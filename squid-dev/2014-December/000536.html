<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Support for regex with \-escaped characters
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Support%20for%20regex%20with%20%5C-escaped%20characters&In-Reply-To=%3C547F2256.2030702%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000596.html">
   <LINK REL="Next"  HREF="000547.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Support for regex with \-escaped characters</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Support%20for%20regex%20with%20%5C-escaped%20characters&In-Reply-To=%3C547F2256.2030702%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Support for regex with \-escaped characters">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  3 14:46:46 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000596.html">[squid-dev] Build failed in Jenkins:	3.HEAD-amd64-ubuntu-utopic-clang #21
</A></li>
        <LI>Next message: <A HREF="000547.html">[squid-dev] [PATCH] Support for regex with \-escaped characters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#536">[ date ]</a>
              <a href="thread.html#536">[ thread ]</a>
              <a href="subject.html#536">[ subject ]</a>
              <a href="author.html#536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 21/11/2014 5:38 p.m., Alex Rousskov wrote:
&gt;<i> On 11/17/2014 05:56 PM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> For now the detection is only added during parsing of regex
</I>&gt;&gt;<i> tokens or files.
</I>&gt;<i> 
</I>&gt;<i> And it should probably stay that way: We cannot easily add support
</I>&gt;<i> for \-based escaping in bare strings because in some of those
</I>&gt;<i> strings \ is meaningful on its own (unfortunately).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> +    while (ConfigParser::RecognizeQuotedPair_ &amp;&amp; *(nextToken-1)
</I>&gt;&gt;<i> == '\\') {
</I>&gt;<i> 
</I>&gt;<i> Are you sure that nextToken never points at the start of a buffer, 
</I>&gt;<i> especially when parsing parameters loaded from external files? If
</I>&gt;<i> you are absolutely sure, this guarantee should be documented where 
</I>&gt;<i> ConfigParser::TokenParse() is defined. Otherwise, the code has to
</I>&gt;<i> be revised (but still support regex parameter files that start with
</I>&gt;<i> a backslash).
</I>
I dont believe that is possible. nextToken always points at the
current buffer, although it may point at the \0 c-string terminator.
There is an un-conditional strcspn() call prior to the while-loop
which will move the nextToken pointer down into the buffer at least
one character in distance.

If the buffer starts with a '\' character the nextToken should be
pointing at its escaped value character. If it does not start with
that then it will be somewhere down the buffer after the next delimiter.

I have moved the \0 terminator check up into the while() condition so
that it will not do a [-1] de-reference if the buffer is ever of
0-length. Although that should have been found and protected against
already by the if-condition at the start of the method.


&gt;<i> 
</I>&gt;<i> The second problem with this code is that it incorrectly handles
</I>&gt;<i> &quot;\\X&quot; AFAICT: X should not be escaped, even though it is preceded
</I>&gt;<i> by a backslash (because that backslash is itself escaped).
</I>
This code does not un-escape anything. All it does is notice '\'
escapes and ensures that both the '\' and character following are
included in the token (unless that following character is the \0
terminator). The regex pattern parser is responsible for any
un-escaping and processing of the token itself.

It accounts for tokens starting with a '\', for multiple sequential
'\', and for &quot;loaded file lines wrongly ending with a '\'. In that
latter case by treating them as an un-escaped '\' character in the
pattern token.


&gt;<i> 
</I>&gt;&gt;<i> +	&lt;tag&gt;configuration_includes_quoted_values&lt;/tag&gt; +	&lt;p&gt;Regex
</I>&gt;&gt;<i> expression values can not be parsed when this directive is +
</I>&gt;&gt;<i> configured to &lt;em&gt;ON&lt;/em&gt;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This is a little misleading because, IIRC, the 
</I>&gt;<i> configuration_includes_quoted_values hack can be turned ON for just
</I>&gt;<i> a section of the configuration file.\ I suggest s/when this
</I>&gt;<i> directive is configured to ON/in parts of configuration where this
</I>&gt;<i> directive is set to ON/.
</I>&gt;<i> 
</I>
Done.

&gt;<i> 
</I>&gt;<i> Please consider s/can not/cannot/ for improved consistency:
</I>&gt;<i> 
</I>&gt;<i> $ fgrep -i 'can not' src/*pre | wc -l 7 $ fgrep -i 'cannot'
</I>&gt;<i> src/*pre | wc -l 19
</I>&gt;<i> 
</I>
Done for the release notes text that made you point this out.
The others are unrelated to this patch. Will do as a separate cleanup
change.

&gt;<i> 
</I>&gt;&gt;<i> +	&lt;tag&gt;configuration_includes_quoted_values&lt;/tag&gt; +	&lt;p&gt;Regex
</I>&gt;&gt;<i> expression values can not be parsed when this directive is +
</I>&gt;&gt;<i> configured to &lt;em&gt;ON&lt;/em&gt;. Instead Squid now accepts regex
</I>&gt;&gt;<i> \-escaped +	   characters including escaped whitespace.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We should clarify that \-escaped characters are supported when
</I>&gt;<i> parsing regular expressions, not just any token. I also suggest
</I>&gt;<i> moving the last sentence to its own paragraph as it has no relation
</I>&gt;<i> to configuration_includes_quoted_values:
</I>
It is directly related to the previous sentence. eg. We do not support
A. Instead we support B.

Also, all &lt;p&gt; entries following &lt;tag&gt; are documented changes to that
same &lt;tag&gt;.

I opted for documenting this under
configuration_includes_quoted_values since the alternative would be
listing each and every directive in Squid which has a regex option and
repeating the same two sentences about how it operates in regards to
when a previous configuration_includes_quoted_values was set to ON.


I'm in half a mind to temporarily disable the
configuration_includes_quoted_values when calling RegexToken(). But
since we already have a hard error when the two collide I left it
as-is and try to document what to do instead of placing quotes around
the pattern.

&gt;<i> 
</I>&gt;<i> &lt;p&gt;When parsing regular expressions, Squid now accepts \-escaped 
</I>&gt;<i> characters, including escaped whitespace.&lt;/p&gt;
</I>&gt;<i> 
</I>&gt;<i> If &quot;escaped whitespace&quot; means \s, I would say so explicitly. If it 
</I>&gt;<i> means &quot;\ &quot;, I would say &quot;including escaped space characters&quot;.
</I>
Escaped whitespace means \ followed by whitespace. As per the bug
report use case.

  acl foo browser Windows\ XP Windows.NT

has two patterns in it equivalent to the single pattern:
  acl foo browser Windows(\ XP|.NT)

Fixed.

&gt;&gt;<i> +    static bool RecognizeQuotedPair_; ///&lt; The next tokens may
</I>&gt;&gt;<i> containing quoted-pair (\-escaped) characters
</I>&gt;<i> 
</I>&gt;<i> s/containing/contain/
</I>
Fixed.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Except for the nextToken-1 concerns, the above corrections are 
</I>&gt;<i> cosmetic, of course.
</I>&gt;<i> 
</I>
Fixed all, and applied to trunk as rev.13730

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUfyJVAAoJELJo5wb/XPRjRmsIAIv+hgXFiQd0St4U3wFYneSR
RGlFpnAGs8NyYiihxf7nnGBgYzVvbBbzLEIPSAzemGGfhfIsmu36ruSCj74qsA77
zTLt6bBwmSVUwrjrPdWmua64rswB4WOibtdaBr2+qCiy82G6CrbS8aP0CSC7h7p3
Uyvl1JzJHDFxz8qj31KJv+gvFo5RKYjD7p1Q+OJYkwhFweVk5G4C9Pr3olmyY7zn
cV4y07L+8NFt/+r2n0rceVBKjiITvAGXr3X9cKDhdJwUE102TqAY1XaPaSl3UQJE
GKrz0srs3A1Vn0JVyq7xf4GP4xqxrqNhLP0Uoh64oCn+l7ZXCuPyhVnghYg48Ck=
=O2Dd
-----END PGP SIGNATURE-----
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000596.html">[squid-dev] Build failed in Jenkins:	3.HEAD-amd64-ubuntu-utopic-clang #21
</A></li>
	<LI>Next message: <A HREF="000547.html">[squid-dev] [PATCH] Support for regex with \-escaped characters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#536">[ date ]</a>
              <a href="thread.html#536">[ thread ]</a>
              <a href="subject.html#536">[ subject ]</a>
              <a href="author.html#536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
