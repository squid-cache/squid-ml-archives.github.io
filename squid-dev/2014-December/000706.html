<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] invalid certificates and spliced connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20invalid%20certificates%20and%20spliced%20connections&In-Reply-To=%3C54948493.9030107%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000835.html">
   <LINK REL="Next"  HREF="000876.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] invalid certificates and spliced connections</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20invalid%20certificates%20and%20spliced%20connections&In-Reply-To=%3C54948493.9030107%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] invalid certificates and spliced connections">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec 19 20:03:31 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000835.html">[squid-dev] [PATCH] invalid certificates and spliced connections
</A></li>
        <LI>Next message: <A HREF="000876.html">[squid-dev] [PATCH] invalid certificates and spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#706">[ date ]</a>
              <a href="thread.html#706">[ thread ]</a>
              <a href="subject.html#706">[ subject ]</a>
              <a href="author.html#706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 20/12/2014 7:27 a.m., Tsantilas Christos wrote:
&gt;<i> Currently peek-and-splice mode have the following bug: 1) When the 
</I>&gt;<i> certificate validation procedure found that the certificate is 
</I>&gt;<i> invalid, splice action is selected and the certificate validator 
</I>&gt;<i> helpers are not used it will splice the connection (even if 
</I>&gt;<i> certificates found invalid).
</I>&gt;<i> 
</I>
Okay. &quot;transparent&quot; is good there.


&gt;<i> 2) When server sends a malformed or unsupported Hello response, 
</I>&gt;<i> squid may splice the connection if splice action is configured.
</I>&gt;<i> 
</I>&gt;<i> This patch, cause squid to return an error page to the user for 
</I>&gt;<i> both cases.
</I>&gt;<i> 
</I>&gt;<i> But about the (2) I need squid developers opinions:
</I>&gt;<i> 
</I>&gt;<i> a) Should we abort with an error when a malformed or unsupported 
</I>&gt;<i> server hello message received? In this case the user may be able
</I>&gt;<i> to control squid behaviour using cert_validator helpers: squid
</I>&gt;<i> will send empty certificates list, and cert validator can respond
</I>&gt;<i> with en error.
</I>&gt;<i> 
</I>&gt;<i> b) Abort with an error, if the server response can not be parsed.
</I>&gt;<i> 
</I>

A) Consider that CONNECT is always attempted being bumped, but non-TLS
protocols exist within CONNECT.
 Also non-TLS protocols over port 443.
 Also SSL v1 / v2 / v3 over port 443 when the library used by Squid
has all support and knowledge of those protocols removed.

According to at least one user report Skype uses a TLS look-alike
clientHello and something strange as serverHello. So we may not be
able to rely on clientHello to indicate TLS. I dont know for certain
the accuracy of that, you may have observed it or know differently.


B) Remember that TLS is about *security*. In security decision making
you validate strictly and if it fails to pass you abort (fail closed)
quickly with nothing or a code containing as few details as necessary
to be clear something is wrong.


In the (A) vs (B) cases above the errors are all internal to TLS. No
need to get HTTP involved if we can avoid it. If there is a TLS alert
code to signal malformed traffic, use it, otherwise just abort.

Possibly a fast ACL is appropriate:
   ssl_bump_error allow/deny [acls...]

Which is run to make the above decision. ONLY in the event that TLS
protocol syntax errors or malformations.  Not for cert/cipher/option
issues such as bad combinations of valid things, or insecure settings.
 Default action on this *_error directive should be &quot;deny all&quot;.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUlISSAAoJELJo5wb/XPRjRnkIANo6hCm5qxVmDNUC7Ium4fCv
lP9TrNXKcwMYSuFU325QswFXKwhSLctnVq4+yTiaKwU4zbjFqjXVN4qbbBNcjgt9
CikN9d6p5HHKUfOrONRMkih0RxihpvgKFG4REa2UByQQerwpWmZuCZ3a6/74nulT
0eRUmTsVL+bRSIft2TqPjnz4x7xlXA1wqIQdxQSGB/Ew/Ms3Ip6UsAu2tSOAx78D
U63U2SBL770L3cWJw/VVnRd3/FPnSKQk5fTt4K9qSv171yQfaxMOJ+8zJUVaHOZi
v/Bpaet0dJoD10SwRWQK7kM3Vb0umPqy1lBJKNcGfin322WIB2XZJnbRAdOd7Ck=
=WFtK
-----END PGP SIGNATURE-----
</PRE>














































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000835.html">[squid-dev] [PATCH] invalid certificates and spliced connections
</A></li>
	<LI>Next message: <A HREF="000876.html">[squid-dev] [PATCH] invalid certificates and spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#706">[ date ]</a>
              <a href="thread.html#706">[ thread ]</a>
              <a href="subject.html#706">[ subject ]</a>
              <a href="author.html#706">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
