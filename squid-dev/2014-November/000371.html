<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] url_rewrite_timeout directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20url_rewrite_timeout%20directive&In-Reply-To=%3C546884F6.2080402%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000369.html">
   <LINK REL="Next"  HREF="000378.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] url_rewrite_timeout directive</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20url_rewrite_timeout%20directive&In-Reply-To=%3C546884F6.2080402%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] url_rewrite_timeout directive">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Nov 16 11:05:26 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000369.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
        <LI>Next message: <A HREF="000378.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#371">[ date ]</a>
              <a href="thread.html#371">[ thread ]</a>
              <a href="subject.html#371">[ subject ]</a>
              <a href="author.html#371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 16/11/2014 7:38 a.m., Tsantilas Christos wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> This patch adds the url_rewrite_timeout directive.
</I>&gt;<i> 
</I>&gt;<i> When configured, Squid keeps track of active requests and treats
</I>&gt;<i> timed out requests to redirector as failed requests.
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_timeout format: url_rewrite_timeout timeout time-units 
</I>&gt;<i> on_timeout=&lt;fail|bypass|retry|use_configured_response&gt; 
</I>&gt;<i> [response=&lt;quoted-string&gt;]
</I>&gt;<i> 
</I>&gt;<i> The url_rewrite_timeout directive can accept the on_timeout
</I>&gt;<i> argument to allow user configure the action when the helper request
</I>&gt;<i> times out. The available actions are: - fail: squid return a
</I>&gt;<i> ERR_GATEWAY_FAILURE error page
</I>
Why?
 It seems to me this should be doing one of the below:

 on_timeout=use_configured_response response=ERR

 on_timeout=use_configured_response response=BH

although being able to redirect to a Squid default error page template
has its attractions regardless of this. Perhapse BH with an
error=ERR_GATEWAY_FAILURE kv-pair ?


&gt;<i> - bypass: the url is not rewritten.
</I>
Identical to:
 on_timeout=use_configured_response response=OK

&gt;<i> - retry: retry the request to helper
</I>
Equivalent to what is supposed to happen for:
 on_timeout=use_configured_response response=BH

NP: if retry with different helper process is not already being done
on BH then it needs to be added.


&gt;<i> - use_configured_response: use a response which can be configured 
</I>&gt;<i> using the the response= option
</I>&gt;<i> 
</I>
So as you can see, with a change to make the URL-rewriter capable of
redirecting to one of the built-in error page templates we could
completely drop the on_timeout setting.


&gt;<i> 
</I>&gt;<i> Technical details =====================
</I>&gt;<i> 
</I>&gt;<i> This patch: - adds mechanism inside helpers.cc code to handle
</I>&gt;<i> timeouts: - return a pre-configured response on timeout - or
</I>&gt;<i> retries on timeouts. - or timedout (Helper::TimedOut code) response
</I>&gt;<i> to the  caller. The caller can select to ignore the timedout
</I>&gt;<i> request, or produce an error.
</I>&gt;<i> 
</I>&gt;<i> - modify the client_side_request.cc to return ERR_GATEWAY_FAILURE
</I>&gt;<i> error page. Also the error detail ERR_DETAIL_REDIRECTOR_TIMEDOUT is
</I>&gt;<i> set to identify the type of error.
</I>&gt;<i> 
</I>
For the record I am still extremely skeptical about the use-case
behind this feature. Timeout i a clear sign that the helper or system
behind it is broken (capacity overload / network congestion).
Continuing to use such systems in a way which further increases
network load is very often a bad choice. Hiding the issue an even
worse choice.


Now the code:

in src/ConfigParser.cc:

* please call the new type flag ConfigParser::ParseKvPair_ instead.
&quot;ParseKeyValue_&quot; implies that only the value portion is being parsed,
not the entire kv-pair.
 - similary NextKvPair() instead of NextKeyValue().


in src/ConfigParser.h:

* We are (or should be) calling key=value &quot;kv-pair&quot; through the rest
of Squid. Not &quot;key=value pairs&quot; nor &quot;key value pair which must be
separated by '='&quot; nor &quot;Key=value token&quot;


in src/auth/digest/UserRequest.cc:

* please shift the Helper::TimedOut case up above
Helper::BrokenHelper. So it is clear the case is by default a BH not
an ERR response.


in src/cache_cf.cc

* please move the *_url_rewrite_timeout() functions to redirect.cc
 - that will help reduce dependency issues when we get around to
making the redirector config a standalone FooConfig object.

* missing implementation of dump_url_rewrite_timeout().
 - if the function is really meant to be empty use a #define to set it
to no-op like the rest of the parser code instead off adding to the
already large symbol table.

* it would be simpler and easier on users to omit the
&quot;on_timeout=use_configured_response response=&quot; and just have the
existence of a response= kv-pair imply the on_timeout action.
 - that also allows the above suggested removal of bypass and retry
special actions without loosing any functionality.
 - that removes the FATAL errors if admin gets the options ordering
different from what you expect.
 - and allows for forward-compatibility with unknown options. A while
loop fetching kv-pair and processing them as found regardess of order
seems best for a field documented a &quot; [options] &quot;.



in src/cf.data.pre:

* omit the ':' after documented on_timeout= values (if any after the
above changes). It makes it seem like the ':' is part of the value.

* s/the url is not rewritten./Do not re-write the URL/

* s/retry the request to helper/Send the lookup to the helper again/


in src/client_side_request.cc:

* Bad logic &quot;if (!Config.onUrlRewriteTimeout.action == toutActBypass)&quot;
 - aka. if (true == toutActBypass || false == toutActBypass)  ???
 - I think you mean:
    (Config.onUrlRewriteTimeout.action != toutActBypass)

* please add empty line after break; between switch cases

* please define the new handleAdaptationFailure() *above* the new
calloutsError().
 - that will reduce the diff and make it clearer what actually is
changing and what not.

* its now possible for adaptation error to silently continue
processing. Before it would hang. I am not sure that is a good or bad
change. But it may be worth noting the difference in
handleAdaptationFailure() where it not unconditionally calls
doCallouts() at the end.


in src/helper.cc:

* adding multiple double-empty lines in the chunk @195

* helper_server::checkForTimedOutRequests() is deducting from
stats.pending pending. This is incorrect, the helper request is still
pending.
 - your act of removing the requests from the queue invalidates the
logic in helperReturnBuffer() recording and managing late helper
responses.
 - both of the above also corrupts the mgr report content for expected
pending responses.
 By all means call (and clear) the callback on a timeout but please do
not remove the queue entries for them until the helper actually
responds to that query.
 - if a helper gets too many un-responded queries the traffic being
served by it is f'ckd and we should shutdown the helper. If an
auto-restart does not work Manual intervention is probably required
from the admin to resolve why it is timing out *at all*.

 NP: when doing a re-try we still may get a response to this lookup
from *either* of the helpers which have been asked for it. The frst
helper is in fact more likely to respond first. IMO we should be
taking advantage of that and leaving both helpers with shared pointer
which either can call+unset the callback for.


in src/helper/Reply.cc:
* Timeout does not need to be allocated a on-wire protocol code
(&quot;TO&quot;). Please just use the word &quot;Timedout&quot;, like &quot;Unknown&quot; it is
purely for debug reporting.


Please also document clearly in the release notes that:

A) helper-mux.pl we have been distributing for the past few years to
encourage use of concurrency is no longer compatible with Squid. If
used it will spawn up to 2^64 helpers and DoS the Squid server.

B) helpers utilizing arrays to handle fixed amounts of concurrency
channels MUST be re-written to use queues and capable of handling a
64-bit int as index or they will be vulnerable to buffer overrun and
arbitrary memory accesses.

C) 32-bit helpers need re-writing to handle the concurrency channel ID
as a 64-bit integer value. If not updated they will cause proxies to
return unexpected results or timeout once crossing the 32-bit wrap
boundary. Leading to undefined behaviour in the client HTTP traffic.



My vote on this is -0. Too many problems and still no clear use-case
has been described[1] for this to be a reasonable addition.


[1] &quot;helper is slow&quot; and &quot;helper times out&quot; are not use-case
descriptions. They are symptoms of an underlying problem. The &quot;WHY&quot; is
highly important.
 Ignoring helper on timeout bypass/auto-reply *raises* network req/sec
throughput. If the helper was slow because it was network congested or
capacity congested at the backend API you just made the problem
infinitely worse by adding more req/sec on top of it. Slow responses
are the natural feedback loop restricting traffic to levels the helper
backend system can handle. The solution is not to ignore the delay
itself, but to remove the bottleneck limit which is causing it to be
slow. Without that bottleneck the throughput performance is improved
permanently.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUaIT2AAoJELJo5wb/XPRjCeEH/i65891D+rRk96ZCJVavYKpH
GDb9KdjGIwQ5O4Lp5Ia9YBMcPXCxg8cqcgyfVAeA18t3AlTImG3l+QBA50/XqyZ3
BvbPea2/AKLOCBYNkDWEGsZymPWFU2De6IBoWiNFRjzr0ljPCTtjQzVFHpXuQa8V
imZC6GRC7pwFEJDNgCgxPPy+8KrX13DyNUuVQAIKL7ipCR28njwoVuMDgaw8tGk4
TgW5w6/E3wkiVzIriE3G49zft0ktr6gwH6xH8mUUTG9HfJC4wVBO0TK4WhBJagFR
0JIIWUzxr4iP21ncxWEFj4jwCX0QGd0quZDGYv/uo56ZS7C2dmJmWcn00DH8Pl4=
=S4Rs
-----END PGP SIGNATURE-----
</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000369.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
	<LI>Next message: <A HREF="000378.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#371">[ date ]</a>
              <a href="thread.html#371">[ thread ]</a>
              <a href="subject.html#371">[ subject ]</a>
              <a href="author.html#371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
