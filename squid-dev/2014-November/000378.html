<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] url_rewrite_timeout directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20url_rewrite_timeout%20directive&In-Reply-To=%3C546A2C1B.50703%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000371.html">
   <LINK REL="Next"  HREF="000386.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] url_rewrite_timeout directive</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20url_rewrite_timeout%20directive&In-Reply-To=%3C546A2C1B.50703%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] url_rewrite_timeout directive">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Mon Nov 17 17:10:51 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000371.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
        <LI>Next message: <A HREF="000386.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#378">[ date ]</a>
              <a href="thread.html#378">[ thread ]</a>
              <a href="subject.html#378">[ subject ]</a>
              <a href="author.html#378">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/16/2014 01:05 PM, Amos Jeffries wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 16/11/2014 7:38 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This patch adds the url_rewrite_timeout directive.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When configured, Squid keeps track of active requests and treats
</I>&gt;&gt;<i> timed out requests to redirector as failed requests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> url_rewrite_timeout format: url_rewrite_timeout timeout time-units
</I>&gt;&gt;<i> on_timeout=&lt;fail|bypass|retry|use_configured_response&gt;
</I>&gt;&gt;<i> [response=&lt;quoted-string&gt;]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The url_rewrite_timeout directive can accept the on_timeout
</I>&gt;&gt;<i> argument to allow user configure the action when the helper request
</I>&gt;&gt;<i> times out. The available actions are: - fail: squid return a
</I>&gt;&gt;<i> ERR_GATEWAY_FAILURE error page
</I>&gt;<i>
</I>&gt;<i> Why?
</I>&gt;<i>   It seems to me this should be doing one of the below:
</I>&gt;<i>
</I>&gt;<i>   on_timeout=use_configured_response response=ERR
</I>&gt;<i>
</I>&gt;<i>   on_timeout=use_configured_response response=BH
</I>&gt;<i>
</I>&gt;<i> although being able to redirect to a Squid default error page template
</I>&gt;<i> has its attractions regardless of this. Perhapse BH with an
</I>&gt;<i> error=ERR_GATEWAY_FAILURE kv-pair ?
</I>
The on_timeout= option is easier to understand and configure.

Also this patch add the retries operation inside helpers.cc code and 
make it easier to implement similar features for other helpers too...

Also the BH retry can be implemented now using helpers retry operation.

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> - bypass: the url is not rewritten.
</I>&gt;<i>
</I>&gt;<i> Identical to:
</I>&gt;<i>   on_timeout=use_configured_response response=OK
</I>&gt;<i>
</I>&gt;&gt;<i> - retry: retry the request to helper
</I>&gt;<i>
</I>&gt;<i> Equivalent to what is supposed to happen for:
</I>&gt;<i>   on_timeout=use_configured_response response=BH
</I>&gt;<i>
</I>&gt;<i> NP: if retry with different helper process is not already being done
</I>&gt;<i> on BH then it needs to be added.
</I>
It is not implemented for BH redirects. Also although it is make sense 
to not use the same server for a BH response, it is not clear why it is 
needed for a timedout server?

I believe this is should have a different form. If there are many 
timedout responses from a server, then do not sent more requests for a 
while, or maybe shut it down.
We can add a todo for this one.

&gt;<i>
</I>&gt;&gt;<i> - use_configured_response: use a response which can be configured
</I>&gt;&gt;<i> using the the response= option
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So as you can see, with a change to make the URL-rewriter capable of
</I>&gt;<i> redirecting to one of the built-in error page templates we could
</I>&gt;<i> completely drop the on_timeout setting.
</I>
I still believe that the &quot;on-timeout&quot; is better options and easier to 
understand and configure.

&gt;&gt;<i>
</I>&gt;&gt;<i> Technical details =====================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This patch: - adds mechanism inside helpers.cc code to handle
</I>&gt;&gt;<i> timeouts: - return a pre-configured response on timeout - or
</I>&gt;&gt;<i> retries on timeouts. - or timedout (Helper::TimedOut code) response
</I>&gt;&gt;<i> to the  caller. The caller can select to ignore the timedout
</I>&gt;&gt;<i> request, or produce an error.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - modify the client_side_request.cc to return ERR_GATEWAY_FAILURE
</I>&gt;&gt;<i> error page. Also the error detail ERR_DETAIL_REDIRECTOR_TIMEDOUT is
</I>&gt;&gt;<i> set to identify the type of error.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For the record I am still extremely skeptical about the use-case
</I>&gt;<i> behind this feature. Timeout i a clear sign that the helper or system
</I>&gt;<i> behind it is broken (capacity overload / network congestion).
</I>&gt;<i> Continuing to use such systems in a way which further increases
</I>&gt;<i> network load is very often a bad choice. Hiding the issue an even
</I>&gt;<i> worse choice.
</I>

Maybe the administrator does not care about unanswered queries.
Imagine a huge squid proxy, which may have to process thousands of URLs 
per minute and the administrator decided that a 10% of helpers request 
can fail. In this case we are giving him a way to configure the squid 
behaviour in this case: may ignore the probelm, or use a predefined 
answer etc

The reason the helper is not answered enough fast, maybe is a database 
or an external lookup failure (for example categorized urls list as a 
DNS service).
In these cases the system admin or service provider, may prefer a none 
answer from the helper, or a preconfigured answer, instead of waiting 
too long for the answer.

The helper can be implemented to not answer at all after a timeout period.
A policy of &quot;if you do not answer in a day, please do not answer at all, 
I am not interested any mode&quot; is common in human world, and in business.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now the code:
</I>&gt;<i>
</I>&gt;<i> in src/ConfigParser.cc:
</I>&gt;<i>
</I>&gt;<i> * please call the new type flag ConfigParser::ParseKvPair_ instead.
</I>&gt;<i> &quot;ParseKeyValue_&quot; implies that only the value portion is being parsed,
</I>&gt;<i> not the entire kv-pair.
</I>&gt;<i>   - similary NextKvPair() instead of NextKeyValue().
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ConfigParser.h:
</I>&gt;<i>
</I>&gt;<i> * We are (or should be) calling key=value &quot;kv-pair&quot; through the rest
</I>&gt;<i> of Squid. Not &quot;key=value pairs&quot; nor &quot;key value pair which must be
</I>&gt;<i> separated by '='&quot; nor &quot;Key=value token&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/auth/digest/UserRequest.cc:
</I>&gt;<i>
</I>&gt;<i> * please shift the Helper::TimedOut case up above
</I>&gt;<i> Helper::BrokenHelper. So it is clear the case is by default a BH not
</I>&gt;<i> an ERR response.
</I>&gt;<i>
</I>
ok to all.

&gt;<i>
</I>&gt;<i> in src/cache_cf.cc
</I>&gt;<i>
</I>&gt;<i> * please move the *_url_rewrite_timeout() functions to redirect.cc
</I>&gt;<i>   - that will help reduce dependency issues when we get around to
</I>&gt;<i> making the redirector config a standalone FooConfig object.
</I>
Not so easy, because of dependencies on time-related parsing functions....
I let it for now. If required we must move time parse functions to a 
library file, for example Config.cc


&gt;<i>
</I>&gt;<i> * missing implementation of dump_url_rewrite_timeout().
</I>&gt;<i>   - if the function is really meant to be empty use a #define to set it
</I>&gt;<i> to no-op like the rest of the parser code instead off adding to the
</I>&gt;<i> already large symbol table.
</I>
True, I forgot to implement it...
It is implemented in this patch.

&gt;<i>
</I>&gt;<i> * it would be simpler and easier on users to omit the
</I>&gt;<i> &quot;on_timeout=use_configured_response response=&quot; and just have the
</I>&gt;<i> existence of a response= kv-pair imply the on_timeout action.
</I>&gt;<i>   - that also allows the above suggested removal of bypass and retry
</I>&gt;<i> special actions without loosing any functionality.
</I>&gt;<i>   - that removes the FATAL errors if admin gets the options ordering
</I>&gt;<i> different from what you expect.
</I>&gt;<i>   - and allows for forward-compatibility with unknown options. A while
</I>&gt;<i> loop fetching kv-pair and processing them as found regardess of order
</I>&gt;<i> seems best for a field documented a &quot; [options] &quot;.
</I>&gt;<i>
</I>
True.
This is fixed in this patch

&gt;<i>
</I>&gt;<i> in src/cf.data.pre:
</I>&gt;<i>
</I>&gt;<i> * omit the ':' after documented on_timeout= values (if any after the
</I>&gt;<i> above changes). It makes it seem like the ':' is part of the value.
</I>&gt;<i>
</I>&gt;<i> * s/the url is not rewritten./Do not re-write the URL/
</I>&gt;<i>
</I>&gt;<i> * s/retry the request to helper/Send the lookup to the helper again/
</I>
ok, fixed as you suggested in this patch

&gt;<i> in src/client_side_request.cc:
</I>&gt;<i>
</I>&gt;<i> * Bad logic &quot;if (!Config.onUrlRewriteTimeout.action == toutActBypass)&quot;
</I>&gt;<i>   - aka. if (true == toutActBypass || false == toutActBypass)  ???
</I>&gt;<i>   - I think you mean:
</I>&gt;<i>      (Config.onUrlRewriteTimeout.action != toutActBypass)
</I>
Yes!

&gt;<i>
</I>&gt;<i> * please add empty line after break; between switch cases
</I>
ok

&gt;<i>
</I>&gt;<i> * please define the new handleAdaptationFailure() *above* the new
</I>&gt;<i> calloutsError().
</I>&gt;<i>   - that will reduce the diff and make it clearer what actually is
</I>&gt;<i> changing and what not.
</I>

&gt;<i>
</I>&gt;<i> * its now possible for adaptation error to silently continue
</I>&gt;<i> processing. Before it would hang. I am not sure that is a good or bad
</I>&gt;<i> change. But it may be worth noting the difference in
</I>&gt;<i> handleAdaptationFailure() where it not unconditionally calls
</I>&gt;<i> doCallouts() at the end.
</I>
There is not any change on handling adaptation errors, or should not be.
Am I loosing something?

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/helper.cc:
</I>&gt;<i>
</I>&gt;<i> * adding multiple double-empty lines in the chunk @195
</I>&gt;<i>
</I>&gt;<i> * helper_server::checkForTimedOutRequests() is deducting from
</I>&gt;<i> stats.pending pending. This is incorrect, the helper request is still
</I>&gt;<i> pending.
</I>
Amos, I think it is better as is....
Maybe in a point of view the request is still pending, but we are not 
waiting an answer for this request any more.

&gt;<i>   - your act of removing the requests from the queue invalidates the
</I>&gt;<i> logic in helperReturnBuffer() recording and managing late helper
</I>&gt;<i> responses.
</I>
why?

&gt;<i>   - both of the above also corrupts the mgr report content for expected
</I>&gt;<i> pending responses.
</I>&gt;<i>   By all means call (and clear) the callback on a timeout but please do
</I>&gt;<i> not remove the queue entries for them until the helper actually
</I>&gt;<i> responds to that query.
</I>
Some of the queries will never  answered. This is may result to memory 
leaks.


&gt;<i>   - if a helper gets too many un-responded queries the traffic being
</I>&gt;<i> served by it is f'ckd and we should shutdown the helper. If an
</I>&gt;<i> auto-restart does not work Manual intervention is probably required
</I>&gt;<i> from the admin to resolve why it is timing out *at all*.
</I>



&gt;<i>   NP: when doing a re-try we still may get a response to this lookup
</I>&gt;<i> from *either* of the helpers which have been asked for it. The frst
</I>&gt;<i> helper is in fact more likely to respond first. IMO we should be
</I>&gt;<i> taking advantage of that and leaving both helpers with shared pointer
</I>&gt;<i> which either can call+unset the callback for.
</I>
Maybe this is good optimization.
However requires some work.... We can add it later if required as 
optimization...

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/helper/Reply.cc:
</I>&gt;<i> * Timeout does not need to be allocated a on-wire protocol code
</I>&gt;<i> (&quot;TO&quot;). Please just use the word &quot;Timedout&quot;, like &quot;Unknown&quot; it is
</I>&gt;<i> purely for debug reporting.
</I>
ok.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Please also document clearly in the release notes that:
</I>&gt;<i>
</I>&gt;<i> A) helper-mux.pl we have been distributing for the past few years to
</I>&gt;<i> encourage use of concurrency is no longer compatible with Squid. If
</I>&gt;<i> used it will spawn up to 2^64 helpers and DoS the Squid server.
</I>
What is this helper? I can not find it inside squid sources....

&gt;<i>
</I>&gt;<i> B) helpers utilizing arrays to handle fixed amounts of concurrency
</I>&gt;<i> channels MUST be re-written to use queues and capable of handling a
</I>&gt;<i> 64-bit int as index or they will be vulnerable to buffer overrun and
</I>&gt;<i> arbitrary memory accesses.
</I>

OK for this

&gt;<i>
</I>&gt;<i> C) 32-bit helpers need re-writing to handle the concurrency channel ID
</I>&gt;<i> as a 64-bit integer value. If not updated they will cause proxies to
</I>&gt;<i> return unexpected results or timeout once crossing the 32-bit wrap
</I>&gt;<i> boundary. Leading to undefined behaviour in the client HTTP traffic.
</I>&gt;<i>
</I>
OK.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> My vote on this is -0. Too many problems and still no clear use-case
</I>&gt;<i> has been described[1] for this to be a reasonable addition.
</I>

OK.
I tried to do most  of the fixes you are suggested.
I hope it is OK.



&gt;<i>
</I>&gt;<i>
</I>&gt;<i> [1] &quot;helper is slow&quot; and &quot;helper times out&quot; are not use-case
</I>&gt;<i> descriptions. They are symptoms of an underlying problem. The &quot;WHY&quot; is
</I>&gt;<i> highly important.
</I>&gt;<i>   Ignoring helper on timeout bypass/auto-reply *raises* network req/sec
</I>&gt;<i> throughput. If the helper was slow because it was network congested or
</I>&gt;<i> capacity congested at the backend API you just made the problem
</I>&gt;<i> infinitely worse by adding more req/sec on top of it. Slow responses
</I>&gt;<i> are the natural feedback loop restricting traffic to levels the helper
</I>&gt;<i> backend system can handle. The solution is not to ignore the delay
</I>&gt;<i> itself, but to remove the bottleneck limit which is causing it to be
</I>&gt;<i> slow. Without that bottleneck the throughput performance is improved
</I>&gt;<i> permanently.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: url_rewrite_timeout-all-t3.patch
Type: text/x-patch
Size: 161566 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20141117/578a20af/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20141117/578a20af/attachment-0001.bin</A>&gt;
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000371.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
	<LI>Next message: <A HREF="000386.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#378">[ date ]</a>
              <a href="thread.html#378">[ thread ]</a>
              <a href="subject.html#378">[ subject ]</a>
              <a href="author.html#378">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
