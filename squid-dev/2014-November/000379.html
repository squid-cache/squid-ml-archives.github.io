<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] New format code %acl_matched to log the last matched acl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20New%20format%20code%20%25acl_matched%20to%20log%20the%0A%20last%20matched%20acl&In-Reply-To=%3C546A6F9F.7030006%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000377.html">
   <LINK REL="Next"  HREF="000380.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] New format code %acl_matched to log the last matched acl</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20New%20format%20code%20%25acl_matched%20to%20log%20the%0A%20last%20matched%20acl&In-Reply-To=%3C546A6F9F.7030006%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] New format code %acl_matched to log the last matched acl">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Nov 17 21:58:55 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000377.html">[squid-dev] [PATCH] New format code %acl_matched to log the last matched acl
</A></li>
        <LI>Next message: <A HREF="000380.html">[squid-dev] Build farm configuration updated.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#379">[ date ]</a>
              <a href="thread.html#379">[ thread ]</a>
              <a href="subject.html#379">[ subject ]</a>
              <a href="author.html#379">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 18/11/2014 5:55 a.m., Alfonso Ali wrote:
&gt;<i> On 11/16/2014 06:14 AM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> What exactly are those use-cases please? Accounting what
</I>&gt;&gt;<i> exactly?
</I>&gt;<i> 
</I>&gt;<i> We have a lot of sites classified in some categories (tech,
</I>&gt;<i> health, culture, etc.) and we need to generate traffic reports
</I>&gt;<i> based on those categories. Each category can be composed of more
</I>&gt;<i> than one acl type (dstdomain, url_regex). When parsing the logs we
</I>&gt;<i> can extract to which category belongs each url based on the matched
</I>&gt;<i> acl.
</I>&gt;<i> 
</I>&gt;<i> The other user case is related with quota accounting, we have a
</I>&gt;<i> lot sites that are free (mainly the ones described above) for each
</I>&gt;<i> user and the quota program use the acl matche to know if the
</I>&gt;<i> request have to be accounted or not.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> This is important to document as it informs us whether this patch
</I>&gt;&gt;<i> is only useful for you, or could be useful for others. It may
</I>&gt;&gt;<i> also be
</I>&gt;<i> 
</I>&gt;<i> I understand, we decided to send it now becouse other institutions
</I>&gt;<i> asked us about our solution, so i though it could be useful for
</I>&gt;<i> other too.
</I>&gt;<i> 
</I>&gt;&gt;<i> that your use-case is far better served by some other feature or
</I>&gt;&gt;<i> patch addition.
</I>&gt;<i> 
</I>&gt;<i> Agreed, as i said before our first approach to the problem was to
</I>&gt;<i> use an external acl that generated a log=%s reply to be used on the
</I>&gt;<i> log files with the %ea format code.
</I>
The traffic classification use-case is best served by the annotation
feature now available in Squid-3.4. It is like the tag= response from
external ACL helpers. But annotations can be added from any helper at
all, or explicitly by the note directive.

&gt;<i> 
</I>&gt;&gt;<i> ? sounds like a bug. In which case fixing the bug is the right 
</I>&gt;&gt;<i> approach. Some details on what you found would be appreciated.
</I>&gt;&gt;<i> You can report through bugzilla to keep this thread clean.
</I>&gt;<i> 
</I>&gt;<i> We looked into it, but is was very difficult to debug since it
</I>&gt;<i> only ocurred at high loads and the way to verify it is parsing the
</I>&gt;<i> whole log file to see if each url match the correct acl (we only
</I>&gt;<i> found this issue becouse some users complained about been accounted
</I>&gt;<i> incorrectly), at first we though it was a problem related with the
</I>&gt;<i> acl's ttl or buffering but since squid already knows which acl was
</I>&gt;<i> used to allow the request and logging it from squid will have the
</I>&gt;<i> benefit of reducing the load associated with the external programs
</I>&gt;<i> used for the external acl's we decided for this solution.
</I>
Hm. If an external ACL helper is used multiple times ony the last log=
delivered will be used in the log. This may have been part of the
problem. Older Squid would often repeat ACL tests with new data when
resuming from external lookups.

&gt;<i> 
</I>&gt;&gt;<i> Please be aware the named ACL is not valid to be used outside of 
</I>&gt;&gt;<i> Checklist matching sequences. It contains the last ACL to be
</I>&gt;&gt;<i> named *including* any ACLs tested in figuring out where to log
</I>&gt;&gt;<i> the traffic. Even if no ACLs are tested determining the log to
</I>&gt;&gt;<i> write to, the name may be altered at any time by a concurrent
</I>&gt;&gt;<i> request being processed through some other ACLs.
</I>&gt;<i> 
</I>&gt;<i> I don't have much knowledge of squid's code, i just looked at how
</I>&gt;<i> others format codes where defined and how the debug info about the
</I>&gt;<i> matched acl was generated (line 739 in client_side_request.cc).
</I>&gt;<i> 
</I>&gt;<i> I though (but don't checked) that the http object and
</I>&gt;<i> AclMatchedName variable where unique for each request or at least
</I>&gt;<i> until the log line was generated.
</I>&gt;<i> 
</I>&gt;<i> Do you think that if i make a copy of AclMatchedName's value on the
</I>&gt;<i> http object i can ensure that the correct info is generated in the
</I>&gt;<i> log file?
</I>
Possibly. But it is just adding another custom tag onto the
transaction. We are trying at present to reduce the number of those
type of mechanisms. Centering on the annotation feature as a single
unified way to do it instead.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUam+fAAoJELJo5wb/XPRjcKYIALNHi9K8SE8MrEx4FHymuItS
rGsPCnK27vN5WXcbV3zHHB5W3MtFL7a6CUEqlDVdlO5DJ3pZo2Ja3fN9ZAP/sG3P
4NWbLwS4lslmR38bpe8wN0IagEMz+KMQZ4UE2V0gBslJSI+I7DrrD+XiK0yMig+y
He+Zwl1R+EXQuUaIB1wbgrppcoq32jjLIgu+N/WloX2oj6qYD28FWVcImQVqC3ps
NAKdVp8ocZ03Tj8naEwO2d0qzXue9kE74W47P3ENms/J/kNOleFH4jVux7ekmeKK
bANgw/3ggN4uXJAhRpLmfrMwcAODYP6gjgRrkaPrDggjBWT7OHPu2ZEQPgj+nns=
=HbM5
-----END PGP SIGNATURE-----
</PRE>



































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000377.html">[squid-dev] [PATCH] New format code %acl_matched to log the last matched acl
</A></li>
	<LI>Next message: <A HREF="000380.html">[squid-dev] Build farm configuration updated.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#379">[ date ]</a>
              <a href="thread.html#379">[ thread ]</a>
              <a href="subject.html#379">[ subject ]</a>
              <a href="author.html#379">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
