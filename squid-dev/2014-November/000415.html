<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] url_rewrite_timeout directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20url_rewrite_timeout%20directive&In-Reply-To=%3C546B2CBA.7000207%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000413.html">
   <LINK REL="Next"  HREF="000431.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] url_rewrite_timeout directive</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20url_rewrite_timeout%20directive&In-Reply-To=%3C546B2CBA.7000207%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] url_rewrite_timeout directive">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 18 11:25:46 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000413.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
        <LI>Next message: <A HREF="000431.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#415">[ date ]</a>
              <a href="thread.html#415">[ thread ]</a>
              <a href="subject.html#415">[ subject ]</a>
              <a href="author.html#415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 18/11/2014 10:44 p.m., Tsantilas Christos wrote:
&gt;<i> On 11/18/2014 01:27 AM, Amos Jeffries wrote:
</I>
&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> in src/helper.cc:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> * adding multiple double-empty lines in the chunk @195
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> * helper_server::checkForTimedOutRequests() is deducting
</I>&gt;&gt;&gt;&gt;<i> from stats.pending pending. This is incorrect, the helper
</I>&gt;&gt;&gt;&gt;<i> request is still pending.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Amos, I think it is better as is.... Maybe in a point of view
</I>&gt;&gt;&gt;<i> the request is still pending, but we are not waiting an answer
</I>&gt;&gt;&gt;<i> for this request any more.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Any helper which is obeying the helper protocol *will* still be 
</I>&gt;&gt;<i> consuming resources trying to satisfy it. This is what I mean by
</I>&gt;&gt;<i> forgetting and sending more requests to the helper &quot;making the
</I>&gt;&gt;<i> overload problem worse&quot;.
</I>&gt;<i> 
</I>&gt;<i> Maybe we should document this behaviour in option documentation.
</I>&gt;<i> The administrators who want to use timeout they have to take care
</I>&gt;<i> of it.
</I>
So instead of being pointed at a specific problem needing attention
and which they probably can fix. They have to read and act on some
documentation to prepare for the risk of some future possibility
happening.

Sadly the commonness of &quot;RTFM&quot; shows which of those approaches is most
likely to result in critical failure.

&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> - your act of removing the requests from the queue
</I>&gt;&gt;&gt;&gt;<i> invalidates the logic in helperReturnBuffer() recording and
</I>&gt;&gt;&gt;&gt;<i> managing late helper responses.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> why?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Non-concurrent helpers: * #1 query times out and gets discarded. 
</I>&gt;&gt;<i> * Lookup logics finding a helper to use see a helper without
</I>&gt;&gt;<i> pending requests and deliver a second lookup (#2). * #1 response
</I>&gt;&gt;<i> arrives late and is used as response to the current pending (#2)
</I>&gt;&gt;<i> lookup.
</I>&gt;<i> 
</I>&gt;<i> This is will be discarded. This is because the request will get new
</I>&gt;<i> requestId before retried.  The old requestId is not valid any
</I>&gt;<i> more.
</I>
Non-concurrent helpers have no ID on the response with which to
determine whether it was for the currently waiting request or
something earlier.

&gt;<i> 
</I>&gt;&gt;<i> * #2 response arrives and is discarded.
</I>&gt;<i> 
</I>&gt;<i> This is will be accepted.
</I>&gt;<i> 
</I>&gt;&gt;<i> - --&gt; helper responses are hereafter off-by-1 until another
</I>&gt;&gt;<i> timeout makes it off-by-2 or lucky random timing makes it
</I>&gt;&gt;<i> off-by-0 again.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Please notice that the helpers with most common long duration
</I>&gt;&gt;<i> lookups are NTLM and Kerberos crypto validation. Which do not
</I>&gt;&gt;<i> support concurrency channels.
</I>&gt;<i> 
</I>&gt;<i> Yes. They can not use timeout feature.
</I>
But they can configure it and when configured it is always used.

For non-concurrent helpers the request-ID is only saved in the request
object which was discarded from the queue when it timed out. The #2
request updated both the srv/hlp latest-requestID on record and added
a new queued 'pending' request.

The un-numbered reply coming back can mistakenly use those stored
details about the request which has not yet come back.

With this patch concurrency is effectively mandatory - except when it
isn't.

&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> - both of the above also corrupts the mgr report content for 
</I>&gt;&gt;&gt;&gt;<i> expected pending responses. By all means call (and clear)
</I>&gt;&gt;&gt;&gt;<i> the callback on a timeout but please do not remove the queue
</I>&gt;&gt;&gt;&gt;<i> entries for them until the helper actually responds to that
</I>&gt;&gt;&gt;&gt;<i> query.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Some of the queries will never  answered. This is may result
</I>&gt;&gt;&gt;<i> to memory leaks.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> see the point I made next:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> - if a helper gets too many un-responded queries the traffic 
</I>&gt;&gt;&gt;&gt;<i> being served by it is f'ckd and we should shutdown the
</I>&gt;&gt;&gt;&gt;<i> helper. If an auto-restart does not work Manual intervention
</I>&gt;&gt;&gt;&gt;<i> is probably required from the admin to resolve why it is
</I>&gt;&gt;&gt;&gt;<i> timing out *at all*.
</I>&gt;<i> 
</I>&gt;<i> Yes this is true. But the admin can find out if many requests are
</I>&gt;<i> timed out for a server using mgr. And then he can kill problematic
</I>&gt;<i> server.
</I>&gt;<i> 
</I>
How often do you log into your machines and check the TCP packet
failure rates in order to see if the NIC or cables need replacing?
How often do you run the fsck to see if disk drive errors are
accumulating and will need a replacement in future?

I posit you dont notice until the errors start popping up in your face.

&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Please also document clearly in the release notes that:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> A) helper-mux.pl we have been distributing for the past few
</I>&gt;&gt;&gt;&gt;<i> years to encourage use of concurrency is no longer compatible
</I>&gt;&gt;&gt;&gt;<i> with Squid. If used it will spawn up to 2^64 helpers and DoS
</I>&gt;&gt;&gt;&gt;<i> the Squid server.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> What is this helper? I can not find it inside squid
</I>&gt;&gt;&gt;<i> sources....
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Under tools/ 
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/HelperMultiplexer">http://wiki.squid-cache.org/Features/HelperMultiplexer</A>
</I>&gt;<i> 
</I>&gt;<i> We need to fix this helper to work with new changes too.... OK.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> B) helpers utilizing arrays to handle fixed amounts of 
</I>&gt;&gt;&gt;&gt;<i> concurrency channels MUST be re-written to use queues and
</I>&gt;&gt;&gt;&gt;<i> capable of handling a 64-bit int as index or they will be
</I>&gt;&gt;&gt;&gt;<i> vulnerable to buffer overrun and arbitrary memory accesses.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> OK for this
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> C) 32-bit helpers need re-writing to handle the concurrency 
</I>&gt;&gt;&gt;&gt;<i> channel ID as a 64-bit integer value. If not updated they
</I>&gt;&gt;&gt;&gt;<i> will cause proxies to return unexpected results or timeout
</I>&gt;&gt;&gt;&gt;<i> once crossing the 32-bit wrap boundary. Leading to undefined
</I>&gt;&gt;&gt;&gt;<i> behaviour in the client HTTP traffic.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> OK.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> My vote on this is -0. Too many problems and still no clear 
</I>&gt;&gt;&gt;&gt;<i> use-case has been described[1] for this to be a reasonable 
</I>&gt;&gt;&gt;&gt;<i> addition.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> OK. I tried to do most  of the fixes you are suggested. I hope
</I>&gt;&gt;&gt;<i> it is OK.
</I>&gt;&gt;&gt;<i> 
</I>
Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUayy4AAoJELJo5wb/XPRjjRQH/A2yT762PpCFLTIPzHI9RSaM
FoeNfzC6Z+Gf29eWgcCkzBQMCOJjm3G950IK4BWtSd5OivI/7zAJO6KY3YQ4dnfc
KXU3+E+DrOYHdmhljBaPDYbOA9mCfMaCH32jISYTTtDYBEvNuQh1KSPh5so63aGV
u4SVCGkISACAUATy+vaeKTR4ry0c0XYDc+l55E7LvQLNJlRyQYb2H9DG2YjV8j6h
l/gNlwK0K9VJAOu0+B3GmdNSEwW05i7mdSDqw2zuuLdaORizyDpHb/IgzHAjBi9D
zZl6kxAngzfooBxwnllOnr1eTzRSAoGe7NmZMPhh89K/olGvF2I9bbefqzXHiL4=
=X+Xo
-----END PGP SIGNATURE-----
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000413.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
	<LI>Next message: <A HREF="000431.html">[squid-dev] [PATCH] url_rewrite_timeout directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#415">[ date ]</a>
              <a href="thread.html#415">[ thread ]</a>
              <a href="subject.html#415">[ subject ]</a>
              <a href="author.html#415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
