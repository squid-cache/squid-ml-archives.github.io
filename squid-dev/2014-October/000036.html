<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] pconn_lifetime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C542E6AA8.7050506%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000032.html">
   <LINK REL="Next"  HREF="000038.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] pconn_lifetime</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C542E6AA8.7050506%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] pconn_lifetime">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Fri Oct  3 09:21:44 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000032.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
        <LI>Next message: <A HREF="000038.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36">[ date ]</a>
              <a href="thread.html#36">[ thread ]</a>
              <a href="subject.html#36">[ subject ]</a>
              <a href="author.html#36">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/02/2014 08:24 AM, Amos Jeffries wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 2/10/2014 5:23 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> Ping....
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So which is the decision? Can the patch go to trunk? Should the
</I>&gt;&gt;<i> patch replaced with on other solution?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> We already have client_lifetime directive which is documented as doing
</I>&gt;<i> exactly what this new directive does.
</I>&gt;<i> (&lt;<A HREF="http://www.squid-cache.org/Doc/config/client_lifetime/">http://www.squid-cache.org/Doc/config/client_lifetime/</A>&gt;).
</I>&gt;<i>
</I>&gt;<i> However, what that directive *actually* does is very different from
</I>&gt;<i> the documented behaviour - it is also used for controlling
</I>&gt;<i> between-request idle timeout (breaking client_idle_pconn_timeout by
</I>&gt;<i> making it 1 week!) and also server request timout (pretending to be a
</I>&gt;<i> timeout for duration between sending request and starting to read reply).
</I>

My sense is that the client_lifetime is a timeout, which should 
triggered when the client waits for long time an HTTP or ICAP or DNS 
server to finish.
Probably should renamed to &quot;client_wait_for_activity_timeout&quot; and 
documentation should adapted. Also probably we need to fix it a little.

However it make sense to me a such timeout parameter. It is used in the 
case:
   &quot;The web browser, waits 1 minute the dns server to respond, 1 minute 
helper to finish, 1 minute the ICAP server to respond, 2 minutes the 
HTTP server send first bytes of the answer, please close this connection 
I am not interested any more for the response...&quot;

I should note that the pconn_lifetime has effect to server side 
connections too. And also try to not halt a served transaction. Only 
triggered after the transaction is finished, or while we are waiting for 
new requests.
It is a timeout used by administrators to resolve a problem without 
affecting active transactions.
There are major differences in use cases.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I think extending it to a better solution for the above bugs and
</I>&gt;<i> scoping correctly.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 1) In the existing client_side_reply.cc keep-alive conditions there
</I>&gt;<i> exists a line:
</I>&gt;<i>
</I>&gt;<i>   else if (http-&gt;getConn() &amp;&amp; http-&gt;getConn()-&gt;port-&gt;listenConn == NULL)
</I>&gt;<i>
</I>&gt;<i> your patch retains it as:
</I>&gt;<i>    if (http-&gt;getConn()-&gt;port-&gt;listenConn == NULL)
</I>&gt;<i>
</I>&gt;<i>   - this check is *supposed* to be the check for when, as you put it
</I>&gt;<i> &quot;environments with long-lived connections where Squid configuration
</I>&gt;<i> ... change during a single connection lifetime.&quot;
</I>&gt;<i>   - that is buggy. A check of !Comm::IsConnOpen() is what will
</I>&gt;<i> determine a live/dead listener socket.
</I>
This is should fixed.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2) There is more work to do to integrate it properly with the existing
</I>&gt;<i> pconn timeout and lifetime directives.
</I>&gt;<i>
</I>&gt;<i> I request that we include these in this patch:
</I>&gt;<i>
</I>&gt;<i>   * change ConnStateData::clientParseRequests() to use
</I>&gt;<i> conn-&gt;timeLeft(Config.Timeout.clientIdlePconn) when setting timeout
</I>&gt;<i> between requests.
</I>&gt;<i>   - this is another bug in the existing code that is retained by your
</I>&gt;<i> patch and needs fixing.
</I>&gt;<i>
</I>
I think this change should not be done.
We may affect an valid existing request. If the timeLeft() is very 
short, we may have timeout while waiting data from helpers or ICAP server.

We need a client_wait_for_activity_timeout here.
This is what the &quot;client_lifetime&quot; now does.


&gt;<i>   * change your new directive &quot;pconn_lifetime&quot; to be
</I>&gt;<i> &quot;client_pconn_lifetime&quot; since it is specifically scoped to client
</I>&gt;<i> browser connections.
</I>&gt;<i>   - keeping or updating the client_lifetime documentation.
</I>&gt;<i>
</I>&gt;<i>   * add some new directive (or find existing one that supposed to be
</I>&gt;<i> applied) for the server waiting-for-reply timout period.
</I>&gt;<i>   - use that instead of Config.Timeout.lifetime in src/http.cc
</I>&gt;<i>
</I>&gt;<i>   * update tunnel.cc client connection timeouts to use conn-&gt;timeLeft().
</I>&gt;<i>    - maybe with some new tunnel-specific lifetime config item. But I
</I>&gt;<i> think your new config lifetime is appropriate for now at least.
</I>&gt;<i>
</I>&gt;<i> NP: at this point Config.Timeout.lifetime should not be used anywhere
</I>&gt;<i> in Squid and can be dropped.
</I>&gt;<i>
</I>&gt;<i>   * check the SSL code where Config.Timeout.lifetime is mentioned in
</I>&gt;<i> comment to see if the timeout there is still relevant. Probably is but
</I>&gt;<i> needs checking and the comment updating.
</I>
So you are suggesting to use two configuration parameters here. One for 
client_side connections and one for server side.

We need to require a Lifetime value in Comm::Connection constructor, for 
this. It will make this patch a little big, but it can be implemented 
without huge changes.

But still I am not sure that we should use different parameters for 
server and client connections....


&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Optional / future work:
</I>&gt;<i>
</I>&gt;<i> A) this depends on having a matching/symmetrical server_pconn_lifetime
</I>&gt;<i> directive for the server connections.
</I>&gt;<i>
</I>&gt;<i> Since there would be separate lifetimes for each 'side', I think we
</I>&gt;<i> should followup with a patch making a Comm::Connection::startTime_ be
</I>&gt;<i> initialized by Comm::TcpAcceptor() and Comm::ConnOpener() with the
</I>&gt;<i> relevant lifetime.
</I>&gt;<i>
</I>&gt;<i> Then timeLeft() method does not need dependency on SquidConfig.h and
</I>&gt;<i> connection lifetimes will actually be predictable across a
</I>&gt;<i> reconfigure. At present a reconfigure changing lifetime will change
</I>&gt;<i> some connections but not others depending on whether they actually
</I>&gt;<i> receive a request between the reconfigure and one of the two old/new
</I>&gt;<i> lifetimes.
</I>&gt;<i>
</I>&gt;<i> B) after the above we can also de-duplicate the timeLeft(X) calls to
</I>&gt;<i> one inside commSetConnTimeout().
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000032.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
	<LI>Next message: <A HREF="000038.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36">[ date ]</a>
              <a href="thread.html#36">[ thread ]</a>
              <a href="subject.html#36">[ subject ]</a>
              <a href="author.html#36">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
