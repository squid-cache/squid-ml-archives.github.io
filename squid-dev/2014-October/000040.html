<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] pconn_lifetime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C542EE392.4080700%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000037.html">
   <LINK REL="Next"  HREF="000045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] pconn_lifetime</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C542EE392.4080700%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] pconn_lifetime">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct  3 17:57:38 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000037.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
        <LI>Next message: <A HREF="000045.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40">[ date ]</a>
              <a href="thread.html#40">[ thread ]</a>
              <a href="subject.html#40">[ subject ]</a>
              <a href="author.html#40">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 4/10/2014 3:52 a.m., Alex Rousskov wrote:
&gt;<i> On 10/01/2014 11:24 PM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> We already have client_lifetime directive which is documented as 
</I>&gt;&gt;<i> doing exactly what this new directive does. 
</I>&gt;&gt;<i> (&lt;<A HREF="http://www.squid-cache.org/Doc/config/client_lifetime/">http://www.squid-cache.org/Doc/config/client_lifetime/</A>&gt;).
</I>&gt;<i> 
</I>&gt;<i> No, client_lifetime is not documented (and is not meant) to do what
</I>&gt;<i> we want pconn_lifetime to do. Client_lifetime is supposed to kill
</I>&gt;<i> client connections exceeding the configured lifetime, _regardless_
</I>&gt;<i> of the client (and client connection) state. We do not want that
</I>&gt;<i> for pconn_lifetime which only affects _idle_ connections.
</I>
Lets have a look at that documentation then...

<A HREF="http://www.squid-cache.org/Doc/config/client_lifetime/">http://www.squid-cache.org/Doc/config/client_lifetime/</A> :
&quot;
The maximum amount of time a client (browser) is allowed to
remain connected to the cache process.
&quot;

 - scope: &quot;client (browser)&quot;

And Christos patch description:
&quot;
the desired maximum lifetime of a persistent connection.
&quot;

Having read through the patch. What it does is *only* set a timer
running when the client connection is accepted, and limits (most)
timeouts applied later on that connection to be no more than the
configured total.

 - scope implied: all client (browser) connections


Christos patch is therefore implementing the _documented_ behaviour of
client_lifetime.


Sadly the actual current implementation of client_lifetime does
several undocumented and IMO wrong things.

What asked for is that those wrong things get moved to other
directives so they can still be controlled. And that client_lifetime
configure the new logic so that people using it already will actually
start to see it working as documented.

&gt;<i> 
</I>&gt;<i> Moreover, pconn_lifetime is meant to apply to all connections, not 
</I>&gt;<i> just the connections from a client.
</I>
Then Christos patch is seriously incomplete, because it only affects
connections arriving from clients. The lifetime is never set on any of
the other types of connection that make up &quot;all&quot;.

&gt;<i> 
</I>&gt;&gt;<i> * change your new directive &quot;pconn_lifetime&quot; to be 
</I>&gt;&gt;<i> &quot;client_pconn_lifetime&quot; since it is specifically scoped to client
</I>&gt;&gt;<i>  browser connections.
</I>&gt;<i> 
</I>&gt;<i> pconn_lifetime is not exclusive to client browser connections. 
</I>&gt;<i> Ideally, it should apply to _all_ Squid connections that are in an 
</I>&gt;<i> &quot;idle persistent connection&quot; state. We are not there yet, but we 
</I>&gt;<i> already support origin connections AFAIK.
</I>
The patch code presented does none of what you say above.
 - it *is* limited only to client connections,
 - it is *not* limited to measuring idle connections,
 - it is *not* limited to persistent connections,


Ironically, client_lifetime directives current implementation does
what you are describing. It starts measuring from the beginning of
client connections idle period (violating the documented behaviour),
and gets cleared when the connection stops being idle. For server
connections it strangely starts counting from end of the idle period
when the request is sent until reply come back.


&gt;<i> 
</I>&gt;&gt;<i> * update tunnel.cc client connection timeouts to use 
</I>&gt;&gt;<i> conn-&gt;timeLeft(). - maybe with some new tunnel-specific lifetime 
</I>&gt;&gt;<i> config item. But I think your new config lifetime is appropriate 
</I>&gt;&gt;<i> for now at least.
</I>&gt;<i> 
</I>&gt;<i> There is no concept of &quot;idle persistent connection&quot; for TCP tunnels
</I>&gt;<i> so we should not apply pconn_lifetime to them right now.
</I>
You added &quot;idle&quot; to that description. The code in question *does not*
limit itself to idle connections, nor persistent connections.

Christos description (and the patch) is applied to all client
connections. Without &quot;idle&quot;, tunnels do indeed meet the description of
a &quot;persistent connection&quot; and the timout I'm mentioning above is the
one being applied on the client end of the tunnel.

In fact Christos patch sets pconn_lifetime timeout on tunnel
connections to measure the parse and setup, then reverts to using
client_lifetime &quot;maximum connection time&quot; to cover the tunnel idle
periods *individually* (violating the documented behaviour of both).


So do we at least have a consensus on terminology:

 That &quot;lifetime&quot; for a connection means from its opening
accept()/connect() to its close()  ??

 That the bits named FOO_timeout means some duration of that lifetime
spent doing a &quot;FOO&quot; ??


Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJULuOSAAoJELJo5wb/XPRj33oH+gJWtnnL+ygHj4BhVejy3l/V
Nq2XdU16stxwIC5mqUHUi0WfEdG2V25qI7z8KtKEaqjk94hRx2iV+xaq1kZ+dhM2
sGvdlxm4J/9xLCc+vn6EHddhzEWo+x1zp3F0GuM3MjiEkA15r0q6M0KtzVUai5Rw
WUyPlJkQik/oLqO928WZwy9Yl6uJIjWYwNkOysf0/is7DgLfKKMkzOX5M+0MWbKU
8p3ElDCmzJKmteZ1K+xA1B+U8p5yQIT61sb2xgSQTr1YbvT115K2+0Za92qM6Lmj
uUoOw+JwPKBE3ymGmuWko6l6j+N47FW4ioTmyEoL+6Lel2WQH6nrd298NjnwNFI=
=Q2bq
-----END PGP SIGNATURE-----
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000037.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
	<LI>Next message: <A HREF="000045.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40">[ date ]</a>
              <a href="thread.html#40">[ thread ]</a>
              <a href="subject.html#40">[ subject ]</a>
              <a href="author.html#40">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
