<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] pconn_lifetime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C542EF1E3.10109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000041.html">
   <LINK REL="Next"  HREF="000064.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] pconn_lifetime</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C542EF1E3.10109%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] pconn_lifetime">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct  3 18:58:43 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000041.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
        <LI>Next message: <A HREF="000064.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42">[ date ]</a>
              <a href="thread.html#42">[ thread ]</a>
              <a href="subject.html#42">[ subject ]</a>
              <a href="author.html#42">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 3/10/2014 10:21 p.m., Tsantilas Christos wrote:
&gt;<i> On 10/02/2014 08:24 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA1
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 2/10/2014 5:23 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;<i> Ping....
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> So which is the decision? Can the patch go to trunk? Should
</I>&gt;&gt;&gt;<i> the patch replaced with on other solution?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We already have client_lifetime directive which is documented as
</I>&gt;&gt;<i> doing exactly what this new directive does. 
</I>&gt;&gt;<i> (&lt;<A HREF="http://www.squid-cache.org/Doc/config/client_lifetime/">http://www.squid-cache.org/Doc/config/client_lifetime/</A>&gt;).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> However, what that directive *actually* does is very different
</I>&gt;&gt;<i> from the documented behaviour - it is also used for controlling 
</I>&gt;&gt;<i> between-request idle timeout (breaking client_idle_pconn_timeout
</I>&gt;&gt;<i> by making it 1 week!) and also server request timout (pretending
</I>&gt;&gt;<i> to be a timeout for duration between sending request and starting
</I>&gt;&gt;<i> to read reply).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My sense is that the client_lifetime is a timeout, which should 
</I>&gt;<i> triggered when the client waits for long time an HTTP or ICAP or
</I>&gt;<i> DNS server to finish. Probably should renamed to
</I>&gt;<i> &quot;client_wait_for_activity_timeout&quot; and documentation should
</I>&gt;<i> adapted. Also probably we need to fix it a little.
</I>
We already have a lot of different *_timeout directives being used for
activities. Each one named for the activity being watched.

What I am hearing you requesting, and seeing in your code, is a total
since-opened timeout. Covering all actions on that connection.


&gt;<i> 
</I>&gt;<i> However it make sense to me a such timeout parameter. It is used in
</I>&gt;<i> the case: &quot;The web browser, waits 1 minute the dns server to
</I>&gt;<i> respond, 1 minute helper to finish, 1 minute the ICAP server to
</I>&gt;<i> respond, 2 minutes the HTTP server send first bytes of the answer,
</I>&gt;<i> please close this connection I am not interested any more for the
</I>&gt;<i> response...&quot;
</I>&gt;<i> 
</I>&gt;<i> I should note that the pconn_lifetime has effect to server side 
</I>&gt;<i> connections too. And also try to not halt a served transaction.
</I>&gt;<i> Only triggered after the transaction is finished, or while we are
</I>&gt;<i> waiting for new requests.
</I>
Yes, I noted that, and agree it is a good decision.

&gt;<i> It is a timeout used by administrators to resolve a problem
</I>&gt;<i> without affecting active transactions. There are major differences
</I>&gt;<i> in use cases.
</I>&gt;<i> 
</I>
There is a lot of similarity here with:
* request_timeout which counts down the period between accept() and
first request bytes arriving, and
* client_idle_pconn_timeout which counts down the period between requests.

Although both those count in time relative to the current idle
activity, instead of time since connection accept().

I note that you said this pconn_lifetime did not need coding for ICAP
or server connections since those were stored in Pconn/Idle pools. The
Idle pool timeouts only count from start of idle period, just like
client_idle_pconn_timeout.
 So either request_timeout/client_idle_pconn_timeout make
pconn_lifetime needless or pconn_lifetime needs some since-connect()
equivalent on server connections (and ICAP).


I think your choice of scoping &quot;lifetime&quot; as since-accept() is right.


&gt;&gt;<i> 
</I>&gt;&gt;<i> I think extending it to a better solution for the above bugs and 
</I>&gt;&gt;<i> scoping correctly.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1) In the existing client_side_reply.cc keep-alive conditions
</I>&gt;&gt;<i> there exists a line:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> else if (http-&gt;getConn() &amp;&amp; http-&gt;getConn()-&gt;port-&gt;listenConn ==
</I>&gt;&gt;<i> NULL)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> your patch retains it as: if (http-&gt;getConn()-&gt;port-&gt;listenConn
</I>&gt;&gt;<i> == NULL)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> - this check is *supposed* to be the check for when, as you put
</I>&gt;&gt;<i> it &quot;environments with long-lived connections where Squid
</I>&gt;&gt;<i> configuration ... change during a single connection lifetime.&quot; -
</I>&gt;&gt;<i> that is buggy. A check of !Comm::IsConnOpen() is what will 
</I>&gt;&gt;<i> determine a live/dead listener socket.
</I>&gt;<i> 
</I>&gt;<i> This is should fixed.
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 2) There is more work to do to integrate it properly with the
</I>&gt;&gt;<i> existing pconn timeout and lifetime directives.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I request that we include these in this patch:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> * change ConnStateData::clientParseRequests() to use 
</I>&gt;&gt;<i> conn-&gt;timeLeft(Config.Timeout.clientIdlePconn) when setting
</I>&gt;&gt;<i> timeout between requests. - this is another bug in the existing
</I>&gt;&gt;<i> code that is retained by your patch and needs fixing.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I think this change should not be done. We may affect an valid
</I>&gt;<i> existing request. If the timeLeft() is very short, we may have
</I>&gt;<i> timeout while waiting data from helpers or ICAP server.
</I>
Your patch is already setting keepalive=false when the pipeline may
have others still waiting responses, and in fact some of those may be
fully serviced by a server and only awaiting their reply data to be
written to the client.

If you want lifetime to have no bad side effects on a client
connection, then you need the timeout handler for it to set the client
connection to half-closed (no more reading) and let the existing
transactions (all of them) complete.

If you are doing the half-closed action, then it is better to set idle
timeout using timeLeft() in ConnStateData::clientParseRequests()
instead of playing with requests keep-alive flags.


&gt;<i> 
</I>&gt;<i> We need a client_wait_for_activity_timeout here. This is what the
</I>&gt;<i> &quot;client_lifetime&quot; now does.
</I>&gt;<i> 
</I>
No it waits for a random request and sets the keepalive flag to close.
Activity on other requests is *probably* pending.

&gt;<i> 
</I>&gt;&gt;<i> * change your new directive &quot;pconn_lifetime&quot; to be 
</I>&gt;&gt;<i> &quot;client_pconn_lifetime&quot; since it is specifically scoped to
</I>&gt;&gt;<i> client browser connections. - keeping or updating the
</I>&gt;&gt;<i> client_lifetime documentation.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> * add some new directive (or find existing one that supposed to
</I>&gt;&gt;<i> be applied) for the server waiting-for-reply timout period. - use
</I>&gt;&gt;<i> that instead of Config.Timeout.lifetime in src/http.cc
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> * update tunnel.cc client connection timeouts to use
</I>&gt;&gt;<i> conn-&gt;timeLeft(). - maybe with some new tunnel-specific lifetime
</I>&gt;&gt;<i> config item. But I think your new config lifetime is appropriate
</I>&gt;&gt;<i> for now at least.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> NP: at this point Config.Timeout.lifetime should not be used
</I>&gt;&gt;<i> anywhere in Squid and can be dropped.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> * check the SSL code where Config.Timeout.lifetime is mentioned
</I>&gt;&gt;<i> in comment to see if the timeout there is still relevant.
</I>&gt;&gt;<i> Probably is but needs checking and the comment updating.
</I>&gt;<i> 
</I>&gt;<i> So you are suggesting to use two configuration parameters here. One
</I>&gt;<i> for client_side connections and one for server side.
</I>&gt;<i> 
</I>&gt;<i> We need to require a Lifetime value in Comm::Connection
</I>&gt;<i> constructor, for this. It will make this patch a little big, but it
</I>&gt;<i> can be implemented without huge changes.
</I>
Optional parameter I think. It will not be used everywhere just yet.

&gt;<i> 
</I>&gt;<i> But still I am not sure that we should use different parameters
</I>&gt;<i> for server and client connections....
</I>&gt;<i> 
</I>
See my last post to Alex.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJULvHjAAoJELJo5wb/XPRjMN0H/04IqpUy5FxNwp9XrYIYkyFh
V9iwzGyz4VeyCVFrRw57mAPtS+Wf8TIbCMhQtWjpM1jeMiaL3T3ljpr+YmTnYplK
NIOJBcBNMu2/HWpMiGlqffk9wtPhGJJEcRhsdut05AOD0QPCJYUIhR17JZO0aecL
z2mnoITfK60e5sD1B1iqRRXR+D98LqZl4/ykOVhmxv6riqZzOe4Hy3qglZpvI4f8
z+I382AbDa86iapDOM9oBttK2K8ut1+CSlk2hhEVHme3ZJTJqPvuyWkpUbUiniNb
vNWaaHDZZNxwk9EUHx94nCgLP0SSI2OLTpud0lsUTHRAd8OQ3SPuq1uYnYrXMEw=
=If6c
-----END PGP SIGNATURE-----
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000041.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
	<LI>Next message: <A HREF="000064.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42">[ date ]</a>
              <a href="thread.html#42">[ thread ]</a>
              <a href="subject.html#42">[ subject ]</a>
              <a href="author.html#42">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
