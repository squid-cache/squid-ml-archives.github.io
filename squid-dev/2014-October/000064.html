<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] pconn_lifetime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C54329163.6030600%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000042.html">
   <LINK REL="Next"  HREF="000037.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] pconn_lifetime</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20pconn_lifetime&In-Reply-To=%3C54329163.6030600%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] pconn_lifetime">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Mon Oct  6 12:56:03 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000042.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
        <LI>Next message: <A HREF="000037.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64">[ date ]</a>
              <a href="thread.html#64">[ thread ]</a>
              <a href="subject.html#64">[ subject ]</a>
              <a href="author.html#64">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/03/2014 09:58 PM, Amos Jeffries wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 3/10/2014 10:21 p.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> On 10/02/2014 08:24 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA1
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 2/10/2014 5:23 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;<i> Ping....
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> So which is the decision? Can the patch go to trunk? Should
</I>&gt;&gt;&gt;&gt;<i> the patch replaced with on other solution?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We already have client_lifetime directive which is documented as
</I>&gt;&gt;&gt;<i> doing exactly what this new directive does.
</I>&gt;&gt;&gt;<i> (&lt;<A HREF="http://www.squid-cache.org/Doc/config/client_lifetime/">http://www.squid-cache.org/Doc/config/client_lifetime/</A>&gt;).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> However, what that directive *actually* does is very different
</I>&gt;&gt;&gt;<i> from the documented behaviour - it is also used for controlling
</I>&gt;&gt;&gt;<i> between-request idle timeout (breaking client_idle_pconn_timeout
</I>&gt;&gt;&gt;<i> by making it 1 week!) and also server request timout (pretending
</I>&gt;&gt;&gt;<i> to be a timeout for duration between sending request and starting
</I>&gt;&gt;&gt;<i> to read reply).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My sense is that the client_lifetime is a timeout, which should
</I>&gt;&gt;<i> triggered when the client waits for long time an HTTP or ICAP or
</I>&gt;&gt;<i> DNS server to finish. Probably should renamed to
</I>&gt;&gt;<i> &quot;client_wait_for_activity_timeout&quot; and documentation should
</I>&gt;&gt;<i> adapted. Also probably we need to fix it a little.
</I>&gt;<i>
</I>&gt;<i> We already have a lot of different *_timeout directives being used for
</I>&gt;<i> activities. Each one named for the activity being watched.
</I>&gt;<i>
</I>&gt;<i> What I am hearing you requesting, and seeing in your code, is a total
</I>&gt;<i> since-opened timeout. Covering all actions on that connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However it make sense to me a such timeout parameter. It is used in
</I>&gt;&gt;<i> the case: &quot;The web browser, waits 1 minute the dns server to
</I>&gt;&gt;<i> respond, 1 minute helper to finish, 1 minute the ICAP server to
</I>&gt;&gt;<i> respond, 2 minutes the HTTP server send first bytes of the answer,
</I>&gt;&gt;<i> please close this connection I am not interested any more for the
</I>&gt;&gt;<i> response...&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I should note that the pconn_lifetime has effect to server side
</I>&gt;&gt;<i> connections too. And also try to not halt a served transaction.
</I>&gt;&gt;<i> Only triggered after the transaction is finished, or while we are
</I>&gt;&gt;<i> waiting for new requests.
</I>&gt;<i>
</I>&gt;<i> Yes, I noted that, and agree it is a good decision.
</I>&gt;<i>
</I>&gt;&gt;<i> It is a timeout used by administrators to resolve a problem
</I>&gt;&gt;<i> without affecting active transactions. There are major differences
</I>&gt;&gt;<i> in use cases.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There is a lot of similarity here with:
</I>&gt;<i> * request_timeout which counts down the period between accept() and
</I>&gt;<i> first request bytes arriving, and
</I>&gt;<i> * client_idle_pconn_timeout which counts down the period between requests.
</I>&gt;<i>
</I>&gt;<i> Although both those count in time relative to the current idle
</I>&gt;<i> activity, instead of time since connection accept().
</I>&gt;<i>
</I>&gt;<i> I note that you said this pconn_lifetime did not need coding for ICAP
</I>&gt;<i> or server connections since those were stored in Pconn/Idle pools. The
</I>&gt;<i> Idle pool timeouts only count from start of idle period, just like
</I>&gt;<i> client_idle_pconn_timeout.
</I>&gt;<i>   So either request_timeout/client_idle_pconn_timeout make
</I>&gt;<i> pconn_lifetime needless or pconn_lifetime needs some since-connect()
</I>&gt;<i> equivalent on server connections (and ICAP).
</I>
My sense is that the pconn_lifetime scoping lifetime since-connect in 
this patch.
Am I wrong, is there any bug to this patch?

&gt;<i>
</I>&gt;<i> I think your choice of scoping &quot;lifetime&quot; as since-accept() is right.
</I>&gt;<i>
</I>
....
&gt;<i>
</I>&gt;&gt;&gt;<i> 2) There is more work to do to integrate it properly with the
</I>&gt;&gt;&gt;<i> existing pconn timeout and lifetime directives.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I request that we include these in this patch:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * change ConnStateData::clientParseRequests() to use
</I>&gt;&gt;&gt;<i> conn-&gt;timeLeft(Config.Timeout.clientIdlePconn) when setting
</I>&gt;&gt;&gt;<i> timeout between requests. - this is another bug in the existing
</I>&gt;&gt;&gt;<i> code that is retained by your patch and needs fixing.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think this change should not be done. We may affect an valid
</I>&gt;&gt;<i> existing request. If the timeLeft() is very short, we may have
</I>&gt;&gt;<i> timeout while waiting data from helpers or ICAP server.
</I>&gt;<i>
</I>&gt;<i> Your patch is already setting keepalive=false when the pipeline may
</I>&gt;<i> have others still waiting responses, and in fact some of those may be
</I>&gt;<i> fully serviced by a server and only awaiting their reply data to be
</I>&gt;<i> written to the client.
</I>
However it is not the same as aborting a served transaction (including 
POST or PUT requests)

&gt;<i>
</I>&gt;<i> If you want lifetime to have no bad side effects on a client
</I>&gt;<i> connection, then you need the timeout handler for it to set the client
</I>&gt;<i> connection to half-closed (no more reading) and let the existing
</I>&gt;<i> transactions (all of them) complete.
</I>
Maybe this is a good optimization, and probably we should add it to this 
patch.

&gt;<i> If you are doing the half-closed action, then it is better to set idle
</I>&gt;<i> timeout using timeLeft() in ConnStateData::clientParseRequests()
</I>&gt;<i> instead of playing with requests keep-alive flags.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We need a client_wait_for_activity_timeout here. This is what the
</I>&gt;&gt;<i> &quot;client_lifetime&quot; now does.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No it waits for a random request and sets the keepalive flag to close.
</I>&gt;<i> Activity on other requests is *probably* pending.
</I>

Currently the client_lifetime now is set to client_side connection after 
we received all of the HTTP request. This is not a connection lifetime 
timeout.

Also set this read timeout to squid-to-server connection after sent all 
HTTP request.

We may read new HTTP pipelined requests on this connection, but we may 
not read. This timeout will be triggered when no input data come to this 
connection for the timeout period.

 From what I can understand reading the code (not the documentation), is 
that this timeout intended to abort connection which does not have any 
activity for long time. This is why this timeout has big value.
Most possible is that the client will wait all of this time for an 
answer from squid, or client already hclosed the connection but for a 
reason squid did not know it.

Also when this timeout triggered squid will just close client-side 
connection. No keep-alive flag is set.

We may want to change the current behaviour of this cfg parameter, but 
my opinion is that we should fix the documentation, and cfg parameter 
name ...







</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000042.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
	<LI>Next message: <A HREF="000037.html">[squid-dev] [PATCH] pconn_lifetime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64">[ date ]</a>
              <a href="thread.html#64">[ thread ]</a>
              <a href="subject.html#64">[ subject ]</a>
              <a href="author.html#64">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
