<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Non-HTTP bypass
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-HTTP%20bypass&In-Reply-To=%3C543EBD3B.40408%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000128.html">
   <LINK REL="Next"  HREF="000170.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Non-HTTP bypass</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-HTTP%20bypass&In-Reply-To=%3C543EBD3B.40408%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] Non-HTTP bypass">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Wed Oct 15 18:30:19 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000128.html">[squid-dev] Jenkins build is back to normal :	3.HEAD-amd64-centos-7-clang #59
</A></li>
        <LI>Next message: <A HREF="000170.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#131">[ date ]</a>
              <a href="thread.html#131">[ thread ]</a>
              <a href="subject.html#131">[ subject ]</a>
              <a href="author.html#131">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Intercepting proxies often receive non-HTTP connections. Squid cannot 
currently deal with such connections well because it assumes that a 
given port receives HTTP, FTP, or HTTPS traffic exclusively. This patch 
allows Squid to tunnel unexpected connections instead of terminating 
them with an error.

This patch:
    -Defines an unexpected connection as a connection that resulted in a 
Squid error during first request parsing. Which errors trigger tunneling 
behavior is configurable by the admin using ACLs.

   - Adds &quot;on_first_request_error&quot;, a new ACL-driven squid.conf 
directive that can be used to establish a blind TCP tunnel which relays 
all bytes from/to the intercepted connection to/from the intended 
destination address. See the sketch above.
The on_first_request_error directive supports fast ACLs only.

   - Adds &quot;squid_error&quot;, a new ACL type to match transactions that 
triggered a given Squid error. Squid error IDs are used to configure one 
or more errors to match. This is similar to the existing ssl_error ACL 
type but works with Squid-generated errors rather than SSL library errors.

   - Adds &quot;ERR_WRONG_PROTOCOL&quot;, a new Squid error triggered for 
http_port connections that start with something that lacks even basic 
HTTP request structure. This error is triggered by the HTTP request 
parser, and probably only when/after the current parsing code detects an 
error.

   Adds &quot;request_start_timeout&quot;, a new squid.conf directive to trigger a 
new Squid ERR_REQUEST_START_TIMEOUT error if no bytes are received from 
the client on a newly established http_port connection during the 
configured time period. Applies to all http_ports (for now).

No support for tunneling through cache_peers is included. Configurations
that direct outgoing traffic through a peer may break Squid.

Configuration sketch:

    # define what Squid errors indicate receiving non-HTTP traffic:
    acl foreignProtocol squid_error ERR_WRONG_PROTOCOL ERR_TOO_BIG

    # define what Squid errors indicate receiving nothing:
    acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT

    # tunnel everything that does not look like HTTP:
    on_first_request_error tunnel foreignProtocol

    # tunnel if we think the client waits for the server to talk first:
    on_first_request_error tunnel serverTalksFirstProtocol

    # in all other error cases, just send an HTTP &quot;error page&quot; response:
    on_first_request_error respond all

    # Configure how long to wait for the first byte on the incoming
    # connection before raising an ERR_REQUEST_START_TIMEOUT error.
    request_start_timeout 5 seconds

For more informations please read patch preamble.

This is a Measurement Factory project

-------------- next part --------------
A non-text attachment was scrubbed...
Name: trunk-non-HTTP-bypass-v5.patch.gz
Type: application/x-tar
Size: 20858 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20141015/4d6c7a8f/attachment-0001.tar">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20141015/4d6c7a8f/attachment-0001.tar</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000128.html">[squid-dev] Jenkins build is back to normal :	3.HEAD-amd64-centos-7-clang #59
</A></li>
	<LI>Next message: <A HREF="000170.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#131">[ date ]</a>
              <a href="thread.html#131">[ thread ]</a>
              <a href="subject.html#131">[ subject ]</a>
              <a href="author.html#131">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
