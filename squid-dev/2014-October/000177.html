<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Non-HTTP bypass
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-HTTP%20bypass&In-Reply-To=%3C54476707.2080204%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000175.html">
   <LINK REL="Next"  HREF="000178.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Non-HTTP bypass</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-HTTP%20bypass&In-Reply-To=%3C54476707.2080204%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] Non-HTTP bypass">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Wed Oct 22 08:12:55 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000175.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
        <LI>Next message: <A HREF="000178.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#177">[ date ]</a>
              <a href="thread.html#177">[ thread ]</a>
              <a href="subject.html#177">[ subject ]</a>
              <a href="author.html#177">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/21/2014 04:29 PM, Amos Jeffries wrote:
&gt;<i> 2) All changes in src/tunnel.cc seem to be needless.
</I>
Some changes are required!

&gt;<i>   - tunnelStartShovelling() should *always* be the entrypoint to begin
</I>&gt;<i> transmit on a tunnel in any direction. At that point there is maybe
</I>&gt;<i> client data to send to server ...
</I>
Yes.

&gt;<i>   - The socket may not even permit one whole TCP_RCV_BUF worth of bytes
</I>&gt;<i> to be written in a single action. comm_write can handle that just fine.
</I>&gt;<i> If comm_write is unable to handle all the available conn-&gt;in.buf in one
</I>&gt;<i> comm_write() call then that would be a bug in comm to fix separate from
</I>&gt;<i> all this.
</I>
This is true. However we are using two buffers to read/write to/from 
server/client. The TunnelState::client::buf and TunnelState::server::buf 
which are of size SQUID_TCP_SO_RCVBUF

At early stages of this patch I tried to convert these buffers to SBufs 
, but required many changes in the tunnel.cc code, so I revert the 
changes and finally implemented the  TunnelStateData::copyClientBytes 
member.

&gt;<i>   There is simply no reason to add an extra if
</I>&gt;<i> (preReadClientData.length()) conditional in *every* packet I/O cycle.
</I>

As you can see the old code copies the ConnStateData::in-&gt;buf data to 
TunnelStateData-&gt;client.buf buffer. This is because in the case you are 
read a CONNECT request you can be sure that the extra bytes you read are 
not hugger than the SQUID_TCP_SO_RCVBUF.

But for this patch imagine the case where:
   - Squid configured with:
        request_header_max_size 70kbs
   - Client sends something which looks like an HTTP request eg:
         AMETHOD [spaces]* string [spaces]* ... Other data
     Also assume that this is more than the size of 70k.
   - Squid will read 70k before decide that this is not an HTTP request.
   - The 70k are not fit to TunnelStateData-&gt;client.buf

An alternate solution is to add some code to build/fix 
TunnelStateData-&gt;client.buf to have the required size.
I need to recheck, but looks a good solution.
Is it ok?

&gt;<i>
</I>&gt;<i> Cheers
</I>&gt;<i> Amos
</I>&gt;<i>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000175.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
	<LI>Next message: <A HREF="000178.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#177">[ date ]</a>
              <a href="thread.html#177">[ thread ]</a>
              <a href="subject.html#177">[ subject ]</a>
              <a href="author.html#177">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
