<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Non-HTTP bypass
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-HTTP%20bypass&In-Reply-To=%3C5447A6B6.1050904%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000177.html">
   <LINK REL="Next"  HREF="000181.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Non-HTTP bypass</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-HTTP%20bypass&In-Reply-To=%3C5447A6B6.1050904%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Non-HTTP bypass">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 22 12:44:38 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="000177.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
        <LI>Next message: <A HREF="000181.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#178">[ date ]</a>
              <a href="thread.html#178">[ thread ]</a>
              <a href="subject.html#178">[ subject ]</a>
              <a href="author.html#178">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 22/10/2014 9:12 p.m., Tsantilas Christos wrote:
&gt;<i> On 10/21/2014 04:29 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> 2) All changes in src/tunnel.cc seem to be needless.
</I>&gt;<i> 
</I>&gt;<i> Some changes are required!
</I>&gt;<i> 
</I>&gt;&gt;<i> - tunnelStartShovelling() should *always* be the entrypoint to
</I>&gt;&gt;<i> begin transmit on a tunnel in any direction. At that point there
</I>&gt;&gt;<i> is maybe client data to send to server ...
</I>&gt;<i> 
</I>&gt;<i> Yes.
</I>&gt;<i> 
</I>&gt;&gt;<i> - The socket may not even permit one whole TCP_RCV_BUF worth of
</I>&gt;&gt;<i> bytes to be written in a single action. comm_write can handle
</I>&gt;&gt;<i> that just fine. If comm_write is unable to handle all the
</I>&gt;&gt;<i> available conn-&gt;in.buf in one comm_write() call then that would
</I>&gt;&gt;<i> be a bug in comm to fix separate from all this.
</I>&gt;<i> 
</I>&gt;<i> This is true. However we are using two buffers to read/write
</I>&gt;<i> to/from server/client. The TunnelState::client::buf and
</I>&gt;<i> TunnelState::server::buf which are of size SQUID_TCP_SO_RCVBUF
</I>&gt;<i> 
</I>&gt;<i> At early stages of this patch I tried to convert these buffers to
</I>&gt;<i> SBufs , but required many changes in the tunnel.cc code, so I
</I>&gt;<i> revert the changes and finally implemented the
</I>&gt;<i> TunnelStateData::copyClientBytes member.
</I>
Arg, sorry you are right. I forgot that my previous conversion to SBuf
did not make it through Alex audit requirements.

Is this an urgent need? or can we work on fixing that problem first to
reduce the changes this feature requires?

&gt;<i> 
</I>&gt;&gt;<i> There is simply no reason to add an extra if 
</I>&gt;&gt;<i> (preReadClientData.length()) conditional in *every* packet I/O
</I>&gt;&gt;<i> cycle.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> As you can see the old code copies the ConnStateData::in-&gt;buf data
</I>&gt;<i> to TunnelStateData-&gt;client.buf buffer. This is because in the case
</I>&gt;<i> you are read a CONNECT request you can be sure that the extra bytes
</I>&gt;<i> you read are not hugger than the SQUID_TCP_SO_RCVBUF.
</I>&gt;<i> 
</I>&gt;<i> But for this patch imagine the case where: - Squid configured
</I>&gt;<i> with: request_header_max_size 70kbs - Client sends something which
</I>&gt;<i> looks like an HTTP request eg: AMETHOD [spaces]* string [spaces]*
</I>&gt;<i> ... Other data Also assume that this is more than the size of 70k. 
</I>&gt;<i> - Squid will read 70k before decide that this is not an HTTP
</I>&gt;<i> request. - The 70k are not fit to TunnelStateData-&gt;client.buf
</I>&gt;<i> 
</I>&gt;<i> An alternate solution is to add some code to build/fix 
</I>&gt;<i> TunnelStateData-&gt;client.buf to have the required size. I need to
</I>&gt;<i> recheck, but looks a good solution. Is it ok?
</I>&gt;<i> 
</I>
Okay. I find it acceptible as a workaround for the buffer limitation.

I would rather see the limit fixed though. Alex and I have now almost
reached agreement on the Comm::Write API needed to SBuf the tunnel I/O
fully. If this bypass feature can wait for a while I will divert my
efforts to getting that completed now.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUR6a1AAoJELJo5wb/XPRjZ4EH+gL4YoDwKFWIzV9FvzYLGE0n
wxY1We5Nk3PqP3YH/BTMnoA0XMdQ9+SPd4sHFVhU3lnx/xUztI83i/2k18+6d4SH
Dl1NHS/pBsIkCvwJ6hc3ZDgG3+LTkHv5A0UuYqU5PbLkU63TPoNkFT6elfXZMNkL
8K/vSw75GpI+0AYGTw7NbqHuuG8XLM1CL8Y7jKug9SiZn9w/9RFsa4BmOZ4LYBa6
nQdjmus5dcdLk0OMF4oAGnR6XytzwjO47TiOywE9FcbzismKO/aRCdq5pV5sLJHe
xDTfcmB9OJiOvPbMLhlilWtc1oveoYtWsyKQy1kPk1tXj+/KPLi8HKEaN2onjg8=
=+Iz9
-----END PGP SIGNATURE-----
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000177.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
	<LI>Next message: <A HREF="000181.html">[squid-dev] [PATCH] Non-HTTP bypass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#178">[ date ]</a>
              <a href="thread.html#178">[ thread ]</a>
              <a href="subject.html#178">[ subject ]</a>
              <a href="author.html#178">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
