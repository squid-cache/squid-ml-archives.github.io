<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] splicing resumed sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C55267AF3.9000900%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002027.html">
   <LINK REL="Next"  HREF="002032.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] splicing resumed sessions</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C55267AF3.9000900%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] splicing resumed sessions">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr  9 13:13:23 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002027.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
        <LI>Next message: <A HREF="002032.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2029">[ date ]</a>
              <a href="thread.html#2029">[ thread ]</a>
              <a href="subject.html#2029">[ subject ]</a>
              <a href="author.html#2029">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/04/2015 10:53 p.m., Tsantilas Christos wrote:
&gt;<i> A new version of the patch.
</I>&gt;<i> 
</I>&gt;<i> This is removes the ssl_bump_resuming_sessions directive, includes many
</I>&gt;<i> fixes over the previous patch.
</I>&gt;<i> Also include support for NPN and ALPN tls extensions, required to
</I>&gt;<i> correctly bump SSL connections.
</I>&gt;<i> Please read carefully the patch preamble , specially the technical note
</I>&gt;<i> part.
</I>&gt;<i> 
</I>&gt;<i> The resumed sessions and the NPN/ALPN extensions problem appeared in
</I>&gt;<i> squid after our decision to not allow splicing of connections for which
</I>&gt;<i> we do not have access on the server certificates. The resumed sessions
</I>&gt;<i> does not include server certificates, and the NPN/ALPN extensions causes
</I>&gt;<i> openSSL to abort before retrieve and verify server certificates.
</I>
Regarding NPN in Chrome:
  <A HREF="https://www.imperialviolet.org/2013/03/20/alpn.html">https://www.imperialviolet.org/2013/03/20/alpn.html</A>

So for now this patch is okay, but we/you should already be thinking
about how to auto-translate NPN from clients into ALPN to servers.


&gt;<i> 
</I>&gt;<i> The problem affects the ssl bumping and make it unusable for many cases.
</I>&gt;<i> Many of the problems which reported by the users for squid-3.5 should be
</I>&gt;<i> related to this.
</I>&gt;<i> So probably this patch should applied to squid-3.5 too. If yes I will
</I>&gt;<i> post the patch for squid-3.5 too.
</I>
Yes on that.


As for the audit of this patch. All I've spotted is cosmetic debugs and
comments needing fixes.

+1 from me on the logic changes. Pelae apply when the below are resolved.


in src/ssl/bio.cc:

* please thread the parser code in this file with references to relevant
sections of RFC 5246 where the message syntax is defined.
 - you can see the http/one/*Parser.cc comments for examples

* Ssl::ServerBio::resumingSession() has unnecessary empty line and
if-condition brackets {} at the start

* Ssl::Bio::sslFeatures::checkForCcsOrNst()
 - comment on the second if-condition (looking for ticket) is wrong.
 - &quot;New Session Ticket&quot; is a TLS feature. So in the debugs
  s/SSL New Session Ticket/TLS New Session Ticket/

* Ssl::Bio::sslFeatures::parseV3ServerHello()
 - s/SSL Exntension/TLS Extension/ ... spelling, and extensions is
another TLS-specific feature.
 - there is inconsistent case on &quot;Server Hello&quot; all over this function.
The RFC use &quot;ServerHello&quot; - CamelCase without whitespace.

* Ssl::Bio::sslFeatures::parseV3Hello()
 - similar issues with s/Client Hello/ClientHello/ and &quot;SSL Extension&quot;
as above.
 - please update the comment about detecting NPN extension to indicate
its &quot;obsoleted by ALPN&quot;.
 Is it possible to take the protocol list from NPN and treat it as if
ALPN was received? if yes please do, otherwise this is fine.

* Ssl::Bio::sslFeatures::print()
 - seems to be lacking display of ALPN received
 - missing the format details for sslVersion used elsewhere:
     std::hex &lt;&lt; std::setw(8) &lt;&lt; std::setfill('0')


in src/ssl/bio.h

* comments have same issues as in .cc:
 - s/client hello/ClientHello/
 - s/server hello/ServerHello/
 - and what is a server &quot;Hello A&quot; message ?

* parseMsgHead() documentation about return result &gt;0 is wrong.
  - it does not return &lt;0 when the contents of the buffer are a TLS
(non-SSL) message.


Amos
</PRE>
































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002027.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
	<LI>Next message: <A HREF="002032.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2029">[ date ]</a>
              <a href="thread.html#2029">[ thread ]</a>
              <a href="subject.html#2029">[ subject ]</a>
              <a href="author.html#2029">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
