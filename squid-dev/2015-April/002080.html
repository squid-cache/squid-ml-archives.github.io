<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] splicing resumed sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C5527D4D7.2000300%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002032.html">
   <LINK REL="Next"  HREF="002091.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] splicing resumed sessions</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C5527D4D7.2000300%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] splicing resumed sessions">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Fri Apr 10 13:49:11 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002032.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
        <LI>Next message: <A HREF="002091.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2080">[ date ]</a>
              <a href="thread.html#2080">[ thread ]</a>
              <a href="subject.html#2080">[ subject ]</a>
              <a href="author.html#2080">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am attaching patch for trunk and squid-3.5


On 04/09/2015 04:13 PM, Amos Jeffries wrote:
&gt;<i> On 9/04/2015 10:53 p.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> A new version of the patch.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is removes the ssl_bump_resuming_sessions directive, includes many
</I>&gt;&gt;<i> fixes over the previous patch.
</I>&gt;&gt;<i> Also include support for NPN and ALPN tls extensions, required to
</I>&gt;&gt;<i> correctly bump SSL connections.
</I>&gt;&gt;<i> Please read carefully the patch preamble , specially the technical note
</I>&gt;&gt;<i> part.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The resumed sessions and the NPN/ALPN extensions problem appeared in
</I>&gt;&gt;<i> squid after our decision to not allow splicing of connections for which
</I>&gt;&gt;<i> we do not have access on the server certificates. The resumed sessions
</I>&gt;&gt;<i> does not include server certificates, and the NPN/ALPN extensions causes
</I>&gt;&gt;<i> openSSL to abort before retrieve and verify server certificates.
</I>&gt;<i>
</I>&gt;<i> Regarding NPN in Chrome:
</I>&gt;<i>    <A HREF="https://www.imperialviolet.org/2013/03/20/alpn.html">https://www.imperialviolet.org/2013/03/20/alpn.html</A>
</I>&gt;<i>
</I>&gt;<i> So for now this patch is okay, but we/you should already be thinking
</I>&gt;<i> about how to auto-translate NPN from clients into ALPN to servers.
</I>
Probably we can do it for bump-server first or bump-client first.
In this cases we are not using at all NPN or ALPN now because we are 
only supporting the http/1.1 protocol.
We may have consider it in the case we are going to support SPDY or 
similar protocols in the future.

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem affects the ssl bumping and make it unusable for many cases.
</I>&gt;&gt;<i> Many of the problems which reported by the users for squid-3.5 should be
</I>&gt;&gt;<i> related to this.
</I>&gt;&gt;<i> So probably this patch should applied to squid-3.5 too. If yes I will
</I>&gt;&gt;<i> post the patch for squid-3.5 too.
</I>&gt;<i>
</I>&gt;<i> Yes on that.
</I>I am including a patch for squid-3.5 too.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As for the audit of this patch. All I've spotted is cosmetic debugs and
</I>&gt;<i> comments needing fixes.
</I>&gt;<i>
</I>&gt;<i> +1 from me on the logic changes. Pelae apply when the below are resolved.
</I>
I did most of the changes you are requested, but maybe not all. Please 
look bellow.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/bio.cc:
</I>&gt;<i>
</I>&gt;<i> * please thread the parser code in this file with references to relevant
</I>&gt;<i> sections of RFC 5246 where the message syntax is defined.
</I>&gt;<i>   - you can see the http/one/*Parser.cc comments for examples
</I>
I tried to add some code inside SSL parsing code. In the future we can 
improve them as the parser improved and extended.

&gt;<i>
</I>&gt;<i> * Ssl::ServerBio::resumingSession() has unnecessary empty line and
</I>&gt;<i> if-condition brackets {} at the start
</I>
yep

&gt;<i>
</I>&gt;<i> * Ssl::Bio::sslFeatures::checkForCcsOrNst()
</I>&gt;<i>   - comment on the second if-condition (looking for ticket) is wrong.
</I>&gt;<i>   - &quot;New Session Ticket&quot; is a TLS feature. So in the debugs
</I>&gt;<i>    s/SSL New Session Ticket/TLS New Session Ticket/
</I>
done

&gt;<i>
</I>&gt;<i> * Ssl::Bio::sslFeatures::parseV3ServerHello()
</I>&gt;<i>   - s/SSL Exntension/TLS Extension/ ... spelling, and extensions is
</I>&gt;<i> another TLS-specific feature.
</I>
done

&gt;<i>   - there is inconsistent case on &quot;Server Hello&quot; all over this function.
</I>&gt;<i> The RFC use &quot;ServerHello&quot; - CamelCase without whitespace.
</I>&gt;<i>
</I>&gt;<i> * Ssl::Bio::sslFeatures::parseV3Hello()
</I>&gt;<i>   - similar issues with s/Client Hello/ClientHello/ and &quot;SSL Extension&quot;
</I>&gt;<i> as above.
</I>
I did it only for the comments added or modified by this patch to avoid 
increasing the size of this patch.
If required we can do it as separate patch.


&gt;<i>   - please update the comment about detecting NPN extension to indicate
</I>&gt;<i> its &quot;obsoleted by ALPN&quot;.
</I>
I did not add this comment. A such comment implies that there is 
something we have to fix or change something here because it is obsoleted.
Still we have to handle NPN if client and server use it.

&gt;<i>   Is it possible to take the protocol list from NPN and treat it as if
</I>&gt;<i> ALPN was received? if yes please do, otherwise this is fine.
</I>
No we can not do it. We are only bumping, we are not using NPN or ALPN 
for selecting protocol to cuminicate with server and client.

&gt;<i>
</I>&gt;<i> * Ssl::Bio::sslFeatures::print()
</I>&gt;<i>   - seems to be lacking display of ALPN received
</I>&gt;<i>   - missing the format details for sslVersion used elsewhere:
</I>&gt;<i>       std::hex &lt;&lt; std::setw(8) &lt;&lt; std::setfill('0')
</I>

I did not fix this. The ALPN is in an encoded form and requires some 
development to correctly print it. We do not have to gain something 
implementing this.
Also the Ssl::Bio::sslFeatures::print currently is not used. It is here 
for using it for debugging if required.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/bio.h
</I>&gt;<i>
</I>&gt;<i> * comments have same issues as in .cc:
</I>&gt;<i>   - s/client hello/ClientHello/
</I>&gt;<i>   - s/server hello/ServerHello/
</I>
OK for comments added by this patch.

&gt;<i>   - and what is a server &quot;Hello A&quot; message ?
</I>It is used in openSSL source code. I removed the &quot;A&quot;.


&gt;<i>
</I>&gt;<i> * parseMsgHead() documentation about return result &gt;0 is wrong.
</I>&gt;<i>    - it does not return &lt;0 when the contents of the buffer are a TLS
</I>&gt;<i> (non-SSL) message.
</I>
This is what it does!


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: splicing-resumed-sessions-Squid-3.5-t12.patch
Type: text/x-patch
Size: 57944 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150410/b29fa730/attachment-0002.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150410/b29fa730/attachment-0002.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: splicing-resumed-sessions-t12.patch
Type: text/x-patch
Size: 58383 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150410/b29fa730/attachment-0003.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150410/b29fa730/attachment-0003.bin</A>&gt;
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002032.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
	<LI>Next message: <A HREF="002091.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2080">[ date ]</a>
              <a href="thread.html#2080">[ thread ]</a>
              <a href="subject.html#2080">[ subject ]</a>
              <a href="author.html#2080">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
