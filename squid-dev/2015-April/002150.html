<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Basic tests results for the proxy protocol with	squid.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Basic%20tests%20results%20for%20the%20proxy%20protocol%20with%0A%09squid.&In-Reply-To=%3C552E41E5.4040208%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002149.html">
   <LINK REL="Next"  HREF="002154.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Basic tests results for the proxy protocol with	squid.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Basic%20tests%20results%20for%20the%20proxy%20protocol%20with%0A%09squid.&In-Reply-To=%3C552E41E5.4040208%40treenet.co.nz%3E"
       TITLE="[squid-dev] Basic tests results for the proxy protocol with	squid.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 15 10:48:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002149.html">[squid-dev] squid tcp_outgoing_address feature not working
</A></li>
        <LI>Next message: <A HREF="002154.html">[squid-dev] [RFC] removal of SSL version options
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2150">[ date ]</a>
              <a href="thread.html#2150">[ thread ]</a>
              <a href="subject.html#2150">[ subject ]</a>
              <a href="author.html#2150">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/03/2015 4:32 a.m., Eliezer Croitoru wrote:
&gt;<i> Hey Amos,
</I>&gt;<i> 
</I>&gt;<i> The setup I have used to test the proxy protocol is:
</I>&gt;<i> - 192.168.10.0/24 network.
</I>&gt;<i> - 192.168.10.131 basic forward proxy client(firefox)
</I>&gt;<i> - 192.168.10.151 haproxy+squid host
</I>&gt;<i> 
</I>&gt;<i> The haproxy is listening on port 13128 which is open on the FW.
</I>&gt;<i> The squid instance is listening on ports 3128 and 23128.
</I>&gt;<i> The settings for squid is from the release notes:
</I>&gt;<i>  acl frontend src 127.0.0.1
</I>&gt;<i>  http_port 23128 require-proxy-header
</I>&gt;<i>  proxy_protocol_access allow frontend
</I>&gt;<i> 
</I>&gt;<i> While I have not found &quot;proxy_protocol_access&quot; at all in:
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A>
</I>&gt;<i> 
</I>&gt;<i> Now indeed as you mentioned I was curios about this weird state which a
</I>&gt;<i> forward proxy would even look at the original_dst when in a forward
</I>&gt;<i> proxy mode it should not even be looked at.
</I>&gt;<i> What is even more weird is that the first request is being logged as
</I>&gt;<i> from 192.168.10.151 and the second is from 192.168.10.131.
</I>&gt;<i> Since the same issue happens when there is no default gateway I would
</I>&gt;<i> assume something is probably not happening as it was planned.
</I>&gt;<i> For each and every request there should be only one request happening.
</I>&gt;<i> 
</I>&gt;<i> I have never used the proxy protocol and my assumption is that there is
</I>&gt;<i> one of two:
</I>&gt;<i> - haproxy bad handling of the request
</I>&gt;<i> - squid issue with the proxy protocol handling.
</I>&gt;<i> 
</I>&gt;<i> I have seen that most server software which implements the proxy
</I>&gt;<i> protocol do use version 1 and not 2(at least the open source I have seen).
</I>&gt;<i> 
</I>&gt;<i> My next step would be to add a more detailed logs into the haproxy
</I>&gt;<i> instance and run TCPDUMP to make sure what is passing on the wires.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>
Yuhua Wu just did some testing and found the TPROXY intercept flag was
being incorrectly set to true (ouch, mea culpa). This could have been
breaking things in several ways

If you would like please test again and see if trunk is now working past
the issues you found earlier. I've still not found the time to get it
done, sorry.

Though please also note that the &quot;intercept&quot; and &quot;accel&quot; mode flags need
to be set (or not) to match what type of traffic HAProxy is receiving on
its inbound. Which is a little different from normal.

Amos
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002149.html">[squid-dev] squid tcp_outgoing_address feature not working
</A></li>
	<LI>Next message: <A HREF="002154.html">[squid-dev] [RFC] removal of SSL version options
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2150">[ date ]</a>
              <a href="thread.html#2150">[ thread ]</a>
              <a href="subject.html#2150">[ subject ]</a>
              <a href="author.html#2150">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
