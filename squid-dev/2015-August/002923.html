<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20HttpHeader%20migration%20%28coverity-fixes%20branch%29&In-Reply-To=%3C55C0B6ED.5030309%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002922.html">
   <LINK REL="Next"  HREF="002926.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20HttpHeader%20migration%20%28coverity-fixes%20branch%29&In-Reply-To=%3C55C0B6ED.5030309%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug  4 12:58:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002922.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
        <LI>Next message: <A HREF="002926.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2923">[ date ]</a>
              <a href="thread.html#2923">[ thread ]</a>
              <a href="subject.html#2923">[ subject ]</a>
              <a href="author.html#2923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/08/2015 11:22 p.m., Kinkie wrote:
&gt;<i> Hi all,
</I>&gt;<i>   the attached patch is a build- and run-tested merge proposal for next
</I>&gt;<i> round of the coverity-fixes branch, currently focusing on more effective
</I>&gt;<i> header name -&gt; id lookups.
</I>&gt;<i> 
</I>&gt;<i> Here's the status with the current todo checklist:
</I>&gt;<i> 
</I>&gt;<i>  * DONE 1. shift HDR_BAD_HDR to end of enum
</I>&gt;<i>  * DONE 2. shift headers data array to http/RegistredHeaders.cc
</I>&gt;<i>  * DONE 3. creatign LookupTable object from teh enum and array
</I>&gt;<i>  * (with HDR_BAD_HDR as invalid value)
</I>&gt;<i>  * DONE 4. replacing httpHeaderIdByName() uses with the lookup table
</I>&gt;<i>  * NOT POSSIBLE 5. merge HDR_BAD_HDR and HDR_ENUM_END into one thing -
</I>&gt;<i> HDR_ENUM_END is overloaded meaning &quot;All&quot; headers in Manglers.
</I>&gt;<i>  * DONE 6. replacing httpHeaderNameById with direct array lookups
</I>&gt;<i>  * DONE 7. being looking at the other arrays removal
</I>&gt;<i> 
</I>&gt;<i> In working on this I found out several instances of enum abuses - tracking
</I>&gt;<i> those down has been the hardest part of the effort.
</I>&gt;<i> HttpHeader::parse is being used to parse error page templates - thus the
</I>&gt;<i> relaxed any_registered_header() checks in some methods, e.g.
</I>&gt;<i> HttpHdeader::addEntry().
</I>&gt;<i> 
</I>&gt;<i> Next steps, if there is consensus:
</I>&gt;<i> - moving LookupTable away from std::map to std::hash with custom
</I>&gt;<i> gperf-derived Hashers for extra boost
</I>&gt;<i> - investigating whether strongly-typed enums can be used instead of C-style
</I>&gt;<i> enums in more places.
</I>&gt;<i> - moving away from homegrown bitfields (CBIT_TEST etc.) towards
</I>&gt;<i> std::vector&lt;bool&gt; or std::vector&lt;unsigned char&gt;, possibly via a class
</I>&gt;<i> bitfield or somesuch.
</I>&gt;<i> 
</I>
audit results:

* httpHdrCcCleanModule() and httpHdrScCleanModule() can both be fully
deleted now.


in src/enums.h:

* please move the altered enums out to the HttpHdr{C,S}c.h files
 - or worst-case to http/forward.h

in src/base/LookupTable.h:
* missing empty line separator between SBufCaseInsensitiveLess and the
LookupTable template

* does SBufCaseInsensitiveLess have to be a struct?
 - inheritence and operators is a bit odd with struct

* LookupTableRecord should be a class.
 - custom storage types can then inherit from it, with it as the first
parent


in src/HttpHeader.cc:

* can you move the headerLookupTable to src/http/RegisteredHeaders.cc
and the Http:: namespace as well please ?
 - that way we keep the polished new code in http/libhttp and the old C
code in src/*.cc files.

* headerLookupTable is a global / static. ie. HeaderLookupTable.
 - or when in the namespace ... Http::HeaderLookupTable

* any_registered_header() is wrong.
 - it matches for HDR_OTHER which by definition is a non-registered header
 - assert_eid() is equivalent to any_valid_header()

* &quot;// is this really needed?&quot;
 - either make that a TODO or remove. as a comment it is useless and
will only get lost.

* the chunk @1528
 - s/ &quot;got hdr id hdr: &quot; / &quot;got hdr-id=&quot; /

 - please consider removing the assert(assert(any_valid_header(id)))
   it could probably be replaced by:
      if (!assert(any_valid_header(id)))
          id = HDR_OTHER

* I think the wrong assert() was removed from the
HttpHeaderEntry::get*() methods.
 - since the entry exists there should be no use to asserting its id is
valid.
 - please consider replacing the two asserts with an if() actually
handling of the case where id is BAD_HDR_NUM or not the right header
value-type. By returning some invalid value-type representation instead
of asserting or trying to parse.

* can valid_id in httpHeaderFieldStatDumper() be made a const bool ?


in http/RegisteredHeaders.h:

* please place the new symbols in the Http:: namespace


in src/HttpHeaderTools.cc:

* HeaderManglers::find contains &quot;e.id != HDR_OTHER &amp;&amp; e.id &lt; HDR_ENUM_END&quot;
 - that should now be just: e.id != HDR_OTHER &amp;&amp; any_registered_header(e.id)
 - once you fix any_registered_header definition the !=OTHER check may
not be necessary.



Okay. I think thats all. But I may have missed stuff. SO at least
another round ahead :-(

Amos
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002922.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
	<LI>Next message: <A HREF="002926.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2923">[ date ]</a>
              <a href="thread.html#2923">[ thread ]</a>
              <a href="subject.html#2923">[ subject ]</a>
              <a href="author.html#2923">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
