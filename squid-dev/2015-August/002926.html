<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20HttpHeader%20migration%20%28coverity-fixes%20branch%29&In-Reply-To=%3CCA%2BY8hcNNf1M3uhv2SLGBZTjH9tBurN%3DtLdtX4kg7hA8b%3DfwgxQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002923.html">
   <LINK REL="Next"  HREF="002927.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20HttpHeader%20migration%20%28coverity-fixes%20branch%29&In-Reply-To=%3CCA%2BY8hcNNf1M3uhv2SLGBZTjH9tBurN%3DtLdtX4kg7hA8b%3DfwgxQ%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)">gkinkie at gmail.com
       </A><BR>
    <I>Tue Aug  4 21:08:44 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002923.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
        <LI>Next message: <A HREF="002927.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2926">[ date ]</a>
              <a href="thread.html#2926">[ thread ]</a>
              <a href="subject.html#2926">[ subject ]</a>
              <a href="author.html#2926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Aug 4, 2015 at 2:58 PM, Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 4/08/2015 11:22 p.m., Kinkie wrote:
</I>&gt;<i> &gt; Hi all,
</I>&gt;<i> &gt;   the attached patch is a build- and run-tested merge proposal for next
</I>&gt;<i> &gt; round of the coverity-fixes branch, currently focusing on more effective
</I>&gt;<i> &gt; header name -&gt; id lookups.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here's the status with the current todo checklist:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  * DONE 1. shift HDR_BAD_HDR to end of enum
</I>&gt;<i> &gt;  * DONE 2. shift headers data array to http/RegistredHeaders.cc
</I>&gt;<i> &gt;  * DONE 3. creatign LookupTable object from teh enum and array
</I>&gt;<i> &gt;  * (with HDR_BAD_HDR as invalid value)
</I>&gt;<i> &gt;  * DONE 4. replacing httpHeaderIdByName() uses with the lookup table
</I>&gt;<i> &gt;  * NOT POSSIBLE 5. merge HDR_BAD_HDR and HDR_ENUM_END into one thing -
</I>&gt;<i> &gt; HDR_ENUM_END is overloaded meaning &quot;All&quot; headers in Manglers.
</I>&gt;<i> &gt;  * DONE 6. replacing httpHeaderNameById with direct array lookups
</I>&gt;<i> &gt;  * DONE 7. being looking at the other arrays removal
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In working on this I found out several instances of enum abuses -
</I>&gt;<i> tracking
</I>&gt;<i> &gt; those down has been the hardest part of the effort.
</I>&gt;<i> &gt; HttpHeader::parse is being used to parse error page templates - thus the
</I>&gt;<i> &gt; relaxed any_registered_header() checks in some methods, e.g.
</I>&gt;<i> &gt; HttpHdeader::addEntry().
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Next steps, if there is consensus:
</I>&gt;<i> &gt; - moving LookupTable away from std::map to std::hash with custom
</I>&gt;<i> &gt; gperf-derived Hashers for extra boost
</I>&gt;<i> &gt; - investigating whether strongly-typed enums can be used instead of
</I>&gt;<i> C-style
</I>&gt;<i> &gt; enums in more places.
</I>&gt;<i> &gt; - moving away from homegrown bitfields (CBIT_TEST etc.) towards
</I>&gt;<i> &gt; std::vector&lt;bool&gt; or std::vector&lt;unsigned char&gt;, possibly via a class
</I>&gt;<i> &gt; bitfield or somesuch.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> audit results:
</I>&gt;<i>
</I>&gt;<i> * httpHdrCcCleanModule() and httpHdrScCleanModule() can both be fully
</I>&gt;<i> deleted now.
</I>&gt;<i>
</I>
Yes. I chose to let them in: they are NOPs, not in the critical path, and
may be useful in the future. Let me know if you still want them removed.

in src/enums.h:
&gt;<i>
</I>&gt;<i> * please move the altered enums out to the HttpHdr{C,S}c.h files
</I>&gt;<i>  - or worst-case to http/forward.h
</I>&gt;<i>
</I>
Done.


&gt;<i> in src/base/LookupTable.h:
</I>&gt;<i> * missing empty line separator between SBufCaseInsensitiveLess and the
</I>&gt;<i> LookupTable template
</I>&gt;<i>
</I>
Done

&gt;<i>
</I>&gt;<i> * does SBufCaseInsensitiveLess have to be a struct?
</I>&gt;<i>  - inheritence and operators is a bit odd with struct
</I>&gt;<i>
</I>
Turned to class.


&gt;<i> * LookupTableRecord should be a class.
</I>&gt;<i>  - custom storage types can then inherit from it, with it as the first
</I>&gt;<i> parent
</I>&gt;<i>
</I>
Well, templatization can prevent that need, but sure. Should I implement
that?
Isn't nowadays a struct == all-public class though? It looks odd, but
functionally is the same


&gt;<i> in src/HttpHeader.cc:
</I>&gt;<i>
</I>&gt;<i> * can you move the headerLookupTable to src/http/RegisteredHeaders.cc
</I>&gt;<i> and the Http:: namespace as well please ?
</I>&gt;<i>
</I>
Moved to RegisteredHeaders and renamed HDR_FOO to Http::HdrType::FOO .
Moving to a strongly-typed enum is unfortunately not feasible as eCAP
requires integer-enum equivalence; it may be that the whole change has to
be reverted.


&gt;<i>
</I>&gt;<i>  - that way we keep the polished new code in http/libhttp and the old C
</I>&gt;<i> code in src/*.cc files.
</I>&gt;<i>
</I>


&gt;<i>
</I>&gt;<i> * headerLookupTable is a global / static. ie. HeaderLookupTable.
</I>&gt;<i>  - or when in the namespace ... Http::HeaderLookupTable
</I>&gt;<i>
</I>
Done.


&gt;<i> * any_registered_header() is wrong.
</I>&gt;<i>  - it matches for HDR_OTHER which by definition is a non-registered header
</I>&gt;<i>  - assert_eid() is equivalent to any_valid_header()
</I>&gt;<i>
</I>
Then we need to change name. We need two semantics:
1) any header which is valid and defined (including OTHER)
2) any header ID which will not go out-of-bounds (same as (1) + HDR_BAD_HDR)

any suggestion?


&gt;<i>
</I>&gt;<i> * &quot;// is this really needed?&quot;
</I>&gt;<i>  - either make that a TODO or remove. as a comment it is useless and
</I>&gt;<i> will only get lost.
</I>&gt;<i>
</I>
Comment removed.


&gt;<i> * the chunk @1528
</I>&gt;<i>  - s/ &quot;got hdr id hdr: &quot; / &quot;got hdr-id=&quot; /
</I>&gt;<i>
</I>
done


&gt;<i>
</I>&gt;<i>  - please consider removing the assert(assert(any_valid_header(id)))
</I>&gt;<i>    it could probably be replaced by:
</I>&gt;<i>       if (!assert(any_valid_header(id)))
</I>&gt;<i>           id = HDR_OTHER
</I>&gt;<i>
</I>
Huh? I can't find any nested assert


&gt;<i> * I think the wrong assert() was removed from the
</I>&gt;<i> HttpHeaderEntry::get*() methods.
</I>&gt;<i>  - since the entry exists there should be no use to asserting its id is
</I>&gt;<i> valid.
</I>&gt;<i>  - please consider replacing the two asserts with an if() actually
</I>&gt;<i> handling of the case where id is BAD_HDR_NUM or not the right header
</I>&gt;<i> value-type. By returning some invalid value-type representation instead
</I>&gt;<i> of asserting or trying to parse.
</I>&gt;<i>
</I>
Removed the asserts; I am convinced they are just wasted cycles right now.


&gt;<i>
</I>&gt;<i> * can valid_id in httpHeaderFieldStatDumper() be made a const bool ?
</I>&gt;<i>
</I>
Yes, done.


&gt;<i> in http/RegisteredHeaders.h:
</I>&gt;<i>
</I>&gt;<i> * please place the new symbols in the Http:: namespace
</I>&gt;<i>
</I>
done, except for operator&lt;&lt;(Http::HdrType)


&gt;<i> in src/HttpHeaderTools.cc:
</I>&gt;<i>
</I>&gt;<i> * HeaderManglers::find contains &quot;e.id != HDR_OTHER &amp;&amp; e.id &lt; HDR_ENUM_END&quot;
</I>&gt;<i>  - that should now be just: e.id != HDR_OTHER &amp;&amp; any_registered_header(
</I>&gt;<i> e.id)
</I>&gt;<i>  - once you fix any_registered_header definition the !=OTHER check may
</I>&gt;<i> not be necessary.
</I>&gt;<i>
</I>
moved to Http::any_registered_header


&gt;<i> Okay. I think thats all. But I may have missed stuff. SO at least
</I>&gt;<i> another round ahead :-(
</I>&gt;<i>
</I>
Here it is, to lighten up your morning :)

Thanks!

-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150804/ace96b56/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150804/ace96b56/attachment-0001.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: coverity-fixes-3-v2.patch
Type: text/x-patch
Size: 270962 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150804/ace96b56/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150804/ace96b56/attachment-0001.bin</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002923.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
	<LI>Next message: <A HREF="002927.html">[squid-dev] [PATCH] HttpHeader migration (coverity-fixes branch)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2926">[ date ]</a>
              <a href="thread.html#2926">[ thread ]</a>
              <a href="subject.html#2926">[ subject ]</a>
              <a href="author.html#2926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
