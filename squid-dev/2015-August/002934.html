<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [CODE] iterating over enums
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BCODE%5D%20iterating%20over%20enums&In-Reply-To=%3CCA%2BY8hcNcY1wZhu4%2BKUr22acahRYmCExm8_%3DZNUE9zuuiqpS8Ag%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002933.html">
   <LINK REL="Next"  HREF="002935.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [CODE] iterating over enums</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BCODE%5D%20iterating%20over%20enums&In-Reply-To=%3CCA%2BY8hcNcY1wZhu4%2BKUr22acahRYmCExm8_%3DZNUE9zuuiqpS8Ag%40mail.gmail.com%3E"
       TITLE="[squid-dev] [CODE] iterating over enums">gkinkie at gmail.com
       </A><BR>
    <I>Thu Aug  6 01:58:26 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002933.html">[squid-dev] [CODE] iterating over enums
</A></li>
        <LI>Next message: <A HREF="002935.html">[squid-dev] [CODE] iterating over enums
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2934">[ date ]</a>
              <a href="thread.html#2934">[ thread ]</a>
              <a href="subject.html#2934">[ subject ]</a>
              <a href="author.html#2934">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Aug 6, 2015 at 12:38 AM, Alex Rousskov &lt;
<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 08/05/2015 09:33 AM, Kinkie wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I crossed the topic of enumerating over iterations.
</I>&gt;<i>
</I>&gt;<i> You mean iterating enum[eration]s :-)
</I>&gt;<i>
</I>
I have my thinking cap backwards ;)


&gt;<i> &gt; We kind-of follow (C-ish)best
</I>&gt;<i> &gt; practices on that, but that got me wondering if we can do better.
</I>&gt;<i> &gt; I came up with a trinket which on its face looks quite elegant to me,
</I>&gt;<i> &gt; and I'd like to understand with you guys if it makes sense to deploy it
</I>&gt;<i> &gt; in our code.
</I>&gt;<i>
</I>&gt;<i> Maybe, after quite a few changes. It is risky for me to review this
</I>&gt;<i> because the problems in the posted code lie on several very different
</I>&gt;<i> layers, the code is outside Squid context, and I am not even sure what
</I>&gt;<i> [CODE] thread designation means. I hope this does not lead to a long
</I>&gt;<i> discussion, but here are a few things to consider:
</I>&gt;<i>
</I>
[CODE] means that it contains code which is not a [PATCH] but meant to
spark a discussion which may or may not result into a patch.
I hope that the discussion will be fruitful, I don't mind if it's long as
long as it doesn't waste people's time (read: it's fruitful)


&gt;<i> * Iterating enums under Squid control ought to be a lot easier, safer,
</I>&gt;<i> and cheaper because we can add begin/end markers *with standard names*
</I>&gt;<i> to each enum. This is important because most iterations iterate
</I>&gt;<i> everything _and_ C++11 range loops always iterate everything. The
</I>&gt;<i> &quot;everything&quot; case is worth focusing on! See attached files for examples
</I>&gt;<i> of how standardized begin/end marks can be used.
</I>&gt;<i>
</I>
I agree. We'd need to take care to avoid the anti-pattern of &quot;iterate over
everything but not really everything&quot;, but that's exactly the itch I was
trying to scratch, and found unsatisfactorily scratched in my online
research.


&gt;<i> * Your Iterator class is mixing two very different interfaces/APIs: One
</I>&gt;<i> provides begin/end() methods and is required for range loops (I do not
</I>&gt;<i> know how this API is called in the C++ standard). The other one is a
</I>&gt;<i> [partial] iterator API. Do not mix those two APIs! Each of the attached
</I>&gt;<i> files illustrates how to separate them (and there are two ways to
</I>&gt;<i> implement the second/iterator API).
</I>&gt;<i>
</I>
Yes, I had unintentionally borrowed from Python where an object sometimes
is its own iterator.
I don't have any particular attachment to the way I coded this - if that's
what you are afraid of when you refer to the long discussion. Anything that
is well self-contained and easy to use will fill the bill for me :)


&gt;<i> * The stand-alone iterator API implementation in
</I>&gt;<i> t-enum-stand-alone-v3.cc allows for nice explicit for-loops and such,
</I>&gt;<i> but those global operators are rather invasive, and I am worried they
</I>&gt;<i> will cause problems in Squid context (as opposed a tiny test file!). I
</I>&gt;<i> recommend that you start with t-enum-v3.cc and then diff the two
</I>&gt;<i> attached files to see changes related to the stand-alone iterator API
</I>&gt;<i> implementation. If you really like stand-alone operator side-effects,
</I>&gt;<i> you may want to investigate whether they would work well in Squid context.
</I>&gt;<i>
</I>
Instinctivelty I would go for the class-based approach as it feels less
invasive.
What I understand from the changes you propose is that:
1. instead of having explicit begin/end markers passed as template
arguments you propose to have a convention on begin/end markers.
2. you skip the typedef fixing these parameters in favor of letting the
template parameters appear in the calls. This is quite consistent with an
approach often taken in the stdlib (e.g. std::numeric_limits).

1. looks interesting, especially as an enum missing those markers will fail
to compile. Maybe both approaches can be combined by using default template
arguments, what do you think?
template &lt;typename C, C first = C::enumBegin_, C last_plus_one =
C::enumEnd_&gt;
2. looks verbose to me, but it can be decided on a case-by-case basis,
which can be a good or a bad thing.
3. we could maybe combine the benefits of beautiful range-for and ugly
explicit-for also for shorter ranges by having (in the class-based
variant), on top of what you have already proposed (untested)

template &lt;typename Enum&gt;
class WholeEnum
{
   Enum first, lastplusone;
public:
   WholeEnum (Enum firstValue, Enum lastValuePlusOne) : first(firstValue),
lastplusone(lastValuePlusOne) {}
   Iterator begin() { return Iterator(first); }
   Iterator end() { return Iterator(lastplusone); }
}

this would allow to do
for (auto i : WholeEnum&lt;Numbers&gt;(Numbers::one, Numbers::three)) {
 // do stuff
}

What do you think? Not very kosher maybe, but it should work.

* Avoid static variables in templates, especially when you want to
&gt;<i> instantiate different templates based on such trivial things as range
</I>&gt;<i> boundaries. This is (or used to be?) one of the dark C++ corners; they
</I>&gt;<i> might hurt inlining/performance as well.
</I>&gt;<i>
</I>
Ok.


&gt;<i> The attached files are unpolished, but should illustrate the above
</I>&gt;<i> points and how to avoid some of the problems discussed here.
</I>&gt;<i>
</I>
It looks to me that I have crossed an itch you feel as well, and this
effort may be useful after all.
Thanks for taking the time!
-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150806/bde8996f/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150806/bde8996f/attachment.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002933.html">[squid-dev] [CODE] iterating over enums
</A></li>
	<LI>Next message: <A HREF="002935.html">[squid-dev] [CODE] iterating over enums
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2934">[ date ]</a>
              <a href="thread.html#2934">[ thread ]</a>
              <a href="subject.html#2934">[ subject ]</a>
              <a href="author.html#2934">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
