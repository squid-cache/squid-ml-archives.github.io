<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reject responses with conflicting Content-Length
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%20Content-Length&In-Reply-To=%3C55C58A03.5030000%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002948.html">
   <LINK REL="Next"  HREF="002967.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reject responses with conflicting Content-Length</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%20Content-Length&In-Reply-To=%3C55C58A03.5030000%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Reject responses with conflicting Content-Length">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Aug  8 04:48:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002948.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
        <LI>Next message: <A HREF="002967.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2950">[ date ]</a>
              <a href="thread.html#2950">[ thread ]</a>
              <a href="subject.html#2950">[ subject ]</a>
              <a href="author.html#2950">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/08/2015 8:54 a.m., Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     Squid trusts and forwards the largest Content-Length header. This
</I>&gt;<i> behavior violates an RFC 7230 MUST in Section 3.3.3 item #4. It also
</I>&gt;<i> confuses some ICAP services and probably some HTTP clients. With the
</I>&gt;<i> proposed changes, Squid refuses to forward the message to the ICAP
</I>&gt;<i> service and HTTP client, responding with an HTTP 502 error instead.
</I>&gt;<i> 
</I>&gt;<i> This is a quick-and-dirty implementation. A polished version should
</I>&gt;<i> reject responses with invalid Content-Length values as well (per RFC
</I>&gt;<i> 7230 MUST), should return 502 even with a strict parser (this is not a
</I>&gt;<i> header parsing issue), and should probably not warn the admin when all
</I>&gt;<i> values actually match.
</I>
That is already taken care of by warnOnError as debugs() level for the
recoverable issues. The admin who explicitly configure that they want
the warnings will see duplicate header notice. Otherwise not.

&gt;<i> 
</I>&gt;<i> I am not volunteering to provide a more polished version at this time,
</I>&gt;<i> but the proposed changes solve a known problem and are a step in the
</I>&gt;<i> right direction towards better Content-Length processing.
</I>&gt;<i> 
</I>
Please do eitehr XXX or implement the clause about 502 on invalid
Content-Length header. The unable to parse cases when comparing l1 and
l2 at chunk @548.


+1 as a temporary workaround. Looks like it catches some important cases
correctly.

IMO the polish can happen when the header parsing is refactored. No need
for a special followup to this.

Amos

</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002948.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
	<LI>Next message: <A HREF="002967.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2950">[ date ]</a>
              <a href="thread.html#2950">[ thread ]</a>
              <a href="subject.html#2950">[ subject ]</a>
              <a href="author.html#2950">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
