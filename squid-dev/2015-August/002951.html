<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] PackableStream for cachemgr reports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PackableStream%20for%20cachemgr%20reports&In-Reply-To=%3C55C58DFB.7040305%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002937.html">
   <LINK REL="Next"  HREF="002953.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] PackableStream for cachemgr reports</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PackableStream%20for%20cachemgr%20reports&In-Reply-To=%3C55C58DFB.7040305%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] PackableStream for cachemgr reports">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Aug  8 05:04:59 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002937.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
        <LI>Next message: <A HREF="002953.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2951">[ date ]</a>
              <a href="thread.html#2951">[ thread ]</a>
              <a href="subject.html#2951">[ subject ]</a>
              <a href="author.html#2951">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/05/2015 10:24 AM, Amos Jeffries wrote:
&gt;<i> Adds a PackableStream class which provides std::ostream semantics for
</I>&gt;<i> writing data to a cachemgr report.
</I>

&gt;<i> +    PackableStreamBuf(Packable *out) : outBuf(out) {}
</I>
Missing &quot;explicit&quot; or a comment justifying implicit conversions.


&gt;<i> +    ~PackableStreamBuf() {}
</I>
Please add &quot;virtual&quot;.


&gt;<i> +    virtual int_type overflow(int_type aChar = traits_type::eof()) {
</I>
&gt;<i> +    virtual int sync() {
</I>
&gt;<i> +    virtual std::streamsize xsputn(const char * chars, std::streamsize number) {
</I>
Please add &quot;override&quot; to each overridden virtual method from the
std::streambuf API.


&gt;<i> +            // NP: cast because GCC promotes int_type to 32-bit type
</I>&gt;<i> +            //     std::basic_streambuf&lt;char&gt;::int_type {aka int}
</I>&gt;<i> +            //     despite the definition with 8-bit type value.
</I>&gt;<i> +            char chars[1] = {char(aChar)};
</I>
Please use static_cast (or another appropriately named cast) to cast.

Do not declare &quot;chars&quot; when you do not need them.

Make &quot;chars&quot; constant if you can.


&gt;<i> +                outBuf-&gt;append(chars, 1);
</I>...
&gt;<i> +            outBuf-&gt;append(pbase(), pending);
</I>...
&gt;<i> +            outBuf-&gt;append(chars, number);
</I>
To reduce code duplication and to assist with debugging, it would be
nice to move these three into a single dedicated private write() method
or similar.


&gt;<i> +        if (pending)
</I>&gt;<i> +            outBuf-&gt;append(pbase(), pending);
</I>...
&gt;<i> +        if (number)
</I>&gt;<i> +            outBuf-&gt;append(chars, number);
</I>
Are you sure you are saving more cycles by bypassing zero-size appends
than you are wasting on the size check? If you are not, do not waste
cycles and ink on that check.


&gt;<i> +private:
</I>&gt;<i> +    Packable *outBuf;
</I>&gt;<i> +};
</I>
Why is this a pointer? The class code seems to require a non-null
pointer. If you can make this a reference, please do.

If this member remains a pointer, we ought to check that it is not null.


&gt;<i> +    PackableStream(Packable *entry): std::ostream(0), theBuffer(entry) {
</I>
Missing &quot;explicit&quot; or a comment justifying implicit conversions.

If you do not want this class to be responsible for checking &quot;entry&quot; for
being nil (after the PackableStreamBuf fixes above), then use a
reference instead of a pointer.

Please s/entry/packable/ or something like that. We should not imply
that this is StoreEntry even if it [usually] is today.


&gt;<i> +    /* create a stream for writing text etc into theEntry */
</I>
No theEntry here.


&gt;<i> +    virtual void dump(std::ostream &amp;) {}
</I>
This should either throw (if it must not be called unless overridden) or
provide some debugging (if it is OK to leave it a no-op).


&gt;<i> +    virtual void dump(std::ostream &amp;) {}
</I>&gt;<i> +
</I>&gt;<i> +    // magic wrapper.
</I>&gt;<i> +    // old code will override this instead of the new ostream dumper.
</I>&gt;<i> +    virtual void dump(StoreEntry *e);
</I>
IIRC, it is not possible to override just one dump() without hiding the
other. I do not know whether we enable compiler warnings about hiding
virtual methods by default, but we _should_ enable them if we do not
already.

Perhaps more importantly, why do we actually need this [black] magic
here? Can the new method just use a different name, like dumpToStream(),
until the transition is over?


&gt;<i> * convert old Action classes to new API
</I>&gt;<i> * refactor old C-code report generators to be Action classes
</I>&gt;<i>  - fixing display output syntax to minimal YAML as we go on both the
</I>&gt;<i> above. It mostly is already, but some reports have wrong syntax.
</I>
It feels wrong that you want Actions to output using strict syntax but
give them an &quot;free form&quot; or &quot;anything goes&quot; std::ostream as a tool to
accomplish that. Should not Action dumping methods receive a specialized
class that makes it easy to produce the output you want and hard (if not
impossible) to make syntax mistakes?


Finally, &quot;make check&quot; fails in my tests with several errors like:


&gt;<i> tests/stub_libmgr.cc:65:6: error: prototype for ‘void Mgr::RotateAction::dump(StoreEntry*)’ does not match any in class ‘Mgr::RotateAction’
</I>&gt;<i>  void Mgr::RotateAction::dump(StoreEntry *entry) STUB
</I>&gt;<i>       ^
</I>&gt;<i> In file included from tests/stub_libmgr.cc:48:0:
</I>&gt;<i> ../src/mgr/BasicActions.h:78:18: error: candidate is: virtual void Mgr::RotateAction::dump(std::ostream&amp;)
</I>&gt;<i>      virtual void dump(std::ostream &amp;);
</I>&gt;<i>                   ^
</I>

HTH,

Alex.

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002937.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
	<LI>Next message: <A HREF="002953.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2951">[ date ]</a>
              <a href="thread.html#2951">[ thread ]</a>
              <a href="subject.html#2951">[ subject ]</a>
              <a href="author.html#2951">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
