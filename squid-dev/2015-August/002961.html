<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] PackableStream for cachemgr reports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PackableStream%20for%20cachemgr%20reports&In-Reply-To=%3C55C8B55D.8090009%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002957.html">
   <LINK REL="Next"  HREF="002965.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] PackableStream for cachemgr reports</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PackableStream%20for%20cachemgr%20reports&In-Reply-To=%3C55C8B55D.8090009%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] PackableStream for cachemgr reports">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Aug 10 14:29:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002957.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
        <LI>Next message: <A HREF="002965.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2961">[ date ]</a>
              <a href="thread.html#2961">[ thread ]</a>
              <a href="subject.html#2961">[ subject ]</a>
              <a href="author.html#2961">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/09/2015 09:39 PM, Amos Jeffries wrote:
&gt;&gt;&gt;<i> Primarily that we can do the formatting cleanup without adding a
</I>&gt;&gt;&gt;<i> circular dependency between libbase and libmem in the current code
</I>&gt;&gt;&gt;<i> situation.
</I>

&gt;&gt;<i> This answer to my &quot;Why do the same change twice?&quot; question does not
</I>&gt;&gt;<i> compute/correlate for me. I do not see why two cleanups are better than
</I>&gt;&gt;<i> one here (if that is what you are implying). Also, &quot;without adding X&quot;
</I>&gt;&gt;<i> cannot be the reason because the existing code does not add anything.
</I>
&gt;<i>  LDADD=
</I>

I begin to understand why the progress on this thread is so inefficient:
You are apparently trying to solve several problems at once, some of
them correctly, some not. When I question the wrong decisions, you
defend the right ones, and the resulting conversation makes no sense.
The lack of the description of the primary problems the patch was
attempting to solve (i.e., the &quot;Why&quot;s) did not help either.


&gt;<i>  2 changes [layers] are better than 3.
</I>&gt;<i> 
</I>&gt;<i> Getting all the way down to 1 change did not seem possible a week ago
</I>&gt;<i> when I started this. Now it looks more hopeful.
</I>
Great, at least the discussion was not a total waste of time.


&gt;&gt;&gt;<i> If you can agree that we start with a Mgr::Formatter class that does not
</I>&gt;&gt;&gt;<i> do anything initially but dump out a free-form &quot;notice&quot; box with a line
</I>&gt;&gt;&gt;<i> of text in it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I hope we can come up with a minimal API (only usable for the very basic
</I>&gt;&gt;<i> output such as one-line notices and such). We will need to discuss and
</I>&gt;&gt;<i> agree on what that minimum is exactly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If YAML support is one of the ultimate goals, then I would propose
</I>&gt;&gt;<i> something like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> // Assembles information for a single Cache Manager &quot;page&quot;.
</I>&gt;&gt;<i> // Supplied information goes into a configured stream.
</I>&gt;&gt;<i> // Kids implement various information formatting methods.
</I>&gt;&gt;<i> class Page: public std::ostream {
</I>&gt;&gt;<i> public:
</I>&gt;&gt;<i>     Page(std::ostream &amp;os);
</I>
&gt;<i> Does this mean you want to go head with PackableStream for the libmem
</I>&gt;<i> problem ?
</I>

I have nothing against PackableStream* classes as such. If they are
useful for something, they should be polished and committed, of course.

I am against making half-way changes to the cache manager output.
Library dependencies can be changed without changing output.
Alternatively, we can solve linking problems while switching to the new
and _final_ output format. If you are doing the legwork, it is your call
whether to combine the two activities or separate them.


&gt;<i> If we plan to get rid of PackableStream / StoreEntryStream in the end
</I>&gt;<i> product that ctor could take a Packable&amp;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This assumes that the Page object does the actual append() to the
</I>&gt;<i> Packable it references.
</I>
The Page essentially takes and uses PackableStream[Buffer]. There is no
good reason to keep using C-style printf()s if we have to change the
output anyway.


&gt;<i> For the record; I have considered the alternative design where the Page
</I>&gt;<i> is just a struct holding tokens for output at each position in the
</I>&gt;<i> display state.
</I>&gt;<i> PageSimple {
</I>&gt;<i> .comment = ': ';
</I>&gt;<i> .beginList = ':\n';
</I>&gt;<i> .endList = '\n';
</I>&gt;<i> .tableRow = '\t';
</I>&gt;<i> .tableEndRow = '\n'
</I>&gt;<i> ... and so on.
</I>&gt;<i> }
</I>
I doubt we can render two formats (e.g., text and YAML) _nicely_ using
one rendering code (with a few configurable delimiters), but if that
works, great! Note that YamlPage and PlainPage should only contain the
code unique to each format, so if those classes end up being empty, it
would be trivial to remove them completely. Actions do not know about
those classes because they use Page (instead of the current StoreEntry).


&gt;&gt;<i>     virtual ~Page() {}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     // a comment
</I>&gt;&gt;<i>     virtual Page &amp;comment(const SBuf &amp;text) = 0;
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I was suggesting just the above bit in the first patch.
</I>
Fine with me, but your thoughts below seem to indicate that it is not
actually what you want to do (or that it is impossible to do using a
comment()).


&gt;<i> Although the immediate uses seem more like notice box / announcements
</I>&gt;<i> than regular text comment. The display end would highlight them in bold
</I>&gt;<i> colors or something to attract attention.
</I>
Then comment() is not appropriate. It would be appropriate for something
like &quot;no data collected for this page&quot; or &quot;internal error while
rendering statistics for this page&quot;. That is, for something that scripts
do not need to interpret (beyond the fact that there no actual data in
the output).

You may add a Page::announce() method of some sort, of course, but it
has to be _implemented_ using basic YAML constructs like lists, hashes,
key:value pairs, comments, etc. Thus, you may need some of the other
methods from the sketch. This is important: To avoid changing same
output more than once, we have to use the right constructs in any
changed code.


HTH,

Alex.

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002957.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
	<LI>Next message: <A HREF="002965.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2961">[ date ]</a>
              <a href="thread.html#2961">[ thread ]</a>
              <a href="subject.html#2961">[ subject ]</a>
              <a href="author.html#2961">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
