<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] PayloadFormatter (was PackableStream)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PayloadFormatter%20%28was%20PackableStream%29&In-Reply-To=%3C55C8BAA6.1080700%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002960.html">
   <LINK REL="Next"  HREF="002985.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] PayloadFormatter (was PackableStream)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PayloadFormatter%20%28was%20PackableStream%29&In-Reply-To=%3C55C8BAA6.1080700%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] PayloadFormatter (was PackableStream)">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Aug 10 14:52:22 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002960.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
        <LI>Next message: <A HREF="002985.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2962">[ date ]</a>
              <a href="thread.html#2962">[ thread ]</a>
              <a href="subject.html#2962">[ subject ]</a>
              <a href="author.html#2962">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/08/2015 2:20 a.m., Amos Jeffries wrote:
&gt;<i> Here is mk2 of the Formatter class for doing display things to CacheMgr
</I>&gt;<i> report payloads.
</I>&gt;<i> 
</I>&gt;<i> I have removed the ostream parts of Alex proposal. Since these formatter
</I>&gt;<i> could create StoreEntryStream at need if they really had to and the
</I>&gt;<i> formatting API does not require that functionality.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I've labelled it PATCH, since this is operational code and I would like
</I>&gt;<i> to commit if it passes an audit.
</I>&gt;<i> 
</I>&gt;<i> Leaving more of the Formatter API and report conversions to followup
</I>&gt;<i> patches. This one is scoped at getting the base class existing with
</I>&gt;<i> exemplar use-cases.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>

[

On 11/08/2015 2:29 a.m., Alex Rousskov wrote:
&gt;<i> On 08/09/2015 09:39 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I hope we can come up with a minimal API (only usable for the very basic
</I>&gt;&gt;&gt;<i> output such as one-line notices and such). We will need to discuss and
</I>&gt;&gt;&gt;<i> agree on what that minimum is exactly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If YAML support is one of the ultimate goals, then I would propose
</I>&gt;&gt;&gt;<i> something like this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> // Assembles information for a single Cache Manager &quot;page&quot;.
</I>&gt;&gt;&gt;<i> // Supplied information goes into a configured stream.
</I>&gt;&gt;&gt;<i> // Kids implement various information formatting methods.
</I>&gt;&gt;&gt;<i> class Page: public std::ostream {
</I>&gt;&gt;&gt;<i> public:
</I>&gt;&gt;&gt;<i>     Page(std::ostream &amp;os);
</I>&gt;<i>
</I>&gt;&gt;<i> Does this mean you want to go head with PackableStream for the libmem
</I>&gt;&gt;<i> problem ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have nothing against PackableStream* classes as such. If they are
</I>&gt;<i> useful for something, they should be polished and committed, of course.
</I>&gt;<i>
</I>&gt;<i> I am against making half-way changes to the cache manager output.
</I>&gt;<i> Library dependencies can be changed without changing output.
</I>&gt;<i> Alternatively, we can solve linking problems while switching to the new
</I>&gt;<i> and _final_ output format. If you are doing the legwork, it is your call
</I>&gt;<i> whether to combine the two activities or separate them.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> If we plan to get rid of PackableStream / StoreEntryStream in the end
</I>&gt;&gt;<i> product that ctor could take a Packable&amp;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This assumes that the Page object does the actual append() to the
</I>&gt;&gt;<i> Packable it references.
</I>&gt;<i>
</I>&gt;<i> The Page essentially takes and uses PackableStream[Buffer]. There is no
</I>&gt;<i> good reason to keep using C-style printf()s if we have to change the
</I>&gt;<i> output anyway.
</I>&gt;<i>
</I>
Ah. Okay. My take-2 accepts Packable&amp; and later developments can
construct a PackableStream member for internal use from that if it needs
one.


&gt;&gt;&gt;<i>     virtual ~Page() {}
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     // a comment
</I>&gt;&gt;&gt;<i>     virtual Page &amp;comment(const SBuf &amp;text) = 0;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was suggesting just the above bit in the first patch.
</I>&gt;<i>
</I>&gt;<i> Fine with me, but your thoughts below seem to indicate that it is not
</I>&gt;<i> actually what you want to do (or that it is impossible to do using a
</I>&gt;<i> comment()).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Although the immediate uses seem more like notice box / announcements
</I>&gt;&gt;<i> than regular text comment. The display end would highlight them in bold
</I>&gt;&gt;<i> colors or something to attract attention.
</I>&gt;<i>
</I>&gt;<i> Then comment() is not appropriate. It would be appropriate for something
</I>&gt;<i> like &quot;no data collected for this page&quot; or &quot;internal error while
</I>&gt;<i> rendering statistics for this page&quot;. That is, for something that scripts
</I>&gt;<i> do not need to interpret (beyond the fact that there no actual data in
</I>&gt;<i> the output).
</I>&gt;<i>
</I>&gt;<i> You may add a Page::announce() method of some sort, of course, but it
</I>&gt;<i> has to be _implemented_ using basic YAML constructs like lists, hashes,
</I>&gt;<i> key:value pairs, comments, etc. Thus, you may need some of the other
</I>&gt;<i> methods from the sketch. This is important: To avoid changing same
</I>&gt;<i> output more than once, we have to use the right constructs in any
</I>&gt;<i> changed code.
</I>
YAML block-literal suits notices fine. Whereas comment would be YAML
comment since its only for human use.

Though for mk2 I have listed the existing report syntax in PayloadOldCgi
formatter. AFAICS, the reports that do not already conform to that are
malformed and show up broken in cachemgr.cgi display.

Amos
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002960.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
	<LI>Next message: <A HREF="002985.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2962">[ date ]</a>
              <a href="thread.html#2962">[ thread ]</a>
              <a href="subject.html#2962">[ subject ]</a>
              <a href="author.html#2962">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
