<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Ignore impossible SSL bumping actions, as intended and documented / bug 4237 fix
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Ignore%20impossible%20SSL%20bumping%20actions%2C%0A%20as%20intended%20and%20documented%20/%20bug%204237%20fix&In-Reply-To=%3C55C8C937.90709%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003087.html">
   <LINK REL="Next"  HREF="002974.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Ignore impossible SSL bumping actions, as intended and documented / bug 4237 fix</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Ignore%20impossible%20SSL%20bumping%20actions%2C%0A%20as%20intended%20and%20documented%20/%20bug%204237%20fix&In-Reply-To=%3C55C8C937.90709%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] Ignore impossible SSL bumping actions, as intended and documented / bug 4237 fix">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Mon Aug 10 15:54:31 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003087.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
        <LI>Next message: <A HREF="002974.html">[squid-dev] [PATCH] Ignore impossible SSL bumping actions, as intended and documented / bug 4237 fix
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2963">[ date ]</a>
              <a href="thread.html#2963">[ thread ]</a>
              <a href="subject.html#2963">[ subject ]</a>
              <a href="author.html#2963">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>According to Squid wiki: &quot;Some actions are not possible during  certain 
processing steps. During a given processing step, Squid ignores ssl_bump 
lines with impossible actions&quot;. The distributed squid.conf.documented 
has similar text.

Current Squid violates the above rule. Squid considers all actions, and 
if an impossible action matches first, Squid guesses what the true 
configuration intent was. Squid may guess wrong. For example, depending 
on the transaction, Squid may guess that a matching  stare or peek 
action during bumping step3 means &quot;bump&quot;, breaking peeked connections 
that cannot be bumped.

This unintended but gross configuration semantics violation remained 
invisible until bug 4237, probably because most configurations in most 
environments either worked around the problem (where admins experimented 
to &quot;make it work&quot;) or did not result in visible errors (where Squid 
guesses did not lead to terminated connections).

While configuration workarounds are possible, the current 
implementation is very wrong and leads to overly complex and, hence, 
often wrong configurations. It is also nearly impossible to document 
accurately because the guessing logic depends on too many factors.

To fix this, we add an action filtering/banning mechanism to Squid ACL 
code. This mechanism is then used to:
   - ban client-first and server-first on bumping steps 2 and 3.
   - ban peek and stare actions on bumping step 3.
   - ban splice on step3 if stare is selected on step2 and
     Squid cannot splice the SSL connection any more.
   - ban bump on step3 if peek is selected on step2 and
     Squid cannot bump the connection any more.

The same action filtering mechanism may be useful for other ACL-driven 
directives with state-dependent custom actions.

This change adds a runtime performance overhead of a single virtual 
method call to all ORed ACLs that do not use banned actions. That method 
itself just returns false unless the ACL represents a whole directive 
rule. In the latter case, an std::vector size() is also checked. It is 
possible to avoid this overhead by adding a boolean &quot;I may ban actions&quot; 
flag to Acl::OrNode, but we decided the small performance harm is not 
worth the extra code to set that flag.

This is a Measurement Factory project
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ignore-bumping-actions-t4.patch
Type: text/x-patch
Size: 24443 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150810/64dd2753/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150810/64dd2753/attachment.bin</A>&gt;
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003087.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
	<LI>Next message: <A HREF="002974.html">[squid-dev] [PATCH] Ignore impossible SSL bumping actions, as intended and documented / bug 4237 fix
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2963">[ date ]</a>
              <a href="thread.html#2963">[ thread ]</a>
              <a href="subject.html#2963">[ subject ]</a>
              <a href="author.html#2963">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
