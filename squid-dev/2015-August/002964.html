<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] squid SSL subsystem did not initialized	correctly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20squid%20SSL%20subsystem%20did%20not%20initialized%0A%09correctly&In-Reply-To=%3C55C8D02C.7050905%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002959.html">
   <LINK REL="Next"  HREF="002975.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] squid SSL subsystem did not initialized	correctly</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20squid%20SSL%20subsystem%20did%20not%20initialized%0A%09correctly&In-Reply-To=%3C55C8D02C.7050905%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] squid SSL subsystem did not initialized	correctly">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Mon Aug 10 16:24:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002959.html">[squid-dev] [PATCH] squid SSL subsystem did not initialized correctly
</A></li>
        <LI>Next message: <A HREF="002975.html">[squid-dev] [PATCH] squid SSL subsystem did not initialized correctly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2964">[ date ]</a>
              <a href="thread.html#2964">[ thread ]</a>
              <a href="subject.html#2964">[ subject ]</a>
              <a href="author.html#2964">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This patch looks OK

On 08/10/2015 05:12 PM, Amos Jeffries wrote:
&gt;<i> On 10/08/2015 11:29 p.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> On 08/06/2015 02:55 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 6/08/2015 9:54 p.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>      Currently SSL subsystem did not initialized correctly in squid
</I>&gt;&gt;&gt;&gt;<i> trunk.
</I>&gt;&gt;&gt;&gt;<i> This is because of the Security::ProxyOutgoingConfig.encryptTransport
</I>&gt;&gt;&gt;&gt;<i> which is always false so the client SSL CTX object never builds. As a
</I>&gt;&gt;&gt;&gt;<i> result squid may not start if SSL is configured. I am attaching a small
</I>&gt;&gt;&gt;&gt;<i> patch I am using in my squid trees to work with SSL.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This always-enabled code is not compatible with the possible admin
</I>&gt;&gt;&gt;<i> configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>    tls_outgoing_options disable
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can you please try this instead:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>    Security::PeerOptions::parse(const char *token)
</I>&gt;&gt;&gt;<i>    {
</I>&gt;&gt;&gt;<i>        if (strncmp(token, &quot;disable&quot;, 7) == 0) {
</I>&gt;&gt;&gt;<i>            clear();
</I>&gt;&gt;&gt;<i> +        return;
</I>&gt;&gt;&gt;<i>        } else if (strncmp(token, &quot;cert=&quot;, 5) == 0) {
</I>&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;<i>        } else {
</I>&gt;&gt;&gt;<i>            debugs(3, DBG_CRITICAL, &quot;ERROR: Unknown TLS option '&quot; &lt;&lt; ...
</I>&gt;&gt;&gt;<i> +        return;
</I>&gt;&gt;&gt;<i>        }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +    encryptTransport = true;
</I>&gt;&gt;&gt;<i>    }
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If that works you can go through and also remove uses of
</I>&gt;&gt;&gt;<i> &quot;secure.encryptTransport = true&quot; from adaptation/ServiceConfig.cc and
</I>&gt;&gt;&gt;<i> cache_cf.cc where it is set next to a call to secure.parse()
</I>&gt;&gt;&gt;<i> ... but not the other one where it is set to always-on for https_port.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is will not work, because it is not required for someone to
</I>&gt;&gt;<i> configure any of the sslproxy options for the SSL client to work.
</I>&gt;&gt;<i> Squid can always work with the default options.
</I>&gt;<i>
</I>&gt;<i> Did you test it?
</I>&gt;<i>
</I>&gt;<i> The default squid.conf parser always sets &quot;tls_outgoing_options
</I>&gt;<i> tls-min-version=1.0&quot;. Which should auto-enable DIRECT outgoing, then
</I>&gt;<i> explicit disable is required to turn off again.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> http_port ... protocol=HTTPS and https_port forces
</I>&gt;<i> &quot;encryptTransport=true;&quot; explicitly based on the expected protocol. So
</I>&gt;<i> it is either enabled by the parse() call when TLS options are used, or
</I>&gt;<i> forced on anyway later when the protocol is validated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="icaps://">icaps://</A> services also explicitly set &quot;encryptTransport=true;&quot;
</I>&gt;<i> explicitly based on 's' in the service URI scheme.
</I>&gt;<i>
</I>&gt;<i> The cache_peer requires a minimum of &quot;ssl&quot; option to be configured. And
</I>&gt;<i> calls parse(). I see that simple case is passing &quot;&quot; token which gets
</I>&gt;<i> reported as unknown option.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> With the attached patch TLS should be:
</I>&gt;<i> * default-on for all https_port, <A HREF="icaps://">icaps://</A> services, and outgoing
</I>&gt;<i> <A HREF="https://">https://</A> traffic.
</I>&gt;<i> * manually enabled on cache_peer and http_port.
</I>&gt;<i> * manually disabled on outgoing <A HREF="https://">https://</A> traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Security::ProxyOutgoingConfig.encryptTransport = true must be always
</I>&gt;&gt;<i> true unless the the SSL client is disabled.
</I>&gt;<i>
</I>&gt;<i> Yes. And the default config should see to that happening. Which is why I
</I>&gt;<i> asked if you could try the change.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In previous squid releases it was not possible to disable SSL client,
</I>&gt;&gt;<i> but now looks that this is can be done using the
</I>&gt;&gt;<i>    &quot;tls_outgoing_options disable&quot;
</I>&gt;<i>
</I>&gt;<i> Yes, that is new in Squid-4. Along with some small non-OpenSSL HTTPS
</I>&gt;<i> support (not much yet, but growing).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Maybe we need to add a parameter to Security::PeerOptions constructor,
</I>&gt;&gt;<i> to define if the SSL is enabled by default (for example in the case of
</I>&gt;&gt;<i> ProxyOutgoingConfig) or not (for example in HTTP ports configuration).
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That would be messy because ProxyOutgoingConfig is a global and the
</I>&gt;<i> others are all explicitly constructed.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i>
</I>
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002959.html">[squid-dev] [PATCH] squid SSL subsystem did not initialized correctly
</A></li>
	<LI>Next message: <A HREF="002975.html">[squid-dev] [PATCH] squid SSL subsystem did not initialized correctly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2964">[ date ]</a>
              <a href="thread.html#2964">[ thread ]</a>
              <a href="subject.html#2964">[ subject ]</a>
              <a href="author.html#2964">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
