<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] PackableStream for cachemgr reports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PackableStream%20for%20cachemgr%20reports&In-Reply-To=%3C55C8D095.401%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002961.html">
   <LINK REL="Next"  HREF="002938.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] PackableStream for cachemgr reports</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PackableStream%20for%20cachemgr%20reports&In-Reply-To=%3C55C8D095.401%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] PackableStream for cachemgr reports">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Aug 10 16:25:57 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002961.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
        <LI>Next message: <A HREF="002938.html">[squid-dev] [PATCH] squid SSL subsystem did not initialized	correctly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2965">[ date ]</a>
              <a href="thread.html#2965">[ thread ]</a>
              <a href="subject.html#2965">[ subject ]</a>
              <a href="author.html#2965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/09/2015 01:47 AM, Amos Jeffries wrote:
&gt;&gt;&gt;<i> However the char(int_type) type constructor is necessary because this is
</I>&gt;&gt;&gt;<i> the fundamental int_type being passed in. All the available
</I>&gt;&gt;&gt;<i> *_cast&lt;char&gt;() operators are built to convert a 32-bit int_type value
</I>&gt;&gt;&gt;<i> into an array of 4 bytes before dealing with the byte-&gt;char conversion
</I>&gt;&gt;&gt;<i> part. Which then incorrectly takes the lowest-8 bits rather than the
</I>&gt;&gt;&gt;<i> first-8.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am curious where you got the above information from, especially the
</I>&gt;&gt;<i> last sentence.
</I>

&gt;<i> From several long days testing why static_cast always 0-terminated the
</I>&gt;<i> strings when trying to fix this same thing in the same way for
</I>&gt;<i> StoreEntryStream years back. LP says rev.11605 (initial c++0x support).
</I>
Trunk r11605 just enables C++0x. The commit message does not mention how
that relates to the code change we are discussing. Are you saying that
enabling C++0x support broke the code with implicit casts [and did not
let you add an explicit static_cast]?


&gt;<i> Repeating the tests it seems to work now. Although I am building with
</I>&gt;<i> GCC-5 now. IIRC that was about GCC 4.6-ish.
</I>
My simple static_cast tests appear to work as expected with GCC 4.4, but
I do not know how to reproduce the problem you were facing. GCC 4.4
defines &quot;int_type&quot; for char-based traits as &quot;int&quot;, just like the modern
GCC versions do and the STL documentation says.


&gt;<i> +            // NP: cast because GCC promotes int_type to 32-bit type
</I>&gt;<i> +            //     std::basic_streambuf&lt;char&gt;::int_type {aka int}
</I>&gt;<i> +            //     despite the definition with 8-bit type value.
</I>
If you are sure that static_cast did not work for earlier GCC versions,
please s/GCC/old GCC/ or something like that in your comment because the
comment does not make sense in the context of the [current] GCC STL code
and the C++ standard itself.

What definition do you refer to as &quot;definition with 8-bit type value&quot;?

How can &quot;GCC promote int_type to 32-bit type ... int&quot; if int_type _is_
int (in both traits and streambuf)?


&gt;&gt;<i> Also, do not declare &quot;chars&quot; until you need them. This is unrelated to
</I>&gt;&gt;<i> casting. It is related to where you declare &quot;chars&quot;. You are declaring
</I>&gt;&gt;<i> them too early, inserting them in the wider context where they are not
</I>&gt;&gt;<i> needed AFAICT.
</I>

&gt;<i> Looking up the origins of the hack I found the chars being outside the
</I>&gt;<i> if() was result of a different patch by one Alex R when adding the if(). :-P
</I>
If you mean trunk r7557, that was not my code, but even if it were, I am
surprised you waste your time on investigating who committed imperfect
code almost ten years ago and then sharing that invaluable information
with the rest of us.

If you want to accuse me of being more picky about others code, then
please say so explicitly (but it does not address the problem at hand).
If you want to keep the new class in sync with the old code, then please
use a source code comment to document your decision. If you want to
excuse minor problems in the code you propose, then I recommend just
fixing them instead because doing so saves time.


&gt;<i> +        if (aChar != traits_type::eof()) {
</I>...
&gt;<i> +            if (aChar != traits_type::eof())
</I>
And why test the same thing twice? The aChar variable does not change.
Can we just remove the second test?


&gt;&gt;&gt;&gt;&gt;<i> +                outBuf-&gt;append(chars, 1);
</I>&gt;&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;&gt;&gt;<i> +            outBuf-&gt;append(pbase(), pending);
</I>&gt;&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;&gt;&gt;<i> +            outBuf-&gt;append(chars, number);
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> To reduce code duplication and to assist with debugging, it would be
</I>&gt;&gt;&gt;&gt;<i> nice to move these three into a single dedicated private write() method
</I>&gt;&gt;&gt;&gt;<i> or similar.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Calling xsputn() instead now. Although note that trampolining off a
</I>&gt;&gt;&gt;<i> virtual function (non-inlinable in some compilers) actually makes it
</I>&gt;&gt;&gt;<i> less efficient.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is exactly the reason I did not suggest to call xsputn(). Please do
</I>&gt;&gt;<i> not call that virtual method! Please add and call a dedicated private
</I>&gt;&gt;<i> write() method (or similar).
</I>&gt;<i> 
</I>&gt;<i> So what is the point then?
</I>
I have documented both points in my original request: To reduce code
duplication and to assist with debugging.


&gt;<i> If it is inline the compiler optimizes it away even in stack traces. No
</I>&gt;<i> use for debugging then.
</I>
Unless one builds with inlining disabled (as some of us often do) or
adds a temporary debugs() statement to that new method.

Alex.

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002961.html">[squid-dev] [PATCH] PackableStream for cachemgr reports
</A></li>
	<LI>Next message: <A HREF="002938.html">[squid-dev] [PATCH] squid SSL subsystem did not initialized	correctly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2965">[ date ]</a>
              <a href="thread.html#2965">[ thread ]</a>
              <a href="subject.html#2965">[ subject ]</a>
              <a href="author.html#2965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
