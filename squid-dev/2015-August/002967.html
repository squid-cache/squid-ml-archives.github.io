<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reject responses with conflicting	Content-Length
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%09Content-Length&In-Reply-To=%3C55C91941.8060104%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002950.html">
   <LINK REL="Next"  HREF="002976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reject responses with conflicting	Content-Length</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%09Content-Length&In-Reply-To=%3C55C91941.8060104%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Reject responses with conflicting	Content-Length">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Aug 10 21:36:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002950.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
        <LI>Next message: <A HREF="002976.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2967">[ date ]</a>
              <a href="thread.html#2967">[ thread ]</a>
              <a href="subject.html#2967">[ subject ]</a>
              <a href="author.html#2967">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/07/2015 10:48 PM, Amos Jeffries wrote:
&gt;<i> On 8/08/2015 8:54 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i>     Squid trusts and forwards the largest Content-Length header. This
</I>&gt;&gt;<i> behavior violates an RFC 7230 MUST in Section 3.3.3 item #4. It also
</I>&gt;&gt;<i> confuses some ICAP services and probably some HTTP clients. With the
</I>&gt;&gt;<i> proposed changes, Squid refuses to forward the message to the ICAP
</I>&gt;&gt;<i> service and HTTP client, responding with an HTTP 502 error instead.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is a quick-and-dirty implementation. A polished version should
</I>&gt;&gt;<i> reject responses with invalid Content-Length values as well (per RFC
</I>&gt;&gt;<i> 7230 MUST), should return 502 even with a strict parser (this is not a
</I>&gt;&gt;<i> header parsing issue), and should probably not warn the admin when all
</I>&gt;&gt;<i> values actually match.
</I>

&gt;<i> Please do eitehr XXX or implement the clause about 502 on invalid
</I>&gt;<i> Content-Length header. The unable to parse cases when comparing l1 and
</I>&gt;<i> l2 at chunk @548.
</I>
XXX added:

&gt;<i> // XXX: RFC 7230 Section 3.3.3 item #4 requires sending a 502 error in 
</I>&gt;<i> // several cases that we do not yet cover. TODO: Rewrite to cover more.
</I>&gt;<i> if (e-&gt;id == Http::HdrType::CONTENT_LENGTH &amp;&amp; (e2 = ...
</I>

I am reluctant to make invalid Content-Length handling compliant during
this project because

(a) the right fix will probably require a serious code rewrite; and

(b) I do not have a good way to test how damaging that compliance will
be to real traffic. There might be enough malformed benign responses out
there to necessitate a USE_HTTP_VIOLATIONS exception when there is no
Transfer-Encoding, there is only one Content-Length header field, and
that single header field is malformed.


While writing that XXX, I realized that Squid has a similar bug with
request processing, and that the proposed change affects but is not
enough to fix the request processing path. To fix that, I added the
following check to the existing clientIsContentLengthValid() in
client_side.cc:


&gt;<i> +// checks body length of non-chunked requests
</I>&gt;<i>  static int
</I>&gt;<i>  clientIsContentLengthValid(HttpRequest * r)
</I>&gt;<i>  {
</I>&gt;<i> +    // No Content-Length means this request just has no body, but conflicting
</I>&gt;<i> +    // Content-Lengths mean a message framing error (RFC 7230 Section 3.3.3 #4).
</I>&gt;<i> +    if (r-&gt;header.conflictingContentLength())
</I>&gt;<i> +        return 0;
</I>&gt;<i> +
</I>&gt;<i>      switch (r-&gt;method.id()) {
</I>

Just like with response handling, the above code is not enough to cover
all bad request cases, but it improves coverage. Addressing the new XXX
comment will cover more HTTP Client and Server cases.

Finally, while testing request path changes, I noticed that the patch
left multiple same-value Content-Length fields in the header. The
committed version leaves just one of them, as the unpatched Squid code did.


&gt;<i> +1 as a temporary workaround. Looks like it catches some important cases
</I>&gt;<i> correctly.
</I>
Committed to trunk as r14215. Please let me know if you see any problems
with the added clientIsContentLengthValid() code.


For the record, here is a Bing server response that prompted this change:

&gt;<i> HTTP/1.1 206 Partial Content
</I>&gt;<i> Cache-Control: public, max-age=15552000
</I>&gt;<i> Content-Length: 14543
</I>&gt;<i> Content-Type: application/x-javascript; charset=utf-8
</I>&gt;<i> Last-Modified: Tue, 14 Jul 2015 01:35:04 GMT
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Server: Microsoft-IIS/8.5
</I>&gt;<i> Date: Wed, 05 Aug 2015 15:42:26 GMT
</I>&gt;<i> Content-Length: 300
</I>&gt;<i> Content-Range: bytes 14243-14542/14543
</I>&gt;<i> Accept-Ranges: bytes
</I>
As you can see, the addition of an extra Content-Length field was
probably triggered by the partial response to the Range request.


HTH,

Alex.

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002950.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
	<LI>Next message: <A HREF="002976.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2967">[ date ]</a>
              <a href="thread.html#2967">[ thread ]</a>
              <a href="subject.html#2967">[ subject ]</a>
              <a href="author.html#2967">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
