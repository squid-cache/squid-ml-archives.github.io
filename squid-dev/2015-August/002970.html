<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [WTF] HttpHeader strangenesses
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BWTF%5D%20HttpHeader%20strangenesses&In-Reply-To=%3C55C92F71.4090405%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002966.html">
   <LINK REL="Next"  HREF="002973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [WTF] HttpHeader strangenesses</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BWTF%5D%20HttpHeader%20strangenesses&In-Reply-To=%3C55C92F71.4090405%40measurement-factory.com%3E"
       TITLE="[squid-dev] [WTF] HttpHeader strangenesses">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Aug 10 23:10:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002966.html">[squid-dev] [WTF] HttpHeader strangenesses
</A></li>
        <LI>Next message: <A HREF="002973.html">[squid-dev] [WTF] HttpHeader strangenesses
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2970">[ date ]</a>
              <a href="thread.html#2970">[ thread ]</a>
              <a href="subject.html#2970">[ subject ]</a>
              <a href="author.html#2970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/10/2015 02:13 PM, Kinkie wrote:
&gt;<i> I'm going over HttpHeader to see if there's any possible improvements to
</I>&gt;<i> be obtained by dragging it (kicking and screaming, from the look of it)
</I>&gt;<i> into the 10's.
</I>&gt;<i> 
</I>&gt;<i> Here's a list of weirdnesses I'm coming to find, hopefully someone has
</I>&gt;<i> any idea of WHY they are like this, or if they can be safely be removed:
</I>&gt;<i> 
</I>&gt;<i> - HttpHeader::insertTime makes no sense. It's O(N) and it's always used
</I>&gt;<i> in two patterns: delById(HDR); insertTime(HDR) and if (!has(HDR)
</I>&gt;<i> insertTime(HDR)).
</I>

Henrik may know why he went the extra mile to insert header Date at the
beginning of the message as opposed to just appending it at the end
(trunk r7037).

If I have to guess, I would say that it might be related to the RFC 2616
recommendation to order headers a certain way:

&gt;<i> it is &quot;good practice&quot; to send
</I>&gt;<i> general-header fields first, followed by request-header or response-
</I>&gt;<i> header fields, and ending with the entity-header fields.
</I>

RFC 7230 updates that with:

&gt;<i> it is good practice to send
</I>&gt;<i> header fields that contain control data first, such as Host on
</I>&gt;<i> requests and Date on responses
</I>


&gt;<i> I've replaced with putTime everywhere
</I>
Sounds good to me. IIRC, at some point, we have tried to make &quot;put&quot;
delete all old headers, but I doubt that idea survived. To make the code
consistent, you may want to check that no remaining put methods delete
old headers now (and adjust the code as needed if some still do).


&gt;<i> - why doesn't HttpHeaderEntry use a copy-constructor, relying instead in
</I>&gt;<i> a clone() method?
</I>
The conversion from a C struct to a C++ class was incomplete, most
likely because we did not know as much about C++ as we know now.
Renaming the old httpHeaderEntryClone() into HttpHeaderEntry::clone()
was probably a natural thing to do ten years ago (trunk r7589).


&gt;<i> - why the strange loop in HttpHeader's copy-constructor?
</I>
What do you find strange about it? It just reuses a method to clone all
the header fields from the other header. I could (should?) have
optimized this by refactoring the cloning/second loop from update() into
a separate cloneEntries() method and using just that.


&gt;<i> Replaced with a &quot;= default&quot;, it should be just fine..
</I>
But is it? AFAICT, the &quot;default&quot; (i.e., generated) copy constructor will
not clone individual header entries. Perhaps you have added some magic
to make that cloning happen now, but the old code did require an
explicit cloning loop (the second loop in update(), see above).


&gt;<i> - statistics accounting: we count A LOT (see HttpHeader::clean) Is it
</I>&gt;<i> really worth it in a performance-critical code as this? Maybe we could
</I>&gt;<i> shuffle things around to HttpHeader and HttpHeaderEntry's ctor and dtor ..
</I>
The statics code is ugly and, IIRC, collects inaccurate stats in many
cases. I am sure it can be significantly improved.

However, I would recommend going into the _opposite_ direction. Instead
of trying to find the right low-level code to collect header stats (and
then dealing with problems such as cloned headers screwing up all
stats), I would add dedicated statistics-collection calls in a few
specific places in the high-level code, where new headers are &quot;accepted
into Squid&quot; and should be counted.

Neither approach will cover 100% of cases, but I think the high-level
approach will have a lot less problems overall. As an added bonus, it
would be easier to disable all or some statistics header collection that
way.


HTH,

Alex.

</PRE>



































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002966.html">[squid-dev] [WTF] HttpHeader strangenesses
</A></li>
	<LI>Next message: <A HREF="002973.html">[squid-dev] [WTF] HttpHeader strangenesses
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2970">[ date ]</a>
              <a href="thread.html#2970">[ thread ]</a>
              <a href="subject.html#2970">[ subject ]</a>
              <a href="author.html#2970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
