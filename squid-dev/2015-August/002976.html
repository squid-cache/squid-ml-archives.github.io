<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reject responses with conflicting Content-Length
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%20Content-Length&In-Reply-To=%3C55C98873.4060707%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002967.html">
   <LINK REL="Next"  HREF="002987.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reject responses with conflicting Content-Length</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%20Content-Length&In-Reply-To=%3C55C98873.4060707%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Reject responses with conflicting Content-Length">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 11 05:30:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002967.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
        <LI>Next message: <A HREF="002987.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2976">[ date ]</a>
              <a href="thread.html#2976">[ thread ]</a>
              <a href="subject.html#2976">[ subject ]</a>
              <a href="author.html#2976">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/08/2015 9:36 a.m., Alex Rousskov wrote:
&gt;<i> On 08/07/2015 10:48 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 8/08/2015 8:54 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i>     Squid trusts and forwards the largest Content-Length header. This
</I>&gt;&gt;&gt;<i> behavior violates an RFC 7230 MUST in Section 3.3.3 item #4. It also
</I>&gt;&gt;&gt;<i> confuses some ICAP services and probably some HTTP clients. With the
</I>&gt;&gt;&gt;<i> proposed changes, Squid refuses to forward the message to the ICAP
</I>&gt;&gt;&gt;<i> service and HTTP client, responding with an HTTP 502 error instead.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This is a quick-and-dirty implementation. A polished version should
</I>&gt;&gt;&gt;<i> reject responses with invalid Content-Length values as well (per RFC
</I>&gt;&gt;&gt;<i> 7230 MUST), should return 502 even with a strict parser (this is not a
</I>&gt;&gt;&gt;<i> header parsing issue), and should probably not warn the admin when all
</I>&gt;&gt;&gt;<i> values actually match.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Please do eitehr XXX or implement the clause about 502 on invalid
</I>&gt;&gt;<i> Content-Length header. The unable to parse cases when comparing l1 and
</I>&gt;&gt;<i> l2 at chunk @548.
</I>&gt;<i> 
</I>&gt;<i> XXX added:
</I>&gt;<i> 
</I>&gt;&gt;<i> // XXX: RFC 7230 Section 3.3.3 item #4 requires sending a 502 error in 
</I>&gt;&gt;<i> // several cases that we do not yet cover. TODO: Rewrite to cover more.
</I>&gt;&gt;<i> if (e-&gt;id == Http::HdrType::CONTENT_LENGTH &amp;&amp; (e2 = ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I am reluctant to make invalid Content-Length handling compliant during
</I>&gt;<i> this project because
</I>&gt;<i> 
</I>&gt;<i> (a) the right fix will probably require a serious code rewrite; and
</I>&gt;<i> 
</I>&gt;<i> (b) I do not have a good way to test how damaging that compliance will
</I>&gt;<i> be to real traffic. There might be enough malformed benign responses out
</I>&gt;<i> there to necessitate a USE_HTTP_VIOLATIONS exception when there is no
</I>&gt;<i> Transfer-Encoding, there is only one Content-Length header field, and
</I>&gt;<i> that single header field is malformed.
</I>
There is exactly 2 cases of benign malformation:

 * duplicate identical Content-Length
 * header is a list of identical values (ie &quot;42, 42,42&quot;)

Erase and ignore is required for both cases.

The MUST requirement in section 3.3.2 paragraph 9 is an &quot;either ... or
...&quot; text requiring that we clean up the malformation when we can do so
without guessing the Content-Length's real intended value.

All other malformations are *malign*.

The case of Content-Length + Transfer-Encoding is *malign* malformation.
With many known abuses and failures resulting. Squid is part of the
problem here.

Content-Length on CONNECT or its 200 reponse is also malign
malformation. It is seen a lot in the wild but, ignoring causes worse
problems than 502.
- stripping the Content-Length causes browser/client cache poisoning.
- allowing it through leads to aborted tunnels with User-visible
mangling and malformations from incomplete content returned inside.


Note: high-speed routers that need to disable Content-Length headers do
so by mangling the name portion so it shows up as an unknown custom
header. There is never a need to send invalid value portions.


&gt;<i> 
</I>&gt;<i> While writing that XXX, I realized that Squid has a similar bug with
</I>&gt;<i> request processing, and that the proposed change affects but is not
</I>&gt;<i> enough to fix the request processing path. To fix that, I added the
</I>&gt;<i> following check to the existing clientIsContentLengthValid() in
</I>&gt;<i> client_side.cc:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> +// checks body length of non-chunked requests
</I>&gt;&gt;<i>  static int
</I>&gt;&gt;<i>  clientIsContentLengthValid(HttpRequest * r)
</I>&gt;&gt;<i>  {
</I>&gt;&gt;<i> +    // No Content-Length means this request just has no body, but conflicting
</I>&gt;&gt;<i> +    // Content-Lengths mean a message framing error (RFC 7230 Section 3.3.3 #4).
</I>&gt;&gt;<i> +    if (r-&gt;header.conflictingContentLength())
</I>&gt;&gt;<i> +        return 0;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i>      switch (r-&gt;method.id()) {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Just like with response handling, the above code is not enough to cover
</I>&gt;<i> all bad request cases, but it improves coverage. Addressing the new XXX
</I>&gt;<i> comment will cover more HTTP Client and Server cases.
</I>&gt;<i> 
</I>&gt;<i> Finally, while testing request path changes, I noticed that the patch
</I>&gt;<i> left multiple same-value Content-Length fields in the header. The
</I>&gt;<i> committed version leaves just one of them, as the unpatched Squid code did.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> +1 as a temporary workaround. Looks like it catches some important cases
</I>&gt;&gt;<i> correctly.
</I>&gt;<i> 
</I>&gt;<i> Committed to trunk as r14215. Please let me know if you see any problems
</I>&gt;<i> with the added clientIsContentLengthValid() code.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> For the record, here is a Bing server response that prompted this change:
</I>&gt;<i> 
</I>&gt;&gt;<i> HTTP/1.1 206 Partial Content
</I>&gt;&gt;<i> Cache-Control: public, max-age=15552000
</I>&gt;&gt;<i> Content-Length: 14543
</I>&gt;&gt;<i> Content-Type: application/x-javascript; charset=utf-8
</I>&gt;&gt;<i> Last-Modified: Tue, 14 Jul 2015 01:35:04 GMT
</I>&gt;&gt;<i> Vary: Accept-Encoding
</I>&gt;&gt;<i> Server: Microsoft-IIS/8.5
</I>&gt;&gt;<i> Date: Wed, 05 Aug 2015 15:42:26 GMT
</I>&gt;&gt;<i> Content-Length: 300
</I>&gt;&gt;<i> Content-Range: bytes 14243-14542/14543
</I>&gt;&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> 
</I>&gt;<i> As you can see, the addition of an extra Content-Length field was
</I>&gt;<i> probably triggered by the partial response to the Range request.
</I>&gt;<i> 
</I>
Yes. C-L holds the message payload size, not the original object size.
 RFC 7233 section-4.1 examples show that.

Is that an IIS? Bing? or ICAP server bug?

Amos
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002967.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
	<LI>Next message: <A HREF="002987.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2976">[ date ]</a>
              <a href="thread.html#2976">[ thread ]</a>
              <a href="subject.html#2976">[ subject ]</a>
              <a href="author.html#2976">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
