<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [WTF] HttpHeader strangenesses
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BWTF%5D%20HttpHeader%20strangenesses&In-Reply-To=%3C55CA247B.7000608%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002973.html">
   <LINK REL="Next"  HREF="002968.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [WTF] HttpHeader strangenesses</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BWTF%5D%20HttpHeader%20strangenesses&In-Reply-To=%3C55CA247B.7000608%40measurement-factory.com%3E"
       TITLE="[squid-dev] [WTF] HttpHeader strangenesses">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Aug 11 16:36:11 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002973.html">[squid-dev] [WTF] HttpHeader strangenesses
</A></li>
        <LI>Next message: <A HREF="002968.html">[squid-dev] squid-3.5.6  -- debug missing? and a few others?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2982">[ date ]</a>
              <a href="thread.html#2982">[ thread ]</a>
              <a href="subject.html#2982">[ subject ]</a>
              <a href="author.html#2982">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/10/2015 08:47 PM, Amos Jeffries wrote:
&gt;<i> On 11/08/2015 11:10 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 08/10/2015 02:13 PM, Kinkie wrote:
</I>&gt;&gt;&gt;<i> I'm going over HttpHeader to see if there's any possible improvements to
</I>&gt;&gt;&gt;<i> be obtained by dragging it (kicking and screaming, from the look of it)
</I>&gt;&gt;&gt;<i> into the 10's.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's a list of weirdnesses I'm coming to find, hopefully someone has
</I>&gt;&gt;&gt;<i> any idea of WHY they are like this, or if they can be safely be removed:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> - HttpHeader::insertTime makes no sense. It's O(N) and it's always used
</I>&gt;&gt;&gt;<i> in two patterns: delById(HDR); insertTime(HDR) and if (!has(HDR)
</I>&gt;&gt;&gt;<i> insertTime(HDR)).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Henrik may know why he went the extra mile to insert header Date at the
</I>&gt;&gt;<i> beginning of the message as opposed to just appending it at the end
</I>&gt;&gt;<i> (trunk r7037).
</I>

&gt;<i> IIRC its a HTTP/1.0 performance optimization.
</I>&gt;<i> 
</I>&gt;<i> Locating Host quickly avoids work in the inefficient getHost() pre-parse
</I>&gt;<i> function which is now Http::One::Parser::getHeaderField().
</I>&gt;<i> 
</I>&gt;<i> Locating Date header at the top avoids a similar scan to determine
</I>&gt;<i> cacheability and validity of received replies. AFAIK that is not a
</I>&gt;<i> useful now that HTTP/1.1 involve other headers than Date.
</I>

If you are talking about optimizing Squid code, then I think we should
work on removing any &quot;preparse&quot; scans such as getHeaderField() calls in
prepareAcceleratedURL() instead of discussing their optimization:

1. Quickly parse into an object supporting fast lookups/manipulations.
2. Perform semantic analysis and manipulations using the object from #1.


&gt;<i> So if we want to optimize it is probably best to optimize allowing this
</I>&gt;<i> type of insertion than to remove it completely. 
</I>
We should not remove what we need, of course. Just be careful about
optimizing something we do not use often or should not be using often.

For example:

* Probably useful optimization: Replace most remove/insert pairs with an
update operation that does not remove or insert anything unless the
removal is actually needed.

* Probably a waste of time: Optimizing the insertion-at-the-top that
either does not happen often now or should not continue to happen often
[after other, useful optimizations].


&gt;<i> We probably want to be making the headers list into multiple lists and
</I>&gt;<i> just add/remove/append to the appropriate one. Squid will mostly not
</I>&gt;<i> have to deal with the entity or custom headers at all and it wastes time
</I>&gt;<i> searching through them for control headers that were already found
</I>&gt;<i> during parse.
</I>
Avoid scans for something already detected is important, but I do not
think it is (or should be) related to splitting headers into multiple
lists. I recommend keeping a single container at least until we catch
all the bigger fish. Moreover, the way we optimize lookups may influence
how we split the storage container in the future (if such a split is
needed at all).


&gt;<i> We may also want to think about having the control headers as
</I>&gt;<i> first-class unique members of HttpHeader instead of using the list
</I>&gt;<i> accesses. For example a HdrDate HdrCc, HdrSc, Hdr member that stores the
</I>&gt;<i> date including a &quot;not present&quot; flag. 
</I>
Yes, and we already store some parsed field values (e.g.,
content_length), but clumsily.


&gt;<i> Leaving the headers list only containing the entity and unknown headers.
</I>
Not storing original header field images is a separate optimization
decision IMO (compared to storing their parsed values). We may actually
want to preserve images while caching parsed values.


&gt;<i>  Assembling the message buffer would then be a hard-coded sequence of {
</I>&gt;<i> member Host, member Date, member Cc, member ..., walk generic headers list }
</I>
If we are talking about optimization, it may be best to _avoid_
re-assembly of header fields that do not require modifications. If that
is too difficult, then we may want to avoid generation of string images
for header fields that we have seen a reusable string image for. All of
this will probably save a lot more cycles than splitting header field
container.


&gt;&gt;&gt;<i> - statistics accounting: we count A LOT (see HttpHeader::clean) Is it
</I>&gt;&gt;&gt;<i> really worth it in a performance-critical code as this? Maybe we could
</I>&gt;&gt;&gt;<i> shuffle things around to HttpHeader and HttpHeaderEntry's ctor and dtor ..
</I>
&gt;&gt;<i> The statics code is ugly and, IIRC, collects inaccurate stats in many
</I>&gt;&gt;<i> cases. I am sure it can be significantly improved.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, I would recommend going into the _opposite_ direction. Instead
</I>&gt;&gt;<i> of trying to find the right low-level code to collect header stats (and
</I>&gt;&gt;<i> then dealing with problems such as cloned headers screwing up all
</I>&gt;&gt;<i> stats), I would add dedicated statistics-collection calls in a few
</I>&gt;&gt;<i> specific places in the high-level code, where new headers are &quot;accepted
</I>&gt;&gt;<i> into Squid&quot; and should be counted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Neither approach will cover 100% of cases, but I think the high-level
</I>&gt;&gt;<i> approach will have a lot less problems overall. As an added bonus, it
</I>&gt;&gt;<i> would be easier to disable all or some statistics header collection that
</I>&gt;&gt;<i> way.
</I>

&gt;<i> Agreed. Parser is the only thing that should be stats accounting for
</I>&gt;<i> &quot;seen&quot; (aka received) headers. And that can do it at the same point it
</I>&gt;<i> adds the freshly parsed value to the HttpHeader object state.
</I>

Parser is an example of low-level code that I would not associate with
statistics collection _unless_ your goal is to actually collect
low-level statistics about parsing. AFAIK, the original goal of header
statistics collection was to learn &quot;what internet traffic looks like&quot;.
What we parse is different (e.g., we may parse the same HTTP message
header more than once).


HTH,

Alex.

</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002973.html">[squid-dev] [WTF] HttpHeader strangenesses
</A></li>
	<LI>Next message: <A HREF="002968.html">[squid-dev] squid-3.5.6  -- debug missing? and a few others?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2982">[ date ]</a>
              <a href="thread.html#2982">[ thread ]</a>
              <a href="subject.html#2982">[ subject ]</a>
              <a href="author.html#2982">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
