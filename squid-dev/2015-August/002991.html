<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reject responses with conflicting Content-Length
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%20Content-Length&In-Reply-To=%3C55CADE79.6020408%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002987.html">
   <LINK REL="Next"  HREF="002994.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reject responses with conflicting Content-Length</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reject%20responses%20with%20conflicting%0A%20Content-Length&In-Reply-To=%3C55CADE79.6020408%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Reject responses with conflicting Content-Length">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 12 05:49:45 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002987.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
        <LI>Next message: <A HREF="002994.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2991">[ date ]</a>
              <a href="thread.html#2991">[ thread ]</a>
              <a href="subject.html#2991">[ subject ]</a>
              <a href="author.html#2991">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/08/2015 6:34 a.m., Alex Rousskov wrote:
&gt;<i> On 08/10/2015 11:30 PM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> There is exactly 2 cases of benign malformation:
</I>&gt;<i> ...
</I>&gt;&gt;<i> All other malformations are *malign*.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This is your opinion, not a fact.
</I>&gt;<i> 
</I>
Which one of these malformations is not malign ?

 * non-numeric Content-Length

 * negative value Content-Length

 * Content-Length with also Transfer-Encoding header

 * multiple different-value Content-Length

 * Content-Length on 204 response
 (&lt;<A HREF="http://lists.w3.org/Archives/Public/ietf-http-wg/2015AprJun/0488.html">http://lists.w3.org/Archives/Public/ietf-http-wg/2015AprJun/0488.html</A>&gt;)

Those plus the 2 benign ones are the entire set of possible malformations.


Note that I am speaking of malformations. There are several cases were
even the above nastiness is *not* malformed;


* Wrong size value is not malformed so long as it is a positive (0 or
more) integer value, and only one Content-Length header exists.

* Content-Length on HEAD and 304 are not malformed so long as the value
is positive (0 or more) integer.
(&lt;<A HREF="http://lists.w3.org/Archives/Public/ietf-http-wg/2015AprJun/0489.html">http://lists.w3.org/Archives/Public/ietf-http-wg/2015AprJun/0489.html</A>&gt;)

* CONNECT (request and reply) are not malformed, regardless of what crap
might be in the header value.
 (&lt;<A HREF="http://www.rfc-editor.org/errata_search.php?rfc=7231&amp;eid=4351">http://www.rfc-editor.org/errata_search.php?rfc=7231&amp;eid=4351</A>&gt;)
&quot;
On Wed, Apr 29, 2015 at 04:00:36PM -0700, Roy T. Fielding wrote:
&gt;&gt;<i> Ignoring the Content-Length has the side-effect that the 2xx CONNECT
</I>&gt;&gt;<i> response body is treated as application data.  Why ignore that which
</I>&gt;&gt;<i> must not be sent, and why ignore it if processing it and then treating
</I>&gt;&gt;<i> the response body as application data... has the same effect?
</I>&gt;<i>
</I>&gt;<i> The header fields MUST be ignored -- not the bits after the response.
</I>&gt;<i> The response has no body!
</I>&quot;



&gt;<i> IMO, being &quot;benign&quot; cannot be defined by an RFC because that
</I>&gt;<i> classification depends on real-world circumstances, not just syntax
</I>&gt;<i> rules. An RFC can require action X when a header is malformed, of
</I>&gt;<i> course. We ought to follow that recommendation except if doing X breaks
</I>&gt;<i> too many benign real-world cases. If the latter happens, we may want to
</I>&gt;<i> give admin a choice.
</I>&gt;<i> 
</I>&gt;<i> All of that complexity and decision making is outside this thread scope.
</I>&gt;<i> 
</I>
I'm getting a little tired of repeating this phrase. So I'll quote :
&quot;
On 29/04/2015 5:01 p.m., Willy Tarreau wrote
&gt;<i>
</I>&gt;<i> Don't forget that RFC723x aim at describing
</I>&gt;<i> what *is* deployed and how to best interoperate.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Willy
</I>&gt;<i>
</I>&quot;

Each time we go against spec we retreat from the situation of current
best interoperability.

It took more than 7 years, but these things *were* measured, *were*
tested, bugs filed and software slowly fixed (including Squid
wrong-tolerance hacks removed), then re-measured and tested.
 In the end the RFC is a concise outline of what will actually work with
todays (well, 2012-ish) software, and what won't.

A lot of the issues you have been pointing out here and elsewhere is a
result of people experimenting with their newly approved abilities.
Sometimes getting it wrong, sometimes hitting remaining Squid flaws. But
that is cause for reporting failures to the experimenters so they can
fix inline with the spec (and/or us if we are the violator like this C-L
case), not for bending over backwards to silently allow a whole new
generation of brokenness to creep in.


&gt;<i> 
</I>&gt;&gt;&gt;<i> For the record, here is a Bing server response that prompted this change:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> HTTP/1.1 206 Partial Content
</I>&gt;&gt;&gt;&gt;<i> Cache-Control: public, max-age=15552000
</I>&gt;&gt;&gt;&gt;<i> Content-Length: 14543
</I>&gt;&gt;&gt;&gt;<i> Content-Type: application/x-javascript; charset=utf-8
</I>&gt;&gt;&gt;&gt;<i> Last-Modified: Tue, 14 Jul 2015 01:35:04 GMT
</I>&gt;&gt;&gt;&gt;<i> Vary: Accept-Encoding
</I>&gt;&gt;&gt;&gt;<i> Server: Microsoft-IIS/8.5
</I>&gt;&gt;&gt;&gt;<i> Date: Wed, 05 Aug 2015 15:42:26 GMT
</I>&gt;&gt;&gt;&gt;<i> Content-Length: 300
</I>&gt;&gt;&gt;&gt;<i> Content-Range: bytes 14243-14542/14543
</I>&gt;&gt;&gt;&gt;<i> Accept-Ranges: bytes
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As you can see, the addition of an extra Content-Length field was
</I>&gt;&gt;&gt;<i> probably triggered by the partial response to the Range request.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Is that an IIS? Bing? or ICAP server bug?
</I>&gt;<i> 
</I>&gt;<i> AFAIK, the quoted header did not come from the ICAP server under Squid
</I>&gt;<i> control. I believe it came from some Bing server, but I do not know the
</I>&gt;<i> details. The reasons I mentioned that header here is to document that
</I>&gt;<i> the problem is happening right now, possibly on a relatively popular
</I>&gt;<i> site, and may involve a relatively complex combination of headers.
</I>&gt;<i> 
</I>
And thank you for that. I am passing it on to Mike B. to see if he can
get it fixed at their end too.


Which reminds me, if you can get similar details about the AWS software
breakage with '|' URI characters and please make sure that gets reported
somewhere appropriate. But I digress.

Amos
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002987.html">[squid-dev] [PATCH] Reject responses with conflicting	Content-Length
</A></li>
	<LI>Next message: <A HREF="002994.html">[squid-dev] [PATCH] Reject responses with conflicting Content-Length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2991">[ date ]</a>
              <a href="thread.html#2991">[ thread ]</a>
              <a href="subject.html#2991">[ subject ]</a>
              <a href="author.html#2991">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
