<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] PayloadFormatter (was PackableStream)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PayloadFormatter%20%28was%20PackableStream%29&In-Reply-To=%3C55CB3BF5.1060603%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002985.html">
   <LINK REL="Next"  HREF="003004.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] PayloadFormatter (was PackableStream)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PayloadFormatter%20%28was%20PackableStream%29&In-Reply-To=%3C55CB3BF5.1060603%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] PayloadFormatter (was PackableStream)">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 12 12:28:37 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002985.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
        <LI>Next message: <A HREF="003004.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2995">[ date ]</a>
              <a href="thread.html#2995">[ thread ]</a>
              <a href="subject.html#2995">[ subject ]</a>
              <a href="author.html#2995">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/08/2015 5:07 a.m., Alex Rousskov wrote:
&gt;<i> On 08/10/2015 08:20 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> Here is mk2 of the Formatter class for doing display things to CacheMgr
</I>&gt;&gt;<i> report payloads.
</I>&gt;<i> 
</I>&gt;<i> Please post the patch (your post had no attachments), preferably
</I>&gt;<i> reflecting the discussion that happened since then.
</I>&gt;<i> 
</I>
Oops. Sorry.

Amos

-------------- next part --------------
=== modified file 'src/ipc/Coordinator.cc'
--- src/ipc/Coordinator.cc	2015-01-13 07:25:36 +0000
+++ src/ipc/Coordinator.cc	2015-08-10 04:53:39 +0000
@@ -1,39 +1,40 @@
 /*
  * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
  * Please see the COPYING and CONTRIBUTORS files for details.
  */
 
 /* DEBUG: section 54    Interprocess Communication */
 
 #include &quot;squid.h&quot;
 #include &quot;base/Subscription.h&quot;
 #include &quot;base/TextException.h&quot;
 #include &quot;CacheManager.h&quot;
 #include &quot;comm.h&quot;
 #include &quot;comm/Connection.h&quot;
 #include &quot;ipc/Coordinator.h&quot;
 #include &quot;ipc/SharedListen.h&quot;
 #include &quot;mgr/Inquirer.h&quot;
+#include &quot;mgr/PayloadFormatter.h&quot;
 #include &quot;mgr/Request.h&quot;
 #include &quot;mgr/Response.h&quot;
 #include &quot;tools.h&quot;
 #if SQUID_SNMP
 #include &quot;snmp/Inquirer.h&quot;
 #include &quot;snmp/Request.h&quot;
 #include &quot;snmp/Response.h&quot;
 #endif
 
 #include &lt;cerrno&gt;
 
 CBDATA_NAMESPACED_CLASS_INIT(Ipc, Coordinator);
 Ipc::Coordinator* Ipc::Coordinator::TheInstance = NULL;
 
 Ipc::Coordinator::Coordinator():
     Port(Ipc::Port::CoordinatorAddr())
 {
 }
 
 void Ipc::Coordinator::start()

=== modified file 'src/mgr/Action.cc'
--- src/mgr/Action.cc	2015-01-13 07:25:36 +0000
+++ src/mgr/Action.cc	2015-08-10 03:56:00 +0000
@@ -1,54 +1,62 @@
 /*
  * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
  * Please see the COPYING and CONTRIBUTORS files for details.
  */
 
 /* DEBUG: section 16    Cache Manager API */
 
 #include &quot;squid.h&quot;
 #include &quot;comm/Connection.h&quot;
 #include &quot;HttpReply.h&quot;
 #include &quot;ipc/Port.h&quot;
 #include &quot;mgr/Action.h&quot;
 #include &quot;mgr/ActionCreator.h&quot;
 #include &quot;mgr/ActionParams.h&quot;
 #include &quot;mgr/ActionProfile.h&quot;
 #include &quot;mgr/Command.h&quot;
+#include &quot;mgr/PayloadOldCgi.h&quot;
 #include &quot;mgr/Request.h&quot;
 #include &quot;mgr/Response.h&quot;
 #include &quot;SquidTime.h&quot;
 #include &quot;Store.h&quot;
 
 Mgr::Action::Action(const Command::Pointer &amp;aCmd): cmd(aCmd)
 {
     Must(cmd != NULL);
     Must(cmd-&gt;profile != NULL);
 }
 
 Mgr::Action::~Action()
 {
 }
 
+void
+Mgr::Action::dump(StoreEntry *e)
+{
+    Mgr::PayloadOldCgi p(*e);
+    displayWith(p);
+}
+
 const Mgr::Command &amp;
 Mgr::Action::command() const
 {
     Must(cmd != NULL);
     return *cmd;
 }
 
 bool
 Mgr::Action::atomic() const
 {
     return command().profile-&gt;isAtomic;
 }
 
 const char*
 Mgr::Action::name() const
 {
     return command().profile-&gt;name;
 }
 
 StoreEntry*

=== modified file 'src/mgr/Action.h'
--- src/mgr/Action.h	2015-01-13 07:25:36 +0000
+++ src/mgr/Action.h	2015-08-10 05:37:40 +0000
@@ -1,35 +1,36 @@
 /*
  * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
  *
  * Squid software is distributed under GPLv2+ license and includes
  * contributions from numerous individuals and organizations.
  * Please see the COPYING and CONTRIBUTORS files for details.
  */
 
 /* DEBUG: section 16    Cache Manager API */
 
 #ifndef SQUID_MGR_ACTION_H
 #define SQUID_MGR_ACTION_H
 
 #include &quot;ipc/forward.h&quot;
 #include &quot;mgr/forward.h&quot;
+#include &quot;mgr/PayloadFormatter.h&quot;
 
 class StoreEntry;
 
 namespace Mgr
 {
 
 /// Base API for organizing the processing of a compiled cache manager command.
 /// Not a job because all methods are synchronous (but they may start jobs).
 class Action: public RefCountable
 {
 public:
     typedef RefCount&lt;Action&gt; Pointer;
 
 public:
     Action(const CommandPointer &amp;aCmd);
     virtual ~Action();
 
     /* for local Cache Manager use */
 
     /// collect + fillEntry: collect local information and fill the store entry
@@ -63,34 +64,38 @@
     /// combined data should be written at the end of the coordinated response
     virtual bool aggregatable() const { return true; } // most kid classes are
 
     bool atomic() const; ///&lt; dump() call writes everything before returning
     const char *name() const; ///&lt; label as seen in the cache manager menu
     const Command &amp;command() const; ///&lt; the cause of this action
 
     StoreEntry *createStoreEntry() const; ///&lt; creates store entry from params
 
     ///&lt; Content-Type: header value for this report
     virtual const char *contentType() const {return &quot;text/plain;charset=utf-8&quot;;}
 
 protected:
     /// calculate and keep local action-specific information
     virtual void collect() {}
 
     /** start writing action-specific info to Store entry;
      * may collect info during dump, especially if collect() did nothing
      * non-atomic() actions may continue writing asynchronously after returning
      */
-    virtual void dump(StoreEntry *) {}
+    virtual void displayWith(Mgr::PayloadFormatter &amp;p) {p.notImplemented(name(), strlen(name()));}
+
+    // deprecated wrapper for displayWith().
+    // old code will override this instead of the new displayWith() method.
+    virtual void dump(StoreEntry *e);
 
 private:
     const CommandPointer cmd; ///&lt; the command that caused this action
 
 private:
     Action(const Action &amp;); // not implemented
     Action &amp;operator= (const Action &amp;); // not implemented
 };
 
 } // namespace Mgr
 
 #endif /* SQUID_MGR_ACTION_H */
 

=== modified file 'src/mgr/BasicActions.cc'
--- src/mgr/BasicActions.cc	2015-01-13 07:25:36 +0000
+++ src/mgr/BasicActions.cc	2015-08-10 05:38:50 +0000
@@ -14,41 +14,41 @@
 #include &quot;mgr/ActionCreator.h&quot;
 #include &quot;mgr/ActionProfile.h&quot;
 #include &quot;mgr/BasicActions.h&quot;
 #include &quot;mgr/Registration.h&quot;
 #include &quot;protos.h&quot;
 #include &quot;SquidConfig.h&quot;
 #include &quot;Store.h&quot;
 
 Mgr::IndexAction::Pointer
 Mgr::IndexAction::Create(const Command::Pointer &amp;cmd)
 {
     return new IndexAction(cmd);
 }
 
 Mgr::IndexAction::IndexAction(const Command::Pointer &amp;aCmd): Action(aCmd)
 {
     debugs(16, 5, HERE);
 }
 
 void
-Mgr::IndexAction::dump(StoreEntry *)
+Mgr::IndexAction::displayWith(Mgr::PayloadFormatter &amp;)
 {
     debugs(16, 5, HERE);
 }
 
 Mgr::MenuAction::Pointer
 Mgr::MenuAction::Create(const Command::Pointer &amp;cmd)
 {
     return new MenuAction(cmd);
 }
 
 Mgr::MenuAction::MenuAction(const Command::Pointer &amp;aCmd): Action(aCmd)
 {
     debugs(16, 5, HERE);
 }
 
 void
 Mgr::MenuAction::dump(StoreEntry* entry)
 {
     debugs(16, 5, HERE);
     Must(entry != NULL);
@@ -58,102 +58,104 @@
 
     for (Iterator a = menu.begin(); a != menu.end(); ++a) {
         storeAppendPrintf(entry, &quot; %-22s\t%-32s\t%s\n&quot;,
                           (*a)-&gt;name, (*a)-&gt;desc,
                           CacheManager::GetInstance()-&gt;ActionProtection(*a));
     }
 }
 
 Mgr::ShutdownAction::Pointer
 Mgr::ShutdownAction::Create(const Command::Pointer &amp;cmd)
 {
     return new ShutdownAction(cmd);
 }
 
 Mgr::ShutdownAction::ShutdownAction(const Command::Pointer &amp;aCmd): Action(aCmd)
 {
     debugs(16, 5, HERE);
 }
 
 void
-Mgr::ShutdownAction::dump(StoreEntry *)
+Mgr::ShutdownAction::displayWith(Mgr::PayloadFormatter &amp;)
 {
     debugs(16, DBG_CRITICAL, &quot;Shutdown by Cache Manager command.&quot;);
     shut_down(SIGTERM);
 }
 
 Mgr::ReconfigureAction::Pointer
 Mgr::ReconfigureAction::Create(const Command::Pointer &amp;cmd)
 {
     return new ReconfigureAction(cmd);
 }
 
 Mgr::ReconfigureAction::ReconfigureAction(const Command::Pointer &amp;aCmd):
     Action(aCmd)
 {
     debugs(16, 5, HERE);
 }
 
 void
-Mgr::ReconfigureAction::dump(StoreEntry* entry)
+Mgr::ReconfigureAction::displayWith(Mgr::PayloadFormatter &amp;p)
 {
     debugs(16, DBG_IMPORTANT, &quot;Reconfigure by Cache Manager command.&quot;);
-    storeAppendPrintf(entry, &quot;Reconfiguring Squid Process ....&quot;);
+    static const SBuf s(&quot;Reconfiguring Squid Process ....&quot;);
+    p.notice(s);
     reconfigure(SIGHUP);
 }
 
 Mgr::RotateAction::Pointer
 Mgr::RotateAction::Create(const Command::Pointer &amp;cmd)
 {
     return new RotateAction(cmd);
 }
 
 Mgr::RotateAction::RotateAction(const Command::Pointer &amp;aCmd): Action(aCmd)
 {
     debugs(16, 5, HERE);
 }
 
 void
-Mgr::RotateAction::dump(StoreEntry* entry)
+Mgr::RotateAction::displayWith(Mgr::PayloadFormatter &amp;p)
 {
     debugs(16, DBG_IMPORTANT, &quot;Rotate Logs by Cache Manager command.&quot;);
-    storeAppendPrintf(entry, &quot;Rotating Squid Process Logs ....&quot;);
+    static const SBuf s(&quot;Rotating Squid Process Logs ....&quot;);
+    p.notice(s);
 #if defined(_SQUID_LINUX_THREADS_)
     rotate_logs(SIGQUIT);
 #else
     rotate_logs(SIGUSR1);
 #endif
 }
 
 Mgr::OfflineToggleAction::Pointer
 Mgr::OfflineToggleAction::Create(const Command::Pointer &amp;cmd)
 {
     return new OfflineToggleAction(cmd);
 }
 
 Mgr::OfflineToggleAction::OfflineToggleAction(const Command::Pointer &amp;aCmd):
     Action(aCmd)
 {
     debugs(16, 5, HERE);
 }
 
 void
-Mgr::OfflineToggleAction::dump(StoreEntry* entry)
+Mgr::OfflineToggleAction::displayWith(Mgr::PayloadFormatter &amp;p)
 {
     Config.onoff.offline = !Config.onoff.offline;
-    debugs(16, DBG_IMPORTANT, &quot;offline_mode now &quot; &lt;&lt; (Config.onoff.offline ? &quot;ON&quot; : &quot;OFF&quot;) &lt;&lt; &quot; by Cache Manager request.&quot;);
-
-    storeAppendPrintf(entry, &quot;offline_mode is now %s\n&quot;,
-                      Config.onoff.offline ? &quot;ON&quot; : &quot;OFF&quot;);
+    static const SBuf offline(&quot;offline_mode is now OFF&quot;);
+    static const SBuf online(&quot;offline_mode is now ON&quot;);
+    debugs(16, DBG_IMPORTANT, (Config.onoff.offline ? online : offline ) &lt;&lt; &quot; by Cache Manager request.&quot;);
+    p.notice(Config.onoff.offline ? online : offline);
 }
 
 void
 Mgr::RegisterBasics()
 {
     RegisterAction(&quot;index&quot;, &quot;Cache Manager Interface&quot;, &amp;Mgr::IndexAction::Create, 0, 1);
     RegisterAction(&quot;menu&quot;, &quot;Cache Manager Menu&quot;, &amp;Mgr::MenuAction::Create, 0, 1);
     RegisterAction(&quot;offline_toggle&quot;, &quot;Toggle offline_mode setting&quot;, &amp;Mgr::OfflineToggleAction::Create, 1, 1);
     RegisterAction(&quot;shutdown&quot;, &quot;Shut Down the Squid Process&quot;, &amp;Mgr::ShutdownAction::Create, 1, 1);
     RegisterAction(&quot;reconfigure&quot;, &quot;Reconfigure Squid&quot;, &amp;Mgr::ReconfigureAction::Create, 1, 1);
     RegisterAction(&quot;rotate&quot;, &quot;Rotate Squid Logs&quot;, &amp;Mgr::RotateAction::Create, 1, 1);
 }
 

=== modified file 'src/mgr/BasicActions.h'
--- src/mgr/BasicActions.h	2015-01-13 07:25:36 +0000
+++ src/mgr/BasicActions.h	2015-08-10 03:34:14 +0000
@@ -10,93 +10,93 @@
 
 #ifndef SQUID_MGR_BASIC_ACTIONS_H
 #define SQUID_MGR_BASIC_ACTIONS_H
 
 #include &quot;mgr/Action.h&quot;
 
 /* a collection of simple, mostly stateless actions */
 
 namespace Mgr
 {
 
 /// A dummy action placeholder for the no-action requests
 /// a templated Cache Manager index ('home') page.
 /// Display output is produced directly by the receiving worker
 /// without invoking the co-ordinator or action Job.
 class IndexAction: public Action
 {
 public:
     static Pointer Create(const CommandPointer &amp;cmd);
     /* Action API */
-    virtual void dump(StoreEntry *entry);
+    virtual void displayWith(Mgr::PayloadFormatter &amp;) override final;
 
 protected:
     IndexAction(const CommandPointer &amp;cmd);
 };
 
 /// returns available Cache Manager actions and their access requirements
 class MenuAction: public Action
 {
 public:
     static Pointer Create(const CommandPointer &amp;cmd);
     /* Action API */
     virtual void dump(StoreEntry *entry);
 
 protected:
     MenuAction(const CommandPointer &amp;cmd);
 };
 
 /// shuts Squid down
 class ShutdownAction: public Action
 {
 public:
     static Pointer Create(const CommandPointer &amp;cmd);
     /* Action API */
-    virtual void dump(StoreEntry *entry);
+    virtual void displayWith(Mgr::PayloadFormatter &amp;) override final;
 
 protected:
     ShutdownAction(const CommandPointer &amp;cmd);
 };
 
 /// reconfigures Squid
 class ReconfigureAction: public Action
 {
 public:
     static Pointer Create(const CommandPointer &amp;cmd);
     /* Action API */
-    virtual void dump(StoreEntry *entry);
+    virtual void displayWith(Mgr::PayloadFormatter &amp;) override final;
 
 protected:
     ReconfigureAction(const CommandPointer &amp;cmd);
 };
 
 /// starts log rotation
 class RotateAction: public Action
 {
 public:
     static Pointer Create(const CommandPointer &amp;cmd);
     /* Action API */
-    virtual void dump(StoreEntry *entry);
+    virtual void displayWith(Mgr::PayloadFormatter &amp;) override final;
 
 protected:
     RotateAction(const CommandPointer &amp;cmd);
 };
 
 /// changes offline mode
 class OfflineToggleAction: public Action
 {
 public:
     static Pointer Create(const CommandPointer &amp;cmd);
     /* Action API */
-    virtual void dump(StoreEntry *entry);
+    virtual void displayWith(Mgr::PayloadFormatter &amp;) override final;
 
 protected:
     OfflineToggleAction(const CommandPointer &amp;cmd);
 };
 
 /// Registeres profiles for the actions above; \todo move elsewhere?
 void RegisterBasics();
 
 } // namespace Mgr
 
 #endif /* SQUID_MGR_BASIC_ACTIONS_H */
 

=== modified file 'src/mgr/Makefile.am'
--- src/mgr/Makefile.am	2015-01-13 07:25:36 +0000
+++ src/mgr/Makefile.am	2015-08-10 09:24:03 +0000
@@ -25,39 +25,42 @@
 	BasicActions.h \
 	Command.cc \
 	Command.h \
 	CountersAction.cc \
 	CountersAction.h \
 	Filler.cc \
 	Filler.h \
 	Forwarder.cc \
 	Forwarder.h \
 	forward.h \
 	FunAction.cc \
 	FunAction.h \
 	InfoAction.cc \
 	InfoAction.h \
 	Inquirer.cc \
 	Inquirer.h \
 	IntervalAction.cc \
 	IntervalAction.h \
 	IoAction.cc \
 	IoAction.h \
+	PayloadFormatter.h \
+	PayloadOldCgi.cc \
+	PayloadOldCgi.h \
 	Registration.cc \
 	Registration.h \
 	Request.cc \
 	Request.h \
 	Response.cc \
 	Response.h \
 	ServiceTimesAction.cc \
 	ServiceTimesAction.h \
 	StoreIoAction.cc \
 	StoreIoAction.h \
 	StoreToCommWriter.cc \
 	StoreToCommWriter.h \
 	QueryParam.h \
 	QueryParams.cc \
 	QueryParams.h \
 	IntParam.cc \
 	IntParam.h \
 	StringParam.cc \
 	StringParam.h

=== added file 'src/mgr/PayloadFormatter.h'
--- src/mgr/PayloadFormatter.h	1970-01-01 00:00:00 +0000
+++ src/mgr/PayloadFormatter.h	2015-08-10 05:59:45 +0000
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+ */
+
+/* DEBUG: section 16    Cache Manager API */
+
+#ifndef SQUID_SRC_MGR_PAYLOADFORMATTER_H
+#define SQUID_SRC_MGR_PAYLOADFORMATTER_H
+
+#include &quot;base/Packable.h&quot;
+#include &quot;mgr/forward.h&quot;
+
+class SBuf;
+
+namespace Mgr
+{
+
+/// Base API for organizing the processing of a compiled cache manager command.
+/// Not a job because all methods are synchronous (but they may start jobs).
+class PayloadFormatter
+{
+public:
+    explicit PayloadFormatter(Packable &amp;p) : outBuf(p) {}
+    virtual ~PayloadFormatter() = default;
+
+    void notImplemented(const char *name, size_t len) {
+        outBuf.append(name, len);
+        outBuf.append(&quot; is Not Implemented&quot;,19);
+    }
+
+    // a comment
+    virtual void notice(const SBuf &amp;) = 0;
+
+protected:
+    Packable &outBuf;
+};
+
+} // namepace Mgr
+
+#endif /* SQUID_SRC_MGR_PAYLOADFORMATTER_H */

=== added file 'src/mgr/PayloadOldCgi.cc'
--- src/mgr/PayloadOldCgi.cc	1970-01-01 00:00:00 +0000
+++ src/mgr/PayloadOldCgi.cc	2015-08-12 02:39:55 +0000
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+ */
+
+/* DEBUG: section 16    Cache Manager API */
+
+#include &quot;squid.h&quot;
+#include &quot;base/Packable.h&quot;
+#include &quot;mgr/PayloadOldCgi.h&quot;
+#include &quot;SBuf.h&quot;
+
+void
+Mgr::PayloadOldCgi::notice(const SBuf &amp;s)
+{
+    outBuf.append(s.rawContent(), s.length());
+    outBuf.append(&quot;\n&quot;,2);
+}
+

=== added file 'src/mgr/PayloadOldCgi.h'
--- src/mgr/PayloadOldCgi.h	1970-01-01 00:00:00 +0000
+++ src/mgr/PayloadOldCgi.h	2015-08-12 11:07:37 +0000
@@ -0,0 +1,44 @@
+/*
+ * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
+ *
+ * Squid software is distributed under GPLv2+ license and includes
+ * contributions from numerous individuals and organizations.
+ * Please see the COPYING and CONTRIBUTORS files for details.
+ */
+
+/* DEBUG: section 16    Cache Manager API */
+
+#ifndef SQUID_SRC_MGR_PAYLOADOLDCGI_H
+#define SQUID_SRC_MGR_PAYLOADOLDCGI_H
+
+#include &quot;mgr/PayloadFormatter.h&quot;
+
+namespace Mgr
+{
+
+/**
+ * Produces cache manager report payloads in a human-readable markup syntax
+ * which is parsed by the cachemgr.cgi tool.
+ *
+ * Syntax ABNF:
+ *  payload     = *( table / kv-list / notice / LF )
+ *  table       = [ label ':' [ table-row ] ] 1*( table-row )
+ *  table-row   = 1*( [ string ] '\t' ) string LF
+ *  kv-list     = label ( '=' / ':' ' ' ) string LF
+ *  label       = 1*( VCHAR / SP ) ; any printable excluding ':' and '='
+ *  notice      = string LF
+ *  string      = 1*OCTET    ; any characters excluding LF (\n) and TAB (\t)
+ */
+class PayloadOldCgi: public PayloadFormatter
+{
+public:
+    PayloadOldCgi(Packable &amp;p): PayloadFormatter(p) {}
+    virtual ~PayloadOldCgi() = default;
+
+    /* PayloadFormatter API */
+    virtual void notice(const SBuf &amp;) override final;
+};
+
+} // namepace Mgr
+
+#endif /* SQUID_SRC_MGR_PAYLOADOLDCGI_H */

=== modified file 'src/mgr/forward.h'
--- src/mgr/forward.h	2015-08-01 02:13:13 +0000
+++ src/mgr/forward.h	2015-08-10 05:06:30 +0000
@@ -6,40 +6,42 @@
  * Please see the COPYING and CONTRIBUTORS files for details.
  */
 
 /* DEBUG: section 16    Cache Manager API */
 
 #ifndef SQUID_MGR_FORWARD_H
 #define SQUID_MGR_FORWARD_H
 
 #include &quot;base/RefCount.h&quot;
 
 /// Cache Manager API
 namespace Mgr
 {
 
 class Action;
 class ActionCreator;
 class ActionPasswordList;
 class ActionProfile;
 class ActionWriter;
 class Command;
+class PayloadFormatter;
+class PayloadOldCgi;
 class Request;
 class Response;
 class QueryParam;
 class QueryParams;
 
 typedef RefCount&lt;Action&gt; ActionPointer;
 typedef RefCount&lt;ActionProfile&gt; ActionProfilePointer;
 typedef RefCount&lt;ActionCreator&gt; ActionCreatorPointer;
 typedef RefCount&lt;Command&gt; CommandPointer;
 
 typedef ActionPointer (ClassActionCreationHandler)(const CommandPointer &amp;cmd);
 
 } // namespace Mgr
 
 class StoreEntry;
 /**
  * Handler for &quot;dumping&quot; out a cachemgr report to a StoreEntry
  */
 typedef void OBJH(StoreEntry *);
 

=== modified file 'src/tests/stub_libmgr.cc'
--- src/tests/stub_libmgr.cc	2015-01-13 07:25:36 +0000
+++ src/tests/stub_libmgr.cc	2015-08-10 13:21:50 +0000
@@ -15,76 +15,77 @@
 // NP: used by Command.h instantiations
 #include &quot;mgr/ActionProfile.h&quot;
 
 // NP: used by Action.h instantiations
 #include &quot;mgr/Command.h&quot;
 std::ostream &amp;operator &lt;&lt;(std::ostream &amp;os, const Mgr::Command &amp;cmd) STUB_RETVAL(os)
 
 #include &quot;mgr/Action.h&quot;
 Mgr::Action::Action(const CommandPointer &amp;aCmd) STUB
 Mgr::Action::~Action() STUB
 void Mgr::Action::run(StoreEntry *entry, bool writeHttpHeader) STUB
 void Mgr::Action::fillEntry(StoreEntry *entry, bool writeHttpHeader) STUB
 void Mgr::Action::add(const Action &amp;action) STUB
 void Mgr::Action::respond(const Request &amp;request) STUB
 void Mgr::Action::sendResponse(unsigned int requestId) STUB
 bool Mgr::Action::atomic() const STUB_RETVAL(false)
 const char * Mgr::Action::name() const STUB_RETVAL(NULL)
 static Mgr::Command static_Command;
 const Mgr::Command &amp; Mgr::Action::command() const STUB_RETVAL(static_Command)
 StoreEntry * Mgr::Action::createStoreEntry() const STUB_RETVAL(NULL)
+void Mgr::Action::dump(StoreEntry *) STUB
 static Mgr::Action::Pointer dummyAction;
 
 #include &quot;mgr/ActionParams.h&quot;
 Mgr::ActionParams::ActionParams() STUB_NOP
 Mgr::ActionParams::ActionParams(const Ipc::TypedMsgHdr &amp;msg) STUB_NOP
 void Mgr::ActionParams::pack(Ipc::TypedMsgHdr &amp;msg) const STUB
 std::ostream &amp;operator &lt;&lt;(std::ostream &amp;os, const Mgr::ActionParams &amp;params) STUB_RETVAL(os)
 
 #include &quot;mgr/ActionWriter.h&quot;
 //Mgr::ActionWriter::ActionWriter(const Action::Pointer &amp;anAction, int aFd) STUB
 //protected:
 void Mgr::ActionWriter::start() STUB
 
 #include &quot;mgr/BasicActions.h&quot;
 Mgr::Action::Pointer Mgr::MenuAction::Create(const Mgr::CommandPointer &amp;cmd) STUB_RETVAL(dummyAction)
 void Mgr::MenuAction::dump(StoreEntry *entry) STUB
 //protected:
 //Mgr::MenuAction::MenuAction(const CommandPointer &amp;cmd) STUB
 
 Mgr::Action::Pointer Mgr::ShutdownAction::Create(const Mgr::CommandPointer &amp;cmd) STUB_RETVAL(dummyAction)
-void Mgr::ShutdownAction::dump(StoreEntry *entry) STUB
+void Mgr::ShutdownAction::displayWith(Mgr::PayloadFormatter &amp;) STUB
 // protected:
 //Mgr::ShutdownAction::ShutdownAction(const CommandPointer &amp;cmd) STUB
 
 Mgr::Action::Pointer Mgr::ReconfigureAction::Create(const Mgr::CommandPointer &amp;cmd) STUB_RETVAL(dummyAction)
-void Mgr::ReconfigureAction::dump(StoreEntry *entry) STUB
+void Mgr::ReconfigureAction::displayWith(Mgr::PayloadFormatter &amp;) STUB
 //protected:
 //Mgr::ReconfigureAction::ReconfigureAction(const CommandPointer &amp;cmd) STUB
 
 Mgr::Action::Pointer Mgr::RotateAction::Create(const Mgr::CommandPointer &amp;cmd) STUB_RETVAL(dummyAction)
-void Mgr::RotateAction::dump(StoreEntry *entry) STUB
+void Mgr::RotateAction::displayWith(Mgr::PayloadFormatter &amp;) STUB
 //protected:
 //Mgr::RotateAction::RotateAction(const CommandPointer &amp;cmd) STUB
 
 Mgr::Action::Pointer Mgr::OfflineToggleAction::Create(const CommandPointer &amp;cmd) STUB_RETVAL(dummyAction)
-void Mgr::OfflineToggleAction::dump(StoreEntry *entry) STUB
+void Mgr::OfflineToggleAction::displayWith(Mgr::PayloadFormatter &amp;) STUB
 //protected:
 //Mgr::OfflineToggleAction::OfflineToggleAction(const CommandPointer &amp;cmd) STUB
 
 void Mgr::RegisterBasics() STUB
 
 #include &quot;mgr/CountersAction.h&quot;
 //Mgr::CountersActionData::CountersActionData() STUB
 Mgr::CountersActionData&amp; Mgr::CountersActionData::operator +=(const Mgr::CountersActionData&amp; stats) STUB_RETVAL(*this)
 
 Mgr::Action::Pointer Mgr::CountersAction::Create(const CommandPointer &amp;cmd) STUB_RETVAL(dummyAction)
 void Mgr::CountersAction::add(const Action&amp; action) STUB
 void Mgr::CountersAction::pack(Ipc::TypedMsgHdr&amp; msg) const STUB
 void Mgr::CountersAction::unpack(const Ipc::TypedMsgHdr&amp; msg) STUB
 //protected:
 //Mgr::CountersAction::CountersAction(const CommandPointer &amp;cmd) STUB
 void Mgr::CountersAction::collect() STUB
 void Mgr::CountersAction::dump(StoreEntry* entry) STUB
 
 #include &quot;mgr/Filler.h&quot;
 //Mgr::Filler::Filler(const Action::Pointer &amp;anAction, int aFd, unsigned int aRequestId) STUB

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002985.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
	<LI>Next message: <A HREF="003004.html">[squid-dev] [PATCH] PayloadFormatter (was PackableStream)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2995">[ date ]</a>
              <a href="thread.html#2995">[ thread ]</a>
              <a href="subject.html#2995">[ subject ]</a>
              <a href="author.html#2995">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
