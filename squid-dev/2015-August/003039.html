<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] FtpServer.cc:1024: &quot;reply != NULL&quot; assertion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20FtpServer.cc%3A1024%3A%20%22reply%20%21%3D%20NULL%22%20assertion&In-Reply-To=%3C55D35898.8090504%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003036.html">
   <LINK REL="Next"  HREF="003046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] FtpServer.cc:1024: &quot;reply != NULL&quot; assertion</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20FtpServer.cc%3A1024%3A%20%22reply%20%21%3D%20NULL%22%20assertion&In-Reply-To=%3C55D35898.8090504%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] FtpServer.cc:1024: &quot;reply != NULL&quot; assertion">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Tue Aug 18 16:08:56 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003036.html">[squid-dev] Fedora-20 EOL
</A></li>
        <LI>Next message: <A HREF="003046.html">[squid-dev] [PATCH] FtpServer.cc:1024: &quot;reply != NULL&quot; assertion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3039">[ date ]</a>
              <a href="thread.html#3039">[ thread ]</a>
              <a href="subject.html#3039">[ subject ]</a>
              <a href="author.html#3039">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Handle nil HttpReply pointer inside various handlers called from 
Ftp::Server::handleReply(). For example, when the related StoreEntry 
object is aborted, the client_side_reply.cc code may call the 
Ftp::Server::handleReply() method with a nil reply pointer.

The Ftp::Server::handleReply() methods itself cannot handle nil replies 
because they are valid in many states. Only state-specific handlers know 
whether they need the reply.

The Ftp::Server::handleReply() method is called [via Store] from Client 
code. Thus, exceptions in handleReply() are handled by the Ftp::Client 
job. That job does not have enough information to know whether the 
client-to-Squid connection should be closed; the job keeps the 
connection open. When the reply is nil, that open connection becomes 
unusable, leading to more problems.

This patch fixes the Ftp::Server::handleReply() to handle exceptions, 
including closing the connections in the case of an exception. It also 
adds Must(reply) checks to check for nil HttpReply pointers where the 
reply is required. Eventually, Store should start using async calls to 
protect jobs waiting for Store updates. Meanwhile, this should help.

This is a Measurement Factory project.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: Squid-Assertion-FtpServer_cc_1024-reply_neq_NULL-trunk-t5.patch
Type: text/x-patch
Size: 10426 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150818/fd3af28b/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150818/fd3af28b/attachment-0001.bin</A>&gt;
</PRE>

















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003036.html">[squid-dev] Fedora-20 EOL
</A></li>
	<LI>Next message: <A HREF="003046.html">[squid-dev] [PATCH] FtpServer.cc:1024: &quot;reply != NULL&quot; assertion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3039">[ date ]</a>
              <a href="thread.html#3039">[ thread ]</a>
              <a href="subject.html#3039">[ subject ]</a>
              <a href="author.html#3039">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
