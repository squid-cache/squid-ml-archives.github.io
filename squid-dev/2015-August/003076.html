<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55D577B9.90100%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003020.html">
   <LINK REL="Next"  HREF="003091.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55D577B9.90100%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Aug 20 06:46:17 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003020.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four,	HttpHeader refactor
</A></li>
        <LI>Next message: <A HREF="003091.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3076">[ date ]</a>
              <a href="thread.html#3076">[ thread ]</a>
              <a href="subject.html#3076">[ subject ]</a>
              <a href="author.html#3076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/08/2015 7:09 p.m., Kinkie wrote:
&gt;<i> Hi all,
</I>&gt;<i>   the attached patch does:
</I>&gt;<i> - EnumIterator, which now uses autoconf to detect std::underlying_type
</I>&gt;<i> - Removes header masks in HttpHeader.cc and HttpReply in favor of..
</I>&gt;<i> - gperf-generated header table with flags describing headers all collected
</I>&gt;<i> in one place
</I>&gt;<i> - replaces HttpHeader::getEntry with explicit vector iteration
</I>&gt;<i> - Implements and uses Http::HeaderTable.lookup(string-or-Http::HdrType) to
</I>&gt;<i> look up headers in the gperf-generated hash
</I>&gt;<i> - small optimizationi in HttpHeader::getLastEntry thanks to reverse
</I>&gt;<i> iterators
</I>&gt;<i> - use erase-remove pattern in HttpHeader::compact in place of resize()
</I>&gt;<i> - use std:: algorithms instead of explicit loop in HttpHeader::delById
</I>&gt;<i> - gets rid of httpHeaderCalcMask - masks are still used elsewhere but
</I>&gt;<i> generating them is now easier thanks to WholeEnum&lt;type&gt;
</I>&gt;<i> - some readability improvements
</I>&gt;<i> - refactor HeaderManglers::track to avoid overloading of meaning the
</I>&gt;<i> enumEnd_ enumerator - please help me checking carefully I haven't altered
</I>&gt;<i> functionality here
</I>&gt;<i> - implements a case-insensitve hash function for SBuf
</I>&gt;<i> - all known headers are now unconditionally parsed. May not be acted upon
</I>&gt;<i> if some functions are not compiled in
</I>&gt;<i> - LookupTable now uses an unordered_map instead of map for backing storage.
</I>&gt;<i> No user-visible change for SBuf and std::string users unless they wish to
</I>&gt;<i> have a custom hasher
</I>&gt;<i> 
</I>&gt;<i> Most code has been run-tested (most notable exception: HeaderManglers),
</I>&gt;<i> farm-build-, coadvisor- and polygraph- tested. The main focus of this
</I>&gt;<i> refactoring is correctness and readability, c++11-ification and recovering
</I>&gt;<i> from the performance regression that was introduced ~10 days ago.
</I>&gt;<i> 
</I>

Here goes. Audit:


* IMO the HeaderManglers really do need at least basic testing with
these changes. A regression there affects widely used features.

basic tests are easy enough. A simple proxy altering the Server header
to a fixed value, adding some custom new header, and stripping something
common like Expires should be sufficient to trigger any code problems
and eyeball any major issues from the squidclient output to verify working.


in acinclude/* and configure.ac:

* tests and macro defines for C++11/0x back-compat are in
acinclude/ax_cxx_0x_types.m4


in src/HttpHeader.cc:

* please use {} on the for in HttpHeader::append().
 - aids readability of multiple nesting layers
 - same occurs elsewhere, I cant see the method name.

* &quot;assert(! Http::HeaderLookupTable.lookup&quot; looks - odd.
 - the extra whitespace does not really add anything and detracts from
searching for &quot;!Http::HeaderLookupTable.lookup&quot;

* inconsistent changes ofr NULL-&gt;nullptr
 - eg in HttpHeader::findLastEntry() NULL is not changed, but elsewhere
it usually is.


in src/HttpHeaderTools.cc:

* HeaderManglers::dumpReplacement() has some odd line wrapping in the
parameter lists of header_mangler_dump_replacement()


in src/Makefile.am:

* for testEnumIterator please add $(SQUID_CPPUNIT_LA) to the *_LDADD
list instead of a *_DEPENDENCIES entry

* also please place tests/stub_* and base/EnumIterator.h in the nodist_*
list from now on.
 - the test _SOURCE list should now only contain the tests/test*.{h,cc}
actually containing the unit-test code.
 - this helps prevent unit tests being the only reason files are dist
(found a few like that already), so we can ensure they are linked to
Squid main binary or libraries properly for automake dependency detection.


in src/SBufAlgos.cc:

* whats cctype needed for?


in src/SBufAlgos.h:

 * please doxygen comment new class CaseInsensitiveSBufHash


in src/adaptation/icap/ModXact.cc:

* why is #if USE_ADAPTATION wrappers being added?
 - this entire file and even libicap.la should never be linked if
adaptation is disabled.


in src/base/EnumIterator.h:

* please place the #if wrappers underneath the copyright blurb.
 - ensures the squid copyright is part of any code using that squid
header, and
 - makes the maintenance tools detect it as ours not a third-party
copyright.
 - same for tests/testEnumIterator.h

* please doxygen comment new class EnumIteratorBase, ReverseEnumIterator,
 - eg, do these cover all values?
   where does it stop iterating?
   what value is produced for out-of-bounds ?
   uni or bi-directional ?

* for EnumRangeT and WholeEnum
 - utilize 'empty' lines between paragraphs
 - \note for highlighting additional notes
 - highlight example code with \code ... \endcode).

* s/Enum/EnumType/
 - to avoid any confusion with keyword 'enum'


in src/base/Makefile.am:

* alphabetical order.


in src/http.cc:

* please mark use of name.c_str() with &quot;XXX: performance regression,
c_str() reallocates&quot;
 - the xmalloc removal is countered by the data-copy into &quot;SBuf name&quot;.
Making this a new second data-copy.


in src/http/RegisteredHeaders.h:

* please lock ACCEPT in as first entry;
&quot;
  enumBegin_ = 0,
  ACCEPT = enumBegin_,
  ...
&quot;

* please delimit the methods and members of HeaderTableRecord with an
empty line (and maybe another &quot;public:&quot;)

* a formatter run is going to be needed. Things like enum HdrKind
contain tab-indented lines and double-empty lines.

* HeaderLookupTable_t
 - need empty lines between paragraphs in doxygen comments again.
 - ie before the paragraph starting &quot;Actual records are ...&quot;

* &quot;///look record ...&quot; --&gt; &quot;/// look ...&quot;


in src/http/RegisteredHeadersHash.cci:

* is there any way to add a comment blurb &quot;/* AUTO-GENERATED DO NOT EDIT
*/&quot; to the top of this file ?

* also need to add the copyright boilerplate


in  src/http/RegisteredHeadersHash.gperf:

* need a way to add the copyright boilerplate as a gperf-ignored comment


in  src/tests/testEnumIterator.cc:

* include path &quot;testEnumIterator.h&quot; -&gt; tests/testEnumIterator.h

* test enums should also use the &quot; first = enumBegin_, &quot; trick

* testBidirectionalIter() also needs to test for reaching out-of-bounds
conditions in either direction.
 - can it go fully across begin() -&gt; end() -&gt; begin() successfully in
only the expected count of iterations? (no more, no less)


Cheers
Amos

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003020.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four,	HttpHeader refactor
</A></li>
	<LI>Next message: <A HREF="003091.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3076">[ date ]</a>
              <a href="thread.html#3076">[ thread ]</a>
              <a href="subject.html#3076">[ subject ]</a>
              <a href="author.html#3076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
