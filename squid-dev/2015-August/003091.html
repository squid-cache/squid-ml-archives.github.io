<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3CCA%2BY8hcPR-DGWFhjzgRBzXHFHA4ady5kZZ1VjHTkUbEM1jDQX1w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003076.html">
   <LINK REL="Next"  HREF="003093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3CCA%2BY8hcPR-DGWFhjzgRBzXHFHA4ady5kZZ1VjHTkUbEM1jDQX1w%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor">gkinkie at gmail.com
       </A><BR>
    <I>Fri Aug 21 10:37:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003076.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
        <LI>Next message: <A HREF="003093.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3091">[ date ]</a>
              <a href="thread.html#3091">[ thread ]</a>
              <a href="subject.html#3091">[ subject ]</a>
              <a href="author.html#3091">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Aug 20, 2015 at 8:46 AM, Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 16/08/2015 7:09 p.m., Kinkie wrote:
</I>&gt;<i> &gt; Hi all,
</I>&gt;<i> &gt;   the attached patch does:
</I>&gt;<i> &gt; - EnumIterator, which now uses autoconf to detect std::underlying_type
</I>&gt;<i> &gt; - Removes header masks in HttpHeader.cc and HttpReply in favor of..
</I>&gt;<i> &gt; - gperf-generated header table with flags describing headers all
</I>&gt;<i> collected
</I>&gt;<i> &gt; in one place
</I>&gt;<i> &gt; - replaces HttpHeader::getEntry with explicit vector iteration
</I>&gt;<i> &gt; - Implements and uses Http::HeaderTable.lookup(string-or-Http::HdrType)
</I>&gt;<i> to
</I>&gt;<i> &gt; look up headers in the gperf-generated hash
</I>&gt;<i> &gt; - small optimizationi in HttpHeader::getLastEntry thanks to reverse
</I>&gt;<i> &gt; iterators
</I>&gt;<i> &gt; - use erase-remove pattern in HttpHeader::compact in place of resize()
</I>&gt;<i> &gt; - use std:: algorithms instead of explicit loop in HttpHeader::delById
</I>&gt;<i> &gt; - gets rid of httpHeaderCalcMask - masks are still used elsewhere but
</I>&gt;<i> &gt; generating them is now easier thanks to WholeEnum&lt;type&gt;
</I>&gt;<i> &gt; - some readability improvements
</I>&gt;<i> &gt; - refactor HeaderManglers::track to avoid overloading of meaning the
</I>&gt;<i> &gt; enumEnd_ enumerator - please help me checking carefully I haven't altered
</I>&gt;<i> &gt; functionality here
</I>&gt;<i> &gt; - implements a case-insensitve hash function for SBuf
</I>&gt;<i> &gt; - all known headers are now unconditionally parsed. May not be acted upon
</I>&gt;<i> &gt; if some functions are not compiled in
</I>&gt;<i> &gt; - LookupTable now uses an unordered_map instead of map for backing
</I>&gt;<i> storage.
</I>&gt;<i> &gt; No user-visible change for SBuf and std::string users unless they wish to
</I>&gt;<i> &gt; have a custom hasher
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Most code has been run-tested (most notable exception: HeaderManglers),
</I>&gt;<i> &gt; farm-build-, coadvisor- and polygraph- tested. The main focus of this
</I>&gt;<i> &gt; refactoring is correctness and readability, c++11-ification and
</I>&gt;<i> recovering
</I>&gt;<i> &gt; from the performance regression that was introduced ~10 days ago.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here goes. Audit:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * IMO the HeaderManglers really do need at least basic testing with
</I>&gt;<i> these changes. A regression there affects widely used features.
</I>&gt;<i>
</I>&gt;<i> basic tests are easy enough. A simple proxy altering the Server header
</I>&gt;<i> to a fixed value, adding some custom new header, and stripping something
</I>&gt;<i> common like Expires should be sufficient to trigger any code problems
</I>&gt;<i> and eyeball any major issues from the squidclient output to verify working.
</I>&gt;<i>
</I>&gt;<i>
</I>After some careful checking:
*_header_access and *_header_add work fine.
*_header_replace is broken, but it's been for a long time (I run-tested
with code from february).


&gt;<i> in acinclude/* and configure.ac:
</I>&gt;<i>
</I>&gt;<i> * tests and macro defines for C++11/0x back-compat are in
</I>&gt;<i> acinclude/ax_cxx_0x_types.m4
</I>&gt;<i>
</I>
The file name seems inappropriate, but sure.
Done.


&gt;<i> in src/HttpHeader.cc:
</I>&gt;<i>
</I>&gt;<i> * please use {} on the for in HttpHeader::append().
</I>&gt;<i>  - aids readability of multiple nesting layers
</I>&gt;<i>  - same occurs elsewhere, I cant see the method name.
</I>&gt;<i>
</I>
findEntry, findLastEntry, refreshMask, getList. Done.


&gt;<i> * &quot;assert(! Http::HeaderLookupTable.lookup&quot; looks - odd.
</I>&gt;<i>  - the extra whitespace does not really add anything and detracts from
</I>&gt;<i> searching for &quot;!Http::HeaderLookupTable.lookup&quot;
</I>&gt;<i>
</I>
Changed.


&gt;<i> * inconsistent changes ofr NULL-&gt;nullptr
</I>&gt;<i>  - eg in HttpHeader::findLastEntry() NULL is not changed, but elsewhere
</I>&gt;<i> it usually is.
</I>&gt;<i>
</I>
That's actually intentional: I changed that only when something in the
vicinity changed so not to make the patch any more enormous. I can blanket
change if that's preferred.


&gt;<i> in src/HttpHeaderTools.cc:
</I>&gt;<i>
</I>&gt;<i> * HeaderManglers::dumpReplacement() has some odd line wrapping in the
</I>&gt;<i> parameter lists of header_mangler_dump_replacement()
</I>&gt;<i>
</I>
Removed all line wrapping.


&gt;<i> in src/Makefile.am:
</I>&gt;<i>
</I>&gt;<i> * for testEnumIterator please add $(SQUID_CPPUNIT_LA) to the *_LDADD
</I>&gt;<i> list instead of a *_DEPENDENCIES entry
</I>&gt;<i>
</I>
hm.. it's applied inconsistently. Documentation (at line 957) says to have
it in both places.
testUfs, testRock : do not have it as a dependency
testHttpReply, testBoilerplate, testCacheManager, testDiskIO, testEvent,
testEventLoop, test_http_range, testHttp1Parser, testHttpRequest,
testStore, testString, testUrl, testSBuf, testSBufList, testConfigParser,
testStatHist (and so on..) have it as a dependency
testACLMaxUserIP : used to have it as a dependency (but now it's commented
out)

For now I'm following documentation and leaving it in both places; if you
have an opinion about how it should be I'll gladly carpet-apply that to the
whole file.


&gt;<i> * also please place tests/stub_* and base/EnumIterator.h in the nodist_*
</I>&gt;<i> list from now on.
</I>&gt;<i>
</I>
Ok. Changed documentation at about line 951 to reflect that.


&gt;<i>  - the test _SOURCE list should now only contain the tests/test*.{h,cc}
</I>&gt;<i> actually containing the unit-test code.
</I>&gt;<i>
</I>Does this also apply to the files actually being tested? (X.h, X.cc)
I am fine either way, I would just like it to be reflected in the
documentation. Not changed there for now, just in the testEnumIterator part.


&gt;<i>  - this helps prevent unit tests being the only reason files are dist
</I>&gt;<i> (found a few like that already), so we can ensure they are linked to
</I>&gt;<i> Squid main binary or libraries properly for automake dependency detection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/SBufAlgos.cc:
</I>&gt;<i>
</I>&gt;<i> * whats cctype needed for?
</I>&gt;<i>
</I>
tolower(3).


&gt;<i>
</I>&gt;<i> in src/SBufAlgos.h:
</I>&gt;<i>
</I>&gt;<i>  * please doxygen comment new class CaseInsensitiveSBufHash
</I>&gt;<i>
</I>
Done.


&gt;<i> in src/adaptation/icap/ModXact.cc:
</I>&gt;<i>
</I>&gt;<i> * why is #if USE_ADAPTATION wrappers being added?
</I>&gt;<i>  - this entire file and even libicap.la should never be linked if
</I>&gt;<i> adaptation is disabled.
</I>&gt;<i>
</I>
By mistake. Thanks for catching this.


&gt;<i> in src/base/EnumIterator.h:
</I>&gt;<i>
</I>&gt;<i> * please place the #if wrappers underneath the copyright blurb.
</I>&gt;<i>  - ensures the squid copyright is part of any code using that squid
</I>&gt;<i> header, and
</I>&gt;<i>  - makes the maintenance tools detect it as ours not a third-party
</I>&gt;<i> copyright.
</I>&gt;<i>  - same for tests/testEnumIterator.h
</I>&gt;<i>
</I>
Ok.


&gt;<i>
</I>&gt;<i> * please doxygen comment new class EnumIteratorBase, ReverseEnumIterator,
</I>&gt;<i>  - eg, do these cover all values?
</I>&gt;<i>    where does it stop iterating?
</I>&gt;<i>    what value is produced for out-of-bounds ?
</I>&gt;<i>    uni or bi-directional ?
</I>&gt;<i>
</I>
Done.

&gt;<i>
</I>&gt;<i> * for EnumRangeT and WholeEnum
</I>&gt;<i>  - utilize 'empty' lines between paragraphs
</I>&gt;<i>  - \note for highlighting additional notes
</I>&gt;<i>  - highlight example code with \code ... \endcode).
</I>&gt;<i>
</I>
Done

&gt;<i>
</I>&gt;<i> * s/Enum/EnumType/
</I>&gt;<i>  - to avoid any confusion with keyword 'enum'
</I>&gt;<i>
</I>
Done.


&gt;<i> in src/base/Makefile.am:
</I>&gt;<i>
</I>&gt;<i> * alphabetical order.
</I>&gt;<i>
</I>
Done.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/http.cc:
</I>&gt;<i>
</I>&gt;<i> * please mark use of name.c_str() with &quot;XXX: performance regression,
</I>&gt;<i> c_str() reallocates&quot;
</I>&gt;<i>
</I>
Actually, no in this case it doesn't unless ilen is exactly equal to one of
the MemBlob MemPool sizes (possible but unlikely, I estimate in the 0.1%
range).
There are some performance deltas but they are IMO quite marginal:
slowdowns: SBuf housekeeping, temp creation (of ilen+1 bytes) done in two
steps instead of one
speedups: SBuf uses mempools, &quot;*&quot; case is checked before lowering case


&gt;<i>  - the xmalloc removal is countered by the data-copy into &quot;SBuf name&quot;.
</I>&gt;<i> Making this a new second data-copy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/http/RegisteredHeaders.h:
</I>&gt;<i>
</I>&gt;<i> * please lock ACCEPT in as first entry;
</I>&gt;<i> &quot;
</I>&gt;<i>   enumBegin_ = 0,
</I>&gt;<i>   ACCEPT = enumBegin_,
</I>&gt;<i>   ...
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>
It already was, by assigning both enumBegin and ACCEPT value 0. Changed for
clarity's sake.


&gt;<i> * please delimit the methods and members of HeaderTableRecord with an
</I>&gt;<i> empty line (and maybe another &quot;public:&quot;)
</I>&gt;<i>
</I>
Done.


&gt;<i> * a formatter run is going to be needed. Things like enum HdrKind
</I>&gt;<i> contain tab-indented lines and double-empty lines.
</I>&gt;<i>
</I>
Yes.


&gt;<i>
</I>&gt;<i> * HeaderLookupTable_t
</I>&gt;<i>  - need empty lines between paragraphs in doxygen comments again.
</I>&gt;<i>  - ie before the paragraph starting &quot;Actual records are ...&quot;
</I>&gt;<i>
</I>&gt;<i> * &quot;///look record ...&quot; --&gt; &quot;/// look ...&quot;
</I>&gt;<i>
</I>&gt;<i> Ok
</I>

&gt;<i>
</I>&gt;<i> in src/http/RegisteredHeadersHash.cci:
</I>&gt;<i>
</I>&gt;<i> * is there any way to add a comment blurb &quot;/* AUTO-GENERATED DO NOT EDIT
</I>&gt;<i> */&quot; to the top of this file ?
</I>&gt;<i>
</I>
It can and I did, but it's not possible at the very top unfortunately.


&gt;<i>
</I>&gt;<i> * also need to add the copyright boilerplate
</I>&gt;<i>
</I>
Same thing.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in  src/http/RegisteredHeadersHash.gperf:
</I>&gt;<i>
</I>&gt;<i> * need a way to add the copyright boilerplate as a gperf-ignored comment
</I>&gt;<i>
</I>
Done that. There is a preamble section into which I copied the C++ comments
above.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in  src/tests/testEnumIterator.cc:
</I>&gt;<i>
</I>&gt;<i> * include path &quot;testEnumIterator.h&quot; -&gt; tests/testEnumIterator.h
</I>&gt;<i>
</I>
Done.


&gt;<i> * test enums should also use the &quot; first = enumBegin_, &quot; trick
</I>&gt;<i>
</I>
Done.


&gt;<i> * testBidirectionalIter() also needs to test for reaching out-of-bounds
</I>&gt;<i> conditions in either direction.
</I>&gt;<i>  - can it go fully across begin() -&gt; end() -&gt; begin() successfully in
</I>&gt;<i> only the expected count of iterations? (no more, no less)
</I>&gt;<i>
</I>
Ok, added and tested.

Updated patch attached.


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150821/f9d285fb/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150821/f9d285fb/attachment-0001.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: coverity-fixes-4-v2.patch
Type: application/octet-stream
Size: 175001 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150821/f9d285fb/attachment-0001.obj">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150821/f9d285fb/attachment-0001.obj</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003076.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
	<LI>Next message: <A HREF="003093.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3091">[ date ]</a>
              <a href="thread.html#3091">[ thread ]</a>
              <a href="subject.html#3091">[ subject ]</a>
              <a href="author.html#3091">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
