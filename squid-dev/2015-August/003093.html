<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55D71AF9.7010304%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003091.html">
   <LINK REL="Next"  HREF="003096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55D71AF9.7010304%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 21 12:35:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003091.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
        <LI>Next message: <A HREF="003096.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3093">[ date ]</a>
              <a href="thread.html#3093">[ thread ]</a>
              <a href="subject.html#3093">[ subject ]</a>
              <a href="author.html#3093">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/08/2015 10:37 p.m., Kinkie wrote:
&gt;<i> On Thu, Aug 20, 2015 at 8:46 AM, Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 16/08/2015 7:09 p.m., Kinkie wrote:
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i>   the attached patch does:
</I>&gt;&gt;&gt;<i> - EnumIterator, which now uses autoconf to detect std::underlying_type
</I>&gt;&gt;&gt;<i> - Removes header masks in HttpHeader.cc and HttpReply in favor of..
</I>&gt;&gt;&gt;<i> - gperf-generated header table with flags describing headers all
</I>&gt;&gt;<i> collected
</I>&gt;&gt;&gt;<i> in one place
</I>&gt;&gt;&gt;<i> - replaces HttpHeader::getEntry with explicit vector iteration
</I>&gt;&gt;&gt;<i> - Implements and uses Http::HeaderTable.lookup(string-or-Http::HdrType)
</I>&gt;&gt;<i> to
</I>&gt;&gt;&gt;<i> look up headers in the gperf-generated hash
</I>&gt;&gt;&gt;<i> - small optimizationi in HttpHeader::getLastEntry thanks to reverse
</I>&gt;&gt;&gt;<i> iterators
</I>&gt;&gt;&gt;<i> - use erase-remove pattern in HttpHeader::compact in place of resize()
</I>&gt;&gt;&gt;<i> - use std:: algorithms instead of explicit loop in HttpHeader::delById
</I>&gt;&gt;&gt;<i> - gets rid of httpHeaderCalcMask - masks are still used elsewhere but
</I>&gt;&gt;&gt;<i> generating them is now easier thanks to WholeEnum&lt;type&gt;
</I>&gt;&gt;&gt;<i> - some readability improvements
</I>&gt;&gt;&gt;<i> - refactor HeaderManglers::track to avoid overloading of meaning the
</I>&gt;&gt;&gt;<i> enumEnd_ enumerator - please help me checking carefully I haven't altered
</I>&gt;&gt;&gt;<i> functionality here
</I>&gt;&gt;&gt;<i> - implements a case-insensitve hash function for SBuf
</I>&gt;&gt;&gt;<i> - all known headers are now unconditionally parsed. May not be acted upon
</I>&gt;&gt;&gt;<i> if some functions are not compiled in
</I>&gt;&gt;&gt;<i> - LookupTable now uses an unordered_map instead of map for backing
</I>&gt;&gt;<i> storage.
</I>&gt;&gt;&gt;<i> No user-visible change for SBuf and std::string users unless they wish to
</I>&gt;&gt;&gt;<i> have a custom hasher
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Most code has been run-tested (most notable exception: HeaderManglers),
</I>&gt;&gt;&gt;<i> farm-build-, coadvisor- and polygraph- tested. The main focus of this
</I>&gt;&gt;&gt;<i> refactoring is correctness and readability, c++11-ification and
</I>&gt;&gt;<i> recovering
</I>&gt;&gt;&gt;<i> from the performance regression that was introduced ~10 days ago.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here goes. Audit:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * IMO the HeaderManglers really do need at least basic testing with
</I>&gt;&gt;<i> these changes. A regression there affects widely used features.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> basic tests are easy enough. A simple proxy altering the Server header
</I>&gt;&gt;<i> to a fixed value, adding some custom new header, and stripping something
</I>&gt;&gt;<i> common like Expires should be sufficient to trigger any code problems
</I>&gt;&gt;<i> and eyeball any major issues from the squidclient output to verify working.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> After some careful checking:
</I>&gt;<i> *_header_access and *_header_add work fine.
</I>&gt;<i> *_header_replace is broken, but it's been for a long time (I run-tested
</I>&gt;<i> with code from february).
</I>&gt;<i> 
</I>

&lt;snipping the done requests&gt;


&gt;&gt;<i> in src/Makefile.am:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * for testEnumIterator please add $(SQUID_CPPUNIT_LA) to the *_LDADD
</I>&gt;&gt;<i> list instead of a *_DEPENDENCIES entry
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> hm.. it's applied inconsistently. Documentation (at line 957) says to have
</I>&gt;<i> it in both places.
</I>&gt;<i> testUfs, testRock : do not have it as a dependency
</I>&gt;<i> testHttpReply, testBoilerplate, testCacheManager, testDiskIO, testEvent,
</I>&gt;<i> testEventLoop, test_http_range, testHttp1Parser, testHttpRequest,
</I>&gt;<i> testStore, testString, testUrl, testSBuf, testSBufList, testConfigParser,
</I>&gt;<i> testStatHist (and so on..) have it as a dependency
</I>&gt;<i> testACLMaxUserIP : used to have it as a dependency (but now it's commented
</I>&gt;<i> out)
</I>&gt;<i> 
</I>&gt;<i> For now I'm following documentation and leaving it in both places; if you
</I>&gt;<i> have an opinion about how it should be I'll gladly carpet-apply that to the
</I>&gt;<i> whole file.
</I>

Documentation is outdated. I'm trying to work on _DEPENDENCIES removal
now for automake 1.15 support as another incremental fix-up polishing as
we add/change tests. Each test that has one does not check all its
_LDADD indirect dependencies properly, so can inconsistently link tests.

As far as SQUID_CPPUNIT_LA is concerned the issue seems to have been a
bug that was resolved in older automake and/or cppunit versions. It
works fine with just one _LDADD entry on the tests I've converted so far.


It looks like I'm going to have to do a sorting sweep on *_LDADD anyway.
So up to you.


&gt;<i> 
</I>&gt;&gt;<i> * also please place tests/stub_* and base/EnumIterator.h in the nodist_*
</I>&gt;&gt;<i> list from now on.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Ok. Changed documentation at about line 951 to reflect that.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>  - the test _SOURCE list should now only contain the tests/test*.{h,cc}
</I>&gt;&gt;<i> actually containing the unit-test code.
</I>&gt;&gt;<i>
</I>&gt;<i> Does this also apply to the files actually being tested? (X.h, X.cc)
</I>&gt;<i> I am fine either way, I would just like it to be reflected in the
</I>&gt;<i> documentation. Not changed there for now, just in the testEnumIterator part.
</I>&gt;<i> 
</I>
Yes. Especially them. The purpose is to ensure they are correctly listed
in a _SOURCES for one of the libraries or binaries in normal builds.

Sorry, I got a bit distracted on the _DEPENDENCIES removal work. Docs
update still coming.


&gt;<i> 
</I>&gt;&gt;<i>  - this helps prevent unit tests being the only reason files are dist
</I>&gt;&gt;<i> (found a few like that already), so we can ensure they are linked to
</I>&gt;&gt;<i> Squid main binary or libraries properly for automake dependency detection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> in src/SBufAlgos.cc:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * whats cctype needed for?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> tolower(3).
</I>&gt;<i> 
</I>
Ah. Thought so. Please use the xtolower() provided by libcompat.


&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> in src/http.cc:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * please mark use of name.c_str() with &quot;XXX: performance regression,
</I>&gt;&gt;<i> c_str() reallocates&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Actually, no in this case it doesn't unless ilen is exactly equal to one of
</I>&gt;<i> the MemBlob MemPool sizes (possible but unlikely, I estimate in the 0.1%
</I>&gt;<i> range).
</I>&gt;<i> There are some performance deltas but they are IMO quite marginal:
</I>&gt;<i> slowdowns: SBuf housekeeping, temp creation (of ilen+1 bytes) done in two
</I>&gt;<i> steps instead of one
</I>&gt;<i> speedups: SBuf uses mempools, &quot;*&quot; case is checked before lowering case
</I>&gt;<i> 
</I>
Okay. If you are sure. I have thought that a few times then found SBuf
reallocating based on seemingly just the lock counter.


&gt;&gt;<i>
</I>&gt;&gt;<i> in src/http/RegisteredHeadersHash.cci:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * is there any way to add a comment blurb &quot;/* AUTO-GENERATED DO NOT EDIT
</I>&gt;&gt;<i> */&quot; to the top of this file ?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> It can and I did, but it's not possible at the very top unfortunately.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * also need to add the copyright boilerplate
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Same thing.
</I>&gt;<i> 
</I>
Fine. At least they there now to silence the &quot;CHECK COPYRIGHT&quot;
maintenance warnings. I will see what else is needed by the scripts once
this is all merged.


+1. with the below documentation polish :-)

New bits:

in src/HttpHeader.cc
* HttpHeader::append now s/addEntry (/addEntry(/


in src/HttpReply.cc:
* one more for-loop needing brackets


in src/SBufAlgos.h:
* please use doxygen \code ... \endcode for code exammples.
 - definitely NOT using shell-eval quotes


in src/acl/HttpHeaderData.h:
* please re-aligning the comments after code shrinkage :-)


in src/base/EnumIterator.h:

* one empty line after the boilerplate please.
 - surprised the formatting run did not catch that, it does on master.
 - same in testEnumIterator.h

* s/or c++11 strongly-typed/or C++11 strongly-typed/
 - &quot;C++11&quot; is a noun/acronym.

* please do not quote around begin()/end()/rbegin()/rend() names
 - doxygen should highlight and link naturally
 - specialy not with shell-eval quotes.
 - might be best to look for more of those in this patch if you can. I
cant because my command-line tries to execute something just looking for
a string involving them.


* s/doesn't/does not/ and s/you'll/you will/
 - documentation is formal language.

* all this &quot;prefix increment&quot; / &quot;postfix increment&quot; operator documentation
 - if its worth writing them at all use doxygen &quot;///&quot;.

* EnumRangeT
 - s/mote/note/ ?
 - and shell-eval quotes again

* WholeEnum
 - doxygen syntax is:  /** [brief] \n ... \n */
 - if you start a multi-line description on the first line after &quot;/**&quot;
things get weird by only using part of the text in some output douments.
 - so keep 1-liners for brief description, and omit anything on the same
line as &quot;/**&quot; if you need just need a good long description.
 - this is why I generally avoid the 1-liner brief prefixes.


in src/esi/Libxml2Parser.h
* revert to trunk version.


in src/http/RegisteredHeaders.h:
* HeaderTableRecord if its worth using '//' on the bools its worth using
'///&lt; '

* HeaderLookupTable_t
 - s/header types' definitions/header definitions/
 - on BadHdr; use doxygen '///&lt; '

in src/tests/testEnumIterator.cc
* in testBidirectionalIter and testUnsignedEnum
 - how about using &amp;&amp;count&lt;=20 to terminate the loops if things go very
wrong?
 - I'd hope for something similar in the testRangeFor*() loops, but not
sure if/how its possible to enforce an exit with range-for being
hyper-threaded sometimes.


Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003091.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
	<LI>Next message: <A HREF="003096.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3093">[ date ]</a>
              <a href="thread.html#3093">[ thread ]</a>
              <a href="subject.html#3093">[ subject ]</a>
              <a href="author.html#3093">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
