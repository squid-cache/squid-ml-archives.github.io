<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3CCA%2BY8hcOD-Owj%2BfiW1Jk3SuRNr%3DeCVb%3Dn%3DV9rETaCk8rNKWfPRg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003093.html">
   <LINK REL="Next"  HREF="003100.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3CCA%2BY8hcOD-Owj%2BfiW1Jk3SuRNr%3DeCVb%3Dn%3DV9rETaCk8rNKWfPRg%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor">gkinkie at gmail.com
       </A><BR>
    <I>Fri Aug 21 13:26:51 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003093.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
        <LI>Next message: <A HREF="003100.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3096">[ date ]</a>
              <a href="thread.html#3096">[ thread ]</a>
              <a href="subject.html#3096">[ subject ]</a>
              <a href="author.html#3096">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>&gt;<i> &gt;&gt; in src/Makefile.am:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; * for testEnumIterator please add $(SQUID_CPPUNIT_LA) to the *_LDADD
</I>&gt;<i> &gt;&gt; list instead of a *_DEPENDENCIES entry
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; hm.. it's applied inconsistently. Documentation (at line 957) says to
</I>&gt;<i> have
</I>&gt;<i> &gt; it in both places.
</I>&gt;<i> &gt; testUfs, testRock : do not have it as a dependency
</I>&gt;<i> &gt; testHttpReply, testBoilerplate, testCacheManager, testDiskIO, testEvent,
</I>&gt;<i> &gt; testEventLoop, test_http_range, testHttp1Parser, testHttpRequest,
</I>&gt;<i> &gt; testStore, testString, testUrl, testSBuf, testSBufList, testConfigParser,
</I>&gt;<i> &gt; testStatHist (and so on..) have it as a dependency
</I>&gt;<i> &gt; testACLMaxUserIP : used to have it as a dependency (but now it's
</I>&gt;<i> commented
</I>&gt;<i> &gt; out)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For now I'm following documentation and leaving it in both places; if you
</I>&gt;<i> &gt; have an opinion about how it should be I'll gladly carpet-apply that to
</I>&gt;<i> the
</I>&gt;<i> &gt; whole file.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Documentation is outdated. I'm trying to work on _DEPENDENCIES removal
</I>&gt;<i> now for automake 1.15 support as another incremental fix-up polishing as
</I>&gt;<i> we add/change tests. Each test that has one does not check all its
</I>&gt;<i> _LDADD indirect dependencies properly, so can inconsistently link tests.
</I>&gt;<i>
</I>&gt;<i> As far as SQUID_CPPUNIT_LA is concerned the issue seems to have been a
</I>&gt;<i> bug that was resolved in older automake and/or cppunit versions. It
</I>&gt;<i> works fine with just one _LDADD entry on the tests I've converted so far.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It looks like I'm going to have to do a sorting sweep on *_LDADD anyway.
</I>&gt;<i> So up to you.
</I>&gt;<i>
</I>
I guess it's best left as a cohesive effort, so I'll leave as-is for now.
This patch is huge enough.



&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; * also please place tests/stub_* and base/EnumIterator.h in the nodist_*
</I>&gt;<i> &gt;&gt; list from now on.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Ok. Changed documentation at about line 951 to reflect that.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;  - the test _SOURCE list should now only contain the tests/test*.{h,cc}
</I>&gt;<i> &gt;&gt; actually containing the unit-test code.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; Does this also apply to the files actually being tested? (X.h, X.cc)
</I>&gt;<i> &gt; I am fine either way, I would just like it to be reflected in the
</I>&gt;<i> &gt; documentation. Not changed there for now, just in the testEnumIterator
</I>&gt;<i> part.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Yes. Especially them. The purpose is to ensure they are correctly listed
</I>&gt;<i> in a _SOURCES for one of the libraries or binaries in normal builds.
</I>&gt;<i>
</I>&gt;<i> Sorry, I got a bit distracted on the _DEPENDENCIES removal work. Docs
</I>&gt;<i> update still coming.
</I>&gt;<i>
</I>
Same answer as above then. I guess we'll have to have a &quot;improve
Makefile.am&quot; effort.


&gt;<i> &gt;&gt;  - this helps prevent unit tests being the only reason files are dist
</I>&gt;<i> &gt;&gt; (found a few like that already), so we can ensure they are linked to
</I>&gt;<i> &gt;&gt; Squid main binary or libraries properly for automake dependency
</I>&gt;<i> detection.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; in src/SBufAlgos.cc:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; * whats cctype needed for?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; tolower(3).
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Ah. Thought so. Please use the xtolower() provided by libcompat.
</I>&gt;<i>
</I>
Ok.


&gt;<i> &gt;&gt; in src/http.cc:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; * please mark use of name.c_str() with &quot;XXX: performance regression,
</I>&gt;<i> &gt;&gt; c_str() reallocates&quot;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Actually, no in this case it doesn't unless ilen is exactly equal to one
</I>&gt;<i> of
</I>&gt;<i> &gt; the MemBlob MemPool sizes (possible but unlikely, I estimate in the 0.1%
</I>&gt;<i> &gt; range).
</I>&gt;<i> &gt; There are some performance deltas but they are IMO quite marginal:
</I>&gt;<i> &gt; slowdowns: SBuf housekeeping, temp creation (of ilen+1 bytes) done in two
</I>&gt;<i> &gt; steps instead of one
</I>&gt;<i> &gt; speedups: SBuf uses mempools, &quot;*&quot; case is checked before lowering case
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Okay. If you are sure. I have thought that a few times then found SBuf
</I>&gt;<i> reallocating based on seemingly just the lock counter.
</I>&gt;<i>
</I>
if sbuf has single owner, c_str just makes sure that after the end of the
valid area there is a \0. That may require re-allocing if end of valid area
is at end of owned memory space.



&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; in src/http/RegisteredHeadersHash.cci:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; * is there any way to add a comment blurb &quot;/* AUTO-GENERATED DO NOT EDIT
</I>&gt;<i> &gt;&gt; */&quot; to the top of this file ?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It can and I did, but it's not possible at the very top unfortunately.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; * also need to add the copyright boilerplate
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Same thing.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Fine. At least they there now to silence the &quot;CHECK COPYRIGHT&quot;
</I>&gt;<i> maintenance warnings. I will see what else is needed by the scripts once
</I>&gt;<i> this is all merged.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> +1. with the below documentation polish :-)
</I>&gt;<i>
</I>&gt;<i> New bits:
</I>&gt;<i>
</I>&gt;<i> in src/HttpHeader.cc
</I>&gt;<i> * HttpHeader::append now s/addEntry (/addEntry(/
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/HttpReply.cc:
</I>&gt;<i> * one more for-loop needing brackets
</I>&gt;<i>
</I>
two, actually. Both done.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/SBufAlgos.h:
</I>&gt;<i> * please use doxygen \code ... \endcode for code exammples.
</I>&gt;<i>  - definitely NOT using shell-eval quotes
</I>&gt;<i>
</I>
Ok


&gt;<i> in src/acl/HttpHeaderData.h:
</I>&gt;<i> * please re-aligning the comments after code shrinkage :-)
</I>&gt;<i>
</I>
Done


&gt;<i> in src/base/EnumIterator.h:
</I>&gt;<i>
</I>&gt;<i> * one empty line after the boilerplate please.
</I>&gt;<i>  - surprised the formatting run did not catch that, it does on master.
</I>&gt;<i>  - same in testEnumIterator.h
</I>&gt;<i>
</I>
Ok


&gt;<i>
</I>&gt;<i> * s/or c++11 strongly-typed/or C++11 strongly-typed/
</I>&gt;<i>  - &quot;C++11&quot; is a noun/acronym.
</I>&gt;<i>
</I>
Ok


&gt;<i> * please do not quote around begin()/end()/rbegin()/rend() names
</I>&gt;<i>  - doxygen should highlight and link naturally
</I>&gt;<i>  - specialy not with shell-eval quotes.
</I>&gt;<i>  - might be best to look for more of those in this patch if you can. I
</I>&gt;<i> cant because my command-line tries to execute something just looking for
</I>&gt;<i> a string involving them.
</I>&gt;<i>
</I>
Removed all in EnumIterator.h, I don't think there's any more.


&gt;<i> * s/doesn't/does not/ and s/you'll/you will/
</I>&gt;<i>  - documentation is formal language.
</I>&gt;<i>
</I>
Ok


&gt;<i> * all this &quot;prefix increment&quot; / &quot;postfix increment&quot; operator documentation
</I>&gt;<i>  - if its worth writing them at all use doxygen &quot;///&quot;.
</I>&gt;<i>
</I>
Removing.


&gt;<i> * EnumRangeT
</I>&gt;<i>  - s/mote/note/ ?
</I>&gt;<i>  - and shell-eval quotes again
</I>&gt;<i>
</I>
Yes; fixed.


&gt;<i> * WholeEnum
</I>&gt;<i>  - doxygen syntax is:  /** [brief] \n ... \n */
</I>&gt;<i>  - if you start a multi-line description on the first line after &quot;/**&quot;
</I>&gt;<i> things get weird by only using part of the text in some output douments.
</I>&gt;<i>  - so keep 1-liners for brief description, and omit anything on the same
</I>&gt;<i> line as &quot;/**&quot; if you need just need a good long description.
</I>&gt;<i>  - this is why I generally avoid the 1-liner brief prefixes.
</I>&gt;<i>
</I>
Shortened. I've also taken the chance to expand the use examples to be more
understandable.


&gt;<i> in src/esi/Libxml2Parser.h
</I>&gt;<i> * revert to trunk version.
</I>&gt;<i>
</I>
Ok.


&gt;<i> in src/http/RegisteredHeaders.h:
</I>&gt;<i> * HeaderTableRecord if its worth using '//' on the bools its worth using
</I>&gt;<i> '///&lt; '
</I>&gt;<i>
</I>
Kept documentation


&gt;<i>
</I>&gt;<i> * HeaderLookupTable_t
</I>&gt;<i>  - s/header types' definitions/header definitions/
</I>&gt;<i>  - on BadHdr; use doxygen '///&lt; '
</I>&gt;<i>
</I>
Ok, although it's kind of internal.


&gt;<i> in src/tests/testEnumIterator.cc
</I>&gt;<i> * in testBidirectionalIter and testUnsignedEnum
</I>&gt;<i>  - how about using &amp;&amp;count&lt;=20 to terminate the loops if things go very
</I>&gt;<i> wrong?
</I>&gt;<i>
</I>
Done by explicit test in the loop in order to allow using a specific comment


&gt;<i>  - I'd hope for something similar in the testRangeFor*() loops, but not
</I>&gt;<i> sure if/how its possible to enforce an exit with range-for being
</I>&gt;<i> hyper-threaded sometimes.
</I>&gt;<i>
</I>
Up to the compiler to enforce. Would probably disable parallelization, but
who cares: it must be transparent to us anyway.

Committing, testing and merging.
Thanks!

-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150821/f9cfe52a/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150821/f9cfe52a/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003093.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
	<LI>Next message: <A HREF="003100.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3096">[ date ]</a>
              <a href="thread.html#3096">[ thread ]</a>
              <a href="subject.html#3096">[ subject ]</a>
              <a href="author.html#3096">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
