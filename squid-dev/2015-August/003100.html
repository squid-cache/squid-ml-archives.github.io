<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55D75445.8050306%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003096.html">
   <LINK REL="Next"  HREF="003104.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55D75445.8050306%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 21 16:39:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003096.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
        <LI>Next message: <A HREF="003104.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3100">[ date ]</a>
              <a href="thread.html#3100">[ thread ]</a>
              <a href="subject.html#3100">[ subject ]</a>
              <a href="author.html#3100">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/21/2015 04:37 AM, Kinkie wrote:

&gt;<i>   the attached patch does:
</I>
... a long list of mostly unrelated changes ...

Sigh. Some of the patch changes are not necessary at all. Some are
useful. Some should be redone to minimize conflicts. Some are
performance optimizations that should be considered very carefully. It
would take too much time to sift through all of this and separate the
good from the bad, so we would have to accept pretty much all of them,
create a lot of conflicts, and probably miss bugs.

Sometimes, changing a lot of code is necessary. There is no way around
that. However, combining many unrelated changes, some of which change a
lot of code, and some of which are performance-sensitive or bug-prone,
is virtually never necessary.


&gt;<i> -        Tolower(name);
</I>&gt;<i> -
</I>&gt;<i> -        if (strcmp(name, &quot;*&quot;) == 0) {
</I>&gt;<i> -            /* Can not handle &quot;Vary: *&quot; withtout ETag support */
</I>&gt;<i> -            safe_free(name);
</I>&gt;<i> +        SBuf name(item, ilen);
</I>&gt;<i> +        if (name.cmp(&quot;*&quot;,1) == 0) {
</I>&gt;<i>              vstr.clean();
</I>&gt;<i>              break;
</I>&gt;<i>          }
</I>&gt;<i> -
</I>&gt;<i> -        strListAdd(&amp;vstr, name, ',');
</I>&gt;<i> +        name.toLower();
</I>
Do you know why we need to convert header names to lowercase here? The
header names are not a part of some Store hash, right? This conversion
is expensive because most header names will be changed here, breaking
SBuf reuse. If you know the reason, let's add a comment since you are
changing this code anyway.


&gt;<i>     in src/http.cc:
</I>&gt;<i> 
</I>&gt;<i>     * please mark use of name.c_str() with &quot;XXX: performance regression,
</I>&gt;<i>     c_str() reallocates&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Actually, no in this case it doesn't unless ilen is exactly equal to one
</I>&gt;<i> of the MemBlob MemPool sizes (possible but unlikely, I estimate in the
</I>&gt;<i> 0.1% range).
</I>
*If* we remove toLower(), then there will be other, very common cases
where c_str() will reallocate in this context, either right now or when
the surrounding code is optimized to be more SBuf-friendly. Without
toLower(), the &quot;name&quot; SBuf should be pointing in the middle of another
SBuf in most cases where name was already in lower case.

I would honor Amos request for an XXX. In that XXX, I would not use the
word &quot;regression&quot; because this change may not make performance worse
than it was, but it is still bad code from performance point of view and
should eventually be changed/optimized. I would write something like:

  // XXX: will reallocate if toLower() above is removed


&gt;<i> -        if (strcmp(name, &quot;*&quot;) == 0) {
</I>&gt;<i> -            /* Can not handle &quot;Vary: *&quot; withtout ETag support */
</I>&gt;<i> -            safe_free(name);
</I>&gt;<i> +        SBuf name(item, ilen);
</I>&gt;<i> +        if (name.cmp(&quot;*&quot;,1) == 0) {
</I>
AFAICT, the new code looks for names starting with &quot;*&quot;. The old code was
looking for &quot;*&quot; names.


&gt;<i> -    while ((e = getEntry(&amp;pos))) {
</I>&gt;<i> -        if (e-&gt;id == id)
</I>&gt;<i> -            delAt(pos, count);
</I>&gt;<i> -    }
</I>&gt;<i> +    int sz_before = entries.size();
</I>&gt;<i> +    entries.erase(std::remove_if(entries.begin(), entries.end(),
</I>&gt;<i> +    [=](HttpHeaderEntry *e) { return e &amp;&amp; e-&gt;id == id; }),
</I>&gt;<i> +    entries.end());
</I>
This change is a performance regression AFAICT: Unlike the old delAt(),
std::remove_if is very expensive for std::vector. Consider using
std::replace_if without .erasing instead.


&gt;<i> +enum HdrKind {
</I>
Use C++11 class enums for global enums, especially when such use does
not increase the amount of old code changes. In this specific case, it
does not AFAICT.


&gt;<i> -    for(HttpHeaderEntry *e : entries) {
</I>&gt;<i> +    for (HttpHeaderEntry *e : entries) {
</I>
&gt;<i> -
</I>&gt;<i> -    return NULL;        /* not reached */
</I>&gt;<i> +    return nullptr;        /* not reached */
</I>
&gt;<i>      /* check mask first */
</I>&gt;<i> -
</I>&gt;<i>      if (!CBIT_TEST(mask, id))
</I>&gt;<i>          return NULL;
</I>
...

Avoid out of scope changes, especially whitespace changes and NULL renaming.


&gt;<i> +    assert(0);
</I>
s/0/false/


&gt;<i> +    int sz_before = entries.size();
</I>&gt;<i> +    entries.erase(std::remove_if(entries.begin(), entries.end(),
</I>&gt;<i> +    [=](HttpHeaderEntry *e) { return e &amp;&amp; e-&gt;id == id; }),
</I>&gt;<i> +    entries.end());
</I>&gt;<i> +    int count = entries.size() - sz_before;
</I>
If you can make sz_before, *e, and/or count const, make them const.


&gt;<i> +        if (e != nullptr &amp;&amp; e-&gt;id == id)
</I>
You can save a lot of ink by writing &quot;e&quot; instead of &quot;e != nullptr&quot;.


As always, please post patches with at least 20 context lines to
increase chances of reviewers spotting bugs.


Alex.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003096.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
	<LI>Next message: <A HREF="003104.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3100">[ date ]</a>
              <a href="thread.html#3100">[ thread ]</a>
              <a href="subject.html#3100">[ subject ]</a>
              <a href="author.html#3100">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
