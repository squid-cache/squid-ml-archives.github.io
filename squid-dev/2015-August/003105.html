<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] renaming StoreEntryStream to PackableStream
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20renaming%20StoreEntryStream%20to%20PackableStream&In-Reply-To=%3C55D76363.8000900%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003092.html">
   <LINK REL="Next"  HREF="003109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] renaming StoreEntryStream to PackableStream</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20renaming%20StoreEntryStream%20to%20PackableStream&In-Reply-To=%3C55D76363.8000900%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] renaming StoreEntryStream to PackableStream">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 21 17:44:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003092.html">[squid-dev] [PATCH] renaming StoreEntryStream to PackableStream
</A></li>
        <LI>Next message: <A HREF="003109.html">[squid-dev] [PATCH] renaming StoreEntryStream to PackableStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3105">[ date ]</a>
              <a href="thread.html#3105">[ thread ]</a>
              <a href="subject.html#3105">[ subject ]</a>
              <a href="author.html#3105">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/21/2015 04:38 AM, Amos Jeffries wrote:
&gt;<i> So PackableStream is really just a rename of StoreEntryStream BUT with
</I>&gt;<i> some implicit new properties from the underlying type change:
</I>&gt;<i> 
</I>&gt;<i> * lack of Store.h dependency
</I>&gt;<i> 
</I>&gt;<i> * ability to stream into a MemBuf if its creator desires that
</I>&gt;<i> 
</I>&gt;<i> This patch demonstrates that by doing the upgrade in-place and re-typing
</I>&gt;<i> all StoreEntryStream objects.
</I>&gt;<i> 
</I>&gt;<i> It includes some extra polishing of the *StreamBuf logics to remove
</I>&gt;<i> styling and redundant code issues identified in the previous cycles of
</I>&gt;<i> discussion. But otherwise is essentially a drop-in replacement.
</I>

Thank you for making a well-scoped change. It makes finding problems a
lot easier.


&gt;<i> +    virtual int sync() override {
</I>&gt;<i>          std::streamsize pending(pptr() - pbase());
</I>&gt;<i> -
</I>&gt;<i> -        if (pending)
</I>&gt;<i> -            theEntry-&gt;append(pbase(), pending);
</I>&gt;<i> -
</I>&gt;<i> -        theEntry-&gt;flush();
</I>&gt;<i> -
</I>&gt;<i> +        lowAppend(pbase(), pending);
</I>&gt;<i>          return 0;
</I>&gt;<i>      }
</I>
Patched sync() no longer flush()es the entry. This is a significant
undocumented change and, AFAICT, a major bug. If I am right (see below
for specifics), please consider adding a pure virtual Packable::flush()
method and calling that in the above code _regardless_ of the &quot;pending&quot;
value, just like the old code used to do.


&gt;<i> +    PackableStream stream(*sentry);
</I>...
&gt;<i>      stream.flush();
</I>
How would that flush() call reach &quot;sentry&quot; if PackableStreamBuf never
flushes its buf_?


&gt;<i> +        anEntry-&gt;lock(&quot;test&quot;);
</I>&gt;<i> +        PackableStream stream(*anEntry);
</I>&gt;<i>  
</I>&gt;<i>          stream.setf(std::ios::fixed);
</I>&gt;<i>          stream &lt;&lt; 123456 &lt;&lt; std::setprecision(1) &lt;&lt; 77.7;
</I>&gt;<i>          stream &lt;&lt; &quot; some text&quot; &lt;&lt; std::setw(4) &lt;&lt; &quot;!&quot; &lt;&lt; '.';
</I>&gt;<i>          stream.flush();
</I>&gt;<i> -        // flushed at least once more
</I>&gt;<i> -        CPPUNIT_ASSERT(anEntry-&gt;_flush_calls &gt; preFlushCount);
</I>&gt;<i> +        CPPUNIT_ASSERT_EQUAL(String(&quot;12345677.7 some text   !.&quot;), anEntry-&gt;_appended_text);
</I>&gt;<i>  
</I>&gt;<i> +        delete anEntry; // does the unlock()
</I>
Checking the appended text without checking that the entry was flushed
is not sufficient because the appended text does not know what store
entry sent to Store clients. It only shows what Store servers appended
to the entry.


&gt;<i> +        anEntry-&gt;lock(&quot;test&quot;);
</I>&gt;<i> +        PackableStream stream(*anEntry);
</I>...
&gt;<i> +        delete anEntry; // does the unlock()
</I>
This leads to a dangling reference in the &quot;stream&quot; object. Please
consider narrowing the &quot;stream&quot; scope so that it is destroyed before you
delete anEntry.


&gt;<i> +    PackableStreamBuf(Packable &amp;p) : buf_(p) {}
</I>
If you can make the ctor explicit, please do.


&gt;<i> +    PackableStream(Packable &amp;p) : std::ostream(0), theBuffer(p) {
</I>
Ditto.


&gt;<i> +    ~PackableStreamBuf() = default;
</I>
I would remove that for simplicity and consistency sake.

Rule of thumb: Given a set of method kinds that can be marked as default
or can be explicitly deleted (i.e., copy constructor, destructor,
assignment operator, etc.), we should either explicitly declare all such
methods or none at all. None is the right choice when we do not _need_
to redefine any default methods or explicitly delete any methods.

The &quot;none&quot; choice applies to both PackableStreamBuf and PackableStream.


HTH,

Alex.

</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003092.html">[squid-dev] [PATCH] renaming StoreEntryStream to PackableStream
</A></li>
	<LI>Next message: <A HREF="003109.html">[squid-dev] [PATCH] renaming StoreEntryStream to PackableStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3105">[ date ]</a>
              <a href="thread.html#3105">[ thread ]</a>
              <a href="subject.html#3105">[ subject ]</a>
              <a href="author.html#3105">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
