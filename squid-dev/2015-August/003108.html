<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Non-zeroing mempools
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-zeroing%20mempools&In-Reply-To=%3C55D8439F.4010704%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003101.html">
   <LINK REL="Next"  HREF="003137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Non-zeroing mempools</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Non-zeroing%20mempools&In-Reply-To=%3C55D8439F.4010704%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Non-zeroing mempools">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Aug 22 09:40:47 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003101.html">[squid-dev] [PATCH] Non-zeroing mempools
</A></li>
        <LI>Next message: <A HREF="003137.html">[squid-dev] [PATCH] Non-zeroing mempools
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3108">[ date ]</a>
              <a href="thread.html#3108">[ thread ]</a>
              <a href="subject.html#3108">[ subject ]</a>
              <a href="author.html#3108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/08/2015 4:43 a.m., Kinkie wrote:
&gt;<i> On Thu, Aug 20, 2015 at 7:11 AM, Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 20/08/2015 7:28 a.m., Kinkie wrote:
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i>   the attached patch (a merge request from
</I>&gt;&gt;&gt;<i> lp:~kinkie/squid/mempools-nozero) changes MEMPROXY_CLASS so that it
</I>&gt;&gt;<i> doesn't
</I>&gt;&gt;&gt;<i> zero memory before releasing it to requestors. The constructors of all
</I>&gt;&gt;&gt;<i> classes using that feature were checked, so that they fully initialize
</I>&gt;&gt;<i> all
</I>&gt;&gt;&gt;<i> data members and thus require no zeroing.
</I>&gt;&gt;&gt;<i> It also changes Debug::OutStream to use MEMPROXY_CLASS instead of
</I>&gt;&gt;&gt;<i> new/derelete, and changes constructors to initializer lists whenever
</I>&gt;&gt;&gt;<i> possible and sensible (aka justified by other changes), same for dropping
</I>&gt;&gt;&gt;<i> HERE and adopting nullptr.
</I>&gt;&gt;&gt;<i> It also changes some code in Makefile.am to use make variables in place
</I>&gt;&gt;<i> of
</I>&gt;&gt;&gt;<i> full paths.
</I>&gt;&gt;&gt;<i> The code has been run-tested (default config only), build-farm-tested and
</I>&gt;&gt;&gt;<i> polygraph-tested. It shows a small but noticeable performance improvement
</I>&gt;&gt;&gt;<i> in performance (of course, numbers are to be taken with a big grain of
</I>&gt;&gt;&gt;<i> salt).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> When reviewing, please do not focus on formatting issues; if this patch
</I>&gt;&gt;&gt;<i> passes review I'll run a source-formatting before merging.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * in Makefiles please add the new bits of *_SOURCE lists in alphabetical
</I>&gt;&gt;<i> order.
</I>&gt;&gt;<i>  - you have several stub_libmem.cc going after stub_M and stub_S*
</I>&gt;&gt;<i> filenames.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I think I fixed them. It was mentioned in the coverity-fixes thread that it
</I>&gt;<i> could be a good idea to do a formatting round sorting all entries in
</I>&gt;<i> Makefiles, once the updated standards are finalized. I'd defer any leftover
</I>&gt;<i> unsorted entries till then.
</I>&gt;<i> 
</I>
You did that, and then some.

The ones you are now just shuffling around can be reverted until the
makefile cleanup project happens. I meant just for the new entries being
added to some _SOURCES lists.



&gt;<i> 
</I>&gt;&gt;<i> * Please make the initializer lists one member per line.
</I>&gt;&gt;<i>  - the auto-formatting wont do that for us yet.
</I>&gt;&gt;<i>  - it greatly helps readability and manual checking for missing or
</I>&gt;&gt;<i> out-of-order items. We can also then easily add comments to lines
</I>&gt;&gt;<i> explain odd default values.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Sure for .cc, not so sure for .h, where compactness helps readability and
</I>&gt;<i> presence and order should be easier to spot. Finally, many missing or
</I>&gt;<i> out-of-order should get caught either by Coverity or gcc.
</I>&gt;<i> Changed for all .cc, not done for .h (where lists are quite shorter)
</I>&gt;<i> 
</I>
Okay. As we kind of spoke of in IRC it is a &quot;does it look readable&quot; call
for .h.

The change to src/URL.h and src/acl/Acl.h are good examples of what I
would like to avoid.

- The orginal single-liner with {} at the end looks fine.

- A one-per-line also looks fine.

But with the slightly longer line they have now a partial wrapping in
the set mid-way somewhere makes it hard to read.


&gt;<i> * in memset() please use 0 integer value not '\0' to set flags.
</I>&gt;&gt;<i>  - it helps the compiler know it is safe to optimize up to larger than
</I>&gt;&gt;<i> 8-bit values of 0.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Ok.
</I>&gt;<i> 
</I>
I meant just for the ones you were adding. But since this is a patch
scoped at correcting initialization issues I'll accept the ones you are
now changing.


&gt;<i> 
</I>&gt;&gt;<i> * src/HttpHeader.cc - revert
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Yes.
</I>&gt;<i> 
</I>
Now you've got src/ident/AclIdent.h with gratuitous change.

I like the change itself but its well outside any relevance.


&gt;<i> 
</I>&gt;&gt;<i> * when adding a new constructor ensure the big-5 operators (ctor, dtor,
</I>&gt;&gt;<i> assign, emplace, emplace-assign) are all present. Even if they use &quot;=
</I>&gt;&gt;<i> default&quot;
</I>&gt;&gt;<i>  - looking at StoreMeta, maybe others.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> StoreMeta is pure-virtual; Also, it has no complex members so emplace
</I>&gt;<i> doesn't add value vs. copy.
</I>&gt;<i> Omitting emplace and implementing the others as protected for completeness'
</I>&gt;<i> sake.
</I>&gt;<i> 
</I>
Hmm. We are going to have to decide what to do about cases like that
where Big-3 is more appropriate than Big-5.

I'm inclined to use emplace =default/=delete anyway just for code clarity.

Might be worth adding a comment to that effect just to record that
StoreMeta has actually been considered for big-5 already.


&gt;<i> 
</I>&gt;&gt;<i> * wordlist missing 'explicit' on the raw-pointer ctor
</I>&gt;&gt;<i>  - also other big-5 operators
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> wordlist must die; it's a C relic which doesn't belong to squid anymore.
</I>&gt;<i> Kinda-implemented with a private default destructor (friended by
</I>&gt;<i> wordlistDestroy) and deleted assignment and copyconstructor. This helped
</I>&gt;<i> catch a leak in FtpGateway.cc so at least it was used for something -even
</I>&gt;<i> if it's very ugly.
</I>&gt;<i> 
</I>
I'm resisting the urge to request this be split to a different patch. :-P


&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> * please do one of these:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  + return the XXX to Debugs.h, but it can move up to explain why
</I>&gt;&gt;<i> AllocatorProxy.h is used instead of mem/forward.h
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> It doesn't need to. I'm dumb and should have used mem/forward in the first
</I>&gt;<i> place - you had even told me not too long ago.
</I>
It does. The problem was documented in the old XXX:

 &quot;pulls in typedefs.h and enums.h and globals.h&quot;

typedefs.h/enums.h/defines.h/globals.h is a nasty nest of recursive
include worms. In particular including them from something widely used
like Debugs.h makes it super nasty doing test builds trying to verify
future shuffling of their contents.
 It was weeks of effort to get defines.h out of Debugs.h in the first place.

Thats why the original XXX existed (as it said). If you just use
mem/forward.h there without the shuffling of FREE typedef and remove
typedefs.h dependency, then the problem is just delayed to a subtle more
nasty issue later.

Looking at the scope creep that would may involve linkage fixes where
things already depend on typedefs.h includes via mem/forward.h. So I
retract mem/forward.h as an option to be selected. Please do the
AllocatorProxy.h include with a new XXX.



More new bits:

in src/fs/ufs/UFSStoreState.h
* you are changing _queued_write lines but not NULL/nullptr


in src/mem/AllocatorProxy.h:
* please avoid using the term &quot;store&quot; in MEMPROXY_CLASS description.
 - it kind of collides with our use of the word for caching.
 - &quot;memory&quot; or &quot;memory block&quot; would be better here.


* AllocatorProxy has tabs in its initializer list.



(thats what I'm seeing with a read-thru, haven't tried Alex's script yet).

Amos
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003101.html">[squid-dev] [PATCH] Non-zeroing mempools
</A></li>
	<LI>Next message: <A HREF="003137.html">[squid-dev] [PATCH] Non-zeroing mempools
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3108">[ date ]</a>
              <a href="thread.html#3108">[ thread ]</a>
              <a href="subject.html#3108">[ subject ]</a>
              <a href="author.html#3108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
