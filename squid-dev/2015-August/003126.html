<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55DA08FA.4040604%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003104.html">
   <LINK REL="Next"  HREF="003130.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%28-inspired%29%20fixes%20part%20four%2C%0A%20HttpHeader%20refactor&In-Reply-To=%3C55DA08FA.4040604%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Aug 23 17:55:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003104.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
        <LI>Next message: <A HREF="003130.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3126">[ date ]</a>
              <a href="thread.html#3126">[ thread ]</a>
              <a href="subject.html#3126">[ subject ]</a>
              <a href="author.html#3126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/21/2015 11:31 AM, Kinkie wrote:
&gt;<i> On Fri, Aug 21, 2015 at 6:39 PM, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 08/21/2015 04:37 AM, Kinkie wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt;   the attached patch does:
</I>&gt;<i> 
</I>&gt;<i>     ... a long list of mostly unrelated changes ...
</I>&gt;<i> 
</I>&gt;<i>     Sigh. Some of the patch changes are not necessary at all. Some are
</I>&gt;<i>     useful. Some should be redone to minimize conflicts. Some are
</I>&gt;<i>     performance optimizations that should be considered very carefully. It
</I>&gt;<i>     would take too much time to sift through all of this and separate the
</I>&gt;<i>     good from the bad, so we would have to accept pretty much all of them,
</I>&gt;<i>     create a lot of conflicts, and probably miss bugs.
</I>

&gt;<i> To defend the code, ...
</I>
Your code was not under attack. Your choice to assemble many unrelated
and/or supposed-to-be-sequential changes into one patch was.


&gt;<i>     &gt; -        Tolower(name);
</I>&gt;<i>     &gt; -
</I>&gt;<i>     &gt; -        if (strcmp(name, &quot;*&quot;) == 0) {
</I>&gt;<i>     &gt; -            /* Can not handle &quot;Vary: *&quot; withtout ETag support */
</I>&gt;<i>     &gt; -            safe_free(name);
</I>&gt;<i>     &gt; +        SBuf name(item, ilen);
</I>&gt;<i>     &gt; +        if (name.cmp(&quot;*&quot;,1) == 0) {
</I>&gt;<i>     &gt;              vstr.clean();
</I>&gt;<i>     &gt;              break;
</I>&gt;<i>     &gt;          }
</I>&gt;<i>     &gt; -
</I>&gt;<i>     &gt; -        strListAdd(&amp;vstr, name, ',');
</I>&gt;<i>     &gt; +        name.toLower();
</I>&gt;<i> 
</I>&gt;<i>     Do you know why we need to convert header names to lowercase here? The
</I>&gt;<i>     header names are not a part of some Store hash, right? This conversion
</I>&gt;<i>     is expensive because most header names will be changed here, breaking
</I>&gt;<i>     SBuf reuse. If you know the reason, let's add a comment since you are
</I>&gt;<i>     changing this code anyway.
</I>

&gt;<i> Since lowerCase(&quot;*&quot;) == &quot;*&quot;, I'd hope that the behavior is unchanged,
</I>
I did not say something has changed. I asked *why* we need to convert
header names to lower case. I am not trying to sneak in some veiled
attack on your code inside an innocent-looking question. I asked exactly
what I wanted to know. An &quot;I do not know&quot; would be a perfectly
acceptable response, of course, but if you do know, it would be good to
add a comment.


&gt;<i>       // XXX: will reallocate if toLower() above is removed
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> .. and strListGetItem will start emitting SBufs in place of (char*,
</I>&gt;<i> length).
</I>
Right, so perhaps s/will/may/ to be less precise since there are many
factors here. The toLower() call is the most hidden factor though. This
is not important -- if you disagree that a comment would be useful, do
not add it. This is not an attack on your code.


&gt;<i>     &gt; -    while ((e = getEntry(&amp;pos))) {
</I>&gt;<i>     &gt; -        if (e-&gt;id == id)
</I>&gt;<i>     &gt; -            delAt(pos, count);
</I>&gt;<i>     &gt; -    }
</I>&gt;<i>     &gt; +    int sz_before = entries.size();
</I>&gt;<i>     &gt; +    entries.erase(std::remove_if(entries.begin(), entries.end(),
</I>&gt;<i>     &gt; +    [=](HttpHeaderEntry *e) { return e &amp;&amp; e-&gt;id == id; }),
</I>&gt;<i>     &gt; +    entries.end());
</I>&gt;<i> 
</I>&gt;<i>     This change is a performance regression AFAICT: Unlike the old delAt(),
</I>&gt;<i>     std::remove_if is very expensive for std::vector. Consider using
</I>&gt;<i>     std::replace_if without .erasing instead.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> yes, it is a small regresson (from N to 2N)
</I>
I suspect a factor of 2 does not describe the overhead accurately. If
remove_if removes a field, then all subsequent fields (except those that
are also removed) would have to be moved, which is probably much more
expensive than just checking their values twice.


&gt;<i> ). Reimplemented using replace_if - readability goes a bit down the
</I>&gt;<i> drain, unfortunatley.
</I>
Perhaps a little bit. Personally, I could not interpret the earlier
erase(remove_if) combination without looking things up anyway :-).


&gt;<i>     &gt; +enum HdrKind {
</I>&gt;<i> 
</I>&gt;<i>     Use C++11 class enums for global enums, especially when such use does
</I>&gt;<i>     not increase the amount of old code changes. In this specific case, it
</I>&gt;<i>     does not AFAICT.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Unfortunately it's not possible in ordeer to use it as a bit-field (I
</I>&gt;<i> have tried and the compiler refused)
</I>
Interesting! If you still have an example of what goes wrong, can you
post it? I tried a few tests myself, but they seem to be working fine if
I specify the underlying class storage type (as we should, per [1]):


&gt;<i> enum class HdrKind: std::uint8_t {
</I>&gt;<i>     None = 0,
</I>&gt;<i>     ListHeader = 1,
</I>...
&gt;<i> };
</I>&gt;<i> 
</I>&gt;<i> class Foo {
</I>&gt;<i> public:
</I>&gt;<i> 	HdrKind bar: 8;
</I>&gt;<i> };
</I>
[1]
<A HREF="http://stackoverflow.com/questions/22606392/is-this-warning-related-to-enum-class-size-wrong">http://stackoverflow.com/questions/22606392/is-this-warning-related-to-enum-class-size-wrong</A>



&gt;<i> &quot;bzr send&quot; unfortunately doesn't allow to specify context to be added :(
</I>
Yes, that is unfortunate indeed. Fortunately, &quot;bzr send&quot; is not the only
way to post a patch for review :-).


Thank you,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003104.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
	<LI>Next message: <A HREF="003130.html">[squid-dev] [PATCH] Coverity(-inspired) fixes part four, HttpHeader refactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3126">[ date ]</a>
              <a href="thread.html#3126">[ thread ]</a>
              <a href="subject.html#3126">[ subject ]</a>
              <a href="author.html#3126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
