<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Regression introduced in r14268
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Regression%20introduced%20in%20r14268&In-Reply-To=%3C55E35E6C.8000504%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003278.html">
   <LINK REL="Next"  HREF="003282.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Regression introduced in r14268</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Regression%20introduced%20in%20r14268&In-Reply-To=%3C55E35E6C.8000504%40treenet.co.nz%3E"
       TITLE="[squid-dev] Regression introduced in r14268">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Aug 30 19:50:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003278.html">[squid-dev] Regression introduced in r14268
</A></li>
        <LI>Next message: <A HREF="003282.html">[squid-dev] Regression introduced in r14268
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3280">[ date ]</a>
              <a href="thread.html#3280">[ thread ]</a>
              <a href="subject.html#3280">[ subject ]</a>
              <a href="author.html#3280">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/08/2015 6:51 p.m., Kinkie wrote:
&gt;<i> Hi all,
</I>&gt;<i>   I suspect that  r14268 is causing a regression: running that revision of
</I>&gt;<i> trunk or later on any URL causes:
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> 2015/08/30 08:12:59 kid1| SECURITY ERROR: ACL 0x7f96e1c2ea88 checked with
</I>&gt;<i> nothing to match against!!
</I>&gt;<i> ----
</I>&gt;<i> 
</I>&gt;<i> The user-visible result is ERR_ACCESS_DENIED and connection termination.
</I>&gt;<i> I've tried checing the patch, and noticed nothing obvious in it that could
</I>&gt;<i> cause the behavior.
</I>&gt;<i> 
</I>&gt;<i>    Kinkie
</I>&gt;<i> 
</I>
Turns out to be the locking sequence was borked and releasing the one it
needed to hold.

Apologies to Alex for associating his name with this. The bug was
entirely my bad cut-n-paste'ing.


After fixing that I am now getting:

#3  0x083316dd in xassert (msg=0x8703069 &quot;c-&gt;locks &gt; 0&quot;, file=0x8702ed3
&quot;../../src/cbdata.cc&quot;, line=425) at ../../src/debug.cc:556

Hey reproducible case for *that* long annoying bug !!

#4  0x082d7feb in cbdataReferenceValid (p=0x8c92e48) at
../../src/cbdata.cc:425
#5  0x082fe3f0 in ACLChecklist::changeAcl (this=0xbffff110, t=0x0) at
../../src/acl/Checklist.h:175
#6  0x084d972b in ACLChecklist::fastCheck (this=0xbffff110,
list=0x8c92e48) at ../../../src/acl/Checklist.cc:326
#7  0x0863b5a6 in accessLogLogTo (log=0x8a7c780, al=...,
checklist=0xbffff110) at ../../../src/log/access_log.cc:96


It looks like this is a result from the SquidConfig.accessList.*
pointers not having any cbdataReference locks. They and squid.conf
aprsing are the true &quot;owner&quot; of the CBDATA object so the only place
valid to set initial lock and call cbdataReferenceValidDone() from. But
none of that logic exists.

So the actual locking/unlocking happens properly symmetric within ACL
testing but the final validity test fails since its still a valid but
now fully unlocked CBDATA object. Yuck.

I'm reverting the validity test for now. But this kind of highlights the
need to fix/remove *ValidDone(). Removing all locks and leaving the
object still valid is very wrong for any lock-counted referencing model
whose own validity test requires locks to exist.

Amos

</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003278.html">[squid-dev] Regression introduced in r14268
</A></li>
	<LI>Next message: <A HREF="003282.html">[squid-dev] Regression introduced in r14268
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3280">[ date ]</a>
              <a href="thread.html#3280">[ thread ]</a>
              <a href="subject.html#3280">[ subject ]</a>
              <a href="author.html#3280">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
