<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Where do ACL flags belong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C5661028D.7070502%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004035.html">
   <LINK REL="Next"  HREF="004038.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Where do ACL flags belong?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C5661028D.7070502%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] Where do ACL flags belong?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Dec  4 03:03:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004035.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
        <LI>Next message: <A HREF="004038.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4037">[ date ]</a>
              <a href="thread.html#4037">[ thread ]</a>
              <a href="subject.html#4037">[ subject ]</a>
              <a href="author.html#4037">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/03/2015 06:10 PM, Amos Jeffries wrote:
&gt;<i> On 4/12/2015 1:02 p.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> AFAICT, admins expect the following configuration to work as described
</I>&gt;&gt;<i> in the #comments:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl foo dstdomain    v1 # lookup/conversion allowed
</I>&gt;&gt;<i>   acl foo dstdomain -n v2 # no lookup/conversion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, Squid interprets the above as:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl foo dstdomain -n v1 # no lookup/conversion
</I>&gt;&gt;<i>   acl foo dstdomain -n v2 # no lookup/conversion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> or, if you prefer:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl foo dstdomain -n v1 v2 # no lookup/conversion
</I>

&gt;&gt;<i> The only exception is the -i flag that is parsed/stored
</I>&gt;&gt;<i> specially for historical reasons; let's ignore that exception for now.
</I>

&gt;<i> Lets not. It used to be -i was the only one that existed for many years.
</I>&gt;<i> So it was the authoritative pattern or how flags operated in Squid. AIUI
</I>&gt;<i> this is where the admins expectation comes from.
</I>
Admin expectations differ as they come from different places. Some Squid
admins read our -n documentation and expect the above line-specific flag
behavior. I know I did and was surprised to find out that Squid does
something else.


&gt;<i> The -n flags which are breaking that pattern are the exception. Not the
</I>&gt;<i> other way around.
</I>
Sorry for not being clear enough (I copied that phrase from a bug report
with more context): -i is exceptional from implementation point of view
because it does not use the general ACLFlags interface (where the new
flags should be added), and not because its interface is &quot;broken&quot;.


&gt;&gt;<i> I see two primary ways to fix this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Move ACLFlags from the ACL object to individual data items inside the
</I>&gt;&gt;<i> ACLData object. This move will allow multiple acl lines to have
</I>&gt;&gt;<i> different flags.
</I>

&gt;<i> It will also work much better with the allof design you insisted on
</I>&gt;<i> using. Where a single ACL contains a full AND-OR boolean tree of decisions.
</I>
Sorry, I do not see the relevance.


&gt;&gt;<i> In summary, this is a tough choice between:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #1: Supporting what the admins thought they are configuring.
</I>&gt;&gt;<i>     Better configuration interface?
</I>&gt;&gt;<i>     More similar to how -i is handled today.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #2: Backward compatible (but with &quot;Is your config broken?&quot; warnings).
</I>&gt;&gt;<i>     A lot less development work.
</I>&gt;<i> 
</I>&gt;<i> No. You will have to fully re-implement regex parsing not to perform -i/+i.
</I>
No. We could leave -i/+i handling as is.


&gt;&gt;<i>     Simpler configuration interface.
</I>&gt;&gt;<i>     Less RAM.
</I>

&gt;<i> Not much less RAM to matter. Each of the split ACLs will have more
</I>&gt;<i> overhead in RAM usage
</I>
A simple implementation of #1 will add about 16 bytes to each ACL data
value item. For example, an ACL with 1M URLs will grow by 16MB. As I
mentioned, this can be optimized, but at the expense of more complex code.


&gt;&gt;<i> I lean towards #2 because it is backward compatible and simpler (the
</I>&gt;&gt;<i> ACLs are already &quot;too complex&quot; for many admins). I would have been sure
</I>&gt;&gt;<i> that this is the best approach if -i was not handled differently already.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How do you think this should be fixed?
</I>
&gt;<i> I prefer #1, because it is already familiar to admins and does not force
</I>&gt;<i> us all to do a non-backward-compatible manual config update (those as
</I>&gt;<i> you may see below that is not mandatory). We have enough config updates
</I>&gt;<i> happening without this.
</I>
If we do #1, do you think we should ignore the possibility that some
Squids will be broken because Squid interpretation of the configuration
file will change? We can add warnings, but then removing those warnings
will require changing the config...


&gt;<i> I believe -i is a lot more widespread in historic usage than -n.
</I>
Yes, of course. I was not proposing to change how -i works.


&gt;<i> I also see no use for a flag that changes the behaviour for an entire
</I>&gt;<i> ACL type. We would probably be better off making a new type (dstdomain_str).
</I>

Not sure what you mean. A single -n flag changes behavior of a named ACL
(today) or a single data item of a named ACL (if we implement #1).


&gt;<i> I know that has issues of its own as side effects on *access complexity.
</I>&gt;<i> Allowing one &quot;name&quot; to be shared between the dstdomain, dstdom_regex,
</I>&gt;<i> and dstdom_str types would simplify those.
</I>&gt;<i>  OR, using a namespace sub-type ('_' maybe?) that implies the flagged
</I>&gt;<i> behaviour difference. A renaming dstdom_regex to dstdomain_regex etc.
</I>&gt;<i> under the new model.
</I>
Sorry, you lost me here completely. Can you give an example?


&gt;<i> AFAICS it should not be much more difficult to
</I>&gt;<i> re-implement -n using #1 than to re-implement regex parsing and -i to
</I>&gt;<i> implement #2.
</I>
True, but I do not think we should touch the -i interface. It works as
expected.



&gt;<i> Or if you are super worried about one boolean flag per ACL value
</I>
I am not.

&gt;<i> adn insist on #2
</I>
I am not. It is an RFC, and I did express my concerns about each approach.


&gt;<i> then auto-converting the lists of values between -n/+n
</I>&gt;<i> flags down into sub-nodes of the ACL tree would let the flag actually be
</I>&gt;<i> on the node rather than the value entry. Without requiring the manual
</I>&gt;<i> config migrations.
</I>
Sorry, I do not follow, but perhaps this is not important for now.


Thank you,

Alex.

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004035.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
	<LI>Next message: <A HREF="004038.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4037">[ date ]</a>
              <a href="thread.html#4037">[ thread ]</a>
              <a href="subject.html#4037">[ subject ]</a>
              <a href="author.html#4037">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
