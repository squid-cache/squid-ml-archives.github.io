<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Where do ACL flags belong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C5661259F.2000407%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004037.html">
   <LINK REL="Next"  HREF="004042.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Where do ACL flags belong?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C5661259F.2000407%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Where do ACL flags belong?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec  4 05:33:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004037.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
        <LI>Next message: <A HREF="004042.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4038">[ date ]</a>
              <a href="thread.html#4038">[ thread ]</a>
              <a href="subject.html#4038">[ subject ]</a>
              <a href="author.html#4038">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/12/2015 4:03 p.m., Alex Rousskov wrote:
&gt;<i> On 12/03/2015 06:10 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 4/12/2015 1:02 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> AFAICT, admins expect the following configuration to work as described
</I>&gt;&gt;&gt;<i> in the #comments:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   acl foo dstdomain    v1 # lookup/conversion allowed
</I>&gt;&gt;&gt;<i>   acl foo dstdomain -n v2 # no lookup/conversion
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> However, Squid interprets the above as:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   acl foo dstdomain -n v1 # no lookup/conversion
</I>&gt;&gt;&gt;<i>   acl foo dstdomain -n v2 # no lookup/conversion
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> or, if you prefer:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   acl foo dstdomain -n v1 v2 # no lookup/conversion
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> The only exception is the -i flag that is parsed/stored
</I>&gt;&gt;&gt;<i> specially for historical reasons; let's ignore that exception for now.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Lets not. It used to be -i was the only one that existed for many years.
</I>&gt;&gt;<i> So it was the authoritative pattern or how flags operated in Squid. AIUI
</I>&gt;&gt;<i> this is where the admins expectation comes from.
</I>&gt;<i> 
</I>&gt;<i> Admin expectations differ as they come from different places. Some Squid
</I>&gt;<i> admins read our -n documentation and expect the above line-specific flag
</I>&gt;<i> behavior. I know I did and was surprised to find out that Squid does
</I>&gt;<i> something else.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The -n flags which are breaking that pattern are the exception. Not the
</I>&gt;&gt;<i> other way around.
</I>&gt;<i> 
</I>&gt;<i> Sorry for not being clear enough (I copied that phrase from a bug report
</I>&gt;<i> with more context): -i is exceptional from implementation point of view
</I>&gt;<i> because it does not use the general ACLFlags interface (where the new
</I>&gt;<i> flags should be added), and not because its interface is &quot;broken&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I see two primary ways to fix this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1. Move ACLFlags from the ACL object to individual data items inside the
</I>&gt;&gt;&gt;<i> ACLData object. This move will allow multiple acl lines to have
</I>&gt;&gt;&gt;<i> different flags.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> It will also work much better with the allof design you insisted on
</I>&gt;&gt;<i> using. Where a single ACL contains a full AND-OR boolean tree of decisions.
</I>&gt;<i> 
</I>&gt;<i> Sorry, I do not see the relevance.
</I>&gt;<i> 
</I>
In defence of #2 you made the statement:
&quot;
it matches the original squid.conf &quot;multiple ACL lines with the same
name are the same as a single line&quot; design.
&quot;

That design was thrown away with the introduction of the allof ACL when
you insisted that each separate line in squid.conf was OR'd together.
Even though its single-line values were being AND'd together.

Which means for at least that ACL there is not single-line vs
multiple-line equivalence.


The current working model is actually that all config lines (&quot;acl &quot;
definitions included) are OR'd on a first-match basis. Each line is
sequential but independently operating on its set of per-line
values/parameters.


Of the two proposals #1 (with the implied changing of -n behaviour to be
per-line) is actually the best fit with the currently working
design/architectural model for squid.conf.


&gt;<i> 
</I>&gt;&gt;&gt;<i> In summary, this is a tough choice between:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #1: Supporting what the admins thought they are configuring.
</I>&gt;&gt;&gt;<i>     Better configuration interface?
</I>&gt;&gt;&gt;<i>     More similar to how -i is handled today.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #2: Backward compatible (but with &quot;Is your config broken?&quot; warnings).
</I>&gt;&gt;&gt;<i>     A lot less development work.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No. You will have to fully re-implement regex parsing not to perform -i/+i.
</I>&gt;<i> 
</I>&gt;<i> No. We could leave -i/+i handling as is.
</I>
You cannot do that while unifying the model for how flags operate (to
the form of per-ACL).

The -i/-n are polar opposites in conceptual design.



&gt;<i> 
</I>&gt;&gt;&gt;<i>     Simpler configuration interface.
</I>&gt;&gt;&gt;<i>     Less RAM.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Not much less RAM to matter. Each of the split ACLs will have more
</I>&gt;&gt;<i> overhead in RAM usage
</I>&gt;<i> 
</I>&gt;<i> A simple implementation of #1 will add about 16 bytes to each ACL data
</I>&gt;<i> value item. For example, an ACL with 1M URLs will grow by 16MB. As I
</I>&gt;<i> mentioned, this can be optimized, but at the expense of more complex code.
</I>
In context of the up to 64GB of RAM the 1M values will use for their
value portion that 16M is trivial.

The whole ACLFlags object is not necessary in per-value/line entries. We
only use 3 bits today, and even allowing for extension the flag field is
4 bytes. Most of what is in ACLFlags seems to only be needed by the ACL
Prototype object used by the config parser/dumper logic.


&gt;<i> 
</I>&gt;&gt;&gt;<i> I lean towards #2 because it is backward compatible and simpler (the
</I>&gt;&gt;&gt;<i> ACLs are already &quot;too complex&quot; for many admins). I would have been sure
</I>&gt;&gt;&gt;<i> that this is the best approach if -i was not handled differently already.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> How do you think this should be fixed?
</I>&gt;<i> 
</I>&gt;&gt;<i> I prefer #1, because it is already familiar to admins and does not force
</I>&gt;&gt;<i> us all to do a non-backward-compatible manual config update (those as
</I>&gt;&gt;<i> you may see below that is not mandatory). We have enough config updates
</I>&gt;&gt;<i> happening without this.
</I>&gt;<i> 
</I>&gt;<i> If we do #1, do you think we should ignore the possibility that some
</I>&gt;<i> Squids will be broken because Squid interpretation of the configuration
</I>&gt;<i> file will change? We can add warnings, but then removing those warnings
</I>&gt;<i> will require changing the config...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I believe -i is a lot more widespread in historic usage than -n.
</I>&gt;<i> 
</I>&gt;<i> Yes, of course. I was not proposing to change how -i works.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I also see no use for a flag that changes the behaviour for an entire
</I>&gt;&gt;<i> ACL type. We would probably be better off making a new type (dstdomain_str).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Not sure what you mean. A single -n flag changes behavior of a named ACL
</I>&gt;<i> (today) or a single data item of a named ACL (if we implement #1).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I know that has issues of its own as side effects on *access complexity.
</I>&gt;&gt;<i> Allowing one &quot;name&quot; to be shared between the dstdomain, dstdom_regex,
</I>&gt;&gt;<i> and dstdom_str types would simplify those.
</I>&gt;&gt;<i>  OR, using a namespace sub-type ('_' maybe?) that implies the flagged
</I>&gt;&gt;<i> behaviour difference. A renaming dstdom_regex to dstdomain_regex etc.
</I>&gt;&gt;<i> under the new model.
</I>&gt;<i> 
</I>&gt;<i> Sorry, you lost me here completely. Can you give an example?
</I>&gt;<i> 
</I>

  acl foo dstdomain .example.com
  acl foo dstdomain 192.0.2.1

  acl foo dstdomain_str 192.0.2.3

  http_access deny foo

when looking up <A HREF="http://192.0.2.3/">http://192.0.2.3/</A> the ACL only performs an exact match.
when looking up <A HREF="http://192.0.2.1/">http://192.0.2.1/</A> the ACL performs exact-match, then
rDNS lookup and match.


Same as the below would do today:

  acl foo dstdomain .example.com
  acl foo dstdomain 192.0.2.1

  acl bar dstdomain -n 192.0.2.3

  http_access deny foo
  http_access deny bar


(bar currently needing to exist due to -n's per-ACL not per-line nature).


&gt;<i> 
</I>&gt;&gt;<i> AFAICS it should not be much more difficult to
</I>&gt;&gt;<i> re-implement -n using #1 than to re-implement regex parsing and -i to
</I>&gt;&gt;<i> implement #2.
</I>&gt;<i> 
</I>&gt;<i> True, but I do not think we should touch the -i interface. It works as
</I>&gt;<i> expected.
</I>&gt;<i> 
</I>
Then I must have completely misunderstood what your #2 proposal was about.
 -i flag operates per-line, and resets at the EOL. If we remove
per-line/value flags then a lot of configs are broken.

 (making) -n operate per-line and (not?) reset at the EOL.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Or if you are super worried about one boolean flag per ACL value
</I>&gt;<i> 
</I>&gt;<i> I am not.
</I>&gt;<i> 
</I>&gt;&gt;<i> adn insist on #2
</I>&gt;<i> 
</I>&gt;<i> I am not. It is an RFC, and I did express my concerns about each approach.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> then auto-converting the lists of values between -n/+n
</I>&gt;&gt;<i> flags down into sub-nodes of the ACL tree would let the flag actually be
</I>&gt;&gt;<i> on the node rather than the value entry. Without requiring the manual
</I>&gt;&gt;<i> config migrations.
</I>&gt;<i> 
</I>&gt;<i> Sorry, I do not follow, but perhaps this is not important for now.
</I>
We already have allof/anyof generating sub-trees of ACL nodes.

I am proposing option #3 be that we have the flag (or ACL type _suffix)
cause parser to generate a similar sub-tree of nodes to what anyof would
generate. BUT using only the specific named type of ACL that the line
was given.


So this:
 acl foo dstdomain 192.0.2.1
 acl foo dstdomain -n 192.0.2.3

or this:
 acl foo dstdomain 192.0.2.1
 acl foo dstdomain_str 192.0.2.3


both generates internally a tree identical to:

  acl foo:1 dstdomain 192.0.2.1
  acl foo:2 dstdomain -n 192.0.2.3
  acl foo anyof foo:1 foo:2

That way:
 * the ACLFlags can be on the node instead of the value. But have the
behaviour of being on the value(s).

 * we can leave -n as exceptional behaviour, but deprecate it in favour
of the _suffix ACL type.

 * we can avoid the outstanding problem with dstdomain vs dstdom_regex
needing different multiple *_access lines.


Amos

</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004037.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
	<LI>Next message: <A HREF="004042.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4038">[ date ]</a>
              <a href="thread.html#4038">[ thread ]</a>
              <a href="subject.html#4038">[ subject ]</a>
              <a href="author.html#4038">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
