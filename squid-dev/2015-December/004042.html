<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Where do ACL flags belong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C566137DD.5090006%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004038.html">
   <LINK REL="Next"  HREF="004043.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Where do ACL flags belong?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C566137DD.5090006%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] Where do ACL flags belong?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Dec  4 06:51:09 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004038.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
        <LI>Next message: <A HREF="004043.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4042">[ date ]</a>
              <a href="thread.html#4042">[ thread ]</a>
              <a href="subject.html#4042">[ subject ]</a>
              <a href="author.html#4042">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/03/2015 10:33 PM, Amos Jeffries wrote:
&gt;<i> On 4/12/2015 4:03 p.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 12/03/2015 06:10 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 4/12/2015 1:02 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> In summary, this is a tough choice between:
</I>
&gt;&gt;&gt;&gt;<i> #1: Supporting what the admins thought they are configuring.
</I>&gt;&gt;&gt;&gt;<i>     Better configuration interface?
</I>&gt;&gt;&gt;&gt;<i>     More similar to how -i is handled today.
</I>
&gt;&gt;&gt;&gt;<i> #2: Backward compatible (but with &quot;Is your config broken?&quot; warnings).
</I>&gt;&gt;&gt;&gt;<i>     A lot less development work.
</I>
&gt;&gt;&gt;<i> No. You will have to fully re-implement regex parsing not to perform -i/+i.
</I>
&gt;&gt;<i> No. We could leave -i/+i handling as is.
</I>

&gt;<i> You cannot do that while unifying the model for how flags operate (to
</I>&gt;<i> the form of per-ACL).
</I>
#2 does not attempt to unify how -i and the new flags operate. In #2,
everything continues to match as it does today, but the admins are
warned when the -n flags configuration is inconsistent with how they
actually work.


&gt;&gt;&gt;&gt;<i> How do you think this should be fixed?
</I>
&gt;&gt;&gt;<i> I prefer #1, because it is already familiar to admins and does not force
</I>&gt;&gt;&gt;<i> us all to do a non-backward-compatible manual config update (those as
</I>&gt;&gt;&gt;<i> you may see below that is not mandatory). We have enough config updates
</I>&gt;&gt;&gt;<i> happening without this.
</I>

&gt;&gt;<i> If we do #1, do you think we should ignore the possibility that some
</I>&gt;&gt;<i> Squids will be broken because Squid interpretation of the configuration
</I>&gt;&gt;<i> file will change? We can add warnings, but then removing those warnings
</I>&gt;&gt;<i> will require changing the config...
</I>

This is the last open question on this thread AFAICT: What to do about
backward compatibility in approach #1 that you favor?



&gt;&gt;&gt;<i> I know that has issues of its own as side effects on *access complexity.
</I>&gt;&gt;&gt;<i> Allowing one &quot;name&quot; to be shared between the dstdomain, dstdom_regex,
</I>&gt;&gt;&gt;<i> and dstdom_str types would simplify those.
</I>&gt;&gt;&gt;<i>  OR, using a namespace sub-type ('_' maybe?) that implies the flagged
</I>&gt;&gt;&gt;<i> behaviour difference. A renaming dstdom_regex to dstdomain_regex etc.
</I>&gt;&gt;&gt;<i> under the new model.
</I>
&gt;&gt;<i> Sorry, you lost me here completely. Can you give an example?
</I>

&gt;<i>   acl foo dstdomain .example.com
</I>&gt;<i>   acl foo dstdomain 192.0.2.1
</I>&gt;<i> 
</I>&gt;<i>   acl foo dstdomain_str 192.0.2.3
</I>&gt;<i> 
</I>&gt;<i>   http_access deny foo
</I>&gt;<i> 
</I>&gt;<i> when looking up <A HREF="http://192.0.2.3/">http://192.0.2.3/</A> the ACL only performs an exact match.
</I>&gt;<i> when looking up <A HREF="http://192.0.2.1/">http://192.0.2.1/</A> the ACL performs exact-match, then
</I>&gt;<i> rDNS lookup and match.
</I>
AFAICT, the above will perform an rDNS lookup (to match against
.example.com) in both cases. We are still matching each acl data entry
in order, right? Did you mean to place the dstdomain_str line first?


&gt;<i> Same as the below would do today:
</I>&gt;<i> 
</I>&gt;<i>   acl foo dstdomain .example.com
</I>&gt;<i>   acl foo dstdomain 192.0.2.1
</I>&gt;<i> 
</I>&gt;<i>   acl bar dstdomain -n 192.0.2.3
</I>&gt;<i> 
</I>&gt;<i>   http_access deny foo
</I>&gt;<i>   http_access deny bar
</I>

&gt;<i> (bar currently needing to exist due to -n's per-ACL not per-line nature).
</I>

The -n approach is overall better than _str suffix approach because the
former makes it easy to mix-and-match multiple flags and to support
flags with values such as -m=delimiters.



&gt;&gt;&gt;<i> AFAICS it should not be much more difficult to
</I>&gt;&gt;&gt;<i> re-implement -n using #1 than to re-implement regex parsing and -i to
</I>&gt;&gt;&gt;<i> implement #2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> True, but I do not think we should touch the -i interface. It works as
</I>&gt;&gt;<i> expected.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Then I must have completely misunderstood what your #2 proposal was about.
</I>
#2 issues a warning when -n is used on some but not all lines of a given
ACL foo. No other changes in #2.


&gt;<i>  -i flag operates per-line, and resets at the EOL. 
</I>
Yes (which, BTW, also breaks the &quot;multiple lines are the same as one
combined line&quot; design principle).


&gt;<i> If we remove per-line/value flags then a lot of configs are broken.
</I>
Neither #1 nor #2 change how -i works.

#1 makes -n work per line, as intended.

#2 does not change how -n works, but issues a warning if -n is used
inconsistently across multiple lines.



&gt;<i> I am proposing option #3 be that we have the flag (or ACL type _suffix)
</I>&gt;<i> cause parser to generate a similar sub-tree of nodes to what anyof would
</I>&gt;<i> generate. BUT using only the specific named type of ACL that the line
</I>&gt;<i> was given.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So this:
</I>&gt;<i>  acl foo dstdomain 192.0.2.1
</I>&gt;<i>  acl foo dstdomain -n 192.0.2.3
</I>&gt;<i> 
</I>&gt;<i> or this:
</I>&gt;<i>  acl foo dstdomain 192.0.2.1
</I>&gt;<i>  acl foo dstdomain_str 192.0.2.3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> both generates internally a tree identical to:
</I>&gt;<i> 
</I>&gt;<i>   acl foo:1 dstdomain 192.0.2.1
</I>&gt;<i>   acl foo:2 dstdomain -n 192.0.2.3
</I>&gt;<i>   acl foo anyof foo:1 foo:2
</I>

AFAICT this is the same as optimized #1 I have mentioned earlier (except
for the _suffix part which I think we should avoid as discussed above).
To illustrate this even better, you need to add more lines and values:

  acl foo dstdomain v1
  acl foo dstdomain -n v2a v2b
  acl foo dstdomain v3

is interpreted after #1 changes as

  acl foo1  dstdomain v1
  acl foo2a dstdomain -n v2a
  acl foo2b dstdomain -n v2b
  acl foo3  dstdomain v3
  acl foo anyof foo1 foo2a foo2b foo3

Does this match what you think we should do? If yes, what to do about
backward compatibility? Break it because -n is not that widely used?


Thank you,

Alex.

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004038.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
	<LI>Next message: <A HREF="004043.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4042">[ date ]</a>
              <a href="thread.html#4042">[ thread ]</a>
              <a href="subject.html#4042">[ subject ]</a>
              <a href="author.html#4042">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
