<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Where do ACL flags belong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C5661947B.4070508%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004046.html">
   <LINK REL="Next"  HREF="004052.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Where do ACL flags belong?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C5661947B.4070508%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Where do ACL flags belong?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec  4 13:26:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004046.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
        <LI>Next message: <A HREF="004052.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4044">[ date ]</a>
              <a href="thread.html#4044">[ thread ]</a>
              <a href="subject.html#4044">[ subject ]</a>
              <a href="author.html#4044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Okay, I see I have very misunderstood your proposals.

So snipping away my side-trails...

On 4/12/2015 7:51 p.m., Alex Rousskov wrote:
&gt;<i> On 12/03/2015 10:33 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 4/12/2015 4:03 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 12/03/2015 06:10 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 4/12/2015 1:02 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> In summary, this is a tough choice between:
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> #1: Supporting what the admins thought they are configuring.
</I>&gt;&gt;&gt;&gt;&gt;<i>     Better configuration interface?
</I>&gt;&gt;&gt;&gt;&gt;<i>     More similar to how -i is handled today.
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> #2: Backward compatible (but with &quot;Is your config broken?&quot; warnings).
</I>&gt;&gt;&gt;&gt;&gt;<i>     A lot less development work.
</I>&gt;<i>
</I>
&gt;&gt;&gt;&gt;&gt;<i> How do you think this should be fixed?
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I prefer #1, because it is already familiar to admins and does not force
</I>&gt;&gt;&gt;&gt;<i> us all to do a non-backward-compatible manual config update (those as
</I>&gt;&gt;&gt;&gt;<i> you may see below that is not mandatory). We have enough config updates
</I>&gt;&gt;&gt;&gt;<i> happening without this.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> If we do #1, do you think we should ignore the possibility that some
</I>&gt;&gt;&gt;<i> Squids will be broken because Squid interpretation of the configuration
</I>&gt;&gt;&gt;<i> file will change? We can add warnings, but then removing those warnings
</I>&gt;&gt;&gt;<i> will require changing the config...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This is the last open question on this thread AFAICT: What to do about
</I>&gt;<i> backward compatibility in approach #1 that you favor?
</I>&gt;<i> 
</I>
#2 does sound like an attractve short-term fix rather than a good
long-term solution.

But as you state in that one-liner summary of #2 later it would also
involve warnings. And ones we cant get rid of while the -n behaviour
remains unchanged.

We would need to add a completely different flag for the no-rDNS and
&quot;burn&quot; -n for a very long time. Which is somewhat worse.

&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I know that has issues of its own as side effects on *access complexity.
</I>&gt;&gt;&gt;&gt;<i> Allowing one &quot;name&quot; to be shared between the dstdomain, dstdom_regex,
</I>&gt;&gt;&gt;&gt;<i> and dstdom_str types would simplify those.
</I>&gt;&gt;&gt;&gt;<i>  OR, using a namespace sub-type ('_' maybe?) that implies the flagged
</I>&gt;&gt;&gt;&gt;<i> behaviour difference. A renaming dstdom_regex to dstdomain_regex etc.
</I>&gt;&gt;&gt;&gt;<i> under the new model.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Sorry, you lost me here completely. Can you give an example?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>   acl foo dstdomain .example.com
</I>&gt;&gt;<i>   acl foo dstdomain 192.0.2.1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl foo dstdomain_str 192.0.2.3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access deny foo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> when looking up <A HREF="http://192.0.2.3/">http://192.0.2.3/</A> the ACL only performs an exact match.
</I>&gt;&gt;<i> when looking up <A HREF="http://192.0.2.1/">http://192.0.2.1/</A> the ACL performs exact-match, then
</I>&gt;&gt;<i> rDNS lookup and match.
</I>&gt;<i> 
</I>&gt;<i> AFAICT, the above will perform an rDNS lookup (to match against
</I>&gt;<i> .example.com) in both cases. We are still matching each acl data entry
</I>&gt;<i> in order, right? Did you mean to place the dstdomain_str line first?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Same as the below would do today:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl foo dstdomain .example.com
</I>&gt;&gt;<i>   acl foo dstdomain 192.0.2.1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl bar dstdomain -n 192.0.2.3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access deny foo
</I>&gt;&gt;<i>   http_access deny bar
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> (bar currently needing to exist due to -n's per-ACL not per-line nature).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The -n approach is overall better than _str suffix approach because the
</I>&gt;<i> former makes it easy to mix-and-match multiple flags and to support
</I>&gt;<i> flags with values such as -m=delimiters.
</I>&gt;<i> 
</I>
Good point.

&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> AFAICS it should not be much more difficult to
</I>&gt;&gt;&gt;&gt;<i> re-implement -n using #1 than to re-implement regex parsing and -i to
</I>&gt;&gt;&gt;&gt;<i> implement #2.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> True, but I do not think we should touch the -i interface. It works as
</I>&gt;&gt;&gt;<i> expected.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then I must have completely misunderstood what your #2 proposal was about.
</I>&gt;<i> 
</I>&gt;<i> #2 issues a warning when -n is used on some but not all lines of a given
</I>&gt;<i> ACL foo. No other changes in #2.
</I>&gt;<i> 
</I>
Which makes that a permanent warning, and a permanent annoyance that
only forces admin to expand the number of named ACLs they use. Which
kind of defeats the purpose of having the flag vs a different ACL type name.


&gt;<i> 
</I>&gt;&gt;<i>  -i flag operates per-line, and resets at the EOL. 
</I>&gt;<i> 
</I>&gt;<i> Yes (which, BTW, also breaks the &quot;multiple lines are the same as one
</I>&gt;<i> combined line&quot; design principle).
</I>&gt;<i> 
</I>
Nod.

&gt;<i> 
</I>&gt;&gt;<i> If we remove per-line/value flags then a lot of configs are broken.
</I>&gt;<i> 
</I>&gt;<i> Neither #1 nor #2 change how -i works.
</I>&gt;<i> 
</I>&gt;<i> #1 makes -n work per line, as intended.
</I>&gt;<i> 
</I>&gt;<i> #2 does not change how -n works, but issues a warning if -n is used
</I>&gt;<i> inconsistently across multiple lines.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I am proposing option #3 be that we have the flag (or ACL type _suffix)
</I>&gt;&gt;<i> cause parser to generate a similar sub-tree of nodes to what anyof would
</I>&gt;&gt;<i> generate. BUT using only the specific named type of ACL that the line
</I>&gt;&gt;<i> was given.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So this:
</I>&gt;&gt;<i>  acl foo dstdomain 192.0.2.1
</I>&gt;&gt;<i>  acl foo dstdomain -n 192.0.2.3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> or this:
</I>&gt;&gt;<i>  acl foo dstdomain 192.0.2.1
</I>&gt;&gt;<i>  acl foo dstdomain_str 192.0.2.3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> both generates internally a tree identical to:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl foo:1 dstdomain 192.0.2.1
</I>&gt;&gt;<i>   acl foo:2 dstdomain -n 192.0.2.3
</I>&gt;&gt;<i>   acl foo anyof foo:1 foo:2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> AFAICT this is the same as optimized #1 I have mentioned earlier (except
</I>&gt;<i> for the _suffix part which I think we should avoid as discussed above).
</I>&gt;<i> To illustrate this even better, you need to add more lines and values:
</I>&gt;<i> 
</I>&gt;<i>   acl foo dstdomain v1
</I>&gt;<i>   acl foo dstdomain -n v2a v2b
</I>&gt;<i>   acl foo dstdomain v3
</I>&gt;<i> 
</I>&gt;<i> is interpreted after #1 changes as
</I>&gt;<i> 
</I>&gt;<i>   acl foo1  dstdomain v1
</I>&gt;<i>   acl foo2a dstdomain -n v2a
</I>&gt;<i>   acl foo2b dstdomain -n v2b
</I>&gt;<i>   acl foo3  dstdomain v3
</I>&gt;<i>   acl foo anyof foo1 foo2a foo2b foo3
</I>&gt;<i> 
</I>&gt;<i> Does this match what you think we should do?
</I>
Yes.

&gt;<i> If yes, what to do about
</I>&gt;<i> backward compatibility? Break it because -n is not that widely used?
</I>
Yes. With a +n flag (akin to the +i, re-enabling what -n disabled) we
can follow -i/+i pattern with an auto-reset at the end of each line but
add a warning if the +n is omitted on the next one.

The internal implementation of that could be a node listing values to
check pre-rDNS and a node listing values only checked post-rDNS.



The message I have been getting about back-compat seems to be that
admins are relatively okay with pushing out config changes after the
fact, so long as headless upgrades dont actually self-abort during the
upgrade process itself and leave the proxy shutdown.
Much as I hate having a proxy suddenly start behaving differently than
expected it seems to be what the vocal others are saying they prefer (ew).

&gt;<i>From a security standpoint changing the behaviour of -n on line endings
</I>is borderline. Depending on whether the ACL is used as whitelist or
blacklist it might have CVE-serious implications. But we avoid CVE
assignment by documenting the change as intentional.


Could this be something completed quickly enough for Squid-4?

Amos

</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004046.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
	<LI>Next message: <A HREF="004052.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4044">[ date ]</a>
              <a href="thread.html#4044">[ thread ]</a>
              <a href="subject.html#4044">[ subject ]</a>
              <a href="author.html#4044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
