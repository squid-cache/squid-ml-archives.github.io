<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Where do ACL flags belong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C56627E70.1080306%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004052.html">
   <LINK REL="Next"  HREF="004096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Where do ACL flags belong?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Where%20do%20ACL%20flags%20belong%3F&In-Reply-To=%3C56627E70.1080306%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Where do ACL flags belong?">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Dec  5 06:04:32 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004052.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
        <LI>Next message: <A HREF="004096.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4063">[ date ]</a>
              <a href="thread.html#4063">[ thread ]</a>
              <a href="subject.html#4063">[ subject ]</a>
              <a href="author.html#4063">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/12/2015 8:42 a.m., Alex Rousskov wrote:
&gt;<i> On 12/04/2015 06:26 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 4/12/2015 7:51 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> To illustrate this even better, you need to add more lines and values:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   acl foo dstdomain v1
</I>&gt;&gt;&gt;<i>   acl foo dstdomain -n v2a v2b
</I>&gt;&gt;&gt;<i>   acl foo dstdomain v3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> is interpreted after #1 changes as
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   acl foo1  dstdomain v1
</I>&gt;&gt;&gt;<i>   acl foo2a dstdomain -n v2a
</I>&gt;&gt;&gt;<i>   acl foo2b dstdomain -n v2b
</I>&gt;&gt;&gt;<i>   acl foo3  dstdomain v3
</I>&gt;&gt;&gt;<i>   acl foo anyof foo1 foo2a foo2b foo3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Does this match what you think we should do?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Yes.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> If yes, what to do about
</I>&gt;&gt;&gt;<i> backward compatibility? Break it because -n is not that widely used?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes. 
</I>&gt;<i> 
</I>&gt;<i> Noted.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> With a +n flag (akin to the +i, re-enabling what -n disabled) we
</I>&gt;&gt;<i> can follow -i/+i pattern with an auto-reset at the end of each line but
</I>&gt;&gt;<i> add a warning if the +n is omitted on the next one.
</I>&gt;<i> 
</I>&gt;<i> I am not against adding +n support, but I do not recommend forcing users
</I>&gt;<i> to add +n, just like we do not force them to add +i.
</I>
Then do you thik -n is used rarely enough to warrant breaking BC silently?
Because having warnings about the line change with no way to silence
them in the case that it was intentional is not a good option.


&gt;<i> 
</I>&gt;<i> Now for flags in-between acl values on the same line:
</I>&gt;<i> 
</I>&gt;<i>   acl old dstname foo -n bar -x baz
</I>&gt;<i> 
</I>&gt;<i> I think we should prohibit general flags between same-line values
</I>
Agree. Seems reasonable to at least require different lines for
different permutations of flags.

&gt;<i> (-i
</I>&gt;<i> support preserved for backward compatibility, but I would probably warn
</I>&gt;<i> about it anyway). Such support does not really add much value AFAICT,
</I>&gt;<i> but the resulting ACL lines become more and more difficult for a human
</I>&gt;<i> to interpret correctly because each flag &quot;area&quot; overlaps subsequent
</I>&gt;<i> flags on the same line. KISS.
</I>

Maybe we should deprecate +i and warn admins to split the line where the
+i is?
If you agree, that change and WARNING can go in immediately.

&gt;<i> 
</I>&gt;<i> General flags in front of lines loaded from an acl parameter file should
</I>&gt;<i> be supported.
</I>&gt;<i> 
</I>
You mean in the data file or the squid.conf?

If you mean the data file, that sounds like its moving the goalpposts of
this proposal. It can be planned to allow for future addition, but not
in scope for coding yet.

&gt;<i> 
</I>&gt;<i> To protect admins from typos and such, we need to prohibit non-quoted
</I>&gt;<i> acl values that
</I>&gt;<i> 
</I>&gt;<i> a) start with a dash followed by a single character (-x and -x=foo)
</I>&gt;<i> 
</I>&gt;<i> and possibly (for future flags)
</I>&gt;<i> 
</I>&gt;<i> b) start with two dashes followed by one or more characters (--long and
</I>&gt;<i> --long=foo)
</I>&gt;<i> 
</I>
Nod.

&gt;<i> Same for those starting with a + sign.
</I>&gt;<i> 
</I>&gt;<i> We can start with deprecation warnings (except for +n which will be
</I>&gt;<i> mis-interpreted in old configurations read by newer Squid, I guess).
</I>&gt;<i> 
</I>
I can't think of any ACL which would need its values to start with '+'
today. The n flag is only valid for ACLs handling DNS labels where '+'
is already invalid for starting a value.
 I'm struggling to see any other ACL that would have a value starting
with '+' either. So no need for an exception there I think.


&gt;<i> 
</I>&gt;<i> Would you recommend any changes to the above approach?
</I>&gt;<i> 
</I>
Agreed on approach. See above for possible redux.

&gt;<i> 
</I>&gt;&gt;<i> The internal implementation of that could be a node listing values to
</I>&gt;&gt;<i> check pre-rDNS and a node listing values only checked post-rDNS.
</I>&gt;<i> 
</I>&gt;<i> Most likely, this fix will not be done using multiple ACL nodes because
</I>&gt;<i> each ACL class object is meant to combine everything about a single ACL
</I>&gt;<i> named foo. We could add more &quot;fake&quot; or &quot;implicit&quot; ACL objects to handle
</I>&gt;<i> this, but I think it would be better to change ACLData instead. That's
</I>&gt;<i> how I would start anyway.
</I>&gt;<i> 
</I>
Hmm. Okay I will shelve that idea until the code hits audit and I get a
better view of what you are thinking.

&gt;<i> 
</I>&gt;&gt;<i> Could this be something completed quickly enough for Squid-4?
</I>&gt;<i> 
</I>&gt;<i> IMO, this change can always go into Squid-4 because it is essentially a
</I>&gt;<i> bug fix. If Factory does the work, and accounting for current overload
</I>&gt;<i> and upcoming holidays, we can probably deliver #1 patch for review by
</I>&gt;<i> the end of January 2016, but this is an estimate and not a promise. Do
</I>&gt;<i> you want Factory to work on this?
</I>&gt;<i> 
</I>
I assumed that since this proposal was coming from you it was a Factory
intention to do anyway. Just design details and timing to organize.

Well the size of patch diff is also a factor on the port. If it is going
to do hundreds of lines of logic change the best thing to do for
stability is procrastinate or incremental addition.

January sounds like it would be just scraping into the beta cycle. But I
do request that back-compat warning happen within the next few weeks, so
we can at least start to see if the assumptions are correct.

Amos

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004052.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
	<LI>Next message: <A HREF="004096.html">[squid-dev] [RFC] Where do ACL flags belong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4063">[ date ]</a>
              <a href="thread.html#4063">[ thread ]</a>
              <a href="subject.html#4063">[ subject ]</a>
              <a href="author.html#4063">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
