<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] on_crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20on_crash&In-Reply-To=%3C56685C08.6040706%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004404.html">
   <LINK REL="Next"  HREF="004110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] on_crash</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20on_crash&In-Reply-To=%3C56685C08.6040706%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] on_crash">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Dec  9 16:51:20 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004404.html">[squid-dev] [PATCH] Note ACL substrings matching
</A></li>
        <LI>Next message: <A HREF="004110.html">[squid-dev] [RFC] on_crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4109">[ date ]</a>
              <a href="thread.html#4109">[ thread ]</a>
              <a href="subject.html#4109">[ subject ]</a>
              <a href="author.html#4109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    The attached patch modifies Squid to run /tmp/squid-on-fatal.sh on
fatal errors. A sample script is also attached. I needed this trick to
triage a complicated bug related to Squid shared memory usage.

In general, running such a script helps record the environment state
_before_ Squid exits, which is important when the problem is related to
Squid resource usage that often becomes invisible after the Squid
process is gone: connections, FDs, shared memory segments, etc.

The patch needs more work to make this behavior and the script name
squid.conf-configurable. We should also pass Squid PID and Squid process
&quot;role&quot; to the script as parameters so that the script does not have to
guess them.


Do you want this feature in Squid?

If yes, which squid.conf directive name do you think works the best?
Here are some options to consider:

on_crash ...
on_fatal_exit ..
on_bad_exit ...
on_unexpected_exit ...
on_exit &lt;success|failure&gt; ...

The directive parameter could be

  program=...
  handler=...

which would allow us to easily add more exit-handling options later if
needed (e.g., free_all_memory, keep_shared_memory, etc.).


Please note that Squid already does something similar on startup. See
squid_start_script in main.cc. That hack should be made configurable
too, of course (on_start, on_launch, etc.).


Thank you,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: on-fatal-t4.patch
Type: text/x-diff
Size: 2916 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151209/4ef52aa1/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151209/4ef52aa1/attachment.patch</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-on-fatal.sh
Type: application/x-sh
Size: 1490 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151209/4ef52aa1/attachment.sh">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151209/4ef52aa1/attachment.sh</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004404.html">[squid-dev] [PATCH] Note ACL substrings matching
</A></li>
	<LI>Next message: <A HREF="004110.html">[squid-dev] [RFC] on_crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4109">[ date ]</a>
              <a href="thread.html#4109">[ thread ]</a>
              <a href="subject.html#4109">[ subject ]</a>
              <a href="author.html#4109">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
