<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] on_crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20on_crash&In-Reply-To=%3C5668927E.5000307%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004111.html">
   <LINK REL="Next"  HREF="004114.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] on_crash</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20on_crash&In-Reply-To=%3C5668927E.5000307%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] on_crash">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  9 20:43:42 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004111.html">[squid-dev] [RFC] on_crash
</A></li>
        <LI>Next message: <A HREF="004114.html">[squid-dev] [RFC] on_crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4113">[ date ]</a>
              <a href="thread.html#4113">[ thread ]</a>
              <a href="subject.html#4113">[ subject ]</a>
              <a href="author.html#4113">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/12/2015 6:51 a.m., Alex Rousskov wrote:
&gt;<i> On 12/09/2015 10:29 AM, Kinkie wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>   this sounds like an useful feature, especially if we also manage to
</I>&gt;&gt;<i> include a sample/default crash handler.
</I>&gt;<i> 
</I>&gt;<i> A sample sounds good (the script I posted can be a good starting point
</I>&gt;<i> though it is far from perfect). There should probably be no default
</I>&gt;<i> script because crash handling needs vary a lot and because there are
</I>&gt;<i> probably security implications related to one.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Among the choices you provide I like &quot;on_fatal_exit&quot;; 
</I>&gt;<i> 
</I>&gt;<i> I am curious why you think on_crash is worse than on_fatal_exit?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I could also
</I>&gt;&gt;<i> suggest &quot;crash_handler&quot;, &quot;crash_helper&quot;, &quot;crash_report_collector&quot; or
</I>&gt;&gt;<i> somesuch.
</I>&gt;<i> 
</I>&gt;<i> IMO, we should use the &quot;on_&quot; prefix because it allows us to group many
</I>&gt;<i> simple options related to crash handling instead of focusing on the
</I>&gt;<i> handler alone (see my original post for examples). It is also a familiar
</I>&gt;<i> prefix for all sorts of event handlers.
</I>&gt;<i> 
</I>

I don't have much opinion either way right now. on_fatal / on_fatal_exit
seems fine.

Calling the binary bundled to do the job &quot;squid_crash_reporter&quot; seems
the right thing to do.


I am not going to +1 this right now, because the issues below are
security related. I would like to see at least one round of audit with
them resolved before it goes in.


As for the patch:

* function should be &quot;static void&quot; it seems.


* please never hard-code anything be executed from /tmp.
 - for security /tmp should always be considered to be under a remote
attackers control. The patch as-is enables a major vulnerability.
 - it should either default to not happening, or use a bundled
squid_crash_reporter binary installed alongside the other helpers.


* please do not use system() for this.

[sorry linking the draft, I can't seem to find the final PDF right now]
&lt;<A HREF="http://www.secologic.org/downloads/c/051207_EUROSEC_Draft_Whitepaper_Secure_C_Programming.doc">http://www.secologic.org/downloads/c/051207_EUROSEC_Draft_Whitepaper_Secure_C_Programming.doc</A>&gt;
&quot;
* Do not call a shell to invoke another program from within a C/C++
program.

&gt;<i>From within a C/C++ program it is possible to call a shell to invoke
</I>another program. This can be accomplished with function calls like
system() or popen(). Using such function calls opens a program to
attacks by modification of the environment (particularly by changing the
PATH and IFS variables). To avoid dependencies on the environment, usage
of execve() is recommended instead.

* To call another program from within a process use execve() or execle().

To call another program from within a process one of the exec functions
may be used. The functions execl(), execv(), execlp() and execvp() do
use the current environment when calling a new program, whereas execve()
and execle() do have an input argument for the new environment to be
used. As it is safe programming practice not to depend on the
environment, the execve() or execle() function calls should be used.
Moreover execlp() and execvp() evaluate the PATH environment variable to
find the called executable. This makes these function calls vulnerable
to attacks that change the PATH variable.
&quot;

I know we have a lot of system()/popen() legacy code hanging around. But
crash is one place we need to be extra careful.



For anyone thinking of bundling a helper for this please make the
reporter a binary. For the same reasons quoted above regarding system()
and environment contents. Also avoiding the speed (and memory) overheads
of bash/cash/ksh/python/php/whatever is a very good idea in these
situations.

Amos

</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004111.html">[squid-dev] [RFC] on_crash
</A></li>
	<LI>Next message: <A HREF="004114.html">[squid-dev] [RFC] on_crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4113">[ date ]</a>
              <a href="thread.html#4113">[ thread ]</a>
              <a href="subject.html#4113">[ subject ]</a>
              <a href="author.html#4113">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
