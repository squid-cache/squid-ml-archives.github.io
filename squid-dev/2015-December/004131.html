<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Fix%20shared%20memory%20initialization%2C%0A%20cleanup.%20Ensure%20its%20usability.&In-Reply-To=%3C5669A2FB.1010603%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004126.html">
   <LINK REL="Next"  HREF="004136.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Fix%20shared%20memory%20initialization%2C%0A%20cleanup.%20Ensure%20its%20usability.&In-Reply-To=%3C5669A2FB.1010603%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 10 16:06:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004126.html">[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
</A></li>
        <LI>Next message: <A HREF="004136.html">[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4131">[ date ]</a>
              <a href="thread.html#4131">[ thread ]</a>
              <a href="subject.html#4131">[ subject ]</a>
              <a href="author.html#4131">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/10/2015 01:53 AM, Amos Jeffries wrote:
&gt;<i> On 10/12/2015 1:24 p.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 12/09/2015 04:24 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 10/12/2015 10:49 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Questions: Should we add a configuration directive to control whether
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> mlock(2) is called? If yes, should mlock(2) be called by default?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Should mlock(2) failures be fatal?
</I>
&gt;&gt;&gt;&gt;&gt;<i> My answers are no, yes, yes. Since this is a startup thing squid.conf
</I>&gt;&gt;&gt;&gt;&gt;<i> post-processing is probably too late.
</I>

&gt;<i> It makes them &quot;maybe&quot;, no, yes.
</I>

&gt;<i> Though I am still not convinced exactly that squid.conf is the right
</I>&gt;<i> place. As I said before:
</I>&gt;<i> &quot;
</I>&gt;<i> In general if a setting is not something that can have a reasonable
</I>&gt;<i> temporary default for a while, then be switched around in realtime. Then
</I>&gt;<i> squid.conf is not a good place for it.
</I>
Yes, you said that, but (a) your precondition still does not quite match
the situation at hand:

* The &quot;perform mlock&quot; setting _has_ a reasonable default (i.e., yes, lock),

* that default can be overwritten to &quot;do not lock&quot; if the admin does not
want to lock, and

* the setting can even be switched around during reconfiguration (after
somebody adds support for reconfigurable shared storage, although the
change from no-lock to lock can be supported earlier);

and (b) I disagree with the overall decision logic you are proposing:
IMO, command line options should be limited to these two areas:

i. controlling Squid behavior before squid.conf is parsed.
ii. controlling another Squid instance (for legacy reasons).

Memory locking controls do not belong to the command line. And yes, many
current command line options violate the above, but that does not make
those violations good ideas and does not mean we should add more of them.


&gt;<i> I would make it mandatory on &quot;-k check&quot; (but not -k parse). Optional
</I>&gt;<i> through a command line parameter on all other runs.
</I>

I have two problems with the -k check approach:

1. -k check is documented to parse configuration and send a signal to
the already running Squid. To implement what you are proposing would
require also initializing Squid storage. Initializing Squid storage when
another Squid instance is running is either impossible (because it will
conflict with the existing instance) or would require a highly
customized code (to work around those conflicts) that will not fully
test what a freshly started Squid would experience. Finally, locking
memory on -k check may also swap out or even crash the running Squid
instance!

2. Since most folks do not run -k check, they will not be aware that
their Squid or OS is misconfigured and will suffer from the obscure
effects of that misconfiguration such as SIGBUS and segmentation fault
deaths.

Problem #2 affects the &quot;Optional through a command line parameter on all
other runs&quot; part as well.


&gt;<i> The other (default / normal) runs having it OFF by default, since the -k
</I>&gt;<i> check should have confirmed already that it is going to work.
</I>
Yes, but I do not think we should use -kcheck and can rely on -kcheck as
discussed in #1 and #2 above. If we want to avoid these SIGBUS problems
in old and new configurations, we should lock by default. I see no other
way.

We may, of course, decide that SIGBUS problems are not significant
enough to be worth avoiding, but it feels wrong to ship a proxy that can
easily crash in its default configuration just because we decided to
avoid a check preventing such crashes. I would rather ship a proxy that
starts slow when explicitly configured to use lots of shared memory.


Thank you,

Alex.
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004126.html">[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
</A></li>
	<LI>Next message: <A HREF="004136.html">[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4131">[ date ]</a>
              <a href="thread.html#4131">[ thread ]</a>
              <a href="subject.html#4131">[ subject ]</a>
              <a href="author.html#4131">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
