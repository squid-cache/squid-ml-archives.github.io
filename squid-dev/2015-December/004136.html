<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Fix%20shared%20memory%20initialization%2C%0A%20cleanup.%20Ensure%20its%20usability.&In-Reply-To=%3C5669C30B.9090401%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004131.html">
   <LINK REL="Next"  HREF="004137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Fix%20shared%20memory%20initialization%2C%0A%20cleanup.%20Ensure%20its%20usability.&In-Reply-To=%3C5669C30B.9090401%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 10 18:23:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004131.html">[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
</A></li>
        <LI>Next message: <A HREF="004137.html">[squid-dev] [RFC] Fix shared memory initialization,	cleanup. Ensure its usability.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4136">[ date ]</a>
              <a href="thread.html#4136">[ thread ]</a>
              <a href="subject.html#4136">[ subject ]</a>
              <a href="author.html#4136">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/12/2015 5:06 a.m., Alex Rousskov wrote:
&gt;<i> On 12/10/2015 01:53 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 10/12/2015 1:24 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 12/09/2015 04:24 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 10/12/2015 10:49 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Questions: Should we add a configuration directive to control whether
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> mlock(2) is called? If yes, should mlock(2) be called by default?
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Should mlock(2) failures be fatal?
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> My answers are no, yes, yes. Since this is a startup thing squid.conf
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> post-processing is probably too late.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> It makes them &quot;maybe&quot;, no, yes.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Though I am still not convinced exactly that squid.conf is the right
</I>&gt;&gt;<i> place. As I said before:
</I>&gt;&gt;<i> &quot;
</I>&gt;&gt;<i> In general if a setting is not something that can have a reasonable
</I>&gt;&gt;<i> temporary default for a while, then be switched around in realtime. Then
</I>&gt;&gt;<i> squid.conf is not a good place for it.
</I>&gt;<i> 
</I>&gt;<i> Yes, you said that, but (a) your precondition still does not quite match
</I>&gt;<i> the situation at hand:
</I>&gt;<i> 
</I>&gt;<i> * The &quot;perform mlock&quot; setting _has_ a reasonable default (i.e., yes, lock),
</I>&gt;<i> 
</I>&gt;<i> * that default can be overwritten to &quot;do not lock&quot; if the admin does not
</I>&gt;<i> want to lock, and
</I>&gt;<i> 
</I>&gt;<i> * the setting can even be switched around during reconfiguration (after
</I>&gt;<i> somebody adds support for reconfigurable shared storage, although the
</I>&gt;<i> change from no-lock to lock can be supported earlier);
</I>&gt;<i> 
</I>&gt;<i> and (b) I disagree with the overall decision logic you are proposing:
</I>&gt;<i> IMO, command line options should be limited to these two areas:
</I>&gt;<i> 
</I>&gt;<i> i. controlling Squid behavior before squid.conf is parsed.
</I>&gt;<i> ii. controlling another Squid instance (for legacy reasons).
</I>&gt;<i> 
</I>&gt;<i> Memory locking controls do not belong to the command line. And yes, many
</I>&gt;<i> current command line options violate the above, but that does not make
</I>&gt;<i> those violations good ideas and does not mean we should add more of them.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I would make it mandatory on &quot;-k check&quot; (but not -k parse). Optional
</I>&gt;&gt;<i> through a command line parameter on all other runs.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have two problems with the -k check approach:
</I>&gt;<i> 
</I>&gt;<i> 1. -k check is documented to parse configuration and send a signal to
</I>&gt;<i> the already running Squid. To implement what you are proposing would
</I>&gt;<i> require also initializing Squid storage. Initializing Squid storage when
</I>&gt;<i> another Squid instance is running is either impossible (because it will
</I>&gt;<i> conflict with the existing instance) or would require a highly
</I>&gt;<i> customized code (to work around those conflicts) that will not fully
</I>&gt;<i> test what a freshly started Squid would experience. Finally, locking
</I>&gt;<i> memory on -k check may also swap out or even crash the running Squid
</I>&gt;<i> instance!
</I>&gt;<i> 
</I>&gt;<i> 2. Since most folks do not run -k check, they will not be aware that
</I>&gt;<i> their Squid or OS is misconfigured and will suffer from the obscure
</I>&gt;<i> effects of that misconfiguration such as SIGBUS and segmentation fault
</I>&gt;<i> deaths.
</I>&gt;<i> 
</I>&gt;<i> Problem #2 affects the &quot;Optional through a command line parameter on all
</I>&gt;<i> other runs&quot; part as well.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The other (default / normal) runs having it OFF by default, since the -k
</I>&gt;&gt;<i> check should have confirmed already that it is going to work.
</I>&gt;<i> 
</I>&gt;<i> Yes, but I do not think we should use -kcheck and can rely on -kcheck as
</I>&gt;<i> discussed in #1 and #2 above. If we want to avoid these SIGBUS problems
</I>&gt;<i> in old and new configurations, we should lock by default. I see no other
</I>&gt;<i> way.
</I>&gt;<i> 
</I>&gt;<i> We may, of course, decide that SIGBUS problems are not significant
</I>&gt;<i> enough to be worth avoiding, but it feels wrong to ship a proxy that can
</I>&gt;<i> easily crash in its default configuration just because we decided to
</I>&gt;<i> avoid a check preventing such crashes. I would rather ship a proxy that
</I>&gt;<i> starts slow when explicitly configured to use lots of shared memory.
</I>&gt;<i> 
</I>
Okay. Good points, and some very good ones.


So it comes down to doing it your way and we will have to come up with
something to explain to confused admin why their proxies are now slow.

If we really have no choice in the matter (and you make a good case for
that being so). Then requiring an answer up front on what we will say is
not useful, just blocking progress. It is hard to pick any answer or
explanation in advance of knowing how bad the problem is (if at all),
and I dont think we should spend time trying to.

So is there anything else you need to discuss? or shall we wind up this
thread and wait to see what appears for audit?

Amos
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004131.html">[squid-dev] [RFC] Fix shared memory initialization, cleanup. Ensure its usability.
</A></li>
	<LI>Next message: <A HREF="004137.html">[squid-dev] [RFC] Fix shared memory initialization,	cleanup. Ensure its usability.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4136">[ date ]</a>
              <a href="thread.html#4136">[ thread ]</a>
              <a href="subject.html#4136">[ subject ]</a>
              <a href="author.html#4136">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
