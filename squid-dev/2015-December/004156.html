<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Log SSL Cryptography Parameters
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Log%20SSL%20Cryptography%20Parameters&In-Reply-To=%3C566DD90E.3040108%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004154.html">
   <LINK REL="Next"  HREF="004157.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Log SSL Cryptography Parameters</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Log%20SSL%20Cryptography%20Parameters&In-Reply-To=%3C566DD90E.3040108%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Log SSL Cryptography Parameters">christos at chtsanti.net
       </A><BR>
    <I>Sun Dec 13 20:46:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004154.html">[squid-dev] [PATCH] Log SSL Cryptography Parameters
</A></li>
        <LI>Next message: <A HREF="004157.html">[squid-dev] [PATCH] Log SSL Cryptography Parameters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4156">[ date ]</a>
              <a href="thread.html#4156">[ thread ]</a>
              <a href="subject.html#4156">[ subject ]</a>
              <a href="author.html#4156">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/13/2015 11:16 AM, Amos Jeffries wrote:
&gt;<i> On 11/12/2015 6:36 a.m., Christos Tsantilas wrote:
</I>&gt;&gt;<i> This patch adds the following formatting codes:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&gt;negotiated_version
</I>&gt;&gt;<i>    The SSL version of the client-to-Squid connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&lt;negotiated_version
</I>&gt;&gt;<i>    The SSL version of the Squid-to-server connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&gt;received_hello_version
</I>&gt;&gt;<i>    The SSL version of the Hello message received from SSL client
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&lt;received_hello_version
</I>&gt;&gt;<i>    The SSL version of the Hello message received from SSL server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&gt;received_supported_version
</I>&gt;&gt;<i>    The maximum SSL version supported by the the SSL client.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&lt;received_supported_version
</I>&gt;&gt;<i>    The maximum SSL version supported by the the SSL server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&gt;cipher
</I>&gt;&gt;<i>    The negotiated cipher of the client-to-Squid connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    %ssl::&lt;cipher
</I>&gt;&gt;<i>    The negotiated cipher of the Squid-to-server connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These are useful for statistics collection, security reviews, and
</I>&gt;&gt;<i> reviews prior to adjusting the list of the allowed SSL protocols and
</I>&gt;&gt;<i> ciphers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is a Measurement Factory project
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Looks good. But there are some minor issues to resolve.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> src/ssl/support.h:
</I>&gt;<i> * s/SSL/TLS/ in the new documentation
</I>
fixed in my new patch

&gt;<i>
</I>&gt;<i> * Can you please put this new class in libsecurity and the Security::
</I>&gt;<i> namespace?
</I>
The Security::NegotiationHistory class moved to 
security/NegotiationHistory.[cc,h] files

&gt;<i>
</I>&gt;<i> in src/ssl/support.cc:
</I>&gt;<i> * since printTlsVersion() is used in format codes that sometimes used
</I>&gt;<i> for HTTP headers, please make it output the IETF protocol-version
</I>&gt;<i> format. ie. protocol/major.minor
</I>
OK.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/comm/Connection.cc:
</I>&gt;<i> * tlsHistory is only sometime protected by USE_OPENSSL.
</I>&gt;<i>   - it should be defined in the .h as a void* for non-OpenSSL builds.
</I>&gt;<i> Which can avoid many of the wrappers.
</I>&gt;<i> - if you moved the class definitino to libsecurity it should always be
</I>&gt;<i> available anyway, so not need the wrappers in this code.
</I>
The &quot;#ifdef USE_OPENSSL/#endif&quot; removed from Connection.[cc,h] code.
Maybe we need it around the new methods and members, to same some bytes 
per connection object, if the squid did not compiled with SSL/TLS support

&gt;<i>
</I>&gt;<i> in src/comm/Connection.h:
</I>&gt;<i> * replace &quot;/** SSL conenction details*/&quot;
</I>&gt;<i>    with &quot;/// TLS connection details&quot;
</I>
fixed

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/SquidConfig.h
</I>&gt;<i> * logTlsServerHelloDetails should be bool type.
</I>
Fixed. It is the first bool type in Config classes.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/cf.data.pre:
</I>&gt;<i> * s/SSL/TLS/ Squid-4 no longer performs SSL.
</I>ok
However I must note that still accepts SSL hello messages.

&gt;<i>
</I>&gt;<i> * s/client-to-Squid/client/
</I>&gt;<i>
</I>&gt;<i> * s/Squid-to-server/last server or peer/
</I>
OK on this.



&gt;<i>
</I>&gt;<i> * please make the codes shorter. We still have to work within a
</I>&gt;<i> relatively short line length for the entire log format.
</I>
Well, I did not fix it in the new patch. We need the other developers 
opinion.

The short names does not improve the speed or something in operation.
However they confuses system admins when trying to read a logformat strings.
I am suggesting to keep the long names for logformat codes as is.


&gt;<i>
</I>&gt;<i> There also seems to be a lot of confusion over the meaning of &quot;SSL
</I>&gt;<i> version&quot; in the documentation.
</I>&gt;<i>   - I suggest:
</I>&gt;<i>
</I>&gt;<i>    %ssl::&lt;v - Negotiated TLS version on the client connection.
</I>&gt;<i>
</I>&gt;<i>    %ssl::&lt;cv - ClientHello message version received on the client connection.
</I>&gt;<i>
</I>&gt;<i>    %ssl::&lt;sv - ServerHello message version sent on the client connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    %ssl::&gt;v - Negotiated TLS version on the last server or peer connection.
</I>&gt;<i>
</I>&gt;<i>    %ssl::&gt;cv - ClientHello message version sent on the last server or
</I>&gt;<i> peer connection.
</I>&gt;<i>
</I>&gt;<i>    %ssl::&gt;sv - ServerHello message version received on the last server or
</I>&gt;<i> peer connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/format/ByteCode.h:
</I>&gt;<i> * s/LFT_SSL_/LFT_TLS_/ on the new codes.
</I>
This is fixed in new patch.

&gt;<i>
</I>&gt;<i> The codes so far have a bit of a naming convention:
</I>&gt;<i>
</I>&gt;<i>   LFT_(TLS|SSL)_(CLIENT|SERVER)_(LOCAL_)_FOO
</I>&gt;<i>
</I>&gt;<i> - CLIENT for client connection
</I>&gt;<i> - SERVER for server connection
</I>&gt;<i> - LOCAL_ for Squid details on the connection
</I>&gt;<i> - FOO for the FOO detail name
</I>
I disagree in this too..
- The client sends a Hello message

- The hello message version may be is SSLv2, or SSLv3 or TLS1.x. Or 
better this is the version of the SSL/TLS Record protocol includes the 
hello handshake message.

- The client Hello message includes the (maximum) supported TLS version 
by the client, which is not always the same as Hello (SSL/TLS record) 
message version.

- The server sends back hello server handshake message in an SSL/TLS 
record of version X, and which includes the supported TLS version Y by 
server.

The CLIENT, SERVER and LOCAL names are not enough to hold the above.
I believe that the current scheme is  better.

&gt;<i>
</I>&gt;<i> Then sorted by tag, so related things are grouped together.
</I>&gt;<i>
</I>&gt;<i> If you could follow that it would help readability.
</I>&gt;<i>
</I>&gt;<i> Which would mean:
</I>&gt;<i>    LFT_TLS_CLIENT_HELLO_VERSION       (%ssl:&lt;cv)
</I>&gt;<i>    LFT_TLS_CLIENT_LOCAL_HELLO_VERSION (%ssl:&lt;sv)
</I>&gt;<i>    LFT_TLS_CLIENT_NEGOTIATED_VERSION  (%ssl:&lt;v)
</I>&gt;<i>
</I>&gt;<i>    LFT_TLS_SERVER_HELLO_VERSION       (%ssl:&gt;sv)
</I>&gt;<i>    LFT_TLS_SERVER_LOCAL_HELLO_VERSION (%ssl:&gt;cv)
</I>&gt;<i>    LFT_TLS_SERVER_NEGOTIATED_VERSION  (%ssl:&gt;v)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/bio.cc:
</I>&gt;<i> * s/SSL/TLS/ - at least in the new documentation.
</I>
ok

&gt;<i>
</I>&gt;<i> * since you are changing the initialization list for
</I>&gt;<i> Ssl::Bio::sslFeatures::sslFeatures(), please make the entries one member
</I>&gt;<i> per line for easier reading.
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * Ssl::Bio::sslFeatures::parseMsgHead()
</I>&gt;<i>   - why is the SSL version parse being changed?
</I>&gt;<i>   - what was wrong with reporting the actual on-wire value given?
</I>&gt;<i>
</I>&gt;<i> -        sslVersion = (head[3] &lt;&lt; 8) | head[4];
</I>&gt;<i> +        sslHelloVersion = 0x0002;
</I>
This is code refers to a Hello message sent into an SSLv23 SSL record.
The maximum supported version (in head[3] and head[4] bytes) will be 
extracted latter in parseV23message.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/bio.h:
</I>&gt;<i> * s/SSL/TLS/ - at least in the new documentation.
</I>
ok
&gt;<i>
</I>&gt;<i> * receivedHelloFeatures_ says &quot;The futures received&quot;.
</I>&gt;<i>   - typo of &quot;features&quot; or are you actually documenting C++ futures
</I>&gt;<i> functionality usage?
</I>
..the future which will never come....


&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: Log-SSL-Cryptography-Parameters-t7.patch
Type: text/x-patch
Size: 58015 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151213/c0e5f5ff/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151213/c0e5f5ff/attachment-0001.bin</A>&gt;
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004154.html">[squid-dev] [PATCH] Log SSL Cryptography Parameters
</A></li>
	<LI>Next message: <A HREF="004157.html">[squid-dev] [PATCH] Log SSL Cryptography Parameters
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4156">[ date ]</a>
              <a href="thread.html#4156">[ thread ]</a>
              <a href="subject.html#4156">[ subject ]</a>
              <a href="author.html#4156">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
