<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] improve CharacterSet
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20improve%20CharacterSet&In-Reply-To=%3C567F43D4.3010205%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004432.html">
   <LINK REL="Next"  HREF="004434.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] improve CharacterSet</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20improve%20CharacterSet&In-Reply-To=%3C567F43D4.3010205%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] improve CharacterSet">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Dec 27 01:50:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004432.html">[squid-dev] [PATCH] improve CharacterSet
</A></li>
        <LI>Next message: <A HREF="004434.html">[squid-dev] [PATCH] improve CharacterSet
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4433">[ date ]</a>
              <a href="thread.html#4433">[ thread ]</a>
              <a href="subject.html#4433">[ subject ]</a>
              <a href="author.html#4433">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/26/2015 09:03 AM, Kinkie wrote:
&gt;<i> Hi all,
</I>&gt;<i>   the attached patch improves CharacterSet by adding a subtraction
</I>&gt;<i> operator, equality test and associated unit tests.
</I>

Perhaps this is different in C++11, but IIRC we are supposed to:

1. declare non-modifying operators such as &quot;-&quot; outside the class

2. declare an inequality operator &quot;!=&quot; when declaring an equality operator

For #1, you can claim code consistency as an excuse because the &quot;+&quot;
operator was already misplaced, but since no existing or proposed code
uses the new operators (AFAIK), it seems like it would be a good idea to
fix the wrong location before (or while) adding the new [unused] ones.


&gt;<i> +    if (this == &amp;c) // identity test
</I>&gt;<i> +        return true;
</I>
I would remove this check as unneeded unless you are sure that the
comparison with self is common enough to optimize for. If you keep this,
please s/identity test/optimization: fast comparison with self/ because
I do not think the term &quot;identity test&quot; is standard [enough] to be
recognized by many readers and googling it does not help.


&gt;<i> +    auto e=chars_.cend();
</I>&gt;<i> +    for (auto i = chars_.cbegin(), j = c.chars_.cbegin(); i != e; ++i, ++j) {
</I>&gt;<i> +        if (*i != *j)
</I>&gt;<i> +            return false;
</I>&gt;<i> +    }
</I>
Is the existing Storage::operator &quot;==&quot; so bad that we need to hand-roll
a loop [with a critical hidden assumption] like that? If hand-rolling is
needed, please at least add a comment that the code assumes that all
chars_ containers have the same length.


&gt;<i> +    /// remove all characters from the given CharacterSet to this one
</I>&gt;<i> +    CharacterSet &amp;operator -=(const CharacterSet &amp;src);
</I>
Please remove the &quot;to this one&quot; copy-paste typo.

I recommend rephrasing the description to document what happens when the
character cannot be removed because it is not in the &quot;this&quot; set. For
example:

/// set subtraction: remove all characters that are also in src


&quot;src&quot; is a weird name for the parameter subtraction operator argument.
You can cite code consistency as an excuse but consider using &quot;other&quot; or
perhaps something like &quot;banned&quot; instead.


&gt;<i>      /// return a new CharacterSet containing the union of two sets, labeled as the first argument
</I>&gt;<i>      CharacterSet operator +(const CharacterSet &amp;src) const;
</I>...
&gt;<i> +    /// return a new CharacterSet containing the set of characters in the first but not in the second
</I>&gt;<i> +    CharacterSet operator -(const CharacterSet &amp;src) const;
</I>

It is funny that you preserved many bad things but decided to drop
documentation about the label. Please add it.

Please note that neither the old operator &quot;+&quot; nor the new operator &quot;-&quot;
have two [explicit] arguments [until they are moved outside the class as
discussed in #1 above] so the comment using words &quot;first&quot; and &quot;second&quot;
is rather confusing!


&gt;<i> +static
</I>&gt;<i> +std::ostream&amp; operator&lt;&lt; (std::ostream &amp;s, const CharacterSet &amp;c)
</I>&gt;<i> +{
</I>&gt;<i> +    s &lt;&lt; &quot;CharacterSet(&quot; &lt;&lt; c.name &lt;&lt; ')';
</I>&gt;<i> +    return s;
</I>&gt;<i> +}
</I>&gt;<i> +
</I>
Perhaps this should be provided in the CharacterSet header, for all to
use? You would have to split the definition from the declaration to
avoid dragging iostream into the header, but this operator feels useful
to me, even in its current &quot;primitive&quot; form.


&gt;<i> -        for (int j = 0; j &lt; 255; ++j)
</I>&gt;<i> -            if (j != '0')
</I>&gt;<i> +        for (int j = 0; j &lt; 255; ++j) {
</I>&gt;<i> +            if (j != '0') {
</I>&gt;<i>                  CPPUNIT_ASSERT_EQUAL(false,t[j]);
</I>&gt;<i> +            } else {
</I>&gt;<i> +                CPPUNIT_ASSERT_EQUAL(true,t[j]);
</I>&gt;<i> +            }
</I>&gt;<i> +        }
</I>
If polishing this code is in scope, consider fixing the loop boundary as
well: There is nothing so special about character with codepoint 255 to
exclude it AFAICT.


&gt;<i> +void
</I>&gt;<i> +testCharacterSet::CharacterSetSubtract()
</I>&gt;<i> +{
</I>&gt;<i> +    CharacterSet sample(NULL, &quot;0123456789aAbBcCdDeEfFz&quot;);
</I>&gt;<i> +    sample -= CharacterSet(NULL, &quot;z&quot;);
</I>&gt;<i> +    CPPUNIT_ASSERT_EQUAL(CharacterSet::HEXDIG, sample);
</I>&gt;<i> +}
</I>

It would be good to have an A-B test where B has [some] characters not
present in A.

Since operator &quot;-&quot; operator is implemented using operator &quot;-=&quot; it may be
better to test the former (if we have to pick between testing one or the
other).


HTH,

Alex.

</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004432.html">[squid-dev] [PATCH] improve CharacterSet
</A></li>
	<LI>Next message: <A HREF="004434.html">[squid-dev] [PATCH] improve CharacterSet
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4433">[ date ]</a>
              <a href="thread.html#4433">[ thread ]</a>
              <a href="subject.html#4433">[ subject ]</a>
              <a href="author.html#4433">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
