<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] implement RFC3986
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20implement%20RFC3986&In-Reply-To=%3C56816770.1090302%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004461.html">
   <LINK REL="Next"  HREF="004464.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] implement RFC3986</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20implement%20RFC3986&In-Reply-To=%3C56816770.1090302%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] implement RFC3986">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Dec 28 16:46:40 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004461.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
        <LI>Next message: <A HREF="004464.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4463">[ date ]</a>
              <a href="thread.html#4463">[ thread ]</a>
              <a href="subject.html#4463">[ subject ]</a>
              <a href="author.html#4463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/28/2015 07:01 AM, Kinkie wrote:

&gt;<i>   the attached patch is meant to implement rfc3986, and eventually
</I>&gt;<i> supersede rfc1738, which is not API-compatible with.
</I>
I am only commenting on the code itself, not the RFC 3986 support idea.


&gt;<i> +static int
</I>&gt;<i> +fromhex(char ch)
</I>
...

&gt;<i> +// return a static 2-char buffer with a hex representation of argument
</I>&gt;<i> +static char*
</I>&gt;<i> +tohex(const unsigned char c)
</I>
Please do not add global static functions to header files unless
actually needed. Use inline instead to avoid duplicating these functions
in every file that includes this header.


&gt;<i> +// duplicate from rfc1738.c
</I>&gt;<i> +static int
</I>&gt;<i> +fromhex(char ch)
</I>
Missing description. &quot;Duplicate of some private function in some
scheduled-for-removal(?) C file&quot; is not a description.


&gt;<i> +static int
</I>&gt;<i> +fromhex(char ch)
</I>&gt;<i> +{
</I>&gt;<i> +    if (ch &gt;= '0' &amp;&amp; ch &lt;= '9')
</I>&gt;<i> +        return ch - '0';
</I>&gt;<i> +    if (ch &gt;= 'a' &amp;&amp; ch &lt;= 'f')
</I>&gt;<i> +        return ch - 'a' + 10;
</I>&gt;<i> +    if (ch &gt;= 'A' &amp;&amp; ch &lt;= 'F')
</I>&gt;<i> +        return ch - 'A' + 10;
</I>&gt;<i> +    return -1;
</I>&gt;<i> +}
</I>
If you are after performance, an unconditional lookup in a 256-member
int vector would be faster.


&gt;<i> +// return a static 2-char buffer with a hex representation of argument
</I>&gt;<i> +static char*
</I>&gt;<i> +tohex(const unsigned char c)
</I>&gt;<i> +{
</I>&gt;<i> +    static char rv[3];
</I>&gt;<i> +    (void) snprintf ( rv, 3, &quot;%02X&quot;, c);
</I>&gt;<i> +    return rv;
</I>&gt;<i> +}
</I>
If you are after performance, an unconditional lookup in a 256-member
char* vector would be much faster.

If you can return a const pointer, please return a const pointer.


&gt;<i> +    for (auto in = s.begin(); in != e; ++in) {
</I>&gt;<i> +        if (*in != '%') { // normal case, copy and continue
</I>&gt;<i> +            rv.push_back(*in);
</I>&gt;<i> +            continue;
</I>&gt;<i> +        }
</I>...

I cannot validate that low-level C code. Can you use a Tokenizer
instead? Is it critical to provide copy-less performance for helpers
using std::string instead of SBuf?



&gt;<i> +class RFC3986 {
</I>&gt;<i> +public:
</I>&gt;<i> +    const static CharacterSet
</I>&gt;<i> +        Unsafe,  // RFC 1738 unsafe set
</I>&gt;<i> +        Ctrls,   // control characters (\0x00 to \0x1f)
</I>&gt;<i> +        UnsafeAndCtrls, // RFC 1738 Unsafe and Ctrls
</I>&gt;<i> +        Reserved1738, // RFC 1738 Reserved set
</I>&gt;<i> +        GenDelims,// RFC 3986 gen-delims set
</I>&gt;<i> +        SubDelims,// RFC 3986 sub-delims set
</I>&gt;<i> +        Reserved, // RFC 3986 reserved characters set
</I>&gt;<i> +        Unreserved, // RFC 3986 unreserved characters set
</I>&gt;<i> +        Unescaped,//ctrls and unsafe except for percent symbol
</I>&gt;<i> +        All;
</I>&gt;<i> +
</I>&gt;<i> +};
</I>
This is not a class but a namespace.

Please s/RFC3986/Rfc3986/ for consistency with similar &quot;let's group RFC
concepts in one namespace&quot; SslBump code posted by Christos earlier (IIRC).



&gt;<i> +template &lt;class String&gt;
</I>&gt;<i> +String rfc3986_escape(const String &amp;s, const CharacterSet &amp;escapeChars = RFC3986::UnsafeAndCtrls)
</I>
Describe and place inside the Rfc3986 namespace as &quot;Escape()&quot;. There may
be other names that you may want to add to the Rfc3986 namespace (I have
not checked).


&gt;<i> +const CharacterSet
</I>&gt;<i> +    RFC3986::Unsafe(&quot;rfc1738:unsafe&quot;, &quot;&lt;&gt;\&quot;# %{}|\\^~[]`'&quot;),
</I>&gt;<i> +    RFC3986::Ctrls(&quot;rfc1738:ctrls&quot;, {{0x00, 0x1f}, {0x7f,0xff}}),
</I>&gt;<i> +    RFC3986::Reserved1738(&quot;rfc1738:reserved&quot;, &quot;;/?:@=&amp;&quot;),
</I>...
&gt;<i> +    RFC3986::Unescaped = (UnsafeAndCtrls - CharacterSet(nullptr,&quot;%&quot;) ).rename(&quot;rfc1738:unescaped&quot;),
</I>

If these are RFC 1738 sequences, why place them in the RFC 3986 namespace?


&gt;<i> === added file 'include/rfc3986.h'
</I>...
&gt;<i> +#include &quot;base/CharacterSet.h&quot;
</I>
This is not my area of expertise, but including src/base/CharacterSet.h
into include/ files looks very wrong: Code that needs
src/base/CharacterSet, should live in src/ IMHO.


&gt;<i> +/* Being a C library code it is best bodily included and tested with C++ type-safe techniques. */
</I>&gt;<i> +#include &quot;lib/rfc3986.cc&quot;
</I>
lib/rfc3986.cc is not a C library code. This looks like a dirty hack to
work around some linking problems due to misplaced rfc3986.cc file.


&gt;<i> +    // bugs.
</I>&gt;<i> +    void PercentZeroNullDecoding();
</I>&gt;<i> +    void testPerformance();
</I>
Not sure what this misplaced description means. Are we adding bugs?


HTH,

Alex.

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004461.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
	<LI>Next message: <A HREF="004464.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4463">[ date ]</a>
              <a href="thread.html#4463">[ thread ]</a>
              <a href="subject.html#4463">[ subject ]</a>
              <a href="author.html#4463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
