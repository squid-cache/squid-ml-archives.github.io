<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] SBuf API improvements
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SBuf%20API%20improvements&In-Reply-To=%3CCA%2BY8hcN3xHNDfNQ-OsduTds0eeB_pyJ-WvaYAWGrGhak7RAKoA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004465.html">
   <LINK REL="Next"  HREF="004470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] SBuf API improvements</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SBuf%20API%20improvements&In-Reply-To=%3CCA%2BY8hcN3xHNDfNQ-OsduTds0eeB_pyJ-WvaYAWGrGhak7RAKoA%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] SBuf API improvements">gkinkie at gmail.com
       </A><BR>
    <I>Tue Dec 29 21:59:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004465.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
        <LI>Next message: <A HREF="004470.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4469">[ date ]</a>
              <a href="thread.html#4469">[ thread ]</a>
              <a href="subject.html#4469">[ subject ]</a>
              <a href="author.html#4469">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Dec 28, 2015 at 10:27 PM, Alex Rousskov
&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 12/28/2015 06:41 AM, Kinkie wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>   the attached patch is a proposal for a couple of small extensions to
</I>&gt;&gt;<i> SBuf, which are meant to make it more API-compatible with std::string.
</I>&gt;<i>
</I>&gt;<i> ... as well as increase the probability of callers using the wrong SBuf
</I>&gt;<i> API as discussed below.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> - it adds a &quot;fill&quot; operator: append(size_type n, char c)
</I>&gt;&gt;<i> - it aliases append(char) to push_back(char)
</I>&gt;<i>
</I>&gt;<i> If this change goes forward, I recommend removing our custom
</I>&gt;<i> append(char) because it conflicts with the other &quot;standard&quot; append,
</I>&gt;<i> increasing API confusion:
</I>
Sure, can do.
It will probably look funny in chaining code, but that's not different
from std::string, e.g.:
SBuf s;
s.append(&quot;string&quot;).push_back('c').append(&quot;another string&quot;);

&gt;<i>
</I>&gt;<i>   string&amp; append(const char* s);
</I>&gt;<i>
</I>&gt;<i> The old append(char) calling code would need to be adjusted to call
</I>&gt;<i> push_back(), of course.
</I>
Of course.

&gt;<i>
</I>&gt;&gt;<i> - it aliases reserveCapacity to reserve
</I>&gt;<i>
</I>&gt;<i> The standard reserve() has a default argument value of zero. Yours does
</I>&gt;<i> not. If you want compatibility, you have to provide that default IMO.
</I>
Ok, done. If reserve() is called with no arguments, il'll be a no-op,
but that's consistent with the documentaiton I found.

&gt;&gt;<i> It is debateable whether reserveCapacity should be just renamed
</I>&gt;&gt;<i> instead of aliased; feedback is welcome.
</I>&gt;<i>
</I>&gt;<i> I do not have a strong opinion on this. reserveCapacity() is not called
</I>&gt;<i> reserve() today because we also have reserveSpace() and knowing that
</I>&gt;<i> there are two different methods is important for some callers. Once you
</I>&gt;<i> add plain reserve(), the probability that a caller will notice
</I>&gt;<i> reserveSpace() that the caller needs will go down.
</I>
We could leave both and mark in the documentation that it's meant for
API compatibility and should not be used by code calling SBuf. what do
you think?

&gt;&gt;<i> The objective of this change will be clear in the followup rfc3986
</I>&gt;&gt;<i> patch, which is templatized in order to be available both to helpers
</I>&gt;&gt;<i> who use std::string and to squid using SBuf.
</I>&gt;<i>
</I>&gt;<i> SBuf is already suffering from being too many things to too many
</I>&gt;<i> different callers. I suspect that requiring API compatibility with
</I>&gt;<i> std::string [in certain poorly defined areas] will make the situation
</I>&gt;<i> worse, but I cannot prove that. Same for writing templated code that can
</I>&gt;<i> work with both std::string and SBuf.
</I>&gt;<i>
</I>&gt;<i> If helpers really need SBuf, give them SBuf. If helpers want to use
</I>&gt;<i> std::string, they already can. Assuring that one can be substituted with
</I>&gt;<i> another feels like a false goal that would bring more trouble in the
</I>&gt;<i> long run than it would help in the short term. Again, I cannot prove
</I>&gt;<i> that and will not veto these changes.
</I>
helpers do not need SBuf, in fact they don't want it, they need
percent-encoding and a c++ string management system.
 The main benefit of SBuf over std::string is its integration with
support infrastructure in squid proper (mempools and cachemgr), which
is definitely too much to add to helpers as well. We'd end up filling
them with stubs which would make maintaining the build system
complicated - see how much effort it is to do so for unit tests.

So IMO helpers need std::string, and templated code is the best
solution I could come up with to avoid having to maintain three
different implementations of percent-encoding. Suggestions on
alternate paths to obtain the same objective are of course welcome.

As you don't veto the code, but neither approve it; are there others
willing to add their thoughts?

Thanks
(I've implemented some of the changes but won't push a patch until
open points have been closed. Thanks)

-- 
    Francesco
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004465.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
	<LI>Next message: <A HREF="004470.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4469">[ date ]</a>
              <a href="thread.html#4469">[ thread ]</a>
              <a href="subject.html#4469">[ subject ]</a>
              <a href="author.html#4469">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
