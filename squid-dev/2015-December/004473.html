<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] SBuf API improvements
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SBuf%20API%20improvements&In-Reply-To=%3CCA%2BY8hcNnkUH82iAwRknw3KPtWXOKXhL5a2OO97H5%3Dn1AWuAJfw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004472.html">
   <LINK REL="Next"  HREF="004476.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] SBuf API improvements</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SBuf%20API%20improvements&In-Reply-To=%3CCA%2BY8hcNnkUH82iAwRknw3KPtWXOKXhL5a2OO97H5%3Dn1AWuAJfw%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] SBuf API improvements">gkinkie at gmail.com
       </A><BR>
    <I>Wed Dec 30 16:05:30 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="004472.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
        <LI>Next message: <A HREF="004476.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4473">[ date ]</a>
              <a href="thread.html#4473">[ thread ]</a>
              <a href="subject.html#4473">[ subject ]</a>
              <a href="author.html#4473">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
  I've implemented the API shuffling I described earlier, and it is
quite a self-contained change.
I'm submitting it, as it makes sense regardless of the &quot;use SBuf for
helpers&quot; discussion (don't be fooled by the size of the attachment,
it's due to the big context).

On Wed, Dec 30, 2015 at 11:42 AM, Kinkie &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">gkinkie at gmail.com</A>&gt; wrote:
&gt;<i> On Wed, Dec 30, 2015 at 1:01 AM, Alex Rousskov
</I>&gt;<i> &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 12/29/2015 02:59 PM, Kinkie wrote:
</I>&gt;&gt;&gt;<i> On Mon, Dec 28, 2015 at 10:27 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> On 12/28/2015 06:41 AM, Kinkie wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> It is debateable whether reserveCapacity should be just renamed
</I>&gt;&gt;&gt;&gt;&gt;<i> instead of aliased; feedback is welcome.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I do not have a strong opinion on this. reserveCapacity() is not called
</I>&gt;&gt;&gt;&gt;<i> reserve() today because we also have reserveSpace() and knowing that
</I>&gt;&gt;&gt;&gt;<i> there are two different methods is important for some callers. Once you
</I>&gt;&gt;&gt;&gt;<i> add plain reserve(), the probability that a caller will notice
</I>&gt;&gt;&gt;&gt;<i> reserveSpace() that the caller needs will go down.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We could leave both and mark in the documentation that it's meant for
</I>&gt;&gt;&gt;<i> API compatibility and should not be used by code calling SBuf. what do
</I>&gt;&gt;&gt;<i> you think?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Having three methods (reserve, reserveCapacity, and reserveSpace) is a
</I>&gt;&gt;<i> poor solution to the problem that the two methods (reserveCapacity and
</I>&gt;&gt;<i> reserveSpace) were solving. Yes, adding a not-to-be-used third name
</I>&gt;&gt;<i> might be better than renaming the existing one, but, again, the overall
</I>&gt;&gt;<i> direction of your changes eliminates good options, forcing you to pick
</I>&gt;&gt;<i> among the bad ones.
</I>&gt;<i>
</I>&gt;<i> Ok, next option. reserveSpace(n) is actually just
</I>&gt;<i> reserveCapacity(n+length()); what about simply getting rid of
</I>&gt;<i> reserveSpace and rename reserveCapacity to reserve? Minimum surprise
</I>&gt;<i> here for users here.
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The objective of this change will be clear in the followup rfc3986
</I>&gt;&gt;&gt;&gt;&gt;<i> patch, which is templatized in order to be available both to helpers
</I>&gt;&gt;&gt;&gt;&gt;<i> who use std::string and to squid using SBuf.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> SBuf is already suffering from being too many things to too many
</I>&gt;&gt;&gt;&gt;<i> different callers. I suspect that requiring API compatibility with
</I>&gt;&gt;&gt;&gt;<i> std::string [in certain poorly defined areas] will make the situation
</I>&gt;&gt;&gt;&gt;<i> worse, but I cannot prove that. Same for writing templated code that can
</I>&gt;&gt;&gt;&gt;<i> work with both std::string and SBuf.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If helpers really need SBuf, give them SBuf. If helpers want to use
</I>&gt;&gt;&gt;&gt;<i> std::string, they already can. Assuring that one can be substituted with
</I>&gt;&gt;&gt;&gt;<i> another feels like a false goal that would bring more trouble in the
</I>&gt;&gt;&gt;&gt;<i> long run than it would help in the short term. Again, I cannot prove
</I>&gt;&gt;&gt;&gt;<i> that and will not veto these changes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> helpers do not need SBuf, in fact they don't want it, they need
</I>&gt;&gt;&gt;<i> percent-encoding and a c++ string management system.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I doubt that all helpers are the same with regard to string needs. Many
</I>&gt;&gt;<i> helpers do not need C++ at all. I assume that you are thinking about
</I>&gt;&gt;<i> helpers maintained by the Squid Project and helpers that we decided to
</I>&gt;&gt;<i> make very efficient and tightly integrated with Squid code.
</I>&gt;<i>
</I>&gt;<i> Yes. Although I wouldn't call them &quot;tightly integrated&quot; but simply
</I>&gt;<i> &quot;bundled&quot;. What I'm trying to do is to make them more readable, secure
</I>&gt;<i> and adaptable first by using c++ in place of the c-with-thin-c++-paint
</I>&gt;<i> they currently are coded as. Making them more maintainable, hopefully
</I>&gt;<i> robust and readable is the main goal. In fact, as we can assume that
</I>&gt;<i> they will be used as reference by others writing their own helpers,
</I>&gt;<i> it's in everyone's best interests if they are as readable and compact
</I>&gt;<i> as possible.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> The main benefit of SBuf over std::string is its integration with
</I>&gt;&gt;&gt;<i> support infrastructure in squid proper (mempools and cachemgr), which
</I>&gt;&gt;&gt;<i> is definitely too much to add to helpers as well. We'd end up filling
</I>&gt;&gt;&gt;<i> them with stubs which would make maintaining the build system
</I>&gt;&gt;&gt;<i> complicated - see how much effort it is to do so for unit tests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I certainly agree that it is easier to add a few methods to SBuf and
</I>&gt;&gt;<i> craft a templated encoding loop than it is to make SBufs independent
</I>&gt;&gt;<i> from memory pools [and cache manager]. The ease of a small change does
</I>&gt;&gt;<i> not necessarily make it the best long-term solution though. There are
</I>&gt;&gt;<i> other factors to consider.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You use existing unit test build difficulties as an argument to avoid
</I>&gt;&gt;<i> using SBufs in helpers [because helpers will face similar difficulties].
</I>&gt;&gt;<i> That argument is valid _if_ those build difficulties are inherent in the
</I>&gt;&gt;<i> SBuf concept. However, if those difficulties are simply SBuf
</I>&gt;&gt;<i> implementation bugs/deficiencies, then it would be better to address
</I>&gt;&gt;<i> those SBuf deficiencies than to work around [and exacerbate!] them in
</I>&gt;&gt;<i> one more place.
</I>&gt;<i>
</I>&gt;<i> Let's consider mempools for instance. Having a build-time, static,
</I>&gt;<i> mechanism which can prevent linking against mempools is IMO tricky and
</I>&gt;<i> fragile; and mempools carry with them a lot of extra depedencies (e.g.
</I>&gt;<i> squid_curtime - it's simple but pervasive).
</I>&gt;<i> Currently the minimum set for linking against SBuf outside Squid is:
</I>&gt;<i> base/CharacterSet.{h,cc}
</I>&gt;<i> base/InstanceId.h
</I>&gt;<i> MemBlob.{h,cc}
</I>&gt;<i> OutOfBoundsException.h
</I>&gt;<i> SBuf.{h,cc}
</I>&gt;<i> SBufExceptions.{h,cc}
</I>&gt;<i> tests/stub_debug.cc
</I>&gt;<i> tests/stub_libmem.cc
</I>&gt;<i> tests/stub_SBufDetailedStats.cc
</I>&gt;<i> base/libbase.la
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> So IMO helpers need std::string,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and Perl $string, and Javascript String. There are many different
</I>&gt;&gt;<i> helpers with very different needs...
</I>&gt;<i>
</I>&gt;<i> right. Let me restrict the scope to &quot;the C-ish and C++ helpers we bundle&quot;
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> and templated code is the best
</I>&gt;&gt;&gt;<i> solution I could come up with to avoid having to maintain three
</I>&gt;&gt;&gt;<i> different implementations of percent-encoding. Suggestions on
</I>&gt;&gt;&gt;<i> alternate paths to obtain the same objective are of course welcome.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since Squid is (or should be) using standard encodings, I suspect there
</I>&gt;&gt;<i> are libraries and modules (for various programming languages) that
</I>&gt;&gt;<i> already provide appropriate encoding support. We would not have to
</I>&gt;&gt;<i> maintain any of those implementations.
</I>&gt;<i>
</I>&gt;<i> There are. However:
</I>&gt;<i> - the ones I could find seem to be quite generic, we have different
</I>&gt;<i> needs in different contexts
</I>&gt;<i> - impedence mismatch. These are either C or use std::string; this
</I>&gt;<i> generally means two more data-copies if we wish to use SBuf (or
</I>&gt;<i> std::string with a custom allocator)
</I>&gt;<i> - finding one which is generally available on all OSes we care about
</I>&gt;<i> seems not trivial.
</I>&gt;<i> - if we don't find one, IIRC bundling was already discarded as an
</I>&gt;<i> option when talking about relying on boost.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> However, let's assume that our ultimate goal[1] is to ship fast,
</I>&gt;&gt;<i> production-quality helpers that are built without external dependencies
</I>&gt;&gt;<i> (i.e., built using Squid libraries) and that Squid code is (or will be)
</I>&gt;&gt;<i> using SBuf for most string and buffering operations.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Quality helpers are likely to need a variety of string and buffering
</I>&gt;&gt;<i> operations. Which of the following approaches is better long-term?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A. Support a growing number of templated algorithms while making SBuf
</I>&gt;&gt;<i> API more and more interchangeable with std::string (while at the same
</I>&gt;&gt;<i> time providing a growing number of SBuf methods for raw buffer operations).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> B. Make SBufs and SBuf-driven algorithms easily available in helpers by
</I>&gt;&gt;<i> making SBuf storage/memory backing (and any other current dependencies
</I>&gt;&gt;<i> on Squid core) easily replaceable with something that does not need any
</I>&gt;&gt;<i> integration with Squid core.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To me, option B looks like the right overall direction.
</I>&gt;<i>
</I>&gt;<i> Could be, but we'd then need to redesign mempools to be stub-able, or
</I>&gt;<i> templatize SBuf with an allocator and isolate it from mempools (I
</I>&gt;<i> focus on these as these are the dependency bringing in most baggage.
</I>&gt;<i>
</I>&gt;<i> Given the fact that we won't probably require many common algorithms,
</I>&gt;<i> I believe that A is not a bad an option as you do.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i>     Francesco
</I>


-- 
    Francesco
-------------- next part --------------
A non-text attachment was scrubbed...
Name: sbuf-improvements-v2.patch
Type: text/x-diff
Size: 25045 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151230/a14b2ed1/attachment-0001.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151230/a14b2ed1/attachment-0001.patch</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004472.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
	<LI>Next message: <A HREF="004476.html">[squid-dev] [PATCH] SBuf API improvements
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4473">[ date ]</a>
              <a href="thread.html#4473">[ thread ]</a>
              <a href="subject.html#4473">[ subject ]</a>
              <a href="author.html#4473">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
