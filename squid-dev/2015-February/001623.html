<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20sslproxy_options%20in%20peek-and-splice%20mode&In-Reply-To=%3C54DB40F3.1010304%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001617.html">
   <LINK REL="Next"  HREF="001625.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20sslproxy_options%20in%20peek-and-splice%20mode&In-Reply-To=%3C54DB40F3.1010304%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Wed Feb 11 11:45:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001617.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
        <LI>Next message: <A HREF="001625.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1623">[ date ]</a>
              <a href="thread.html#1623">[ thread ]</a>
              <a href="subject.html#1623">[ subject ]</a>
              <a href="author.html#1623">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/11/2015 01:54 AM, Amos Jeffries wrote:
&gt;<i> On 9/02/2015 6:43 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> Bug description:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - Squid sslproxy_options deny the use of TLSv1_2 SSL protocol:
</I>&gt;&gt;<i>             sslproxy_options NO_TLSv1_2
</I>&gt;&gt;<i>    - Squid uses peek mode for bumped connections.
</I>&gt;&gt;<i>    - Web client sends an TLSv1_2 hello message and squid in peek mode,
</I>&gt;&gt;<i> forwards the client hello message to server
</I>&gt;&gt;<i>    - Web server respond with an TLSv1_2 hello message
</I>&gt;&gt;<i>    - Squid while parsing server hello message aborts with an error
</I>&gt;&gt;<i> because  sslproxy_options deny the use ot TLSv1_2 protocol.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This patch fixes squid to ignore sslproxy_options in peek or stare
</I>&gt;&gt;<i> bumping mode.
</I>&gt;<i>
</I>&gt;<i> As I understand it the action of applying the options to the context
</I>&gt;<i> removes from the context cipher references etc which are not possible.
</I>&gt;<i>
</I>&gt;<i> Since peek and stare are non-final states I can easily imagine that
</I>&gt;<i> OpenSSL library negotiates ciphers which the options would otherwise
</I>&gt;<i> prohibit. Then when the options get applied to the context it find
</I>&gt;<i> itself using an algorithm which does not exist.
</I>
The context SSL_CTX objects are bases to create the SSL objects which 
are responsible for the negotiation with the other side (server in this 
case).
The SSL created, inherits the options from CTXa nd we are adding our 
options to SSL object.
The SSL library will use these options to build client hello message, 
parse server hello message and select algorithms/ciphers and other 
features to establish SSL connection.

In my patch the options applied to the squid client SSL objects 
immediately after created, in the case of bump-server-first, or 
bump-client-first.

In the cases of peek or stare we are not setting any options. This is 
because we are sending a hello message which is the same or similar with 
the client hello message, so we can not apply options. Else the peek or 
stare will fail...

This is has as result that we can not control the ssl behaviour in peek 
or stare mode. But it is not easy to do anything else...
Maybe we can add 1-2 new configurations parameter which control the 
behaviour. But this is a different project...

Regards,
    Christos


&gt;<i>
</I>&gt;<i> So what happens during the final state in that type of event?
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i>
</I>
</PRE>



















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001617.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
	<LI>Next message: <A HREF="001625.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1623">[ date ]</a>
              <a href="thread.html#1623">[ thread ]</a>
              <a href="subject.html#1623">[ subject ]</a>
              <a href="author.html#1623">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
