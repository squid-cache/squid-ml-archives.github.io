<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20sslproxy_options%20in%20peek-and-splice%20mode&In-Reply-To=%3C54DBB21C.2000103%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001623.html">
   <LINK REL="Next"  HREF="001630.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20sslproxy_options%20in%20peek-and-splice%20mode&In-Reply-To=%3C54DBB21C.2000103%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb 11 19:48:44 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001623.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
        <LI>Next message: <A HREF="001630.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1625">[ date ]</a>
              <a href="thread.html#1625">[ thread ]</a>
              <a href="subject.html#1625">[ subject ]</a>
              <a href="author.html#1625">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/02/2015 12:45 a.m., Tsantilas Christos wrote:
&gt;<i> On 02/11/2015 01:54 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 9/02/2015 6:43 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;<i> Bug description:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>    - Squid sslproxy_options deny the use of TLSv1_2 SSL protocol:
</I>&gt;&gt;&gt;<i>             sslproxy_options NO_TLSv1_2
</I>&gt;&gt;&gt;<i>    - Squid uses peek mode for bumped connections.
</I>&gt;&gt;&gt;<i>    - Web client sends an TLSv1_2 hello message and squid in peek mode,
</I>&gt;&gt;&gt;<i> forwards the client hello message to server
</I>&gt;&gt;&gt;<i>    - Web server respond with an TLSv1_2 hello message
</I>&gt;&gt;&gt;<i>    - Squid while parsing server hello message aborts with an error
</I>&gt;&gt;&gt;<i> because  sslproxy_options deny the use ot TLSv1_2 protocol.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This patch fixes squid to ignore sslproxy_options in peek or stare
</I>&gt;&gt;&gt;<i> bumping mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As I understand it the action of applying the options to the context
</I>&gt;&gt;<i> removes from the context cipher references etc which are not possible.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since peek and stare are non-final states I can easily imagine that
</I>&gt;&gt;<i> OpenSSL library negotiates ciphers which the options would otherwise
</I>&gt;&gt;<i> prohibit. Then when the options get applied to the context it find
</I>&gt;&gt;<i> itself using an algorithm which does not exist.
</I>&gt;<i> 
</I>&gt;<i> The context SSL_CTX objects are bases to create the SSL objects which
</I>&gt;<i> are responsible for the negotiation with the other side (server in this
</I>&gt;<i> case).
</I>&gt;<i> The SSL created, inherits the options from CTXa nd we are adding our
</I>&gt;<i> options to SSL object.
</I>&gt;<i> The SSL library will use these options to build client hello message,
</I>&gt;<i> parse server hello message and select algorithms/ciphers and other
</I>&gt;<i> features to establish SSL connection.
</I>&gt;<i> 
</I>&gt;<i> In my patch the options applied to the squid client SSL objects
</I>&gt;<i> immediately after created, in the case of bump-server-first, or
</I>&gt;<i> bump-client-first.
</I>&gt;<i> 
</I>&gt;<i> In the cases of peek or stare we are not setting any options. This is
</I>&gt;<i> because we are sending a hello message which is the same or similar with
</I>&gt;<i> the client hello message, so we can not apply options. Else the peek or
</I>&gt;<i> stare will fail...
</I>&gt;<i> 
</I>
What I means is the code flow is roughly like this yes?

1) bump
2) splice
3) peek then bump
4) stare then bump
5) peek then splice
6) stare then splice

In which of those cases are the options set?
 all cases ending in bump or splice.

Also, for this bug to have occured at all means the server SSL_CTX is
being actively used during the peek/stare steps.

So what can possibly go wrong by changing the CTX cipher sets halfway
through case 3, 4, 5, 6 ?




&gt;<i> This is has as result that we can not control the ssl behaviour in peek
</I>&gt;<i> or stare mode. But it is not easy to do anything else...
</I>&gt;<i> Maybe we can add 1-2 new configurations parameter which control the
</I>&gt;<i> behaviour. But this is a different project...
</I>
I agree we should do the not-setting-options. What I'm having issues
with is how it appears that they are set later - which could be just
adding a different problem.

Amos
</PRE>



















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001623.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
	<LI>Next message: <A HREF="001630.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1625">[ date ]</a>
              <a href="thread.html#1625">[ thread ]</a>
              <a href="subject.html#1625">[ subject ]</a>
              <a href="author.html#1625">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
