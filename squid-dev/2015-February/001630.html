<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20sslproxy_options%20in%20peek-and-splice%20mode&In-Reply-To=%3C54DC80E8.5080804%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001625.html">
   <LINK REL="Next"  HREF="001631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20sslproxy_options%20in%20peek-and-splice%20mode&In-Reply-To=%3C54DC80E8.5080804%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Thu Feb 12 10:31:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001625.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
        <LI>Next message: <A HREF="001631.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1630">[ date ]</a>
              <a href="thread.html#1630">[ thread ]</a>
              <a href="subject.html#1630">[ subject ]</a>
              <a href="author.html#1630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/11/2015 09:48 PM, Amos Jeffries wrote:
&gt;<i> On 12/02/2015 12:45 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> On 02/11/2015 01:54 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 9/02/2015 6:43 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;<i> Bug description:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>     - Squid sslproxy_options deny the use of TLSv1_2 SSL protocol:
</I>&gt;&gt;&gt;&gt;<i>              sslproxy_options NO_TLSv1_2
</I>&gt;&gt;&gt;&gt;<i>     - Squid uses peek mode for bumped connections.
</I>&gt;&gt;&gt;&gt;<i>     - Web client sends an TLSv1_2 hello message and squid in peek mode,
</I>&gt;&gt;&gt;&gt;<i> forwards the client hello message to server
</I>&gt;&gt;&gt;&gt;<i>     - Web server respond with an TLSv1_2 hello message
</I>&gt;&gt;&gt;&gt;<i>     - Squid while parsing server hello message aborts with an error
</I>&gt;&gt;&gt;&gt;<i> because  sslproxy_options deny the use ot TLSv1_2 protocol.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> This patch fixes squid to ignore sslproxy_options in peek or stare
</I>&gt;&gt;&gt;&gt;<i> bumping mode.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As I understand it the action of applying the options to the context
</I>&gt;&gt;&gt;<i> removes from the context cipher references etc which are not possible.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Since peek and stare are non-final states I can easily imagine that
</I>&gt;&gt;&gt;<i> OpenSSL library negotiates ciphers which the options would otherwise
</I>&gt;&gt;&gt;<i> prohibit. Then when the options get applied to the context it find
</I>&gt;&gt;&gt;<i> itself using an algorithm which does not exist.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The context SSL_CTX objects are bases to create the SSL objects which
</I>&gt;&gt;<i> are responsible for the negotiation with the other side (server in this
</I>&gt;&gt;<i> case).
</I>&gt;&gt;<i> The SSL created, inherits the options from CTXa nd we are adding our
</I>&gt;&gt;<i> options to SSL object.
</I>&gt;&gt;<i> The SSL library will use these options to build client hello message,
</I>&gt;&gt;<i> parse server hello message and select algorithms/ciphers and other
</I>&gt;&gt;<i> features to establish SSL connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In my patch the options applied to the squid client SSL objects
</I>&gt;&gt;<i> immediately after created, in the case of bump-server-first, or
</I>&gt;&gt;<i> bump-client-first.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In the cases of peek or stare we are not setting any options. This is
</I>&gt;&gt;<i> because we are sending a hello message which is the same or similar with
</I>&gt;&gt;<i> the client hello message, so we can not apply options. Else the peek or
</I>&gt;&gt;<i> stare will fail...
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What I means is the code flow is roughly like this yes?
</I>&gt;<i>
</I>&gt;<i> 1) bump
</I>&gt;<i> 2) splice
</I>&gt;<i> 3) peek then bump
</I>&gt;<i> 4) stare then bump
</I>&gt;<i> 5) peek then splice
</I>&gt;<i> 6) stare then splice
</I>&gt;<i>
</I>&gt;<i> In which of those cases are the options set?
</I>&gt;<i>   all cases ending in bump or splice.
</I>
The important factor here is the bumping step.
in bump case (1,3,4)
  - if the decision is to bump in bumpStep1 or bumpStep2 then the squid 
SSL client options are set.
  - If the decision for bumping taken in bumpStep3, the the squid SSL 
client options are NOT set.

in splice case (2,5 or 6) :
  -  if we splice on bumpStep1 or on bumpStep2, then we are not using 
squid SSL client code at all, so the options does not play any  role on 
this case.
  - If we splice on bumpStep3 we have use squid SSL client, but in this 
case the options are not set.


After the bumpStep2 completed we have received the client hello message, 
but we do not sent any response (server hello). At the same time we are 
starting to initiate the connection to the SSL server. This is mean that 
we are going to set SSL client hello message which is depends on SSL 
client code. So:
   - If we know that we will going to bump the connection, we can safely 
set SSL client options. This is because the squid SSL client will 
initiate a normal SSL connection.
   - If we are going to stare, or peek then the client hello message we 
are going to sent must be similar to the client-to-squid SSL hello 
message. In this case we can not control SSL features using options, 
else the SSL negotiation will fail.



&gt;<i>
</I>&gt;<i> Also, for this bug to have occured at all means the server SSL_CTX is
</I>&gt;<i> being actively used during the peek/stare steps.
</I>
The SSL_CTX is an object which holds predefined settings and options for 
SSL objects.
This patch sets the options for the SSL object not the SSL_CTX options.
&gt;<i>
</I>&gt;<i> So what can possibly go wrong by changing the CTX cipher sets halfway
</I>&gt;<i> through case 3, 4, 5, 6 ?
</I>
We are not changing anything in SSL_CTX object

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> This is has as result that we can not control the ssl behaviour in peek
</I>&gt;&gt;<i> or stare mode. But it is not easy to do anything else...
</I>&gt;&gt;<i> Maybe we can add 1-2 new configurations parameter which control the
</I>&gt;&gt;<i> behaviour. But this is a different project...
</I>&gt;<i>
</I>&gt;<i> I agree we should do the not-setting-options. What I'm having issues
</I>&gt;<i> with is how it appears that they are set later - which could be just
</I>&gt;<i> adding a different problem.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i>
</I>
</PRE>

















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001625.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
	<LI>Next message: <A HREF="001631.html">[squid-dev] [PATCH] sslproxy_options in peek-and-splice mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1630">[ date ]</a>
              <a href="thread.html#1630">[ thread ]</a>
              <a href="subject.html#1630">[ subject ]</a>
              <a href="author.html#1630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
