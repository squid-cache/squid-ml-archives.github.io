<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [MERGE] Fix splay
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BMERGE%5D%20Fix%20splay&In-Reply-To=%3C54A67FF9.6080208%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000974.html">
   <LINK REL="Next"  HREF="000976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [MERGE] Fix splay</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BMERGE%5D%20Fix%20splay&In-Reply-To=%3C54A67FF9.6080208%40treenet.co.nz%3E"
       TITLE="[squid-dev] [MERGE] Fix splay">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jan  2 11:24:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="000974.html">[squid-dev] [MERGE] Fix splay
</A></li>
        <LI>Next message: <A HREF="000976.html">[squid-dev] [MERGE] Fix splay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#975">[ date ]</a>
              <a href="thread.html#975">[ thread ]</a>
              <a href="subject.html#975">[ subject ]</a>
              <a href="author.html#975">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 2/01/2015 11:25 p.m., Kinkie wrote:
&gt;<i> Hi, splay uses lots of C-isms still, which make recent clang fail
</I>&gt;<i> the build badly.
</I>&gt;<i> 
</I>&gt;<i> Things like: SplayNode&lt;foo&gt; *root = NULL root-&gt;insert(data)
</I>&gt;<i> 
</I>&gt;<i> The attached patch : - migrates all clients from using the
</I>&gt;<i> now-private SplayNode API to Splay - fixes Splay to account for
</I>&gt;<i> some corner-cases - removes always-true or always-false
</I>&gt;<i> conditionals in SplayNode (if (this == NULL)) - ports parts of the
</I>&gt;<i> unit test (most were not ported assuming the aim is to test the
</I>&gt;<i> private API)
</I>&gt;<i> 
</I>&gt;<i> This builds and checks fine on ubuntu utopic with gcc and clang
</I>&gt;<i> (clang halts the build on a similar issue in src/comm/Read.cc but
</I>&gt;<i> that's another topic).
</I>&gt;<i> 
</I>&gt;<i> Public branch is at lp:~squid/squid/splayfix
</I>&gt;<i> 
</I>&gt;<i> To me this is a reasonable merge candidate; please review.
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>

I believe this is missing several &quot;delete Foo;&quot; in the ACL
destructors. You used new() to allocate the Splay&lt;&gt; objects, there
should be matching delete() at the same owner/abstraction level.
For example:
&quot;
 ACLIP::~ACLIP()
 {
    if (data) {
        data-&gt;destroy(IPSplay::DefaultFree);
        data-&gt;destroy();
        delete data;
     }
 }
&quot;
... although, it would be even better if the data members could be
made non-pointers now they are Splay&lt;&gt; objects. Is that easy enough to
do in this patch ?


Please dont leave empty lines lying around. Like this one in
src/acl/Ip.h that was before the &quot;private:&quot;
&quot;
     IPSplay *data;

- -private:
- -    static void DumpIpListWalkee(acl_ip_data * const &amp; ip, void *state);
 };
&quot;
 ... there are also empty lines being added like at the top of
include/splay.h:
&quot;
 #include &lt;stack&gt;

+
+// private class of Splay. Do not use directly
&quot;


in test-suite/splay.cc:
* s/oher/other/


Other than the new() / delete() issue. +1.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUpn/5AAoJELJo5wb/XPRjHBEH/jSJmWgLn7hJNE11x22zxySy
zrlkcDt7MgFCID6bEDvJO27cmQIw+30yfx58pSYkQkyc5dI3xNmRrPyucUrBo6ih
zT11q8BhG/0I4XYVKuS6OhGxLwFIILqwEFL2szQ10XKgiJyhNaBbDXnrJZ+KFVOZ
srDgEwpGr3W1xp18riQX283VyX8n9vRpzGUa0GavHao8bqCGOuiKlGUc/aEXKMPz
S8aZ5eYBRhN6tuVhj41QpcdRBvmk/MfLS52v8EgH7+IBFT2gQyrkKikTERkqOCdn
tLDRDYoKAjavjrf7gdllXiZyrcMeBCyOSVjTWWrU48OYSK9UKrE+WfjiuxBCJJo=
=hxLW
-----END PGP SIGNATURE-----
</PRE>












































































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000974.html">[squid-dev] [MERGE] Fix splay
</A></li>
	<LI>Next message: <A HREF="000976.html">[squid-dev] [MERGE] Fix splay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#975">[ date ]</a>
              <a href="thread.html#975">[ thread ]</a>
              <a href="subject.html#975">[ subject ]</a>
              <a href="author.html#975">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
