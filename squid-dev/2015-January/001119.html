<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] adapting 100-Continue / A Bug 4067 fix
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20adapting%20100-Continue%20/%20A%20Bug%204067%20fix&In-Reply-To=%3C54AD1A0E.2010609%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001118.html">
   <LINK REL="Next"  HREF="001189.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] adapting 100-Continue / A Bug 4067 fix</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20adapting%20100-Continue%20/%20A%20Bug%204067%20fix&In-Reply-To=%3C54AD1A0E.2010609%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] adapting 100-Continue / A Bug 4067 fix">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Wed Jan  7 11:35:42 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001118.html">[squid-dev] [RFC] remove-splay branch
</A></li>
        <LI>Next message: <A HREF="001189.html">[squid-dev] [PATCH] adapting 100-Continue / A Bug 4067 fix
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1119">[ date ]</a>
              <a href="thread.html#1119">[ thread ]</a>
              <a href="subject.html#1119">[ subject ]</a>
              <a href="author.html#1119">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 01/01/2015 01:47 AM, Alex Rousskov wrote:
&gt;<i> On 11/09/2014 02:02 PM, Tsantilas Christos wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>   void
</I>&gt;&gt;<i>   Http::Server::processParsedRequest(ClientSocketContext *context)
</I>&gt;&gt;<i>   {
</I>&gt;&gt;<i> +    if (!buildHttpRequest(context))
</I>&gt;&gt;<i> +        return;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +    if (Config.accessList.forceRequestBodyContinuation) {
</I>&gt;&gt;<i> +        ClientHttpRequest *http = context-&gt;http;
</I>&gt;&gt;<i> +        HttpRequest *request = http-&gt;request;
</I>&gt;&gt;<i> +        ACLFilledChecklist bodyContinuationCheck(Config.accessList.forceRequestBodyContinuation, request, NULL);
</I>&gt;&gt;<i> +        if (bodyContinuationCheck.fastCheck() == ACCESS_ALLOWED) {
</I>&gt;&gt;<i> +            debugs(33, 5, &quot;Body Continuation forced&quot;);
</I>&gt;&gt;<i> +            request-&gt;forcedBodyContinuation = true;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The HTTP code above sends 100-Continue responses to HTTP GET messages
</I>&gt;<i> unless the admin is very careful with the ACLs. This can be reproduced
</I>&gt;<i> trivially with
</I>&gt;<i>
</I>&gt;<i>    force_request_body_continuation allow all
</I>&gt;<i>
</I>&gt;<i> We should not evaluate force_request_body_continuation if the request
</I>&gt;<i> does not have a body IMO. The force_request_body_continuation
</I>&gt;<i> documentation makes that option specific to upload requests. If you
</I>&gt;<i> agree, please adjust the committed code accordingly.
</I>
:<i>-(
</I>
I am attaching a patch which fixes this. The patch attached in both 
normal form and &quot;-b&quot; diff option to allow squid developers examine the 
proposed changes.

In my patch I am moving the check for &quot;Expect: 100-Continue&quot; header from 
clientProcessRequest() (located in client_side.cc file), which checks 
for valid Expect header values, to Http::Server::processParsedRequest 
method to minimise the required checks.

  I believe this relocation is valid because this check is needed only 
for HTTP protocol. For FTP protocol the Expect header is generated by 
squid and is not possible to include not supported values.

Alternately we can just check if &quot;Expect: 100-continue&quot; header exist 
inside Http::Server::processParsedRequest.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The similar FTP check seems to be inside the upload-specific code and,
</I>&gt;<i> hence, should not need additional &quot;do we expect a body?&quot; guards.
</I>
Yep.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: HTTP-100-Continue-forceRequestBodyContinuation-bug-diff-b-t1.patch
Type: text/x-patch
Size: 3295 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150107/704709dd/attachment-0002.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150107/704709dd/attachment-0002.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: HTTP-100-Continue-forceRequestBodyContinuation-bug-t1.patch
Type: text/x-patch
Size: 6871 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150107/704709dd/attachment-0003.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150107/704709dd/attachment-0003.bin</A>&gt;
</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001118.html">[squid-dev] [RFC] remove-splay branch
</A></li>
	<LI>Next message: <A HREF="001189.html">[squid-dev] [PATCH] adapting 100-Continue / A Bug 4067 fix
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1119">[ date ]</a>
              <a href="thread.html#1119">[ thread ]</a>
              <a href="subject.html#1119">[ subject ]</a>
              <a href="author.html#1119">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
