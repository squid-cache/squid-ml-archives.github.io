<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moved PID file management from Coordinator to Master
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B2AC8F.5040906%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001128.html">
   <LINK REL="Next"  HREF="001135.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moved PID file management from Coordinator to Master</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B2AC8F.5040906%40users.sourceforge.net%3E"
       TITLE="[squid-dev] Moved PID file management from Coordinator to Master">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Sun Jan 11 17:02:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001128.html">[squid-dev] Build failed in Jenkins: trunk-matrix » gcc,rs-fbsd-10 #11
</A></li>
        <LI>Next message: <A HREF="001135.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1129">[ date ]</a>
              <a href="thread.html#1129">[ thread ]</a>
              <a href="subject.html#1129">[ subject ]</a>
              <a href="author.html#1129">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,
  this patch moves pid file managment from coordinator process to master 
process.

This move is the first step necessary to avoid the following race 
condition among PID file deletion and shared segment 
creation/destruction in SMP Squid:

   O1) The old Squid Coordinator removes its PID file and quits.
   N1) The system script notices Coordinator death and starts the new Squid.
   N2) Shared segments are created by the new Master process.
   O2) Shared segments are removed by the old Master process.
   N3) New worker/disker processes fail due to missing segments.

TODO: The second step (not a part of this change) is to delete shared 
memory segments before PID file is deleted (all in the Master process 
after this change).

Now the Master process receives signals and is responsible for 
forwarding them to the kids.

Please for more informations read the patch preamble.

This is a Measurement Factory project


Some extra notes/ideas
--------------------------

1) Multiple shutdown signals received by squid

  In current squid when coordinator received a shutdown signal, then 
replaced shutdown signal handlers with the default handlers. This is has 
as result when a second shutdown signal received then the coordinator 
process died immediately, without forwarding shutdown signal to kids. 
The shutdown of the other kids are finished as normal.

   This patch when master process receives a shutdown signal forward it 
to kids and master process is ready to receive a second shutdown signal. 
When a second shutdown signal received to master and this forwarded to 
kids then the kids died immediately.


2) The system admin shows a blocked kid (infinity loop or not 
responding). He kill with the hand.

   Current squid does not restart the kids killed by a TERM or KILL 
signal (squid considers it as normal kid shutdown).
This patch does not change this behaviour. The admin is still able to 
kill with a &quot;kill -11&quot; and in this case the kid will restarted.

My opinion is that squid should restart kids in these cases. Should not 
restart a kid only when a shutdown requested from system admin, or when 
the kids dying very fast (hopeless()==true ).

Regards,
    Christos
-------------- next part --------------
A non-text attachment was scrubbed...
Name: move-PID-file-management-to-Master-t6.patch
Type: text/x-patch
Size: 35594 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150111/40b1d3e2/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150111/40b1d3e2/attachment-0001.bin</A>&gt;
</PRE>









































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001128.html">[squid-dev] Build failed in Jenkins: trunk-matrix » gcc,rs-fbsd-10 #11
</A></li>
	<LI>Next message: <A HREF="001135.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1129">[ date ]</a>
              <a href="thread.html#1129">[ thread ]</a>
              <a href="subject.html#1129">[ subject ]</a>
              <a href="author.html#1129">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
