<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moved PID file management from Coordinator to Master
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B402D7.1090802%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001129.html">
   <LINK REL="Next"  HREF="001147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moved PID file management from Coordinator to Master</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B402D7.1090802%40treenet.co.nz%3E"
       TITLE="[squid-dev] Moved PID file management from Coordinator to Master">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jan 12 17:22:31 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001129.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
        <LI>Next message: <A HREF="001147.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1135">[ date ]</a>
              <a href="thread.html#1135">[ thread ]</a>
              <a href="subject.html#1135">[ subject ]</a>
              <a href="author.html#1135">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 12/01/2015 6:02 a.m., Tsantilas Christos wrote:
&gt;<i> Hi all, this patch moves pid file managment from coordinator
</I>&gt;<i> process to master process.
</I>&gt;<i> 
</I>&gt;<i> This move is the first step necessary to avoid the following race 
</I>&gt;<i> condition among PID file deletion and shared segment 
</I>&gt;<i> creation/destruction in SMP Squid:
</I>&gt;<i> 
</I>&gt;<i> O1) The old Squid Coordinator removes its PID file and quits. N1)
</I>&gt;<i> The system script notices Coordinator death and starts the new
</I>&gt;<i> Squid. N2) Shared segments are created by the new Master process. 
</I>&gt;<i> O2) Shared segments are removed by the old Master process. N3) New
</I>&gt;<i> worker/disker processes fail due to missing segments.
</I>&gt;<i> 
</I>
The Coordinator needs to continue coordinating activities over the SMP
sockets until the workers are all shutdown and SMP sockets closed,
only then should it do O2 and O1 (in that order).

The planned behaviour for worker shutdown is to:
 W1) early client FD closures into the beginning of the
shutdown_timeout period
 W2) on each client closure or connection going idle, close it
 W3) at end of shutdown_timeout OR last client disconnect, release all
resources.

In that design the AsyncEngine still runs right up until the queue
completes draining. Using SMP sockets to inform Coordinator about
clean shutdown at the end.
The Master process has no way to know if the workers are exiting early
with no clients, or aborting on worker-specific shutdown_timeout
values. But the coordinator can receive a terminated message from them
over SMP sockets.


&gt;<i> TODO: The second step (not a part of this change) is to delete
</I>&gt;<i> shared memory segments before PID file is deleted (all in the
</I>&gt;<i> Master process after this change).
</I>&gt;<i> 
</I>&gt;<i> Now the Master process receives signals and is responsible for 
</I>&gt;<i> forwarding them to the kids.
</I>
The command line control process also used manually for the -k options
 to send signals also thinks of itself as Master.

How does this new closing of SMP sockets interact with that other
meaning of Master process?



&gt;<i> 
</I>&gt;<i> Please for more informations read the patch preamble.
</I>&gt;<i> 
</I>&gt;<i> This is a Measurement Factory project
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Some extra notes/ideas --------------------------
</I>&gt;<i> 
</I>&gt;<i> 1) Multiple shutdown signals received by squid
</I>&gt;<i> 
</I>&gt;<i> In current squid when coordinator received a shutdown signal, then 
</I>&gt;<i> replaced shutdown signal handlers with the default handlers. This
</I>&gt;<i> is has as result when a second shutdown signal received then the
</I>&gt;<i> coordinator process died immediately, without forwarding shutdown
</I>&gt;<i> signal to kids. The shutdown of the other kids are finished as
</I>&gt;<i> normal.
</I>&gt;<i> 
</I>&gt;<i> This patch when master process receives a shutdown signal forward
</I>&gt;<i> it to kids and master process is ready to receive a second shutdown
</I>&gt;<i> signal. When a second shutdown signal received to master and this
</I>&gt;<i> forwarded to kids then the kids died immediately.
</I>
Plan was to pass the signal to workers again where they kick off their
own shutdown_timeout event handlers immediately instead of hard
killing workers.

FWIW: Ubuntu Gentoo, and RHEL people are enjoying their patches that
just ignore the repeated signals.


&gt;<i> 
</I>&gt;<i> 2) The system admin shows a blocked kid (infinity loop or not 
</I>&gt;<i> responding). He kill with the hand.
</I>&gt;<i> 
</I>&gt;<i> Current squid does not restart the kids killed by a TERM or KILL 
</I>&gt;<i> signal (squid considers it as normal kid shutdown). This patch does
</I>&gt;<i> not change this behaviour. The admin is still able to kill with a
</I>&gt;<i> &quot;kill -11&quot; and in this case the kid will restarted.
</I>&gt;<i> 
</I>&gt;<i> My opinion is that squid should restart kids in these cases. Should
</I>&gt;<i> not restart a kid only when a shutdown requested from system admin,
</I>&gt;<i> or when the kids dying very fast (hopeless()==true ).
</I>
TERM and KILL received by the workers often *are* signals sent by the
system admin, or scripts on their behalf. That may decrease in
popularity though when we fix the normal shutdown process issues. For
a while longer we have to take the current reality.




In related topics, I have been trying to figure out a --foreground
command line option that operates like -N but does not disable SMP,
just makes Coordinator == Master. But understanding the SMP
complexities have been blocking me so far.  Are you able and
interested in taking that forward?

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUtALXAAoJELJo5wb/XPRjwKsIAMPzuOaxvC7WpBHOpQZpG1IZ
1tgbtosaJu3JweE7At729HLL34mR+YagaJbTz4xF6c2mkpLxxYioT6IzSxKc6YCD
mYJr8WU8uuJVI662u7w+3UyLVLI+c3vIwrw8d8NDZaKyAkOIn//Xks9YIG7h+xse
ooK/AAhMaADiS5S1FqY9OM3Q5Pn0nI3R91EpzGIeL1U5bG+43GYiOic3YSKgxSzq
8Q3YemiLj7ex00ZBtCbQ955bB8Zz1Q9I8hWgXdAFHgQKrjNmjdUDHqEg5M6E33zf
Gwpr6M3bO1gbtp7ize9vX7YxIlUjK6TUsbOFPlt9QJYEzzVxoqcgzy0lavVEiXE=
=5Qeg
-----END PGP SIGNATURE-----
</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001129.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
	<LI>Next message: <A HREF="001147.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1135">[ date ]</a>
              <a href="thread.html#1135">[ thread ]</a>
              <a href="subject.html#1135">[ subject ]</a>
              <a href="author.html#1135">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
