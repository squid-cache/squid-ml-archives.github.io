<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bug%20fixes%20for%20mingw%20based%20on%0A%09squid-3.5.0.4-20150106-r13714&In-Reply-To=%3C54B41BF6.3090305%40infologika.com.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001165.html">
   <LINK REL="Next"  HREF="001140.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714</H1>
    <B>Dennis</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bug%20fixes%20for%20mingw%20based%20on%0A%09squid-3.5.0.4-20150106-r13714&In-Reply-To=%3C54B41BF6.3090305%40infologika.com.br%3E"
       TITLE="[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714">dennis at infologika.com.br
       </A><BR>
    <I>Mon Jan 12 19:09:42 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001165.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
        <LI>Next message: <A HREF="001140.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1137">[ date ]</a>
              <a href="thread.html#1137">[ thread ]</a>
              <a href="subject.html#1137">[ subject ]</a>
              <a href="author.html#1137">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Dear Sirs

I tried compiling squid-3.5.0.4-20150106-r13714 running under windows 
with wingw

It still had a few bugs. I fixed them and now it compiles and runs, but 
still can't resolve addresses (I have correctly specified the name servers).
I get:
  WARNING: Reply from unknown nameserver [::]:53

I don't have more time to work it further.

I would like to contribute with the fixes I wrote. Here are them.

Obs.: the diff shows squid-3.5.0.4 against 
squid-3.5.0.4-20150106-r13714, but it is actually my 
squid-3.5.0.4-20150106-r13714 against squid-3.5.0.4-20150106-r13714

configure command used:
./configure --enable-default-hostsfile=none --prefix=C:/msys/1.0/squid
mingw version: latest 32 bit.

diffs:


diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\os\mswindows.h 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\os\mswindows.h
625,630c624,629
&lt; /* commen out this function
&lt; inline char *
&lt; inet_ntop(int af, const void *src, char *dst, size_t size)
&lt; {
&lt;     return (char*)InetNtopA(af, const_cast&lt;void*&gt;(src), dst, size);
&lt; }
&lt; #define inet_ntop(a,s,d,l) Squid::inet_ntop(a,s,d,l) */
---
 &gt; inline char *
 &gt; inet_ntop(int af, const void *src, char *dst, size_t size)
 &gt; {
 &gt;     return (char*)InetNtopA(af, const_cast&lt;void*&gt;(src), dst, size);
 &gt; }
 &gt; #define inet_ntop(a,s,d,l) Squid::inet_ntop(a,s,d,l)


***************************

diff -r C:\msys\1.0\var\squid-3.5.0.4\helpers\basic_auth\SSPI\valid.h 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\helpers\basic_auth\SSPI\valid.h
41d40
&lt; typedef HANDLE SERVICE_STATUS_HANDLE;
74c73
&lt; static const char *__foo;
---
 &gt; static char *__foo;
95d93
&lt; int Valid_User(char *,char *, char *);


****************************


diff -r 
C:\msys\1.0\var\squid-3.5.0.4\helpers\external_acl\LM_group\ext_lm_group_acl.ccC:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\helpers\external_acl\LM_group\ext_lm_group_acl.cc
95d94
&lt; typedef HANDLE SERVICE_STATUS_HANDLE;


**************************************

diff -r 
C:\msys\1.0\var\squid-3.5.0.4\helpers\ntlm_auth\SSPI\ntlm_sspi_auth.cc 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\helpers\ntlm_auth\SSPI\ntlm_sspi_auth.cc
82d81
&lt; typedef HANDLE SERVICE_STATUS_HANDLE;



*********************

squid-3.5.0.4-20150106-r13714

diff getaddrinfo.cc
26d25
&lt; #include &quot;../src/debug.h&quot;
85c84
&lt;     ret = (addrinfo*) malloc (sizeof (struct addrinfo));
---
 &gt;     ret = malloc (sizeof (struct addrinfo));
89c88
&lt;     ret-&gt;ai_addr = (sockaddr*) malloc (addrlen);
---
 &gt;     ret-&gt;ai_addr = malloc (addrlen);
180c179
&lt;         if (inet_pton(result.ai_family, nodename, &amp;sin.sin_addr) != 1)
---
 &gt;         if (inet_pton(result.ai_family, nodename, &amp;sin.sin_addr))
281c280
&lt;         sai-&gt;ai_canonname = (char *) malloc (strlen (hp-&gt;h_name) + 1);
---
 &gt;         sai-&gt;ai_canonname = malloc (strlen (hp-&gt;h_name) + 1);

*****************

diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\getnameinfo.cc 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\getnameinfo.cc
151c151,159
&lt; int xgetnameinfo(const struct sockaddr *sa, socklen_t salen, char 
*host, size_t hostlen, char *serv, size_t servlen, int flags)
---
 &gt; int
 &gt; xgetnameinfo(sa, salen, host, hostlen, serv, servlen, flags)
 &gt; const struct sockaddr *sa;
 &gt; socklen_t salen;
 &gt; char *host;
 &gt; size_t hostlen;
 &gt; char *serv;
 &gt; size_t servlen;
 &gt; int flags;


******************

diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\inet_ntop.cc 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\inet_ntop.cc
97,98c97,98
&lt; const char *inet_ntop4 (const u_char *src, char *dst, size_t size);
&lt; const char *inet_ntop6 (const u_char *src, char *dst, size_t size);
---
 &gt; static const char *inet_ntop4 (const u_char *src, char *dst, size_t 
size);
 &gt; static const char *inet_ntop6 (const u_char *src, char *dst, size_t 
size);
107,112c108,113
&lt; const char *
&lt; xinet_ntop(af, src, dst, size)
&lt; int af;
&lt; const void *src;
&lt; char *dst;
&lt; size_t size;
---
 &gt; const char *
 &gt; xinet_ntop(af, src, dst, size)
 &gt; int af;
 &gt; const void *src;
 &gt; char *dst;
 &gt; size_t size;
114d113
&lt; const char * xinet_ntop(int af, const void *src, char * dst, size_t size)
118c117
&lt;         return (inet_ntop4((const u_char*) src, dst, size));
---
 &gt;         return (inet_ntop4(src, dst, size));
120c119
&lt;         return (inet_ntop6((const u_char*) src, dst, size));
---
 &gt;         return (inet_ntop6(src, dst, size));
138,142c138,142
&lt; static const char *
&lt; inet_ntop4(src, dst, size)
&lt; const u_char *src;
&lt; char *dst;
&lt; size_t size;
---
 &gt; static const char *
 &gt; inet_ntop4(src, dst, size)
 &gt; const u_char *src;
 &gt; char *dst;
 &gt; size_t size;
144d142
&lt; const char * inet_ntop4( const u_char *src, char *dst, size_t size)
149c147
&lt;     if ((size_t) snprintf(tmp, min(sizeof(&quot;255.255.255.255&quot;),size), 
fmt, src[0], src[1], src[2], src[3]) &gt;= size) {
---
 &gt;     if (snprintf(tmp, min(sizeof(&quot;255.255.255.255&quot;),size), fmt, 
src[0], src[1], src[2], src[3]) &gt;= size) {
162,166c161,165
&lt; static const char *
&lt; inet_ntop6(src, dst, size)
&lt; const u_char *src;
&lt; char *dst;
&lt; size_t size;
---
 &gt; static const char *
 &gt; inet_ntop6(src, dst, size)
 &gt; const u_char *src;
 &gt; char *dst;
 &gt; size_t size;
168d165
&lt; const char * inet_ntop6( const u_char *src, char *dst, size_t size)


***************

diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\inet_pton.cc 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\inet_pton.cc
106c106,110
&lt; int xinet_pton( int af, const char *src, void *dst)
---
 &gt; int
 &gt; xinet_pton(af, src, dst)
 &gt; int af;
 &gt; const char *src;
 &gt; void *dst;
110c114
&lt;         return (inet_pton4(src, (u_char*) dst));
---
 &gt;         return (inet_pton4(src, dst));
112c116
&lt;         return (inet_pton6(src, (u_char*) dst));
---
 &gt;         return (inet_pton6(src, dst));
130c134,137
&lt; static int inet_pton4( const char *src, u_char *dst)
---
 &gt; static int
 &gt; inet_pton4(src, dst)
 &gt; const char *src;
 &gt; u_char *dst;
144c150
&lt;             u_int nw = *tp * 10 + (pch - digits);
---
 &gt;             u_int new = *tp * 10 + (pch - digits);
148c154
&lt;             if (nw &gt; 255)
---
 &gt;             if (new &gt; 255)
150c156
&lt;             *tp = nw;
---
 &gt;             *tp = new;
162c168
&lt;             break; //return (0);
---
 &gt;             return (0);
183c189,192
&lt; static int inet_pton6( const char *src, u_char *dst)
---
 &gt; static int
 &gt; inet_pton6(src, dst)
 &gt; const char *src;
 &gt; u_char *dst;
238c247
&lt;         break; //return (0);
---
 &gt;         return (0);

***********************

diff -r C:\msys\1.0\var\squid-3.5.0.4\src\comm\ModSelectWin32.cc 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\src\comm\ModSelectWin32.cc
20d19
&lt; #include &quot;SquidConfig.h&quot;
25d23
&lt; #include &quot;Globals.h&quot;
278c276
&lt;     incoming_udp_interval += Config.comm_incoming.udp.average - nevents;
---
 &gt;     incoming_udp_interval += Config.comm_incoming.udp_average - nevents;
310c308
&lt;     incoming_tcp_interval += Config.comm_incoming.tcp.average - nevents;
---
 &gt;     incoming_tcp_interval += Config.comm_incoming.tcp_average - nevents;
338,339c336
&lt;     int calldns = 0;
&lt;     int calludp = 0, calltcp = 0;
---
 &gt;     int calldns = 0, callicp = 0, callhttp = 0;


*************************

diff -r C:\msys\1.0\var\squid-3.5.0.4\src\ipc_win32.cc 
C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\src\ipc_win32.cc
28,41d27
&lt; #else
&lt; #if HAVE_WINSOCK2_H
&lt; #define SO_CONNDATA 0x7000
&lt; #define SO_CONNOPT 0x7001
&lt; #define SO_DISCDATA 0x7002
&lt; #define SO_DISCOPT 0x7003
&lt; #define SO_CONNDATALEN 0x7004
&lt; #define SO_CONNOPTLEN 0x7005
&lt; #define SO_DISCDATALEN 0x7006
&lt; #define SO_DISCOPTLEN 0x7007
&lt; #define SO_OPENTYPE 0x7008
&lt; #define SO_SYNCHRONOUS_ALERT 0x10
&lt; #define SO_SYNCHRONOUS_NONALERT 0x20
&lt; #endif

Thank you for providing squid to us all

Best Regards,
Dennis Felippa
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150112/08e8385e/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150112/08e8385e/attachment.html</A>&gt;
</PRE>


















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001165.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
	<LI>Next message: <A HREF="001140.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1137">[ date ]</a>
              <a href="thread.html#1137">[ thread ]</a>
              <a href="subject.html#1137">[ subject ]</a>
              <a href="author.html#1137">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
