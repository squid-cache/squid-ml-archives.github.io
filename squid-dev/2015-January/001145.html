<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Remove some splay users
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Remove%20some%20splay%20users&In-Reply-To=%3C54B4F58F.10303%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001144.html">
   <LINK REL="Next"  HREF="001141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Remove some splay users</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Remove%20some%20splay%20users&In-Reply-To=%3C54B4F58F.10303%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Remove some splay users">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan 13 10:38:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001144.html">[squid-dev] [PATCH] Remove some splay users
</A></li>
        <LI>Next message: <A HREF="001141.html">[squid-dev] Build failed in Jenkins: trunk-x64-freebsd-72 #2340
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1145">[ date ]</a>
              <a href="thread.html#1145">[ thread ]</a>
              <a href="subject.html#1145">[ subject ]</a>
              <a href="author.html#1145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 13/01/2015 11:19 p.m., Kinkie wrote:
&gt;<i> On Tue, Jan 13, 2015 at 3:09 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 13/01/2015 8:51 a.m., Kinkie wrote:
</I>&gt;&gt;&gt;<i> Hello, the attached patch changes some users of splay to
</I>&gt;&gt;&gt;<i> std::set. The aim is to get more predictable (if not
</I>&gt;&gt;&gt;<i> necessarily better) performance and leverage a cleaner API
</I>&gt;&gt;&gt;<i> resulting in more readable code.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> This is a merge snapshot of branch
</I>&gt;&gt;&gt;<i> lp:~squid/squid/replace-splay revno 13835; I will continue
</I>&gt;&gt;&gt;<i> working on the branch to migrate more users.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The touched classes have been build- and run-tested.
</I>&gt;&gt;&gt;<i> 
</I>
&gt;&gt;<i> in src/acl/Eui64.cc: * ACLEui64::parse() can be optimized a bit
</I>&gt;&gt;<i> further:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> while (const char *t = ConfigParser::strtokFile()) { if
</I>&gt;&gt;<i> (Eui::Eui64 *q = aclParseEuiData(t)) { ... what used to follow
</I>&gt;&gt;<i> the if xfree(q); }
</I>&gt;<i> 
</I>&gt;<i> done, although it is not a performance-critical path.
</I>
We keep saying that (me too sometimes) about the paths which are not
commonly used. However the config parsing pathways are used on a -k
reconfigure event. Which is rare-ish but critical since the service is
actually suspended for the duration those pathways take to process the
config.

So yeah this is a performance critical pathway (when its used). Just
not a common one.

IMO we should be optimizing these paths as much as we can reasonably
do so when we do touch them, but not going out of our way to trade
complexity against speed like for the more commonly used code paths.


&gt;&gt;<i> * for ctor/dtor like ACLUserData::~ACLUserData() which have
</I>&gt;&gt;<i> become NOP, please inline them in the .h where possible. That
</I>&gt;&gt;<i> allows some more compiler optimizations.
</I>&gt;<i> 
</I>&gt;<i> Is that even true when they are virtual? But sure, it means fewer 
</I>&gt;<i> lines of code so that's OK.
</I>
It seems to work when its been used elsewhere. Apparently the compiler
makes a choice whether to &quot;unroll&quot; that part of the ctor/dtor sequence
or make it a static call. That choice may vary depending on
optimization level and the .cc code around where its used.

So we gain in simpler code, and occasionally in faster code though not
reliably on the latter.

&gt;<i> 
</I>&gt;&gt;<i> * is cend() usable instead of end() for the find test in the
</I>&gt;&gt;<i> function above ACLUserData::dump() [ chunk @55, I think its
</I>&gt;&gt;<i> probably the end of match()]
</I>&gt;<i> 
</I>&gt;<i> Using const iterators in the copied-from container.
</I>&gt;<i> 
</I>&gt;&gt;<i> * why is CaseInsensitveSBufCompare() not defined in SBufAlgos.h
</I>&gt;&gt;<i> for re-use ?
</I>&gt;<i> 
</I>&gt;<i> Should I do that as part of this branch or merge separately?
</I>&gt;<i> 
</I>
Up to you.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUtPWPAAoJELJo5wb/XPRjPm4IANkKZUr02PVsb33CEyj1XDbF
yHEK7LS+NW17YkuE9phh1dh1XRJEQZOdrKUT4+7nsQvLjF/SLetwpyZKHSbAsCEk
PGSPNt47r2uaurNWH0RGxDC8EhDraRf9LpmXsLuI7Bq8AX1HpNLXrJuWBbtNXn89
LS6Nk2raDPumzflBPnWz8MoWSI5goYrFmQQAnFznIzIn196SGpCXDtk6N1qmSxin
Y00Tht6FFOgxfZ+WVz/PHWWpYVSZ6GEfIAE4Rmlfu1GmwhOPjrW8f6kCmrq7fXUQ
abaqEAfP9Wq727KeD6NtrgOoXhiMluWVX6pl4UOOv2/vafsPLvqB495hboooKc4=
=cN0T
-----END PGP SIGNATURE-----
</PRE>


















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001144.html">[squid-dev] [PATCH] Remove some splay users
</A></li>
	<LI>Next message: <A HREF="001141.html">[squid-dev] Build failed in Jenkins: trunk-x64-freebsd-72 #2340
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1145">[ date ]</a>
              <a href="thread.html#1145">[ thread ]</a>
              <a href="subject.html#1145">[ subject ]</a>
              <a href="author.html#1145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
