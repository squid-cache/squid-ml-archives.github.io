<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moved PID file management from Coordinator to Master
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B63623.7010803%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001147.html">
   <LINK REL="Next"  HREF="001151.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moved PID file management from Coordinator to Master</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B63623.7010803%40treenet.co.nz%3E"
       TITLE="[squid-dev] Moved PID file management from Coordinator to Master">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 14 09:25:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001147.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
        <LI>Next message: <A HREF="001151.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1150">[ date ]</a>
              <a href="thread.html#1150">[ thread ]</a>
              <a href="subject.html#1150">[ subject ]</a>
              <a href="author.html#1150">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 14/01/2015 7:37 a.m., Tsantilas Christos wrote:
&gt;<i> On 01/12/2015 07:22 PM, Amos Jeffries wrote: On 12/01/2015 6:02
</I>&gt;<i> a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi all, this patch moves pid file managment from coordinator 
</I>&gt;&gt;&gt;&gt;<i> process to master process.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> This move is the first step necessary to avoid the following
</I>&gt;&gt;&gt;&gt;<i> race condition among PID file deletion and shared segment 
</I>&gt;&gt;&gt;&gt;<i> creation/destruction in SMP Squid:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> O1) The old Squid Coordinator removes its PID file and quits.
</I>&gt;&gt;&gt;&gt;<i> N1) The system script notices Coordinator death and starts
</I>&gt;&gt;&gt;&gt;<i> the new Squid. N2) Shared segments are created by the new
</I>&gt;&gt;&gt;&gt;<i> Master process. O2) Shared segments are removed by the old
</I>&gt;&gt;&gt;&gt;<i> Master process. N3) New worker/disker processes fail due to
</I>&gt;&gt;&gt;&gt;<i> missing segments.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Coordinator needs to continue coordinating activities over the
</I>&gt;<i> SMP sockets until the workers are all shutdown and SMP sockets
</I>&gt;<i> closed, only then should it do O2 and O1 (in that order).
</I>&gt;<i> 
</I>&gt;<i> The planned behaviour for worker shutdown is to: W1) early client
</I>&gt;<i> FD closures into the beginning of the shutdown_timeout period W2)
</I>&gt;<i> on each client closure or connection going idle, close it W3) at
</I>&gt;<i> end of shutdown_timeout OR last client disconnect, release all 
</I>&gt;<i> resources.
</I>&gt;<i> 
</I>&gt;<i> In that design the AsyncEngine still runs right up until the queue 
</I>&gt;<i> completes draining. Using SMP sockets to inform Coordinator about 
</I>&gt;<i> clean shutdown at the end.
</I>&gt;<i> 
</I>&gt;&gt;<i> My sense is that the exit status can provide the same
</I>&gt;&gt;<i> functionality and also is easier to be implemented. If the worker
</I>&gt;&gt;<i> aborted early by a segfault then I am doubt that it will be able
</I>&gt;&gt;<i> to send a message to an SMP socket.
</I>&gt;<i> 
</I>&gt;<i> The Master process has no way to know if the workers are exiting
</I>&gt;<i> early with no clients, or aborting on worker-specific
</I>&gt;<i> shutdown_timeout values. But the coordinator can receive a
</I>&gt;<i> terminated message from them over SMP sockets.
</I>&gt;<i> 
</I>&gt;&gt;<i> We can use exit status.
</I>
Does the master process get exit status of *all* worker processes and
the sub-childs down N levels? It was my understanding that in SMP each
worker disker etc is a fork() and the child becomes new coordinator.


Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUtjYjAAoJELJo5wb/XPRjWN0IAJUR13a2a45DT/XKqlYVYXGb
BoqPtKRUQQQsSrAqxJVrl59UXgY+yB38h7QWUrdBUV/+QaZvEhjMwVSLsL8qHbrM
bMd0HQLa5G8W9nuKQnuI+3iwUQj0F9+7Z45yGKFimJRi7sDGRkHH5dTl/zJqNLgu
oYJYZ3nB6QYsLV15SVf/cpBxrhELKZCfvb5Fcoy8LZojUfK9O0gXmdmBIJJtJyoa
1u9TbKsxtAdJOiUuhGcruLApj2bHoQL6IwEm9soV2IYOUxCamFKyaz4BqmUzmp05
txaYvQ3GbMc9k5IGGuXZHNiEVyNjUSg/97qXL150lYpKu7IYCJXqCj4PqwMu7NU=
=qDv3
-----END PGP SIGNATURE-----
</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001147.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
	<LI>Next message: <A HREF="001151.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1150">[ date ]</a>
              <a href="thread.html#1150">[ thread ]</a>
              <a href="subject.html#1150">[ subject ]</a>
              <a href="author.html#1150">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
