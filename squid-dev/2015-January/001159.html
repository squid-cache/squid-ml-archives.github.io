<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bug%20fixes%20for%20mingw%20based%20on%0A%09squid-3.5.0.4-20150106-r13714&In-Reply-To=%3C54B6A808.6080801%40infologika.com.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001140.html">
   <LINK REL="Next"  HREF="001163.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714</H1>
    <B>Dennis</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bug%20fixes%20for%20mingw%20based%20on%0A%09squid-3.5.0.4-20150106-r13714&In-Reply-To=%3C54B6A808.6080801%40infologika.com.br%3E"
       TITLE="[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714">dennis at infologika.com.br
       </A><BR>
    <I>Wed Jan 14 17:31:52 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001140.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
        <LI>Next message: <A HREF="001163.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1159">[ date ]</a>
              <a href="thread.html#1159">[ thread ]</a>
              <a href="subject.html#1159">[ subject ]</a>
              <a href="author.html#1159">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hello Amos

The changes are for used mingw32 32. But I also tried mingw64 32 and 
mingw64 64 with all different options. None really worked.

The mingw64 (32 and 64) seem to use ModSelect.cc and not 
ModSelectWin32.cc. When started it gives multiple lines with
&quot;WARNING: FD xxxx has handlers, but it's invalid&quot;
each line has an increasing number for xxxx. It consumes all possible 
numbers in a loop and then crashes.

And for mingw32 I get &quot;I get: WARNING: Reply from unknown nameserver 
[::]:53&quot; (as i wrote initially)

I already am working on other project and don't have much time to make 
the diffs again. I attached the diffs so it's a lot more readable 
without the line breaks. Please take a look it's actually very simple 
(changes are minor).

Thank you, and best regards,
Dennis Felippa


-----------------------------------------
Em (When): Tue, 13 Jan 2015 15:47:48 +1300
De (From): <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>
Para (To): <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">dennis at infologika.com.br</A>, <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 13/01/2015 8:09 a.m., Dennis wrote:
</I>&gt;&gt;<i> Dear Sirs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried compiling squid-3.5.0.4-20150106-r13714 running under
</I>&gt;&gt;<i> windows with wingw
</I>&gt;<i> Hi Dennis, thank you!
</I>&gt;<i>
</I>&gt;&gt;<i> It still had a few bugs. I fixed them and now it compiles and runs,
</I>&gt;&gt;<i> but still can't resolve addresses (I have correctly specified the
</I>&gt;&gt;<i> name servers). I get: WARNING: Reply from unknown nameserver
</I>&gt;&gt;<i> [::]:53
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don't have more time to work it further.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would like to contribute with the fixes I wrote. Here are them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Obs.: the diff shows squid-3.5.0.4 against
</I>&gt;&gt;<i> squid-3.5.0.4-20150106-r13714, but it is actually my
</I>&gt;&gt;<i> squid-3.5.0.4-20150106-r13714 against
</I>&gt;&gt;<i> squid-3.5.0.4-20150106-r13714
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> configure command used: ./configure --enable-default-hostsfile=none
</I>&gt;&gt;<i> --prefix=C:/msys/1.0/squid mingw version: latest 32 bit.
</I>&gt;<i> MinGW32 32-bit ? or MinGW-w64 32-bit ?
</I>&gt;<i> I am finding there are some critical API differences between the two
</I>&gt;<i> &quot;MinGW&quot; projects.
</I>&gt;<i>
</I>&gt;&gt;<i> diffs:
</I>&gt;&gt;<i>
</I>&gt;<i> Can you present these in unified format please? (diff -ur ...), and
</I>&gt;<i> attachments rather than inline.
</I>&gt;<i> It's very hard to read the other format around email quoting.
</I>&gt;<i>
</I>&gt;&gt;<i> diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\os\mswindows.h
</I>&gt;&gt;<i> C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\os\mswindows.h
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 625,630c624,629
</I>&gt;&gt;<i> &lt; /* commen out this function &lt; inline char * &lt; inet_ntop(int af,
</I>&gt;&gt;<i> const void *src, char *dst, size_t size) &lt; { &lt;     return
</I>&gt;&gt;<i> (char*)InetNtopA(af, const_cast&lt;void*&gt;(src), dst, size); &lt; } &lt;
</I>&gt;&gt;<i> #define inet_ntop(a,s,d,l) Squid::inet_ntop(a,s,d,l) */ ---
</I>&gt;&gt;&gt;<i> inline char * inet_ntop(int af, const void *src, char *dst,
</I>&gt;&gt;&gt;<i> size_t size) { return (char*)InetNtopA(af,
</I>&gt;&gt;&gt;<i> const_cast&lt;void*&gt;(src), dst, size); } #define inet_ntop(a,s,d,l)
</I>&gt;&gt;&gt;<i> Squid::inet_ntop(a,s,d,l)
</I>&gt;<i> FYI: A fix for the re-definition error is about to be backported. But
</I>&gt;<i> the absence of InetNtopA API call required by MS is still an issue I'm
</I>&gt;<i> working on now.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2.0.22 (MingW32)
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBAgAGBQJUtIdUAAoJELJo5wb/XPRjREIIAMx0UgbcS3lw8N2vFbuYhOt3
</I>&gt;<i> J4s/+UVXJ4up5iq3MHtXKDK2tvDo3Bln9ZdAbUnXlrBdIZomDFMLfbU+6aToVFrL
</I>&gt;<i> ACrmvJCFdoyBfjaSr1WONyf8mEifLfI/20gJWq5fRKw0OEiTNujfqTOvF+OBcLez
</I>&gt;<i> JIkcMgjyhiwT3CITytXmVuFQxYzX/IAUQTHkf5axWUISyPbOIKFQ0lznMEaKHvC6
</I>&gt;<i> tMklOnzDY3pIGYNi5tYKR76qs5vfuiCtxWWVMRt9976ABCViz5xatJyYO2d8Msrx
</I>&gt;<i> FXmtjgie9rmX/AKkmffSTw9mW3Ls6J4/yF9G9YMa3ZSX5Yjf0G2OCeJHHjJIqTM=
</I>&gt;<i> =hxHP
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i>
</I>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150114/12526119/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150114/12526119/attachment.html</A>&gt;
-------------- next part --------------

Obs.: the diff shows squid-3.5.0.4 against squid-3.5.0.4-20150106-r13714, but it is actually my squid-3.5.0.4-20150106-r13714 against squid-3.5.0.4-20150106-r13714

configure command used:
./configure --enable-default-hostsfile=none --prefix=C:/msys/1.0/squid
mingw version: latest 32 bit.

diffs:


diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\os\mswindows.h C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\os\mswindows.h
625,630c624,629
&lt; /* commen out this function
&lt; inline char *
&lt; inet_ntop(int af, const void *src, char *dst, size_t size)
&lt; {
&lt;     return (char*)InetNtopA(af, const_cast&lt;void*&gt;(src), dst, size);
&lt; }
&lt; #define inet_ntop(a,s,d,l) Squid::inet_ntop(a,s,d,l) */
---
&gt;<i> inline char *
</I>&gt;<i> inet_ntop(int af, const void *src, char *dst, size_t size)
</I>&gt;<i> {
</I>&gt;<i>     return (char*)InetNtopA(af, const_cast&lt;void*&gt;(src), dst, size);
</I>&gt;<i> }
</I>&gt;<i> #define inet_ntop(a,s,d,l) Squid::inet_ntop(a,s,d,l)
</I>

***************************

diff -r C:\msys\1.0\var\squid-3.5.0.4\helpers\basic_auth\SSPI\valid.h C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\helpers\basic_auth\SSPI\valid.h
41d40
&lt; typedef HANDLE SERVICE_STATUS_HANDLE;
74c73
&lt; static const char *__foo;
---
&gt;<i> static char *__foo;
</I>95d93
&lt; int Valid_User(char *,char *, char *);


****************************  

  
diff -r C:\msys\1.0\var\squid-3.5.0.4\helpers\external_acl\LM_group\ext_lm_group_acl.ccC:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\helpers\external_acl\LM_group\ext_lm_group_acl.cc
95d94
&lt; typedef HANDLE SERVICE_STATUS_HANDLE;


**************************************

diff -r C:\msys\1.0\var\squid-3.5.0.4\helpers\ntlm_auth\SSPI\ntlm_sspi_auth.cc C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\helpers\ntlm_auth\SSPI\ntlm_sspi_auth.cc
82d81
&lt; typedef HANDLE SERVICE_STATUS_HANDLE;

 

*********************

squid-3.5.0.4-20150106-r13714

diff getaddrinfo.cc
26d25
&lt; #include &quot;../src/debug.h&quot;
85c84
&lt;     ret = (addrinfo*) malloc (sizeof (struct addrinfo));
---
&gt;<i>     ret = malloc (sizeof (struct addrinfo));
</I>89c88
&lt;     ret-&gt;ai_addr = (sockaddr*) malloc (addrlen);
---
&gt;<i>     ret-&gt;ai_addr = malloc (addrlen);
</I>180c179
&lt;         if (inet_pton(result.ai_family, nodename, &amp;sin.sin_addr) != 1)
---
&gt;<i>         if (inet_pton(result.ai_family, nodename, &amp;sin.sin_addr))
</I>281c280
&lt;         sai-&gt;ai_canonname = (char *) malloc (strlen (hp-&gt;h_name) + 1);
---
&gt;<i>         sai-&gt;ai_canonname = malloc (strlen (hp-&gt;h_name) + 1);
</I>
*****************

diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\getnameinfo.cc C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\getnameinfo.cc
151c151,159
&lt; int xgetnameinfo(const struct sockaddr *sa, socklen_t salen, char *host, size_t hostlen, char *serv, size_t servlen, int flags)
---
&gt;<i> int
</I>&gt;<i> xgetnameinfo(sa, salen, host, hostlen, serv, servlen, flags)
</I>&gt;<i> const struct sockaddr *sa;
</I>&gt;<i> socklen_t salen;
</I>&gt;<i> char *host;
</I>&gt;<i> size_t hostlen;
</I>&gt;<i> char *serv;
</I>&gt;<i> size_t servlen;
</I>&gt;<i> int flags;
</I>

******************

diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\inet_ntop.cc C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\inet_ntop.cc
97,98c97,98
&lt; const char *inet_ntop4 (const u_char *src, char *dst, size_t size);
&lt; const char *inet_ntop6 (const u_char *src, char *dst, size_t size);
---
&gt;<i> static const char *inet_ntop4 (const u_char *src, char *dst, size_t size);
</I>&gt;<i> static const char *inet_ntop6 (const u_char *src, char *dst, size_t size);
</I>107,112c108,113
&lt; const char *
&lt; xinet_ntop(af, src, dst, size)
&lt; int af;
&lt; const void *src;
&lt; char *dst;
&lt; size_t size;
---
&gt;<i> const char *
</I>&gt;<i> xinet_ntop(af, src, dst, size)
</I>&gt;<i> int af;
</I>&gt;<i> const void *src;
</I>&gt;<i> char *dst;
</I>&gt;<i> size_t size;
</I>114d113
&lt; const char * xinet_ntop(int af, const void *src, char * dst, size_t size)
118c117
&lt;         return (inet_ntop4((const u_char*) src, dst, size));
---
&gt;<i>         return (inet_ntop4(src, dst, size));
</I>120c119
&lt;         return (inet_ntop6((const u_char*) src, dst, size));
---
&gt;<i>         return (inet_ntop6(src, dst, size));
</I>138,142c138,142
&lt; static const char *
&lt; inet_ntop4(src, dst, size)
&lt; const u_char *src;
&lt; char *dst;
&lt; size_t size;
---
&gt;<i> static const char *
</I>&gt;<i> inet_ntop4(src, dst, size)
</I>&gt;<i> const u_char *src;
</I>&gt;<i> char *dst;
</I>&gt;<i> size_t size;
</I>144d142
&lt; const char * inet_ntop4( const u_char *src, char *dst, size_t size)
149c147
&lt;     if ((size_t) snprintf(tmp, min(sizeof(&quot;255.255.255.255&quot;),size), fmt, src[0], src[1], src[2], src[3]) &gt;= size) {
---
&gt;<i>     if (snprintf(tmp, min(sizeof(&quot;255.255.255.255&quot;),size), fmt, src[0], src[1], src[2], src[3]) &gt;= size) {
</I>162,166c161,165
&lt; static const char *
&lt; inet_ntop6(src, dst, size)
&lt; const u_char *src;
&lt; char *dst;
&lt; size_t size;
---
&gt;<i> static const char *
</I>&gt;<i> inet_ntop6(src, dst, size)
</I>&gt;<i> const u_char *src;
</I>&gt;<i> char *dst;
</I>&gt;<i> size_t size;
</I>168d165
&lt; const char * inet_ntop6( const u_char *src, char *dst, size_t size)


***************

diff -r C:\msys\1.0\var\squid-3.5.0.4\compat\inet_pton.cc C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\compat\inet_pton.cc
106c106,110
&lt; int xinet_pton( int af, const char *src, void *dst)
---
&gt;<i> int
</I>&gt;<i> xinet_pton(af, src, dst)
</I>&gt;<i> int af;
</I>&gt;<i> const char *src;
</I>&gt;<i> void *dst;
</I>110c114
&lt;         return (inet_pton4(src, (u_char*) dst));
---
&gt;<i>         return (inet_pton4(src, dst));
</I>112c116
&lt;         return (inet_pton6(src, (u_char*) dst));
---
&gt;<i>         return (inet_pton6(src, dst));
</I>130c134,137
&lt; static int inet_pton4( const char *src, u_char *dst)
---
&gt;<i> static int
</I>&gt;<i> inet_pton4(src, dst)
</I>&gt;<i> const char *src;
</I>&gt;<i> u_char *dst;
</I>144c150
&lt;             u_int nw = *tp * 10 + (pch - digits);
---
&gt;<i>             u_int new = *tp * 10 + (pch - digits);
</I>148c154
&lt;             if (nw &gt; 255)
---
&gt;<i>             if (new &gt; 255)
</I>150c156
&lt;             *tp = nw;
---
&gt;<i>             *tp = new;
</I>162c168
&lt;             break; //return (0);
---
&gt;<i>             return (0);
</I>183c189,192
&lt; static int inet_pton6( const char *src, u_char *dst)
---
&gt;<i> static int
</I>&gt;<i> inet_pton6(src, dst)
</I>&gt;<i> const char *src;
</I>&gt;<i> u_char *dst;
</I>238c247
&lt;         break; //return (0);
---
&gt;<i>         return (0);
</I>
***********************

diff -r C:\msys\1.0\var\squid-3.5.0.4\src\comm\ModSelectWin32.cc C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\src\comm\ModSelectWin32.cc
20d19
&lt; #include &quot;SquidConfig.h&quot;
25d23
&lt; #include &quot;Globals.h&quot;
278c276
&lt;     incoming_udp_interval += Config.comm_incoming.udp.average - nevents;
---
&gt;<i>     incoming_udp_interval += Config.comm_incoming.udp_average - nevents;
</I>310c308
&lt;     incoming_tcp_interval += Config.comm_incoming.tcp.average - nevents;
---
&gt;<i>     incoming_tcp_interval += Config.comm_incoming.tcp_average - nevents;
</I>338,339c336
&lt;     int calldns = 0;
&lt;     int calludp = 0, calltcp = 0;
---
&gt;<i>     int calldns = 0, callicp = 0, callhttp = 0;
</I>

*************************

diff -r C:\msys\1.0\var\squid-3.5.0.4\src\ipc_win32.cc C:\msys\1.0\var\squid-3.5.0.4-20150106-r13714\src\ipc_win32.cc
28,41d27
&lt; #else
&lt; #if HAVE_WINSOCK2_H
&lt; #define SO_CONNDATA 0x7000
&lt; #define SO_CONNOPT 0x7001
&lt; #define SO_DISCDATA 0x7002
&lt; #define SO_DISCOPT 0x7003
&lt; #define SO_CONNDATALEN 0x7004
&lt; #define SO_CONNOPTLEN 0x7005
&lt; #define SO_DISCDATALEN 0x7006
&lt; #define SO_DISCOPTLEN 0x7007
&lt; #define SO_OPENTYPE 0x7008
&lt; #define SO_SYNCHRONOUS_ALERT 0x10
&lt; #define SO_SYNCHRONOUS_NONALERT 0x20
&lt; #endif

</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001140.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
	<LI>Next message: <A HREF="001163.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1159">[ date ]</a>
              <a href="thread.html#1159">[ thread ]</a>
              <a href="subject.html#1159">[ subject ]</a>
              <a href="author.html#1159">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
