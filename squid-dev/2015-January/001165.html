<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moved PID file management from Coordinator to Master
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B7E5FD.6050702%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001301.html">
   <LINK REL="Next"  HREF="001137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moved PID file management from Coordinator to Master</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moved%20PID%20file%20management%20from%20Coordinator%20to%20Master&In-Reply-To=%3C54B7E5FD.6050702%40users.sourceforge.net%3E"
       TITLE="[squid-dev] Moved PID file management from Coordinator to Master">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Thu Jan 15 16:08:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001301.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
        <LI>Next message: <A HREF="001137.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1165">[ date ]</a>
              <a href="thread.html#1165">[ thread ]</a>
              <a href="subject.html#1165">[ subject ]</a>
              <a href="author.html#1165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A new patch.

This is has the following change over the old one:
  - When a worker or coordinator receives a shutdown signal, starts the 
shutdown procedure.
  - If a second shutdown signal received by the worker process the 
shutdown_lifetime ignored and stops immediately event loop and completes 
the shutdown procedure.

Regards,
    Christos

On 01/12/2015 07:22 PM, Amos Jeffries wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 12/01/2015 6:02 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> Hi all,this patch moves pid file managment from coordinator
</I>&gt;&gt;<i> process to master process.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This move is the first step necessary to avoid the following race
</I>&gt;&gt;<i> condition among PID file deletion and shared segment
</I>&gt;&gt;<i> creation/destruction in SMP Squid:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> O1) The old Squid Coordinator removes its PID file and quits. N1)
</I>&gt;&gt;<i> The system script notices Coordinator death and starts the new
</I>&gt;&gt;<i> Squid. N2) Shared segments are created by the new Master process.
</I>&gt;&gt;<i> O2) Shared segments are removed by the old Master process. N3) New
</I>&gt;&gt;<i> worker/disker processes fail due to missing segments.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Coordinator needs to continue coordinating activities over the SMP
</I>&gt;<i> sockets until the workers are all shutdown and SMP sockets closed,
</I>&gt;<i> only then should it do O2 and O1 (in that order).
</I>&gt;<i>
</I>&gt;<i> The planned behaviour for worker shutdown is to:
</I>&gt;<i>   W1) early client FD closures into the beginning of the
</I>&gt;<i> shutdown_timeout period
</I>&gt;<i>   W2) on each client closure or connection going idle, close it
</I>&gt;<i>   W3) at end of shutdown_timeout OR last client disconnect, release all
</I>&gt;<i> resources.
</I>&gt;<i>
</I>&gt;<i> In that design the AsyncEngine still runs right up until the queue
</I>&gt;<i> completes draining. Using SMP sockets to inform Coordinator about
</I>&gt;<i> clean shutdown at the end.
</I>&gt;<i> The Master process has no way to know if the workers are exiting early
</I>&gt;<i> with no clients, or aborting on worker-specific shutdown_timeout
</I>&gt;<i> values. But the coordinator can receive a terminated message from them
</I>&gt;<i> over SMP sockets.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> TODO: The second step (not a part of this change) is to delete
</I>&gt;&gt;<i> shared memory segments before PID file is deleted (all in the
</I>&gt;&gt;<i> Master process after this change).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now the Master process receives signals and is responsible for
</I>&gt;&gt;<i> forwarding them to the kids.
</I>&gt;<i>
</I>&gt;<i> The command line control process also used manually for the -k options
</I>&gt;<i>   to send signals also thinks of itself as Master.
</I>&gt;<i>
</I>&gt;<i> How does this new closing of SMP sockets interact with that other
</I>&gt;<i> meaning of Master process?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please for more informations read the patch preamble.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is a Measurement Factory project
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some extra notes/ideas --------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) Multiple shutdown signals received by squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In current squid when coordinator received a shutdown signal, then
</I>&gt;&gt;<i> replaced shutdown signal handlers with the default handlers. This
</I>&gt;&gt;<i> is has as result when a second shutdown signal received then the
</I>&gt;&gt;<i> coordinator process died immediately, without forwarding shutdown
</I>&gt;&gt;<i> signal to kids. The shutdown of the other kids are finished as
</I>&gt;&gt;<i> normal.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This patch when master process receives a shutdown signal forward
</I>&gt;&gt;<i> it to kids and master process is ready to receive a second shutdown
</I>&gt;&gt;<i> signal. When a second shutdown signal received to master and this
</I>&gt;&gt;<i> forwarded to kids then the kids died immediately.
</I>&gt;<i>
</I>&gt;<i> Plan was to pass the signal to workers again where they kick off their
</I>&gt;<i> own shutdown_timeout event handlers immediately instead of hard
</I>&gt;<i> killing workers.
</I>&gt;<i>
</I>&gt;<i> FWIW: Ubuntu Gentoo, and RHEL people are enjoying their patches that
</I>&gt;<i> just ignore the repeated signals.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2) The system admin shows a blocked kid (infinity loop or not
</I>&gt;&gt;<i> responding). He kill with the hand.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Current squid does not restart the kids killed by a TERM or KILL
</I>&gt;&gt;<i> signal (squid considers it as normal kid shutdown). This patch does
</I>&gt;&gt;<i> not change this behaviour. The admin is still able to kill with a
</I>&gt;&gt;<i> &quot;kill -11&quot; and in this case the kid will restarted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My opinion is that squid should restart kids in these cases. Should
</I>&gt;&gt;<i> not restart a kid only when a shutdown requested from system admin,
</I>&gt;&gt;<i> or when the kids dying very fast (hopeless()==true ).
</I>&gt;<i>
</I>&gt;<i> TERM and KILL received by the workers often *are* signals sent by the
</I>&gt;<i> system admin, or scripts on their behalf. That may decrease in
</I>&gt;<i> popularity though when we fix the normal shutdown process issues. For
</I>&gt;<i> a while longer we have to take the current reality.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In related topics, I have been trying to figure out a --foreground
</I>&gt;<i> command line option that operates like -N but does not disable SMP,
</I>&gt;<i> just makes Coordinator == Master. But understanding the SMP
</I>&gt;<i> complexities have been blocking me so far.  Are you able and
</I>&gt;<i> interested in taking that forward?
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2.0.22 (MingW32)
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBAgAGBQJUtALXAAoJELJo5wb/XPRjwKsIAMPzuOaxvC7WpBHOpQZpG1IZ
</I>&gt;<i> 1tgbtosaJu3JweE7At729HLL34mR+YagaJbTz4xF6c2mkpLxxYioT6IzSxKc6YCD
</I>&gt;<i> mYJr8WU8uuJVI662u7w+3UyLVLI+c3vIwrw8d8NDZaKyAkOIn//Xks9YIG7h+xse
</I>&gt;<i> ooK/AAhMaADiS5S1FqY9OM3Q5Pn0nI3R91EpzGIeL1U5bG+43GYiOic3YSKgxSzq
</I>&gt;<i> 8Q3YemiLj7ex00ZBtCbQ955bB8Zz1Q9I8hWgXdAFHgQKrjNmjdUDHqEg5M6E33zf
</I>&gt;<i> Gwpr6M3bO1gbtp7ize9vX7YxIlUjK6TUsbOFPlt9QJYEzzVxoqcgzy0lavVEiXE=
</I>&gt;<i> =5Qeg
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: move-PID-file-management-to-Master-t7.patch
Type: text/x-patch
Size: 36053 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150115/77ad45b5/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150115/77ad45b5/attachment-0001.bin</A>&gt;
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001301.html">[squid-dev] Moved PID file management from Coordinator to Master
</A></li>
	<LI>Next message: <A HREF="001137.html">[squid-dev] Bug fixes for mingw based on	squid-3.5.0.4-20150106-r13714
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1165">[ date ]</a>
              <a href="thread.html#1165">[ thread ]</a>
              <a href="subject.html#1165">[ subject ]</a>
              <a href="author.html#1165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
