<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Initial libsecurity API
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Initial%20libsecurity%20API&In-Reply-To=%3C54C69500.3080301%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001402.html">
   <LINK REL="Next"  HREF="001157.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Initial libsecurity API</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Initial%20libsecurity%20API&In-Reply-To=%3C54C69500.3080301%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Initial libsecurity API">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan 26 19:26:56 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001402.html">[squid-dev] [PATCH] Initial libsecurity API
</A></li>
        <LI>Next message: <A HREF="001157.html">[squid-dev] Jenkins build is back to normal : 3.HEAD-coadvisor #538
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1403">[ date ]</a>
              <a href="thread.html#1403">[ thread ]</a>
              <a href="subject.html#1403">[ subject ]</a>
              <a href="author.html#1403">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/14/2015 08:50 AM, Amos Jeffries wrote:
&gt;<i> This is the first step(s) towards a generic TLS/SSL security API for
</I>&gt;<i> Squid.
</I>

&gt;<i> +    // BUG: ssl_client.sslContext will leak on reconfigure when Config gets memset()
</I>...
&gt;<i> +    Config.ssl_client.sslContext = Security::ProxyOutgoingConfig.createContext();
</I>
Which memset(Config) call are you referring to here?

&gt;<i> void
</I>&gt;<i> configFreeMemory(void)
</I>&gt;<i> {   
</I>&gt;<i>     free_all();
</I>&gt;<i> #if USE_OPENSSL
</I>&gt;<i>     SSL_CTX_free(Config.ssl_client.sslContext);
</I>&gt;<i> #endif
</I>&gt;<i> }
</I>
And is not Config.ssl_client.sslContext destroyed in the old
configFreeMemory() function quoted above?


&gt;<i> +    // it makes more sense to create a context per outbound connection instead of this
</I>
Please remove this comment. Since each context may consume gobbles of
RAM, I doubt what you are suggesting always makes more sense, but
discussing this is outside your project scope.


&gt;<i> +NAME: tls_outgoing_options
</I>
Please do not forget the recently added SSL_OP_NO_TICKET when merging.


&gt;<i> +} // namespace Security
</I>&gt;<i> +
</I>&gt;<i> +// parse the tls_outgoing_options directive
</I>&gt;<i> +inline void
</I>&gt;<i> +parse_securePeerOptions(Security::PeerOptions *opt)
</I>&gt;<i> +{
</I>&gt;<i> +    while(const char *token = ConfigParser::NextToken()) {
</I>&gt;<i> +        opt-&gt;parse(token);
</I>&gt;<i> +    }
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> +#define free_securePeerOptions(x) Security::ProxyOutgoingConfig.clear()
</I>&gt;<i> +#define dump_securePeerOptions(e,n,x) // not supported yet
</I>

Please add an XXX to explain why is these are declared outside their
namespace. For example:

XXX: These declarations are outside their namespace because our
generated parsing code cannot handle namespaces.


&gt;<i> +// parse the tls_outgoing_options directive
</I>&gt;<i> +inline void
</I>&gt;<i> +parse_securePeerOptions(Security::PeerOptions *opt)
</I>&gt;<i> +{
</I>&gt;<i> +    while(const char *token = ConfigParser::NextToken()) {
</I>&gt;<i> +        opt-&gt;parse(token);
</I>&gt;<i> +    }
</I>&gt;<i> +}
</I>
I see no reasons to inline this loop. The related code is slow for other
reasons and not in a critical path. Please do not inline unless really
necessary.


&gt;<i> +#define free_securePeerOptions(x) Security::ProxyOutgoingConfig.clear()
</I>&gt;<i> +#define dump_securePeerOptions(e,n,x) // not supported yet
</I>
Why are these #defined? If they can be implemented as regular functions,
they should be IMO.


&gt;<i> +            // const loss is okay here, ssl_ex_index_server is only read and not assigned a destructor
</I>&gt;<i> +            SSL_set_ex_data(ssl, ssl_ex_index_server, const_cast&lt;SBuf*&gt;(&amp;peer-&gt;secure.sslDomain));
</I>
Perhaps I am missing something, but it looks like you are adding an SBuf
pointer where the rest of the code expects a char* pointer (both
SSL_set_ex_data and SSL_get_ex_data calls with the same
ssl_ex_index_server index). How did this change work or was this path
not tested?

If this is indeed a bug, please go through all ssl_ex_index_server users
to make sure they all agree on the data type. For example:

  bzr grep -n ssl_ex_index_server


&gt;<i> +#if WHEN_PEER_HOST_IS_SBUF
</I>&gt;<i>          else
</I>&gt;<i>              SSL_set_ex_data(ssl, ssl_ex_index_server, peer-&gt;host);
</I>&gt;<i> +#endif
</I>
Lost of functionality here? Please restore if possible or
explain/document if not.


&gt;<i> +
</I>&gt;<i> +class PeerOptions
</I>&gt;<i> +{
</I>
Please add a one-line description to clarify what we mean by &quot;Peer&quot;
here: cache_peer, any server, any client or server, etc.


&gt;<i> +    /// generate a security context from the configured options
</I>&gt;<i> +    Security::ContextPointer createContext();
</I>
Do we need to use the explicit Secutiry:: prefix inside namespace
Security {}?


&gt;<i> +    /// generate a security context from the configured options
</I>&gt;<i> +    Security::ContextPointer createContext();
</I>
If the description is accurate, should not this method be moved outside
the PeerOptions class? And if the move is not possible for some reason,
should not this method be &quot;const&quot;?


&gt;<i> +    bool ssl;   ///&lt; whether SSL is to be used on this connection
</I>
&quot;this connection&quot; is not clear in a PeerOptions context. Perhaps we can
say &quot;with this peer&quot;?

I thought you were opposed to using ssl for new stuff. Why not call this
&quot;secured&quot; or something like that? You have to change all calling code
anyway, right?


&gt;<i> +    bool ssl;   ///&lt; whether SSL is to be used on this connection
</I>&gt;<i> +
</I>&gt;<i> +    SBuf certFile;       ///&lt; path of file containing PEM format X509 certificate
</I>&gt;<i> +    SBuf privateKeyFile; ///&lt; path of file containing private key in PEM format
</I>&gt;<i> +    SBuf sslOptions;     ///&lt; library-specific options string
</I>&gt;<i> +    SBuf caFile;         ///&lt; path of file containing trusted Certificate Authority
</I>&gt;<i> +    SBuf caDir;          ///&lt; path of directory containign a set of trusted Certificate Authorities
</I>&gt;<i> +    SBuf crlFile;        ///&lt; path of file containing Certificate Revoke List
</I>&gt;<i> +
</I>&gt;<i> +    int sslVersion;
</I>&gt;<i> +    SBuf sslCipher;
</I>&gt;<i> +    SBuf sslFlags;
</I>&gt;<i> +    SBuf sslDomain;
</I>
Please consider making &quot;sslVersion&quot; and &quot;ssl&quot; last data members (in that
order), to possibly save a tiny bit of padding and avoid giving a bad
order example for other classes (where it may actually matter).


If this change was not tested with and without SslBump, please test.


Thank you,

Alex.
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001402.html">[squid-dev] [PATCH] Initial libsecurity API
</A></li>
	<LI>Next message: <A HREF="001157.html">[squid-dev] Jenkins build is back to normal : 3.HEAD-coadvisor #538
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1403">[ date ]</a>
              <a href="thread.html#1403">[ thread ]</a>
              <a href="subject.html#1403">[ subject ]</a>
              <a href="author.html#1403">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
