<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] checklist-&gt;conn assertion in DestinationIp.cc
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20checklist-%3Econn%20assertion%20in%20DestinationIp.cc&In-Reply-To=%3C55A944E5.6050909%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002850.html">
   <LINK REL="Next"  HREF="002684.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] checklist-&gt;conn assertion in DestinationIp.cc</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20checklist-%3Econn%20assertion%20in%20DestinationIp.cc&In-Reply-To=%3C55A944E5.6050909%40measurement-factory.com%3E"
       TITLE="[squid-dev] checklist-&gt;conn assertion in DestinationIp.cc">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jul 17 18:09:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002850.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
        <LI>Next message: <A HREF="002684.html">[squid-dev] checklist-&gt;conn assertion in DestinationIp.cc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2682">[ date ]</a>
              <a href="thread.html#2682">[ thread ]</a>
              <a href="subject.html#2682">[ subject ]</a>
              <a href="author.html#2682">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    Intercepting Squids sometimes fail with the following assertion in
ACLDestinationIP::match():

&gt;<i>     // Bug 3243: CVE 2009-0801
</I>&gt;<i>     // Bypass of browser same-origin access control in intercepted communication
</I>&gt;<i>     // To resolve this we will force DIRECT and only to the original client destination.
</I>&gt;<i>     // In which case, we also need this ACL to accurately match the destination
</I>&gt;<i>     if (Config.onoff.client_dst_passthru &amp;&amp; ... intercepted ...) {
</I>&gt;<i>         assert(checklist-&gt;conn() &amp;&amp; checklist-&gt;conn()-&gt;clientConnection != NULL);
</I>&gt;<i>         return ACLIP::match(checklist-&gt;conn()-&gt;clientConnection-&gt;local);
</I>&gt;<i>     }
</I>
There are several reports about these failures on squid-users, including
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2015-May/003562.html">http://lists.squid-cache.org/pipermail/squid-users/2015-May/003562.html</A>

The assertion makes no sense to me -- why would an ACL assert that a
connection is valid? A lot of things can happen between the time the ACL
checklist was formed and the time the ACL got evaluated. This is true
for all ACLs, but should be especially obvious for slow/asynchronous
ACLs such as &quot;dst&quot;.

Is suggest replacing the assert with an if-statement to return -1
(matching failure) when the connection is gone. Rationale: With the
connection gone, the matching result probably does not matter anymore so
there is little incentive for us to use alternative (and insecure!)
sources of destination information.

Any better ideas?


Thank you,

Alex.
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002850.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
	<LI>Next message: <A HREF="002684.html">[squid-dev] checklist-&gt;conn assertion in DestinationIp.cc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2682">[ date ]</a>
              <a href="thread.html#2682">[ thread ]</a>
              <a href="subject.html#2682">[ subject ]</a>
              <a href="author.html#2682">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
