<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] received_encrypted ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20received_encrypted%20ACL&In-Reply-To=%3C55B0EF17.4050806%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002828.html">
   <LINK REL="Next"  HREF="002838.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] received_encrypted ACL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20received_encrypted%20ACL&In-Reply-To=%3C55B0EF17.4050806%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] received_encrypted ACL">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 23 13:41:43 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002828.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
        <LI>Next message: <A HREF="002838.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2832">[ date ]</a>
              <a href="thread.html#2832">[ thread ]</a>
              <a href="subject.html#2832">[ subject ]</a>
              <a href="author.html#2832">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/07/2015 3:32 a.m., Alex Rousskov wrote:
&gt;<i> On 07/21/2015 04:25 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 21/07/2015 9:42 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> adaptation_access icapS aclIcap
</I>&gt;&gt;&gt;&gt;&gt;<i> adaptation_access icapN !aclIcap
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> aclIcap can be a received_encrypted ACL. What ACL expression would you
</I>&gt;&gt;&gt;&gt;&gt;<i> suggest for aclIcap if received_encrypted is not available?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i>   # top 5 criteria - TLS transactions
</I>&gt;&gt;&gt;&gt;<i>   acl aclIcap allof HTTPS
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> What is &quot;HTTPS&quot; ACL? If it is based on the URI scheme, then AFAIK, it is
</I>&gt;&gt;&gt;<i> not going to work because it will not match bumped <A HREF="http://">http://</A> requests (at
</I>&gt;&gt;&gt;<i> least).
</I>&gt;<i> 
</I>&gt;&gt;<i> Good you have seen those. That is what the HTTPbis WG call
</I>&gt;&gt;<i> &quot;opportunistic encryption&quot; traffic.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I bet many (most?) of them are actually regular HTTP requests sent over
</I>&gt;<i> TLS/SSL connections. There is nothing opportunistic about them.
</I>
That is the very definition of &quot;opportunistic&quot; in the related HTTP
documentation.

[Sorry wording gets flicked from &quot;security&quot; to &quot;encryption&quot; in those WG
threads a lot, didn't mean to bring it over here too].

RFC 7435 section 1.2 - A New Perspective
&quot;
   &quot;Opportunistic Security&quot; (OS) is defined as the use of cleartext as
   the baseline communication security policy, with encryption and
   authentication negotiated and applied to the communication when
   available.
&quot;

[Note that *when available* wording.]

<A HREF="http://tools.ietf.org/html/draft-ietf-httpbis-http2-encryption-02">http://tools.ietf.org/html/draft-ietf-httpbis-http2-encryption-02</A>
&quot;
   Serving &quot;https&quot; URIs require acquiring and configuring a valid
   certificate, which means that some deployments find supporting TLS
   difficult.  This document describes a usage model whereby sites can
   serve &quot;http&quot; URIs over TLS without being required to support strong
   server authentication.

   Opportunistic Security [RFC7435] does not provide the same guarantees
   as using TLS with &quot;https&quot; URIs; it is vulnerable to active attacks,
   and does not change the security context of the connection.
   Normally, users will not be able to tell that it is in use (i.e.,
   there will be no &quot;lock icon&quot;).
&quot;
[Note that *serve &quot;http&quot; URIs over TLS without being required* and *does
not change the security context of the connection* wording.]

Both HTTP and HTTPS are regular message syntax. Both MAY transit over
TLS. The *only* difference is the URL scheme name indicating whether TLS
layer security is mandatory or optional/opportunistic.

&gt;<i> 
</I>&gt;&gt;<i> This is where the security requirements and your ACL use-case differ.
</I>&gt;&gt;<i> Security requirements for those requests is that they be handled as per
</I>&gt;&gt;<i> any other <A HREF="http://">http://</A> - any encrytpion or security applied is *optional*.
</I>&gt;<i> 
</I>&gt;<i> No requirement can _force_ something to be optional! If the use case
</I>
I think you misunderstand me.

The forcing applied is: optional-&gt;mandatory.

It is done by using the received_encrypted ACL. Apparently without admin
intending to.


&gt;<i> demands that requests received over TLS are sent to icapS service, then
</I>&gt;<i> they should be sent to the icapS service, even if some of the
</I>&gt;<i> corresponding request owners would not mind to see their requests going
</I>&gt;<i> to the icapN service.
</I>
If you recall my very first words on this thread. I question the use-case.

 &quot;I object to making this ACL available *for this use case*.&quot;
[new emphasis].


Look closely:

+    if (!(filled-&gt;request-&gt;sources &amp; HttpMsg::srcUnsafe)  ||
+        (filled-&gt;reply &amp;&amp; !(filled-&gt;reply-&gt;sources &amp; HttpMsg::srcUnsafe)))
+        return 1;
+
+    return 0;

The permutations of match/non-match vs traffic source vs mask setters is
counter intuitive.

eg. when policy wants traffic only from TLS sources to use icapS the
rest to use icapN.

aka.
  adaptation_access icapS allow aclReceivedEncrypted
  adaptation_access icapN allow !aclReceivedEncrypted

aka.
 icapN to get used on the inverted union of whether both request and
reply are not unsafe.

aka.
   if (!0 || !0) ... icapS HTTPS proper handling (okay)
   if (!1 || !0) ... icapS opportunistic security (oops)
   if (!0 || !1) ... icapS opportunistic security (oops)
   if (!1 || !1) ... icapN HTTP normal handling (okay)


While I personally like the outcome (more security). Its clearly not
matching the use case presented as *sole* reason for the ACLs existence.
Nor the apparent admin policy in adaptation_access.


So I ask; why are we bothering with this ACL?
 Just use an <A HREF="https://">https://</A> scheme match, which will only be true in the top
line of above if()-matrix. Admin *wanting* &quot;opportunistic security&quot;
should not be the ones trying to avoid using icapS in the first place.


[I think that sums up what we are debating over. So I will refrain from
replying to the other sidetrails we got into.]

Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002828.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
	<LI>Next message: <A HREF="002838.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2832">[ date ]</a>
              <a href="thread.html#2832">[ thread ]</a>
              <a href="subject.html#2832">[ subject ]</a>
              <a href="author.html#2832">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
