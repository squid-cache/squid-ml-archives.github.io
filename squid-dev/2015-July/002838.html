<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] received_encrypted ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20received_encrypted%20ACL&In-Reply-To=%3C55B11497.8050008%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002832.html">
   <LINK REL="Next"  HREF="002841.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] received_encrypted ACL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20received_encrypted%20ACL&In-Reply-To=%3C55B11497.8050008%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] received_encrypted ACL">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jul 23 16:21:43 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002832.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
        <LI>Next message: <A HREF="002841.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2838">[ date ]</a>
              <a href="thread.html#2838">[ thread ]</a>
              <a href="subject.html#2838">[ subject ]</a>
              <a href="author.html#2838">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/23/2015 07:41 AM, Amos Jeffries wrote:
&gt;<i> On 23/07/2015 3:32 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 07/21/2015 04:25 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 21/07/2015 9:42 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> adaptation_access icapS aclIcap
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> adaptation_access icapN !aclIcap
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> aclIcap can be a received_encrypted ACL. What ACL expression would you
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> suggest for aclIcap if received_encrypted is not available?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>   # top 5 criteria - TLS transactions
</I>&gt;&gt;&gt;&gt;&gt;<i>   acl aclIcap allof HTTPS
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> What is &quot;HTTPS&quot; ACL? If it is based on the URI scheme, then AFAIK, it is
</I>&gt;&gt;&gt;&gt;<i> not going to work because it will not match bumped <A HREF="http://">http://</A> requests (at
</I>&gt;&gt;&gt;&gt;<i> least).
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Good you have seen those. That is what the HTTPbis WG call
</I>&gt;&gt;&gt;<i> &quot;opportunistic encryption&quot; traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I bet many (most?) of them are actually regular HTTP requests sent over
</I>&gt;&gt;<i> TLS/SSL connections. There is nothing opportunistic about them.
</I>&gt;<i> 
</I>&gt;<i> That is the very definition of &quot;opportunistic&quot; in the related HTTP
</I>&gt;<i> documentation.
</I>

Hi Amos,

    The opportunistic security (OS) documents you site talk about
optionally applying encryption to traffic X, to arrive at traffic XE. A
general-purpose intermediary cannot use those documents to go backwards
and say that any applied encryption was optional if we see traffic XE!
This backward direction is possible only when X or XE includes some sort
of an &quot;it is OK to decrypt at any time&quot; flag. Until such a flag is
defined for HTTP and/or TLS, and Squid learns to interpret it, the
discussion about opportunistic encryption is pretty much not relevant to
the received_encrypted ACL.

Moreover, the received_encrypted ACL itself and the related use cases do
not become wrong or obsolete when/if &quot;it is OK to decrypt at any time&quot;
flag is supported.

Is &quot;<A HREF="http://">http://</A>&quot; scheme such a flag? Not for Squid. That URI scheme existed
long before any of the HTTP WG proposals you site were written, so Squid
should not assume that an encrypted <A HREF="http://">http://</A> request is the result of OS.
Either a more reliable flag or an admin decision is required to enable
such behavior. All of this is orthogonal to received_encrypted.



&gt;&gt;&gt;<i> This is where the security requirements and your ACL use-case differ.
</I>&gt;&gt;&gt;<i> Security requirements for those requests is that they be handled as per
</I>&gt;&gt;&gt;<i> any other <A HREF="http://">http://</A> - any encrytpion or security applied is *optional*.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No requirement can _force_ something to be optional! If the use case
</I>&gt;<i> 
</I>&gt;<i> I think you misunderstand me.
</I>&gt;<i> 
</I>&gt;<i> The forcing applied is: optional-&gt;mandatory.
</I>&gt;<i> 
</I>&gt;<i> It is done by using the received_encrypted ACL. Apparently without admin
</I>&gt;<i> intending to.
</I>
Any assertion that uses a &quot;received ACL forces ...&quot; pattern is wrong. An
ACL is a yes/no test, nothing more. Yet, you keep blaming the ACL for
doing something other than testing. That does not compute for me.


&gt;&gt;<i> demands that requests received over TLS are sent to icapS service, then
</I>&gt;&gt;<i> they should be sent to the icapS service, even if some of the
</I>&gt;&gt;<i> corresponding request owners would not mind to see their requests going
</I>&gt;&gt;<i> to the icapN service.
</I>&gt;<i> 
</I>&gt;<i> If you recall my very first words on this thread. I question the use-case.
</I>
What does that mean? Are you saying the use case does not exist? That I
made it up? Or that we should not allow the admins to do what they want
to do? Something else?


&gt;<i> Look closely:
</I>
&gt;<i> +    if (!(filled-&gt;request-&gt;sources &amp; HttpMsg::srcUnsafe)  ||
</I>&gt;<i> +        (filled-&gt;reply &amp;&amp; !(filled-&gt;reply-&gt;sources &amp; HttpMsg::srcUnsafe)))
</I>&gt;<i> +        return 1;
</I>&gt;<i> +
</I>&gt;<i> +    return 0;
</I>
That code does not make sense to me. I think it should be written like
this instead:

    const bool safeRequest =
        !(filled-&gt;request-&gt;sources &amp; HttpMsg::srcUnsafe);
    const bool safeReply = !filled-&gt;reply ||
        !(filled-&gt;reply-&gt;sources &amp; HttpMsg::srcUnsafe);
    return (safeRequest &amp;&amp; safeReply) ? 1 : 0;

Furthermore, the values of &quot;unsafe&quot; srcX enum constants should be
increased to actually match the srcUnsafe mask (16 is still smaller than
0xFFFF).


&gt;<i> While I personally like the outcome (more security). Its clearly not
</I>&gt;<i> matching the use case presented as *sole* reason for the ACLs existence.
</I>&gt;<i> Nor the apparent admin policy in adaptation_access.
</I>
To me, it just looks like an implementation bug. Christos, do you think
the code should be rewritten as in my sketch above?


&gt;<i> So I ask; why are we bothering with this ACL?
</I>&gt;<i>  Just use an <A HREF="https://">https://</A> scheme match, which will only be true in the top
</I>&gt;<i> line of above if()-matrix. Admin *wanting* &quot;opportunistic security&quot;
</I>&gt;<i> should not be the ones trying to avoid using icapS in the first place.
</I>
I have answered that question several times already, including providing
specific examples requested by Kinkie: The URI scheme alone does not
match what the ACL is defined to match.


Cheers,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002832.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
	<LI>Next message: <A HREF="002841.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2838">[ date ]</a>
              <a href="thread.html#2838">[ thread ]</a>
              <a href="subject.html#2838">[ subject ]</a>
              <a href="author.html#2838">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
