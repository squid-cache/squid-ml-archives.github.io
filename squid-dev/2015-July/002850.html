<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] received_encrypted ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20received_encrypted%20ACL&In-Reply-To=%3C55B29C23.6010206%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002849.html">
   <LINK REL="Next"  HREF="002682.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] received_encrypted ACL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20received_encrypted%20ACL&In-Reply-To=%3C55B29C23.6010206%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] received_encrypted ACL">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 24 20:12:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002849.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
        <LI>Next message: <A HREF="002682.html">[squid-dev] checklist-&gt;conn assertion in DestinationIp.cc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2850">[ date ]</a>
              <a href="thread.html#2850">[ thread ]</a>
              <a href="subject.html#2850">[ subject ]</a>
              <a href="author.html#2850">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/07/2015 3:28 a.m., Alex Rousskov wrote:
&gt;<i> On 07/24/2015 05:26 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> I think you still misunderstand the OppSec RFC meanings.
</I>&gt;<i> 
</I>&gt;<i> Ditto.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Since SSL support first went into Squid back in 1998 we have allowed
</I>&gt;&gt;<i> cache_peer to connect to a remote https_port and sent <A HREF="http://">http://</A> traffic
</I>&gt;&gt;<i> over it.
</I>&gt;<i> 
</I>&gt;<i> Using the above as a sub-case of the use case we are considering, a
</I>&gt;<i> third independent proxy intercepting that peer-to-peer link (among other
</I>&gt;<i> traffic) should send bumped <A HREF="http://">http://</A> messages from that link to a remote
</I>&gt;<i> ICAP service using Secure ICAP. To configure that desirable behavior,
</I>&gt;<i> the intercepting proxy admin may use received_encrypted.
</I>&gt;<i> 
</I>&gt;<i> In short, what is &quot;optional&quot; or &quot;opportunistic&quot; for some is often
</I>&gt;<i> &quot;required&quot; or &quot;highly desirable&quot; for others. Independent intercepting
</I>&gt;<i> intermediaries should honor others' decision to use encryption, even
</I>&gt;<i> when that use was &quot;optional&quot; or &quot;opportunistic&quot;. There are many
</I>&gt;<i> exceptions and wrinkles to these simple rules of thumb, and the admin
</I>&gt;<i> has the power to configure them.
</I>&gt;<i> 
</I>
Good point. I can agree with that.

&gt;<i> 
</I>&gt;&gt;<i> * the &quot;received&quot; part of the AC type name seems a bit odd.
</I>&gt;&gt;<i>  - perhapse &quot;connections_encrypted&quot; makes more sense with the
</I>&gt;&gt;<i> description for it, and focus on TLS connections.
</I>&gt;<i> 
</I>&gt;<i> I disagree that connections_encrypted is better than received_encrypted,
</I>&gt;<i> especially in the presence of connectionless eCAP and
</I>&gt;<i> half-connectionless hits. A more general name may make this ACL more
</I>&gt;<i> forward-compatible.
</I>&gt;<i> 
</I>&gt;<i> However, if you insist, we will use your &quot;connections_encrypted&quot; name to
</I>&gt;<i> avoid discussing this further [unless somebody else suggests a better
</I>&gt;<i> name that you agree to, of course].
</I>
I think insist. With that [] caveat.

Regards the ecaps relationship. Its already been mentiond that ecap is
secure by default being &quot;just&quot; a library attachment. AFAIK that normally
a local machine memory-only thing. What would make eCAP services worthy
of the in-secure tag would usually be fetching/sending the data
externally over some type of unsecured connections. Just like ICAP vs
ICAPS. Which brings in the &quot;connection&quot; meaning to eCAP as well in an
only slightly twisted way.

Regards the &quot;half-connectionless hits&quot;. If the prior transactions
involved with the cache data matter that much they should be marked as
secure for <A HREF="https://">https://</A> and insecure for <A HREF="http://.">http://.</A>
 BUT, you convinced me earlier that the scope of the ACL was deciding if
the current transactions connections all used TLS (or not). Which means
that pulling details about past transactions into the current one is a
bit out of scope.
 The half-connection they do have is already marked in the sources data.
So that fits &quot;connections&quot; as well if one squints sideways.


&gt;<i> 
</I>&gt;&gt;<i> * you mentionend cache HITs earlier.
</I>&gt;&gt;<i>  - IMO you can drop all mention of cache HIT in the commit message on
</I>&gt;&gt;<i> grounds that no reply connection was involved with HIT at the scope
</I>&gt;&gt;<i> level of &quot;current transaction&quot;.
</I>&gt;<i> 
</I>&gt;<i> The new ACL is evaluated against the master transaction (a set of
</I>&gt;<i> messages), not reply connection, so we have to document what happens to
</I>&gt;<i> cache hits IMO. I hope that you will not object to more explicit
</I>&gt;<i> documentation as long as it is correct, matches the code, etc.
</I>&gt;<i> 
</I>
No I dont think I object to correct documentation :-)


What I meant was that the code was not actually doing any reply markings
in regards to cache HITs that I could see. So it seems irrelevant to
mention their lack of interaction with a non-existent reply connection
when it is not affecting the outcome.


&gt;<i> 
</I>&gt;&gt;<i> in src/HttpMsg.h:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Unless you are going to add secure eCAP flag functionality as part of
</I>&gt;&gt;<i> ths patch scope I dont see why we should have the extra code or enum for
</I>&gt;&gt;<i> srcEcaps existing yet.
</I>&gt;&gt;<i>  - please remove srcEcaps, or implement the ecaps flag feature.
</I>&gt;&gt;<i>  - TODO in places where the ecaps flag feature would need to hook in
</I>&gt;&gt;<i> seems sufficient to me at present.
</I>&gt;&gt;<i>  - what remains is plain eCAP which does not naturally involve network
</I>&gt;&gt;<i> connections, TLS or otherwise.
</I>&gt;&gt;<i>  - marking eCAP involvement does not seem useful either until that ecaps
</I>&gt;&gt;<i> feature is added. Please consider turning those into TODO as well,
</I>&gt;&gt;<i> though I will accept the current code for srcEcap.
</I>&gt;<i> 
</I>&gt;<i> I disagree that a TODO comment is better than correct, small, and
</I>&gt;<i> symmetric code, but we will replace eCAP-related code with TODO comments
</I>&gt;<i> to avoid prolonging this discussion.
</I>&gt;<i> 
</I>
Thank you.

I just realized after writing the above about eCAP that with a loaded
library being effectively secure by default and only certain uncommon
external activities making it non-secure. Then marking the traffic as
srcEcap == Unsafe before the ecaps flag exists is decreasing the amount
of visibly secure transactions. Erring on the side of insecurity rather
than security. Which is much of a sameness, but less desirable in common
cases.


&gt;<i> 
</I>&gt;&gt;<i> * can you explain the rational of doing this with a bitmask instead of a
</I>&gt;&gt;<i> default-true 'tlsEncrypted' boolean flag in class HttpMsg ?
</I>&gt;<i> 
</I>&gt;<i> IIRC, there were two reasons for using distinct, named flags:
</I>&gt;<i> 
</I>&gt;<i> 1. They simplify adding received_encrypted parameters that adjust how
</I>&gt;<i> the ACL is applied/computed.
</I>&gt;<i> 
</I>&gt;<i> 2. &quot;tlsEncrypted&quot; or similar does not work well for connection-less
</I>&gt;<i> things like eCAP and hits. By using protocol/module names, we were able
</I>&gt;<i> to avoid this naming problem.
</I>&gt;<i> 
</I>&gt;<i> Distinct flags also serve as an excellent way of finding various message
</I>&gt;<i> sources in Squid source code, but we probably did not realize that when
</I>&gt;<i> designing the code.
</I>
Okay. Fair enough.

&gt;<i> 
</I>&gt;<i> If you insist, we can use boolean storage OR reduce the storage member
</I>&gt;<i> size to 16 bits (let us know what would you prefer).
</I>
At this point I'm okay with the current design. It can be easily changed
later if we get on a serious minimalist rampage.


&gt;<i> 
</I>&gt;<i> Your other comments not discussed above should be addressed in the next
</I>&gt;<i> patch version. Please comment on what changes discussed above you insist on.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>
HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002849.html">[squid-dev] [PATCH] received_encrypted ACL
</A></li>
	<LI>Next message: <A HREF="002682.html">[squid-dev] checklist-&gt;conn assertion in DestinationIp.cc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2850">[ date ]</a>
              <a href="thread.html#2850">[ thread ]</a>
              <a href="subject.html#2850">[ subject ]</a>
              <a href="author.html#2850">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
