<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fix ICAP transactions that read a lot of data
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20ICAP%20transactions%20that%20read%20a%20lot%20of%20data&In-Reply-To=%3C55B2C164.1000000%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002859.html">
   <LINK REL="Next"  HREF="002855.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fix ICAP transactions that read a lot of data</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20ICAP%20transactions%20that%20read%20a%20lot%20of%20data&In-Reply-To=%3C55B2C164.1000000%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Fix ICAP transactions that read a lot of data">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jul 24 22:51:16 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002859.html">[squid-dev] [PATCH] chop() should always clear empty buffers
</A></li>
        <LI>Next message: <A HREF="002855.html">[squid-dev] [PATCH] Fix ICAP transactions that read a lot of	data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2852">[ date ]</a>
              <a href="thread.html#2852">[ thread ]</a>
              <a href="subject.html#2852">[ subject ]</a>
              <a href="author.html#2852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    Trunk r13995 (Parser-NG: Convert the ICAP read buffer to an SBuf)
broke ICAP transactions that read a lot of data because the new
SBuf::consume() method often does not free buffer space, unlike the old
MemBuf::consume(). Trunk r14173 (Parser-NG: Transfer-Encoding:chunked
Parser) did not have a material effect on this bug AFAICT, even though
it replaced at least one new explicit consume() call with an SBuf
assignment. I think that just effectively moved the consume() call(s)
elsewhere.

Affected transactions fail with mayReadMore() exceptions because their
readBuf.spaceSize() is zero while they need to read more data.

Any append,parse,consume;append,parse,consume;... user of SBuf cannot
rely on SBuf::spaceSize() to be meaningful because even consuming the
entire SBuf contents may leave spaceSize() at zero! Instead such code
has to use SBuf::length() to keep buffer from growing too big and
SBuf::rawSpace(1) to ensure some space is available for reading when the
buffer is not too big.

The attached patch fixes this bug in code based on trunk r14083. Judging
by cache.log, the same patch has the right effect on the current trunk
(r14173) as well. However, the current trunk seems to be broken in other
(non-ICAP) places [related to large transaction handling?] so I am
unable to fully test the patch there right now.


I have not carefully checked whether other new SBuf::consume() users are
affected. If somebody has the time, I recommend analyzing all
SBuf::spaceSize() uses.


Thank you,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: icap-ensure-space-t2.patch
Type: text/x-diff
Size: 5482 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150724/305466bc/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150724/305466bc/attachment.patch</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002859.html">[squid-dev] [PATCH] chop() should always clear empty buffers
</A></li>
	<LI>Next message: <A HREF="002855.html">[squid-dev] [PATCH] Fix ICAP transactions that read a lot of	data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2852">[ date ]</a>
              <a href="thread.html#2852">[ thread ]</a>
              <a href="subject.html#2852">[ subject ]</a>
              <a href="author.html#2852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
