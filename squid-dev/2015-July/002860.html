<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fix ICAP transactions that read a lot of data
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20ICAP%20transactions%20that%20read%20a%20lot%20of%0A%20data&In-Reply-To=%3C55B52831.9030909%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002855.html">
   <LINK REL="Next"  HREF="002854.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fix ICAP transactions that read a lot of data</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20ICAP%20transactions%20that%20read%20a%20lot%20of%0A%20data&In-Reply-To=%3C55B52831.9030909%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Fix ICAP transactions that read a lot of data">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jul 26 18:34:25 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002855.html">[squid-dev] [PATCH] Fix ICAP transactions that read a lot of	data
</A></li>
        <LI>Next message: <A HREF="002854.html">[squid-dev] [PATCH] display debug levels in cache.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2860">[ date ]</a>
              <a href="thread.html#2860">[ thread ]</a>
              <a href="subject.html#2860">[ subject ]</a>
              <a href="author.html#2860">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/24/2015 07:46 PM, Amos Jeffries wrote:
&gt;<i> On 25/07/2015 10:51 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> Affected transactions fail with mayReadMore() exceptions because their
</I>&gt;&gt;<i> readBuf.spaceSize() is zero while they need to read more data.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any append,parse,consume;append,parse,consume;... user of SBuf cannot
</I>&gt;&gt;<i> rely on SBuf::spaceSize() to be meaningful because even consuming the
</I>&gt;&gt;<i> entire SBuf contents may leave spaceSize() at zero! Instead such code
</I>&gt;&gt;<i> has to use SBuf::length() to keep buffer from growing too big and
</I>&gt;&gt;<i> SBuf::rawSpace(1) to ensure some space is available for reading when the
</I>&gt;&gt;<i> buffer is not too big.
</I>

&gt;<i> If you were using rawSpace(1) to avoid the possible reallocation by
</I>&gt;<i> reserveSpace() 
</I>
I use rawSpace() instead of reserveSpace() because reserveSpace()
guarantees single ownership, and we do not need that in the context of
an immediate ReadNow() call.


&gt;<i> it was not worth it. The reserveCapacity() used above it
</I>&gt;<i> is what reserveSpace() uses internally and causes that reallocation. So
</I>&gt;<i> its happening anyway.
</I>
Yes, I agree that the earlier reserveCapacity() call essentially blocks
the desired rawSpace() optimization, but I did not want to make
out-of-scope changes or even mark them with TODO/XXX comments, given the
tendency of those comments to be used against me by reviewers.

AFAICT, the rawSpace() call is in the right place. The reserveCapacity()
call may not be, but it does not cause the bug I am fixing. Somebody
should investigate whether [re]moving the reserveCapacity() call is
feasible. It probably is!



&gt;<i> It is probably better to do:
</I>&gt;<i>    rawSpace(SQUID_TCP_SO_RCVBUF - readBuf.length());
</I>

(*)I do not think so: The above &quot;greedy&quot; parameters will &quot;work&quot;, but we
are not trying to maximize space here because *always* getting the
maximum allowed space is often more expensive than using the available
space first.


&gt;<i> Which guarantees the requested size, without triggering as many
</I>&gt;<i> reallocates as reserveCapacity().
</I>
The greedy call guarantees more space than we need to make progress.
With the misplaced reserveCapacity() call above, it probably does not
have any [negative or positive] effect, but if somebody [re]moves that
reserveCapacity() call, the greedy parameters will start working against us.


&gt;<i> client_side.cc/http.cc both also use reserveSpace(N) instead of
</I>&gt;<i> rawSpace(N). Which may reallocate a lot more. Seems like a mistake to
</I>&gt;<i> avoid the SBuf API marked &quot;EXTREME caution&quot;. At least for I/O.
</I>
The SBuf space-related API is broken IMO. Nearly all of the related
methods need an &quot;EXTREME caution&quot; mark, for various context-dependent
reasons. This is a side effect of using SBuf for both &quot;raw I/O buffer&quot;
and &quot;meaningful string&quot; roles. I regret not insisting on role separation
at the time when SBuf was being added.


&gt;<i> So lots more reading into many smaller buffers. That was one of the
</I>&gt;<i> goals right ? :-P
</I>
Unknown to me: IIRC, the attempts to actually establish a clear
performance model for SBuf I/O code have failed. Most of the work was
focusing on &quot;meaningful string&quot; manipulations. The &quot;How are we going to
implement and integrate read/decode and encode/write loops efficiently?&quot;
question was raised a few times, but I do not remember it getting any
serious traction.


Thank you for checking other spaceSize() uses.


&gt;<i> +1, Please apply ASAP after considering the above mentioned alteration
</I>&gt;<i> of rawSpace(1).
</I>

Committed to trunk (r14180). Please see above for the rawSpace()
parameter value discussion at (*).


Thank you,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002855.html">[squid-dev] [PATCH] Fix ICAP transactions that read a lot of	data
</A></li>
	<LI>Next message: <A HREF="002854.html">[squid-dev] [PATCH] display debug levels in cache.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2860">[ date ]</a>
              <a href="thread.html#2860">[ thread ]</a>
              <a href="subject.html#2860">[ subject ]</a>
              <a href="author.html#2860">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
