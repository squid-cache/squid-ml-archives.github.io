<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Coverity fixes, part 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%20fixes%2C%20part%203&In-Reply-To=%3C55B541BD.8070705%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002861.html">
   <LINK REL="Next"  HREF="002863.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Coverity fixes, part 3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Coverity%20fixes%2C%20part%203&In-Reply-To=%3C55B541BD.8070705%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Coverity fixes, part 3">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jul 26 20:23:25 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002861.html">[squid-dev] [PATCH] Coverity fixes, part 3
</A></li>
        <LI>Next message: <A HREF="002863.html">[squid-dev] [PATCH] Coverity fixes, part 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2862">[ date ]</a>
              <a href="thread.html#2862">[ thread ]</a>
              <a href="subject.html#2862">[ subject ]</a>
              <a href="author.html#2862">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/07/2015 4:48 a.m., Kinkie wrote:
&gt;<i> HI,
</I>&gt;<i>   the low-hanging fruits from Coverity's analysis have been picked, now
</I>&gt;<i> working on somewhat more complex fixes.
</I>&gt;<i> The attached patch takes a hint from two benign coverity defects to:
</I>
&gt;<i> - refactor Digest auth's field lookup table to use a std::map instead of
</I>&gt;<i> abusing httpHeaderFieldsInfo; this improves readability and size of the
</I>&gt;<i> code, and has the added small bonus of lowering the lookup cost from linear
</I>&gt;<i> to logarithmic
</I>&gt;<i> 
</I>&gt;<i> the Digest code has been run-tested. I'd like feedback on its style, as
</I>&gt;<i> httpHeaderFieldsInfo is abused similarly elswehere and I'm considering to
</I>&gt;<i> apply it elsewhere as well; it can then be further refined to get O(1) via
</I>&gt;<i> a carefully-chosen hash (via std::unsorted_map)
</I>&gt;<i> 
</I>
My thoughts: (sorry if its a bit rambling)

I dont like spawning lots of new classes for basic things. I know its
essentially the C++ way. But applying pattern theory can go too far
sometimes. And this patterns usage is one case where I can see exactly
that happening.

You have a struct, a class, an enum and array. Thats a lot of custom
infrastructure just to represent a simple set of name:id. We could as
easily have std::map&lt;const char*, enum&gt; holding that directly and avoid
all the local types except enum.

There are already 5 headers currently in Squid that need these same
operations applied, and at least as many more that should but dont even
use the current HttpHeaderFieldAttrs related types yet.



struct HttpDigestFieldAttrs should be a template class so we dont have
to re-implement a new little struct for each enum.

BUT, notice that generalizing that same structure is also where the enum
casting hack for HttpHeaderFieldAttrs comes from in the first place.
 The probkem was template style breaks with C++03 compilers thinking all
enums are of &quot;int&quot; type. Enter lots of repeated-instantiation complaints
from dumb compilers.
 I've not tried it with current C++11 compilers which are quite a bit
smarter. It may work now (or not).

If *that* can be solved then refactoring HttpHeaderFieldAttrs to a
template is better way forward. Maybe followed by replacing or
refactoring the HttpHeaderFieldInfo bits to avoid the performance
problem you identified.

Amos

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002861.html">[squid-dev] [PATCH] Coverity fixes, part 3
</A></li>
	<LI>Next message: <A HREF="002863.html">[squid-dev] [PATCH] Coverity fixes, part 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2862">[ date ]</a>
              <a href="thread.html#2862">[ thread ]</a>
              <a href="subject.html#2862">[ subject ]</a>
              <a href="author.html#2862">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
