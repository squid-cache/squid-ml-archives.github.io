<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Refactor HttpHeader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Refactor%20HttpHeader&In-Reply-To=%3C55B9464E.9030100%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002879.html">
   <LINK REL="Next"  HREF="002881.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Refactor HttpHeader</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Refactor%20HttpHeader&In-Reply-To=%3C55B9464E.9030100%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Refactor HttpHeader">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 29 21:31:58 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002879.html">[squid-dev] [RFC] Refactor HttpHeader
</A></li>
        <LI>Next message: <A HREF="002881.html">[squid-dev] [RFC] Refactor HttpHeader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2880">[ date ]</a>
              <a href="thread.html#2880">[ thread ]</a>
              <a href="subject.html#2880">[ subject ]</a>
              <a href="author.html#2880">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/07/2015 9:10 a.m., Kinkie wrote:
&gt;<i> Hi all,
</I>&gt;<i>    I'm starting to work on refactoring HttpHeader to use LookupTable, and
</I>&gt;<i> boy that code is a mess..
</I>&gt;<i> 
</I>&gt;<i> Since it's going to take significant effort, I'd like to get feedback on
</I>&gt;<i> the changes I'd like to implement, so not to end in long discussions later.
</I>&gt;<i> 
</I>&gt;<i> Current data structures:
</I>&gt;<i> HeadersAttrs: static declaration of header name, header ID, header type
</I>&gt;<i> (string/int/etc). Must be sorted by numeric value of ID
</I>&gt;<i> Headers: built at initialization time from HeadersAttrs, it's an array of
</I>&gt;<i> (name, id, type, stats) structs
</I>&gt;<i> ListHeadersArr, GeneralHeadersArr, EntityHeadersArr, RequestHeadersArr,
</I>&gt;<i> ReplyHeadersArr, etc: lists of headers ID (possibly overlapping) which are
</I>&gt;<i> used to generate..
</I>&gt;<i> ListHeadersMask, GeneralHeadersArr, EntityHeadersArr etc: bitmaps used
</I>&gt;<i> (only) by HttpHeaderStats to assemble different stats sets
</I>
I seem to recall a hop-by-hop headers lists as well and the
request/reply lists being used by message filtering logic to strip away
invalid and hop-by-hop headers ?

&gt;<i> 
</I>&gt;<i> I would like to turn these into:
</I>&gt;<i> headerTable: LookupTable&lt;&gt;::Record mapping header name to header ID, used
</I>&gt;<i> to generate ...
</I>&gt;<i> headerLookupTable: a fast lookup table of header names to ids
</I>&gt;<i> headerStatsTable: a std::vector&lt;HttpHeaderFieldStat&gt; indexed by header ID
</I>&gt;<i> to collect the statistics currently in Headers[id].stats.
</I>&gt;<i> headerDescription: a std::vector keyed by header ID containing header type
</I>&gt;<i> (currently in Headers[id].type), possibly header name (if useful), a
</I>&gt;<i> bitfield noting if HTTP_HDR{LIST,GENERAL,REQUEST,REPLY,...}.
</I>&gt;<i> 
</I>&gt;<i> There are some possible optimizations, but at a minimum this should help
</I>&gt;<i> keep information more organized while introducing no performance
</I>&gt;<i> regressions.
</I>&gt;<i> What do you think?
</I>&gt;<i> 
</I>
In my brief look the other day I thought a small struct {ID, type, group
bitmask} could be used as the EnumType on LookupTable.

LookupTable really only needs a POD type that can be copied cheaply for
its stored type. Enum / int is the simplest of those but not mandatory.

If that works then you can collapse headerLookupTable and
headerDescription into one list that efficiently looks up all data for
the header. Getting rid of the multiple sub-list type arrays.

Amos
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002879.html">[squid-dev] [RFC] Refactor HttpHeader
</A></li>
	<LI>Next message: <A HREF="002881.html">[squid-dev] [RFC] Refactor HttpHeader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2880">[ date ]</a>
              <a href="thread.html#2880">[ thread ]</a>
              <a href="subject.html#2880">[ subject ]</a>
              <a href="author.html#2880">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
