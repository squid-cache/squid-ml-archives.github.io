<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Bug 3875 MimeIcon error handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%203875%20MimeIcon%20error%20handling&In-Reply-To=%3C556D0212.4060406%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002398.html">
   <LINK REL="Next"  HREF="002403.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Bug 3875 MimeIcon error handling</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%203875%20MimeIcon%20error%20handling&In-Reply-To=%3C556D0212.4060406%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Bug 3875 MimeIcon error handling">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun  2 01:08:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002398.html">[squid-dev] [PATCH] Bug 3875 MimeIcon error handling
</A></li>
        <LI>Next message: <A HREF="002403.html">[squid-dev] [PATCH] Bug 3875 MimeIcon error handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2399">[ date ]</a>
              <a href="thread.html#2399">[ thread ]</a>
              <a href="subject.html#2399">[ subject ]</a>
              <a href="author.html#2399">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/06/2015 12:23 p.m., Alex Rousskov wrote:
&gt;<i> On 06/01/2015 05:33 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 21/05/2015 3:22 a.m., Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> This is an attempt to improve the MimeIcon reliability when filesystem
</I>&gt;&gt;&gt;<i> I/O errors or others cause the icon data to not be loadable.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The loading process is re-worked to guarantee that once the
</I>&gt;&gt;&gt;<i> MimeIon::created callback occurs it will result in a valid StoreEntry in
</I>&gt;&gt;&gt;<i> the cache representing the wanted icon.
</I>&gt;&gt;&gt;<i>  * If the image can be loaded without any issues it will be placed in
</I>&gt;&gt;&gt;<i> the cache as a 200 response.
</I>&gt;&gt;&gt;<i>  * If errors prevent the image being loaded or necessary parameters
</I>&gt;&gt;&gt;<i> (size and mtime) being known a 204 object will be placed into the cache.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have selected 204 as the representation of errors since the bug is not
</I>&gt;&gt;&gt;<i> in the clients request (eliminating 400, 404, etc), a 500 would be
</I>&gt;&gt;&gt;<i> revealing details about server internals unnecessarily often and incur
</I>&gt;&gt;&gt;<i> extra complexity creating the error page. 204 also avoids needing to set
</I>&gt;&gt;&gt;<i> and emit Content-Length header, and just enough different from 200 to
</I>&gt;&gt;&gt;<i> use as a special-case test.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NP: It started with just correcting the errno usage, but other bugs
</I>&gt;&gt;&gt;<i> promptly started appearing once I got to seriously testing this load
</I>&gt;&gt;&gt;<i> process. So far it fixes:
</I>&gt;&gt;&gt;<i> * several assertions resulting from StoreEntry being left invalid in
</I>&gt;&gt;&gt;<i> cache limbo beween created hash entries and valid mem_obj data.
</I>&gt;&gt;&gt;<i> * on startup 6+ repeated attempts to load absent icons files which dont
</I>&gt;&gt;&gt;<i> exist in the filesystem.
</I>&gt;&gt;&gt;<i> * buffer overfow on misconfigured or corrupt mime.conf file entries
</I>&gt;&gt;&gt;<i> * incorrect debugs messages about file I/O errors
</I>&gt;&gt;&gt;<i> * large error pages delivered when icons not installed (when it doesnt
</I>&gt;&gt;&gt;<i> assert from the StoreEntry)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> If there are no objections I will appy this tomorrow.
</I>&gt;<i> 
</I>&gt;<i> Using a successful 2xx code to indicate an error sounds like a mistake
</I>&gt;<i> to me. Moreover, 204 responses have special framing rules that increase
</I>&gt;<i> the chance of them being misinterpreted by poorly written clients.
</I>
Its not a protocol error. It may or not be a configuration error on the
part of the sysadmin though.

The proxy has been explicitly configured to &quot;know&quot; this icon URL and has
no content loaded from disk to deliver for it. As far as the client and
any downstream intermediaries are concerned that is the relevant info.

&gt;<i> 
</I>&gt;<i> If there are no better error codes, I suggest using a 503 Service
</I>&gt;<i> Unavailable response. If it is difficult to adjust the code to serve an
</I>&gt;<i> existing error message in this context, then just set Content-Length to
</I>&gt;<i> zero or close connection, whichever is easier.
</I>
503 is not appropriate. That implies Connection:close and client being
diverted to another server/proxy (if using PAC or reverse-proxy). The
issue here has nothing to do with the connection or future usability of
the proxy producing this response.


If we are going to advertise these at all to the client, then 500 is the
only applicable registered 5xx status. Since it is also technically an
&quot;Internal Error&quot; while loading the icon.

I dont believe there is anything worth informing the client about
though. If the admin cares about the icons and notices them absent the
errors are logged at the time they actually occur, the cached icon object.

&gt;<i> 
</I>&gt;<i> You have mentioned that 204 &quot;avoids needing to set [...] Content-Length
</I>&gt;<i> header&quot;, but AFAICT, the content length is just a setHeaders() parameter
</I>&gt;<i> which can be zero. In fact, your patch uses it! It looks like that part
</I>&gt;<i> of the argument against a true error response is invalid.
</I>
FWIW, &quot;set and emit&quot;. Saving a few bytes in the headers and allows the
response to be cacheable by default. Both being incidental to the
problems I'm fixing, but potentially useful in general if the URL gets
hit a lot.


&gt;<i> 
</I>&gt;<i> If you are sure your solution is better than doing nothing, please do
</I>&gt;<i> not interpret the above as an objection.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If you decide to commit this, please do include your NP paragraph to
</I>&gt;<i> document what kind of &quot;reliability&quot; problems this patch fixes.
</I>&gt;<i> 
</I>
Okay.

Amos

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002398.html">[squid-dev] [PATCH] Bug 3875 MimeIcon error handling
</A></li>
	<LI>Next message: <A HREF="002403.html">[squid-dev] [PATCH] Bug 3875 MimeIcon error handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2399">[ date ]</a>
              <a href="thread.html#2399">[ thread ]</a>
              <a href="subject.html#2399">[ subject ]</a>
              <a href="author.html#2399">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
