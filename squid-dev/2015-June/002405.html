<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] TLS: Add support for EECDH
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20TLS%3A%20Add%20support%20for%20EECDH&In-Reply-To=%3C55709E3F.3070502%40ufscar.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002472.html">
   <LINK REL="Next"  HREF="002407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] TLS: Add support for EECDH</H1>
    <B>Paulo Matias</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20TLS%3A%20Add%20support%20for%20EECDH&In-Reply-To=%3C55709E3F.3070502%40ufscar.br%3E"
       TITLE="[squid-dev] [PATCH] TLS: Add support for EECDH">matias at ufscar.br
       </A><BR>
    <I>Thu Jun  4 18:51:43 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002472.html">[squid-dev] [PATCH] TLS: Disable client-initiated renegotiation
</A></li>
        <LI>Next message: <A HREF="002407.html">[squid-dev] [PATCH] TLS: Add support for EECDH
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2405">[ date ]</a>
              <a href="thread.html#2405">[ thread ]</a>
              <a href="subject.html#2405">[ subject ]</a>
              <a href="author.html#2405">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

This patch adds support for Ephemeral Elliptic Curve Diffie-Hellman (EECDH)
key exchange, which allows for forward secrecy with better performance than
traditional ephemeral DH.

This was previously posted to squid-users, but modified since then to implement
Amos's suggestions:

&gt;<i> * the DH parameters I think would be better added as a new option
</I>&gt;<i> &quot;tls-dh=curve:/path/to/params&quot; where the 'curve' part is optional and
</I>&gt;<i> implies EC when present - non-EC when absent.
</I>
OK, I have left the &quot;dhparams=&quot; option working as before, but emitting a
deprecation warning message. There is a new &quot;tls-dh=&quot; option which should
replace &quot;dhparams=&quot;, and supports the suggested syntax. The following
are also accepted:

 * &quot;tls-dh=:/path/to/params&quot; -&gt; equivalent to &quot;tls-dh=/path/to/params&quot;
 * &quot;tls-dh=curve:&quot; -&gt; allows for enabling only EECDH (no EDH)

&gt;<i> * SINGLE_ECDH_USE needs to be documented in release-4.sgml
</I>&gt;<i>  &quot;New &lt;em&gt;options=SINGLE_ECDH_USE&lt;/em&gt; parameter to ...&quot;
</I>
OK.

&gt;<i> * The ECDH changes affect both https_port and http_port. They need
</I>&gt;<i> separate listings for each under changed directives, duplicate text on
</I>&gt;<i> the line items is fine.
</I>
OK.

&gt;<i> * please implement (duplicate) all this UI parse change using the
</I>&gt;<i> Security::PeerOptions object (src/security/PeerOptions.*)
</I>&gt;<i>  - the src/ssl/* code for UI parsing and config storage is 'legacy' only
</I>&gt;<i> use by http(s)_port directives.
</I>&gt;<i>  - this may require some small changes suitable for use on client contexts
</I>&gt;<i>  - UI options added to Security::PeerOptions get documented in
</I>&gt;<i> release-4.sgml as changes for both cache_peer and tls_outgoing_options.
</I>&gt;<i>  - also in cf.data.pre for those directives
</I>
If I understood correctly, Security::PeerOptions is currently only used
for client TLS contexts. Currently, it does not implement e.g. the &quot;dhparams=&quot;
option, which is only supposed to be present when configuring a server
TLS context. According to
<A HREF="http://openssl.6102.n7.nabble.com/question-about-ecdh-functions-tp38239p38242.html,">http://openssl.6102.n7.nabble.com/question-about-ecdh-functions-tp38239p38242.html,</A>
the curve should also be configured only in the server context. Also,
<A HREF="https://github.com/openssl/openssl/blob/e481f9b90b164fd1053015d1c4e0a0d92076d7a8/ssl/ssl_conf.c#L450">https://github.com/openssl/openssl/blob/e481f9b90b164fd1053015d1c4e0a0d92076d7a8/ssl/ssl_conf.c#L450</A>
shows that the &quot;named_curve&quot; parameter is only allowed in the s_server
OpenSSL tool, therefore not allowed in s_client.

Therefore this is not included in the patch below. Please correct me if I
misunderstood anything.

&gt;<i> * configureSslEECDH() return true in the event that the chosen
</I>&gt;<i> configuration options are not even available.
</I>&gt;<i>  - please make an #else condition that displays an ERROR message at
</I>&gt;<i> level DBG_CRITICAL about the option(s) not being available, then return
</I>&gt;<i> false.
</I>&gt;<i>  - variable 'ok' can then become const (define on assignment) and move
</I>&gt;<i> fully inside the #if case.
</I>
OK.

We welcome any additional suggestions or comments.

Best regards,
Paulo Matias


-------------- next part --------------
=== modified file 'doc/release-notes/release-4.sgml'
--- doc/release-notes/release-4.sgml	2015-05-22 09:42:55 +0000
+++ doc/release-notes/release-4.sgml	2015-06-04 14:59:38 +0000
@@ -137,6 +137,12 @@
 	&lt;p&gt;All &lt;em&gt;options=&lt;/em&gt; values for SSLv2
 	   configuration or disabling have been removed.
 	&lt;p&gt;Removed &lt;em&gt;version=&lt;/em&gt; option. Use &lt;em&gt;options=&lt;/em&gt; instead.
+	&lt;p&gt;New &lt;em&gt;options=SINGLE_ECDH_USE&lt;/em&gt; parameter to enable ephemeral
+	   ECDH key exchange.
+	&lt;p&gt;Deprecated &lt;em&gt;dhparams=&lt;/em&gt; option. Use &lt;em&gt;tls-dh=&lt;/em&gt; instead.
+	   The new option allows to optionally specify an elliptic curve for
+	   ephemeral ECDH by adding &lt;em&gt;curve-name:&lt;/em&gt; in front of the
+	   parameter file name.
 	&lt;p&gt;Manual squid.conf update may be required on upgrade.
 
 	&lt;tag&gt;sslcrtd_children&lt;/tag&gt;

=== modified file 'src/anyp/PortCfg.cc'
--- src/anyp/PortCfg.cc	2015-05-22 09:42:55 +0000
+++ src/anyp/PortCfg.cc	2015-06-04 13:36:42 +0000
@@ -54,6 +54,7 @@
     capath(NULL),
     crlfile(NULL),
     dhfile(NULL),
+    tls_dh(NULL),
     sslflags(NULL),
     sslContextSessionId(NULL),
     generateHostCertificates(false),
@@ -67,6 +68,7 @@
     clientVerifyCrls(),
     clientCA(),
     dhParams(),
+    eecdhCurve(NULL),
     contextMethod(),
     sslContextFlags(0),
     sslOptions(0)
@@ -95,8 +97,10 @@
     safe_free(capath);
     safe_free(crlfile);
     safe_free(dhfile);
+    safe_free(tls_dh);
     safe_free(sslflags);
     safe_free(sslContextSessionId);
+    safe_free(eecdhCurve);
 #endif
 }
 
@@ -140,6 +144,8 @@
         b-&gt;crlfile = xstrdup(crlfile);
     if (dhfile)
         b-&gt;dhfile = xstrdup(dhfile);
+    if (tls_dh)
+        b-&gt;tls_dh = xstrdup(tls_dh);
     if (sslflags)
         b-&gt;sslflags = xstrdup(sslflags);
     if (sslContextSessionId)
@@ -227,8 +233,27 @@
     contextMethod = SSLv23_server_method();
 #endif
 
-    if (dhfile)
-        dhParams.reset(Ssl::readDHParams(dhfile));
+    const char *dhFile = dhfile; // backward compatibility for dhparams= configuration
+
+    if (tls_dh &amp;&amp; tls_dh[0]) {
+        safe_free(eecdhCurve);
+        eecdhCurve = xstrdup(tls_dh);
+        char *p = strchr(eecdhCurve, ':');
+        if (p) {  // tls-dh=eecdhCurve:dhfile
+            *p = '\0';
+            dhFile = p+1;
+        } else {  // tls-dh=dhfile is equivalent to tls-dh=:dhfile
+            dhFile = tls_dh;
+            eecdhCurve[0] = '\0';
+        }
+    }
+
+    if (dhFile &amp;&amp; dhFile[0])
+        dhParams.reset(Ssl::readDHParams(dhFile));
+
+    // an empty eecdhCurve means &quot;do not use EECDH&quot;
+    if (eecdhCurve &amp;&amp; !eecdhCurve[0])
+        safe_free(eecdhCurve);
 
     if (sslflags)
         sslContextFlags = Ssl::parse_flags(sslflags);

=== modified file 'src/anyp/PortCfg.h'
--- src/anyp/PortCfg.h	2015-01-13 07:25:36 +0000
+++ src/anyp/PortCfg.h	2015-06-03 19:36:39 +0000
@@ -78,6 +78,7 @@
     char *capath;
     char *crlfile;
     char *dhfile;
+    char *tls_dh;
     char *sslflags;
     char *sslContextSessionId; ///&lt; &quot;session id context&quot; for staticSslContext
     bool generateHostCertificates; ///&lt; dynamically make host cert for sslBump
@@ -93,6 +94,7 @@
     Ssl::X509_CRL_STACK_Pointer clientVerifyCrls; ///&lt; additional CRL lists to use when verifying the client certificate
     Ssl::X509_NAME_STACK_Pointer clientCA; ///&lt; CA certificates to use when verifying client certificates
     Ssl::DH_Pointer dhParams; ///&lt; DH parameters for temporary/ephemeral DH key exchanges
+    char *eecdhCurve; ///&lt; Elliptic curve for ephemeral EC-based DH key exchanges
     Ssl::ContextMethod contextMethod; ///&lt; The context method (SSL_METHOD) to use when creating certificates
     long sslContextFlags; ///&lt; flags modifying the use of SSL
     long sslOptions; ///&lt; SSL engine options

=== modified file 'src/cache_cf.cc'
--- src/cache_cf.cc	2015-05-22 09:42:55 +0000
+++ src/cache_cf.cc	2015-06-03 19:13:55 +0000
@@ -3612,8 +3612,13 @@
         safe_free(s-&gt;crlfile);
         s-&gt;crlfile = xstrdup(token + 8);
     } else if (strncmp(token, &quot;dhparams=&quot;, 9) == 0) {
+        debugs(3, DBG_PARSE_NOTE(DBG_IMPORTANT), &quot;WARNING: '&quot; &lt;&lt; token &lt;&lt; &quot;' is deprecated &quot; &lt;&lt;
+               &quot;in &quot; &lt;&lt; cfg_directive &lt;&lt; &quot;. Use 'tls-dh=' instead.&quot;);
         safe_free(s-&gt;dhfile);
         s-&gt;dhfile = xstrdup(token + 9);
+    } else if (strncmp(token, &quot;tls-dh=&quot;, 7) == 0) {
+        safe_free(s-&gt;tls_dh);
+        s-&gt;tls_dh = xstrdup(token + 7);
     } else if (strncmp(token, &quot;sslflags=&quot;, 9) == 0) {
         safe_free(s-&gt;sslflags);
         s-&gt;sslflags = xstrdup(token + 9);
@@ -3834,6 +3839,9 @@
     if (s-&gt;dhfile)
         storeAppendPrintf(e, &quot; dhparams=%s&quot;, s-&gt;dhfile);
 
+    if (s-&gt;tls_dh)
+        storeAppendPrintf(e, &quot; tls-dh=%s&quot;, s-&gt;tls_dh);
+
     if (s-&gt;sslflags)
         storeAppendPrintf(e, &quot; sslflags=%s&quot;, s-&gt;sslflags);
 

=== modified file 'src/cf.data.pre'
--- src/cf.data.pre	2015-06-02 12:04:00 +0000
+++ src/cf.data.pre	2015-06-03 21:14:04 +0000
@@ -1935,6 +1935,11 @@
 				      Always create a new key when using
 				      temporary/ephemeral DH key exchanges
 
+			    SINGLE_ECDH_USE
+				      Enable ephemeral ECDH key exchange.
+				      The adopted curve should be specified
+				      using the tls-dh option.
+
 			    NO_TICKET
 				      Disable use of RFC5077 session tickets.
 				      Some servers may have problems
@@ -1963,11 +1968,15 @@
 			the client certificate, in addition to CRLs stored in
 			the capath. Implies VERIFY_CRL flag below.
 
-	   dhparams=	File containing DH parameters for temporary/ephemeral
-			DH key exchanges. See OpenSSL documentation for details
-			on how to create this file.
-			WARNING: EDH ciphers will be silently disabled if this
-				 option is not set.
+	   tls-dh=[curve:]file
+			File containing DH parameters for temporary/ephemeral DH key
+			exchanges, optionally prefixed by a curve for ephemeral ECDH
+			key exchanges.
+			See OpenSSL documentation for details on how to create the
+			DH parameter file. Supported curves for ECDH can be listed
+			using the &quot;openssl ecparam -list_curves&quot; command.
+			WARNING: EDH and EECDH ciphers will be silently disabled if
+				 this option is not set.
 
 	   sslflags=	Various flags modifying the use of SSL:
 			    DELAYED_AUTH
@@ -2110,6 +2119,11 @@
 				      Always create a new key when using
 				      temporary/ephemeral DH key exchanges
 
+			    SINGLE_ECDH_USE
+				      Enable ephemeral ECDH key exchange.
+				      The adopted curve should be specified
+				      using the tls-dh option.
+
 			    SSL_OP_NO_TICKET
 				      Disable use of RFC5077 session tickets.
 				      Some servers may have problems
@@ -2138,8 +2152,10 @@
 			the client certificate, in addition to CRLs stored in
 			the capath. Implies VERIFY_CRL flag below.
 
-	   dhparams=	File containing DH parameters for temporary/ephemeral
-			DH key exchanges.
+	   tls-dh=[curve:]file
+			File containing DH parameters for temporary/ephemeral DH key
+			exchanges, optionally prefixed by a curve for ephemeral ECDH
+			key exchanges.
 
 	   sslflags=	Various flags modifying the use of SSL:
 			    DELAYED_AUTH

=== modified file 'src/ssl/support.cc'
--- src/ssl/support.cc	2015-06-03 10:42:08 +0000
+++ src/ssl/support.cc	2015-06-04 14:53:55 +0000
@@ -472,6 +472,11 @@
         &quot;NO_TICKET&quot;, SSL_OP_NO_TICKET
     },
 #endif
+#if SSL_OP_SINGLE_ECDH_USE
+    {
+        &quot;SINGLE_ECDH_USE&quot;, SSL_OP_SINGLE_ECDH_USE
+    },
+#endif
     {
         &quot;&quot;, 0
     },
@@ -824,6 +829,29 @@
 }
 
 static bool
+configureSslEECDH(SSL_CTX *sslContext, const char *curve)
+{
+#if OPENSSL_VERSION_NUMBER &gt;= 0x0090800fL &amp;&amp; !defined(OPENSSL_NO_ECDH)
+    int nid = OBJ_sn2nid(curve);
+    if (!nid) {
+        debugs(83, DBG_CRITICAL, &quot;ERROR: Unknown EECDH curve '&quot; &lt;&lt; curve &lt;&lt; &quot;'&quot;);
+        return false;
+    }
+
+    EC_KEY *ecdh = EC_KEY_new_by_curve_name(nid);
+    if (ecdh == NULL)
+        return false;
+
+    const bool ok = SSL_CTX_set_tmp_ecdh(sslContext, ecdh) != 0;
+    EC_KEY_free(ecdh);
+    return ok;
+#else
+    debugs(83, DBG_CRITICAL, &quot;ERROR: EECDH is not available in this build&quot;);
+    return false;
+#endif
+}
+
+static bool
 configureSslContext(SSL_CTX *sslContext, AnyP::PortCfg &amp;port)
 {
     int ssl_error;
@@ -855,6 +883,16 @@
     debugs(83, 9, &quot;Setting RSA key generation callback.&quot;);
     SSL_CTX_set_tmp_rsa_callback(sslContext, ssl_temp_rsa_cb);
 
+    if (port.eecdhCurve) {
+        debugs(83, 9, &quot;Setting Ephemeral ECDH curve to &quot; &lt;&lt; port.eecdhCurve &lt;&lt; &quot;.&quot;);
+
+        if (!configureSslEECDH(sslContext, port.eecdhCurve)) {
+            ssl_error = ERR_get_error();
+            debugs(83, DBG_CRITICAL, &quot;ERROR: Unable to configure Ephemeral ECDH: &quot; &lt;&lt; ERR_error_string(ssl_error, NULL));
+            return false;
+        }
+    }
+
     debugs(83, 9, &quot;Setting CA certificate locations.&quot;);
 
     const char *cafile = port.cafile ? port.cafile : port.clientca;


</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002472.html">[squid-dev] [PATCH] TLS: Disable client-initiated renegotiation
</A></li>
	<LI>Next message: <A HREF="002407.html">[squid-dev] [PATCH] TLS: Add support for EECDH
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2405">[ date ]</a>
              <a href="thread.html#2405">[ thread ]</a>
              <a href="subject.html#2405">[ subject ]</a>
              <a href="author.html#2405">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
