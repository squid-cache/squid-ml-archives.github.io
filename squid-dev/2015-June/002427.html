<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Injecting custom JavaScript
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Injecting%20custom%20JavaScript&In-Reply-To=%3C5582BC6E.5010800%40jartechnologies.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002425.html">
   <LINK REL="Next"  HREF="002436.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Injecting custom JavaScript</H1>
    <B>James Hunter</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Injecting%20custom%20JavaScript&In-Reply-To=%3C5582BC6E.5010800%40jartechnologies.com%3E"
       TITLE="[squid-dev] Injecting custom JavaScript">james.hunter at jartechnologies.com
       </A><BR>
    <I>Thu Jun 18 12:41:18 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002425.html">[squid-dev] Injecting custom JavaScript
</A></li>
        <LI>Next message: <A HREF="002436.html">[squid-dev] Injecting custom JavaScript
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2427">[ date ]</a>
              <a href="thread.html#2427">[ thread ]</a>
              <a href="subject.html#2427">[ subject ]</a>
              <a href="author.html#2427">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

&gt;<i> On 18/06/2015 11:42 p.m., James Hunter wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've been looking to inject special JavaScript code into every HTML page
</I>&gt;&gt;<i> my squid proxy receives via HTTPS connections, this is for an
</I>&gt;&gt;<i> application where the users will be fully aware of the injection.
</I>&gt;<i> Lets start with how this is a truly terrible idea.
</I>&gt;<i>
</I>&gt;<i> The content you are seeking to change is:
</I>&gt;<i> a) somebody elses property,
</I>&gt;<i> b) copyrighted as such,
</I>&gt;<i> c) potentially subject to external checksum and digital protections,
</I>&gt;<i> d) HTTP relies on it being unchanged from origin server copies for
</I>&gt;<i> correct revalidation operations.
</I>This is for stress testing tool that requires the knowledge of what the 
user is doing to record (at a browser event level) the keyboard and 
mouse activities, this occurs on just a single authorized domain that 
they must have signed consent for. If they use the proxy for a domain 
that that is not authorized it redirects them to our web app to seek 
authorization. There is no way to do this without injecting our own 
Javascript library to push those events to a recording application.

Hopefully that's not a truly terrible one :) just a necessity for us

&gt;<i>
</I>&gt;&gt;<i> I've correctly configured Squid to do the SSL Bump, having verified in
</I>&gt;&gt;<i> WireShark that the two sides are communicating via separate connections.
</I>&gt;<i> That means little these days. Splice works via two connections and Squid
</I>&gt;<i> does not participate in the TLS layer inside those connections.
</I>&gt;<i>
</I>&gt;<i> You have to also confirm that Squid has access to the decrypted data,
</I>&gt;<i> that shows up in wireshark as different sets of crypto operating on each
</I>&gt;<i> connection.
</I>I will verify this, I was wondering where (from a C++ level) I can gain 
access to the segments of each request - I couldn't see in the source 
where the &quot;data segment&quot; is available, could anyone point me to the file 
where the data is available in it's raw format (as a void* or similar)

&gt;<i>
</I>&gt;&gt;<i> Can someone point out where the plain HTTP / TCP request flows through
</I>&gt;&gt;<i> squid, after it's deciphered by one side - but before it's encrypted for
</I>&gt;&gt;<i> the other? I want to scan the buffer's to find any &lt;BODY&gt; tags and
</I>&gt;&gt;<i> ensure that the script is inserted.
</I>&gt;<i> The &quot;page&quot; is not plaintext HTTP. Its binary payload. Squid is designed
</I>&gt;<i> explicitly NOT to touch them.
</I>&gt;<i>
</I>&gt;<i> It is also relayed as given, spread over many smaller buffer segments
</I>&gt;<i> and very likely compressed. There is 0 guarantee that you will be able
</I>&gt;<i> to see a whole sequence of &quot;&lt;BODY&gt;&quot; characters as a string even if one
</I>&gt;<i> existed bare in the payload.
</I>&gt;<i>
</I>&gt;<i> If you want to do payload adaptation use an ICAP service or eCAP module.
</I>&gt;<i> The above guarantee is still not provided, but the *CAP APIs provide
</I>&gt;<i> easier ways to access the transaction data.
</I>&gt;<i> NP: Dont forget to skip altering any and all messages with
</I>&gt;<i> &quot;Cache-Control:no-transform&quot; header - that is critical.
</I>Understood, we will have to create some sort of bitstream analyzer that 
can handle separate segments of binary data (for the same URL).

I will investigate the ICAP and eCAP facilities if I can't get direct 
access to the data from within the code.

James
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002425.html">[squid-dev] Injecting custom JavaScript
</A></li>
	<LI>Next message: <A HREF="002436.html">[squid-dev] Injecting custom JavaScript
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2427">[ date ]</a>
              <a href="thread.html#2427">[ thread ]</a>
              <a href="subject.html#2427">[ subject ]</a>
              <a href="author.html#2427">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
