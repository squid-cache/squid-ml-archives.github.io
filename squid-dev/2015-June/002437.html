<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Do not blindly forward cache peer CONNECT	responses
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20blindly%20forward%20cache%20peer%20CONNECT%0A%09responses&In-Reply-To=%3C5584494F.1010405%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002435.html">
   <LINK REL="Next"  HREF="002439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Do not blindly forward cache peer CONNECT	responses</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20blindly%20forward%20cache%20peer%20CONNECT%0A%09responses&In-Reply-To=%3C5584494F.1010405%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Do not blindly forward cache peer CONNECT	responses">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun 19 16:54:39 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002435.html">[squid-dev] Injecting custom JavaScript
</A></li>
        <LI>Next message: <A HREF="002439.html">[squid-dev] [PATCH] Do not blindly forward cache peer CONNECT responses
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2437">[ date ]</a>
              <a href="thread.html#2437">[ thread ]</a>
              <a href="subject.html#2437">[ subject ]</a>
              <a href="author.html#2437">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    The attached trunk patch fixes a rare but nasty problem by removing
a very old hack which shielded Squid from parsing most CONNECT responses.

Currently, Squid blindly forwards cache peer CONNECT responses to
clients when possible. This may break things if the peer responds with
something like HTTP 403 (Forbidden) and keeps the connection with Squid
open:

  -  The client application issues a CONNECT request.
  -  Squid forwards this request to a cache peer.
  -  Cache peer correctly responds back with a &quot;403 Forbidden&quot;.
  -  Squid does not parse cache peer response and
     just forwards it as if it was a Squid response to the client.
  -  The TCP connections are not closed.

At this stage, Squid is unaware that the CONNECT request has failed. All
subsequent requests on the user agent TCP connection are treated as
tunnelled traffic. Squid is forwarding these requests to the peer on the
TCP connection previously used for the 403-ed CONNECT request, without
proper processing. The additional headers which should have been applied
by Squid to these requests are not applied, and the requests are being
forwarded to the cache peer even though the Squid configuration may
state that these requests must go directly to the origin server.

This patch fixes Squid to parse cache peer responses, and if an error
response found, respond with &quot;502 Bad Gateway&quot; to the client and close
the connections.


HTH,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-53-blind-connect-response-t8.patch
Type: text/x-diff
Size: 29781 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150619/27f08c05/attachment-0001.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150619/27f08c05/attachment-0001.patch</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002435.html">[squid-dev] Injecting custom JavaScript
</A></li>
	<LI>Next message: <A HREF="002439.html">[squid-dev] [PATCH] Do not blindly forward cache peer CONNECT responses
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2437">[ date ]</a>
              <a href="thread.html#2437">[ thread ]</a>
              <a href="subject.html#2437">[ subject ]</a>
              <a href="author.html#2437">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
