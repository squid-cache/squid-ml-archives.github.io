<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Avoid SSL certificate db corruption with empty index.txt as a symptom.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Avoid%20SSL%20certificate%20db%20corruption%20with%20empty%0A%20index.txt%20as%20a%20symptom.&In-Reply-To=%3C55897B90.3020708%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002474.html">
   <LINK REL="Next"  HREF="002443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Avoid SSL certificate db corruption with empty index.txt as a symptom.</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Avoid%20SSL%20certificate%20db%20corruption%20with%20empty%0A%20index.txt%20as%20a%20symptom.&In-Reply-To=%3C55897B90.3020708%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] Avoid SSL certificate db corruption with empty index.txt as a symptom.">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Tue Jun 23 15:30:24 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002474.html">[squid-dev] [PATCH] Splice to origin cache_peer
</A></li>
        <LI>Next message: <A HREF="002443.html">[squid-dev] [PATCH] Temporary fix to restore compatibility with	Amazon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2442">[ date ]</a>
              <a href="thread.html#2442">[ thread ]</a>
              <a href="subject.html#2442">[ subject ]</a>
              <a href="author.html#2442">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
* Detect cases where the size file is corrupted or has a clearly wrong 
value. Automatically rebuild the database in such cases.

* Teach ssl_crtd to keep running if it is unable to store the generated 
certificate in the database. Return the generated certificate to Squid 
and log an error message in such cases.

Background:

There are cases where ssl_crtd may corrupt its certificate database. The 
known cases manifest themselves with an empty db index file.  When that 
happens, ssl_crtd helpers quit, SSL bumping does not work any more, and 
the certificate DB has to be deleted and re-initialized.

We do not know exactly what causes corruption in deployments, but one 
known trigger that is easy to reproduce in a lab is the block size 
change in the ssl_crtd configuration. That change has the following 
side-effects:

1. When ssl_crtd removes certificates, it computes their size using a 
different block size than the one used to store the certificates. This 
is may result in negative database sizes.

2. Signed/unsigned conversion results in a huge number near LONG_MAX, 
which is then written to the &quot;size&quot; file.

3. The ssl_crtd helper refuses to store new certificates because the 
database size (as described by the &quot;size&quot; file) exceeds the configured 
limit.

4. The ssl_crtd helper exits because it cannot store a new certificates 
to the database. No helper response is sent to Squid in this case.

Most likely, there are other corruption triggers -- the database 
management code is of an overall poor quality. This change resolves some 
of the underlying problems in hope to address at least some of the 
unknown triggers as well as the known one.

This is a Measurement Factory project.
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002474.html">[squid-dev] [PATCH] Splice to origin cache_peer
</A></li>
	<LI>Next message: <A HREF="002443.html">[squid-dev] [PATCH] Temporary fix to restore compatibility with	Amazon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2442">[ date ]</a>
              <a href="thread.html#2442">[ thread ]</a>
              <a href="subject.html#2442">[ subject ]</a>
              <a href="author.html#2442">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
