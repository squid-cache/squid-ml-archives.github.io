<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Temporary%20fix%20to%20restore%20compatibility%20with%0A%20Amazon&In-Reply-To=%3C558D7280.1080707%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002466.html">
   <LINK REL="Next"  HREF="002462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Temporary%20fix%20to%20restore%20compatibility%20with%0A%20Amazon&In-Reply-To=%3C558D7280.1080707%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun 26 15:40:48 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002466.html">[squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon
</A></li>
        <LI>Next message: <A HREF="002462.html">[squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2468">[ date ]</a>
              <a href="thread.html#2468">[ thread ]</a>
              <a href="subject.html#2468">[ subject ]</a>
              <a href="author.html#2468">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/26/2015 06:44 AM, Amos Jeffries wrote:
&gt;<i> On 26/06/2015 7:55 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> Tokenizer cannot handle URIs with whitespaces directly, like your patch
</I>&gt;&gt;<i> attempts to do: Tokenizer alone cannot handle ambiguous grammars. To
</I>&gt;&gt;<i> handle such URIs well, you have two options IMO:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A. The old &quot;do it by hand&quot; way:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   0. Trim request line to remove trailing whitespace and CR*LF.
</I>&gt;&gt;<i>   1. Find the *last* whitespace on the trimmed request line.
</I>&gt;&gt;<i>   2. To get the request method and URI, apply the tokenizer to the
</I>&gt;&gt;<i>      request line prefix before that last whitespace.
</I>&gt;&gt;<i>   3. To get the protocol parts, apply the tokenizer to the
</I>&gt;&gt;<i>      request line suffix after that last whitespace.
</I>&gt;&gt;<i>   4. Make the code even messier to handle HTTP/0.9 cases if needed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> B. The new optimized and simplified &quot;optimistic Tokenizer&quot; way:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is a sketch:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     SBuf uri; // accumulates request URI characters
</I>&gt;&gt;<i>     if (!tok.prefix(uri, StrictUriChars))
</I>&gt;&gt;<i>         return false; // URI does not start with a valid character
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     // in the order of correctness (and popularity!):
</I>&gt;&gt;<i>     const bool parsedSuffix =
</I>&gt;&gt;<i>         // canonical HTTP/1 format
</I>&gt;&gt;<i>         parseCanonicalReqLineTail(uri, tok) ||
</I>&gt;&gt;<i>         // HTTP/1 format but with bad characters in URI
</I>&gt;&gt;<i>         parseBadUriReqLineTail(uri, tok) ||
</I>&gt;&gt;<i>         // HTTP/1 format but with bad characters and spaces in URI
</I>&gt;&gt;<i>         parseSpacedReqLineTail(uri, tok) ||
</I>&gt;&gt;<i>         // HTTP/0 format (without the protocol part at all)
</I>&gt;&gt;<i>         parseHttpZeroReqLineTail(uri, tok);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Assert(parsedSuffix); // parseHttpZeroReqLineTail() cannot fail
</I>&gt;&gt;<i>     ...
</I>

&gt;<i> C. locate LF character and parse in reverse. HTTP-Version label, WSP
</I>&gt;<i> then remainder is URI.
</I>
Yes, this is a better variant of option A, using Tokenizer::suffix(); I
missed that method. It is still manual labor to accommodate rare special
cases while complicating and slowing down parsing of the common case.



&gt;<i> (B) is Interesting alternative to what we have now (C). Although you are
</I>&gt;<i> missing the relaxed vs strict characters which the RFC mandates (for
</I>&gt;<i> both URI and whitspace separately permutating). That complicates things
</I>&gt;<i> a bit.
</I>
I do not see where design B is missing something. Obviously(?), if there
are more special cases than the sketch shows, they should be added. I
was just illustrating the approach. The actual implementation should be
different.


&gt;<i> If I can find some time I'll give this (B) style a bit of testing and
</I>&gt;<i> see how it matches up against the current code. Could prove faster on
</I>&gt;<i> very long URIs.
</I>
Given correct implementations of A and B, B should be a tiny bit faster
for an average URI because it does less work in common cases.


In your patch, please add support for all URI characters that we can
support (or at least all the &quot;unwise&quot; ones from RFC 2396), not just the
characters that recent deployments have already confirmed &quot;as necessary
to accommodate&quot;. We do not want to come back to this every time some app
starts sending slightly malformed URIs.

I would also recommend accommodating whitespace after HTTP-version.

Ideally, parseRequestFirstLine(), or at least the new code, should be
split into several methods. It is too long, convoluted, and is getting
worse.


I remain opposed to downgrading HTTP/1 requests with slightly malformed
URIs to HTTP/0.


HTH,

Alex.

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002466.html">[squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon
</A></li>
	<LI>Next message: <A HREF="002462.html">[squid-dev] [PATCH] Temporary fix to restore compatibility with Amazon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2468">[ date ]</a>
              <a href="thread.html#2468">[ thread ]</a>
              <a href="subject.html#2468">[ subject ]</a>
              <a href="author.html#2468">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
