<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] start workers as root
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20start%20workers%20as%20root&In-Reply-To=%3C54FB368E.5060509%40users.sourceforge.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001849.html">
   <LINK REL="Next"  HREF="001852.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] start workers as root</H1>
    <B>Tsantilas Christos</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20start%20workers%20as%20root&In-Reply-To=%3C54FB368E.5060509%40users.sourceforge.net%3E"
       TITLE="[squid-dev] [PATCH] start workers as root">chtsanti at users.sourceforge.net
       </A><BR>
    <I>Sat Mar  7 17:34:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001849.html">[squid-dev] [PATCH] start workers as root
</A></li>
        <LI>Next message: <A HREF="001852.html">[squid-dev] [PATCH] start workers as root
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1850">[ date ]</a>
              <a href="thread.html#1850">[ thread ]</a>
              <a href="subject.html#1850">[ subject ]</a>
              <a href="author.html#1850">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/07/2015 07:18 AM, Amos Jeffries wrote:
&gt;<i> On 7/03/2015 12:18 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;<i> SMP workers in trunk start without root privileges. This results in
</I>&gt;&gt;<i> startup  failures when workers need to use a privileged port (e.g., 443)
</I>&gt;&gt;<i> or other  root-only features such as TPROXY.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This bug added with my &quot;Moved PID file management from Coordinator to
</I>&gt;&gt;<i> Master&quot; patch.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem is inside watch_child function which called after a
</I>&gt;&gt;<i> enter_suid() call, but the  writePidFile() call, inside the
</I>&gt;&gt;<i> watch_child(), will leave suid mode before exit.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This patch removes the enter_suid/leave_suid cals from the writePidFile
</I>&gt;&gt;<i>   and make the caller responsible for setting the root privileges if
</I>&gt;&gt;<i> required.
</I>&gt;<i>
</I>&gt;<i> I think this is wrong approach.
</I>&gt;<i>
</I>&gt;<i> Firstly, what are processes without SUID ability doing writing to secure
</I>&gt;<i> system files?
</I>
What do you mean here?

&gt;<i>
</I>&gt;<i> Secondly, I thought the entire point of the earlier patch was to make
</I>&gt;<i> the *MASTER* process was the one writing the PID file. Not
</I>&gt;<i> low-privileged workers.
</I>
Yes the master process writing the pid file, not the workers.

&gt;<i>
</I>&gt;<i> Thirdly, the enter/leave_suid calls mean &quot;dangerous security stuff about
</I>&gt;<i> to happen&quot; and should only be called if absolutely necessary, AND only
</I>&gt;<i> around the (block of) system calls which require them.
</I>
I agree.
However the watch_child which is implements the master process, is 
designed to run in suid mode. This was not changed by the PID patch. 
Just due to a bug added with the PID patch this function leaves the suid 
mode.

Maybe we want to fix master process to not run in suid mode, but I believe:
   - This is not a scope for this patch
   - The master process does not do a lot of thinks. Probably we do not 
need to make it run with low privileges. Moreover we may have problems 
with the kids. (Is it possible for kids to run with different 
cache_effective_user parameter?)


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Your description sounds like some part of the code in worker scope is
</I>&gt;<i> using enter_suid doing a lot of Squid stuff - plus incidentally some
</I>&gt;<i> root system stuff, then leave_suid. That is broken code. None of the
</I>&gt;<i> general &quot;Squid stuff&quot; are security sentitive system calls needing root
</I>&gt;<i> privileges.
</I>
No, please forget the workers. This patch does not change anything in a 
worker.
Please take a look into the writePidFile function, and into watch_child 
function (which implements the master process)

&gt;<i>   We should be fixing that broken code. Either to not need the system
</I>&gt;<i> suid privilege at all, or to call enter/leave_suid only around the
</I>&gt;<i> sensitive operation - while also ensuring those suid calls will work at
</I>&gt;<i> the point they are used.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001849.html">[squid-dev] [PATCH] start workers as root
</A></li>
	<LI>Next message: <A HREF="001852.html">[squid-dev] [PATCH] start workers as root
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1850">[ date ]</a>
              <a href="thread.html#1850">[ thread ]</a>
              <a href="subject.html#1850">[ subject ]</a>
              <a href="author.html#1850">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
