<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Basic tests results for the proxy protocol with	squid.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Basic%20tests%20results%20for%20the%20proxy%20protocol%20with%0A%09squid.&In-Reply-To=%3C5502A5CB.4010905%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001870.html">
   <LINK REL="Next"  HREF="001893.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Basic tests results for the proxy protocol with	squid.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Basic%20tests%20results%20for%20the%20proxy%20protocol%20with%0A%09squid.&In-Reply-To=%3C5502A5CB.4010905%40treenet.co.nz%3E"
       TITLE="[squid-dev] Basic tests results for the proxy protocol with	squid.">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 13 08:54:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001870.html">[squid-dev] Basic tests results for the proxy protocol with squid.
</A></li>
        <LI>Next message: <A HREF="001893.html">[squid-dev] Basic tests results for the proxy protocol with	squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1871">[ date ]</a>
              <a href="thread.html#1871">[ thread ]</a>
              <a href="subject.html#1871">[ subject ]</a>
              <a href="author.html#1871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/03/2015 9:07 p.m., Eliezer Croitoru wrote:
&gt;<i> I started testing squid 3.5.2 with the proxy protocol and I have setup a
</I>&gt;<i> basic haproxy settings for it.
</I>&gt;<i> <A HREF="http://ngtech.co.il/paste/1287/">http://ngtech.co.il/paste/1287/</A>
</I>&gt;<i> 
</I>&gt;<i> copy of the logs at:
</I>&gt;<i> <A HREF="http://www1.ngtech.co.il/paste/1288/">http://www1.ngtech.co.il/paste/1288/</A>
</I>&gt;<i> 
</I>&gt;<i> While testing I started first haproxy with regular squid forward proxy
</I>&gt;<i> and then moved to a proxy protocol supported forward proxy setup.
</I>&gt;<i> 
</I>&gt;<i> While with forward proxy the acls seems to work fine with the proxy
</I>&gt;<i> protocol I am encountering couple weird things:
</I>&gt;<i> 1426233543.491     28 192.168.10.131 TCP_MISS/404 611 GET
</I>&gt;<i> <A HREF="http://ngtech.co.il/favico.ico">http://ngtech.co.il/favico.ico</A> - HIER_DIRECT/84.95.212.160 text/html
</I>&gt;<i> 1426233562.110  29091 192.168.10.131 TCP_TUNNEL/200 3374 CONNECT
</I>&gt;<i> tiles.services.mozilla.com:443 - HIER_DIRECT/54.149.185.208 -
</I>
&gt;<i> 1426233562.119      1 192.168.10.151 TCP_MISS/403 4324 GET
</I>&gt;<i> <A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A> - HIER_NONE/- text/html
</I>&gt;<i> 1426233562.122      5 192.168.10.131 TCP_MISS/403 4461 GET
</I>&gt;<i> <A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A> - ORIGINAL_DST/192.168.10.151 text/html
</I>&gt;<i> 1426233562.259      1 192.168.10.151 TCP_MISS/403 4382 GET
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Artwork/SN.png">http://www.squid-cache.org/Artwork/SN.png</A> - HIER_NONE/- text/html
</I>&gt;<i> 1426233562.261      3 192.168.10.131 TCP_MISS/403 4519 GET
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Artwork/SN.png">http://www.squid-cache.org/Artwork/SN.png</A> - ORIGINAL_DST/192.168.10.151
</I>&gt;<i> text/html
</I>&gt;<i> 1426233562.294      1 192.168.10.151 TCP_MISS/403 4306 GET
</I>&gt;<i> <A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A> - HIER_NONE/- text/html
</I>&gt;<i> 1426233562.296      2 192.168.10.131 TCP_MISS/403 4443 GET
</I>&gt;<i> <A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A> - ORIGINAL_DST/192.168.10.151 text/html
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The first two requests are on the regular forward proxy port.
</I>&gt;<i> Then the 403 response is not a TCP_DENIED but I am still watching the
</I>&gt;<i> screen and see a squid access denied page which is identified by the
</I>&gt;<i> with the local proxy name.
</I>
MISS/403 usually means the server contacted supplied 403.

Whats the 192.168.10.151 server and which port is it being contacted on?


&gt;<i> Why would I see an &quot;ORIGINAL_DST&quot; at all in these requests??? there is
</I>&gt;<i> none...(else then the haproxy).
</I>
The PROXY protocol is providing Squid with both the src-IP and dst-IP.
Squid is using those as the client IP and ORIGINAL_DST.


&gt;<i> 
</I>&gt;<i> So summery of the setup:
</I>&gt;<i> 1 host with both squid and haproxy installed and configured for proxy
</I>&gt;<i> protocol version 1(version 2 didn't worked for me at all)
</I>&gt;<i> haproxy listens on one port(13128) and squid on receives the requests on
</I>&gt;<i> the loopback interface(port 23128).
</I>&gt;<i> 
</I>&gt;<i> I think it's a bug but first I am putting the details here in the dev
</I>&gt;<i> list and later next week I will file a bugzilla report.
</I>
Not working the same with v2 of the protocol is a bug.

I'm not sure how we could handle the dst-IP differently. By using the
PROXY protocol we explicitly trust the haproxy frontend to supply the
correct IPs.

Amos

</PRE>







































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001870.html">[squid-dev] Basic tests results for the proxy protocol with squid.
</A></li>
	<LI>Next message: <A HREF="001893.html">[squid-dev] Basic tests results for the proxy protocol with	squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1871">[ date ]</a>
              <a href="thread.html#1871">[ thread ]</a>
              <a href="subject.html#1871">[ subject ]</a>
              <a href="author.html#1871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
