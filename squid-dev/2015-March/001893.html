<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Basic tests results for the proxy protocol with	squid.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Basic%20tests%20results%20for%20the%20proxy%20protocol%20with%0A%09squid.&In-Reply-To=%3C5505A624.3080406%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001871.html">
   <LINK REL="Next"  HREF="001904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Basic tests results for the proxy protocol with	squid.</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Basic%20tests%20results%20for%20the%20proxy%20protocol%20with%0A%09squid.&In-Reply-To=%3C5505A624.3080406%40ngtech.co.il%3E"
       TITLE="[squid-dev] Basic tests results for the proxy protocol with	squid.">eliezer at ngtech.co.il
       </A><BR>
    <I>Sun Mar 15 15:32:52 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001871.html">[squid-dev] Basic tests results for the proxy protocol with	squid.
</A></li>
        <LI>Next message: <A HREF="001904.html">[squid-dev] Basic tests results for the proxy protocol with squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1893">[ date ]</a>
              <a href="thread.html#1893">[ thread ]</a>
              <a href="subject.html#1893">[ subject ]</a>
              <a href="author.html#1893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Amos,

The setup I have used to test the proxy protocol is:
- 192.168.10.0/24 network.
- 192.168.10.131 basic forward proxy client(firefox)
- 192.168.10.151 haproxy+squid host

The haproxy is listening on port 13128 which is open on the FW.
The squid instance is listening on ports 3128 and 23128.
The settings for squid is from the release notes:
  acl frontend src 127.0.0.1
  http_port 23128 require-proxy-header
  proxy_protocol_access allow frontend

While I have not found &quot;proxy_protocol_access&quot; at all in: 
<A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A>

Now indeed as you mentioned I was curios about this weird state which a 
forward proxy would even look at the original_dst when in a forward 
proxy mode it should not even be looked at.
What is even more weird is that the first request is being logged as 
from 192.168.10.151 and the second is from 192.168.10.131.
Since the same issue happens when there is no default gateway I would 
assume something is probably not happening as it was planned.
For each and every request there should be only one request happening.

I have never used the proxy protocol and my assumption is that there is 
one of two:
- haproxy bad handling of the request
- squid issue with the proxy protocol handling.

I have seen that most server software which implements the proxy 
protocol do use version 1 and not 2(at least the open source I have seen).

My next step would be to add a more detailed logs into the haproxy 
instance and run TCPDUMP to make sure what is passing on the wires.

Eliezer

On 13/03/2015 10:54, Amos Jeffries wrote:
&gt;<i> On 13/03/2015 9:07 p.m., Eliezer Croitoru wrote:
</I>&gt;&gt;<i> &gt;I started testing squid 3.5.2 with the proxy protocol and I have setup a
</I>&gt;&gt;<i> &gt;basic haproxy settings for it.
</I>&gt;&gt;<i> &gt;<A HREF="http://ngtech.co.il/paste/1287/">http://ngtech.co.il/paste/1287/</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;copy of the logs at:
</I>&gt;&gt;<i> &gt;<A HREF="http://www1.ngtech.co.il/paste/1288/">http://www1.ngtech.co.il/paste/1288/</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;While testing I started first haproxy with regular squid forward proxy
</I>&gt;&gt;<i> &gt;and then moved to a proxy protocol supported forward proxy setup.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;While with forward proxy the acls seems to work fine with the proxy
</I>&gt;&gt;<i> &gt;protocol I am encountering couple weird things:
</I>&gt;&gt;<i> &gt;1426233543.491     28 192.168.10.131 TCP_MISS/404 611 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://ngtech.co.il/favico.ico">http://ngtech.co.il/favico.ico</A>  - HIER_DIRECT/84.95.212.160 text/html
</I>&gt;&gt;<i> &gt;1426233562.110  29091 192.168.10.131 TCP_TUNNEL/200 3374 CONNECT
</I>&gt;&gt;<i> &gt;tiles.services.mozilla.com:443 - HIER_DIRECT/54.149.185.208 -
</I>&gt;&gt;<i> &gt;1426233562.119      1 192.168.10.151 TCP_MISS/403 4324 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A>  - HIER_NONE/- text/html
</I>&gt;&gt;<i> &gt;1426233562.122      5 192.168.10.131 TCP_MISS/403 4461 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A>  - ORIGINAL_DST/192.168.10.151 text/html
</I>&gt;&gt;<i> &gt;1426233562.259      1 192.168.10.151 TCP_MISS/403 4382 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://www.squid-cache.org/Artwork/SN.png">http://www.squid-cache.org/Artwork/SN.png</A>  - HIER_NONE/- text/html
</I>&gt;&gt;<i> &gt;1426233562.261      3 192.168.10.131 TCP_MISS/403 4519 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://www.squid-cache.org/Artwork/SN.png">http://www.squid-cache.org/Artwork/SN.png</A>  - ORIGINAL_DST/192.168.10.151
</I>&gt;&gt;<i> &gt;text/html
</I>&gt;&gt;<i> &gt;1426233562.294      1 192.168.10.151 TCP_MISS/403 4306 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A>  - HIER_NONE/- text/html
</I>&gt;&gt;<i> &gt;1426233562.296      2 192.168.10.131 TCP_MISS/403 4443 GET
</I>&gt;&gt;<i> &gt;<A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A>  - ORIGINAL_DST/192.168.10.151 text/html
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;The first two requests are on the regular forward proxy port.
</I>&gt;&gt;<i> &gt;Then the 403 response is not a TCP_DENIED but I am still watching the
</I>&gt;&gt;<i> &gt;screen and see a squid access denied page which is identified by the
</I>&gt;&gt;<i> &gt;with the local proxy name.
</I>&gt;<i> MISS/403 usually means the server contacted supplied 403.
</I>&gt;<i>
</I>&gt;<i> Whats the 192.168.10.151 server and which port is it being contacted on?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> &gt;Why would I see an &quot;ORIGINAL_DST&quot; at all in these requests??? there is
</I>&gt;&gt;<i> &gt;none...(else then the haproxy).
</I>&gt;<i> The PROXY protocol is providing Squid with both the src-IP and dst-IP.
</I>&gt;<i> Squid is using those as the client IP and ORIGINAL_DST.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;So summery of the setup:
</I>&gt;&gt;<i> &gt;1 host with both squid and haproxy installed and configured for proxy
</I>&gt;&gt;<i> &gt;protocol version 1(version 2 didn't worked for me at all)
</I>&gt;&gt;<i> &gt;haproxy listens on one port(13128) and squid on receives the requests on
</I>&gt;&gt;<i> &gt;the loopback interface(port 23128).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;I think it's a bug but first I am putting the details here in the dev
</I>&gt;&gt;<i> &gt;list and later next week I will file a bugzilla report.
</I>&gt;<i> Not working the same with v2 of the protocol is a bug.
</I>&gt;<i>
</I>&gt;<i> I'm not sure how we could handle the dst-IP differently. By using the
</I>&gt;<i> PROXY protocol we explicitly trust the haproxy frontend to supply the
</I>&gt;<i> correct IPs.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001871.html">[squid-dev] Basic tests results for the proxy protocol with	squid.
</A></li>
	<LI>Next message: <A HREF="001904.html">[squid-dev] Basic tests results for the proxy protocol with squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1893">[ date ]</a>
              <a href="thread.html#1893">[ thread ]</a>
              <a href="subject.html#1893">[ subject ]</a>
              <a href="author.html#1893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
