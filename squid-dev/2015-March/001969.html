<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] splicing resumed sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C550C62C7.4090103%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001966.html">
   <LINK REL="Next"  HREF="001970.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] splicing resumed sessions</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C550C62C7.4090103%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] splicing resumed sessions">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 20 18:11:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001966.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
        <LI>Next message: <A HREF="001970.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1969">[ date ]</a>
              <a href="thread.html#1969">[ thread ]</a>
              <a href="subject.html#1969">[ subject ]</a>
              <a href="author.html#1969">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/03/2015 4:35 a.m., Alex Rousskov wrote:
&gt;<i> On 03/20/2015 02:06 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 18/03/2015 6:21 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;<i> This patch adds the &quot;ssl_bump_resuming_sessions&quot; directive that controls
</I>&gt;&gt;&gt;<i> SslBump behavior when dealing with &quot;resuming SSL/TLS sessions&quot;. Without
</I>&gt;&gt;&gt;<i> these changes, SslBump usually terminates all resuming sessions with an
</I>&gt;&gt;&gt;<i> error because such sessions do not include server certificates,
</I>&gt;&gt;&gt;<i> preventing Squid from successfully validating the server identity.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The RFC 2818 has mandatory validation of the HTTP CONNECT, client SNI
</I>&gt;&gt;<i> (with server ack), and server certificate dNSname values before session
</I>&gt;&gt;<i> resume may be performed.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I am afraid you have misunderstood the problem domain because RFC 2818
</I>&gt;<i> is irrelevant here. That RFC is about sending HTTP over TLS. Here, Squid
</I>&gt;<i> does not establish a secure HTTP connection with the client or server so
</I>&gt;<i> Squid is not subject to that RFC (the client and server are).
</I>&gt;<i> 
</I>&gt;<i> Without the patch, a client and server cannot resume secure sessions.
</I>&gt;<i> Users suffer from disconnects and various associated errors even though
</I>&gt;<i> Squid does not bump their connections. With the patch, things work, and
</I>&gt;<i> work without violating any TLS/SSL rules. Moreover, an admin can now
</I>&gt;<i> explicitly control whether resumed sessions are allowed or not (the
</I>&gt;<i> default &quot;allow&quot; is what nearly everybody should want).
</I>

Squid is behaving wrong right now. Fix that.

I dont see any need for the new directive to exist because Squid should
be resuming by default and terminate the SSL only when the domain checks
which are possible confirm bad behaviour.

It sounds a bit like a &quot;fail open&quot;, but is actually an opportunistic
terminate [see below].


&gt;<i> 
</I>&gt;&gt;<i> I dont think we have any such validation in Squid yet. So the current
</I>&gt;&gt;<i> behaviour of terminate is mandatory for compliance with TLS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> As Christos has said, proper validation is impossible in this case even
</I>&gt;<i> if we wanted to do it: Squid most likely have already spliced the
</I>&gt;<i> previous TLS session (a compliant behavior!) and now does not have
</I>&gt;<i> enough information to validate the new connection to the server (because
</I>&gt;<i> the server does not send its certificate during session resumption) and
</I>&gt;<i> splices the connections again.
</I>&gt;<i> 
</I>
I think we are talking past each other here again, and again its the
word &quot;validation&quot;. Previous connection has nothing to do with it. HTTP
messages inside the previous connection have nothing to do with it.

&gt;<i> HTTP, TLS, and SSL RFCs do not apply to traffic on spliced connections.
</I>&gt;<i> When splicing, Squid works as a TCP proxy. The fact that Squid may have
</I>&gt;<i> peeked into the connections (before deciding to splice them) is
</I>&gt;<i> irrelevant because that peeking did not affect the security of those
</I>&gt;<i> connections.
</I>

The validation I'm talking about is the spec requirement that we dont
allow the following scenario:

  CONNECT example.com:443 HTTP/1.1
  ...
  ClientHello SNI:  example.org


* if the CONNECT contains a raw-IP we can ignore it.
 - this includes our fake-CONNECT on intercept.

* if the SNI is missing we can ignore it.

* if the CONNECT and SNI both contain different domains the
specification says SSL &quot;MUST terminate&quot; with a specified reject error.

  - CONNECT having a domain means we are in the RFC 2818 scenario of
TLS-over-HTTP.

  - checking and terminating ourselves helps protect naive/old servers
against SNI abuses.

  - given what Squid is doing, we are allowed to just splice always and
let the endpoints do the error stuff. BUT, that is a waste of resources
when we could abort early and log a nice alert.

In all other cases we can allow the splice to resume with no loss of
safety. The endpoints will do (or not) anything they would do anyway
without the proxy.


So ...
 if we allow an admin directive it would be to force terminate when
resume was otherwise allowed.

 1) Do you have any existing need for that?

 2) Would not &quot;ssl_bump terminate blah&quot; be a better way to express the
policy?


I think we should fix the currently broken Squid behaviour without a new
directive.

Amos
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001966.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
	<LI>Next message: <A HREF="001970.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1969">[ date ]</a>
              <a href="thread.html#1969">[ thread ]</a>
              <a href="subject.html#1969">[ subject ]</a>
              <a href="author.html#1969">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
