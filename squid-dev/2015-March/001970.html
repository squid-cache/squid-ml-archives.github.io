<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] splicing resumed sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C550C9561.7030604%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001969.html">
   <LINK REL="Next"  HREF="001972.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] splicing resumed sessions</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C550C9561.7030604%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] splicing resumed sessions">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Mar 20 21:47:13 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001969.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
        <LI>Next message: <A HREF="001972.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1970">[ date ]</a>
              <a href="thread.html#1970">[ thread ]</a>
              <a href="subject.html#1970">[ subject ]</a>
              <a href="author.html#1970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/20/2015 12:11 PM, Amos Jeffries wrote:
&gt;<i> On 21/03/2015 4:35 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 03/20/2015 02:06 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 18/03/2015 6:21 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;<i> This patch adds the &quot;ssl_bump_resuming_sessions&quot; directive that controls
</I>&gt;&gt;&gt;&gt;<i> SslBump behavior when dealing with &quot;resuming SSL/TLS sessions&quot;. Without
</I>&gt;&gt;&gt;&gt;<i> these changes, SslBump usually terminates all resuming sessions with an
</I>&gt;&gt;&gt;&gt;<i> error because such sessions do not include server certificates,
</I>&gt;&gt;&gt;&gt;<i> preventing Squid from successfully validating the server identity.
</I>

&gt;<i> Squid is behaving wrong right now. Fix that.
</I>
Yes, the proposed patch &quot;fixes that&quot;.


&gt;<i> I dont see any need for the new directive to exist
</I>
We can remove the configuration option. The option was added to minimize
the chance that you will object to the patch because, without the new
option, the old &quot;terminate&quot; behavior would be lost. Clearly, my plan to
avoid that discussion has failed! Removing the configuration option is
totally fine with me because nobody has asked for it [yet]. We can
always add it later if needed.


&gt;<i> The validation I'm talking about is the spec requirement that we dont
</I>&gt;<i> allow the following scenario:
</I>&gt;<i> 
</I>&gt;<i>   CONNECT example.com:443 HTTP/1.1
</I>&gt;<i>   ...
</I>&gt;<i>   ClientHello SNI:  example.org
</I>

I still think this part of the discussion is out of scope, but is there
really a spec requirement that talks about comparing CONNECT- and
SNI-provided server names? Where? CONNECT is about blind TCP *tunnels*.
SNI is about becoming an *end point* of a TLS connection. Those two
things seem mutually exclusive to me.


&gt;<i> * if the CONNECT and SNI both contain different domains the
</I>&gt;<i> specification says SSL &quot;MUST terminate&quot; with a specified reject error.
</I>
Which specification? RFC 2818 does not mention CONNECT. It contains some
requirements for HTTP clients, but Squid is not an HTTP client in this
issue scope; Squid is a TCP client.


&gt;<i>   - CONNECT having a domain means we are in the RFC 2818 scenario of
</I>&gt;<i> TLS-over-HTTP.
</I>
No, CONNECT means &quot;establish a TCP tunnel by splicing client and server
TCP connections together&quot;. CONNECT does not imply SSL or TLS. When Squid
bumps a secure connection, then Squid becomes subject to various SSL and
TLS rules. Here, we are not bumping anything, just splicing at TCP level.


&gt;<i>   - given what Squid is doing, we are allowed to just splice always and
</I>&gt;<i> let the endpoints do the error stuff. BUT, that is a waste of resources
</I>&gt;<i> when we could abort early and log a nice alert.
</I>
Yes, there are cases where &quot;doing error stuff&quot; in Squid is useful, and
there are cases where it is harmful. There are cases where logging a
&quot;nice alert&quot; is useful and cases where it is at best pointless (unless
the client gets an error message as well). This patch does not try to
improve any of that &quot;doing error stuff&quot;. I am certainly not against
adding [more] SNI checks, but not as a part of the fix for an
SNI-unrelated error.


&gt;<i> In all other cases we can allow the splice to resume with no loss of
</I>&gt;<i> safety. The endpoints will do (or not) anything they would do anyway
</I>&gt;<i> without the proxy.
</I>
I do not think the proposed changes _introduce_ a safety loss in *any*
case. They just make session resumption work in the presence of a
splicing Squid. Could Squid check more things? Yes! Are those additional
checks both trivial to add and relevant to this fix? No.


&gt;<i> So ...
</I>&gt;<i>  if we allow an admin directive it would be to force terminate when
</I>&gt;<i> resume was otherwise allowed.
</I>
Yes.


&gt;<i>  1) Do you have any existing need for that?
</I>
None other than avoiding this discussion, which has already failed to work.


&gt;<i>  2) Would not &quot;ssl_bump terminate blah&quot; be a better way to express the
</I>&gt;<i> policy?
</I>
Probably not. We have considered that design, but most ssl_bump rules
rely on information unavailable when sessions are resumed. If we force
admins to use ssl_bump to control which resuming sessions are
terminated, the ssl_bump rules become needlessly complex and difficult
to write correctly.


&gt;<i> I think we should fix the currently broken Squid behaviour without a new
</I>&gt;<i> directive.
</I>
Sounds good to me! If we do not hear otherwise, we will commit the
proposed patch without the new [already optional] directive.


Thank you,

Alex.

</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001969.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
	<LI>Next message: <A HREF="001972.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1970">[ date ]</a>
              <a href="thread.html#1970">[ thread ]</a>
              <a href="subject.html#1970">[ subject ]</a>
              <a href="author.html#1970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
