<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] splicing resumed sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C550D0567.9070709%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001970.html">
   <LINK REL="Next"  HREF="001984.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] splicing resumed sessions</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C550D0567.9070709%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] splicing resumed sessions">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Mar 21 05:45:11 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001970.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
        <LI>Next message: <A HREF="001984.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1972">[ date ]</a>
              <a href="thread.html#1972">[ thread ]</a>
              <a href="subject.html#1972">[ subject ]</a>
              <a href="author.html#1972">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/03/2015 10:47 a.m., Alex Rousskov wrote:
&gt;<i> On 03/20/2015 12:11 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 21/03/2015 4:35 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 03/20/2015 02:06 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 18/03/2015 6:21 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> This patch adds the &quot;ssl_bump_resuming_sessions&quot; directive that controls
</I>&gt;&gt;&gt;&gt;&gt;<i> SslBump behavior when dealing with &quot;resuming SSL/TLS sessions&quot;. Without
</I>&gt;&gt;&gt;&gt;&gt;<i> these changes, SslBump usually terminates all resuming sessions with an
</I>&gt;&gt;&gt;&gt;&gt;<i> error because such sessions do not include server certificates,
</I>&gt;&gt;&gt;&gt;&gt;<i> preventing Squid from successfully validating the server identity.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Squid is behaving wrong right now. Fix that.
</I>&gt;<i> 
</I>&gt;<i> Yes, the proposed patch &quot;fixes that&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I dont see any need for the new directive to exist
</I>&gt;<i> 
</I>&gt;<i> We can remove the configuration option. The option was added to minimize
</I>&gt;<i> the chance that you will object to the patch because, without the new
</I>&gt;<i> option, the old &quot;terminate&quot; behavior would be lost. Clearly, my plan to
</I>&gt;<i> avoid that discussion has failed! Removing the configuration option is
</I>&gt;<i> totally fine with me because nobody has asked for it [yet]. We can
</I>&gt;<i> always add it later if needed.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The validation I'm talking about is the spec requirement that we dont
</I>&gt;&gt;<i> allow the following scenario:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   CONNECT example.com:443 HTTP/1.1
</I>&gt;&gt;<i>   ...
</I>&gt;&gt;<i>   ClientHello SNI:  example.org
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I still think this part of the discussion is out of scope, but is there
</I>&gt;<i> really a spec requirement that talks about comparing CONNECT- and
</I>&gt;<i> SNI-provided server names? Where? CONNECT is about blind TCP *tunnels*.
</I>&gt;<i> SNI is about becoming an *end point* of a TLS connection. Those two
</I>&gt;<i> things seem mutually exclusive to me.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> * if the CONNECT and SNI both contain different domains the
</I>&gt;&gt;<i> specification says SSL &quot;MUST terminate&quot; with a specified reject error.
</I>&gt;<i> 
</I>&gt;<i> Which specification? RFC 2818 does not mention CONNECT. It contains some
</I>&gt;<i> requirements for HTTP clients, but Squid is not an HTTP client in this
</I>&gt;<i> issue scope; Squid is a TCP client.
</I>&gt;<i> 
</I>
Sorry the specifics here are mostly in RFC 6066 section 3, the final two
paragraphs.
 <A HREF="http://tools.ietf.org/html/rfc6066#section-3">http://tools.ietf.org/html/rfc6066#section-3</A>
&quot;
 If an application negotiates a server name using an application
 protocol and then upgrades to TLS, and if a server_name extension is
 sent, then the extension SHOULD contain the same name that was
 negotiated in the application protocol.  If the server_name is
 established in the TLS session handshake, the client SHOULD NOT
 attempt to request a different server name at the application layer.
&quot;

 ie CONNECT with hostname contains the same value as SNI from the client.

RFC 2818 section 3.1 leads into that with its paragraph 2,
&quot;
 If the client has external information as to the expected identity of
 the server, the hostname check MAY be omitted.
 ...
 In such cases, it is important to narrow the scope of
 acceptable certificates as much as possible in order to prevent man
 in the middle attacks.  In special cases, it may be appropriate for
 the client to simply ignore the server's identity, but it must be
 understood that this leaves the connection open to active attack.
&quot;

such narrowing can be Squid doing the check that CONNECT == SNI and
aborting if not.
My emphasis is in doing what we can to avoid that risk indicated in the
final line.


&gt;<i> 
</I>&gt;&gt;<i>   - CONNECT having a domain means we are in the RFC 2818 scenario of
</I>&gt;&gt;<i> TLS-over-HTTP.
</I>&gt;<i> 
</I>&gt;<i> No, CONNECT means &quot;establish a TCP tunnel by splicing client and server
</I>&gt;<i> TCP connections together&quot;. CONNECT does not imply SSL or TLS. When Squid
</I>&gt;<i> bumps a secure connection, then Squid becomes subject to various SSL and
</I>&gt;<i> TLS rules. Here, we are not bumping anything, just splicing at TCP level.
</I>&gt;<i> 
</I>
How then does one get into the situation of having a SSL ClientHello
with a SNI value ... for non-TLS ?


&gt;&gt;<i> So ...
</I>&gt;&gt;<i>  if we allow an admin directive it would be to force terminate when
</I>&gt;&gt;<i> resume was otherwise allowed.
</I>&gt;<i> 
</I>&gt;<i> Yes.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>  1) Do you have any existing need for that?
</I>&gt;<i> 
</I>&gt;<i> None other than avoiding this discussion, which has already failed to work.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>  2) Would not &quot;ssl_bump terminate blah&quot; be a better way to express the
</I>&gt;&gt;<i> policy?
</I>&gt;<i> 
</I>&gt;<i> Probably not. We have considered that design, but most ssl_bump rules
</I>&gt;<i> rely on information unavailable when sessions are resumed. If we force
</I>&gt;<i> admins to use ssl_bump to control which resuming sessions are
</I>&gt;<i> terminated, the ssl_bump rules become needlessly complex and difficult
</I>&gt;<i> to write correctly.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I think we should fix the currently broken Squid behaviour without a new
</I>&gt;&gt;<i> directive.
</I>&gt;<i> 
</I>&gt;<i> Sounds good to me! If we do not hear otherwise, we will commit the
</I>&gt;<i> proposed patch without the new [already optional] directive.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001970.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
	<LI>Next message: <A HREF="001984.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1972">[ date ]</a>
              <a href="thread.html#1972">[ thread ]</a>
              <a href="subject.html#1972">[ subject ]</a>
              <a href="author.html#1972">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
