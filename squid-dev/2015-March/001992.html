<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] splicing resumed sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C551545CB.1010809%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="001984.html">
   <LINK REL="Next"  HREF="001971.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] splicing resumed sessions</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20splicing%20resumed%20sessions&In-Reply-To=%3C551545CB.1010809%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] splicing resumed sessions">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 27 11:58:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001984.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
        <LI>Next message: <A HREF="001971.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1992">[ date ]</a>
              <a href="thread.html#1992">[ thread ]</a>
              <a href="subject.html#1992">[ subject ]</a>
              <a href="author.html#1992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/03/2015 8:35 p.m., Tsantilas Christos wrote:
&gt;<i> On 03/21/2015 07:45 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 21/03/2015 10:47 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 03/20/2015 12:11 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 21/03/2015 4:35 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> On 03/20/2015 02:06 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On 18/03/2015 6:21 a.m., Tsantilas Christos wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> This patch adds the &quot;ssl_bump_resuming_sessions&quot; directive that
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> controls
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> SslBump behavior when dealing with &quot;resuming SSL/TLS sessions&quot;.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Without
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> these changes, SslBump usually terminates all resuming sessions
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> with an
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> error because such sessions do not include server certificates,
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> preventing Squid from successfully validating the server identity.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Squid is behaving wrong right now. Fix that.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Yes, the proposed patch &quot;fixes that&quot;.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I dont see any need for the new directive to exist
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We can remove the configuration option. The option was added to minimize
</I>&gt;&gt;&gt;<i> the chance that you will object to the patch because, without the new
</I>&gt;&gt;&gt;<i> option, the old &quot;terminate&quot; behavior would be lost. Clearly, my plan to
</I>&gt;&gt;&gt;<i> avoid that discussion has failed! Removing the configuration option is
</I>&gt;&gt;&gt;<i> totally fine with me because nobody has asked for it [yet]. We can
</I>&gt;&gt;&gt;<i> always add it later if needed.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The validation I'm talking about is the spec requirement that we dont
</I>&gt;&gt;&gt;&gt;<i> allow the following scenario:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>    CONNECT example.com:443 HTTP/1.1
</I>&gt;&gt;&gt;&gt;<i>    ...
</I>&gt;&gt;&gt;&gt;<i>    ClientHello SNI:  example.org
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I still think this part of the discussion is out of scope, but is there
</I>&gt;&gt;&gt;<i> really a spec requirement that talks about comparing CONNECT- and
</I>&gt;&gt;&gt;<i> SNI-provided server names? Where? CONNECT is about blind TCP *tunnels*.
</I>&gt;&gt;&gt;<i> SNI is about becoming an *end point* of a TLS connection. Those two
</I>&gt;&gt;&gt;<i> things seem mutually exclusive to me.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * if the CONNECT and SNI both contain different domains the
</I>&gt;&gt;&gt;&gt;<i> specification says SSL &quot;MUST terminate&quot; with a specified reject error.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Which specification? RFC 2818 does not mention CONNECT. It contains some
</I>&gt;&gt;&gt;<i> requirements for HTTP clients, but Squid is not an HTTP client in this
</I>&gt;&gt;&gt;<i> issue scope; Squid is a TCP client.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry the specifics here are mostly in RFC 6066 section 3, the final two
</I>&gt;&gt;<i> paragraphs.
</I>&gt;&gt;<i>   <A HREF="http://tools.ietf.org/html/rfc6066#section-3">http://tools.ietf.org/html/rfc6066#section-3</A>
</I>&gt;&gt;<i> &quot;
</I>&gt;&gt;<i>   If an application negotiates a server name using an application
</I>&gt;&gt;<i>   protocol and then upgrades to TLS, and if a server_name extension is
</I>&gt;&gt;<i>   sent, then the extension SHOULD contain the same name that was
</I>&gt;&gt;<i>   negotiated in the application protocol.  If the server_name is
</I>&gt;&gt;<i>   established in the TLS session handshake, the client SHOULD NOT
</I>&gt;&gt;<i>   attempt to request a different server name at the application layer.
</I>&gt;&gt;<i> &quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   ie CONNECT with hostname contains the same value as SNI from the
</I>&gt;&gt;<i> client.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> RFC 2818 section 3.1 leads into that with its paragraph 2,
</I>&gt;&gt;<i> &quot;
</I>&gt;&gt;<i>   If the client has external information as to the expected identity of
</I>&gt;&gt;<i>   the server, the hostname check MAY be omitted.
</I>&gt;&gt;<i>   ...
</I>&gt;&gt;<i>   In such cases, it is important to narrow the scope of
</I>&gt;&gt;<i>   acceptable certificates as much as possible in order to prevent man
</I>&gt;&gt;<i>   in the middle attacks.  In special cases, it may be appropriate for
</I>&gt;&gt;<i>   the client to simply ignore the server's identity, but it must be
</I>&gt;&gt;<i>   understood that this leaves the connection open to active attack.
</I>&gt;&gt;<i> &quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> such narrowing can be Squid doing the check that CONNECT == SNI and
</I>&gt;&gt;<i> aborting if not.
</I>&gt;&gt;<i> My emphasis is in doing what we can to avoid that risk indicated in the
</I>&gt;&gt;<i> final line.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> At the first stages of the ssl bumping , I remember that there was cases
</I>&gt;<i> where the browser used the IP address in CONNECT request and not the
</I>&gt;<i> hostname. I do not know if there are still browsers which uses the same
</I>&gt;<i> form.
</I>
I covered that. We ignore raw-IP in CONNECT. The vulnerability is when
the client sending false CONNECT URI/domain gets past security
permissions. With raw-IP that does not work nearly so easily.


&gt;<i> 
</I>&gt;<i> I must note that the SSL-bumping is not covered by any RFC.
</I>&gt;<i> It is not something it should happen, because IT IS a man in the middle.
</I>
Which is precisely why we should be careful to be well behaved and do
what verification we can to avoid bad behaviour happening over the
proxy. We cannot catch every case, but preventing even some cases is a
good increase in security.


&gt;<i> The proxy is not expected to validate the client HELLO SNI information,
</I>&gt;<i> with the CONNECT hostname, should not interposed into the client/server
</I>&gt;<i> negotiation.
</I>

In the case of a CONNECT we are essentially pretending that SSL-Bump was
an Upgrade request:
&quot;
If an application negotiates a server name using an application protocol
and then upgrades to TLS, then the extension SHOULD contain the same
name that was negotiated in the application protocol.
&quot;
(<A HREF="http://tools.ietf.org/html/rfc6066#section-3">http://tools.ietf.org/html/rfc6066#section-3</A>)

All I am saying is that we should / SHOULD enforce that requirement in
the spirit of the standard even though technically MITM cases are
officially not mentioned by any IETF document.



&gt;<i> The browsers can use either the IP or hostname in CONNECT string,
</I>&gt;<i> nothing prevents them for doing this.
</I>
Indeed. Its the hostname vs SNI case we can check and SHOULD do so. The
raw-IP ones we can skip the check. Some nasties will still get passed,
but less than without any checks.

Amos
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001984.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
	<LI>Next message: <A HREF="001971.html">[squid-dev] [PATCH] splicing resumed sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1992">[ date ]</a>
              <a href="thread.html#1992">[ thread ]</a>
              <a href="subject.html#1992">[ subject ]</a>
              <a href="author.html#1992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
