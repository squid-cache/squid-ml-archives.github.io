<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Removing DNS lookups in intercept mode by using client dest IP address
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Removing%20DNS%20lookups%20in%20intercept%20mode%20by%20using%0A%20client%20dest%20IP%20address&In-Reply-To=%3C555DDF21.6090501%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="002361.html">
   <LINK REL="Next"  HREF="002366.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Removing DNS lookups in intercept mode by using client dest IP address</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Removing%20DNS%20lookups%20in%20intercept%20mode%20by%20using%0A%20client%20dest%20IP%20address&In-Reply-To=%3C555DDF21.6090501%40treenet.co.nz%3E"
       TITLE="[squid-dev] Removing DNS lookups in intercept mode by using client dest IP address">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May 21 13:35:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="002361.html">[squid-dev] Removing DNS lookups in intercept mode by using client dest IP address
</A></li>
        <LI>Next message: <A HREF="002366.html">[squid-dev] Removing DNS lookups in intercept mode by using	client dest IP address
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2362">[ date ]</a>
              <a href="thread.html#2362">[ thread ]</a>
              <a href="subject.html#2362">[ subject ]</a>
              <a href="author.html#2362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/05/2015 12:00 a.m., johndunne wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm running squid 3.5.4 on a network which caches http and https traffic via
</I>&gt;<i> a tproxy redirect on a linux box. The setup runs perfectly, except that a
</I>&gt;<i> slight lag is introduced owing to the squid service making DNS lookups for
</I>&gt;<i> many of the requests it receives via http and https.
</I>&gt;<i> 
</I>&gt;<i> Now, I'm considering patching squid such that it auto adds the destination
</I>&gt;<i> IP address of the client connection to its own dns cache, for the hostname
</I>&gt;<i> that appears in the http header of that connection. I think this is safe
</I>&gt;<i> since the connection is redirected via tproxy i.e. I know that the client
</I>&gt;<i> machine got that IP address for the hostname in the HTTP/HTTPS request.
</I>
No, no you dont. On the contrary we do know from testing the
host_verify_strict feature that many, many clients lie.

The amount of traffic where URL and Host header contained entirely
different domain names (or even ports) was quite a surprise.

&gt;<i> 
</I>&gt;<i> Assuming my logic here isn't flawed, does anyone know if this is sensible
</I>&gt;<i> and if any such work has already been done?
</I>&gt;<i> 
</I>
No, the DNS lookup being done is to protect against CVE-2009-0801.

That CVE is about a client browser running a malicious script provided
by a web server somewhere, which makes HTTP requests but lies when
sending the Host: header. This is trivial for an attacker to do and if
trusted would result in cache corruption affecting all clients on the
network.

Essentially if the Host header value does not match the URL or resolve
to the IP being contacted then it can't be trusted for use as a cache
key that other clients might fetch.

You could get around the DNS lookup if you really have to by patching
Squid to always mark the hostVerify as done with a failed result. But
none of the traffic would then be able to cache, so its not a very
useful thing to do.


You can probably better reduce latency by ensuring that the clients and
Squid are using the same DNS resolvers. And that they those resolvers
respond fast. That will allow Squid to verify success more often than
not and caching will raise the HIT ratio on intercepted traffic.

Amos

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002361.html">[squid-dev] Removing DNS lookups in intercept mode by using client dest IP address
</A></li>
	<LI>Next message: <A HREF="002366.html">[squid-dev] Removing DNS lookups in intercept mode by using	client dest IP address
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2362">[ date ]</a>
              <a href="thread.html#2362">[ thread ]</a>
              <a href="subject.html#2362">[ subject ]</a>
              <a href="author.html#2362">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
