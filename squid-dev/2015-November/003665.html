<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Simpler and more robust request line parser
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Simpler%20and%20more%20robust%20request%20line%20parser&In-Reply-To=%3C5638E077.2090303%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003664.html">
   <LINK REL="Next"  HREF="003667.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Simpler and more robust request line parser</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Simpler%20and%20more%20robust%20request%20line%20parser&In-Reply-To=%3C5638E077.2090303%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Simpler and more robust request line parser">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov  3 16:27:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003664.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
        <LI>Next message: <A HREF="003667.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3665">[ date ]</a>
              <a href="thread.html#3665">[ thread ]</a>
              <a href="subject.html#3665">[ subject ]</a>
              <a href="author.html#3665">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2015 02:12 AM, Amos Jeffries wrote:
&gt;&gt;<i> On 24/07/2015 11:13 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> &quot;I am happy to restrict URIs to what older Squids accepted or more.
</I>&gt;&gt;&gt;<i> Recent parser changes broke Squid. There is no need to go beyond what we
</I>&gt;&gt;&gt;<i> were doing before those changes. I will gladly make a simple patch
</I>&gt;&gt;&gt;<i> change to restrict URIs to either that old subset or to the current
</I>&gt;&gt;&gt;<i> trunk subset, whichever is larger. Exactly what subset do you want me to
</I>&gt;&gt;&gt;<i> use?&quot;
</I>

&gt;&gt;<i> Current trunk already accepts all ASCII printable characters, and a
</I>&gt;&gt;<i> bunch of whitespace / control codes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;What I would like&quot; is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> // RFC 3986 URI component character set(s)
</I>&gt;&gt;<i> // RFC 7230 request-line delimiter
</I>&gt;&gt;<i> // RFC 7230 HTTP-version character set
</I>&gt;&gt;<i> auto permit = uriValidCharacters() + CharacterSet::SP;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if (relaxed_header_parser) {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  // RFC7230 section 3.5 alternative control-code whitespace
</I>&gt;&gt;<i>  permit += CharacterSet::HTAB
</I>&gt;&gt;<i>    + CharacterSet(&quot;VT,FF&quot;,&quot;\x0B\x0C&quot;)
</I>&gt;&gt;<i>    + CharacterSet::CR;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #if USE_HTTP_VIOLATIONS
</I>&gt;&gt;<i>   // RFC 2396 unwise character set
</I>&gt;&gt;<i>   // the &quot;transport agents are known to sometimes modify or use as
</I>&gt;&gt;<i> delimiter&quot; set
</I>&gt;&gt;<i>   // which must never be transmitted in un-escaped form
</I>&gt;&gt;<i>   permit.add('\0');
</I>&gt;&gt;<i>   permit += CharacterSet(&quot;RFC2396-unwise&quot;,&quot;\&quot;\\|^&lt;&gt;`{}&quot;);
</I>&gt;&gt;<i> #endif
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Which leaves some 27 CTL characters (0x01-0x1F) still forbidden. Things
</I>&gt;&gt;<i> like delete, backslash, bell, escape, end-of-transmission. I hope you
</I>&gt;&gt;<i> are not going to argue for re-enabling those inside this parser.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Of course the bare UTF-8 extended unicode characters are omitted too.
</I>&gt;&gt;<i> Those is prohibited anywhere in HTTP, and a sure sign that its non-HTTP
</I>&gt;&gt;<i> being processed. So definitely exit this parser.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IFF you have no objections to the above charsets then the only thing
</I>&gt;&gt;<i> this patch is waiting on in the technical sense is polygraph test results.
</I>

&gt;<i> Ping. Do we have agreement on those character sets ?
</I>
Maybe. I asked for the exact &quot;relaxed parser&quot; &quot;HTTP violating&quot; set (the
only important case in the real world). You gave me code constructing
various sets under various conditions. Until I start porting the
proposed patch to trunk, I would not know whether your code is
compatible with what I think we should do, and what sets it constructs.

You also expressed hope that we will not re-enable support for CTL
characters. I do not know whether the old parser allowed [some of] them,
which is one of the primary acceptance conditions for me (by default, we
want to accept everything old Squid accepted and possibly more; any new
restrictions should be discussed).

You also talked about Unicode which sounds completely irrelevant to me
because we are (or should be) dealing with octets and their 0-255
integer values, not any smart encoding on top of that.

In summary, I could not (and still cannot) respond with a quick
&quot;agreed/disagreed&quot;. You did not give me enough information in an
digestible enough form to do that. You are certainly _not_ obligated to
provide the info I ask in a form I can quickly grok! I am just
explaining why I could not respond promptly.


Moreover, there is still some merging work required because you have
changed the parser between my review of your parser and my suggested
replacement patch. I could no longer simply adjust the sets and apply my
patch back then. That merging work is still required. If you have the
time to do that, please do it.


&gt;<i> I'm willing to skip the polygraph request and let the regular trunk
</I>&gt;<i> testing handle that part now.
</I>
Noted.


Thank you,

Alex.

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003664.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
	<LI>Next message: <A HREF="003667.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3665">[ date ]</a>
              <a href="thread.html#3665">[ thread ]</a>
              <a href="subject.html#3665">[ subject ]</a>
              <a href="author.html#3665">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
