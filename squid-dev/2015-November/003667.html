<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Simpler and more robust request line parser
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Simpler%20and%20more%20robust%20request%20line%20parser&In-Reply-To=%3C56390697.5010208%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003665.html">
   <LINK REL="Next"  HREF="003670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Simpler and more robust request line parser</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Simpler%20and%20more%20robust%20request%20line%20parser&In-Reply-To=%3C56390697.5010208%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Simpler and more robust request line parser">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov  3 19:10:15 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003665.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
        <LI>Next message: <A HREF="003670.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3667">[ date ]</a>
              <a href="thread.html#3667">[ thread ]</a>
              <a href="subject.html#3667">[ subject ]</a>
              <a href="author.html#3667">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/11/2015 5:27 a.m., Alex Rousskov wrote:
&gt;<i> On 11/03/2015 02:12 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 24/07/2015 11:13 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> &quot;I am happy to restrict URIs to what older Squids accepted or more.
</I>&gt;&gt;&gt;&gt;<i> Recent parser changes broke Squid. There is no need to go beyond what we
</I>&gt;&gt;&gt;&gt;<i> were doing before those changes. I will gladly make a simple patch
</I>&gt;&gt;&gt;&gt;<i> change to restrict URIs to either that old subset or to the current
</I>&gt;&gt;&gt;&gt;<i> trunk subset, whichever is larger. Exactly what subset do you want me to
</I>&gt;&gt;&gt;&gt;<i> use?&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Current trunk already accepts all ASCII printable characters, and a
</I>&gt;&gt;&gt;<i> bunch of whitespace / control codes.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &quot;What I would like&quot; is:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> // RFC 3986 URI component character set(s)
</I>&gt;&gt;&gt;<i> // RFC 7230 request-line delimiter
</I>&gt;&gt;&gt;<i> // RFC 7230 HTTP-version character set
</I>&gt;&gt;&gt;<i> auto permit = uriValidCharacters() + CharacterSet::SP;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> if (relaxed_header_parser) {
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  // RFC7230 section 3.5 alternative control-code whitespace
</I>&gt;&gt;&gt;<i>  permit += CharacterSet::HTAB
</I>&gt;&gt;&gt;<i>    + CharacterSet(&quot;VT,FF&quot;,&quot;\x0B\x0C&quot;)
</I>&gt;&gt;&gt;<i>    + CharacterSet::CR;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #if USE_HTTP_VIOLATIONS
</I>&gt;&gt;&gt;<i>   // RFC 2396 unwise character set
</I>&gt;&gt;&gt;<i>   // the &quot;transport agents are known to sometimes modify or use as
</I>&gt;&gt;&gt;<i> delimiter&quot; set
</I>&gt;&gt;&gt;<i>   // which must never be transmitted in un-escaped form
</I>&gt;&gt;&gt;<i>   permit.add('\0');
</I>&gt;&gt;&gt;<i>   permit += CharacterSet(&quot;RFC2396-unwise&quot;,&quot;\&quot;\\|^&lt;&gt;`{}&quot;);
</I>&gt;&gt;&gt;<i> #endif
</I>&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Which leaves some 27 CTL characters (0x01-0x1F) still forbidden. Things
</I>&gt;&gt;&gt;<i> like delete, backslash, bell, escape, end-of-transmission. I hope you
</I>&gt;&gt;&gt;<i> are not going to argue for re-enabling those inside this parser.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Of course the bare UTF-8 extended unicode characters are omitted too.
</I>&gt;&gt;&gt;<i> Those is prohibited anywhere in HTTP, and a sure sign that its non-HTTP
</I>&gt;&gt;&gt;<i> being processed. So definitely exit this parser.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> IFF you have no objections to the above charsets then the only thing
</I>&gt;&gt;&gt;<i> this patch is waiting on in the technical sense is polygraph test results.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Ping. Do we have agreement on those character sets ?
</I>&gt;<i> 
</I>&gt;<i> Maybe. I asked for the exact &quot;relaxed parser&quot; &quot;HTTP violating&quot; set (the
</I>&gt;<i> only important case in the real world). You gave me code constructing
</I>&gt;<i> various sets under various conditions. Until I start porting the
</I>&gt;<i> proposed patch to trunk, I would not know whether your code is
</I>&gt;<i> compatible with what I think we should do, and what sets it constructs.
</I>&gt;<i> 
</I>
Strict parsing:
 0x20-0x21, 0x23-0x3B, 0x3D, 0x3F-0x5B, 0x5D, 0x5F, 0x61-0x7A, 0x7E

Relaxed parsing:
 0x09-0x0d, 0x20-0x21, 0x23-0x3B, 0x3D, 0x3F-0x5B, 0x5D, 0x5F,
0x61-0x7A, 0x7E

Relaxed parsing with USE_HTTP_VIOLATIONS enabled:
 0x09-0x0d, 0x20-0x7E


NOTE 1: violatison is enabled by default. To get non-violations
behaviour people have to have explicitly configured strict parsing, or
built the proxy without violations (reducing their relaxed parser to
just the compliant tolerances).

NOTE 2: HTTP is ASCII-only unless specifically documented. The
request-line is not one of those special cases. The 0x80-0xFF octet
range is not part of ASCII.


I cannot do a proper comparison to the old-old parser because there was
not just one of them. But 3 and bits of partial-parsing in a few places.
They mostly appeared to accept 0x00-0x09, 0x0B-0xFF, with various bits
of the buffer having specific exact-string matches applied or passed
directly to syscalls depending on what code path was being followed.

The biggest problem is the main syscall, isspace() which is locale
dependent. So there are some really weird attacks possible by sending an
HTTP message with locale-specific &quot;whitspace&quot; delimiters around the URL
field, then the first actual SP (0x20) character on another line
somewhere after the first \n character. Sometimes that second line gets
parsed and used as the URL, not the one on the first line of the message.


I can see where your temptation to accept 0x00-0xFF comes from. But I
really think we need to do better with the validation side of parse now,
since this parser is replacing whole code paths of both parse and
validation.

Rejecting the 0x01-0x08, 0x0E-0x1F, 0x7F set even in violations mode is
a good start on that. Those characters are non-printable and can affect
display in logs, terminals, and when debugging.



&gt;<i> You also expressed hope that we will not re-enable support for CTL
</I>&gt;<i> characters. I do not know whether the old parser allowed [some of] them,
</I>&gt;<i> which is one of the primary acceptance conditions for me (by default, we
</I>&gt;<i> want to accept everything old Squid accepted and possibly more; any new
</I>&gt;<i> restrictions should be discussed).
</I>&gt;<i> 
</I>&gt;<i> You also talked about Unicode which sounds completely irrelevant to me
</I>&gt;<i> because we are (or should be) dealing with octets and their 0-255
</I>&gt;<i> integer values, not any smart encoding on top of that.
</I>
Unicode: octets 0x80-0xFF.

&gt;<i> 
</I>&gt;<i> In summary, I could not (and still cannot) respond with a quick
</I>&gt;<i> &quot;agreed/disagreed&quot;. You did not give me enough information in an
</I>&gt;<i> digestible enough form to do that. You are certainly _not_ obligated to
</I>&gt;<i> provide the info I ask in a form I can quickly grok! I am just
</I>&gt;<i> explaining why I could not respond promptly.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Moreover, there is still some merging work required because you have
</I>&gt;<i> changed the parser between my review of your parser and my suggested
</I>&gt;<i> replacement patch. I could no longer simply adjust the sets and apply my
</I>&gt;<i> patch back then. That merging work is still required. If you have the
</I>&gt;<i> time to do that, please do it.
</I>
The current parser is accepting the same sets above that I am requesting
from yours, in those same above modes. It seems to be working okay so
far as the charactersets go.

Trying to update the patch now.

Thank you.

Amos
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003665.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
	<LI>Next message: <A HREF="003670.html">[squid-dev] [PATCH] Simpler and more robust request line parser
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3667">[ date ]</a>
              <a href="thread.html#3667">[ thread ]</a>
              <a href="subject.html#3667">[ subject ]</a>
              <a href="author.html#3667">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
