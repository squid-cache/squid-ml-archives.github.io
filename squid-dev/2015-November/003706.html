<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fix for cache_peer forceddomain= in CONNECT case
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fix%20for%20cache_peer%20forceddomain%3D%20in%20CONNECT%20case&In-Reply-To=%3C56411288.60807%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003695.html">
   <LINK REL="Next"  HREF="003697.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fix for cache_peer forceddomain= in CONNECT case</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fix%20for%20cache_peer%20forceddomain%3D%20in%20CONNECT%20case&In-Reply-To=%3C56411288.60807%40treenet.co.nz%3E"
       TITLE="[squid-dev] Fix for cache_peer forceddomain= in CONNECT case">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Nov  9 21:39:20 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003695.html">[squid-dev] Fix for cache_peer forceddomain= in CONNECT case
</A></li>
        <LI>Next message: <A HREF="003697.html">[squid-dev] [PATCH] SourceFormat: rename cache_manager.cc to	CacheManager.cc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3706">[ date ]</a>
              <a href="thread.html#3706">[ thread ]</a>
              <a href="subject.html#3706">[ subject ]</a>
              <a href="author.html#3706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/11/2015 1:18 a.m., aymericvincent wrote:
&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> while looking around for the impact of the auth-no-keytab patch, I
</I>&gt;<i> stumbled upon a missing copy of peer_domain in src/tunnel.cc and I
</I>&gt;<i> can confirm that the Host: line is not forced if I query a document
</I>&gt;<i> through a https URL whereas it is forced if I query the same document
</I>&gt;<i> through a http URL.
</I>&gt;<i> 
</I>&gt;<i> Could you please review the implications of this patch and commit it?
</I>&gt;<i> I'm not using the feature.
</I>
Thank you.

I found two places in the trunk tunnel code where peer_login is being
set and it looks like the domain should be too. One in
tunnelConnectDone, the other in switchToTunnel. I have applied the same
change to both places in trunk rev.14392.


Since you ask, the implications are potentially nasty but only in the
rare case that the recipient pays any attention at all to Host on these
messages.
With the domain in the authority-URI the Host header on a CONNECT
request is meaningless - and its so widely abused with garbage values
that if there is a sane proxy at the other end it will just ignore the
header.


&gt;<i> 
</I>&gt;<i> Might it explain the problem described at
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/26548298/squid3-reverse-ssl-proxy-squid-x509-v-err-domain-mismatch-error">http://stackoverflow.com/questions/26548298/squid3-reverse-ssl-proxy-squid-x509-v-err-domain-mismatch-error</A>
</I>&gt;<i> ?
</I>&gt;<i> 
</I>
Possibly. It gets complicated with two distinct domains in the CONNECT
message, SNI values from-client and to-server, three domain fields in
the X.509 certificate each containing whole lists of domains, and both
OpenSSL validator and Squid helper potentially involved - plus
implementation bugs. So I'm quite hesitant to give an opinion about that
old Squid version.


PS. can you please prefix your subject lines with &quot;[PATCH]&quot; in future
when you include a patch. Thank you.

Amos
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003695.html">[squid-dev] Fix for cache_peer forceddomain= in CONNECT case
</A></li>
	<LI>Next message: <A HREF="003697.html">[squid-dev] [PATCH] SourceFormat: rename cache_manager.cc to	CacheManager.cc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3706">[ date ]</a>
              <a href="thread.html#3706">[ thread ]</a>
              <a href="subject.html#3706">[ subject ]</a>
              <a href="author.html#3706">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
