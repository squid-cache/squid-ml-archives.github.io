<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PREVIEW] Store API changes blocking bug #7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPREVIEW%5D%20Store%20API%20changes%20blocking%20bug%20%237&In-Reply-To=%3C5643CDB4.9090405%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003735.html">
   <LINK REL="Next"  HREF="003713.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PREVIEW] Store API changes blocking bug #7</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPREVIEW%5D%20Store%20API%20changes%20blocking%20bug%20%237&In-Reply-To=%3C5643CDB4.9090405%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PREVIEW] Store API changes blocking bug #7">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 11 23:22:28 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003735.html">[squid-dev] [PATCH] ignore build-generated files
</A></li>
        <LI>Next message: <A HREF="003713.html">[squid-dev] [PREVIEW] Store API changes blocking bug #7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3711">[ date ]</a>
              <a href="thread.html#3711">[ thread ]</a>
              <a href="subject.html#3711">[ subject ]</a>
              <a href="author.html#3711">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    The attached compressed diff represents a 70% complete first step
towards bug #7 fix. This step focus is on fixing &quot;all Stores are the
same&quot; API that forced us to bloat the base Store class with methods
needed only in Store::Root() Controller or other specific storage
classes. Besides unblocking bug 7 development, one of the primary
objectives of this step was to avoid functionality changes (so that they
will be considered for v4.0 inclusion instead of forcing a branching point).

There are a few technical details below, but I am posting this preview
to ask the following high-level questions:

1. Should I move most of the remaining [Ss]tore*.{cc,h} code to src/store/?

2. Should I place most of the moved code in #1 under Store namespace,
and perform other aggressive renamings as needed to polish Store API?

Item #1 will require many changes to #include statements throughout the
code but is kind of incomplete (some might say pointless?) without #2.
Doing #2 will cause lots of changes in the caller code throughout Squid.
Both will significantly delay bug #7 fix due to sheer amount of renaming
work. If there is no strong consensus that these changes should be done
now, then I will _not_ do them, finish the previewed changes, and then
proceed with the actual bug #7 fix.

Also, src/store/Disk.* (i.e. a single cache_dir) kind of clashes with
src/disk.* (low-level disk I/O operations), but I cannot find a better
name for Store::Disk. The old SwapDir name feels rather inadequate for
some cache_dir types, and especially awkward inside the Store namespace:
Store::SwapDir. Better names for Store::Disk and Store::Disks classes
are welcomed.


Please keep the virtually-no-functionality-changes restriction in mind
when answering these questions!



The attached patch polishes class naming and source file locations:

  src/SwapDir.h =&gt; src/store/Disk.h (and Controller.h)
  src/SwapDir.cc =&gt; src/store/Disk.cc
  src/StoreHashIndex.h =&gt; src/store/Disks.h
  src/store_dir.cc =&gt; src/store/Controller.cc (and Disks.cc)

The code movement to files in parenthesis is not tracked by bzr because
bzr cannot track file splits, and most of the moved code had to be
splitted across multiple files to untangle various messes. When deciding
what to tell &quot;bzr mv&quot;, I picked file pairs that would allow us to track
the most complex, most voluminous code but there is probably no single
correct way to do that.

Again, I tried to preserve the functionality of the moved code (but
without better bzr support it is especially difficult to validate that
all moved code was moved intact).


The Store namespace hierarchy now looks like this:

* Storage: Any storage. Similar to the old Store class, but leaner.

* Controller: Combined memory/disks caches and transients.

* Controlled: Memory cache, disk(s) cache, or transient Storage.

* Disks: All disk caches combined.

* Disk: A single cache_dir Storage.

* Memory: A memory cache.

* Transients: Entries capable of being collapsed for CF.

The last two are not moved/finalized yet, but it should not be too
difficult.

Untested; &quot;make all&quot; works (with hacks) but &quot;make check&quot; fails. This is
PREVIEW!


Thank you,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: bug7-api-fixes-t5.patch.gz
Type: application/gzip
Size: 49079 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151111/ff557606/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151111/ff557606/attachment-0001.bin</A>&gt;
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003735.html">[squid-dev] [PATCH] ignore build-generated files
</A></li>
	<LI>Next message: <A HREF="003713.html">[squid-dev] [PREVIEW] Store API changes blocking bug #7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3711">[ date ]</a>
              <a href="thread.html#3711">[ thread ]</a>
              <a href="subject.html#3711">[ subject ]</a>
              <a href="author.html#3711">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
