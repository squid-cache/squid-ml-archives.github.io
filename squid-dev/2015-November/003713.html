<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PREVIEW] Store API changes blocking bug #7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPREVIEW%5D%20Store%20API%20changes%20blocking%20bug%20%237&In-Reply-To=%3C56441631.1010808%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003711.html">
   <LINK REL="Next"  HREF="003767.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PREVIEW] Store API changes blocking bug #7</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPREVIEW%5D%20Store%20API%20changes%20blocking%20bug%20%237&In-Reply-To=%3C56441631.1010808%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PREVIEW] Store API changes blocking bug #7">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov 12 04:31:45 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003711.html">[squid-dev] [PREVIEW] Store API changes blocking bug #7
</A></li>
        <LI>Next message: <A HREF="003767.html">[squid-dev] [PATCH] Store API changes blocking bug #7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3713">[ date ]</a>
              <a href="thread.html#3713">[ thread ]</a>
              <a href="subject.html#3713">[ subject ]</a>
              <a href="author.html#3713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/11/2015 12:22 p.m., Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     The attached compressed diff represents a 70% complete first step
</I>&gt;<i> towards bug #7 fix. This step focus is on fixing &quot;all Stores are the
</I>&gt;<i> same&quot; API that forced us to bloat the base Store class with methods
</I>&gt;<i> needed only in Store::Root() Controller or other specific storage
</I>&gt;<i> classes. Besides unblocking bug 7 development, one of the primary
</I>&gt;<i> objectives of this step was to avoid functionality changes (so that they
</I>&gt;<i> will be considered for v4.0 inclusion instead of forcing a branching point).
</I>&gt;<i> 
</I>&gt;<i> There are a few technical details below, but I am posting this preview
</I>&gt;<i> to ask the following high-level questions:
</I>&gt;<i> 
</I>&gt;<i> 1. Should I move most of the remaining [Ss]tore*.{cc,h} code to src/store/?
</I>&gt;<i> 
</I>&gt;<i> 2. Should I place most of the moved code in #1 under Store namespace,
</I>&gt;<i> and perform other aggressive renamings as needed to polish Store API?
</I>&gt;<i> 
</I>&gt;<i> Item #1 will require many changes to #include statements throughout the
</I>&gt;<i> code but is kind of incomplete (some might say pointless?) without #2.
</I>&gt;<i> Doing #2 will cause lots of changes in the caller code throughout Squid.
</I>&gt;<i> Both will significantly delay bug #7 fix due to sheer amount of renaming
</I>&gt;<i> work. If there is no strong consensus that these changes should be done
</I>&gt;<i> now, then I will _not_ do them, finish the previewed changes, and then
</I>&gt;<i> proceed with the actual bug #7 fix.
</I>
If they are not necessary, then I think procrastinate.


&gt;<i> 
</I>&gt;<i> Also, src/store/Disk.* (i.e. a single cache_dir) kind of clashes with
</I>&gt;<i> src/disk.* (low-level disk I/O operations), but I cannot find a better
</I>&gt;<i> name for Store::Disk. The old SwapDir name feels rather inadequate for
</I>&gt;<i> some cache_dir types, and especially awkward inside the Store namespace:
</I>&gt;<i> Store::SwapDir. Better names for Store::Disk and Store::Disks classes
</I>&gt;<i> are welcomed.
</I>
One of them will definitely need to rename. We cannot have any files in
src/ that matches case-insensitively with a file in one of the
sub-directories.

There are several OS and at least some of the community self-builds that
I know of building Squid with case insensitive filesystems or
case-ignorant automake.


&gt;<i> 
</I>&gt;<i> Please keep the virtually-no-functionality-changes restriction in mind
</I>&gt;<i> when answering these questions!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The attached patch polishes class naming and source file locations:
</I>&gt;<i> 
</I>&gt;<i>   src/SwapDir.h =&gt; src/store/Disk.h (and Controller.h)
</I>&gt;<i>   src/SwapDir.cc =&gt; src/store/Disk.cc
</I>&gt;<i>   src/StoreHashIndex.h =&gt; src/store/Disks.h
</I>&gt;<i>   src/store_dir.cc =&gt; src/store/Controller.cc (and Disks.cc)
</I>&gt;<i> 
</I>&gt;<i> The code movement to files in parenthesis is not tracked by bzr because
</I>&gt;<i> bzr cannot track file splits, and most of the moved code had to be
</I>&gt;<i> splitted across multiple files to untangle various messes. When deciding
</I>&gt;<i> what to tell &quot;bzr mv&quot;, I picked file pairs that would allow us to track
</I>&gt;<i> the most complex, most voluminous code but there is probably no single
</I>&gt;<i> correct way to do that.
</I>
Good. Thats what I would have done too (and have in the past).

&gt;<i> 
</I>&gt;<i> Again, I tried to preserve the functionality of the moved code (but
</I>&gt;<i> without better bzr support it is especially difficult to validate that
</I>&gt;<i> all moved code was moved intact).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Store namespace hierarchy now looks like this:
</I>&gt;<i> 
</I>&gt;<i> * Storage: Any storage. Similar to the old Store class, but leaner.
</I>&gt;<i> 
</I>&gt;<i> * Controller: Combined memory/disks caches and transients.
</I>&gt;<i> 
</I>&gt;<i> * Controlled: Memory cache, disk(s) cache, or transient Storage.
</I>&gt;<i> 
</I>&gt;<i> * Disks: All disk caches combined.
</I>&gt;<i> 
</I>&gt;<i> * Disk: A single cache_dir Storage.
</I>&gt;<i> 
</I>&gt;<i> * Memory: A memory cache.
</I>&gt;<i> 
</I>&gt;<i> * Transients: Entries capable of being collapsed for CF.
</I>&gt;<i> 
</I>&gt;<i> The last two are not moved/finalized yet, but it should not be too
</I>&gt;<i> difficult.
</I>&gt;<i> 
</I>&gt;<i> Untested; &quot;make all&quot; works (with hacks) but &quot;make check&quot; fails. This is
</I>&gt;<i> PREVIEW!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>
Thank you.

Amos

</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003711.html">[squid-dev] [PREVIEW] Store API changes blocking bug #7
</A></li>
	<LI>Next message: <A HREF="003767.html">[squid-dev] [PATCH] Store API changes blocking bug #7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3713">[ date ]</a>
              <a href="thread.html#3713">[ thread ]</a>
              <a href="subject.html#3713">[ subject ]</a>
              <a href="author.html#3713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
