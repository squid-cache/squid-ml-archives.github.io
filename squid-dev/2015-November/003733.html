<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20is%20this%20really%20an%20ICAP%20206%20response%20%22protocol%0A%09error%22%2C%20if%20so%20what%3F&In-Reply-To=%3C564542E9.1000701%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003732.html">
   <LINK REL="Next"  HREF="003734.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20is%20this%20really%20an%20ICAP%20206%20response%20%22protocol%0A%09error%22%2C%20if%20so%20what%3F&In-Reply-To=%3C564542E9.1000701%40measurement-factory.com%3E"
       TITLE="[squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Nov 13 01:54:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003732.html">[squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?
</A></li>
        <LI>Next message: <A HREF="003734.html">[squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3733">[ date ]</a>
              <a href="thread.html#3733">[ thread ]</a>
              <a href="subject.html#3733">[ subject ]</a>
              <a href="author.html#3733">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/12/2015 05:27 PM, Eliezer Croitoru wrote:

&gt;<i> What I have found is an exception in the logs which results in
</I>&gt;<i> &quot;ICAP_ERR_OTHER&quot; but I am unable to understand what the issue is.
</I>&gt;<i> 
</I>&gt;<i> The lines from the log are:
</I>&gt;<i> 2015/11/13 01:47:22.072 kid1| 0,3| TextException.cc(87) Throw:
</I>&gt;<i> ModXact.cc:918: exception: state.allowedPostview206
</I>

The code on that line is pretty clear IMO:

&gt;<i> void Adaptation::Icap::ModXact::handle206PartialContent()
</I>&gt;<i> {
</I>&gt;<i> if (state.writing == State::writingPaused) {
</I>&gt;<i>     Must(preview.enabled());
</I>&gt;<i>     Must(state.allowedPreview206);
</I>&gt;<i>     debugs(93, 7, HERE &lt;&lt; &quot;206 inside preview&quot;);
</I>&gt;<i> } else {
</I>&gt;<i>     Must(state.writing &gt; State::writingPaused);
</I>&gt;<i>     Must(state.allowedPostview206);
</I>&gt;<i>     debugs(93, 7, HERE &lt;&lt; &quot;206 outside preview&quot;);
</I>&gt;<i> }
</I>

The state.allowedPostview206 exception means that Squid thinks that the
following are all true:

1. Squid received ICAP 206 response;
2. Squid received a response outside of Preview; and
3. Squid did _not_ allow 206 outside of Preview.

You need to figure out which of those three assumptions are false.

If you start digging around, you may eventually find that Squid did not
allow your service to send a 206 response in the first place:

&gt;<i> RESPMOD <A HREF="icap://127.0.0.2:1344/allow_cache">icap://127.0.0.2:1344/allow_cache</A> ICAP/1.0
</I>&gt;<i> Encapsulated: req-hdr=0, res-hdr=144, null-body=444
</I>&gt;<i> Allow: 204
</I>
but your service did anyway:

&gt;<i> ICAP/1.0 206 Partial Content
</I>&gt;<i> Encapsulated: res-hdr=0, res-body=331
</I>
There are other problems with your service response. For example, it
tells Squid to use a body (use-original-body=0) that Squid said does not
exist (null-body).

As I have mentioned before, writing a high-quality ICAP service is more
difficult than it may seem. Correctly handling 206 transactions is even
more so.


As a consolation prize, consider reproducing and filing a bug report
against Squid as well: AFAICT, the state.writing == State::writingPaused
condition in handle206PartialContent() is wrong because when there is no
HTTP message body at all, Squid may be in Preview state (from the ICAP
point of view), but state.writing will not be State::writingPaused. It
will be State::writingReallyDone AFAICT. Your logs seem to confirm that.


HTH,

Alex.
P.S. Please do not use .gz extension for bzip2-compressed files.

</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003732.html">[squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?
</A></li>
	<LI>Next message: <A HREF="003734.html">[squid-dev] is this really an ICAP 206 response &quot;protocol	error&quot;, if so what?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3733">[ date ]</a>
              <a href="thread.html#3733">[ thread ]</a>
              <a href="subject.html#3733">[ subject ]</a>
              <a href="author.html#3733">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
