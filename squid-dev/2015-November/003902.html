<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Hello%20and%20ssl_bump%20and%20External%20ACLs%20-%204.0.2&In-Reply-To=%3CCC3664F6-C4CC-46FB-AA6D-EF2B7C83010A%40realitymine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003900.html">
   <LINK REL="Next"  HREF="003904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2</H1>
    <B>Dave Lewthwaite</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Hello%20and%20ssl_bump%20and%20External%20ACLs%20-%204.0.2&In-Reply-To=%3CCC3664F6-C4CC-46FB-AA6D-EF2B7C83010A%40realitymine.com%3E"
       TITLE="[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2">Dave.Lewthwaite at realitymine.com
       </A><BR>
    <I>Mon Nov 23 12:16:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003900.html">[squid-dev] on_unsupported_protocol doesn't work for bumped https connecttions
</A></li>
        <LI>Next message: <A HREF="003904.html">[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3902">[ date ]</a>
              <a href="thread.html#3902">[ thread ]</a>
              <a href="subject.html#3902">[ subject ]</a>
              <a href="author.html#3902">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I’ve finally found time to join the dev mailing list, I work with squid on a daily basis and we’re always needing the latest features which often causes to use beta’s and nightlies rather than final releases. At the moment I’m having an issue with SSL peek and splice with external ACLs.

I'm using Squid 4.0.2 compiled for CentOS 7 and i'm having issues with the SSL peek and splice configuration that previously worked in 3.5.11 with no problems. (The reason to update is to get eliptic curve cipher support).

Relavent config

external_acl_type extallowedSslUsers children-startup=1 children-max=40 ttl=0 negative_ttl=0 %MYPORT %SRC %{X-Proxy-Port}&gt;h %{User-Agent}&gt;h %DST %ssl::&gt;sni /etc/squid/acl/aclSSLInterceptUsers.php
acl allowedSslUsers external extallowedSslUsers

acl DiscoverSNIHost at_step SslBump1

ssl_bump stare DiscoverSNIHost all
ssl_bump bump allowedSslUsers
ssl_bump splice all

In this configuration when using a normal proxy port or transparent port, the external ACL is never evaluated - it logs

WARNING: allowedSslUsers ACL is used in context without an ALE state. Assuming mismatch.

Changing DiscoverSNIHost to be SslBump2 causes the external acl to be evaluated for normal proxy port (but SNI is not populated) but still not for transparent proxy.

The aim is to retrieve the SNI sent by the client to use in both logging and the external ACL.

Swapping stare for peek gives the same behaviour. As far as I can tell, if the system hits this point (without an ALE state) it will skip the ACL check and return false – obviously that’s a problem – I’ve also tried stripping out parameters from the external acl to no avail.

Is this a bug or a mis-configuration?

I can supply debug logs, traces etc if required.

Thanks


Dave Lewthwaite
Infrastructure Systems Architect, RealityMine

[cid:2A866CD1-FB22-42AF-8EC3-AE86345E4557]
E: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">davel at realitymine.com</A>&lt;mailto:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">davel at realitymine.com</A>&gt; | M: +44 (0) 7919 100 358 | W: www.realitymine.com&lt;<A HREF="http://www.realitymine.com/">http://www.realitymine.com/</A>&gt; | T:  +44 (0) 161 414 0707

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151123/04efaf6e/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151123/04efaf6e/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: AB77E50D-9940-4F90-9B76-06A0E4BDC5F0[3].png
Type: image/png
Size: 8554 bytes
Desc: AB77E50D-9940-4F90-9B76-06A0E4BDC5F0[3].png
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151123/04efaf6e/attachment.png">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151123/04efaf6e/attachment.png</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003900.html">[squid-dev] on_unsupported_protocol doesn't work for bumped https connecttions
</A></li>
	<LI>Next message: <A HREF="003904.html">[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3902">[ date ]</a>
              <a href="thread.html#3902">[ thread ]</a>
              <a href="subject.html#3902">[ subject ]</a>
              <a href="author.html#3902">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
