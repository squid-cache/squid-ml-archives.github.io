<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Hello%20and%20ssl_bump%20and%20External%20ACLs%20-%204.0.2&In-Reply-To=%3C56543A28.6090002%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003904.html">
   <LINK REL="Next"  HREF="003913.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Hello%20and%20ssl_bump%20and%20External%20ACLs%20-%204.0.2&In-Reply-To=%3C56543A28.6090002%40chtsanti.net%3E"
       TITLE="[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2">christos at chtsanti.net
       </A><BR>
    <I>Tue Nov 24 10:21:28 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003904.html">[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
</A></li>
        <LI>Next message: <A HREF="003913.html">[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3912">[ date ]</a>
              <a href="thread.html#3912">[ thread ]</a>
              <a href="subject.html#3912">[ subject ]</a>
              <a href="author.html#3912">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am attaching a small (not well tested) patch, which fixed a similar 
problem for me, in the case someone want to test it.

Amos,
  should we try to retrieve ALE object from 
HttpRequest-&gt;clientConnectionManager-&gt;getCurrentContext()-&gt;http-&gt;al, or 
other sources, inside ACLFilledChecklist::syncAle(), if it is not set?



On 11/24/2015 07:44 AM, Amos Jeffries wrote:
&gt;<i> On 24/11/2015 1:16 a.m., Dave Lewthwaite wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I’ve finally found time to join the dev mailing list, I work with squid on a daily basis and we’re always needing the latest features which often causes to use beta’s and nightlies rather than final releases. At the moment I’m having an issue with SSL peek and splice with external ACLs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm using Squid 4.0.2 compiled for CentOS 7 and i'm having issues with the SSL peek and splice configuration that previously worked in 3.5.11 with no problems. (The reason to update is to get eliptic curve cipher support).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Relavent config
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> external_acl_type extallowedSslUsers children-startup=1 children-max=40 ttl=0 negative_ttl=0 %MYPORT %SRC %{X-Proxy-Port}&gt;h %{User-Agent}&gt;h %DST %ssl::&gt;sni /etc/squid/acl/aclSSLInterceptUsers.php
</I>&gt;&gt;<i> acl allowedSslUsers external extallowedSslUsers
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl DiscoverSNIHost at_step SslBump1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump stare DiscoverSNIHost all
</I>&gt;&gt;<i> ssl_bump bump allowedSslUsers
</I>&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In this configuration when using a normal proxy port or transparent port, the external ACL is never evaluated - it logs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> WARNING: allowedSslUsers ACL is used in context without an ALE state. Assuming mismatch.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Changing DiscoverSNIHost to be SslBump2 causes the external acl to be evaluated for normal proxy port (but SNI is not populated) but still not for transparent proxy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The aim is to retrieve the SNI sent by the client to use in both logging and the external ACL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Swapping stare for peek gives the same behaviour. As far as I can tell, if the system hits this point (without an ALE state) it will skip the ACL check and return false – obviously that’s a problem – I’ve also tried stripping out parameters from the external acl to no avail.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is this a bug or a mis-configuration?
</I>&gt;<i>
</I>&gt;<i> It is one of the effects of the external_acl_type format changes.
</I>&gt;<i>
</I>&gt;<i> Is that message occuring on bumped CONNECT messages on an http_port, or
</I>&gt;<i> on an https_port?
</I>&gt;<i>
</I>&gt;<i> And are you able to get an ALL,9 cache.log trace from a test request please?
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: EXTACL_ACL_is_used_in_context_without_an_ALE-t1.patch
Type: text/x-patch
Size: 5305 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151124/13a96363/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151124/13a96363/attachment.bin</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003904.html">[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
</A></li>
	<LI>Next message: <A HREF="003913.html">[squid-dev] Hello and ssl_bump and External ACLs - 4.0.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3912">[ date ]</a>
              <a href="thread.html#3912">[ thread ]</a>
              <a href="subject.html#3912">[ subject ]</a>
              <a href="author.html#3912">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
