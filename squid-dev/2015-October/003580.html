<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] external_acl_type logformat tokens
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20external_acl_type%20logformat%20tokens&In-Reply-To=%3C561534A3.1090406%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003570.html">
   <LINK REL="Next"  HREF="003592.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] external_acl_type logformat tokens</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20external_acl_type%20logformat%20tokens&In-Reply-To=%3C561534A3.1090406%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] external_acl_type logformat tokens">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct  7 15:05:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003570.html">[squid-dev] [PATCH] external_acl_type logformat tokens
</A></li>
        <LI>Next message: <A HREF="003592.html">[squid-dev] [PATCH] external_acl_type logformat tokens
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3580">[ date ]</a>
              <a href="thread.html#3580">[ thread ]</a>
              <a href="subject.html#3580">[ subject ]</a>
              <a href="author.html#3580">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/03/2015 02:35 AM, Amos Jeffries wrote:
&gt;<i> Update the external_acl_type helper interface to use libformat and thus
</I>&gt;<i> make any logformat token valid in its format parameter field.
</I>&gt;<i> 
</I>&gt;<i> As a result much of the logic surrounding format code parsing, display
</I>&gt;<i> and helper query generation has been completely dropped. What remains is
</I>&gt;<i> a basic parse loop handling backward compatibility for the unusual
</I>&gt;<i> %CERT_* token syntax, space delimiter and field default encodings.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Extensions to logformat resulting from the merger:
</I>&gt;<i> 
</I>&gt;<i> * adds \-escape encoding of output fields
</I>&gt;<i> 
</I>&gt;<i> * allows {arg} field to be placed before or after the format code.
</I>&gt;<i> 
</I>&gt;<i> * extended to accept the old external_acl_type %macros. But not
</I>&gt;<i> documented, these are deprecated and only for backward compatibility.
</I>&gt;<i> 
</I>&gt;<i> * extended to support outputting formats without a format-name prefix.
</I>
Please rephrase/clarify the last bullet in the commit message. I do not
know what that last bullet means.



&gt;<i> The major side effect of this change is that these ACLs now require
</I>&gt;<i> AccessLogEntry to be filled out with state data, rather than just the
</I>&gt;<i> ACLChecklist object members.
</I>&gt;<i> 
</I>&gt;<i> The requires*() mechanism of ACLChecklist has been extended to catch
</I>&gt;<i> some cases resulting from missing the ALE entirely. But it cannot catch
</I>&gt;<i> the more subtle problem of data members inside the ALE being unset.
</I>

Agreed. I expect lots of small but time-wasting and
deployment-preventing bugs because of that change.

Would it be possible to avoid most of those problems by using the
following approach?

1. If both hasAleXXX() and requiresAleXXX() are true in
   ACL::matches(), call a new virtual checklist-&gt;syncAle() method.

2. Add FilledChecklist::syncAle() method that fills unset ALE data
   members with data from the checklist object, where possible. This
   can be limited to external_acl_type-relevant fields if needed.

3. If any ALE data member is filled in #2, print a level-1 warning.
   Do not print more than a few such warnings per worker lifetime.

The above plan is meant to alert us of the bugs introduced by this
change without actually exposing admins to those bugs (except for the
warning and a small performance penalty).

Please let me know if the above sketch is not detailed enough to follow.


&gt;<i> +    virtual bool requiresAleXXX() const {return true;}
</I>
I do not think this really warrants an XXX because I see nothing
seriously wrong with this method. Same for hasAleXXX().


&gt;<i>      // Why is this a sub-class and not a set of real &quot;private:&quot; fields?
</I>&gt;<i>      // TODO: shuffle this to the relevant ICP/HTCP protocol section
</I>&gt;<i>      class Private
</I>&gt;<i>      {
</I>&gt;<i>  
</I>&gt;<i>      public:
</I>&gt;<i> -        Private() : method_str(NULL) {}
</I>&gt;<i> +        Private() : method_str(NULL), lastAclName(NULL), lastAclData(NULL) {}
</I>&gt;<i> +        ~Private() {
</I>&gt;<i> +            safe_free(lastAclName);
</I>&gt;<i> +            safe_free(lastAclData);
</I>&gt;<i> +        }
</I>&gt;<i>  
</I>&gt;<i>          const char *method_str;
</I>&gt;<i> +        const char *lastAclName; ///&lt; string for external_acl_type %ACL format code
</I>&gt;<i> +        const char *lastAclData; ///&lt; string for external_acl_type %DATA format code
</I>&gt;<i> +
</I>&gt;<i>      } _private;
</I>

Why exacerbate the existing problem by adding more fields to _private
instead of just adding those fields to the &quot;public:&quot; section? Just give
them names specific to external_acl_type to emphasize that these fields
are not generally available (which is true for many ALE fields). You can
even create a dedicated sub-class for them, like we already do for
protocols!

Eventually, we may decide to support lastAclName for access_log (and
other contexts?) as well.



&gt;<i> +            safe_free(lastAclData);
</I>...
&gt;<i> +            ch-&gt;al-&gt;_private.lastAclData = sb.c_str();
</I>
The combination looks wrong to me. c_str() does not allocate a new
c-string AFAICT.


Please also check the patch for out-of-scope or needless whitespace changes.

This is not a full/detailed audit, but I do not expect to be able to do
more in the foreseeable future. Consider pinging Christos if you need a
second opinion -- he knows this code well.


Thank you,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003570.html">[squid-dev] [PATCH] external_acl_type logformat tokens
</A></li>
	<LI>Next message: <A HREF="003592.html">[squid-dev] [PATCH] external_acl_type logformat tokens
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3580">[ date ]</a>
              <a href="thread.html#3580">[ thread ]</a>
              <a href="subject.html#3580">[ subject ]</a>
              <a href="author.html#3580">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
