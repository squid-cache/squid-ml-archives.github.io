<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20squid-3.5%3A%20fix%20for%20errors%20when%20receiving%20a%0A%20non-existent%20file%20via%20ftp&In-Reply-To=%3C561576C9.2080504%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003583.html">
   <LINK REL="Next"  HREF="003586.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20squid-3.5%3A%20fix%20for%20errors%20when%20receiving%20a%0A%20non-existent%20file%20via%20ftp&In-Reply-To=%3C561576C9.2080504%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct  7 19:47:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003583.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
        <LI>Next message: <A HREF="003586.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3585">[ date ]</a>
              <a href="thread.html#3585">[ thread ]</a>
              <a href="subject.html#3585">[ subject ]</a>
              <a href="author.html#3585">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/07/2015 12:16 PM, Vitaly Lavrov wrote:
&gt;<i> Bug 4279: No response from proxy for FTP-download of non-existing file
</I>&gt;<i> 
</I>&gt;<i> There is no code to handle errors ftp-protocol functions ftpFail().
</I>&gt;<i> The patch forms a response to the client an error similar to loginFailed().
</I>&gt;<i> To handle specific errors, you must add code in failedHttpStatus().
</I>&gt;<i> 
</I>&gt;<i> If you add to the template ERR_FTP_NOT_FOUND macro &quot;%g&quot;, then the client
</I>&gt;<i> will be seen the original message server (550: Permission denied/File
</I>&gt;<i> not found)
</I>&gt;<i> 
</I>&gt;<i> Patch tested on squid-3.5.9
</I>

Hello Vitaly,

    I am glad you were able to fix the problem, and I thank you for
sharing your fix.

Unfortunately, the patch itself needs significant refactoring because
you are [incorrectly] duplicating an already duplicated code. As you
probably know, most of the code you added already exists in
Ftp::Gateway::loginFailed() and, more importantly, in
Ftp::Client::failed(). We do not need a third imperfect copy of that logic!

Somebody should examine your additions as well as the existing two
methods and carefully merge them, keeping Ftp::Relay needs in mind. If
you can help with that, I would recommend the following first steps:

0. Undo your changes (the code may be reused at step #3).

1. Add an optional ErrorState *err parameter to ftpFail() with a default
NULL value. When the parameter is not nil, ftpFail() should use it
instead of creating its own ErrorState.

2. Change Ftp::Gateway::loginFailed() to always call ftpFail() after
trying to create an ErrorState. Move the bottom of
Ftp::Gateway::loginFailed() (i.e., the code that handles non-nil err) to
ftpFail(). Test the refactored code for regressions. This change will
not fix the bug you are after.

3. Compare the resulting ftpFail() with the code from your patch. Add
any missing actions. Test that the resulting code works fine, including
handling the bug you are after.

More work will be needed after the above steps to remove duplication
with Ftp::Client::failed(), but these steps would move us a lot closer
to that final goal.


HTH,

Alex.

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003583.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
	<LI>Next message: <A HREF="003586.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3585">[ date ]</a>
              <a href="thread.html#3585">[ thread ]</a>
              <a href="subject.html#3585">[ subject ]</a>
              <a href="author.html#3585">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
