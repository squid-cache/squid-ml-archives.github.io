<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20squid-3.5%3A%20fix%20for%20errors%20when%20receiving%20a%0A%20non-existent%20file%20via%20ftp&In-Reply-To=%3C56171C41.1090105%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003586.html">
   <LINK REL="Next"  HREF="003593.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20squid-3.5%3A%20fix%20for%20errors%20when%20receiving%20a%0A%20non-existent%20file%20via%20ftp&In-Reply-To=%3C56171C41.1090105%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct  9 01:45:37 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003586.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
        <LI>Next message: <A HREF="003593.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3589">[ date ]</a>
              <a href="thread.html#3589">[ thread ]</a>
              <a href="subject.html#3589">[ subject ]</a>
              <a href="author.html#3589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/10/2015 3:15 a.m., Vitaly Lavrov wrote:
&gt;<i> On 07.10.2015 22:47, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i> Hello Alex.
</I>&gt;<i> 
</I>&gt;<i> Thanks for the quick response.
</I>&gt;&gt;<i> Hello Vitaly,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      I am glad you were able to fix the problem, and I thank you for
</I>&gt;&gt;<i> sharing your fix.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Unfortunately, the patch itself needs significant refactoring because
</I>&gt;&gt;<i> you are [incorrectly] duplicating an already duplicated code. As you
</I>&gt;&gt;<i> probably know, most of the code you added already exists in
</I>&gt;&gt;<i> Ftp::Gateway::loginFailed() and, more importantly, in
</I>&gt;&gt;<i> Ftp::Client::failed(). We do not need a third imperfect copy of that
</I>&gt;&gt;<i> logic!
</I>&gt;<i> Yes, agree!
</I>&gt;&gt;<i> 0. Undo your changes (the code may be reused at step #3).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Add an optional ErrorState *err parameter to ftpFail() with a default
</I>&gt;&gt;<i> NULL value. When the parameter is not nil, ftpFail() should use it
</I>&gt;&gt;<i> instead of creating its own ErrorState.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Change Ftp::Gateway::loginFailed() to always call ftpFail() after
</I>&gt;&gt;<i> trying to create an ErrorState. Move the bottom of
</I>&gt;&gt;<i> Ftp::Gateway::loginFailed() (i.e., the code that handles non-nil err) to
</I>&gt;&gt;<i> ftpFail(). Test the refactored code for regressions. This change will
</I>&gt;&gt;<i> not fix the bug you are after.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3. Compare the resulting ftpFail() with the code from your patch. Add
</I>&gt;&gt;<i> any missing actions. Test that the resulting code works fine, including
</I>&gt;&gt;<i> handling the bug you are after.
</I>&gt;<i> I added a field &quot;ErrorState *ftperr&quot; in class Ftp::Client. If it is not
</I>&gt;<i> NULL,
</I>&gt;<i> the Ftp::Client::failed() uses it.
</I>
This is not what Alex meant by parameter.

Function parameter is passed by the caller directly and only exists
within the specific function call chain where it was passed. It cannot
remain in memory interferring with other state or operations, does not
need any extra constructor/destructor infrastructure code to manage its
existence, and the value of the pointer being NULL/non-NULL can be used
as the boolean of whether to use it or not.

A member like ftperr may be setup by some earlier FTP transaction an
unknown number of steps and time prior to the current error happening.
Then prevents any following errors from using their own ErrorState
object with details about the second error.

For example; if you have some minor error early in the protocol that the
code causes to be ignored (because its minor), then something major like
login could get an irrelevant error page displayed and break the login
process.


&gt;<i> Through &quot;ftperr&quot; also passed
</I>&gt;<i> httpStatus correct and error-code.
</I>&gt;<i> Duplicate code in loginFailed() and ftpFail() removed.
</I>&gt;<i> 
</I>&gt;<i> See the new version of the patch.
</I>&gt;<i> 
</I>&gt;<i> I can not test all variants of handling errors when using the protocol ftp.
</I>&gt;<i> I checked for proper operation without anonymous access, and anonymous
</I>&gt;<i> access
</I>&gt;<i> to the available file, missing file, missing directory in the file path and
</I>&gt;<i> the file inaccessible due to permissions.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> More work will be needed after the above steps to remove duplication
</I>&gt;&gt;<i> with Ftp::Client::failed(), but these steps would move us a lot closer
</I>&gt;&gt;<i> to that final goal.
</I>&gt;&gt;<i>
</I>
This new patch is making things even more complicated than they started
off just by using that new member. Alexs' suggestion was a specific set
of steps that when followed reduces complexity.

Amos

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003586.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
	<LI>Next message: <A HREF="003593.html">[squid-dev] [PATCH] squid-3.5: fix for errors when receiving a non-existent file via ftp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3589">[ date ]</a>
              <a href="thread.html#3589">[ thread ]</a>
              <a href="subject.html#3589">[ subject ]</a>
              <a href="author.html#3589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
