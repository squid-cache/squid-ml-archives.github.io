<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [squid-users] POST upload splits tcp stream in many small 39byte sized pakets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5Bsquid-users%5D%20POST%20upload%20splits%20tcp%20stream%20in%20many%0A%20small%2039byte%20sized%20pakets&In-Reply-To=%3C56266519.7010604%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003630.html">
   <LINK REL="Next"  HREF="003617.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [squid-users] POST upload splits tcp stream in many small 39byte sized pakets</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5Bsquid-users%5D%20POST%20upload%20splits%20tcp%20stream%20in%20many%0A%20small%2039byte%20sized%20pakets&In-Reply-To=%3C56266519.7010604%40ngtech.co.il%3E"
       TITLE="[squid-dev] [squid-users] POST upload splits tcp stream in many small 39byte sized pakets">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Oct 20 16:00:25 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003630.html">[squid-dev] Jenkins build is back to normal : trunk-polygraph #898
</A></li>
        <LI>Next message: <A HREF="003617.html">[squid-dev] [PATCH] %&lt;lp missing for persistent connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3616">[ date ]</a>
              <a href="thread.html#3616">[ thread ]</a>
              <a href="subject.html#3616">[ subject ]</a>
              <a href="author.html#3616">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Toni,

I have not reviewed your tcpdump captures but I have briefly reviewed 
your squid.conf.
The number of packets per second would not be accounted as a DOS unless 
the admin of the service don't really know what it means.
The TCP stack allows a connection to send small packets if there is a 
need and it is a part of the TCP open and available options for the 
public use.

I recommend you to open a bug in the bugzilla using this link:
<A HREF="http://bugs.squid-cache.org/enter_bug.cgi?product=Squid">http://bugs.squid-cache.org/enter_bug.cgi?product=Squid</A>

And choose the &quot;other&quot; component and 3.5 as the version and as confirmed.

I have also tested this issue now after reading your issue and it seems 
to be quite real.
The test I was running was on latest 3.5.10:
[<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">root at proxy</A>]$ http_proxy=&quot;<A HREF="http://192.168.10.150:3128/">http://192.168.10.150:3128/</A>&quot; curl -X POST -H 
&quot;Content-Type: multipart/form-data&quot; -F &quot;data=@/tmp/storeid_db&quot; 
<A HREF="http://ngtech.co.il/favicon.ico">http://ngtech.co.il/favicon.ico</A> &gt;/dev/null

And the tcp dump result was fascinating:
[<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">root at www1</A>]$ tcpdump -n port 80
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
18:57:46.748661 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [S], 
seq 1931160420, win 14600, options [mss 1460,sackOK,TS val 2567736261 
ecr 0,nop,wscale 7], length 0
18:57:46.748801 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [S.], 
seq 2253848035, ack 1931160421, win 28960, options [mss 1460,sackOK,TS 
val 578191590 ecr 2567736261,nop,wscale 7], length 0
18:57:46.754405 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 1, win 115, options [nop,nop,TS val 2567736266 ecr 578191590], length 0
18:57:46.755667 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 1:270, ack 1, win 115, options [nop,nop,TS val 2567736268 ecr 
578191590], length 269
18:57:46.755790 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
ack 270, win 235, options [nop,nop,TS val 578191592 ecr 2567736268], 
length 0
18:57:46.765041 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [P.], 
seq 1:26, ack 270, win 235, options [nop,nop,TS val 578191594 ecr 
2567736268], length 25
18:57:46.766184 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 26, win 115, options [nop,nop,TS val 2567736278 ecr 578191594], length 0
18:57:46.767043 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 270:309, ack 26, win 115, options [nop,nop,TS val 2567736279 ecr 
578191594], length 39
18:57:46.767706 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 309:348, ack 26, win 115, options [nop,nop,TS val 2567736279 ecr 
578191594], length 39
18:57:46.767744 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 348:387, ack 26, win 115, options [nop,nop,TS val 2567736279 ecr 
578191594], length 39
18:57:46.767760 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 387:424, ack 26, win 115, options [nop,nop,TS val 2567736279 ecr 
578191594], length 37
18:57:46.767827 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
ack 424, win 235, options [nop,nop,TS val 578191595 ecr 2567736279], 
length 0
18:57:46.807708 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 424:463, ack 26, win 115, options [nop,nop,TS val 2567736319 ecr 
578191595], length 39
18:57:46.807762 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 463:502, ack 26, win 115, options [nop,nop,TS val 2567736319 ecr 
578191595], length 39
18:57:46.807779 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 502:541, ack 26, win 115, options [nop,nop,TS val 2567736319 ecr 
578191595], length 39
18:57:46.807791 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 541:580, ack 26, win 115, options [nop,nop,TS val 2567736319 ecr 
578191595], length 39
18:57:46.807809 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 580:619, ack 26, win 115, options [nop,nop,TS val 2567736319 ecr 
578191595], length 39
18:57:46.807823 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 619:658, ack 26, win 115, options [nop,nop,TS val 2567736320 ecr 
578191595], length 39
18:57:46.807870 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [P.], 
seq 658:672, ack 26, win 115, options [nop,nop,TS val 2567736320 ecr 
578191595], length 14
18:57:46.807976 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
ack 672, win 235, options [nop,nop,TS val 578191605 ecr 2567736319], 
length 0
18:57:46.808180 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
seq 26:2922, ack 672, win 235, options [nop,nop,TS val 578191605 ecr 
2567736319], length 2896
18:57:46.808221 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
seq 2922:5818, ack 672, win 235, options [nop,nop,TS val 578191605 ecr 
2567736319], length 2896
18:57:46.808241 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [P.], 
seq 5818:8714, ack 672, win 235, options [nop,nop,TS val 578191605 ecr 
2567736319], length 2896
18:57:46.808260 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
seq 8714:11610, ack 672, win 235, options [nop,nop,TS val 578191605 ecr 
2567736319], length 2896
18:57:46.808280 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [.], 
seq 11610:14506, ack 672, win 235, options [nop,nop,TS val 578191605 ecr 
2567736319], length 2896
18:57:46.809154 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 2922, win 160, options [nop,nop,TS val 2567736321 ecr 578191605], 
length 0
18:57:46.809226 IP 192.168.10.1.80 &gt; 192.168.10.254.40918: Flags [P.], 
seq 14506:17258, ack 672, win 235, options [nop,nop,TS val 578191605 ecr 
2567736321], length 2752
18:57:46.809257 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 5818, win 205, options [nop,nop,TS val 2567736321 ecr 578191605], 
length 0
18:57:46.809278 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 8714, win 250, options [nop,nop,TS val 2567736321 ecr 578191605], 
length 0
18:57:46.809294 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 11610, win 269, options [nop,nop,TS val 2567736321 ecr 578191605], 
length 0
18:57:46.809311 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 14506, win 296, options [nop,nop,TS val 2567736321 ecr 578191605], 
length 0
18:57:46.809913 IP 192.168.10.254.40918 &gt; 192.168.10.1.80: Flags [.], 
ack 17258, win 323, options [nop,nop,TS val 2567736322 ecr 578191605], 
length 0
^C
32 packets captured
32 packets received by filter
0 packets dropped by kernel

Eliezer

On 20/10/2015 16:49, Squid admin wrote:
&gt;<i> Dear squid team,
</I>&gt;<i>
</I>&gt;<i> first of all thanks for developing such a great product!
</I>&gt;<i>
</I>&gt;<i> Unfortunately on uploading a big test file (unencrypted POST) to apache
</I>&gt;<i> webserver using a squid proxy (V 3.5.10 or 4.0.1) the upstream pakets
</I>&gt;<i> get slized into thousands of small 39 byte sized pakets.
</I>&gt;<i>
</I>&gt;<i> Excerpt from cache.log:
</I>&gt;<i>
</I>&gt;<i> 2015/10/20 13:51:08.201 kid1| 5,5| Write.cc(35) Write:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: sz 583:
</I>&gt;<i> asynCall 0x244b670*1
</I>&gt;<i> 2015/10/20 13:51:08.201 kid1| 5,5| Write.cc(66) HandleWrite:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: off 0, sz 583.
</I>&gt;<i> 2015/10/20 13:51:08.203 kid1| 5,5| Write.cc(35) Write:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: sz 16422:
</I>&gt;<i> asynCall 0x2447d40*1
</I>&gt;<i> 2015/10/20 13:51:08.203 kid1| 5,5| Write.cc(66) HandleWrite:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: off 0, sz 16422.
</I>&gt;<i> 2015/10/20 13:51:08.204 kid1| 5,5| Write.cc(35) Write:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: sz 39:
</I>&gt;<i> asynCall 0x2448ec0*1
</I>&gt;<i> 2015/10/20 13:51:08.205 kid1| 5,5| Write.cc(66) HandleWrite:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: off 0, sz 39.
</I>&gt;<i> 2015/10/20 13:51:08.206 kid1| 5,5| Write.cc(35) Write:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: sz 39:
</I>&gt;<i> asynCall 0x2464bb0*1
</I>&gt;<i> 2015/10/20 13:51:08.207 kid1| 5,5| Write.cc(66) HandleWrite:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: off 0, sz 39.
</I>&gt;<i> 2015/10/20 13:51:08.208 kid1| 5,5| Write.cc(35) Write:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: sz 39:
</I>&gt;<i> asynCall 0x2448ec0*1
</I>&gt;<i> 2015/10/20 13:51:08.209 kid1| 5,5| Write.cc(66) HandleWrite:
</I>&gt;<i> local=10.1.1.210:46731 remote=10.1.1.19:81 FD 17 flags=1: off 0, sz 39.
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> Attached you can find a tar file containing squid configuration,
</I>&gt;<i> test network topology, network trace from traffic from client to squid,
</I>&gt;<i> network trace from squid to webserver and a full debug log from squid
</I>&gt;<i>
</I>&gt;<i> One incoming paket of size ~ 1500 bytes gets sliced into more as 40 pakets.
</I>&gt;<i> On the target webserver the squid upstream traffic therefore looks like
</I>&gt;<i> a DOS attack.
</I>&gt;<i>
</I>&gt;<i> The problem can be reproduced using squid 3.5.x and squid 4.0.x (32bit
</I>&gt;<i> and 64bit variants)
</I>&gt;<i> The where no such problems using squid 3.2.x
</I>&gt;<i>
</I>&gt;<i> Hopefully you can help me to fix this problem as this is a showstopper
</I>&gt;<i> for me to upgrade to squid 3.5.x and higher.
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i>
</I>&gt;<i> Toni
</I>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003630.html">[squid-dev] Jenkins build is back to normal : trunk-polygraph #898
</A></li>
	<LI>Next message: <A HREF="003617.html">[squid-dev] [PATCH] %&lt;lp missing for persistent connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3616">[ date ]</a>
              <a href="thread.html#3616">[ thread ]</a>
              <a href="subject.html#3616">[ subject ]</a>
              <a href="author.html#3616">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
