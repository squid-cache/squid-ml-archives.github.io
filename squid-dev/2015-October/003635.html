<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] No reconfiguration during shutdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20No%20reconfiguration%20during%20shutdown&In-Reply-To=%3C562E4E0D.3090704%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003640.html">
   <LINK REL="Next"  HREF="003636.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] No reconfiguration during shutdown</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20No%20reconfiguration%20during%20shutdown&In-Reply-To=%3C562E4E0D.3090704%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] No reconfiguration during shutdown">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Oct 26 16:00:13 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003640.html">[squid-dev] Jenkins build is back to normal : trunk-polygraph #902
</A></li>
        <LI>Next message: <A HREF="003636.html">[squid-dev] [PATCH] No reconfiguration during shutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3635">[ date ]</a>
              <a href="thread.html#3635">[ thread ]</a>
              <a href="subject.html#3635">[ subject ]</a>
              <a href="author.html#3635">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    To avoid crashes, prohibit pointless reconfiguration during shutdown.

Also consolidated and polished signal action handling code:

1. For any executed action X, clear do_X at the beginning of action X
   code because once we start X, we should accept/queue more X
   requests (or inform the admin if we reject them).

2. Delay any action X requested during startup or reconfiguration
   because the latter two actions modify global state that X depends
   on. Inform the admin that the requested action is being delayed.

3. Cancel any action X requested during shutdown. We cannot run X
   during shutdown because shutdown modifies global state that X
   depends on, and we never come back from shutdown so there is no
   point in delaying X. Inform the admin that the requested action is
   canceled.

Repeated failed attempts to fix crashes related to various overlapping
signal actions confirm that this code is a lot trickier than it looks.
This change introduces a more systematic/comprehensive approach to
resolving associated conflicts compared to previous ad hoc attempts.

For example, there were several changes related to bug 3574 (trunk
r14354), but trunk Squid still crashes if SIGHUP is received at the
&quot;wrong&quot; time. I hope this fix will kill the remaining similar bugs or at
least make future fixes easier.

    <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3574">http://bugs.squid-cache.org/show_bug.cgi?id=3574</A>


One possible future work is to split shutdown into two states:

* scheduled (waiting for timeout to expire; may not affect some of the
  signal actions) and
* in-progress (blocks out all other actions).

Currently, the two states are merged into one in trunk code (there is
only one shutting_down global). This fix does not attempt to address
that deficiency. Factory does not plan to work on this in the
foreseeable future. Please feel free to solve this problem!


Amos, I have also attached a &quot;bag10s&quot; patch that may work better for the
v3.5 branch should you decide to apply this fix to v3.5 as well.


Thank you,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-116-no-reconfig-during-shutdown-t8.patch
Type: text/x-diff
Size: 9175 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151026/0149c28d/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151026/0149c28d/attachment.patch</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-116-no-reconfig-during-shutdown-bag10s-t8.patch
Type: text/x-diff
Size: 7438 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151026/0149c28d/attachment-0001.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20151026/0149c28d/attachment-0001.patch</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003640.html">[squid-dev] Jenkins build is back to normal : trunk-polygraph #902
</A></li>
	<LI>Next message: <A HREF="003636.html">[squid-dev] [PATCH] No reconfiguration during shutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3635">[ date ]</a>
              <a href="thread.html#3635">[ thread ]</a>
              <a href="subject.html#3635">[ subject ]</a>
              <a href="author.html#3635">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
