<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] No reconfiguration during shutdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20No%20reconfiguration%20during%20shutdown&In-Reply-To=%3C562E61E8.4050507%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003635.html">
   <LINK REL="Next"  HREF="003656.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] No reconfiguration during shutdown</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20No%20reconfiguration%20during%20shutdown&In-Reply-To=%3C562E61E8.4050507%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] No reconfiguration during shutdown">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Oct 26 17:24:56 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003635.html">[squid-dev] [PATCH] No reconfiguration during shutdown
</A></li>
        <LI>Next message: <A HREF="003656.html">[squid-dev] [PATCH] No reconfiguration during shutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3636">[ date ]</a>
              <a href="thread.html#3636">[ thread ]</a>
              <a href="subject.html#3636">[ subject ]</a>
              <a href="author.html#3636">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/10/2015 5:00 a.m., Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     To avoid crashes, prohibit pointless reconfiguration during shutdown.
</I>&gt;<i> 
</I>&gt;<i> Also consolidated and polished signal action handling code:
</I>&gt;<i> 
</I>&gt;<i> 1. For any executed action X, clear do_X at the beginning of action X
</I>&gt;<i>    code because once we start X, we should accept/queue more X
</I>&gt;<i>    requests (or inform the admin if we reject them).
</I>&gt;<i> 
</I>&gt;<i> 2. Delay any action X requested during startup or reconfiguration
</I>&gt;<i>    because the latter two actions modify global state that X depends
</I>&gt;<i>    on. Inform the admin that the requested action is being delayed.
</I>&gt;<i> 
</I>&gt;<i> 3. Cancel any action X requested during shutdown. We cannot run X
</I>&gt;<i>    during shutdown because shutdown modifies global state that X
</I>&gt;<i>    depends on, and we never come back from shutdown so there is no
</I>&gt;<i>    point in delaying X. Inform the admin that the requested action is
</I>&gt;<i>    canceled.
</I>&gt;<i> 
</I>&gt;<i> Repeated failed attempts to fix crashes related to various overlapping
</I>&gt;<i> signal actions confirm that this code is a lot trickier than it looks.
</I>&gt;<i> This change introduces a more systematic/comprehensive approach to
</I>&gt;<i> resolving associated conflicts compared to previous ad hoc attempts.
</I>&gt;<i> 
</I>&gt;<i> For example, there were several changes related to bug 3574 (trunk
</I>&gt;<i> r14354), but trunk Squid still crashes if SIGHUP is received at the
</I>&gt;<i> &quot;wrong&quot; time. I hope this fix will kill the remaining similar bugs or at
</I>&gt;<i> least make future fixes easier.
</I>&gt;<i> 
</I>&gt;<i>     <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3574">http://bugs.squid-cache.org/show_bug.cgi?id=3574</A>
</I>&gt;<i> 
</I>
+1 on this patch.

Please apply with a &quot;--fixes squid:3574&quot; and bug reference in the commit
title.


&gt;<i> 
</I>&gt;<i> One possible future work is to split shutdown into two states:
</I>&gt;<i> 
</I>&gt;<i> * scheduled (waiting for timeout to expire; may not affect some of the
</I>&gt;<i>   signal actions) and
</I>&gt;<i> * in-progress (blocks out all other actions).
</I>&gt;<i> 
</I>&gt;<i> Currently, the two states are merged into one in trunk code (there is
</I>&gt;<i> only one shutting_down global). This fix does not attempt to address
</I>&gt;<i> that deficiency. Factory does not plan to work on this in the
</I>&gt;<i> foreseeable future. Please feel free to solve this problem!
</I>

I did (re-)discover that the final cycle through SignalsEngine whe
hutdown timeout ends does indeed drain the AsyncQueue. But not wait for
any other types of pending I/O or FD events that might appear during
that drain. That is paving the way for the current swap.state read/write
crashes on shutdown.

I plan to work towards Runners doing all the shutdown handling and in
particular hooking some components into that which are currently not
paying any attention to shutdown termination (ie the swap.state and DNS
sockets FD). Once that conversion is completed we shall see what remains
that needs any async handling after timout ends.

Amos
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003635.html">[squid-dev] [PATCH] No reconfiguration during shutdown
</A></li>
	<LI>Next message: <A HREF="003656.html">[squid-dev] [PATCH] No reconfiguration during shutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3636">[ date ]</a>
              <a href="thread.html#3636">[ thread ]</a>
              <a href="subject.html#3636">[ subject ]</a>
              <a href="author.html#3636">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
