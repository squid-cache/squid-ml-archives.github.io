<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] SBuf Locker friend class
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SBuf%20Locker%20friend%20class&In-Reply-To=%3C56329242.70708%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003652.html">
   <LINK REL="Next"  HREF="003654.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] SBuf Locker friend class</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SBuf%20Locker%20friend%20class&In-Reply-To=%3C56329242.70708%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] SBuf Locker friend class">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct 29 21:40:18 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003652.html">[squid-dev] [PATCH] SBuf Locker friend class
</A></li>
        <LI>Next message: <A HREF="003654.html">[squid-dev] Build failed in Jenkins: trunk-full-matrix » clang,d-debian-unstable #33
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3653">[ date ]</a>
              <a href="thread.html#3653">[ thread ]</a>
              <a href="subject.html#3653">[ subject ]</a>
              <a href="author.html#3653">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/29/2015 01:23 PM, Amos Jeffries wrote:

&gt;<i> Adds the Locker friend class to SBuf to provide safety ref-count locks
</I>&gt;<i> when dealing with dangerous char* or SBuf&amp; inputs.
</I>
Thank you for working on this.


&gt;<i> +    Locker prevent_raw_memory_madness(this, S, n);
</I>
If you can make it constant, make it const.


&gt;<i> +            // lock if Q intersects the parents buffer area
</I>&gt;<i> +            const MemBlob *P = parent-&gt;store_.getRaw();
</I>&gt;<i> +            if ( (Q+len) &gt;= P-&gt;mem &amp;&amp; Q &lt;= (P-&gt;mem + P-&gt;capacity) )
</I>

I do not think &quot;len&quot; is important here. We are not trying to protect
ourselves against invalid pointers that start somewhere before the blob
but end inside the blob. If I am right, please remove the len argument
and simplify.

I recommend using &quot;min &lt;= x &lt;= max&quot; pattern.

Also, a Q pointing at (P-&gt;mem + P-&gt;capacity) does not belong to P!

Please avoid single-character names. They may the code more difficult to
understand, search, and refactor.

Please reserve capitalized names for Globals.

In summary, consider:

    if (blob-&gt;mem &lt;= mem &amp;&amp; mem &lt; blob-&gt;mem + blob-&gt;capacity)


However, I would actually make it an inlined MemBlob method:

    if (blob-&gt;contains(mem))


I like your refcounting Pointer trick. Much better than manual
lock/unlock work!


&gt;<i> I have gone through and added it to all the non-const methods that
</I>&gt;<i> appear to be taking char* directly, or using a char* taken from SBuf&amp;.
</I>&gt;<i> That review added the appendf/printf methods to the set we identified on
</I>&gt;<i> IRC.
</I>
What about SBuf::scanf()? Unlikely, but, the format parameter might be
pointing to the same blob that gets deleted when we call c_str()...



&gt;<i>  SBuf &amp;
</I>&gt;<i>  SBuf::append(const char * S, size_type Ssize)
</I>&gt;<i>  {
</I>&gt;<i>      if (S == NULL)
</I>&gt;<i>          return *this;
</I>&gt;<i>      if (Ssize == SBuf::npos)
</I>&gt;<i>          Ssize = strlen(S);
</I>&gt;<i>      debugs(24, 7, &quot;from c-string to id &quot; &lt;&lt; id);
</I>&gt;<i> +    Locker prevent_raw_memory_madness(this, S, Ssize);
</I>
and

&gt;<i> SBuf::vappendf(const char *fmt, va_list vargs)
</I>&gt;<i>  {
</I>&gt;<i>      Must(fmt != NULL);
</I>&gt;<i>      int sz = 0;
</I>&gt;<i>      //reserve twice the format-string size, it's a likely heuristic
</I>&gt;<i>      size_type requiredSpaceEstimate = strlen(fmt)*2;
</I>&gt;<i>  
</I>&gt;<i> +    // with appendf() an arg might be a dangerous char*
</I>&gt;<i> +    Locker prevent_raw_memory_madness(this, buf(), length());
</I>&gt;<i> +
</I>
If possible, let's always start dangerous methods with allocating a
Locker object. This clarifies the lock scope and minimizes the chance
that somebody adds dangerous code _above_ the lock.


&gt;<i> +    // with printf() an arg might be a dangerous char*
</I>
&gt;<i> +    // with appendf() an arg might be a dangerous char*
</I>

s/an arg/fmt or arg/ or s/an arg/any parameter/

That is, the &quot;fmt&quot; parameter itself is not excluded from danger.


&gt;<i> IMO the trim() method mentioned on IRC does not need it since the scope
</I>&gt;<i> lifetime of the pointer taken by toRemove.buf() does not cross any
</I>&gt;<i> alterations of the this objects members.
</I>
Agreed.


I also suggest renaming &quot;prevent_raw_memory_madness&quot; to &quot;blobKeeper&quot; to
clarify and for consistency with other camelCase names.



&gt;<i> I've not added documentation for the Locker class. Alex could you
</I>&gt;<i> provide a blurb to describe the memory issue and requirements this solves ?
</I>

How about something like the following?

/// Keeps SBuf's MemBlob alive in a blob-destroying context where
/// a seemingly unrelated memory pointer may belong to the same blob.
/// For [an extreme] example, consider: a.append(a).
/// Compared to an SBuf temporary, this class is optimized to
/// preserve blobs only if needed and to reduce debugging noise.
class Locker ...


HTH,

Alex.

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003652.html">[squid-dev] [PATCH] SBuf Locker friend class
</A></li>
	<LI>Next message: <A HREF="003654.html">[squid-dev] Build failed in Jenkins: trunk-full-matrix » clang,d-debian-unstable #33
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3653">[ date ]</a>
              <a href="thread.html#3653">[ thread ]</a>
              <a href="subject.html#3653">[ subject ]</a>
              <a href="author.html#3653">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
