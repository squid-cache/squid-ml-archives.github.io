<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F31179.7050101%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003335.html">
   <LINK REL="Next"  HREF="003343.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F31179.7050101%40opendium.com%3E"
       TITLE="[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice">steve at opendium.com
       </A><BR>
    <I>Fri Sep 11 17:38:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003335.html">[squid-dev] default SSL client and server methods
</A></li>
        <LI>Next message: <A HREF="003343.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3340">[ date ]</a>
              <a href="thread.html#3340">[ thread ]</a>
              <a href="subject.html#3340">[ subject ]</a>
              <a href="author.html#3340">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I'm currently using Bump-Server-First, but I'm fiddling with 
Bump/Peek/Splice and have uncovered some compatibility problems with the 
way I'm currently doing things, so I'm hoping for some advice:


To enforce Google's Safe Search, Google recommends setting up a CNAME in 
the local DNS server to redirect requests for www.google.com to 
forcesafesearch.google.com.  A DNS change like that would apply to the 
whole network and I want to only apply it to certain users, so I'm doing 
this a slightly different way: The &quot;CONNECT www.google.com&quot; request gets 
sent to an ICAP REQMOD method, which rewrites it to &quot;CONNECT 
forcesafesearch.google.com&quot;, causing Squid to connect to the appropriate 
IP address.  The rest of the request behaves as though the connection 
was to www.google.com - i.e. the HTTP requests within the bumped 
connection appear as <A HREF="https://www.google.com/...">https://www.google.com/...</A> etc.

With Bump-Server-First, this works ok - the CN and SANs are copied from 
Google's original certificate into the forged cert, so as far as the 
browser is concerned the certificate is valid for www.google.com. 
However, with the new Bump functionality, the CN of the forged 
certificate appears to come from the (rewritten) CONNECT request, so the 
browser sees a CN of forcesafesearch.google.com.

Is there a better way of doing what I'm doing?

What is the reasoning behind the change to using the name from the 
CONNECT string, rather than copying it from the server's certificate, or 
have I misconfigured something?  Notably, some applications CONNECT to 
the IP address rather than the server's host name, but would still 
expect the certificate's CN to be the server's hostname.


A related second question is that obviously when transparently proxying 
traffic, the host name isn't available in the CONNECT request, so the 
above rewrite method doesn't work anyway.  I'm using an external ACL at 
Bump Step 2 to look at the SNI that's obtained from the client handshake 
and decide whether to bump - is there any way for the external ACL to 
change the IP address that Squid will connect to, to replicate the 
rewrite above?


Also, I've noticed that the &quot;%un&quot; external ACL format code is never 
being filled with the user name when calling an external ACL during bump 
step 2, even though the request has been authenticated.


Any advice gratefully received, looks like I'm spending next week 
working through these issues. :)

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>
    Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>
    Phone:            sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: steve.vcf
Type: text/x-vcard
Size: 283 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150911/408537dc/attachment.vcf">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150911/408537dc/attachment.vcf</A>&gt;
</PRE>








































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003335.html">[squid-dev] default SSL client and server methods
</A></li>
	<LI>Next message: <A HREF="003343.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3340">[ date ]</a>
              <a href="thread.html#3340">[ thread ]</a>
              <a href="subject.html#3340">[ subject ]</a>
              <a href="author.html#3340">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
