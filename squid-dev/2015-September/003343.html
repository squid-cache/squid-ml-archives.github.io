<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F33D9E.9060109%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003340.html">
   <LINK REL="Next"  HREF="003346.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F33D9E.9060109%40measurement-factory.com%3E"
       TITLE="[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep 11 20:46:22 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003340.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
        <LI>Next message: <A HREF="003346.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3343">[ date ]</a>
              <a href="thread.html#3343">[ thread ]</a>
              <a href="subject.html#3343">[ subject ]</a>
              <a href="author.html#3343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/11/2015 11:38 AM, Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> I'm currently using Bump-Server-First, but I'm fiddling with
</I>&gt;<i> Bump/Peek/Splice and have uncovered some compatibility problems with the
</I>&gt;<i> way I'm currently doing things, so I'm hoping for some advice:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> To enforce Google's Safe Search, Google recommends setting up a CNAME in
</I>&gt;<i> the local DNS server to redirect requests for www.google.com to
</I>&gt;<i> forcesafesearch.google.com.
</I>
It may important that Google wants you to modify the IP address of
www.google.com, not the domain name itself. CNAME is there for DNS
administration convenience, but from HTTP/SSL/browser point of view, the
connection is still to something named www.google.com.

What you are doing with CONNECT rewrite is different (even if it works
or used to work).


&gt;<i> A DNS change like that would apply to the
</I>&gt;<i> whole network and I want to only apply it to certain users, so I'm doing
</I>&gt;<i> this a slightly different way: The &quot;CONNECT www.google.com&quot; request gets
</I>&gt;<i> sent to an ICAP REQMOD method, which rewrites it to &quot;CONNECT
</I>&gt;<i> forcesafesearch.google.com&quot;, causing Squid to connect to the appropriate
</I>&gt;<i> IP address.  The rest of the request behaves as though the connection
</I>&gt;<i> was to www.google.com - i.e. the HTTP requests within the bumped
</I>&gt;<i> connection appear as <A HREF="https://www.google.com/...">https://www.google.com/...</A> etc.
</I>&gt;<i> 
</I>&gt;<i> With Bump-Server-First, this works ok - the CN and SANs are copied from
</I>&gt;<i> Google's original certificate into the forged cert, so as far as the
</I>&gt;<i> browser is concerned the certificate is valid for www.google.com.
</I>
I suspect this works because the [old] server-first bumping code does
not send [correct] SNI to Google. You should be able to confirm or deny
that by studying SSL packets. SNI and server certificate are a part of
unencrypted handshake so it is easy to look at what Squid receives and
sends.

Note that things may change. See, for example, Squid bug 4293 which
required us to fix SNI to match the rewritten domain name. I do not know
whether that fix affects the [old] server-first bumping code and your
use case.


&gt;<i> However, with the new Bump functionality, the CN of the forged
</I>&gt;<i> certificate appears to come from the (rewritten) CONNECT request
</I>
At least two very different scenarios would result in the forged
certificate having forcesafesearch.google.com CN:

1. Squid receives www.google.com CN from Google, but uses
forcesafesearch.google.com CN in the forged certificate. This is what
you think is happening.

2. Squid receives forcesafesearch.google.com CN from Google and uses it
in the fake certificate. This is what I suspect may be happening.

Again, you can easily check this by looking at the Squid-Google SSL
handshake with wireshark or some such.


&gt;<i> Is there a better way of doing what I'm doing?
</I>
I think so, but it requires some development. Instead of rewriting
CONNECT requests in ways that Google does not want you to do, I would do
what Google suggests -- rewrite the IP address. Specifically, I would
allow the eCAP/ICAP adapter to leave the CONNECT request &quot;as is&quot; but
tell Squid what IP address to use when satisfying that request, as if
that IP came from a DNS server when resolving the CONNECT host name.

With this solution, no SslBump would be required at all!

A high-quality implementation would have to address things like DNS
caching, IPv6, and cache_peers, but I think it would be a generally
useful feature.


&gt;<i> What is the reasoning behind the change to using the name from the
</I>&gt;<i> CONNECT string, rather than copying it from the server's certificate, or
</I>&gt;<i> have I misconfigured something?
</I>
The reason to use a CONNECT name would be to match browser expectations
(the code may not realize that it is looking at the rewritten CONNECT).
I know we do that in recent code when serving Squid errors. However,
let's revisit this question after you confirm that #2 is not happening.


&gt;<i> A related second question is that obviously when transparently proxying
</I>&gt;<i> traffic, the host name isn't available in the CONNECT request, so the
</I>&gt;<i> above rewrite method doesn't work anyway.  I'm using an external ACL at
</I>&gt;<i> Bump Step 2 to look at the SNI that's obtained from the client handshake
</I>&gt;<i> and decide whether to bump - is there any way for the external ACL to
</I>&gt;<i> change the IP address that Squid will connect to, to replicate the
</I>&gt;<i> rewrite above?
</I>
I do not think so, but this functionality can be added. It is very
similar to the eCAP/ICAP solution I proposed above (before I read your
suggestion here), and it would use the same existing transaction
metadata mechanism with the external ACL. Alternatively, you can
continue to use eCAP/ICAP for transparent connections -- they generate
fake CONNECT requests that are sent to adaptation services...


&gt;<i> Also, I've noticed that the &quot;%un&quot; external ACL format code is never
</I>&gt;<i> being filled with the user name when calling an external ACL during bump
</I>&gt;<i> step 2, even though the request has been authenticated.
</I>
If the TCP connection has been authenticated, then this is a bug and you
should file a bug report.

If you are talking about HTTP authentication methods that authenticate
individual transactions and not whole connections (e.g., Basic), then
there is no HTTP at SslBump step #2 yet.


&gt;<i> Any advice gratefully received, looks like I'm spending next week
</I>&gt;<i> working through these issues. :)
</I>
You may get more advice on the squid-users list, where there are
probably more folks facing similar problems.


HTH,

Alex.

</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003340.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
	<LI>Next message: <A HREF="003346.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3343">[ date ]</a>
              <a href="thread.html#3343">[ thread ]</a>
              <a href="subject.html#3343">[ subject ]</a>
              <a href="author.html#3343">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
