<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F3ECAC.9000102%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003343.html">
   <LINK REL="Next"  HREF="003349.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F3ECAC.9000102%40opendium.com%3E"
       TITLE="[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice">steve at opendium.com
       </A><BR>
    <I>Sat Sep 12 09:13:16 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003343.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
        <LI>Next message: <A HREF="003349.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3346">[ date ]</a>
              <a href="thread.html#3346">[ thread ]</a>
              <a href="subject.html#3346">[ subject ]</a>
              <a href="author.html#3346">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/09/15 21:46, Alex Rousskov wrote:

&gt;<i> At least two very different scenarios would result in the forged
</I>&gt;<i> certificate having forcesafesearch.google.com CN:
</I>&gt;<i> 
</I>&gt;<i> 1. Squid receives www.google.com CN from Google, but uses
</I>&gt;<i> forcesafesearch.google.com CN in the forged certificate. This is what
</I>&gt;<i> you think is happening.
</I>&gt;<i> 
</I>&gt;<i> 2. Squid receives forcesafesearch.google.com CN from Google and uses it
</I>&gt;<i> in the fake certificate. This is what I suspect may be happening.
</I>
I will need to test this more thoroughly, but I was testing using
proxytunnel (to set up the CONNECT) and openssl (to do the actual ssl
bit) and found that the CN was always identical to the contents of the
CONNECT, even if the CONNECT was to an IP address rather than a host name.

I'll do some more testing next week and report back - I'm pretty sure
that using an IP address in the CN is going to break things, so either I
have a problem with my config or there's a problem with the new bump
code (notably, just switching back to server-first without changing the
squid version restores the old behaviour).

&gt;<i> I think so, but it requires some development. Instead of rewriting
</I>&gt;<i> CONNECT requests in ways that Google does not want you to do, I would do
</I>&gt;<i> what Google suggests -- rewrite the IP address. Specifically, I would
</I>&gt;<i> allow the eCAP/ICAP adapter to leave the CONNECT request &quot;as is&quot; but
</I>&gt;<i> tell Squid what IP address to use when satisfying that request, as if
</I>&gt;<i> that IP came from a DNS server when resolving the CONNECT host name.
</I>
I thought the same, but wasn't entirely sure if there was an existing
method of doing that before I started doing development. :)

&gt;<i> With this solution, no SslBump would be required at all!
</I>
Yep, and that would certainly be a good option, although I bump google
searches for other reasons (content examination) most of the time anyway.

&gt;<i> Alternatively, you can
</I>&gt;<i> continue to use eCAP/ICAP for transparent connections -- they generate
</I>&gt;<i> fake CONNECT requests that are sent to adaptation services...
</I>
The CONNECT requests for transparent connections only contain the IP
address at the moment, since they happen before any of the bump steps.
A nice solution would be to call an ICAP REQMOD hook for each SSL bump
step (with each ICAP request including the extra data that has been
discovered in that step).  But that would be a lot of work. :)

&gt;&gt;<i> Also, I've noticed that the &quot;%un&quot; external ACL format code is never
</I>&gt;&gt;<i> being filled with the user name when calling an external ACL during bump
</I>&gt;&gt;<i> step 2, even though the request has been authenticated.
</I>&gt;<i> 
</I>&gt;<i> If the TCP connection has been authenticated, then this is a bug and you
</I>&gt;<i> should file a bug report.
</I>&gt;<i>
</I>&gt;<i> If you are talking about HTTP authentication methods that authenticate
</I>&gt;<i> individual transactions and not whole connections (e.g., Basic), then
</I>&gt;<i> there is no HTTP at SslBump step #2 yet.
</I>
I am talking about Basic, but I don't understand why this wouldn't be
authenticated by step 2, the various stages of a Basic authenticated
connection should be:

1. Client sends &quot;CONNECT example.com&quot;
2. http_access ACL is checked and returns &quot;proxy_auth&quot;
3. Proxy replies with a 407
4. Client sends &quot;CONNECT example.com&quot; with authentication credentials
5. Proxy replies with &quot;HTTP/1.1 200 Connection established&quot;
6. Client sends SSL handshake.
7. Bump step 1 ACL is checked and returns &quot;peek&quot;
8. Proxy examines client's SSL handshake and retrieves SNI
9. Bump step 2 ACL is checked and returns &quot;splice&quot;
10. Proxy connects to server, forwards the client handshake and splices
the Client&lt;-&gt;Proxy connection to the Proxy&lt;-&gt;Server connection.

So by the time we reach (9), we've already got the credentials.  Have I
misunderstood?


The relevant parts of the config are:

http_access allow proxy_auth
http_access deny all
external_acl_type sslpeek children-max=10 concurrency=100 ttl=0
negative_ttl=0 %SRC %un %URI %ssl::&gt;sni %&gt;ha{User-Agent}
/usr/sbin/check_bump.sh
acl sslpeek external sslpeek
acl ssl_bump_step_1 at_step SslBump1
acl ssl_bump_step_2 at_step SslBump2
acl ssl_bump_step_3 at_step SslBump3
ssl_bump peek ssl_bump_step_1
ssl_bump bump ssl_bump_step_2 sslpeek
ssl_bump splice all
sslproxy_cert_error allow all


The debug log shows that the request is successfully authenticated:

Acl.cc(138) matches: checking proxy_auth
UserData.cc(22) match: user is steve, case_insensitive is 0
UserData.cc(28) match: aclMatchUser: user REQUIRED and auth-info present.
Acl.cc(340) cacheMatchAcl: ACL::cacheMatchAcl: miss for 'proxy_auth'.
Adding result 1
Acl.cc(158) matches: checked: proxy_auth = 1

But then later in the log I see:

external_acl.cc(1416) Start: fg lookup in 'sslpeek' for
'2a00:1940:1:8:468a:5bff:fe9a:cd7f - www.hsbc.co.uk:443 www.hsbc.co.uk
Mozilla/5.0%20(X11;%20Fedora;%20Linux%20x86_64;%20rv:39.0)%20Gecko/20100101%20Firefox/39.0'


(the user name is shown as &quot;-&quot; rather than being filled in).

Setting a-&gt;require_auth in parse_externalAclHelper() makes it work, but
obviously just makes %un behave like %LOGIN (requires auth, rather than
just being filled in if it is present), so isn't a solution.


&gt;&gt;<i> Any advice gratefully received, looks like I'm spending next week
</I>&gt;&gt;<i> working through these issues. :)
</I>&gt;<i> 
</I>&gt;<i> You may get more advice on the squid-users list, where there are
</I>&gt;<i> probably more folks facing similar problems.
</I>
I had posted about the %un issue on squid-users the previous week but
had no reply - I figured that the new bump functionality is probably not
yet being used widely enough for many outside the development folks to
be playing with it.

Many thanks for the reply.

-- 

 - Steve Hill
   Technical Director
   Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
   Instant messager: xmpp:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>
   Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>
   Phone:            sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>

Sales / enquiries contacts:
   Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>
   Phone:            +44-1792-825748 / sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>

Support contacts:
   Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
   Phone:            +44-1792-824568 / sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003343.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
	<LI>Next message: <A HREF="003349.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3346">[ date ]</a>
              <a href="thread.html#3346">[ thread ]</a>
              <a href="subject.html#3346">[ subject ]</a>
              <a href="author.html#3346">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
