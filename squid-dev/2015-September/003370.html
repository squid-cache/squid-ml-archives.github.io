<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F70D51.5060604%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003397.html">
   <LINK REL="Next"  HREF="003351.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Moving%20from%20Bump-Server-First%20to%20Bump/Peek/Splice&In-Reply-To=%3C55F70D51.5060604%40measurement-factory.com%3E"
       TITLE="[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Sep 14 18:09:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003397.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
        <LI>Next message: <A HREF="003351.html">[squid-dev] Build failed in Jenkins: trunk-matrix » clang,d-centos-7 #347
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3370">[ date ]</a>
              <a href="thread.html#3370">[ thread ]</a>
              <a href="subject.html#3370">[ subject ]</a>
              <a href="author.html#3370">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/12/2015 03:13 AM, Steve Hill wrote:
&gt;<i> On 11/09/15 21:46, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> At least two very different scenarios would result in the forged
</I>&gt;&gt;<i> certificate having forcesafesearch.google.com CN:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Squid receives www.google.com CN from Google, but uses
</I>&gt;&gt;<i> forcesafesearch.google.com CN in the forged certificate. This is what
</I>&gt;&gt;<i> you think is happening.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Squid receives forcesafesearch.google.com CN from Google and uses it
</I>&gt;&gt;<i> in the fake certificate. This is what I suspect may be happening.
</I>&gt;<i> 
</I>&gt;<i> I will need to test this more thoroughly, but I was testing using
</I>&gt;<i> proxytunnel (to set up the CONNECT) and openssl (to do the actual ssl
</I>&gt;<i> bit) and found that the CN was always identical to the contents of the
</I>&gt;<i> CONNECT, even if the CONNECT was to an IP address rather than a host name.
</I>&gt;<i> 
</I>&gt;<i> I'll do some more testing next week and report back - I'm pretty sure
</I>&gt;<i> that using an IP address in the CN is going to break things, so either I
</I>&gt;<i> have a problem with my config or there's a problem with the new bump
</I>&gt;<i> code (notably, just switching back to server-first without changing the
</I>&gt;<i> squid version restores the old behaviour).
</I>
If you think the bumping code is buggy, consider filing a bug report
with Bugzilla to increase the chance that the bug is noticed and fixed.
If you can, please mention in your report whether recent trunk code works.


&gt;&gt;<i> Alternatively, you can
</I>&gt;&gt;<i> continue to use eCAP/ICAP for transparent connections -- they generate
</I>&gt;&gt;<i> fake CONNECT requests that are sent to adaptation services...
</I>&gt;<i> 
</I>&gt;<i> The CONNECT requests for transparent connections only contain the IP
</I>&gt;<i> address at the moment, since they happen before any of the bump steps.
</I>
When dealing with certain connections, Squid trunk sends _two_ fake
CONNECT requests for adaptation, including the second CONNECT request
during SslBump step #2. Since trunk r14293, that second fake CONNECT
request includes SNI information. Sorry, I do not know the exact
criteria when Squid sends two fake CONNECT requests instead of one.


&gt;&gt;&gt;<i> Also, I've noticed that the &quot;%un&quot; external ACL format code is never
</I>&gt;&gt;&gt;<i> being filled with the user name when calling an external ACL during bump
</I>&gt;&gt;&gt;<i> step 2, even though the request has been authenticated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If the TCP connection has been authenticated, then this is a bug and you
</I>&gt;&gt;<i> should file a bug report.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are talking about HTTP authentication methods that authenticate
</I>&gt;&gt;<i> individual transactions and not whole connections (e.g., Basic), then
</I>&gt;&gt;<i> there is no HTTP at SslBump step #2 yet.
</I>&gt;<i> 
</I>&gt;<i> I am talking about Basic, but I don't understand why this wouldn't be
</I>&gt;<i> authenticated by step 2, the various stages of a Basic authenticated
</I>&gt;<i> connection should be:
</I>&gt;<i> 
</I>&gt;<i> 1. Client sends &quot;CONNECT example.com&quot;
</I>
You are right, I forgot that the proxy authentication information is
inside CONNECT, not inside the first encrypted/tunnelled request. I
agree that the authentication information should be there, even during
bumping step #1. Please see above regarding bugs.


Alex.

</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003397.html">[squid-dev] Moving from Bump-Server-First to Bump/Peek/Splice
</A></li>
	<LI>Next message: <A HREF="003351.html">[squid-dev] Build failed in Jenkins: trunk-matrix » clang,d-centos-7 #347
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3370">[ date ]</a>
              <a href="thread.html#3370">[ thread ]</a>
              <a href="subject.html#3370">[ subject ]</a>
              <a href="author.html#3370">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
