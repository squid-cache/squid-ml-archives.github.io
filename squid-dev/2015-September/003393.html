<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] keep track of the size of uploads done with CONNECT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20keep%20track%20of%20the%20size%20of%20uploads%20done%20with%0A%20CONNECT&In-Reply-To=%3C55F7434C.50404%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003389.html">
   <LINK REL="Next"  HREF="003398.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] keep track of the size of uploads done with CONNECT</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20keep%20track%20of%20the%20size%20of%20uploads%20done%20with%0A%20CONNECT&In-Reply-To=%3C55F7434C.50404%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] keep track of the size of uploads done with CONNECT">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Sep 14 21:59:40 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003389.html">[squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT
</A></li>
        <LI>Next message: <A HREF="003398.html">[squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3393">[ date ]</a>
              <a href="thread.html#3393">[ thread ]</a>
              <a href="subject.html#3393">[ subject ]</a>
              <a href="author.html#3393">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/14/2015 02:22 PM, Aymeric Vincent wrote:
&gt;<i> Alex Rousskov &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; writes:
</I>&gt;&gt;<i> You are adding a new ClientHttpRequest in_size field dedicated to
</I>&gt;&gt;<i> client-sent &quot;payload&quot; sizes in tunnels, but Squid seems to be using
</I>&gt;&gt;<i> AccessLogEntry's http.clientRequestSz.payloadData for similar purposes
</I>&gt;&gt;<i> in non-tunnel areas of the code. Would it be possible to teach tunnel.cc
</I>&gt;&gt;<i> code to update http.clientRequestSz.payloadData (directly or indirectly)
</I>&gt;&gt;<i> instead of adding a new field?
</I>

&gt;<i> Here is a quick patch doing what you suggest. However:
</I>&gt;<i> 
</I>&gt;<i> - it doesn't match what happens in client_side.cc where log data gets
</I>&gt;<i>   filled in after the fact (see most notably req_sz field) but this may
</I>&gt;<i>   need fixing too after all
</I>
I agree that the after-the-fact setting vs. runtime updates difference
is unfortunate. The suggestions below eliminate that difference (but
since many AccessLogEntry (ALE) fields are set and updated throughout
the transaction lifetime so we were not setting a new bad precedent here).

Overall, take2 is slightly better, but the _pointer_ cast is indeed ugly
(not to mention the need to maintain these pointers). I would recommend
the following changes:

1a. Since you are polishing tunnelStart() profile anyway, delete the
status_ptr parameter as well. AFAICT, that parameter is as unneeded as
the size_ptr parameter you have already deleted. Use al-&gt;http.code
inside tunnelStart() instead. This will leave you with two parameters:
ClientHttpRequest and AccessLogEntry pointers.

1b. Use (1a) logic above to delete the AccessLogEntry::Pointer parameter
as well. Initialize TunnelStateData::al with http-&gt;al.

2. Convert TunnelStateData::Connection::size_ptr into an &quot;uint64_t
bytesSent&quot; or a similar data member (not a pointer). It will still be
updated by TunnelStateData::Connection::dataSent().

3. In TunnelStateData destructor, update ALE &quot;al&quot; as needed, using
client.bytesSent and server.bytesSent values. Test that you have guessed
which one is which correctly -- they are confusing.


&gt;<i> - it currently requires a cast because tunnelStart() expects (signed)
</I>&gt;<i>   int64_t's whereas payloadData is (unsigned) uint64_t, and switching to
</I>&gt;<i>   uint64_t everywhere requires an audit because out.size gets compared
</I>&gt;<i>   to some other signed quantity (expectedLength) in at least one place.
</I>&gt;<i>   This pulls strings in many places where int64_t's are used for size
</I>&gt;<i>   quantities.
</I>&gt;<i> 
</I>&gt;<i>   The cast is harmless because this integer gets only added to, but it's
</I>&gt;<i>   still a cast
</I>&gt;<i> 
</I>&gt;<i> If you are not satisfied with any of the two patches, please tell me
</I>&gt;<i> which direction you prefer and I can work on a more extensive patch
</I>&gt;<i> tomorrow. IMHO the advantage of the first patch is its blending with the
</I>&gt;<i> current code, while other nicer solutions will require changing a few
</I>&gt;<i> types here and there, which could be done as a second, wider, cleaning
</I>&gt;<i> step.
</I>
The problem with the first take is that it adds a data field that is
dedicated to the tunnel code but does not live in the tunnel class. It
moves an already ugly code a tiny step in the same wrong direction by
adding yet another hard-to-track ClientHttpRequest:TunnelStateData
dependency. ALE is supposed to hold statistics for logging. It is
guaranteed to exist. The tunnel code should just update it.

Your patch, even after a few takes, will not solve all the upload size
logging problems, of course, but I think that encapsulating tunnel
upload size accounting code in tunnel.cc is the right step. Eventually,
similar changes may be done to the non-tunneling code, completely
removing upload size updates from prepareLogWithRequestDetails().


Thank you,

Alex.

</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003389.html">[squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT
</A></li>
	<LI>Next message: <A HREF="003398.html">[squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3393">[ date ]</a>
              <a href="thread.html#3393">[ thread ]</a>
              <a href="subject.html#3393">[ subject ]</a>
              <a href="author.html#3393">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
