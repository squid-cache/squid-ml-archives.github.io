<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20keep%20track%20of%20the%20size%20of%20uploads%20done%20with%0A%09CONNECT&In-Reply-To=%3C87pp1jmqgg.fsf%40free.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003393.html">
   <LINK REL="Next"  HREF="003431.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT</H1>
    <B>Aymeric Vincent</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20keep%20track%20of%20the%20size%20of%20uploads%20done%20with%0A%09CONNECT&In-Reply-To=%3C87pp1jmqgg.fsf%40free.fr%3E"
       TITLE="[squid-dev] [PATCH] keep track of the size of uploads done with	CONNECT">aymericvincent at free.fr
       </A><BR>
    <I>Tue Sep 15 19:29:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003393.html">[squid-dev] [PATCH] keep track of the size of uploads done with CONNECT
</A></li>
        <LI>Next message: <A HREF="003431.html">[squid-dev] [PATCH] keep track of the size of uploads done with CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3398">[ date ]</a>
              <a href="thread.html#3398">[ thread ]</a>
              <a href="subject.html#3398">[ subject ]</a>
              <a href="author.html#3398">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi,

thank you for your detailed explanations.

Alex Rousskov &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; writes:

&gt;<i> 1a. Since you are polishing tunnelStart() profile anyway, delete the
</I>&gt;<i> status_ptr parameter as well. AFAICT, that parameter is as unneeded as
</I>&gt;<i> the size_ptr parameter you have already deleted. Use al-&gt;http.code
</I>&gt;<i> inside tunnelStart() instead. This will leave you with two parameters:
</I>&gt;<i> ClientHttpRequest and AccessLogEntry pointers.
</I>&gt;<i>
</I>&gt;<i> 1b. Use (1a) logic above to delete the AccessLogEntry::Pointer parameter
</I>&gt;<i> as well. Initialize TunnelStateData::al with http-&gt;al.
</I>&gt;<i>
</I>&gt;<i> 2. Convert TunnelStateData::Connection::size_ptr into an &quot;uint64_t
</I>&gt;<i> bytesSent&quot; or a similar data member (not a pointer). It will still be
</I>&gt;<i> updated by TunnelStateData::Connection::dataSent().
</I>&gt;<i>
</I>&gt;<i> 3. In TunnelStateData destructor, update ALE &quot;al&quot; as needed, using
</I>&gt;<i> client.bytesSent and server.bytesSent values. Test that you have guessed
</I>&gt;<i> which one is which correctly -- they are confusing.
</I>
so I implemented your proposal, except for (2) and (3) because
TunnelStateData::Connection::size_ptr, I think, should remain for the
time being. I tried to remove it but switchToTunnel() is using it to
point to some (other, it seems) http's out.size field due probably to
the nesting of connections in the ssl bump case. There are other xxx_ptr
fields in TSD which serve this nesting purpose as well IIUC.

This means I had to sprinkle a minimal amount of s/int64_t/uint64_t/
changes to remove the ugly pointer cast in tunnelStart() but they are a
step in the right direction if I'm not mistaken.

&gt;<i> Your patch, even after a few takes, will not solve all the upload size
</I>&gt;<i> logging problems, of course, but I think that encapsulating tunnel
</I>&gt;<i> upload size accounting code in tunnel.cc is the right step.
</I>
Fully agreed.

Best regards,
 Aymeric

-------------- next part --------------
A non-text attachment was scrubbed...
Name: diff-squid-account-connect-uploads-take-3
Type: application/octet-stream
Size: 4829 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150915/86755dcc/attachment.obj">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150915/86755dcc/attachment.obj</A>&gt;
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003393.html">[squid-dev] [PATCH] keep track of the size of uploads done with CONNECT
</A></li>
	<LI>Next message: <A HREF="003431.html">[squid-dev] [PATCH] keep track of the size of uploads done with CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3398">[ date ]</a>
              <a href="thread.html#3398">[ thread ]</a>
              <a href="subject.html#3398">[ subject ]</a>
              <a href="author.html#3398">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
