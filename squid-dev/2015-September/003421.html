<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Do not update gperf-generated files through make
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20update%20gperf-generated%20files%20through%0A%20make&In-Reply-To=%3C560036EA.1090809%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003420.html">
   <LINK REL="Next"  HREF="003422.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Do not update gperf-generated files through make</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20update%20gperf-generated%20files%20through%0A%20make&In-Reply-To=%3C560036EA.1090809%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Do not update gperf-generated files through make">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 21 16:57:14 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003420.html">[squid-dev] [PATCH] Do not update gperf-generated files through make
</A></li>
        <LI>Next message: <A HREF="003422.html">[squid-dev] [PATCH] Do not update gperf-generated files through make
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3421">[ date ]</a>
              <a href="thread.html#3421">[ thread ]</a>
              <a href="subject.html#3421">[ subject ]</a>
              <a href="author.html#3421">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/09/2015 4:40 a.m., Alex Rousskov wrote:
&gt;<i> On 09/21/2015 10:24 AM, Kinkie wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>    since we include the gperf-generated files in the source
</I>&gt;&gt;<i> distribution, it doesn't really make sense to build them through Make
</I>&gt;&gt;<i> - depending on the relative timestamps of the .cci and .gperf files at
</I>&gt;&gt;<i> checkout, some systems may decide to rebuild the .cci file.
</I>&gt;&gt;<i> The side effect of such a rebuild are a greatly lengthened build time
</I>&gt;&gt;<i> - if we want to have a perfect hash we need to try many hash functions
</I>&gt;&gt;<i> - for no benefit at all.
</I>&gt;&gt;<i> This also highlighted a gmake-ism in the Makefile.am which recently
</I>&gt;&gt;<i> caused some failed builds on FreeBSD 9.3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The attached patch removes the Makefile.am dependency of the .cci
</I>&gt;&gt;<i> file, and replaces it with a comment in the .gperf file; we want to
</I>&gt;&gt;<i> rerun gperf only when touching the .gperf file and that's expected to
</I>&gt;&gt;<i> be a very rare event.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I agree that the default Squid build should not rely on gperf presence
</I>&gt;<i> or depend on RegisteredHeadersHash.cci timestamp.
</I>&gt;<i> 
</I>&gt;<i> It would be better to have a dedicated make target (unused by &quot;make
</I>&gt;<i> all&quot;) that would rebuild all gperf-related file(s), but if that is
</I>&gt;<i> difficult to add, we can live with a comment IMHO. If we go the comment
</I>&gt;<i> route, I recommend leaving commented-out rules in the Makefile and s/to
</I>&gt;<i> regenerate:/to generate RegisteredHeadersHash.cci:/ in
</I>&gt;<i> RegisteredHeadersHash.gperf.
</I>&gt;<i> 
</I>
The only difficult part would be making it work recursively from the top
level Makefile. But that is probably not necessary.

I've not tested it, but the attached should do what we want. With the
maintenance infrastructure rebuilding the .cci IFF it needs to be, or
manual makes, but no other builds doing so.

Amos

-------------- next part --------------
=== modified file 'scripts/source-maintenance.sh'
--- scripts/source-maintenance.sh	2015-08-04 05:32:35 +0000
+++ scripts/source-maintenance.sh	2015-09-21 16:49:54 +0000
@@ -260,27 +260,31 @@
 for f in `ls -1 ${ROOT}/doc/manuals/*.po | sort -u`
 do
 	echo &quot; \\&quot;
 	echo -n &quot;    ${f}&quot;
 done
 echo &quot; &quot;
 )| sed s%${ROOT}/doc/manuals/%%g | sed s%\.po%\.lang%g &gt;${ROOT}/doc/manuals/language.list
 
 # Build STUB framework include from current stub_* available
 (
 sed -e 's%\ \*%##%' -e 's%/\*%##%' -e 's%##/%##%' &lt;scripts/boilerplate.h
 echo -n &quot;STUB_SOURCE= tests/STUB.h&quot;
 for f in `ls -1 ${ROOT}/src/tests/stub_*.cc | sort -u`
 do
 	echo &quot; \\&quot;
 	echo -n &quot;	${f}&quot;
 done
 echo &quot; &quot;
 )| sed s%${ROOT}/src/%%g &gt;${ROOT}/src/tests/Stub.list
 
+# Build the GPERF generated content
+cd ${ROOT}/src/http &amp;&amp; make gperf-files
+cd ${ROOT}
+
 # Run formating
 echo &quot;&quot; &gt;${ROOT}/doc/debug-sections.tmp
 srcformat || exit 1
 sort -u &lt;${ROOT}/doc/debug-sections.tmp | sort -n &gt;${ROOT}/doc/debug-sections.tmp2
 cat scripts/boilerplate.h ${ROOT}/doc/debug-sections.tmp2 &gt;${ROOT}/doc/debug-sections.txt
 rm ${ROOT}/doc/debug-sections.tmp ${ROOT}/doc/debug-sections.tmp2
 rm ${ROOT}/boilerplate_fix.sed

=== modified file 'src/http/Makefile.am'
--- src/http/Makefile.am	2015-09-05 18:52:17 +0000
+++ src/http/Makefile.am	2015-09-21 16:52:59 +0000
@@ -4,38 +4,41 @@
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
 include $(top_srcdir)/src/Common.am
 include $(top_srcdir)/src/TestHeaders.am
 
 SUBDIRS = one
 DIST_SUBDIRS = one
 
 noinst_LTLIBRARIES = libsquid-http.la
 
 libsquid_http_la_SOURCES = \
 	forward.h \
 	MethodType.cc \
 	MethodType.h \
 	ProtocolVersion.h \
 	RegisteredHeaders.h \
 	RegisteredHeaders.cc \
 	RegisteredHeadersHash.cci \
-	RegisteredHeadersHash.gperf \
 	RequestMethod.cc \
 	RequestMethod.h \
 	StatusCode.cc \
 	StatusCode.h \
 	StatusLine.cc \
 	StatusLine.h
 
 libsquid_http_la_LIBADD= one/libhttp1.la
 
 MethodType.cc: MethodType.h $(top_srcdir)/src/mk-string-arrays.awk
 	($(AWK) -f $(top_srcdir)/src/mk-string-arrays.awk sbuf=1 &lt; $(srcdir)/MethodType.h | \
 		sed -e 's%METHOD_%%' -e 's%_C%-C%' &gt;$@) || ($(RM) -f $@ &amp;&amp; exit 1)
 
-RegisteredHeadersHash.cci: RegisteredHeadersHash.gperf
-	gperf --output-file=$@ -m 100000 $&lt;
+gperf-files: RegisteredHeadersHash.gperf
+	@if test $(srcdir)/RegisteredHeadersHash.gperf -gt $(srcdir)/RegisteredHeadersHash.cci; then \
+		gperf --output-file=$(srcdir)/RegisteredHeadersHash.cci -m 100000 $&lt; \
+	fi
 
 CLEANFILES += MethodType.cc
+
+.PHONY: gperf-files

</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003420.html">[squid-dev] [PATCH] Do not update gperf-generated files through make
</A></li>
	<LI>Next message: <A HREF="003422.html">[squid-dev] [PATCH] Do not update gperf-generated files through make
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3421">[ date ]</a>
              <a href="thread.html#3421">[ thread ]</a>
              <a href="subject.html#3421">[ subject ]</a>
              <a href="author.html#3421">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
