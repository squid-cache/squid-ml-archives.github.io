<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fake CONNECT requests during SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C560182A7.5090802%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003457.html">
   <LINK REL="Next"  HREF="003459.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fake CONNECT requests during SSL Bump</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C560182A7.5090802%40opendium.com%3E"
       TITLE="[squid-dev] Fake CONNECT requests during SSL Bump">steve at opendium.com
       </A><BR>
    <I>Tue Sep 22 16:32:39 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003457.html">[squid-dev] [PATCH] neutralize gperf useage of &quot;register&quot;	keyword
</A></li>
        <LI>Next message: <A HREF="003459.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3453">[ date ]</a>
              <a href="thread.html#3453">[ thread ]</a>
              <a href="subject.html#3453">[ subject ]</a>
              <a href="author.html#3453">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Currently, Squid generates a fake CONNECT request for transparently 
proxied HTTPS, and possibly a second fake CONNECT if that connection is 
spliced.  For non-transparently proxied connections, there's a real 
CONNECT, so the first fake CONNECT isn't needed, but the second fake 
CONNECT is also suppressed.

I'm trying to extend Squid to generate an ICAP REQMOD request for each 
ssl bump step, for both transparent and non-transparent connections. 
i.e. for transparent connections the ICAP server would see something like:
CONNECT &lt;ip&gt;:&lt;port&gt; HTTP/1.1     (initial fake CONNECT)
CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1    (step 2: after peeking in step 1)
and for non-transparent:
CONNECT &lt;host&gt;:&lt;port&gt; HTTP/1.1 (initial real CONNECT)
CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1 (step 2: after peeking in step 1)

The idea is that the ICAP server can examine the request and add headers 
to tell Squid whether to peek, bump, splice, etc. at each step.  The 
alternative is to use an external ACL do to this, but that seems more 
messy.  Ideally the step 2 CONNECT would contain all of the headers from 
the real connect in the case of a non-transparent connection.

Originally, I thought I could extend fakeAConnectRequest() to handle 
non-transparent connections and use that, but it seems fraught with 
problems - e.g. I end up with a second connection to the web server, and 
generally odd behaviour which is probably the result of the SSL-bump and 
tunnelling code fighting over the same client connection.

So I'm looking for some advice on what the best way is to go about doing 
this.  Any advice would be appreciated.

Many thanks.

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>
    Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>
    Phone:            sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: steve.vcf
Type: text/x-vcard
Size: 283 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150922/09b39fbc/attachment.vcf">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150922/09b39fbc/attachment.vcf</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003457.html">[squid-dev] [PATCH] neutralize gperf useage of &quot;register&quot;	keyword
</A></li>
	<LI>Next message: <A HREF="003459.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3453">[ date ]</a>
              <a href="thread.html#3453">[ thread ]</a>
              <a href="subject.html#3453">[ subject ]</a>
              <a href="author.html#3453">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
