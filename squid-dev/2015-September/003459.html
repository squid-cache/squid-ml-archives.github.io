<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fake CONNECT requests during SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C56018CF6.4020702%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003453.html">
   <LINK REL="Next"  HREF="003463.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fake CONNECT requests during SSL Bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C56018CF6.4020702%40treenet.co.nz%3E"
       TITLE="[squid-dev] Fake CONNECT requests during SSL Bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 22 17:16:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003453.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
        <LI>Next message: <A HREF="003463.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3459">[ date ]</a>
              <a href="thread.html#3459">[ thread ]</a>
              <a href="subject.html#3459">[ subject ]</a>
              <a href="author.html#3459">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/09/2015 4:32 a.m., Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> Currently, Squid generates a fake CONNECT request for transparently
</I>&gt;<i> proxied HTTPS, and possibly a second fake CONNECT if that connection is
</I>&gt;<i> spliced.  For non-transparently proxied connections, there's a real
</I>&gt;<i> CONNECT, so the first fake CONNECT isn't needed, but the second fake
</I>&gt;<i> CONNECT is also suppressed.
</I>&gt;<i> 
</I>&gt;<i> I'm trying to extend Squid to generate an ICAP REQMOD request for each
</I>&gt;<i> ssl bump step,
</I>
You do understand that those &quot;bump steps&quot; are an abstract concept we
created out of thin air right?
 Every time adaptation completes the adaptation response is re-parsed
and the bumping procedure is re-started from scratch on the TLS which is
contextually now &quot;inside&quot; the new faked-CONNECT.

Its like doing a full ICAP transaction to represent sending a message to
ICAP, then doing a second full one to represent receiving the message
back from ICAP. Then wanting an ICAP request to represent sending that
request to ICAP... Turtles all the ways down...


&gt;<i> for both transparent and non-transparent connections.
</I>&gt;<i> i.e. for transparent connections the ICAP server would see something like:
</I>&gt;<i> CONNECT &lt;ip&gt;:&lt;port&gt; HTTP/1.1     (initial fake CONNECT)
</I>&gt;<i> CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1    (step 2: after peeking in step 1)
</I>&gt;<i> and for non-transparent:
</I>&gt;<i> CONNECT &lt;host&gt;:&lt;port&gt; HTTP/1.1 (initial real CONNECT)
</I>&gt;<i> CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1 (step 2: after peeking in step 1)
</I>
There is a mandatory host == sni identical values thing going on. So why
bother faking a request that will be identical sans the mime headers to
the one preceeding it?

&gt;<i> CONNECT &lt;host&gt;:&lt;port&gt; HTTP/1.1 (initial real CONNECT)
</I>&gt;<i> CONNECT &lt;host&gt;:&lt;port&gt; HTTP/1.1 (step 2: after peeking in step 1)
</I>

&gt;<i> 
</I>&gt;<i> The idea is that the ICAP server can examine the request and add headers
</I>&gt;<i> to tell Squid whether to peek, bump, splice, etc. at each step.  The
</I>&gt;<i> alternative is to use an external ACL do to this, but that seems more
</I>&gt;<i> messy.
</I>
Its not. External ACL is the correct way to do it. A simple helper
lookup that returns a value mid-way through the ssl_bump decision making.

Versus injecting data into the buffer and re-parsing everything from
scratch as a sub-context nested inside the older context(s) from earlier
cycles of CONNECT.


&gt;<i>  Ideally the step 2 CONNECT would contain all of the headers from
</I>&gt;<i> the real connect in the case of a non-transparent connection.
</I>&gt;<i> 
</I>&gt;<i> Originally, I thought I could extend fakeAConnectRequest() to handle
</I>&gt;<i> non-transparent connections and use that, but it seems fraught with
</I>&gt;<i> problems - e.g. I end up with a second connection to the web server, and
</I>&gt;<i> generally odd behaviour which is probably the result of the SSL-bump and
</I>&gt;<i> tunnelling code fighting over the same client connection.
</I>
fakeAConnectRequest() only injects an HTTP message into the TCP read
buffer. That message is then treated as if *it* were the HTTP message
received instead of straight TLS. It now happens to contain the client
TLS, ... which gets bumped... and so on.

&gt;<i> 
</I>&gt;<i> So I'm looking for some advice on what the best way is to go about doing
</I>&gt;<i> this.  Any advice would be appreciated.
</I>&gt;<i> 
</I>
Amos

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003453.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
	<LI>Next message: <A HREF="003463.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3459">[ date ]</a>
              <a href="thread.html#3459">[ thread ]</a>
              <a href="subject.html#3459">[ subject ]</a>
              <a href="author.html#3459">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
