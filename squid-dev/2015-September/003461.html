<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fake CONNECT requests during SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C5601C335.40207%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003484.html">
   <LINK REL="Next"  HREF="003462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fake CONNECT requests during SSL Bump</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C5601C335.40207%40measurement-factory.com%3E"
       TITLE="[squid-dev] Fake CONNECT requests during SSL Bump">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 22 21:08:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003484.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
        <LI>Next message: <A HREF="003462.html">[squid-dev] Build failed in Jenkins: trunk-polygraph #867
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3461">[ date ]</a>
              <a href="thread.html#3461">[ thread ]</a>
              <a href="subject.html#3461">[ subject ]</a>
              <a href="author.html#3461">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/22/2015 10:32 AM, Steve Hill wrote:

&gt;<i> Currently, Squid generates a fake CONNECT request for transparently
</I>&gt;<i> proxied HTTPS, and possibly a second fake CONNECT if that connection is
</I>&gt;<i> spliced.  For non-transparently proxied connections, there's a real
</I>&gt;<i> CONNECT, so the first fake CONNECT isn't needed, but the second fake
</I>&gt;<i> CONNECT is also suppressed.
</I>&gt;<i> 
</I>&gt;<i> I'm trying to extend Squid to generate an ICAP REQMOD request for each
</I>&gt;<i> ssl bump step, for both transparent and non-transparent connections.
</I>&gt;<i> i.e. for transparent connections the ICAP server would see something like:
</I>&gt;<i> CONNECT &lt;ip&gt;:&lt;port&gt; HTTP/1.1     (initial fake CONNECT)
</I>&gt;<i> CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1    (step 2: after peeking in step 1)
</I>
&gt;<i> and for non-transparent:
</I>&gt;<i> CONNECT &lt;host&gt;:&lt;port&gt; HTTP/1.1 (initial real CONNECT)
</I>&gt;<i> CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1 (step 2: after peeking in step 1)
</I>
Makes sense to me. The CONNECT request is needed, in one form or
another, for both ACL- and ICAP-driven solutions, for transparent and
forward-proxy scenarios.

Note that &lt;host&gt; may be &lt;ip&gt; in the forward-proxy scenario too.


&gt;<i> The idea is that the ICAP server can examine the request and add headers
</I>&gt;<i> to tell Squid whether to peek, bump, splice, etc. at each step.  The
</I>&gt;<i> alternative is to use an external ACL do to this, but that seems more
</I>&gt;<i> messy.
</I>
Yes, especially if you have to duplicate or split your business logic
between the ICAP service and the external ACL helper. And if you need
extension CONNECT headers that the external ACL is not supposed to get.



&gt;<i> Originally, I thought I could extend fakeAConnectRequest() to handle
</I>&gt;<i> non-transparent connections and use that, but it seems fraught with
</I>&gt;<i> problems - e.g. I end up with a second connection to the web server, and
</I>&gt;<i> generally odd behaviour which is probably the result of the SSL-bump and
</I>&gt;<i> tunnelling code fighting over the same client connection.
</I>&gt;<i> 
</I>&gt;<i> So I'm looking for some advice on what the best way is to go about doing
</I>&gt;<i> this.  Any advice would be appreciated.
</I>
It will be difficult. ConnStateData::fakeAConnectRequest() is a big
hack. Extending that to work for forwarded connections is probably
possible, but you would have to carefully compare transparent and
forwarded sequences of calls/events and make sure the forwarded code
works/cleans up as expected.

I would not be surprised if it would be easier to completely remove
fakeAConnectRequest() and implement the whole thing the &quot;right way&quot;:
Instead of injecting data into the input buffer, the SslBump code should
be creating CONNECT request structures, and the processing code should
accept CONNECT request structures instead of raw buffers. It was too
difficult to do that earlier, but tunnel.cc is getting better, and may
now allow for the proper implementation.


There is an alternative, but it is also complex: We need to add an
eCAP-backed ACL (headers-only). If you have that, you could put all your
business logic into an eCAP adapter and use that for ssl_bump ACLs
(among other things).


Alex.
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003484.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
	<LI>Next message: <A HREF="003462.html">[squid-dev] Build failed in Jenkins: trunk-polygraph #867
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3461">[ date ]</a>
              <a href="thread.html#3461">[ thread ]</a>
              <a href="subject.html#3461">[ subject ]</a>
              <a href="author.html#3461">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
