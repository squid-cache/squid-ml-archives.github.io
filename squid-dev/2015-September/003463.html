<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fake CONNECT requests during SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C5601C95E.9090800%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003459.html">
   <LINK REL="Next"  HREF="003466.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fake CONNECT requests during SSL Bump</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C5601C95E.9090800%40measurement-factory.com%3E"
       TITLE="[squid-dev] Fake CONNECT requests during SSL Bump">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 22 21:34:22 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003459.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
        <LI>Next message: <A HREF="003466.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3463">[ date ]</a>
              <a href="thread.html#3463">[ thread ]</a>
              <a href="subject.html#3463">[ subject ]</a>
              <a href="author.html#3463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/22/2015 11:16 AM, Amos Jeffries wrote:
&gt;<i> On 23/09/2015 4:32 a.m., Steve Hill wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Currently, Squid generates a fake CONNECT request for transparently
</I>&gt;&gt;<i> proxied HTTPS, and possibly a second fake CONNECT if that connection is
</I>&gt;&gt;<i> spliced.  For non-transparently proxied connections, there's a real
</I>&gt;&gt;<i> CONNECT, so the first fake CONNECT isn't needed, but the second fake
</I>&gt;&gt;<i> CONNECT is also suppressed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to extend Squid to generate an ICAP REQMOD request for each
</I>&gt;&gt;<i> ssl bump step,
</I>
&gt;<i> You do understand that those &quot;bump steps&quot; are an abstract concept we
</I>&gt;<i> created out of thin air right?
</I>

At the risk of getting into another pointless debate about the meaning
of dictionary words, I have to note that bumping steps are as real as
anything else in Squid. No, they are not described in some RFC, but they
could have been, and they are backed by various necessary processing
steps to implement bumping. We could group those processing steps
differently and could add more steps, of course, but that does not make
the existing steps any less &quot;real&quot; or more &quot;abstract&quot; than, say,
http_access or cache_peer processing steps.


&gt;<i> Every time adaptation completes the adaptation response is re-parsed
</I>&gt;<i> and the bumping procedure is re-started from scratch on the TLS which is
</I>&gt;<i> contextually now &quot;inside&quot; the new faked-CONNECT.
</I>&gt;<i> 
</I>&gt;<i> Its like doing a full ICAP transaction to represent sending a message to
</I>&gt;<i> ICAP, then doing a second full one to represent receiving the message
</I>&gt;<i> back from ICAP. Then wanting an ICAP request to represent sending that
</I>&gt;<i> request to ICAP... Turtles all the ways down...
</I>
I do not see it that way. There is no recursion or even [significant]
repetition here. The fact that we sometimes fake CONNECT message is an
implementation detail driven by Squid code and ICAP limitations. The
CONNECT message is just a container to get the information across.


&gt;&gt;<i> for both transparent and non-transparent connections.
</I>&gt;&gt;<i> i.e. for transparent connections the ICAP server would see something like:
</I>&gt;&gt;<i> CONNECT &lt;ip&gt;:&lt;port&gt; HTTP/1.1     (initial fake CONNECT)
</I>&gt;&gt;<i> CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1    (step 2: after peeking in step 1)
</I>&gt;&gt;<i> and for non-transparent:
</I>&gt;&gt;<i> CONNECT &lt;host&gt;:&lt;port&gt; HTTP/1.1 (initial real CONNECT)
</I>&gt;&gt;<i> CONNECT &lt;sni&gt;:&lt;port&gt; HTTP/1.1 (step 2: after peeking in step 1)
</I>
&gt;<i> There is a mandatory host == sni identical values thing going on. So why
</I>&gt;<i> bother faking a request that will be identical sans the mime headers to
</I>&gt;<i> the one preceeding it?
</I>
The answer is the same as the answer to the &quot;Why have three bumping
steps?&quot; question: Things are usually identical and sane, but real
traffic requires handling exceptions, and the earlier some of those
exceptions are detected and acted upon, the better.

The simplest example is perhaps a real CONNECT that uses an IP address
instead of a domain name, but there are many more.


&gt;&gt;<i> The idea is that the ICAP server can examine the request and add headers
</I>&gt;&gt;<i> to tell Squid whether to peek, bump, splice, etc. at each step.  The
</I>&gt;&gt;<i> alternative is to use an external ACL do to this, but that seems more
</I>&gt;&gt;<i> messy.
</I>

&gt;<i> Its not. External ACL is the correct way to do it. A simple helper
</I>&gt;<i> lookup that returns a value mid-way through the ssl_bump decision making.
</I>
I do agree that, all other factors being equal, using an ACL is easier.
Moreover, I think migrating from extra transaction adaptation steps to
[eCAP/ICAP-backed] ACLs would be the right long-term direction for Squid.


&gt;<i> Versus injecting data into the buffer and re-parsing everything from
</I>&gt;<i> scratch as a sub-context nested inside the older context(s) from earlier
</I>&gt;<i> cycles of CONNECT.
</I>
Injections and re-parsings are Squid implementation flaws, not an
inherent problem property. Conceptually, they are not important and will
probably/hopefully eventually disappear.


Alex.

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003459.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
	<LI>Next message: <A HREF="003466.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3463">[ date ]</a>
              <a href="thread.html#3463">[ thread ]</a>
              <a href="subject.html#3463">[ subject ]</a>
              <a href="author.html#3463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
