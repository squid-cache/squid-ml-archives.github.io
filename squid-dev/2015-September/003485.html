<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fake CONNECT requests during SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C560744AA.8020306%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003473.html">
   <LINK REL="Next"  HREF="003489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fake CONNECT requests during SSL Bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fake%20CONNECT%20requests%20during%20SSL%20Bump&In-Reply-To=%3C560744AA.8020306%40treenet.co.nz%3E"
       TITLE="[squid-dev] Fake CONNECT requests during SSL Bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Sep 27 01:21:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003473.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
        <LI>Next message: <A HREF="003489.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3485">[ date ]</a>
              <a href="thread.html#3485">[ thread ]</a>
              <a href="subject.html#3485">[ subject ]</a>
              <a href="author.html#3485">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/09/2015 11:40 p.m., Marcus Kool wrote:
&gt;<i> 
</I>&gt;<i> On 09/24/2015 02:13 AM, Eliezer Croitoru wrote:
</I>&gt;&gt;<i> On 23/09/2015 04:52, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> Exactly. They are processing steps. Not messages to be adapted.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> +1 For that.
</I>&gt;&gt;<i>
</I>&gt;<i> [...]
</I>&gt;<i> 
</I>&gt;&gt;<i> In any case the bottom line from me is that for now ICAP and ECAP are
</I>&gt;&gt;<i> called ADAPTATION services and not ACL services.
</I>&gt;&gt;<i> It can be extended to do so and it's not a part of the RFCs or
</I>&gt;&gt;<i> definitions and it might be the right way to do things but it will
</I>&gt;&gt;<i> require simple enough libraries that will let most admins (if not all)
</I>&gt;&gt;<i> to be able to implement their ACL logics using these
</I>&gt;&gt;<i> protocol\implementations.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ICAP is an adaptation protocol that almost everybody uses for access
</I>&gt;<i> control.
</I>
Which is wrong way to do it in many cases. All the effort put into
avoiding the use of correct APIs is frustrating.

Adaptation is for adaptation, not authorization.

&gt;<i> 
</I>&gt;<i> The ICAP server must be able to see all traffic going through Squid so
</I>&gt;<i> that it can do what it was designed for and block (parts) of websites
</I>&gt;<i> and other data streams.
</I>
Blocking *parts* of websites is not access control. It is censorship and
copyright violation.

Rejecting the requests with 451 status is the correct (and legal) way to
go about that.


&gt;<i> Other data streams may not be HTTP(S)-based and hence are not bumped,
</I>&gt;<i> but for the ICAP server to be able to do its thing, it still needs a
</I>&gt;<i> (fake) CONNECT.
</I>&gt;<i> 
</I>&gt;<i> Going back to Steve's original message, I think that it is not necessary
</I>&gt;<i> to generate a (fake) CONNECT for each bump step,
</I>&gt;<i> but to send exactly one CONNECT at the moment that Squid makes a
</I>&gt;<i> decision.  I.e. when Squid decides to bump or splice.
</I>&gt;<i> 
</I>
No. CONNECT means a change of traffic protocols is happening on the
connection.

Specifically it is a placeholder for the request message that would have
been sent by the client if it was using an explicit-proxy and the
protocol stack was being changed properly by an explicit HTTP layer
CONNECT message, instead of intercepted.


The first layer protocol received is TCP.

 - If that was intercepted we use a CONNECT with raw-IP to represent the
machine NAT subsystem requesting a tunnel.
  + Explicit proxies this actually exists as bytes of on-wire message
and can have domain names from the client.

 - If that HTTP-over-TCP CONNECT request is allowed it gets serviced,
maybe adapted. Otherwise it gets rejected.

 - If ssl_bump says to do anything other than splice with it ...


The second layer protocol is TLS-over-HTTP (-over-TCP).

 - If the connection was intercepted and SNI was now found to be present.
   + We reset (some of) the connection state and go back to &quot;first layer
protocol&quot; processing but using the SNI instead of raw-IP.
   + For the *sole* reason of better emulating the real explicit-proxy
behaviour. Otherwise...

 - If splicing is chosen the tunnel is enacted.

 - If bumping is done ...


The third protocol is HTTP-over-TLS (-over-HTTP-over-TCP).

 - If that HTTP(S) request is allowed it gets serviced, maybe adapted.
Otherwise it gets rejected.


** Interception proxies run through later 1, maybe 1 again and 3.
** Explicit proxies run through layer 1 and 3.


IMO we are better off removing the raw-IP CONNECT by always peeking at
the SNI than going the other way and adding more repeated CONNECT
processing.

Contextually a second CONNECT for explicit proxy is meaningless since
the SNI value is just the FQDN used for all the bumped HTTPS requests
URLs. There is no real HTTP message or even a protocol change action for
the adaptation to associate a client response with.

One part lacking that we do need to fix soonish is to add hostVerify
logics to enforce the inner layer (3) messages Host: header == SNI
security requirement.

Amos
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003473.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
	<LI>Next message: <A HREF="003489.html">[squid-dev] Fake CONNECT requests during SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3485">[ date ]</a>
              <a href="thread.html#3485">[ thread ]</a>
              <a href="subject.html#3485">[ subject ]</a>
              <a href="author.html#3485">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
