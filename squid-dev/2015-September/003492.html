<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] convert digest_nonce_h to MEMPROXY_CLASS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20convert%20digest_nonce_h%20to%20MEMPROXY_CLASS&In-Reply-To=%3C56088859.6080004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003490.html">
   <LINK REL="Next"  HREF="003493.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] convert digest_nonce_h to MEMPROXY_CLASS</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20convert%20digest_nonce_h%20to%20MEMPROXY_CLASS&In-Reply-To=%3C56088859.6080004%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] convert digest_nonce_h to MEMPROXY_CLASS">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 28 00:22:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003490.html">[squid-dev] [PATCH] convert digest_nonce_h to MEMPROXY_CLASS
</A></li>
        <LI>Next message: <A HREF="003493.html">[squid-dev] [PATCH] Transform dlink_node into memproxy_class
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3492">[ date ]</a>
              <a href="thread.html#3492">[ thread ]</a>
              <a href="subject.html#3492">[ subject ]</a>
              <a href="author.html#3492">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/09/2015 6:40 a.m., Kinkie wrote:
&gt;<i> On Sun, Sep 27, 2015 at 12:51 PM, Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;<i> On 27/09/2015 10:30 p.m., Kinkie wrote:
</I>&gt;&gt;&gt;<i> .. and remove one XXX in the process.
</I>&gt;&gt;&gt;<i> Not much to add besides the subject.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> build- and lightly run-tested, seems to be ok.
</I>&gt;&gt;&gt;<i> Big-context patch attached.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Two big problems stand right out.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * The static random and distribution objects were specificaly internal
</I>&gt;&gt;<i> to a function in order so that they got initialized on first use, but
</I>&gt;&gt;<i> did not get initialized if never used.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is somewhat important to a) save the machine available entropy bits
</I>&gt;&gt;<i> for other useswhen Digest is not configured, and b) decrease the
</I>&gt;&gt;<i> probability that the workers initialize them within the same second -
</I>&gt;&gt;<i> they only get initialized on first traffic request handled, not during
</I>&gt;&gt;<i> the startup second. And so the seeding can survive fork()'ing.
</I>&gt;<i> 
</I>&gt;<i> Whoops, I had misinterpreted the intention in this code as stated in
</I>&gt;<i> the first comment in authenticateDigestNonceNew. Is that not
</I>&gt;<i> intentional?
</I>&gt;<i> But if the problem is unique seeding, isn't it also useful to mix time
</I>&gt;<i> with a known-unique quantity, e.g. the PID?
</I>
Not really, that increases the chance of seed collisions between
seconds.  NOW() + (PID + n) == (NOW() + n) + PID

Since PID values loop we end up with different (cyclic) periods of time
sharing seeds with identical values. Whereas with just time every second
is a new seed, and we only have to worry about avoiding seeding twice in
one second.

If the particular seconds was a big issue between workers we could just
dig for deeper resolution of time to seed with.


&gt;<i> In the meantime I've moved these data members as static members of
</I>&gt;<i> digest_nonce_data::refreshRandomData() and referenced that from the
</I>&gt;<i> ctor .
</I>&gt;<i> 
</I>
Okay. Good.

&gt;&gt;<i> * the contents of authenticateDigestNonceNew() should be in the nonce
</I>&gt;&gt;<i> object ctor, or at least a method called by it.
</I>&gt;<i> 
</I>&gt;<i> Are you sure? It seems to me that it's actually the other way around:
</I>&gt;<i> authenticateDigestNonceNew is the only place where digest_nonce_data
</I>&gt;<i> gets instantiated, I've factored the POD instantiation code out of
</I>&gt;<i> digest_nonce_data to the ctor. The code could certainly be improved,
</I>&gt;<i> e.g. by moving the nonces registry and the nonce base64 encoding as a
</I>&gt;<i> static member of digest_nonce_h . It may be argued that the comment
</I>&gt;<i> block in authenticateDigestNonceNew could be moved elsewhere, I don't
</I>&gt;<i> really know what could be the best location for it tho.
</I>
I believe the RBC /**/ block is related to the ctor initialization
values which authenticateDigestNonceNew() as a whole was creating. The
choice of initializer values is part of that, the randomness objects and
while loop was enforcing the criteria.
 Which is why I think the whole of that functions body need to be ctor.
So it stays together as a unit constructing a nonce object. With the RBC
comment retained.


The //NP: block I added is specifically about the std:: random objects
and their use of time(). It should stay above them in their new home.


&gt;<i> 
</I>&gt;&gt;<i> * the contents of authenticateDigestNonceDelete() should be the nonce
</I>&gt;&gt;<i> objects dtor.
</I>&gt;<i> 
</I>&gt;<i> Not unless we move the cache in the nonce_data class. It's doable but
</I>&gt;<i> I consider it out of scope for this effort. I've added an XXX about
</I>&gt;<i> that.
</I>
The latest changes to the bug4190 cache give it an agnostic key. I'm
thinking long term the nonce cache can just re-use that cache code by
passing the nonce (or whatever) as the key.

Amos

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003490.html">[squid-dev] [PATCH] convert digest_nonce_h to MEMPROXY_CLASS
</A></li>
	<LI>Next message: <A HREF="003493.html">[squid-dev] [PATCH] Transform dlink_node into memproxy_class
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3492">[ date ]</a>
              <a href="thread.html#3492">[ thread ]</a>
              <a href="subject.html#3492">[ subject ]</a>
              <a href="author.html#3492">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
