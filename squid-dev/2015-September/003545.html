<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] ICAP REQMOD request and response structure expectations?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20ICAP%20REQMOD%20request%20and%20response%20structure%0A%20expectations%3F&In-Reply-To=%3C560A64E8.5000004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003544.html">
   <LINK REL="Next"  HREF="003546.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] ICAP REQMOD request and response structure expectations?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20ICAP%20REQMOD%20request%20and%20response%20structure%0A%20expectations%3F&In-Reply-To=%3C560A64E8.5000004%40treenet.co.nz%3E"
       TITLE="[squid-dev] ICAP REQMOD request and response structure expectations?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 29 10:16:08 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003544.html">[squid-dev] ICAP REQMOD request and response structure expectations?
</A></li>
        <LI>Next message: <A HREF="003546.html">[squid-dev] ICAP REQMOD request and response structure expectations?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3545">[ date ]</a>
              <a href="thread.html#3545">[ thread ]</a>
              <a href="subject.html#3545">[ subject ]</a>
              <a href="author.html#3545">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/09/2015 12:57 p.m., Eliezer Croitoru wrote:
&gt;<i> I have been working on an ICAP service and eventually I found out that
</I>&gt;<i> some of the issues I have been struggling to resolve are just there
</I>&gt;<i> because the library implementer partially read the RFC or just not fully
</I>&gt;<i> considered the code he was writing.
</I>&gt;<i> 
</I>&gt;<i> So after reading the ICAP RFC(who knows what time) I found out that
</I>&gt;<i> squid obeys it but it seems to alter the requests a bit.
</I>&gt;<i> So I wanted to verify as much as possible I understand correctly what is
</I>&gt;<i> possible.
</I>&gt;<i> For HTTP requests squid seems to replace the original request first line
</I>&gt;<i> PATH to a full URI.
</I>
No, to the &quot;effective Request URI&quot; as defined in RFC 7230. In practice
that means the absolute-URI (or &quot;full URL&quot;) on all requests except
OPTIONS and CONNECT.

&lt;<A HREF="http://tools.ietf.org/html/rfc7230#section-5.5">http://tools.ietf.org/html/rfc7230#section-5.5</A>&gt;

NP: Squid was doing this long before it was documented in the RFCs.


&gt;<i> I have tried couple times to verify and this is how it works..
</I>&gt;<i> I remember that there might have been an RFC that allows the usage of a
</I>&gt;<i> full url in the path of the Request first line and I know but it is
</I>&gt;<i> supported by many web servers.
</I>
What do you mean &quot;in the path&quot; ?

Like this?
  <A HREF="http://example.com/http://example.net/">http://example.com/http://example.net/</A>

 - has always been allowed. There is nothing special about
/<A HREF="http://example.net/">http://example.net/</A>&quot; to prevent it being a series of path segments, or
folders in a filesystem somewhere.


Or do you mean software sending the absolute-URL where you personally
think relative-URL is supposed to go?
 If so it is your expectation that was wrong. HTTP/1 has always defined
request-target as being optionally an absolute-URI, with a preference
for relative-URL on port 80 and 443 messages. (except on CONNECT and
OPTIONS methods)

&gt;<i> 
</I>&gt;<i> So would it be expected to be always like that in squid? since it
</I>&gt;<i> applies to tproxy and forward proxy mode I assume it will be the same
</I>&gt;<i> for everything else including reverse proxy mode.
</I>&gt;<i> Another case is the CONNECT method, there I know that in a forward proxy
</I>&gt;<i> mode a URI is not being used in the path but a domain\ip:port is there
</I>&gt;<i> always.
</I>

The criterion for the _4_ request-target URL types (&quot;forms&quot;) is
&lt;<A HREF="http://tools.ietf.org/html/rfc7230#section-5.3">http://tools.ietf.org/html/rfc7230#section-5.3</A>&gt;


&gt;<i> 
</I>&gt;<i> Now to the main question:
</I>&gt;<i> In a case I would modify a request to perform a url rewrite like
</I>&gt;<i> operation, which is to replace url_rewrite helper I can do one of two
</I>&gt;<i> things.
</I>&gt;<i> - I can either modify the full request and transparently send the client
</I>&gt;<i> to another page.
</I>&gt;<i> - or use the same request and append a response such as 302 or 307
</I>&gt;<i> redirection.
</I>
The *proper* way to do it is 30x redirect. But that relies on the
redirected-to URL being accessible to the client.
  In that #2 case you just have to emit the 30x message properly with
Location header and UI-suitable payload both agreeing with each other
(semantically, if not absolutely).

Note that 300, 301, 302, 303, 307, 308, 426, 451 and 511 are all
redirect (or equivalent) responses that may be more (or less) suitable
depending on the specific situations.


&gt;<i> 
</I>&gt;<i> The second case is simple to implement but the first one(changing the
</I>&gt;<i> original request) means that I am changing the URL, but what squid
</I>&gt;<i> expects me to change in the request?
</I>
The message request-target field (what commonly called the message URL).
Any headers which embed parts of the URL.

If you change the URL using a absolute-URL on the adapted request
message Squid will deal with the Host header itself.

But there is also Origin, Authority, Forwarded-For, etc. which might
exist depending on what sub-protocol or extension is being transmitted
over HTTP.

Maybe uploaded content, though that is probably rare outside of PUT.


&gt;<i> or what response does it expects?
</I>
For #1 case, to make it transparent you have to filter the response
headers. Anything like Location, Content-Location, Forwarded-For which
contains URL or portions of it.

Also the payload - any content object that might contain URLs. HTML, JS,
JSON are the worst. But also PS, PDF, images, videos SWF etc.

If any of those get through on reponses there is a chance the user or
some automated script might use it. What that chance is varies from
large to ignorable depending on the format type and what the client
software is.


Sorry. Content adaptation is complex if you plan to do it seriously.

&gt;<i> Does squid expect me to change the URI only in the request first line or
</I>&gt;<i> also the Host header?
</I>
Yes, both.

&gt;<i> 
</I>&gt;<i> It is not a &quot;critical&quot; question since for now I replace them both, but
</I>&gt;<i> if squid expects only the URI in the first request line to be changed
</I>&gt;<i> there is no point to change the Host header.
</I>
See above. But you may not want to tie this behaviour to depend on
Squid. ICAP is by design portable between proxies and other types of
ICAP clients.

&gt;<i> 
</I>&gt;<i> Thanks In Advance,
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> * I am trying to think about documenting couple things about ICAP in the
</I>&gt;<i> WIKI with an example ICAP service.
</I>
Our wiki is probably not the best place. Unless you were just
concentrating on the squid.conf parts, and AFAICS that is covered already.

You might want to get in contact with Christos about improving c-icap
documentation or the ICAP forum for adding to their docs for the service
internals or how-to documentation.

Amos
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003544.html">[squid-dev] ICAP REQMOD request and response structure expectations?
</A></li>
	<LI>Next message: <A HREF="003546.html">[squid-dev] ICAP REQMOD request and response structure expectations?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3545">[ date ]</a>
              <a href="thread.html#3545">[ thread ]</a>
              <a href="subject.html#3545">[ subject ]</a>
              <a href="author.html#3545">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
