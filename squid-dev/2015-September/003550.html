<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] turn mempools' delete(nullptr) into NOP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20turn%20mempools%27%20delete%28nullptr%29%20into%20NOP&In-Reply-To=%3CCA%2BY8hcMkVp1u%3DNDMgW4hMzK5MC98h7ko7yWZUFQUe2L1jY7czg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="003547.html">
   <LINK REL="Next"  HREF="003551.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] turn mempools' delete(nullptr) into NOP</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20turn%20mempools%27%20delete%28nullptr%29%20into%20NOP&In-Reply-To=%3CCA%2BY8hcMkVp1u%3DNDMgW4hMzK5MC98h7ko7yWZUFQUe2L1jY7czg%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] turn mempools' delete(nullptr) into NOP">gkinkie at gmail.com
       </A><BR>
    <I>Tue Sep 29 19:33:16 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="003547.html">[squid-dev] Jenkins build is back to normal : trunk-polygraph #879
</A></li>
        <LI>Next message: <A HREF="003551.html">[squid-dev] [PATCH] turn mempools' delete(nullptr) into NOP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3550">[ date ]</a>
              <a href="thread.html#3550">[ thread ]</a>
              <a href="subject.html#3550">[ subject ]</a>
              <a href="author.html#3550">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
  while checking the mempools code during the discussion of thread
&quot;[PATCH] Refactor htcpDetail into MEMPROXY_CLASS&quot; I found out that
mempools' operator delete has a different behavior than that of
::<i>delete.
</I>In particular, ::delete(nullptr) is defined to be a NOP [1]. Our code
instead aborts:
MEMPROXY_CLASS's delete calls MemAllocatorProxy::freeOne which calls
MemImplementingAllocator::freeOne (via MemAllocator) which asserts on
nullptr.

The assert is needed because which freeOne calls
MemAllocator::deallocate which is virtual, specialized by
MemPoolChunked and MemPoolMalloc, neither of which can accept
nullptr's in the general case.
The whole setup is right now working because the API makes it a
responsiblity of the caller never to delete(nullptr).

In the thread I mentioned above, Amos suggests to change our
user-facing API to match ::delete. This patch does exactly that, by
accepting but not processing nullptrs in
MemImplementingAllocator::freeOne.

[1] <A HREF="http://stackoverflow.com/questions/6731331/is-it-still-safe-to-delete-nullptr-in-c0x">http://stackoverflow.com/questions/6731331/is-it-still-safe-to-delete-nullptr-in-c0x</A>

-- 
    Francesco
-------------- next part --------------
A non-text attachment was scrubbed...
Name: memproxy-class-allow-delete-nullptr.patch
Type: text/x-diff
Size: 2458 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150929/994ca10f/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20150929/994ca10f/attachment.patch</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003547.html">[squid-dev] Jenkins build is back to normal : trunk-polygraph #879
</A></li>
	<LI>Next message: <A HREF="003551.html">[squid-dev] [PATCH] turn mempools' delete(nullptr) into NOP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3550">[ date ]</a>
              <a href="thread.html#3550">[ thread ]</a>
              <a href="subject.html#3550">[ subject ]</a>
              <a href="author.html#3550">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
