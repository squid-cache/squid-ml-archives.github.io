<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Increase request buffer size to 64kb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Increase%20request%20buffer%20size%20to%2064kb&In-Reply-To=%3C57009C3E.1050701%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005536.html">
   <LINK REL="Next"  HREF="005538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Increase request buffer size to 64kb</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Increase%20request%20buffer%20size%20to%2064kb&In-Reply-To=%3C57009C3E.1050701%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Increase request buffer size to 64kb">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Apr  3 04:29:50 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005536.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
        <LI>Next message: <A HREF="005538.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5537">[ date ]</a>
              <a href="thread.html#5537">[ thread ]</a>
              <a href="subject.html#5537">[ subject ]</a>
              <a href="author.html#5537">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/31/2016 11:22 PM, Nathan Hoad wrote:
&gt;<i> I've attached two patches - they're functionally identical, one uses
</I>&gt;<i> SBuf and the other using MemBuf.
</I>
I am only looking at SBuf patch because MemBuf is deprecated. I have not
read your analysis email yet, but will do so soon. Meanwhile, I wanted
to give you something to work on...


&gt;<i> Make the size of the buffer on Http::Stream configurable.
</I>
s/buffer on Http::Stream/ClientStream buffer/


Please do mention the other two equally (or more!) important changes:

* Enlarge that buffer [default] size (from 4KB to 64KB) to ...

* Enlarge read_ahead_gap (from 4KB to 64KB) to ...

The code changes will show what you did, but will not explain *why* you
are changing these defaults. Do not let your research be forgotten in
the mailing list archives!


&gt;<i> +StoreIOBuffer
</I>&gt;<i> +Http::Stream::getStoreIOBuffer()
</I>&gt;<i> +{
</I>&gt;<i> +    StoreIOBuffer tempBuffer;
</I>&gt;<i> +    tempBuffer.data = this-&gt;requestBuffer.rawSpace(Config.httpStreamBufferSize);
</I>&gt;<i> +    tempBuffer.length = this-&gt;requestBuffer.spaceSize();
</I>&gt;<i> +    assert(tempBuffer.length);
</I>&gt;<i> +    return tempBuffer;
</I>&gt;<i> +}
</I>
getStoreIOBuffer() name tells us that the method returns a
StoreIOBuffer, which we already know based on the method return type. I
suggest calling this method clientStreamBuffer() to tell the reader what
kind of StoreIOBuffer the method returns.


Adding a method that grows some buffer without bounds on every call is a
bad idea in general. I suspect this problem will go away when you
convert to MemBlob (because it will be allocated once).


The new assert() looks out of place and/or misleading: rawSpace()
guarantees spaceSize() to be at least Config.httpStreamBufferSize. Thus,
the assert() essentially checks that Config.httpStreamBufferSize is
positive. getStoreIOBuffer is the wrong place to check configuration
[and assert if it incorrect]. Moreover, since getStoreIOBuffer() does
not try to write something into that buffer, it does not actually care
whether tempBuffer.length is zero and should not assert if it is.

Please find a better place to check that Config.httpStreamBufferSize is
positive. There should be some configuration validation code in Squid
already.


Please no explicit &quot;this&quot; inside regular class methods. There are some
rare cases where using explicit &quot;this&quot; is appropriate or even required,
but this is not one of them.



&gt;<i> +    requestBuffer.reserveCapacity(Config.httpStreamBufferSize);
</I>
This is premature RAM spending. Your code always requests at least
Config.httpStreamBufferSize space bytes later so there is no need to
pre-allocate the same amount here. However, you may have to do that once
you migrate away from SBuf to MemBlob (unless you allocate MemBlob when
asked for the stream buffer).


&gt;<i> -    StoreIOBuffer tempBuffer;
</I>&gt;<i> -    tempBuffer.data = context-&gt;reqbuf;
</I>&gt;<i> -    tempBuffer.length = HTTP_REQBUF_SZ;
</I>&gt;<i> +    StoreIOBuffer tempBuffer = context-&gt;getStoreIOBuffer();
</I>&gt;<i>      clientStreamInit(&amp;http-&gt;client_stream, clientGetMoreData, clientReplyDetach,
</I>&gt;<i>                       clientReplyStatus, new clientReplyContext(http), clientSocketRecipient,
</I>&gt;<i>                       clientSocketDetach, context, tempBuffer);
</I>
Please remove the used-once tempBuffer variable to emphasize that the
buffer is only used for ClientStreams. Just call getStoreIOBuffer() when
calling clientStreamInit(). Same in other similar contexts you modify.


&gt;<i> +NAME: http_stream_buffer_size
</I>
The option applies to the FTP ClientStream buffer as well, so this name
does not seem to work at all. Please also avoid the overloaded &quot;stream&quot;
word; there are too many &quot;streams&quot; floating around and it gets confusing.

I cannot suggest a good alternative, but something like
&quot;internal_client_response_buffer_size&quot; would be better IMO. It would be
good to emphasize that this is something low-level that may change or
disappear. Technically, this buffer should not even exist (at least not
in the current form)...


&gt;<i> +	The buffer size that the cache will use when streaming response objects to
</I>&gt;<i> +	clients.
</I>
I recommend avoiding overloaded words like &quot;cache&quot; and &quot;streaming&quot;. How
about this (*if* it is true; adjust as needed!):

&quot;Specifies the size of one of the internal buffers that Squid uses for
delivering responses to clients. Network writes are done from this
buffer. This buffer is used for both hits and misses. Reducing the
buffer size does XXX. Enlarging the buffer improves YYY.

Squid does _not_ slow down response delivery to the client in order to
fill the buffer. This is one of several internal buffers a response may
go through. It may eventually be optimized away.&quot;


Fill XXX and YYY as needed to illustrate the trade-off the new parameter
controls -- there is little point in documenting this configuration
parameter if we do not tell the admin what the parameter affects. This
is very important IMO.

Again, adjust as needed.


&gt;<i> The patches are also abusing
</I>&gt;<i> MemBuf/SBuf - they're being used purely to allow configuration of the
</I>&gt;<i> buffer size, they're not being used as they normally are, or growing
</I>&gt;<i> dynamically. That would involve quite a few more changes, I think.
</I>
Yeah. Dynamic resizing may require rewriting ClientStreams. I would not
go there unless you have a lot of time to devote to that noble task.


Nevertheless, SBuf is the wrong class for this task, as you have noticed
yourself. If possible, please use MemBlob instead. You can find examples
of that class being used for similar tasks in TcpLogger and Rock::IoState.


N.B. Please use 20-30 lines of context when posting future patches --
more context makes them easier to review correctly. The default is 3-4
lines. Also, if you can configure your diff program to add function
names to patch hunks, please do so (--show-c-function for Linux diffs).


Thank you,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005536.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
	<LI>Next message: <A HREF="005538.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5537">[ date ]</a>
              <a href="thread.html#5537">[ thread ]</a>
              <a href="subject.html#5537">[ subject ]</a>
              <a href="author.html#5537">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
