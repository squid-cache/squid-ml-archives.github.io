<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Replace new/delete operators using modern C++	rules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Replace%20new/delete%20operators%20using%20modern%20C%2B%2B%0A%09rules&In-Reply-To=%3C570606C7.1070005%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005583.html">
   <LINK REL="Next"  HREF="005576.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Replace new/delete operators using modern C++	rules</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Replace%20new/delete%20operators%20using%20modern%20C%2B%2B%0A%09rules&In-Reply-To=%3C570606C7.1070005%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Replace new/delete operators using modern C++	rules">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Apr  7 07:05:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005583.html">[squid-dev] [PATCH] Remove ServerOptions &quot;partial copy&quot; copy constructor
</A></li>
        <LI>Next message: <A HREF="005576.html">[squid-dev] [PATCH] Replace new/delete operators using modern C++ rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5554">[ date ]</a>
              <a href="thread.html#5554">[ thread ]</a>
              <a href="subject.html#5554">[ subject ]</a>
              <a href="author.html#5554">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    This change was motivated by &quot;Mismatched free()/delete/delete[]&quot;
errors reported by valgrind and mused about in Squid source code.

I speculate that the old new/delete replacement code was the result of
slow accumulation of working hacks to accomodate various environments,
as compiler support for the feature evolved. The cumulative result does
not actually work well (see the above paragraph), and the replacement
functions had the following visible coding problems according to [1,2]:

a) Declared with non-standard profiles that included throw specifiers.

b) Declared inline. C++ says that the results of inline declarations
   have unspecified effects. In Squid, they probably necessitated
   complex compiler-specific &quot;extern inline&quot; workarounds.

c) Defined in the header file. C++ says that defining replacements &quot;in
   any source file&quot; is enough and that multiple replacements per
   program (which is what a header file definition produces) result in
   &quot;undefined behavior&quot;.

d) Declared inconsistently (only 2 out of 4 flavors). Declaring one base
   flavor should be sufficient, but if we declare more, we should
   declare all of them.

[1] <A HREF="http://en.cppreference.com/w/cpp/memory/new/operator_new">http://en.cppreference.com/w/cpp/memory/new/operator_new</A>
[2] <A HREF="http://en.cppreference.com/w/cpp/memory/new/operator_delete">http://en.cppreference.com/w/cpp/memory/new/operator_delete</A>

The replacements were not provided to clang (trunk r13219), but there
was no explanation why. This patch does not change that exclusion.


I have no idea whether any of the old hacks are still necessary in some
cases. However, I suspect that either we do not care much if the
replacements are not enabled on some poorly supported platforms OR we
can disable them (or make them work) using much simpler hacks for the
platforms we do care about.


If the patch is approved, the SquidNew.h file should be removed. The
patch does not contain this change, but I hope that removing that file
should not be difficult -- it is not even mentioned in Makefile.am files
AFAICT.

The attached patch does not remove Debug::OutStream class that was
created to work around some of the above problems. There is a different
pending patch (&quot;Do not hide important/critical messages&quot;) which also
removes that class completely (for somewhat different reasons):
<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005510.html">http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005510.html</A>


Thank you,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: IP-12713-new-replacement-t3.patch
Type: text/x-diff
Size: 10677 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160407/1184feac/attachment-0001.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160407/1184feac/attachment-0001.patch</A>&gt;
</PRE>









































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005583.html">[squid-dev] [PATCH] Remove ServerOptions &quot;partial copy&quot; copy constructor
</A></li>
	<LI>Next message: <A HREF="005576.html">[squid-dev] [PATCH] Replace new/delete operators using modern C++ rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5554">[ date ]</a>
              <a href="thread.html#5554">[ thread ]</a>
              <a href="subject.html#5554">[ subject ]</a>
              <a href="author.html#5554">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
