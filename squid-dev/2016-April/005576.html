<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Replace new/delete operators using modern C++ rules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Replace%20new/delete%20operators%20using%20modern%0A%20C%2B%2B%20rules&In-Reply-To=%3C5709DB7C.9050102%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005554.html">
   <LINK REL="Next"  HREF="005578.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Replace new/delete operators using modern C++ rules</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Replace%20new/delete%20operators%20using%20modern%0A%20C%2B%2B%20rules&In-Reply-To=%3C5709DB7C.9050102%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Replace new/delete operators using modern C++ rules">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Apr 10 04:50:04 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005554.html">[squid-dev] [PATCH] Replace new/delete operators using modern C++	rules
</A></li>
        <LI>Next message: <A HREF="005578.html">[squid-dev] [PATCH] Replace new/delete operators using modern	C++ rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5576">[ date ]</a>
              <a href="thread.html#5576">[ thread ]</a>
              <a href="subject.html#5576">[ subject ]</a>
              <a href="author.html#5576">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/04/2016 7:05 p.m., Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     This change was motivated by &quot;Mismatched free()/delete/delete[]&quot;
</I>&gt;<i> errors reported by valgrind and mused about in Squid source code.
</I>&gt;<i> 
</I>&gt;<i> I speculate that the old new/delete replacement code was the result of
</I>&gt;<i> slow accumulation of working hacks to accomodate various environments,
</I>&gt;<i> as compiler support for the feature evolved. The cumulative result does
</I>&gt;<i> not actually work well (see the above paragraph), and the replacement
</I>&gt;<i> functions had the following visible coding problems according to [1,2]:
</I>&gt;<i> 
</I>&gt;<i> a) Declared with non-standard profiles that included throw specifiers.
</I>&gt;<i> 
</I>&gt;<i> b) Declared inline. C++ says that the results of inline declarations
</I>&gt;<i>    have unspecified effects. In Squid, they probably necessitated
</I>&gt;<i>    complex compiler-specific &quot;extern inline&quot; workarounds.
</I>&gt;<i> 
</I>&gt;<i> c) Defined in the header file. C++ says that defining replacements &quot;in
</I>&gt;<i>    any source file&quot; is enough and that multiple replacements per
</I>&gt;<i>    program (which is what a header file definition produces) result in
</I>&gt;<i>    &quot;undefined behavior&quot;.
</I>&gt;<i> 
</I>&gt;<i> d) Declared inconsistently (only 2 out of 4 flavors). Declaring one base
</I>&gt;<i>    flavor should be sufficient, but if we declare more, we should
</I>&gt;<i>    declare all of them.
</I>&gt;<i> 
</I>&gt;<i> [1] <A HREF="http://en.cppreference.com/w/cpp/memory/new/operator_new">http://en.cppreference.com/w/cpp/memory/new/operator_new</A>
</I>&gt;<i> [2] <A HREF="http://en.cppreference.com/w/cpp/memory/new/operator_delete">http://en.cppreference.com/w/cpp/memory/new/operator_delete</A>
</I>&gt;<i> 
</I>&gt;<i> The replacements were not provided to clang (trunk r13219), but there
</I>&gt;<i> was no explanation why. This patch does not change that exclusion.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have no idea whether any of the old hacks are still necessary in some
</I>&gt;<i> cases. However, I suspect that either we do not care much if the
</I>&gt;<i> replacements are not enabled on some poorly supported platforms OR we
</I>&gt;<i> can disable them (or make them work) using much simpler hacks for the
</I>&gt;<i> platforms we do care about.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If the patch is approved, the SquidNew.h file should be removed. The
</I>&gt;<i> patch does not contain this change, but I hope that removing that file
</I>&gt;<i> should not be difficult -- it is not even mentioned in Makefile.am files
</I>&gt;<i> AFAICT.
</I>&gt;<i> 
</I>&gt;<i> The attached patch does not remove Debug::OutStream class that was
</I>&gt;<i> created to work around some of the above problems. There is a different
</I>&gt;<i> pending patch (&quot;Do not hide important/critical messages&quot;) which also
</I>&gt;<i> removes that class completely (for somewhat different reasons):
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005510.html">http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005510.html</A>
</I>&gt;<i> 
</I>
AFAIK we should still have MacOS and Solaris people around to check that
this update does not break anything for them. Though the BuildFarm does
not have nodes to do it ourselves.

In principle this is a great step forward, but I would like confirmation
about the portability side of things before it actually gets merged.

Amos


</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005554.html">[squid-dev] [PATCH] Replace new/delete operators using modern C++	rules
</A></li>
	<LI>Next message: <A HREF="005578.html">[squid-dev] [PATCH] Replace new/delete operators using modern	C++ rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5576">[ date ]</a>
              <a href="thread.html#5576">[ thread ]</a>
              <a href="subject.html#5576">[ subject ]</a>
              <a href="author.html#5576">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
