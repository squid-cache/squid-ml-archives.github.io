<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Remove SquidList / link_list
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Remove%20SquidList%20/%20link_list&In-Reply-To=%3C570F8DA0.9090508%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005612.html">
   <LINK REL="Next"  HREF="005614.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Remove SquidList / link_list</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Remove%20SquidList%20/%20link_list&In-Reply-To=%3C570F8DA0.9090508%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Remove SquidList / link_list">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr 14 12:31:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005612.html">[squid-dev] [PATCH] PeerConnector shuffling to libsecurity
</A></li>
        <LI>Next message: <A HREF="005614.html">[squid-dev] [PATCH] Remove SquidList / link_list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5597">[ date ]</a>
              <a href="thread.html#5597">[ thread ]</a>
              <a href="subject.html#5597">[ subject ]</a>
              <a href="author.html#5597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This patch replaces the remaining use of Squid custom link_list type
with STL std::queue or std::list templates. Removing the now unneeded
custom type completely.

It builds on the previous libmem old_api cleanup patch and has yet to be
run tested, though the unit tests we have for the types all pass.

Amos
-------------- next part --------------
=== modified file 'src/Makefile.am'
--- src/Makefile.am	2016-03-18 09:38:10 +0000
+++ src/Makefile.am	2016-04-12 12:09:40 +0000
@@ -357,8 +357,6 @@
 	ipcache.cc \
 	ipcache.h \
 	$(LEAKFINDERSOURCE) \
-	SquidList.h \
-	SquidList.cc \
 	LogTags.cc \
 	LogTags.h \
 	lookup_t.h \
@@ -1058,8 +1056,6 @@
 	MasterXaction.h \
 	Notes.cc \
 	Notes.h \
-	SquidList.h \
-	SquidList.cc \
 	mem_node.cc \
 	Parsing.cc \
 	tests/stub_libsecurity.cc \
@@ -1297,8 +1293,6 @@
 	internal.cc \
 	LogTags.cc \
 	tests/stub_libsecurity.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	multicast.h \
@@ -1479,8 +1473,6 @@
 	HttpReply.cc \
 	int.h \
 	int.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	MemBuf.cc \
@@ -1725,8 +1717,6 @@
 	internal.cc \
 	LogTags.cc \
 	tests/stub_libsecurity.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	tests/stub_libmem.cc \
@@ -1964,8 +1954,6 @@
 	internal.h \
 	internal.cc \
 	LogTags.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	MemBuf.cc \
@@ -2199,8 +2187,6 @@
 	$(IPC_SOURCE) \
 	ipcache.cc \
 	LogTags.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	MemBuf.cc \
@@ -2516,8 +2502,6 @@
 	internal.cc \
 	LogTags.cc \
 	tests/stub_libsecurity.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	multicast.h \
@@ -2730,8 +2714,6 @@
 	RequestFlags.h \
 	int.h \
 	int.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	mem_node.cc \
@@ -2956,8 +2938,6 @@
 	int.cc \
 	RequestFlags.h \
 	RequestFlags.cc \
-	SquidList.h \
-	SquidList.cc \
 	Transients.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
@@ -3138,8 +3118,6 @@
 	HttpReply.cc \
 	int.h \
 	int.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	MemBuf.cc \
@@ -3351,8 +3329,6 @@
 	internal.cc \
 	tests/stub_libeui.cc \
 	LogTags.cc \
-	SquidList.h \
-	SquidList.cc \
 	MasterXaction.cc \
 	MasterXaction.h \
 	multicast.h \

=== removed file 'src/SquidList.cc'
--- src/SquidList.cc	2016-01-01 00:12:18 +0000
+++ src/SquidList.cc	1970-01-01 00:00:00 +0000
@@ -1,49 +0,0 @@
-/*
- * Copyright (C) 1996-2016 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-/* DEBUG: none          Linked list functions (deprecated) */
-
-#include &quot;squid.h&quot;
-#include &quot;mem/forward.h&quot;
-#include &quot;SquidList.h&quot;
-
-/* This should go away, in favour of the List template class */
-
-void
-linklistPush(link_list ** L, void *p)
-{
-    link_list *l = (link_list *)memAllocate(MEM_LINK_LIST);
-    l-&gt;next = NULL;
-    l-&gt;ptr = p;
-
-    while (*L)
-        L = &amp;(*L)-&gt;next;
-
-    *L = l;
-}
-
-void *
-linklistShift(link_list ** L)
-{
-    void *p;
-    link_list *l;
-
-    if (NULL == *L)
-        return NULL;
-
-    l = *L;
-
-    p = l-&gt;ptr;
-
-    *L = (*L)-&gt;next;
-
-    memFree(l, MEM_LINK_LIST);
-
-    return p;
-}
-

=== removed file 'src/SquidList.h'
--- src/SquidList.h	2016-01-01 00:12:18 +0000
+++ src/SquidList.h	1970-01-01 00:00:00 +0000
@@ -1,25 +0,0 @@
-/*
- * Copyright (C) 1996-2016 The Squid Software Foundation and contributors
- *
- * Squid software is distributed under GPLv2+ license and includes
- * contributions from numerous individuals and organizations.
- * Please see the COPYING and CONTRIBUTORS files for details.
- */
-
-/* DEBUG: none          Linked list functions (deprecated) */
-
-#ifndef SQUID_SQUIDLIST_H_
-#define SQUID_SQUIDLIST_H_
-
-class link_list
-{
-public:
-    void *ptr;
-    link_list *next;
-};
-
-void linklistPush(link_list **, void *);
-void *linklistShift(link_list **);
-
-#endif /* SQUID_SQUIDLIST_H_ */
-

=== modified file 'src/fs/ufs/UFSStoreState.cc'
--- src/fs/ufs/UFSStoreState.cc	2016-01-01 00:12:18 +0000
+++ src/fs/ufs/UFSStoreState.cc	2016-04-12 15:42:12 +0000
@@ -14,7 +14,6 @@
 #include &quot;DiskIO/ReadRequest.h&quot;
 #include &quot;DiskIO/WriteRequest.h&quot;
 #include &quot;Generic.h&quot;
-#include &quot;SquidList.h&quot;
 #include &quot;Store.h&quot;
 #include &quot;store/Disk.h&quot;
 #include &quot;UFSStoreState.h&quot;
@@ -181,17 +180,18 @@
 void
 Fs::Ufs::UFSStoreState::doWrite()
 {
-    debugs(79, 3, HERE &lt;&lt; this &lt;&lt; &quot; UFSStoreState::doWrite&quot;);
-
+    debugs(79, 3, static_cast&lt;void *&gt;(this));
     assert(theFile-&gt;canWrite());
 
-    _queued_write *q = (_queued_write *)linklistShift(&amp;pending_writes);
+    _queued_write *q = pending_writes.front();
 
-    if (q == NULL) {
+    if (!q) {
         debugs(79, 3, HERE &lt;&lt; this &lt;&lt; &quot; UFSStoreState::doWrite queue is empty&quot;);
         return;
     }
 
+    pending_writes.pop();
+
     if (theFile-&gt;error()) {
         debugs(79, DBG_IMPORTANT,HERE &lt;&lt; &quot;avoid write on theFile with error&quot;);
         debugs(79,3,HERE &lt;&lt; &quot;calling free_func for &quot; &lt;&lt; (void*) q-&gt;buf);
@@ -328,8 +328,6 @@
     closing(false),
     reading(false),
     writing(false),
-    pending_reads(NULL),
-    pending_writes(NULL),
     read_buf(NULL)
 {
     // StoreIOState inherited members
@@ -344,55 +342,53 @@
 
 Fs::Ufs::UFSStoreState::~UFSStoreState()
 {
-    assert(pending_reads == NULL);
-    assert(pending_writes == NULL);
+    assert(pending_reads.empty());
+    assert(pending_writes.empty());
 }
 
 void
 Fs::Ufs::UFSStoreState::freePending()
 {
-    _queued_read *qr;
-
-    while ((qr = (_queued_read *)linklistShift(&amp;pending_reads))) {
+    while (auto *qr = pending_reads.front()) {
         cbdataReferenceDone(qr-&gt;callback_data);
+        pending_reads.pop();
         delete qr;
     }
 
-    debugs(79,3,HERE &lt;&lt; &quot;UFSStoreState::freePending: freed pending reads&quot;);
-
-    _queued_write *qw;
-
-    while ((qw = (_queued_write *)linklistShift(&amp;pending_writes))) {
+    debugs(79, 3, &quot;freed pending reads&quot;);
+
+    while (auto *qw = pending_writes.front()) {
         if (qw-&gt;free_func)
             qw-&gt;free_func(const_cast&lt;char *&gt;(qw-&gt;buf));
+        pending_writes.pop();
         delete qw;
     }
 
-    debugs(79,3,HERE &lt;&lt; &quot;UFSStoreState::freePending: freed pending writes&quot;);
+    debugs(79, 3, &quot;freed pending writes&quot;);
 }
 
 bool
 Fs::Ufs::UFSStoreState::kickReadQueue()
 {
-    _queued_read *q = (_queued_read *)linklistShift(&amp;pending_reads);
+    _queued_read *q = pending_reads.front();
 
-    if (NULL == q)
+    if (!q)
         return false;
 
-    debugs(79, 3, &quot;UFSStoreState::kickReadQueue: reading queued request of &quot; &lt;&lt; q-&gt;size &lt;&lt; &quot; bytes&quot;);
+    debugs(79, 3, &quot;reading queued request of &quot; &lt;&lt; q-&gt;size &lt;&lt; &quot; bytes&quot;);
+
+    pending_reads.pop();
 
     void *cbdata;
-
     if (cbdataReferenceValidDone(q-&gt;callback_data, &amp;cbdata)) {
         read_(q-&gt;buf, q-&gt;size, q-&gt;offset, q-&gt;callback, cbdata);
     } else {
-        debugs(79, 2, &quot;UFSStoreState::kickReadQueue: this: &quot; &lt;&lt; this &lt;&lt; &quot; cbdataReferenceValidDone returned false.&quot; &lt;&lt; &quot; closing: &quot; &lt;&lt; closing &lt;&lt; &quot; flags.try_closing: &quot; &lt;&lt; flags.try_closing);
+        debugs(79, 2, &quot;this: &quot; &lt;&lt; this &lt;&lt; &quot; cbdataReferenceValidDone returned false. closing: &quot; &lt;&lt; closing &lt;&lt; &quot; flags.try_closing: &quot; &lt;&lt; flags.try_closing);
         delete q;
         return false;
     }
 
     delete q;
-
     return true;
 }
 
@@ -401,14 +397,14 @@
 {
     debugs(79, 3, &quot;UFSStoreState::queueRead: queueing read&quot;);
     assert(opening);
-    assert (pending_reads == NULL);
+    assert(pending_reads.empty());
     _queued_read *q = new _queued_read;
     q-&gt;buf = buf;
     q-&gt;size = size;
     q-&gt;offset = aOffset;
     q-&gt;callback = callback_;
     q-&gt;callback_data = cbdataReference(callback_data_);
-    linklistPush(&amp;pending_reads, q);
+    pending_reads.push(q);
 }
 
 /*
@@ -435,7 +431,7 @@
 
     flags.write_draining = true;
 
-    while (pending_writes != NULL) {
+    while (!pending_writes.empty()) {
         doWrite();
     }
 
@@ -475,14 +471,13 @@
 void
 Fs::Ufs::UFSStoreState::queueWrite(char const *buf, size_t size, off_t aOffset, FREE * free_func)
 {
-    debugs(79, 3, HERE &lt;&lt; this &lt;&lt; &quot; UFSStoreState::queueWrite: queueing write of size &quot; &lt;&lt; size);
+    debugs(79, 3, static_cast&lt;void*&gt;(this) &lt;&lt; &quot;: queueing write of size &quot; &lt;&lt; size);
 
-    _queued_write *q;
-    q = new _queued_write;
+    _queued_write *q = new _queued_write;
     q-&gt;buf = buf;
     q-&gt;size = size;
     q-&gt;offset = aOffset;
     q-&gt;free_func = free_func;
-    linklistPush(&amp;pending_writes, q);
+    pending_writes.push(q);
 }
 

=== modified file 'src/fs/ufs/UFSStoreState.h'
--- src/fs/ufs/UFSStoreState.h	2016-01-01 00:12:18 +0000
+++ src/fs/ufs/UFSStoreState.h	2016-04-12 13:20:16 +0000
@@ -10,9 +10,10 @@
 #define SQUID_FS_UFS_UFSSTORESTATE_H
 
 #include &quot;DiskIO/IORequestor.h&quot;
-#include &quot;SquidList.h&quot;
 #include &quot;StoreIOState.h&quot;
 
+#include &lt;queue&gt;
+
 namespace Fs
 {
 namespace Ufs
@@ -98,8 +99,8 @@
          */
         bool try_closing;
     } flags;
-    link_list *pending_reads;
-    link_list *pending_writes;
+    std::queue&lt;_queued_read *&gt; pending_reads;
+    std::queue&lt;_queued_write *&gt; pending_writes;
     void queueRead(char *, size_t, off_t, STRCB *, void *);
     void queueWrite(char const *, size_t, off_t, FREE *);
     bool kickReadQueue();

=== modified file 'src/mem/forward.h'
--- src/mem/forward.h	2016-04-12 10:44:44 +0000
+++ src/mem/forward.h	2016-04-12 12:10:29 +0000
@@ -46,7 +46,6 @@
     MEM_64K_BUF,
     MEM_ACL_DENY_INFO_LIST,
     MEM_ACL_NAME_LIST,
-    MEM_LINK_LIST,
     MEM_DLINK_NODE,
     MEM_DREAD_CTRL,
     MEM_DWRITE_Q,

=== modified file 'src/mem/old_api.cc'
--- src/mem/old_api.cc	2016-04-12 10:44:44 +0000
+++ src/mem/old_api.cc	2016-04-12 12:10:32 +0000
@@ -24,7 +24,6 @@
 #include &quot;MemBuf.h&quot;
 #include &quot;mgr/Registration.h&quot;
 #include &quot;SquidConfig.h&quot;
-#include &quot;SquidList.h&quot;
 #include &quot;SquidTime.h&quot;
 #include &quot;Store.h&quot;
 
@@ -445,7 +444,6 @@
     memDataInit(MEM_ACL_DENY_INFO_LIST, &quot;AclDenyInfoList&quot;,
                 sizeof(AclDenyInfoList), 0);
     memDataInit(MEM_ACL_NAME_LIST, &quot;acl_name_list&quot;, sizeof(AclNameList), 0);
-    memDataInit(MEM_LINK_LIST, &quot;link_list&quot;, sizeof(link_list), 10);
     memDataInit(MEM_DLINK_NODE, &quot;dlink_node&quot;, sizeof(dlink_node), 10);
     memDataInit(MEM_DREAD_CTRL, &quot;dread_ctrl&quot;, sizeof(dread_ctrl), 0);
     memDataInit(MEM_DWRITE_Q, &quot;dwrite_q&quot;, sizeof(dwrite_q), 0);

=== modified file 'src/repl/heap/store_repl_heap.cc'
--- src/repl/heap/store_repl_heap.cc	2016-01-01 00:12:18 +0000
+++ src/repl/heap/store_repl_heap.cc	2016-04-13 01:14:51 +0000
@@ -20,7 +20,6 @@
 #include &quot;squid.h&quot;
 #include &quot;heap.h&quot;
 #include &quot;MemObject.h&quot;
-#include &quot;SquidList.h&quot;
 #include &quot;Store.h&quot;
 #include &quot;store_heap_replacement.h&quot;
 #include &quot;wordlist.h&quot;
@@ -181,10 +180,12 @@
 
 /** RemovalPurgeWalker **/
 
-typedef struct _HeapPurgeData HeapPurgeData;
+class HeapPurgeData
+{
+public:
+    HeapPurgeData() : min_age(0.0) {}
 
-struct _HeapPurgeData {
-    link_list *locked_entries;
+    std::list&lt;StoreEntry *&gt; locked_entries;
     heap_key min_age;
 };
 
@@ -197,22 +198,18 @@
     StoreEntry *entry;
     heap_key age;
 
-try_again:
-
-    if (heap_empty(h-&gt;theHeap))
-        return NULL;        /* done */
-
-    age = heap_peepminkey(h-&gt;theHeap);
-
-    entry = (StoreEntry *)heap_extractmin(h-&gt;theHeap);
-
-    if (entry-&gt;locked()) {
-
-        entry-&gt;lock(&quot;heap_purgeNext&quot;);
-        linklistPush(&amp;heap_walker-&gt;locked_entries, entry);
-
-        goto try_again;
-    }
+    do {
+        if (heap_empty(h-&gt;theHeap))
+            return nullptr;
+
+        age = heap_peepminkey(h-&gt;theHeap);
+        entry = (StoreEntry *)heap_extractmin(h-&gt;theHeap);
+
+        if (entry-&gt;locked()) {
+            entry-&gt;lock(&quot;heap_purgeNext&quot;);
+            heap_walker-&gt;locked_entries.push_back(entry);
+        }
+    } while (entry-&gt;locked());
 
     heap_walker-&gt;min_age = age;
     h-&gt;setPolicyNode(entry, NULL);
@@ -225,7 +222,6 @@
     HeapPurgeData *heap_walker = (HeapPurgeData *)walker-&gt;_data;
     RemovalPolicy *policy = walker-&gt;_policy;
     HeapPolicyData *h = (HeapPolicyData *)policy-&gt;_data;
-    StoreEntry *entry;
     assert(strcmp(policy-&gt;_type, &quot;heap&quot;) == 0);
     assert(h-&gt;nwalkers &gt; 0);
     h-&gt;nwalkers -= 1;
@@ -235,13 +231,12 @@
         debugs(81, 3, &quot;Heap age set to &quot; &lt;&lt; h-&gt;theHeap-&gt;age);
     }
 
-    /*
-     * Reinsert the locked entries
-     */
-    while ((entry = (StoreEntry *)linklistShift(&amp;heap_walker-&gt;locked_entries))) {
+    // Reinsert the locked entries
+    while (StoreEntry *entry = heap_walker-&gt;locked_entries.front()) {
         heap_node *node = heap_insert(h-&gt;theHeap, entry);
         h-&gt;setPolicyNode(entry, node);
         entry-&gt;unlock(&quot;heap_purgeDone&quot;);
+        heap_walker-&gt;locked_entries.pop_front();
     }
 
     safe_free(walker-&gt;_data);
@@ -253,14 +248,10 @@
 {
     HeapPolicyData *h = (HeapPolicyData *)policy-&gt;_data;
     RemovalPurgeWalker *walker;
-    HeapPurgeData *heap_walk;
     h-&gt;nwalkers += 1;
     walker = new RemovalPurgeWalker;
-    heap_walk = (HeapPurgeData *)xcalloc(1, sizeof(*heap_walk));
-    heap_walk-&gt;min_age = 0.0;
-    heap_walk-&gt;locked_entries = NULL;
     walker-&gt;_policy = policy;
-    walker-&gt;_data = heap_walk;
+    walker-&gt;_data = new HeapPurgeData;
     walker-&gt;max_scan = max_scan;
     walker-&gt;Next = heap_purgeNext;
     walker-&gt;Done = heap_purgeDone;

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005612.html">[squid-dev] [PATCH] PeerConnector shuffling to libsecurity
</A></li>
	<LI>Next message: <A HREF="005614.html">[squid-dev] [PATCH] Remove SquidList / link_list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5597">[ date ]</a>
              <a href="thread.html#5597">[ thread ]</a>
              <a href="subject.html#5597">[ subject ]</a>
              <a href="author.html#5597">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
