<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] PeerConnector shuffling to libsecurity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PeerConnector%20shuffling%20to%20libsecurity&In-Reply-To=%3C570FD31D.4050407%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005596.html">
   <LINK REL="Next"  HREF="005612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] PeerConnector shuffling to libsecurity</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20PeerConnector%20shuffling%20to%20libsecurity&In-Reply-To=%3C570FD31D.4050407%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] PeerConnector shuffling to libsecurity">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Apr 14 17:27:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005596.html">[squid-dev] [PATCH] PeerConnector shuffling to libsecurity
</A></li>
        <LI>Next message: <A HREF="005612.html">[squid-dev] [PATCH] PeerConnector shuffling to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5599">[ date ]</a>
              <a href="thread.html#5599">[ thread ]</a>
              <a href="subject.html#5599">[ subject ]</a>
              <a href="author.html#5599">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/14/2016 06:23 AM, Amos Jeffries wrote:
&gt;<i> This patch shuffles the Ssl::PeerConnector to Security::TlsPeerEncryptor
</I>&gt;<i> and Ssl::BlindPeerConnector to Security::BlindTlsPeerEncryptor.
</I>
I have already given up on fighting you about pointless and inconsistent
SSL/TLS/Security renames, but please at least do not nest layers until
we actually need that nesting: Use either Security::PeerEncryptor or
TlsPeerEncryptor, not Security::TlsPeerEncryptor. I recommend
Security::PeerEncryptor because the API users do not care much about the
protocol being used.


&gt;<i> +#elif USE_GNUTLS
</I>&gt;<i> +    // XXX: no GnuTLS support for cert validation helper yet
</I>&gt;<i> +#endif
</I>...
&gt;<i> +#elif USE_GNUTLS
</I>&gt;<i> +        // TODO
</I>&gt;<i> +#endif
</I>...

I object to ongoing pollution of innocent code with USE_GNUTLS that
cannot be used: Having to deal with USE_OPENSSL is bad enough. Please do
not quadruple the problem by adding [unused] #USE_GNUTLS everywhere!

&gt;<i> +#if USE_OPENSSL
</I>&gt;<i>      if (serverConnection()-&gt;getPeer() &amp;&amp; !SSL_session_reused(ssl)) {
</I>...
&gt;<i> +#elif USE_GNUTLS
</I>&gt;<i> +    if (serverConnection()-&gt;getPeer() &amp;&amp; !gnutls_session_is_resumed(ssl)) {
</I>&gt;<i> +#endif
</I>
The above is just one of many examples of how GnuTLS support should
_not_ be introduced. The above code should look like this:

  if (serverConnection()-&gt;getPeer() &amp;&amp; ssl-&gt;resumedSession())
    ...

or, at the very least, like this:

  if (serverConnection()-&gt;getPeer() &amp;&amp; !session_is_resumed(ssl))
    ...

No duplication of logic, no constant thinking of what API each library
uses, no #ifdefs, and no invasive predictions about what GnuTLS code
will need when GnuTLS support is actually added. If you are not ready to
add GnuTLS support the right way, please do not add GnuTLS support at all!

The &quot;wrong way to move towards GnuTLS support&quot; problem discussed above
is the biggest problem with the proposed patch that I can see. Please do
not commit until that problem is resolved.


&gt;<i> This shuffling is a required step to simplify converting the basic TLS
</I>&gt;<i> I/O logic to libsecurity and for GnuTLS to actually begin adding useful
</I>&gt;<i> implementation bits.
</I>
This required step was done in the wrong direction IMO: The proposed
patch adds a dozen new &quot;#if USE_&quot;s. If we are moving &quot;basic TLS I/O
logic to libsecurity&quot;, then we should be reducing the number of ifdefs,
not increasing them. Is this is a necessary pain to see some beautiful
results in the future? Should not we wait with the pain until that
future becomes a reality so that we can judge whether it is worth the pain?



&gt;<i> -#if USE_OPENSSL
</I>&gt;<i> -    /// Gives PeerConnector access to Answer in the TunnelStateData callback dialer.
</I>&gt;<i> -    class MyAnswerDialer: public CallDialer, public Ssl::PeerConnector::CbDialer
</I>&gt;<i> +#if USE_OPENSSL || USE_GNUTLS
</I>&gt;<i> +    /// Gives Securit::TlsPeerEncryptor access to Answer in the TunnelStateData callback dialer.
</I>&gt;<i> +    class MyAnswerDialer: public CallDialer, public Security::TlsPeerEncryptor::CbDialer
</I>
I understand why MyAnswerDialer was wrapped in USE_OPENSSL before -- it
was using an Ssl::PeerConnector, and stuff in src/ssl/ is not generic.
However, now, it is using Security::TlsPeerEncryptor and src/security
API is supposed to be OpenSSL-neutral. Can we remove USE_OPENSSL from
this (and possibly some other) tunnel.cc parts now instead of adding
USE_GNUTLS?


&gt;<i> -class IcapPeerConnector: public PeerConnector {
</I>&gt;<i> +class IcapPeerConnector: public Security::TlsPeerEncryptor {
</I>
Why was not this class renamed as well?


&gt;<i> -Ssl::CreateClient(Security::ContextPtr sslContext, const int fd, const char *squidCtx)
</I>&gt;<i> -{
</I>&gt;<i> -    return SslCreate(sslContext, fd, Ssl::Bio::BIO_TO_SERVER, squidCtx);
</I>&gt;<i> -}
</I>
That function seemed like a perfect pair for the CreateServer() which
you did not remove. Why introduce such inconsistency and bother callers
with such ugly details as BIO_TO_SERVER constants?


&gt;<i> -               theName.termedBuf(),static_cast&lt;int64_t&gt;(theSize), xstrerr(savedError));
</I>&gt;<i> +               theName.termedBuf(), static_cast&lt;int64_t&gt;(theSize), xstrerr(savedError));
</I>
Out-of-scope formatting change.


&gt;<i> -    if (!Comm::IsConnOpen(serverConnection()) || fd_table[serverConnection()-&gt;fd].closing())
</I>&gt;<i> +    if (!Comm::IsConnOpen(serverConnection()))
</I>
Out-of-scope optimization(?) change.

&gt;<i> -    if (request != NULL)
</I>&gt;<i> +    if (request)
</I>
Out-of-scope code style change.


There may be more out-of-scope changes; I stopped looking.


Alex.

</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005596.html">[squid-dev] [PATCH] PeerConnector shuffling to libsecurity
</A></li>
	<LI>Next message: <A HREF="005612.html">[squid-dev] [PATCH] PeerConnector shuffling to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5599">[ date ]</a>
              <a href="thread.html#5599">[ thread ]</a>
              <a href="subject.html#5599">[ subject ]</a>
              <a href="author.html#5599">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
