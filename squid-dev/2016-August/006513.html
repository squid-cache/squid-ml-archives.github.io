<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] GnuTLS session redo
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20GnuTLS%20session%20redo&In-Reply-To=%3C57A4DCD3.40208%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006516.html">
   <LINK REL="Next"  HREF="006514.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] GnuTLS session redo</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20GnuTLS%20session%20redo&In-Reply-To=%3C57A4DCD3.40208%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] GnuTLS session redo">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug  5 18:37:07 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006516.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
        <LI>Next message: <A HREF="006514.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6513">[ date ]</a>
              <a href="thread.html#6513">[ thread ]</a>
              <a href="subject.html#6513">[ subject ]</a>
              <a href="author.html#6513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/03/2016 11:57 PM, Amos Jeffries wrote:
&gt;<i> +Security::SetSessionResumeData(const Security::SessionPointer &amp;s, const Security::SessionStatePointer &amp;data)
</I>&gt;<i> +{
</I>&gt;<i> +    if (data) {
</I>&gt;<i> +#if USE_OPENSSL
</I>&gt;<i> +        (void)SSL_set_session(s.get(), data.get());
</I>&gt;<i> +#elif USE_GNUTLS
</I>&gt;<i> +        (void)gnutls_session_set_data(s.get(), data-&gt;data, data-&gt;size);
</I>&gt;<i> +#endif
</I>&gt;<i> +    }
</I>&gt;<i> +}
</I>
Why cast to (void) here? The current code does not do that AFAICT.
Casting the result to (void) usually means

* I know this may fail, but I do not care.

It should be accompanied by a comment that explains why we do not care,
unless the code makes it obvious (the patched code does not).


Not casting may mean many things, including:

* It returns void.
* I did not even think about it.
* I know it may fail, but I either do not know how to handle its failure
or just do not have the time to handle it.

AFAICT, in this particular case, the current code probably matches one
of the last two bullets. If I am right, then there are two correct ways
to deal with it IMO:

1. Return a boolean success/failure result.
   The caller will still ignore the result.

2. Remove &quot;(void)&quot;. Ideally, add a &quot;// TODO: throw on failures&quot; comment.

My weak recommendation is for #2.


&gt;<i> +Security::SessionIsResumed(const Security::SessionPointer &amp;s)
</I>&gt;<i> +{
</I>&gt;<i> +    return
</I>&gt;<i> +#if USE_OPENSSL
</I>&gt;<i> +        SSL_session_reused(s.get()) == 1;
</I>&gt;<i> +#elif USE_GNUTLS
</I>&gt;<i> +        gnutls_session_is_resumed(s.get()) != 0;
</I>&gt;<i> +#else
</I>&gt;<i> +        false;
</I>&gt;<i> +#endif
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> +void
</I>&gt;<i> +Security::GetSessionResumeData(const Security::SessionPointer &amp;s, Security::SessionStatePointer &amp;data)
</I>&gt;<i> +{
</I>&gt;<i> +    if (!SessionIsResumed(s)) {
</I>&gt;<i> +#if USE_OPENSSL
</I>&gt;<i> +        data.reset(SSL_get1_session(s.get()));
</I>&gt;<i> +#elif USE_GNUTLS
</I>&gt;<i> +        gnutls_datum_t *tmp = nullptr;
</I>&gt;<i> +        (void)gnutls_session_get_data2(s.get(), tmp);
</I>&gt;<i> +        data.reset(tmp);
</I>&gt;<i> +#endif
</I>&gt;<i> +    }
</I>&gt;<i> +}
</I>
Can we establish some rules for when to use &quot;#else&quot; in
OpenSSL/GnuTLS/Security contexts? The inconsistency illustrated above is
a red flag. I do not think &quot;use #else if it is needed to compile&quot; is the
rule used for the above code because Security::GetSessionResumeData()
may produce an &quot;unused parameter 'data'&quot; warning, killing the build.


&gt;<i> +/// Retrieve the data needed to resume this session on a later connection
</I>&gt;<i> +void GetSessionResumeData(const Security::SessionPointer &amp;, Security::SessionStatePointer &amp;);
</I>
&gt;<i> +void
</I>&gt;<i> +Security::GetSessionResumeData(const Security::SessionPointer &amp;s, Security::SessionStatePointer &amp;data)
</I>&gt;<i> +{
</I>&gt;<i> +    if (!SessionIsResumed(s)) {
</I>
The implementation does not seem to match the description. The
implementation matches the current code, but the description says
nothing about !SessionIsResumed() precondition. Please either change
description and rename OR test the precondition in the callers,
whichever you think is better long-term.


Thank you,

Alex.

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006516.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
	<LI>Next message: <A HREF="006514.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6513">[ date ]</a>
              <a href="thread.html#6513">[ thread ]</a>
              <a href="subject.html#6513">[ subject ]</a>
              <a href="author.html#6513">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
