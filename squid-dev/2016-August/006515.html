<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] GnuTLS session redo
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20GnuTLS%20session%20redo&In-Reply-To=%3C57A507F5.4060806%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006514.html">
   <LINK REL="Next"  HREF="006528.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] GnuTLS session redo</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20GnuTLS%20session%20redo&In-Reply-To=%3C57A507F5.4060806%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] GnuTLS session redo">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug  5 21:41:09 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006514.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
        <LI>Next message: <A HREF="006528.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6515">[ date ]</a>
              <a href="thread.html#6515">[ thread ]</a>
              <a href="subject.html#6515">[ subject ]</a>
              <a href="author.html#6515">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/05/2016 02:13 PM, Amos Jeffries wrote:
&gt;<i> On 6/08/2016 6:37 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 08/03/2016 11:57 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> +Security::SetSessionResumeData(const Security::SessionPointer &amp;s, const Security::SessionStatePointer &amp;data)
</I>&gt;&gt;&gt;<i> +{
</I>&gt;&gt;&gt;<i> +    if (data) {
</I>&gt;&gt;&gt;<i> +#if USE_OPENSSL
</I>&gt;&gt;&gt;<i> +        (void)SSL_set_session(s.get(), data.get());
</I>&gt;&gt;&gt;<i> +#elif USE_GNUTLS
</I>&gt;&gt;&gt;<i> +        (void)gnutls_session_set_data(s.get(), data-&gt;data, data-&gt;size);
</I>&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;<i> +    }
</I>&gt;&gt;&gt;<i> +}
</I>

&gt;&gt;<i> Why cast to (void) here? The current code does not do that AFAICT.
</I>&gt;&gt;<i> Casting the result to (void) usually means
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * I know this may fail, but I do not care.
</I>
&gt;&gt;<i> It should be accompanied by a comment that explains why we do not care,
</I>&gt;&gt;<i> unless the code makes it obvious (the patched code does not).
</I>

&gt;<i> Failures there just mean a clean new session is used.
</I>
I do not think SSL_set_session() fails when &quot;a clean new session is
used&quot; but perhaps I am misinterpreting what you mean by that.

If you meant that an SSL_set_session() failure is not important because
a new session will be eventually created instead of the old one being
reused, then I agree regarding what will happen but disagree regarding
that failure unimportance. Session reuse is very important in some
environments, so the proposed &quot;I do not care why it did not happen&quot; is
the wrong approach. We do care, at least for triage/debugging purposes.

That kind of logic would be very similar to saying &quot;I do not care that
nothing gets cached due to a failed disk -- the users will get their
responses from the origin server instead&quot;. While they will indeed, we
still do care as far as stats/logging/debugging are concerned.


&gt;<i> I dont see any reason to throw. Resume is just a speed optimization for TLS.
</I>
We should throw if the callers need to know about the failure. We should
not throw if the callers do not care about the failure. Resume being an
optional optimization is irrelevant in this particular decision --
either the callers have some cleanup/setup/debugging code to accompany
this call or they do not.


&gt;&gt;&gt;<i> +Security::SessionIsResumed(const Security::SessionPointer &amp;s)
</I>&gt;&gt;&gt;<i> +{
</I>&gt;&gt;&gt;<i> +    return
</I>&gt;&gt;&gt;<i> +#if USE_OPENSSL
</I>&gt;&gt;&gt;<i> +        SSL_session_reused(s.get()) == 1;
</I>&gt;&gt;&gt;<i> +#elif USE_GNUTLS
</I>&gt;&gt;&gt;<i> +        gnutls_session_is_resumed(s.get()) != 0;
</I>&gt;&gt;&gt;<i> +#else
</I>&gt;&gt;&gt;<i> +        false;
</I>&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;<i> +}
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +void
</I>&gt;&gt;&gt;<i> +Security::GetSessionResumeData(const Security::SessionPointer &amp;s, Security::SessionStatePointer &amp;data)
</I>&gt;&gt;&gt;<i> +{
</I>&gt;&gt;&gt;<i> +    if (!SessionIsResumed(s)) {
</I>&gt;&gt;&gt;<i> +#if USE_OPENSSL
</I>&gt;&gt;&gt;<i> +        data.reset(SSL_get1_session(s.get()));
</I>&gt;&gt;&gt;<i> +#elif USE_GNUTLS
</I>&gt;&gt;&gt;<i> +        gnutls_datum_t *tmp = nullptr;
</I>&gt;&gt;&gt;<i> +        (void)gnutls_session_get_data2(s.get(), tmp);
</I>&gt;&gt;&gt;<i> +        data.reset(tmp);
</I>&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;<i> +    }
</I>&gt;&gt;&gt;<i> +}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can we establish some rules for when to use &quot;#else&quot; in
</I>&gt;&gt;<i> OpenSSL/GnuTLS/Security contexts?
</I>
&gt;<i> Sure. So far I've been trying to only add #else when there was some
</I>&gt;<i> meaningful code that needed to be done in those builds.
</I>
Not sure I understand the rule you are proposing (if you are proposing a
rule). Can you detail/rephrase it? Please keep the following two
questions in mind when doing so:

1. What are these rules trying to guarantee or accomplish?
   In other words, what will happen if we [do not] follow them?

2. If I see no &quot;#else&quot; (or no &quot;#elif&quot;), what does that mean?
   * We have not checked yet. It may not run or even compile.
   * We know it compiles (and runs?) without #else (or #elif).
   * Something should go there but we have not figured out what yet.
   * We know that nothing should go there; all callers will be fine.
   Etc.


&gt;<i> Usually it is for a default return statement or setting up error results
</I>&gt;<i> indicating the related TLS/SSL feature not working. 
</I>
Should the &quot;default return statement&quot; always indicate an error of some
sort? If not, how to know when to implement the default success route
(your first reason) and when to set up an error (your second reason)?


&gt;<i> Code that is only
</I>&gt;<i> run when the feature being used usually does not need #else.
</I>
Without a good set of rules, this gets messy very quickly IMO. For
example, your own GetSessionResumeData() does not reset the data
parameter in the [absent] #else case but does unconditionally reset it
(possibly to a nil value) in other cases. Is this a bug waiting to
happen, and intended side effect, or both? Without rules, it is
difficult to say for sure.


&gt;<i> I've built this with the full set of build layers. 
</I>
This is not simply a build matter IMO.


&gt;<i> /// Retrieve the data needed to resume this session on a later connection
</I>&gt;<i> /// if it was not itself resumed from earlier details
</I>&gt;<i> void MaybeGetSessionResumeData(...)
</I>
We should say what happens if &quot;it was itself resumed&quot;. The current
&quot;leave data pointer intact&quot; logic looks very strange to me, but I cannot
tell whether this is a bug in the existing code (that you do not have to
fix, but can expose by adding XXX to your documentation) or intended
[but difficult to understand] behavior.


&gt;<i> Since this is all cosmetic, is/was any testing able to happen on your part?
</I>
The rules decisions we should make here are as far from cosmetic
polishing as they get IMO. The understanding of GetSessionResumeData()
side effects may not be cosmetic either.

As for testing, I cannot volunteer for that at this time. And given the
sad state of Squid automated QA, my testing with OpenSSL (or GnuTLS)
would be about as good as what you can do anyway.


Cheers,

Alex.

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006514.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
	<LI>Next message: <A HREF="006528.html">[squid-dev] [PATCH] GnuTLS session redo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6515">[ date ]</a>
              <a href="thread.html#6515">[ thread ]</a>
              <a href="subject.html#6515">[ subject ]</a>
              <a href="author.html#6515">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
