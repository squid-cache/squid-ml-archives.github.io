<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Revalidate without Last-Modified
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Revalidate%20without%20Last-Modified&In-Reply-To=%3Cc60ea54d-1056-03b4-ae23-184d2c64f559%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006605.html">
   <LINK REL="Next"  HREF="006612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Revalidate without Last-Modified</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Revalidate%20without%20Last-Modified&In-Reply-To=%3Cc60ea54d-1056-03b4-ae23-184d2c64f559%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Revalidate without Last-Modified">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Aug 21 12:58:14 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006605.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
        <LI>Next message: <A HREF="006612.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6606">[ date ]</a>
              <a href="thread.html#6606">[ thread ]</a>
              <a href="subject.html#6606">[ subject ]</a>
              <a href="author.html#6606">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/08/2016 9:08 a.m., Eduard Bagdasaryan wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> This patch fixes bug 4471.
</I>&gt;<i> 
</I>&gt;<i> The bug was caused by the fact that Squid used only Last-Modified header
</I>&gt;<i> value for evaluating entry's last modification time while making an
</I>&gt;<i> internal revalidation request. So, without Last-Modified it was not
</I>&gt;<i> possible to correctly fill If-Modified-Since header value. As a result,
</I>&gt;<i> the revalidation request was not initiated when it should be.
</I>&gt;<i> 
</I>&gt;<i> To fix this problem, we should generate If-Modified-Since based on other
</I>&gt;<i> data, showing how &quot;old&quot; the cached response is, such as Date and Age
</I>&gt;<i> header values.  Both Date and Age header values are utilized while
</I>&gt;<i> calculating entry's timestamp.  Therefore, we could use the timestamp if
</I>&gt;<i> Last-Modified is unavailable.
</I>&gt;<i> 
</I>&gt;<i> XXX: HttpRequest::imslen support looks broken/deprecated. Using this
</I>&gt;<i> field inside StoreEntry::modifiedSince() leads to several useless checks
</I>&gt;<i> and probably may cause other [hidden] problems.
</I>&gt;<i> 
</I>
Thanks for this.

In src/Store.h:

* please dont move the StoreEntry 'lastmod' member variable which exists
between the &quot;ON-DISK STORE_META_STD TLV field&quot; marker comments.

 - To change anything between those markers we have to do a full cache
versioning and up/down-grade compatibility dance. I think its best to
keep all that trouble separate from this patch.
 - for now just document it with a comment saying how it should to be
set instead of by assignment.


in src/store.cc:

* lastModifiedDelta() returning -1 when the actual delta is any -N value
is wrong conceptually.
 - A delta should be the actual difference value -N &lt; 0 &lt; +N.
 - I've not had time right now to check how fixing that affects the
caller logic though. That check will need doing before any commit so we
can either produce proper delta's or comment why they get truncated to
-1 in half the cases.


in src/client_side_reply.cc:

* please take the opportunity to cleanup any touched debugs() messages.
Like this one:
 debugs(88, 5, &quot;clientReplyContext::processExpired : lastmod &quot; &lt;&lt;
entry-&gt;lastModified() );

should be:
 debugs(88, 5, &quot;lastmod &quot; &lt;&lt; entry-&gt;lastModified());

- note function name and whitespace before ending bracket are gone.

* for the hunk @@ -587 where it says &quot;cannot revalidate entries without
timestamp or Last-Modified header&quot;
 - please add a note &quot;XXX BUG 1890 objects without Date do not get one
added&quot;. I think when that compliance bug is fixed an effective-LM
will/should always be found.

Cheers
Amos

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006605.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
	<LI>Next message: <A HREF="006612.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6606">[ date ]</a>
              <a href="thread.html#6606">[ thread ]</a>
              <a href="subject.html#6606">[ subject ]</a>
              <a href="author.html#6606">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
