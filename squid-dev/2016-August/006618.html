<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Revalidate without Last-Modified
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Revalidate%20without%20Last-Modified&In-Reply-To=%3C1dd0edee-823e-4bcc-f94c-50f4d5c1e393%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006617.html">
   <LINK REL="Next"  HREF="006628.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Revalidate without Last-Modified</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Revalidate%20without%20Last-Modified&In-Reply-To=%3C1dd0edee-823e-4bcc-f94c-50f4d5c1e393%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Revalidate without Last-Modified">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Aug 23 15:53:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006617.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
        <LI>Next message: <A HREF="006628.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6618">[ date ]</a>
              <a href="thread.html#6618">[ thread ]</a>
              <a href="subject.html#6618">[ subject ]</a>
              <a href="author.html#6618">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/23/2016 09:17 AM, Amos Jeffries wrote:
&gt;<i> On 24/08/2016 12:07 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;<i> 2016-08-21 15:58 GMT+03:00 Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt;:
</I>&gt;&gt;&gt;<i> To change anything between those markers we have to do a full cache
</I>&gt;&gt;&gt;<i> versioning and up/down-grade compatibility dance.
</I>
&gt;&gt;<i> Could you please clarify what versioning problems you are talking
</I>&gt;&gt;<i> about?
</I>
&gt;<i> I was referring to that block of members being read and written
</I>&gt;<i> directly to cache files. Either swap.state or the object metadata section.
</I>&gt;<i> I dont think they are referenced individully, but as a raw-pointer to
</I>&gt;<i> the first members address cast to some other identically laid out
</I>&gt;<i> StoreMeta* type (yucky).
</I>

Yes, this happens in at least two places:

&gt;<i> bzr grep timestamp src | fgrep \&amp;
</I>...
&gt;<i> src/store_rebuild.cc:            memcpy(&amp;what-&gt;timestamp, x.value, STORE_HDR_METASIZE);
</I>&gt;<i> src/store_swapmeta.cc:    t = StoreMeta::Factory(STORE_META_STD_LFS,STORE_HDR_METASIZE,&amp;e-&gt;timestamp)
</I>

&gt;<i> The point of those comments AFAIK is to make it obvious that kind of
</I>&gt;<i> this is/was being done with them and prevent us doing what you did.
</I>
Agreed. Since improving this code is way outside this simple fix scope,
I recommend returning the renamed lastmod data member into that &quot;keep
them together&quot; section, with a comment:

time_t lastmod_; ///&lt; received Last-Modified value or -1; treat as private

Please note that &quot;received Last-Modified value or -1&quot; is just my guess
what lastmod_ is -- use the right description if my guess is wrong.

Renaming lastmod (and temporary making it private) already forced you to
check and, if needed, adjust most of the old code using that data
member. Keeping lastmod_ public is not ideal, but it does not make
things worse and allows you to stay focused. Fixing related problems is
only a good idea when those fixes are simple and do not stray you off
course too much.


HTH,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006617.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
	<LI>Next message: <A HREF="006628.html">[squid-dev] [PATCH] Revalidate without Last-Modified
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6618">[ date ]</a>
              <a href="thread.html#6618">[ thread ]</a>
              <a href="subject.html#6618">[ subject ]</a>
              <a href="author.html#6618">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
