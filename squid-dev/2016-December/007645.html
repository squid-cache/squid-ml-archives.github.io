<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] IPv6 NDP lookups
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20IPv6%20NDP%20lookups&In-Reply-To=%3Cb918b3be-a90f-ca6b-1885-cb204358a6f9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007618.html">
   <LINK REL="Next"  HREF="007622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] IPv6 NDP lookups</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20IPv6%20NDP%20lookups&In-Reply-To=%3Cb918b3be-a90f-ca6b-1885-cb204358a6f9%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] IPv6 NDP lookups">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec 23 05:49:08 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007618.html">[squid-dev] [PATCH] IPv6 NDP lookups
</A></li>
        <LI>Next message: <A HREF="007622.html">[squid-dev] Jenkins build is back to normal : 5-matrix » gcc,d-ubuntu-trusty #44
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7645">[ date ]</a>
              <a href="thread.html#7645">[ thread ]</a>
              <a href="subject.html#7645">[ subject ]</a>
              <a href="author.html#7645">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/12/2016 1:42 a.m., Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> The attached patch is against Squid 3.5.  Given Squid 3.5's status as a
</I>&gt;<i> stable release, this probably won't be integrated into the vanilla Squid
</I>&gt;<i> release, but I'm posting here in case anyone finds it useful, or if
</I>&gt;<i> someone wants to port it to Squid 4.
</I>&gt;<i> 
</I>
Yay. Thank you.

&gt;<i> 
</I>&gt;<i> Squid currently supports ACLs and logformat specifiers which rely on the
</I>&gt;<i> EUI-48 (MAC address) for IPv4 traffic, and EUI-64 for IPv6 traffic.
</I>&gt;<i> 
</I>&gt;<i> For IPv4, Squid queries the ARP cache for the client's address.  For
</I>&gt;<i> IPv6, Squid extracts the EUI-64 from site-local SLAAC addresses.  This
</I>&gt;<i> isn't going to work for most clients, since site-local addresses are
</I>&gt;<i> rarely used in the real world.  This patch brings the IPv6 functionality
</I>&gt;<i> in line with the IPv4 functionality by querying the neighbour table
</I>&gt;<i> using rtnetlink.
</I>&gt;<i> 
</I>&gt;<i> Open question: we could also pull the EUI-64 from a global scope SLAAC
</I>&gt;<i> address.  Would it be trustworthy enough?  Is it worth doing?  Since
</I>&gt;<i> most clients now use privacy extensions it's probably not worthwhile.
</I>&gt;<i> 
</I>
I considered it at the time. But so far it has not been worth doing. At
least nobody has mentioned wanting to do it over the global spaces.


&gt;<i> 
</I>&gt;<i> Notes:
</I>&gt;<i> 
</I>&gt;<i> - We have to examine the entire neighbour table since (as far as I can
</I>&gt;<i> tell) the kernel doesn't allow querying a specific IP address.  This
</I>&gt;<i> could be slow if there are a lot of neighbours.
</I>&gt;<i> 
</I>&gt;<i> - The IPv4 neighbour table can be retrieved in the same way, so there is
</I>&gt;<i> scope for unifying the IPv6 and IPv4 code.
</I>&gt;<i> 
</I>&gt;<i> - The neighbour table contains MAC addresses (i.e. EUI-48), not EUI-64
</I>&gt;<i> addresses.  This patch converts the retrieved EUI-48 into an EUI-64 by
</I>&gt;<i> inserting 0xfffe into the middle.
</I>&gt;<i> 
</I>&gt;<i> - If the IPv4/IPv6 code is to be unified in the future, consider
</I>&gt;<i> converting everything to EUI-64 instead of making a distinction between
</I>&gt;<i> EUI-48 and EUI-64.
</I>&gt;<i> 
</I>&gt;<i> - This code is useful where users are being authenticated through a
</I>&gt;<i> mechanism other than HTTP proxy auth.  For example, a client can
</I>&gt;<i> identify itself through a captive portal, but then use a combination of
</I>&gt;<i> IPv4 and numerous IPv6 addresses (due to privacy extensions) thereafter.
</I>&gt;<i>  The client can be linked back to their portal login through their MAC,
</I>&gt;<i> irrespective of the IP address they are using for any given request.
</I>&gt;<i> 
</I>&gt;<i> - Obviously the client needs to be on the same layer 2 network as Squid,
</I>&gt;<i> so this doesn't help in situations where clients are behind a router.
</I>&gt;<i> 
</I>

Some design things:

* do we really have to open a new rtnetlink_sock on each lookup? or can
we keep that connection open and send multiple requests over it?
 - if we can keep it open, use a static function to do the opening and
create a Runner + comm close handler for closing it.
  + the test 'if (rtnetlink_sock &lt; 0)' should return false immediately.
    that will remove one level of indent.

 - please call fd_note(rtnetlink_sock, &quot;NDP lookup socket&quot;) after
opening it to record what the socket FD is/was used for.


* are these netlink structs and macros generically available on all
Linux systems? I suspect not,
 - the code blocks wrapper #if condition may need to include the
HAVE_FOO_H macros relevant for the netlink .h file(s) required.


* for the 'req' structure, is there an rtnetlink header defined type we
can use instead of defining our own 'custom' packet structure?


* the buf array can be made a static to reduce stack allocations
 - why is buf 16K? please document what decision was made to get that
number. arbitrary value is fine, but we need to have a record in case
something changes years from now.


* both variables found_ip and success are being used to mean the success
case.
 - found_ip can be reset to false after that inner for loop if !mac_ptr.
That will leave it with identical value to success in all cases after
the while-loop finishes.


And some code polish:

* please replace all '(! done)' with just '!done'

* you have added a comment documenting what the while is looping over,
please do the same for the two internal for loops.

* use true/false keywords to initialize the bool variables instead of
0/1 constants.

* please move variables from the top of the code block down to their
scope or time of first use. This is C++.

* also please use C++ casting if it cannot be dropped entirely.

* the debugs() at the end of the code block should be printed in all
cases, just a with a (success? &quot;found&quot;:&quot;fail&quot;) dynamic line portion to
say what the result was.


NP: whoever applies this patch will need to run the maintenance script
first to cleanup a bunch of line wrappings and other whitespace stuff.

Amos

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007618.html">[squid-dev] [PATCH] IPv6 NDP lookups
</A></li>
	<LI>Next message: <A HREF="007622.html">[squid-dev] Jenkins build is back to normal : 5-matrix » gcc,d-ubuntu-trusty #44
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7645">[ date ]</a>
              <a href="thread.html#7645">[ thread ]</a>
              <a href="subject.html#7645">[ subject ]</a>
              <a href="author.html#7645">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
