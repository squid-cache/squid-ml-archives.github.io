<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Security::SessionPointer and	Security::LockingPointer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Security%3A%3ASessionPointer%20and%0A%09Security%3A%3ALockingPointer&In-Reply-To=%3C56BA2258.2060502%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005099.html">
   <LINK REL="Next"  HREF="005107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Security::SessionPointer and	Security::LockingPointer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Security%3A%3ASessionPointer%20and%0A%09Security%3A%3ALockingPointer&In-Reply-To=%3C56BA2258.2060502%40treenet.co.nz%3E"
       TITLE="[squid-dev] Security::SessionPointer and	Security::LockingPointer">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Feb  9 17:31:04 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005099.html">[squid-dev] Security::SessionPointer and Security::LockingPointer
</A></li>
        <LI>Next message: <A HREF="005107.html">[squid-dev] Security::SessionPointer and	Security::LockingPointer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5102">[ date ]</a>
              <a href="thread.html#5102">[ thread ]</a>
              <a href="subject.html#5102">[ subject ]</a>
              <a href="author.html#5102">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/02/2016 5:53 a.m., Christos Tsantilas wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> The short question:
</I>&gt;<i> The Security::SessionPointer is a TidyPointer. Is it acceptable to
</I>&gt;<i> convert it to a LockingPointer?
</I>
Only with a reliable reference counting/locking mechanism.

We get away with it on contexts only because contexts are anchored in
permanent globals (ie PortCfg list, ::Config etc) and the deinit()
function does its reference counting relative to active sessions when we
do a -k reconfigure change.

With session_t we dont have any lifesaving anchor and have to use a
slightly different free()-like call that risks totally releasing memory
too early.

I added the fd_table adjustment recently to get us a some stability
anchor, but its not enough to be fully lock-safe in relation to
outstanding Calls or connection close handlers. We still need the code
to pass around the Pointer&amp; instead of Ptr and avoid having more than
one Pointer for each session_t existing at any time.

&gt;<i> 
</I>&gt;<i> My sense is that the GnuTLS does not support locking pointers?
</I>&gt;<i> However I have an idea about how we can add locking support for
</I>&gt;<i> gnutls_session_t if required.
</I>&gt;<i> 
</I>
I have not been able to find any exposed refcount/locks we can use in
GnuTLS, and been procrastinating on contacting Nikos about it. GnuTLS
seems to handle threads and SMP internally well enough. But not async
events like our Calls.

I am *very* interested in that locking idea of yours.


&gt;<i>   The Security::SessionPointer is the old Ssl::SSL_Pointer and used to
</I>&gt;<i> be a TidiPointer.
</I>
Yes.

&gt;<i> However while fixing the memory leak bug reported and analysed under the
</I>&gt;<i> &quot;[squid-dev] NotePairs, SSL and Cert Validation memory leaks&quot; mail
</I>&gt;<i> thread, I made a patch which converted this pointer to a LockingPointer.
</I>&gt;<i> 
</I>&gt;<i> If we can not convert it to locking pointer I need to reimplement the
</I>&gt;<i> patch. However using a locking pointer for SSL may help us in many other
</I>&gt;<i> cases too.
</I>&gt;<i> 
</I>
Yes I noticed that. What I've done as a halfway measure is to make the
API of both the Locking and TidyPointers identical. So as a last resort
we could make the OpenSSL one a LockingPointer and the GnuTLS a
TidyPointer. But that does not solve the leak issue for GnuTLS builds.

Amos

</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005099.html">[squid-dev] Security::SessionPointer and Security::LockingPointer
</A></li>
	<LI>Next message: <A HREF="005107.html">[squid-dev] Security::SessionPointer and	Security::LockingPointer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5102">[ date ]</a>
              <a href="thread.html#5102">[ thread ]</a>
              <a href="subject.html#5102">[ subject ]</a>
              <a href="author.html#5102">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
