<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shuffle%20SessionCacheRunner%20to%20libsecurity&In-Reply-To=%3C56BD4E0C.8080605%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005120.html">
   <LINK REL="Next"  HREF="005124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shuffle%20SessionCacheRunner%20to%20libsecurity&In-Reply-To=%3C56BD4E0C.8080605%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 12 03:14:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005120.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
        <LI>Next message: <A HREF="005124.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5123">[ date ]</a>
              <a href="thread.html#5123">[ thread ]</a>
              <a href="subject.html#5123">[ subject ]</a>
              <a href="author.html#5123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/02/2016 7:21 a.m., Alex Rousskov wrote:
&gt;<i> On 02/11/2016 10:20 AM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> One issue was uncovered during this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * While ssl/support.h was defining a destruct_session_cache() function
</I>&gt;&gt;<i> that appeared to release the cache memory, it was not actually being
</I>&gt;&gt;<i> used anywhere. Which unless a fortuitous sequence of events is happening
</I>&gt;&gt;<i> means that OpenSSL locks we create for the cache entries may not be
</I>&gt;&gt;<i> released properly. On the other hand the cache should only be erased on
</I>&gt;&gt;<i> shutdown so the effects of this are minor.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The unused function has been removed and the issue is now expicitly
</I>&gt;&gt;<i> noted in the Runner shutdown handling method.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> +SharedSessionCacheRr::~SharedSessionCacheRr()
</I>&gt;&gt;<i> +{
</I>&gt;&gt;<i> +#if 0
</I>&gt;&gt;<i> +    // XXX: the Ssl::SessionCache memory (if any) is leaked.
</I>&gt;&gt;<i> +    // at least technically. OpenSSL is never informed about this memory
</I>&gt;&gt;<i> +    // being no longer used and the bulk SHM chunk being released.
</I>&gt;&gt;<i> +    // Any locks it is holding for the sessions may stay set.
</I>&gt;&gt;<i> +//      delete Ssl::SessionCache;
</I>&gt;&gt;<i> +#endif
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +    delete owner;
</I>&gt;&gt;<i> +}
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Why not delete Ssl::SessionCache?
</I>&gt;<i> 
</I>&gt;<i> I am not intimately familiar with the specifics of the OpenSSL session
</I>&gt;<i> locks you are discussing, so I cannot comment about that aspect, but
</I>&gt;<i> after &quot;delete owner&quot; above, any Ssl::SessionCache memory that OpenSSL
</I>&gt;<i> might have been pointing at would be gone anyway and must not be
</I>&gt;<i> accessed, right?
</I>
Well. I hoped the XXX explained that. The cache is a SHM block of memory
- so far so good. but...

&gt;<i> 
</I>&gt;<i> AFAICT, Ssl::SessionCache itself does not know anything about OpenSSL
</I>&gt;<i> because it is just a [shared memory] key:opaque_value cache. With its
</I>&gt;<i> memory gone and no SessionCache--&gt;OpenSSL connection, it feels like
</I>&gt;<i> deleting SessionCache cannot make things worse (and will free a few
</I>&gt;<i> otherwise &quot;technically leaking&quot; Ipc::MemMap bytes that are not shared).
</I>

... using delete in kid1 would unset/nul/unlock all the Pointer in it
even if kid2/kid3 were still going to be active for a while. AFAIK the
SHM locking parts only ensure the SHM block itself (as a blob) remains
open, not the individual objects in it.

(we have the problem that mgr:shutdown can target individual workers.
and maybe exceptino handling will cycle one worker cleanly. So no
guarantees the current one shutting down means the others are too.)


To get around all that I think we will need an atomic counter in the
session cache which tells any kid how many other kids are currently
accessing that SHM block. But there may be a better way.

&gt;<i> 
</I>&gt;<i> I am guessing you have tried deleting Ssl::SessionCache and something
</I>&gt;<i> broke. What was it?
</I>&gt;<i> 
</I>
No. I chose to leave this bug-compatible with existing trunk, since I
cant test that change properly myself.

Amos

</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005120.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
	<LI>Next message: <A HREF="005124.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5123">[ date ]</a>
              <a href="thread.html#5123">[ thread ]</a>
              <a href="subject.html#5123">[ subject ]</a>
              <a href="author.html#5123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
