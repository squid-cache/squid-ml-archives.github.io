<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shuffle%20SessionCacheRunner%20to%20libsecurity&In-Reply-To=%3C56BD55F8.6060709%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005123.html">
   <LINK REL="Next"  HREF="005126.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shuffle%20SessionCacheRunner%20to%20libsecurity&In-Reply-To=%3C56BD55F8.6060709%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Feb 12 03:48:08 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005123.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
        <LI>Next message: <A HREF="005126.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5124">[ date ]</a>
              <a href="thread.html#5124">[ thread ]</a>
              <a href="subject.html#5124">[ subject ]</a>
              <a href="author.html#5124">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/11/2016 08:14 PM, Amos Jeffries wrote:
&gt;<i> On 12/02/2016 7:21 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 02/11/2016 10:20 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> One issue was uncovered during this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * While ssl/support.h was defining a destruct_session_cache() function
</I>&gt;&gt;&gt;<i> that appeared to release the cache memory, it was not actually being
</I>&gt;&gt;&gt;<i> used anywhere. Which unless a fortuitous sequence of events is happening
</I>&gt;&gt;&gt;<i> means that OpenSSL locks we create for the cache entries may not be
</I>&gt;&gt;&gt;<i> released properly. On the other hand the cache should only be erased on
</I>&gt;&gt;&gt;<i> shutdown so the effects of this are minor.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The unused function has been removed and the issue is now expicitly
</I>&gt;&gt;&gt;<i> noted in the Runner shutdown handling method.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> +SharedSessionCacheRr::~SharedSessionCacheRr()
</I>&gt;&gt;&gt;<i> +{
</I>&gt;&gt;&gt;<i> +#if 0
</I>&gt;&gt;&gt;<i> +    // XXX: the Ssl::SessionCache memory (if any) is leaked.
</I>&gt;&gt;&gt;<i> +    // at least technically. OpenSSL is never informed about this memory
</I>&gt;&gt;&gt;<i> +    // being no longer used and the bulk SHM chunk being released.
</I>&gt;&gt;&gt;<i> +    // Any locks it is holding for the sessions may stay set.
</I>&gt;&gt;&gt;<i> +//      delete Ssl::SessionCache;
</I>&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +    delete owner;
</I>&gt;&gt;&gt;<i> +}
</I>

&gt;&gt;<i> Why not delete Ssl::SessionCache?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am not intimately familiar with the specifics of the OpenSSL session
</I>&gt;&gt;<i> locks you are discussing, so I cannot comment about that aspect, but
</I>&gt;&gt;<i> after &quot;delete owner&quot; above, any Ssl::SessionCache memory that OpenSSL
</I>&gt;&gt;<i> might have been pointing at would be gone anyway and must not be
</I>&gt;&gt;<i> accessed, right?
</I>

&gt;<i> Well. I hoped the XXX explained that. The cache is a SHM block of memory
</I>
Sorry, the XXX comment did not help me understand. I _do_ know that the
cache is in shared memory, but the comment talks about things that do
not match my understanding of reality.


&gt;&gt;<i> AFAICT, Ssl::SessionCache itself does not know anything about OpenSSL
</I>&gt;&gt;<i> because it is just a [shared memory] key:opaque_value cache. With its
</I>&gt;&gt;<i> memory gone and no SessionCache--&gt;OpenSSL connection, it feels like
</I>&gt;&gt;<i> deleting SessionCache cannot make things worse (and will free a few
</I>&gt;&gt;<i> otherwise &quot;technically leaking&quot; Ipc::MemMap bytes that are not shared).
</I>

&gt;<i> ... using delete in kid1 would unset/nul/unlock all the Pointer in it
</I>
I do not follow. Ssl::SessionCache is Ipc::MemMap. Ipc::MemMap does not
know anything about OpenSSL. Deleting Ipc::MemMap cannot
unset/nul/unlock any OpenSSL pointers AFAICT.

Moreover, correctly deleting Ipc::MemMap in kid1 should have no effect
on IpcMemMap in other kids -- this is shared memory, and its users may
come and go at any time (by design!).


If your argument is that some OpenSSL structures somewhere are pointing
to the shared memory maintained by Ssl::SessionCache, then

(a) IIRC, deleting the memory owner (which we do!) ought to invalidate
that memory anyway, and

(b) please point me to those structures because I only see SessionCache
managing opaque blobs that OpenSSL either parses or writes to within the
scope of a given function call -- no long-term sharing of that opaque
data area with the rest of Squid.


Again, I am not intimate with that area of the code, so please correct
me if I am wrong.



&gt;<i> To get around all that I think we will need an atomic counter in the
</I>&gt;<i> session cache which tells any kid how many other kids are currently
</I>&gt;<i> accessing that SHM block. But there may be a better way.
</I>
There are already counters like that, on the cache slot level. They seem
irrelevant here because Ssl::SessionCache does not export them to
OpenSSL (AFAICT). AFAICT, Ssl::SessionCache does this:

openForReading
  ... read/parse ...
closeForReading

or this:

openForWriting
  ... write/store ...
closeForWriting


without leaving those open/close blocks open outside the corresponding
function call.


&gt;&gt;<i> I am guessing you have tried deleting Ssl::SessionCache and something
</I>&gt;&gt;<i> broke. What was it?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> No. I chose to leave this bug-compatible with existing trunk, since I
</I>&gt;<i> cant test that change properly myself.
</I>
If we were never deleting Ssl::SessionCache before, and you do not want
to deal with that problem, then it is acceptable to leave it as is, of
course. However, please replace the proposed XXX comment with something
less assertive about scary thing that may not be true. For example:

  // TODO: Enable after testing to improve at-exit memory cleanup.
  // delete Ssl::SessionCache

or

  // XXX: Enable after testing to reduce at-exit memory &quot;leaks&quot;.
  // delete Ssl::SessionCache


Thank you,

Alex.

</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005123.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
	<LI>Next message: <A HREF="005126.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5124">[ date ]</a>
              <a href="thread.html#5124">[ thread ]</a>
              <a href="subject.html#5124">[ subject ]</a>
              <a href="author.html#5124">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
