<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shuffle%20SessionCacheRunner%20to%20libsecurity&In-Reply-To=%3C56BDFA9F.3040500%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005124.html">
   <LINK REL="Next"  HREF="005144.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shuffle%20SessionCacheRunner%20to%20libsecurity&In-Reply-To=%3C56BDFA9F.3040500%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 12 15:30:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005124.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
        <LI>Next message: <A HREF="005144.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5126">[ date ]</a>
              <a href="thread.html#5126">[ thread ]</a>
              <a href="subject.html#5126">[ subject ]</a>
              <a href="author.html#5126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/02/2016 4:48 p.m., Alex Rousskov wrote:
&gt;<i> On 02/11/2016 08:14 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 12/02/2016 7:21 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 02/11/2016 10:20 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> One issue was uncovered during this:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * While ssl/support.h was defining a destruct_session_cache() function
</I>&gt;&gt;&gt;&gt;<i> that appeared to release the cache memory, it was not actually being
</I>&gt;&gt;&gt;&gt;<i> used anywhere. Which unless a fortuitous sequence of events is happening
</I>&gt;&gt;&gt;&gt;<i> means that OpenSSL locks we create for the cache entries may not be
</I>&gt;&gt;&gt;&gt;<i> released properly. On the other hand the cache should only be erased on
</I>&gt;&gt;&gt;&gt;<i> shutdown so the effects of this are minor.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The unused function has been removed and the issue is now expicitly
</I>&gt;&gt;&gt;&gt;<i> noted in the Runner shutdown handling method.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> +SharedSessionCacheRr::~SharedSessionCacheRr()
</I>&gt;&gt;&gt;&gt;<i> +{
</I>&gt;&gt;&gt;&gt;<i> +#if 0
</I>&gt;&gt;&gt;&gt;<i> +    // XXX: the Ssl::SessionCache memory (if any) is leaked.
</I>&gt;&gt;&gt;&gt;<i> +    // at least technically. OpenSSL is never informed about this memory
</I>&gt;&gt;&gt;&gt;<i> +    // being no longer used and the bulk SHM chunk being released.
</I>&gt;&gt;&gt;&gt;<i> +    // Any locks it is holding for the sessions may stay set.
</I>&gt;&gt;&gt;&gt;<i> +//      delete Ssl::SessionCache;
</I>&gt;&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;&gt;<i> +    delete owner;
</I>&gt;&gt;&gt;&gt;<i> +}
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Why not delete Ssl::SessionCache?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am not intimately familiar with the specifics of the OpenSSL session
</I>&gt;&gt;&gt;<i> locks you are discussing, so I cannot comment about that aspect, but
</I>&gt;&gt;&gt;<i> after &quot;delete owner&quot; above, any Ssl::SessionCache memory that OpenSSL
</I>&gt;&gt;&gt;<i> might have been pointing at would be gone anyway and must not be
</I>&gt;&gt;&gt;<i> accessed, right?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Well. I hoped the XXX explained that. The cache is a SHM block of memory
</I>&gt;<i> 
</I>&gt;<i> Sorry, the XXX comment did not help me understand. I _do_ know that the
</I>&gt;<i> cache is in shared memory, but the comment talks about things that do
</I>&gt;<i> not match my understanding of reality.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> AFAICT, Ssl::SessionCache itself does not know anything about OpenSSL
</I>&gt;&gt;&gt;<i> because it is just a [shared memory] key:opaque_value cache. With its
</I>&gt;&gt;&gt;<i> memory gone and no SessionCache--&gt;OpenSSL connection, it feels like
</I>&gt;&gt;&gt;<i> deleting SessionCache cannot make things worse (and will free a few
</I>&gt;&gt;&gt;<i> otherwise &quot;technically leaking&quot; Ipc::MemMap bytes that are not shared).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> ... using delete in kid1 would unset/nul/unlock all the Pointer in it
</I>&gt;<i> 
</I>&gt;<i> I do not follow. Ssl::SessionCache is Ipc::MemMap. Ipc::MemMap does not
</I>&gt;<i> know anything about OpenSSL. Deleting Ipc::MemMap cannot
</I>&gt;<i> unset/nul/unlock any OpenSSL pointers AFAICT.
</I>
Does it initiate the destructor chain for the objects stored in the
SessionCache ?


&gt;<i> 
</I>&gt;<i> Moreover, correctly deleting Ipc::MemMap in kid1 should have no effect
</I>&gt;<i> on IpcMemMap in other kids -- this is shared memory, and its users may
</I>&gt;<i> come and go at any time (by design!).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If your argument is that some OpenSSL structures somewhere are pointing
</I>&gt;<i> to the shared memory maintained by Ssl::SessionCache, then
</I>&gt;<i> 
</I>&gt;<i> (a) IIRC, deleting the memory owner (which we do!) ought to invalidate
</I>&gt;<i> that memory anyway, and
</I>&gt;<i> 
</I>&gt;<i> (b) please point me to those structures because I only see SessionCache
</I>&gt;<i> managing opaque blobs that OpenSSL either parses or writes to within the
</I>&gt;<i> scope of a given function call -- no long-term sharing of that opaque
</I>&gt;<i> data area with the rest of Squid.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Again, I am not intimate with that area of the code, so please correct
</I>&gt;<i> me if I am wrong.
</I>&gt;<i> 
</I>
Sorry. I mucked myself up confusing this piece with my previous
(artially failed) experiments.

It is a side-track, but since they are related:

GnuTLS does things slightly different to OpenSSL. It requires that the
memory allocated belong to the library (otherwise fetched and linked the
same to a session).
 BUT, the crucial thing there is that our shared memory stores the
pointer to  rather than a fully separate copy. So it appears the next
stages might need the cache to store a Pointer. Which means the Pointer
deallocation will manage whatever locking is (or not) needed. So the
destructors need to be run from each worker, but not free from each worker.

Anyhow since as you say thats out of scope for this patch. And the
dependency issue I ran aground on means this wont be relevant for
anything soon anyway. We might have a better solution by then.

&gt;<i> 
</I>&gt;&gt;&gt;<i> I am guessing you have tried deleting Ssl::SessionCache and something
</I>&gt;&gt;&gt;<i> broke. What was it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No. I chose to leave this bug-compatible with existing trunk, since I
</I>&gt;&gt;<i> cant test that change properly myself.
</I>&gt;<i> 
</I>&gt;<i> If we were never deleting Ssl::SessionCache before, and you do not want
</I>&gt;<i> to deal with that problem, then it is acceptable to leave it as is, of
</I>&gt;<i> course. However, please replace the proposed XXX comment with something
</I>&gt;<i> less assertive about scary thing that may not be true. For example:
</I>&gt;<i> 
</I>&gt;<i>   // TODO: Enable after testing to improve at-exit memory cleanup.
</I>&gt;<i>   // delete Ssl::SessionCache
</I>&gt;<i> 
</I>&gt;<i> or
</I>&gt;<i> 
</I>&gt;<i>   // XXX: Enable after testing to reduce at-exit memory &quot;leaks&quot;.
</I>&gt;<i>   // delete Ssl::SessionCache
</I>&gt;<i> 
</I>
Okay, done.

If there are no objections to the code itself, in particular the
initialization change. Then I will apply later today.

Amos

</PRE>





































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005124.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
	<LI>Next message: <A HREF="005144.html">[squid-dev] [PATCH] shuffle SessionCacheRunner to libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5126">[ date ]</a>
              <a href="thread.html#5126">[ thread ]</a>
              <a href="subject.html#5126">[ subject ]</a>
              <a href="author.html#5126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
