<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Bug 4111 fix
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204111%20fix&In-Reply-To=%3C56C3B931.3090401%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005137.html">
   <LINK REL="Next"  HREF="005155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Bug 4111 fix</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204111%20fix&In-Reply-To=%3C56C3B931.3090401%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Bug 4111 fix">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb 17 00:05:05 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005137.html">[squid-dev] testRock still not working on macOS
</A></li>
        <LI>Next message: <A HREF="005155.html">[squid-dev] [PATCH] Bug 4111 fix
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5145">[ date ]</a>
              <a href="thread.html#5145">[ thread ]</a>
              <a href="subject.html#5145">[ subject ]</a>
              <a href="author.html#5145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This bug had unfortunately gotten lost in the flood. The bug reporters
proposed patch seems to be correct in terms of its intention.

This version of the patch adds the missing {} and uses fatalf() instead
of exit(). It also goes a little further and corrects the outstanding
errno handling issues in the affected functions. Both of these
diffferences are to ensure consistent error reporting on the abort.

Amos
-------------- next part --------------
=== modified file 'src/tools.cc'
--- src/tools.cc	2016-01-24 17:41:43 +0000
+++ src/tools.cc	2016-02-16 22:48:57 +0000
@@ -534,19 +534,22 @@
     }
 
 #if HAVE_SETRESUID
-
-    if (setresuid(Config2.effectiveUserID, Config2.effectiveUserID, 0) &lt; 0)
-        debugs(50, DBG_CRITICAL, &quot;ALERT: setresuid: &quot; &lt;&lt; xstrerror());
+    if (setresuid(Config2.effectiveUserID, Config2.effectiveUserID, 0) &lt; 0) {
+        auto xerrno = errno;
+        fatalf(&quot;FATAL: setresuid: %s&quot;, xstrerr(xerrno));
+    }
 
 #elif HAVE_SETEUID
-
-    if (seteuid(Config2.effectiveUserID) &lt; 0)
-        debugs(50, DBG_CRITICAL, &quot;ALERT: seteuid: &quot; &lt;&lt; xstrerror());
+    if (seteuid(Config2.effectiveUserID) &lt; 0) {
+        auto xerrno = errno;
+        fatalf(&quot;FATAL: seteuid: %s&quot;, xstrerr(xerrno));
+    }
 
 #else
-
-    if (setuid(Config2.effectiveUserID) &lt; 0)
-        debugs(50, DBG_CRITICAL, &quot;ALERT: setuid: &quot; &lt;&lt; xstrerror());
+    if (setuid(Config2.effectiveUserID) &lt; 0) {
+        auto xerrno = errno;
+        fatalf(&quot;FATAL: setuid: %s&quot;, xstrerr(xerrno));
+    }
 
 #endif
 
@@ -566,8 +569,10 @@
 {
     debugs(21, 3, &quot;enter_suid: PID &quot; &lt;&lt; getpid() &lt;&lt; &quot; taking root privileges&quot;);
 #if HAVE_SETRESUID
-    if (setresuid((uid_t)-1, 0, (uid_t)-1) &lt; 0)
-        debugs (21, 3, &quot;enter_suid: setresuid failed: &quot; &lt;&lt; xstrerror ());
+    if (setresuid((uid_t)-1, 0, (uid_t)-1) &lt; 0) {
+        auto xerrno = errno;
+        debugs (21, 3, &quot;enter_suid: setresuid failed: &quot; &lt;&lt; xstrerr(xerrno));
+    }
 #else
 
     setuid(0);
@@ -581,8 +586,9 @@
 #endif
 }
 
-/* Give up the posibility to gain privilegies.
- * this should be used before starting a sub process
+/**
+ * Give up the posibility to gain privileges.
+ * This should be used before starting a sub process.
  */
 void
 no_suid(void)
@@ -592,11 +598,15 @@
     uid = geteuid();
     debugs(21, 3, &quot;no_suid: PID &quot; &lt;&lt; getpid() &lt;&lt; &quot; giving up root priveleges forever&quot;);
 
-    if (setuid(0) &lt; 0)
-        debugs(50, DBG_IMPORTANT, &quot;WARNING: no_suid: setuid(0): &quot; &lt;&lt; xstrerror());
+    if (setuid(0) &lt; 0) {
+        auto xerrno = errno;
+        debugs(50, DBG_IMPORTANT, &quot;WARNING: no_suid: setuid(0): &quot; &lt;&lt; xstrerr(xerrno));
+    }
 
-    if (setuid(uid) &lt; 0)
-        debugs(50, DBG_IMPORTANT, &quot;ERROR: no_suid: setuid(&quot; &lt;&lt; uid &lt;&lt; &quot;): &quot; &lt;&lt; xstrerror());
+    if (setuid(uid) &lt; 0) {
+        auto xerrno = errno;
+        debugs(50, DBG_IMPORTANT, &quot;ERROR: no_suid: setuid(&quot; &lt;&lt; uid &lt;&lt; &quot;): &quot; &lt;&lt; xstrerr(xerrno));
+    }
 
     restoreCapabilities(false);
 

</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005137.html">[squid-dev] testRock still not working on macOS
</A></li>
	<LI>Next message: <A HREF="005155.html">[squid-dev] [PATCH] Bug 4111 fix
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5145">[ date ]</a>
              <a href="thread.html#5145">[ thread ]</a>
              <a href="subject.html#5145">[ subject ]</a>
              <a href="author.html#5145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
