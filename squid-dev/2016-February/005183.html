<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] implement RFC3986
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20implement%20RFC3986&In-Reply-To=%3CCA%2BY8hcP0DeBv3yxW6xzvgmAD_QsTSQGvTPZetSqWiVfkuyoxdg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005178.html">
   <LINK REL="Next"  HREF="005184.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] implement RFC3986</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20implement%20RFC3986&In-Reply-To=%3CCA%2BY8hcP0DeBv3yxW6xzvgmAD_QsTSQGvTPZetSqWiVfkuyoxdg%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] implement RFC3986">gkinkie at gmail.com
       </A><BR>
    <I>Mon Feb 22 21:53:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005178.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
        <LI>Next message: <A HREF="005184.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5183">[ date ]</a>
              <a href="thread.html#5183">[ thread ]</a>
              <a href="subject.html#5183">[ subject ]</a>
              <a href="author.html#5183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, Feb 21, 2016 at 4:51 PM, Alex Rousskov
&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 02/20/2016 11:27 AM, Kinkie wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Sorry to bring this topic up again, but honestly I don't understand
</I>&gt;&gt;<i> your position.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe that the deadlock we currently are in
</I>&gt;<i>
</I>&gt;<i> There is no deadlock. I think the design decision to use templated
</I>&gt;<i> escape functions to accomodate std::string-using helpers was wrong, but
</I>&gt;<i> I am not bold enough to stop you from committing it. Much worse code
</I>&gt;<i> goes in despite my objections or without proper audit.
</I>
Unfortunately there is: I am prepared to abandon this effort unless we
reach consensus - at least non-opposition. It'd be a pity, as it's an
useful feature.

&gt;&gt;<i> is caused by the fact
</I>&gt;&gt;<i> that we are discussing about two topics at the same time.
</I>&gt;&gt;<i> One is: should Rfc3986 target both SBuf and std::string, if the
</I>&gt;&gt;<i> performance and complexity penalty in doing so is none or small? I
</I>&gt;&gt;<i> (and I believe Amos) think it's a good, or at least not a bad idea.
</I>&gt;<i>
</I>&gt;<i> Any &quot;Should I do X if X is good?&quot; question is pointless. The question is
</I>&gt;<i> &quot;Should I do X?&quot;. I have already outlined why I think doing X is harmful.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> The other is: should we use std::string or SBuf or c-strings in
</I>&gt;&gt;<i> helpers? My opinion is that std::string would be preferable, yours is
</I>&gt;&gt;<i> that SBuf is preferable, if any change is performed over the current
</I>&gt;&gt;<i> state of using c-strings. I think change over current state is a good
</I>&gt;&gt;<i> idea, you - I believe - are averse enough to using std::string that
</I>&gt;&gt;<i> would prefer no change.
</I>&gt;<i>
</I>&gt;<i> I think helpers should use whatever works best for them, given the
</I>&gt;<i> available Squid APIs and other factors. The question is not about what
</I>&gt;<i> helpers should use but whether Squid code should bend over backwards
</I>&gt;<i> (e.g., providing a templated function to escape strings and adjust SBuf
</I>&gt;<i> to work with that function) to accommodate a helper. The answer, IMO, is
</I>&gt;<i> &quot;no&quot;. It is much better to
</I>
&gt;<i> * provide SBuf to helpers that want top performance
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;<i> * provide a trivial std::string-escaping function (that uses
</I>&gt;<i> SBuf-escaping function internally) to helpers that want to use C-strings
</I>&gt;<i> or std::strings.
</I>
Ok, I believe here is the crux of the issue. rfc3986 is a library; we
could split it into two versions, one to be used by helpers and one to
be used by squid. The two versions would be remarkably similar and
have a lot of code duplications, or as you propose be one an adapter
of the other.
An adapter exposing a std::string API and using SBuf internally would
be quite inefficient as it'd need to copy data back and forth.
Performance is not a big concern when it comes to helpers, but I argue
that this approach would require more code, be less efficient, and
increase coupling between squid and helpers than the template-based
approach.
In order to clarify, when I talk about couplign I mean link-time
coupling. This can be directly understood from the list of objects
needed for testSBuf: between headers, objects and stubs that's about
30 files (on top of the testSBuf files themselves).

&gt;&gt;<i> Can we try to decouple the two discussions and see if this helps us
</I>&gt;&gt;<i> reach a consensus?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My point of view is:
</I>&gt;&gt;<i> - having a more generic API costs us nothing - the code is compact,
</I>&gt;&gt;<i> readable and efficient regardless the genericity, so we should merge
</I>&gt;&gt;<i> Rfc3986.
</I>&gt;<i>
</I>&gt;<i> A single template costs virtually nothing. I speculate that the design
</I>&gt;<i> decision to treat std::string-using helpers as the primary driving
</I>&gt;<i> factor for Squid APIs will cost a lot long-term.
</I>
Let's be clear: Squid API are in no way influenced by this. However
Squid has a need (a rfc3986/1738 codec library) which also helpers
have. Using a template leverages the opportunity offered by the very
similar APIs that std::string and SBuf have to increase applicability
of the library.

&gt;<i> This is very similar to assert(string_size &lt; 64K). The cost of that
</I>&gt;<i> single line was nothing when it was written. However, the cost of the
</I>&gt;<i> design decision that Strings can self-limit their size is a growing
</I>&gt;<i> collection of CVEs. IMO, you are opening a Pandora box. The cost of
</I>&gt;<i> lifting the lid is indeed negligible, but that cost is not what I am
</I>&gt;<i> worried about.
</I>
I still can't see the long-term harm, while I can see the short-term
harm in not following my idea.
To the cost of repeating myself, we want a SBuf API for squid where
performance and COW matter a lot. I wish a std::string API for helpers
to avoid having to link 30+ squid files and stubs for each helper
(object size is not a concern, it's more about maintaining this long
list of dependencies).

&gt;&gt;<i> - there is no performance or readability benefit in using SBuf in
</I>&gt;&gt;<i> helpers due to the way client code is structured.
</I>&gt;<i>
</I>&gt;<i> I agree regarding readability. SBuf is about the same or a little worse
</I>&gt;<i> than std::string.
</I>
I agree

&gt;<i> If you are right about performance and safety across all helpers, then
</I>&gt;<i> there is no benefit in using SBuf in Squid.
</I>
Here I disagree. SBuf is relevant for squid. It is not for helpers.
BTW: if there was a way to reasonably integrate std::string and
mempools, that would be worth investigating. I haven't found it.

&gt;&gt;<i> Also, we would need
</I>&gt;&gt;<i> to stub a lot of functionality it relies on (e.g. mempools,
</I>&gt;&gt;<i> statistics, cachemgr).
</I>&gt;<i>
</I>&gt;<i> I am not sure that is true, but even if it is true, it should not be
</I>&gt;<i> important for this discussion. The vast majority of such refactoring,
</I>&gt;<i> would benefit Squid. For example, if our SBuf code depends on cache
</I>&gt;<i> manager, then we made a mistake that should be fixed.
</I>
It doesn't depend from cachemgr to work, but it links to it. This can
probably be refactored to decrease decoupling.

-- 
    Francesco
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005178.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
	<LI>Next message: <A HREF="005184.html">[squid-dev] [PATCH] implement RFC3986
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5183">[ date ]</a>
              <a href="thread.html#5183">[ thread ]</a>
              <a href="subject.html#5183">[ subject ]</a>
              <a href="author.html#5183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
