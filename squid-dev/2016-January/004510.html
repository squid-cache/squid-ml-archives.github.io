<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] connections_encrypted ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20connections_encrypted%20ACL&In-Reply-To=%3C568A9D13.4050701%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004487.html">
   <LINK REL="Next"  HREF="004549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] connections_encrypted ACL</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20connections_encrypted%20ACL&In-Reply-To=%3C568A9D13.4050701%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] connections_encrypted ACL">christos at chtsanti.net
       </A><BR>
    <I>Mon Jan  4 16:25:55 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004487.html">[squid-dev] [PATCH] connections_encrypted ACL
</A></li>
        <LI>Next message: <A HREF="004549.html">[squid-dev] [PATCH] connections_encrypted ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4510">[ date ]</a>
              <a href="thread.html#4510">[ thread ]</a>
              <a href="subject.html#4510">[ subject ]</a>
              <a href="author.html#4510">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/02/2016 05:23 AM, Amos Jeffries wrote:
&gt;<i> On 2015-12-30 23:23, Christos Tsantilas wrote:
</I>&gt;&gt;<i> This patch initialy discussed in squid-dev under the thread &quot;[PATCH]
</I>&gt;&gt;<i> received_encrypted ACL&quot; some months ago:
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-July/002680.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-July/002680.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The &quot;received_encrypted&quot; was the original name of a new ACL which in
</I>&gt;&gt;<i> this patch (t7) renamed to connections_encrypted
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am reposting here as new patch.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (New) Patch description:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The new connections_encrypted ACL matches transactions where all HTTP
</I>&gt;&gt;<i> messages were received over TLS transport connections, including
</I>&gt;&gt;<i> messages received from ICAP servers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some ICAP/eCAP services receive data from unencrypted sources. Some
</I>&gt;&gt;<i> ICAP/eCAP services are &quot;secure&quot;. By default we assume that all eCAP
</I>&gt;&gt;<i> services and all ICAP services on TLS transport connections  are
</I>&gt;&gt;<i> &quot;secure&quot; unless the user uses the &quot;connection_encryption&quot; option in
</I>&gt;&gt;<i> service configuration line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is a Measurement Factory project.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/acl/ConnectionsEncrypted.h:
</I>&gt;<i>
</I>&gt;<i> * the #ifndef wrapper string s/ENTRYPTED/ENCRYPTED/
</I>&gt;<i>
</I>&gt;<i> * please use a space between &quot;operator=&quot;
</I>&gt;<i>
</I>&gt;<i> * please add empty line between end of namespace and file wrapper #endif
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/adaptation/ServiceConfig.h:
</I>&gt;<i>
</I>&gt;<i> * something seems wrong about the use of connectionsEncryptedSet member.
</I>&gt;<i>   - it is using twice as much memory to configure a boolean option than
</I>&gt;<i> it should be able to.
</I>
Probably the connectionsEncryptedSet should renamed to 
overwriteConnectionsEncrypted os something like that.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The options are documented as being configured *after* the service URI.
</I>&gt;<i> So it seems to me that the service URI should set the flag default based
</I>&gt;<i> on the icap/icaps (or ecap/ecaps) nature. Then the user option set/unset
</I>&gt;<i> it later if they want to override. No need for a separate &quot;user set it&quot;
</I>&gt;<i> member, or for special casing of ICAP/eCAP non-S.
</I>

An ICAP service can configured to use TLS even if the icaps is not used 
in URI scheme. Just the &quot;tls&quot; option in icap_service configuration line 
is enough to enable TLS for service.


The ecaps is not used in ecap URIs, the ECAP services by default 
considered always as secure because no connection to external sources is 
required.

The final decision about encrypting or not the ICAP connections in the 
ICAP related squid code does not taken while the configuration line is 
parsed, but in later step, just before the service configured and starts.


&gt;<i>
</I>&gt;<i> On the dumpCfg() side the service URI type could be checked to see if it
</I>&gt;<i> the value needs to be dumped out or not. The user setting it to the
</I>&gt;<i> default is a no-op.
</I>
hmm.....
The Adaptation::Config::dumpService() functions which prints an
adaptation service looks wrong ...

If no problem I will not touch this method now, and I will make a new 
patch which fixes this method.

&gt;<i>
</I>&gt;<i> in src/cf.data.pre:
</I>&gt;<i>
</I>&gt;<i> * the documentation implies that connection_encrypted=on turns the taint
</I>&gt;<i> check *OFF* for ICAPS connections. But does not un-taint ICAP
</I>&gt;<i> connections. The code does not seem to match.
</I>
You are right I confused too reading these lines.

* For secure ICAP service the  connection_encrypted=on option is the 
default, the user can use the connection_encrypted=off to change the 
default behaviour.
* For plain ICAP services the default is the connection_encrypted=off 
and the user can use the connection_encrypted=on to change the default 
behaviour.

Are the following lines enough for ICAP service:
&quot;The default is &quot;on&quot; for Secure ICAP services (i.e., those with the 
<A HREF="icaps://">icaps://</A> service URIs scheme) and &quot;off&quot; for plain ICAP services.&quot;

The existing related documentation line for ECAP looks OK to me.

&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I></PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004487.html">[squid-dev] [PATCH] connections_encrypted ACL
</A></li>
	<LI>Next message: <A HREF="004549.html">[squid-dev] [PATCH] connections_encrypted ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4510">[ date ]</a>
              <a href="thread.html#4510">[ thread ]</a>
              <a href="subject.html#4510">[ subject ]</a>
              <a href="author.html#4510">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
