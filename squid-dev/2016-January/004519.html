<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fix libatomic detection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20libatomic%20detection&In-Reply-To=%3C568B7980.4060707%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004515.html">
   <LINK REL="Next"  HREF="004520.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fix libatomic detection</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20libatomic%20detection&In-Reply-To=%3C568B7980.4060707%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Fix libatomic detection">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan  5 08:06:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004515.html">[squid-dev] [PATCH] Fix libatomic detection
</A></li>
        <LI>Next message: <A HREF="004520.html">[squid-dev] [PATCH] Fix libatomic detection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4519">[ date ]</a>
              <a href="thread.html#4519">[ thread ]</a>
              <a href="subject.html#4519">[ subject ]</a>
              <a href="author.html#4519">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/01/2016 7:34 a.m., Kinkie wrote:
&gt;<i> On Mon, Jan 4, 2016 at 6:47 AM, Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;<i> On 28/12/2015 10:25 p.m., Kinkie wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Mon, Dec 28, 2015 at 1:32 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 24/12/2015 11:32 a.m., Kinkie wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;&gt;<i>   libatomic detection is currently broken in configure.ac; it will
</I>&gt;&gt;&gt;&gt;&gt;<i> define -latomic even in case where it wouldn't be required (e.g.
</I>&gt;&gt;&gt;&gt;&gt;<i> because it's already provided by the compiler).
</I>&gt;&gt;&gt;&gt;&gt;<i> The attached patch fixes the broken case. Unfortunately I don't know a
</I>&gt;&gt;&gt;&gt;&gt;<i> system where this library is required, I'm convinced there's room for
</I>&gt;&gt;&gt;&gt;&gt;<i> further simplification.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It was for Clang builds IIRC. At least 3.5 needs it added.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Does this work instead for shorter code?
</I>&gt;&gt;&gt;&gt;<i>   AC_SEARCH_LIBS([__atomic_load_8],[atomic],[
</I>&gt;&gt;&gt;&gt;<i>     ATOMICLIB=&quot;$ac_cv_search___atomic_load_8&quot;
</I>&gt;&gt;&gt;&gt;<i>   ],[])
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> unfortunately not, as the result could be &quot;none required&quot; or &quot;no&quot;,
</I>&gt;&gt;&gt;<i> too. The former is actually the error case which bought me to the
</I>&gt;&gt;&gt;<i> topic.
</I>&gt;&gt;&gt;<i> Documentation states that if a library is needed it should get
</I>&gt;&gt;&gt;<i> automatically added to LIBS though.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;Unless the 3rd and 4th parameters are specified&quot;. So it will be
</I>&gt;&gt;<i> automatically added under your patch, but not under the existing/older code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Which was an intentional omission from LIBS to avoid build warnings on
</I>&gt;&gt;<i> some distros about unnecessary dependencies being linked in (such as
</I>&gt;&gt;<i> &lt;<A HREF="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=770928">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=770928</A>&gt;). Since most
</I>&gt;&gt;<i> of the helper binaries do not use atomics (yet, though we could thread
</I>&gt;&gt;<i> them in future) the -latomic addition is only needed by squid_LDADD not
</I>&gt;&gt;<i> the generic LIBS / LDADD.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Are you sure? This from the doc I could find:
</I>&gt;<i> ===
</I>&gt;<i> the default action-if-found code, adding the library to the LIBS
</I>&gt;<i> variables, is always executed, even if a parameter is passed
</I>&gt;<i> ===
</I>&gt;<i> 
</I>&gt;<i> I have no objection on the intention, of course.
</I>&gt;<i> If you are right, then the one-liner below should then do the trick.
</I>&gt;<i> If I am right, we need to go through the
</I>&gt;<i> SQUID_SAVE_STATE/SQUID_ROLLBACK_STATE dance on top of that.
</I>&gt;<i> 
</I>&gt;<i> === modified file 'configure.ac'
</I>&gt;<i> --- configure.ac    2016-01-04 14:39:06 +0000
</I>&gt;<i> +++ configure.ac    2016-01-04 18:25:48 +0000
</I>&gt;<i> @@ -458,7 +458,7 @@
</I>&gt;<i>  fi
</I>&gt;<i> 
</I>&gt;<i>  ## check for atomics library before anything that might need it
</I>&gt;<i> -AC_SEARCH_LIBS([__atomic_load_8],[atomic])
</I>&gt;<i> +AC_SEARCH_LIBS([__atomic_load_8],[atomic],[],[])
</I>&gt;<i>  if test &quot;x$ac_cv_search___atomic_load_8&quot; = &quot;-latomic&quot;; then
</I>&gt;<i>    ATOMICLIB=&quot;-latomic&quot;
</I>&gt;<i>  fi
</I>&gt;<i> 
</I>
Seems I was wrong. I have just checked the two versions and the above
patch generates exactly the same code as current trunk and sets LIBS. So
we will have to do the state preservation dance. But I think wait until
we have evidence of complaints for that.

I also see the test is missing the &quot;x&quot; on the RHS of the conditional.
Which is a bigger problem for clang where it needs to be set.

PS. this is all fixes bug 4393 right?

Amos

</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004515.html">[squid-dev] [PATCH] Fix libatomic detection
</A></li>
	<LI>Next message: <A HREF="004520.html">[squid-dev] [PATCH] Fix libatomic detection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4519">[ date ]</a>
              <a href="thread.html#4519">[ thread ]</a>
              <a href="subject.html#4519">[ subject ]</a>
              <a href="author.html#4519">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
