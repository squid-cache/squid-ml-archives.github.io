<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5CPREVIEW%5D%20ICAP%20service%20nodown%20option%20addition.&In-Reply-To=%3C569160F8.206%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004595.html">
   <LINK REL="Next"  HREF="004601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5CPREVIEW%5D%20ICAP%20service%20nodown%20option%20addition.&In-Reply-To=%3C569160F8.206%40ngtech.co.il%3E"
       TITLE="[squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.">eliezer at ngtech.co.il
       </A><BR>
    <I>Sat Jan  9 19:35:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004595.html">[squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.
</A></li>
        <LI>Next message: <A HREF="004601.html">[squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4597">[ date ]</a>
              <a href="thread.html#4597">[ thread ]</a>
              <a href="subject.html#4597">[ subject ]</a>
              <a href="author.html#4597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Alex,

Inline comments..

On 08/01/2016 17:27, Alex Rousskov wrote:
&gt;<i> On 01/07/2016 07:03 PM, Eliezer Croitoru wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I added a configurable option to the ICAP services named &quot;nodown&quot; but
</I>&gt;&gt;<i> maybe another name would be better fit.
</I>&gt;<i>
</I>&gt;<i> Please do not use negative option names. If this feature is committed
</I>&gt;<i> despite my objections, please consider using &quot;always-up&quot; or another
</I>&gt;<i> positive name.
</I>Both nodown and always-up do not describe the exact meaning of the flag.
Do you(..and others) think that a longer name would be better? something 
like &quot;options-only-suspened&quot; or &quot;suspend-only-by-options-fail&quot; ?


&gt;&gt;<i> The idea of the patch is to allow the admin to count on the periodic
</I>&gt;&gt;<i> OPTIONS request only to identify the current state of the ICAP service.
</I>&gt;<i>
</I>&gt;<i> If an ICAP OPTIONS request fails, will the service be marked as down? If
</I>&gt;<i> yes, the option name is misleading. If not, your description above is
</I>&gt;<i> misleading. If this feature is committed, please adjust the
</I>&gt;<i> documentation to clearly define whether Squid may mark a nodown=1
</I>&gt;<i> service as down for any reason.
</I>
I suspected that my words might not be descriptive enough and I will try 
to clear it out in the next comments.

&gt;<i>
</I>&gt;&gt;<i> I was thinking about using the icap_service_failure_limit with a very
</I>&gt;&gt;<i> high limit but it is an ICAP global configuration and not a service
</I>&gt;&gt;<i> specific configuration.
</I>&gt;<i>
</I>&gt;<i> IMO, you should add a service-specific failure-limit option instead of
</I>&gt;<i> adding a brand new option with an overlapping but very narrow scope.
</I>&gt;<i> Squid already implements the failure-limit logic on a per-service basis.
</I>&gt;<i> You just need to add a per-service option (that will default to the
</I>&gt;<i> global one).
</I>
I was thinking about it but this feature eliminates every suspension 
between each OPTIONS fetch\check.

I know it doesn't fit all setups but I want to eliminate any other test 
then the OPTIONS fetch and the reason is that only using a very high 
failure limit will answer to this specific attack I have seen. A simple 
JS just sent about 1k requests pretty fast and with all of them failing 
pretty fast the ICAP service is just being suspended so just eliminating 
the issues solved my problem.

(I cannot do a thing about a webui programmer that doesn't like to do 
his job properly??)

&gt;&gt;<i> +       [...] It gives the
</I>&gt;&gt;<i> +       service admin to implement his own heart-beat script which
</I>&gt;&gt;<i> +       will work as a replacment to the default internal requests
</I>&gt;&gt;<i> +       success\failure probes while the ICAP service state is UP.
</I>&gt;&gt;<i> +       An external heart-beat script can run under external_acl
</I>&gt;&gt;<i> +       and can be checked in http_access and couple other acls
</I>&gt;&gt;<i> +       vectoring points.
</I>&gt;<i>
</I>&gt;<i> IMO, this text should not be added to the new option because it talks
</I>&gt;<i> about controlling access to an ICAP service rather than about [not]
</I>&gt;<i> changing the service state which the new option controls. Referring to
</I>&gt;<i> adaptation_access from the new option documentation and adding a similar
</I>&gt;<i> hint to the adaptation_access documentation instead may be a good idea.
</I>
Not really but I do understand what you are writing about.
The intention is very specific and not related to the adaptation_access, 
the idea is that the service is essential and the proxy cannot allow any 
traffic without this service due to some health facilities 
confidentiality policy. So for the case that the service is indeed down 
the admin needs to deny access to the whole service since it's useless 
without the adaptation service. The external_acl is per squid port and 
will deny access to the whole service based on the real status of the 
ICAP service.
If I will use adaptation_access it will lead to a situation which the 
clients traffic will not pass inspection which is worst then having ICAP 
failures per specific wrongly formed requests.

However I did not test what is the situation with adaptation services 
set and if their &quot;chained&quot; use is based only on full suspension or it 
will also pass the request to the next host per request failure.

I will conduct couple tests this week to make sure how things works with 
sets.

Do you think a wiki article will be good enough to explain the use cases 
of this option instead of the documentation?
I was thinking about writing one.

&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>
Again Thanks!
Eliezer

</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004595.html">[squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.
</A></li>
	<LI>Next message: <A HREF="004601.html">[squid-dev] [RFC\PREVIEW] ICAP service nodown option addition.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4597">[ date ]</a>
              <a href="thread.html#4597">[ thread ]</a>
              <a href="subject.html#4597">[ subject ]</a>
              <a href="author.html#4597">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
