<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] The situation with helpers/
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20The%20situation%20with%20helpers/&In-Reply-To=%3C5696BDFA.1040409%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004669.html">
   <LINK REL="Next"  HREF="004670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] The situation with helpers/</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20The%20situation%20with%20helpers/&In-Reply-To=%3C5696BDFA.1040409%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] The situation with helpers/">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 13 21:13:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004669.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
        <LI>Next message: <A HREF="004670.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4668">[ date ]</a>
              <a href="thread.html#4668">[ thread ]</a>
              <a href="subject.html#4668">[ subject ]</a>
              <a href="author.html#4668">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/01/2016 2:12 a.m., Kinkie wrote:
&gt;<i> 
</I>&gt;<i> About build dependencies from src/ : while refactoring some helpers I
</I>&gt;<i> came across a recipe which seems reasonably clean and maintainable,
</I>&gt;<i> and I submit it for consideration until a more structured approach
</I>&gt;<i> (such as lifting helpers/ into src/) can be chosen:
</I>&gt;<i> 
</I>&gt;<i> In each helper's Makefile.am, the following clauses must be added:
</I>&gt;<i> 
</I>&gt;<i> IMPORTED_FILES = &lt;list of files including paths relative to src/ to be
</I>&gt;<i> imported into the helper's directory from src&gt;
</I>&gt;<i> nodist_&lt;target&gt;_SOURCES = $(IMPORTED_FILES)
</I>&gt;<i> &lt;target&gt;_DEPENDENCIES = $(IMPORTED_FILES)
</I>&gt;<i> CLEANFILES += $(IMPORTED_FILES)
</I>
Okay on the above. &quot;Nooooo...&quot; on the below bit.

&gt;<i> 
</I>&gt;<i> $(IMPORTED_FILES): $(top_srcdir)/src/$@
</I>&gt;<i>         test -d $(dir $@)|| mkdir -p $(dir $@)
</I>&gt;<i>         cp $(top_srcdir)/src/$@ $@
</I>&gt;<i> 
</I>
... doing it like that will make dozens of .am snippets of code that
have to be maintained in-sync forever.

Like I said on IRC this part needs to be in a src/ImportedFiles.am that
gets included wherever its needed. Not copy-pasted everywhere.
See how we use doc/manuals/Substitute.am if you want an example.

All that the various Makefile.am should contain is the X=Y variable
definitions followed by a &quot;include src/ImportedFiles.am&quot; statement.


And for the love of all thats holy, avoid *_DEPENDENCIES variables.

When DEPENDENCIES is *absent*, automake will take the SOURCES list and
add dependency for each file listed, plus (compiler version dependent) a
sub-dependency recursively for each file #include'd by those. It will
also take the LDADD list and for all local tree objects will add a
dependency. It is smart enough to filter out flags and system libraries
nowdays (AFAICT that was the reason DEPENDENCIES was used to begin with
back in Y2K).

When DEPENDENCIES is present only objects explicitly listed in that
variable are dependencies. *all* of the existing ones are broken and
breaking Squid builds.



&gt;<i> &lt;target&gt; must be replaced with the executable's name. The need for
</I>&gt;<i> this replacement unfortunately means that this recipe must be copied
</I>&gt;<i> to each helper, and can't be factored out.
</I>
The important part to factor away duplication of is:

&gt;<i> $(IMPORTED_FILES): $(top_srcdir)/src/$@
</I>&gt;<i>         test -d $(dir $@)|| mkdir -p $(dir $@)
</I>&gt;<i>         cp $(top_srcdir)/src/$@ $@
</I>&gt;<i>
</I>
which does not contain the &quot;target&quot; bit.

Amos

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004669.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
	<LI>Next message: <A HREF="004670.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4668">[ date ]</a>
              <a href="thread.html#4668">[ thread ]</a>
              <a href="subject.html#4668">[ subject ]</a>
              <a href="author.html#4668">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
