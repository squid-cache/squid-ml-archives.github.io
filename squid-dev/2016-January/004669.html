<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] The situation with helpers/
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20The%20situation%20with%20helpers/&In-Reply-To=%3C5696C56E.1000206%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004667.html">
   <LINK REL="Next"  HREF="004668.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] The situation with helpers/</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20The%20situation%20with%20helpers/&In-Reply-To=%3C5696C56E.1000206%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] The situation with helpers/">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jan 13 21:45:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004667.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
        <LI>Next message: <A HREF="004668.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4669">[ date ]</a>
              <a href="thread.html#4669">[ thread ]</a>
              <a href="subject.html#4669">[ subject ]</a>
              <a href="author.html#4669">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/13/2016 01:50 PM, Amos Jeffries wrote:

&gt;<i> Small side-track (sorry):
</I>&gt;<i> 
</I>&gt;<i> My experiments in fixing that makefile dependencies situation have
</I>&gt;<i> resulted in a few conclusions. Though nowhere near complete the
</I>&gt;<i> lp:~yadi/squid/makefile-deps branch has the latest version of what I
</I>&gt;<i> think it should look like.
</I>&gt;<i> 
</I>&gt;<i> * First stage, bar none is to simply stop adding new foo_DEPENDENCIES
</I>&gt;<i> lines to any .am file. We can/should/need all do that right now.
</I>&gt;<i> 
</I>&gt;<i> * Second stage is to remove existing *_DEPENDENCIES where possible. I
</I>&gt;<i> have found that needs to be done with care, bulk erasing or moving the
</I>&gt;<i> entris to LDADD lists is not always correct. The branch did it and a few
</I>&gt;<i> test binaries had inconsistent builds until their SOURCES were
</I>&gt;<i> corrected. Still not sure I got them all yet.
</I>&gt;<i> 
</I>&gt;<i> * Third stage is to reduce the SOURCES and LDADD lists to the actual
</I>&gt;<i> minimal set needed (maybe increase to full set needed). Stubs helps
</I>&gt;<i> there a lot, but a) some new ones are needed, b) some existing are
</I>&gt;<i> incorrect, and c) more/better use of the ones we have improves automake
</I>&gt;<i> results.
</I>&gt;<i> 
</I>&gt;<i> * Fourth stage I am experimenting with in the branch now is
</I>&gt;<i> non-recursive unit tests. By using src/*/UnitTest.am files we can have
</I>&gt;<i> the tests defined in their respective sudir, but actually built and run
</I>&gt;<i> non-recursive by the src/Makefile.
</I>

FWIW, if I were to solve this problem, I would try to write a script
that generates 95-99% of the Makefile.am rules based on:

* dependencies auto-discovered by scanning #include statements in
sources (probably using gcc or clang capabilities) and

* limited Squid-specific (or configurable) knowledge of external and
unusual dependencies.

IMHO, the problem is not solvable by automation in a general case, but
is solvable with [and should be solved by] automation in the context of
Squid.


&gt;<i> automake itself is migrating upstream to a model where it assumes
</I>&gt;<i> recursive Makefiles and deals better with those sometimes than
</I>&gt;<i> non-recursive. eg. the whole subdirs feature in 1.12+.
</I>
Can you share any references to support the above statement about
automake development direction? AFAIK, the subdir-objects option/fix was
added to, in part, better support *non-recursive* Makefiles so it sounds
like a counter-example to me, but perhaps you meant something else by
the &quot;subdirs feature&quot;.


The difference between recursive and non-recursive Makefiles is of
secondary importance though: A Makefile.am-generating script can
probably handle both styles although a non-recursive Makefile is
probably easier to generate because the make solves the build-order
problem for us.


&gt;<i> IMO the recursive design is better. We have to take care where we put
</I>&gt;<i> things in either case. But with recursive we can reduce the focus to
</I>&gt;<i> only the dirs, not every individual file in the sources.
</I>
I do not see any significant difference in &quot;focus&quot; between (in
pseudo-Makefile.am):

  # non-recursive
  FOO_SOURCES = foo.cc foo.h \
                $(DIR1_SOURCES) $(DIR2_SOURCES)

and

  # recursive
  FOO_SOURCES = foo.cc foo.h
  FOO_LDADD = dir1/libdir1.la dir2/libdir2.la


but, again, I suspect the best style should be determined by automated
Makefile.am-generation needs and not discussion about the human focus.
Once the problem is solved with automation, the above pretty much becomes:

  FOO_SOURCE = foo.cc

as far as humans are concerned.


HTH,

Alex.

</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004667.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
	<LI>Next message: <A HREF="004668.html">[squid-dev] [RFC] The situation with helpers/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4669">[ date ]</a>
              <a href="thread.html#4669">[ thread ]</a>
              <a href="subject.html#4669">[ subject ]</a>
              <a href="author.html#4669">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
