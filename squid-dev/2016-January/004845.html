<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] ftruncate() failures on OS X (Darwin)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20ftruncate%28%29%20failures%20on%20OS%20X%20%28Darwin%29&In-Reply-To=%3CCANEuBv4e0iH0SH1k1uDf1gNPcfj7zhny7Vf4QaAMEWygxpKiQg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="004844.html">
   <LINK REL="Next"  HREF="004846.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] ftruncate() failures on OS X (Darwin)</H1>
    <B>Markus Mayer</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20ftruncate%28%29%20failures%20on%20OS%20X%20%28Darwin%29&In-Reply-To=%3CCANEuBv4e0iH0SH1k1uDf1gNPcfj7zhny7Vf4QaAMEWygxpKiQg%40mail.gmail.com%3E"
       TITLE="[squid-dev] ftruncate() failures on OS X (Darwin)">code at mmayer.net
       </A><BR>
    <I>Sat Jan 23 19:05:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="004844.html">[squid-dev] ftruncate() failures on OS X (Darwin)
</A></li>
        <LI>Next message: <A HREF="004846.html">[squid-dev] ftruncate() failures on OS X (Darwin)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4845">[ date ]</a>
              <a href="thread.html#4845">[ thread ]</a>
              <a href="subject.html#4845">[ subject ]</a>
              <a href="author.html#4845">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23 January 2016 at 09:35, Alex Rousskov &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>
&gt;<i> wrote:
</I>
&gt;<i> On 01/21/2016 08:03 PM, Markus Mayer wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I left out the &quot;flags&quot; variable from the shm_open() call that you
</I>&gt;<i> &gt; showed, since I didn't see it being used or declared anywhere.
</I>&gt;<i>
</I>&gt;<i> Sorry about that leftover from a previous version of my sketch. You did
</I>&gt;<i> the right thing.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I did test it, and it works &quot;as advertised&quot;.
</I>&gt;<i>
</I>&gt;<i> Your patch is solving two problems at once. You have described only one,
</I>&gt;<i> but the other problem[1] is arguably more severe because (a) it leads to
</I>&gt;<i> subtle bugs and crashes rather than startup failures and (b) most people
</I>&gt;<i> run Squid on OSes other than OS X.
</I>&gt;<i>
</I>&gt;<i> [1] Item #1 at
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html</A>
</I>

Right. I completely forgot about that. I had most of the documentation
written up before I learned about the other problem.


&gt;<i> IMO, we should document both problems in the code to minimize our
</I>&gt;<i> chances of repeating them during future refactoring. I suggest replacing
</I>&gt;<i> this comment
</I>&gt;<i>
</I>
Agreed.

```
&gt;<i> Why a brand new segment? Our placement-new code requires an all-0
</I>&gt;<i> segment. We could truncate and resize an old segment, but OS X does not
</I>&gt;<i> allow using O_TRUNC with shm_open() and does not support resizing after
</I>&gt;<i> ftruncate(0).```
</I>&gt;<i>
</I>
Maybe say &quot;doesn't support resizing using a second ftruncate() call&quot; or
something along those lines, since it doesn't support resizing of any kind,
not just after ftruncate(0). But I'm not going to insist on you rewording
the comment you have.

and perhaps renaming createExclusive() to createFresh() for clarity. The
&gt;<i> above can be done during commit -- no need to repost IMO.
</I>&gt;<i>
</I>&gt;<i> Your commit message will explain the details. I (or another committer)
</I>&gt;<i> will add text to state that problem [1] is also fixed by this change.
</I>&gt;<i>
</I>
No objections. Looks good to me.

Regards,
-Markus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160123/a0112ad3/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160123/a0112ad3/attachment.html</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004844.html">[squid-dev] ftruncate() failures on OS X (Darwin)
</A></li>
	<LI>Next message: <A HREF="004846.html">[squid-dev] ftruncate() failures on OS X (Darwin)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4845">[ date ]</a>
              <a href="thread.html#4845">[ thread ]</a>
              <a href="subject.html#4845">[ subject ]</a>
              <a href="author.html#4845">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
