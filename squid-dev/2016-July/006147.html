<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] annotate_transaction ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C4ab8fedb-2ead-d4f0-44ae-41b912d20d1d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006146.html">
   <LINK REL="Next"  HREF="006153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] annotate_transaction ACL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C4ab8fedb-2ead-d4f0-44ae-41b912d20d1d%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] annotate_transaction ACL">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jul  9 23:47:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006146.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
        <LI>Next message: <A HREF="006153.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6147">[ date ]</a>
              <a href="thread.html#6147">[ thread ]</a>
              <a href="subject.html#6147">[ subject ]</a>
              <a href="author.html#6147">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/07/2016 7:14 a.m., Alex Rousskov wrote:
&gt;<i> 
</I>&gt;<i> B. Add general ACL options to be able to force any existing ACL to add
</I>&gt;<i> an annotation:
</I>&gt;<i> 
</I>&gt;<i>     acl myOldAcl dst --annotate foo=bar 127.0.0.1/32
</I>&gt;<i> 
</I>&gt;<i> Please let me know if you consider any of the above alternatives more
</I>&gt;<i> attractive (than adding new ACLs) or need me to detail their drawbacks.
</I>&gt;<i> 
</I>
I do like the below better. But for the record what was the drawback on
(B) that you saw as serious?
 This used to be what we were planning to add one day.

&gt;<i> 
</I>&gt;<i> Please note that the documentation below does not currently detail what
</I>&gt;<i> &quot;adding&quot; a foo=bar annotation means when there is already an annotation
</I>&gt;<i> named &quot;foo&quot;. During implementation, we will decide whether the new ACLs
</I>&gt;<i> should always append to the existing matching annotation and/or
</I>&gt;<i> overwrite it. The documentation will be adjusted accordingly, of course.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> * acl aclname annotate_transaction key value [fast]
</I>&gt;<i> 
</I>&gt;<i> Always matches. Used for its side effect: This ACL immediately adds
</I>&gt;<i> a key=value annotation to the current master transaction. The added
</I>&gt;<i> annotation can then be tested using note ACL and logged (or sent to
</I>&gt;<i> helpers) using %note format code. This ACL is especially useful for
</I>&gt;<i> recording complex multi-step ACL-driven decisions. For example:
</I>&gt;<i> 
</I>&gt;<i>     # Do not log transaction accepted after aclX matched
</I>&gt;<i> 
</I>&gt;<i>     # First, mark transactions accepted after aclX matched
</I>&gt;<i>     acl markSpecial annotate_transaction special true
</I>&gt;<i>     http_access allow acl001
</I>&gt;<i>     ...
</I>&gt;<i>     http_access deny acl100
</I>&gt;<i>     http_access allow aclX markSpecial
</I>&gt;<i> 
</I>&gt;<i>     # Second, do not log marked transactions:
</I>&gt;<i>     acl markedSpecial note special true
</I>&gt;<i>     access_log ... deny markedSpecial
</I>&gt;<i> 
</I>&gt;<i>     # Note that the following would not have worked because aclX
</I>&gt;<i>     # alone does not determine whether the transaction was allowed:
</I>&gt;<i>     # access_log ... deny markedSpecial # Wrong
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Warning: This ACL annotates the transaction even when negated and
</I>&gt;<i> even if subsequent ACLs fail to match. For example, the following
</I>&gt;<i> three rules will have exactly the same effect as far as annotations
</I>&gt;<i> set by the &quot;mark&quot; ACL are concerned:
</I>&gt;<i> 
</I>&gt;<i>     some_directive acl1 acl2 ... mark # rule matches if mark is reached
</I>&gt;<i>     some_directive acl1 acl2 ... !mark     # rule never matches
</I>&gt;<i>     some_directive acl1 acl2 ... mark !all # rule never matches
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> * acl aclname annotate_client key value [fast]
</I>&gt;<i> 
</I>&gt;<i> Always matches. Used for its side effect: This ACL immediately adds
</I>&gt;<i> a key=value annotation to the current client-to-Squid connection.
</I>&gt;<i> Connection annotations are propagated to the current and all future
</I>&gt;<i> master transactions on the annotated connection. All caveats for the
</I>&gt;<i> annotate_transaction ACL apply to this ACL.
</I>
I think the format should use explicitly the ' key=&quot;value&quot; ' syntax to
make it simpler to identify where the value ends and ACL sub-tree begin.

That will also allow us to define the above format as adding a new key
only if not already present. We could use key+=&quot;value&quot; syntax for
appending a value to an possibly existing key (or adding if none).

&quot;Always matches&quot; seems incorrect definition for this ACL. When 'fast' is
provided it should pass-thru the match or non-match result of the [fast]
ACL sub-tree, and only annotate when that result is a match.
 I assume [fast] default would be 'all' to always annotate and be true
if there was no sub-tree.

We will also have to be careful to blacklist the reserved key names that
require special processing to be correct:
 user, group, password, ttl, url, url-rewrite, etc.

Otherwise it seems good. Thanks.

Amos

</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006146.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
	<LI>Next message: <A HREF="006153.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6147">[ date ]</a>
              <a href="thread.html#6147">[ thread ]</a>
              <a href="subject.html#6147">[ subject ]</a>
              <a href="author.html#6147">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
