<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] annotate_transaction ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C57832E4A.6090808%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006160.html">
   <LINK REL="Next"  HREF="006184.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] annotate_transaction ACL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C57832E4A.6090808%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] annotate_transaction ACL">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jul 11 05:27:38 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006160.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
        <LI>Next message: <A HREF="006184.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6159">[ date ]</a>
              <a href="thread.html#6159">[ thread ]</a>
              <a href="subject.html#6159">[ subject ]</a>
              <a href="author.html#6159">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/09/2016 05:47 PM, Amos Jeffries wrote:
&gt;<i> On 10/07/2016 7:14 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> B. Add general ACL options to be able to force any existing ACL to add
</I>&gt;&gt;<i> an annotation:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     acl myOldAcl dst --annotate foo=bar 127.0.0.1/32
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please let me know if you consider any of the above alternatives more
</I>&gt;&gt;<i> attractive (than adding new ACLs) or need me to detail their drawbacks.
</I>

&gt;<i> I do like the below better. But for the record what was the drawback on
</I>&gt;<i> (B) that you saw as serious?
</I>
(B) will screw up many squid.conf parsers and ACL generator scripts that
cannot handle complex ACL parameters like

   --annotate foo=&quot;bar baz&quot;

This is especially true for ACLs that normally take no parameters at
all. There is already a big problem regarding ACL parameter scope in
multi-ACL lines, and it may be best to stay away from that.


(B) cannot add annotations to predefined/hard-coded ACLs like &quot;all&quot; and
also to frequently used ACLs like, say, &quot;trustedNetworks&quot;. As a
workaround, it would be possible to use named all-of or any-of ACLs
containing nothing but a hard-coded or frequently used ACL, but then we
may be better off with always naming marking ACLs to start with:

   # create a named alias for &quot;all&quot; so that we can annotate
   acl markCase123 any-of --annotate foo=bar all
   ...
   http_access deny markCase123

(B) is less explicit so there is more risk that annotations will be
accidentally added in lots of places they should not be.


&gt;&gt;<i> * acl aclname annotate_client key value [fast]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Always matches. Used for its side effect: This ACL immediately adds
</I>&gt;&gt;<i> a key=value annotation to the current client-to-Squid connection.
</I>&gt;&gt;<i> Connection annotations are propagated to the current and all future
</I>&gt;&gt;<i> master transactions on the annotated connection. All caveats for the
</I>&gt;&gt;<i> annotate_transaction ACL apply to this ACL.
</I>&gt;<i> 
</I>&gt;<i> I think the format should use explicitly the ' key=&quot;value&quot; ' syntax to
</I>&gt;<i> make it simpler to identify where the value ends and ACL sub-tree begin.
</I>&gt;<i> 
</I>&gt;<i> That will also allow us to define the above format as adding a new key
</I>&gt;<i> only if not already present. We could use key+=&quot;value&quot; syntax for
</I>&gt;<i> appending a value to an possibly existing key (or adding if none).
</I>
Yes, I was thinking about similar tricks as well. The key=value syntax
will tempt us to add support for setting several annotations with one
ACL, but perhaps that is OK.


&gt;<i> &quot;Always matches&quot; seems incorrect definition for this ACL. When 'fast' is
</I>&gt;<i> provided it should pass-thru the match or non-match result of the [fast]
</I>&gt;<i> ACL sub-tree, and only annotate when that result is a match.
</I>&gt;<i>  I assume [fast] default would be 'all' to always annotate and be true
</I>&gt;<i> if there was no sub-tree.
</I>
Err... The letters &quot;[fast]&quot; is just how we mark non-blocking ACLs in
squid.conf. That is, the proposed ACL syntax is just

    acl aclname annotate_client key value
or
    acl aclname annotate_client key=value


&quot;Always matches&quot; is exactly what we plan for this ACL. If you think it
should not match in some cases, please discuss which
transactions/connections it should not match.

One [documented] problem is that !foo will still annotate, which is a
little counter-intuitive, but I cannot think of a better approach.


&gt;<i> We will also have to be careful to blacklist the reserved key names that
</I>&gt;<i> require special processing to be correct:
</I>&gt;<i>  user, group, password, ttl, url, url-rewrite, etc.
</I>
Are those already reserved for annotations set by the external ACL? I
was hoping the new ACLs can reuse at least some external ACL code
related to annotations. No need to answer this one. We will research it
as needed.


Thank you,

Alex.

</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006160.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
	<LI>Next message: <A HREF="006184.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6159">[ date ]</a>
              <a href="thread.html#6159">[ thread ]</a>
              <a href="subject.html#6159">[ subject ]</a>
              <a href="author.html#6159">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
