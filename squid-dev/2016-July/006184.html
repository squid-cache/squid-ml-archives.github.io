<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] annotate_transaction ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C8e9e00ca-7787-6844-d037-df9af41c912a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006159.html">
   <LINK REL="Next"  HREF="006188.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] annotate_transaction ACL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C8e9e00ca-7787-6844-d037-df9af41c912a%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] annotate_transaction ACL">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 12 06:59:32 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006159.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
        <LI>Next message: <A HREF="006188.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6184">[ date ]</a>
              <a href="thread.html#6184">[ thread ]</a>
              <a href="subject.html#6184">[ subject ]</a>
              <a href="author.html#6184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/07/2016 5:27 p.m., Alex Rousskov wrote:
&gt;<i> On 07/09/2016 05:47 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 10/07/2016 7:14 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> B. Add general ACL options to be able to force any existing ACL to add
</I>&gt;&gt;&gt;<i> an annotation:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     acl myOldAcl dst --annotate foo=bar 127.0.0.1/32
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Please let me know if you consider any of the above alternatives more
</I>&gt;&gt;&gt;<i> attractive (than adding new ACLs) or need me to detail their drawbacks.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I do like the below better. But for the record what was the drawback on
</I>&gt;&gt;<i> (B) that you saw as serious?
</I>&gt;<i> 
</I>&gt;<i> (B) will screw up many squid.conf parsers and ACL generator scripts that
</I>&gt;<i> cannot handle complex ACL parameters like
</I>&gt;<i> 
</I>&gt;<i>    --annotate foo=&quot;bar baz&quot;
</I>&gt;<i> 
</I>&gt;<i> This is especially true for ACLs that normally take no parameters at
</I>&gt;<i> all. There is already a big problem regarding ACL parameter scope in
</I>&gt;<i> multi-ACL lines, and it may be best to stay away from that.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> (B) cannot add annotations to predefined/hard-coded ACLs like &quot;all&quot; and
</I>&gt;<i> also to frequently used ACLs like, say, &quot;trustedNetworks&quot;. As a
</I>&gt;<i> workaround, it would be possible to use named all-of or any-of ACLs
</I>&gt;<i> containing nothing but a hard-coded or frequently used ACL, but then we
</I>&gt;<i> may be better off with always naming marking ACLs to start with:
</I>&gt;<i> 
</I>&gt;<i>    # create a named alias for &quot;all&quot; so that we can annotate
</I>&gt;<i>    acl markCase123 any-of --annotate foo=bar all
</I>&gt;<i>    ...
</I>&gt;<i>    http_access deny markCase123
</I>&gt;<i> 
</I>&gt;<i> (B) is less explicit so there is more risk that annotations will be
</I>&gt;<i> accidentally added in lots of places they should not be.
</I>&gt;<i> 
</I>
Thanks. Yes the second point is a total killer.

&gt;<i> 
</I>&gt;&gt;&gt;<i> * acl aclname annotate_client key value [fast]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Always matches. Used for its side effect: This ACL immediately adds
</I>&gt;&gt;&gt;<i> a key=value annotation to the current client-to-Squid connection.
</I>&gt;&gt;&gt;<i> Connection annotations are propagated to the current and all future
</I>&gt;&gt;&gt;<i> master transactions on the annotated connection. All caveats for the
</I>&gt;&gt;&gt;<i> annotate_transaction ACL apply to this ACL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think the format should use explicitly the ' key=&quot;value&quot; ' syntax to
</I>&gt;&gt;<i> make it simpler to identify where the value ends and ACL sub-tree begin.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That will also allow us to define the above format as adding a new key
</I>&gt;&gt;<i> only if not already present. We could use key+=&quot;value&quot; syntax for
</I>&gt;&gt;<i> appending a value to an possibly existing key (or adding if none).
</I>&gt;<i> 
</I>&gt;<i> Yes, I was thinking about similar tricks as well. The key=value syntax
</I>&gt;<i> will tempt us to add support for setting several annotations with one
</I>&gt;<i> ACL, but perhaps that is OK.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> &quot;Always matches&quot; seems incorrect definition for this ACL. When 'fast' is
</I>&gt;&gt;<i> provided it should pass-thru the match or non-match result of the [fast]
</I>&gt;&gt;<i> ACL sub-tree, and only annotate when that result is a match.
</I>&gt;&gt;<i>  I assume [fast] default would be 'all' to always annotate and be true
</I>&gt;&gt;<i> if there was no sub-tree.
</I>&gt;<i> 
</I>&gt;<i> Err... The letters &quot;[fast]&quot; is just how we mark non-blocking ACLs in
</I>&gt;<i> squid.conf. That is, the proposed ACL syntax is just
</I>&gt;<i> 
</I>&gt;<i>     acl aclname annotate_client key value
</I>&gt;<i> or
</I>&gt;<i>     acl aclname annotate_client key=value
</I>&gt;<i> 
</I>
Sorry. Braindead moment there. I'm used to only seeing that at the end
of the textual description. Not the ABNF syntax.


&gt;<i> 
</I>&gt;<i> &quot;Always matches&quot; is exactly what we plan for this ACL. If you think it
</I>&gt;<i> should not match in some cases, please discuss which
</I>&gt;<i> transactions/connections it should not match.
</I>&gt;<i> 
</I>&gt;<i> One [documented] problem is that !foo will still annotate, which is a
</I>&gt;<i> little counter-intuitive, but I cannot think of a better approach.
</I>&gt;<i> 
</I>
Well, that issue is partially resolved in the design I was mistakenly
thinking you were suggesting.

If this ACL is implmented as a Node with a sub-tree, like any-of/all-of.
Which annotates whenever the sub-tree produces a match. Then the '!' on
it wont matter so much.

I was thinking to use it like this to annotate:

 # without annotation
 http_access allow localhost

 # with annotation &quot;localhost&quot; when its allowed:
 acl foo annotate_client key=&quot;localhost&quot; localhost
 http_access allow foo

 # with annotation &quot;localhost&quot; when its denied
 http_access deny foo


Or both of these being equivalent to &quot;deny !localhost&quot; with different
annotation when it denies:

 # annotates localhost, denies non-localhost stuff
 http_access deny !foo

 # annotates non-localhost and denies non-localhost stuff
 acl foo2 annotate_client key=&quot;non-localhost&quot; !localhost
 http_access deny foo2


&gt;<i> 
</I>&gt;&gt;<i> We will also have to be careful to blacklist the reserved key names that
</I>&gt;&gt;<i> require special processing to be correct:
</I>&gt;&gt;<i>  user, group, password, ttl, url, url-rewrite, etc.
</I>&gt;<i> 
</I>&gt;<i> Are those already reserved for annotations set by the external ACL? I
</I>&gt;<i> was hoping the new ACLs can reuse at least some external ACL code
</I>&gt;<i> related to annotations. No need to answer this one. We will research it
</I>&gt;<i> as needed.
</I>
Not just by external ACL. They are used in various ways by the helper
protocols to trigger things. Their existence usually signals that thing
has happened. But if its just an annotation without actually going
through the helper handlers to do that thing - they could badly confuse
people about whats happening.
 The user/password/group ones are most dangerous since they can be used
as input to external ACL with dangerous results to authorization.

Amos

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006159.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
	<LI>Next message: <A HREF="006188.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6184">[ date ]</a>
              <a href="thread.html#6184">[ thread ]</a>
              <a href="subject.html#6184">[ subject ]</a>
              <a href="author.html#6184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
