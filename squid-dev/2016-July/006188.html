<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] annotate_transaction ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C57850608.4040809%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006184.html">
   <LINK REL="Next"  HREF="006230.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] annotate_transaction ACL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20annotate_transaction%20ACL&In-Reply-To=%3C57850608.4040809%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] annotate_transaction ACL">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jul 12 15:00:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006184.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
        <LI>Next message: <A HREF="006230.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6188">[ date ]</a>
              <a href="thread.html#6188">[ thread ]</a>
              <a href="subject.html#6188">[ subject ]</a>
              <a href="author.html#6188">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/12/2016 12:59 AM, Amos Jeffries wrote:
&gt;<i> On 11/07/2016 5:27 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> * acl aclname annotate_client key value [fast]
</I>
&gt;&gt;<i> One [documented] problem is that !foo will still annotate, which is a
</I>&gt;&gt;<i> little counter-intuitive, but I cannot think of a better approach.
</I>

&gt;<i> Well, that issue is partially resolved in the design I was mistakenly
</I>&gt;<i> thinking you were suggesting.
</I>
I do not think your sub-tree design solves that problem, even partially,
because !foo annotates in your design as well (assuming foo itself
annotates). Moreover, I doubt this is a problem that can be solved! When
foo annotates,

  * if !foo annotates, some admins will be confused
  * if !foo does not annotate, some admins will be confused

My always-annotates design is the simplest among the various
confusing-for-some options: If Squid reaches your annotating ACL, it
_will_ annotate, no matter what happens afterwards.


&gt;<i> If this ACL is implmented as a Node with a sub-tree, like any-of/all-of.
</I>&gt;<i> Which annotates whenever the sub-tree produces a match. Then the '!' on
</I>&gt;<i> it wont matter so much.
</I>
I do not think it would make a difference because the &quot;!&quot; is applied
_after_ the new ACL, regardless of whether the new ACL is a leaf or a
sub-tree. In other words, the ACL itself does not know about its
subsequent negation. We used to _implement_ negation as an ACL flag, but
that [inferior for other reasons] design is long gone IIRC.

* In your proposal, the new ACL X matches/annotates when both the
previous ACLs in the same rule and X subtree match.

* In my proposal, the new ACL X matches when the previous ACLs in the
same rule match.

The latter is simpler.

Please note that one can still achieve your functionality with the
simpler approach by using an all-of ACL:

  acl foo_ annotate_client key=value
  acl foo  all-of sub-tree foo_

Also, if we add a sub-tree to the new ACL, then there is a question of
whether that sub-tree should be an &quot;all-of&quot; or &quot;any-of&quot; tree. Folks will
want both, and some will be confused about the actual support,
regardless of which one we actually support. In the simpler design,
there is no such question/confusion (but folks can still create all-of
and any-of subtrees if needed as the example above illustrates).


&gt;<i> I was thinking to use it like this to annotate:
</I>&gt;<i> 
</I>&gt;<i>  # without annotation
</I>&gt;<i>  http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i>  # with annotation &quot;localhost&quot; when its allowed:
</I>&gt;<i>  acl foo annotate_client key=&quot;localhost&quot; localhost
</I>&gt;<i>  http_access allow foo
</I>&gt;<i> 
</I>&gt;<i>  # with annotation &quot;localhost&quot; when its denied
</I>&gt;<i>  http_access deny foo
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Or both of these being equivalent to &quot;deny !localhost&quot; with different
</I>&gt;<i> annotation when it denies:
</I>&gt;<i> 
</I>&gt;<i>  # annotates localhost, denies non-localhost stuff
</I>&gt;<i>  http_access deny !foo
</I>&gt;<i> 
</I>&gt;<i>  # annotates non-localhost and denies non-localhost stuff
</I>&gt;<i>  acl foo2 annotate_client key=&quot;non-localhost&quot; !localhost
</I>&gt;<i>  http_access deny foo2
</I>
Yes, that would work, but I do not see any _advantages_ this added
complexity buys us, and I see some disadvantages (besides complexity).
One of the disadvantages is that to clearly see what traffic is denied
while reading http_access rules, one would have to use long ACL names,
re-telling the annotating ACL construction:

  # sub-tree approach where it is unclear what is denied
  http_access deny mark

  # sub-tree approach where it is unclear that denied traffic is marked
  http_access deny myLocalhost

  # clear sub-tree approach that duplicates information
  http_access deny localhost_and_mark

  # clear leaf approach
  http_access deny localhost mark


I suggest that we &quot;divide and conquer&quot; by using simplest,
dedicated-to-one-task ACLs. If my arguments above did not convince you,
please detail the advantages of the more complex sub-tree scheme.


Thank you,

Alex.

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006184.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
	<LI>Next message: <A HREF="006230.html">[squid-dev] [RFC] annotate_transaction ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6188">[ date ]</a>
              <a href="thread.html#6188">[ thread ]</a>
              <a href="subject.html#6188">[ subject ]</a>
              <a href="author.html#6188">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
