<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fetch missing certificates
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fetch%20missing%20certificates&In-Reply-To=%3C5788EE41.4040807%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006297.html">
   <LINK REL="Next"  HREF="006379.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fetch missing certificates</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fetch%20missing%20certificates&In-Reply-To=%3C5788EE41.4040807%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Fetch missing certificates">christos at chtsanti.net
       </A><BR>
    <I>Fri Jul 15 14:08:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006297.html">[squid-dev] [PATCH] Fetch missing certificates
</A></li>
        <LI>Next message: <A HREF="006379.html">[squid-dev] [PATCH] Fetch missing certificates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6289">[ date ]</a>
              <a href="thread.html#6289">[ thread ]</a>
              <a href="subject.html#6289">[ subject ]</a>
              <a href="author.html#6289">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A new patch.

It also includes the following fixes:
   - Sets the log_uri for ClientHttpRequest build by Downloader
   - Removes two XXX comments from PeerConnector class, which are not 
valid any more
   - Make the Downloader::CbDialer a CallDialer kid.


Please also see my comments bellow.

On 07/14/2016 02:16 PM, Amos Jeffries wrote:
&gt;<i> Audit of patch #2;
</I>&gt;<i>
</I>&gt;<i> This is mostly polish, but there are a few logic issues still present.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in the patch description / commit message:
</I>&gt;<i>
</I>&gt;<i> * s/independed /independent /
</I>&gt;<i>
</I>&gt;<i> * s/from net/from the network/
</I>&gt;<i>
</I>&gt;<i> * s/an Downloader class/class Downloader/
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * in newely added or altered documentation, comments and debugs please
</I>&gt;<i> refer to &quot;TLS&quot; not &quot;SSL&quot;.
</I>&gt;<i>
</I>
ok

&gt;<i>
</I>&gt;<i> in src/Downloader.cc:
</I>&gt;<i>
</I>&gt;<i> * missing copyright
</I>
ok

&gt;<i>
</I>&gt;<i> * in class DownloaderContext please use a empty line to separate the
</I>&gt;<i> methods and member variables.
</I>ok

&gt;<i>
</I>&gt;<i> * please use nullptr in new code instead of NULL
</I>&gt;<i>   - same applies in all the other changed parts too
</I>
ok

&gt;<i>
</I>&gt;<i> * please do not use &quot; X == NULL&quot; or &quot;X != NULL&quot; in boolean conditions
</I>&gt;<i> anymore (that includes assert or Must conditions).
</I>&gt;<i>   - C++11 provides proper boolean operators. If this causes problems with
</I>&gt;<i> any object then that object requires the bool operator's to be defined.
</I>
ok

&gt;<i>
</I>&gt;<i> * s/debugs(33 , /debugs(33, /
</I>
ok

&gt;<i>
</I>&gt;<i> * the debugs lines indicating constructor and destructor have been run
</I>&gt;<i> need to be symmetrical and name the object type.
</I>&gt;<i>
</I>&gt;<i>   - They are there for the find-alive.pl script, so need to match the
</I>&gt;<i> pattern it is searching for:
</I>&gt;<i>   eg. debugs(33, 6, &quot;Downloader constructed, this=&quot; &lt;&lt; (void*)this);
</I>&gt;<i>   eg. debugs(33, 6, &quot;Downloader destructed, this=&quot; &lt;&lt; (void*)this);
</I>&gt;<i>
</I>&gt;<i>   - same for other new objects contrustors and destructors. IF you have
</I>&gt;<i> debugs() namign them.
</I>
ok


&gt;<i>
</I>&gt;<i> * please do not add whitespace between function/name and first '(' in
</I>&gt;<i> any new code, it makes things much harder to find when not using an IDE.
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * in Downloader::~Downloader
</I>&gt;<i>
</I>&gt;<i>   - please reserve debugs level 2 for protocol activity.
</I>&gt;<i>    Since we are considering Downloader a type of high level protocol
</I>&gt;<i> actor its conceivable that we will want to use 11,2 for displaying its
</I>&gt;<i> HTTP-ish messages before the rest of Squid logic gets to mangle them.
</I>
I added 1-2 debugs in Downloader::buildRequest() method.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * Downloader::buildRequest method
</I>&gt;<i>
</I>&gt;<i>   - please use xstrdup() instead of strdup()
</I>
ok
&gt;<i>
</I>&gt;<i>   - please use the SBuf url_ member variable in the debugs instead of the
</I>&gt;<i> raw-char* pointer.
</I>ok

&gt;<i>
</I>&gt;<i>   - no need for safe_free() of a local variable before a return. use
</I>&gt;<i> xfree() instead.
</I>ok

&gt;<i>
</I>&gt;<i>   - debugs &quot;Invalid FTP URL&quot; ? perhapse &quot;Invalid URI&quot; would be more
</I>&gt;<i> accurate here.
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * Downloader::handleReply method
</I>&gt;<i>
</I>&gt;<i>   - &quot;TODO: remove the following check:&quot;  ? its followed by a casting.
</I>
The casting is used only for the check follows the casting.
I moved the TODO after casting.

&gt;<i>
</I>&gt;<i>   - 'const bool failed' is used only the once. There's no point having it
</I>&gt;<i> when the flag assigned to it can be tested directly by the if-condition.
</I>
In the future we may want other cases of failed. Maybe &quot;!reply&quot; or zero 
buffers size etc.
If no problem I prefer to leave it.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * Downloader::downloadFinished method
</I>&gt;<i>
</I>&gt;<i>   - please remove the commented deleteThis and comment above it. They are
</I>&gt;<i> not necessary after the Must(done())
</I>&gt;<i>   - that comment brings up the question of whether that Must() should be
</I>&gt;<i> confirming doneAll() instead of done() ?
</I>
The done() is a more general test, include the case the Downloader 
aborted for a reason.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/Downloader.h
</I>&gt;<i>
</I>&gt;<i> * missing copyright
</I>
ok

&gt;<i>
</I>&gt;<i> * please include http/forward.h instead of defining &quot;class HttpReply&quot;
</I>
ok

&gt;<i>
</I>&gt;<i>   - includes for base/AsyncCall.h and cbdata.h are also redundant and can
</I>&gt;<i> be removed
</I>ok

&gt;<i>
</I>&gt;<i>   - &quot;/* AsyncJob API */&quot; only needs to be put once.
</I>&gt;<i>     move methods up into the first ones list if necessary, and remove
</I>&gt;<i> whitespace lines between the API re-definitions.
</I>
ok

&gt;<i>
</I>&gt;<i>   - the parameter names on handleReply are no necessary, the line can be
</I>&gt;<i> shortened by removing them.
</I>
ok

&gt;<i>
</I>&gt;<i>   - our coding style places documentation of class 'private' methods in
</I>&gt;<i> the .cc file not the .h.
</I>
ok, I fixed them, but we should change this style.
It is easier to have open the .h file and read the documentation for a 
method you are going to use, than searching in the cc file to find the 
documentation.


&gt;<i>
</I>&gt;<i>   - the symbol name 'callback' has a clash between the private method,
</I>&gt;<i> and the private member Pointer. This is a case where the '_' suffix is
</I>&gt;<i> required to distinguish them.
</I>&gt;<i>    Ironically you have _ on most other members already. :-P
</I>
ok.

&gt;<i>   + since the private members mostly use '_' the 'SBuf object' one should
</I>&gt;<i> as well for consistency.
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/HttpRequest.h:
</I>&gt;<i>
</I>&gt;<i> * s/object intiated/which initiated/ and s/if exist/if any/
</I>&gt;<i>
</I>
ok

&gt;<i>
</I>&gt;<i> in src/Makefile.am:
</I>&gt;<i>
</I>&gt;<i> * list the .cc before the .h on new entries please.
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/base/AsyncJob.cc:
</I>&gt;<i>
</I>&gt;<i> * s/debugs(93 , /debugs(93, /
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/client_side_reply.cc:
</I>&gt;<i>
</I>&gt;<i> * please remove the method name string
</I>&gt;<i> &quot;clientReplyContext::sendMoreData:&quot; from the touched debugs() lines.
</I>
ok

&gt;<i>
</I>&gt;<i> * the Comm::IsConnOpen(conn-&gt;clientConnection) check can now be removed
</I>&gt;<i> from the TOS/NFMARK tests, since the new conn-&gt;isOpen() check now
</I>&gt;<i> handles that case.
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/security/Handshake.cc:
</I>&gt;<i>
</I>&gt;<i> * Security::HandshakeParser::ParseCertificate #else condition is empty
</I>&gt;<i> and should be removed.
</I>&gt;<i>
</I>&gt;<i> * You should also be able to write its body simpler in C++11:
</I>&gt;<i>
</I>&gt;<i>    +  typedef const unsigned char *x509Data;
</I>&gt;<i>    +  const x509Data x509Start =
</I>&gt;<i> reinterpret_cast&lt;x509Data&gt;(raw.rawContent());
</I>&gt;<i>    +  x509Data x509Pos = x509Start;
</I>&gt;<i>
</I>&gt;<i>   becomes:
</I>&gt;<i>
</I>&gt;<i>    +  auto x509Pos = reinterpret_cast&lt;unsigned char *&gt;(raw.rawContent());
</I>&gt;<i>    +  const auto x509Start = x509Pos;
</I>
ok


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/security/forward.h:
</I>&gt;<i>
</I>&gt;<i> * please put CertList before CertRevokeList.
</I>&gt;<i>   I'm trying to keep these alphabetical for easier patch porting in future.
</I>&gt;<i>
</I>
ok


&gt;<i>
</I>&gt;<i> in src/ssl/PeerConnector.cc:
</I>&gt;<i>
</I>&gt;<i> * Ssl::PeerConnector::certDownloadingDone
</I>&gt;<i>
</I>&gt;<i>   - what does the downloadStatus status parameter mean? what values can
</I>&gt;<i> it have?
</I>
It is the HTTP status code.
This patch does not check for this.
If there are returned data and if they are a valid certificate, it 
consider the response valid.

&gt;<i>
</I>&gt;<i>   - please pre-increment certsDownloads instead of post-increment.
</I>
ok

&gt;<i>
</I>&gt;<i>   - why is DER format being used here? I think I know, but it needs to be
</I>&gt;<i> stated for clarity, Squid normally uses PEM format.
</I>
The DER format is used by RFCs for this and similar cases.

&gt;<i>
</I>&gt;<i>   - &quot;check if __ has uri to download from&quot; missing words, and s/uri/URI/
</I>&gt;<i>
</I>&gt;<i>   - s/checkForMissingCertificates ()/checkForMissingCertificates()/
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * in Ssl::PeerConnector::checkForMissingCertificates and
</I>&gt;<i> Ssl::PeerConnector::startCertDownloading
</I>&gt;<i>
</I>&gt;<i>   - request-&gt;downloader is a CbcPointer&lt;Dowloader&gt; already. so get()
</I>&gt;<i> produces a Downloader raw-pointer.
</I>&gt;<i>
</I>&gt;<i> which means instead of this mess:
</I>&gt;<i>    const Downloader *csd = dynamic_cast&lt;const
</I>&gt;<i> Downloader*&gt;(request-&gt;downloader.valid());
</I>&gt;<i>
</I>&gt;<i> You should be able to do:
</I>&gt;<i>   const auto *csd = request-&gt;downloader.get();
</I>&gt;<i>
</I>&gt;<i> Or better, use the CbcPointer instead of a raw-pointer. Most of the
</I>&gt;<i> things using csd dont need a raw-pointer at all. You can probably just use:
</I>&gt;<i>    const auto &amp;csd = request-&gt;downloader;
</I>

OK for &quot;get()&quot; instead of valid() and static cast.

But I am not a fan of the &quot;auto&quot; type.
It is good to avoid searching/typing strange names like those we are 
using in iterators but my opinion is that we must not overuse it.
Else we would have to search for a class member declaration to find out 
the correct type of a parameter.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/PeerConnector.h:
</I>&gt;<i>
</I>&gt;<i> * since certsDownloads is apparently constrained to values up to
</I>&gt;<i> MaxCertsDownloads. Can we please use a small integer type like uint8_t
</I>&gt;<i> instead of a full 'int' ?
</I>
  The MaxCertsDownloads normally will have a value of 10 or 15 or 20.
In practice we do not care about its size, it can be 8bit, 16bit, 32bit 
or 64bit integer. Also we do not care about the memory space it 
requires. In the cases where we do not care about the size of a 
parameter it is not bad idea to use the general data type.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/bio.h:
</I>&gt;<i>
</I>&gt;<i> * Please use doxygen \retval or \return instead of &quot;Returns&quot; on the new
</I>&gt;<i> gotHello*() methods
</I>&gt;<i>
</I>&gt;<i> * serverCertificatesIfAny() is not documented
</I>&gt;<i>
</I>ok


&gt;<i>
</I>&gt;<i> in src/ssl/support.cc:
</I>&gt;<i>
</I>&gt;<i> * C++ casting please, not C-style.
</I>
ok,


&gt;<i>
</I>&gt;<i> * the new function Ssl::uriOfIssuerIfMissing contains a comment:
</I>&gt;<i>    // There is a URI where we can download a certificate.
</I>&gt;<i>    // Check to see if this is required.
</I>

I remove this comment.

&gt;<i>
</I>&gt;<i> ... but it does not check anything, it just returns the value found.
</I>&gt;<i>    - I think that second line of comment needs to be dropped.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * in Ssl::missingChainCertificatesUrls since the for-loop is iterating
</I>&gt;<i> over all values each time. Use a C++11 for-each loop here
</I>&gt;<i>    for (const auto &amp;i : serverCertificates) {
</I>&gt;<i>    }
</I>
ok

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> in src/ssl/support.h:
</I>&gt;<i>
</I>&gt;<i> * can we use Security::CertPointer for the second parameter of
</I>&gt;<i> CertsIndexedList ?
</I>
I am not seeing any reason.
In any case we can do it with an other patch if required.

&gt;<i>
</I>&gt;<i> * dont use \ingroup for newly added items.
</I>&gt;<i>   - they should be in an appropriate namespace instead (Ssl:: for these).
</I>&gt;<i>
</I>
ok

&gt;<i>
</I>&gt;<i> * useSquidUntrusted() appears to be defined twice in a row.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-112-fetch-certificates-t4.patch
Type: text/x-patch
Size: 73392 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160715/c8aa5553/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160715/c8aa5553/attachment-0001.bin</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006297.html">[squid-dev] [PATCH] Fetch missing certificates
</A></li>
	<LI>Next message: <A HREF="006379.html">[squid-dev] [PATCH] Fetch missing certificates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6289">[ date ]</a>
              <a href="thread.html#6289">[ thread ]</a>
              <a href="subject.html#6289">[ subject ]</a>
              <a href="author.html#6289">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
