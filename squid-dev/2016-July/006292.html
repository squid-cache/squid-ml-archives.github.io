<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C5788F5C3.9030108%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006410.html">
   <LINK REL="Next"  HREF="006337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C5788F5C3.9030108%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Fri Jul 15 14:40:03 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006410.html">[squid-dev] [RFC] &quot;Splicing&quot; bumped requests to	resolve\workaround WebSockets issues.
</A></li>
        <LI>Next message: <A HREF="006337.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6292">[ date ]</a>
              <a href="thread.html#6292">[ thread ]</a>
              <a href="subject.html#6292">[ subject ]</a>
              <a href="author.html#6292">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

There are situations when Squid logs nothing to access.log after an
[abnormal] transaction termination. Such &quot;stealthy&quot; transactions may be
a security risk and an accounting problem.

ClientHttpRequest is responsible for logging most transactions but that
object is created only after the HTTP request headers are successfully
parsed. Request header parsing errors may be detected and logged
appropriately, but the job handling the incoming transaction may
terminate for reasons outside the parsing code control (e.g., a job-
killing exception thrown when there are no request headers to start
parsing yet or when the job waits for more request headers to finishing
parsing).

This change adds access logging for two cases:

1. accept(2) system call errors (before ConnStateData job is created);

2. unexpected ConnStateData job termination, when there is no
    ClientHttpRequest to log the failure.

TODO: Squid still logs nothing when the connection closes before reading
request header data. We should probably make that behavior configurable
because such connections drain Squid resources (and, hence, should be
logged) but some browsers are known to routinely create them (and,
hence, logging them by default may create too much noise).

Regards,
Eduard.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-170-some-failed-transactions-not-logged-t6.patch
Type: text/x-patch
Size: 24104 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160715/1512cf99/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160715/1512cf99/attachment-0001.bin</A>&gt;
</PRE>











































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006410.html">[squid-dev] [RFC] &quot;Splicing&quot; bumped requests to	resolve\workaround WebSockets issues.
</A></li>
	<LI>Next message: <A HREF="006337.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6292">[ date ]</a>
              <a href="thread.html#6292">[ thread ]</a>
              <a href="subject.html#6292">[ subject ]</a>
              <a href="author.html#6292">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
