<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Broken trunk after r14735, r14726
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3Cb8b6ee71-afdc-22fe-88d0-b61e38cdd55e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006301.html">
   <LINK REL="Next"  HREF="006327.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Broken trunk after r14735, r14726</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3Cb8b6ee71-afdc-22fe-88d0-b61e38cdd55e%40treenet.co.nz%3E"
       TITLE="[squid-dev] Broken trunk after r14735, r14726">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jul 16 12:56:14 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006301.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
        <LI>Next message: <A HREF="006327.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6325">[ date ]</a>
              <a href="thread.html#6325">[ thread ]</a>
              <a href="subject.html#6325">[ subject ]</a>
              <a href="author.html#6325">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/07/2016 7:02 a.m., Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     There are two more recent changes that broke trunk:
</I>&gt;<i> 
</I>&gt;<i> * After r14735 (Replaced TidyPointer with std::unique_ptr), Squid cannot
</I>&gt;<i> start due to an &quot;std::bad_function_call&quot; exception.
</I>&gt;<i> 
</I>&gt;<i> * After r14726 (GnuTLS: support for TLS session resume): Squid segfaults
</I>&gt;<i> when attempting to connect to a Secure ICAP service. Official Squid
</I>&gt;<i> v4.0.12 suffers from this bug.
</I>&gt;<i> 
</I>&gt;<i> Stack traces from both crashes are quoted at the end of this email.
</I>&gt;<i> 
</I>&gt;<i> Please fix these regressions or undo the changes that created or exposed
</I>&gt;<i> them.
</I>&gt;<i> 
</I>
&lt;snip&gt;
&gt;<i> * segfault when attempting to connect to a Secure ICAP REQMOD service
</I>&gt;<i> (tested with r14726, r14734):
</I>&gt;<i> 
</I>
Does this patch fix the session issue ?

=== modified file 'src/security/Session.cc'
--- src/security/Session.cc     2016-07-07 19:03:02 +0000
+++ src/security/Session.cc     2016-07-16 12:43:38 +0000
@@ -53,7 +53,7 @@
 void
 Security::SetSessionResumeData(const Security::SessionPtr &amp;s, const
Security::SessionStatePointer &amp;data)
 {
-    if (s) {
+    if (data) {
 #if USE_OPENSSL
         (void)SSL_set_session(s, data.get());
 #elif USE_GNUTLS


I'm a little worried about the code calling SetSessionResumeData.
OpenSSL documentation states:
  &quot;If there is already a session set inside ssl (because it was set with
SSL_set_session() before or because the same ssl was already used for a
connection), SSL_SESSION_free() will be called for that session.&quot;

But our SetSessionResumeData() is called after setting up the sessions
host data, etc. So I'm thinking all that setup in
Ssl::BlindPeerConnector::initializeTls() may be thrown away by the
resume action being called.


Amos
</PRE>






























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006301.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
	<LI>Next message: <A HREF="006327.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6325">[ date ]</a>
              <a href="thread.html#6325">[ thread ]</a>
              <a href="subject.html#6325">[ subject ]</a>
              <a href="author.html#6325">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
