<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C1dd014f0-32e4-2464-5e8b-d46d7bfdd384%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006292.html">
   <LINK REL="Next"  HREF="006354.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C1dd014f0-32e4-2464-5e8b-d46d7bfdd384%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jul 17 09:34:19 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006292.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
        <LI>Next message: <A HREF="006354.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6337">[ date ]</a>
              <a href="thread.html#6337">[ thread ]</a>
              <a href="subject.html#6337">[ subject ]</a>
              <a href="author.html#6337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/07/2016 2:40 a.m., Eduard Bagdasaryan wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> There are situations when Squid logs nothing to access.log after an
</I>&gt;<i> [abnormal] transaction termination. Such &quot;stealthy&quot; transactions may be
</I>&gt;<i> a security risk and an accounting problem.
</I>&gt;<i> 
</I>&gt;<i> ClientHttpRequest is responsible for logging most transactions but that
</I>&gt;<i> object is created only after the HTTP request headers are successfully
</I>&gt;<i> parsed. Request header parsing errors may be detected and logged
</I>&gt;<i> appropriately, but the job handling the incoming transaction may
</I>&gt;<i> terminate for reasons outside the parsing code control (e.g., a job-
</I>&gt;<i> killing exception thrown when there are no request headers to start
</I>&gt;<i> parsing yet or when the job waits for more request headers to finishing
</I>&gt;<i> parsing).
</I>&gt;<i> 
</I>&gt;<i> This change adds access logging for two cases:
</I>&gt;<i> 
</I>&gt;<i> 1. accept(2) system call errors (before ConnStateData job is created);
</I>&gt;<i> 
</I>&gt;<i> 2. unexpected ConnStateData job termination, when there is no
</I>&gt;<i>    ClientHttpRequest to log the failure.
</I>&gt;<i> 
</I>&gt;<i> TODO: Squid still logs nothing when the connection closes before reading
</I>&gt;<i> request header data. We should probably make that behavior configurable
</I>&gt;<i> because such connections drain Squid resources (and, hence, should be
</I>&gt;<i> logged) but some browsers are known to routinely create them (and,
</I>&gt;<i> hence, logging them by default may create too much noise).
</I>
IMO these should be logged by default (with option to ignore). We have
often enough queries about what all the open but never-used connections
listed by netstat are about.


Now the audit:

** A release notes mention about these changes is needed. Nothing major,
just an entry for access_log under 'changes to existing squid.conf
options', and line for each affected transaction type saying what its
logged as.

 + Something like:

    &lt;tag&gt;access_log&lt;/tag&gt;
    &lt;p&gt;TCP accept(2) errors logged in access.log with URI &lt;em&gt;error:...&lt;/em&gt;
    &lt;p&gt;Unused connections received in &lt;em&gt;http_port&lt;/em&gt; or
&lt;em&gt;https_port&lt;/em&gt; logged with URI &lt;em&gt;error:...&lt;/em&gt;

 - can these URI be logged with url_regex ACLs on access_log lines?
   If so, theres the answer to people wanting to hide any frequently
occuring ones. ie the TODO is already implememented in a good way.


in src/client_side.cc:

* thanks for identifying the ConnStateData::clientParseRequests()
redundant code. I have applied that to trunk separately as rev.14747.,
it seems out of scope for this patch.


* ConnStateData::checkLogging()

 - why is pipeline.back() being checked instead of pipeline.front() ?
  [not saying its wrong yet, just asking for a good reason.]

 - the if (inBuf.isEmpty()) check is not right for &quot;connections that
sent us no bytes&quot;. Squid can reach that test on an idle connection
between HTTP requests (quite common situation). That case also proves
the XXX assumption is wrong.

I think the condition needs to be changed to:
  if (receivedFirstByte() &amp;&amp; inBuf.isEmpty())
      return;

  + the case of !receivedFirstByte() is the &quot;connections that sent us no
bytes&quot;. Which will now fall through to do the logging.

  + which still leaves not-logging at least the cases where TLS bytes or
such layered things have occured but no HTTP bytes yet (and the inBuf
empty right now). That needs an explicit mention, and deserves an XXX or
TODO (different than the &quot;assumes ...&quot; one.)



in src/comm/TcpAcceptor.cc:

* logAcceptError needs to use Squid coding style of the return-type on
line above the function name. Same as the other surrounding functions
and methods.

* logAcceptError() should use a distinct &quot;error:&quot; URI labeling this as a
TCP accept error, since it has nothing to do with HTTP state.


Thank you
Amos

</PRE>


































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006292.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
	<LI>Next message: <A HREF="006354.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6337">[ date ]</a>
              <a href="thread.html#6337">[ thread ]</a>
              <a href="subject.html#6337">[ subject ]</a>
              <a href="author.html#6337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
