<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] reduce MISS on transients collision
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20reduce%20MISS%20on%20transients%20collision&In-Reply-To=%3C0095e503-eb0a-837a-59c0-4427a2121844%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006416.html">
   <LINK REL="Next"  HREF="006343.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] reduce MISS on transients collision</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20reduce%20MISS%20on%20transients%20collision&In-Reply-To=%3C0095e503-eb0a-837a-59c0-4427a2121844%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] reduce MISS on transients collision">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jul 17 11:01:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006416.html">[squid-dev] [PATCH] Collapse internal revalidation requests (SMP-unaware caches)
</A></li>
        <LI>Next message: <A HREF="006343.html">[squid-dev] [RFC] reduce MISS on transients collision
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6340">[ date ]</a>
              <a href="thread.html#6340">[ thread ]</a>
              <a href="subject.html#6340">[ subject ]</a>
              <a href="author.html#6340">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've just been looking at the Store::Controller::find() implementation
and it struck me that if the transients lookup has an error the object
will fail to HIT on any existing cache entries.

It seems to me that failure on any specific lookup should continue
checking the alternative places.


Alex; am I missing something undocumented here ?


 /// Internal method to implements the guts of the Store::get() API:
 /// returns an in-transit or cached object with a given key, if any.
 StoreEntry *
 Store::Controller::find(const cache_key *key)
 {
     ... check for store_table hash entry ...

     // Must search transients before caches because we must sync those
we find.
     if (transients) {
         if (StoreEntry *e = transients-&gt;get(key)) {
             debugs(20, 3, &quot;got shared in-transit entry: &quot; &lt;&lt; *e);
             bool inSync = false;
             const bool found = anchorCollapsed(*e, inSync);
             if (!found || inSync)
                 return e;
             assert(!e-&gt;locked()); // ensure release will
destroyStoreEntry()
             e-&gt;release(); // do not let others into the same trap
-            return NULL;
+            // continue on to maybe find it in cache
         }
     }

     if (memStore) {
         if (StoreEntry *e = memStore-&gt;get(key)) {
             debugs(20, 3, HERE &lt;&lt; &quot;got mem-cached entry: &quot; &lt;&lt; *e);
             return e;
         }
     }

     if (swapDir) {
         if (StoreEntry *e = swapDir-&gt;get(key)) {
             debugs(20, 3, &quot;got disk-cached entry: &quot; &lt;&lt; *e);
             return e;
         }
     }

     debugs(20, 4, &quot;cannot locate &quot; &lt;&lt; storeKeyText(key));
     return nullptr;
 }



Amos
</PRE>





















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006416.html">[squid-dev] [PATCH] Collapse internal revalidation requests (SMP-unaware caches)
</A></li>
	<LI>Next message: <A HREF="006343.html">[squid-dev] [RFC] reduce MISS on transients collision
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6340">[ date ]</a>
              <a href="thread.html#6340">[ thread ]</a>
              <a href="subject.html#6340">[ subject ]</a>
              <a href="author.html#6340">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
