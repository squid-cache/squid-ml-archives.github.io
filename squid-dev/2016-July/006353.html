<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Broken trunk after r14735, r14726
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3C578CB98D.1040504%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006351.html">
   <LINK REL="Next"  HREF="006357.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Broken trunk after r14735, r14726</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3C578CB98D.1040504%40chtsanti.net%3E"
       TITLE="[squid-dev] Broken trunk after r14735, r14726">christos at chtsanti.net
       </A><BR>
    <I>Mon Jul 18 11:12:14 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006351.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
        <LI>Next message: <A HREF="006357.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6353">[ date ]</a>
              <a href="thread.html#6353">[ thread ]</a>
              <a href="subject.html#6353">[ subject ]</a>
              <a href="author.html#6353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/16/2016 03:56 PM, Amos Jeffries wrote:
&gt;<i> On 16/07/2016 7:02 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      There are two more recent changes that broke trunk:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * After r14735 (Replaced TidyPointer with std::unique_ptr), Squid cannot
</I>&gt;&gt;<i> start due to an &quot;std::bad_function_call&quot; exception.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * After r14726 (GnuTLS: support for TLS session resume): Squid segfaults
</I>&gt;&gt;<i> when attempting to connect to a Secure ICAP service. Official Squid
</I>&gt;&gt;<i> v4.0.12 suffers from this bug.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Stack traces from both crashes are quoted at the end of this email.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please fix these regressions or undo the changes that created or exposed
</I>&gt;&gt;<i> them.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &lt;snip&gt;
</I>&gt;&gt;<i> * segfault when attempting to connect to a Secure ICAP REQMOD service
</I>&gt;&gt;<i> (tested with r14726, r14734):
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Does this patch fix the session issue ?
</I>&gt;<i>
</I>&gt;<i> === modified file 'src/security/Session.cc'
</I>&gt;<i> --- src/security/Session.cc     2016-07-07 19:03:02 +0000
</I>&gt;<i> +++ src/security/Session.cc     2016-07-16 12:43:38 +0000
</I>&gt;<i> @@ -53,7 +53,7 @@
</I>&gt;<i>   void
</I>&gt;<i>   Security::SetSessionResumeData(const Security::SessionPtr &amp;s, const
</I>&gt;<i> Security::SessionStatePointer &amp;data)
</I>&gt;<i>   {
</I>&gt;<i> -    if (s) {
</I>&gt;<i> +    if (data) {
</I>&gt;<i>   #if USE_OPENSSL
</I>&gt;<i>           (void)SSL_set_session(s, data.get());
</I>&gt;<i>   #elif USE_GNUTLS
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'm a little worried about the code calling SetSessionResumeData.
</I>&gt;<i> OpenSSL documentation states:
</I>&gt;<i>    &quot;If there is already a session set inside ssl (because it was set with
</I>&gt;<i> SSL_set_session() before or because the same ssl was already used for a
</I>&gt;<i> connection), SSL_SESSION_free() will be called for that session.&quot;
</I>&gt;<i>
</I>&gt;<i> But our SetSessionResumeData() is called after setting up the sessions
</I>&gt;<i> host data, etc. So I'm thinking all that setup in
</I>&gt;<i> Ssl::BlindPeerConnector::initializeTls() may be thrown away by the
</I>&gt;<i> resume action being called.
</I>&gt;<i>
</I>
Squid crashes at the first TLS connection trying to establish to the 
ICAP server.  There is not any session to resume so the SSL session 
related methods should not called at all.

It is a strange crash. Is it a corrupted SSL object?

I must say that I am worrying a lot for all of these changes.
It is very difficult for me to follow them, and already I have 
difficulties to read and debug squid openSSL relate code.

We are using our own naming scheme for openSSL structures, eg 
&quot;Security::SessionPtr&quot; instead of &quot;SSL *&quot; or 
&quot;Security::SessionStatePointer&quot; instead of &quot;SSL_SESSION *&quot; and this is 
make it very difficult to follow Squid/openSSL code.

It is difficult to read an example openSSL code and trying convert it to 
squid, or reading a reference implementation and trying check against 
squid code. Someone is obligated to search for definitions and 
equivalents types all the time.

I have not ever study for a good way to support both GnuTLS and openSSL 
for squid, to know the problems,  but probably I would start to 
implement openSSLAcceptor/gnuTlsAcceptor and 
openSSLPeerConnector/gnuTLSPeerConnector classes.
Internally gnuTLS and openSSL should use their own types. This is will 
help current and future squid developers.

I am just expressing my worries here, I do not want to impose anything 
and if there was a related discussion in squid-dev, sorry that I do not 
participate and I did not express my concerns earlier.

Regards,
    Christos



</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006351.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
	<LI>Next message: <A HREF="006357.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6353">[ date ]</a>
              <a href="thread.html#6353">[ thread ]</a>
              <a href="subject.html#6353">[ subject ]</a>
              <a href="author.html#6353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
