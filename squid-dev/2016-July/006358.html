<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C578CED25.6030001%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006354.html">
   <LINK REL="Next"  HREF="006366.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C578CED25.6030001%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jul 18 14:52:21 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006354.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
        <LI>Next message: <A HREF="006366.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6358">[ date ]</a>
              <a href="thread.html#6358">[ thread ]</a>
              <a href="subject.html#6358">[ subject ]</a>
              <a href="author.html#6358">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/17/2016 03:34 AM, Amos Jeffries wrote:
&gt;<i> On 16/07/2016 2:40 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;<i> +    // do not log connections that sent us no bytes (TODO: make configurable)
</I>&gt;&gt;<i> +    // do not log connections that closed after a transaction (those are normal)
</I>&gt;&gt;<i> +    // XXX: We assume that all inBuf consumption cases were covered above.
</I>&gt;&gt;<i> +    if (inBuf.isEmpty())
</I>&gt;&gt;<i> +        return;
</I>
&gt;<i>  - the if (inBuf.isEmpty()) check is not right for &quot;connections that
</I>&gt;<i> sent us no bytes&quot;. 
</I>
Connections that sent us no bytes will have an empty inBuf and will not
be logged, just like the comment promises. The fact that some _other_
connections may also have an empty inBuf (and will not be logged) is
already implied by the second &quot;do not log&quot; comment. I agree that the two
comments do not cover all cases and so at least one more comment (or
code restructuring to cover all known cases) is needed, but the existing
comments appear to be correct.


&gt;<i> Squid can reach that test on an idle connection
</I>&gt;<i> between HTTP requests (quite common situation). 
</I>
... which is already documented by the second &quot;do not log&quot; comment. The
grouped comments ought to be interpreted together, of course.


&gt;<i> That case also proves the XXX assumption is wrong.
</I>
The unsubstantiated (hence XXX) assumption is not about sent-nothing
(after start or after the last request) cases. It is difficult to
formulate it correctly without writing a whole paragraph, but we are
trying to say that if something goes into inBuf, then it can only be
consumed by cases covered by the two if-statements above the XXX. We
should reword or move that XXX to clarify.

Perhaps the following sketch that moves XXX up and details it a little
would work better?

&gt;<i>  // if we are parsing request body, its request is responsible for logging
</I>&gt;<i> if (bodyPipe)
</I>&gt;<i>   return;
</I>&gt;<i> 
</I>&gt;<i> // a request currently using this connection is responsible for logging
</I>&gt;<i> if (!pipeline.empty() &amp;&amp; pipeline.back()-&gt;mayUseConnection())
</I>&gt;<i>   return;
</I>&gt;<i> 
</I>&gt;<i> /* Either we are waiting for the very first transaction, or
</I>&gt;<i>  * we are done with the Nth transaction and are waiting for N+1st.
</I>&gt;<i>  * XXX: We assume that if anything was added to inBuf, then it could
</I>&gt;<i>  * only be consumed by actions already covered by the above checks.
</I>&gt;<i>  */
</I>&gt;<i> 
</I>&gt;<i> // do not log connections that sent us no bytes (TODO: make configurable)
</I>&gt;<i> // do not log connections that closed after a transaction (those are normal)
</I>&gt;<i> // XXX: TLS bytes are consumed without going through inBuf
</I>&gt;<i> // XXX: PROXY protocol bytes are consumed without going through inBuf
</I>&gt;<i> if (inBuf.isEmpty())
</I>&gt;<i>   return;
</I>

We agree that sent-nothing connections should be logged. I am not
against logging them by default (unless others have evidence to prove
that it would create too much noise). However, logging sent-nothing
connections probably requires a configuration option and can be
considered outside this patch scope -- the patch is improving access
logging without claiming to fix all access logging bugs.

If you are sure that logging all sent-nothing connections *without an
option to disable that behavior* is the right thing to do in v4, then
let's ask Eduard to cover that case using receivedFirstByte().


&gt;<i>   + which still leaves not-logging at least the cases where TLS bytes or
</I>&gt;<i> such layered things have occured but no HTTP bytes yet (and the inBuf
</I>&gt;<i> empty right now). That needs an explicit mention, and deserves an XXX or
</I>&gt;<i> TODO (different than the &quot;assumes ...&quot; one.)
</I>
I agree that TLS should be either handled or explicitly excluded with an
XXX comment. Another potentially relevant case to handle or explicitly
exclude is the PROXY protocol, right? I added two XXXs to cover those in
the above sketch.


Thank you,

Alex.

</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006354.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
	<LI>Next message: <A HREF="006366.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6358">[ date ]</a>
              <a href="thread.html#6358">[ thread ]</a>
              <a href="subject.html#6358">[ subject ]</a>
              <a href="author.html#6358">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
