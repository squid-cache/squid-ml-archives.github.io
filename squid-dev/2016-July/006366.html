<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3Ccabf3878-9d69-4c4c-45ea-92a379138b97%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006358.html">
   <LINK REL="Next"  HREF="006369.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3Ccabf3878-9d69-4c4c-45ea-92a379138b97%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 19 05:13:42 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006358.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
        <LI>Next message: <A HREF="006369.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6366">[ date ]</a>
              <a href="thread.html#6366">[ thread ]</a>
              <a href="subject.html#6366">[ subject ]</a>
              <a href="author.html#6366">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/07/2016 2:52 a.m., Alex Rousskov wrote:
&gt;<i> On 07/17/2016 03:34 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 16/07/2016 2:40 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;&gt;<i> +    // do not log connections that sent us no bytes (TODO: make configurable)
</I>&gt;&gt;&gt;<i> +    // do not log connections that closed after a transaction (those are normal)
</I>&gt;&gt;&gt;<i> +    // XXX: We assume that all inBuf consumption cases were covered above.
</I>&gt;&gt;&gt;<i> +    if (inBuf.isEmpty())
</I>&gt;&gt;&gt;<i> +        return;
</I>&gt;<i> 
</I>&gt;&gt;<i>  - the if (inBuf.isEmpty()) check is not right for &quot;connections that
</I>&gt;&gt;<i> sent us no bytes&quot;. 
</I>&gt;<i> 
</I>&gt;<i> Connections that sent us no bytes will have an empty inBuf and will not
</I>&gt;<i> be logged, just like the comment promises. The fact that some _other_
</I>&gt;<i> connections may also have an empty inBuf (and will not be logged) is
</I>&gt;<i> already implied by the second &quot;do not log&quot; comment. I agree that the two
</I>&gt;<i> comments do not cover all cases and so at least one more comment (or
</I>&gt;<i> code restructuring to cover all known cases) is needed, but the existing
</I>&gt;<i> comments appear to be correct.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Squid can reach that test on an idle connection
</I>&gt;&gt;<i> between HTTP requests (quite common situation). 
</I>&gt;<i> 
</I>&gt;<i> ... which is already documented by the second &quot;do not log&quot; comment. The
</I>&gt;<i> grouped comments ought to be interpreted together, of course.
</I>&gt;<i> 
</I>
It is. But also results in the TODO about implementing logging those
transactions which have not yet reeived reqeust headers / &quot;first byte&quot;.
Resolving that TODO is easy and what I'm aiming at here.

&gt;<i> 
</I>&gt;&gt;<i> That case also proves the XXX assumption is wrong.
</I>&gt;<i> 
</I>&gt;<i> The unsubstantiated (hence XXX) assumption is not about sent-nothing
</I>&gt;<i> (after start or after the last request) cases. It is difficult to
</I>&gt;<i> formulate it correctly without writing a whole paragraph, but we are
</I>&gt;<i> trying to say that if something goes into inBuf, then it can only be
</I>&gt;<i> consumed by cases covered by the two if-statements above the XXX. We
</I>&gt;<i> should reword or move that XXX to clarify.
</I>&gt;<i> 
</I>&gt;<i> Perhaps the following sketch that moves XXX up and details it a little
</I>&gt;<i> would work better?
</I>&gt;<i> 
</I>&gt;&gt;<i>  // if we are parsing request body, its request is responsible for logging
</I>&gt;&gt;<i> if (bodyPipe)
</I>&gt;&gt;<i>   return;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> // a request currently using this connection is responsible for logging
</I>&gt;&gt;<i> if (!pipeline.empty() &amp;&amp; pipeline.back()-&gt;mayUseConnection())
</I>&gt;&gt;<i>   return;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /* Either we are waiting for the very first transaction, or
</I>&gt;&gt;<i>  * we are done with the Nth transaction and are waiting for N+1st.
</I>&gt;&gt;<i>  * XXX: We assume that if anything was added to inBuf, then it could
</I>&gt;&gt;<i>  * only be consumed by actions already covered by the above checks.
</I>&gt;&gt;<i>  */
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> // do not log connections that sent us no bytes (TODO: make configurable)
</I>&gt;&gt;<i> // do not log connections that closed after a transaction (those are normal)
</I>&gt;&gt;<i> // XXX: TLS bytes are consumed without going through inBuf
</I>&gt;&gt;<i> // XXX: PROXY protocol bytes are consumed without going through inBuf
</I>&gt;&gt;<i> if (inBuf.isEmpty())
</I>&gt;&gt;<i>   return;
</I>&gt;<i> 
</I>
That describes the situation better. +1.

&gt;<i> 
</I>&gt;<i> We agree that sent-nothing connections should be logged. I am not
</I>&gt;<i> against logging them by default (unless others have evidence to prove
</I>&gt;<i> that it would create too much noise). However, logging sent-nothing
</I>&gt;<i> connections probably requires a configuration option and can be
</I>&gt;<i> considered outside this patch scope -- the patch is improving access
</I>&gt;<i> logging without claiming to fix all access logging bugs.
</I>&gt;<i> 
</I>&gt;<i> If you are sure that logging all sent-nothing connections *without an
</I>&gt;<i> option to disable that behavior* is the right thing to do in v4, then
</I>&gt;<i> let's ask Eduard to cover that case using receivedFirstByte().
</I>&gt;<i> 
</I>
Logging them by default is something I think we should do.

As for config controlling them, that was what my questions about the
access_log ACLs abilities were for. Since Eduard has confirmed that
approach is useless, we will need a new config option added for this new
function/method to disable those log entries.


&gt;<i> 
</I>&gt;&gt;<i>   + which still leaves not-logging at least the cases where TLS bytes or
</I>&gt;&gt;<i> such layered things have occured but no HTTP bytes yet (and the inBuf
</I>&gt;&gt;<i> empty right now). That needs an explicit mention, and deserves an XXX or
</I>&gt;&gt;<i> TODO (different than the &quot;assumes ...&quot; one.)
</I>&gt;<i> 
</I>&gt;<i> I agree that TLS should be either handled or explicitly excluded with an
</I>&gt;<i> XXX comment. Another potentially relevant case to handle or explicitly
</I>&gt;<i> exclude is the PROXY protocol, right? I added two XXXs to cover those in
</I>&gt;<i> the above sketch.
</I>&gt;<i> 
</I>
Yes, PROXY is a case to note.

Is ftp_port traffic another one?

I think thats all the current ways for a TCP client connection to
happen. I'm assuming UDP ones are out of scope here.

Thank you
Amos

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006358.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
	<LI>Next message: <A HREF="006369.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6366">[ date ]</a>
              <a href="thread.html#6366">[ thread ]</a>
              <a href="subject.html#6366">[ subject ]</a>
              <a href="author.html#6366">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
