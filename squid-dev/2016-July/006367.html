<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Broken trunk after r14735, r14726
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3C82c40cc7-96ed-ecec-a4f0-398bf3d96c78%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006362.html">
   <LINK REL="Next"  HREF="006373.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Broken trunk after r14735, r14726</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3C82c40cc7-96ed-ecec-a4f0-398bf3d96c78%40treenet.co.nz%3E"
       TITLE="[squid-dev] Broken trunk after r14735, r14726">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 19 06:52:21 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006362.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
        <LI>Next message: <A HREF="006373.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6367">[ date ]</a>
              <a href="thread.html#6367">[ thread ]</a>
              <a href="subject.html#6367">[ subject ]</a>
              <a href="author.html#6367">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/07/2016 11:12 p.m., Christos Tsantilas wrote:
&gt;<i> On 07/16/2016 03:56 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 16/07/2016 7:02 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      There are two more recent changes that broke trunk:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * After r14735 (Replaced TidyPointer with std::unique_ptr), Squid cannot
</I>&gt;&gt;&gt;<i> start due to an &quot;std::bad_function_call&quot; exception.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * After r14726 (GnuTLS: support for TLS session resume): Squid segfaults
</I>&gt;&gt;&gt;<i> when attempting to connect to a Secure ICAP service. Official Squid
</I>&gt;&gt;&gt;<i> v4.0.12 suffers from this bug.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Stack traces from both crashes are quoted at the end of this email.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Please fix these regressions or undo the changes that created or exposed
</I>&gt;&gt;&gt;<i> them.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;&gt;<i> * segfault when attempting to connect to a Secure ICAP REQMOD service
</I>&gt;&gt;&gt;<i> (tested with r14726, r14734):
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does this patch fix the session issue ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> === modified file 'src/security/Session.cc'
</I>&gt;&gt;<i> --- src/security/Session.cc     2016-07-07 19:03:02 +0000
</I>&gt;&gt;<i> +++ src/security/Session.cc     2016-07-16 12:43:38 +0000
</I>&gt;&gt;<i> @@ -53,7 +53,7 @@
</I>&gt;&gt;<i>   void
</I>&gt;&gt;<i>   Security::SetSessionResumeData(const Security::SessionPtr &amp;s, const
</I>&gt;&gt;<i> Security::SessionStatePointer &amp;data)
</I>&gt;&gt;<i>   {
</I>&gt;&gt;<i> -    if (s) {
</I>&gt;&gt;<i> +    if (data) {
</I>&gt;&gt;<i>   #if USE_OPENSSL
</I>&gt;&gt;<i>           (void)SSL_set_session(s, data.get());
</I>&gt;&gt;<i>   #elif USE_GNUTLS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm a little worried about the code calling SetSessionResumeData.
</I>&gt;&gt;<i> OpenSSL documentation states:
</I>&gt;&gt;<i>    &quot;If there is already a session set inside ssl (because it was set with
</I>&gt;&gt;<i> SSL_set_session() before or because the same ssl was already used for a
</I>&gt;&gt;<i> connection), SSL_SESSION_free() will be called for that session.&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But our SetSessionResumeData() is called after setting up the sessions
</I>&gt;&gt;<i> host data, etc. So I'm thinking all that setup in
</I>&gt;&gt;<i> Ssl::BlindPeerConnector::initializeTls() may be thrown away by the
</I>&gt;&gt;<i> resume action being called.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Squid crashes at the first TLS connection trying to establish to the
</I>&gt;<i> ICAP server.  There is not any session to resume so the SSL session
</I>&gt;<i> related methods should not called at all.
</I>&gt;<i> 
</I>&gt;<i> It is a strange crash. Is it a corrupted SSL object?
</I>&gt;<i> 
</I>&gt;<i> I must say that I am worrying a lot for all of these changes.
</I>&gt;<i> It is very difficult for me to follow them, and already I have
</I>&gt;<i> difficulties to read and debug squid openSSL relate code.
</I>&gt;<i> 
</I>&gt;<i> We are using our own naming scheme for openSSL structures, eg
</I>&gt;<i> &quot;Security::SessionPtr&quot; instead of &quot;SSL *&quot; or
</I>&gt;<i> &quot;Security::SessionStatePointer&quot; instead of &quot;SSL_SESSION *&quot; and this is
</I>&gt;<i> make it very difficult to follow Squid/openSSL code.
</I>&gt;<i> 
</I>&gt;<i> It is difficult to read an example openSSL code and trying convert it to
</I>&gt;<i> squid, or reading a reference implementation and trying check against
</I>&gt;<i> squid code. Someone is obligated to search for definitions and
</I>&gt;<i> equivalents types all the time.
</I>&gt;<i> 
</I>&gt;<i> I have not ever study for a good way to support both GnuTLS and openSSL
</I>&gt;<i> for squid, to know the problems,  but probably I would start to
</I>&gt;<i> implement openSSLAcceptor/gnuTlsAcceptor and
</I>&gt;<i> openSSLPeerConnector/gnuTLSPeerConnector classes.
</I>&gt;<i> Internally gnuTLS and openSSL should use their own types. This is will
</I>&gt;<i> help current and future squid developers.
</I>
That is indeed where I started, and what I started doing. It turns out
we then have to maintain feature compatibility in those two relatively
high-level classes. Which are internally designed and implemented in
different ways. Thats a bit tricky to start with, but seemed reasonable.
  Then there is the killer fact that to do ssl-bump those classes are
all using fd_table[].ssl things shared between Server and Client and
Icap and Ecap 'sides' (head =&gt; meet brick wall, doh!).

&gt;<i> 
</I>&gt;<i> I am just expressing my worries here, I do not want to impose anything
</I>&gt;<i> and if there was a related discussion in squid-dev, sorry that I do not
</I>&gt;<i> participate and I did not express my concerns earlier.
</I>
As Alex noted, there has not been any detailed discussion. Just partial
coverage of some details during the occasional patch reviews. And it is
good to have opinions voiced/written.


As the one most recently looking at the ways to do combined API. I'm
just as frustrated as you. For the same reasons. Though in the reverse
direction. It has been quite hard to look at nice 3-4 line GnuTLS
examples and then trying to figure out a) what 10-20 OpenSSL calls are
used to do the equivalent, and even more annoyingly b) where those
OpenSSL calls are spinkled around the Squid codebase.

Regarding (b); TBH, I'm quite impressed you can translate from the
OpenSSL examples to the Squid use of OpenSSL.


The choices we have for combining basically come down to four ways:

1) implementing everything twice. The way OpenSSL is spreading its calls
all over the place that means the entire SSL-Bump, HTTPS receiving,
sending, BIO, and Comm I/O layers and FD socket handling.

A *huge* amount of duplication. Almost everything that stores OpenSSL
raw pointers today would need duplicating to work differently for
GnuTLS. Just because the pointer usage is different. Sometimes only in
the meaning of 0 return values - but thats enough.


2) picking one library API and writing our own compatibility layer for
other libraries using that API.

Unfortunately, there is a history of people trying this. The GnuTLS
compatibility openssl.h header is lacking many OpenSSL API symbols for
good reasons which boil down to intentional major design differences in
the libraries:
 a) OpenSSL exposes these annoying but useful locking references. GnuTLS
hides any locking from the callers - leaving us unsure if something is
referenced or copied, but safe to use any pointers we're given.
 b) OpenSSL uses N more API calls to explicitly do all sorts of things,
with ordering dependencies IIRC - where GnuTLS uses far fewer calls.

Sadly the Squid logics are sometimes heavily leveraging the locking
behaviour of OpenSSL to pass info from one context to another, by
updating shared structures.


3) sprinkling #if conditions like candy through the whole codebase.

(Er, yuck). We have too much of that already for OpenSSL.


4) designing our code to use an abstraction API that renames all the
library structures and functions to some thing we understand easier **.

Still a lot of code re-writing, and even more re-arranging so the
library call(s) themselves happen away from the huge number of
components mentioned in (1). But doable within a decade (maybe).


So, I've gone with this (4) and taking Alex suggestions on how to
abstract better as I go.

If you think its a good way to go, we might be able to use the reverse
compatibility direction for (3). ie. Using GnuTLS symbol names and
implementing them for OpenSSL API. But that wont help much when it comes
to supporting NSS for Fedora/RHEL/CentOS, PolarSSL (for SuSE? I forget),
or Crypto for MacOS.


** YMMV on easier. I fully sympathize with the examples-vs-abstraction
problem. It might help if we communicated a bit better on that so it
turned out to be something you understand as well, not just my ideas.
 I had the idea that you were flooded with SSL-Bump problems? has that
situation eased?


Amos

</PRE>







































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006362.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
	<LI>Next message: <A HREF="006373.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6367">[ date ]</a>
              <a href="thread.html#6367">[ thread ]</a>
              <a href="subject.html#6367">[ subject ]</a>
              <a href="author.html#6367">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
