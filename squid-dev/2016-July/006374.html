<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C578E5CE4.9030402%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006372.html">
   <LINK REL="Next"  HREF="006376.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C578E5CE4.9030402%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jul 19 17:01:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006372.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
        <LI>Next message: <A HREF="006376.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6374">[ date ]</a>
              <a href="thread.html#6374">[ thread ]</a>
              <a href="subject.html#6374">[ subject ]</a>
              <a href="author.html#6374">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/19/2016 08:10 AM, Amos Jeffries wrote:
&gt;<i> On 20/07/2016 1:44 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;<i> 2016-07-19 16:17 GMT+03:00 Amos Jeffries:
</I>&gt;&gt;&gt;<i> Is this patch going to include the new config option to prevent logging
</I>&gt;&gt;&gt;<i> the new things? or do it in a followup?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For now we are not planning to add this option(that is why initially the
</I>&gt;&gt;<i> patch did not perform logging for &quot;no-bytes&quot; connections).
</I>&gt;&gt;<i> Probably there should be a (new?) ACL, controlling number of received
</I>&gt;&gt;<i> bytes(instead of separate option). If so, implementing this requires
</I>&gt;&gt;<i> solving non-trivial separate task.
</I>
&gt;<i> Okay. I was just thinking an on/off directive for now. So people could
</I>&gt;<i> restore the old behaviour, or go ahead with the new logs. 
</I>
An ACL is the right way to control what gets logged -- this is the
access_log configuration interface we already support. If no existing
ACL(s) can match the transactions we want users to be able to match,
then we need to add more ACL(s). I suspect those new ACL(s) would be
useful for more than logging.

A new config directive is not something we can add &quot;for now&quot; -- it would
have to be maintained for a long time while the overlap between the
existing ACL-driven interface and the new directive will cause pains for
developers, documentation writers, and admins.


Which ACL(s) to add depends on the final version of the new logging
code, requires careful thinking, and may require non-trivial
development. We want to keep all of that outside this project scope.
Amos, if we assume that this patch does not add new ACLs or directives,
are you happy with what it logs now or do you want Eduard to exclude
something?


&gt;<i> I'll give Alex another day to point out any issues, with intention to
</I>&gt;<i> apply this in ~24hrs.
</I>
Thank you.


&gt;<i> error:accept-user-connection
</I>
vs. recently discussed

&gt;<i> annotate_client or annotate_client_connection
</I>
All of these are about the same kind of connection to a Squid
protocol_port. Should we use &quot;user&quot; or &quot;client&quot;? I do not think just
&quot;annotate_user&quot; works because folks will think it is about the
[authenticated] user [agent] as a whole. Thus, we have the following
naming options:

1) error:accept-user-connection and annotate_user_connection

2) error:accept-client-connection and annotate_client

3) error:accept-client-connection and annotate_client_connection


FYI: I found a few references to &quot;user&quot; and ~30 references to &quot;client&quot;
in squid.conf directives and ACLS:

* user_max_ip, user_cert, ext_user, ftp_user, and cache_effective_user;

* client_dst_passthru, client_delay_*, *_uses_indirect_client,
client_db, client_idle_pconn_timeout, client_ip_max_connections,
client_lifetime, client_netmask, client_persistent_connections, and
client_request_buffer_max_size.

Given the above, (2) or (3) seems like a better choice. Amos, please
pick one or confirm that you still want (1).


&gt;<i> +    // do not log connections that closed after a transaction (it is normal)
</I>...
&gt;<i> +    // XXX: TLS bytes are consumed without going through inBuf
</I>&gt;<i> +    // XXX: PROXY protocol bytes are consumed without going through inBuf
</I>&gt;<i> +    if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
</I>&gt;<i> +        return;
</I>
Given the new condition, I would do:

&gt;<i> // do not log connections that closed after a transaction (it is normal)
</I>&gt;<i> // TODO: access_log needs ACLs to match received-no-bytes connections
</I>&gt;<i> // XXX: TLS may return here even though we got no transactions yet
</I>&gt;<i> // XXX: PROXY protocol may return here even though we got no transactions yet
</I>&gt;<i> if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
</I>&gt;<i>     return;
</I>

I have not checked PROXY, but TLS is tricky because, AFAICT, it sets
receivedFirstByte_ to true but may later _reset_ it back to false:

&gt;<i> // Also reset receivedFirstByte_ flag to allow this timeout work in the case we 
</I>&gt;<i> // a bumbed &quot;connect&quot; request on non transparent port.
</I>&gt;<i> receivedFirstByte_ = false;
</I>
I would keep those XXXs vague until somebody investigates and addresses
them completely. I suspect we will need to split receivedFirstByte_ into
receivedFirstTransactionByte_ and receivedFirstRawByte_ or perhaps byte
counters for each (and ACLs that can match their ranges).


Thank you,

Alex.

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006372.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
	<LI>Next message: <A HREF="006376.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6374">[ date ]</a>
              <a href="thread.html#6374">[ thread ]</a>
              <a href="subject.html#6374">[ subject ]</a>
              <a href="author.html#6374">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
