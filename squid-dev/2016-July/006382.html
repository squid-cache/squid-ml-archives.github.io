<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C578F8E4D.7080004%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006376.html">
   <LINK REL="Next"  HREF="006384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C578F8E4D.7080004%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Wed Jul 20 14:44:29 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006376.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
        <LI>Next message: <A HREF="006384.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6382">[ date ]</a>
              <a href="thread.html#6382">[ thread ]</a>
              <a href="subject.html#6382">[ subject ]</a>
              <a href="author.html#6382">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> &gt;   2016-07-20 7:36 GMT+03:00 Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt;:
 &gt;On 20/07/2016 5:01 a.m., Alex Rousskov wrote:
 &gt;&gt; On 07/19/2016 08:10 AM, Amos Jeffries wrote:
 &gt;&gt;&gt; On 20/07/2016 1:44 a.m., Eduard Bagdasaryan wrote:
 &gt;&gt;&gt;&gt; 2016-07-19 16:17 GMT+03:00 Amos Jeffries:
 &gt;&gt;&gt;&gt;&gt; Is this patch going to include the new config option to prevent 
logging
 &gt;&gt;&gt;&gt;&gt; the new things? or do it in a followup?
 &gt;&gt;&gt;&gt;
 &gt;&gt;&gt;&gt; For now we are not planning to add this option(that is why 
initially the
 &gt;&gt;&gt;&gt; patch did not perform logging for &quot;no-bytes&quot; connections).
 &gt;&gt;&gt;&gt; Probably there should be a (new?) ACL, controlling number of received
 &gt;&gt;&gt;&gt; bytes(instead of separate option). If so, implementing this requires
 &gt;&gt;&gt;&gt; solving non-trivial separate task.
 &gt;&gt;
 &gt;&gt;&gt; Okay. I was just thinking an on/off directive for now. So people could
 &gt;&gt;&gt; restore the old behaviour, or go ahead with the new logs.
 &gt;&gt;
 &gt;&gt; An ACL is the right way to control what gets logged -- this is the
 &gt;&gt; access_log configuration interface we already support. If no existing
 &gt;&gt; ACL(s) can match the transactions we want users to be able to match,
 &gt;&gt; then we need to add more ACL(s). I suspect those new ACL(s) would be
 &gt;&gt; useful for more than logging.
 &gt;&gt;
 &gt;&gt; A new config directive is not something we can add &quot;for now&quot; -- it would
 &gt;&gt; have to be maintained for a long time while the overlap between the
 &gt;&gt; existing ACL-driven interface and the new directive will cause pains for
 &gt;&gt; developers, documentation writers, and admins.
 &gt;&gt;
 &gt;&gt;
 &gt;&gt; Which ACL(s) to add depends on the final version of the new logging
 &gt;&gt; code, requires careful thinking, and may require non-trivial
 &gt;&gt; development. We want to keep all of that outside this project scope.
 &gt;&gt; Amos, if we assume that this patch does not add new ACLs or directives,
 &gt;&gt; are you happy with what it logs now or do you want Eduard to exclude
 &gt;&gt; something?
 &gt;&gt;
 &gt;
 &gt;Hmm. Good point.
 &gt;
 &gt;The 'problem' with ACLs was not the lack of checks, it is that the URL
 &gt;ones we already have use exclusively the HttpRequest URL and complain
 &gt;when one is not existing. It might be easier to extend those to use the
 &gt;error:* URL, in the same way the log itself is getting it for display.
 &gt;
 &gt;&gt;
 &gt;&gt;&gt; I'll give Alex another day to point out any issues, with intention to
 &gt;&gt;&gt; apply this in ~24hrs.
 &gt;&gt;
 &gt;&gt; Thank you.
 &gt;&gt;
 &gt;&gt;
 &gt;&gt;&gt; error:accept-user-connection
 &gt;&gt;
 &gt;&gt; vs. recently discussed
 &gt;&gt;
 &gt;&gt;&gt; annotate_client or annotate_client_connection
 &gt;&gt;
 &gt;&gt; All of these are about the same kind of connection to a Squid
 &gt;&gt; protocol_port. Should we use &quot;user&quot; or &quot;client&quot;? I do not think just
 &gt;&gt; &quot;annotate_user&quot; works because folks will think it is about the
 &gt;&gt; [authenticated] user [agent] as a whole.
 &gt;
 &gt;Agreed. User is a specific subset of client. That 'does it require a
 &gt;person' is the first filter I am applying whenever anyone suggests
 &gt;&quot;user&quot; for anything.
 &gt;
 &gt;
 &gt;&gt; Thus, we have the following
 &gt;&gt; naming options:
 &gt;&gt;
 &gt;&gt; 1) error:accept-user-connection and annotate_user_connection
 &gt;&gt;
 &gt;&gt; 2) error:accept-client-connection and annotate_client
 &gt;&gt;
 &gt;&gt; 3) error:accept-client-connection and annotate_client_connection
 &gt;&gt;
 &gt;&gt;
 &gt;&gt; FYI: I found a few references to &quot;user&quot; and ~30 references to &quot;client&quot;
 &gt;&gt; in squid.conf directives and ACLS:
 &gt;&gt;
 &gt;&gt; * user_max_ip, user_cert, ext_user, ftp_user, and cache_effective_user;
 &gt;&gt;
 &gt;&gt; * client_dst_passthru, client_delay_*, *_uses_indirect_client,
 &gt;&gt; client_db, client_idle_pconn_timeout, client_ip_max_connections,
 &gt;&gt; client_lifetime, client_netmask, client_persistent_connections, and
 &gt;&gt; client_request_buffer_max_size.
 &gt;&gt;
 &gt;&gt; Given the above, (2) or (3) seems like a better choice. Amos, please
 &gt;&gt; pick one or confirm that you still want (1).
 &gt;&gt;
 &gt;
 &gt;My inbox(es) contain no mention of these annotate_client / annotate_user
 &gt;you speak of being discussed. And my memory is also drawing a bank right
 &gt;now.
 &gt;
 &gt;The latest proposed patch of this thread failed the filter mentioned
 &gt;above for me. I'm asking for &quot;error:accept-client-connection&quot;, which
 &gt;would be (2) or (3) of your offered list.
 &gt;
 &gt;
 &gt;&gt;
 &gt;&gt;&gt; +    // do not log connections that closed after a transaction (it 
is normal)
 &gt;&gt; ...
 &gt;&gt;&gt; +    // XXX: TLS bytes are consumed without going through inBuf
 &gt;&gt;&gt; +    // XXX: PROXY protocol bytes are consumed without going 
through inBuf
 &gt;&gt;&gt; +    if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
 &gt;&gt;&gt; +        return;
 &gt;&gt;
 &gt;&gt; Given the new condition, I would do:
 &gt;&gt;
 &gt;&gt;&gt; // do not log connections that closed after a transaction (it is 
normal)
 &gt;&gt;&gt; // TODO: access_log needs ACLs to match received-no-bytes connections
 &gt;&gt;&gt; // XXX: TLS may return here even though we got no transactions yet
 &gt;&gt;&gt; // XXX: PROXY protocol may return here even though we got no 
transactions yet
 &gt;&gt;&gt; if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
 &gt;&gt;&gt;     return;
 &gt;&gt;
 &gt;
 &gt;That works for me. +1.
 &gt;
 &gt;&gt;
 &gt;&gt; I have not checked PROXY, but TLS is tricky because, AFAICT, it sets
 &gt;&gt; receivedFirstByte_ to true but may later _reset_ it back to false:
 &gt;&gt;
 &gt;&gt;&gt; // Also reset receivedFirstByte_ flag to allow this timeout work in 
the case we
 &gt;&gt;&gt; // a bumbed &quot;connect&quot; request on non transparent port.
 &gt;&gt;&gt; receivedFirstByte_ = false;
 &gt;&gt;
 &gt;&gt; I would keep those XXXs vague until somebody investigates and addresses
 &gt;&gt; them completely. I suspect we will need to split receivedFirstByte_ into
 &gt;&gt; receivedFirstTransactionByte_ and receivedFirstRawByte_ or perhaps byte
 &gt;&gt; counters for each (and ACLs that can match their ranges).
 &gt;
 &gt;Nod. I had exactly that same thought. :-)

Amos,
just to clarify: any more touches from my side?


Eduard.
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006376.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
	<LI>Next message: <A HREF="006384.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6382">[ date ]</a>
              <a href="thread.html#6382">[ thread ]</a>
              <a href="subject.html#6382">[ subject ]</a>
              <a href="author.html#6382">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
