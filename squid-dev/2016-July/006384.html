<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Some failed transactions are not logged
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C8cb712e5-0c72-5d56-47f6-acb1c98d1283%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006382.html">
   <LINK REL="Next"  HREF="006386.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Some failed transactions are not logged</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Some%20failed%20transactions%20are%20not%20logged&In-Reply-To=%3C8cb712e5-0c72-5d56-47f6-acb1c98d1283%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Some failed transactions are not logged">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 20 15:06:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006382.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
        <LI>Next message: <A HREF="006386.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6384">[ date ]</a>
              <a href="thread.html#6384">[ thread ]</a>
              <a href="subject.html#6384">[ subject ]</a>
              <a href="author.html#6384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/07/2016 2:44 a.m., Eduard Bagdasaryan wrote:
&gt;&gt;<i>   2016-07-20 7:36 GMT+03:00 Amos Jeffries:
</I>&gt;&gt;<i>On 20/07/2016 5:01 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 07/19/2016 08:10 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 20/07/2016 1:44 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> 2016-07-19 16:17 GMT+03:00 Amos Jeffries:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Is this patch going to include the new config option to prevent
</I>&gt;<i> logging
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> the new things? or do it in a followup?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> For now we are not planning to add this option(that is why
</I>&gt;<i> initially the
</I>&gt;&gt;&gt;&gt;&gt;<i> patch did not perform logging for &quot;no-bytes&quot; connections).
</I>&gt;&gt;&gt;&gt;&gt;<i> Probably there should be a (new?) ACL, controlling number of received
</I>&gt;&gt;&gt;&gt;&gt;<i> bytes(instead of separate option). If so, implementing this requires
</I>&gt;&gt;&gt;&gt;&gt;<i> solving non-trivial separate task.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Okay. I was just thinking an on/off directive for now. So people could
</I>&gt;&gt;&gt;&gt;<i> restore the old behaviour, or go ahead with the new logs.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> An ACL is the right way to control what gets logged -- this is the
</I>&gt;&gt;&gt;<i> access_log configuration interface we already support. If no existing
</I>&gt;&gt;&gt;<i> ACL(s) can match the transactions we want users to be able to match,
</I>&gt;&gt;&gt;<i> then we need to add more ACL(s). I suspect those new ACL(s) would be
</I>&gt;&gt;&gt;<i> useful for more than logging.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> A new config directive is not something we can add &quot;for now&quot; -- it would
</I>&gt;&gt;&gt;<i> have to be maintained for a long time while the overlap between the
</I>&gt;&gt;&gt;<i> existing ACL-driven interface and the new directive will cause pains for
</I>&gt;&gt;&gt;<i> developers, documentation writers, and admins.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Which ACL(s) to add depends on the final version of the new logging
</I>&gt;&gt;&gt;<i> code, requires careful thinking, and may require non-trivial
</I>&gt;&gt;&gt;<i> development. We want to keep all of that outside this project scope.
</I>&gt;&gt;&gt;<i> Amos, if we assume that this patch does not add new ACLs or directives,
</I>&gt;&gt;&gt;<i> are you happy with what it logs now or do you want Eduard to exclude
</I>&gt;&gt;&gt;<i> something?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Hmm. Good point.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>The 'problem' with ACLs was not the lack of checks, it is that the URL
</I>&gt;&gt;<i>ones we already have use exclusively the HttpRequest URL and complain
</I>&gt;&gt;<i>when one is not existing. It might be easier to extend those to use the
</I>&gt;&gt;<i>error:* URL, in the same way the log itself is getting it for display.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I'll give Alex another day to point out any issues, with intention to
</I>&gt;&gt;&gt;&gt;<i> apply this in ~24hrs.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thank you.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> error:accept-user-connection
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> vs. recently discussed
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> annotate_client or annotate_client_connection
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> All of these are about the same kind of connection to a Squid
</I>&gt;&gt;&gt;<i> protocol_port. Should we use &quot;user&quot; or &quot;client&quot;? I do not think just
</I>&gt;&gt;&gt;<i> &quot;annotate_user&quot; works because folks will think it is about the
</I>&gt;&gt;&gt;<i> [authenticated] user [agent] as a whole.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Agreed. User is a specific subset of client. That 'does it require a
</I>&gt;&gt;<i>person' is the first filter I am applying whenever anyone suggests
</I>&gt;&gt;<i>&quot;user&quot; for anything.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thus, we have the following
</I>&gt;&gt;&gt;<i> naming options:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1) error:accept-user-connection and annotate_user_connection
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2) error:accept-client-connection and annotate_client
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 3) error:accept-client-connection and annotate_client_connection
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> FYI: I found a few references to &quot;user&quot; and ~30 references to &quot;client&quot;
</I>&gt;&gt;&gt;<i> in squid.conf directives and ACLS:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * user_max_ip, user_cert, ext_user, ftp_user, and cache_effective_user;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * client_dst_passthru, client_delay_*, *_uses_indirect_client,
</I>&gt;&gt;&gt;<i> client_db, client_idle_pconn_timeout, client_ip_max_connections,
</I>&gt;&gt;&gt;<i> client_lifetime, client_netmask, client_persistent_connections, and
</I>&gt;&gt;&gt;<i> client_request_buffer_max_size.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Given the above, (2) or (3) seems like a better choice. Amos, please
</I>&gt;&gt;&gt;<i> pick one or confirm that you still want (1).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>My inbox(es) contain no mention of these annotate_client / annotate_user
</I>&gt;&gt;<i>you speak of being discussed. And my memory is also drawing a bank right
</I>&gt;&gt;<i>now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>The latest proposed patch of this thread failed the filter mentioned
</I>&gt;&gt;<i>above for me. I'm asking for &quot;error:accept-client-connection&quot;, which
</I>&gt;&gt;<i>would be (2) or (3) of your offered list.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> +    // do not log connections that closed after a transaction (it
</I>&gt;<i> is normal)
</I>&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;&gt;<i> +    // XXX: TLS bytes are consumed without going through inBuf
</I>&gt;&gt;&gt;&gt;<i> +    // XXX: PROXY protocol bytes are consumed without going through
</I>&gt;<i> inBuf
</I>&gt;&gt;&gt;&gt;<i> +    if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
</I>&gt;&gt;&gt;&gt;<i> +        return;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Given the new condition, I would do:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> // do not log connections that closed after a transaction (it is
</I>&gt;<i> normal)
</I>&gt;&gt;&gt;&gt;<i> // TODO: access_log needs ACLs to match received-no-bytes connections
</I>&gt;&gt;&gt;&gt;<i> // XXX: TLS may return here even though we got no transactions yet
</I>&gt;&gt;&gt;&gt;<i> // XXX: PROXY protocol may return here even though we got no
</I>&gt;<i> transactions yet
</I>&gt;&gt;&gt;&gt;<i> if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
</I>&gt;&gt;&gt;&gt;<i>     return;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>That works for me. +1.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have not checked PROXY, but TLS is tricky because, AFAICT, it sets
</I>&gt;&gt;&gt;<i> receivedFirstByte_ to true but may later _reset_ it back to false:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> // Also reset receivedFirstByte_ flag to allow this timeout work in
</I>&gt;<i> the case we
</I>&gt;&gt;&gt;&gt;<i> // a bumbed &quot;connect&quot; request on non transparent port.
</I>&gt;&gt;&gt;&gt;<i> receivedFirstByte_ = false;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I would keep those XXXs vague until somebody investigates and addresses
</I>&gt;&gt;&gt;<i> them completely. I suspect we will need to split receivedFirstByte_ into
</I>&gt;&gt;&gt;<i> receivedFirstTransactionByte_ and receivedFirstRawByte_ or perhaps byte
</I>&gt;&gt;&gt;<i> counters for each (and ACLs that can match their ranges).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Nod. I had exactly that same thought. :-)
</I>&gt;<i> 
</I>&gt;<i> Amos,
</I>&gt;<i> just to clarify: any more touches from my side?
</I>
There are the bits where Alex and I agreed on a change. I think that was
all cosmetic documentation stuff.

Also, if you agree - I'd prefer the getter method for receivedFirstByte_
was used instead of the member itself. Just so we can more easily move
the bits around as Server is cleaned up.

If you have time to re-check the thread since last patch submission and
make a new final one it would help making sure everything matched your
name as author and your design. Otherwise I can do it when committing
tomorrow.

Amos

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006382.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
	<LI>Next message: <A HREF="006386.html">[squid-dev] [PATCH] Some failed transactions are not logged
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6384">[ date ]</a>
              <a href="thread.html#6384">[ thread ]</a>
              <a href="subject.html#6384">[ subject ]</a>
              <a href="author.html#6384">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
