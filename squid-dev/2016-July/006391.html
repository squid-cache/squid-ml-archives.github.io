<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] [PREVIEW] LockingPointer round 3.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20%5BPREVIEW%5D%20LockingPointer%20round%203.&In-Reply-To=%3C578FBABD.3090707%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006377.html">
   <LINK REL="Next"  HREF="006396.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] [PREVIEW] LockingPointer round 3.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20%5BPREVIEW%5D%20LockingPointer%20round%203.&In-Reply-To=%3C578FBABD.3090707%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] [PREVIEW] LockingPointer round 3.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 20 17:54:05 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006377.html">[squid-dev] [RFC] [PREVIEW] LockingPointer round 3.
</A></li>
        <LI>Next message: <A HREF="006396.html">[squid-dev] [RFC] [PREVIEW] LockingPointer round 3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6391">[ date ]</a>
              <a href="thread.html#6391">[ thread ]</a>
              <a href="subject.html#6391">[ subject ]</a>
              <a href="author.html#6391">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/19/2016 10:45 PM, Amos Jeffries wrote:
&gt;<i> On 19/07/2016 7:14 p.m., Amos Jeffries wrote:
</I>&gt;&gt;<i> On 19/07/2016 6:58 a.m., Christos Tsantilas wrote:
</I>&gt;&gt;&gt;<i> On 07/18/2016 08:32 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> I can only repeat my earlier suggestions to hide that dangerous
</I>&gt;&gt;&gt;&gt;<i> constructor behind an explicit static method like
</I>&gt;&gt;&gt;&gt;<i> LockingPointer::NewWithoutLocking() and to assert that
</I>&gt;&gt;&gt;&gt;<i> resetWithoutLocking() method is fed a previously locked object.
</I>
&gt;&gt;&gt;<i> something like that.
</I>
&gt;&gt;<i> Nod. I'm about to try a build with dropped construtor to see what
</I>&gt;&gt;<i> breaks. That should highlight if a builder function is actually
</I>&gt;&gt;<i> necessary. I hope we can avoid it.
</I>

&gt;<i> Attached is a patch showing what that constructor removal would look
</I>&gt;<i> like for current Squid trunk.
</I>
Creating a nil pointer just to reset it on the next line looks like bad
style to me. It makes it impossible to make the pointer object constant
and increases the chances that the two lines will get separated in the
future for now good reason, possibly causing bugs.

Why resist naming an unusual/special construction method?


&gt;<i> I've added &quot;// X locks&quot; comments on new resetWithoutLocking() to be
</I>&gt;<i> clearer where the non-locking comes from. OpenSSL API explicitly
</I>&gt;<i> mentions that it &quot;increments a reference&quot; / locks.
</I>
The &quot;resetWithoutLocking(X()); // X locks&quot; approach creates a redundant
distraction IMO. If you feel that we need those comments, then perhaps
the reset method needs a new name, like resetUsingLocked(X()) or
resetToLocked(X()).

Note that you actually did not add a comment where one would be useful:

ctx-&gt;resetWithoutLocking(sslContext); // XXX: how do we know its locked?




&gt;<i> // XXX: why not set fd_table if that add() succeeded ?
</I>
The simple answer is that if you set fd_table after cache add()ing
succeeded, then both fd_table and the cache will delete the same
pointer, crashing Squid. Note that ctx is a raw pointer [to a smart
pointer]. However, I doubt this is the correct/best answer.

AFAICT, the poor-quality comments in the original code were supposed to
answer that question like this: The _only_ reason we add ctx to the
table is so that it gets eventually destroyed. The context object is not
needed in the table and should not be accessed from there. If we
successfully add ctx to the cache, then the cache becomes responsible
for its destruction and we do not need to add it to the table.


&gt;<i> +            if (!ssl_ctx_cache)
</I>&gt;<i> +                // if there is no storage, just use
</I>&gt;<i>                  fd_table[clientConnection-&gt;fd].dynamicSslContext = sslContext;
</I>&gt;<i> +            else {
</I>
Missing {} around the multiline if-statement body.

&gt;<i> +    explicit LockingPointer() : raw(nullptr) {}
</I>
Default explicit constructors is a convoluted C++ issue. Unless you have
a specific need for it, I suggest removing &quot;explicit&quot; here. Otherwise,
document that need in a source code comment.


&gt;<i> +     * Our destructor will do the matching unlock.
</I>
This comment is inaccurate because we may unlock in places other than
the destructor. You can say &quot;We become responsible for the matching
unlock().&quot; or something like that.



&gt;<i> +        tmp.resetWithoutLocking(crl); // XXX: does PEM_read_bio_X509_CRL lock ??
</I>
One more reason to assert that resetWithoutLocking() is fed a locked
OpenSSL object and also assert that unlock() has a locked OpenSSL object
(if any).

To answer your question, yes, I think it does lock because the BUGS
section of the PEM_read_bio_X509_CRL manual page contains an example
that frees the result:

&gt;<i>         X509_free(x);
</I>&gt;<i>         x = PEM_read_bio_X509(bp, NULL, 0, NULL);
</I>

HTH,

Alex.

</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006377.html">[squid-dev] [RFC] [PREVIEW] LockingPointer round 3.
</A></li>
	<LI>Next message: <A HREF="006396.html">[squid-dev] [RFC] [PREVIEW] LockingPointer round 3.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6391">[ date ]</a>
              <a href="thread.html#6391">[ thread ]</a>
              <a href="subject.html#6391">[ subject ]</a>
              <a href="author.html#6391">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
