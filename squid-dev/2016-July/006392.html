<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Broken trunk after r14735, r14726
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3C578FE4CF.60504%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006388.html">
   <LINK REL="Next"  HREF="006413.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Broken trunk after r14735, r14726</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Broken%20trunk%20after%20r14735%2C%20r14726&In-Reply-To=%3C578FE4CF.60504%40measurement-factory.com%3E"
       TITLE="[squid-dev] Broken trunk after r14735, r14726">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 20 20:53:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006388.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
        <LI>Next message: <A HREF="006413.html">[squid-dev] Broken trunk after r14735
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6392">[ date ]</a>
              <a href="thread.html#6392">[ thread ]</a>
              <a href="subject.html#6392">[ subject ]</a>
              <a href="author.html#6392">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/20/2016 10:04 AM, Christos Tsantilas wrote:

&gt;<i> Why do we need common types for both SDKs?
</I>
You have answered your own question below:


&gt;<i> The only type needed by squid for openSSL is the &quot;SSL *&quot; which is stored
</I>&gt;<i> inside fde class. And the gnutls_session_int for gnutls. These are
</I>&gt;<i> should be enough (maybe with some other like the certificate errors.).
</I>&gt;<i> 
</I>&gt;<i> Squid should use SSL or gnutls_session_int and pass it to openSSL or
</I>&gt;<i> gnuTLS  related classes
</I>

The combination of &quot;what to pass&quot; and &quot;where to pass it&quot; is the common
API! There is no sane way to avoid that API if we want to support
multiple SSL libraries.

With that API, instead of writing general code like this:

    #if OpenSSL
        auto x = SSL_foo1(fd_table[fd].openSslConnection);
        SSL_foo2(x, 12345);
        z = AsyncJob::Start(new OpenSslFooDoer(x));
        SSL_free(x);
    #elsif GnuTLS
        auto y = GnuTLS_bar1(fd_table[fd].gnuTlsConnection);
        GnuTLS_bar2(y, 54321);
        z = AsyncJob::Start(new GnuTlsBarDoer(y));
        // y is refcounted
    #else
        throw UnrechableCode(Here);
    #endif

we write either

    z = Security::Baz(fd_table[fd].ssl);

or

    z = AsyncJob::Start(new Security::BazDoer(y));


Designing a high-quality API to achieve the above is very difficult, of
course. We have done some baby steps in a few places, but a lot more
work remains, and some of those changes must be wrong because each
developer doing those steps does not know enough about the problem as a
whole to make the right decisions (and for other reasons).


Note that Security::* is _not_ meant to be a general-purpose SSL SDK! It
is not a wrapper around OpenSSL and GnuTLS. Its primary API is the
boundary between the non-SSL Squid code and the SSL Squid code. Its
secondary purpose is to encapsulate common OpenSSL and GnuTLS code.


&gt;<i> If you decide to implement  NEW GnuTls PeerConnector class, without
</I>&gt;<i> sslbump for the beggining, it is easy. The PeerConnector class is about
</I>&gt;<i> 500 lines of code and the BlindPeerConnector other 100 lines.
</I>&gt;<i> 
</I>&gt;<i> And after this is ready the common code like the certificates validation
</I>&gt;<i> (150 lines of code) can be moved into a parent class.
</I>
s/after/during/ -- you do not want to sanction blatant code duplication
without a good reason. And whether that common code belongs to a parent
or some helper class(es) is another open question that the developer
would have to answer.


&gt;<i> But trying to fit GnuTLS and openSSL into the same PeerConnector class
</I>&gt;<i> will fail and will make the code complex.
</I>
I do not know whether that is true, but I do know that drawing those
boundaries correctly is a very difficult task, regardless of whether the
correct design is &quot;GnuTlsConnector with PeerConnector parent&quot; or
&quot;PeerConnector with Security::Foo() calls inside&quot;.


&gt;<i> The SSLBump also is still under heavy development.
</I>&gt;<i> Again here the PeekingPeerConnector is about 400 lines of code. Is this
</I>&gt;<i> code we are worrying that it will be duplicated?
</I>
Frankly, I am worried about any code duplication, regardless of whether
it is 400 lines of super complex SslBump code, 4000 lines of relatively
straightforward SSL code, or something else.


&gt;&gt;<i> 4) designing our code to use an abstraction API that renames all the
</I>&gt;&gt;<i> library structures and functions to some thing we understand easier **.
</I>
&gt;<i> I believe that that the PeerConnector is a part of this API.
</I>
It could be indeed! In this email, I am not taking a position on whether
it is or it is not.


We agree that making correct decisions in this area is difficult and any
decision requires a lot of knowledge and legwork. IMHO, the Project does
not have the necessary skills and cycles for that right now, but that
lack of resources necessary for a decent outcome has not stopped anybody
before.

Alex.

</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006388.html">[squid-dev] Broken trunk after r14735, r14726
</A></li>
	<LI>Next message: <A HREF="006413.html">[squid-dev] Broken trunk after r14735
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6392">[ date ]</a>
              <a href="thread.html#6392">[ thread ]</a>
              <a href="subject.html#6392">[ subject ]</a>
              <a href="author.html#6392">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
