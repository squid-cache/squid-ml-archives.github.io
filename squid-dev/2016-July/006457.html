<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Deletors for std::unique_ptr WAS: Re: Broken trunk after r14735
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Deletors%20for%20std%3A%3Aunique_ptr%20WAS%3A%20Re%3A%0A%20Broken%20trunk%20after%20r14735&In-Reply-To=%3C579BA09C.1090806%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006456.html">
   <LINK REL="Next"  HREF="006458.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Deletors for std::unique_ptr WAS: Re: Broken trunk after r14735</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Deletors%20for%20std%3A%3Aunique_ptr%20WAS%3A%20Re%3A%0A%20Broken%20trunk%20after%20r14735&In-Reply-To=%3C579BA09C.1090806%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Deletors for std::unique_ptr WAS: Re: Broken trunk after r14735">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jul 29 18:29:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006456.html">[squid-dev] [PATCH] Deletors for std::unique_ptr WAS: Re: Broken trunk after r14735
</A></li>
        <LI>Next message: <A HREF="006458.html">[squid-dev] [PATCH] Deletors for std::unique_ptr fixing r14735
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6457">[ date ]</a>
              <a href="thread.html#6457">[ thread ]</a>
              <a href="subject.html#6457">[ subject ]</a>
              <a href="author.html#6457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/29/2016 09:27 AM, Amos Jeffries wrote:
&gt;&gt;&gt;<i> typedef std::unique_ptr&lt;BIO, std::function&lt;decltype(BIO_free)&gt;&gt; BIO_Pointer;
</I>
&gt;<i> I got this config parsing crash replicated here and tried a dozen or so
</I>&gt;<i> combinations. It does seem to keep coming back to my earlier approach of
</I>&gt;<i> using per-type Functors as the most reliable solution.
</I>
AFAICT, this is not a question of reliability, and we should not be
fixing this by trying various combination of typedef characters until we
find one that does not immediately crash Squid. We should figure out
_why_ trunk code does not work (and then fix it accordingly).

The trunk code cannot work because we are telling std::unique_ptr that
our Deleter is std::function&lt;decltype(BIO_free)&gt;. What is
std::function&lt;decltype(BIO_free)&gt;? It is an std::function class. An
instance of that class can call any function that has the same
declaration as BIO_free. So, which function should our BIO_Pointer call?
We did not specify that! Thus, we get a bad_function_call exception when
unique_ptr object is trying to destroy its target pointer [using a
missing/unspecified deleter function].

In other words, trunk code is equivalent to this pseudo code:

  BIO *bio = ...;
  std::function&lt;int(BIO*)&gt; fun = NULL;
  fun(bio); // throws -- cannot call an unspecified function

What we should be writing is this:

  BIO *bio = ...;
  std::function&lt;int(BIO*)&gt; fun = BIO_free;
  fun(bio); // frees bio

Since std::function supports default construction, the &quot;= NULL&quot; part is
implicit -- we do not need to pass NULL to std::unique for the default
std::function constructor to construct an empty/non-callable functor.


&gt;<i> We could also wrap the std::unique_ptr definition parts inside the macro
</I>&gt;<i> for much smaller visible code. But that would prevent re-use of the
</I>&gt;<i> macro for other plain Functor definitions (not that anything else is
</I>&gt;<i> using it).
</I>
If possible, we should avoid macros and should learn how to use C++11
correctly. In general, it makes little sense to suffer the pains of
switching to C++11 and then use macros for things C++11 is supposed to
provide or support natively.

However, in this specific case, some macros may be unavoidable or even a
good idea because we are also dealing with C libraries that we cannot
convert to C++11. Please give me a few hours to think whether there is a
macro-free solution available.


Thank you,

Alex.

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006456.html">[squid-dev] [PATCH] Deletors for std::unique_ptr WAS: Re: Broken trunk after r14735
</A></li>
	<LI>Next message: <A HREF="006458.html">[squid-dev] [PATCH] Deletors for std::unique_ptr fixing r14735
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6457">[ date ]</a>
              <a href="thread.html#6457">[ thread ]</a>
              <a href="subject.html#6457">[ subject ]</a>
              <a href="author.html#6457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
