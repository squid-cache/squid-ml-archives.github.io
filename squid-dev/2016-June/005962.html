<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] client header mangling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20client%20header%20mangling&In-Reply-To=%3Cd0a0fcb7-044e-4a4f-d707-0e3515f1ebc7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005959.html">
   <LINK REL="Next"  HREF="005970.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] client header mangling</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20client%20header%20mangling&In-Reply-To=%3Cd0a0fcb7-044e-4a4f-d707-0e3515f1ebc7%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] client header mangling">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jun 10 00:48:31 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005959.html">[squid-dev] [RFC] client header mangling
</A></li>
        <LI>Next message: <A HREF="005970.html">[squid-dev] [RFC] client header mangling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5962">[ date ]</a>
              <a href="thread.html#5962">[ thread ]</a>
              <a href="subject.html#5962">[ subject ]</a>
              <a href="author.html#5962">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/06/2016 9:49 a.m., Eliezer Croitoru wrote:
&gt;<i> I am trying to understand so bear with me couple seconds.
</I>&gt;<i> I have seen that there are pages\servers which doesn't state about the User-Agent in the Vary response while still taking it into account.
</I>&gt;<i> 
</I>&gt;<i> The caching side of the picture is storing an object which will never be served.
</I>&gt;<i> The HIT ratio is a whole other story  of the picture.
</I>&gt;<i> 
</I>&gt;<i> Since I am not inside the code but I do try to understand, currently what happens?
</I>
Currently what happens is Squid uses the real client headers or
ICAP/eCAP adapted headers when looking up the cached objects variant.

The admin might be fixing the actual response using
request_header_access/replace to craft what the server sees. But that
does not help Squid with the variants. Altering the headers prior to
cache lookup is needed for that, which today means ICAP/eCAP are needed.

I'm proposing making he header alteratiosn affect input as well as output.


&gt;<i> How many lookups are done for\per a request? 
</I>
1 or 2 if it is a Vary response.

&gt;<i> Do we run an object lookup after the response headers was received from the server?
</I>
No.

&gt;<i> Can we predict a Vary object based on the request only?(I assume that it will be an estimated and not absolute certainty if at all)
</I>
No.

&gt;<i> 
</I>&gt;<i> Also let say we have a 1k page ahead, would we want it to be fetched
</I>&gt;<i> from disk\ram store rather then from the origin server after we told
</I>&gt;<i> it we want the object?
</I>
This is not relevant. Size of the objects and where each would be placed
is not relevant to the problem.

The issue is that there are a huge, possibly infinite number of such
objects wasting filenum spaces/slots in the cache. There are only 2^25
object slots per cache location, so these huge sets of variants can
really cramp the storage even if they are only 1 bytes in size.


&gt;<i> 
</I>&gt;<i> I am almost sure that lowering the disk and ram stored objects should
</I>&gt;<i> be a goal by itself if we cannot &quot;dig&quot; them up from ram or disk later
</I>&gt;<i> for any use.
</I>
Yes, but not relevant to the current decision.

The question here is whether we should allow pre-cache header mangling
by admin as a way to reduce number of objects count for Vary responses.

The alternative is requiring them to use ICAP or eCAP to do it.
Possibly asking someone to write an eCAP module.


&gt;<i> 
</I>&gt;<i> A request_header_replace can work only for &quot;generic&quot; ones such as
</I>&gt;<i> without a language preference such as &quot;br&quot; added to some requests by
</I>&gt;<i> browser add-ons.
</I>
No. It can and will work for any header. Just requires the admin to know
what ones to modify and when. Which is still somewhat hard for unusual
headers.

Which is part of why I RFC'd it rather than going ahead and proposing a
patch.

&gt;<i> 
</I>&gt;<i> Now a step further, I can write a tiny ICAP service that will
</I>&gt;<i> &quot;handle&quot; common Vary headers from FireFox and other browsers to test
</I>&gt;<i> how it affects caches in general.
</I>
I'd rather eCAP for this than ICAP. But if you think you can do it and
want to try then we can work on the details of what the code needs to do.

Amos

</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005959.html">[squid-dev] [RFC] client header mangling
</A></li>
	<LI>Next message: <A HREF="005970.html">[squid-dev] [RFC] client header mangling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5962">[ date ]</a>
              <a href="thread.html#5962">[ thread ]</a>
              <a href="subject.html#5962">[ subject ]</a>
              <a href="author.html#5962">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
