<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH make ssl-bump implicit on HTTPS interception	ports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%20make%20ssl-bump%20implicit%20on%20HTTPS%20interception%0A%09ports&In-Reply-To=%3C02644fca-c895-529d-654b-c5ed27cf4150%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005990.html">
   <LINK REL="Next"  HREF="005991.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH make ssl-bump implicit on HTTPS interception	ports</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%20make%20ssl-bump%20implicit%20on%20HTTPS%20interception%0A%09ports&In-Reply-To=%3C02644fca-c895-529d-654b-c5ed27cf4150%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH make ssl-bump implicit on HTTPS interception	ports">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 14 02:55:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005990.html">[squid-dev] [PATCH] scripts/trace-kid.pl
</A></li>
        <LI>Next message: <A HREF="005991.html">[squid-dev] [PATCH make ssl-bump implicit on HTTPS interception ports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5986">[ date ]</a>
              <a href="thread.html#5986">[ thread ]</a>
              <a href="subject.html#5986">[ subject ]</a>
              <a href="author.html#5986">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Using an https_port with intercept or tproxy is pretty useless without
ssl-bump being enabled. So auto-enable the 'ssl-bump' option on those
ports instead of aborting with an error about ssl-bump being needed.

The result of this should be that the intercepted traffic gets received
by either the 'unknown protocol' pass-thru settings or the admins other
ssl-bump related settings enacted.

Amos
-------------- next part --------------
=== modified file 'doc/release-notes/release-4.sgml'
--- doc/release-notes/release-4.sgml	2016-06-09 20:31:15 +0000
+++ doc/release-notes/release-4.sgml	2016-06-13 14:45:42 +0000
@@ -272,6 +272,8 @@
 	&lt;p&gt;Removed &lt;em&gt;version=&lt;/em&gt; option. Use &lt;em&gt;tls-options=&lt;/em&gt; instead.
 	&lt;p&gt;Manual squid.conf update may be required on upgrade.
 	&lt;p&gt;Replaced &lt;em&gt;cafile=&lt;/em&gt; with &lt;em&gt;tls-cafile=&lt;/em&gt; which takes multiple entries.
+	&lt;p&gt;&lt;em&gt;ssl-bump&lt;/em&gt; is now implicitly enabled for &lt;em&gt;intercept&lt;/em&gt; or
+	   &lt;em&gt;tproxy&lt;/em&gt; ports.
 
 	&lt;tag&gt;icap_service&lt;/tag&gt;
 	&lt;p&gt;New scheme &lt;em&gt;<A HREF="icaps://&lt;/em">icaps://&lt;/em</A>&gt; to enable TLS/SSL connections to Secure ICAP

=== modified file 'src/cache_cf.cc'
--- src/cache_cf.cc	2016-04-03 23:41:58 +0000
+++ src/cache_cf.cc	2016-06-13 14:24:22 +0000
@@ -3696,10 +3696,9 @@
             debugs(3, DBG_CRITICAL, &quot;FATAL: ssl-bump on https_port requires tproxy/intercept which is missing.&quot;);
             self_destruct();
         }
-        if (hijacked &amp;&amp; !s-&gt;flags.tunnelSslBumping) {
-            debugs(3, DBG_CRITICAL, &quot;FATAL: tproxy/intercept on https_port requires ssl-bump which is missing.&quot;);
-            self_destruct();
-        }
+        // intercepted traffic on https_port implies 'ssl-bump'
+        if (hijacked &amp;&amp; !s-&gt;flags.tunnelSslBumping)
+            s-&gt;flags.tunnelSslBumping = true;
 #endif
         if (s-&gt;flags.proxySurrogate) {
             debugs(3,DBG_CRITICAL, &quot;FATAL: https_port: require-proxy-header option is not supported on HTTPS ports.&quot;);
@@ -3814,7 +3813,8 @@
     }
 
 #if USE_OPENSSL
-    if (s-&gt;flags.tunnelSslBumping)
+    // ssl-bump is implicit for HTTPS intercept/tproxy ports, otherwise explicit
+    if (s-&gt;flags.tunnelSslBumping &amp;&amp; !s-&gt;flags.isIntercepted())
         storeAppendPrintf(e, &quot; ssl-bump&quot;);
 #endif
 

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005990.html">[squid-dev] [PATCH] scripts/trace-kid.pl
</A></li>
	<LI>Next message: <A HREF="005991.html">[squid-dev] [PATCH make ssl-bump implicit on HTTPS interception ports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5986">[ date ]</a>
              <a href="thread.html#5986">[ thread ]</a>
              <a href="subject.html#5986">[ subject ]</a>
              <a href="author.html#5986">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
