<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] LockingPointer API update
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20LockingPointer%20API%20update&In-Reply-To=%3C576A6B94.4020609%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006016.html">
   <LINK REL="Next"  HREF="006025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] LockingPointer API update</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20LockingPointer%20API%20update&In-Reply-To=%3C576A6B94.4020609%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] LockingPointer API update">christos at chtsanti.net
       </A><BR>
    <I>Wed Jun 22 10:42:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006016.html">[squid-dev] [PATCH] LockingPointer API update
</A></li>
        <LI>Next message: <A HREF="006025.html">[squid-dev] [PATCH] LockingPointer API update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6024">[ date ]</a>
              <a href="thread.html#6024">[ thread ]</a>
              <a href="subject.html#6024">[ subject ]</a>
              <a href="author.html#6024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/22/2016 07:32 AM, Amos Jeffries wrote:
&gt;<i> On 22/06/2016 1:02 p.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 06/21/2016 04:00 AM, Amos Jeffries wrote:
</I>&gt;<i>
</I>&gt;<i> The two I saw were:
</I>&gt;<i>
</I>&gt;<i> 1) PeekingPeerConnector::handleServerCertificate() doing
</I>&gt;<i> serverBump-&gt;serverCert.reset(serverCert.release())
</I>&gt;<i>
</I>&gt;<i> On much closer inspection it appears not a bug. But is doing move
</I>&gt;<i> semantics without a move operator relying heavily on specific
</I>&gt;<i> implementation detail of TidyPointer API exposure.
</I>
This is not bug. The call
newServerCertPointer.reset(oldServerCertPointer.release())
just moves the X509 object with the current locks to the 
newServerCertPointer.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2) PeekingPeerConnector::serverCertificateVerified() doing two different
</I>&gt;<i> reset() vs resetAndLock() depending on the data source.
</I>&gt;<i>
</I>&gt;<i> The OpenSSL docs do say the call increments a reference count itself.
</I>&gt;<i> But I still think this is leaking. Since we explicitly unlock on
</I>&gt;<i> destruct as well as calling the necessary free API method in OpenSSL.
</I>
I do not think that this is leaking here.
The code is the following:

   Security::CertPointer serverCert;
    if (...) {
            // We need to lock here because the destructor of
	   // serverCert will call X509_free and will
            // decrease the lock of the
            serverCert.resetAndLock(serverBump-&gt;serverCert.get());
    } else {
            // We do not need to lock here, the SSL_get_peer_certificate
            // already increases the clock counter and we have to
            // free with X509_free.
            serverCert.reset(SSL_get_peer_certificate(ssl));
    }
    // serverCert::~serverCert() called on function
    // leave, calling X509_free.


For LockingCounter we need both a reset and a resetAndLock method to 
correctly using it with openSSL library. There are cases where an 
openSSL call increases the locking counter for the object it returns and 
other cases where it doesn't.

The LockingPointer is not perfect. But it is a class used and adjusted 
to be used for openSSL related objects. OpenSSL is a C library and it is 
not easy to convert openSSL objects to equivalent C++ objects.

I must also note that the locking pointer is not used only for X509 
objects but for other objects too.

In a point of view the LockingPointer should never moved under the 
Security and should be used only for openSSL related code.



</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006016.html">[squid-dev] [PATCH] LockingPointer API update
</A></li>
	<LI>Next message: <A HREF="006025.html">[squid-dev] [PATCH] LockingPointer API update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6024">[ date ]</a>
              <a href="thread.html#6024">[ thread ]</a>
              <a href="subject.html#6024">[ subject ]</a>
              <a href="author.html#6024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
