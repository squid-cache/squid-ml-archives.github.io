<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Retry cache peer DNS failures more	frequently
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Retry%20cache%20peer%20DNS%20failures%20more%0A%09frequently&In-Reply-To=%3Cd5bc95f8-a7f5-bfa1-c938-259541995b69%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006036.html">
   <LINK REL="Next"  HREF="006039.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Retry cache peer DNS failures more	frequently</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Retry%20cache%20peer%20DNS%20failures%20more%0A%09frequently&In-Reply-To=%3Cd5bc95f8-a7f5-bfa1-c938-259541995b69%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Retry cache peer DNS failures more	frequently">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jun 24 03:44:09 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006036.html">[squid-dev] [PATCH] Retry cache peer DNS failures more	frequently
</A></li>
        <LI>Next message: <A HREF="006039.html">[squid-dev] [PATCH] Update all stored headers on revalidation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6037">[ date ]</a>
              <a href="thread.html#6037">[ thread ]</a>
              <a href="subject.html#6037">[ subject ]</a>
              <a href="author.html#6037">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/06/2016 10:50 a.m., Nathan Hoad wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> Did anyone have any thoughts on the issues I had with this? I don't want
</I>&gt;<i> this to slip through the cracks :)
</I>&gt;<i> 
</I>
Sorry, half-wrote this reply a while back and didn't get time to finish
it ...

&gt;<i> 
</I>&gt;<i> On 17 May 2016 at 15:57, Nathan Hoad wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Attached is a patch which makes the changes recommended by Amos - each
</I>&gt;&gt;<i> peer now gets its own event for retrying resolution, dependent on the DNS
</I>&gt;&gt;<i> TTL. This should also fix up the concerns up by Alex. A few caveats though:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  - the cache manager shows generic &quot;peerRefreshDNS&quot; names for each event.
</I>&gt;&gt;<i> I can't find any examples that give it a dynamic name, e.g. I'd like
</I>&gt;&gt;<i> something like &quot;peerRefreshDNS(example.com)&quot;, but I can't think of how
</I>&gt;&gt;<i> I'd do that without leaking memory or making some significant changes to
</I>&gt;&gt;<i> the event handler system.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - I can't figure out how to reproduce the second failure case, where a
</I>&gt;&gt;<i> result comes back but it has no IP addresses. I _think_ using the TTL would
</I>&gt;&gt;<i> be valid instead of negative_dns_ttl would be valid in that situation, but
</I>&gt;&gt;<i> I can't be sure. I figured this was the safest option.
</I>
The positive vs negative is about whether the response code is NXDOMAIN.
With NX being the negative-TTL, and failures defaulting to that timer
since it is required to be the shorter one.

Outside the DNS code itself an empty set is usually a failure. Inside
DNS it might be a partial response with A or AAAA etc. still pending.


&gt;&gt;<i>
</I>&gt;&gt;<i>  - eventDelete does not appear to be clearing out events as I expect it
</I>&gt;&gt;<i> to, so if you reconfigure Squid you end up with some dead events, like so:
</I>
It is based on the function pointer value IIRC from the days when events
were unique and serial things.

If you have a Call object store somewher ehandy (the CachePeer?) then
using call-&gt;cancel() is the way to go and let the events queue do its
own cleaning.

&gt;&gt;<i>
</I>&gt;&gt;<i> [<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">root at xxx</A> ~]# squidmgr events | grep peerRefresh
</I>&gt;&gt;<i> Last event to run: peerRefreshDNS
</I>&gt;&gt;<i> peerRefreshDNS                  0.331 sec           1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  0.679 sec           1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  47.649 sec          1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  61.619 sec          1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  207.682 sec         1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  207.682 sec         1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  207.682 sec         1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  207.682 sec         1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  207.682 sec         1    yes
</I>&gt;&gt;<i> [<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">root at xxx</A> ~]# squid -k
</I>&gt;&gt;<i> reconfigure
</I>&gt;&gt;<i> [<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">root at xxx</A> ~]# squidmgr events | grep peerRefresh
</I>&gt;&gt;<i> Last event to run: peerRefreshDNS
</I>&gt;&gt;<i> peerRefreshDNS                  0.763 sec           1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  0.763 sec           1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  41.755 sec          1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  55.755 sec          1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  56.187 sec          1    no
</I>&gt;&gt;<i> peerRefreshDNS                  202.250 sec         1    no
</I>&gt;&gt;<i> peerRefreshDNS                  202.250 sec         1    no
</I>&gt;&gt;<i> peerRefreshDNS                  3599.758 sec        1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  3599.758 sec        1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  3599.758 sec        1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  3599.758 sec        1    yes
</I>&gt;&gt;<i> peerRefreshDNS                  3599.758 sec        1    yes
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I run squid -k reconfigure again, then the events with invalid callback
</I>&gt;&gt;<i> data are cleared out, so it doesn't grow indefinitely at least. I'm not
</I>&gt;&gt;<i> sure how or if I should fix this.
</I>
The above post-reconfigure list tells me that there is still at least
one of the old 3600 timeout eventAdd being scheduled somewhere. That
needs to be removed now that peers do their own.

Amos

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006036.html">[squid-dev] [PATCH] Retry cache peer DNS failures more	frequently
</A></li>
	<LI>Next message: <A HREF="006039.html">[squid-dev] [PATCH] Update all stored headers on revalidation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6037">[ date ]</a>
              <a href="thread.html#6037">[ thread ]</a>
              <a href="subject.html#6037">[ subject ]</a>
              <a href="author.html#6037">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
