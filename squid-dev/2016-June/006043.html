<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] TidyPointer removal
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20TidyPointer%20removal&In-Reply-To=%3C5771803A.7060101%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006042.html">
   <LINK REL="Next"  HREF="006044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] TidyPointer removal</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20TidyPointer%20removal&In-Reply-To=%3C5771803A.7060101%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] TidyPointer removal">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jun 27 19:36:26 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006042.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
        <LI>Next message: <A HREF="006044.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6043">[ date ]</a>
              <a href="thread.html#6043">[ thread ]</a>
              <a href="subject.html#6043">[ subject ]</a>
              <a href="author.html#6043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/27/2016 04:35 AM, Amos Jeffries wrote:
&gt;<i> This splits TidyPointer and LockingPointer by removing the inheritence
</I>&gt;<i> and copying the needed TidyPointer code into the LockingPointer as-is.
</I>
Why start duplicating TidyPointer/unique_ptr functionality in
LockingPointer? Can we [continue to] use unique_ptr in LockingPointer
instead, now as a data member?


&gt;<i> The resulting situation is that TidyPointer is a stand-alone Pointer
</I>&gt;<i> type that duplicates the std::unique_ptr API so closely it can almost be
</I>&gt;<i> a drop-in replacement. The remaining difference is that TidyPointer took
</I>&gt;<i> a function pointer whereas unique_ptr uses a Functor type.
</I>&gt;<i> 
</I>&gt;<i> Adding a UniaryFunctor(function, arg) macro in src/base/MakeFunctor.h to
</I>&gt;<i> replace the CtoCpp1(function, arg) macro used by TidyPointer allows us
</I>&gt;<i> to remove TidyPointer completely from Squid-4.
</I>
Replacing custom TidyPointer with standard unique_ptr is a welcomed
improvement that can and should be accepted. Whether you commit those
[polished] changes before or while fixing &quot;LockingPointer issues&quot; is
your call. However, this reasoning alone does not make code duplication
necessary or acceptable.


&gt;<i> The LockingPointer still has the issues which led us down the path to
</I>&gt;<i> getting here. I've chosen to stop and submit for review at this point to
</I>&gt;<i> ensure we still have a fully working Squid before going further down
</I>&gt;<i> this trail.
</I>
Stopping here is perfectly fine, but please do not duplicate
TidyPointer/unique_ptr code/functionality. That duplication did not
exist before, so you cannot argue that it is one of the old
LockingPointer issues that you will fix later.


&gt;<i> unique_ptr uses a Functor type.
</I>
This statement is inaccurate in its context -- unique_ptr does accept
[lvalue references to] functions as well. I believe this is by design --
any good template should not care whether it was given a simple function
or a Functor object.


&gt;<i> +/// DeAllocator functor for pointers that need free(3) from the std C library
</I>&gt;<i> +UniaryFunctor(xfree, char *);
</I>
Where is xfree_functor used? I only see xfree_char() which is defined
without using UniaryFunctor.


&gt;<i> +// Macro to be used to define a C++ functor of an extern &quot;C&quot;
</I>&gt;<i> +// function.
</I>
I do not see anything in this macro that would make it specific to
extern &quot;C&quot; functions. I think it works with any function. The old
CtoCpp1() macro was needed to convert &quot;extern C&quot; functions to &quot;extern
C++&quot; functions; the [ugly] macro description from r11100 &quot;worked&quot;
because the macro changed only one aspect -- the linking style changed
from C to C++. Here, you are changing two aspects at once, resulting in
a far less helpful comment IMO.


Combined, these observations related to adding functors lead me to
suspect that we do not need to replace CtoCpp1 with UniaryFunctor. What
errors do you get when building with CtoCpp1 instead of UniaryFunctor?

Similarly, is there something wrong with tidyFree() that forces you to
add xfree_char() [with a botched description]?


&gt;<i> +#define UniaryFunctor(function, argument_type) \
</I>
s/Uniary/Unary/ to fix spelling


I hope to post more polishing comments as well, but the code duplication
and functor issues should probably be resolved first.


Thank you,

Alex.
P.S. If you can post larger context diffs (e.g., -U30), please do so,
but there is no need to repost the last patch.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006042.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
	<LI>Next message: <A HREF="006044.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6043">[ date ]</a>
              <a href="thread.html#6043">[ thread ]</a>
              <a href="subject.html#6043">[ subject ]</a>
              <a href="author.html#6043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
