<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] TidyPointer removal
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20TidyPointer%20removal&In-Reply-To=%3C57731E6B.3090905%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006044.html">
   <LINK REL="Next"  HREF="006046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] TidyPointer removal</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20TidyPointer%20removal&In-Reply-To=%3C57731E6B.3090905%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] TidyPointer removal">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jun 29 01:03:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006044.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
        <LI>Next message: <A HREF="006046.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6045">[ date ]</a>
              <a href="thread.html#6045">[ thread ]</a>
              <a href="subject.html#6045">[ subject ]</a>
              <a href="author.html#6045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/28/2016 08:52 AM, Amos Jeffries wrote:
&gt;<i> On 28/06/2016 7:36 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 06/27/2016 04:35 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> This splits TidyPointer and LockingPointer by removing the inheritence
</I>&gt;&gt;&gt;<i> and copying the needed TidyPointer code into the LockingPointer as-is.
</I>

&gt;&gt;<i> Why start duplicating TidyPointer/unique_ptr functionality in
</I>&gt;&gt;<i> LockingPointer?
</I>

&gt;<i> So that LockingPointer is not affected by the unique_ptr change. 
</I>
That does not compute for me: Clearly, LockingPointer _is_ affected by
the unique_ptr change in your patch. And if you meant that
LockingPointer _callers_ should not be affected, then using unique_ptr
for LockingPointer _implementation_ will not affect LockingPointer
callers AFAICT.


&gt;<i> Without that LockingPointer would inherit from std::unique_ptr.
</I>
I hope you can avoid duplication without making unique_ptr a
LockingPointer parent. You can use unique_ptr for the LockingPointer
data member.


&gt;&gt;<i> Can we [continue to] use unique_ptr in LockingPointer
</I>&gt;&gt;<i> instead, now as a data member?
</I>
&gt;<i> I found we cannot. LockingPointer is doing too much non-unique_ptr
</I>&gt;<i> things with the locks. It is like a demented cross between unique_ptr,
</I>&gt;<i> shared_ptr and cbdata.
</I>
This does not compute for me: You have claimed that TidyPointer, the
former LockingPointer parent, is essentially a unique_ptr. I agreed with
that claim. Now you are claiming that you cannot use unique_ptr as a
private data member of LockingPointer because LockingPointer does
unusual things. Since you are not changing what LockingPointer does, I
would expect LockingPointer to [continue to] be able to use
TidyPointer/unique_ptr, regardless of how unusual LockingPointer is.
Both claims cannot be true at the same time AFAICT...

To make progress, I will rephrase the question: What unique_ptr
properties prevent you from using it for LockingPointer::raw?


&gt;<i> Thats also why I wanted to pause here and get an audit.
</I>
You did the right thing.



&gt;&gt;<i> Replacing custom TidyPointer with standard unique_ptr is a welcomed
</I>&gt;&gt;<i> improvement that can and should be accepted. Whether you commit those
</I>&gt;&gt;<i> [polished] changes before or while fixing &quot;LockingPointer issues&quot; is
</I>&gt;&gt;<i> your call. However, this reasoning alone does not make code duplication
</I>&gt;&gt;<i> necessary or acceptable.
</I>
&gt;<i> Nod. Its not exactly duplication though. It was cut-n-paste, not
</I>&gt;<i> copy-n-paste. So if anything is duplicated it was beforehand too, just
</I>&gt;<i> not so obviousy so.
</I>
TidyPointer was certainly duplicating unique_ptr. IIRC, there was a
valid reason for that functionality duplication -- Squid did not have a
reliable access to unique_ptr when TidyPointer was written. Note that
there was no code duplication from Squid point of view; there was a
&quot;reinventing the wheel&quot; problem instead.

Now, when replacing TidyPointer with the now-available std::unique_ptr
class, you can no longer use unique_ptr unavailability as an excuse to
duplicate TidyPointer/unique_ptr functionality in the LockingPointer.



&gt;&gt;&gt;<i> unique_ptr uses a Functor type.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This statement is inaccurate in its context -- unique_ptr does accept
</I>&gt;&gt;<i> [lvalue references to] functions as well. I believe this is by design --
</I>&gt;&gt;<i> any good template should not care whether it was given a simple function
</I>&gt;&gt;<i> or a Functor object.
</I>

&gt;<i> Thats how I took the documentation, in fact it says so outright in
</I>&gt;<i> place. But I was not able to easily get it to accept either a function
</I>&gt;<i> pointer, or a function type.
</I>
Yeah. I think there are two different problems here, and that obscures
the solution. I will illustrate using BIGNUM_Pointer as an example:

A) The Deleter template parameter must be a type, not an object. Thus,
declaring BIGNUM_Pointer using BN_free_cpp as Deleter does not work:
BN_free_cpp is not a type but an object.

B) We do not want to specify the Deleter object explicitly every time we
are defining our BIGNUM_Pointer objects. Thus, our Deleter type must
have a default constructor. Pointers to functions do not have default
constructors. Thus, the Deleter type must be a [DefaultConstructible]
class and not just a &quot;pointer to function X&quot; type.

All of the following &quot;typedef ... BIGNUM_Pointer&quot; variants compile in my
tests:

  1.  std::unique_ptr&lt;BIGNUM, std::function&lt;decltype(BN_free_cpp)&gt; &gt;
  2.  std::unique_ptr&lt;BIGNUM, std::function&lt;decltype(BN_free)&gt; &gt;
  3a. std::unique_ptr&lt;BIGNUM, decltype(&amp;BN_free_cpp) &gt;
  3b. std::unique_ptr&lt;BIGNUM, void(*)(BIGNUM*) &gt;

#3a and #3b force you to pass a specific deleter when defining
BIGNUM_Pointer objects, violating condition (B) above. For example:
  BIGNUM_Pointer bnp(..., &amp;BN_free_cpp);

#2 might suffer from the same problem that forced us to add the CtoCpp1
macro. Christos, the author of r11100 that added CtoCpp1, may be able to
confirm or deny this.


&gt;<i> ../../../src/ssl/gadgets.h:51:44: note:   expected a type, got
</I>&gt;<i> ‘Ssl::BN_free_cpp’
</I>
Yes, this is due to (A) above. Solutions #1-3 avoid that problem.


&gt;<i> If I give it the type instead of function pointer, like so:
</I>&gt;<i>   typedef std::unique_ptr&lt;BIGNUM, decltype(BN_free_cpp)&gt; BIGNUM_Pointer;
</I>
AFAICT, you want a reference to the function, not the function name
itself. I do not know why the usual decaying rules do not apply here,
but perhaps that is not important. #3a solves this but violates (B) as
discussed above.


&gt;<i> Asside from that the functor keeps the code looking almost the same as
</I>&gt;<i> it did before. So a bit less pain for all of us porting things to 3.5 in
</I>&gt;<i> the next years.
</I>
I hope the above both explains exactly why we need a functor here and
offers a similar std::function-based solution that does not require
re-inventing UnaryFunctor.


Thank you,

Alex.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006044.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
	<LI>Next message: <A HREF="006046.html">[squid-dev] [PATCH] TidyPointer removal
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6045">[ date ]</a>
              <a href="thread.html#6045">[ thread ]</a>
              <a href="subject.html#6045">[ subject ]</a>
              <a href="author.html#6045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
