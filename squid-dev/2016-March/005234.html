<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204430%20Squid%20crashes%20on%20shutdown%20while%0A%20cleaning%20up%20idle%20ICAP%20connections.&In-Reply-To=%3C56D5DDDE.5030109%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005235.html">
   <LINK REL="Next"  HREF="005237.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204430%20Squid%20crashes%20on%20shutdown%20while%0A%20cleaning%20up%20idle%20ICAP%20connections.&In-Reply-To=%3C56D5DDDE.5030109%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar  1 18:22:22 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005235.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
        <LI>Next message: <A HREF="005237.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5234">[ date ]</a>
              <a href="thread.html#5234">[ thread ]</a>
              <a href="subject.html#5234">[ subject ]</a>
              <a href="author.html#5234">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/29/2016 07:36 PM, Amos Jeffries wrote:

&gt;<i> Please split the IndependentRunner and ConnStateData parts out of the
</I>&gt;<i> main patch. It is unrelated to the ICAP bug specifics.
</I>
The IndependentRunner parts are fixing the RR API abuse introduced by
the ConnStateData changes while solving pretty much the same bug.
IndependentRunner is needed by both ConnStateData and ICAP code.
Separating these changes would only increase overhead IMO (but can be
done if you insist, of course).


&gt;<i>  I am a little worried about the virtual change to finishedShutdown(). I
</I>&gt;<i> have found myself several times already mistakenly implementing that
</I>&gt;<i> hook in child Runners. The lack of virtual was what made me take a
</I>&gt;<i> second look and fix my design bug.
</I>
&gt;<i>  If we go ahead with this I would kind of like some other mechanism for
</I>&gt;<i> IndependentRunner to use to avoid &quot;delete this&quot; that requires a bit more
</I>&gt;<i> dev thought and work to make use of than simply overridding the virtual
</I>&gt;<i> method.
</I>
We will make accidentally overriding finishedShutdown() impossible in
the next version of the patch.



&gt;<i> On the other hand;
</I>&gt;<i>  ConnStateData being a Runner situation was only intended to be a
</I>&gt;<i> temporary middle-term workaround until we had a global list of client
</I>&gt;<i> connections workingproperly and the comm_exit was itself turned into a
</I>&gt;<i> proper Runner.
</I>
IndependentRunner simplifies any future migration of shutdown-handling
responsibilities. Our ConnStateData changes help you replace your
temporary workaround with a long-term solution (whatever it is).

IndependentRunner is needed if we have any shutdown handlers that cannot
be deleted by the RR registry. I expect the number of such handlers
increase rather than go to zero.


&gt;<i> On the other hand;
</I>&gt;<i>  comm_exit action still needs to be made into a Runner.
</I>
I doubt the end of Comm service should be [a designated RR event]. Like
memory operations, Comm service should be provided when somebody needs
it, no matter when that happens. We are obviously not there yet, but
that is the design I recommend moving towards instead of trying to time
Comm exit &quot;just right&quot; and make all Comm users responsible for handling
a yet another special event.


Thank you,

Alex.
P.S. I wish you were as thorough when reviewing the changes that first
introduced RR abuse for short-lived objects like ConnStateData. Oh, wait...

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005235.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
	<LI>Next message: <A HREF="005237.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5234">[ date ]</a>
              <a href="thread.html#5234">[ thread ]</a>
              <a href="subject.html#5234">[ subject ]</a>
              <a href="author.html#5234">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
