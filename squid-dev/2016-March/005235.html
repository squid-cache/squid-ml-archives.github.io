<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204430%20Squid%20crashes%20on%20shutdown%20while%0A%20cleaning%20up%20idle%20ICAP%20connections.&In-Reply-To=%3C56D63D89.6050307%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005232.html">
   <LINK REL="Next"  HREF="005234.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204430%20Squid%20crashes%20on%20shutdown%20while%0A%20cleaning%20up%20idle%20ICAP%20connections.&In-Reply-To=%3C56D63D89.6050307%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar  2 01:10:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005232.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
        <LI>Next message: <A HREF="005234.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5235">[ date ]</a>
              <a href="thread.html#5235">[ thread ]</a>
              <a href="subject.html#5235">[ subject ]</a>
              <a href="author.html#5235">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/03/2016 5:21 a.m., Christos Tsantilas wrote:
&gt;<i> On 03/01/2016 04:36 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 1/03/2016 9:31 a.m., Christos Tsantilas wrote:
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>    Squid crashes on shutdown with the following backtrace:
</I>&gt;&gt;&gt;<i> (gdb) bt
</I>&gt;&gt;&gt;<i> #0  0x00000000007138d8 in commSetConnTimeout(RefCount&lt;Comm::Connection&gt;
</I>&gt;&gt;&gt;<i> const&amp;, int, RefCount&lt;AsyncCall&gt;&amp;) ()
</I>&gt;&gt;&gt;<i> #1  0x0000000000510ddf in
</I>&gt;&gt;&gt;<i> commUnsetConnTimeout(RefCount&lt;Comm::Connection&gt; const&amp;) ()
</I>&gt;&gt;&gt;<i> #2  0x00000000006104a4 in
</I>&gt;&gt;&gt;<i> IdleConnList::clearHandlers(RefCount&lt;Comm::Connection&gt; const&amp;) ()
</I>&gt;&gt;&gt;<i> #3  0x000000000041226b in IdleConnList::closeN(unsigned long) ()
</I>&gt;&gt;&gt;<i> #4  0x0000000000412bf9 in IdleConnList::~IdleConnList() ()
</I>&gt;&gt;&gt;<i> #5  0x0000000000617e9b in Adaptation::Icap::ServiceRep::~ServiceRep() ()
</I>&gt;&gt;&gt;<i> #6  0x0000000000618579 in Adaptation::Icap::ServiceRep::~ServiceRep() ()
</I>&gt;&gt;&gt;<i> #7  0x000000000060e79c in Adaptation::DetachServices() ()
</I>&gt;&gt;&gt;<i> #8  0x0000000000606da0 in Adaptation::Config::freeService() ()
</I>&gt;&gt;&gt;<i> #9  0x0000000000606e4e in Adaptation::Config::~Config() ()
</I>&gt;&gt;&gt;<i> #10 0x001237f3e8664e29 in __run_exit_handlers (status=0,
</I>&gt;&gt;&gt;<i> listp=0x7f3e5c9cf5a8 &lt;__exit_funcs&gt;,
</I>&gt;&gt;&gt;<i>      run_list_atexit=<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">run_list_atexit at entry</A>=true) at exit.c:82
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The global Adaptation::Icap::TheConfig object is automatically
</I>&gt;&gt;&gt;<i> destroyed when Squid exits. Its destructor destroys Icap::ServiceRep
</I>&gt;&gt;&gt;<i> objects that, in turn, close all open connections in the idle
</I>&gt;&gt;&gt;<i> connections pool. Since this happens after comm_exit has destroyed all
</I>&gt;&gt;&gt;<i> Comm structures associated with those connections, Squid crases.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am attaching two patches. A simple  patch
</I>&gt;&gt;&gt;<i> (Squid-Segfault-on-Shutdown-t2.patch) which I believe it should applied
</I>&gt;&gt;&gt;<i> to squid-3.5, but also I am posting a second preview patch
</I>&gt;&gt;&gt;<i> (Squid-Segfault-on-Shutdown-preview-trunk-t4.patch) with a possible long
</I>&gt;&gt;&gt;<i> term solution.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am suggesting to commit for now the squid3.5 patch while we are
</I>&gt;&gt;&gt;<i> discussing a long term solution for this or future similar problems for
</I>&gt;&gt;&gt;<i> trunk.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Okay. +1 on that 3.5 patch going in.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For the other:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please split the IndependentRunner and ConnStateData parts out of the
</I>&gt;&gt;<i> main patch. It is unrelated to the ICAP bug specifics.
</I>&gt;<i> 
</I>&gt;<i> OK.
</I>&gt;<i> However the IndepedentRunner is a solution for runner objects which can
</I>&gt;<i> be destroyed outside the runners registry.
</I>&gt;<i> The ICAP IdleConnList are such objects.
</I>&gt;<i> 
</I>
They are that. But the ConnStateData is already present and would
benefit. The two changes can therefore be separated and tested
independently to ensure the IndepedentRunner design is okay without the
patch size explosion for IdleConnList.


&gt;&gt;<i>
</I>&gt;&gt;<i> On the one hand;
</I>&gt;&gt;<i>   I am a little worried about the virtual change to finishedShutdown(). I
</I>&gt;&gt;<i> have found myself several times already mistakenly implementing that
</I>&gt;&gt;<i> hook in child Runners. The lack of virtual was what made me take a
</I>&gt;&gt;<i> second look and fix my design bug.
</I>&gt;<i> 
</I>&gt;<i> The finishShutdown should not be used or overwritten by kid classes.
</I>&gt;<i> Maybe we can convert it to a private function.
</I>
Nod.

&gt;<i> 
</I>&gt;&gt;<i>   If we go ahead with this I would kind of like some other mechanism for
</I>&gt;&gt;<i> IndependentRunner to use to avoid &quot;delete this&quot; that requires a bit more
</I>&gt;&gt;<i> dev thought and work to make use of than simply overridding the virtual
</I>&gt;<i> 
</I>&gt;<i> In this case we are running the risk to make it complex and finally add
</I>&gt;<i> more bugs than those we are trying to solve...
</I>

I was thinking along the lines of some private/protected flag that had
to be explicitly set by IndependentRunner (in its ctor?) to skip the
delete. The name of that flag would be part of the documentation that is
was being dangerous.
 Just something harder than defining a virtual method.


&gt;<i> 
</I>&gt;&gt;<i> method. Making it easier to use IndependentRunner than to duplicate its
</I>&gt;&gt;<i> purpose by accident is a good thing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On the other hand;
</I>&gt;&gt;<i>   ConnStateData being a Runner situation was only intended to be a
</I>&gt;&gt;<i> temporary middle-term workaround until we had a global list of client
</I>&gt;&gt;<i> connections workingproperly and the comm_exit was itself turned into a
</I>&gt;&gt;<i> proper Runner.
</I>&gt;<i> 
</I>&gt;<i> ok.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On the other hand;
</I>&gt;&gt;<i>   comm_exit action still needs to be made into a Runner. Which will make
</I>&gt;&gt;<i> its exact timing less predictable and require us to design some
</I>&gt;&gt;<i> friendlier behaviour for it in the case of still-open FD.
</I>&gt;&gt;<i>   - for a long-term solution we should aim at that happening sooner
</I>&gt;&gt;<i> rather than later.
</I>&gt;&gt;<i>   - this does not conflict with the need to fix the ICAP idle list and
</I>&gt;&gt;<i> many other FD uses.
</I>&gt;<i> 
</I>&gt;<i> I do not disagree with this as a general plan. What are you suggesting?
</I>

I have only got a few half-formed (aka bad) ideas at present. I keep
floating back to the idea of a Runner that tries to do some action and
if it does not succeed immediately causes itself to happen at the end of
the current runner chain.

That might mean adapting the Registry to take a success/fail result from
the hooks, or Runners de-registering and re-registering themselves. Or
havig two hooks, one being 'hopeful', and another later being absolute.
Pretty bad / rough ideas right now.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005232.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
	<LI>Next message: <A HREF="005234.html">[squid-dev] [PATCH] Bug 4430 Squid crashes on shutdown while cleaning up idle ICAP connections.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5235">[ date ]</a>
              <a href="thread.html#5235">[ thread ]</a>
              <a href="subject.html#5235">[ subject ]</a>
              <a href="author.html#5235">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
