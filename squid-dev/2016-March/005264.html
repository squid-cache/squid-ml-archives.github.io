<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] shared_memory_locking
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shared_memory_locking&In-Reply-To=%3C56E18C44.2080402%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005263.html">
   <LINK REL="Next"  HREF="005272.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] shared_memory_locking</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shared_memory_locking&In-Reply-To=%3C56E18C44.2080402%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] shared_memory_locking">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Mar 10 15:01:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005263.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
        <LI>Next message: <A HREF="005272.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5264">[ date ]</a>
              <a href="thread.html#5264">[ thread ]</a>
              <a href="subject.html#5264">[ subject ]</a>
              <a href="author.html#5264">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/10/2016 01:33 AM, Amos Jeffries wrote:
&gt;<i> On 10/03/2016 11:14 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     The attached patch adds a &quot;shared_memory_locking&quot; configuration
</I>&gt;&gt;<i> directive to control mlock(2).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Locking shared memory at startup avoids SIGBUS crashes when kernel runs
</I>&gt;&gt;<i> out of RAM during runtime. This has been discussed during the &quot;[RFC] Fix
</I>&gt;&gt;<i> shared memory initialization, cleanup. Ensure its usability.&quot; thread
</I>&gt;&gt;<i> archived at
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why not enable locking by default? Unfortunately, locking requires
</I>&gt;&gt;<i> privileges and/or much-higher-than-default RLIMIT_MEMLOCK limits. Thus,
</I>&gt;&gt;<i> requiring locked memory by default is likely to cause too many
</I>&gt;&gt;<i> complaints, especially since Squid has not required that before. Even
</I>&gt;&gt;<i> &quot;make check&quot; will not work in most environments (without making our unit
</I>&gt;&gt;<i> tests even less representative)! Thus, the default is off, at least for now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As we gain more experience, we may enable locking by default while
</I>&gt;&gt;<i> making default locking failures non-fatal and warning about significant
</I>&gt;&gt;<i> [accumulated] locking delays. The proposed code was written to make
</I>&gt;&gt;<i> those possible future changes easier, but I am not volunteering to
</I>&gt;&gt;<i> implement them at this time.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> In Ipc::Mem::Segment::lock():
</I>&gt;<i> 
</I>&gt;<i> * please use #if defined() instead of #ifdef.
</I>
Done.


&gt;<i> * fatalf() sends a FATAL level error to cache.log. No need to preceed it
</I>&gt;<i> with a less important debugs ERROR message saying the same thing.
</I>
There is such a need, unfortunately: The FATAL error is printed much
later than the error is found, making triage a lot more difficult in
some cases. In the extreme cases, the FATAL error is not printed at all
(because Squid crashes long before fatal.cc code gets to printing the
error). Fixing this fatal() problem is outside this patch scope.

To partially address your concern, I set debugs() level to 5 and removed
the ERROR prefix. This still helps with triage when higher debugging
levels are configured and makes the new code consistent with most other
fatal() calls in Segment.cc.


Thank you,

Alex.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: shm-lock-t4.patch
Type: text/x-diff
Size: 11503 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160310/06233bb3/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160310/06233bb3/attachment.patch</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005263.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
	<LI>Next message: <A HREF="005272.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5264">[ date ]</a>
              <a href="thread.html#5264">[ thread ]</a>
              <a href="subject.html#5264">[ subject ]</a>
              <a href="author.html#5264">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
