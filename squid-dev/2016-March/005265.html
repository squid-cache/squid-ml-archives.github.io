<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20assertion%20failed%3A%20Write.cc%3A41%3A%20%22%21ccb-%3Eactive%28%29%22&In-Reply-To=%3C56E1C783.1060002%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005262.html">
   <LINK REL="Next"  HREF="005266.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20assertion%20failed%3A%20Write.cc%3A41%3A%20%22%21ccb-%3Eactive%28%29%22&In-Reply-To=%3C56E1C783.1060002%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;">christos at chtsanti.net
       </A><BR>
    <I>Thu Mar 10 19:14:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005262.html">[squid-dev] [PATCH] Fix HttpRequest object leaks in Squid 4.0.x
</A></li>
        <LI>Next message: <A HREF="005266.html">[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5265">[ date ]</a>
              <a href="thread.html#5265">[ thread ]</a>
              <a href="subject.html#5265">[ subject ]</a>
              <a href="author.html#5265">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,
  I am attaching two patches for this bug. One simple for squid-3.5 (t1 
patch) and one more complex (t2 patch). The simple patch solve the bug 
for now, but may leave other similar bugs in squid.

Bug description:
    - The client side and server side are finished
    - On server side the Ftp::Relay::finalizeDataDownload() is called and
      schedules the Ftp::Server::originDataCompletionCheckpoint
    - On client side the &quot;Ftp::Server::userDataCompletionCheckpoint&quot; is
      called. This is schedules a write to control connection and closes
      data connection.
    - The Ftp::Server::originDataCompletionCheckpoint is called which is
      trying to write to control connection and the assertion triggered.

This bug is an corner case, where the client-side  (FTP::Server) should 
wait for the server side (Ftp::Client/Ftp::Relay) to finish its job 
before respond to the FTP client. In this bug the existing mechanism, 
designed to handle such problems, did not worked correctly and resulted 
to a double writing to the client.

To understand why it is important such mechanism, imagine the case where 
an FTP client download a huge file and the ICAP server
block this file. In this case Squid needs to delay response to the FTP
client until the squid server-side closes its data connection too and
get the response from FTP server. This is required because we can not 
accept more commands from FTP client, if we can not forward them to the 
FTP server.

Moreover Squid can fall into such cases when a download or upload may 
aborted abnormally by one of the client or server.  The problem can 
become more complicated if ICAP/adaptation is used and squid respond to 
a download request without contacting the FTP server.

This patch try to fix the existing mechanism as follows:
- When Ftp::Server receives a &quot;startWaitingForOrigin&quot; callback, 
postpones writting possible responses to the client and keeps waiting 
for the stopWaitingForOrigin callback

- When the Ftp::Server receives a &quot;stopWaitingForOrigin&quot; callback, 
resumes any postponed response.

- When the Ftp::Client starts working on a DATA-related transaction 
calls the Ftp::Server::startWaitingForOrigin callback

- When the Ftp::Client finishes its job or when its abort abnormaly, 
checks whether it needs to call Ftp::Server::stopWaitingForOrigin callback.

- Also this patch try to fix the status code returned to the FTP client 
taking in account the status code returned by FTP server. The 
&quot;Ftp::Server::stopWaitingForOrigin&quot; is used to pass the returned status 
code to the client side.

This is a Measurement Factory project


-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-156-assertion_failed_Write.cc_41-not_ccb_active-squid-3.5-t1.patch
Type: text/x-patch
Size: 5069 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160310/d9f24d41/attachment-0002.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160310/d9f24d41/attachment-0002.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-156-assertion_failed_Write.cc_41-not_ccb_active-trunk-t2.patch
Type: text/x-patch
Size: 26352 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160310/d9f24d41/attachment-0003.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160310/d9f24d41/attachment-0003.bin</A>&gt;
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005262.html">[squid-dev] [PATCH] Fix HttpRequest object leaks in Squid 4.0.x
</A></li>
	<LI>Next message: <A HREF="005266.html">[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5265">[ date ]</a>
              <a href="thread.html#5265">[ thread ]</a>
              <a href="subject.html#5265">[ subject ]</a>
              <a href="author.html#5265">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
