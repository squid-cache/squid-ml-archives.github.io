<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] shared_memory_locking
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shared_memory_locking&In-Reply-To=%3C56E23B57.6020805%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005264.html">
   <LINK REL="Next"  HREF="005273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] shared_memory_locking</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shared_memory_locking&In-Reply-To=%3C56E23B57.6020805%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] shared_memory_locking">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 11 03:28:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005264.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
        <LI>Next message: <A HREF="005273.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5272">[ date ]</a>
              <a href="thread.html#5272">[ thread ]</a>
              <a href="subject.html#5272">[ subject ]</a>
              <a href="author.html#5272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2016 4:01 a.m., Alex Rousskov wrote:
&gt;<i> On 03/10/2016 01:33 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 10/03/2016 11:14 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     The attached patch adds a &quot;shared_memory_locking&quot; configuration
</I>&gt;&gt;&gt;<i> directive to control mlock(2).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Locking shared memory at startup avoids SIGBUS crashes when kernel runs
</I>&gt;&gt;&gt;<i> out of RAM during runtime. This has been discussed during the &quot;[RFC] Fix
</I>&gt;&gt;&gt;<i> shared memory initialization, cleanup. Ensure its usability.&quot; thread
</I>&gt;&gt;&gt;<i> archived at
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Why not enable locking by default? Unfortunately, locking requires
</I>&gt;&gt;&gt;<i> privileges and/or much-higher-than-default RLIMIT_MEMLOCK limits. Thus,
</I>&gt;&gt;&gt;<i> requiring locked memory by default is likely to cause too many
</I>&gt;&gt;&gt;<i> complaints, especially since Squid has not required that before. Even
</I>&gt;&gt;&gt;<i> &quot;make check&quot; will not work in most environments (without making our unit
</I>&gt;&gt;&gt;<i> tests even less representative)! Thus, the default is off, at least for now.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As we gain more experience, we may enable locking by default while
</I>&gt;&gt;&gt;<i> making default locking failures non-fatal and warning about significant
</I>&gt;&gt;&gt;<i> [accumulated] locking delays. The proposed code was written to make
</I>&gt;&gt;&gt;<i> those possible future changes easier, but I am not volunteering to
</I>&gt;&gt;&gt;<i> implement them at this time.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In Ipc::Mem::Segment::lock():
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * please use #if defined() instead of #ifdef.
</I>&gt;<i> 
</I>&gt;<i> Done.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> * fatalf() sends a FATAL level error to cache.log. No need to preceed it
</I>&gt;&gt;<i> with a less important debugs ERROR message saying the same thing.
</I>&gt;<i> 
</I>&gt;<i> There is such a need, unfortunately: The FATAL error is printed much
</I>&gt;<i> later than the error is found, making triage a lot more difficult in
</I>&gt;<i> some cases. In the extreme cases, the FATAL error is not printed at all
</I>&gt;<i> (because Squid crashes long before fatal.cc code gets to printing the
</I>&gt;<i> error). Fixing this fatal() problem is outside this patch scope.
</I>
I'm talking about these lines:

 ... {
+        const int savedError = errno;
+        debugs(54, DBG_IMPORTANT, &quot;ERROR: shared_memory_locking enabled
but mlock(&quot; &lt;&lt; theName &lt;&lt; ',' &lt;&lt; theSize &lt;&lt; &quot;) failed: &quot; &lt;&lt;
xstrerr(savedError));
+        fatalf(&quot;shared_memory_locking on but failed to mlock(%s, %&quot;
PRId64 &quot;): %s\n&quot;,
+               theName.termedBuf(), theSize, xstrerr(savedError));
+    }

&gt;<i> 
</I>&gt;<i> To partially address your concern, I set debugs() level to 5 and removed
</I>&gt;<i> the ERROR prefix. This still helps with triage when higher debugging
</I>&gt;<i> levels are configured and makes the new code consistent with most other
</I>&gt;<i> fatal() calls in Segment.cc.
</I>
If there is a bug in fatalf() that's something else that needs to be
fixed. But there has been no sign that I'm aware of about any such issue
in for any of the hundreds of other calls to it. Please dont make bad
code here just for that.

Amos

</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005264.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
	<LI>Next message: <A HREF="005273.html">[squid-dev] [PATCH] shared_memory_locking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5272">[ date ]</a>
              <a href="thread.html#5272">[ thread ]</a>
              <a href="subject.html#5272">[ subject ]</a>
              <a href="author.html#5272">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
