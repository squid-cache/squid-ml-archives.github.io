<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PREVIEW] Free AccessLogEntry::url when needed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPREVIEW%5D%20Free%20AccessLogEntry%3A%3Aurl%20when%20needed&In-Reply-To=%3C56E255F2.2060102%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005268.html">
   <LINK REL="Next"  HREF="005314.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PREVIEW] Free AccessLogEntry::url when needed</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPREVIEW%5D%20Free%20AccessLogEntry%3A%3Aurl%20when%20needed&In-Reply-To=%3C56E255F2.2060102%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PREVIEW] Free AccessLogEntry::url when needed">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 11 05:21:54 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005268.html">[squid-dev] [PREVIEW] Free AccessLogEntry::url when needed
</A></li>
        <LI>Next message: <A HREF="005314.html">[squid-dev] [PREVIEW] Free AccessLogEntry::url when needed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5280">[ date ]</a>
              <a href="thread.html#5280">[ thread ]</a>
              <a href="subject.html#5280">[ subject ]</a>
              <a href="author.html#5280">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2016 12:53 p.m., Nathan Hoad wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> The attached patch is a demonstration of a memory leak on
</I>&gt;<i> AccessLogentry::url, created by ACLFilledChecklist::syncAle(). The
</I>&gt;<i> patch itself is not good enough quality to warrant acceptance, and no
</I>&gt;<i> doubt introduces bugs.
</I>&gt;<i> 
</I>&gt;<i> ::syncAle() is the only place in the codebase that assigns a URL that
</I>&gt;<i> AccessLogEntry is expected to free(), which AccessLogEntry doesn't do.
</I>&gt;<i> This results in a memory leak.
</I>&gt;<i> 
</I>&gt;<i> As mentioned, the patch is of questionable quality, as the chunk in
</I>&gt;<i> src/client_side.cc shows. This sort of change would have to be made
</I>&gt;<i> everywhere that url is assigned to, which isn't practical.
</I>&gt;<i> 
</I>&gt;<i> It would be good to modify ::syncAle() so that it doesn't allocate a
</I>&gt;<i> new URL, but I'm not sure how that could be achieved. I think the only
</I>&gt;<i> workable alternative is to change AccessLogEntry::url to a more
</I>&gt;<i> intelligent string type. There is also the possibility of making the
</I>&gt;<i> member private and using a setter to ensure it is always xstrdup'd
</I>&gt;<i> from another URL.
</I>&gt;<i> 
</I>&gt;<i> If someone with better knowledge than me would like to make a
</I>&gt;<i> recommendation on what to do here, I'd be happy to work towards a
</I>&gt;<i> better solution.
</I>
You can probably guess by now that I'm going to say SBuf.

In this case there is also possibly the option of removing that url
variable entirely. A class URL is the proper way to store URLs. But that
could be significantly more work to make URL ref-countable with a Pointer.

FYI:
 SBuf is the intended solution to all our many string related problems.
We are just in the transitional period of converting things.

One issue we are working around during the transition time is that SBuf
data-copies when importing from any non-SBuf type, and when c_str() is
called to export. Effort to avoid those is worthwhile. Use in the wrong
places can reduce performance noticably.
 However, any object which is already being allocated or copied to the
string/char* can be SBuf converted without this being a new cost. And we
then gain improved memory management from it.

Amos

</PRE>
































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005268.html">[squid-dev] [PREVIEW] Free AccessLogEntry::url when needed
</A></li>
	<LI>Next message: <A HREF="005314.html">[squid-dev] [PREVIEW] Free AccessLogEntry::url when needed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5280">[ date ]</a>
              <a href="thread.html#5280">[ thread ]</a>
              <a href="subject.html#5280">[ subject ]</a>
              <a href="author.html#5280">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
