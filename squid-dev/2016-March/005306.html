<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20assertion%20failed%3A%20Write.cc%3A41%3A%0A%20%22%21ccb-%3Eactive%28%29%22&In-Reply-To=%3C56E6E7BD.7010708%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005308.html">
   <LINK REL="Next"  HREF="005310.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20assertion%20failed%3A%20Write.cc%3A41%3A%0A%20%22%21ccb-%3Eactive%28%29%22&In-Reply-To=%3C56E6E7BD.7010708%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Mar 14 16:33:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005308.html">[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
</A></li>
        <LI>Next message: <A HREF="005310.html">[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5306">[ date ]</a>
              <a href="thread.html#5306">[ thread ]</a>
              <a href="subject.html#5306">[ subject ]</a>
              <a href="author.html#5306">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/13/2016 01:57 PM, Christos Tsantilas wrote:
&gt;<i> On 03/10/2016 11:35 PM, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 03/10/2016 12:14 PM, Christos Tsantilas wrote:
</I>
&gt;&gt;&gt;<i>      if (master-&gt;serverState == fssHandleDataRequest) {
</I>&gt;&gt;&gt;<i> +        if (!master-&gt;userDataDone) {
</I>&gt;&gt;<i> ...
</I>&gt;&gt;&gt;<i> +            originDataDownloadAbortedOnError = (originStatus &gt; 400);
</I>&gt;&gt;&gt;<i> +            return;
</I>&gt;&gt;&gt;<i> +        }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +        completeDataExchange();
</I>&gt;&gt;&gt;<i> +    } else {
</I>&gt;&gt;&gt;<i> +        if (delayedReply != NULL) {
</I>&gt;&gt;&gt;<i> +            writeForwardedReply(delayedReply.getRaw());
</I>&gt;&gt;&gt;<i> +            delayedReply = NULL;
</I>&gt;&gt;&gt;<i> +        }
</I>&gt;&gt;&gt;<i> +    }
</I>

&gt;&gt;<i> The above logic looks correct to me, but I feel like I am reading an
</I>&gt;&gt;<i> inside-out code. Please consider this instead:
</I>

&gt;<i> I did not follow your suggestion here.
</I>&gt;<i> The completeDataExchange should be called only if we are downloading
</I>&gt;<i> data. 
</I>
I think your code is [still] correct but, thanks to your comments, I now
understand where [my] confusion about its meaning was coming from. I
suggest the following (functionally-equivalent) code:


&gt;<i> void
</I>&gt;<i> Ftp::Server::stopWaitingForOrigin(int originStatus)
</I>&gt;<i> {
</I>&gt;<i>     Must(waitingForOrigin);
</I>&gt;<i>     waitingForOrigin = false;
</I>&gt;<i> 
</I>&gt;<i>     // completeDataExchange() could be waitingForOrigin in fssHandleDataRequest
</I>&gt;<i>     if (master-&gt;serverState == fssHandleDataRequest) {
</I>&gt;<i>         // Depending on which side has finished downloading first, either trust 
</I>&gt;<i>         // master-&gt;userDataDone status or set originDataDownloadAbortedOnError:
</I>&gt;<i>         if (master-&gt;userDataDone) {
</I>&gt;<i>             // We finished downloading before Ftp::Client. Most likely, the
</I>&gt;<i>             // adaptation shortened the origin response or we hit an error.
</I>&gt;<i>             // Our status (stored in master-&gt;userDataDone) is more informative.
</I>&gt;<i>             // Use master-&gt;userDataDone; avoid originDataDownloadAbortedOnError.
</I>&gt;<i>             completeDataExchange();
</I>&gt;<i>         } else {
</I>&gt;<i>             debugs(33, 5, &quot;too early to write the response&quot;);
</I>&gt;<i>             // Ftp::Client naturally finished downloading before us. Set
</I>&gt;<i>             // originDataDownloadAbortedOnError to overwrite future
</I>&gt;<i>             // master-&gt;userDataDone and relay Ftp::Client error, if there was
</I>&gt;<i>             // any, to the user.
</I>&gt;<i>             originDataDownloadAbortedOnError = (originStatus &gt;= 400);
</I>&gt;<i>         }
</I>&gt;<i>         return;
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     if (delayedReply) {
</I>&gt;<i>         writeForwardedReply(delayedReply.getRaw());
</I>&gt;<i>         delayedReply = nullptr;
</I>&gt;<i>     }
</I>&gt;<i> }
</I>

The only remaining doubt in my mind is the combination of delayedReply
and fssHandleDataRequest state. The above code appears to assume that,
in fssHandleDataRequest, delayedReply is either always nil or never
important. Is that really true? delayedReply is set in
Ftp::Server::writeForwardedReply() which is called from lots of places,
including Ftp::Server::handleDataReply(). May it be set in
fssHandleDataRequest?

Why are we prioritizing completeDataExchange() over
writeForwardedReply(delayedReply)?

And if we are doing the right thing, should we either assert that with
Must(!delayedReply) in the beginning of the fssHandleDataRequest clause
or clear the delayedReply, if any, in that clause?


&gt;<i> +        debugs(33, 5, &quot;Transfering from FTP server is not complete&quot;);
</I>
&gt;<i> +        debugs(33, 5, &quot;Transfering from FTP server terminated with an error, adjust status code&quot;);
</I>
s/FTP server/FTP origin server/ to minimize the chance of this &quot;FTP
server&quot; phrase being misinterpreted as Ftp::Server.



&gt;<i> Probably the completeDataExchange should be renamed to
</I>&gt;<i> completeDataDownload. It is used only while we are downloading objects
</I>&gt;<i> (not uploading).
</I>
Agreed.



&gt;&gt;<i> All of these are pretty much cosmetic changes that do not alter the
</I>&gt;&gt;<i> proposed patch functionality AFAICT. IMO, if there are no objections,
</I>&gt;&gt;<i> the polished patch should go into trunk (see above regarding v3.5).
</I>&gt;<i> 
</I>&gt;<i> I am attaching a new patch here, if no objection I will apply this to
</I>&gt;<i> trunk.
</I>
Please do, especially if my concerns regarding the combination of
delayedReply and fssHandleDataRequest state are easily addressed.


Thank you,

Alex.

</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005308.html">[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
</A></li>
	<LI>Next message: <A HREF="005310.html">[squid-dev] [PATCH] assertion failed: Write.cc:41: &quot;!ccb-&gt;active()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5306">[ date ]</a>
              <a href="thread.html#5306">[ thread ]</a>
              <a href="subject.html#5306">[ subject ]</a>
              <a href="author.html#5306">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
