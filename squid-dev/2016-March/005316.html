<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Add reply_header_add
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Add%20reply_header_add&In-Reply-To=%3C56E7615E.70902%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005315.html">
   <LINK REL="Next"  HREF="005324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Add reply_header_add</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Add%20reply_header_add&In-Reply-To=%3C56E7615E.70902%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Add reply_header_add">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar 15 01:11:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005315.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
        <LI>Next message: <A HREF="005324.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5316">[ date ]</a>
              <a href="thread.html#5316">[ thread ]</a>
              <a href="subject.html#5316">[ subject ]</a>
              <a href="author.html#5316">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/14/2016 05:46 PM, Nathan Hoad wrote:

&gt;<i> The attached patch implements reply_header_add, for adding HTTP
</I>&gt;<i> headers to reply objects as they're sent to the client.
</I>
Thank you for this useful addition. Unfortunately, it needs quite a bit
of work.


* Please _carefully_ review your src/cf.data.pre changes. There appear
to be many copy-paste errors there, some of which seriously misleading
(e.g., &quot;incoming&quot; vs. &quot;outgoing&quot; and &quot;request&quot; vs. &quot;response&quot;).

* You have not adjusted HTTP response headers produced by
Http::One::Server::writeControlMsgAndCall(). Please either apply the
same logic to those headers or explicitly document that control message
headers are out of this option reach.

* You have not adjusted HTTP response headers produced by
tunnelConnected() and ClientHttpRequest::sslBumpStart(). Please either
apply the same logic to those headers or explicitly document that
successful CONNECT responses are out of this option reach.


I also recommend the following adjustments:

* The scary &quot;In theory, all of ...&quot; paragraph that made a lot of sense
for requests is barely applicable to post-cache responses, where most
information is already available. Please consider making that text
context-neutral and moving it to an option-independent location in the
begging of squid.conf. That would be really useful IMO because we have
many options using logformat codes now and that old text is applicable,
to various degrees, to all of them.

* Adding a sentence or two explicitly stating that this directive does
not affect cached responses. Your copied text says that it &quot;has no
affect on cache hit detection&quot;, and that is also true, if somewhat
redundant for responses.

* Adding a &quot;See also: request_header_add&quot; statement and the symmetrical
statement for request_header_add.



&gt;<i> +    if (Config.reply_header_add &amp;&amp; !Config.reply_header_add-&gt;empty())
</I>&gt;<i> +        httpHdrAdd(hdr, request, http-&gt;al, *Config.reply_header_add);
</I>

I know you are reusing an existing code template here, but this
particular copy starts duplicating a lot of logic. I recommend moving
both guards/conditions from the if-statement into httpHdrAdd() itself.
If others object to moving both conditions on performance grounds,
please move at least the second/empty() condition:

That is, ideally:

  httpHdrAdd(hdr, request, http-&gt;al, Config.reply_header_add);

Or, if others object:

  if (Config.reply_header_add)
      httpHdrAdd(hdr, request, http-&gt;al, *Config.reply_header_add);



Thank you,

Alex.

</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005315.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
	<LI>Next message: <A HREF="005324.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5316">[ date ]</a>
              <a href="thread.html#5316">[ thread ]</a>
              <a href="subject.html#5316">[ subject ]</a>
              <a href="author.html#5316">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
