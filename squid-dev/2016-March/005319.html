<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Better support for unknown URL schemes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Better%20support%20for%20unknown%20URL%20schemes&In-Reply-To=%3C56E83DBC.8020506%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005318.html">
   <LINK REL="Next"  HREF="005338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Better support for unknown URL schemes</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Better%20support%20for%20unknown%20URL%20schemes&In-Reply-To=%3C56E83DBC.8020506%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Better support for unknown URL schemes">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar 15 16:52:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005318.html">[squid-dev] [PATCH] Better support for unknown URL schemes
</A></li>
        <LI>Next message: <A HREF="005338.html">[squid-dev] Build failed in Jenkins: trunk-matrix » clang,d-ubuntu-trusty #590
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5319">[ date ]</a>
              <a href="thread.html#5319">[ thread ]</a>
              <a href="subject.html#5319">[ subject ]</a>
              <a href="author.html#5319">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/15/2016 09:36 AM, Amos Jeffries wrote:
&gt;<i> Squid already contains AnyP::PROTO_UNKNOWN support for unknown protocols
</I>&gt;<i> but currently does not preserve the actual string value received for them.
</I>&gt;<i> 
</I>&gt;<i> This adds a textual representation ('image') to the UriScheme object to
</I>&gt;<i> fill that gap and ensure that all URL representatinos (ie cache keys,
</I>&gt;<i> logs and outgoing messages) are generated with the scheme string as it
</I>&gt;<i> was received.
</I>
Preserving textual representation is the right thing to do, but the
implementation itself needs a lot more work IMO.


&gt;<i>      /// convert the URL scheme to that given
</I>&gt;<i>      void setScheme(const AnyP::ProtocolType &amp;p) {scheme_=p; touch();}
</I>&gt;<i> +    void setSchemeImage(const char *str) {scheme_.setImage(str); touch();}
</I>

The parameter type should be changed instead. Yes, that will require
more changes, but those changes are essential to properly support
foreign protocol names. Without those changes, you are creating an API
bug in addition to adding a useful feature.

We (mostly you) have already done similar work for foreign HTTP request
methods. This is similar -- UriScheme should be used nearly everywhere
(instead of ProtocolType that does not carry enough information). It
could be argued that the UriScheme class itself should be renamed to
something like Protocol, but I do not want to argue about that.


&gt;<i> +    /// Sets the string representation of this scheme.
</I>&gt;<i> +    /// Only needed if the scheme type is PROTO_UNKNOWN.
</I>&gt;<i> +    void setImage(const char *str) {assert(theScheme_ == AnyP::PROTO_UNKNOWN); schemeImage_ = str;}
</I>
This method should be a constructor.


&gt;<i>  char const *
</I>&gt;<i>  AnyP::UriScheme::c_str() const
</I>&gt;<i>  {
</I>
This method should be replaced with AnyP::UriScheme::image() returning SBuf.


&gt;<i> +    if (!schemeImage_.isEmpty())
</I>&gt;<i> +        return schemeImage_.c_str();
</I>&gt;<i> +
</I>
Why are we not lowering the case of a foreign protocol image if we are
lowering the case of standard protocol images below? Either both should
be lowered or there should be a source code comment explaining the
discrepancy.

If both should be lowered, the lowering should be done in the
constructor to avoid lowering the same string multiple times.


&gt;<i>      if (theScheme_ &gt; AnyP::PROTO_NONE &amp;&amp; theScheme_ &lt; AnyP::PROTO_MAX) {
</I>&gt;<i> -        const char *in = AnyP::ProtocolType_str[theScheme_];
</I>&gt;<i> -        for (; p &lt; (BUFSIZ-1) &amp;&amp; in[p] != '\0'; ++p)
</I>&gt;<i> -            out[p] = xtolower(in[p]);
</I>&gt;<i> +        schemeImage_ = AnyP::ProtocolType_str[theScheme_];
</I>&gt;<i> +        schemeImage_.toLower();
</I>&gt;<i>      }
</I>
This slow code may not be needed at all if the rest of the changes are
implemented. If this code stays, please add an &quot;XXX: Slow.&quot; or a similar
comment after toLower(). There are many ways to fix/optimize this, but
the best way probably depends on the rest of the changes so I am not
going to suggest any specific TODO here.


&gt;<i> @@ -157,6 +158,9 @@
</I>&gt;<i>      if (strncasecmp(b, &quot;whois&quot;, len) == 0)
</I>&gt;<i>          return AnyP::PROTO_WHOIS;
</I>&gt;<i>  
</I>&gt;<i> +    if (len &gt; 0)
</I>&gt;<i> +        return AnyP::PROTO_UNKNOWN;
</I>&gt;<i> +
</I>&gt;<i>      return AnyP::PROTO_NONE;
</I>&gt;<i>  }
</I>
This function should return a UriScheme object instead. Ideally, using
created-once constants for common protocols (so that we do not have to
deal with to-lower-case conversion every time a scheme image is needed).


&gt;<i> @@ -27,7 +28,7 @@
</I>&gt;<i>      ~UriScheme() {}
</I>...
&gt;<i> +    /// the string representation to use for theScheme_
</I>&gt;<i> +    mutable SBuf schemeImage_;
</I>
Please do not name Foo members FooX. One Foo is enough!


&gt;<i> +    /// the string representation to use for theScheme_
</I>
s/to use for theScheme_//
or
s/to use for theScheme_/of the scheme//

If you can make such a guarantee after all other changes, please add
something like &quot;; always in lower case&quot;.


&gt;<i> +    mutable SBuf schemeImage_;
</I>
Mutable may not be needed after all other changes.


It is difficult for me to review 4-line no-function-names diff, so
forgive me if I missed any context-dependent caveats.


Thank you,

Alex.

</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005318.html">[squid-dev] [PATCH] Better support for unknown URL schemes
</A></li>
	<LI>Next message: <A HREF="005338.html">[squid-dev] Build failed in Jenkins: trunk-matrix » clang,d-ubuntu-trusty #590
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5319">[ date ]</a>
              <a href="thread.html#5319">[ thread ]</a>
              <a href="subject.html#5319">[ subject ]</a>
              <a href="author.html#5319">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
