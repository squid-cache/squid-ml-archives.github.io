<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Add reply_header_add
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Add%20reply_header_add&In-Reply-To=%3C56E8CFCC.9030407%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005324.html">
   <LINK REL="Next"  HREF="005331.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Add reply_header_add</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Add%20reply_header_add&In-Reply-To=%3C56E8CFCC.9030407%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Add reply_header_add">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 16 03:15:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005324.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
        <LI>Next message: <A HREF="005331.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5327">[ date ]</a>
              <a href="thread.html#5327">[ thread ]</a>
              <a href="subject.html#5327">[ subject ]</a>
              <a href="author.html#5327">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/15/2016 07:29 PM, Nathan Hoad wrote:
&gt;<i> On 15 March 2016 at 12:11, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 03/14/2016 05:46 PM, Nathan Hoad wrote:
</I>
&gt;&gt;<i> * You have not adjusted HTTP response headers produced by
</I>&gt;&gt;<i> Http::One::Server::writeControlMsgAndCall(). Please either apply the
</I>&gt;&gt;<i> same logic to those headers or explicitly document that control message
</I>&gt;&gt;<i> headers are out of this option reach.
</I>
&gt;<i> Done.
</I>

Thank you. After those improvements, you can probably see a new pattern
emerging:

&gt;<i> if (Config2.onoff.mangle_request_headers)
</I>&gt;<i>     httpHdrMangleList(hdr_out, request, ROR_REQUEST);
</I>&gt;<i> 
</I>&gt;<i> httpHdrAdd(hdr_out, request, al, Config.request_header_add);
</I>
and


&gt;<i> httpHdrMangleList(&amp;rep-&gt;header, http-&gt;request, ROR_REPLY);
</I>&gt;<i> httpHdrAdd(&amp;rep-&gt;header, http-&gt;request, http-&gt;al, Config.reply_header_add);
</I>
and

&gt;<i> httpHdrMangleList(hdr, request, ROR_REPLY);
</I>&gt;<i> 
</I>&gt;<i> httpHdrAdd(hdr, request, http-&gt;al, Config.reply_header_add);
</I>
and

&gt;<i> $ bzr grep '    httpHdrMangleList' | wc -l
</I>&gt;<i> 3
</I>
and, I would imagine,

&gt;<i> bzr grep '    httpHdrAdd' | wc -l
</I>&gt;<i> 3
</I>

Yes, there are only three cases, and in all of them, we apply the same
set of two operations. Thus, you can now move the httpHdrAdd() call into
httpHdrMangleList()!

If you do that, move the code that gets the right Config.*_header_access
mangler from the beginning of httpHdrMangle() to httpHdrMangleList()
itself and adjust it to also check Config2.onoff.mangle_request_headers
during ROR_REQUEST.

Adjust as needed: httpHdrMangle() is a private/static function and you
will be working with all three httpHdrMangleList() calls in existence
(AFAICT).


I cannot require these additional changes from you, but if you need an
extra incentive/motivation, then just look at the loop in
httpHdrMangleList() and what happens at the start of httpHdrMangle()
that the loop calls on every iteration. Consider the common case of no
Config.*_header_access manglers configured. See how httpHdrMangleList()
always iterates through all header fields while repeating the same
checks and doing nothing useful at all?

With the above changes (that move those checks to be done once, in front
of the loop, and that will entirely eliminate looping in the common
case), you would be making Squid a tiny bit faster despite adding a new
feature!


Thank you,

Alex.

</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005324.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
	<LI>Next message: <A HREF="005331.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5327">[ date ]</a>
              <a href="thread.html#5327">[ thread ]</a>
              <a href="subject.html#5327">[ subject ]</a>
              <a href="author.html#5327">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
