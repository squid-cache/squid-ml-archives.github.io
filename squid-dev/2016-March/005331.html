<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Add reply_header_add
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Add%20reply_header_add&In-Reply-To=%3CCAGUJm7Zckoy%2BX51H78774TCAWOMfC6SYVNeAMzvKjj6yLHHgdQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005327.html">
   <LINK REL="Next"  HREF="005332.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Add reply_header_add</H1>
    <B>Nathan Hoad</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Add%20reply_header_add&In-Reply-To=%3CCAGUJm7Zckoy%2BX51H78774TCAWOMfC6SYVNeAMzvKjj6yLHHgdQ%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] Add reply_header_add">nathan at getoffmalawn.com
       </A><BR>
    <I>Wed Mar 16 23:40:07 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005327.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
        <LI>Next message: <A HREF="005332.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5331">[ date ]</a>
              <a href="thread.html#5331">[ thread ]</a>
              <a href="subject.html#5331">[ subject ]</a>
              <a href="author.html#5331">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Attached is an updated patch with Alex's suggested changes, i.e.
moving the use of httpHdrAdd into httpHdrMangleList, and moving some
code out of httpHdrMangle into httpHdrMangleList.

I've opted to remove Config2.onoff.mangle_request_headers completely.
I found keeping it around and making use of it in httpHdrMangleList
made the flow of execution confusing, with regards to ensuring
httpHdrAdd was still called.

Thank you for taking the time to look at this.

Nathan.

On 16 March 2016 at 14:15, Alex Rousskov
&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 03/15/2016 07:29 PM, Nathan Hoad wrote:
</I>&gt;&gt;<i> On 15 March 2016 at 12:11, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 03/14/2016 05:46 PM, Nathan Hoad wrote:
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> * You have not adjusted HTTP response headers produced by
</I>&gt;&gt;&gt;<i> Http::One::Server::writeControlMsgAndCall(). Please either apply the
</I>&gt;&gt;&gt;<i> same logic to those headers or explicitly document that control message
</I>&gt;&gt;&gt;<i> headers are out of this option reach.
</I>&gt;<i>
</I>&gt;&gt;<i> Done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you. After those improvements, you can probably see a new pattern
</I>&gt;<i> emerging:
</I>&gt;<i>
</I>&gt;&gt;<i> if (Config2.onoff.mangle_request_headers)
</I>&gt;&gt;<i>     httpHdrMangleList(hdr_out, request, ROR_REQUEST);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> httpHdrAdd(hdr_out, request, al, Config.request_header_add);
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> httpHdrMangleList(&amp;rep-&gt;header, http-&gt;request, ROR_REPLY);
</I>&gt;&gt;<i> httpHdrAdd(&amp;rep-&gt;header, http-&gt;request, http-&gt;al, Config.reply_header_add);
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;&gt;<i> httpHdrMangleList(hdr, request, ROR_REPLY);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> httpHdrAdd(hdr, request, http-&gt;al, Config.reply_header_add);
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;&gt;<i> $ bzr grep '    httpHdrMangleList' | wc -l
</I>&gt;&gt;<i> 3
</I>&gt;<i>
</I>&gt;<i> and, I would imagine,
</I>&gt;<i>
</I>&gt;&gt;<i> bzr grep '    httpHdrAdd' | wc -l
</I>&gt;&gt;<i> 3
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes, there are only three cases, and in all of them, we apply the same
</I>&gt;<i> set of two operations. Thus, you can now move the httpHdrAdd() call into
</I>&gt;<i> httpHdrMangleList()!
</I>&gt;<i>
</I>&gt;<i> If you do that, move the code that gets the right Config.*_header_access
</I>&gt;<i> mangler from the beginning of httpHdrMangle() to httpHdrMangleList()
</I>&gt;<i> itself and adjust it to also check Config2.onoff.mangle_request_headers
</I>&gt;<i> during ROR_REQUEST.
</I>&gt;<i>
</I>&gt;<i> Adjust as needed: httpHdrMangle() is a private/static function and you
</I>&gt;<i> will be working with all three httpHdrMangleList() calls in existence
</I>&gt;<i> (AFAICT).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I cannot require these additional changes from you, but if you need an
</I>&gt;<i> extra incentive/motivation, then just look at the loop in
</I>&gt;<i> httpHdrMangleList() and what happens at the start of httpHdrMangle()
</I>&gt;<i> that the loop calls on every iteration. Consider the common case of no
</I>&gt;<i> Config.*_header_access manglers configured. See how httpHdrMangleList()
</I>&gt;<i> always iterates through all header fields while repeating the same
</I>&gt;<i> checks and doing nothing useful at all?
</I>&gt;<i>
</I>&gt;<i> With the above changes (that move those checks to be done once, in front
</I>&gt;<i> of the loop, and that will entirely eliminate looping in the common
</I>&gt;<i> case), you would be making Squid a tiny bit faster despite adding a new
</I>&gt;<i> feature!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: reply-header-add-v3.patch
Type: text/x-patch
Size: 10521 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160317/0e544e27/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160317/0e544e27/attachment.bin</A>&gt;
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005327.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
	<LI>Next message: <A HREF="005332.html">[squid-dev] [PATCH] Add reply_header_add
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5331">[ date ]</a>
              <a href="thread.html#5331">[ thread ]</a>
              <a href="subject.html#5331">[ subject ]</a>
              <a href="author.html#5331">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
