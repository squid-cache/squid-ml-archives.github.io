<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Do not hide important/critical messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20hide%20important/critical%20messages&In-Reply-To=%3C56F9C1EA.2070906%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005509.html">
   <LINK REL="Next"  HREF="005513.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Do not hide important/critical messages</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20hide%20important/critical%20messages&In-Reply-To=%3C56F9C1EA.2070906%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Do not hide important/critical messages">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Mar 28 23:44:42 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005509.html">[squid-dev] [PATCH][pinger] fix select(2) to actually use max_fd
</A></li>
        <LI>Next message: <A HREF="005513.html">[squid-dev] [PATCH] BUg 4466: removal of -k kill command
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5510">[ date ]</a>
              <a href="thread.html#5510">[ thread ]</a>
              <a href="subject.html#5510">[ subject ]</a>
              <a href="author.html#5510">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    While working on Squid bug 4465 (Header forgery detection leads to
crash), I noticed that Squid may hide important/critical debugs()
messages from the admin if those messages are assembled using code that
also uses debugs(). For example, unpatched Squid console only says:

  2016/03/27 14:19:48.297| SECURITY ALERT: By user agent:
  2016/03/27 14:19:48.297| SECURITY ALERT: on URL: dut70.test:443

A patched Squid produces the expected three console lines:

  2016/03/27 15:25:42| SECURITY ALERT: Host header forgery detected...
  2016/03/27 15:25:42| SECURITY ALERT: By user agent:
  2016/03/27 15:25:42| SECURITY ALERT: on URL: dut70.test:443


The underlying debugs() bug leads to several rather confusing problems.
For example, the unpatched output quoted above has millisecond
timestamps that are not supposed to be there; the hidden lines may
actually be logged into cache.log (but not on the console/stderr or
system log). It took several patch rewrites and many tests to better
understand these side effects (which explains, in part, why the patch
has more cleanup pieces than are strictly necessary to fix the bug in
the subject line).

The attached v3.5 patch fixes the underlying bug and has several
positive side-effects such as faster debugs() performance, no clobbered
messages, and cleaner code. Please see patch preamble for a complete
list of known side effects.

If this v3.5 patch is accepted in principle, I hope somebody volunteers
a trunk port (which should not be difficult).


Thank you,

Alex.
P.S. This patch is not intended to fix Squid bug 4465.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: reentrant-debug-hides-t6.patch
Type: text/x-diff
Size: 36807 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160328/9da106cc/attachment-0001.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160328/9da106cc/attachment-0001.patch</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005509.html">[squid-dev] [PATCH][pinger] fix select(2) to actually use max_fd
</A></li>
	<LI>Next message: <A HREF="005513.html">[squid-dev] [PATCH] BUg 4466: removal of -k kill command
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5510">[ date ]</a>
              <a href="thread.html#5510">[ thread ]</a>
              <a href="subject.html#5510">[ subject ]</a>
              <a href="author.html#5510">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
