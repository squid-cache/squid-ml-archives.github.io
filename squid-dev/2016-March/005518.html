<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Increase request buffer size to 64kb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Increase%20request%20buffer%20size%20to%2064kb&In-Reply-To=%3CCAGUJm7ZQawkzCGnC3oWGYyn2qUPvYz%3DEE%3D8UDGwVt0TcYCgN5g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005515.html">
   <LINK REL="Next"  HREF="005520.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Increase request buffer size to 64kb</H1>
    <B>Nathan Hoad</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Increase%20request%20buffer%20size%20to%2064kb&In-Reply-To=%3CCAGUJm7ZQawkzCGnC3oWGYyn2qUPvYz%3DEE%3D8UDGwVt0TcYCgN5g%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] Increase request buffer size to 64kb">nathan at getoffmalawn.com
       </A><BR>
    <I>Wed Mar 30 00:06:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005515.html">[squid-dev] [PATCH][pinger][linux] drop capabilities
</A></li>
        <LI>Next message: <A HREF="005520.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5518">[ date ]</a>
              <a href="thread.html#5518">[ thread ]</a>
              <a href="subject.html#5518">[ subject ]</a>
              <a href="author.html#5518">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

This (very small) patch increases the request buffer size to 64kb, from 4kb.

In my testing, this increases throughput rather dramatically for
downloading large files:

Pre patch:
100 5120M  100 5120M    0     0   126M      0  0:00:40  0:00:40 --:--:--  109M

CPU Usage: 40.500 seconds = 26.537 user + 13.963 sys

Post patch:

100 5120M  100 5120M    0     0   340M      0  0:00:15  0:00:15 --:--:--  329M

CPU Usage: 18.203 seconds = 12.477 user + 5.727 sys

The relevant numbers being that pre-patch it took 40 seconds/126MB a
second, and post patch it took 15 seconds/340MB a second. The above
tests were done against squid 4.0.7, serving a 5gb file built with
fallocate. The server was nothing fancy - Python's builtin HTTP
server.

Full disclosure, these numbers are over the loopback device - the
client, proxy and server are all on my laptop. If I move the proxy off
of my laptop, the numbers aren't as high, but the speed differences
are comparable.

We've been running this in production since late 2011 across many,
many deployments, and haven't had any issues with it. Part of me
wonders if this should be made configurable via the configure script?
Happy to work on that instead if people see value in it.

It's possible the same treatment should be applied to some of the
other buffer sizes in src/defines.h, but we have not modified these at
all.

Thank you,

Nathan.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: recv-buffer.patch
Type: text/x-patch
Size: 420 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160330/c59ab40b/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160330/c59ab40b/attachment.bin</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005515.html">[squid-dev] [PATCH][pinger][linux] drop capabilities
</A></li>
	<LI>Next message: <A HREF="005520.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5518">[ date ]</a>
              <a href="thread.html#5518">[ thread ]</a>
              <a href="subject.html#5518">[ subject ]</a>
              <a href="author.html#5518">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
