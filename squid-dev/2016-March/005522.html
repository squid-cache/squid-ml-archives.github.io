<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Increase request buffer size to 64kb
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Increase%20request%20buffer%20size%20to%2064kb&In-Reply-To=%3C56FB69CD.8010604%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005521.html">
   <LINK REL="Next"  HREF="005523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Increase request buffer size to 64kb</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Increase%20request%20buffer%20size%20to%2064kb&In-Reply-To=%3C56FB69CD.8010604%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Increase request buffer size to 64kb">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 30 05:53:17 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005521.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
        <LI>Next message: <A HREF="005523.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5522">[ date ]</a>
              <a href="thread.html#5522">[ thread ]</a>
              <a href="subject.html#5522">[ subject ]</a>
              <a href="author.html#5522">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/29/2016 10:39 PM, Nathan Hoad wrote:
&gt;<i> On 30 March 2016 at 12:11, Alex Rousskov
</I>&gt;<i> &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 03/29/2016 06:06 PM, Nathan Hoad wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This (very small) patch increases the request buffer size to 64kb, from 4kb.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -#define HTTP_REQBUF_SZ  4096
</I>&gt;&gt;&gt;<i> +#define HTTP_REQBUF_SZ  65535
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In my testing, this increases throughput rather dramatically for
</I>&gt;&gt;&gt;<i> downloading large files:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Based on your results alone, it is clear that the patch does more than
</I>&gt;&gt;<i> &quot;increases the request buffer size&quot;(*). IMO, the important initial
</I>&gt;&gt;<i> questions we need to answer are:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   1. Why the performance is improved in this micro test?
</I>&gt;&gt;<i>   2. What are the expected effects on other traffic?
</I>
&gt;<i> I think these are reasonable questions to ask. Answering question one
</I>&gt;<i> will take time
</I>
Yes, finding the correct answer may not be trivial, although I would
expect that larger system reads result in fewer reads and, hence, less
Squid-imposed overhead in a micro test. That hypothesis should be
relatively easy to semi-confirm by looking at the number of system reads
before/after the change (if that statistics is already reported).
Hacking Squid to collect those stats should not be difficult either (if
that statistics is not already reported).


Another related angle you may want to consider is comparing 8KB, 16KB,
and 32KB performance with the already available 4KB and 64KB numbers:

*  If performance keeps going up with a larger buffer (in a micro test),
how about 512KB? You will need a large enough file and a fast
client/server to make sure Squid is the bottleneck, of course.

* If there is a &quot;sweet spot&quot; that is determined by system page size or
perhaps NIC buffer size, then one can argue that this parameter should
be configurable to match that size (and perhaps even set based on system
parameters by default if possible).

Also, as you look at the code you may be able to tell others whether
Squid always uses a fixed buffer or grows the buffer as needed. If Squid
does not grow the buffer, perhaps it would be easy to hack it to grow
the buffer during a micro test. That &quot;adaptive algorithm&quot; may allow us
to avoid changing the default while accommodating &quot;fast download&quot;
environments.


&gt;<i> I'm not sure how I can answer question two definitively
</I>
I recommend starting with &quot;bzr grep HTTP_REQBUF_SZ&quot; or equivalent. If
you are lucky, the number of actual uses will be small and you will be
able to speculate about their impact and/or isolate it to avoid that
speculation (and to allow separate configuration in the future).


&gt;<i> - are there
</I>&gt;<i> any accepted benchmarking/test suites I can use to test the change on
</I>&gt;<i> different types of traffic, to see if particular situations have been
</I>&gt;<i> negatively affected?
</I>
There are benchmarks (e.g., Apache ab and Factory Web Polygraph) and
even &quot;standard&quot; workloads, but if you are asking about their existence,
it implies that it will take you a while to get _meaningful_ results
using those tools. I would start with manual code analysis instead (as
mentioned above) and then decide whether additional testing is warranted
(and what kind of testing would be best).


&gt;<i> Yes I think you are right in that the constant may be
</I>&gt;<i> misnamed/misused. Once I've gone through all the places that use it, I
</I>&gt;<i> suppose reevaluating its name would be a good idea.
</I>
... and we would have to rename it anyway if we decide to make it
configurable. Knowing where it is used (and/or isolating its usage)
would be important for that as well.


Thank you,

Alex.

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005521.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
	<LI>Next message: <A HREF="005523.html">[squid-dev] [PATCH] Increase request buffer size to 64kb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5522">[ date ]</a>
              <a href="thread.html#5522">[ thread ]</a>
              <a href="subject.html#5522">[ subject ]</a>
              <a href="author.html#5522">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
