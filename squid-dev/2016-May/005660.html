<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fix maybeMakeSpaceAvailable() logic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20maybeMakeSpaceAvailable%28%29%20logic&In-Reply-To=%3C57364064.5080803%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005684.html">
   <LINK REL="Next"  HREF="005662.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fix maybeMakeSpaceAvailable() logic</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20maybeMakeSpaceAvailable%28%29%20logic&In-Reply-To=%3C57364064.5080803%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Fix maybeMakeSpaceAvailable() logic">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri May 13 21:00:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005684.html">[squid-dev] [PATCH] Fast SNI peek
</A></li>
        <LI>Next message: <A HREF="005662.html">[squid-dev] [PATCH] Fix maybeMakeSpaceAvailable() logic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5660">[ date ]</a>
              <a href="thread.html#5660">[ thread ]</a>
              <a href="subject.html#5660">[ subject ]</a>
              <a href="author.html#5660">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    This change fixes logic bugs that mostly affect performance: In
micro-tests, this change gives 10% performance improvement for
intercepted &quot;fast peek at SNI and splice&quot; SslBump configurations.
Similar improvement is expected for future plain HTTP/2 parsers.

      trunk  fsni fsni+
  SS1  100%  100%  100%
  SS2   22%   69%   77%
  SS3   16%   26%   26%

The table format was described in my follow up to Christos' &quot;Fast SNI
peek&quot; email a few minutes ago. The testing methodology was the same so
the same caveats apply. The last column contains results from the Fast
SNI branch code patched with the attached patch.


Server::maybeMakeSpaceAvailable() is called with an essentially random
inBuf. The method must prepare inBuf for the next network read. The old
code was not doing that [well enough], leading to performance problems.

In some environments, inBuf often ends up having a tiny space exceeding
2 bytes (e.g., 6 bytes). This happens, for example, when Squid creates
and parses a fake CONNECT request. The old code often left such tiny
inBufs &quot;as is&quot; because we tried to ensure that we have at least 2 bytes
to read instead of trying to provide a reasonable number of buffer space
for the next network read. Tiny buffers naturally result in tiny network
reads, which are very inefficient, especially for non-incremental parsers.

I have removed the explicit &quot;2 byte&quot; space checks: Both the new and the
old code do not _guarantee_ that at least 2 bytes of buffer space are
always available, and the caller does not check that condition either.
If some other code relies on it, more fixes will be needed (but this
change is not breaking that guarantee -- either it was broken earlier or
was never fully enforced). In practice, only buffers approaching
Config.maxRequestBufferSize limit may violate this guarantee AFAICT, and
those buffers ought to be rare, so the bug, if any, remains unnoticed.

Another subtle maybeMakeSpaceAvailable() problem was that the code
contained its own buffer capacity increase algorithm (n^2 growth).
However, increasing buffer capacity exponentially does not make much
sense because network read sizes are not going to increase
exponentially. Also, memAllocStringmemAllocate() overwrites n^2 growth
with its own logic. Besides, it is buffer _space_, not the total
capacity that should be increased. More work is needed to better match
Squid buffer size for from-user network reads with the TCP stack buffers
and traffic patterns.

Both the old and the new code reallocate inBuf MemBlobs. However, the
new code leaves &quot;reallocate or memmove&quot; decision to the new
SBuf::reserve(), opening the possibility for future memmove
optimizations that SBuf/MemBlob do not currently support.

It is probably wrong that inBuf points to an essentially random MemBlob
outside Server control but this change does not attempt to fix that.

The patch was written and tested ~2 weeks ago so it may need some
polishing to apply to the current trunk.


Cheers,

Alex.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: make-space-available-t5.patch
Type: text/x-diff
Size: 18622 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160513/c36aefdd/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160513/c36aefdd/attachment.patch</A>&gt;
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005684.html">[squid-dev] [PATCH] Fast SNI peek
</A></li>
	<LI>Next message: <A HREF="005662.html">[squid-dev] [PATCH] Fix maybeMakeSpaceAvailable() logic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5660">[ date ]</a>
              <a href="thread.html#5660">[ thread ]</a>
              <a href="subject.html#5660">[ subject ]</a>
              <a href="author.html#5660">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
