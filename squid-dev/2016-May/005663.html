<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fast SNI peek
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fast%20SNI%20peek&In-Reply-To=%3Cab679eb0-7a28-5802-ce9b-9b4b546bde10%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005681.html">
   <LINK REL="Next"  HREF="005665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fast SNI peek</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fast%20SNI%20peek&In-Reply-To=%3Cab679eb0-7a28-5802-ce9b-9b4b546bde10%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Fast SNI peek">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun May 15 13:49:05 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005681.html">[squid-dev] [PATCH] Fast SNI peek
</A></li>
        <LI>Next message: <A HREF="005665.html">[squid-dev] [PATCH] Fast SNI peek
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5663">[ date ]</a>
              <a href="thread.html#5663">[ thread ]</a>
              <a href="subject.html#5663">[ subject ]</a>
              <a href="author.html#5663">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/05/2016 5:07 a.m., Christos Tsantilas wrote:
&gt;<i> Currently, bumping peek mode at step2 and splice at step2, after the SNI
</I>&gt;<i> is  received is very slow.
</I>&gt;<i> 
</I>&gt;<i> The most of the performance overhead comes from openSSL. However Squid
</I>&gt;<i> does not need openSSL to peek at SNI. It needs only to get client TLS
</I>&gt;<i> Hello message, analyse it to retrieve SNI and then splice at step2.
</I>&gt;<i> 
</I>&gt;<i> This patch:
</I>&gt;<i>  - Postpone creation of the OpenSSL connection (i.e. SSL) object for the
</I>&gt;<i> accepted TCP connection until after we peek at SNI (after step2).
</I>&gt;<i> 
</I>&gt;<i>  - Implements the Parser::BinaryTokenizer parser for extracting
</I>&gt;<i> byte-oriented fields from raw input
</I>&gt;<i> 
</I>&gt;<i>  - Reimplement a new SSL/TLS handshake messages parser using the
</I>&gt;<i> BinaryTokenizer, and remove old buggy parsing code from ssl/bio.cc
</I>&gt;<i> 
</I>&gt;<i>  - Adjust ConnStateData, Ssl::Bio, Ssl::PeerConnector classes to use the
</I>&gt;<i> new parsers and parsing results.
</I>&gt;<i> 
</I>
Thank you.

Below is all polish and documentation fixes :-)

+1. If nobody has anything else I think this can go in when you have
attended to these bits of polishing.
 (I will hold off on my PeerConnector related changes until this is in).



in src/anyp/ProtocolType.h:

* these protocol names should be orered from most to least common.
 - expect TLS to be more common than SSL in future now that all SSL
versions are formally prohibited.


in src/client_side.h:

* the cpmment block starting with:
  &quot;// The following block does not needed,&quot;

 can all be replaced with one line:
  // Setting bio-&gt;rBufData() is not needed. inBuf and rbuf have the same
content.

  - I am a little doubtful about the accuracy of that. Both places are
using SBuf to hold the buffer. If they are not kept in sync they might
end up pointing at different MemBlob offsets or different MemBlob
entirely. Did I might have missed the sync'ing ?


in src/client_side.cc:

* files in src/security/ should not need wrapping in USE_OPENSSL
 - referring to the #includes pulling in security/Handshake.h
 - maybe others

* tlsParser has no doxygen comment


in src/parser/BinaryTokenizer.cc:

* #include &quot;parser/BinaryTokenizer.h&quot; instead.

* delegating constructors is a C++11 feature that will definitely fail
on GCC 4.8.
 - I have put the question to Alex in how recent patch about dropping
that support. If we go ahead with that, the BinaryTokenizer construction
is fine. Otherwise it will have to be expanded to non-delegating.

* please make BinaryTokenizer_tail a function not a macro.
 - doing that will also fix the missing (void*) before use of 'this'

* please add to the BinaryTokenizer intN() methods that they assume
network-endian input.


in src/parser/BinaryTokenizer.h:

* please make the wrapper macro match the file name + path.
 - only inject '_' to replace '/' and '.'
  so: SQUID_SRC_PARSER_BINARYTOKENIZER_H
 - similar in src/security/Handshake.h

* are users of BinaryTokenizerContext allowed to change the name parameter?
 - if not it should be a &quot;const char * const&quot;
 - same for the parent

* please move the BinaryTokenizerContext inline method definitions
inside the class {} block.
 - then you wont need to even use &quot;inline&quot;.


in src/security/Handshake.cc:

* Security::HandshakeParser::skipMessage
 - the comment seems to be mentioning some serious breakage of the
debugging output. That should probably get an XXX marker.


in src/security/Handshake.h:

* don't need base/RefCount.h or sbuf/SBuf.h here.
 - they get pulled by the other dependencies

* class HandshakeParser documentation &quot;TLS/SSL&quot; instead of just &quot;SSL&quot;.

* put '{' on the line after &quot;class ...&quot;

* s/ressumingSession/resumingSession/
 - as a member this also affects ssl/bio.cc, maybe elsewhere

* tkRecords, tkMessages, and expectingModernRecords missing doxygen comments

 NP: just a note on class method definitions. Try to avoid naming the
parameters if you can. It seems to hep with the recent doxygen versions,
and the STUBS creation. We might have to if the type is basic like an
int or bool. But for types where the type-name describes the parameter
object you can omit.
 For example:  &quot;foo(const tlsDetails &amp;details)&quot; the variable name is
redundant.


in src/security/NegotiationHistory.cc:

* s/NULL/nullptr/ when touching lines
 - the constructor list at least
 - bio.cc has some more in adjustSSL(), maybe elsewhere

* in toProtocolVersion() are the case values all guaranteed to exist?
 - specifically the older ones like SSL2_VERSION.
 - if not, now might be a good time to wrap the cases in #if defined()
   which might also solve issues with TLSv1.1/1.2 version in library ports


in src/ssl/PeekingPeerConnector.cc:

* the debugs dropped from Ssl::PeekingPeerConnector::noteWantWrite() was
about the srvBio-&gt;holdWrite() in the line above which still remains
wasn't it?


in src/ssl/PeerConnector.cc:

* &quot;Log connection details, if any&quot;
 - in the function above Ssl::PeerConnector::noteWantRead()

* change in Ssl::PeerConnector::noteWantRead() is not necessary.
 - we leave local variable definitions until the point they are needed.
 - which for that 'fd' is still where it was before.


in src/ssl/bio.cc:

* you dont need to put /* Ssl:Bio */ or /* ServerBio */ markers between
definitions at the file global level.
 - if its not obvious from the function/method definition what they are
something has gone wrong in the design.

* in applyTlsDetailsToSSL() replace:
&quot;
 The SSL_set_ssl_method is not the correct method because it will strict
 SSL version which can be used to the SSL version used for client hello
message.
&quot;
   with:
&quot;
The SSL_set_ssl_method is wrong here because it will restrict the
permitted transport version to be identical to the version used in the
ClientHello message.
&quot;


in src/ssl/bio.h:

* security/Handshake.h makes #include sbuf/SBuf.h no longer needed.

* Bio::rBufData() missing doxygen comment

* ClientBio::setReadBufData() missing doxygen comment

* ClientBio::wrongProtocol is removed
 - erase it from the constructor list too.

* ServerBio::receivedHelloDetails() use \return instead of &quot;Return&quot;

* ServerBio::rbufConsumePos() wrong &quot;///&lt;&quot;
 - doxygen comments placed before the symbol definition use &quot;///&quot;
without the '&lt;'

* &quot;SSL messages&quot; -&gt; &quot;TLS/SSL messages&quot;



Amos

</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005681.html">[squid-dev] [PATCH] Fast SNI peek
</A></li>
	<LI>Next message: <A HREF="005665.html">[squid-dev] [PATCH] Fast SNI peek
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5663">[ date ]</a>
              <a href="thread.html#5663">[ thread ]</a>
              <a href="subject.html#5663">[ subject ]</a>
              <a href="author.html#5663">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
