<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] shell un-escaping squidclient -H option
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shell%20un-escaping%20squidclient%20-H%20option&In-Reply-To=%3C2617692a-3b6a-6aa1-a1c2-d3dd4bb1902d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005698.html">
   <LINK REL="Next"  HREF="005702.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] shell un-escaping squidclient -H option</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20shell%20un-escaping%20squidclient%20-H%20option&In-Reply-To=%3C2617692a-3b6a-6aa1-a1c2-d3dd4bb1902d%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] shell un-escaping squidclient -H option">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May 19 13:51:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005698.html">[squid-dev] Jenkins build is back to normal : trunk-matrix » gcc,d-debian-unstable #644
</A></li>
        <LI>Next message: <A HREF="005702.html">[squid-dev] [PATCH] shell un-escaping squidclient -H option
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5695">[ date ]</a>
              <a href="thread.html#5695">[ thread ]</a>
              <a href="subject.html#5695">[ subject ]</a>
              <a href="author.html#5695">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The squidclient -H parameter takes a string with some limited
shellescaped characters. Currently just \n was expanded to the CRLF
sequence. Other shell escaped characters were left untouched.

However, to properly test headers containing weird CR, LF and HTAB
positioning it needs to be able to receive these special characters
individually and thus unescape them.

Add a new function similar to perform shell unescape with special
characters \r, \n, and \t. All other characters are un-escaped to
themselves. Including '\\'.

Amos
-------------- next part --------------
=== modified file 'tools/squidclient/squidclient.cc'
--- tools/squidclient/squidclient.cc	2016-04-03 23:41:58 +0000
+++ tools/squidclient/squidclient.cc	2016-05-19 13:46:00 +0000
@@ -94,61 +94,108 @@
 static void
 usage(const char *progname)
 {
     std::cerr &lt;&lt; &quot;Version: &quot; &lt;&lt; VERSION &lt;&lt; std::endl
               &lt;&lt; &quot;Usage: &quot; &lt;&lt; progname &lt;&lt; &quot; [Basic Options] [HTTP Options]&quot; &lt;&lt; std::endl
               &lt;&lt; std::endl;
     std::cerr
             &lt;&lt; &quot;    -s | --quiet    Silent.  Do not print response message to stdout.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -v | --verbose  Verbose debugging. Repeat (-vv) to increase output level.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;                    Levels:&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;                      1 - Print outgoing request message to stderr.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;                      2 - Print action trace to stderr.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    --help          Display this help text.&quot; &lt;&lt; std::endl
             &lt;&lt; std::endl;
     Transport::Config.usage();
     Ping::Config.usage();
     std::cerr
             &lt;&lt; &quot;HTTP Options:&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -a           Do NOT include Accept: header.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -A           User-Agent: header. Use \&quot;\&quot; to omit.&quot; &lt;&lt; std::endl
-            &lt;&lt; &quot;    -H 'string'  Extra headers to send. Use '\\n' for new lines.&quot; &lt;&lt; std::endl
+            &lt;&lt; &quot;    -H 'string'  Extra headers to send. Use '\\\\' for \\, '\\n' for LF, '\\r' for CR and '\\t' for tab.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -i IMS       If-Modified-Since time (in Epoch seconds).&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -j hosthdr   Host header content&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -k           Keep the connection active. Default is to do only one request then close.&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -m method    Request method, default is GET.&quot; &lt;&lt; std::endl
 #if HAVE_GSSAPI
             &lt;&lt; &quot;    -n           Proxy Negotiate(Kerberos) authentication&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -N           WWW Negotiate(Kerberos) authentication&quot; &lt;&lt; std::endl
 #endif
             &lt;&lt; &quot;    -P file      Send content from the named file as request payload&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -r           Force cache to reload URL&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -t count     Trace count cache-hops&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -u user      Proxy authentication username&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -U user      WWW authentication username&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -V version   HTTP Version. Use '-' for HTTP/0.9 omitted case&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -w password  Proxy authentication password&quot; &lt;&lt; std::endl
             &lt;&lt; &quot;    -W password  WWW authentication password&quot; &lt;&lt; std::endl
             ;
     exit(1);
 }
 
+static void
+shellUnescape(char *buf)
+{
+    if (!buf)
+        return;
+
+    unsigned char *p, *d;
+    unsigned char ch;
+
+    d = p = (unsigned char *)buf;
+
+    while ((ch = *p)) {
+
+        if (ch == '\\') {
+            ++p;
+
+            switch (*p) {
+            case 'n':
+                ch = '\n';
+                break;
+            case 'r':
+                ch = '\r';
+                break;
+            case 't':
+                ch = '\t';
+                break;
+            default:
+                ch = *p;
+                break;
+            }
+
+            *d = ch;
+
+            if (!ch)
+                continue;
+
+        } else {
+            *d = *p;
+        }
+
+        ++p;
+        ++d;
+    }
+
+    *d = '\0';
+}
+
 int
 main(int argc, char *argv[])
 {
     int len, bytesWritten;
     bool to_stdout, reload;
     int keep_alive = 0;
     int opt_noaccept = 0;
 #if HAVE_GSSAPI
     int www_neg = 0, proxy_neg = 0;
 #endif
     char url[BUFSIZ], msg[MESSAGELEN], buf[BUFSIZ];
     char extra_hdrs[HEADERLEN];
     const char *method = &quot;GET&quot;;
     extern char *optarg;
     time_t ims = 0;
     int max_forwards = -1;
 
     const char *proxy_user = NULL;
     const char *proxy_password = NULL;
     const char *www_user = NULL;
@@ -245,44 +292,42 @@
 
             case 'P':
                 put_file = xstrdup(optarg);
                 break;
 
             case 'i':       /* IMS */
                 ims = (time_t) atoi(optarg);
                 break;
 
             case 'm':
                 method = xstrdup(optarg);
                 break;
 
             case 't':
                 method = xstrdup(&quot;TRACE&quot;);
                 max_forwards = atoi(optarg);
                 break;
 
             case 'H':
                 if (strlen(optarg)) {
-                    char *t;
                     strncpy(extra_hdrs, optarg, sizeof(extra_hdrs));
-                    while ((t = strstr(extra_hdrs, &quot;\\n&quot;)))
-                        *t = '\r', *(t + 1) = '\n';
+                    shellUnescape(extra_hdrs);
                 }
                 break;
 
             case 'T':
                 Transport::Config.ioTimeout = atoi(optarg);
                 break;
 
             case 'u':
                 proxy_user = optarg;
                 break;
 
             case 'w':
                 proxy_password = optarg;
                 break;
 
             case 'U':
                 www_user = optarg;
                 break;
 
             case 'W':

</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005698.html">[squid-dev] Jenkins build is back to normal : trunk-matrix » gcc,d-debian-unstable #644
</A></li>
	<LI>Next message: <A HREF="005702.html">[squid-dev] [PATCH] shell un-escaping squidclient -H option
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5695">[ date ]</a>
              <a href="thread.html#5695">[ thread ]</a>
              <a href="subject.html#5695">[ subject ]</a>
              <a href="author.html#5695">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
