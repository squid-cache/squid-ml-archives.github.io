<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Bumping after peek and Splicing after stare
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bumping%20after%20peek%20and%20Splicing%20after%20stare&In-Reply-To=%3Ca24ea4a7-a42f-23a5-c540-78ca9a6bda16%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005711.html">
   <LINK REL="Next"  HREF="005716.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Bumping after peek and Splicing after stare</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bumping%20after%20peek%20and%20Splicing%20after%20stare&In-Reply-To=%3Ca24ea4a7-a42f-23a5-c540-78ca9a6bda16%40treenet.co.nz%3E"
       TITLE="[squid-dev] Bumping after peek and Splicing after stare">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 20 09:26:53 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005711.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
        <LI>Next message: <A HREF="005716.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5713">[ date ]</a>
              <a href="thread.html#5713">[ thread ]</a>
              <a href="subject.html#5713">[ subject ]</a>
              <a href="author.html#5713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/05/2016 8:20 p.m., Christos Tsantilas wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i>  On peek bumping mode we are sending the client hello message to the SSL
</I>&gt;<i> server. The client Hello message normally includes the supported
</I>&gt;<i> features by client and a shared key. This is normally makes impossible
</I>&gt;<i> to bump the connection after &quot;peek&quot; mode.
</I>&gt;<i> 
</I>&gt;<i> On stare mode squid sends its hello message (with its supported features
</I>&gt;<i> and its shared keys), and this is make impossible to splice the
</I>&gt;<i> connection after stare mode.
</I>&gt;<i> 
</I>&gt;<i> However currently we are trying to hack openSSL, if it is possible (the
</I>&gt;<i> same features supported by both squid and client) and fill its internal
</I>&gt;<i> structures with the hello message sent by client to allow:
</I>&gt;<i>   - on stare mode splice the connection
</I>&gt;<i>   - on peek mode bump the connection.
</I>&gt;<i> 
</I>&gt;<i> This was possible and worked if squid and web client was build using the
</I>&gt;<i> same openSSL library, or for older firefox clients (which used a limit
</I>&gt;<i> number of tls extensions).
</I>&gt;<i> 
</I>&gt;<i> However recent changes to the source code of openSSL, break this
</I>&gt;<i> feature. Moreover the openSSL source code is significant changed in its
</I>&gt;<i> trunk repository. The upcoming openSSL releases will have major difference.
</I>&gt;<i> 
</I>&gt;<i> Looks that it will be very difficult to maintain this hack. And this is
</I>&gt;<i> already make problems to squid. The stare mode may not work in some cases.
</I>&gt;<i> 
</I>&gt;<i> The squid code which hacks openSSL is inside adjustSSL function in bio.cc.
</I>&gt;<i> 
</I>&gt;<i> I am suggesting to just remove this function and the
</I>&gt;<i> SQUID_CHECK_OPENSSL_HELLO_OVERWRITE_HACK configure.ac check.
</I>
Sounds like it is the way to go. It would also be hard to maintain for
other non-OpenSSL libraries anyway.


[Slightly off topic, sorry]

I've said this before, but what I would really like to see in the long
term is peeking always at clientHello. I dont see any reason not to
given how BIO works, the action would not involve any crypto and it
would not lead to the above problem.

That would solve several problems we have currently:
* less explicit configurations of step1 actions leading to these problem
cases.
* almost all users having to explicitly configure peek at step 1 to get
the SNI.
* having to hack up careful http_access configs to deal with the raw-IP
CONNECT that we start with. Instead jumping straight to the fake-CONNECT
with SNI details, or raw-IP meaning no SNI.
 - in other words the CONNECT filters by dstdomain can work without
having to start ssl_bump.
* logging and routing of the CONNECT much more consistently being based
on a domain or server name.

Both peek and stare then reliably mean operations only on the
serverHello, and Squid can probably start to warn about config issues a
bit better.

Amos

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005711.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
	<LI>Next message: <A HREF="005716.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5713">[ date ]</a>
              <a href="thread.html#5713">[ thread ]</a>
              <a href="subject.html#5713">[ subject ]</a>
              <a href="author.html#5713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
