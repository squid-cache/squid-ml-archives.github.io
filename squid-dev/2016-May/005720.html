<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Bumping after peek and Splicing after stare
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bumping%20after%20peek%20and%20Splicing%20after%20stare&In-Reply-To=%3C573F2A12.1020901%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005716.html">
   <LINK REL="Next"  HREF="005721.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Bumping after peek and Splicing after stare</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bumping%20after%20peek%20and%20Splicing%20after%20stare&In-Reply-To=%3C573F2A12.1020901%40measurement-factory.com%3E"
       TITLE="[squid-dev] Bumping after peek and Splicing after stare">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri May 20 15:15:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005716.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
        <LI>Next message: <A HREF="005721.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5720">[ date ]</a>
              <a href="thread.html#5720">[ thread ]</a>
              <a href="subject.html#5720">[ subject ]</a>
              <a href="author.html#5720">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/20/2016 05:12 AM, Christos Tsantilas wrote:
&gt;<i> On 05/20/2016 12:26 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> I would really like to see in the long
</I>&gt;&gt;<i> term is peeking always at clientHello.
</I>
&gt;<i> This is what fast-sni does! For the step1-to-step2 does not involved any
</I>&gt;<i> openSSL code.
</I>
What Amos means is doing step1 unconditionally/always, eliminating the
need to mention it in squid.conf.


&gt;<i> But I am not sure that we can completely remove the step1. Splice on
</I>&gt;<i> step1 required for non SSL related protocols.
</I>
Yes, non-SSL protocols and SSL traffic incompatible with our SSL parser
are the reasons why we need this &quot;Should Squid do SslBump step #1?&quot;
checkpoint. In other words, today step1 is needed _not_ because we want
to do step1, but because we want to be able to _avoid_ doing step1 (and
the following steps).

With more work, this checkpoint can and should be replaced with the
equivalent on_unsupported_protocol-driven functionality. So, long-term,
I agree with Amos that step1 should be done automatically with
on_unsupported_protocol allowing the admin to control Squid actions when
step1 parsing fails.

Just like catching exceptions is the best way to handle most parsing
errors in C++ code, using special/dedicated configuration options is the
best way to configure Squid behavior in exceptional situations. Our
on_unsupported_protocol is such a configuration option.


&gt;&gt;<i> the action would not lead to the above problem.
</I>
The problem Christos discusses is different and will exist regardless of
whether we always do step1 or not. adjustSSL() hack allows

  ssl_bump peek step2
  ssl_bump bump all

and

  ssl_bump stare step2
  ssl_bump splice all

combinations to work in _some_ cases. In other cases, it either breaks
SSL negotiation or crashes Squid. The number of non-working cases and
their unpredictability has increased so much that we are proposing to
remove this hack even though there are probably some admins in
old/controlled deployment environment that benefit from it (possibly
unknowingly).

For example, today, Squid trunk may not be able to stare during step2
when built with the latest OpenSSL v1.0 releases because adjustSsl()
screws up OpenSSL state. We do not know the exact mechanism, but suspect
that the internal OpenSSL buffer layout has changed. Going forward,
OpenSSL v1.1 releases contain lots of drastic changes in that area.


Hope this clarifies,

Alex.

</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005716.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
	<LI>Next message: <A HREF="005721.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5720">[ date ]</a>
              <a href="thread.html#5720">[ thread ]</a>
              <a href="subject.html#5720">[ subject ]</a>
              <a href="author.html#5720">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
