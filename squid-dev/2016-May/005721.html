<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Bumping after peek and Splicing after stare
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bumping%20after%20peek%20and%20Splicing%20after%20stare&In-Reply-To=%3C69adbdd9-ac69-cf57-bea4-04178fb57493%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005720.html">
   <LINK REL="Next"  HREF="005722.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Bumping after peek and Splicing after stare</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Bumping%20after%20peek%20and%20Splicing%20after%20stare&In-Reply-To=%3C69adbdd9-ac69-cf57-bea4-04178fb57493%40treenet.co.nz%3E"
       TITLE="[squid-dev] Bumping after peek and Splicing after stare">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 20 15:45:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005720.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
        <LI>Next message: <A HREF="005722.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5721">[ date ]</a>
              <a href="thread.html#5721">[ thread ]</a>
              <a href="subject.html#5721">[ subject ]</a>
              <a href="author.html#5721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/05/2016 3:15 a.m., Alex Rousskov wrote:
&gt;<i> On 05/20/2016 05:12 AM, Christos Tsantilas wrote:
</I>&gt;&gt;<i> On 05/20/2016 12:26 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> I would really like to see in the long
</I>&gt;&gt;&gt;<i> term is peeking always at clientHello.
</I>&gt;<i> 
</I>&gt;&gt;<i> This is what fast-sni does! For the step1-to-step2 does not involved any
</I>&gt;&gt;<i> openSSL code.
</I>&gt;<i> 
</I>&gt;<i> What Amos means is doing step1 unconditionally/always, eliminating the
</I>&gt;<i> need to mention it in squid.conf.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> But I am not sure that we can completely remove the step1. Splice on
</I>&gt;&gt;<i> step1 required for non SSL related protocols.
</I>&gt;<i> 
</I>&gt;<i> Yes, non-SSL protocols and SSL traffic incompatible with our SSL parser
</I>&gt;<i> are the reasons why we need this &quot;Should Squid do SslBump step #1?&quot;
</I>&gt;<i> checkpoint. In other words, today step1 is needed _not_ because we want
</I>&gt;<i> to do step1, but because we want to be able to _avoid_ doing step1 (and
</I>&gt;<i> the following steps).
</I>&gt;<i> 
</I>&gt;<i> With more work, this checkpoint can and should be replaced with the
</I>&gt;<i> equivalent on_unsupported_protocol-driven functionality. So, long-term,
</I>&gt;<i> I agree with Amos that step1 should be done automatically with
</I>&gt;<i> on_unsupported_protocol allowing the admin to control Squid actions when
</I>&gt;<i> step1 parsing fails.
</I>&gt;<i> 
</I>&gt;<i> Just like catching exceptions is the best way to handle most parsing
</I>&gt;<i> errors in C++ code, using special/dedicated configuration options is the
</I>&gt;<i> best way to configure Squid behavior in exceptional situations. Our
</I>&gt;<i> on_unsupported_protocol is such a configuration option.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> the action would not lead to the above problem.
</I>&gt;<i> 
</I>&gt;<i> The problem Christos discusses is different and will exist regardless of
</I>&gt;<i> whether we always do step1 or not. adjustSSL() hack allows
</I>&gt;<i> 
</I>&gt;<i>   ssl_bump peek step2
</I>&gt;<i>   ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> and
</I>&gt;<i> 
</I>&gt;<i>   ssl_bump stare step2
</I>&gt;<i>   ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> combinations to work in _some_ cases. In other cases, it either breaks
</I>&gt;<i> SSL negotiation or crashes Squid. The number of non-working cases and
</I>&gt;<i> their unpredictability has increased so much that we are proposing to
</I>&gt;<i> remove this hack even though there are probably some admins in
</I>&gt;<i> old/controlled deployment environment that benefit from it (possibly
</I>&gt;<i> unknowingly).
</I>&gt;<i> 
</I>&gt;<i> For example, today, Squid trunk may not be able to stare during step2
</I>&gt;<i> when built with the latest OpenSSL v1.0 releases because adjustSsl()
</I>&gt;<i> screws up OpenSSL state. We do not know the exact mechanism, but suspect
</I>&gt;<i> that the internal OpenSSL buffer layout has changed. Going forward,
</I>&gt;<i> OpenSSL v1.1 releases contain lots of drastic changes in that area.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hope this clarifies,
</I>&gt;<i> 
</I>
Yes.

IMO, if its a hack and causing trouble we should remove it. But as you
are the one who will probably be the one fixing it if it stays, thats
your call Chhristos.

If you want to experiment, you could &quot;#if 0&quot; it for next weeks release
and see what feedback we get.

Amos

</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005720.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
	<LI>Next message: <A HREF="005722.html">[squid-dev] Bumping after peek and Splicing after stare
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5721">[ date ]</a>
              <a href="thread.html#5721">[ thread ]</a>
              <a href="subject.html#5721">[ subject ]</a>
              <a href="author.html#5721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
