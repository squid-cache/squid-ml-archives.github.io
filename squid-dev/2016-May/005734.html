<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Do not load icons one character at a time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Do%20not%20load%20icons%20one%20character%20at%20a%20time&In-Reply-To=%3C574094D6.3010600%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005731.html">
   <LINK REL="Next"  HREF="005768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Do not load icons one character at a time</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Do%20not%20load%20icons%20one%20character%20at%20a%20time&In-Reply-To=%3C574094D6.3010600%40measurement-factory.com%3E"
       TITLE="[squid-dev] Do not load icons one character at a time">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat May 21 17:03:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005731.html">[squid-dev] Do not load icons one character at a time
</A></li>
        <LI>Next message: <A HREF="005768.html">[squid-dev] Do not load icons one character at a time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5734">[ date ]</a>
              <a href="thread.html#5734">[ thread ]</a>
              <a href="subject.html#5734">[ subject ]</a>
              <a href="author.html#5734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/21/2016 03:09 AM, Amos Jeffries wrote:
&gt;<i> On 21/05/2016 6:25 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i>   Since trunk r14100 (Bug 3875: bad mimeLoadIconFile error handling), each
</I>&gt;&gt;&gt;<i>   icon was read from disk and written to Store one character at a time.
</I>

&gt;<i> -        char *buf = (char *)memAllocate(MEM_4K_BUF);
</I>&gt;<i> -        while ((n = FD_READ_METHOD(fd, buf, sizeof(*buf))) &gt; 0)
</I>

&gt;<i> Do you know where it is coming from exactly?
</I>&gt;<i>  sizeof(*buf) on dynamic arrays should be the array length. Not the char
</I>&gt;<i> size.
</I>
... because the compiler adds secret code that stores sizes of all
dynamically allocated buffers in a secret hash and then looks that hash
up whenever somebody calls sizeof() for any pointer, including sizeof()
calls in another library compiled by another compiler and running in
another thread? Think about it.

sizeof(expression) always returns the size of expression's type. The
only caveat to keep in mind when dealing with sizeof is that arrays do
not decay to pointers when passed to sizeof.

sizeof(&quot;foo&quot;) returning 4 confuses developers, but it is not magical if
you know the type of literal strings like &quot;foo&quot; (it is an array of
chars, and not a char pointer).

So, in trunk r14100 case, sizeof(*buf) means sizeof(char) which is 1.

References:
  <A HREF="http://stackoverflow.com/questions/1392200/sizeof-string-literal">http://stackoverflow.com/questions/1392200/sizeof-string-literal</A>
  <A HREF="http://en.cppreference.com/w/cpp/language/sizeof">http://en.cppreference.com/w/cpp/language/sizeof</A>



If you recall any other place where you used an expression like
sizeof(*buf) to mean &quot;the size of the dynamically allocated buffer that
buf points to&quot;, please fix those as well.



&gt;<i>  sizeof(buf) is the 32-bit/64-bit size of pointers in the build. So we
</I>&gt;<i> can't use that.
</I>
Correct.


&gt;<i> We could hard-code the 4KB size here for 3.5. But I'd rather learn what
</I>&gt;<i> was wrong.
</I>
I recommend using an array for v3.5:

    char buf[4096];

A fixed-size array is simple, fast, exception-safe, does not need
dynamic allocation/cleanup, and allows you to use sizeof(buf) instead of
repeating 4096 or naming that constant. 4KB stack objects are fine in
non-recursive, non-kernel contexts. A C array is less safe than
std::array, but we can leave with that risk in this context.

I do not know why you have chosen the complex route of dynamically
allocating a 4KiB buffer. Perhaps you were trying to avoid writing
&quot;4096&quot;? There is no shame in writing that, as long as you write it only
once for each distinct purpose.


HTH,

Alex.

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005731.html">[squid-dev] Do not load icons one character at a time
</A></li>
	<LI>Next message: <A HREF="005768.html">[squid-dev] Do not load icons one character at a time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5734">[ date ]</a>
              <a href="thread.html#5734">[ thread ]</a>
              <a href="subject.html#5734">[ subject ]</a>
              <a href="author.html#5734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
