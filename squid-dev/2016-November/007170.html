<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3Ce0b4185e-0763-a05f-d4f3-816d86ed2351%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007167.html">
   <LINK REL="Next"  HREF="007174.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3Ce0b4185e-0763-a05f-d4f3-816d86ed2351%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Nov  4 18:12:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007167.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
        <LI>Next message: <A HREF="007174.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7170">[ date ]</a>
              <a href="thread.html#7170">[ thread ]</a>
              <a href="subject.html#7170">[ subject ]</a>
              <a href="author.html#7170">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/04/2016 01:12 AM, Kinkie wrote:
&gt;<i> On Thu, Nov 3, 2016 at 10:55 PM, Alex Rousskov
</I>&gt;<i> &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 11/03/2016 03:19 PM, Kinkie wrote:
</I>&gt;&gt;&gt;<i> On Tue, Nov 1, 2016 at 8:47 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> On 11/01/2016 02:02 PM, Kinkie wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>   the attached patch extends SBufContainerJoin to have prefix and
</I>&gt;&gt;&gt;&gt;&gt;<i> suffix arguments.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I recommend reworking this by adding a dest parameter:
</I>&gt;&gt;&gt;&gt;<i> SBuf &amp;ContainerToSBuf(SBuf &amp;dest, ...);
</I>
&gt;<i> attached v3 does this.
</I>
&gt;<i>  SBuf
</I>&gt;<i> +JoinContainerIntoSBuf(SBuf &amp;dest, ...
</I>
Please return dest, not a copy of it. There is no reason to create and
destroy a new SBuf object here IMO. SBuf creation and destruction are
not as expensive as underlying storage copying, but they are still a
measurable expense without justification AFAICT.

There are certainly many cases where using references is a bad idea but
returning a fed-by-reference &quot;dest&quot; is not one of them AFAICT. In fact,
it is nearly the norm in &quot;chainable&quot; calls such as those that append
something.


&gt;<i> +/// variant of JoinContainerIntoSBuf not needing a SBuf lvalue
</I>
I recommend a more informative description than retelling of the
function declaration code. For example:

/// convenience JoinContainerIntoSBuf() wrapper with an extra memory
allocation

&gt;<i> +    dest.reserveSpace(sz + prefix.length() + suffix.length());
</I>
I would reorder the operands to make the code more self-documenting,
especially when using an anonymous variable name like &quot;sz&quot;:

  dest.reserveSpace(prefix.length() + sz + suffix.length());


&gt;<i> I am not generally worried as it seems you are about copying SBufs as
</I>&gt;<i> long as the underlying storage is not reallocated needlessly. 
</I>
Unfortunately, all three patch versions reallocate storage needlessly
(for various reasons). You can study the attached debugging from the
attached patch to see what is actually going on in various
JoinContainerIntoSBuf implementations. It may surprise and inspire you
to make the code better. It did surprise and inspire me (but I wish I
was not doing this legwork!).


Thank you,

Alex.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: sbuf-alloc.log
Type: text/x-log
Size: 8233 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161104/3b8dcbc9/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161104/3b8dcbc9/attachment.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: sbuf-alloc.patch
Type: text/x-diff
Size: 3301 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161104/3b8dcbc9/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161104/3b8dcbc9/attachment.patch</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007167.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
	<LI>Next message: <A HREF="007174.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7170">[ date ]</a>
              <a href="thread.html#7170">[ thread ]</a>
              <a href="subject.html#7170">[ subject ]</a>
              <a href="author.html#7170">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
