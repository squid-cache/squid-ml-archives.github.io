<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3C4506e1bb-2fca-36dd-54e0-794213fa3051%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007174.html">
   <LINK REL="Next"  HREF="007176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3C4506e1bb-2fca-36dd-54e0-794213fa3051%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Nov  6 02:10:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007174.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
        <LI>Next message: <A HREF="007176.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7175">[ date ]</a>
              <a href="thread.html#7175">[ thread ]</a>
              <a href="subject.html#7175">[ subject ]</a>
              <a href="author.html#7175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/05/2016 02:57 PM, Kinkie wrote:
&gt;<i> On Fri, Nov 4, 2016 at 6:12 PM, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 11/04/2016 01:12 AM, Kinkie wrote:
</I>&gt;&gt;&gt;<i> +/// variant of JoinContainerIntoSBuf not needing a SBuf lvalue
</I>
&gt;&gt;<i> I recommend a more informative description than retelling of the
</I>&gt;&gt;<i> function declaration code. For example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /// convenience JoinContainerIntoSBuf() wrapper with an extra memory
</I>&gt;&gt;<i> allocation
</I>

&gt;<i> The extra memory allocation is a side effect; 
</I>
Some side effects, like this one, are very important to document,
_especially_ because they are invisible to the caller. If I am looking
for a convenience function to call, I do want to know whether that
convenience comes at a price.


&gt;<i> the convenience is in not needing a SBuf lvalue.
</I>
Yes.


&gt;<i> This makes it useable e.g. in ostreams
</I>
Both functions are usable with ostream, but the convenience wrapper is
more convenient to use, naturally. There is nothing wrong with that! You
just need to warn folks that they are probably paying one memory
allocation/destruction for that convenience. In many cases, that price
is perfectly reasonable, of course. We just need to disclose it.


&gt;<i> Note that the wrapper cannot return a ref, intentionally so.
</I>
Yes, of course. As far as the wrapper is concerned, it is only a
question of disclosing that the wrapper is a costly function. The cost
does not come from the return type. It comes from the lack of a
pre-allocated caller's buffer to accumulate the results in.


&gt;&gt;<i> Unfortunately, all three patch versions reallocate storage needlessly
</I>&gt;&gt;<i> (for various reasons). You can study the attached debugging from the
</I>&gt;&gt;<i> attached patch to see what is actually going on in various
</I>&gt;&gt;<i> JoinContainerIntoSBuf implementations. It may surprise and inspire you
</I>&gt;&gt;<i> to make the code better. It did surprise and inspire me (but I wish I
</I>&gt;&gt;<i> was not doing this legwork!).
</I>
&gt;<i> Updated patch attached. 
</I>
&gt;<i> +    dest.reserveSpace(prefix.length() + totalContainerSize + suffix.length());
</I>
Please note that v4 still allocates memory according to my last
experiment. See JoinContainerIntoSBuf3() which mimics your patch v4. You
may claim that the unnecessary allocation is not the fault of this
patch, and you could be right, but I was hoping this observation will
inspire you to change

* either your patch (mimicking my JoinContainerIntoSBuf4() which does
not result in extra allocation) reserveSpace()

* or reserveSpace() (after making sure that all callers are going to be
OK with that change).

The latter would be better if it is possible. If it is not possible,
then we may need to change reserveSpace() documentation so that folks do
not use that method like you did.


HTH,

Alex.

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007174.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
	<LI>Next message: <A HREF="007176.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7175">[ date ]</a>
              <a href="thread.html#7175">[ thread ]</a>
              <a href="subject.html#7175">[ subject ]</a>
              <a href="author.html#7175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
