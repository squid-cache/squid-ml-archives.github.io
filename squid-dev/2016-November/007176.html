<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3CCA%2BY8hcOfO-G2d2vPxL6KP0PnSk%2BHWkSRBcdBmGmk2sRtKgB22w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007175.html">
   <LINK REL="Next"  HREF="007179.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3CCA%2BY8hcOfO-G2d2vPxL6KP0PnSk%2BHWkSRBcdBmGmk2sRtKgB22w%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments">gkinkie at gmail.com
       </A><BR>
    <I>Sun Nov  6 07:15:25 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007175.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
        <LI>Next message: <A HREF="007179.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7176">[ date ]</a>
              <a href="thread.html#7176">[ thread ]</a>
              <a href="subject.html#7176">[ subject ]</a>
              <a href="author.html#7176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i> +    dest.reserveSpace(prefix.length() + totalContainerSize + suffix.length());
</I>&gt;<i>
</I>&gt;<i> Please note that v4 still allocates memory according to my last
</I>&gt;<i> experiment. See JoinContainerIntoSBuf3() which mimics your patch v4. You
</I>&gt;<i> may claim that the unnecessary allocation is not the fault of this
</I>&gt;<i> patch, and you could be right, but I was hoping this observation will
</I>&gt;<i> inspire you to change
</I>
I don't follow. The space requirement in JoinContainerIntoSBuf is not
advisory. The accumulate at the beginning of the function is meant to
calculate exactly how much space is needed, to copy (if needed) only
once and early.

&gt;<i> * either your patch (mimicking my JoinContainerIntoSBuf4() which does
</I>&gt;<i> not result in extra allocation) reserveSpace()
</I>
The traces you provided do not reallocate there because the underlying
MemBlob has grown enough in previous calls to have enough free space
to cover the projected needs (it was resized last at
JoinContainerIntoSBuf3).

In other words, the test data is dirtied as the tests progress.
Follow with me:
2016/11/04 11:47:21.841| 24,8| SBuf.cc(42) SBuf: SBuf2698 created
2016/11/04 11:47:21.841| 24,8| SBuf.cc(908) cow: SBuf2698 new size:1024
2016/11/04 11:47:21.841| 24,8| SBuf.cc(878) reAlloc: SBuf2698 new size: 1024

But then:

2016/11/04 11:47:21.841| 1,2| AccessLogEntry.cc(47)
JoinContainerIntoSBuf2: started
2016/11/04 11:47:21.841| 1,2| AccessLogEntry.cc(48)
JoinContainerIntoSBuf2: did not create an empty buf
2016/11/04 11:47:21.841| 24,8| SBuf.cc(908) cow: SBuf2698 new size:124
2016/11/04 11:47:21.841| 24,8| SBuf.cc(878) reAlloc: SBuf2698 new size: 124

This is correct behavior: the code advises that it only needs that
much storage and the SBuf shrinks. It's passed by reference, so from
now on 'buffer' has 124 bytes of storage instead of the pre-allocated
1024.

As a demonstration, swapping order of tests 3 and 4 results in:
[...]
2016/11/06 07:05:47.860 kid1| 1,2| main.cc(457) JoinContainerIntoSBuf4: started
2016/11/06 07:05:47.860 kid1| 24,8| SBuf.cc(130) reserve: SBuf3657
was: 0+81+47=128
2016/11/06 07:05:47.860 kid1| 24,8| SBuf.cc(912) cow: SBuf3657 new size:181
2016/11/06 07:05:47.860 kid1| 24,8| SBuf.cc(882) reAlloc: SBuf3657 new size: 181
2016/11/06 07:05:47.860 kid1| 24,8| MemBlob.cc(101) memAlloc: blob2420
memAlloc: requested=181, received=512
2016/11/06 07:05:47.860 kid1| 24,7| SBuf.cc(891) reAlloc: SBuf3657 new
store capacity: 512
2016/11/06 07:05:47.860 kid1| 24,7| SBuf.cc(146) reserve: SBuf3657
now: 0+81+431=512
2016/11/06 07:05:47.860 kid1| 1,2| main.cc(462)
JoinContainerIntoSBuf4: reserved space
2016/11/06 07:05:47.860 kid1| 24,7| SBuf.cc(154) rawSpace: reserving 7
for SBuf3657
2016/11/06 07:05:47.860 kid1| 24,7| SBuf.cc(161) rawSpace: SBuf3657 not growing


I don't think however that we should change reserveSpace() behavior
not to ever shrink; there may be use cases where it's better not to do
it in fact. At the same time, it's not a matter of API: the extended
reserve() has the same behavior as the &quot;problem&quot; is elsewhere.

&gt;<i>
</I>&gt;<i> * or reserveSpace() (after making sure that all callers are going to be
</I>&gt;<i> OK with that change).
</I>&gt;<i>
</I>&gt;<i> The latter would be better if it is possible. If it is not possible,
</I>&gt;<i> then we may need to change reserveSpace() documentation so that folks do
</I>&gt;<i> not use that method like you did.
</I>
What we could do is:
- define a reserveMinSpace() which does not shrink storage
- reimplement both reserveSpace() and reserveMinSpace() as convenience
wrappers around reserve() which is undoubtably more powerful
- while we're at it, give SBufReservationRequirements a convenience constructor

What do you think?
Thanks.

-- 
    Francesco
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007175.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
	<LI>Next message: <A HREF="007179.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7176">[ date ]</a>
              <a href="thread.html#7176">[ thread ]</a>
              <a href="subject.html#7176">[ subject ]</a>
              <a href="author.html#7176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
