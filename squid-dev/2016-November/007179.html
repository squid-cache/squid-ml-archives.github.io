<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3Caa2bf093-7ba2-5530-0a05-37d9ead0a72b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007176.html">
   <LINK REL="Next"  HREF="007197.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Extend%20SBufContainerJoin%20to%20have%20prefix%20and%0A%20suffix%20arguments&In-Reply-To=%3Caa2bf093-7ba2-5530-0a05-37d9ead0a72b%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Nov  7 01:02:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007176.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
        <LI>Next message: <A HREF="007197.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7179">[ date ]</a>
              <a href="thread.html#7179">[ thread ]</a>
              <a href="subject.html#7179">[ subject ]</a>
              <a href="author.html#7179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/06/2016 01:15 AM, Kinkie wrote:
&gt;&gt;&gt;<i> +    dest.reserveSpace(prefix.length() + totalContainerSize + suffix.length());
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please note that v4 still allocates memory according to my last
</I>&gt;&gt;<i> experiment. See JoinContainerIntoSBuf3() which mimics your patch v4. You
</I>&gt;&gt;<i> may claim that the unnecessary allocation is not the fault of this
</I>&gt;&gt;<i> patch, and you could be right, but I was hoping this observation will
</I>&gt;&gt;<i> inspire you to change
</I>&gt;<i> 
</I>&gt;<i> I don't follow. The space requirement in JoinContainerIntoSBuf is not
</I>&gt;<i> advisory. The accumulate at the beginning of the function is meant to
</I>&gt;<i> calculate exactly how much space is needed, to copy (if needed) only
</I>&gt;<i> once and early.
</I>
What you say is true except for the &quot;if needed&quot; part. In some cases,
JoinContainerIntoSBuf() allocates and copies without needed. Those extra
allocations are present in v1, v2, v3, and v4 versions of the patch, but
the reasons behind those unnecessary allocations varied.


&gt;<i> The traces you provided do not reallocate there because the underlying
</I>&gt;<i> MemBlob has grown enough in previous calls to have enough free space
</I>&gt;<i> to cover the projected needs (it was resized last at
</I>&gt;<i> JoinContainerIntoSBuf3).
</I>
No, &quot;has grown enough&quot; is not the reason why JoinContainerIntoSBuf4()
does not reallocate needlessly.


&gt;<i> In other words, the test data is dirtied as the tests progress.
</I>
My tests were indeed dirty (sorry) and could have easily led to wrong
conclusions, but they did not. The cleaned up version (attached) shows
exactly the same problem, this time without any effect of earlier tests
on later tests.


&gt;<i> This is correct behavior: the code advises that it only needs that
</I>&gt;<i> much storage and the SBuf shrinks.
</I>
Violating explicit STL reserve() guarantees is rarely a good idea but,
for now, I will not argue about what reserveSpace() should do. I will
focus on JoinContainerIntoSBuf() instead.

Tests and code analysis show that JoinContainerIntoSBuf() allocates when
no allocation is needed. I have also shown that it is possible to
implement JoinContainerIntoSBuf() so that there is no extra allocation.
AFAICT, going forward, you choices are:

* state that the extra allocation is not your fault, leaving it as is,
  and/or
* fix JoinContainerIntoSBuf() to avoid the extra allocation.

When you added the &quot;dest&quot; parameter, you have started moving in the
latter direction.


&gt;<i> As a demonstration, swapping order of tests 3 and 4 results in:
</I>
[Snipped wrong conclusions based on confusing dirty tests.
 See cleaned up order-independent tests instead.]


&gt;<i> At the same time, it's not a matter of API: the extended
</I>&gt;<i> reserve() has the same behavior as the &quot;problem&quot; is elsewhere.
</I>
Whether SBuf::reserve() has the same behavior as reserveSpace() depends
on reserve() configuration parameters.

JoinContainerIntoSBuf() should configure reserve() in such a way that
reserve() does _not_ have the same behavior as reserveSpace(). I showed
how to do that in JoinContainerIntoSBuf4() in my earlier patch. The
patch attached now has an even simpler JoinContainerIntoSBuf5()
implementation because I fixed reserve() to not require the .ideal
configuration parameter to be set (trunk r14917).



&gt;<i> What we could do is:
</I>&gt;<i> - define a reserveMinSpace() which does not shrink storage
</I>
Having two methods called reserveMinSpace() and reserveSpace(), one of
which does not shrink and the other one does, makes no sense to me
because the method names do not reflect that difference at all and
because reserve() is always primarily about &quot;minimum&quot; space anyway.

More importantly, reserveSpace() guarantees single ownership. IMO,
shrinking is essentially a side effect of that guarantee.

I suspect we do not need a &quot;provide single-ownership space, shrinking
the existing single-owned MemBlob if there is one&quot; method, but if you
have some existing use cases for it, please share them. If there are no
such cases, reserveSpace()/reserveCapacity() should be optimized to
avoid unnecessary re-allocation when their MemBlob is already not
shared, but that is a different story, unrelated to JoinContainerIntoSBuf!


&gt;<i> - reimplement [...] reserveSpace() as convenience wrapper around reserve()
</I>
Sure, but that is outside this patch scope.


&gt;<i> - while we're at it, give SBufReservationRequirements a convenience constructor
</I>
With minSpace as the only parameter? Sure. Please do not forget
&quot;explicit&quot;. Again, that seems to be outside your patch scope.

I do not recommend providing more than one constructor parameter though
because constructors with multiple same- or similar-type parameters are
a recipe for mismatching parameters disasters.


HTH,

Alex.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: sbuf-alloc-t2.patch
Type: text/x-diff
Size: 4098 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161106/7b6067aa/attachment-0001.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161106/7b6067aa/attachment-0001.patch</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: sbuf-alloc-t2.log
Type: text/x-log
Size: 11932 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161106/7b6067aa/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161106/7b6067aa/attachment-0001.bin</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007176.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
	<LI>Next message: <A HREF="007197.html">[squid-dev] [PATCH] Extend SBufContainerJoin to have prefix and suffix arguments
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7179">[ date ]</a>
              <a href="thread.html#7179">[ thread ]</a>
              <a href="subject.html#7179">[ subject ]</a>
              <a href="author.html#7179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
