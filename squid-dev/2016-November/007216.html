<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Rework acl/RegexData optimization to use SBufList
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Rework%20acl/RegexData%20optimization%20to%20use%0A%20SBufList&In-Reply-To=%3C8afb1f3a-a763-86b8-44e0-3277defcee24%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007221.html">
   <LINK REL="Next"  HREF="007218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Rework acl/RegexData optimization to use SBufList</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Rework%20acl/RegexData%20optimization%20to%20use%0A%20SBufList&In-Reply-To=%3C8afb1f3a-a763-86b8-44e0-3277defcee24%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Rework acl/RegexData optimization to use SBufList">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Nov 14 05:30:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007221.html">[squid-dev] [PATCH] Rework acl/RegexData optimization to use	SBufList
</A></li>
        <LI>Next message: <A HREF="007218.html">[squid-dev] [PATCH] Rework acl/RegexData optimization to use SBufList
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7216">[ date ]</a>
              <a href="thread.html#7216">[ thread ]</a>
              <a href="subject.html#7216">[ subject ]</a>
              <a href="author.html#7216">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/13/2016 05:11 PM, Kinkie wrote:

&gt;<i> the attached patch moves away from hand-rolling a c-string onto
</I>&gt;<i> joining a SBufList for optimizing regexes in RegexData.cc.
</I>
&gt;<i> You can find attached as a test case the output of squidclient
</I>&gt;<i> mgr:config taken on trunk and on the submitted code. It is slightly
</I>&gt;<i> different in that the new code allows for a longer optimized regex.
</I>
I see the following before/after difference:

  -acl bigacl dstdom_regex ... (pattern84) (pattern86) ...
  +acl bigacl dstdom_regex ... (pattern84)|(pattern85) ...

Does changing space into &quot;|&quot; result in one internal regex instead of
two? And that is the optimization you have implemented? How is that
related to SBufs (i.e., why could not old c-strings accommodate longer
regexes)?

And why is there no pattern85 in the &quot;before&quot; test?!


&gt;<i> The code is expected to cause a small performance regression on
</I>&gt;<i> parse and reconfigure due to extra data copies. The regression is
</I>&gt;<i> negligible: the attached test cases perform &quot;squid -k parse&quot; in 60
</I>&gt;<i> msec in trunk and 62 on the branch on a warm cache on my i5 macbook
</I>&gt;<i> air.
</I>
A 3% performance regression is not necessarily negligible. Have you
tested with more ACL lines (not larger individual ACL lines) that take a
few seconds to load (as opposed to 60ms) ? If not, please do unless that
test would be irrelevant somehow.

And what is the expected performance improvement from having fewer
longer regexes?


&gt;<i> [RFC]
</I>
This should be a different thread IMHO.


&gt;<i> The code managing case-insensitivity flags is IMO quite complicated
</I>&gt;<i> and not really intuitive: it switches between case-insensitive and
</I>&gt;<i> case-sensitive each time it meets a -i flag. 
</I>
It does?! Wow! The documentation says that +i switches back to
case-sensitive rather than repeating -i values. If Squid does something
else here, that would be a pretty big bug IMO!


&gt;<i> I would like to change
</I>&gt;<i> the behaviour so that a -i flag makes the whole acl case-insensitive;
</I>&gt;<i> this seems to me consistent with the behavior documented in squid.conf
</I>&gt;<i> which does not document the case of multiple -i flags in a single
</I>&gt;<i> regex-type ACL. I'd like feedback on this proposal.
</I>
I am not 100% sure what you mean by &quot;whole acl&quot; exactly, but please see
the &quot;Where do ACL flags belong?&quot; RFC[1] for a comprehensive coverage of
a similar problem and the agreed solution. The initial discussion was
mostly noise, but things started to make sense around [2]. Your -i is
mentioned frequently, including the last(?) email on that thread[3].

AFAICT, the agreed solutions have not been implemented yet so if you
have the cycles to work on this, you may be able to address all the
related problems at once and make things consistent across all options
of all ACLs. You should probably post a revised RFC (summarizing all
known issues and corresponding changes) if you are going to do that.


[1]
<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004034.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004034.html</A>

[2]
<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004044.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004044.html</A>

[3]
<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004096.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004096.html</A>


Thank you,

Alex.

</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007221.html">[squid-dev] [PATCH] Rework acl/RegexData optimization to use	SBufList
</A></li>
	<LI>Next message: <A HREF="007218.html">[squid-dev] [PATCH] Rework acl/RegexData optimization to use SBufList
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7216">[ date ]</a>
              <a href="thread.html#7216">[ thread ]</a>
              <a href="subject.html#7216">[ subject ]</a>
              <a href="author.html#7216">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
