<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fixed%20Write.cc%3A41%20%22%21ccb-%3Eactive%28%29%22%20assertion&In-Reply-To=%3Cae8e0590-d7c9-599b-e641-ffef8b18ba39%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007225.html">
   <LINK REL="Next"  HREF="007232.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fixed%20Write.cc%3A41%20%22%21ccb-%3Eactive%28%29%22%20assertion&In-Reply-To=%3Cae8e0590-d7c9-599b-e641-ffef8b18ba39%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion">christos at chtsanti.net
       </A><BR>
    <I>Mon Nov 14 18:03:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007225.html">[squid-dev] [PATCH] Rework acl/RegexData optimization to use	SBufList
</A></li>
        <LI>Next message: <A HREF="007232.html">[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7229">[ date ]</a>
              <a href="thread.html#7229">[ thread ]</a>
              <a href="subject.html#7229">[ subject ]</a>
              <a href="author.html#7229">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The following sequence of events triggers this assertion:
   - The server sends an 1xx control message.
   - http.cc schedules ConnStateData::sendControlMsg call.
   - Before sendControlMsg is fired, http.cc detects an error (e.g., I/O 
error or timeout) and starts writing the reply to the user.
   - The ConnStateData::sendControlMsg is fired, starts writing 1xx, and 
hits the &quot;no concurrent writes&quot; assertion.

We could only reproduce this sequence in the lab after changing Squid 
code to trigger a timeout at the right moment, but the sequence looks 
plausible. Other event sequences might result in the same outcome.

To avoid concurrent writes, Squid now drops the control message if 
Http::One::Server detects that a reply is already being written. Also, 
ConnStateData delays reply writing until a pending control message write 
has been completed.


There is strong possibility that the bug fixing this patch is a variant 
of the bug4174:
   <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4174">http://bugs.squid-cache.org/show_bug.cgi?id=4174</A>
However we are getting different backtrace.


This is a Measurement Factory project.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-238-assertion_failed_Write_cc_Not_ccb_active-t3.patch
Type: text/x-patch
Size: 11100 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161114/b97e860e/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161114/b97e860e/attachment.bin</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007225.html">[squid-dev] [PATCH] Rework acl/RegexData optimization to use	SBufList
</A></li>
	<LI>Next message: <A HREF="007232.html">[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7229">[ date ]</a>
              <a href="thread.html#7229">[ thread ]</a>
              <a href="subject.html#7229">[ subject ]</a>
              <a href="author.html#7229">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
