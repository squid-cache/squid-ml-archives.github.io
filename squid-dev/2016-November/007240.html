<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fixed%20Write.cc%3A41%20%22%21ccb-%3Eactive%28%29%22%20assertion&In-Reply-To=%3Cdfbd1f17-bfb8-9a2c-5c3a-cff787fd86dc%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007232.html">
   <LINK REL="Next"  HREF="007246.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fixed%20Write.cc%3A41%20%22%21ccb-%3Eactive%28%29%22%20assertion&In-Reply-To=%3Cdfbd1f17-bfb8-9a2c-5c3a-cff787fd86dc%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion">christos at chtsanti.net
       </A><BR>
    <I>Tue Nov 15 11:58:45 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007232.html">[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
</A></li>
        <LI>Next message: <A HREF="007246.html">[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7240">[ date ]</a>
              <a href="thread.html#7240">[ thread ]</a>
              <a href="subject.html#7240">[ subject ]</a>
              <a href="author.html#7240">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,
  I applied the patch as r14945 with an r14946 fix.

Unfortunately while I was testing the Squid-3.5 variant of the patch I 
found a bug:
  When the Http::One::Server::writeControlMsgAndCall fails to write the 
control message, schedules a Comm::Write callback using just a 
ScheduleCallHere command.
The callback called without the CommIoCbParams details and squid is crashes.

There are two ways to fix this issue.
   1) complete the missing CommIoCbParams details inside 
writeControlMsgAndCall
   2) Make the ConnStateData::writeControlMsgAndCall to return false on 
failures and allow caller handle the failure.

This patch implements the (2) as I believe it is the better option.

My apologies for the buggy patch.


On 11/14/2016 08:03 PM, Christos Tsantilas wrote:
&gt;<i> The following sequence of events triggers this assertion:
</I>&gt;<i>   - The server sends an 1xx control message.
</I>&gt;<i>   - http.cc schedules ConnStateData::sendControlMsg call.
</I>&gt;<i>   - Before sendControlMsg is fired, http.cc detects an error (e.g., I/O
</I>&gt;<i> error or timeout) and starts writing the reply to the user.
</I>&gt;<i>   - The ConnStateData::sendControlMsg is fired, starts writing 1xx, and
</I>&gt;<i> hits the &quot;no concurrent writes&quot; assertion.
</I>&gt;<i>
</I>&gt;<i> We could only reproduce this sequence in the lab after changing Squid
</I>&gt;<i> code to trigger a timeout at the right moment, but the sequence looks
</I>&gt;<i> plausible. Other event sequences might result in the same outcome.
</I>&gt;<i>
</I>&gt;<i> To avoid concurrent writes, Squid now drops the control message if
</I>&gt;<i> Http::One::Server detects that a reply is already being written. Also,
</I>&gt;<i> ConnStateData delays reply writing until a pending control message write
</I>&gt;<i> has been completed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There is strong possibility that the bug fixing this patch is a variant
</I>&gt;<i> of the bug4174:
</I>&gt;<i>   <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4174">http://bugs.squid-cache.org/show_bug.cgi?id=4174</A>
</I>&gt;<i> However we are getting different backtrace.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is a Measurement Factory project.
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: Fix-r14945-assertion_failed_Write_cc_Not_ccb_active.patch
Type: text/x-patch
Size: 12186 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161115/fcfd5b31/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161115/fcfd5b31/attachment.bin</A>&gt;
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007232.html">[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
</A></li>
	<LI>Next message: <A HREF="007246.html">[squid-dev] [PATCH] Fixed Write.cc:41 &quot;!ccb-&gt;active()&quot; assertion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7240">[ date ]</a>
              <a href="thread.html#7240">[ thread ]</a>
              <a href="subject.html#7240">[ subject ]</a>
              <a href="author.html#7240">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
