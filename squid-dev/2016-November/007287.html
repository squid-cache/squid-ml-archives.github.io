<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] simplifying ssl_bump complexity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20simplifying%20ssl_bump%20complexity&In-Reply-To=%3Cc618a763-4b75-e01a-4811-d27a5aef3746%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007283.html">
   <LINK REL="Next"  HREF="007290.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] simplifying ssl_bump complexity</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20simplifying%20ssl_bump%20complexity&In-Reply-To=%3Cc618a763-4b75-e01a-4811-d27a5aef3746%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] simplifying ssl_bump complexity">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Nov 28 01:20:51 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007283.html">[squid-dev] [RFC] simplifying ssl_bump complexity
</A></li>
        <LI>Next message: <A HREF="007290.html">[squid-dev] [RFC] simplifying ssl_bump complexity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7287">[ date ]</a>
              <a href="thread.html#7287">[ thread ]</a>
              <a href="subject.html#7287">[ subject ]</a>
              <a href="author.html#7287">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/19/2016 07:06 PM, Amos Jeffries wrote:
&gt;<i> On 20/11/2016 12:08 p.m., Marcus Kool wrote:
</I>&gt;&gt;<i> The current ssl bump steps allow problematic configs where Squid
</I>&gt;&gt;<i> bumps or stares in one step and to splice in an other step,
</I>&gt;&gt;<i> which can be resolved (made impossible) in a new configuration syntax.
</I>
It would be nice to prohibit truly impossible actions at the syntax
level, but I suspect that the only way to make that possible is to focus
on final actions [instead of steps] and require at *most* one ssl_bump
rule for each of the supported final actions:

  ssl_bump splice    ...rules that define when to splice...
  ssl_bump bump      ...rules that define when to bump...
  ssl_bump terminate ...rules that define when to terminate...
  # no other ssl_bump lines allowed!

The current intermediate actions (peek and stare) would have to go into
the ACLs. There will be no ssl_bump rules for them at all. In other
words, the admin would be required to _always_ write an equivalent of

  if (a1() &amp;&amp; a2() &amp;&amp; ...)
  then
      splice
  elsif (b1() &amp;&amp; b2() &amp;&amp; ...)
  then
      bump
  elsif (c1() &amp;&amp; c2() &amp;&amp; ...)
  then
      terminate
  else
      splice or bump, depending on state
      (or some other default; this decision is secondary)
  endif

where a1(), b2(), and other functions/ACLs may peek or stare as needed
to get the required information.

I am not sure such a change is desirable, but it is worth considering, I
guess.

Please note that I am ignoring the directives/actions naming issue for now.


AFAICT, the syntax proposed by Amos (i.e., making stepN mandatory) does
not solve this particular problem at all:

  # Syntactically valid nonsense:
  ssl_bump_step1 splice all
  ssl_bump_step2 bump all


and neither is yours:

  # Syntactically valid nonsense?
  tls_server_hello passthrough all
  tls_client_hello terminate all


&gt;&gt;<i> Below is a new proposal to attempt to make the configuration
</I>&gt;&gt;<i> more intuitive and less prone for admin misunderstandings.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> First the admin must define if there is any bumping at all.
</I>&gt;&gt;<i> This could be done with
</I>&gt;&gt;<i> https_decryption on|off
</I>&gt;&gt;<i> This is similar to tls_new_connection peek|splice but much
</I>&gt;&gt;<i> more intuitive.
</I>
I do not see why

  https_decryption off

is more intuitive (or more precise) than

  ssl_bump splice all

especially after you consider the order of directives.

Again, I am ignoring the naming issue for now. You may assume any name
you want for any directive or ACL.


&gt;&gt;<i> Iff https_decryption is on:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) the &quot;connection&quot; step:
</I>&gt;&gt;<i> When a browser uses &quot;CONNECT &lt;FQDN&gt;&quot; Squid does not need to make
</I>&gt;&gt;<i> peek or splice decisions.
</I>&gt;&gt;<i> When Squid intercepts a connection to &quot;port 443 of &lt;IP&gt;&quot; no peek
</I>&gt;&gt;<i> or splice decision is made here any more.
</I>&gt;&gt;<i> This step becomes obsolete in the proposed configuration.
</I>
&gt;<i> I am still hoping that will happen. But also still getting pushback that
</I>&gt;<i> people want to terminate or splice without even looking at the
</I>&gt;<i> clear-text hello details.
</I>
I suspect that not looking at some SSL Hellos will always be needed
because some of those Hellos are not Hellos at all and it takes too much
time/resources for the SSL Hellos parser to detect some non-SSL Hellos.
Besides that, it is always nice to be able to selectively bypass the
complex Hello parser code in emergencies.


&gt;&gt;<i> 3) the &quot;TLS server hello&quot; step:
</I>&gt;&gt;<i> Usually no directives are needed since rarely actions are taken
</I>&gt;&gt;<i> based on the server hello message, so the default is
</I>&gt;&gt;<i> tls_server_hello continue
</I>&gt;<i> 
</I>&gt;<i> Once Squid gets to this stage of processing &quot;continue&quot; could mean either
</I>&gt;<i> splice or bump, but only one of the two is possible.
</I>&gt;<i> 
</I>&gt;<i> Bump is not legal in a lot of situations but splice may not be possible.
</I>&gt;<i> So terminate is the only realistic default we can set for general use.
</I>&gt;<i> As you say, its uncommon to need it, and people who do tend to know what
</I>&gt;<i> they want done. So will configure that.
</I>
Just like naming, the defaults are probably not that important yet: If
we can agree on the new configuration approach, then we probably will be
able to agree on the defaults.

However, all proposals have to decide how to distinguish stare from peek
during step2. Those two intermediate actions result in different bytes
on the wire so they cannot be mapped to a single verb like &quot;continue&quot;.


&gt;&gt;<i> An example configuration looks like this:
</I>&gt;&gt;<i> https_decryption on
</I>&gt;&gt;<i> acl banks tls::client_servername .bank1.example.org
</I>&gt;&gt;<i> acl no_sni tls::client_hello_missing_sni
</I>&gt;&gt;<i> acl no_handshake tls::handshake_failure
</I>&gt;&gt;<i> acl hacked_server tls::server_servername evil.example.com
</I>&gt;&gt;<i> tls_client_hello passthrough banks
</I>&gt;&gt;<i> tls_client_hello terminate no_sni
</I>&gt;&gt;<i> tls_client_hello passthrough no_handshake
</I>&gt;&gt;<i> tls_client_hello continue
</I>&gt;&gt;<i> tls_server_hello terminate hacked_server
</I>&gt;&gt;<i> tls_server_hello continue
</I>&gt;&gt;<i> tls_no_http passthrough
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The configuration directives as I proposed are IMO intuitive and
</I>&gt;&gt;<i> leave very little room for misunderstandings.
</I>
... if you use them correctly. However, the same is true for the current
directives so this is not really an illustration of improvement AFAICT.
For example, what does the following [mis]configuration do?

  https_decryption off
  tls_server_hello continue
  tls_server_hello terminate hacked_server
  https_decryption on
  tls_client_hello continue
  tls_client_hello passthrough banks

If I understand the proposals correctly, the above will probably splice
or perhaps bump everything but I am obviously not sure. I do not see an
an improvement as far as possible confusion/misunderstanding is concerned.

Again, I am ignoring the naming issue. If, for example, there is
consensus that &quot;passthrough&quot; is better than &quot;splice&quot; or &quot;continue2&quot; is
better than &quot;stare&quot; then we can, of course, add aliases and eventually
completely get rid of the old names. Let's focus on the functionality first.


Thank you,

Alex.

</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007283.html">[squid-dev] [RFC] simplifying ssl_bump complexity
</A></li>
	<LI>Next message: <A HREF="007290.html">[squid-dev] [RFC] simplifying ssl_bump complexity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7287">[ date ]</a>
              <a href="thread.html#7287">[ thread ]</a>
              <a href="subject.html#7287">[ subject ]</a>
              <a href="author.html#7287">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
