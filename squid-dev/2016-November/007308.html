<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fix If-None-Match processing and related bug 4169
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fix%20If-None-Match%20processing%20and%20related%20bug%204169&In-Reply-To=%3Ce44eb84e-c6b6-30cf-a8ce-967b78c02db5%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007307.html">
   <LINK REL="Next"  HREF="007315.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fix If-None-Match processing and related bug 4169</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fix%20If-None-Match%20processing%20and%20related%20bug%204169&In-Reply-To=%3Ce44eb84e-c6b6-30cf-a8ce-967b78c02db5%40measurement-factory.com%3E"
       TITLE="[squid-dev] Fix If-None-Match processing and related bug 4169">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov 29 22:42:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007307.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
        <LI>Next message: <A HREF="007315.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7308">[ date ]</a>
              <a href="thread.html#7308">[ thread ]</a>
              <a href="subject.html#7308">[ subject ]</a>
              <a href="author.html#7308">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/29/2016 02:23 PM, Amos Jeffries wrote:
&gt;<i> On 30/11/2016 1:47 a.m., Garri Djavadyan wrote:
</I>&gt;&gt;<i> On Tue, 2016-11-29 at 14:51 +0500, Garri Djavadyan wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Please review the attached patch prepared for r14958, it fixes the
</I>&gt;&gt;&gt;<i> If-
</I>&gt;&gt;&gt;<i> None-Match processing (incorrect logging [1]) and the bug [2] report
</I>&gt;&gt;&gt;<i> 4169 depending on the incorrect (IMO) behavior.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> An If-None-Match request for a non-matched (ETag) but cached object
</I>&gt;&gt;&gt;<i> should be processed as normal HIT.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [1] <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-November/013483.html">http://lists.squid-cache.org/pipermail/squid-users/2016-November/013483.html</A>
</I>&gt;&gt;&gt;<i> [2] <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4169">http://bugs.squid-cache.org/show_bug.cgi?id=4169</A>
</I>
&gt;&gt;<i> In the first version I
</I>&gt;&gt;<i> removed strings (not related to the fix) which mark a request as non-
</I>&gt;&gt;<i> IMS, because I thought the same request could not
</I>&gt;&gt;<i> enter processConditional twice and the removed actions are redundant.
</I>
I agree that the second version is better: Unless you are absolutely
sure, it is best to stay focused on the problem and leave the IMS
deletion code &quot;as is&quot; even if it may not be necessary. If you still
suspect it is not necessary, add a TODO comment to investigate separately.


&gt;<i> Checking this whole processConditional() sequence for compliance with
</I>&gt;<i> RFC 7232 and 7234 the rest of the logic seems to be fine except this case:
</I>&gt;<i> 
</I>&gt;<i> &lt;<A HREF="https://tools.ietf.org/html/rfc7234#section-4.3.2">https://tools.ietf.org/html/rfc7234#section-4.3.2</A>&gt;
</I>&gt;<i> &quot;
</I>&gt;<i>    If the field-value is &quot;*&quot;, or if the
</I>&gt;<i>    field-value is a list of entity-tags and at least one of them matches
</I>&gt;<i>    the entity-tag of the selected stored response,
</I>
&gt;<i> [ e-&gt;hasIfNoneMatchEtag(r) == false --&gt; !N == true ]
</I>
I am not sure I am interpreting your [...] mnemonic correctly, but
AFAICT, the patched code works when the RFC conditions quoted above are
_not_ meant:

&gt;<i>     if (r.header.has(Http::HdrType::IF_NONE_MATCH)) {
</I>&gt;<i>         if (!e-&gt;hasIfNoneMatchEtag(r)) {
</I>&gt;<i>             // RFC 2616: ignore IMS if If-None-Match did not match
</I>&gt;<i>             r.flags.ims = false;
</I>&gt;<i>             r.ims = -1;
</I>&gt;<i>             r.imslen = 0;
</I>&gt;<i>             r.header.delById(Http::HdrType::IF_MODIFIED_SINCE);
</I>&gt;<i>             http-&gt;logType = LOG_TCP_MISS;
</I>&gt;<i>             sendMoreData(result);
</I>&gt;<i>             return true;
</I>&gt;<i>         }
</I>

In other words, hasIfNoneMatchEtag() returns false and, hence, the
quoted code is executed when _none_ of the requested ETags matches the
cached ETag. The &quot;if If-None-Match did not match&quot; comment inside that
code agrees with this interpretation.

Thus, the recommended RFC action that you found does _not_ apply to the
fixed code:

&gt;<i>    a cache recipient
</I>&gt;<i>    SHOULD generate a 304 (Not Modified) response (using the metadata of
</I>&gt;<i>    the selected stored response) instead of sending that stored
</I>&gt;<i>    response.
</I>&gt;<i> &quot;
</I>

If you were talking about processConditional() code outside the if
statement fixed by Garri (i.e., when hasIfNoneMatchEtag() returns true),
then it appears to match the quoted requirement only if there is no IMS
header:

&gt;<i> if (!r.flags.ims) {
</I>&gt;<i>     // RFC 2616: if If-None-Match matched and there is no IMS,
</I>&gt;<i>     // reply with 304 Not Modified or 412 Precondition Failed
</I>&gt;<i>     sendNotModifiedOrPreconditionFailedError();
</I>&gt;<i>     return true;
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> // otherwise check IMS below to decide if we reply with 304 or 412
</I>&gt;<i> matchedIfNoneMatch = true;
</I>

If there is an IMS header, then Squid violates the following RFC 7232 MUST:

&gt;<i> A recipient MUST ignore If-Modified-Since if the request contains an
</I>&gt;<i> If-None-Match header field
</I>
The HTTP requirements changed here since RFC 2616, and we probably
should adjust the code to delete IMS header/flags after discovering the
If-None-Match header:

if (r.header.has(Http::HdrType::IF_NONE_MATCH)) {
    // RFC 7232: If-None-Match recipient MUST ignore IMS
    r.flags.ims = false;
    r.ims = -1;
    r.imslen = 0;
    r.header.delById(Http::HdrType::IF_MODIFIED_SINCE);

    if (e-&gt;hasIfNoneMatchEtag(r)) {
        sendNotModifiedOrPreconditionFailedError();
        return true;
    }

    // If-None-Match did not match; treat as an unconditional hit
    return false;
}

If the above sketch is correct, then the matchedIfNoneMatch variable may
become unnecessary.


HTH,

Alex.

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007307.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
	<LI>Next message: <A HREF="007315.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7308">[ date ]</a>
              <a href="thread.html#7308">[ thread ]</a>
              <a href="subject.html#7308">[ subject ]</a>
              <a href="author.html#7308">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
