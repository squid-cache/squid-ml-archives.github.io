<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] auth_schemes directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20auth_schemes%20directive&In-Reply-To=%3Cb4dc79bf-bf96-9c14-e70a-398548c082a2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007288.html">
   <LINK REL="Next"  HREF="007310.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] auth_schemes directive</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20auth_schemes%20directive&In-Reply-To=%3Cb4dc79bf-bf96-9c14-e70a-398548c082a2%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] auth_schemes directive">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 29 22:50:27 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007288.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
        <LI>Next message: <A HREF="007310.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7309">[ date ]</a>
              <a href="thread.html#7309">[ thread ]</a>
              <a href="subject.html#7309">[ subject ]</a>
              <a href="author.html#7309">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/11/2016 3:34 p.m., Alex Rousskov wrote:
&gt;<i> On 11/19/2016 02:15 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 19/11/2016 12:56 p.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;&gt;<i> This patch introduces a new 'auth_schemes' squid.conf directive.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This directive may be used to customize authentication
</I>&gt;&gt;&gt;<i> schemes presence and order in Squid's HTTP 401 (Unauthorized) and 407
</I>&gt;&gt;&gt;<i> (Proxy Authentication Required) responses. The defaults remain the same.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Also refactored configuration code for options with custom
</I>&gt;&gt;&gt;<i> ACL-controlled actions
</I>&gt;<i> 
</I>&gt;&gt;<i> -1. This patch is conflating two major feature additions.
</I>&gt;<i> 
</I>&gt;<i> The patch does not add two major features. It only adds one regular feature.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The logic changes adding support for access controls 'kind' other than
</I>&gt;&gt;<i> allow/deny should be proposed as a separate feature addition.
</I>&gt;<i> 
</I>&gt;<i> Squid already supports many actions other than allow/deny. AFAIK, the
</I>&gt;<i> proposed patch reduces code duplication in that existing code area while
</I>&gt;<i> reusing the already working approach. No logic changes related to
</I>&gt;<i> non-allow/deny actions are being proposed here. While splitting the code
</I>&gt;<i> improvements from the new feature may be possible, their coexistence
</I>&gt;<i> certainly does not warrant a -1 vote!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Secondly;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IMO the access control for schemes is implemented wrong.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For the past 10 years admin who have been requesting control over what
</I>&gt;&gt;<i> schemes get advertised to clients have been driven by two main use cases:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  1) segmented networks where auth is done differently on each segment
</I>&gt;&gt;<i> (ie WAN vs LAN) but all segments share the one proxy.
</I>&gt;&gt;<i>  - either access controls to prevent some scheme being advertised to one
</I>&gt;&gt;<i> segment,
</I>&gt;&gt;<i>  - or being able to use one scheme name in several different ways
</I>&gt;&gt;<i> (different helper or realm etc.) .
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Or being able to control the order of schemes presented to the user.
</I>
Any HTTP client implementation which was coded to be properly compliant
with RFC 2616 and 2617 *will not* obey any ordering presented by Squid.
(Yes that was relaxed in RFC723x, but only to &quot;ought to&quot; and most
clients still obey the older MUST requirement).

We *already* have ordering ability in squid.conf. Many users have tried
to make use of it. The fact that it is not solving their issues is a
good demonstration about why/how the above RFC requirement is a killer
for any attempt to use ordering to control the clients behaviour.

IE6 was a notable exception that did follow the ordering when Basic was
first and why that ordering of auth_param was made significant back in
the early Squid-2.x sometime. It is now almost completely dead/absent as
a client though.

The current worst problem is Safari - for exactly the opposite reason.
It demonstrably ignores the list of schemes and uses only (and forever
looping) its first choice of &quot;best&quot; scheme. No others are considered nor
attempted.

I'm also aware of Firefix NTLM issues and Java, but those are not order
related. Are there any other client software with scheme ordering issues
I should be aware of?


&gt;<i> 
</I>&gt;&gt;<i> To resolve (1) fully we will need to have multiple Config objects with
</I>&gt;&gt;<i> the same scheme name and different config details.
</I>&gt;<i> 
</I>&gt;<i> The use cases covered by the proposed patch do not need different
</I>&gt;<i> configurations for the same scheme.
</I>
Indeed, and that is probably why it works well for its own use cases.

&gt;<i> The proposed changes do not preclude
</I>&gt;<i> such future support. Moreover, such future support will not address some
</I>&gt;<i> of the use cases covered by the proposed patch. In other words, what has
</I>&gt;<i> been implemented and your suggestion are complementary, not mutually
</I>&gt;<i> exclusive.
</I>
For the use cases this patch resolves, that is true. For the other cases
my per-scheme ACLs proposal seeks to resolve as well, it is not.

We could add both ways. But that I expect will just lead to more
confusion. So lets try to avoid that.

&gt;<i> 
</I>&gt;&gt;<i> To add auth scheme access controls in a way that does not actively
</I>&gt;&gt;<i> prevent (1) from being implemented later IMO we need to add access
</I>&gt;&gt;<i> controls as a member of the Config object, *not* as a global access list.
</I>&gt;<i> 
</I>&gt;<i> Per-scheme access controls do not work for controlling the order of the
</I>&gt;<i> presented schemes. The order is currently hard-coded. The proposed patch
</I>&gt;<i> makes it configurable. Future patches may certainly add per scheme
</I>&gt;<i> access controls and other knobs as needed. I see no reason why the two
</I>&gt;<i> complementary mechanisms cannot coexist.
</I>
See above, ordering is provided already in current auth_param design.

My proposal uses that existing logic instead of adding a second config
setting that can contradict it and cause confusion.

For the uncommon case of needing different order of the same schemes for
different clients, multiple auth_param sections with different ACL lists
can be used. It is a little verbose, yes, but not a common need so as
you have argued in the past: we should not be optimizing for that type
of case at expense of the more common ones.


&gt;<i> 
</I>&gt;<i> Also, while working on the proposed feature, we have discovered why
</I>&gt;<i> adding per-scheme ACLs (or a special NONE value to auth_schemes) will
</I>&gt;<i> create a negative side effect that the posted implementation avoids: The
</I>&gt;<i> implemented code does not change authentication decision; auth_schemes
</I>&gt;<i> cannot accidentally create a situation where no schemes exist for a
</I>&gt;<i> transaction.
</I>
That is exactly the case in HTTP Authentication where 403 status code is
supposed to be used. It is explicitly one of the permitted auth states.

RFC 7231 section 6.5.3
&quot;
   The 403 (Forbidden) status code indicates that the server understood
   the request but refuses to authorize it.
   ...

   If authentication credentials were provided in the request, the
   server considers them insufficient to grant access.  The client
   SHOULD NOT automatically repeat the request with the same
   credentials.  The client MAY repeat the request with new or different
   credentials.  However, a request might be forbidden for reasons
   unrelated to the credentials.
&quot;

with some tie-in of &quot;reasons unrelated&quot; at the RFC 7235 section 2.1
final paragraph:
&quot;
   HTTP does not restrict applications to this simple challenge-response
   framework for access authentication.  Additional mechanisms can be
   used, such as authentication at the transport level or via message
   encapsulation, and with additional header fields specifying
   authentication information.  However, such additional mechanisms are
   not defined by this specification.
&quot;

Essentially anyone configuring these ACLs has constructed a non-standard
auth mechanism with additional special criteria surrounding the
credentials validity - and has told Squid how to process those extra
criteria in the form of ACL checks.


&gt;<i> Interpreting such a situation correctly is going to be
</I>&gt;<i> tricky: Does it mean &quot;allow access without authentication&quot; or &quot;deny
</I>&gt;<i> access&quot;? Or should Squid keep evaluating other http_access rules because
</I>&gt;<i> the decision/ACLs may change later?
</I>
It means 403 Forbidden in HTTP terms.

IMO, that means in terms of ACLs a non-match has ocured for the auth ACL
being tested.

For the external ACL case any credentials the client did supply should
be able to pass in to the helper but not as %LOGIN / %un, that should be
'-'.


&gt;<i> 
</I>&gt;<i> This &quot;NONE&quot; problem does not imply that multiple same-scheme
</I>&gt;<i> configurations are a bad idea, of course. It only illustrates why the
</I>&gt;<i> &quot;Should I use this configuration for scheme X?&quot; and &quot;What schemes should
</I>&gt;<i> I use for this transaction?&quot; are two different questions, each deserving
</I>&gt;<i> an answer in various real-world situations.
</I>&gt;<i> 
</I>&gt;<i> Please reconsider your initial evaluation.
</I>
I have and still do not want to see this go in as one change.

I'm happy with the structural/internal part making non-allow/deny
actions possible anywhere. If that were split from the auth_schemes
directive part it could go in immediately without another review IMO.

Amos

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007288.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
	<LI>Next message: <A HREF="007310.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7309">[ date ]</a>
              <a href="thread.html#7309">[ thread ]</a>
              <a href="subject.html#7309">[ subject ]</a>
              <a href="author.html#7309">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
