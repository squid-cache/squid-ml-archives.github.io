<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] auth_schemes directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20auth_schemes%20directive&In-Reply-To=%3C53866c4b-5b37-27bb-1f22-ad5e2893a005%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007310.html">
   <LINK REL="Next"  HREF="007312.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] auth_schemes directive</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20auth_schemes%20directive&In-Reply-To=%3C53866c4b-5b37-27bb-1f22-ad5e2893a005%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] auth_schemes directive">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov 30 03:35:45 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007310.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
        <LI>Next message: <A HREF="007312.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7311">[ date ]</a>
              <a href="thread.html#7311">[ thread ]</a>
              <a href="subject.html#7311">[ subject ]</a>
              <a href="author.html#7311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/11/2016 2:11 p.m., Alex Rousskov wrote:
&gt;<i> On 11/29/2016 03:50 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 28/11/2016 3:34 p.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> Or being able to control the order of schemes presented to the user.
</I>&gt;<i> 
</I>&gt;&gt;<i> Any HTTP client implementation which was coded to be properly compliant
</I>&gt;&gt;<i> with RFC 2616 and 2617 *will not* obey any ordering presented by Squid.
</I>&gt;&gt;<i> (Yes that was relaxed in RFC723x, but only to &quot;ought to&quot; and most
</I>&gt;&gt;<i> clients still obey the older MUST requirement).
</I>&gt;<i> 
</I>&gt;&gt;<i> IE6 was a notable exception that did follow the ordering when Basic was
</I>&gt;&gt;<i> first and why that ordering of auth_param was made significant back in
</I>&gt;&gt;<i> the early Squid-2.x sometime. It is now almost completely dead/absent as
</I>&gt;&gt;<i> a client though.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The current worst problem is Safari - for exactly the opposite reason.
</I>&gt;&gt;<i> It demonstrably ignores the list of schemes and uses only (and forever
</I>&gt;&gt;<i> looping) its first choice of &quot;best&quot; scheme. No others are considered nor
</I>&gt;&gt;<i> attempted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm also aware of Firefix NTLM issues and Java, but those are not order
</I>&gt;&gt;<i> related. Are there any other client software with scheme ordering issues
</I>&gt;&gt;<i> I should be aware of?
</I>&gt;<i> 
</I>&gt;<i> I find it ironic that you need to ask for more issues after listing a
</I>&gt;<i> well known issue and indicating that the protocol requirements have been
</I>&gt;<i> relaxed. For me, your own response is a good illustration that ordering
</I>&gt;<i> control is [at least marginally] useful!
</I>&gt;<i> 
</I>
No irony intended. If those are the only things driving the need for
ordering then we should probably drop order considerations entirely.

Considering just the allow/deny decision about whether any particular
scheme configuration should be used on a given request my proposal would
be the simplest implementation;

 one checklist object created outside the fixHeader() loop,
 fastCheck() the relevant access list for active schemes,
   continue the loop on denials,
 if no auth headers added when the loop ends,
   change status code to 403.

10-20 lines of code IIRC and about the same in docs text.

&gt;<i> 
</I>&gt;&gt;<i> We *already* have ordering ability in squid.conf. 
</I>&gt;<i> 
</I>&gt;<i> The existing ability is severely limited because it can accommodate at
</I>&gt;<i> most one unusual client. It is also rather awkward to configure.
</I>&gt;<i> 
</I>
Which appears to be IE and IE alone AFAIK. So nothing much gained by a
change there.

&gt;<i> 
</I>&gt;&gt;<i> Many users have tried
</I>&gt;&gt;<i> to make use of it. The fact that it is not solving their issues is a
</I>&gt;&gt;<i> good demonstration about why/how the above RFC requirement is a killer
</I>&gt;&gt;<i> for any attempt to use ordering to control the clients behaviour.
</I>&gt;<i> 
</I>&gt;<i> I am not sure how you reach that conclusion given the available
</I>&gt;<i> evidence. Yes, ordering alone cannot solve all the issues, but that does
</I>&gt;<i> not mean that properly supporting ACL-driven order is useless.
</I>&gt;<i> 
</I>&gt;<i> Said that, better ordering support is just one of several useful
</I>&gt;<i> properties of the proposed approach. Even if we are 100% positive that
</I>&gt;<i> nobody will ever need to control the order of schemes, the ability to
</I>&gt;<i> specify a list of schemes to use is still a nice/useful feature, and
</I>&gt;<i> will remain a nice/useful feature even after somebody adds support for
</I>&gt;<i> multiple configurations of the same scheme.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> To resolve (1) fully we will need to have multiple Config objects with
</I>&gt;&gt;&gt;&gt;<i> the same scheme name and different config details.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> The proposed changes do not preclude
</I>&gt;&gt;&gt;<i> such future support. Moreover, such future support will not address some
</I>&gt;&gt;&gt;<i> of the use cases covered by the proposed patch. In other words, what has
</I>&gt;&gt;&gt;<i> been implemented and your suggestion are complementary, not mutually
</I>&gt;&gt;&gt;<i> exclusive.
</I>&gt;<i> 
</I>&gt;&gt;<i> For the use cases this patch resolves, that is true. 
</I>&gt;<i> 
</I>&gt;<i> IMO, my statement is true for all use cases, both use cases covered by
</I>&gt;<i> the patch and use cases not covered by the patch: The two areas are
</I>&gt;<i> complementary, not mutually exclusive, regardless of the use cases.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> For the other cases
</I>&gt;&gt;<i> my per-scheme ACLs proposal seeks to resolve as well, it is not.
</I>&gt;<i> 
</I>&gt;<i> Which part of my statement is not true for those other cases?
</I>
The part about them not being &quot;complementary, not mutually exclusive&quot;.

They are mutually interferring on what would seem a reasonably average
config:

 auth_param basic ...
 auth_param ntlm ...
 auth_param ntlm access allow localhost

 auth_schemes ntlm,basic localnet
 auth_schemes basic,ntlm all

WTF?!! only Basic ever gets used.


Or one would think from the above that 'only Negotiate' would be the
outcome in this equivalent config:

 auth_param negotiate ...
 auth_param ntlm ...
 auth_param ntlm access allow localhost

 auth_schemes ntlm,negotiate localnet
 auth_schemes negotiate,ntlm all

Nope, NTLM gets used now. Even when its not offered (ie non-localhost
traffic).


Now some future code of an entirely different sort can fix that, but we
would still have a period of confusion to go through meanwhile.

And if we don't care about ordering (from up top reasons). Then which of
the two access lists gets implemented right away does not matter much.

&gt;<i> 
</I>&gt;&gt;<i> We could add both ways. But that I expect will just lead to more
</I>&gt;&gt;<i> confusion. So lets try to avoid that.
</I>&gt;<i> 
</I>&gt;<i> I agree that supporting two partially overlapping ways to configure used
</I>&gt;<i> authentication schemes will cause some confusion in some cases, but I
</I>&gt;<i> disagree that it will be the only outcome. The positive outcomes of
</I>&gt;<i> supporting both explicit scheme lists and multiple scheme configurations
</I>&gt;<i> outweigh the negatives IMO.
</I>
AFAICT we have pretty much narrowed the positives down to this patch
allowing multiple orderings of schemes. With accompanying evidence that
ordering is largely useless.

So no I dont agree at present that the positives outweight the
negatives. It is only outweighing the status-quo.

&gt;<i> 
</I>&gt;<i> However, we can and should also prevent any overlaps in coverage! The
</I>&gt;<i> already implemented code can be used to control scheme presence [and
</I>&gt;<i> order] while the proposed future code will control which configuration
</I>&gt;<i> is used for each used scheme. That divide-and-concur is the right/best
</I>&gt;<i> approach here. I should have thought of that earlier, but, fortunately,
</I>&gt;<i> this realization does not affect auth_schemes.
</I>&gt;<i> 
</I>&gt;&gt;<i> My proposal uses that existing logic instead of adding a second config
</I>&gt;&gt;<i> setting that can contradict it and cause confusion.
</I>&gt;<i> 
</I>&gt;<i> If your proposal implementation is limited to scheme configuration
</I>&gt;<i> selection (among multiple configurations for the same scheme), then
</I>&gt;<i> there will be no contradiction and confusion. Each feature will control
</I>&gt;<i> its own area.
</I>&gt;<i> 
</I>&gt;<i> * Want to control which schemes are used for transaction X?
</I>&gt;<i>   Use the implemented auth_schemes.
</I>&gt;<i> 
</I>&gt;<i> * Want to control which scheme configuration is used for used scheme S?
</I>&gt;<i>   Use [future feature].
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> For the uncommon case of needing different order of the same schemes for
</I>&gt;&gt;<i> different clients, multiple auth_param sections with different ACL lists
</I>&gt;&gt;<i> can be used. It is a little verbose, yes, but not a common need so as
</I>&gt;&gt;<i> you have argued in the past: we should not be optimizing for that type
</I>&gt;&gt;<i> of case at expense of the more common ones.
</I>&gt;<i> 
</I>&gt;<i> The implemented auth_schemes optimize a common case AFAICT. The future
</I>&gt;<i> scheme configuration selection code can also optimize its common case.
</I>&gt;<i> The features do not need to overlap, and each can focus on optimizing
</I>&gt;<i> its area.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Also, while working on the proposed feature, we have discovered why
</I>&gt;&gt;&gt;<i> adding per-scheme ACLs (or a special NONE value to auth_schemes) will
</I>&gt;&gt;&gt;<i> create a negative side effect that the posted implementation avoids: The
</I>&gt;&gt;&gt;<i> implemented code does not change authentication decision; auth_schemes
</I>&gt;&gt;&gt;<i> cannot accidentally create a situation where no schemes exist for a
</I>&gt;&gt;&gt;<i> transaction.
</I>&gt;<i> 
</I>&gt;&gt;<i> That is exactly the case in HTTP Authentication where 403 status code is
</I>&gt;&gt;<i> supposed to be used. It is explicitly one of the permitted auth states.
</I>&gt;<i> 
</I>&gt;<i> Explicitly forbidding access and wanting to authenticate but implicitly
</I>&gt;<i> running out of authentication schemes are very different cases. We
</I>
Running out of usable schemes is just non-credential criteria and may be
based on other header values ACL matching, not very different case at all.


&gt;<i> should not duplicate http_access functionality in auth_schemes or the
</I>
This is not http_access functaionality. This is the 403 response from
authentication attempt. With auth-failed status codes being 401 (www
credentials), 407 (proxy credentials) and 403 (other auth criteria).


&gt;<i> 
</I>&gt;&gt;&gt;<i>  The
</I>&gt;&gt;&gt;<i> &quot;Should I use this configuration for scheme X?&quot; and &quot;What schemes should
</I>&gt;&gt;&gt;<i> I use for this transaction?&quot; are two different questions, each deserving
</I>&gt;&gt;&gt;<i> an answer in various real-world situations.
</I>&gt;<i> 
</I>&gt;<i> The above is still a good summary of why you should not block
</I>&gt;<i> auth_schemes because you want Squid to support multiple scheme
</I>&gt;<i> configurations in the future. Prior to this email, I thought that what
</I>&gt;<i> you are proposing and what we have implemented can overlap. Now I am
</I>&gt;<i> fairly certain that they should not overlap but should complement each
</I>&gt;<i> other. In other words, they should be orthogonal questions/answers/features.
</I>&gt;<i> 
</I>
I've taken another read of the patch and am leaning towards agreeing to
the above separation despite what I think is a very limited gain.
  The docs will need to reflect that scoping.

Though I do think my proposal would prove to be more efficient if we can
put together some tests for comparing the two.

&gt;<i> 
</I>&gt;&gt;&gt;<i> Please reconsider your initial evaluation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have and still do not want to see this go in as one change.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm happy with the structural/internal part making non-allow/deny
</I>&gt;&gt;<i> actions possible anywhere. If that were split from the auth_schemes
</I>&gt;&gt;<i> directive part it could go in immediately without another review IMO.
</I>&gt;<i> 
</I>&gt;<i> Sure it can, but the deadlock is not in those code polishing changes. Do
</I>&gt;<i> you still block auth_schemes, even if it is committed separately from
</I>&gt;<i> those polishing changes? Or does your &quot;as one change&quot; imply that you are
</I>&gt;<i> removing your objection to auth_schems as such if it is committed
</I>&gt;<i> separately from the polishing changes?
</I>&gt;<i> 
</I>
I still want the split. If it helps clarify my reasons are basically;

 The new directive is UI change so is a v5 feature, excluded from v4 due
to where we are at in the release cycle.

 But the structural changes should probably still end up in v4 to
minimize future portage pain around all the other access controls touched.

 Also, each part is likely to result in (or allow fixing) different
types of bugs. The new directive in specifically auth related issues,
and the structural change more widespread ACL processing issues.


Amos

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007310.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
	<LI>Next message: <A HREF="007312.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7311">[ date ]</a>
              <a href="thread.html#7311">[ thread ]</a>
              <a href="subject.html#7311">[ subject ]</a>
              <a href="author.html#7311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
