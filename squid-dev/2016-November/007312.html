<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] auth_schemes directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20auth_schemes%20directive&In-Reply-To=%3C0b9552d0-381b-2223-a42d-d04fda0b9c7d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007311.html">
   <LINK REL="Next"  HREF="007327.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] auth_schemes directive</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20auth_schemes%20directive&In-Reply-To=%3C0b9552d0-381b-2223-a42d-d04fda0b9c7d%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] auth_schemes directive">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 30 07:06:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007311.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
        <LI>Next message: <A HREF="007327.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7312">[ date ]</a>
              <a href="thread.html#7312">[ thread ]</a>
              <a href="subject.html#7312">[ subject ]</a>
              <a href="author.html#7312">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/29/2016 08:35 PM, Amos Jeffries wrote:
&gt;<i> Considering just the allow/deny decision about whether any particular
</I>&gt;<i> scheme configuration should be used on a given request my proposal would
</I>&gt;<i> be the simplest implementation;
</I>&gt;<i> 
</I>&gt;<i>  one checklist object created outside the fixHeader() loop,
</I>&gt;<i>  fastCheck() the relevant access list for active schemes,
</I>&gt;<i>    continue the loop on denials,
</I>&gt;<i>  if no auth headers added when the loop ends,
</I>&gt;<i>    change status code to 403.
</I>
If we

* want to add 403 support as a side effect of running out of
authentication schemes (rather difficult to configure explicitly because
the decision to send 403 has to be made repeatedly for each scheme!),

* want to make configuring simple scheme lists more difficult, and

* do not want to improve scheme order support,

then the per-scheme access list is indeed a better approach! You are
essentially trading admin convenience/sanity for ease of implementation,
which is a strange trade since the implementation is already available.

The per-scheme access lists do have one advantage: They allow for simple
configuration of a &quot;do not send scheme S to user U&quot; exception when
multiple schemes are enabled. However, this advantage turns into a
problem in many cases (because an admin may accidentally run out of
schemes, because it is going to be difficult for the admin to visualize
the final list after many individual rules, and because it is a bad way
to control 403 responses explicitly).

Perhaps there is a way to keep the per-scheme access list advantage
without opening the 403 Pandora box and preserving the whole-list
visualization provided by auth_schemes?

For example, we could support something like this:

  auth_schemes &quot;ALL except S1&quot;    acl1 ...
  auth_schemes &quot;ALL except S1,S2&quot; acl2 ...
  auth_schemes S1,S2              acl3 ...
  auth_schemes ALL                acl4 ...

but I do not like how this syntax essentially moves operators inside
quoted strings.

Another alternative is:

  auth_schemes S1    deny  acl1 ... # ALL except S1
  auth_schemes S1,S2 deny  acl2 ... # ALL except S1 and S2
  auth_schemes S1,S2 allow acl3 ... # just S1 and S2
  auth_schemes ALL   allow acl4 ... # ALL

(with the configuration implementation similar to the existing
request_header_access rules).

Unfortunately, in all these cases, we would have to special-case
denying/excepting all schemes to avoid opening the 403 Pandora box. Only
the current auth_schemes implementation avoids that 403 problem (because
an empty list is a syntax-level/configure-time violation).


&gt;<i> The part about them not being &quot;complementary, not mutually exclusive&quot;.
</I>&gt;<i> They are mutually interferring on what would seem a reasonably average
</I>&gt;<i> config:
</I>
You are probably interpreting &quot;complementary&quot; as non-intersecting. I did
not mean it that way. I agree that if per-scheme access lists are
allowed to select which schemes are used (as opposed to which scheme
configurations are used), then there will be interference. I think we
agree that such interference is undesirable and can be avoided.


&gt;<i> AFAICT we have pretty much narrowed the positives down to this patch
</I>&gt;<i> allowing multiple orderings of schemes.
</I>
We have not. I doubt introducing implicitly controlled 403s is a good
idea, and I am sure some admins will appreciate the ability to specify
the whole list of schemes as a single parameter rather than trying to
construct it on the fly from individual pieces using properly ordered ACLs.


&gt;&gt;&gt;<i> That is exactly the case in HTTP Authentication where 403 status code is
</I>&gt;&gt;&gt;<i> supposed to be used. It is explicitly one of the permitted auth states.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Explicitly forbidding access and wanting to authenticate but implicitly
</I>&gt;&gt;<i> running out of authentication schemes are very different cases. We
</I>&gt;<i> 
</I>&gt;<i> Running out of usable schemes is just non-credential criteria and may be
</I>&gt;<i> based on other header values ACL matching, not very different case at all.
</I>
I disagree: Configuring ways to authenticate and denying access by
prohibiting authentication are different cases IMHO. Both may be based
on various header values, of course.


&gt;&gt;<i> should not duplicate http_access functionality in auth_schemes or the
</I>&gt;<i> 
</I>&gt;<i> This is not http_access functaionality. This is the 403 response from
</I>&gt;<i> authentication attempt. With auth-failed status codes being 401 (www
</I>&gt;<i> credentials), 407 (proxy credentials) and 403 (other auth criteria).
</I>
It is probably pointless to argue without enough use cases, but I
suspect that all three kinds of access denials should be controlled by
http_access, not schemes configuration/selection code.


&gt;&gt;&gt;&gt;<i>  The
</I>&gt;&gt;&gt;&gt;<i> &quot;Should I use this configuration for scheme X?&quot; and &quot;What schemes should
</I>&gt;&gt;&gt;&gt;<i> I use for this transaction?&quot; are two different questions, each deserving
</I>&gt;&gt;&gt;&gt;<i> an answer in various real-world situations.
</I>

&gt;<i> I've taken another read of the patch and am leaning towards agreeing to
</I>&gt;<i> the above separation despite what I think is a very limited gain.
</I>
Why? We do not seem to agree on any rationale items that back up one
approach versus the other. In other words, all your previous responses
seem to claim that auth_schemes offers no gain at all, but now you see
some. I am curious which agreement I missed; or perhaps you see some
auth_schemes advantage that we have not discussed?


&gt;<i>   The docs will need to reflect that scoping.
</I>
Sure. The implemented auth_scheme docs should not invade per-scheme
configuration selection territory, but we should double check.


&gt;<i> Though I do think my proposal would prove to be more efficient if we can
</I>&gt;<i> put together some tests for comparing the two.
</I>
The performance difference would depend on the configuration: If there
are fewer scheme lists than explicit per-scheme rules, then auth_schemes
win. Otherwise, per-scheme ACLs win.


&gt;<i> I still want the split.
</I>
Yes, that is understood.


&gt;<i> If it helps clarify my reasons are basically;
</I>&gt;<i> 
</I>&gt;<i> The new directive is UI change so is a v5 feature, excluded from v4 due
</I>&gt;<i> to where we are at in the release cycle.
</I>
This is a bogus reason IMO: Adding an optional configuration option is
not the kind of UI change that should matter for a v4/v5 boundary.


&gt;<i> But the structural changes should probably still end up in v4 to
</I>&gt;<i> minimize future portage pain around all the other access controls touched.
</I>
Sure.


&gt;<i> Also, each part is likely to result in (or allow fixing) different
</I>&gt;<i> types of bugs. The new directive in specifically auth related issues,
</I>&gt;<i> and the structural change more widespread ACL processing issues.
</I>
Yes, but if both end up in v4 and v5, then the time spent separating
them would be better spent elsewhere IMO.


Let's do another round in case we manage to improve the overall design
somehow (as discussed above). If that fails, we will start working on
separating auth_schemes from action code polishing so that each can be
committed separately per your request.


Thank you,

Alex.

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007311.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
	<LI>Next message: <A HREF="007327.html">[squid-dev] [PATCH] auth_schemes directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7312">[ date ]</a>
              <a href="thread.html#7312">[ thread ]</a>
              <a href="subject.html#7312">[ subject ]</a>
              <a href="author.html#7312">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
