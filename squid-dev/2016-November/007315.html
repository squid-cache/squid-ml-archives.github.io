<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Fix If-None-Match processing and related bug 4169
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fix%20If-None-Match%20processing%20and%20related%20bug%204169&In-Reply-To=%3C1480506246.7500.25.camel%40comnet.uz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007308.html">
   <LINK REL="Next"  HREF="007317.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Fix If-None-Match processing and related bug 4169</H1>
    <B>Garri Djavadyan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Fix%20If-None-Match%20processing%20and%20related%20bug%204169&In-Reply-To=%3C1480506246.7500.25.camel%40comnet.uz%3E"
       TITLE="[squid-dev] Fix If-None-Match processing and related bug 4169">garryd at comnet.uz
       </A><BR>
    <I>Wed Nov 30 11:44:06 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007308.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
        <LI>Next message: <A HREF="007317.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7315">[ date ]</a>
              <a href="thread.html#7315">[ thread ]</a>
              <a href="subject.html#7315">[ subject ]</a>
              <a href="author.html#7315">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2016-11-29 at 15:42 -0700, Alex Rousskov wrote:
&gt;<i> On 11/29/2016 02:23 PM, Amos Jeffries wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On 30/11/2016 1:47 a.m., Garri Djavadyan wrote:
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; On Tue, 2016-11-29 at 14:51 +0500, Garri Djavadyan wrote:
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; Hello,
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; Please review the attached patch prepared for r14958, it fixes
</I>&gt;<i> &gt; &gt; &gt; the
</I>&gt;<i> &gt; &gt; &gt; If-
</I>&gt;<i> &gt; &gt; &gt; None-Match processing (incorrect logging [1]) and the bug [2]
</I>&gt;<i> &gt; &gt; &gt; report
</I>&gt;<i> &gt; &gt; &gt; 4169 depending on the incorrect (IMO) behavior.
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; An If-None-Match request for a non-matched (ETag) but cached
</I>&gt;<i> &gt; &gt; &gt; object
</I>&gt;<i> &gt; &gt; &gt; should be processed as normal HIT.
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; [1] <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-Nov">http://lists.squid-cache.org/pipermail/squid-users/2016-Nov</A>
</I>&gt;<i> &gt; &gt; &gt; ember/013483.html
</I>&gt;<i> &gt; &gt; &gt; [2] <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4169">http://bugs.squid-cache.org/show_bug.cgi?id=4169</A>
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; In the first version I
</I>&gt;<i> &gt; &gt; removed strings (not related to the fix) which mark a request as
</I>&gt;<i> &gt; &gt; non-
</I>&gt;<i> &gt; &gt; IMS, because I thought the same request could not
</I>&gt;<i> &gt; &gt; enter processConditional twice and the removed actions are
</I>&gt;<i> &gt; &gt; redundant.
</I>&gt;<i> 
</I>&gt;<i> I agree that the second version is better: Unless you are absolutely
</I>&gt;<i> sure, it is best to stay focused on the problem and leave the IMS
</I>&gt;<i> deletion code &quot;as is&quot; even if it may not be necessary. If you still
</I>&gt;<i> suspect it is not necessary, add a TODO comment to investigate
</I>&gt;<i> separately.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Checking this whole processConditional() sequence for compliance
</I>&gt;<i> &gt; with
</I>&gt;<i> &gt; RFC 7232 and 7234 the rest of the logic seems to be fine except
</I>&gt;<i> &gt; this case:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &lt;<A HREF="https://tools.ietf.org/html/rfc7234#section-4.3.2">https://tools.ietf.org/html/rfc7234#section-4.3.2</A>&gt;
</I>&gt;<i> &gt; &quot;
</I>&gt;<i> &gt;    If the field-value is &quot;*&quot;, or if the
</I>&gt;<i> &gt;    field-value is a list of entity-tags and at least one of them
</I>&gt;<i> &gt; matches
</I>&gt;<i> &gt;    the entity-tag of the selected stored response,
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; [ e-&gt;hasIfNoneMatchEtag(r) == false --&gt; !N == true ]
</I>&gt;<i> 
</I>&gt;<i> I am not sure I am interpreting your [...] mnemonic correctly, but
</I>&gt;<i> AFAICT, the patched code works when the RFC conditions quoted above
</I>&gt;<i> are
</I>&gt;<i> _not_ meant:
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     if (r.header.has(Http::HdrType::IF_NONE_MATCH)) {
</I>&gt;<i> &gt;         if (!e-&gt;hasIfNoneMatchEtag(r)) {
</I>&gt;<i> &gt;             // RFC 2616: ignore IMS if If-None-Match did not match
</I>&gt;<i> &gt;             r.flags.ims = false;
</I>&gt;<i> &gt;             r.ims = -1;
</I>&gt;<i> &gt;             r.imslen = 0;
</I>&gt;<i> &gt;             r.header.delById(Http::HdrType::IF_MODIFIED_SINCE);
</I>&gt;<i> &gt;             http-&gt;logType = LOG_TCP_MISS;
</I>&gt;<i> &gt;             sendMoreData(result);
</I>&gt;<i> &gt;             return true;
</I>&gt;<i> &gt;         }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In other words, hasIfNoneMatchEtag() returns false and, hence, the
</I>&gt;<i> quoted code is executed when _none_ of the requested ETags matches
</I>&gt;<i> the
</I>&gt;<i> cached ETag. The &quot;if If-None-Match did not match&quot; comment inside that
</I>&gt;<i> code agrees with this interpretation.
</I>&gt;<i> 
</I>&gt;<i> Thus, the recommended RFC action that you found does _not_ apply to
</I>&gt;<i> the
</I>&gt;<i> fixed code:
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;    a cache recipient
</I>&gt;<i> &gt;    SHOULD generate a 304 (Not Modified) response (using the
</I>&gt;<i> &gt; metadata of
</I>&gt;<i> &gt;    the selected stored response) instead of sending that stored
</I>&gt;<i> &gt;    response.
</I>&gt;<i> &gt; &quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If you were talking about processConditional() code outside the if
</I>&gt;<i> statement fixed by Garri (i.e., when hasIfNoneMatchEtag() returns
</I>&gt;<i> true),
</I>&gt;<i> then it appears to match the quoted requirement only if there is no
</I>&gt;<i> IMS
</I>&gt;<i> header:
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; if (!r.flags.ims) {
</I>&gt;<i> &gt;     // RFC 2616: if If-None-Match matched and there is no IMS,
</I>&gt;<i> &gt;     // reply with 304 Not Modified or 412 Precondition Failed
</I>&gt;<i> &gt;     sendNotModifiedOrPreconditionFailedError();
</I>&gt;<i> &gt;     return true;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; // otherwise check IMS below to decide if we reply with 304 or 412
</I>&gt;<i> &gt; matchedIfNoneMatch = true;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If there is an IMS header, then Squid violates the following RFC 7232
</I>&gt;<i> MUST:
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; A recipient MUST ignore If-Modified-Since if the request contains
</I>&gt;<i> &gt; an
</I>&gt;<i> &gt; If-None-Match header field
</I>&gt;<i> 
</I>&gt;<i> The HTTP requirements changed here since RFC 2616, and we probably
</I>&gt;<i> should adjust the code to delete IMS header/flags after discovering
</I>&gt;<i> the
</I>&gt;<i> If-None-Match header:
</I>&gt;<i> 
</I>&gt;<i> if (r.header.has(Http::HdrType::IF_NONE_MATCH)) {
</I>&gt;<i>     // RFC 7232: If-None-Match recipient MUST ignore IMS
</I>&gt;<i>     r.flags.ims = false;
</I>&gt;<i>     r.ims = -1;
</I>&gt;<i>     r.imslen = 0;
</I>&gt;<i>     r.header.delById(Http::HdrType::IF_MODIFIED_SINCE);
</I>&gt;<i> 
</I>&gt;<i>     if (e-&gt;hasIfNoneMatchEtag(r)) {
</I>&gt;<i>         sendNotModifiedOrPreconditionFailedError();
</I>&gt;<i>         return true;
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     // If-None-Match did not match; treat as an unconditional hit
</I>&gt;<i>     return false;
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> If the above sketch is correct, then the matchedIfNoneMatch variable
</I>&gt;<i> may
</I>&gt;<i> become unnecessary.
</I>
Alex, Amos thanks for comments! I've attached third version of the
patch. It is based on the proposal by Alex. The patch introduces
following changes:

* Matched If-None-Match requests are logged as TCP_INM_HIT (proposed by
Amos)
* If-Modified-Since requests for modified cached objects are processed
as normal HITs
* Not matched If-None-Match requests for cached objects are processed
as normal HITs
* If-Modified-Since header is ignored if If-None-Match header exists
(RFC7232 compliance) 

I've tested different conditional requests (including 'If-None-Match:
*' and 'If-None-Match: &quot;matched-tag&quot;, &quot;not-matched-tag&quot;') and found no
problems. Thanks.

Garri
-------------- next part --------------
A non-text attachment was scrubbed...
Name: fix_if-none-match_v3.patch
Type: text/x-patch
Size: 3789 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161130/747828d1/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161130/747828d1/attachment.bin</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007308.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
	<LI>Next message: <A HREF="007317.html">[squid-dev] Fix If-None-Match processing and related bug 4169
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7315">[ date ]</a>
              <a href="thread.html#7315">[ thread ]</a>
              <a href="subject.html#7315">[ subject ]</a>
              <a href="author.html#7315">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
