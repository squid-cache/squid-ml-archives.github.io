<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] convert DNS shutdown to runner
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20convert%20DNS%20shutdown%20to%20runner&In-Reply-To=%3C711e5534-3230-2b79-5290-658a8c3e5f51%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006916.html">
   <LINK REL="Next"  HREF="006914.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] convert DNS shutdown to runner</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20convert%20DNS%20shutdown%20to%20runner&In-Reply-To=%3C711e5534-3230-2b79-5290-658a8c3e5f51%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] convert DNS shutdown to runner">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Oct  3 04:34:19 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006916.html">[squid-dev] [PATCH] convert DNS shutdown to runner
</A></li>
        <LI>Next message: <A HREF="006914.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6917">[ date ]</a>
              <a href="thread.html#6917">[ thread ]</a>
              <a href="subject.html#6917">[ subject ]</a>
              <a href="author.html#6917">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/10/2016 1:29 p.m., Alex Rousskov wrote:
&gt;<i> On 10/02/2016 06:35 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> This patch adds a Runner to manage the DNS component state on shutdown
</I>&gt;&gt;<i> (and the matching reconfigure port closures). The actions taken on
</I>&gt;&gt;<i> reconfigure and shutdown are not changed, just their timing.
</I>&gt;<i> 
</I>&gt;&gt;<i> +    RunRegisteredHere(RegisteredRunner::startReconfigure);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i>      // Initiate asynchronous closing sequence
</I>&gt;&gt;<i>      serverConnectionsClose();
</I>&gt;&gt;<i>      icpClosePorts();
</I>&gt;&gt;<i>  #if USE_HTCP
</I>&gt;&gt;<i>      htcpClosePorts();
</I>&gt;&gt;<i>  #endif
</I>&gt;&gt;<i> -    Dns::Shutdown();
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Have you checked that serverConnectionsClose(), icpClosePorts(), and
</I>&gt;<i> htcpClosePorts() (and the processing they trigger) can live without DNS?
</I>&gt;<i> I am not saying they cannot. I am just asking whether we are just hoping
</I>&gt;<i> that they can or reasonably certain that they can. Either way, please
</I>&gt;<i> reflect the answer in the commit message.
</I>&gt;<i> 
</I>
Those do not require working DNS to receive transactions. But may
require it for later async processing steps, logging at the very least.

While looking into that I found that the above is already a problem
simply due to the DNS sockets being closed by the existing code.
Anything which is partially processed and continues some Calls or events
during the reconfigure delay races against the DNS re-opening and
idnsSednQuery() will drop the query objects if sockets are closed when
they try to lookup, or no NS are configured.

Added an XXX note to highlight that race problem. When DNS is refactored
for actual HotConf that will need to be attended to. For this patch it
is existing behaviour.

&gt;<i> 
</I>&gt;&gt;<i> Visible differences are now that Squid logs when DNS ports are being
</I>&gt;&gt;<i> closed (and the reason)
</I>&gt;<i> 
</I>&gt;&gt;<i> +    debugs(78, DBG_IMPORTANT, reason &lt;&lt; &quot;: Closing DNS sockets&quot;);
</I>&gt;<i> 
</I>&gt;<i> IMHO, there is nothing important about it. Reconfiguration and shutting
</I>&gt;<i> down is already logged. The [changing] details of that long process are
</I>&gt;<i> not important [to admins]. I suggest changing the debug level to 2, but
</I>&gt;<i> I cannot not insist on it -- cache.log is already filled with noise.
</I>&gt;<i> 
</I>
Done.

&gt;<i> 
</I>&gt;&gt;<i> +    /// Meant for halting any active modules that could be triggered by external
</I>&gt;&gt;<i> +    /// events (such as listening ports) while changing their configuration.
</I>&gt;<i> 
</I>&gt;<i> I suggest something a lot more general, like &quot;Meant for modules that
</I>&gt;<i> need to prepare for their configuration being changed [outside their
</I>&gt;<i> control]. The changes end with the syncConfig() event.&quot;
</I>
Done.

&gt;<i> 
</I>&gt;<i> All of the above can be adjusted during commit IMO.
</I>&gt;<i> 
</I>
Thanks for the review. Applied as Squid-4 rev.14863.

Amos

</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006916.html">[squid-dev] [PATCH] convert DNS shutdown to runner
</A></li>
	<LI>Next message: <A HREF="006914.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6917">[ date ]</a>
              <a href="thread.html#6917">[ thread ]</a>
              <a href="subject.html#6917">[ subject ]</a>
              <a href="author.html#6917">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
