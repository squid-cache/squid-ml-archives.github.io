<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Squid 3.5.23: crash in Comm::DoSelect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Squid%203.5.23%3A%20crash%20in%20Comm%3A%3ADoSelect&In-Reply-To=%3CCAFfuDwxbaoy7mohQK%2B7P2tO61vQqOffpN1bMSW%2BA75Wx1DELTg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007094.html">
   <LINK REL="Next"  HREF="007103.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Squid 3.5.23: crash in Comm::DoSelect</H1>
    <B>oleg gv</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Squid%203.5.23%3A%20crash%20in%20Comm%3A%3ADoSelect&In-Reply-To=%3CCAFfuDwxbaoy7mohQK%2B7P2tO61vQqOffpN1bMSW%2BA75Wx1DELTg%40mail.gmail.com%3E"
       TITLE="[squid-dev] Squid 3.5.23: crash in Comm::DoSelect">oagvozd at gmail.com
       </A><BR>
    <I>Wed Oct 19 10:59:19 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007094.html">[squid-dev] Squid 3.5.23: crash in Comm::DoSelect
</A></li>
        <LI>Next message: <A HREF="007103.html">[squid-dev] Squid 3.5.23: crash in Comm::DoSelect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7098">[ date ]</a>
              <a href="thread.html#7098">[ thread ]</a>
              <a href="subject.html#7098">[ subject ]</a>
              <a href="author.html#7098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> SQUID_MAXFD == 256, but Sqid_MaxFD == 4096, and SQUID_MAXFD_LIMIT == 1024
it's like, that some code uses SQUID_MAXFD, and some Squid_MaxFD
 it's looks that it is supposed, that SQUID_MAXFD always &gt;= Squid_MaxFD,
but in main.cc there is possibility to get Squis_MaxFD &gt; SQUID_MAXFD (in
getrlimit branch: setMaxFD)
so, it looks like architecture bug that we can't fix, sorry.
but in our case we will try to sync all values to 1024, hope it helps to
fix bug in squid.

2016-10-18 17:48 GMT+03:00 Alex Rousskov &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt;:

&gt;<i> On 10/18/2016 03:44 AM, oleg gv wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; nfds=284, so loop ends on 283 and pfds[283] is buggy
</I>&gt;<i>
</I>&gt;<i> &gt; I/o module is  src/comm/ModPoll.cc, method Comm::DoSelect(int msec)
</I>&gt;<i> &gt; On stack we see that pfds[SQUID_MAXFD=256], so is less than nfds in loop.
</I>&gt;<i> &gt; May be malloc nfds?
</I>&gt;<i>
</I>&gt;<i> If your maxfd is bigger than SQUID_MAXFD than the bug is elsewhere and
</I>&gt;<i> dynamically allocating pfds is not the right fix (even though it will
</I>&gt;<i> &quot;work&quot;).
</I>&gt;<i>
</I>&gt;<i> I suspect your Squid is creating creating or accepting a descriptor that
</I>&gt;<i> exceeds SQUID_MAXFD-1. Biggest_FD+1 cannot be allowed to exceed the
</I>&gt;<i> misnamed SQUID_MAXFD limit.
</I>&gt;<i>
</I>&gt;<i> This combination looks like a big red flag to me:
</I>&gt;<i>
</I>&gt;<i>     struct pollfd pfds[SQUID_MAXFD];
</I>&gt;<i>     ...
</I>&gt;<i>     maxfd = Biggest_FD + 1;
</I>&gt;<i>     for (int i = 0; i &lt; maxfd; ++i) {
</I>&gt;<i>         ...
</I>&gt;<i>         pfds[nfds].fd = i;
</I>&gt;<i>
</I>&gt;<i> That code is missing assert(maxfd &lt;= SQUID_MAXFD) which will fail in
</I>&gt;<i> your case.
</I>&gt;<i>
</I>&gt;<i> If you want a workaround, try building Squid with a reasonable number of
</I>&gt;<i> maximum descriptors (e.g., 16K, 32K, or 64K). If that number is never
</I>&gt;<i> reached in your environment, the code will appear to work.
</I>&gt;<i>
</I>&gt;<i> If you want to try a quick fix, replace SQUID_MAXFD with (Biggest_FD +
</I>&gt;<i> 1) when declaring pfds. You may need to ignore/disable compiler warnings
</I>&gt;<i> about C++ arrays with dynamic sizes. Alternatively, you can allocate
</I>&gt;<i> pfds dynamically (as you suggested).
</I>&gt;<i>
</I>&gt;<i> If you want to fix the bug, audit all Biggest_FD- and
</I>&gt;<i> SQUID_MAXFD-related code to make sure the two are always in sync.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2016-10-18 8:29 GMT+03:00 Amos Jeffries:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     FYI: Squid-3.5.23 does not exist yet. What is the output of &quot;squid
</I>&gt;<i> -v&quot; ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 18/10/2016 5:01 a.m., oleg gv wrote:
</I>&gt;<i> &gt;     &gt; I have big traffic (at least 100 computers) , and squid often
</I>&gt;<i> crashed in
</I>&gt;<i> &gt;     &gt; Comm::DoSelect(int msec) function.
</I>&gt;<i> &gt;     &gt; I have interception mode and NAT redirect.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; In coredump I saw then bug is in next fragment of code:
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; 446│         for (size_t loopIndex = 0; loopIndex &lt; nfds;
</I>&gt;<i> ++loopIndex) {
</I>&gt;<i> &gt;     &gt; 447│             fde *F;
</I>&gt;<i> &gt;     &gt; 448│             int revents = pfds[loopIndex].revents;
</I>&gt;<i> &gt;     &gt; 449│             fd = pfds[loopIndex].fd;
</I>&gt;<i> &gt;     &gt; 450│
</I>&gt;<i> &gt;     &gt; 451│             if (fd == -1)
</I>&gt;<i> &gt;     &gt; 452│                 continue;
</I>&gt;<i> &gt;     &gt; 453│
</I>&gt;<i> &gt;     &gt; 454├&gt;            if (fd_table[fd].flags.read_pending)
</I>&gt;<i> &gt;     &gt; 455│                 revents |= POLLIN;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; SIGSEGV occured often (about 1 time in a minute) in line 454 :
</I>&gt;<i> fd=-66012128
</I>&gt;<i> &gt;     &gt; , loopindex=283
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; (gdb) p pfds[282]
</I>&gt;<i> &gt;     &gt; $17 = {fd = 291, events = 64, revents = 0}   -- looks ok
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; (gdb) p pfds[283]
</I>&gt;<i> &gt;     &gt; $18 = {fd = -66012128, events = 32595, revents = 0}  -- looks
</I>&gt;<i> strange and
</I>&gt;<i> &gt;     &gt; spoiled
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; (gdb) p Biggest_FD
</I>&gt;<i> &gt;     &gt; $19 = 292
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     What is the nfds value ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     It looks to me like only 282 FD have operations to perform on this
</I>&gt;<i> I/O
</I>&gt;<i> &gt;     cycle.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     What I/O module is being used?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      src/comm/ModDevPoll.cc:Comm::DoSelect(int msec)
</I>&gt;<i> &gt;      src/comm/ModPoll.cc:Comm::DoSelect(int msec)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Amos
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     _______________________________________________
</I>&gt;<i> &gt;     squid-dev mailing list
</I>&gt;<i> &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A> &lt;mailto:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-</A>
</I>&gt;<i> cache.org&gt;
</I>&gt;<i> &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-dev mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161019/59331c21/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161019/59331c21/attachment-0001.html</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007094.html">[squid-dev] Squid 3.5.23: crash in Comm::DoSelect
</A></li>
	<LI>Next message: <A HREF="007103.html">[squid-dev] Squid 3.5.23: crash in Comm::DoSelect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7098">[ date ]</a>
              <a href="thread.html#7098">[ thread ]</a>
              <a href="subject.html#7098">[ subject ]</a>
              <a href="author.html#7098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
