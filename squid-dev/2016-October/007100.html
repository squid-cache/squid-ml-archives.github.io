<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Support%20tunneling%20of%20bumped%20non-HTTP%0A%20traffic.%20Other%20SslBump%20fixes.&In-Reply-To=%3C03fe40fe-2978-6b75-343b-a233c3737b98%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007099.html">
   <LINK REL="Next"  HREF="007101.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Support%20tunneling%20of%20bumped%20non-HTTP%0A%20traffic.%20Other%20SslBump%20fixes.&In-Reply-To=%3C03fe40fe-2978-6b75-343b-a233c3737b98%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct 19 16:13:15 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007099.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
        <LI>Next message: <A HREF="007101.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7100">[ date ]</a>
              <a href="thread.html#7100">[ thread ]</a>
              <a href="subject.html#7100">[ subject ]</a>
              <a href="author.html#7100">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/19/2016 08:49 AM, Christos Tsantilas wrote:
&gt;<i> I am attaching a new patch.
</I>
I would like to discuss two issues:


* Logging of scheme-less URLs

&gt;<i> This is defines a new proto the PROTO_TCP, and for this prints the url
</I>&gt;<i> in the form host:port.
</I>
The PROTO_TCP name sounds bad because we may want to log
<A HREF="tcp://host:port/">tcp://host:port/</A> URLs in the future as discussed earlier.

PROTO_NONE and PROTO_UNKNOWN are already utilized for different _valid_
use cases. I suggest adding PROTO_AUTHORITY or PROTO_AUTHORITY_FORM
instead of adding PROTO_TCP.


* flags.tunneling

AFAIK, you added flags.tunneling specifically to work around the
tunneling request removal from the ConnStateData pipeline (trunk commit
r14418 &quot;Cleanup: Refactor ConnStateData pipeline handling&quot;). The
justification for that removal is given in the corresponding commit
message (thank you, Amos!):

&gt;<i> Initial testing revealed CONNECT tunnels always being logged as ABORTED.
</I>&gt;<i> [..] I have now made the context be finished() just prior to the
</I>&gt;<i> TunnelStateData being destroyed. That way normal closure should show up
</I>&gt;<i> only as TUNNEL, but timeouts and I/O errors should still be recorded as
</I>&gt;<i> abnormal.
</I>
That explanation makes sense to me -- when we know that the request has
finished successfully, we should call its finished() method.

AFAICT, the flags.tunneling is currently needed specifically because the
following ConnStateData::checkLogging() condition is [sometimes] false
when the pipeline is empty and we are done tunneling:

&gt;<i>     // do not log connections that closed after a transaction (it is normal)
</I>&gt;<i>     if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
</I>&gt;<i>         return;
</I>
Instead of adding flags.tunneling, can we fix/adjust that condition
and/or the code that affects its components to make the condition true?

receivedFirstByte_: This member remains false if we splice and tunnel
intercepted connections during step1 because we read no bytes at that
time, right? However, it feels like this part of the condition should be
not receivedFirstByte_ but something like thereWasAtLeastOne (i.e., we
pushed at least one request into ConnStateData pipeline). Can we adjust
the pipeline code to remember that at least one request has been queued
and use that instead of receivedFirstByte_ here.

inBuf.isEmpty(): That part of the condition looks correct to me. If it
is false in the tunneling case being discussed, then we need to fix the
code to clean inBuf when tunneling starts.

In summary, can we do something like this instead:

// do not log connections that closed after a transaction (it is normal)
if (pipeline.used() &amp;&amp; inBuf.isEmpty())
    return;


Thank you,

Alex.


&gt;<i>  const SBuf &amp;
</I>&gt;<i>  HttpRequest::effectiveRequestUri() const
</I>&gt;<i>  {
</I>&gt;<i> -    if (method.id() == Http::METHOD_CONNECT)
</I>&gt;<i> +    if (method.id() == Http::METHOD_CONNECT || url.getScheme() == AnyP::PROTO_TCP)
</I>&gt;<i>          return url.authority(true); // host:port
</I>&gt;<i>      return url.absolute();
</I>&gt;<i>  }
</I>


</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007099.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
	<LI>Next message: <A HREF="007101.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7100">[ date ]</a>
              <a href="thread.html#7100">[ thread ]</a>
              <a href="subject.html#7100">[ subject ]</a>
              <a href="author.html#7100">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
