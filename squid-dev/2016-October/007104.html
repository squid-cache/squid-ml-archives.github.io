<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Support%20tunneling%20of%20bumped%20non-HTTP%0A%20traffic.%20Other%20SslBump%20fixes.&In-Reply-To=%3Ceb73b3e0-7b16-94ee-f1ed-36064e626059%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007101.html">
   <LINK REL="Next"  HREF="007139.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Support%20tunneling%20of%20bumped%20non-HTTP%0A%20traffic.%20Other%20SslBump%20fixes.&In-Reply-To=%3Ceb73b3e0-7b16-94ee-f1ed-36064e626059%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.">christos at chtsanti.net
       </A><BR>
    <I>Thu Oct 20 14:55:40 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007101.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
        <LI>Next message: <A HREF="007139.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7104">[ date ]</a>
              <a href="thread.html#7104">[ thread ]</a>
              <a href="subject.html#7104">[ subject ]</a>
              <a href="author.html#7104">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am attaching  new patch.


On 10/19/2016 07:13 PM, Alex Rousskov wrote:
&gt;<i> On 10/19/2016 08:49 AM, Christos Tsantilas wrote:
</I>&gt;&gt;<i> I am attaching a new patch.
</I>&gt;<i>
</I>&gt;<i> I would like to discuss two issues:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * Logging of scheme-less URLs
</I>&gt;<i>
</I>&gt;&gt;<i> This is defines a new proto the PROTO_TCP, and for this prints the url
</I>&gt;&gt;<i> in the form host:port.
</I>&gt;<i>
</I>&gt;<i> The PROTO_TCP name sounds bad because we may want to log
</I>&gt;<i> <A HREF="tcp://host:port/">tcp://host:port/</A> URLs in the future as discussed earlier.
</I>&gt;<i>
</I>&gt;<i> PROTO_NONE and PROTO_UNKNOWN are already utilized for different _valid_
</I>&gt;<i> use cases. I suggest adding PROTO_AUTHORITY or PROTO_AUTHORITY_FORM
</I>&gt;<i> instead of adding PROTO_TCP.
</I>
I used the PROTO_AUTHORITY_FORM.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * flags.tunneling
</I>
removed now.

&gt;<i>
</I>&gt;<i> AFAIK, you added flags.tunneling specifically to work around the
</I>&gt;<i> tunneling request removal from the ConnStateData pipeline (trunk commit
</I>&gt;<i> r14418 &quot;Cleanup: Refactor ConnStateData pipeline handling&quot;). The
</I>&gt;<i> justification for that removal is given in the corresponding commit
</I>&gt;<i> message (thank you, Amos!):
</I>&gt;<i>
</I>&gt;&gt;<i> Initial testing revealed CONNECT tunnels always being logged as ABORTED.
</I>&gt;&gt;<i> [..] I have now made the context be finished() just prior to the
</I>&gt;&gt;<i> TunnelStateData being destroyed. That way normal closure should show up
</I>&gt;&gt;<i> only as TUNNEL, but timeouts and I/O errors should still be recorded as
</I>&gt;&gt;<i> abnormal.
</I>&gt;<i>
</I>&gt;<i> That explanation makes sense to me -- when we know that the request has
</I>&gt;<i> finished successfully, we should call its finished() method.
</I>&gt;<i>
</I>&gt;<i> AFAICT, the flags.tunneling is currently needed specifically because the
</I>&gt;<i> following ConnStateData::checkLogging() condition is [sometimes] false
</I>&gt;<i> when the pipeline is empty and we are done tunneling:
</I>&gt;<i>
</I>&gt;&gt;<i>     // do not log connections that closed after a transaction (it is normal)
</I>&gt;&gt;<i>     if (receivedFirstByte_ &amp;&amp; inBuf.isEmpty())
</I>&gt;&gt;<i>         return;
</I>&gt;<i>
</I>&gt;<i> Instead of adding flags.tunneling, can we fix/adjust that condition
</I>&gt;<i> and/or the code that affects its components to make the condition true?
</I>&gt;<i>
</I>&gt;<i> receivedFirstByte_: This member remains false if we splice and tunnel
</I>&gt;<i> intercepted connections during step1 because we read no bytes at that
</I>&gt;<i> time, right? However, it feels like this part of the condition should be
</I>&gt;<i> not receivedFirstByte_ but something like thereWasAtLeastOne (i.e., we
</I>&gt;<i> pushed at least one request into ConnStateData pipeline). Can we adjust
</I>&gt;<i> the pipeline code to remember that at least one request has been queued
</I>&gt;<i> and use that instead of receivedFirstByte_ here.
</I>&gt;<i>
</I>&gt;<i> inBuf.isEmpty(): That part of the condition looks correct to me. If it
</I>&gt;<i> is false in the tunneling case being discussed, then we need to fix the
</I>&gt;<i> code to clean inBuf when tunneling starts.
</I>&gt;<i>
</I>&gt;<i> In summary, can we do something like this instead:
</I>&gt;<i>
</I>&gt;<i> // do not log connections that closed after a transaction (it is normal)
</I>&gt;<i> if (pipeline.used() &amp;&amp; inBuf.isEmpty())
</I>&gt;<i>     return;
</I>

I used the pipeline.nrequests member.
Still I have some worries about inBuf but looks that it is empty in all 
cases we need it. In the worst case would not require a lot of work to 
fix any related issue when this is found.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>  const SBuf &amp;
</I>&gt;&gt;<i>  HttpRequest::effectiveRequestUri() const
</I>&gt;&gt;<i>  {
</I>&gt;&gt;<i> -    if (method.id() == Http::METHOD_CONNECT)
</I>&gt;&gt;<i> +    if (method.id() == Http::METHOD_CONNECT || url.getScheme() == AnyP::PROTO_TCP)
</I>&gt;&gt;<i>          return url.authority(true); // host:port
</I>&gt;&gt;<i>      return url.absolute();
</I>&gt;&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-211-Skype_groups_and_msnp_bypass-t10.patch
Type: text/x-patch
Size: 95230 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161020/005396c8/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161020/005396c8/attachment-0001.bin</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007101.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
	<LI>Next message: <A HREF="007139.html">[squid-dev] [PATCH] Support tunneling of bumped non-HTTP traffic. Other SslBump fixes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7104">[ date ]</a>
              <a href="thread.html#7104">[ thread ]</a>
              <a href="subject.html#7104">[ subject ]</a>
              <a href="author.html#7104">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
