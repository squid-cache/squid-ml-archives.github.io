<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Host header forgery detection when peeking for SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Host%20header%20forgery%20detection%20when%20peeking%20for%20SNI&In-Reply-To=%3C29C6706F-0C40-498B-86C8-7C4E7CAF8EF9%40realitymine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007117.html">
   <LINK REL="Next"  HREF="007112.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Host header forgery detection when peeking for SNI</H1>
    <B>Dave Lewthwaite</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Host%20header%20forgery%20detection%20when%20peeking%20for%20SNI&In-Reply-To=%3C29C6706F-0C40-498B-86C8-7C4E7CAF8EF9%40realitymine.com%3E"
       TITLE="[squid-dev] Host header forgery detection when peeking for SNI">Dave.Lewthwaite at realitymine.com
       </A><BR>
    <I>Tue Oct 25 10:54:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007117.html">[squid-dev] Jenkins build is back to normal : trunk-full-matrix » clang,d-opensuse-13.2 #263
</A></li>
        <LI>Next message: <A HREF="007112.html">[squid-dev] Host header forgery detection when peeking for SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7111">[ date ]</a>
              <a href="thread.html#7111">[ thread ]</a>
              <a href="subject.html#7111">[ subject ]</a>
              <a href="author.html#7111">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We are running into an issue that has come up a few times on the mailing lists - host header forgery detection when using SSL peek in order to include SNI logging in access logs. (Clients operating in transparent mode).

As far as I can tell I have narrowed it down to ClientRequestContext::hostHeaderVerifyFailed, there is a line -

if (!Config.onoff.hostStrictVerify &amp;&amp; http-&gt;request-&gt;method != Http::METHOD_CONNECT)

Along with the comment &quot;// NP: we do not yet handle CONNECT tunnels well, so ignore for them&quot;.

If I remove the method check then the sites hitting this issue start loading fine, however, I don't know what the implications are of doing this - especially given the comment. (I do understand the implications of disabling host verification entirely).

It's also worth noting that this still occurs even when both client and server are using the same DNS servers (although it's not as often) and clearly it is a problem that does occur in the real world.

What is the impact of removing the method check so that this code path is used for CONNECT requests?

Thanks

Dave Lewthwaite




This email and any attachments to it may contain confidential information and are intended solely for the addressee.



If you are not the intended recipient of this email or if you believe you have received this email in error, please contact the sender and remove it from your system.Do not use, copy or disclose the information contained in this email or in any attachment.

RealityMine Limited may monitor email traffic data including the content of email for the purposes of security.

RealityMine Limited is a company registered in England and Wales. Registered number: 07920936 Registered office: Warren Bruce Court, Warren Bruce Road, Trafford Park, Manchester M17 1LB
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161025/9a6218a4/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20161025/9a6218a4/attachment.html</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007117.html">[squid-dev] Jenkins build is back to normal : trunk-full-matrix » clang,d-opensuse-13.2 #263
</A></li>
	<LI>Next message: <A HREF="007112.html">[squid-dev] Host header forgery detection when peeking for SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7111">[ date ]</a>
              <a href="thread.html#7111">[ thread ]</a>
              <a href="subject.html#7111">[ subject ]</a>
              <a href="author.html#7111">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
