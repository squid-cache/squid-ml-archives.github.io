<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Host header forgery detection when peeking for SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Host%20header%20forgery%20detection%20when%20peeking%20for%20SNI&In-Reply-To=%3C501364cb-d209-4059-d47c-efb79d30c6b8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007111.html">
   <LINK REL="Next"  HREF="007116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Host header forgery detection when peeking for SNI</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Host%20header%20forgery%20detection%20when%20peeking%20for%20SNI&In-Reply-To=%3C501364cb-d209-4059-d47c-efb79d30c6b8%40treenet.co.nz%3E"
       TITLE="[squid-dev] Host header forgery detection when peeking for SNI">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct 25 11:40:51 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007111.html">[squid-dev] Host header forgery detection when peeking for SNI
</A></li>
        <LI>Next message: <A HREF="007116.html">[squid-dev] Host header forgery detection when peeking for SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7112">[ date ]</a>
              <a href="thread.html#7112">[ thread ]</a>
              <a href="subject.html#7112">[ subject ]</a>
              <a href="author.html#7112">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/10/2016 11:54 p.m., Dave Lewthwaite wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> We are running into an issue that has come up a few times on the mailing lists - host header forgery detection when using SSL peek in order to include SNI logging in access logs. (Clients operating in transparent mode).
</I>&gt;<i> 
</I>&gt;<i> As far as I can tell I have narrowed it down to ClientRequestContext::hostHeaderVerifyFailed, there is a line -
</I>&gt;<i> 
</I>&gt;<i> if (!Config.onoff.hostStrictVerify &amp;&amp; http-&gt;request-&gt;method != Http::METHOD_CONNECT)
</I>&gt;<i> 
</I>&gt;<i> Along with the comment &quot;// NP: we do not yet handle CONNECT tunnels well, so ignore for them&quot;.
</I>&gt;<i> 
</I>&gt;<i> If I remove the method check then the sites hitting this issue start loading fine, however, I don't know what the implications are of doing this - especially given the comment. (I do understand the implications of disabling host verification entirely).
</I>&gt;<i> 
</I>&gt;<i> It's also worth noting that this still occurs even when both client and server are using the same DNS servers (although it's not as often) and clearly it is a problem that does occur in the real world.
</I>&gt;<i> 
</I>&gt;<i> What is the impact of removing the method check so that this code path is used for CONNECT requests?
</I>
The CONNECT handling code does not yet do the ORIGINAL_DST connection
which other request types do.

CONNECT requests can still be sent by clients over port 80 or 443 (not
common, but possible) and are able to be used to bypass the proxy,
browser and network security systems.


I'm not yet sure what the handling in the SSL-Bump code needs to do in
these cases. Any assistance with ideas or code welcome.

Amos

</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007111.html">[squid-dev] Host header forgery detection when peeking for SNI
</A></li>
	<LI>Next message: <A HREF="007116.html">[squid-dev] Host header forgery detection when peeking for SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7112">[ date ]</a>
              <a href="thread.html#7112">[ thread ]</a>
              <a href="subject.html#7112">[ subject ]</a>
              <a href="author.html#7112">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
