<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Refactor wordlist to SBufList in	acl/RegexData
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Refactor%20wordlist%20to%20SBufList%20in%0A%09acl/RegexData&In-Reply-To=%3CCA%2BY8hcNS62fMum14VCz8y8BBd-9kSrwTh7Mi%2Bzm2Pd_a9r6%2BTw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007125.html">
   <LINK REL="Next"  HREF="007124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Refactor wordlist to SBufList in	acl/RegexData</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Refactor%20wordlist%20to%20SBufList%20in%0A%09acl/RegexData&In-Reply-To=%3CCA%2BY8hcNS62fMum14VCz8y8BBd-9kSrwTh7Mi%2Bzm2Pd_a9r6%2BTw%40mail.gmail.com%3E"
       TITLE="[squid-dev] [PATCH] Refactor wordlist to SBufList in	acl/RegexData">gkinkie at gmail.com
       </A><BR>
    <I>Thu Oct 27 07:02:25 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="007125.html">[squid-dev] [PATCH] Refactor wordlist to SBufList in acl/RegexData
</A></li>
        <LI>Next message: <A HREF="007124.html">[squid-dev] [RFC] support Cache-Control:immutable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7127">[ date ]</a>
              <a href="thread.html#7127">[ thread ]</a>
              <a href="subject.html#7127">[ subject ]</a>
              <a href="author.html#7127">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Oct 27, 2016 at 5:10 AM, Alex Rousskov
&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 10/26/2016 05:18 PM, Kinkie wrote:
</I>&gt;&gt;&gt;&gt;<i> the attached patch refactors the use of wordlist to SBufList in
</I>&gt;&gt;&gt;&gt;<i> acl/RegexData.cc
</I>&gt;<i>
</I>&gt;&gt;<i> -    while (wl != NULL) {
</I>&gt;&gt;<i> +    for (SBuf i : sl) {
</I>&gt;<i>
</I>&gt;<i> If possible, please avoid creating new SBufs by declaring &quot;i&quot; to be a
</I>&gt;<i> constant reference to SBuf. It is probably possible unless you modify
</I>&gt;<i> &quot;i&quot; -- I cannot tell for sure by looking at all the &quot;i&quot;s in the patch.
</I>
SBuf::c_str() is unfortunately non-const which limits applicability.

&gt;<i> Renaming &quot;i&quot; to something longer and more informative like
</I>&gt;<i> &quot;patternOrOption&quot; or even &quot;slowPatternOrOption&quot; would be useful for
</I>&gt;<i> those who try to understand what is going on and/or have to find that
</I>&gt;<i> variable in a text full of other &quot;i&quot;s.
</I>
Done, renamed to configurationLineWord.


&gt;&gt;<i> +    for (auto i : sl) {
</I>&gt;<i>
</I>&gt;<i> Same here, on all counts. Auto does not automatically adds &quot;&amp;&quot; or &quot;const&quot;.
</I>
I know, but this can't be changed due to c_str() below.

&gt;<i> What is the time difference in configuring, for example, one million of
</I>&gt;<i> regexes using patched and unpatched code?
</I>
The results were so surprising I had to double-check correctness which
is confirmed.
For a 100000-lines regex acl, &quot;squid -k parse&quot; time went DOWN from 36
seconds to 0.7 on my Intel Core i5 Macbook air.
By checking SBuf stats in cachemgr, the calling code is actually quite
bad for SBuf allocations; SBufs are apparently mostly used to hold
temporary c-strings and are immediately freed. I suspect however
calling code some O(n^2) or worse behavior in wordlist, hence the big
win.

&gt;<i> I have not reviewed the patch closely. I have no objections.
</I>
Thanks for the insights you gave.

Merging the updated code.

-- 
    Francesco
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007125.html">[squid-dev] [PATCH] Refactor wordlist to SBufList in acl/RegexData
</A></li>
	<LI>Next message: <A HREF="007124.html">[squid-dev] [RFC] support Cache-Control:immutable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7127">[ date ]</a>
              <a href="thread.html#7127">[ thread ]</a>
              <a href="subject.html#7127">[ subject ]</a>
              <a href="author.html#7127">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
