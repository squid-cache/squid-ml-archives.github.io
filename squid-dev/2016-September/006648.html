<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Incorrect logging of request size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Incorrect%20logging%20of%20request%20size&In-Reply-To=%3C57C8A127.7040604%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   <LINK REL="Next"  HREF="006780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Incorrect logging of request size</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Incorrect%20logging%20of%20request%20size&In-Reply-To=%3C57C8A127.7040604%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Incorrect logging of request size">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Thu Sep  1 21:44:07 UTC 2016</I>
    <P><UL>
        
        <LI>Next message: <A HREF="006780.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6648">[ date ]</a>
              <a href="thread.html#6648">[ thread ]</a>
              <a href="subject.html#6648">[ subject ]</a>
              <a href="author.html#6648">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

This patch fixes logged request size (%http::&gt;st) and other size-related
%codes.

The %[http::]&gt;st logformat code should log the actual number of
[dechunked] bytes received from the client. However, for requests with
Content-Length, Squid was logging the sum of the request header size and
the Content-Length header field value instead. The logged value was
wrong when the client sent fewer than Content-Length body bytes.

Also:

* Fixed %http::&gt;h and %http::&lt;h format codes for icap_log. The old code
   was focusing on preserving the &quot;request header&quot; (i.e. not &quot;response
   header&quot;) meaning of the %http::&gt;h logformat code, but since ICAP
   services deal with (and log) both HTTP requests and responses, that
   focus on the HTTP message kind actually complicates ICAP logging
   configuration and will eventually require introduction of new %http
   logformat codes that would be meaningless in access.log context.

   - In ICAP context, %http::&gt;h should log to-be-adapted HTTP message
     headers embedded in an ICAP request (HTTP request headers in REQMOD;
     HTTP response headers in RESPMOD). Before this change, %http::&gt;h
     logged constant/&quot;FYI&quot; HTTP request headers in RESPMOD.

   - Similarly, %http::&lt;h should log adapted HTTP message headers
     embedded in an ICAP response (HTTP request headers in regular
     REQMOD; HTTP response headers in RESPMOD and during request
     satisfaction in REQMOD). Before this change, %http::&lt;h logged &quot;-&quot; in
     REQMOD.

   In other words, in ICAP logging context, the &quot;&gt;&quot; and &quot;&lt;&quot; characters
   should indicate ICAP message kind (where the being-logged HTTP message
   is embedded), not HTTP message kind, even for %http codes.

   TODO: %http::&gt;h code logs &quot;-&quot; in RESPMOD because AccessLogEntry does
   not store virgin HTTP response headers.

* Correctly initialize ICAP ALE HTTP fields related to HTTP message
   sizes for icap_log, including %http::&gt;st, %http::&lt;st, %http::&gt;sh, and
   %http::&gt;sh format codes.

* Initialize HttpMsg::hdr_sz in HTTP header parsing code. Among other
   uses, this field is needed to initialize HTTP fields inside ICAP ALE.

* Synced default icap_log format documentation with the current code.


Regards,
Eduard.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-207-incorrect-logging-of-request-size-t6.patch
Type: text/x-patch
Size: 29039 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160902/6efeff8c/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160902/6efeff8c/attachment-0001.bin</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="006780.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6648">[ date ]</a>
              <a href="thread.html#6648">[ thread ]</a>
              <a href="subject.html#6648">[ subject ]</a>
              <a href="author.html#6648">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
