<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Squid%20crashes%20on%20shutdown%20while%20cleaning%20up%0A%20idle%20ICAP%20connections%20Part2&In-Reply-To=%3C70acee5d-f55a-a4fb-5871-6b3748ced001%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006778.html">
   <LINK REL="Next"  HREF="006678.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Squid%20crashes%20on%20shutdown%20while%20cleaning%20up%0A%20idle%20ICAP%20connections%20Part2&In-Reply-To=%3C70acee5d-f55a-a4fb-5871-6b3748ced001%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2">christos at chtsanti.net
       </A><BR>
    <I>Wed Sep  7 09:44:44 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006778.html">[squid-dev] Sad performance trend
</A></li>
        <LI>Next message: <A HREF="006678.html">[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6676">[ date ]</a>
              <a href="thread.html#6676">[ thread ]</a>
              <a href="subject.html#6676">[ subject ]</a>
              <a href="author.html#6676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A preview of this patch originally discussed under the &quot;[PATCH] Bug 4430 
Squid crashes on shutdown while cleaning up idle ICAP connections&quot; mail 
thread on squid-dev:
   <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005214.html">http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005214.html</A>

We fixed the patch so I hope it handles most of the Amos objections for 
the first patch.

Patch description:

The global Adaptation::Icap::TheConfig object is automatically destroyed 
when Squid exits. Its destructor destroys Icap::ServiceRep objects that, 
in turn, close all open connections in the idle connections pool. Since 
this happens after comm_exit has destroyed all Comm structures 
associated with those connections, Squid crashes.

This patch uses updated RegisteredRunners API to close all connections 
in existing connections pools before Squid cleans up the Comm subsystem.

Also added a new IndependentRunner class to the RegistersRunner API, 
which must be used for runners that are destroyed by external forces, 
possibly while still being registered. IndependentRunner objects 
unregister themselves from Runners registry when they are destroyed.

The finishShutdown() method is now virtual and may be overloaded to 
implement independent runner cleanup during main loop (and/or to support 
complex cleanup actions that require calling other virtual methods). The 
method is still called for all registered runners but it no longer 
destroys the runner. For dependent runners, the destruction happens soon 
after the finishShutdown event ends but also during the main loop 
(unless the runner has managed to register after the main loop ended).

This patch replaces the r14575 temporary fix.

This is a Measurement Factory project.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-152-Squid-Segfault-on-Shutdown-t7.patch
Type: text/x-patch
Size: 27299 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160907/9bcd2759/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160907/9bcd2759/attachment-0001.bin</A>&gt;
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006778.html">[squid-dev] Sad performance trend
</A></li>
	<LI>Next message: <A HREF="006678.html">[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6676">[ date ]</a>
              <a href="thread.html#6676">[ thread ]</a>
              <a href="subject.html#6676">[ subject ]</a>
              <a href="author.html#6676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
