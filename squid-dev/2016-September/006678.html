<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Squid%20crashes%20on%20shutdown%20while%20cleaning%20up%0A%20idle%20ICAP%20connections%20Part2&In-Reply-To=%3Cec89772b-7cfd-4ef4-5f96-32b3c6a2dde3%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006676.html">
   <LINK REL="Next"  HREF="006679.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Squid%20crashes%20on%20shutdown%20while%20cleaning%20up%0A%20idle%20ICAP%20connections%20Part2&In-Reply-To=%3Cec89772b-7cfd-4ef4-5f96-32b3c6a2dde3%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Sep  7 14:56:41 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006676.html">[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
</A></li>
        <LI>Next message: <A HREF="006679.html">[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6678">[ date ]</a>
              <a href="thread.html#6678">[ thread ]</a>
              <a href="subject.html#6678">[ subject ]</a>
              <a href="author.html#6678">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/09/2016 9:44 p.m., Christos Tsantilas wrote:
&gt;<i> A preview of this patch originally discussed under the &quot;[PATCH] Bug 4430
</I>&gt;<i> Squid crashes on shutdown while cleaning up idle ICAP connections&quot; mail
</I>&gt;<i> thread on squid-dev:
</I>&gt;<i>   <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005214.html">http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005214.html</A>
</I>&gt;<i> 
</I>&gt;<i> We fixed the patch so I hope it handles most of the Amos objections for
</I>&gt;<i> the first patch.
</I>&gt;<i> 
</I>&gt;<i> Patch description:
</I>&gt;<i> 
</I>&gt;<i> The global Adaptation::Icap::TheConfig object is automatically destroyed
</I>&gt;<i> when Squid exits. Its destructor destroys Icap::ServiceRep objects that,
</I>&gt;<i> in turn, close all open connections in the idle connections pool. Since
</I>&gt;<i> this happens after comm_exit has destroyed all Comm structures
</I>&gt;<i> associated with those connections, Squid crashes.
</I>&gt;<i> 
</I>&gt;<i> This patch uses updated RegisteredRunners API to close all connections
</I>&gt;<i> in existing connections pools before Squid cleans up the Comm subsystem.
</I>&gt;<i> 
</I>&gt;<i> Also added a new IndependentRunner class to the RegistersRunner API,
</I>&gt;<i> which must be used for runners that are destroyed by external forces,
</I>&gt;<i> possibly while still being registered. IndependentRunner objects
</I>&gt;<i> unregister themselves from Runners registry when they are destroyed.
</I>&gt;<i> 
</I>&gt;<i> The finishShutdown() method is now virtual and may be overloaded to
</I>&gt;<i> implement independent runner cleanup during main loop (and/or to support
</I>&gt;<i> complex cleanup actions that require calling other virtual methods). The
</I>&gt;<i> method is still called for all registered runners but it no longer
</I>&gt;<i> destroys the runner. For dependent runners, the destruction happens soon
</I>&gt;<i> after the finishShutdown event ends but also during the main loop
</I>&gt;<i> (unless the runner has managed to register after the main loop ended).
</I>&gt;<i> 
</I>&gt;<i> This patch replaces the r14575 temporary fix.
</I>&gt;<i> 
</I>&gt;<i> This is a Measurement Factory project.
</I>&gt;<i> 
</I>
I assume this has had enough testing since it last came up for audit.

Please take the opportunity when touching code lines to remove HERE from
debugs() lines, and also use nullptr instead of NULL.

+1. Please apply ASAP with above changes.

Amos

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006676.html">[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
</A></li>
	<LI>Next message: <A HREF="006679.html">[squid-dev] [PATCH] Squid crashes on shutdown while cleaning up idle ICAP connections Part2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6678">[ date ]</a>
              <a href="thread.html#6678">[ thread ]</a>
              <a href="subject.html#6678">[ subject ]</a>
              <a href="author.html#6678">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
