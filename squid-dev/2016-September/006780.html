<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Incorrect logging of request size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Incorrect%20logging%20of%20request%20size&In-Reply-To=%3C7822359d-de16-d805-a2b6-2775a5c74525%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006648.html">
   <LINK REL="Next"  HREF="006781.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Incorrect logging of request size</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Incorrect%20logging%20of%20request%20size&In-Reply-To=%3C7822359d-de16-d805-a2b6-2775a5c74525%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Incorrect logging of request size">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 13 00:11:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006648.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
        <LI>Next message: <A HREF="006781.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6780">[ date ]</a>
              <a href="thread.html#6780">[ thread ]</a>
              <a href="subject.html#6780">[ subject ]</a>
              <a href="author.html#6780">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/01/2016 03:44 PM, Eduard Bagdasaryan wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> This patch fixes logged request size (%http::&gt;st) and other size-related
</I>&gt;<i> %codes.
</I>&gt;<i> 
</I>&gt;<i> The %[http::]&gt;st logformat code should log the actual number of
</I>&gt;<i> [dechunked] bytes received from the client. However, for requests with
</I>&gt;<i> Content-Length, Squid was logging the sum of the request header size and
</I>&gt;<i> the Content-Length header field value instead. The logged value was
</I>&gt;<i> wrong when the client sent fewer than Content-Length body bytes.
</I>&gt;<i> 
</I>&gt;<i> Also:
</I>&gt;<i> 
</I>&gt;<i> * Fixed %http::&gt;h and %http::&lt;h format codes for icap_log. The old code
</I>&gt;<i>   was focusing on preserving the &quot;request header&quot; (i.e. not &quot;response
</I>&gt;<i>   header&quot;) meaning of the %http::&gt;h logformat code, but since ICAP
</I>&gt;<i>   services deal with (and log) both HTTP requests and responses, that
</I>&gt;<i>   focus on the HTTP message kind actually complicates ICAP logging
</I>&gt;<i>   configuration and will eventually require introduction of new %http
</I>&gt;<i>   logformat codes that would be meaningless in access.log context.
</I>&gt;<i> 
</I>&gt;<i>   - In ICAP context, %http::&gt;h should log to-be-adapted HTTP message
</I>&gt;<i>     headers embedded in an ICAP request (HTTP request headers in REQMOD;
</I>&gt;<i>     HTTP response headers in RESPMOD). Before this change, %http::&gt;h
</I>&gt;<i>     logged constant/&quot;FYI&quot; HTTP request headers in RESPMOD.
</I>&gt;<i> 
</I>&gt;<i>   - Similarly, %http::&lt;h should log adapted HTTP message headers
</I>&gt;<i>     embedded in an ICAP response (HTTP request headers in regular
</I>&gt;<i>     REQMOD; HTTP response headers in RESPMOD and during request
</I>&gt;<i>     satisfaction in REQMOD). Before this change, %http::&lt;h logged &quot;-&quot; in
</I>&gt;<i>     REQMOD.
</I>&gt;<i> 
</I>&gt;<i>   In other words, in ICAP logging context, the &quot;&gt;&quot; and &quot;&lt;&quot; characters
</I>&gt;<i>   should indicate ICAP message kind (where the being-logged HTTP message
</I>&gt;<i>   is embedded), not HTTP message kind, even for %http codes.
</I>&gt;<i> 
</I>&gt;<i>   TODO: %http::&gt;h code logs &quot;-&quot; in RESPMOD because AccessLogEntry does
</I>&gt;<i>   not store virgin HTTP response headers.
</I>&gt;<i> 
</I>&gt;<i> * Correctly initialize ICAP ALE HTTP fields related to HTTP message
</I>&gt;<i>   sizes for icap_log, including %http::&gt;st, %http::&lt;st, %http::&gt;sh, and
</I>&gt;<i>   %http::&gt;sh format codes.
</I>&gt;<i> 
</I>&gt;<i> * Initialize HttpMsg::hdr_sz in HTTP header parsing code. Among other
</I>&gt;<i>   uses, this field is needed to initialize HTTP fields inside ICAP ALE.
</I>&gt;<i> 
</I>&gt;<i> * Synced default icap_log format documentation with the current code.
</I>

I cannot track the effects of all the proposed low-level fixes, of
course, but no changes jumped at me as wrong. IIRC, Eduard tried quite a
few test cases in hope to weed out the bugs. The underlying code was in
poor shape, on several levels. This patch does not solve all the
problems, but at least Squid should stop lying about several sizes that
folks are often monitoring (and some icap.log codes should be
interpreted in a more consistent/orderly fashion).

I have not seen any public reviews for this patch. If there are no
last-minute objections, I will commit these important fixes to trunk soon.


Cheers,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006648.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
	<LI>Next message: <A HREF="006781.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6780">[ date ]</a>
              <a href="thread.html#6780">[ thread ]</a>
              <a href="subject.html#6780">[ subject ]</a>
              <a href="author.html#6780">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
