<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Incorrect logging of request size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Incorrect%20logging%20of%20request%20size&In-Reply-To=%3C37e88de2-0cdc-1cec-8b5f-9f85bb76dfe1%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006780.html">
   <LINK REL="Next"  HREF="006783.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Incorrect logging of request size</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Incorrect%20logging%20of%20request%20size&In-Reply-To=%3C37e88de2-0cdc-1cec-8b5f-9f85bb76dfe1%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Incorrect logging of request size">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 13 04:06:50 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006780.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
        <LI>Next message: <A HREF="006783.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6781">[ date ]</a>
              <a href="thread.html#6781">[ thread ]</a>
              <a href="subject.html#6781">[ subject ]</a>
              <a href="author.html#6781">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/09/2016 12:11 p.m., Alex Rousskov wrote:
&gt;<i> On 09/01/2016 03:44 PM, Eduard Bagdasaryan wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This patch fixes logged request size (%http::&gt;st) and other size-related
</I>&gt;&gt;<i> %codes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The %[http::]&gt;st logformat code should log the actual number of
</I>&gt;&gt;<i> [dechunked] bytes received from the client. However, for requests with
</I>&gt;&gt;<i> Content-Length, Squid was logging the sum of the request header size and
</I>&gt;&gt;<i> the Content-Length header field value instead. The logged value was
</I>&gt;&gt;<i> wrong when the client sent fewer than Content-Length body bytes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Fixed %http::&gt;h and %http::&lt;h format codes for icap_log. The old code
</I>&gt;&gt;<i>   was focusing on preserving the &quot;request header&quot; (i.e. not &quot;response
</I>&gt;&gt;<i>   header&quot;) meaning of the %http::&gt;h logformat code, but since ICAP
</I>&gt;&gt;<i>   services deal with (and log) both HTTP requests and responses, that
</I>&gt;&gt;<i>   focus on the HTTP message kind actually complicates ICAP logging
</I>&gt;&gt;<i>   configuration and will eventually require introduction of new %http
</I>&gt;&gt;<i>   logformat codes that would be meaningless in access.log context.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   - In ICAP context, %http::&gt;h should log to-be-adapted HTTP message
</I>&gt;&gt;<i>     headers embedded in an ICAP request (HTTP request headers in REQMOD;
</I>&gt;&gt;<i>     HTTP response headers in RESPMOD). Before this change, %http::&gt;h
</I>&gt;&gt;<i>     logged constant/&quot;FYI&quot; HTTP request headers in RESPMOD.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   - Similarly, %http::&lt;h should log adapted HTTP message headers
</I>&gt;&gt;<i>     embedded in an ICAP response (HTTP request headers in regular
</I>&gt;&gt;<i>     REQMOD; HTTP response headers in RESPMOD and during request
</I>&gt;&gt;<i>     satisfaction in REQMOD). Before this change, %http::&lt;h logged &quot;-&quot; in
</I>&gt;&gt;<i>     REQMOD.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   In other words, in ICAP logging context, the &quot;&gt;&quot; and &quot;&lt;&quot; characters
</I>&gt;&gt;<i>   should indicate ICAP message kind (where the being-logged HTTP message
</I>&gt;&gt;<i>   is embedded), not HTTP message kind, even for %http codes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   TODO: %http::&gt;h code logs &quot;-&quot; in RESPMOD because AccessLogEntry does
</I>&gt;&gt;<i>   not store virgin HTTP response headers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Correctly initialize ICAP ALE HTTP fields related to HTTP message
</I>&gt;&gt;<i>   sizes for icap_log, including %http::&gt;st, %http::&lt;st, %http::&gt;sh, and
</I>&gt;&gt;<i>   %http::&gt;sh format codes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Initialize HttpMsg::hdr_sz in HTTP header parsing code. Among other
</I>&gt;&gt;<i>   uses, this field is needed to initialize HTTP fields inside ICAP ALE.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Synced default icap_log format documentation with the current code.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I cannot track the effects of all the proposed low-level fixes, of
</I>&gt;<i> course, but no changes jumped at me as wrong. IIRC, Eduard tried quite a
</I>&gt;<i> few test cases in hope to weed out the bugs. The underlying code was in
</I>&gt;<i> poor shape, on several levels. This patch does not solve all the
</I>&gt;<i> problems, but at least Squid should stop lying about several sizes that
</I>&gt;<i> folks are often monitoring (and some icap.log codes should be
</I>&gt;<i> interpreted in a more consistent/orderly fashion).
</I>&gt;<i> 
</I>&gt;<i> I have not seen any public reviews for this patch. If there are no
</I>&gt;<i> last-minute objections, I will commit these important fixes to trunk soon.
</I>
I've also not had time to do any thorough check, but with a quick
read-through nothing stands out as broken.

Just the new cf.data.pre docs for icap_log contradicting itself:

&quot;
  http::&gt;h	...
      HTTP response headers in RESPMOD) ...
      currently does not support logging of HTTP response headers in
RESPMOD ...
&quot;

I think that should probably be saying it does not support HTTP
*request* headers in RESPMOD.


Amos

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006780.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
	<LI>Next message: <A HREF="006783.html">[squid-dev] [PATCH] Incorrect logging of request size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6781">[ date ]</a>
              <a href="thread.html#6781">[ thread ]</a>
              <a href="subject.html#6781">[ subject ]</a>
              <a href="author.html#6781">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
