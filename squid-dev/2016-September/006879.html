<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] dns_wait_for_all
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20dns_wait_for_all&In-Reply-To=%3Caf6d5ae3-cec5-5056-8044-175064ad8158%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006877.html">
   <LINK REL="Next"  HREF="006834.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] dns_wait_for_all</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20dns_wait_for_all&In-Reply-To=%3Caf6d5ae3-cec5-5056-8044-175064ad8158%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] dns_wait_for_all">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 20 16:22:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006877.html">[squid-dev] [RFC] dns_wait_for_all
</A></li>
        <LI>Next message: <A HREF="006834.html">[squid-dev] Build failed in Jenkins: trunk-matrix » gcc,d-fedora-21 #762
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6879">[ date ]</a>
              <a href="thread.html#6879">[ thread ]</a>
              <a href="subject.html#6879">[ subject ]</a>
              <a href="author.html#6879">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/20/2016 04:41 AM, Amos Jeffries wrote:
&gt;<i> On 16/09/2016 3:35 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 09/15/2016 03:50 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> The serverDestinations not changing (yet).
</I>
&gt;&gt;<i> I am pretty sure we have to change that field to implement
</I>&gt;&gt;<i> dns_wait_for_all functionality correctly. For example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * we need to make its updates (from different jobs!) safe, with
</I>&gt;&gt;<i> easy-to-trace debugging.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * we need to support an EOF-like semantics to signal whether more
</I>&gt;&gt;<i> destinations may still be provided.
</I>

&gt;<i> I think you are mistaking serverDestinations as being part of the DNS
</I>&gt;<i> operations. It is not.
</I>
I am not thinking in those terms. serverDestinations today is populated
by peer selection code, based on DNS lookups (including DNS cache
lookups). Those DNS lookups create two problems that dns_wait_for_all is
solving (i.e., waiting for the second DNS query in each address
resolution transaction and waiting for all peer address resolution
transactions).


&gt;<i> serverDestinations is state in the FwdStateData 'Job', the IP addresses
</I>&gt;<i> used by it have to go through the peer selection 'Job' processing and
</I>&gt;<i> related access controls applied to whatever comes out of an ipcache
</I>&gt;<i> lookup 'Job'.
</I>
Agreed. serverDestinations state is shared among peer selection and
FwdState code. Today, the sharing is sequential: After peer selection
fills serverDestinations, FwdState starts using serverDestinations. The
sequential nature of this approach creates problems. Dns_wait_for_all
solves some of them.


&gt;<i> DNS lookups are buried 3+ 'Job' layers away on the other side of
</I>&gt;<i> ipcache. All they do is feed that cache with data.
</I>
Yes, there are many layers.

The DNS code itself does not quite feed the cache (it just sends an
answer to the requester which happens to be the cache), and the cache is
not quite a layer: A fresh DNS answer is given to both the cache and the
ipcache_nbgethostbyname() callback. There might be some unwelcomed
dependencies in the code that require that fresh answer to be cached,
but they should not exist and they are unimportant when we discuss high
level concepts.


&gt;<i> If you are intending to alter serveDestinations operations, then please
</I>&gt;<i> dont call the option dns_* . It is a tcp_outgoing_* thing.
</I>
I do not recommend using the tcp_outgoing name prefix because the
directive has nothing to do with TCP (and everything to do with DNS).
However, I am not going to fight you on this -- we usually disagree on
how things should be named, and there usually are not enough formal
arguments that can be made to support a given name. If nobody speaks up,
you will be able to rename the directive however you want. I am
certainly not a big fan of dns_wait_for_all!

Needless to say, the directive name should reflect what the feature does
from Squid admin point of view (the code changes implementing the
feature are irrelevant when it comes to naming). The proposed feature
determines whether Squid waits for certain DNS lookups when forwarding
transactions to peers.


Cheers,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006877.html">[squid-dev] [RFC] dns_wait_for_all
</A></li>
	<LI>Next message: <A HREF="006834.html">[squid-dev] Build failed in Jenkins: trunk-matrix » gcc,d-fedora-21 #762
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6879">[ date ]</a>
              <a href="thread.html#6879">[ thread ]</a>
              <a href="subject.html#6879">[ subject ]</a>
              <a href="author.html#6879">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
