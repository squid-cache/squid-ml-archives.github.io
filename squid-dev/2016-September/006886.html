<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] OSX transparent-proxy using pfctl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B90258350654%40EXWCMS01.fanniemae.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006884.html">
   <LINK REL="Next"  HREF="006887.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] OSX transparent-proxy using pfctl</H1>
    <B>Shively, Gregory</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B90258350654%40EXWCMS01.fanniemae.com%3E"
       TITLE="[squid-dev] [PATCH] OSX transparent-proxy using pfctl">gregory_shively at fanniemae.com
       </A><BR>
    <I>Wed Sep 28 18:18:15 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006884.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
        <LI>Next message: <A HREF="006887.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6886">[ date ]</a>
              <a href="thread.html#6886">[ thread ]</a>
              <a href="subject.html#6886">[ subject ]</a>
              <a href="author.html#6886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>]
</I>&gt;<i> Sent: Monday, September 26, 2016 4:07 PM
</I>&gt;<i> To: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Shively, Gregory &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">gregory_shively at fanniemae.com</A>&gt;
</I>&gt;<i> Subject: [EXTERNAL] Re: [squid-dev] [PATCH] OSX transparent-proxy using
</I>&gt;<i> pfctl
</I>&gt;<i> 
</I>&gt;<i> On 09/26/2016 12:59 PM, Shively, Gregory wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; The patch calls /sbin/pfctl to get the redirect state information
</I>&gt;<i> 
</I>&gt;<i> For every intercepted connection, this patch forks Squid to start a shell
</I>&gt;<i> (which then starts pfctl and awk) and then blocks Squid on that shell output,
</I>&gt;<i> right? That feels very expensive performance-wise. I wonder whether Squid
</I>&gt;<i> should emit a corresponding one-time warning, to minimize the number of
</I>&gt;<i> folks who are going to assume that this works well under load and then
</I>&gt;<i> complain that their Squid is &quot;slow&quot;.
</I>&gt;<i> 
</I>&gt;<i> The awk part can be eliminated by parsing in Squid, but I am not sure that
</I>&gt;<i> optimization is worth it when there is so much overhead in this code besides
</I>&gt;<i> awk.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Totally agree with that. For my use case, I'm using squid for a small number of 
embedded devices that don't have the ability to connect to the available WiFi 
network. The one-time warning sounds like a good idea. Is there a place that
you have to add the one-time message, or should I just add a static variable 
to determine if the warning has been displayed the first time down this code
path?

I had started to parse the results of the pfctl in squid, but came to the same
conclusion and decided to just leave the awk.

&gt;<i> &gt; Let me know if I should continue down the road on getting
</I>&gt;<i> &gt; test-builds.sh running on OSX.
</I>&gt;<i> 
</I>&gt;<i> IMO, you should not be responsible for fixing any old test-builds.sh bugs,
</I>&gt;<i> only for the problems your changes add or cause.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Thanks - I was mistaken and thought from the merge document you sent that
I should have run the test-builds.sh. 

&gt;<i> &gt; +    char *cmd = (char *)malloc(sizeof(char) * cmdLen);
</I>&gt;<i> &gt; +    snprintf(cmd, cmdLen, cmdFormat, daddr, saddr, established);
</I>&gt;<i> 
</I>&gt;<i> Please rewrite using SBuf. AFAICT, what you want can be written without all
</I>&gt;<i> those unsafe C things like malloc() and snprintf() -- you are simply
</I>&gt;<i> concatenating a few strings to form a command.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Makes sense; I've been out of writing C for quite a while and never was much of 
a C++ programmer. Does just using the appendf() method sound alright? And am I
correct that the method with throw an exception that should just rollup the stack?

&gt;<i> &gt; +        execl(&quot;/bin/sh&quot;, &quot;/bin/sh&quot;, &quot;-c&quot;, cmd, NULL);
</I>&gt;<i> 
</I>&gt;<i> Please propagate or otherwise handle execl() errors.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; +    FILE *fp = fdopen(pipefd[0], &quot;r&quot;);
</I>&gt;<i> &gt; +    while (!feof(fp)) {
</I>&gt;<i> 
</I>&gt;<i> Please handle fdopen() errors instead of ignoring them and feeding a nil
</I>&gt;<i> pointer to feof().
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Also added the check to return of the pipe().

&gt;<i> &gt; +    FILE *fp = fdopen(pipefd[0], &quot;r&quot;);
</I>&gt;<i> ...
</I>&gt;<i> &gt; +            close(pipefd[0]);
</I>&gt;<i> &gt; +            return true;
</I>&gt;<i> ...
</I>&gt;<i> &gt; +    close(pipefd[0]);
</I>&gt;<i> &gt; +    return false;
</I>&gt;<i> 
</I>&gt;<i> Leaking &quot;fp&quot;? AFAICT, you are supposed to close &quot;fp&quot; instead of pipefd[0]
</I>&gt;<i> after fdopen() but I am not sure.
</I>&gt;<i> 
</I>
&gt;<i> 
</I>&gt;<i> &gt; +                debugs(89, DBG_IMPORTANT, HERE &lt;&lt; &quot;PFCTL failed to find
</I>&gt;<i> state&quot;);
</I>&gt;<i> &gt; +                return false;
</I>&gt;<i> 
</I>&gt;<i> Leaking both &quot;fp&quot; and pipefd[0]?
</I>&gt;<i> 
</I>&gt;<i> 
</I>
If my memory serves, I think the FILE * returned from fdopen() is just a pointer to the 
same datastructure in the kernel that fd would be associated to. So I was under the 
impression that either a fclose(fp) or close(fd) should be equivalent. I wonder if closing
both would also be bad. I found a SO <A HREF="http://stackoverflow.com/questions/13691107/c-proper-way-to-close-files-when-using-both-open-and-fdopen.">http://stackoverflow.com/questions/13691107/c-proper-way-to-close-files-when-using-both-open-and-fdopen.</A>
I'll go ahead and change it to a fclose() - don't think it matters, but might be more consistent
since I was using buffered reading. But from here, I think, that we should only close
either fp or pipefd[0].

&gt;<i> &gt; +    char rdaddr[MAX_IPSTRLEN + 6];
</I>&gt;<i> 
</I>&gt;<i> AFAICT, the input line may have more characters than that because &quot;:&quot;, &quot;\n&quot;,
</I>&gt;<i> and &quot;\0&quot; all consume space (I assume 6 is for the &quot;:port&quot;).
</I>&gt;<i> 
</I>&gt;<i> Also, this declaration is not needed outside the while loop.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Will add the 3 extra characters. Is the MAX_IPSTRLEN that correct macro to use here?
I wasn't sure of what the max length of a IPv6 string and when I looked it up, I think
MAX_IPSTRLEN was a bit longer.

&gt;<i> &gt; +            char *portPtr = strchr(rdaddr, '\n');
</I>&gt;<i> &gt; +            if (portPtr) *portPtr = '\0';
</I>&gt;<i> 
</I>&gt;<i> Should not we reject truncated lines (without '\n') instead of hoping that the
</I>&gt;<i> port number or the address itself was not truncated?
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Makes sense.

&gt;<i> &gt; +        if (errno == EINTR || errno == EAGAIN) {
</I>&gt;<i> &gt; +            continue;
</I>&gt;<i> &gt; +        }
</I>&gt;<i> 
</I>&gt;<i> This code has no effect AFAICT -- the loop will continue with or without that if
</I>&gt;<i> statement. Did you mean to break the loop on all other errors instead?
</I>&gt;<i> 
</I>&gt;<i> 
</I>
That was left over code that I forgot to pull out. When I was using popen(), for
some reason, the 2nd (or maybe 3rd) connection was returning an error
on fgets(). I was just trying to figure out what was going on.

&gt;<i> I recommend removing &quot;fp&quot; and reading from pipefd[0] directly instead.
</I>&gt;<i> You can use Tokenizer to safely parse what you read without these error-
</I>&gt;<i> prone C tricks.
</I>&gt;<i> 
</I>
The reason that I used fgets() instead of read() on the pipefd[0] is that I'm 
reading either the  length of rdaddr or until I read a newline, which ever 
comes first. If I used read(), if the length of the line was less than rdaddr len
(and there was more than one line), it could read the beginning of the next
Line. At least that is what I remember. I could use Tokenizer or it looks like
Just SBuf after I get the line since the tokenizing is pretty simple. But I think
 if I was to use just read(), I'd have to read a character at a time from the fd
and at that point would it be just better to keep track of when I hit the ':'
in the input stream. I could do that if you'd like.


&gt;<i> &gt; +		CPPFLAGS=\&quot;-D_SQUID_APPLE -Wno-error=deprecated-
</I>&gt;<i> declarations\&quot;
</I>&gt;<i> &gt; +LDFLAGS=-lresolv \
</I>&gt;<i> ...
</I>&gt;<i> &gt; -DISTCHECK_CONFIGURE_FLAGS=&quot;&quot;
</I>&gt;<i> &gt; +DISTCHECK_CONFIGURE_FLAGS=&quot;CPPFLAGS=\&quot;-D_SQUID_APPLE -Wno-
</I>&gt;<i> error=deprecated-declarations\&quot; LDFLAGS=-lresolv&quot;
</I>&gt;<i> 
</I>&gt;<i> These temporary for-testing changes should not be a part of the patch.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Sorry - had meant to remove those prior to sending. I've made the changes other than
removing the use of fp and using the pipefd[0]. I can still make that change also, but
just wanted your feedback if it should be changed, if I missed something in
Tokenizer, and/or if you want me to throw the input stream into a SBuf or
Tokenizer instead of just using some C calls.




&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-3.5.20-osx-devpf-transparent.patch
Type: application/octet-stream
Size: 4139 bytes
Desc: squid-3.5.20-osx-devpf-transparent.patch
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160928/565ace82/attachment.obj">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160928/565ace82/attachment.obj</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006884.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
	<LI>Next message: <A HREF="006887.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6886">[ date ]</a>
              <a href="thread.html#6886">[ thread ]</a>
              <a href="subject.html#6886">[ subject ]</a>
              <a href="author.html#6886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
