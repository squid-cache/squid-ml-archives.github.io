<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] OSX transparent-proxy using pfctl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3C5fa3b081-8f17-af29-3535-5b117374e590%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006889.html">
   <LINK REL="Next"  HREF="006892.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] OSX transparent-proxy using pfctl</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3C5fa3b081-8f17-af29-3535-5b117374e590%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] OSX transparent-proxy using pfctl">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 29 20:11:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006889.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
        <LI>Next message: <A HREF="006892.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6890">[ date ]</a>
              <a href="thread.html#6890">[ thread ]</a>
              <a href="subject.html#6890">[ subject ]</a>
              <a href="author.html#6890">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/29/2016 01:12 PM, Shively, Gregory wrote:

&gt;<i> Sometimes these mailing lists make me think like I'm talking to one
</I>&gt;<i> person :-).
</I>
Glad we all sound coherent to you :-)!


&gt;<i> ERROR: files left in build directory after distclean:
</I>&gt;<i> ./src/cf_gen.dSYM/Contents/Info.plist
</I>&gt;<i> ./src/cf_gen.dSYM/Contents/Resources/DWARF/cf_gen
</I>
&gt;<i> I can run with the &quot;--keep-going&quot; flag, but that ends with a the
</I>&gt;<i> equivalent error in btlayer-05-no-deps-esi. Do I run it this way and
</I>&gt;<i> just grep the logs for FAIL or something?
</I>
Sounds like a good plan to me.


&gt;<i> I wasn't sure if I should handle it or let it flow up, since if it
</I>&gt;<i> was in an overflow state I would doubt I could handle this packet,
</I>&gt;<i> but maybe the next connection would be successful.
</I>
I recommend temporary adding an exception with Must(false) inside the
parsing code and testing what happens. This approach may give you enough
information to decide whether your code or the caller should be
responsible for handling parsing exceptions.


&gt;<i> +    while ((n = read(pipefd[0], buf, sizeof(buf))) &gt; 0) {
</I>&gt;<i> +        state.append(buf);
</I>
You need to tell SBuf how much to append(). read(2) does not 0-terminate
buf!


&gt;<i> +    if (n == -1) {
</I>&gt;<i> +        int xerrno = errno;
</I>
Too late: errno may already be different after close().


&gt;<i> +        // Move to EOL and try again from the next line
</I>&gt;<i> +        tk.token(host, lf);
</I>
If possible, use one of the skip() methods to avoid the implication that
you are parsing host here (and to save a couple of CPU cycles).

Please note that Tokenizer has a method to extract integers. I am not
sure it will help you here, but it might.

&gt;<i> +                newConn-&gt;local = host.c_str();
</I>&gt;<i> +                newConn-&gt;local.port(atol(port.c_str()));
</I>&gt;<i> +                debugs(89, 5, HERE &lt;&lt; &quot;address NAT: &quot; &lt;&lt; newConn);
</I>&gt;<i> +                return true;
</I>
&gt;<i> +                newConn-&gt;local = host.c_str();
</I>&gt;<i> +                newConn-&gt;local.port(atol(port.c_str()));
</I>&gt;<i> +                debugs(89, 5, HERE &lt;&lt; &quot;address NAT: &quot; &lt;&lt; newConn);
</I>
If you can avoid code duplication, please do so.

&gt;<i> +    CharacterSet bracket(&quot;bracket&quot;, &quot;[]&quot;);
</I>&gt;<i> +    CharacterSet colon(&quot;colon&quot;, &quot;:&quot;);
</I>&gt;<i> +    CharacterSet lf(&quot;lf&quot;, &quot;\n&quot;);
</I>&gt;<i> +    CharacterSet ws(&quot;ws&quot;, &quot; \t\r\n&quot;);
</I>
These should be declared as static to avoid allocating/initializing lots
of bytes on every access and as constant to help the optimizer (and to
avoid future bugs). And you can move them inside the loop then -- they
are unused outside the loop.

In general, declare variables as late as possible and make them const if
possible.


Thank you,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006889.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
	<LI>Next message: <A HREF="006892.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6890">[ date ]</a>
              <a href="thread.html#6890">[ thread ]</a>
              <a href="subject.html#6890">[ subject ]</a>
              <a href="author.html#6890">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
