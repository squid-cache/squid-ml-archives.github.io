<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] OSX transparent-proxy using pfctl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B902583F05F1%40EXWCMS01.fanniemae.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006890.html">
   <LINK REL="Next"  HREF="006893.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] OSX transparent-proxy using pfctl</H1>
    <B>Shively, Gregory</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B902583F05F1%40EXWCMS01.fanniemae.com%3E"
       TITLE="[squid-dev] [PATCH] OSX transparent-proxy using pfctl">gregory_shively at fanniemae.com
       </A><BR>
    <I>Thu Sep 29 21:48:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006890.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
        <LI>Next message: <A HREF="006893.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6892">[ date ]</a>
              <a href="thread.html#6892">[ thread ]</a>
              <a href="subject.html#6892">[ subject ]</a>
              <a href="author.html#6892">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>]
</I>&gt;<i> Sent: Thursday, September 29, 2016 4:12 PM
</I>&gt;<i> To: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Shively, Gregory &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">gregory_shively at fanniemae.com</A>&gt;
</I>&gt;<i> Subject: [EXTERNAL] Re: [squid-dev] [PATCH] OSX transparent-proxy using
</I>&gt;<i> pfctl
</I>&gt;<i> 
</I>&gt;<i> On 09/29/2016 01:12 PM, Shively, Gregory wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Sometimes these mailing lists make me think like I'm talking to one
</I>&gt;<i> &gt; person :-).
</I>&gt;<i> 
</I>&gt;<i> Glad we all sound coherent to you :-)!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; ERROR: files left in build directory after distclean:
</I>&gt;<i> &gt; ./src/cf_gen.dSYM/Contents/Info.plist
</I>&gt;<i> &gt; ./src/cf_gen.dSYM/Contents/Resources/DWARF/cf_gen
</I>&gt;<i> 
</I>&gt;<i> &gt; I can run with the &quot;--keep-going&quot; flag, but that ends with a the
</I>&gt;<i> &gt; equivalent error in btlayer-05-no-deps-esi. Do I run it this way and
</I>&gt;<i> &gt; just grep the logs for FAIL or something?
</I>&gt;<i> 
</I>&gt;<i> Sounds like a good plan to me.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
I'll follow that plan then.

&gt;<i> &gt; I wasn't sure if I should handle it or let it flow up, since if it was
</I>&gt;<i> &gt; in an overflow state I would doubt I could handle this packet, but
</I>&gt;<i> &gt; maybe the next connection would be successful.
</I>&gt;<i> 
</I>&gt;<i> I recommend temporary adding an exception with Must(false) inside the
</I>&gt;<i> parsing code and testing what happens. This approach may give you enough
</I>&gt;<i> information to decide whether your code or the caller should be responsible
</I>&gt;<i> for handling parsing exceptions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
If I understand correctly, the Must(false) goes all the way up the stack to main and exits squid. If instead it falls thru and returns false - the connection will fail and the next connection another attempt at parsing. Or is the question that the call to token() or int64() throws an exception and how that is handled, e.g. put a try/catch block around the parsing?

&gt;<i> &gt; +    while ((n = read(pipefd[0], buf, sizeof(buf))) &gt; 0) {
</I>&gt;<i> &gt; +        state.append(buf);
</I>&gt;<i> 
</I>&gt;<i> You need to tell SBuf how much to append(). read(2) does not 0-terminate
</I>&gt;<i> buf!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; +    if (n == -1) {
</I>&gt;<i> &gt; +        int xerrno = errno;
</I>&gt;<i> 
</I>&gt;<i> Too late: errno may already be different after close().
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Thanks.

&gt;<i> &gt; +        // Move to EOL and try again from the next line
</I>&gt;<i> &gt; +        tk.token(host, lf);
</I>&gt;<i> 
</I>&gt;<i> If possible, use one of the skip() methods to avoid the implication that you
</I>&gt;<i> are parsing host here (and to save a couple of CPU cycles).
</I>&gt;<i> 
</I>&gt;<i> Please note that Tokenizer has a method to extract integers. I am not sure it
</I>&gt;<i> will help you here, but it might.
</I>&gt;<i> 
</I>
Thanks - I totally missed that method.

&gt;<i> &gt; +                newConn-&gt;local = host.c_str();
</I>&gt;<i> &gt; +                newConn-&gt;local.port(atol(port.c_str()));
</I>&gt;<i> &gt; +                debugs(89, 5, HERE &lt;&lt; &quot;address NAT: &quot; &lt;&lt; newConn);
</I>&gt;<i> &gt; +                return true;
</I>&gt;<i> 
</I>&gt;<i> &gt; +                newConn-&gt;local = host.c_str();
</I>&gt;<i> &gt; +                newConn-&gt;local.port(atol(port.c_str()));
</I>&gt;<i> &gt; +                debugs(89, 5, HERE &lt;&lt; &quot;address NAT: &quot; &lt;&lt; newConn);
</I>&gt;<i> 
</I>&gt;<i> If you can avoid code duplication, please do so.
</I>&gt;<i> 
</I>
Ok.

&gt;<i> &gt; +    CharacterSet bracket(&quot;bracket&quot;, &quot;[]&quot;);
</I>&gt;<i> &gt; +    CharacterSet colon(&quot;colon&quot;, &quot;:&quot;);
</I>&gt;<i> &gt; +    CharacterSet lf(&quot;lf&quot;, &quot;\n&quot;);
</I>&gt;<i> &gt; +    CharacterSet ws(&quot;ws&quot;, &quot; \t\r\n&quot;);
</I>&gt;<i> 
</I>&gt;<i> These should be declared as static to avoid allocating/initializing lots of bytes
</I>&gt;<i> on every access and as constant to help the optimizer (and to avoid future
</I>&gt;<i> bugs). And you can move them inside the loop then -- they are unused
</I>&gt;<i> outside the loop.
</I>&gt;<i> 
</I>&gt;<i> In general, declare variables as late as possible and make them const if
</I>&gt;<i> possible.
</I>
Makes sense.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-3.5.20-osx-devpf-transparent.patch
Type: application/octet-stream
Size: 3327 bytes
Desc: squid-3.5.20-osx-devpf-transparent.patch
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160929/4636e9c3/attachment.obj">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160929/4636e9c3/attachment.obj</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006890.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
	<LI>Next message: <A HREF="006893.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6892">[ date ]</a>
              <a href="thread.html#6892">[ thread ]</a>
              <a href="subject.html#6892">[ subject ]</a>
              <a href="author.html#6892">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
