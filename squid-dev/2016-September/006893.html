<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] OSX transparent-proxy using pfctl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3C196a1c33-e150-5a70-8454-4e3b336ec3f0%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006892.html">
   <LINK REL="Next"  HREF="006897.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] OSX transparent-proxy using pfctl</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3C196a1c33-e150-5a70-8454-4e3b336ec3f0%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] OSX transparent-proxy using pfctl">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 29 23:43:32 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006892.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
        <LI>Next message: <A HREF="006897.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6893">[ date ]</a>
              <a href="thread.html#6893">[ thread ]</a>
              <a href="subject.html#6893">[ subject ]</a>
              <a href="author.html#6893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/29/2016 03:48 PM, Shively, Gregory wrote:
&gt;&gt;&gt;<i> I wasn't sure if I should handle it or let it flow up, since if it was
</I>&gt;&gt;&gt;<i> in an overflow state I would doubt I could handle this packet, but
</I>&gt;&gt;&gt;<i> maybe the next connection would be successful.
</I>
&gt;&gt;<i> I recommend temporary adding an exception with Must(false) inside the
</I>&gt;&gt;<i> parsing code and testing what happens. This approach may give you enough
</I>&gt;&gt;<i> information to decide whether your code or the caller should be responsible
</I>&gt;&gt;<i> for handling parsing exceptions.
</I>


&gt;<i> If I understand correctly, the Must(false) goes all the way up the
</I>&gt;<i> stack to main and exits squid. If instead it falls thru and returns
</I>&gt;<i> false - the connection will fail and the next connection another
</I>&gt;<i> attempt at parsing.
</I>
Must(false) just throws an exception. Where that exception will be
caught before main() when thrown from your code, I do not know (perhaps
you already do). Must(false) is just a trick to check whether all
exceptions in your code will be caught/handled the way you want. The
alternative is to trigger real exceptions, but that is often a lot harder.

In general, we should be using as few try/catch as possible to
accomplish the desirable outcome. Thus, always adding try/catch &quot;just in
case&quot; is the wrong approach (I am _not_ saying you are doing that!).
Until Squid exception handling is improved, testing is often the best
way to find the right place.

If you decide that a try/catch is necessary, place it as high as
possible and please do not forget to print the caught exception. There
are examples in the code.


Please note that you do not have to catch exceptions even if they kill
Squid. The current lack of try/catchers around critical contexts is not
your problem. Add try/catch only if you think catching close to your new
code is necessary for your code to work well under more-or-less &quot;normal&quot;
conditions. I doubt it is currently necessary because you are not using
exceptions for benign errors.


&gt;<i> +    if (n == -1) {
</I>&gt;<i> +        int xerrno = errno;
</I>&gt;<i> +        debugs(89, DBG_IMPORTANT, HERE &lt;&lt; &quot;Reading from PFCTL failed: &quot; &lt;&lt; xstrerr(xerrno));
</I>&gt;<i> +        return false;
</I>&gt;<i> +    }
</I>&gt;<i> +
</I>&gt;<i> +    close(pipefd[0]);
</I>
Now leaking pipefd[0] on errors. Someday, Squid will have a auto-close
descriptor wrapper...


&gt;<i> +        SBuf host;
</I>&gt;<i> +        int64_t port;
</I>&gt;<i> +
</I>&gt;<i> +        if (tk.token(host, bracket) || tk.token(host, colon)) {
</I>
Nice rewrite! You can move the port declaration lower, and you should.
And no empty lines between the declaration and the single-statement code
that uses that declaration exclusively:

    SBuf host;
    if (...) {
       int64_t port = 0;
       if (...) ...
    }


&gt;<i> +    while (!tk.atEnd()) {
</I>&gt;<i> +        if (tk.token(host, bracket) || tk.token(host, colon)) {
</I>...
&gt;<i> +        }
</I>&gt;<i> +
</I>&gt;<i> +        tk.skip('\n');
</I>&gt;<i> +    }
</I>
An infinite loop if the actual input contains, say, a single space and
nothing else? Or a token without brackets and colons? That is unlikely,
of course, but perhaps not completely impossible. I am not dictating
code, but to skip an arbitrary bad line you might need something like
this at the end of an iteration:

  // the combination covers all characters so we will make progress
  (void)tk.skipAll(anythingButLf); // silently skip any garbage
  (void)tk.skipAll(lf))
  // either at the beginning of the next line or eof


BTW, I believe the previous version of your patch had a similar infinite
loop problem, but now it became obvious, thanks to your nice refactoring.


Thank you,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006892.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
	<LI>Next message: <A HREF="006897.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6893">[ date ]</a>
              <a href="thread.html#6893">[ thread ]</a>
              <a href="subject.html#6893">[ subject ]</a>
              <a href="author.html#6893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
