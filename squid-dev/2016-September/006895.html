<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Support concurrent SBuf::c_str() calls
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Support%20concurrent%20SBuf%3A%3Ac_str%28%29%20calls&In-Reply-To=%3C3753d1cf-65ac-3a68-5f0d-a33675ec32bf%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006888.html">
   <LINK REL="Next"  HREF="006903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Support concurrent SBuf::c_str() calls</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Support%20concurrent%20SBuf%3A%3Ac_str%28%29%20calls&In-Reply-To=%3C3753d1cf-65ac-3a68-5f0d-a33675ec32bf%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Support concurrent SBuf::c_str() calls">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 30 03:19:37 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006888.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
        <LI>Next message: <A HREF="006903.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6895">[ date ]</a>
              <a href="thread.html#6895">[ thread ]</a>
              <a href="subject.html#6895">[ subject ]</a>
              <a href="author.html#6895">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/09/2016 5:03 a.m., Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     The current trunk code contains at least two serious bugs caused by
</I>&gt;<i> SBuf::c_str() misuse. Both known bugs looks similar:
</I>&gt;<i> 
</I>&gt;&gt;<i> storeCreateEntry(storeUri.c_str(), storeUri.c_str(), ...);
</I>&gt;<i> 
</I>&gt;<i> and
</I>&gt;<i> 
</I>&gt;&gt;<i> storeCreateEntry(uri.c_str(), uri.c_str(), ...);
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Both use cases violate safe c_str() use conditions documented in the
</I>&gt;<i> long and occasionally YELLING description of that method. As you have
</I>&gt;<i> probably guessed by now, the c_str() method itself is not constant, so
</I>&gt;<i> calling c_str() twice often destroys the first c_str() result.
</I>&gt;<i> 
</I>&gt;<i> It is trivial to fix both violations, but it is very difficult to say
</I>&gt;<i> how many other similar violations are hidden in (or will be added to)
</I>&gt;<i> the code. I am sure we will continue to miss them during code reviews.
</I>&gt;<i> 
</I>&gt;<i> This particular problem is caused by the &quot;used storage size&quot; increment
</I>&gt;<i> in the SBuf::c_str() implementation:
</I>&gt;<i> 
</I>&gt;&gt;<i>     *rawSpace(1) = '\0'; // terminate the buffer
</I>&gt;&gt;<i>     ++store_-&gt;size; // protect the terminator character
</I>&gt;<i> 
</I>&gt;<i> The increment forces the second call to c_str() to re-allocate the
</I>&gt;<i> store, which usually destroys the still-in-use storage pointed to by the
</I>&gt;<i> first c_str() result.
</I>&gt;<i> 
</I>&gt;<i> If we remove the increment, then Squid will work as expected when using
</I>&gt;<i> two concurrent c_str() results.
</I>&gt;<i> 
</I>&gt;<i> With or without the increment, Squid may crash or misbehave when buggy
</I>&gt;<i> code appends to SBuf while a previous c_str() result is still in use:
</I>&gt;<i> With an increment, appending may destruct the previous c_str() buffer.
</I>&gt;<i> Without an increment, appending may overwrite the 0-terminator used by
</I>&gt;<i> the previous c_str() call.
</I>&gt;<i> 
</I>&gt;<i> Valgrind is able to detect the &quot;concurrent c_str()s&quot; bugs in the current
</I>&gt;<i> trunk. My Valgrind tests did not expose other related bugs when I
</I>&gt;<i> removed the increment, but that does not mean those other bugs do not
</I>&gt;<i> exist, of course.
</I>&gt;<i> 
</I>&gt;<i> Should we remove the increment to make concurrent c_str() calls safe?
</I>
The reason it exists remember is to prevent other SBuf sharing that
storage MemBuf from thinking they can append to the storage oer top of
the terminator. Given that we have no easy knowledge of how the c_str()
is going to be used by the recipient code we cannot guarantee lack of
terminator is safe.
 If we could then rawContent() should have been used instead of c_str().

Time to push SBuf usage forward and aggressively remove the need for
c_str()?

Cheers
Amos

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006888.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
	<LI>Next message: <A HREF="006903.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6895">[ date ]</a>
              <a href="thread.html#6895">[ thread ]</a>
              <a href="subject.html#6895">[ subject ]</a>
              <a href="author.html#6895">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
