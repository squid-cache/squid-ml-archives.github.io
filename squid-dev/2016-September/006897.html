<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] OSX transparent-proxy using pfctl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B902583F086E%40EXWCMS01.fanniemae.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006893.html">
   <LINK REL="Next"  HREF="006899.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] OSX transparent-proxy using pfctl</H1>
    <B>Shively, Gregory</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20OSX%20transparent-proxy%20using%20pfctl&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B902583F086E%40EXWCMS01.fanniemae.com%3E"
       TITLE="[squid-dev] [PATCH] OSX transparent-proxy using pfctl">gregory_shively at fanniemae.com
       </A><BR>
    <I>Fri Sep 30 15:04:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006893.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
        <LI>Next message: <A HREF="006899.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6897">[ date ]</a>
              <a href="thread.html#6897">[ thread ]</a>
              <a href="subject.html#6897">[ subject ]</a>
              <a href="author.html#6897">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Must(false) just throws an exception. Where that exception will be caught
</I>&gt;<i> before main() when thrown from your code, I do not know (perhaps you
</I>&gt;<i> already do). Must(false) is just a trick to check whether all exceptions in your
</I>&gt;<i> code will be caught/handled the way you want. The alternative is to trigger
</I>&gt;<i> real exceptions, but that is often a lot harder.
</I>&gt;<i> 
</I>&gt;<i> In general, we should be using as few try/catch as possible to accomplish the
</I>&gt;<i> desirable outcome. Thus, always adding try/catch &quot;just in case&quot; is the wrong
</I>&gt;<i> approach (I am _not_ saying you are doing that!).
</I>&gt;<i> Until Squid exception handling is improved, testing is often the best way to
</I>&gt;<i> find the right place.
</I>&gt;<i> 
</I>&gt;<i> If you decide that a try/catch is necessary, place it as high as possible and
</I>&gt;<i> please do not forget to print the caught exception. There are examples in the
</I>&gt;<i> code.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Please note that you do not have to catch exceptions even if they kill Squid.
</I>&gt;<i> The current lack of try/catchers around critical contexts is not your problem.
</I>&gt;<i> Add try/catch only if you think catching close to your new code is necessary
</I>&gt;<i> for your code to work well under more-or-less &quot;normal&quot;
</I>&gt;<i> conditions. I doubt it is currently necessary because you are not using
</I>&gt;<i> exceptions for benign errors.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
I think I'll just leave the exception handling for the caller then. There really isn't anything that can be done to resolve the exception in the callee.

&gt;<i> &gt; +    if (n == -1) {
</I>&gt;<i> &gt; +        int xerrno = errno;
</I>&gt;<i> &gt; +        debugs(89, DBG_IMPORTANT, HERE &lt;&lt; &quot;Reading from PFCTL failed: &quot;
</I>&gt;<i> &lt;&lt; xstrerr(xerrno));
</I>&gt;<i> &gt; +        return false;
</I>&gt;<i> &gt; +    }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +    close(pipefd[0]);
</I>&gt;<i> 
</I>&gt;<i> Now leaking pipefd[0] on errors. Someday, Squid will have a auto-close
</I>&gt;<i> descriptor wrapper...
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Thanks - I felt list I was missing something there :-).

&gt;<i> &gt; +        SBuf host;
</I>&gt;<i> &gt; +        int64_t port;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +        if (tk.token(host, bracket) || tk.token(host, colon)) {
</I>&gt;<i> 
</I>&gt;<i> Nice rewrite! You can move the port declaration lower, and you should.
</I>&gt;<i> And no empty lines between the declaration and the single-statement code
</I>&gt;<i> that uses that declaration exclusively:
</I>&gt;<i> 
</I>&gt;<i>     SBuf host;
</I>&gt;<i>     if (...) {
</I>&gt;<i>        int64_t port = 0;
</I>&gt;<i>        if (...) ...
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; +    while (!tk.atEnd()) {
</I>&gt;<i> &gt; +        if (tk.token(host, bracket) || tk.token(host, colon)) {
</I>&gt;<i> ...
</I>&gt;<i> &gt; +        }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +        tk.skip('\n');
</I>&gt;<i> &gt; +    }
</I>&gt;<i> 
</I>&gt;<i> An infinite loop if the actual input contains, say, a single space and nothing
</I>&gt;<i> else? Or a token without brackets and colons? That is unlikely, of course, but
</I>&gt;<i> perhaps not completely impossible. I am not dictating code, but to skip an
</I>&gt;<i> arbitrary bad line you might need something like this at the end of an
</I>&gt;<i> iteration:
</I>&gt;<i> 
</I>&gt;<i>   // the combination covers all characters so we will make progress
</I>&gt;<i>   (void)tk.skipAll(anythingButLf); // silently skip any garbage
</I>&gt;<i>   (void)tk.skipAll(lf))
</I>&gt;<i>   // either at the beginning of the next line or eof
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> BTW, I believe the previous version of your patch had a similar infinite loop
</I>&gt;<i> problem, but now it became obvious, thanks to your nice refactoring.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
You are right - there is an infinite loop. I started to play with the tokenizing after I sent the patch and didn't see the infinite loop, but I don't think it is doing what I was attempting in the loop anyway. How about I get rid of the loop all together - I should be only getting one line from pfctl, and if the parsing fails -I should probably just be returning false anyway instead of attempting to find what I expect later in the buffer. I was trying to be safe from the parsing, but I'm starting to think I should just fail out of the parsing if the buffer doesn't have what I expect. 

&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
A different question - I'm wondering if I should move where this conditional compilation is being placed with regard to the other conditional compilation. I had put it in based on what the last compilation options I had used when attempting to get this working before looking in the code. I didn't know if this would be enabled by configure or some other macro that might be defined on OSX. But it looks like I have it inside the conditional compilation for !USE_NAT_DEVPF. Do you think it should be moved?

Regarding the test_builds.sh - got it to run with the --keep-going and grepped out of the logs - only PASS in the summary section. This was with the current patch. I'll run it again, but at least know that it is working.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-3.5.20-osx-devpf-transparent.patch
Type: application/octet-stream
Size: 3141 bytes
Desc: squid-3.5.20-osx-devpf-transparent.patch
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160930/f0d066e0/attachment.obj">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20160930/f0d066e0/attachment.obj</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006893.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
	<LI>Next message: <A HREF="006899.html">[squid-dev] [PATCH] OSX transparent-proxy using pfctl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6897">[ date ]</a>
              <a href="thread.html#6897">[ thread ]</a>
              <a href="subject.html#6897">[ subject ]</a>
              <a href="author.html#6897">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
