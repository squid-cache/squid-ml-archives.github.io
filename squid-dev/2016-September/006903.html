<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Support concurrent SBuf::c_str() calls
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Support%20concurrent%20SBuf%3A%3Ac_str%28%29%20calls&In-Reply-To=%3C42d5b9c8-873c-9416-842e-b5235207b2b9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="006895.html">
   <LINK REL="Next"  HREF="006891.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Support concurrent SBuf::c_str() calls</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Support%20concurrent%20SBuf%3A%3Ac_str%28%29%20calls&In-Reply-To=%3C42d5b9c8-873c-9416-842e-b5235207b2b9%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] Support concurrent SBuf::c_str() calls">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep 30 17:03:25 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="006895.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
        <LI>Next message: <A HREF="006891.html">[squid-dev] Build failed in Jenkins: trunk-full-matrix » clang,d-ubuntu-wily #237
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6903">[ date ]</a>
              <a href="thread.html#6903">[ thread ]</a>
              <a href="subject.html#6903">[ subject ]</a>
              <a href="author.html#6903">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/29/2016 09:19 PM, Amos Jeffries wrote:
&gt;<i> On 30/09/2016 5:03 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> Should we remove the increment to make concurrent c_str() calls safe?
</I>
&gt;<i> The reason it exists remember is to prevent other SBuf sharing that
</I>&gt;<i> storage MemBuf from thinking they can append to the storage oer top of
</I>&gt;<i> the terminator. 
</I>
Yes, I know, but that increment not only prevents problems but _causes_
them as well: The increment may force the SBuf to realloc, which may
result in deallocation of the original storage still pointed to by the
earlier c_str() result.


&gt;<i> Given that we have no easy knowledge of how the c_str()
</I>&gt;<i> is going to be used by the recipient code we cannot guarantee lack of
</I>&gt;<i> terminator is safe.
</I>
Yes, with or without the increment, Squid may crash or misbehave when
buggy code appends to SBuf while a previous c_str() result is still in
use. The lack of increment is not safe. The presence of the increment is
not safe. The problems are different, but they exist with or without the
increment.


&gt;<i> Time to push SBuf usage forward and aggressively remove the need for
</I>&gt;<i> c_str()?
</I>
The need for c_str() will never go away because libraries outside of
Squid control need c-strings. And, due to the lack of proper QA, any
&quot;aggressive push&quot; affecting lots of Squid code is a recipe for a
disaster IMO.

The question is which c_str() implementation is safer? The one that may
crash Squid when called twice for the same SBuf in the same expression
or the one that may crash Squid when appending to the same SBuf in the
same expression? There are already two known cases of the former. There
are currently no known cases of the latter.


Overall, I know of three primary ways to implement c_str():

1. Always 0-terminate SBuf-used storage. Safest implementation possible,
but has serious negative performance overheads, especially for tokenizing.

2. Terminate the used storage at the time of c_str().

    2a. Increment the used storage size. Current implementation.
        Leads to problems discussed in this thread.

    2b. Do not increment the used storage size.
        Leads to other problems discussed in this thread.

3. Allocate and store a new c-string as needed, copying from the
storage. Safest implementation possible but has serious negative
performance overheads. These overheads affect different use cases than
those of #1.

Needless to say, we can add clever code to reduce risks associated with
some implementations. For example (these are just rough sketches/ideas):

a) Appending code in #2b can check whether it is about to overwrite the
0-terminator added by a previous c_str() call and, if yes, preserve the
old storage (we can preserve one such storage or maintain a global FIFO
queue).

b) C-string allocating code in #4 can maintain a global FIFO queue of
previously allocated but now supposedly unused c-strings to minimize the
risk of de-allocating a still used c-string.

c) C-string allocating code in #4 can delay allocation until it might be
needed, similar to how (a) decides that the 0-terminator is in danger.


Going forward, do you think we should:

i. Keep using #2a and rewrite the known double-c_str() code.
ii. Make double-c_str() code safe (i.e., switch to #2b).
iii. Add code to make the existing #2 implementation safer.
iiii. Switch to a completely different implementation like #1 or #4.


Thank you,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006895.html">[squid-dev] [RFC] Support concurrent SBuf::c_str() calls
</A></li>
	<LI>Next message: <A HREF="006891.html">[squid-dev] Build failed in Jenkins: trunk-full-matrix » clang,d-ubuntu-wily #237
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6903">[ date ]</a>
              <a href="thread.html#6903">[ thread ]</a>
              <a href="subject.html#6903">[ subject ]</a>
              <a href="author.html#6903">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
