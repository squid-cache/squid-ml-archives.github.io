<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Refactor TLS session extra data management
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Refactor%20TLS%20session%20extra%20data%20management&In-Reply-To=%3C1b2a6cde-dfbd-a743-9bba-7c18eafbc251%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008537.html">
   <LINK REL="Next"  HREF="008539.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Refactor TLS session extra data management</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Refactor%20TLS%20session%20extra%20data%20management&In-Reply-To=%3C1b2a6cde-dfbd-a743-9bba-7c18eafbc251%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Refactor TLS session extra data management">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Apr 21 03:58:36 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008537.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
        <LI>Next message: <A HREF="008539.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8538">[ date ]</a>
              <a href="thread.html#8538">[ thread ]</a>
              <a href="subject.html#8538">[ subject ]</a>
              <a href="author.html#8538">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/20/2017 04:50 PM, Amos Jeffries wrote:

&gt;<i> These two patches begin the refactoring work to replace OpenSSL
</I>&gt;<i> SSL_set/get_ex_data() API with a generic libsecurity API.
</I>
Thank you for working on this. I think the patch is on the right track
overall, but I found one bug, and I believe the proposed GetFrom() API
needs to be revised.

I also object to adding any code that calls TLS connections &quot;sessions&quot;,
especially when we already have code that calls TLS sessions &quot;sessions&quot;.
If at all possible, please fix the naming in the existing code (as
already discussed elsewhere) before adding any new stuff that makes the
problem worse.

Details below.


&gt;<i> +/// extra data which we attach to a TLS session
</I>
s/session/connection/


&gt;<i> +/// extra data which we attach to a TLS session
</I>&gt;<i> +class ExtraData
</I>
Please avoid names that end with State, Data, Info, Object, Status, and
similar noise/placeholder words without any specific meaning. In this
particular case, the class should be named ConnectionExtras and
described as &quot;Squid-specific TLS connection details&quot; or something like
that. The variables holding class objects should then become &quot;extras&quot;
instead of &quot;data&quot;.


&gt;<i> +    /// \retval nullptr only if session is nullptr
</I>&gt;<i> +    static Security::ExtraData *GetFrom(const SessionPointer &amp;);
</I>
The patch contains:

* code that asserts if GetFrom() returns nil
* code that crashes if GetFrom() returns nil
* code that pointlessly checks whether GetFrom() returns nil

I did not see any code that actually expects a nil connection pointer
and can handle it correctly.

The method itself does not store the TLS connection so it should not
need a pointer to one.

To avoid multiplying these problems beyond the patch, please change the
method to accept a reference to the connection (instead of a pointer)
and return a reference to ConnectionExtras (instead of a pointer).

Please s/GetFrom/Of/ or, if you insist, s/GetFrom/From/ to shorten the
name and emphasize that this is not just an existing extras retrieval
method. From the caller point of view, all connections have a valid
extras object (and that is a good thing!).


&gt;<i> -        if (hostName)
</I>&gt;<i> -            SSL_set_ex_data(serverSession.get(), ssl_ex_index_server, (void*)hostName);
</I>&gt;<i> +        if (hostName.isEmpty()) {
</I>
You want the opposite condition. AFAICT, this bug implies that the
changes were essentially untested. Please explicitly disclose untested
patches.


&gt;<i> -        SBuf *hostName = NULL;
</I>&gt;<i> +        SBuf hostName;
</I>
Or perhaps we can do the following instead?

  SBuf &amp;hostName = extras-&gt;sni;


&gt;<i> +    Security::SessionPointer session(ssl, [](SSL *){/* do not destroy */});
</I>
This ugly hack will no longer be needed after the above changes AFAICT.


&gt;<i> +class ExtraData
</I>&gt;<i> +{
</I>&gt;<i> +public:
</I>&gt;<i> +    SBuf sni;
</I>
This member may not actually contain an SNI extension value (neither
sent nor received). Let's not lie to ourselves and call it serverName.

Please document new data members. Consider:

  /// suspected or actual connection destination (from various sources)
  SBuf serverName;


&gt;<i> -                sniServer = !request-&gt;url.hostIsNumeric() ? request-&gt;url.host() : NULL;
</I>&gt;<i> +                sniServer = !request-&gt;url.hostIsNumeric() ? request-&gt;url.host() : nullptr;
</I>
An out-of-scope change.


&gt;<i>              // validationRequest disappears on return so no need to cbdataReference
</I>&gt;<i>              validationRequest.errors = errs;
</I>&gt;<i> +
</I>&gt;<i>          try {
</I>
An out-of-scope change.


Thank you,

Alex.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008537.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
	<LI>Next message: <A HREF="008539.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8538">[ date ]</a>
              <a href="thread.html#8538">[ thread ]</a>
              <a href="subject.html#8538">[ subject ]</a>
              <a href="author.html#8538">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
