<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Refactor TLS session extra data management
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Refactor%20TLS%20session%20extra%20data%20management&In-Reply-To=%3Cefa9e6a9-9601-3860-0563-e2fb7ab30732%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008538.html">
   <LINK REL="Next"  HREF="008541.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Refactor TLS session extra data management</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Refactor%20TLS%20session%20extra%20data%20management&In-Reply-To=%3Cefa9e6a9-9601-3860-0563-e2fb7ab30732%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Refactor TLS session extra data management">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Apr 22 12:52:33 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008538.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
        <LI>Next message: <A HREF="008541.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8539">[ date ]</a>
              <a href="thread.html#8539">[ thread ]</a>
              <a href="subject.html#8539">[ subject ]</a>
              <a href="author.html#8539">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/04/17 15:58, Alex Rousskov wrote:
&gt;<i> On 04/20/2017 04:50 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> These two patches begin the refactoring work to replace OpenSSL 
</I>&gt;&gt;<i> SSL_set/get_ex_data() API with a generic libsecurity API. 
</I>&gt;<i> Thank you for working on this. I think the patch is on the right track 
</I>&gt;<i> overall, but I found one bug, and I believe the proposed GetFrom() API 
</I>&gt;<i> needs to be revised. I also object to adding any code that calls TLS 
</I>&gt;<i> connections &quot;sessions&quot;, especially when we already have code that 
</I>&gt;<i> calls TLS sessions &quot;sessions&quot;. If at all possible, please fix the 
</I>&gt;<i> naming in the existing code (as already discussed elsewhere) before 
</I>&gt;<i> adding any new stuff that makes the problem worse. 
</I>
Lets not get bogged down in that again.

&gt;<i> Details below.
</I>&gt;&gt;<i> +/// extra data which we attach to a TLS session 
</I>&gt;<i> s/session/connection/ 
</I>
No this data is explicitly not part of the &quot;TLS connection&quot;. It persists 
long after the &quot;TLS connection&quot; is ended and may be shared across 
multiple if and when the &quot;TLS session&quot; does so.


&gt;&gt;<i> +/// extra data which we attach to a TLS session +class ExtraData 
</I>&gt;<i> Please avoid names that end with State, Data, Info, Object, Status, 
</I>&gt;<i> and similar noise/placeholder words without any specific meaning. In 
</I>&gt;<i> this particular case, the class should be named ConnectionExtras and 
</I>&gt;<i> described as &quot;Squid-specific TLS connection details&quot; or something like 
</I>&gt;<i> that. The variables holding class objects should then become &quot;extras&quot; 
</I>&gt;<i> instead of &quot;data&quot;. 
</I>
OpenSSL calls this &quot;ex_data&quot; and GnuTLS calls it a &quot;datum pointer&quot;, in 
both cases it is documented as being attached to a session. They are 
definitely NOT destructed when the connection is ended.


&gt;&gt;<i> + /// \retval nullptr only if session is nullptr + static 
</I>&gt;&gt;<i> Security::ExtraData *GetFrom(const SessionPointer &amp;); 
</I>&gt;<i> The patch contains: * code that asserts if GetFrom() returns nil * 
</I>&gt;<i> code that crashes if GetFrom() returns nil * code that pointlessly 
</I>&gt;<i> checks whether GetFrom() returns nil I did not see any code that 
</I>&gt;<i> actually expects a nil connection pointer and can handle it correctly.
</I>
Specific alternatives would be useful. I'm looking at a mix of code that 
can only occur when a SessionPointer is available [use without checks], 
code that can occur with or without one [check with an if], and code 
that I'm not sure of its status [check with an if where possible, or an 
assert as alternative to risking segfault].

&gt;<i> The method itself does not store the TLS connection so it should not 
</I>&gt;<i> need a pointer to one.
</I>
Since when was it a requirement that all function parameters were 
stored? it is being _used_.

Regardless of what that parameter is called it is the object that our 
class is being attached to. So yes it is absolutely needed.


&gt;<i> To avoid multiplying these problems beyond the patch, please change 
</I>&gt;<i> the method to accept a reference to the connection (instead of a 
</I>&gt;<i> pointer) and return a reference to ConnectionExtras (instead of a 
</I>&gt;<i> pointer).
</I>
Er, did you read the pt1 code? The pointer received is passed on to the 
underlying library API. Using a reference to an object instance of 
unknown type is not doable. And we also agreed that mixing smart and raw 
pointers in our API was a bad idea.


The connection is not accessible in most places this function is called. 
What we have reliably is a pointer to the session state where our object 
is (to be) associated. Sometimes that session has a connection, but half 
of the calls are at times before the TLS session initiates a TLS connection.


&gt;<i> Please s/GetFrom/Of/ or, if you insist, s/GetFrom/From/ to shorten the 
</I>&gt;<i> name and emphasize that this is not just an existing extras retrieval 
</I>&gt;<i> method. From the caller point of view, all connections have a valid 
</I>&gt;<i> extras object (and that is a good thing!).
</I>&gt;&gt;<i> - if (hostName) - SSL_set_ex_data(serverSession.get(), 
</I>&gt;&gt;<i> ssl_ex_index_server, (void*)hostName); + if (hostName.isEmpty()) { 
</I>&gt;<i> You want the opposite condition. AFAICT, this bug implies that the 
</I>&gt;<i> changes were essentially untested. Please explicitly disclose untested 
</I>&gt;<i> patches. 
</I>
Thanks for the catch.

That code path is untested by me, yes. I cannot test the OpenSSL code 
changes, and thought I'd stated that enough by now. It is one of the 
reasons I'm going about these patches so slowly and piece-wise.


&gt;&gt;<i> - SBuf *hostName = NULL; + SBuf hostName; 
</I>&gt;<i> Or perhaps we can do the following instead? SBuf &amp;hostName = extras-&gt;sni; 
</I>
Nice. Done.

&gt;&gt;<i> + Security::SessionPointer session(ssl, [](SSL *){/* do not destroy 
</I>&gt;&gt;<i> */}); 
</I>&gt;<i> This ugly hack will no longer be needed after the above changes AFAICT. 
</I>
No such luck. At least it is part of the callback state preparation.

&gt;&gt;<i> +class ExtraData +{ +public: + SBuf sni; 
</I>&gt;<i> This member may not actually contain an SNI extension value (neither 
</I>&gt;<i> sent nor received). Let's not lie to ourselves and call it serverName. 
</I>&gt;<i> Please document new data members. Consider: /// suspected or actual 
</I>&gt;<i> connection destination (from various sources) SBuf serverName; 
</I>
Sigh. Ironicly it started as that. Then realized the value being stored 
there was SNI or an SNI-to-be value.

&gt;&gt;<i> - sniServer = !request-&gt;url.hostIsNumeric() ? request-&gt;url.host() : 
</I>&gt;&gt;<i> NULL; + sniServer = !request-&gt;url.hostIsNumeric() ? 
</I>&gt;&gt;<i> request-&gt;url.host() : nullptr; 
</I>&gt;<i> An out-of-scope change.
</I>&gt;&gt;<i> // validationRequest disappears on return so no need to 
</I>&gt;&gt;<i> cbdataReference validationRequest.errors = errs; + try { 
</I>&gt;<i> An out-of-scope change. Thank you, Alex.
</I>

Removed those.

Amos
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Security_ExtraData_pt1_mk2.patch
Type: text/x-patch
Size: 3689 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170423/144d9782/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170423/144d9782/attachment.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Security_ExtraData_pt2_mk2.patch
Type: text/x-patch
Size: 9201 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170423/144d9782/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170423/144d9782/attachment-0001.bin</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008538.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
	<LI>Next message: <A HREF="008541.html">[squid-dev] [PATCH] Refactor TLS session extra data management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8539">[ date ]</a>
              <a href="thread.html#8539">[ thread ]</a>
              <a href="subject.html#8539">[ subject ]</a>
              <a href="author.html#8539">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
