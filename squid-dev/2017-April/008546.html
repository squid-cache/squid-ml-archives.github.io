<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] switch session/connection for OpenSSL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20switch%20session/connection%20for%20OpenSSL&In-Reply-To=%3C8b9d80be-efe9-4818-7580-22046aafcdcb%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008544.html">
   <LINK REL="Next"  HREF="008545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] switch session/connection for OpenSSL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20switch%20session/connection%20for%20OpenSSL&In-Reply-To=%3C8b9d80be-efe9-4818-7580-22046aafcdcb%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] switch session/connection for OpenSSL">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Apr 26 17:24:22 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008544.html">[squid-dev] [PATCH] switch session/connection for OpenSSL
</A></li>
        <LI>Next message: <A HREF="008545.html">[squid-dev] [PATCH] shuffle remaining session cache code to	libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8546">[ date ]</a>
              <a href="thread.html#8546">[ thread ]</a>
              <a href="subject.html#8546">[ subject ]</a>
              <a href="author.html#8546">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/26/2017 06:53 AM, Amos Jeffries wrote:
&gt;<i> Been digging around in library guts and yes you were right Alex - for
</I>&gt;<i> OpenSSL and the very old ones based on SSL protocol. Just not for the
</I>&gt;<i> other N libraries based on TLS design which I/we hope to support. There
</I>&gt;<i> is structural difference between the two protocols layering and activities.
</I>
I am afraid you still do not fully understand the TLS connection concept
if you think our disagreement can be resolved based on how library X
calls something (or if you think that SSL connections exist but TLS
connections do not). The existence of a TLS connection in Squid context
is real, regardless of how libraries distinguish TLS sessions from TLS
connections. I used OpenSSL's SSL type only as one of many ways to
&quot;point&quot; to that concept.

(definitions for TLS connection and session concepts are further below)

We do not control 3rd party library designs. Our task is to map Squid
concepts to library concepts. Depending on the library, sometimes this
mapping looks &quot;natural&quot; and sometimes it does not. Library mappings is
an important but secondary problem compared to the primary problem of
identifying key concepts such as TLS connections and sessions.

I feel that the initial patch tries to avoid using &quot;TLS connection&quot; as a
valid concept. This approach is painful for me to watch because, on one
hand, the patch is fixing a few names, but, on the other hand, it
shovels your dissatisfaction into most fixes. If you are willing to fix
this even though I have not convinced you that TLS connections (as a
concept) exist, then pretend that they do. You cannot fix this properly
while pretending that they do not exist!

Finally, while GnuTLS calls its primary handler gnutls_session_t, it
clearly accesses connection (not session!) associated details through
that handler (e.g., GNUTLS_DATAGRAM and GNUTLS_NONBLOCK options have
nothing to do with TLS sessions but are set using gnutls_session_t). As
GnuTLS adds more TLS connection-specific features, you may feel more
comfortable with the idea that TLS connections exist even if the GnuTLS
primary handler is named after a different concept.


&gt;<i> I'm labeling the patch revert, but it is not a true revert as that would
</I>&gt;<i> unwind much other progress and bug fixes. 
</I>
I agree that it is too late to revert the commits that called TLS
connection a &quot;session&quot;. This patch starts fixing names and descriptions
of things related to TLS connections and sessions, and that is what we
should be doing at this point. Thank you.


&gt;<i> -Ssl::IcapPeerConnector::initialize(Security::SessionPointer &amp;serverSession)
</I>&gt;<i> +Ssl::IcapPeerConnector::initialize(Security::ConnectionPointer &amp;serverSession)
</I>
and

&gt;<i> -Security::BlindPeerConnector::initialize(Security::SessionPointer &amp;serverSession)
</I>&gt;<i> +Security::BlindPeerConnector::initialize(Security::ConnectionPointer &amp;serverSession)
</I>
s/serverSession/serverConnection/ or even simply
s/serverSession/server/

Please check for other similar occurrences -- no ConnectionPointer
object should be called &quot;session&quot; after these changes, including
GnuTLS-only code and debugs() text.


&gt;<i> +    Security::ConnectionPointer theAnSsl(fd_table[fd].ssl);
</I>
No &quot;the&quot; prefixes for local variables please. Those prefixes should be
used exclusively for (old) class data members. (Not to mention that
following &quot;the&quot; with &quot;a[n]&quot; does not make sense because the two
determiners are mutually exclusive.)

s/theAnSsl/ssl/ or, if you prefer,
s/theAnSsl/tls/ or
s/theAnSsl/tlsConnection/


&gt;<i> +// When Squid is built with GnuTLS this is a handle used to reference the TLS session.
</I>&gt;<i> +// When Squid is built against OpenSSL this is a pointer to a TLS connection,
</I>
The above text tries to make the concept of a TLS connection depend on
the library. The concept exists (in Squid) regardless of the library
used. We need to define and use that concept uniformly across all
libraries instead of constantly asking ourselves &quot;Wait, which library
has created this Connection pointer?&quot;.

I suggest this replacement text (shown without proper formatting):

// TLS connection is TLS info about communication over a
// single transport connection between two peers.
// TLS session is TLS info about security arrangements between two
// peers. Those two peers may stop and later resume communication.
// TLS sessions are typically created inside TLS connections.
// A TLS connection may reuse/resume a previously created TLS session.
// With session resumption, many concurrent TLS connections may be
// associated with a single TLS session.

/// points to a library-specific object for TLS connection manipulation
#if USE_OPENSSL
typedef std::shared_ptr&lt;SSL&gt; ConnectionPointer;
...

The top comment blob applies to both security/Session.h and
security/Connection.h. I suspect that the best location for that comment
is actually security/Context.h (and we should add text that defines what
Security::Context is, of course).

Needless to say, I would be happy if we can come up with better
definitions or even better concepts. The above is a starting point.


&gt;<i> +//  ... which gets indirectly de-referenced to manage the TLS session state.
</I>
Please remove this sentence. OpenSSL uses the Connection pointer for
more things than access to the underlying TLS session.


&gt;<i> + * Initializes the data structures for a TLS session with a remote server/peer
</I>&gt;<i> + * and associates them with the given transport connection.
</I>
Given the definitions provided above, this description becomes (shown
here without proper formatting):

/// Creates a TLS connection for communicating with a remote server/peer
over the given opened transport connection. Stores the result in
fd_table[].ssl. Does no I/O (e.g., does not initiate a TLS handshake).

(I also added/polished details after the first sentence.)


&gt;<i> + * Initializes the data structures for a TLS session with a remote client
</I>&gt;<i> + * and associates them with the given transport connection.
</I>
Similarly (except servers do not initiate handshakes):

/// Creates a TLS connection for communicating with a remote client over
the given accepted transport connection. Stores the result in
fd_table[].ssl. Does no I/O (e.g., does not read the TLS client handshake).

Since CreateClient does not create a client and since we often use
&quot;client connection&quot; to mean the opposite of what CreateClient creates, I
suggest:

  s/CreateClient/PrepareToConnect/
  s/CreateServer/PrepareToAccept/


&gt;<i> +/// 'Close' a given TLS connection (if any) by sending the shutdown/bye notice.
</I>
Please remove the quotes around Close. &quot;Close&quot; is the correct term! What
this description is missing is whether this TLS closure is synchronous.

* If it is asynchronous, then the correct description would be something
like this:

/// Initiates TLS connection closure by sending a close_notify alert.
/// Squid may still receive TLS records from the peer after this call.

* If it is synchronous, then the correct description would be something
like this:

/// Synchronously closes the TLS connection. No communication over this
TLS connection is possible after this call.


&gt;<i> +inline Security::ContextPointer
</I>&gt;<i> +GetFrom(Security::ConnectionPointer &amp;p)
</I>
This API is wrong -- one can &quot;get&quot; many different things from a
connection and C++ cannot overload based on function return types. This
function should be named ContextOf() instead.

I also suspect (but have not checked) that it should return the context
instead of an extremely dangerous locking-unaware pointer that pretends
to be locking-aware.

I do not know whether fixing either of those flaws is in scope. If you
have to change callers for other reasons, then renaming (at least) is.


&gt;<i> +Security::ConnectionPointer NewSslObject(const Security::ContextPointer &amp;);
</I>
s/NewSslObject/NewConnection/


&gt;<i>      /// Calls parent initialize(), configures the created TLS session object
</I>
s/session object/connection/

&gt;<i> +        errAction = &quot;failed to allocate handle&quot;;
</I>...
&gt;<i> +        errAction = &quot;failed to initialize session&quot;;
</I>
Keep these identical or at least symmetric. Both refer to exactly the
same error from the caller point of view. For example:

* failed to create a TLS connection handle
* failed to create a TLS connection handle

The fewer differences we have between GnuTLS and OpenSSL code, the
better, but, if insist on propagating the exact library used here, then
something like this may work:

* OpenSSL failed to create a TLS connection handle
* GnuTLS failed to create a TLS connection handle

The fact that GnuTLS calls the handle type &quot;gnutls_session_t&quot; is
irrelevant from the library-agnostic Squid code point of view, and that
errAction variable is for that library-agnostic code. The
Security::ErrorString() will expose the necessary library-specific
details...


&gt;<i> +                peer-&gt;secure.updateSessionOptions(handle);
</I>&gt;<i> +            else
</I>&gt;<i> +                Security::ProxyOutgoingConfig.updateSessionOptions(handle);
</I>
s/updateSessionOptions/setOptions/

This renaming avoids doubts whether anything in the parsedOptions data
member may affect the TLS connection rather than just the TLS session.

The updateSessionOptions() implementation should refer to the handle as
connection, of course.


Please grep recent changes for other cases where the code may be using
the term &quot;session&quot; instead of &quot;connection&quot; in TLS context.


Thank you,

Alex.

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008544.html">[squid-dev] [PATCH] switch session/connection for OpenSSL
</A></li>
	<LI>Next message: <A HREF="008545.html">[squid-dev] [PATCH] shuffle remaining session cache code to	libsecurity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8546">[ date ]</a>
              <a href="thread.html#8546">[ thread ]</a>
              <a href="subject.html#8546">[ subject ]</a>
              <a href="author.html#8546">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
