<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] xstrndup has to go
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20xstrndup%20has%20to%20go&In-Reply-To=%3C9eb6eaa5-a014-216d-ea65-1147c6ada27c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008556.html">
   <LINK REL="Next"  HREF="008553.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] xstrndup has to go</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20xstrndup%20has%20to%20go&In-Reply-To=%3C9eb6eaa5-a014-216d-ea65-1147c6ada27c%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] xstrndup has to go">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Apr 26 22:58:44 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008556.html">[squid-dev] [PATCH] shuffle remaining session cache code to libsecurity
</A></li>
        <LI>Next message: <A HREF="008553.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8547">[ date ]</a>
              <a href="thread.html#8547">[ thread ]</a>
              <a href="subject.html#8547">[ subject ]</a>
              <a href="author.html#8547">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    I accidentally discovered that our xstrndup() documentation lies and
its implementation is dangerously nothing like the standard one. The
attached patch fixes documentation and three callers. Please see the
patch preamble for details, including lack of ESI testing.

The attached patch is NOT the right long-term solution because folks
will, naturally, continue to use xstrndup(SQUID) as if it is strndup(3),
leading to new caller bugs.

Unfortunately, just fixing xstrndup() implementation and callers is not
enough! If we fix xstrndup() implementation (and existing callers) in
v5, then any new caller code ported to an older Squid version may break
in subtle ways (because that old Squid version assumes 0-termination and
requires &quot;+1s&quot; to work correctly). No human will be able to spot such
porting errors reliably.

Thus, it looks like we have to rename xstrndup(), forcing porting humans
to notice the change in the API and adjust the callers. I can suggest
xstrndupe() or bufDupe() as the new name.

Would anybody volunteer to fix this for the long-term?


Thank you,

Alex.
P.S. The OutOfBoundsException use case code fixed by this patch needs a
different fix (the one that does not allocate memory twice):

  xstrndup(explanatoryText.rawContent(), explanatoryText.length());

but we cannot do the above until xstrndup() implementation is fixed.

P.P.S. I did not find any callers that are likely to crash because of
our incorrect xstrndup() implementation, although some callers will
crash if String is changed to use unterminated raw buffers again:

   xstrndup(value.rawBuf(), value.size() + 1);
-------------- next part --------------
A non-text attachment was scrubbed...
Name: xstrndup-is-not-t3.patch
Type: text/x-diff
Size: 7214 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170426/6f62cc50/attachment.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170426/6f62cc50/attachment.patch</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008556.html">[squid-dev] [PATCH] shuffle remaining session cache code to libsecurity
</A></li>
	<LI>Next message: <A HREF="008553.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8547">[ date ]</a>
              <a href="thread.html#8547">[ thread ]</a>
              <a href="subject.html#8547">[ subject ]</a>
              <a href="author.html#8547">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
