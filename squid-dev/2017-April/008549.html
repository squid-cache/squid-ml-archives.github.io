<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Do not revive unconditionally dead peers after	DNS refresh
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20revive%20unconditionally%20dead%20peers%20after%0A%09DNS%20refresh&In-Reply-To=%3Ce3dac8a8-17a6-bb4c-7203-f139c549cf67%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008555.html">
   <LINK REL="Next"  HREF="008558.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Do not revive unconditionally dead peers after	DNS refresh</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20revive%20unconditionally%20dead%20peers%20after%0A%09DNS%20refresh&In-Reply-To=%3Ce3dac8a8-17a6-bb4c-7203-f139c549cf67%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Do not revive unconditionally dead peers after	DNS refresh">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Thu Apr 27 20:39:15 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008555.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
        <LI>Next message: <A HREF="008558.html">[squid-dev] A new 'has' ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8549">[ date ]</a>
              <a href="thread.html#8549">[ thread ]</a>
              <a href="subject.html#8549">[ subject ]</a>
              <a href="author.html#8549">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

This patch fixes peer reviving mechanism for DNS refreshes.

Every hour, peerRefreshDNS() performs a DNS lookup of all cache_peer
addresses. Before this patch, even if DNS lookup results did not change,
the associated peerDNSConfigure() code silently cleared dead peer
marking, if any (CachePeer::tcp_up counter).  Forcefully reviving dead
peers every hour can lead to transaction delays (and delays may lead to
failures) due to connection timeouts when using a still dead peer.

This patch starts standard TCP probing instead of pointless dead peer
reviving, correctly refreshing peer state.  The primary goal is to cover
situation when DNS refresh changes peer addresses list. However TCP
probing may be useful for other situations either, without much overhead
(that is why it starts unconditionally).  For example, we need it when
DNS refresh returns the same addresses list but in different order. Also
it should help with dead idle dead peers detection.


Thanks,
Eduard.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-287-do-not-revive-dead-peers-after-dns-refresh-t1.patch
Type: text/x-patch
Size: 3400 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170427/bfecb949/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170427/bfecb949/attachment.bin</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008555.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
	<LI>Next message: <A HREF="008558.html">[squid-dev] A new 'has' ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8549">[ date ]</a>
              <a href="thread.html#8549">[ thread ]</a>
              <a href="subject.html#8549">[ subject ]</a>
              <a href="author.html#8549">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
