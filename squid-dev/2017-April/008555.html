<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] xstrndup has to go
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20xstrndup%20has%20to%20go&In-Reply-To=%3C3def24cb-dd4a-b9f4-b895-2ec6c0209530%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008553.html">
   <LINK REL="Next"  HREF="008549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] xstrndup has to go</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20xstrndup%20has%20to%20go&In-Reply-To=%3C3def24cb-dd4a-b9f4-b895-2ec6c0209530%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] xstrndup has to go">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Apr 29 16:17:56 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008553.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
        <LI>Next message: <A HREF="008549.html">[squid-dev] [PATCH] Do not revive unconditionally dead peers after	DNS refresh
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8555">[ date ]</a>
              <a href="thread.html#8555">[ thread ]</a>
              <a href="subject.html#8555">[ subject ]</a>
              <a href="author.html#8555">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/29/2017 02:33 AM, Amos Jeffries wrote:

&gt;<i> If that is too hard, making callers do the allocate bit themselves and
</I>&gt;<i> xstrncpy() instead should be a good medium-term workaround.
</I>
In general, it is impossible to correctly replace strndup() with a
simple allocate and strncpy() pair. I bet this impossibility is why
strndup() exists! strndup() is not a convenience function, but an
irreplaceable tool in a performance toolbox.

Why is it impossible in general? Because you do not know how many bytes
to allocate (that number may be much smaller than n) and you cannot use
strlen() to find out because the array may not be 0-terminated. You need
strnlen(), which is usually not available where strndup() is not.


&gt;&gt;<i> P.S. The OutOfBoundsException use case code fixed by this patch needs a
</I>&gt;&gt;<i> different fix (the one that does not allocate memory twice):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    xstrndup(explanatoryText.rawContent(), explanatoryText.length());
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but we cannot do the above until xstrndup() implementation is fixed.
</I>
&gt;<i> Not even by moving that caller to xmalloc() for itself and use xstrncpy() ?
</I>
xmalloc()+xstrncpy() is not &quot;doing the above&quot; it is doing something
else. I only claimed that we &quot;cannot do the above&quot; (literally). There
are other ways to achieve the same result, of course. None of those
other ways that I can think of (in the current code context) are better
than the proposed double-copy IMO.

Sure, it is possible to do xmalloc()+memcpy() in this context instead of
xstrndup(), but, in this context, that would be arguably worse than
copying twice because it would replace a clear high-level code with
risky low-level manipulations on an error handling path.

If strdup(buf.c_str()) pattern appears often, we should add
SBuf::c_str_dup() that does xmalloc()+memcpy().


&gt;<i> +1 if you update the patch to do the above. +0 otherwise  - ie. go ahead
</I>&gt;<i> with commit if you want, but I'd rather see the fixed caller(s) fixed to
</I>&gt;<i> use a more long-ish term fix.
</I>
Understood. We disagree regarding the &quot;more long-ish&quot; fix desirability.


Thank you,

Alex.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008553.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
	<LI>Next message: <A HREF="008549.html">[squid-dev] [PATCH] Do not revive unconditionally dead peers after	DNS refresh
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8555">[ date ]</a>
              <a href="thread.html#8555">[ thread ]</a>
              <a href="subject.html#8555">[ subject ]</a>
              <a href="author.html#8555">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
