<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Introduction / SslBump upstream ssl proxy support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Introduction%20/%20SslBump%20upstream%20ssl%20proxy%20support&In-Reply-To=%3Cc3906f19-57b9-65e6-1036-fb65f0c3c5b4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   <LINK REL="Next"  HREF="009246.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Introduction / SslBump upstream ssl proxy support</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Introduction%20/%20SslBump%20upstream%20ssl%20proxy%20support&In-Reply-To=%3Cc3906f19-57b9-65e6-1036-fb65f0c3c5b4%40treenet.co.nz%3E"
       TITLE="[squid-dev] Introduction / SslBump upstream ssl proxy support">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug  1 09:42:58 UTC 2017</I>
    <P><UL>
        
        <LI>Next message: <A HREF="009246.html">[squid-dev] Git-related wiki updates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9245">[ date ]</a>
              <a href="thread.html#9245">[ thread ]</a>
              <a href="subject.html#9245">[ subject ]</a>
              <a href="author.html#9245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/07/17 01:11, Mihai Ene wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm a developer with higher level languages experience very little 
</I>&gt;<i> commercial c++ development on my hands.
</I>&gt;<i> 
</I>&gt;<i> I've been following the SslBump feature for a while now, and this 
</I>&gt;<i> includes source code changes. SslBumping with upstream proxies was 
</I>&gt;<i> completely restricted when bug 3209 was patched in 2011, however, I 
</I>&gt;<i> believe the patch is too restrictive. I agree with Amos's statement that 
</I>&gt;<i> a plaintext information leak is highly unsafe, but the patch also 
</I>&gt;<i> prevents ssl upstream proxies usage.
</I>&gt;<i> 
</I>
Hi Mihai,

That bug was 6 years ago, and the comments were specifically about using 
plain-text peer connections. The patch was made to cover all parent 
peers because ...

The problem Squid still has with SSL/TLS peers is not that they leak 
info (they are contacted using TLS after all). It is that explicit-TLS 
proxies use their own certs instead of mimic'd ones so they present 
Squid with a cert other than the origin server cert. That has 
side-effects at the child proxy where bumping cannot mimic the origin 
cert details, and SSL-Bump ends up presenting a clearly invalid cert 
which reasonable clients reject.

In order for the bumping to work without user-visible issues at present 
the best way is for the child proxy to go to its DIRECT or ORIGINAL_DST, 
then get re-intercepted into the parent and re-bumped there. Such that 
the parent mimics the origin cert and it gets to the child proxy, then 
the client.


&gt;<i> In order to prevent plaintext and still use upstream proxies, I propose 
</I>&gt;<i> the following changes (tested in intranet, in production) which enable 
</I>&gt;<i> upstream proxies after ssl bumping, as long as the proxies are ssl 
</I>&gt;<i> themselves:
</I>&gt;<i> 
</I>&gt;<i> - version 4.x 
</I>&gt;<i> <A HREF="https://github.com/randunel/squid4/commit/c91995833370771f9903b374f17a0d774643c2b3">https://github.com/randunel/squid4/commit/c91995833370771f9903b374f17a0d774643c2b3</A>
</I>&gt;<i> - version 3.5.x 
</I>&gt;<i> <A HREF="https://github.com/randunel/squid3/commit/a72a47cf0d54bf17faefcfe7692182d82d6520ab">https://github.com/randunel/squid3/commit/a72a47cf0d54bf17faefcfe7692182d82d6520ab</A>
</I>&gt;<i> 
</I>
FYI: we are now using github PR system as the only way to accept changes 
to Squid.

Can you please do your submission as a PR request against the 
<A HREF="https://github.com/squid-cache/squid">https://github.com/squid-cache/squid</A> repository master branch. It needs 
to be accepted there before PR against the beta and stable branches code 
will be considered (in that order).

Thank you
Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="009246.html">[squid-dev] Git-related wiki updates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9245">[ date ]</a>
              <a href="thread.html#9245">[ thread ]</a>
              <a href="subject.html#9245">[ subject ]</a>
              <a href="author.html#9245">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
