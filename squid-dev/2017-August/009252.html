<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reuse%20reserved%20Negotiate%20and%20NTLM%20helpers%0A%20after%20an%20idle%20timeout.&In-Reply-To=%3C024c3ba4-c5d4-f86e-57fb-b3101e6b2844%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009251.html">
   <LINK REL="Next"  HREF="009253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reuse%20reserved%20Negotiate%20and%20NTLM%20helpers%0A%20after%20an%20idle%20timeout.&In-Reply-To=%3C024c3ba4-c5d4-f86e-57fb-b3101e6b2844%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Aug  5 06:52:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009251.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
        <LI>Next message: <A HREF="009253.html">[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9252">[ date ]</a>
              <a href="thread.html#9252">[ thread ]</a>
              <a href="subject.html#9252">[ subject ]</a>
              <a href="author.html#9252">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/08/17 04:40, Alex Rousskov wrote:
&gt;<i> On 07/31/2017 09:24 AM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> To do so otherwise would randomly
</I>&gt;&gt;&gt;&gt;<i> allow replay attacks to succeed
</I>&gt;<i> 
</I>&gt;<i> Please give a specific example where the proposed changes would allow a
</I>&gt;<i> new kind of replay attacks to succeed, given a correctly functioning
</I>&gt;<i> Squid and a correctly functioning helper. I cannot think of any
</I>&gt;<i> realistic examples, but this is not my area of expertise.
</I>&gt;<i> 
</I>

In NTLM the TT (type-2) tokens are generated by a particular helper and 
only that helper can authenticate the corresponding KK (type-3) token.

Annoyingly NTLM does not authenticate the client, nor the HTTP message 
it is attached to - it is specifically (and only) authenticating that 
the TCP connection is being used by the specific end-client able to 
generate the KK token proof-of-identity.


With the current code reserved helpers are tied to a particular TCP 
connection through Auth::UserRequest. As such an attacker would have to 
inject replay attempts into the same TCP connection the client was 
using. Which is protected by the TCP SEQNO mechanism - not impossible to 
subvert, but a high difficulty level.
  Any attempt to send the KK on another TCP connection would reach a 
different helper and be rejected as a 'secret' value embedded in the TT 
was reserved by the originating helper.


With the proposed changes all an attacker needs to do is peek at the KK 
token from the client then race it to be the first one to deliver any 
token to the originating helper (which can succeed at or after reuse 
timeout) - using as many other TCP connections as it likes. Which is a 
MUCH easier thing to do than SEQNO subverting.

As far as the TT generating helper is concerned there is no difference 
between an attackers KK token after timeout, or Squid just waiting some 
period timeout+N until the real clients KK token arrived.

And as I mentioned earlier there are other things the attacker can do to 
slow traffic down and bias the race towards itself. Those things do not 
have any effect on the client TCP connection use of SEQNO - so are 
relatively benign with the current code.


Note that under the attack conditions the TT generating helper *does 
not* receive a fresh YR query which it might use to reset its 
reservation state. The victim client generates the YR, then after 
timeout the attacker supplies the KK. The TT goes out on one TCP 
connection, and the KK returns via a different one.


PS. also note that this is only an issue for NTLM. However the existence 
of Negotiate/NTLM flavour of Negotiate makes that interface hit the same 
problem at times. This whole reservation thing is irrelevant with Kerberos.


Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009251.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
	<LI>Next message: <A HREF="009253.html">[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9252">[ date ]</a>
              <a href="thread.html#9252">[ thread ]</a>
              <a href="subject.html#9252">[ subject ]</a>
              <a href="author.html#9252">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
