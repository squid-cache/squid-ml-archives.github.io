<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204662%20adding%20--with-libressl%20build%20option&In-Reply-To=%3Cccf419ec-bc02-1ead-0fed-457ccf5c95df%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007938.html">
   <LINK REL="Next"  HREF="007942.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204662%20adding%20--with-libressl%20build%20option&In-Reply-To=%3Cccf419ec-bc02-1ead-0fed-457ccf5c95df%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb  1 13:51:01 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007938.html">[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
</A></li>
        <LI>Next message: <A HREF="007942.html">[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7939">[ date ]</a>
              <a href="thread.html#7939">[ thread ]</a>
              <a href="subject.html#7939">[ subject ]</a>
              <a href="author.html#7939">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/02/2017 5:49 a.m., Alex Rousskov wrote:
&gt;<i> On 01/31/2017 08:20 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 31/01/2017 7:04 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 01/29/2017 04:26 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> This is I think all we need to do code-wise to resolve the Bug 4662
</I>&gt;&gt;&gt;&gt;<i> issues with LibreSSL being incompatible with OpenSSL 1.1.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I do not think these changes should be committed. As you probably know
</I>&gt;&gt;&gt;<i> from earlier communication, I think we should avoid using both
</I>&gt;&gt;&gt;<i> USE_OPENSSL and USE_LIBRESSL in the code if LibreSSL is [treated as] a
</I>&gt;&gt;&gt;<i> replacement for OpenSSL. I have suggested several ways to avoid the
</I>&gt;&gt;&gt;<i> dangerous and needless repetition of (USE_OPENSSL || USE_LIBRESSL)
</I>&gt;&gt;&gt;<i> conditions, and we even seemed to agree on one of those solutions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> IMO we only agreed on the HAVE_* macro usage for determining whether the
</I>&gt;&gt;<i> 1.1 API was in use. Which is included in this patch.
</I>&gt;<i> 
</I>&gt;<i> I do not limit &quot;feature tests&quot; to &quot;1.1 API&quot;. Any feature is eligible. In
</I>&gt;<i> fact, it may be a good idea to test individual features rather than
</I>&gt;<i> bundle many of them into a single API version test (that will become
</I>&gt;<i> obsolete as parts of that API are going to change). However, those
</I>&gt;<i> details are probably not very important when resolving the core
</I>&gt;<i> disagreement here.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I don't think the repetition of (USE_OPENSSL || USE_LIBRESSL) is either
</I>&gt;&gt;<i> needless or dangerous.
</I>&gt;<i> 
</I>&gt;<i> The needless part is not a matter of opinion. It is a fact -- you do not
</I>&gt;<i> need to repeat the (USE_OPENSSL || USE_LIBRESSL) test. You may use a
</I>&gt;<i> single USE_FOOBAR macro to avoid this code repetition. The exact
</I>&gt;<i> spelling of FOOBAR is a separate question.
</I>

Do you think we can compromise and call it USE_OPENSSL_OR_LIBRESSL ?


&gt;<i> 
</I>&gt;<i> Whether code duplication is bad, dangerous, unwanted, etc. is certainly
</I>&gt;<i> a matter of opinion and subject to context, but I doubt you can convince
</I>&gt;<i> me that it is not in this case, especially as we have started using
</I>&gt;<i> USE_OPENSSL macro in complex expressions involving GnuTLS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> No more than USE_OPENSSL was in the same spot.
</I>&gt;<i> 
</I>&gt;<i> Repeating (a || b) condition many times is bad. Using a single (c)
</I>&gt;<i> condition many times is not. We should not be arguing about that basic
</I>&gt;<i> programming principle!
</I>&gt;<i> 
</I>
So you wish de define a 3rd macro in addition to the other two

&gt;<i> 
</I>&gt;&gt;<i> Fixing the sheer number of uses is not in scope.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Keep it simple. 
</I>&gt;<i> 
</I>&gt;<i> I believe we can simply continue to use USE_OPENSSL almost everywhere it
</I>&gt;<i> is used today. No &quot;fixing&quot; is needed in this context except changing
</I>&gt;<i> what you think that macro should stand for.
</I>&gt;<i> 
</I>
So a hypothetical patch is submitted to use, lets say a function
parameter is made const, in the LibreSSL but breaks when building with
OpenSSL. Is required to be wrapped in USE_OPENSSL.

 Can you spot the contradiction?


&gt;<i> 
</I>&gt;&gt;<i> Only one macro per library. --with-foo sets USE_FOO.
</I>&gt;<i> 
</I>&gt;<i> For you, the libraries provided by OpenSSL and LibreSSL project are two
</I>&gt;<i> different &quot;libraries&quot;. For me, they are two slightly different flavors
</I>&gt;<i> of the same &quot;library&quot;. IMO, the developers should not be forced to think
</I>&gt;<i> which flavor is in use now or which flavors are supported today, except
</I>&gt;<i> in very few low-level cases where that information might be needed. With
</I>&gt;<i> feature tests, the number of such cases might be zero.
</I>&gt;<i> 
</I>&gt;<i> In other words, you seem to abstract at the level of file name spelling.
</I>&gt;<i> I abstract at the level of APIs. Naturally, it is difficult to agree on
</I>&gt;<i> a single scheme that accommodates both approaches!
</I>
I am following the autoconf guidelines for use of the AC_ARG_WITH() macro:
&quot;
Some packages require, or can optionally use, other software packages
that are already installed. The user can give configure command line
options to specify which such external software to use. The options have
one of these forms:

     --with-package[=arg]
     --without-package

For example, --with-gnu-ld means work with the GNU linker instead of
some other linker.
&quot;

The example about linker is for distinguishing between two different
linkers. They are both linkers and provide the same linking API.
Our usage is for libraries, the APIs have similarities but also differences.

Also note the name of the option follows the naming of the external
software. In our case we have two differently named external software.

1) OpenSSL is the name of one externally provided library / software.

2) LibreSSL is the name of a *different* library.

The point of difference is that LibreSSL does not work with all of the
code enabled by --with-openssl. Which is driving in this patch the
addition of --with-libressl.

If you want to convince anyone that LibreSSL is just a different name
for OpenSSL please take it up with the OpenSSL guys writing LibreSSL. It
is not our place to make (or un-make) that decision for them.



I am then following the naming convention documented in our Squid coding
guidelines for the USE_* macros and how they relate to the ./configure
option naming:

&lt;<A HREF="http://wiki.squid-cache.org/SquidCodingGuidelines#Autoconf_Syntax_Guidelines">http://wiki.squid-cache.org/SquidCodingGuidelines#Autoconf_Syntax_Guidelines</A>&gt;


If you will note, this patch was adding a --with-libressl option
*explicitly* to distinguish those builds from OpenSSL builds with the
auto-tools tests cannot.

It is not changing the meaning of the --with-openssl option in any way.


&gt;<i> 
</I>&gt;<i> Needless to say, the two projects may eventually diverge their APIs so
</I>&gt;<i> that one is no longer a flavor of the other. This day has not come yet,
</I>
Er. False. You seem to be overlooking the fact that bug 2664 exists
because the APIs *have* diverged so much that one of them no longer
builds against code written for the other.

Likewise I brought up the fact that LibreSSL API goes way beyond
OpenSSL-compatible part as more evidence. Code written for LibreSSL
-ltls will not build against any version of OpenSSL.

It can be a bit unclear because Squid today mostly uses the overlapping
part of their APIs. But I dont believe that will always be the case, not
even in the near future.


&gt;<i> and one could hope that LibreSSL folks would either avoid this
</I>&gt;<i> divergence or have the decency to stop using &quot;OPENSSL&quot; in their diverged
</I>&gt;<i> API names.
</I>&gt;<i> 
</I>
That is one thing you should probably open a bug about with them. It
appears to be too late to prevent divergence.

&gt;<i> 
</I>&gt;&gt;<i> NP: I am only adding the &quot;|| USE_LIBRESSL&quot; parts in this patch because I
</I>&gt;&gt;<i> happen to know that the existing code is being used with LibreSSL and
</I>&gt;&gt;<i> found to be working. Future code will have to prove itself separately
</I>&gt;&gt;<i> for each library, OR at the submitters discretion (passing audit and QA
</I>&gt;&gt;<i> also) list the librares believed to be safe with it.
</I>&gt;<i> 
</I>&gt;<i> I believe the approach you have described is inferior to treating both
</I>&gt;<i> OpenSSL and LibreSSL as providing the same overall API while avoiding
</I>&gt;<i> (or treating specially) the rare parts of the API that differ. Today,
</I>&gt;<i> there is only one such known exception in Squid context -- the
</I>&gt;<i> OPENSSL_VERSION_NUMBER macro.
</I>
Not quite, it is a bottleneck point. But all of the OpenSSL v1.1 API
changes are also points of divergence. Plus all the bits mentioned above.

LibreSSL was a full forking. It has just taken a while to be visible.

In regards to this being a planning for the future, we should IMO expect
the differences to keep on increasing. So making our long-term design
require that they been treated as equal is a fail.

The workaround of building --with-openssl to link against LibreSSL had
its time and that time is now over.


&gt;<i> We seem to agree that we should not be
</I>&gt;<i> using that part of the API anyway, so there will be no exceptions at all
</I>&gt;<i> after OPENSSL_VERSION_NUMBER is replaced with feature tests.
</I>
For now in the current Squid code yes. That is evident from the ||
additions in this patch.

However, I was under the impression that we were planning for the future
here. We also seem to agree that in future the LibreSSL is going to
diverge from OpenSSL**. That conflicts AFAICS with the idea of treating
LibreSSL as an alias for OpenSSL - which will by the way do exactly zero
for fixing the bug 2664.

** we seem to still differ on whether that has happened. But we agree it
will in future.

&gt;<i> 
</I>&gt;<i> Your approach appears to be based on the assumption that enabling or
</I>&gt;<i> disabling individual code pieces dealing with OpenSSL/LibreSSL APIs
</I>&gt;<i> based on &quot;known to be used and seemingly working&quot; test will preserve the
</I>&gt;<i> overall integrity of the code.
</I>
Not quite.

I believe the integrity of the code rests solely on which libraries are
used and tested by people. That will happen independently of whether
there is one macro around each code block or a pair/triplet/N-tuplet
with ||/&amp;&amp; expressions.

Fedora/RHEL/CentOS use OpenSSL and we get feedback on testing and
problems from them.

The various *BSD build with LibreSSL mostly now and increasing. We get
feedback on the LibreSSL parts from them.

So there is only minor need to use the macro naming to enforce &quot;good
behaviour&quot;. We can arrange the BuildFarm and QA to do that enforcement.

Instead to be forward-looking we should plan to be flexible enough to
allow the different libraries to have their own unique code blocks where
necessary as they (further) diverge.

I am proposing this bug 2664 as the tipping point for LibreSSL
separating from OpenSSL. Or more correctly OpenSSL v1.1 diverging from
its shared base with LibreSSL.


&gt;<i> I believe that assumption is wrong and
</I>&gt;<i> that low-level approach is too dangerous.
</I>
We have a precedent in the use of distro specific _SQUID_*_ macros. It
has worked fairly well for the past 30-odd years.


&gt;<i> IMO, the decision whether to
</I>&gt;<i> support LibreSSL in Squid should be made on a much higher level than an
</I>&gt;<i> individual piece of code. Levels such as &quot;whole Squid&quot; or &quot;non-bumping
</I>&gt;<i> Squid&quot; would be more appropriate. Exceptions might be made for small,
</I>&gt;<i> isolated functionality, but they should be carefully considered
</I>&gt;<i> exceptions, not the rule.
</I>
Large features is what we use the --enable-* macros for. That level
LibreSSL is not relevant. The macros wrapping those code blocks apply to
OpenSSL, GnuTLS or LibreSSL equally.

It would be lovely if we only had to use macros at that level. But until
TLS and no-longer-SSL libraries all share a universal API definition we
have to use per-library wrappers as well, and per-feature within that.

It is a PITA but these libraries *are* different.

&gt;<i> 
</I>&gt;<i> The considerations in the above two paragraphs are orthogonal to
</I>&gt;<i> avoiding code duplication but avoiding code duplication is easier when
</I>&gt;<i> LibreSSL support decisions are made at a level higher than individual
</I>&gt;<i> preprocessor statements.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> It is not a blocker, but I would like to avoid declaring LibreSSL as no
</I>&gt;&gt;<i> longer supported by v4 since the fix is not exactly hard.
</I>&gt;<i> 
</I>&gt;<i> 1. You do not have to declare anything with regard to LibreSSL support,
</I>&gt;<i>    especially at the v4 branch level. An open bug report is sufficient.
</I>&gt;<i>    IIRC, we have not declared LibreSSL as officially supported either.
</I>
I have to warn all the BSD people that 4.0.18 will probably not build on
their systems anymore unles they switch back to OpenSSL. So not to worry
or bother with complaints. Ditto for all the others voluntarily using
LibreSSL.

&gt;<i> 
</I>&gt;<i> 2. The difficulty of changing Squid code lines is an important factor,
</I>&gt;<i>    but there are other factors to consider. Those other factors make
</I>&gt;<i>    the proposed &quot;not hard&quot; fix undesirable IMO.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>

Amos

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007938.html">[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
</A></li>
	<LI>Next message: <A HREF="007942.html">[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7939">[ date ]</a>
              <a href="thread.html#7939">[ thread ]</a>
              <a href="subject.html#7939">[ subject ]</a>
              <a href="author.html#7939">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
