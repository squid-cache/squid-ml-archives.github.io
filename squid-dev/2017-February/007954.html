<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Case-insensitive URI schemes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Case-insensitive%20URI%20schemes&In-Reply-To=%3C36160f9f-6976-abbc-c96f-c52301b710d3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007951.html">
   <LINK REL="Next"  HREF="007964.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Case-insensitive URI schemes</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Case-insensitive%20URI%20schemes&In-Reply-To=%3C36160f9f-6976-abbc-c96f-c52301b710d3%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Case-insensitive URI schemes">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Feb  2 19:12:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007951.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
        <LI>Next message: <A HREF="007964.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7954">[ date ]</a>
              <a href="thread.html#7954">[ thread ]</a>
              <a href="subject.html#7954">[ subject ]</a>
              <a href="author.html#7954">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/02/2017 05:53 AM, Eduard Bagdasaryan wrote:
&gt;<i> I applied your polishing suggestions to my latest patch
</I>&gt;<i> re-attached it.
</I>
&gt;<i> +std::vector&lt;SBuf&gt; AnyP::UriScheme::LowercaseSchemeNames;
</I>
&gt;<i> +    static std::vector&lt;SBuf&gt; LowercaseSchemeNames;
</I>
We should avoid this code duplication:

  typedef std::vector&lt;SBuf&gt; LowercaseSchemeNames;
  static LowercaseSchemeNames LowercaseSchemeNames_;

but this is not why I am writing this email.


&gt;<i>          storeFsInit();      /* required for config parsing */
</I>&gt;<i>          Fs::Init();
</I>&gt;<i>          DiskIOModule::SetupAllModules();
</I>&gt;<i>          StoreFileSystem::SetupAllFs();
</I>&gt;<i>          Store::Init();
</I>&gt;<i>          Auth::Init();      /* required for config parsing. NOP if !USE_AUTH */
</I>&gt;<i>          Ip::ProbeTransport(); // determine IPv4 or IPv6 capabilities before parsing.
</I>&gt;<i>          Format::Token::Init(); // XXX: temporary. Use a runners registry of pre-parse runners instead.
</I>&gt;<i> +        AnyP::UriScheme::Init();
</I>
The Init() approach may seem like an obvious no-cost optimization, but
it actually has serious negative side effects, including the necessity
to answer the &quot;When to call Init()?&quot; question. In this particular case,
we must call Init()

* after SBuf is operational and
* before anybody might create something containing a UriScheme.

The first part is fairly easy IIRC -- SBuf should already be working at
static initialization time and working efficiently after Mem::Init().

The second one is less obvious. Nobody knows for sure what exactly all
those Init() calls quoted above do now and especially what they will do
tomorrow. Is it possible that one of them will create a URI and will
want to use a UriScheme for that? I think it is! Since UriScheme does
not need any of the above modules (AFAICT), IMO it should be initialized
first, before storeFsInit().

Since Amos did not ask you to go back to as-needed initialization, I
will not ask for that either. However, please check whether we can move
the AnyP::UriScheme::Init() call up, to place it above storeFsInit().


Both of the above changes can be done during commit.


Thank you,

Alex.



&gt;<i> On 02.02.2017 11:33, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 1/02/2017 2:18 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;&gt;<i> Optimized with static array as you suggested and
</I>&gt;&gt;&gt;<i> re-attached the patch.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you, looks like this one removes most of the performance
</I>&gt;&gt;<i> regression.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Just some polishing for src/anyp/UriScheme.cc ;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> in AnyP::UriScheme::UriScheme
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * this TODO seems reasonable and simple enough, please do it:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   +    // the caller knows nothing about the scheme
</I>&gt;&gt;<i> +    // TODO: Avoid special casing by storing this string in the
</I>&gt;&gt;<i> generated ProtocolType_str?
</I>&gt;&gt;<i>       else if (theScheme_ == AnyP::PROTO_UNKNOWN)
</I>&gt;&gt;<i> -        // image could be actually unknown and not provided
</I>&gt;&gt;<i>           image_ = &quot;(unknown)&quot;;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> in AnyP::UriScheme::LowercaseScheme:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * please use the Squid coding style of parameters being on a line before
</I>&gt;&gt;<i> the function name.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * please do use emplace_back instead of push_back. Simple as it is the
</I>&gt;&gt;<i> SBuf is not a pointer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * please add a TODO note about making the ProtocolType enum use
</I>&gt;&gt;<i> base/EnumIterator.h instead of an int for-loop.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> +1. I don't think this needs another review, just the polish.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007951.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
	<LI>Next message: <A HREF="007964.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7954">[ date ]</a>
              <a href="thread.html#7954">[ thread ]</a>
              <a href="subject.html#7954">[ subject ]</a>
              <a href="author.html#7954">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
