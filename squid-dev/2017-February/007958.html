<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] initial GnuTLS support for encrypted server connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20initial%20GnuTLS%20support%20for%20encrypted%20server%0A%20connections&In-Reply-To=%3C9877b5d5-5d44-71a6-ada6-f2a997bc9860%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007953.html">
   <LINK REL="Next"  HREF="007959.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] initial GnuTLS support for encrypted server connections</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20initial%20GnuTLS%20support%20for%20encrypted%20server%0A%20connections&In-Reply-To=%3C9877b5d5-5d44-71a6-ada6-f2a997bc9860%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] initial GnuTLS support for encrypted server connections">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Feb  4 19:31:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007953.html">[squid-dev] [PATCH] initial GnuTLS support for encrypted server connections
</A></li>
        <LI>Next message: <A HREF="007959.html">[squid-dev] [PATCH] initial GnuTLS support for encrypted server connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7958">[ date ]</a>
              <a href="thread.html#7958">[ thread ]</a>
              <a href="subject.html#7958">[ subject ]</a>
              <a href="author.html#7958">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/02/2017 4:05 a.m., Alex Rousskov wrote:
&gt;<i> On 02/01/2017 11:51 PM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Can we agree on this being a fundamental design in Squid:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  * all connections have an associated socket ID.
</I>&gt;<i> 
</I>&gt;<i> That assumption would be too limiting (and, AFAICT, unnecessary). For
</I>&gt;<i> example, SSL connections inside SSL connections (HTTPS proxy) do not
</I>&gt;<i> have a socket. The same will apply to SSL connections inside HTTP/2
</I>&gt;<i> sessions. And eventually QUIC.
</I>&gt;<i> 
</I>
I know. However the curent Squid code does not support such things.
Probably _because_ it was designed with the above as one of the assumptions.


&gt;<i> 
</I>&gt;&gt;<i>  * all _open_ connections are stored in fd_table. Indexed by the
</I>&gt;&gt;<i> connections socket ID. If not that is a bug.
</I>&gt;<i> 
</I>&gt;<i> Again, this is oversimplifying too much: fd_table is for sockets, not
</I>&gt;<i> connections.
</I>
This is why I emphasized _open_ connections. The connections without
socket ID (FD number) are represented by Comm::Connection in 'closed'
state (fd == -1).

If there are other types of connection in the current codebase please
point me at them.



&gt;<i> Some connections do not have sockets. All open TCP
</I>&gt;<i> connections should have sockets in fd_table though.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Do you agree on that?
</I>&gt;<i> 
</I>&gt;<i> No.
</I>&gt;<i> 
</I>


&gt;<i> 
</I>&gt;&gt;<i> Now a Question, and please answer carefully:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does the PeerConnector or the new() operator 'connect' the &quot;SSL
</I>&gt;&gt;<i> connection&quot; ?
</I>&gt;<i> 
</I>&gt;<i> Which new() operator?
</I>
SSL_new() - the one being called by Ssl::CreateClient() to produce its
return object.

OpenSSL:
 &quot;structure which is needed to hold the data for a TLS/SSL connection&quot;

This is the object which will become the Squid representation of a
&quot;session&quot; [see below]. Although at the time of the Create*() function
return it is only half (or less) the session data and is definitly not
associated with a &quot;connection&quot; (yet).


&gt;<i> To connect an SSL connection one has to call
</I>&gt;<i> SSL_connect() or equivalent.
</I>
Um, the SSL_connect() function performs the TLS/SSL handshake protocol.

Note sentence 2 of the formal definition:
&quot;
   session
      A TLS session is an association between a client and a server.
==&gt;   Sessions are created by the handshake protocol.  Sessions define a
      set of cryptographic security parameters that can be shared among
      multiple connections.  Sessions are used to avoid the expensive
      negotiation of new security parameters for each connection.
&quot;


&gt;<i> If PeerConnector or your new() operator
</I>&gt;<i> call SSL_connect() (directly or indirectly) then they are trying to
</I>&gt;<i> change the state of an SSL connection to &quot;connected&quot;.
</I>
This again diverges from the RFC 5246 definition:
&quot;
   connection
      A connection is a transport (in the OSI layering model definition)
      that provides a suitable type of service.  For TLS, such
      connections are peer-to-peer relationships.  The connections are
      transient.  Every connection is associated with one session.
&quot;

The section 6.1 which introduces the phrase &quot;TLS connection&quot; as a
concept is documenting the &quot;TLS Record Protocol&quot;. It is very clear that
abstract &quot;TLS connection&quot; does not exist until the TLS records are
flowing. At which point it refers the transport protocol stack, with
&quot;TLS Record Protocol&quot; on top of that stack.

The session is different:
&quot;
   session
      A TLS session is an association between a client and a server.
      Sessions are created by the handshake protocol.  Sessions define a
      set of cryptographic security parameters that can be shared among
      multiple connections.  Sessions are used to avoid the expensive
      negotiation of new security parameters for each connection.
&quot;

... and also because &quot;Record Protocol&quot; (aka &quot;TLS connection&quot;) exists and
can be used (often are - for alerts etc.) without the handshake having
taken place nor a &quot;session&quot; existing.

(I am of course assuming that since you pointed me at that RFC for
references of &quot;SSL connection&quot; - which does occur exactly 0 times in
that document - that you mean &quot;TLS connection&quot; when you write &quot;SSL
connection&quot;).


&gt;<i> Does that answer
</I>&gt;<i> your question?
</I>&gt;<i> 
</I>
Sadly no, but in a way yes. Earlier you grumbled about conflating &quot;SSL
session&quot; with &quot;SSL connection&quot;.

The only conflation I am seeing is in the OpenSSL documentation. The
spec does not define the term at all, and the closest equivalent is a
phrase used to abbreviate the transport description - not anyting crypto
related.

So far as I can tell both the existing v5/v4 code and my patches do
match the definitions in the RFC 5246 for &quot;session&quot;, &quot;connection&quot;, and
the fuzzy &quot;TLS connection&quot;.

Amos

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007953.html">[squid-dev] [PATCH] initial GnuTLS support for encrypted server connections
</A></li>
	<LI>Next message: <A HREF="007959.html">[squid-dev] [PATCH] initial GnuTLS support for encrypted server connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7958">[ date ]</a>
              <a href="thread.html#7958">[ thread ]</a>
              <a href="subject.html#7958">[ subject ]</a>
              <a href="author.html#7958">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
