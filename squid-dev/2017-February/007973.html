<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] VIA creation code duplication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20VIA%20creation%20code%20duplication&In-Reply-To=%3C61929bd1-5c99-8b04-033a-2e31d1835a01%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007972.html">
   <LINK REL="Next"  HREF="007974.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] VIA creation code duplication</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20VIA%20creation%20code%20duplication&In-Reply-To=%3C61929bd1-5c99-8b04-033a-2e31d1835a01%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] VIA creation code duplication">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 10 23:17:42 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007972.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
        <LI>Next message: <A HREF="007974.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7973">[ date ]</a>
              <a href="thread.html#7973">[ thread ]</a>
              <a href="subject.html#7973">[ subject ]</a>
              <a href="author.html#7973">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/02/2017 5:04 a.m., Alex Rousskov wrote:
&gt;<i> On 02/09/2017 10:19 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 3/02/2017 4:02 a.m., Eduard Bagdasaryan wrote:
</I>&gt;&gt;&gt;<i> This patch fixes VIA appending code duplication, moving common
</I>&gt;&gt;&gt;<i> code into a separate method.
</I>&gt;<i> 
</I>&gt;&gt;<i> Since Via is a list header we should be able to just append a new Via
</I>&gt;&gt;<i> header to the header list with putStr. No need to use getList, String,
</I>&gt;&gt;<i> delById to inject on the end of existing Via string.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please also take the opportunity to fix a long standing protocol
</I>&gt;&gt;<i> violation bug in Via header produced by Squid:
</I>&gt;&gt;<i>  The version part of the header is only supposed to elide the protocol
</I>&gt;&gt;<i> label if the that label would be &quot;HTTP/&quot; (ie. for messages received via
</I>&gt;&gt;<i> HTTP and HTTPS).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> eg. for ICY replies:
</I>&gt;&gt;<i>   Via: ICY/1.1 squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> eg. for FTP gatewayed replies (or relayed requests):
</I>&gt;&gt;<i>   Via: FTP/2 squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After those calls that require String are gone please assemble the value
</I>&gt;&gt;<i> in an SBuf instead of static char* buffer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, for messages where Squid itself generated the message (ie
</I>&gt;&gt;<i> Downloader or ESI) there should be no Via header added at all.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Also, please fix the 10 oldest open bugs on Squid Bugzilla while you are
</I>&gt;<i> at it.&lt;/sarcasm&gt;
</I>&gt;<i> 
</I>&gt;<i> IMHO, you may declare any and all of the changes requested by Amos to be
</I>&gt;<i> outside the scope of the code deduplication patch you have prepared.
</I>&gt;<i> Your patch is valuable even with its current narrow scope. If the patch
</I>&gt;<i> has no problems, it should be acceptable &quot;as is&quot;. Amos, if you disagree
</I>&gt;<i> with this assessment, please say so.
</I>

This patch is &quot;polishing a turd&quot; as the saying goes and a bit premature.
There are some obvious and easy to fix bugs that should be attended
first, then polishing afterwards.

In these particular pieces of code starting with the de-duplicate
obscures that the code was intended to be doing two quite different
things to begin with.

src/client_side_reply.cc was a wrong implementation of an append to a
list-header, and src/http.cc was an inefficient implementation of a
copy. That results in this patches addVia() method being needlessly
complex and inefficient.


AFAICS there is some duplication, but not the same logic which this
patch is de-duplicating.


If we start with fixing the bugs...

* the code in src/client_side_reply.cc should be just this (no slow
String manipulations):

 /* Append VIA */
 if (Config.onoff.via) {
    LOCAL_ARRAY(char, bbuf, MAX_URL + 32);
    snprintf(bbuf, MAX_URL + 32, &quot;%d.%d %s&quot;,
             reply-&gt;sline.version.major,
             reply-&gt;sline.version.minor,
             ThisCache);
     hdr-&gt;putStr(Http::HdrType::VIA, bbuf);
 }


* the code in src/http.cc at first glance looks like its doing the right
thing. It both copies then appends. BUT its operation is also
interdependent with the code inside
copyOneHeaderFromClientsideRequestToUpstreamRequest().

If we make copyOneHeader*() function actually do the copy in all cases:
i.e.
-  case Http::HdrType::VIA:
-       /** \par Via:
-         * If Via is disabled then forward any received header as-is.
-         * Otherwise leave for explicit updated addition later. */
-
-        if (!Config.onoff.via)
-           hdr_out-&gt;addEntry(e-&gt;clone());
-
-        break;

(incidentally this fixes a bug when Connection:Via is received).


* then src/http.cc chunk labeled &quot;append Via&quot; becomes just a simpler append:

 /* Append VIA */
 if (Config.onoff.via) {
    LOCAL_ARRAY(char, bbuf, MAX_URL + 32);
    snprintf(bbuf, MAX_URL + 32, &quot;%d.%d %s&quot;,
             request-&gt;http_ver.major,
             request-&gt;http_ver.minor,
             ThisCache);
     hdr_out-&gt;-&gt;putStr(Http::HdrType::VIA, bbuf);
 }

... which is *now* a proper duplicate of the client_side_reply.cc.


* Those two remaining append bits should be what this new addVia()
method does.
 - and addVia() no longer needs the 'from' parameter complexity.


If you still want to do the de-duplicate standalone, fine. I'll do the
bug fixing myself.

Amos

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007972.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
	<LI>Next message: <A HREF="007974.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7973">[ date ]</a>
              <a href="thread.html#7973">[ thread ]</a>
              <a href="subject.html#7973">[ subject ]</a>
              <a href="author.html#7973">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
