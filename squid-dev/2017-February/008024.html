<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Native FTP relay for active FTP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3Cec124b87-55b9-9ca7-f6af-df2eda6d15a0%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008023.html">
   <LINK REL="Next"  HREF="008025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Native FTP relay for active FTP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3Cec124b87-55b9-9ca7-f6af-df2eda6d15a0%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Native FTP relay for active FTP">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 14 16:06:16 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008023.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
        <LI>Next message: <A HREF="008025.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8024">[ date ]</a>
              <a href="thread.html#8024">[ thread ]</a>
              <a href="subject.html#8024">[ subject ]</a>
              <a href="author.html#8024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/14/2017 03:44 AM, Alex wrote:

&gt;<i> The attached patch allows FTP relay to work in NAT interception mode
</I>&gt;<i> and also fixes IP address binding in TPROXY mode.
</I>
Thank you for working on this bug. NAT/TPROXY address manipulation is
not my area of expertise, but I have one higher level concern and a few
less important clarification requests:


&gt;<i> +    if (clientConnection-&gt;flags &amp; COMM_TRANSPARENT) {
</I>&gt;<i> +        conn-&gt;setAddrs(clientConnection-&gt;local, cltAddr);
</I>&gt;<i> +        conn-&gt;flags |= COMM_TRANSPARENT;
</I>&gt;<i> +    } else {
</I>&gt;<i> +        // In case of NAT interception ...
</I>
Are there really just two cases here (tproxy and NAT)? IIRC, a &quot;forward
FTP proxy&quot; mode without any TCP/IP level redirection and address
rewriting tricks used to work fine, but your email and the new code may
be interpreted to imply otherwise. If there are indeed three supported
cases, then the new if-statement condition may need to be adjusted (at
least).

&gt;<i> +        // In case of NAT interception squid's local address
</I>&gt;<i> +        // will be used for outgoing connection.
</I>&gt;<i> +        conn-&gt;local.setAnyAddr();
</I>&gt;<i> +        conn-&gt;remote = cltAddr;
</I>
In this context, the phrase &quot;squid's local address&quot; can mean a lot of
different things. Is there a more precise term we can use here? For
_example_, the existing comment uses &quot;local IP address of the control
connection&quot; which is a lot more specific.

Also, does the comment talk about the source or the destination address
for the &quot;outgoing connection&quot;? For example, the existing comment says
&quot;as the source address of the active data connection&quot; which is a lot
more specific.

If &quot;outgoing connection&quot; means &quot;data connection&quot;, then I recommend using
the latter terminology because it is more precise (there are several
connections in this context that somebody might consider &quot;outgoing&quot;,
depending on how they view their proxy role or network &quot;position&quot;).


Finally, it is not clear to me whether the new comment means something
like this:

* If we set conn-&gt;local to any IP address (with the right version), then
the TCP stack will pick the correct source address for the data
connection because we are using NAT.

or something like this:

* The exact conn-&gt;local value does not matter because the TCP stack will
automatically pick the correct source address for the data connection
when we are using NAT. Just make sure the IP version is correct.

Or something else entirely (e.g., perhaps it is not the TCP stack but
some other Squid code that selects the right source address). The
passive voice in the new comment may be obscuring the intended meaning.



&gt;<i> +        if (conn-&gt;remote.isIPv4())
</I>&gt;<i> +            conn-&gt;local.setIPv4();
</I>

I know that Squid uses the same code elsewhere, and I assume this
&quot;works&quot; today, but it looks misleading to me. Do we want the local
address to have the same IP version as the remote address has? If yes,
the above code does not say that and, ideally, should be adjusted.
Again, I am not saying that this code does not work.


Thank you,

Alex.

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008023.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
	<LI>Next message: <A HREF="008025.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8024">[ date ]</a>
              <a href="thread.html#8024">[ thread ]</a>
              <a href="subject.html#8024">[ subject ]</a>
              <a href="author.html#8024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
