<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Native FTP relay for active FTP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3C1354641487093885%40web38j.yandex.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008024.html">
   <LINK REL="Next"  HREF="008026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Native FTP relay for active FTP</H1>
    <B>Alex</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3C1354641487093885%40web38j.yandex.ru%3E"
       TITLE="[squid-dev] [PATCH] Native FTP relay for active FTP">gozzy at yandex.ru
       </A><BR>
    <I>Tue Feb 14 17:38:05 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008024.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
        <LI>Next message: <A HREF="008026.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8025">[ date ]</a>
              <a href="thread.html#8025">[ thread ]</a>
              <a href="subject.html#8025">[ subject ]</a>
              <a href="author.html#8025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

14.02.2017, 19:06, &quot;Alex Rousskov&quot; &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt;:

&gt;&gt;<i>  + if (clientConnection-&gt;flags &amp; COMM_TRANSPARENT) {
</I>&gt;&gt;<i>  + conn-&gt;setAddrs(clientConnection-&gt;local, cltAddr);
</I>&gt;&gt;<i>  + conn-&gt;flags |= COMM_TRANSPARENT;
</I>&gt;&gt;<i>  + } else {
</I>&gt;&gt;<i>  + // In case of NAT interception ...
</I>&gt;<i>
</I>&gt;<i> Are there really just two cases here (tproxy and NAT)? IIRC, a &quot;forward
</I>&gt;<i> FTP proxy&quot; mode without any TCP/IP level redirection and address
</I>&gt;<i> rewriting tricks used to work fine, but your email and the new code may
</I>&gt;<i> be interpreted to imply otherwise. If there are indeed three supported
</I>&gt;<i> cases, then the new if-statement condition may need to be adjusted (at
</I>&gt;<i> least).
</I>
I suppose that two cases should be enough. AFAIR, forward/reverse configuration is handled by firewall redirection rules.
I have tested the patch in configuration like this, keeping forward proxy in mind:

[ FTP Client, 1.1.1.1] &lt;-------&gt; [ GW with Squid ] &lt;-------&gt;  [ FTP Server, 5.5.5.5]


&gt;<i>
</I>&gt;&gt;<i>  + // In case of NAT interception squid's local address
</I>&gt;&gt;<i>  + // will be used for outgoing connection.
</I>&gt;&gt;<i>  + conn-&gt;local.setAnyAddr();
</I>&gt;&gt;<i>  + conn-&gt;remote = cltAddr;
</I>&gt;<i>
</I>&gt;<i> Finally, it is not clear to me whether the new comment means something
</I>&gt;<i> like this:
</I>&gt;<i>
</I>&gt;<i> * If we set conn-&gt;local to any IP address (with the right version), then
</I>&gt;<i> the TCP stack will pick the correct source address for the data
</I>&gt;<i> connection because we are using NAT.
</I>&gt;<i>
</I>&gt;<i> or something like this:
</I>&gt;<i>
</I>&gt;<i> * The exact conn-&gt;local value does not matter because the TCP stack will
</I>&gt;<i> automatically pick the correct source address for the data connection
</I>&gt;<i> when we are using NAT. Just make sure the IP version is correct.
</I>
Yes, this is the case. I will adjust the comment to make it more clear.

&gt;&gt;<i>  + if (conn-&gt;remote.isIPv4())
</I>&gt;&gt;<i>  + conn-&gt;local.setIPv4();
</I>&gt;<i>
</I>&gt;<i> I know that Squid uses the same code elsewhere, and I assume this
</I>&gt;<i> &quot;works&quot; today, but it looks misleading to me. Do we want the local
</I>&gt;<i> address to have the same IP version as the remote address has? If yes,
</I>&gt;<i> the above code does not say that and, ideally, should be adjusted.
</I>&gt;<i> Again, I am not saying that this code does not work.
</I>
Ok, I'll add corresponding notes there.
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008024.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
	<LI>Next message: <A HREF="008026.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8025">[ date ]</a>
              <a href="thread.html#8025">[ thread ]</a>
              <a href="subject.html#8025">[ subject ]</a>
              <a href="author.html#8025">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
