<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Native FTP relay for active FTP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3Cfeef07ca-243a-d6aa-04fa-4cb4050a78a5%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008026.html">
   <LINK REL="Next"  HREF="008028.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Native FTP relay for active FTP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3Cfeef07ca-243a-d6aa-04fa-4cb4050a78a5%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Native FTP relay for active FTP">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 14 18:50:25 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008026.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
        <LI>Next message: <A HREF="008028.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8027">[ date ]</a>
              <a href="thread.html#8027">[ thread ]</a>
              <a href="subject.html#8027">[ subject ]</a>
              <a href="author.html#8027">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/14/2017 10:38 AM, Alex wrote:
&gt;&gt;&gt;<i>  + if (clientConnection-&gt;flags &amp; COMM_TRANSPARENT) {
</I>&gt;&gt;&gt;<i>  + conn-&gt;setAddrs(clientConnection-&gt;local, cltAddr);
</I>&gt;&gt;&gt;<i>  + conn-&gt;flags |= COMM_TRANSPARENT;
</I>&gt;&gt;&gt;<i>  + } else {
</I>&gt;&gt;&gt;<i>  + // In case of NAT interception ...
</I>
&gt;&gt;<i> Are there really just two cases here (tproxy and NAT)? IIRC, a &quot;forward
</I>&gt;&gt;<i> FTP proxy&quot; mode without any TCP/IP level redirection and address
</I>&gt;&gt;<i> rewriting tricks used to work fine, but your email and the new code may
</I>&gt;&gt;<i> be interpreted to imply otherwise. If there are indeed three supported
</I>&gt;&gt;<i> cases, then the new if-statement condition may need to be adjusted (at
</I>&gt;&gt;<i> least).
</I>
&gt;<i> I suppose that two cases should be enough. AFAIR, forward/reverse
</I>&gt;<i> configuration is handled by firewall redirection rules.
</I>
When I am talking about the forwarding case, I am talking about a simple
configuration without any redirection or other TCP/IP level tricks or
even reverse proxing of any sort: The FTP client sends FTP requests
directly to Squid's ftp_port (specifying the ultimate destination using
an extra @ sign). IIRC, that used to work with popular proxy-aware FTP
clients when we added the ftp_port code.

In that simple case, some FTP client refuse to accept the FTP data
connection from Squid unless that data connection comes from the same
source IP address as the destination address of the corresponding FTP
control connection. The old &quot;Use local IP...&quot; code/comment were added to
make such clients happy (the changes in [trunk] revision 12742.1.41 are
pretty telling, especially in the light of your changes).

If my recollection is correct, then we should continue to support that
simple case. Your patch breaks that support and, AFAICT, your &quot;Squid is
a gateway&quot; test does not cover that scenario.


&gt;&gt;&gt;<i>  + if (conn-&gt;remote.isIPv4())
</I>&gt;&gt;&gt;<i>  + conn-&gt;local.setIPv4();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know that Squid uses the same code elsewhere, and I assume this
</I>&gt;&gt;<i> &quot;works&quot; today, but it looks misleading to me. Do we want the local
</I>&gt;&gt;<i> address to have the same IP version as the remote address has? If yes,
</I>&gt;&gt;<i> the above code does not say that and, ideally, should be adjusted.
</I>&gt;&gt;<i> Again, I am not saying that this code does not work.
</I>
&gt;<i> Ok, I'll add corresponding notes there.
</I>
I was thinking about using an Ip::Address method that sets &quot;this&quot; IP
version to the version of the supplied IP address. You can add such a
method if we do not have it already.


Thank you,

Alex.

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008026.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
	<LI>Next message: <A HREF="008028.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8027">[ date ]</a>
              <a href="thread.html#8027">[ thread ]</a>
              <a href="subject.html#8027">[ subject ]</a>
              <a href="author.html#8027">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
