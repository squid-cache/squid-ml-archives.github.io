<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Native FTP relay for active FTP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3C3727b52d-31c6-f14e-dd8e-9eaa894b9e7d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008028.html">
   <LINK REL="Next"  HREF="008032.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Native FTP relay for active FTP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Native%20FTP%20relay%20for%20active%20FTP&In-Reply-To=%3C3727b52d-31c6-f14e-dd8e-9eaa894b9e7d%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Native FTP relay for active FTP">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 14 20:22:58 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008028.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
        <LI>Next message: <A HREF="008032.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8031">[ date ]</a>
              <a href="thread.html#8031">[ thread ]</a>
              <a href="subject.html#8031">[ subject ]</a>
              <a href="author.html#8031">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/14/2017 12:25 PM, Alex wrote:
&gt;<i> It seems that the patch doesn't make things worse (if I understood you
</I>&gt;<i> correctly).
</I>
AFAICT, you are not testing the use case that prompted [trunk] revision
12742.1.41 changes. There are three possibilities:

  1. r12742.1.41 changes were bogus/useless.
  2. Your changes break use cases supported by r12742.1.41 changes.
  3. Your changes do not break use cases supported by r12742.1.41
     because all of them have a COMM_TRANSPARENT flag set.

To know which outcome is correct, we need a test case that:

  A. Does not work without r12742.1.41 logic.
  B. Works with the current (i.e., post-r12742.1.41) unpatched code.
  C. Does not have a COMM_TRANSPARENT flag set.

If such a test case exists, then #2 is correct. Unfortunately, I do not
have a ready-to-use instructions on how to construct such a use case,
but it probably has to involve:

* direct/non-intercepted control connection (hence, no COMM_TRANSPARENT
flag if you are testing patched Squid code);

* multiple IP addresses from which Squid can open FTP data connections
to the FTP client (i.e., the FTP client IP has to be reachable from the
Squid box from two different source IP addresses);

* TCP stack selecting the wrong default source IP address when
establishing a connection from Squid to the FTP client.

When all of the above bullets are satisfied, r12742.1.41 starts to
matter in the patched code, meeting conditions A-C above. AFAICT, your
current test cases do not satisfy the last two bullets.


In other words, you patch removes setting the source IP address of the
Squid data connection to the destination address of the control
connection when there is no COMM_TRANSPARENT flag. Squid r12742.1.41
claims that such setting is necessary for some use cases to work. It is
not clear whether r12742.1.41 is only relevant to COMM_TRANSPARENT
connections. If it is, then your patch does not break things. If it is
not, then your patch probably does.


Hope this clarifies,

Alex.

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008028.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
	<LI>Next message: <A HREF="008032.html">[squid-dev] [PATCH] Native FTP relay for active FTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8031">[ date ]</a>
              <a href="thread.html#8031">[ thread ]</a>
              <a href="subject.html#8031">[ subject ]</a>
              <a href="author.html#8031">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
