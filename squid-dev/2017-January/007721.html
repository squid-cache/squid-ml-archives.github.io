<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Case-insensitive URI schemes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Case-insensitive%20URI%20schemes&In-Reply-To=%3C586FC8C5.2030708%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007698.html">
   <LINK REL="Next"  HREF="007885.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Case-insensitive URI schemes</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Case-insensitive%20URI%20schemes&In-Reply-To=%3C586FC8C5.2030708%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Case-insensitive URI schemes">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Fri Jan  6 16:41:41 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007698.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
        <LI>Next message: <A HREF="007885.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7721">[ date ]</a>
              <a href="thread.html#7721">[ thread ]</a>
              <a href="subject.html#7721">[ subject ]</a>
              <a href="author.html#7721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 06.01.2017 15:27, Amos Jeffries wrote:
&gt;<i> As a result, the code responsible for lower-case
</I>&gt;&gt;<i> transformation was not executed.
</I>&gt;<i>
</I>&gt;<i> That is intentional behaviour for several reasons;
</I>&gt;<i>
</I>&gt;<i> 1) it improves transparency and reduces risks from proxy 
</I>&gt;<i> fingerprinting by systems probing the URI scheme handling by the 
</I>&gt;<i> transport agents (ie, fingerprinting Squid).
</I>&gt;<i>
</I>&gt;<i> 2) unknown URI schemes are not necessarily handled properly as 
</I>&gt;<i> case-insensitive by the experimental agents sending and receiving the 
</I>&gt;<i> messages.
</I>&gt;<i>
</I>&gt;<i> also, (and more importantly);
</I>
The patch does not change this, i.e., &quot;unknown&quot; images are still stored 
without
down-casing.

&gt;<i>
</I>&gt;<i> 3) the transport protocol label and URI scheme label are still 
</I>&gt;<i> conflated. The scheme down-casing procedure is _only_ applicable when 
</I>&gt;<i> translating from ProtocolType_str labels (upper case) to scheme label 
</I>&gt;<i> (lower case).
</I>
To avoid misunderstanding I pay your attention that the unpatched Squid 
did not
down-case at all (i.e. for known ProtocolType_str schemes too). In other 
words, when
receiving <A HREF="HTTP://example.com">HTTP://example.com</A> &quot;HTTP&quot; was not down-cased. Just this 
violates HTTP
caching rules: two different cache entries were created for 
<A HREF="HTTP://example.com">HTTP://example.com</A>
and <A HREF="http://example.com">http://example.com</A> requests.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 4) storing the down-cased string for registered protocols of each URI 
</I>&gt;<i> avoids many explicit down-casing operations on use/display of the URI 
</I>&gt;<i> scheme. Note that is specific to the known protocols.
</I>&gt;<i>
</I>&gt;<i>  - There are many more points of code displaying the scheme than 
</I>&gt;<i> setting it. So this is a significant performance gain despite the 
</I>&gt;<i> overhead of allocating and own-casing a new SBuf per UriScheme object 
</I>&gt;<i> your patch notes with an XXX.
</I>
I am not against allocating and storing down-cased SBuf &quot;image_&quot; (for 
performance sake).
The related XXX is about  allocating SBuf which we probably can avoid in 
future optimization.
For example, we could do this by converting ProtocolType_str to a const 
array of SBufs, thus
avoiding image_ member allocation when dealing with known protocols.

&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are a couple of XXX and one of them (about &quot;broken caller&quot; for
</I>&gt;&gt;<i> PROTO_NONE) needs clarification. This caller uses PROTO_NONE
</I>&gt;&gt;<i> (i.e., absent scheme) together with &quot;http&quot; scheme image inside
</I>&gt;&gt;<i> clientReplyContext::createStoreEntry() which looks inconsistent and
</I>&gt;&gt;<i> probably is a bug. Am I missing anything there?
</I>&gt;<i>
</I>&gt;<i> Thats an odd case. I'm not exactly sure what we should be doing there. 
</I>&gt;<i> Thus the unusual parameter combo. It was done that way to minimize 
</I>&gt;<i> breakage with old code - so the request can be detected as missing 
</I>&gt;<i> scheme (avoid confusing with a real HTTP URL) if anything tries to 
</I>&gt;<i> compare it, but still generates a reasonably correct URL if its dumped 
</I>&gt;<i> to store files.
</I>&gt;<i>
</I>
Since you agree that it is an &quot;odd&quot; case (and we are not going to fix it 
right now) I would leave
the &quot;broken caller&quot; XXX.

Please note that the major problem here is probably the caching problem 
as I noted above.
I have not fully investigated whether it has security aspects, i.e., 
affects some URL based ACLs
while comparing with stored URLs.


Eduard.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170106/b948b1b4/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170106/b948b1b4/attachment.html</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007698.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
	<LI>Next message: <A HREF="007885.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7721">[ date ]</a>
              <a href="thread.html#7721">[ thread ]</a>
              <a href="subject.html#7721">[ subject ]</a>
              <a href="author.html#7721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
