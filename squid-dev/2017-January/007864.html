<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SSLv2%20records%20force%20SslBump%20bumping%20despite%0A%20a%20matching%20step2%20peek%20rule.&In-Reply-To=%3Cf59e14fc-a58d-f0d3-909c-72801a515531%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007792.html">
   <LINK REL="Next"  HREF="007865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20SSLv2%20records%20force%20SslBump%20bumping%20despite%0A%20a%20matching%20step2%20peek%20rule.&In-Reply-To=%3Cf59e14fc-a58d-f0d3-909c-72801a515531%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jan 25 18:24:56 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007792.html">[squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.
</A></li>
        <LI>Next message: <A HREF="007865.html">[squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7864">[ date ]</a>
              <a href="thread.html#7864">[ thread ]</a>
              <a href="subject.html#7864">[ subject ]</a>
              <a href="author.html#7864">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/16/2017 04:38 AM, Christos Tsantilas wrote:
&gt;<i> On 13/01/2017 07:04 μμ, Alex Rousskov wrote:
</I>&gt;&gt;<i> The dependency here is that clientHelloMessage comes from our parser. We
</I>&gt;&gt;<i> can substitute OpenSSL-generated ClientHello with client-sent
</I>&gt;&gt;<i> ClientHello because/if we successfully parsed and stored the latter. I
</I>&gt;&gt;<i> think we should validate clientHelloMessage/parsing state before using
</I>&gt;&gt;<i> clientHelloMessage.
</I>

&gt;<i> +            if (bumpMode_ == Ssl::bumpPeek) {
</I>&gt;<i> +                // client-sent ClientHello must be available for peek
</I>&gt;<i> +                Must(!clientSentHello.isEmpty());
</I>&gt;<i> +                if (adjustSSL(ssl, clientTlsDetails, clientSentHello))
</I>&gt;<i>                      allowBump = true;
</I>&gt;<i> +                allowSplice = true;
</I>&gt;<i> +                // Replace OpenSSL-generated ClientHello with client-sent one.
</I>&gt;<i> +                helloMsg.append(clientSentHello);
</I>&gt;<i> +                debugs(83, 7,  &quot;FD &quot; &lt;&lt; fd_ &lt;&lt; &quot;: Using client-sent ClientHello for peek mode&quot;);
</I>
What happens if that new Must() throws?

May Squid reach that Must() and will that Must() throw if Squid receives
a valid TLS Hello encapsulated into ancient SSLv2 records?

Our [fixed?] handling of situations like this is still not clear to me.
My concern does not imply that your code is wrong. It is just not clear
to me whether &quot;client-sent ClientHello must be available for peek&quot;
really means

* A client-sent ClientHello is required for peeking, but we might get
here without it in some unusual cases. Throw so that FooBar will see the
problem and handle these unusual cases.

 or

* A client-sent ClientHello is required for peeking. The calling code
must ensure that we never get here without it. Throw if our calling code
is buggy.

Please note that by &quot;calling code&quot; I do not mean some direct
ServerBio::write() caller. I mean any Squid code that sets up the BIO
object and allows it to proceed to write() under said circumstances.


&gt;<i> and for stare mode allow adjustSSL only if clientSentHello is not null.
</I>
That code/case is clear to me.


Thank you,

Alex.

</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007792.html">[squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.
</A></li>
	<LI>Next message: <A HREF="007865.html">[squid-dev] [PATCH] SSLv2 records force SslBump bumping despite a matching step2 peek rule.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7864">[ date ]</a>
              <a href="thread.html#7864">[ thread ]</a>
              <a href="subject.html#7864">[ subject ]</a>
              <a href="author.html#7864">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
