<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Drop deprecated MSIE Cache-Control	pre-check/post-check
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Drop%20deprecated%20MSIE%20Cache-Control%0A%09pre-check/post-check&In-Reply-To=%3Ce879acf6-f4f6-0038-9641-cd847b8493d0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007862.html">
   <LINK REL="Next"  HREF="007870.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Drop deprecated MSIE Cache-Control	pre-check/post-check</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Drop%20deprecated%20MSIE%20Cache-Control%0A%09pre-check/post-check&In-Reply-To=%3Ce879acf6-f4f6-0038-9641-cd847b8493d0%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Drop deprecated MSIE Cache-Control	pre-check/post-check">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 26 09:08:20 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007862.html">[squid-dev] Jenkins build is back to normal : 5-matrix » gcc,d-opensuse-13.2 #74
</A></li>
        <LI>Next message: <A HREF="007870.html">[squid-dev] [PATCH] Drop deprecated MSIE Cache-Control pre-check/post-check
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7868">[ date ]</a>
              <a href="thread.html#7868">[ thread ]</a>
              <a href="subject.html#7868">[ subject ]</a>
              <a href="author.html#7868">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>These two options have been a bit of annoyance for a long time.
Primarily because they are custom controls and almost all uses of them
is the garbage '0' values that even MSIE ignores completely. Validating
correctness would add processing which offsets the performance gained
from ignoring them.


It has come to my attention that the MSIE guys are now advising people
not to use them. So it seems we can take advantage and make some
performance gains on a lot of traffic, while helping to hasten their demise.

By adding these as registered CC values which are just dropped we can
both reduce outbound bandwith by ~20 bytes per message and avoid all the
slow String handling which CC_OTHER brings to the processing when these
are the only non-standard options present.

Amos

-------------- next part --------------
=== modified file 'src/HttpHdrCc.cc'
--- src/HttpHdrCc.cc	2017-01-07 03:10:12 +0000
+++ src/HttpHdrCc.cc	2017-01-26 02:38:15 +0000
@@ -24,40 +24,42 @@
 #include &lt;map&gt;
 #include &lt;vector&gt;
 #include &lt;ostream&gt;
 
 // invariant: row[j].id == j
 static LookupTable&lt;HttpHdrCcType&gt;::Record CcAttrs[] = {
     {&quot;public&quot;, HttpHdrCcType::CC_PUBLIC},
     {&quot;private&quot;, HttpHdrCcType::CC_PRIVATE},
     {&quot;no-cache&quot;, HttpHdrCcType::CC_NO_CACHE},
     {&quot;no-store&quot;, HttpHdrCcType::CC_NO_STORE},
     {&quot;no-transform&quot;, HttpHdrCcType::CC_NO_TRANSFORM},
     {&quot;must-revalidate&quot;, HttpHdrCcType::CC_MUST_REVALIDATE},
     {&quot;proxy-revalidate&quot;, HttpHdrCcType::CC_PROXY_REVALIDATE},
     {&quot;max-age&quot;, HttpHdrCcType::CC_MAX_AGE},
     {&quot;s-maxage&quot;, HttpHdrCcType::CC_S_MAXAGE},
     {&quot;max-stale&quot;, HttpHdrCcType::CC_MAX_STALE},
     {&quot;min-fresh&quot;, HttpHdrCcType::CC_MIN_FRESH},
     {&quot;only-if-cached&quot;, HttpHdrCcType::CC_ONLY_IF_CACHED},
     {&quot;stale-if-error&quot;, HttpHdrCcType::CC_STALE_IF_ERROR},
     {&quot;immutable&quot;, HttpHdrCcType::CC_IMMUTABLE},
+    {&quot;pre-check&quot;, HttpHdrCcType::CC_PRE_CHECK},
+    {&quot;post-check&quot;, HttpHdrCcType::CC_POST_CHECK},
     {&quot;Other,&quot;, HttpHdrCcType::CC_OTHER}, /* ',' will protect from matches */
     {nullptr, HttpHdrCcType::CC_ENUM_END}
 };
 LookupTable&lt;HttpHdrCcType&gt; ccLookupTable(HttpHdrCcType::CC_OTHER,CcAttrs);
 std::vector&lt;HttpHeaderFieldStat&gt; ccHeaderStats(HttpHdrCcType::CC_ENUM_END);
 
 /// used to walk a table of http_header_cc_type structs
 HttpHdrCcType &amp;operator++ (HttpHdrCcType &amp;aHeader)
 {
     int tmp = (int)aHeader;
     aHeader = (HttpHdrCcType)(++tmp);
     return aHeader;
 }
 
 /// Module initialization hook
 void
 httpHdrCcInitModule(void)
 {
     // check invariant on initialization table
     for (unsigned int j = 0; CcAttrs[j].name != nullptr; ++j) {
@@ -209,40 +211,44 @@
             break;
         case HttpHdrCcType::CC_NO_STORE:
             noStore(true);
             break;
         case HttpHdrCcType::CC_NO_TRANSFORM:
             noTransform(true);
             break;
         case HttpHdrCcType::CC_MUST_REVALIDATE:
             mustRevalidate(true);
             break;
         case HttpHdrCcType::CC_PROXY_REVALIDATE:
             proxyRevalidate(true);
             break;
         case HttpHdrCcType::CC_ONLY_IF_CACHED:
             onlyIfCached(true);
             break;
         case HttpHdrCcType::CC_IMMUTABLE:
             Immutable(true);
             break;
 
+        case HttpHdrCcType::CC_PRE_CHECK:
+        case HttpHdrCcType::CC_POST_CHECK:
+            break; // drop these
+
         case HttpHdrCcType::CC_OTHER:
             if (other.size())
                 other.append(&quot;, &quot;);
 
             other.append(item, ilen);
             break;
 
         default:
             /* note that we ignore most of '=' specs (RFCVIOLATION) */
             break;
         }
     }
 
     return (mask != 0);
 }
 
 void
 HttpHdrCc::packInto(Packable * p) const
 {
     // optimization: if the mask is empty do nothing
@@ -284,40 +290,42 @@
                 p-&gt;appendf(&quot;=%d&quot;, maxAge());
                 break;
             case HttpHdrCcType::CC_S_MAXAGE:
                 p-&gt;appendf(&quot;=%d&quot;, sMaxAge());
                 break;
             case HttpHdrCcType::CC_MAX_STALE:
                 /* max-stale's value is optional.
                   If we didn't receive it, don't send it */
                 if (maxStale()!=MAX_STALE_ANY)
                     p-&gt;appendf(&quot;=%d&quot;, maxStale());
                 break;
             case HttpHdrCcType::CC_MIN_FRESH:
                 p-&gt;appendf(&quot;=%d&quot;, minFresh());
                 break;
             case HttpHdrCcType::CC_ONLY_IF_CACHED:
                 break;
             case HttpHdrCcType::CC_STALE_IF_ERROR:
                 p-&gt;appendf(&quot;=%d&quot;, staleIfError());
                 break;
             case HttpHdrCcType::CC_IMMUTABLE:
+            case HttpHdrCcType::CC_PRE_CHECK:
+            case HttpHdrCcType::CC_POST_CHECK:
                 break;
             case HttpHdrCcType::CC_OTHER:
             case HttpHdrCcType::CC_ENUM_END:
                 // done below after the loop
                 break;
             }
 
             ++pcount;
         }
     }
 
     if (other.size() != 0)
         p-&gt;appendf((pcount ? &quot;, &quot; SQUIDSTRINGPH : SQUIDSTRINGPH), SQUIDSTRINGPRINT(other));
 }
 
 void
 httpHdrCcUpdateStats(const HttpHdrCc * cc, StatHist * hist)
 {
     assert(cc);
 

=== modified file 'src/HttpHdrCc.h'
--- src/HttpHdrCc.h	2017-01-07 03:10:12 +0000
+++ src/HttpHdrCc.h	2017-01-26 02:36:24 +0000
@@ -15,40 +15,42 @@
 #include &quot;SquidString.h&quot;
 #include &lt;iosfwd&gt;
 
 class Packable;
 
 enum HttpHdrCcType : unsigned char {
     CC_PUBLIC = 0,
     CC_PRIVATE,
     CC_NO_CACHE,
     CC_NO_STORE,
     CC_NO_TRANSFORM,
     CC_MUST_REVALIDATE,
     CC_PROXY_REVALIDATE,
     CC_MAX_AGE,
     CC_S_MAXAGE,
     CC_MAX_STALE,
     CC_MIN_FRESH,
     CC_ONLY_IF_CACHED,
     CC_STALE_IF_ERROR,
     CC_IMMUTABLE, /* draft-mcmanus-immutable-00 */
+    CC_PRE_CHECK, /* obsolete MSIE value to identify and drop */
+    CC_POST_CHECK, /* obsolete MSIE value to identify and drop */
     CC_OTHER,
     CC_ENUM_END /* also used to mean &quot;invalid&quot; */
 };
 
 /** Http Cache-Control header representation
  *
  * Store and parse the Cache-Control HTTP header.
  */
 class HttpHdrCc
 {
     MEMPROXY_CLASS(HttpHdrCc);
 
 public:
     static const int32_t MAX_AGE_UNKNOWN=-1; //max-age is unset
     static const int32_t S_MAXAGE_UNKNOWN=-1; //s-maxage is unset
     static const int32_t MAX_STALE_UNKNOWN=-1; //max-stale is unset
     ///used to mark a valueless Cache-Control: max-stale directive, which instructs
     /// us to treat responses of any age as fresh
     static const int32_t MAX_STALE_ANY=0x7fffffff;
     static const int32_t STALE_IF_ERROR_UNKNOWN=-1; //stale_if_error is unset

</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007862.html">[squid-dev] Jenkins build is back to normal : 5-matrix » gcc,d-opensuse-13.2 #74
</A></li>
	<LI>Next message: <A HREF="007870.html">[squid-dev] [PATCH] Drop deprecated MSIE Cache-Control pre-check/post-check
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7868">[ date ]</a>
              <a href="thread.html#7868">[ thread ]</a>
              <a href="subject.html#7868">[ subject ]</a>
              <a href="author.html#7868">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
