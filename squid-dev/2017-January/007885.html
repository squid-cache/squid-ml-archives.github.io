<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Case-insensitive URI schemes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Case-insensitive%20URI%20schemes&In-Reply-To=%3Cbe7d4732-6499-0ade-a7e1-d9af0f4643a3%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007721.html">
   <LINK REL="Next"  HREF="007886.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Case-insensitive URI schemes</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Case-insensitive%20URI%20schemes&In-Reply-To=%3Cbe7d4732-6499-0ade-a7e1-d9af0f4643a3%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Case-insensitive URI schemes">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jan 29 14:10:29 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007721.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
        <LI>Next message: <A HREF="007886.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7885">[ date ]</a>
              <a href="thread.html#7885">[ thread ]</a>
              <a href="subject.html#7885">[ subject ]</a>
              <a href="author.html#7885">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/01/2017 5:41 a.m., Eduard Bagdasaryan wrote:
&gt;<i> 
</I>&gt;<i> On 06.01.2017 15:27, Amos Jeffries wrote:
</I>&gt;&gt;<i> As a result, the code responsible for lower-case
</I>&gt;&gt;&gt;<i> transformation was not executed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is intentional behaviour for several reasons;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) it improves transparency and reduces risks from proxy
</I>&gt;&gt;<i> fingerprinting by systems probing the URI scheme handling by the
</I>&gt;&gt;<i> transport agents (ie, fingerprinting Squid).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2) unknown URI schemes are not necessarily handled properly as
</I>&gt;&gt;<i> case-insensitive by the experimental agents sending and receiving the
</I>&gt;&gt;<i> messages.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> also, (and more importantly);
</I>&gt;<i> 
</I>&gt;<i> The patch does not change this, i.e., &quot;unknown&quot; images are still stored
</I>&gt;<i> without
</I>&gt;<i> down-casing.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3) the transport protocol label and URI scheme label are still
</I>&gt;&gt;<i> conflated. The scheme down-casing procedure is _only_ applicable when
</I>&gt;&gt;<i> translating from ProtocolType_str labels (upper case) to scheme label
</I>&gt;&gt;<i> (lower case).
</I>&gt;<i> 
</I>&gt;<i> To avoid misunderstanding I pay your attention that the unpatched Squid
</I>&gt;<i> did not
</I>&gt;<i> down-case at all (i.e. for known ProtocolType_str schemes too). In other
</I>&gt;<i> words, when
</I>&gt;<i> receiving <A HREF="HTTP://example.com">HTTP://example.com</A> &quot;HTTP&quot; was not down-cased. Just this
</I>&gt;<i> violates HTTP
</I>&gt;<i> caching rules: two different cache entries were created for
</I>&gt;<i> <A HREF="HTTP://example.com">HTTP://example.com</A>
</I>&gt;<i> and <A HREF="http://example.com">http://example.com</A> requests.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4) storing the down-cased string for registered protocols of each URI
</I>&gt;&gt;<i> avoids many explicit down-casing operations on use/display of the URI
</I>&gt;&gt;<i> scheme. Note that is specific to the known protocols.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  - There are many more points of code displaying the scheme than
</I>&gt;&gt;<i> setting it. So this is a significant performance gain despite the
</I>&gt;&gt;<i> overhead of allocating and own-casing a new SBuf per UriScheme object
</I>&gt;&gt;<i> your patch notes with an XXX.
</I>&gt;<i> 
</I>&gt;<i> I am not against allocating and storing down-cased SBuf &quot;image_&quot; (for
</I>&gt;<i> performance sake).
</I>&gt;<i> The related XXX is about  allocating SBuf which we probably can avoid in
</I>&gt;<i> future optimization.
</I>&gt;<i> For example, we could do this by converting ProtocolType_str to a const
</I>&gt;<i> array of SBufs, thus
</I>&gt;<i> avoiding image_ member allocation when dealing with known protocols.
</I>&gt;<i> 
</I>
That will not help avoid the re-allocation since ProtocolType_str should
be upper case and COW property will reallocate for lower-casing anyway.


I'm thinking the quick-and-dirty way is to just lowercase the 'proto'
variable in url.cc urlParse() function. Doing that in the for-loop where
it is copied from 'src' would be easiest.
 - it breaks the case preservation on unknown schemes a litte bit. But
since they are supposed to be insensitive anyway the harm is minimal.

Amos

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007721.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
	<LI>Next message: <A HREF="007886.html">[squid-dev] [PATCH] Case-insensitive URI schemes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7885">[ date ]</a>
              <a href="thread.html#7885">[ thread ]</a>
              <a href="subject.html#7885">[ subject ]</a>
              <a href="author.html#7885">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
