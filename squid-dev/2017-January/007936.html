<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204662%20adding%20--with-libressl%20build%20option&In-Reply-To=%3C009f8215-d7b2-7c07-4c68-e4d57d3a7f77%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="007935.html">
   <LINK REL="Next"  HREF="007887.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Bug%204662%20adding%20--with-libressl%20build%20option&In-Reply-To=%3C009f8215-d7b2-7c07-4c68-e4d57d3a7f77%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan 31 16:49:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="007935.html">[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
</A></li>
        <LI>Next message: <A HREF="007887.html">[squid-dev] Build failed in Jenkins: 5-matrix » clang,rs-fbsd-10 #80
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7936">[ date ]</a>
              <a href="thread.html#7936">[ thread ]</a>
              <a href="subject.html#7936">[ subject ]</a>
              <a href="author.html#7936">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/31/2017 08:20 AM, Amos Jeffries wrote:
&gt;<i> On 31/01/2017 7:04 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i> On 01/29/2017 04:26 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> This is I think all we need to do code-wise to resolve the Bug 4662
</I>&gt;&gt;&gt;<i> issues with LibreSSL being incompatible with OpenSSL 1.1.
</I>
&gt;&gt;<i> I do not think these changes should be committed. As you probably know
</I>&gt;&gt;<i> from earlier communication, I think we should avoid using both
</I>&gt;&gt;<i> USE_OPENSSL and USE_LIBRESSL in the code if LibreSSL is [treated as] a
</I>&gt;&gt;<i> replacement for OpenSSL. I have suggested several ways to avoid the
</I>&gt;&gt;<i> dangerous and needless repetition of (USE_OPENSSL || USE_LIBRESSL)
</I>&gt;&gt;<i> conditions, and we even seemed to agree on one of those solutions.
</I>

&gt;<i> IMO we only agreed on the HAVE_* macro usage for determining whether the
</I>&gt;<i> 1.1 API was in use. Which is included in this patch.
</I>
I do not limit &quot;feature tests&quot; to &quot;1.1 API&quot;. Any feature is eligible. In
fact, it may be a good idea to test individual features rather than
bundle many of them into a single API version test (that will become
obsolete as parts of that API are going to change). However, those
details are probably not very important when resolving the core
disagreement here.


&gt;<i> I don't think the repetition of (USE_OPENSSL || USE_LIBRESSL) is either
</I>&gt;<i> needless or dangerous.
</I>
The needless part is not a matter of opinion. It is a fact -- you do not
need to repeat the (USE_OPENSSL || USE_LIBRESSL) test. You may use a
single USE_FOOBAR macro to avoid this code repetition. The exact
spelling of FOOBAR is a separate question.

Whether code duplication is bad, dangerous, unwanted, etc. is certainly
a matter of opinion and subject to context, but I doubt you can convince
me that it is not in this case, especially as we have started using
USE_OPENSSL macro in complex expressions involving GnuTLS.


&gt;<i> No more than USE_OPENSSL was in the same spot.
</I>
Repeating (a || b) condition many times is bad. Using a single (c)
condition many times is not. We should not be arguing about that basic
programming principle!


&gt;<i> Fixing the sheer number of uses is not in scope.
</I>&gt;<i> 
</I>&gt;<i> Keep it simple. 
</I>
I believe we can simply continue to use USE_OPENSSL almost everywhere it
is used today. No &quot;fixing&quot; is needed in this context except changing
what you think that macro should stand for.


&gt;<i> Only one macro per library. --with-foo sets USE_FOO.
</I>
For you, the libraries provided by OpenSSL and LibreSSL project are two
different &quot;libraries&quot;. For me, they are two slightly different flavors
of the same &quot;library&quot;. IMO, the developers should not be forced to think
which flavor is in use now or which flavors are supported today, except
in very few low-level cases where that information might be needed. With
feature tests, the number of such cases might be zero.

In other words, you seem to abstract at the level of file name spelling.
I abstract at the level of APIs. Naturally, it is difficult to agree on
a single scheme that accommodates both approaches!

Needless to say, the two projects may eventually diverge their APIs so
that one is no longer a flavor of the other. This day has not come yet,
and one could hope that LibreSSL folks would either avoid this
divergence or have the decency to stop using &quot;OPENSSL&quot; in their diverged
API names.


&gt;<i> NP: I am only adding the &quot;|| USE_LIBRESSL&quot; parts in this patch because I
</I>&gt;<i> happen to know that the existing code is being used with LibreSSL and
</I>&gt;<i> found to be working. Future code will have to prove itself separately
</I>&gt;<i> for each library, OR at the submitters discretion (passing audit and QA
</I>&gt;<i> also) list the librares believed to be safe with it.
</I>
I believe the approach you have described is inferior to treating both
OpenSSL and LibreSSL as providing the same overall API while avoiding
(or treating specially) the rare parts of the API that differ. Today,
there is only one such known exception in Squid context -- the
OPENSSL_VERSION_NUMBER macro. We seem to agree that we should not be
using that part of the API anyway, so there will be no exceptions at all
after OPENSSL_VERSION_NUMBER is replaced with feature tests.

Your approach appears to be based on the assumption that enabling or
disabling individual code pieces dealing with OpenSSL/LibreSSL APIs
based on &quot;known to be used and seemingly working&quot; test will preserve the
overall integrity of the code. I believe that assumption is wrong and
that low-level approach is too dangerous. IMO, the decision whether to
support LibreSSL in Squid should be made on a much higher level than an
individual piece of code. Levels such as &quot;whole Squid&quot; or &quot;non-bumping
Squid&quot; would be more appropriate. Exceptions might be made for small,
isolated functionality, but they should be carefully considered
exceptions, not the rule.

The considerations in the above two paragraphs are orthogonal to
avoiding code duplication but avoiding code duplication is easier when
LibreSSL support decisions are made at a level higher than individual
preprocessor statements.


&gt;<i> It is not a blocker, but I would like to avoid declaring LibreSSL as no
</I>&gt;<i> longer supported by v4 since the fix is not exactly hard.
</I>
1. You do not have to declare anything with regard to LibreSSL support,
   especially at the v4 branch level. An open bug report is sufficient.
   IIRC, we have not declared LibreSSL as officially supported either.

2. The difficulty of changing Squid code lines is an important factor,
   but there are other factors to consider. Those other factors make
   the proposed &quot;not hard&quot; fix undesirable IMO.

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007935.html">[squid-dev] [PATCH] Bug 4662 adding --with-libressl build option
</A></li>
	<LI>Next message: <A HREF="007887.html">[squid-dev] Build failed in Jenkins: 5-matrix » clang,rs-fbsd-10 #80
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7936">[ date ]</a>
              <a href="thread.html#7936">[ thread ]</a>
              <a href="subject.html#7936">[ subject ]</a>
              <a href="author.html#7936">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
