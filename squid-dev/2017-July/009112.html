<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] switch session/connection for OpenSSL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20switch%20session/connection%20for%20OpenSSL&In-Reply-To=%3Caae1b8a2-1e1b-62c2-85c2-54386d680f8c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009109.html">
   <LINK REL="Next"  HREF="009116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] switch session/connection for OpenSSL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20switch%20session/connection%20for%20OpenSSL&In-Reply-To=%3Caae1b8a2-1e1b-62c2-85c2-54386d680f8c%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] switch session/connection for OpenSSL">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jul  9 03:28:51 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009109.html">[squid-dev]  mardi le dix août  Vive l’expérience
</A></li>
        <LI>Next message: <A HREF="009116.html">[squid-dev] [PATCH] switch session/connection for OpenSSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9112">[ date ]</a>
              <a href="thread.html#9112">[ thread ]</a>
              <a href="subject.html#9112">[ subject ]</a>
              <a href="author.html#9112">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/10/2017 06:27 AM, Amos Jeffries wrote:

&gt;<i> Yes this is far from complete, and intentionally much smaller that
</I>&gt;<i> the previous patch.
</I>
I believe this patch is a huge step in the right direction. It has one
serious flaw (namespace misuse), but I hope that can be addressed
without too much controversy. The details are further below.


&gt;<i> On 27/04/17 05:24, Alex Rousskov wrote:
</I>&gt;&gt;<i> Needless to say, I would be happy if we can come up with better
</I>&gt;&gt;<i> definitions or even better concepts. The above is a starting point.
</I>
&gt;<i> I do not think it is up to us to define these things. So I have taken a
</I>&gt;<i> much longer reading of all the RFCs since SSLv3.0 through to current
</I>&gt;<i> TLS/1.3 and isolated what are the authoritative definitions AFAICT.
</I>
For the record, I am happy to adopt any &quot;authoritative&quot; definitions that
suite Squid specifics well, but, IMO, it is up to _us_ to decide
suitability and, if necessary, to define and/or clarify things within
Squid context. Quoting RFCs is often useful, but it is not a panacea for
any problem, including the terminology problem.

For example, a TLS Connection exists, as a concept, whether any RFC
defines or not. An RFC may not need that definition, may assume that
every reader already understands that concept, or may just be sloppy. We
should reuse what we can and fill the gaps with our own definitions as
needed.


&gt;<i> * moves the pieces that are doing what is defined as solely TLS
</I>&gt;<i> Connection things to security/TlsConnection.* files.
</I>
Please do not misinterpret the namespace comments below as a
disagreement with the above change. Moving TLS Connection code to
security/TlsConnection.* files is fine with me.


&gt;<i> * adds a Security::TlsConnection::Pointer type for use by code dealing
</I>&gt;<i> with TLS Connection logic.
</I>
This is also great.


&gt;<i>  - SessionPointer still exists for code performing TLS Session logic.
</I>&gt;<i> see PeerConnector description for the distinction.
</I>
Sure, this is fine. TLS Session is a perfectly valid concept as well.


&gt;<i>  - I have not gone through and renamed uses of SessionPointer beyond
</I>&gt;<i> those directly involved with the above code shuffle.
</I>
Can you give an example or two of old uses that should be fixed? Do you
plan on doing this renaming as a part of this series of patches? It
would be nice to get rid of the inconsistencies in one sweep or, if
necessary, several close-in-time changes...


&gt;<i> +namespace TlsConnection {
</I>
We should not use namespaces for what is a class. Very roughly speaking:
If you can create multiple instances of X, then X is (or can be) a
class. It is not a namespace. In this context:

* I can have five &quot;TLS connections&quot;. A &quot;TLS connection&quot; is (or can be) a
class.

* All TLS-related functions, classes, constants, and other interfaces
can be grouped under a single &quot;Tls&quot; namespace. I cannot have five TLSs.
&quot;Tls&quot; is (or can be) a namespace.

N.B. I do not suggest adding a TLS connection class now (and we already
have library-specific types that currently fulfill that role,
essentially). Using Security::ConnectionPointer is enough.


&gt;<i> +    if (Security::TlsConnection::CreateServer(ctx, conn, &quot;client https start&quot;)) {
</I>
I would replace TlsConnection::CreateServer, which reads like nonsense
IMHO, with something like:

* Accept
* AcceptConnection
* PrepareToAccept
* CreateConnection(ToSquid)

And the corresponding names for the Squid-to-peer TLS connections:

* Connect
* InitiateConnection
* PrepareToConnect
* CreateConnection(FromSquid)

&quot;Accept&quot; and &quot;connect&quot; are common networking terms that can be applied
to TLS connections well. The last two versions in each group are more
precise because these functions only _prepare_ the TLS connection for
future negotiations; they do not actually start those negotiations.

All these functions should be inside the existing Security namespace. If
you think we will have non-SSL/TLS things inside Security, then we can
also add a Tls namespace, but I do not see the need for that right now.


&gt;<i> +/// Create TLS state objects and associate with a TLS connection to form a TLS connection.
</I>&gt;<i> +/// Client connection structures and TLS/SSL I/O (Comm and BIO) are initialized.
</I>

&gt;<i> +/// Create TLS state objects and associate with a TLS connection to form a TLS connection.
</I>&gt;<i> +/// Server connection structures and TLS/SSL I/O (Comm and BIO) are initialized.
</I>

I am guessing something went wrong in the first sentences during
find-and-replace (&quot;TLS connection to form a TLS connection&quot;). See below
for a specific fix suggestion.

Also, please avoid the &quot;client connection&quot; and &quot;server connection&quot;
terminology, especially in high-level little-context descriptions like
these, because such terms are very confusing in Squid context. As you
know, we already have &quot;client side&quot; that has &quot;server agents&quot;, and
&quot;server side&quot; that has &quot;client agents&quot;. To reduce confusion, use
&quot;from-client connection&quot; and &quot;to-server connection&quot; phrasing instead
(or, if you prefer, the verbose &quot;client-to-Squid connection&quot; and
&quot;Squid-to-server connection&quot; variants.

Please consider using these replacements:

/// Creates a TLS Connection and
/// associates it with the given from-client transport connection.
/// \returns false on errors (and logs details using DBG_IMPORTANT)

/// Creates a TLS Connection and
/// associates it with the given to-server transport connection.
/// \returns false on errors (and logs details using DBG_IMPORTANT)


The other comments are about relatively minor problems:


&gt;<i> + * Initializes TLS data structures and associates with a TCP Connection
</I>&gt;<i> + * to form a Client or Server TLS Connection.
</I>
&gt;<i> + * Initiates encryption on a TCP Connection to peers or servers.
</I>
&gt;<i> + * The caller must monitor the connection for TCP closure because this job will
</I>

s/TCP Connection/transport connection/g

s/the connection for TCP/the transport connection for/

because when we start supporting SslBump for HTTPS proxies and/or HTTP/2
for HTTPS proxies, that transport will not be TCP. There is nothing
specific to TCP in that code IIRC.

Please apply similar adjustments to other &quot;TCP&quot; phrase added by the patch.


&gt;<i> + * Initializes TLS data structures and associates with a TCP Connection
</I>&gt;<i> + * to form a Client or Server TLS Connection.
</I>
s/associates with/associates them with/

or

s/Initializes ... and associates/Initializes and associates .../

because &quot;associates with&quot; is missing an object in this context
(&quot;Associates what?&quot;) -- the function itself does not associate with the
TCP connection.


&gt;<i> + * Initializes TLS data structures and associates with a TCP Connection
</I>&gt;<i> + * to form a Client or Server TLS Connection.
</I>
I would replace &quot;to form a Client or Server TLS Connection&quot; with &quot;to a
TLS Connection with a Client or Server&quot;.


&gt;<i> ... The primary operational
</I>&gt;<i> + * difference between the server and client is that the server is
</I>&gt;<i> + * generally authenticated, while the client is only optionally
</I>&gt;<i> + * authenticated.&quot;
</I>
I recommend removing that text -- that &quot;primary operational difference&quot;
has little to do with the CreateTlsConnection code.

Overall, quoting fairly generic &quot;client&quot; and &quot;server&quot; definitions feels
like noise to me, but I am not going to fight you about that.


&gt;<i> -    // Temporary ssl for getting X509 certificate from SSL_CTX.
</I>&gt;<i> -    Security::SessionPointer ssl(Security::NewSessionObject(ctx));
</I>&gt;<i> +    // Temporary Pointer&lt;SSL&gt; for getting X509 certificate from SSL_CTX.
</I>&gt;<i> +    Security::TlsConnection::Pointer ssl(Security::TlsConnection::NewSslObject(ctx));
</I>
s/Pointer&lt;SSL&gt;/SSL object/

... because the comment is about the temporary OpenSSL SSL object, not
the pointer to it (the local pointer variable is also temporary, but
that is not the point here -- it is the temporary nature of the
underlying SSL object that is rather unusual and worth commenting on).


&gt;<i> PS: Applying the definitions to PeerConnector, it has become clear that
</I>&gt;<i> it (and children) not following a MUST requirement about the underlying
</I>&gt;<i> TCP transport connection being terminated in the case where Handshake
</I>&gt;<i> negotiation failed due to a Record protocol violation. They are leaving
</I>&gt;<i> this closure to the caller which is a layering violation
</I>
There is no layering violation in letting the transport-aware caller to
do transport-specific things. I seriously doubt separating handshake
failure detection code from the code reacting to that failure violates
any RFC MUSTs! There are certainly interface problems between
PeerConnector and its users, but they are mostly software problems
unrelated to RFCs/terminology and are outside this thread scope AFAICT.


Thank you,

Alex.
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009109.html">[squid-dev]  mardi le dix août  Vive l’expérience
</A></li>
	<LI>Next message: <A HREF="009116.html">[squid-dev] [PATCH] switch session/connection for OpenSSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9112">[ date ]</a>
              <a href="thread.html#9112">[ thread ]</a>
              <a href="subject.html#9112">[ subject ]</a>
              <a href="author.html#9112">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
