<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Purge cache entries in SMP-aware caches
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Purge%20cache%20entries%20in%20SMP-aware%20caches&In-Reply-To=%3Ca659f750-f53c-875c-c66f-788a2e6aa328%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009174.html">
   <LINK REL="Next"  HREF="009227.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Purge cache entries in SMP-aware caches</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Purge%20cache%20entries%20in%20SMP-aware%20caches&In-Reply-To=%3Ca659f750-f53c-875c-c66f-788a2e6aa328%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Purge cache entries in SMP-aware caches">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Jul 22 23:04:18 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009174.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
        <LI>Next message: <A HREF="009227.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9220">[ date ]</a>
              <a href="thread.html#9220">[ thread ]</a>
              <a href="subject.html#9220">[ subject ]</a>
              <a href="author.html#9220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/13/2017 07:26 AM, Eduard Bagdasaryan wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I am attaching an improved version of the patch posted before.
</I>&gt;<i> It is based on v4 r15081. What was fixed:
</I>
I do not see any high-level problems with this code, and it does not
look like others are going to comment on the v4 patch that have been
available for a while. Please sync to master and post a pull request!

A few improvement suggestions:

Please see if you can either

* make updateCollapsed() calls consistent with respect to requiring (via
assert) the given entry presence in the index or always returning either
true or false when the given entry is not present

or

* preserve the old checks meaning (while using new/improved interfaces)

Currently, the removal of some checks left the code in an arguably more
inconsistent state than it was before the changes.


&gt;<i> +MemStore::unlinkByKeyIfFound(const cache_key *key)
</I>&gt;<i> +{
</I>&gt;<i> +    map-&gt;freeEntryByKey(key);
</I>&gt;<i>  }
</I>
Do nothing if map is nil.


&gt;<i> +    /// whether there is a corresponding disk store entry
</I>&gt;<i> +    bool hasDisk(const sdirno dirn = -1, const sfileno filen = -1) const;
</I>
The description is misleading because the disk entry may exist without
StoreEntry knowing anything about it. I do not have a good solution for
this problem, but can suggest:

/// whether one of this StoreEntry owners has locked the corresponding
/// disk entry (at the specified disk entry coordinates, if any)


&gt;<i> +    /// Makes hasDisk() false. The caller should have deleted
</I>&gt;<i> +    /// the corresponding disk store entry.
</I>&gt;<i> +    void detachFromDisk();
</I>
Should we relax the &quot;should have deleted&quot; precondition from &quot;deleted&quot; to
&quot;unlocked&quot;?

Do callers normally unlock the entry before calling this method? After
calling this method? Depends on the caller?


&gt;<i>      // private entry or loading failure
</I>&gt;<i>      map-&gt;closeForReading(index);
</I>&gt;<i>      return NULL;
</I>
The comment became stale after the changes:

// (private or completed) entry or loading failure


&gt;<i>  StoreEntry *
</I>&gt;<i>  storeCreatePureEntry(const char *url, const char *log_url, const RequestFlags &amp;flags, const HttpRequestMethod&amp; method)
</I>&gt;<i>  {
</I>...
&gt;<i> +    if (!flags.cachable)
</I>&gt;<i> +        EBIT_SET(e-&gt;flags, RELEASE_REQUEST);
</I>
This release request feels out of place and direct flags setting goes
around the existing releaseRequest() API. Please check all callers --
perhaps we do not need the above because all callers already do an
equivalent action (e.g., makePrivate()) for &quot;uncachable&quot; requests?

&gt;<i> +    SWAPOUT_NONE, ///&lt; the store entry has not been stored on a disk
</I>
This definition seems to contradict the &quot;else&quot; usage in
Rock::SwapDir::disconnect(). What does SWAPOUT_NONE state correspond to
in that &quot;else&quot; clause? A readable disk entry? It may be tempting to use
SWAPOUT_DONE in that &quot;else&quot; clause inside disconnect() but I suspect
that another worker may still be writing that disk entry (i.e., there is
a SWAPOUT_WITING in another worker). We may need to either

* broaden SWAPOUT_NONE definition to cover that &quot;else&quot; clause or
* call anchor.complete() and use SWAPOUT_DONE/SWAPOUT_WITING in that
&quot;else&quot; clause, similar to what Rock::SwapDir::anchorEntry() does.

Please investigate and suggest any necessary changes.


Thank you,

Alex.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009174.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
	<LI>Next message: <A HREF="009227.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9220">[ date ]</a>
              <a href="thread.html#9220">[ thread ]</a>
              <a href="subject.html#9220">[ subject ]</a>
              <a href="author.html#9220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
