<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Purge cache entries in SMP-aware caches
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Purge%20cache%20entries%20in%20SMP-aware%20caches&In-Reply-To=%3Ced7c0303-1d97-d813-e1c0-4c69a44ec560%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009220.html">
   <LINK REL="Next"  HREF="009175.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Purge cache entries in SMP-aware caches</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Purge%20cache%20entries%20in%20SMP-aware%20caches&In-Reply-To=%3Ced7c0303-1d97-d813-e1c0-4c69a44ec560%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Purge cache entries in SMP-aware caches">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Sun Jul 23 23:00:48 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009220.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
        <LI>Next message: <A HREF="009175.html">[squid-dev] [PATCH] Fix SSL certificate cache refresh and collision	handling.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9227">[ date ]</a>
              <a href="thread.html#9227">[ thread ]</a>
              <a href="subject.html#9227">[ subject ]</a>
              <a href="author.html#9227">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23.07.2017 02:04, Alex Rousskov wrote:
&gt;&gt;<i> +    if (!flags.cachable)
</I>&gt;&gt;<i> +        EBIT_SET(e-&gt;flags, RELEASE_REQUEST);
</I>&gt;<i> This release request feels out of place and direct flags setting goes
</I>&gt;<i> around the existing releaseRequest() API. Please check all callers --
</I>&gt;<i> perhaps we do not need the above because all callers already do an
</I>&gt;<i> equivalent action (e.g., makePrivate()) for &quot;uncachable&quot; requests?
</I>
I don't think this lines are 'out of place': storeCreatePureEntry() just
initializes the just created StoreEntry fields (including
StoreEntry::flags) with correct values.  If we definitely know a
this moment that 'flags' should have RELEASE_REQUEST set, why do we need
to postpone this to many callers, hoping that all of them will do that
work correctly?  There are lots of storeCreateEntry() calls and it is
hardly possible to track that all of them end up with
'releaseRequest()', when flags.cachable is false.  BTW, at the time of
StoreEntry initialization we do not need to do most of the work
releaseRequest() does. E.g., there are no connected storages to
disconnect from, no public keys to make them private, etc. The only
thing to do is RELEASE_REQUEST flag setting.

&gt;&gt;<i> +    SWAPOUT_NONE, ///&lt; the store entry has not been stored on a disk
</I>&gt;<i> This definition seems to contradict the &quot;else&quot; usage in
</I>&gt;<i> Rock::SwapDir::disconnect(). What does SWAPOUT_NONE state correspond to
</I>&gt;<i> in that &quot;else&quot; clause? A readable disk entry? It may be tempting to use
</I>&gt;<i> SWAPOUT_DONE in that &quot;else&quot; clause inside disconnect() but I suspect
</I>&gt;<i> that another worker may still be writing that disk entry (i.e., there is
</I>&gt;<i> a SWAPOUT_WITING in another worker). We may need to either
</I>&gt;<i>
</I>&gt;<i> * broaden SWAPOUT_NONE definition to cover that &quot;else&quot; clause or
</I>&gt;<i> * call anchor.complete() and use SWAPOUT_DONE/SWAPOUT_WITING in that
</I>&gt;<i> &quot;else&quot; clause, similar to what Rock::SwapDir::anchorEntry() does.
</I>&gt;<i>
</I>&gt;<i> Please investigate and suggest any necessary changes.
</I>
This patch introduces an invariant StoreEntry::checkDisk() for disk
fields. According to this rule, a disconnected/unlinked entry
(swap_dirn &lt; 0) must have SWAPOUT_NONE.  So I assume we should correct
SWAPOUT_NONE definition, e.g.,:

/// a store entry which is either unlinked the disk Store or
/// has not been stored on a disk.


Thanks,

Eduard.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009220.html">[squid-dev] [PATCH] Purge cache entries in SMP-aware caches
</A></li>
	<LI>Next message: <A HREF="009175.html">[squid-dev] [PATCH] Fix SSL certificate cache refresh and collision	handling.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9227">[ date ]</a>
              <a href="thread.html#9227">[ thread ]</a>
              <a href="subject.html#9227">[ subject ]</a>
              <a href="author.html#9227">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
