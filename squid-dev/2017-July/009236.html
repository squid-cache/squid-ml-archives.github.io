<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reuse%20reserved%20Negotiate%20and%20NTLM%20helpers%0A%20after%20an%20idle%20timeout.&In-Reply-To=%3C6dc858ed-329d-593a-8f3b-a5a5079737ae%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009234.html">
   <LINK REL="Next"  HREF="009239.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reuse%20reserved%20Negotiate%20and%20NTLM%20helpers%0A%20after%20an%20idle%20timeout.&In-Reply-To=%3C6dc858ed-329d-593a-8f3b-a5a5079737ae%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jul 30 03:48:33 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009234.html">[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
</A></li>
        <LI>Next message: <A HREF="009239.html">[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9236">[ date ]</a>
              <a href="thread.html#9236">[ thread ]</a>
              <a href="subject.html#9236">[ subject ]</a>
              <a href="author.html#9236">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/07/17 18:52, Christos Tsantilas wrote:
&gt;<i> The patch.
</I>&gt;<i> 
</I>&gt;<i> Στις 26/07/2017 12:37 μμ, ο Christos Tsantilas έγραψε:
</I>&gt;&gt;<i> Squid can be killed or maimed by enough clients that start multi-step 
</I>&gt;&gt;<i> connection authentication but never follow up with the second HTTP 
</I>&gt;&gt;<i> request while keeping their HTTP connection open. Affected helpers 
</I>&gt;&gt;<i> remain in the &quot;reserved&quot; state and cannot be reused for other clients. 
</I>&gt;&gt;<i> Observed helper exhaustion has happened without any malicious intent.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To address the problem, we add a helper reservation timeout. Timed out 
</I>&gt;&gt;<i> reserved helpers may be reused by new clients/connections. To minimize 
</I>&gt;&gt;<i> problems with slow-to-resume-authentication clients, timed out 
</I>&gt;&gt;<i> reserved helpers are not reused until there are no unreserved running 
</I>&gt;&gt;<i> helpers left. The reservations are tracked using unique integer IDs.
</I>&gt;&gt;<i>
</I>
Since NTLM and Negotiate are both very stateful security protocols this 
re-use is only possible if the helper is using concurrency in its 
communications with Squid. To do so otherwise would randomly allow 
replay attacks to succeed - in a way that would be extremely nasty to 
troubleshoot. Attackers are fully able to flood an auth backend with 
traffic outside of Squid and slow it down sufficiently for this attack 
to become a problem.
  Note that the type-1 tokens where the TCP connection can be closed 
also should not reserve a helper - if that is happening it is a bug 
regardless of this patch.


To reach the desired behaviour it would be better to actually implement 
concurrency support for the stateful helpers interfaces. So we can 
ensure the helper is fully aware of the separation between clients auth 
sessions regardless of whether any given token gets replayed.

It should not be much of a step to use the concurrency channel-ID as 
part of the reservationId. Helpers that support concurrency should not 
have trouble servicing auth on other channel-ID until the total number 
of reserved channels gets extremely high. At that point restarting the 
helper is sane and the existing on-persistent-overload logics can be 
applied to whether Squid dies or simply kills the blocked helper (ERR).


This patch is going most of the way towards that already by using 
reservation-ID to replace hardcoded class dependencies, and moving a lot 
of code to the Base class. But it does not go far enough to make the 
change safe to add to Squid IMO.


NP: I have only briefly checked the code to be sure this was not 
actually doing the concurrency change yet without mentioning it. 
However, one other major issue stands out;

StatefulGetFirstAvailable() is a C-style accessor method for the 
stateful_helper, we simply have not managed to make it one properly yet. 
The value it is given is the context within/for which the caller needs 
it to find a usable *_server. Changing that context in order to find a 
different server result (for some other context) is not an appropriate 
thing to be doing.

The only thing in the new code for StatefulGetFirstAvailable() which 
might lead to it needing non-const is the HelperServerBase::reserved() 
method being indirectly called. That method should be &quot;virtual bool 
reserved() const = 0&quot;. Fixing that should make the 
StatefulGetFirstAvailable() API const'ness change unnecessary.


-1 for now, and please do not apply this until the replay attack problem 
is fully resolved.

Amos
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009234.html">[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
</A></li>
	<LI>Next message: <A HREF="009239.html">[squid-dev] [PATCH] Reuse reserved Negotiate and NTLM helpers after an idle timeout.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9236">[ date ]</a>
              <a href="thread.html#9236">[ thread ]</a>
              <a href="subject.html#9236">[ subject ]</a>
              <a href="author.html#9236">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
