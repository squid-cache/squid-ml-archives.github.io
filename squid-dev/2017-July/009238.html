<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Migrate explicit syslog calls to debugs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Migrate%20explicit%20syslog%20calls%20to%20debugs&In-Reply-To=%3Cea71dac0-6e7f-5d49-2555-6970fc692466%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009235.html">
   <LINK REL="Next"  HREF="009242.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Migrate explicit syslog calls to debugs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Migrate%20explicit%20syslog%20calls%20to%20debugs&In-Reply-To=%3Cea71dac0-6e7f-5d49-2555-6970fc692466%40treenet.co.nz%3E"
       TITLE="[squid-dev] [RFC] Migrate explicit syslog calls to debugs">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jul 31 09:04:50 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009235.html">[squid-dev] [RFC] Migrate explicit syslog calls to debugs
</A></li>
        <LI>Next message: <A HREF="009242.html">[squid-dev] [RFC] Migrate explicit syslog calls to debugs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9238">[ date ]</a>
              <a href="thread.html#9238">[ thread ]</a>
              <a href="subject.html#9238">[ subject ]</a>
              <a href="author.html#9238">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/07/17 11:12, Alex Rousskov wrote:
&gt;<i> On 07/26/2017 11:04 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 27/07/17 16:06, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i>       Squid master process uses many explicit syslog() calls like these:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_ALERT, &quot;fork failed: %s&quot;, xstrerr(xerrno));
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_ALERT, &quot;Suspiciously high workers value: %d&quot;,
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: will start %d kids&quot;, (int)TheKids.count());
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_ALERT, &quot;execvp failed: %s&quot;, xstrerr(xerrno));
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: %s process %d started&quot;,
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: %s process %d exited with status %d&quot;,
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: %s process %d exited due to signal %d with status %d&quot;,
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: %s process %d exited&quot;,
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: %s process %d will not&quot;
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_NOTICE, &quot;Squid Parent: unknown child process %d exited&quot;, pid);
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_ALERT, &quot;Exiting due to unexpected forced shutdown&quot;);
</I>&gt;&gt;&gt;&gt;<i> syslog(LOG_ALERT, &quot;Exiting due to repeated, frequent failures&quot;);
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I propose to replace explicit syslog() calls with DBG_CRITICAL and
</I>&gt;&gt;&gt;<i> DBG_IMPORTANT debugs() calls _and_ automatically enable syslog-logging
</I>&gt;&gt;&gt;<i> of levels 0-1 debugs() calls made by the master process.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> It can easily result in log lines too long for syslog to record easily
</I>&gt;&gt;<i> (IIRC some do brain-dead line wrapping at inconvenient lengths). So that
</I>&gt;&gt;<i> will need to be accounted for in the design.
</I>&gt;<i> 
</I>&gt;<i> AFAICT[1], &quot;too long&quot; here means &quot;more than 400 characters&quot; in extreme
</I>&gt;<i> cases and &quot;more than 2000 characters&quot; in most environments, so any
</I>&gt;<i> reasonable DBG_CRITICAL and DBG_IMPORTANT messages should be safe. Such
</I>&gt;<i> messages ought to be brief anyway. And if some overly detailed messages
</I>&gt;<i> are truncated or wrapped awkwardly, it is not a big deal IMHO.
</I>
Any log message that mentions a URL (eg a security alert, or a critical 
warning about some transaction-specific thing) may be upwards of 8000 
characters long.

Some of the most important (and correspondingly rare) log messages 
contain URL to assist tracking down the exact problematic transaction 
which is breaking things without assertion or fatal termination of Squid.

The common case short messages are not the one we have to care about, 
they should work whatever is implemented.  It is the rare cases that 
cause mess we have to take care to design around.

In case you missed it, I was not objecting. My point was that you will 
have to review all those 0/1 level outputs to ensure that the maximum 
useful info is output before the truncation point.

FWIW: I have vague recollections of encountering bug reports about one 
syslog implementation causing somebody problems by NOT doing that 
documented truncation, but by slicing the line into multiple parts 
indiscriminantly and prefixing each with the syslog timestamp etc info. 
Words or key=value wrapping at weird places.

That one may come up for us, but I'm okay as long as the truncation is 
coped with.


&gt;<i> 
</I>&gt;<i> [1]
</I>&gt;<i> <A HREF="https://stackoverflow.com/questions/3310875/find-syslog-max-message-length">https://stackoverflow.com/questions/3310875/find-syslog-max-message-length</A>
</I>&gt;<i> 
</I>&gt;<i> Do you think that declaring a &quot;keep level-0/1 messages brief&quot; policy
</I>&gt;<i> would be sufficient here, killing two logging birds with one stone?
</I>&gt;<i> 
</I>
Not really. The most successful critical messages contain extra text 
telling the admin what they can do. Even the most dumb admin can easily 
get help from more observant people that way.


&gt;<i> 
</I>&gt;&gt;<i> I wonder if the use of clog you suggested years ago to resolve the early
</I>&gt;&gt;<i> startup messages problems should be fixed first.
</I>&gt;<i> 
</I>&gt;<i> I am afraid that fix is currently blocked on your response:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2017-June/008792.html">http://lists.squid-cache.org/pipermail/squid-dev/2017-June/008792.html</A>
</I>&gt;<i> 
</I>
Oh? &lt;<A HREF="http://www.squid-cache.org/Versions/v5/changesets/squid-5-15171.patch">http://www.squid-cache.org/Versions/v5/changesets/squid-5-15171.patch</A>&gt;

That thread has nothing to do with the clog idea I was referring to. 
IIRC you wanted debugs() to use std::clog instead of std::cerr so that 
the things done before main(), and also the bits before squid.conf 
loading completed could just be buffered then dumped through the 
expected cache.log channel when it became known.


&gt;<i> 
</I>&gt;&gt;<i> +1 on having this happen though, whenever it happens.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>

Cheers
Amos
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009235.html">[squid-dev] [RFC] Migrate explicit syslog calls to debugs
</A></li>
	<LI>Next message: <A HREF="009242.html">[squid-dev] [RFC] Migrate explicit syslog calls to debugs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9238">[ date ]</a>
              <a href="thread.html#9238">[ thread ]</a>
              <a href="subject.html#9238">[ subject ]</a>
              <a href="author.html#9238">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
