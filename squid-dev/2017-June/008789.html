<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Purge cache entries in SMP-aware caches
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Purge%20cache%20entries%20in%20SMP-aware%20caches&In-Reply-To=%3C68a0d7fb-6e14-195c-b167-fc9bdbea4643%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009058.html">
   <LINK REL="Next"  HREF="008790.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Purge cache entries in SMP-aware caches</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Purge%20cache%20entries%20in%20SMP-aware%20caches&In-Reply-To=%3C68a0d7fb-6e14-195c-b167-fc9bdbea4643%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Purge cache entries in SMP-aware caches">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Thu Jun  1 16:27:08 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009058.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
        <LI>Next message: <A HREF="008790.html">[squid-dev] [PATCH] Fix reopened bug 2833
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8789">[ date ]</a>
              <a href="thread.html#8789">[ thread ]</a>
              <a href="subject.html#8789">[ subject ]</a>
              <a href="author.html#8789">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

This patch fixes Squid bug 4505.

Before this change, SMP Squid with SMP-aware caches sometimes
does not purge cache entries.

When Squid finds a requested entry in the memory cache, it does not
check whether the same entry is also stored in a cache_dir. The
StoreEntry object may become associated with its store entry in the
memory cache but not with its store entry on disk. This inconsistency
causes two known problems:

1. Squid may needlessly swap out the memory hit to disk, either
    overwriting an existing (and identical) disk entry or, worse,
    creating a duplicate entry on another disk. In the second case, the
    two disk entries are not synchronized and may eventually start to
    differ if one of them is removed or updated.

2. Squid may not delete a stale disk entry when needed, violating
    various HTTP MUSTs, and eventually serving stale [disk] cache entries
    to clients.

Another purging problem is not caused by the above inconsistency:

3. A DELETE request or equivalent may come for the entry which is still
    locked for writing. Squid fails to get a lock for such an entry (in
    order to purge it) and the entry remains in disk and/or memory cache.

To solve the first two problems:

* StoreEntry::mayStartSwapout() now avoids needless swapouts by checking
   whether StoreEntry was fully loaded, is being loaded, or could have
   been loaded from disk.

To fix problem #3:

* A new Store::Controller::unlinkByKey() method purges (or marks for
   deletion if purging is impossible) all the matching store entries,
   without loading the StoreEntry information from stores. The lack of
   StoreEntry creation reduces waste of resources (the StoreEntry object
   would have to be deleted anyway) _and_ allows us to mark being-created
   entries (that are locked for writing and, hence, cannot be loaded into
   a StoreEntry object).

Note that even if Squid properly avoids storing duplicate disk entries,
some cache_dir manipulations by humans and Squid crashes may lead to
such duplicates being present.  This patch leaves dealing with potential
duplicates out of scope except it guarantees that if an entry is
deleted, then all [possible] duplicates are deleted as well.

Also added StoreEntry helper methods to prevent direct manipulation of
individual disk-related data members (swap_dirn, swap_filen, and
swap_status). These methods help keep these related data members in a
coherent state and minimize code duplication.

Also tightened rules around several Storage methods: A storage method
must not be given a StoreEntry object unless that object belongs to that
storage.

Also do not mark Transients entry as &quot;waitingToBeFreed&quot; when the entry
is simply closed for writing. This flag is used to mark locked entries
for deletion and should not be used for &quot;completed&quot; transient entries to
avoid confusion.

XXX: SMP cache purges may continue to malfunction when the Transients
table is missing. Currently, Transients are created only when the
collapsed_forwarding is on. After Squid bug 4579 is fixed, every public
StoreEntry will have the corresponding Transients entry and vice versa,
extending these fixes to all SMP environments.

Since this work started long ago and is v4-based, I am attaching the
existing v4 patch for review now and start converting it to v5 version.
I plan to post final v5 version after the review is over.


Thanks,
Eduard.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-175-methods-do-not-invalidate-v4-t13.patch
Type: text/x-patch
Size: 161575 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170601/3c613356/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170601/3c613356/attachment-0001.bin</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009058.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
	<LI>Next message: <A HREF="008790.html">[squid-dev] [PATCH] Fix reopened bug 2833
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8789">[ date ]</a>
              <a href="thread.html#8789">[ thread ]</a>
              <a href="subject.html#8789">[ subject ]</a>
              <a href="author.html#8789">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
