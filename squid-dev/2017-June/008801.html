<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C5b1abb04-37c4-1566-6964-28ab765d18a7%40securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008847.html">
   <LINK REL="Next"  HREF="008803.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C5b1abb04-37c4-1566-6964-28ab765d18a7%40securepoint.de%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">andreas.weigel at securepoint.de
       </A><BR>
    <I>Thu Jun  8 11:49:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008847.html">[squid-dev] [PATCH] transaction_initiator ACL for detecting various unusual transactions
</A></li>
        <LI>Next message: <A HREF="008803.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8801">[ date ]</a>
              <a href="thread.html#8801">[ thread ]</a>
              <a href="subject.html#8801">[ subject ]</a>
              <a href="author.html#8801">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everybody,

Short introduction:

We are a small company using Squid in our Unified Threat Management 
(UTM) series of products. I am working as a Backend developer and have 
tackled some problems with cross-compiling Squid in the past (see the 
unfortunately unanswered bug report at 
<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4650">http://bugs.squid-cache.org/show_bug.cgi?id=4650</A>).

The Problem:

We're using runit (<A HREF="http://smarden.org/runit/">http://smarden.org/runit/</A>) to supervise squid 3.5.21 
in &quot;no_daemon&quot;-mode (-N option).

Being interested in the SMP feature of squid we face the problem that it 
only works in daemon mode, which is inherently incompatible with runit 
supervising the service (would notice the process exiting and start it 
over and over again).

What are the reasons to tie the SMP feature so tightly to the daemon 
mode of squid? I played with the code and was able to alter the behavior 
and allow staying in foreground AND forking children that take the role 
of workers and coordinators etc.. I also managed to make the &quot;master&quot; 
process (the one staying in foreground) to react on a SIGTERM by 
signalling its children to shutdown. See the attached patch against the 
3.5 branch of squid, which is not meant as a real contribution but just 
to show what I did.

I do acknowledge that I do not understand all implications of the 
changes I made, but in general, the program behaves as expected, with 
the slight exception that it runs into an exception if the configuration 
directive &quot;workers 0&quot; is given.

I noticed that in the squid 4 branch, the behavior again has slightly 
changed. What I get from the code in main.cc:watch_child is, that the 
&quot;daemon&quot; process stays alive until all its children terminate if the 
rather strangely named &quot;opt_foreground&quot; option is set. Additionally, the 
&quot;master&quot; process (the one created by the daemon's fork) processes 
signals and broadcasts those to its children.

Isn't it a rather small step from here to just prevent daemonizing and 
let the master process run in &quot;real foreground&quot;? That way, it seems to 
me that runit would not have any problems managing squid with standard 
signals and without changing the behavior of squid?

Am I missing something completely here? Is there some hidden problem 
that would break everything if instead of the &quot;daemon-forking&quot;-process, 
the master process itself would stay in the foreground? Or would it be 
possible?

Kind Regards,

Adnreas Weigel

-- 
Mit freundlichem Gruß / Best regards,

Andreas Weigel
UTM Backend Developer

Securepoint GmbH
Salzstrasse 1
D-21335 Lüneburg

<A HREF="https://www.securepoint.de">https://www.securepoint.de</A>

Tel.: +49(0)413124010
Fax: +49(0)4131240118

Geschäftsführer: Lutz Hausmann, Claudia Hausmann
Amtsgericht Lüneburg HRB 1776
USt.-ID-Nr.: DE 188 528 597

-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid_smp_nodaemon.patch
Type: text/x-patch
Size: 3066 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170608/3f6999d8/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170608/3f6999d8/attachment.bin</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008847.html">[squid-dev] [PATCH] transaction_initiator ACL for detecting various unusual transactions
</A></li>
	<LI>Next message: <A HREF="008803.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8801">[ date ]</a>
              <a href="thread.html#8801">[ thread ]</a>
              <a href="subject.html#8801">[ subject ]</a>
              <a href="author.html#8801">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
