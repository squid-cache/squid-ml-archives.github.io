<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C473086a7-0a7f-803e-afab-ad4a4d41bf21%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008801.html">
   <LINK REL="Next"  HREF="008813.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C473086a7-0a7f-803e-afab-ad4a4d41bf21%40measurement-factory.com%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jun  8 16:04:29 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008801.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008813.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8803">[ date ]</a>
              <a href="thread.html#8803">[ thread ]</a>
              <a href="subject.html#8803">[ subject ]</a>
              <a href="author.html#8803">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/08/2017 05:49 AM, Andreas Weigel wrote:

&gt;<i> Being interested in the SMP feature of squid we face the problem that it
</I>&gt;<i> only works in daemon mode, which is inherently incompatible with runit
</I>&gt;<i> supervising the service (would notice the process exiting and start it
</I>&gt;<i> over and over again).
</I>
Hi Andreas,

    A very thoughtful first post, thank you. FYI: Many of your
background questions can be answered by carefully reading bug 3826
discussion, especially comments #16-18 and comments #40+, but it is
difficult to separate correct information from the discussion noise and
mistakes, so I will try to give short answers here as well.

  <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3826">http://bugs.squid-cache.org/show_bug.cgi?id=3826</A>


&gt;<i> What are the reasons to tie the SMP feature so tightly to the daemon
</I>&gt;<i> mode of squid?
</I>
Before SMP, the daemonized process was the one that started the (only)
kid. When we added SMP, we naturally enhanced the very same code to
start more kids. We did not change -N behavior, did not need to change
it, and possibly did not even think about changing it!

As bug 3826 discussion reveals, the true meaning of -N is rather
illusive. The option is more complex than it often seems because it
affects two technically independent aspects of Squid work: The ability
to restart failing kids and the ability to run in the background. I bet
this complexity was not well understood when -N was first introduced and
the problems snowballed from there.


&gt;<i> I played with the code and was able to alter the behavior
</I>&gt;<i> and allow staying in foreground AND forking children that take the role
</I>&gt;<i> of workers and coordinators etc..
</I>
This is what --foreground should do. AFAICT, its current implementation
is broken. The fork-avoiding changes in the watch_child() part of your
patch might be moving in the right direction towards a fix.


&gt;<i> I do acknowledge that I do not understand all implications of the
</I>&gt;<i> changes I made, but in general, the program behaves as expected, with
</I>&gt;<i> the slight exception that it runs into an exception if the configuration
</I>&gt;<i> directive &quot;workers 0&quot; is given.
</I>
AFAIK, the workers=0 bug exists without your changes (in v5, at least).

Technically, workers=0 should mean -N (see below for a summary).


&gt;<i> I noticed that in the squid 4 branch, the behavior again has slightly
</I>&gt;<i> changed. What I get from the code in main.cc:watch_child is, that the
</I>&gt;<i> &quot;daemon&quot; process stays alive until all its children terminate if the
</I>&gt;<i> rather strangely named &quot;opt_foreground&quot; option is set.
</I>
The --foreground option is named correctly IMO. However, the current
--foreground implementation is wrong. The option should disable non-kid
forking of the master process so that the first Squid process started
remains the master process. AFAICT, that is what your patch correctly
does inside watch_child(), among many other changes that look wrong or
unfinished.


&gt;<i> Isn't it a rather small step from here to just prevent daemonizing and
</I>&gt;<i> let the master process run in &quot;real foreground&quot;? That way, it seems to
</I>&gt;<i> me that runit would not have any problems managing squid with standard
</I>&gt;<i> signals and without changing the behavior of squid?
</I>
If I am right, we do need to change --foreground behavior. Whether that
will break any existing setups, I do not know, but even if it does, it
may be worth doing so for the long-term sanity sake.

The final fix might not require many changes, but getting everything
right in this area usually takes a lot of effort and the differences
between v3.5, v4, and v5 code do not help.


&gt;<i> Am I missing something completely here? Is there some hidden problem
</I>&gt;<i> that would break everything if instead of the &quot;daemon-forking&quot;-process,
</I>&gt;<i> the master process itself would stay in the foreground? Or would it be
</I>&gt;<i> possible?
</I>
AFAICT, the behavior you want is what --foreground should do, and I
supported adding that option, so I do not think there is some
fundamental reason to avoid that behavior. Unfortunately, I did not
review the --foreground patch, so we now might have to break existing
deployments to fix that code :-(.

In summary, the things should work like this IMO:

* -N: The initial process is a master and a worker process.
      No kids.
      No daemonimization.

* --foreground: The initial process is the master process.
      One or more worker kids (depending on workers=N).
      No daemonimization.

* neither: The initial process double-forks the master process.
      One or more worker kids (depending on workers=N).
      Daemonimization.


Would you be willing to fix Squid to match the above summary?


Thank you,

Alex.
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008801.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008813.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8803">[ date ]</a>
              <a href="thread.html#8803">[ thread ]</a>
              <a href="subject.html#8803">[ subject ]</a>
              <a href="author.html#8803">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
