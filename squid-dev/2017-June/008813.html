<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3Cc5ac4f37-1181-7543-1008-0c1a139917ac%40securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008803.html">
   <LINK REL="Next"  HREF="008825.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3Cc5ac4f37-1181-7543-1008-0c1a139917ac%40securepoint.de%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">andreas.weigel at securepoint.de
       </A><BR>
    <I>Fri Jun  9 07:38:30 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008803.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008825.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8813">[ date ]</a>
              <a href="thread.html#8813">[ thread ]</a>
              <a href="subject.html#8813">[ subject ]</a>
              <a href="author.html#8813">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

thanks for the quick reply. I actually had stumbled across the mentioned 
Bug and first thought, &quot;hey, great, exactly my problem&quot;, but then was so 
confused by the initial posts mixing up several issues at once that I 
quit reading (and in addition had some misconceptions about SMP vs. 
Multiple Instances of squid myself).

&gt;<i> AFAICT, that is what your patch correctly
</I>&gt;<i> does inside watch_child(), among many other changes that look wrong or
</I>&gt;<i> unfinished.
</I>Shortly after posting, I noticed some problems with my patch (IamWorker, 
IamMaster returning non-sense and in consequence, serverConnectionsOpen 
not being called with only a single worker). I was able to patch that 
behavior and have both setups running correctly now (both with -N, 
forking children if workers &gt; 1, else staying a single process). The 
overall idea was to make the decision to create and manage kids to 
depend on the number of configured workers/diskers. But I start to think 
that this is not very wise because it prevents adding worker processes 
by just reloading the configuration? Or am I mistaken and it actually is 
possible? If it is, the -N and --foreground options would be somehow 
redundant even after rephrasing.

In summary, the things should work like this IMO:

&gt;<i> * -N: The initial process is a master and a worker process.
</I>&gt;<i>        No kids.
</I>&gt;<i>        No daemonimization.
</I>&gt;<i>
</I>&gt;<i> * --foreground: The initial process is the master process.
</I>&gt;<i>        One or more worker kids (depending on workers=N).
</I>&gt;<i>        No daemonimization.
</I>&gt;<i>
</I>&gt;<i> * neither: The initial process double-forks the master process.
</I>&gt;<i>        One or more worker kids (depending on workers=N).
</I>&gt;<i>        Daemonimization.
</I>&gt;<i>
</I>I think I can agree to that. If my musings above are correct, -N should 
probably also get a notice that it is not possible to add/remove workers 
dynamically. And it should definitely not be termed &quot;no daemon&quot;-mode, as 
that is what --foreground will probably do in the future.

What I get from <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3826#c40">http://bugs.squid-cache.org/show_bug.cgi?id=3826#c40</A> is, 
that the mentioned setup works because systemd broadcasts 
(KillMode=mixed) the signals to all child processes. AFAIK, other 
supervision schemes like runit (which we are using), are capable of that 
and TBH, I think it is a rather hacky workaround.

&gt;<i> Would you be willing to fix Squid to match the above summary?
</I>Yes. I'll try. I fear that it won't be easy to make it correct for all 
setups (e.g., the systemd stuff above). Also, the IamDaemon() function 
should probably be renamed to UseMasterProcess (or similar). The 
historically grown confusing mix of configuration options and command 
line options that partially overlap each other add to the fun. I hope I 
can cope ;-)

Kind Regards,

Andreas

-- 
Mit freundlichem Gruß / Best regards,

Andreas Weigel
UTM Backend Developer

Securepoint GmbH
Salzstrasse 1
D-21335 Lüneburg

<A HREF="https://www.securepoint.de">https://www.securepoint.de</A>

Tel.: +49(0)413124010
Fax: +49(0)4131240118

Geschäftsführer: Lutz Hausmann, Claudia Hausmann
Amtsgericht Lüneburg HRB 1776
USt.-ID-Nr.: DE 188 528 597

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008803.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008825.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8813">[ date ]</a>
              <a href="thread.html#8813">[ thread ]</a>
              <a href="subject.html#8813">[ subject ]</a>
              <a href="author.html#8813">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
