<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C87ec6ca6-5024-412f-877f-b29171080328%40securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008828.html">
   <LINK REL="Next"  HREF="008820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C87ec6ca6-5024-412f-877f-b29171080328%40securepoint.de%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">andreas.weigel at securepoint.de
       </A><BR>
    <I>Fri Jun  9 11:34:53 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008828.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008820.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8819">[ date ]</a>
              <a href="thread.html#8819">[ thread ]</a>
              <a href="subject.html#8819">[ subject ]</a>
              <a href="author.html#8819">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again,

just checked the --foreground option from the squid4 branch. Two things 
noticed:

- strg+c kills the main process that is waiting for its daemon to 
finish, but not the daemon (*ugh*)

     --&gt; this is basically the unexpected --foreground behavior we 
already discussed and which should be fixed

- a SIGTERM  to the master process makes it wait for its children to 
shutdown for 30 seconds
     --&gt; Is that desired behavior? I thought SIGTERM to be the more 
urgent or least equally urgent shutdown signal compared to SIGINT, which 
currently immediately triggers a shutdown. This would be easy to change 
in mainc.cc:shut_down but I guess that probably a lot of people would be 
upset. I do not know about other service supervisors, but runit uses a 
SIGTERM when shutting down or restarting a service, and, egoist I am, 
that's what I currently have to keep in mind (and waiting 30 seconds for 
an &quot;sv restart&quot;, which sends a SIGTERM, is not so great)  ;-)  --- 
However, restarting can also be implemented manually, so that's not a 
major thing.

Apart from that, I'm actually quite happy with how easy it was (seemed 
to be) to make the desired changes to the squid4 branch (see attached 
patch):

workers 2
in squid.conf; output of ps fxao user,pid,ppid,pgid,sid,args | grep 
'squid.*-s$'


squid -s -N
stays in foreground
nobody   25756 20577 25756  2101          |       |   |           \_ 
./squid -N -s

squid -s
daemonized
root     25668  1700 25668 25668          \_ ./squid -s
nobody   25670 25668 25668 25668          |   \_ (squid-coord-3) -s
nobody   25671 25668 25668 25668          |   \_ (squid-2) -s
nobody   25672 25668 25668 25668          |   \_ (squid-1) -s


squid --foreground -s
not daemonized (stays in foreground)
root     25723 20577 25723  2101          |       |   |           \_ 
./squid --foreground -s
nobody   25725 25723 25723  2101          |       | |               \_ 
(squid-coord-3) --foreground -s
nobody   25726 25723 25723  2101          |       | |               \_ 
(squid-2) --foreground -s
nobody   25727 25723 25723  2101          |       | |               \_ 
(squid-1) --foreground -s

The PID-file in all cases refers to the master process, no matter if 
that means the master/worker combined (-N), the foreground master or the 
daemonized master. That makes me hope that existing setups relying on 
the PID-file (as in 
<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3826#c40">http://bugs.squid-cache.org/show_bug.cgi?id=3826#c40</A>) should still be 
working.

I would greatly appreciate feedback to the proposed patch. I am also in 
the process of checking what has to be done for squid 5 and/or squid 3.5 
to get the behavior, although I think applying something similar to 3.5 
will require quite some backporting effort.

Kind Regards,
Andreas

-- 
Mit freundlichem Gruß / Best regards,

Andreas Weigel
UTM Backend Developer

Securepoint GmbH
Salzstrasse 1
D-21335 Lüneburg

<A HREF="https://www.securepoint.de">https://www.securepoint.de</A>

Tel.: +49(0)413124010
Fax: +49(0)4131240118

Geschäftsführer: Lutz Hausmann, Claudia Hausmann
Amtsgericht Lüneburg HRB 1776
USt.-ID-Nr.: DE 188 528 597

-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid4_fix_startup_foreground.patch
Type: text/x-patch
Size: 10390 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170609/a5b04f95/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170609/a5b04f95/attachment.bin</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008828.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008820.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8819">[ date ]</a>
              <a href="thread.html#8819">[ thread ]</a>
              <a href="subject.html#8819">[ subject ]</a>
              <a href="author.html#8819">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
