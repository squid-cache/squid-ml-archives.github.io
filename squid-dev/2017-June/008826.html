<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C481e2f68-0aad-5f41-6c32-f1610de60254%40securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008825.html">
   <LINK REL="Next"  HREF="008828.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C481e2f68-0aad-5f41-6c32-f1610de60254%40securepoint.de%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">andreas.weigel at securepoint.de
       </A><BR>
    <I>Fri Jun  9 15:21:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008825.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008828.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8826">[ date ]</a>
              <a href="thread.html#8826">[ thread ]</a>
              <a href="subject.html#8826">[ subject ]</a>
              <a href="author.html#8826">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again,

&gt;<i> It feels like you may be drifting into a dangerous territory of
</I>&gt;<i> fixing/changing &quot;everything&quot; related to SMP.
</I>
I have to admit that I have a tendency to do so; however, I really tried 
hard to focus on the --foreground option with my new patch against 
squidv4 and trunk 
(<A HREF="https://code.launchpad.net/~andwei/squid/fix_option_foreground/+merge/325395">https://code.launchpad.net/~andwei/squid/fix_option_foreground/+merge/325395</A>).

&gt;<i> You may be right, but I would _not_ change that terminology now because
</I>&gt;<i> all the renaming will obfuscate your true fix and make it more difficult
</I>&gt;<i> to understand/review. It may also preclude v3.5 acceptance.
</I>
I have to disagree to that one. The last few days I tried to understand 
how to use the SMP feature and at the same time to not daemonize squid. 
After much reading and confusion I arrived at &quot;ok, not possible&quot; without 
hacking around the daemonizing or changing squid code.

Looking at the Code for 3.5 I was very confused by the combination of 
Config.workers and opt_no_daemon. The names of options and functions did 
their best to add to the confusion. I think we agreed that due to 
historical reasons, the -N option is doing something different now 
(v4/trunk) from what its description is implying. My (v4/trunk) patch 
therefore changes the names of this option and the function to retrieve 
its value to be more clear, as well as the description of the feature. I 
do think that my changes are all related to the same thing, namely 
allowing a &quot;no daemon&quot; mode with --foreground while retaining the old -N 
functionality, but calling the latter by a more apt name.

&gt;<i> You may be right, but I would _not_ change that terminology now because
</I>&gt;<i> all the renaming will obfuscate your true fix and make it more difficult
</I>&gt;<i> to understand/review. It may also preclude v3.5 acceptance
</I>
See above. I do not expect my patch to be applicable to v3.5. Too many 
changes there plus the --foreground option is not even available here. 
I'll try to make it work for us and locally apply a patch until moving 
to v4.

&gt;<i> When daemonized, Squid master process does not support reconfiguration
</I>&gt;<i> at all. There are plans to change that, but those difficult changes are
</I>&gt;<i> completely outside your project scope.
</I>
My impression was that the current v4/trunk branches do already allow 
exactly that: sending a SIGHUP to the master process made all children 
reconfigure themselves (wrong?) -- I didn't change anything there.

&gt;&gt;<i> What I get from <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3826#c40">http://bugs.squid-cache.org/show_bug.cgi?id=3826#c40</A> is,
</I>&gt;&gt;<i> that the mentioned setup works because systemd broadcasts
</I>&gt;&gt;<i> (KillMode=mixed) the signals to all child processes.
</I>&gt;<i>  From design point of view, Squid should not rely on 3rd party
</I>&gt;<i> applications sending signals to kids. If such broadcast works today in
</I>&gt;<i> some environment, great, but this is not a part of Squid interface. As
</I>&gt;<i> far as signaling is concerned, Squid interface is the PID file.
</I>I think we agree here. I just gave the example to illustrate how it 
should *not* be working.

With the --foreground option working as expected, however, a supervising 
process may send signals to its initial child process, which currently 
(v4/trunk) will always be the squid master. Thereby, the PID file (and 
all possible race conditions associated with it) are not even necessary. 
While this does not seem to be the intended interface, it IMHO is an 
improvement to determining the process ID by reading some PID file and 
works great for supervision schemes that do not like daemons.

Thanks again very much for the quick reactions and the fruitful discussions.

Kind Regards,
Andreas

PS: I do understand your reluctance to change function/variable names 
and/or description of command line options. I still think it is better 
to have those updated, even if it may slightly obfuscate the actual 
behavioral change. I also believe in the broken window theorem and try 
to at least fix some of those from time to time. As noted before, I once 
tackled a cross-compilation issue with squid and encountered diverse 
variables/macros referring to the same concept but used differently 
throughout the code (Squid_MaxFd, SQUID_MAXFD), eventually caused a 
dangerous segfault (see bugs.squid-cache.org/show_bug.cgi?id=4650 if you 
are interested -- the patch I proposed there also tried to fix the issue 
by introducing various renames, which is probably the reason that no one 
ever cared to look at it ;-/ )

-- 
Mit freundlichem Gruß / Best regards,

Andreas Weigel
UTM Backend Developer

Securepoint GmbH
Salzstrasse 1
D-21335 Lüneburg

<A HREF="https://www.securepoint.de">https://www.securepoint.de</A>

Tel.: +49(0)413124010
Fax: +49(0)4131240118

Geschäftsführer: Lutz Hausmann, Claudia Hausmann
Amtsgericht Lüneburg HRB 1776
USt.-ID-Nr.: DE 188 528 597

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008825.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008828.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8826">[ date ]</a>
              <a href="thread.html#8826">[ thread ]</a>
              <a href="subject.html#8826">[ subject ]</a>
              <a href="author.html#8826">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
