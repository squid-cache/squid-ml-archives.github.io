<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C246585ef-b445-000e-99d5-5b4d784ac275%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008824.html">
   <LINK REL="Next"  HREF="008988.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C246585ef-b445-000e-99d5-5b4d784ac275%40measurement-factory.com%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun  9 15:43:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008824.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008988.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8827">[ date ]</a>
              <a href="thread.html#8827">[ thread ]</a>
              <a href="subject.html#8827">[ subject ]</a>
              <a href="author.html#8827">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/09/2017 05:34 AM, Andreas Weigel wrote:

&gt;<i> - a SIGTERM  to the master process makes it wait for its children to
</I>&gt;<i> shutdown for 30 seconds
</I>&gt;<i>     --&gt; Is that desired behavior?
</I>
The question is out of scope, but the answer is &quot;yes&quot;. See
shutdown_lifetime in squid.conf.documented.


&gt;<i> I would greatly appreciate feedback to the proposed patch.
</I>
Your --foreground fix itself (~10 lines) looks good to me, thank you!
The rest is problematic. Details below.


Please undo the following two changes and all their side effects:

&gt;<i> -bool InDaemonMode(); // try using specific Iam*() checks above first
</I>&gt;<i> +bool UsingDedicatedMaster(); // try using specific Iam*() checks above first
</I>
&gt;<i> -extern int opt_no_daemon; /* 0 */
</I>&gt;<i> +extern int opt_use_single_process; /* 0 */
</I>
These renames obscure functionality changes, make v3.5 acceptance less
appealing, and I disagree with the new names and some of the new
descriptions. I agree that things can be and perhaps should be renamed,
but it would be better to do that separately (in v5?).


&gt;<i> -            &quot;       -N        No daemon mode.\n&quot;
</I>&gt;<i> +            &quot;       -N        Use a single process (combining master/worker) running in &quot;
</I>&gt;<i> +            &quot;                 foreground; incompatible with --foreground.\n&quot;
</I>&gt;<i>              &quot;       --foreground\n&quot;
</I>&gt;<i> -            &quot;                 Parent process does not exit until its children have finished.\n&quot;
</I>&gt;<i> +            &quot;                 \&quot;No daemon\&quot; mode: master process stays in foreground.\n&quot;
</I>
Unlike the changes discussed earlier, these changes are (barely) in
scope because we may want to clarify what --foreground means since its
initial implementation was broken, potentially because the developer did
not know what --foreground should mean.

The &quot;single process&quot; terminology is misleading because Squid may start
lots of processes (helpers) even with -N. The &quot;stays&quot; terminology is
inaccurate because a given process cannot go into background itself.

I suggest the following (without proper formatting):

-N: Master process runs in foreground and is a worker. No kids.
--foreground: Master process runs in foreground and creates worker kids.

&gt;<i>From the admin perspective, the only difference between -N and
</I>--foreground is kids creation/maintenance. My version emphasizes that
difference rather than obscuring it.

If we end up removing -N someday, the above --foreground description
will change to &quot;No daemon: Master process runs in foreground&quot;.

Please note that --help is not the manual page (yet?) but a quick
reminder/summary. We should document details in --help. Things like
options incompatibility do not really belong to --help, especially since
Squid quickly detects and explains the conflict if both options are used.


&gt;<i> +&lt;p&gt;The squid binary now has a new &lt;em&gt;--foreground&lt;/em&gt; command line option,
</I>&gt;<i> +   which prevents the process from daemonizing, i.e., launches only one process,
</I>&gt;<i> +   which will become the master process. Unlike the old &lt;em&gt;-N&lt;/em&gt; option,
</I>
I suggest (without proper formatting):

&lt;p&gt;The squid binary has a new &lt;em&gt;--foreground&lt;/em&gt; command line option
which (only) prevents daemonizing the master process. Unlike the old
&lt;em&gt;-N&lt;/em&gt; option,



&gt;<i>  IamWorkerProcess()
</I>&gt;<i>  {
</I>&gt;<i>      // when there is only one process, it has to be the worker
</I>&gt;<i> -    if (opt_no_daemon || Config.workers == 0)
</I>&gt;<i> +    if (opt_use_single_process)
</I>&gt;<i>          return true;
</I>&gt;<i>  
</I>&gt;<i>      return TheProcessKind == pkWorker;
</I>
Why did you remove the (Config.workers == 0) part? What breaks if you
keep it? Is fixing that in scope?


&gt;<i>  bool
</I>&gt;<i> -InDaemonMode()
</I>&gt;<i> +UsingDedicatedMaster()
</I>&gt;<i>  {
</I>&gt;<i> -    return !opt_no_daemon &amp;&amp; Config.workers &gt; 0;
</I>&gt;<i> +    return !opt_use_single_process;
</I>&gt;<i>  }
</I>
Why did you remove the (Config.workers &gt; 0) part? What breaks if you
keep it? Is fixing that in scope?

There may be bugs in the above code, but if they are not related to
fixing --foreground then we should not fix them here...


&gt;<i> +        if ((pid = fork()) &lt; 0) {
</I>&gt;<i> +            int xerrno = errno;
</I>&gt;<i> +            syslog(LOG_ALERT, &quot;fork failed: %s&quot;, xstrerr(xerrno));
</I>&gt;<i> +        } else if (pid &gt; 0) {
</I>&gt;<i> +            // finished daemonizing
</I>&gt;<i> +            exit(0);
</I>&gt;<i> +        }
</I>&gt;<i> +
</I>&gt;<i> +        // makes only sense after daemonizing
</I>&gt;<i> +        if (setsid() &lt; 0) {
</I>&gt;<i> +            int xerrno = errno;
</I>&gt;<i> +            syslog(LOG_ALERT, &quot;setsid failed: %s&quot;, xstrerr(xerrno));
</I>&gt;<i> +        }
</I>
Please restore the &quot;parent&quot; comment and add &quot;daemonized child&quot; comment
to improve code readability. I would also clarify what happens when
fork() fails.

Please note that your &quot;makes only sense after daemonizing&quot; comment kind
of contradicts the code because setsid() is also called when fork() fails.

Here is a polished version, taking the above comments into account:

    if ((pid = fork()) &lt; 0) {
        const int xerrno = errno;
        syslog(LOG_ALERT, &quot;fork failed: %s&quot;, xstrerr(xerrno));
        // continue anyway, mimicking --foreground mode (XXX?)
    } else if (pid &gt; 0) {
        // parent
        exit(0); // successfully daemonized; TODO: Use EXIT_SUCCESS
    } else {
        // daemonized child (now the master process)
        // create a new session with the master process as the leader
        if (setsid() &lt; 0) {
            const int xerrno = errno;
            syslog(LOG_ALERT, &quot;setsid failed: %s&quot;, xstrerr(xerrno));
        }
    }

I recommend moving the above code into a dedicated GoIntoBackground()
static void function:

    if (!opt_foreground)
        GoIntoBackground();


&gt;<i> +        // makes only sense after daemonizing
</I>&gt;<i> +        if (setsid() &lt; 0) {
</I>
Does setsid() have any effect if called in --foreground mode? I suspect
it does. In other words, I suspect that it is possible to detect
setsid() call presence in some environments where --foreground is used.
Please note that I am not asking whether those effects are
useful/good/etc.. I am only asking whether they exist.

If you are not sure that setsid() has no effect in --foreground, then
please do not change this aspect; move the setsid() call outside the
opt_foreground check. Add a TODO comment if this needs further
investigation/work.


Thank you,

Alex.
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008824.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008988.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8827">[ date ]</a>
              <a href="thread.html#8827">[ thread ]</a>
              <a href="subject.html#8827">[ subject ]</a>
              <a href="author.html#8827">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
