<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C95cb5a0c-eca3-fdcd-c631-b0be68d158b2%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008826.html">
   <LINK REL="Next"  HREF="008819.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C95cb5a0c-eca3-fdcd-c631-b0be68d158b2%40measurement-factory.com%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun  9 16:39:55 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008826.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008819.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8828">[ date ]</a>
              <a href="thread.html#8828">[ thread ]</a>
              <a href="subject.html#8828">[ subject ]</a>
              <a href="author.html#8828">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/09/2017 09:21 AM, Andreas Weigel wrote:
&gt;<i> Alex Rousskov wrote:
</I>
&gt;&gt;<i> I would _not_ change that terminology now because
</I>&gt;&gt;<i> all the renaming will obfuscate your true fix and make it more difficult
</I>&gt;&gt;<i> to understand/review.
</I>
&gt;<i> I have to disagree to that one.
</I>
Renaming obfuscated your true fix. It is a fact. It is not an opinion
that we can agree or disagree with.


&gt;<i> Looking at the Code for 3.5 I was very confused by the combination of
</I>&gt;<i> Config.workers and opt_no_daemon. The names of options and functions did
</I>&gt;<i> their best to add to the confusion. 
</I>
I agree that a lot of things can be fixed and improved. Just do not do
those fixes and improvements in the tiny patch fixing --foreground. Do
it separately, after the --foreground code is fixed. This is _not_ one
of those cases where fixing something is impossible without
rewriting/renaming a lot of related code.

Moreover, if rewriting/renaming a lot of related code was necessary for
you to arrive at the correct fix, it still does not imply that you
cannot separate the two after the fact. Yes, that separation can be
viewed as &quot;overhead&quot;, but that &quot;overhead&quot; may be necessary to move
things along in a collaborative project. Convincing others that your
changes are desirable is an (expensive) part of the Squid game. FWIW, I
often spend more resources convincing others that a patch should be
committed then on actually making that patch!


&gt;<i> I think we agreed that due to
</I>&gt;<i> historical reasons, the -N option is doing something different now
</I>&gt;<i> (v4/trunk) from what its description is implying. My (v4/trunk) patch
</I>&gt;<i> therefore changes the names of this option and the function to retrieve
</I>&gt;<i> its value to be more clear, as well as the description of the feature.
</I>
What is more clear for you may look wrong to others. This is a separate
issue/problem. It should be solved in a separate patch (which I, FWIW,
would welcome and promise to review).


&gt;<i> I do think that my changes are all related to the same thing, namely 
</I>&gt;<i> allowing a &quot;no daemon&quot; mode with --foreground while retaining the old
</I>&gt;<i> -N functionality, but calling the latter by a more apt name.
</I>
They are related but they hurt understanding of the core fix and they
can be done separately. Thus, they should be done separately. See my
patch review for details.


&gt;<i> I do not expect my patch to be applicable to v3.5. Too many
</I>&gt;<i> changes there plus the --foreground option is not even available here.
</I>
Ah, I thought it was. Thank you for correcting my understanding. There
is no need to change v3.5 then!

This change does not affect the core of my &quot;divide and conquer&quot; arguments.


&gt;&gt;<i> When daemonized, Squid master process does not support reconfiguration
</I>&gt;&gt;<i> at all. There are plans to change that, but those difficult changes are
</I>&gt;&gt;<i> completely outside your project scope.
</I>
&gt;<i> My impression was that the current v4/trunk branches do already allow
</I>&gt;<i> exactly that
</I>
They do not. You are confusing worker reconfiguration with master
reconfiguration. Kid/worker reconfiguration is supported. Master
reconfiguration is not supported (unless that master is also a worker).

IIRC, the context of this part of the discussion is whether one can
reconfigure the number of kids. One cannot. You did not change that, and
you do not need to worry about that.


&gt;<i> With the --foreground option working as expected, however, a supervising
</I>&gt;<i> process may send signals to its initial child process, which currently
</I>&gt;<i> (v4/trunk) will always be the squid master. Thereby, the PID file (and
</I>&gt;<i> all possible race conditions associated with it) are not even necessary.
</I>
This is a common misunderstanding. The PID file is necessary for many
things beyond supervisor's signaling needs. For example, it is
impossible to reliably start an SMP Squid instance without a PID file.


&gt;<i> While this does not seem to be the intended interface, it IMHO is an
</I>&gt;<i> improvement to determining the process ID by reading some PID file and
</I>&gt;<i> works great for supervision schemes that do not like daemons.
</I>
If you know the master PID and just need to send it some signal, then
you do not need a PID file. In many other use cases, you (and Squid
itself) do need that file. (OT: The right signal to do X is not a part
of Squid's interface, so a supervisor sending raw signals to Squid is
using private Squid details that may change. The public interface is
&quot;squid -k X&quot;. That -k interface has its own problems, but those problems
do not change the fact that -k is the official signaling interface.)


&gt;<i> PS: I do understand your reluctance to change function/variable names
</I>&gt;<i> and/or description of command line options. I still think it is better
</I>&gt;<i> to have those updated,
</I>
Agreed. We disagree _where_ that update should happen, not whether it
should happen.


&gt;<i> even if it may slightly obfuscate the actual
</I>&gt;<i> behavioral change. I also believe in the broken window theorem and try
</I>&gt;<i> to at least fix some of those from time to time.
</I>
Your patch was replacing broken windows during a shootout with a
murderer. Not a good strategy, even if you believe in the broken window
theory!


&gt;<i> I once [...] encountered diverse
</I>&gt;<i> variables/macros referring to the same concept but used differently
</I>&gt;<i> throughout the code (Squid_MaxFd, SQUID_MAXFD), eventually caused a
</I>&gt;<i> dangerous segfault (see bugs.squid-cache.org/show_bug.cgi?id=4650 if you
</I>&gt;<i> are interested -- the patch I proposed there also tried to fix the issue
</I>&gt;<i> by introducing various renames, which is probably the reason that no one
</I>&gt;<i> ever cared to look at it ;-/ )
</I>
FYI: IIRC, I did look at that patch but could not comment because the
patch scope was defined as &quot;the changes I proposed [in a large comment
discussing various problems]&quot; and the patch itself appeared to contain a
mix of renames and bug fixes. It would take me a long time to understand
the issue and to separate the core changes from the renames. I do not
have that time, unfortunately.

The lack of progress on that bug does not mean that your changes were
wrong or ignored! It means that you need to do more than to improve
code. You need to convince others that your improvements should be
committed. That takes more than writing code. The associated overheads
are unfortunate, but there is no other way that works here AFAIK.


Thank you,

Alex.
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008826.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008819.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8828">[ date ]</a>
              <a href="thread.html#8828">[ thread ]</a>
              <a href="subject.html#8828">[ subject ]</a>
              <a href="author.html#8828">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
