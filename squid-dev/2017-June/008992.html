<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C6b6995bc-519f-9ab0-1cba-87a733229f7e%40securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008991.html">
   <LINK REL="Next"  HREF="008993.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C6b6995bc-519f-9ab0-1cba-87a733229f7e%40securepoint.de%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">andreas.weigel at securepoint.de
       </A><BR>
    <I>Fri Jun 16 12:14:14 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008991.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="008993.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8992">[ date ]</a>
              <a href="thread.html#8992">[ thread ]</a>
              <a href="subject.html#8992">[ subject ]</a>
              <a href="author.html#8992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

&gt;<i> It is explicitly adding a regression in a very necessary behaviour for 
</I>&gt;<i> startup sequences running what is effectively &quot;squid --foreground -z 
</I>&gt;<i> &amp;&amp; squid&quot;. We will regress to the state of having race conditions as 
</I>&gt;<i> multiple independent sets of workers are spawned and collide with each 
</I>&gt;<i> others /dev/shm and whether or not the disk cache is formatted before 
</I>&gt;<i> Squid starts accepting client connections. 
</I>
Correct me if I am wrong, but the current --foreground option makes the 
&quot;main process&quot; waits for the termination of it's only child (not its 
grand children), which is the daemonized master process (main.cc:1789; 
WaitForAnyPid finally calls waitpid(-1, &amp;status, 0) or wait3(&amp;status, 0, 
NULL), which is equivalent).

With the patch, instead of spawning a daemon and waiting for it to 
finish, we just run the master process and wait for it to finish. In 
both cases, the master process is responsible for making sure that it 
only exits after the last child has exited. If this would not be the 
case, the WaitForAnyPid() call in the unpatched version would do nothing 
to prevent the master process exiting while its children are still 
running. I do not see the regression here, but probably I am missing 
something. I would even argue that the situation has improved, because 
before it was at least possible, albeit improbable, that the 
&quot;master-forking&quot; process is terminated by some signal while its master 
child (and its worker grand chidren) were still running.

&gt;<i> The original notes wording (and --foreground design) was intended to 
</I>&gt;<i> be clear that in that made a Squid SMP-enabled instance operate as a 
</I>&gt;<i> consistent / atomic whole. **No background parts still operating after 
</I>&gt;<i> the main process exit()'s**. 
</I>I am convinced this is still the case with --foreground in an even more 
accurate way, see above.

&gt;<i> Also, there are (or will be) installations containing &quot;squid 
</I>&gt;<i> --foreground -N &quot; due to the way some OS provide default options 
</I>&gt;<i> (using the new --foreground by default) and allow admin to extend them 
</I>&gt;<i> in a separate config file (usually with -N hacks from legacy installs). 
</I>&gt;<i>  - the updated documentation implies that --foreground actively 
</I>&gt;<i> creates workers. Which will leave anyone with that config confused 
</I>&gt;<i> about what happens if they are both required (--foreground &quot;and 
</I>&gt;<i> creates worker kids&quot;) and prohibited (-N). Yet Squid runs with nary a 
</I>&gt;<i> message about problems.
</I>The behavior has not changed in that regard, only the wording. The two 
options are incompatible and have been so before the patch. There is a 
DBG_CRITICAL message stating that --foreground has no effect with -N. I 
introduced a hint that -N is incompatible with --foreground in usage(), 
but was convinced by Alex that it is probably better to explain those in 
the documentation and not with the -h option. We can still discuss if a 
better description can be found.

Kind Regards,
Andreas

-- 
Mit freundlichem Gruß / Best regards,

Andreas Weigel
UTM Backend Developer

Securepoint GmbH
Salzstrasse 1
D-21335 Lüneburg

<A HREF="https://www.securepoint.de">https://www.securepoint.de</A>

Tel.: +49(0)413124010
Fax: +49(0)4131240118

Geschäftsführer: Lutz Hausmann, Claudia Hausmann
Amtsgericht Lüneburg HRB 1776
USt.-ID-Nr.: DE 188 528 597

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008991.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="008993.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8992">[ date ]</a>
              <a href="thread.html#8992">[ thread ]</a>
              <a href="subject.html#8992">[ subject ]</a>
              <a href="author.html#8992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
