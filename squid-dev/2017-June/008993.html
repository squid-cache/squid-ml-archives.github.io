<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] SMP scaling in no_daemon mode?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C02c9cab0-8a37-99e0-67ad-ad9584688a52%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008992.html">
   <LINK REL="Next"  HREF="009001.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] SMP scaling in no_daemon mode?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20SMP%20scaling%20in%20no_daemon%20mode%3F&In-Reply-To=%3C02c9cab0-8a37-99e0-67ad-ad9584688a52%40measurement-factory.com%3E"
       TITLE="[squid-dev] SMP scaling in no_daemon mode?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun 16 14:20:51 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008992.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
        <LI>Next message: <A HREF="009001.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8993">[ date ]</a>
              <a href="thread.html#8993">[ thread ]</a>
              <a href="subject.html#8993">[ subject ]</a>
              <a href="author.html#8993">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/16/2017 05:11 AM, Amos Jeffries wrote:

&gt;<i> However, the content of that change is enough for me to -1 veto this patch.
</I>
I am afraid you misunderstood what the change does.


&gt;<i> It is explicitly adding a regression in a very necessary behaviour for
</I>&gt;<i> startup sequences running what is effectively &quot;squid --foreground -z &amp;&amp;
</I>&gt;<i> squid&quot;.
</I>
AFAICT, &quot;squid --foreground -z &amp;&amp; squid&quot; (or equivalent) works the same
in patched and unpatched Squid as far as waiting for -z to end is
concerned. Both patched and unpatched --foreground Squids wait for the
child processes to finish:

Unpatched --foreground Squid:
* the initial process starts and waits for the master process
* the master process starts and waits for the kids

Patched --foreground Squid:
* the initial process _is_ the master process
* the master process starts and waits for the kids


&gt;<i> We will regress to the state of having race conditions as
</I>&gt;<i> multiple independent sets of workers are spawned and collide with each
</I>&gt;<i> others /dev/shm and whether or not the disk cache is formatted before
</I>&gt;<i> Squid starts accepting client connections.
</I>
Patched Squid has the same protection from startup race conditions as
the unpatched Squid. That protection comes from the PID file management
code, and the patch does not change that code.


&gt;<i> The original notes wording (and --foreground design) was intended to be
</I>&gt;<i> clear that in that made a Squid SMP-enabled instance operate as a
</I>&gt;<i> consistent / atomic whole. **No background parts still operating after
</I>&gt;<i> the main process exit()'s**.
</I>
That is still the case. AFAICT, the original --foreground design was
correct. The proposed patch fixes its implementation. It does not change
the design.


&gt;<i> Also, there are (or will be) installations containing &quot;squid
</I>&gt;<i> --foreground -N &quot;
</I>
The patch does not change the effects of that combination AFAICT and,
hence, should not be responsible for those effects except for the
documentation changes.


&gt;<i>  - the updated documentation implies that --foreground actively creates
</I>&gt;<i> workers. Which will leave anyone with that config confused about what
</I>&gt;<i> happens if they are both required (--foreground &quot;and creates worker
</I>&gt;<i> kids&quot;) and prohibited (-N).
</I>
Squid tells exactly what happens in that malformed configuration case:

  WARNING: --foreground command-line option has no effect with -N.

If this part of your complaint is about patched documentation, then
please suggest a better wording (without turning --help or release notes
into a user manual!). I actually like the conflict between -N and
--foreground behavior described by --help. That conflict highlights the
fact that the two options are not compatible and should not be used
together!

Unpatched descriptions:

* -N is accurate but requires terminology lookup
* --foreground is vague to the point of being useless
* the combination is conflicting if one knows what &quot;daemon mode&quot; is

Patched descriptions:

* -N is accurate but requires terminology lookup
* --foreground is accurate but requires terminology lookup
* the combination is conflicting even without terminology knowledge


&gt;<i> Yet Squid runs with nary a message about problems.
</I>
IMHO, Squid should quit with an ERROR instead of running with a WARNING,
but the patch does not change that behavior so we should not discuss it
here.


I hope my explanation of what the patch does will allow you to change
your vote.


Thank you,

Alex.



&gt;&gt;<i> On 15.06.2017 17:35, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 06/15/2017 04:57 AM, Andreas Weigel wrote:
</I>&gt;&gt;&gt;&gt;<i>  From discussion on squid-dev, the following behavior is implemented by
</I>&gt;&gt;&gt;&gt;<i> this patch:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * -N: The initial process is a master and a worker process.
</I>&gt;&gt;&gt;&gt;<i>    No kids.
</I>&gt;&gt;&gt;&gt;<i>    No daemonimization.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * --foreground: The initial process is the master process.
</I>&gt;&gt;&gt;&gt;<i>    One or more worker kids (depending on workers=N).
</I>&gt;&gt;&gt;&gt;<i>    No daemonimization.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * neither: The initial process double-forks the master process.
</I>&gt;&gt;&gt;&gt;<i>    One or more worker kids (depending on workers=N).
</I>&gt;&gt;&gt;&gt;<i>    Daemonimization.
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008992.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
	<LI>Next message: <A HREF="009001.html">[squid-dev] SMP scaling in no_daemon mode?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8993">[ date ]</a>
              <a href="thread.html#8993">[ thread ]</a>
              <a href="subject.html#8993">[ subject ]</a>
              <a href="author.html#8993">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
