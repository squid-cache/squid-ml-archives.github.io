<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] helper process library
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20helper%20process%20library&In-Reply-To=%3C8dc89305-673c-52b7-9ad4-d05e077795ef%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009002.html">
   <LINK REL="Next"  HREF="009005.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] helper process library</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20helper%20process%20library&In-Reply-To=%3C8dc89305-673c-52b7-9ad4-d05e077795ef%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] helper process library">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jun 18 23:54:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009002.html">[squid-dev] [PATCH] helper process library
</A></li>
        <LI>Next message: <A HREF="009005.html">[squid-dev] Build failed in Jenkins: template-full-matrix » clang,d-debian-unstable #387
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9003">[ date ]</a>
              <a href="thread.html#9003">[ thread ]</a>
              <a href="subject.html#9003">[ subject ]</a>
              <a href="author.html#9003">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/18/2017 12:08 PM, Amos Jeffries wrote:
&gt;<i> Implement a library for C++ helpers to link against which provides
</I>&gt;<i> a main() function to achieve generic startup/query/shutdown debug
</I>&gt;<i> information and and a simpler API for processing a query line.
</I>
Executive summary: I believe the proposed library interface is harmful
on several levels and must be redesigned. The fix is easy though.

Specific problems are discussed below, followed by the fix suggestion.

I doubt we should add a library that defines main(). There is nearly no
real advantage in doing so, and it introduces a significant surprise
factor for developers that expect every program to define its main(). It
also adds a serious hurdle for any library-using code that needs to
customize its &quot;main&quot; operation. If you want to encapsulate the main()
logic, you may provide Main() or equivalent, but there is a better way
to accomplish what you want as detailed further below.

I do not think we should add a library that declares functions that it
does not define. For example, HelperProcess::Start() and
HelperProcess::Options() are declared in libhelper_process but are then
defined in various helpers. This introduces a big surprise for
developers (and development tools!). AFAICT, this is nothing but a hack
to make it possible to define main() in the library, which is the wrong
goal on its own, as discussed above.

It feels like you are trying hard to avoid defining a proper
Helper::Instance or Helper::Application class that declares the common
interface and implements the bits that it can. That would be the right
strategy to avoid code duplication without any hacks, surprises,
compatibility issues, and extensibility problems.

BTW, with the class-based approach, the main() function in each helper
can be reduced to a single line:

int
main(int argc, char *argv[])
{
    return MyInstance().run(argc, argv);
}


&gt;<i> + * Copyright (c) 2017, Treehouse Networks Ltd. New Zealand
</I>
Please move that copyright statement into CREDITS, like we try to do
with nearly all other custom copyright statements. The usual reasoning
applies, plus there is hardly anything to copyright in those files!


&gt;<i> === added file 'src/helper/Process.h'
</I>
&gt;<i> +namespace HelperProcess {
</I>
I suggest s/Process/Program/ or s/Process/Instance/ because the general
code you are adding exists for the helper as a whole while a helper
instance using your code may create other helper processes (that will
not use the Start/Options/DoOneRequest API). Your call.


&gt;<i> +    while (getline(std::cin,buf)) { // will return false at EOF
</I>&gt;<i> +        ndebug(HelperProcess::Name &lt;&lt; &quot;| Got &quot; &lt;&lt; buf.length() &lt;&lt; &quot; bytes '&quot; &lt;&lt; buf &lt;&lt; &quot;' from Squid&quot;);
</I>&gt;<i> +        HelperProcess::DoOneRequest(buf);
</I>&gt;<i> +    }
</I>
This implementation assumes that each helper requests contains a single
line. That assumption is not general. Some helpers (e.g., the
certificate generator helper) use multiline requests. You can avoid or
even solve this problem if the above loop becomes a Helper::App method
calling a virtual getRequestBuffer() function (with a default getline()
implementation).


If you make another patch revision, please post an --ignore-all-spaces
diff or equivalent to highlight the important changes.


Thank you,

Alex.
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009002.html">[squid-dev] [PATCH] helper process library
</A></li>
	<LI>Next message: <A HREF="009005.html">[squid-dev] Build failed in Jenkins: template-full-matrix » clang,d-debian-unstable #387
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9003">[ date ]</a>
              <a href="thread.html#9003">[ thread ]</a>
              <a href="subject.html#9003">[ subject ]</a>
              <a href="author.html#9003">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
