<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3C46975b80-ab97-b035-cdcf-cf07e8f04fec%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009016.html">
   <LINK REL="Next"  HREF="009018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3C46975b80-ab97-b035-cdcf-cf07e8f04fec%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jun 21 14:24:50 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009016.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
        <LI>Next message: <A HREF="009018.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9017">[ date ]</a>
              <a href="thread.html#9017">[ thread ]</a>
              <a href="subject.html#9017">[ subject ]</a>
              <a href="author.html#9017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/06/17 23:40, Christos Tsantilas wrote:
&gt;<i>
</I>&gt;<i> * Protect Squid Client classes from new requests that compete with
</I>&gt;<i> ongoing pinned connection use and
</I>&gt;<i> * resume dealing with new requests when those Client classes are done
</I>&gt;<i> using the pinned connection.
</I>&gt;<i>
</I>&gt;<i> Replaced primary ConnStateData::pinConnection() calls with a pair of
</I>&gt;<i> pinBusyConnection() and notePinnedConnectionBecameIdle() calls,
</I>&gt;<i> depending on the pinned connection state (&quot;busy&quot; or &quot;idle&quot;).
</I>&gt;<i>
</I>&gt;<i> Removed pinConnection() parameters that were not longer used or could be
</I>&gt;<i> computed from the remaining parameters.
</I>&gt;<i>
</I>&gt;<i> Removed ConnStateData::httpsPeeked() code &quot;hiding&quot; the originating
</I>&gt;<i> request and connection peer details while entering the first &quot;idle&quot;
</I>&gt;<i> state. The old (trunk r11880.1.6) bump-server-first code used a pair of
</I>&gt;<i> NULLs because &quot;Intercepted connections do not have requests at the
</I>&gt;<i> connection pinning stage&quot;, but that limitation no longer applicable
</I>&gt;<i> because Squid always fakes (when intercepting) or parses (a CONNECT)
</I>&gt;<i> request now, even during SslBump step1.
</I>&gt;<i>
</I>&gt;<i> The added XXX and TODOs are not directly related to this fix. They were
</I>&gt;<i> added to document problems discovered while working on this fix.
</I>&gt;<i>
</I>&gt;<i> In v3.5 code, the same problems manifest as Read.cc
</I>&gt;<i> &quot;fd_table[conn-&gt;fd].halfClosedReader != NULL&quot; assertions.
</I>&gt;<i>
</I>&gt;<i> This is a Measurement Factory project
</I>&gt;<i>
</I>

Audit:

in src/FwdState.cc

* Comm::ConnectionPointer() does not need to be passed nullptr 
parameter, there is a default constructor.


in src/client_side.cc:

* regarding the first XXX &quot;Closing pinned conn is too harsh&quot;
  - the entire point of pinning is to make the transports on both client 
and server connections share their fates.

Consider that to do a pinning means something outside Squid (the 
&quot;application layer&quot;) is depending on end-to-end semantics (effectively, 
as far as Squid is concerned anyway) and guarantees on the transport it 
thinks it is using. There is no way for Squid to know fully what is 
being passed at those higher levels to send the correct end signal. The 
only available signal we have is to close the things that _are_ known 
about, right up to the two TCP connections which were pinned together.


in src/client_side.h:

* I predict we are going to see Coverity complaints about 
PinnedIdleContext missing move semantics. It has instances initialized 
on the stack and then passed around by-value as if it were a 
smart-pointer rather than a class storing several smart pointers.
  - the options here are either to pass by-reference with &amp; operator, or 
to implement move constructor and assignment operator for the class.
  - it might be worthwhile implementing as a 
std::tuple&lt;aPointer,bPointer&gt; to get the operators implicitly.


in src/tests/stub_client_side.cc:

* no need for the pic parameter name in the 
notePinnedConnectionBecameIdle() stub.

Amos
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009016.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
	<LI>Next message: <A HREF="009018.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9017">[ date ]</a>
              <a href="thread.html#9017">[ thread ]</a>
              <a href="subject.html#9017">[ subject ]</a>
              <a href="author.html#9017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
