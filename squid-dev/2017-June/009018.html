<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3Ccad0e372-8057-dc24-84a9-35605793e5b4%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009017.html">
   <LINK REL="Next"  HREF="009019.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3Ccad0e372-8057-dc24-84a9-35605793e5b4%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jun 21 16:02:28 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009017.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
        <LI>Next message: <A HREF="009019.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9018">[ date ]</a>
              <a href="thread.html#9018">[ thread ]</a>
              <a href="subject.html#9018">[ subject ]</a>
              <a href="author.html#9018">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/21/2017 08:24 AM, Amos Jeffries wrote:
&gt;<i> On 21/06/17 23:40, Christos Tsantilas wrote:
</I>&gt;&gt;<i> * Protect Squid Client classes from new requests that compete with
</I>&gt;&gt;<i> ongoing pinned connection use and
</I>&gt;&gt;<i> * resume dealing with new requests when those Client classes are done
</I>&gt;&gt;<i> using the pinned connection.
</I>

&gt;<i> in src/FwdState.cc
</I>&gt;<i> 
</I>&gt;<i> * Comm::ConnectionPointer() does not need to be passed nullptr
</I>&gt;<i> parameter, there is a default constructor.
</I>
... but please continue to pass it to emphasize that we want to send a
nil pointer to the connection (rather than some &quot;default&quot; answer).


&gt;<i> in src/client_side.cc:
</I>&gt;<i> 
</I>&gt;<i> * regarding the first XXX &quot;Closing pinned conn is too harsh&quot;
</I>&gt;<i>  - the entire point of pinning is to make the transports on both client
</I>&gt;<i> and server connections share their fates.
</I>
What you describe is more of a side effect rather than the &quot;entire
point&quot;. For the record, pinning has two primary goals:

1. Allow correct server connection reuse (with the pinning client).
2. Prevent incorrect server connection reuse (with other clients).

The two connections certainly &quot;share fate&quot; to some extent, but that fate
sharing does not imply that a closure of one connection must always
trigger an &quot;immediate&quot; closure of the other connection.


&gt;<i> Consider that to do a pinning means something outside Squid (the
</I>&gt;<i> &quot;application layer&quot;) is depending on end-to-end semantics (effectively,
</I>&gt;<i> as far as Squid is concerned anyway) and guarantees on the transport it
</I>&gt;<i> thinks it is using. There is no way for Squid to know fully what is
</I>&gt;<i> being passed at those higher levels to send the correct end signal. The
</I>&gt;<i> only available signal we have is to close the things that _are_ known
</I>&gt;<i> about, right up to the two TCP connections which were pinned together.
</I>
What you say is true for blind tunnels but false for HTTP connection
pairs where Squid has (and uses!) HTTP mechanisms to control TCP
connection lifetimes. You could argue that MitM attacks break some
clients by changing effective server connection lifetime, and I would
agree with that, but once Squid is told (to attack) to use HTTP, it
should use HTTP signals for HTTP connection lifetimes (subject to
satisfying the primary pinning goals listed above, of course).


&gt;<i> in src/client_side.h:
</I>&gt;<i> 
</I>&gt;<i> * I predict we are going to see Coverity complaints about
</I>&gt;<i> PinnedIdleContext missing move semantics.
</I>
PinnedIdleContext already implements move optimizations (implicitly).
See &quot;Implicitly-declared move constructor&quot; at

    <A HREF="http://en.cppreference.com/w/cpp/language/move_constructor">http://en.cppreference.com/w/cpp/language/move_constructor</A>


&gt;<i> It has instances initialized
</I>&gt;<i> on the stack and then passed around by-value as if it were a
</I>&gt;<i> smart-pointer
</I>
The above &quot;as if&quot; conjunction does not compute for me: A lot of things
are initialized on the stack and then passed around by value that are
not smart pointers. For example, &quot;int&quot;, &quot;double&quot;, and &quot;struct timeval&quot;.


&gt;<i>  - the options here are either to pass by-reference with &amp; operator
</I>
I certainly agree that we should pass PinnedIdleContext by reference
where possible. If there are places not doing that in the patch, we
should change them. I do not know of such places, but I could have
missed them, of course.

Please note that asynchronous calls often require by-value parameters
because of how I wrote our AsyncCall parameter storing/type guessing code:

&gt;<i> src/base/AsyncJobCalls.h:139:1: no known conversion for argument 2 from ‘void (ConnStateData::*)(const ConnStateData::PinnedIdleContext&amp;)’ to ‘void (ConnStateData::*)(ConnStateData::PinnedIdleContext)’
</I>
I suspect we can remove that limitation, especially in the C++11 world,
but doing so is outside this project scope.


&gt;<i> or to implement move constructor and assignment operator for the class&gt;  - it might be worthwhile implementing as a
</I>&gt;<i> std::tuple&lt;aPointer,bPointer&gt; to get the operators implicitly.
</I>
PinnedIdleContext already got all those operators implicitly AFAICT.


HTH,

Alex.
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009017.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
	<LI>Next message: <A HREF="009019.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9018">[ date ]</a>
              <a href="thread.html#9018">[ thread ]</a>
              <a href="subject.html#9018">[ subject ]</a>
              <a href="author.html#9018">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
