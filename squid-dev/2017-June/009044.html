<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3Ca5e14002-73e4-f88d-e94e-4e4de98c6b53%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009019.html">
   <LINK REL="Next"  HREF="009046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3Ca5e14002-73e4-f88d-e94e-4e4de98c6b53%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.">christos at chtsanti.net
       </A><BR>
    <I>Fri Jun 23 09:53:16 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009019.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
        <LI>Next message: <A HREF="009046.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9044">[ date ]</a>
              <a href="thread.html#9044">[ thread ]</a>
              <a href="subject.html#9044">[ subject ]</a>
              <a href="author.html#9044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A new patch

Στις 21/06/2017 08:07 μμ, ο Alex Rousskov έγραψε:
&gt;<i> On 06/21/2017 05:40 AM, Christos Tsantilas wrote: I suggest the 
</I>&gt;<i> following one or two polishing touches:
</I>&gt;<i> 
</I>&gt;<i> 1. Merge pinConnection() and pinNewConnection() by returning from
</I>&gt;<i> the method if there is nothing to do, with a debugs() line printing 
</I>&gt;<i> pinServer. The merged method would be called pinConnection(), of 
</I>&gt;<i> course.
</I>
OK, done.

&gt;<i> 
</I>&gt;<i> 2. *If* the request object is actually always there, then change the 
</I>&gt;<i> pinConnection() parameter to an Http::Request reference (and change 
</I>&gt;<i> callers to dereference their request pointers).
</I>

I changed the &quot;HttpRequest *&quot; parameter to HttpRequest::Pointer
reference, I think this is the best.
I think currently the HttpRequest::Pointer is always not NULL, we can
add a &quot;Must()&quot; check if required, but HttpRequest object is not critical
for pinning operation.


&gt;&gt;<i> * regarding the first XXX &quot;Closing pinned conn is too harsh&quot; - the
</I>&gt;&gt;<i>  entire point of pinning is to make the transports on both client 
</I>&gt;&gt;<i> and server connections share their fates.
</I>&gt;<i> 
</I>&gt;<i> What you describe is more of a side effect rather than the &quot;entire 
</I>&gt;<i> point&quot;. For the record, pinning has two primary goals:
</I>&gt;<i> 
</I>&gt;<i> 1. Allow correct server connection reuse (with the pinning client). 
</I>&gt;<i> 2. Prevent incorrect server connection reuse (with other clients).
</I>&gt;<i> 
</I>&gt;<i> The two connections certainly &quot;share fate&quot; to some extent, but that 
</I>&gt;<i> fate sharing does not imply that a closure of one connection must 
</I>&gt;<i> always trigger an &quot;immediate&quot; closure of the other connection.
</I>

Currently when the squid-server connection is closed, we are always
closing the client-squid connection. For HTTP and FTP is not always the
best option.
On the other side if the client-squid connection closed the squid-server
side may want to continue download and store to cache an object, or may
want to cleanup and close properly with the server.

So I let this comment to the patch.
We can discuss it more when someone try to solve pinned connections
closing problems.

&gt;&gt;<i> in src/client_side.h:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> * I predict we are going to see Coverity complaints about 
</I>&gt;&gt;<i> PinnedIdleContext missing move semantics.
</I>
The Coverity should not complain about.
Can we test with Coverity before apply the patch, or can we apply and if
there are problems implement a move constructor?


&gt;&gt;<i> - the options here are either to pass by-reference with &amp; operator
</I>&gt;<i> 
</I>&gt;<i> I certainly agree that we should pass PinnedIdleContext by reference 
</I>&gt;<i> where possible. If there are places not doing that in the patch, we 
</I>&gt;<i> should change them. I do not know of such places, but I could have 
</I>&gt;<i> missed them, of course.
</I>

The ConnStateData::notePinnedConnectionBecameIdle and 
ConnStateData::httpsPeeked are passing by value the PinnedIdleContext.
Because they are AsyncCalls we can not do something else.

However the httpsPeeked calls notePinnedConnectionBecomeIdle (and pass 
PinnedIdleContext object by value).

Maybe we can move the notePinnedConnectionBecomeIdle code to a 
pinnedConnectionBecomeIdle(PinnedIdleContext &amp;) method and call this 
method from httpsPeeked and notePinnedConnectionBecomeIdle methods.



-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID307-half-closed-reader-t9.patch
Type: text/x-patch
Size: 38532 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170623/fc4db0e3/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170623/fc4db0e3/attachment-0001.bin</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009019.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
	<LI>Next message: <A HREF="009046.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9044">[ date ]</a>
              <a href="thread.html#9044">[ thread ]</a>
              <a href="subject.html#9044">[ subject ]</a>
              <a href="author.html#9044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
