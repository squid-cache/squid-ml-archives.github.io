<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3Cdb77005f-e733-707d-aa16-5114b0783156%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009044.html">
   <LINK REL="Next"  HREF="009056.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3Cdb77005f-e733-707d-aa16-5114b0783156%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun 23 14:58:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009044.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
        <LI>Next message: <A HREF="009056.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9046">[ date ]</a>
              <a href="thread.html#9046">[ thread ]</a>
              <a href="subject.html#9046">[ subject ]</a>
              <a href="author.html#9046">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/23/2017 03:53 AM, Christos Tsantilas wrote:
&gt;<i> Στις 21/06/2017 08:07 μμ, ο Alex Rousskov έγραψε:
</I>&gt;&gt;<i> 2. *If* the request object is actually always there, then change the
</I>&gt;&gt;<i> pinConnection() parameter to an Http::Request reference (and change
</I>&gt;&gt;<i> callers to dereference their request pointers).
</I>
&gt;<i> I changed the &quot;HttpRequest *&quot; parameter to HttpRequest::Pointer
</I>&gt;<i> reference, I think this is the best.
</I>&gt;<i> I think currently the HttpRequest::Pointer is always not NULL, we can
</I>&gt;<i> add a &quot;Must()&quot; check if required, but HttpRequest object is not critical
</I>&gt;<i> for pinning operation.
</I>
I understand your hesitation. Replacing what you think is unused code
with an assertion that it is unused is risky. In this particular case, I
recommend this replacement for v5 (so that we are making progress with
code cleanup) but not for v3.5. Your call.

BTW, the Must() you are talking about should probably be implemented as
an assertion inside the Pointer dereferencing method in RefCount.


&gt;&gt;&gt;<i> in src/client_side.h:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * I predict we are going to see Coverity complaints about
</I>&gt;&gt;&gt;<i> PinnedIdleContext missing move semantics.
</I>&gt;<i> 
</I>&gt;<i> The Coverity should not complain about.
</I>&gt;<i> Can we test with Coverity before apply the patch, or can we apply and if
</I>&gt;<i> there are problems implement a move constructor?
</I>
PinnedIdleContext has an implicit move constructor so there is nothing
to do here IMO. We should not add code unless there are some compelling
reasons for doing so, and no such reasons have been provided so far in
this case.

In general, you can certainly test with Coverity first, but I think that
requiring such manual tests in this context would be too onerous,
especially given the current testing setup. Eventually, such pre-commit
tests of pull requests will be automated.


&gt;&gt;&gt;<i> - the options here are either to pass by-reference with &amp; operator
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I certainly agree that we should pass PinnedIdleContext by reference
</I>&gt;&gt;<i> where possible. If there are places not doing that in the patch, we
</I>&gt;&gt;<i> should change them. I do not know of such places, but I could have
</I>&gt;&gt;<i> missed them, of course.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The ConnStateData::notePinnedConnectionBecameIdle and
</I>&gt;<i> ConnStateData::httpsPeeked are passing by value the PinnedIdleContext.
</I>&gt;<i> Because they are AsyncCalls we can not do something else.
</I>&gt;<i> 
</I>&gt;<i> However the httpsPeeked calls notePinnedConnectionBecomeIdle (and pass
</I>&gt;<i> PinnedIdleContext object by value).
</I>&gt;<i> 
</I>&gt;<i> Maybe we can move the notePinnedConnectionBecomeIdle code to a
</I>&gt;<i> pinnedConnectionBecomeIdle(PinnedIdleContext &amp;) method and call this
</I>&gt;<i> method from httpsPeeked and notePinnedConnectionBecomeIdle methods.
</I>
IMO, the increased interface complexity from adding another wrapper
method is not worth saving two smart pointer copies (that may be
optimized away be the compiler).


&gt;<i> +        debugs(33, 3, pinServer &lt;&lt; &quot;is already pinned&quot;);
</I>
I recommend swapping the two streaming elements because pinServer is
going to expand to many tokens, making &quot;is already pinned&quot; info more
difficult to read:

    debugs(33, 3, &quot;already pinned &quot; &lt;&lt; pinServer);

This is a trivial change that can be done during commit, of course.


Thank you,

Alex.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009044.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
	<LI>Next message: <A HREF="009056.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9046">[ date ]</a>
              <a href="thread.html#9046">[ thread ]</a>
              <a href="subject.html#9046">[ subject ]</a>
              <a href="author.html#9046">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
