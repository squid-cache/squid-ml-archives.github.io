<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3C3d840b33-e0b8-bc1b-a2ab-129a97b7237c%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009056.html">
   <LINK REL="Next"  HREF="009022.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Reduce%0A%20%22%21Comm%3A%3AMonitorsRead%28serverConnection-%3Efd%29%22%20assertions.&In-Reply-To=%3C3d840b33-e0b8-bc1b-a2ab-129a97b7237c%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.">christos at chtsanti.net
       </A><BR>
    <I>Mon Jun 26 14:36:56 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009056.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
        <LI>Next message: <A HREF="009022.html">[squid-dev] [PATCH] Digest Auth support for LDAP HA1 attribute without realm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9061">[ date ]</a>
              <a href="thread.html#9061">[ thread ]</a>
              <a href="subject.html#9061">[ subject ]</a>
              <a href="author.html#9061">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I applied the patch to squid-5 as r15226.

The applied patch includes the latest fixes requested by Alex.  The 
HttpRequest reference passed as parameter to the 
ConnStateData::pinConnection and also the RefCount class modified to 
assert on dereference operator when the pointer is null.

I am also attaching the patches for squid-3.5 and squid-4.
The squid-3.5 patch passes the HttpRequest::Pointer as parameter to the 
ConnStateData::pinConnection method.




Στις 23/06/2017 12:53 μμ, ο Christos Tsantilas έγραψε:
&gt;<i> A new patch
</I>&gt;<i> 
</I>&gt;<i> Στις 21/06/2017 08:07 μμ, ο Alex Rousskov έγραψε:
</I>&gt;&gt;<i> On 06/21/2017 05:40 AM, Christos Tsantilas wrote: I suggest the 
</I>&gt;&gt;<i> following one or two polishing touches:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Merge pinConnection() and pinNewConnection() by returning from
</I>&gt;&gt;<i> the method if there is nothing to do, with a debugs() line printing 
</I>&gt;&gt;<i> pinServer. The merged method would be called pinConnection(), of course.
</I>&gt;<i> 
</I>&gt;<i> OK, done.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. *If* the request object is actually always there, then change the 
</I>&gt;&gt;<i> pinConnection() parameter to an Http::Request reference (and change 
</I>&gt;&gt;<i> callers to dereference their request pointers).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I changed the &quot;HttpRequest *&quot; parameter to HttpRequest::Pointer
</I>&gt;<i> reference, I think this is the best.
</I>&gt;<i> I think currently the HttpRequest::Pointer is always not NULL, we can
</I>&gt;<i> add a &quot;Must()&quot; check if required, but HttpRequest object is not critical
</I>&gt;<i> for pinning operation.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> * regarding the first XXX &quot;Closing pinned conn is too harsh&quot; - the
</I>&gt;&gt;&gt;<i>  entire point of pinning is to make the transports on both client and 
</I>&gt;&gt;&gt;<i> server connections share their fates.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What you describe is more of a side effect rather than the &quot;entire 
</I>&gt;&gt;<i> point&quot;. For the record, pinning has two primary goals:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Allow correct server connection reuse (with the pinning client). 2. 
</I>&gt;&gt;<i> Prevent incorrect server connection reuse (with other clients).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The two connections certainly &quot;share fate&quot; to some extent, but that 
</I>&gt;&gt;<i> fate sharing does not imply that a closure of one connection must 
</I>&gt;&gt;<i> always trigger an &quot;immediate&quot; closure of the other connection.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Currently when the squid-server connection is closed, we are always
</I>&gt;<i> closing the client-squid connection. For HTTP and FTP is not always the
</I>&gt;<i> best option.
</I>&gt;<i> On the other side if the client-squid connection closed the squid-server
</I>&gt;<i> side may want to continue download and store to cache an object, or may
</I>&gt;<i> want to cleanup and close properly with the server.
</I>&gt;<i> 
</I>&gt;<i> So I let this comment to the patch.
</I>&gt;<i> We can discuss it more when someone try to solve pinned connections
</I>&gt;<i> closing problems.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> in src/client_side.h:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * I predict we are going to see Coverity complaints about 
</I>&gt;&gt;&gt;<i> PinnedIdleContext missing move semantics.
</I>&gt;<i> 
</I>&gt;<i> The Coverity should not complain about.
</I>&gt;<i> Can we test with Coverity before apply the patch, or can we apply and if
</I>&gt;<i> there are problems implement a move constructor?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> - the options here are either to pass by-reference with &amp; operator
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I certainly agree that we should pass PinnedIdleContext by reference 
</I>&gt;&gt;<i> where possible. If there are places not doing that in the patch, we 
</I>&gt;&gt;<i> should change them. I do not know of such places, but I could have 
</I>&gt;&gt;<i> missed them, of course.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The ConnStateData::notePinnedConnectionBecameIdle and 
</I>&gt;<i> ConnStateData::httpsPeeked are passing by value the PinnedIdleContext.
</I>&gt;<i> Because they are AsyncCalls we can not do something else.
</I>&gt;<i> 
</I>&gt;<i> However the httpsPeeked calls notePinnedConnectionBecomeIdle (and pass 
</I>&gt;<i> PinnedIdleContext object by value).
</I>&gt;<i> 
</I>&gt;<i> Maybe we can move the notePinnedConnectionBecomeIdle code to a 
</I>&gt;<i> pinnedConnectionBecomeIdle(PinnedIdleContext &amp;) method and call this 
</I>&gt;<i> method from httpsPeeked and notePinnedConnectionBecomeIdle methods.
</I>&gt;<i> 
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID307-half-closed-reader-squid4-t10.patch
Type: text/x-patch
Size: 38541 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170626/ff976cb0/attachment-0002.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170626/ff976cb0/attachment-0002.bin</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID307-half-closed-reader-squid3.5-t10.patch
Type: text/x-patch
Size: 41825 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170626/ff976cb0/attachment-0003.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170626/ff976cb0/attachment-0003.bin</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009056.html">[squid-dev] [PATCH] Reduce &quot;!Comm::MonitorsRead(serverConnection-&gt;fd)&quot; assertions.
</A></li>
	<LI>Next message: <A HREF="009022.html">[squid-dev] [PATCH] Digest Auth support for LDAP HA1 attribute without realm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9061">[ date ]</a>
              <a href="thread.html#9061">[ thread ]</a>
              <a href="subject.html#9061">[ subject ]</a>
              <a href="author.html#9061">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
