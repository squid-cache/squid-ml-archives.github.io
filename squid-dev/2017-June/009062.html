<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Retries of failed re-forwardable transactions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Retries%20of%20failed%20re-forwardable%20transactions&In-Reply-To=%3C30bad91d-7b0e-351b-2e82-90776feb023f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009060.html">
   <LINK REL="Next"  HREF="009063.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Retries of failed re-forwardable transactions</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Retries%20of%20failed%20re-forwardable%20transactions&In-Reply-To=%3C30bad91d-7b0e-351b-2e82-90776feb023f%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Retries of failed re-forwardable transactions">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Wed Jun 28 14:28:30 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009060.html">[squid-dev] Jenkins build is back to normal : template-full-matrix » clang,d-fedora-23 #395
</A></li>
        <LI>Next message: <A HREF="009063.html">[squid-dev] test 2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9062">[ date ]</a>
              <a href="thread.html#9062">[ thread ]</a>
              <a href="subject.html#9062">[ subject ]</a>
              <a href="author.html#9062">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,


This is a bug 4223 fix.

This change fixes Store to delay writing (and, therefore, sharing) of
re-triable errors (e.g., 504 Gateway Timeout responses) to clients:
once we start sharing the response with a client, we cannot re-try the
transaction. Since ENTRY_FWD_HDR_WAIT flag purpose is to delay response
sharing with Store clients, this patch fixes and clarifies its usage:

1. Removes unconditional clearing from startWriting().
2. Adds a conditional clearing to StoreEntry::write().
3. Sets it only for may-be-rejected responses.

(2) adds ENTRY_FWD_HDR_WAIT clearing to detect responses that filled the
entire read buffer and must be shared now with the clients because
they can no longer be retried with the current re-forwarding mechanisms
(which rely on completing the bad response transaction first) and will
get stuck. Such large re-triable error responses (&gt;32KB with default
read_ahead_gap) should be uncommon. They were getting stuck prior to
trunk r12501.1.48. That revision started clearing ENTRY_FWD_HDR_WAIT in
StoreEntry startWriting() unconditionally, allowing all errors to be
sent to Store clients without a delay, and effectively disabling
retries.

Mgr::Forwarder was always setting ENTRY_FWD_HDR_WAIT, probably mimicking
similarly aggressive FwdState behavior that we are now removing. Since
the forwarder never rewrites the entry content, it should not need to
set that flag. The forwarder and associated Server classes must not
communicate with the mgr client during the client-Squid connection
descriptor handoff to Coordinator, but ENTRY_FWD_HDR_WAIT is not the
right mechanism to block such Squid-client communication. The flag does
not work well for this purpose because those Server classes may (and
do?) substitute the &quot;blocked&quot; StoreEntry with another one to
write an error message to the client.

Also moved ENTRY_FWD_HDR_WAIT clearance from many StoreEntry::complete()
callers to that method itself. StoreEntry::complete() is meant to be the
last call when forming the entry. Any post-complete entry modifications
such as retries are prohibited.


Regards,

Eduard.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-267-retry-new-ignore-old-504-t1.patch
Type: text/x-patch
Size: 49755 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170628/b5ccee5e/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170628/b5ccee5e/attachment-0001.bin</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009060.html">[squid-dev] Jenkins build is back to normal : template-full-matrix » clang,d-fedora-23 #395
</A></li>
	<LI>Next message: <A HREF="009063.html">[squid-dev] test 2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9062">[ date ]</a>
              <a href="thread.html#9062">[ thread ]</a>
              <a href="subject.html#9062">[ subject ]</a>
              <a href="author.html#9062">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
