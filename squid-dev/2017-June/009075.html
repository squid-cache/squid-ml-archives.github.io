<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Happy Eyeballs: Deliver DNS results to peer	selection ASAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Happy%20Eyeballs%3A%20Deliver%20DNS%20results%20to%20peer%0A%09selection%20ASAP&In-Reply-To=%3C4d991983-4f13-755c-05ab-fd4ce2d1d6fb%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009072.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Happy Eyeballs: Deliver DNS results to peer	selection ASAP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Happy%20Eyeballs%3A%20Deliver%20DNS%20results%20to%20peer%0A%09selection%20ASAP&In-Reply-To=%3C4d991983-4f13-755c-05ab-fd4ce2d1d6fb%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Happy Eyeballs: Deliver DNS results to peer	selection ASAP">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun 30 22:44:57 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009072.html">[squid-dev] Fwd: RFP: ssl-bump support for upstream proxy in	transparent mode
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9075">[ date ]</a>
              <a href="thread.html#9075">[ thread ]</a>
              <a href="subject.html#9075">[ subject ]</a>
              <a href="author.html#9075">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    This patch completes a series of Happy Eyeballs-related changes:

1. stable Squid: Parallel DNS A and AAAA queries.
2. v5 r15183: ASAP delivery of IPs from peer selection to FwdState.
3. This patch: ASAP delivery of IPs from DNS to peer selection.
4. A separate project should add: Parallel TCP connections.

Patched Squid uses the first discovered IP address (e.g., IPv6 from a
DNS AAAA query) without waiting for the other IP address (e.g., IPv4
from a still-pending DNS A query).

Please see the patch preamble for the (many) technical details.

Besides posting this patch for a thorough review, I have one specific
question to ask: May I remove caching of &quot;unusable&quot; /etc/hosts IPs?

When IPv6 is disabled, the official Squid code does not allow IPv6
addresses in DNS records to enter the IP cache. However, there are no
such protections when loading IPs from /etc/hosts (see
ipcacheAddEntryFromHosts). The patch has to do quite a bit of extra work
to preserve that functionality (to see a few examples, search the patch
for &quot;alwaysBad&quot;).

The current approach (preserved by the patch) feels inconsistent. When
IPv6 support is disabled, if we still want to cache IPv6 addresses for
ACL matching, host validation, or other purposes, then we should allow
IPv6 addresses in DNS answers to be cached as well or even submit AAAA
queries to actively seek those valuable addresses! On the other hand, if
we do not want IPv6 addresses when IPv6 is disabled, then we should not
cache IPv6 /etc/hosts entries.

If caching IPv6 /etc/hosts entries when IPv6 support is disabled was an
accident, then I will remove that functionality, simplifying the patch.
If it was intentional, then I will leave the patch as is.

The patch contains a &quot;stop caching alwaysBad() IPs&quot; XXX for the
/etc/hosts question above. All other added XXXs and TODOs are outside
this project scope.


Thank you,

Alex.
P.S. If the patch is accepted, I will reformat it. I think I need to
upgrade my setup to get the newer astyle version that v5 is using now.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID69-deliver-ip-asap-t7.patch
Type: text/x-patch
Size: 112758 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170630/02a7832d/attachment-0001.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170630/02a7832d/attachment-0001.bin</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009072.html">[squid-dev] Fwd: RFP: ssl-bump support for upstream proxy in	transparent mode
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9075">[ date ]</a>
              <a href="thread.html#9075">[ thread ]</a>
              <a href="subject.html#9075">[ subject ]</a>
              <a href="author.html#9075">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
