<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] VIA creation code duplication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20VIA%20creation%20code%20duplication&In-Reply-To=%3Cb626d007-c324-d9a2-f840-de44d6576234%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008246.html">
   <LINK REL="Next"  HREF="008276.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] VIA creation code duplication</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20VIA%20creation%20code%20duplication&In-Reply-To=%3Cb626d007-c324-d9a2-f840-de44d6576234%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] VIA creation code duplication">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Mar 13 16:24:16 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008246.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
        <LI>Next message: <A HREF="008276.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8249">[ date ]</a>
              <a href="thread.html#8249">[ thread ]</a>
              <a href="subject.html#8249">[ subject ]</a>
              <a href="author.html#8249">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/13/2017 08:25 AM, Eduard Bagdasaryan wrote:
&gt;<i> On 14.02.2017 04:22, Amos Jeffries wrote:
</I>&gt;&gt;<i> The problem is with proxy where the admin has configured large headers
</I>&gt;&gt;<i> to be allowed, and receives a Via just under the 6KB liit. Our append
</I>&gt;&gt;<i> pushing it over by even one byte would assert.
</I>
Yes, except s/6/64/ and no special configuration is probably needed:
reply_header_max_size is 64KB by default (and so is String::SizeMax_).


&gt;<i> I am attaching a patch using SBuf instead of String for Via
</I>&gt;<i> accumulating, as you previously suggested. I am not
</I>&gt;<i> sure this is a much better solution since we have to do an
</I>&gt;<i> extra copy into SBuf.
</I>
Will this new patch assert in String::setBuffer(?) when the final Via
value exceeds String::SizeMax_ and putStr() is called with a 64KB+1 or
longer value string?


&gt;&gt;<i> The older bbuf code
</I>&gt;&gt;<i> cropping at 1KB was nasty but would not crash Squid.
</I>
1KB cropping of the additional Via component before strListAdd() is
pretty much irrelevant to String overflows discussed here -- the size of
the added value is usually not the problem (the resulting total size
is). The reason strListAdd() is better than String::append() when
assembling the Via header is because the former throws and the latter
asserts.


&gt;<i> I don't see the code preventing Squid from String overflow
</I>&gt;<i> there. The bbuf you are talking about was appended to via string
</I>&gt;<i> by strListAdd() without any checks...
</I>
strListAdd() has Must(str-&gt;canGrowBy(itemSize)). This protection is far
from perfect or even good, but better than an assert.

See trunk r14552 for details.


Wondering how much more time will be wasted on what used to be a simple
and useful code de-duplication patch,

Alex.

</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008246.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
	<LI>Next message: <A HREF="008276.html">[squid-dev] [PATCH] VIA creation code duplication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8249">[ date ]</a>
              <a href="thread.html#8249">[ thread ]</a>
              <a href="subject.html#8249">[ subject ]</a>
              <a href="author.html#8249">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
