<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] To make squid works in snap world.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3C90e38b47-5ea5-03ec-d2ac-47b53a46b7eb%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008250.html">
   <LINK REL="Next"  HREF="008254.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] To make squid works in snap world.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3C90e38b47-5ea5-03ec-d2ac-47b53a46b7eb%40measurement-factory.com%3E"
       TITLE="[squid-dev] To make squid works in snap world.">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar 14 15:49:51 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008250.html">[squid-dev] To make squid works in snap world.
</A></li>
        <LI>Next message: <A HREF="008254.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8251">[ date ]</a>
              <a href="thread.html#8251">[ thread ]</a>
              <a href="subject.html#8251">[ subject ]</a>
              <a href="author.html#8251">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/14/2017 08:44 AM, Gary Wang wrote:
&gt;<i>     About the DEFAULT_STATEDIR,
</I>&gt;<i>     ...
</I>&gt;<i>     DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;    
</I>&gt;<i>     ...
</I>&gt;<i>     According to the above share memory namespace in snap world, it
</I>&gt;<i> couldn't help on this either.
</I>
Here is how I [mis]interpret the above:

1. Squid has a DEFAULT_STATEDIR compile-time constant that provides the
right control knob you need but uses the wrong hard-coded value.

2. You are adding a compile-time variable DEFAULT_IPC_PREFIX that does
what DEFAULT_STATEDIR does but can be changed at ./configure time.

This raises an obvious question: Why not make DEFAULT_STATEDIR
configurable instead?  (If we do make it configurable, we may need to
renamed it to STATEDIR, IPCDIR, or something like that but that is a
separate and minor issue.)


AFAICT, DEFAULT_STATEDIR is also used for IPC communications in
src/ipc/Port.cc. Your patch does not change that code. This means that

* either you forgot to change src/ipc/Port.cc to honor the new
DEFAULT_IPC_PREFIX

* or src/ipc/Port.cc cannot use DEFAULT_IPC_PREFIX for some reason (and,
hence, DEFAULT_IPC_PREFIX is the wrong name because the parameter does
not apply to some of the IPC code).

Alex.



&gt;<i> === modified file 'configure.ac'
</I>&gt;<i> --- configure.ac	2017-01-28 03:54:15 +0000
</I>&gt;<i> +++ configure.ac	2017-03-02 03:51:46 +0000
</I>&gt;<i> @@ -311,6 +311,15 @@
</I>&gt;<i>  ])
</I>&gt;<i>  AC_SUBST(DEFAULT_SWAP_DIR)
</I>&gt;<i>  
</I>&gt;<i> +DEFAULT_IPC_PREFIX=&quot;&quot;
</I>&gt;<i> +AC_ARG_WITH(ipcprefix,
</I>&gt;<i> +  AS_HELP_STRING([--with-ipcprefix=NAME],
</I>&gt;<i> +    [Default namespace prefix for shared memory object for ipc communication. 
</I>&gt;<i> +     Default is empty string and the share memory object name will be specified by squid. ]), [
</I>&gt;<i> +   DEFAULT_IPC_PREFIX=&quot;$withval&quot;
</I>&gt;<i> +])
</I>&gt;<i> +AC_SUBST(DEFAULT_IPC_PREFIX)
</I>&gt;<i> +
</I>&gt;<i>  if test &quot;$squid_cv_compiler&quot; = &quot;gcc&quot;; then
</I>&gt;<i>    GCCVER=`$CC -v 2&gt;&amp;1 | awk '$2 ==  &quot;version&quot; {print $3}'`
</I>&gt;<i>    GCCVER2=`echo $GCCVER | awk '{print $1 * 100}'`
</I>&gt;<i> 
</I>&gt;<i> === modified file 'src/ipc/Makefile.am'
</I>&gt;<i> --- src/ipc/Makefile.am	2017-01-01 00:16:45 +0000
</I>&gt;<i> +++ src/ipc/Makefile.am	2017-03-02 03:51:46 +0000
</I>&gt;<i> @@ -68,7 +68,7 @@
</I>&gt;<i>  	mem/Segment.cc \
</I>&gt;<i>  	mem/Segment.h
</I>&gt;<i>  
</I>&gt;<i> -DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> +DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot; -DDEFAULT_IPC_PREFIX=\&quot;$(DEFAULT_IPC_PREFIX)\&quot;
</I>&gt;<i>  
</I>&gt;<i>  install-data-local:
</I>&gt;<i>  	$(mkinstalldirs) $(DESTDIR)$(localstatedir)/run/squid;
</I>&gt;<i> 
</I>&gt;<i> === modified file 'src/ipc/mem/Segment.cc'
</I>&gt;<i> --- src/ipc/mem/Segment.cc	2017-01-01 00:16:45 +0000
</I>&gt;<i> +++ src/ipc/mem/Segment.cc	2017-03-02 03:51:46 +0000
</I>&gt;<i> @@ -30,6 +30,8 @@
</I>&gt;<i>  #include &lt;unistd.h&gt;
</I>&gt;<i>  #endif
</I>&gt;<i>  
</I>&gt;<i> +#define DEFAULT_SQUID_IPC_PREFIX  &quot;/&quot; DEFAULT_IPC_PREFIX
</I>&gt;<i> +
</I>&gt;<i>  // test cases change this
</I>&gt;<i>  const char *Ipc::Mem::Segment::BasePath = DEFAULT_STATEDIR;
</I>&gt;<i>  
</I>&gt;<i> @@ -229,9 +231,9 @@
</I>&gt;<i>      if (nameIsPath) {
</I>&gt;<i>          name.append(BasePath);
</I>&gt;<i>          if (name[name.size()-1] != '/')
</I>&gt;<i> -            name.append('/');
</I>&gt;<i> +            name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i>      } else {
</I>&gt;<i> -        name.append('/');
</I>&gt;<i> +        name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i>          name.append(service_name.c_str());
</I>&gt;<i>          name.append('-');
</I>&gt;<i>      }
</I>
</PRE>












































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008250.html">[squid-dev] To make squid works in snap world.
</A></li>
	<LI>Next message: <A HREF="008254.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8251">[ date ]</a>
              <a href="thread.html#8251">[ thread ]</a>
              <a href="subject.html#8251">[ subject ]</a>
              <a href="author.html#8251">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
