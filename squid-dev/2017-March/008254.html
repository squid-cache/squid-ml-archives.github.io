<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] To make squid works in snap world.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3CCAHFd1HC04cFYJ%3DDoNx9Rapuz%3DdzMmJ4OV476c0d57TmWozcF8g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008251.html">
   <LINK REL="Next"  HREF="008256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] To make squid works in snap world.</H1>
    <B>Gary Wang</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3CCAHFd1HC04cFYJ%3DDoNx9Rapuz%3DdzMmJ4OV476c0d57TmWozcF8g%40mail.gmail.com%3E"
       TITLE="[squid-dev] To make squid works in snap world.">gary.wang at canonical.com
       </A><BR>
    <I>Wed Mar 15 03:52:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008251.html">[squid-dev] To make squid works in snap world.
</A></li>
        <LI>Next message: <A HREF="008256.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8254">[ date ]</a>
              <a href="thread.html#8254">[ thread ]</a>
              <a href="subject.html#8254">[ subject ]</a>
              <a href="author.html#8254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Alex for your quick response.


On Tue, Mar 14, 2017 at 11:49 PM, Alex Rousskov &lt;
<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 03/14/2017 08:44 AM, Gary Wang wrote:
</I>&gt;<i> &gt;     About the DEFAULT_STATEDIR,
</I>&gt;<i> &gt;     ...
</I>&gt;<i> &gt;     DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> &gt;     ...
</I>&gt;<i> &gt;     According to the above share memory namespace in snap world, it
</I>&gt;<i> &gt; couldn't help on this either.
</I>&gt;<i>
</I>&gt;<i> Here is how I [mis]interpret the above:
</I>&gt;<i>
</I>&gt;<i> 1. Squid has a DEFAULT_STATEDIR compile-time constant that provides the
</I>&gt;<i> right control knob you need but uses the wrong hard-coded value.
</I>&gt;<i>
</I>&gt;<i> 2. You are adding a compile-time variable DEFAULT_IPC_PREFIX that does
</I>&gt;<i> what DEFAULT_STATEDIR does but can be changed at ./configure time.
</I>&gt;<i>
</I>&gt;<i> This raises an obvious question: Why not make DEFAULT_STATEDIR
</I>&gt;<i> configurable instead?  (If we do make it configurable, we may need to
</I>&gt;<i> renamed it to STATEDIR, IPCDIR, or something like that but that is a
</I>&gt;<i> separate and minor issue.)
</I>&gt;<i>
</I>&gt;<i>    A: Actually, DEFAULT_IPC_PREFIX only changes the shared memory file name
</I>       not the file path. So the usage of these two options are different.
       Meanwhile, DEFAULT_STATEDIR only helps the case that the segment
name is path.
       It can't help this situation where segment name is not path e.g.
 shared memory is created
       in /dev/shm folder on Ubuntu.

<A HREF="http://bazaar.launchpad.net/~gary-wzl77/squid/ipc_prefix/view/head:/src/ipc/mem/Segment.cc#L229">http://bazaar.launchpad.net/~gary-wzl77/squid/ipc_prefix/view/head:/src/ipc/mem/Segment.cc#L229</A>

       Another concern is that even though we make DEFAULT_STATEDIR
configurable instead of introducing new option, STATEDIR, IPCDIR is not
suitable as
end-user might specify the dir path for these options however the purpose
of DEFAULT_IPC_PREFIX
is only add prefix to shared memory file name

&gt;<i>
</I>&gt;<i> AFAICT, DEFAULT_STATEDIR is also used for IPC communications in
</I>&gt;<i> src/ipc/Port.cc. Your patch does not change that code. This means that
</I>&gt;<i>
</I>&gt;<i> * either you forgot to change src/ipc/Port.cc to honor the new
</I>&gt;<i> DEFAULT_IPC_PREFIX
</I>&gt;<i>
</I>   A: I will change src/ipc/Port.cc in the next commit once we reach an
agreement
       on the usage of compiler option.


&gt;<i>
</I>&gt;<i> * or src/ipc/Port.cc cannot use DEFAULT_IPC_PREFIX for some reason (and,
</I>&gt;<i> hence, DEFAULT_IPC_PREFIX is the wrong name because the parameter does
</I>&gt;<i> not apply to some of the IPC code).
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; === modified file 'configure.ac'
</I>&gt;<i> &gt; --- configure.ac      2017-01-28 03:54:15 +0000
</I>&gt;<i> &gt; +++ configure.ac      2017-03-02 03:51:46 +0000
</I>&gt;<i> &gt; @@ -311,6 +311,15 @@
</I>&gt;<i> &gt;  ])
</I>&gt;<i> &gt;  AC_SUBST(DEFAULT_SWAP_DIR)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; +DEFAULT_IPC_PREFIX=&quot;&quot;
</I>&gt;<i> &gt; +AC_ARG_WITH(ipcprefix,
</I>&gt;<i> &gt; +  AS_HELP_STRING([--with-ipcprefix=NAME],
</I>&gt;<i> &gt; +    [Default namespace prefix for shared memory object for ipc
</I>&gt;<i> communication.
</I>&gt;<i> &gt; +     Default is empty string and the share memory object name will be
</I>&gt;<i> specified by squid. ]), [
</I>&gt;<i> &gt; +   DEFAULT_IPC_PREFIX=&quot;$withval&quot;
</I>&gt;<i> &gt; +])
</I>&gt;<i> &gt; +AC_SUBST(DEFAULT_IPC_PREFIX)
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt;  if test &quot;$squid_cv_compiler&quot; = &quot;gcc&quot;; then
</I>&gt;<i> &gt;    GCCVER=`$CC -v 2&gt;&amp;1 | awk '$2 ==  &quot;version&quot; {print $3}'`
</I>&gt;<i> &gt;    GCCVER2=`echo $GCCVER | awk '{print $1 * 100}'`
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; === modified file 'src/ipc/Makefile.am'
</I>&gt;<i> &gt; --- src/ipc/Makefile.am       2017-01-01 00:16:45 +0000
</I>&gt;<i> &gt; +++ src/ipc/Makefile.am       2017-03-02 03:51:46 +0000
</I>&gt;<i> &gt; @@ -68,7 +68,7 @@
</I>&gt;<i> &gt;       mem/Segment.cc \
</I>&gt;<i> &gt;       mem/Segment.h
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> &gt; +DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> -DDEFAULT_IPC_PREFIX=\&quot;$(DEFAULT_IPC_PREFIX)\&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  install-data-local:
</I>&gt;<i> &gt;       $(mkinstalldirs) $(DESTDIR)$(localstatedir)/run/squid;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; === modified file 'src/ipc/mem/Segment.cc'
</I>&gt;<i> &gt; --- src/ipc/mem/Segment.cc    2017-01-01 00:16:45 +0000
</I>&gt;<i> &gt; +++ src/ipc/mem/Segment.cc    2017-03-02 03:51:46 +0000
</I>&gt;<i> &gt; @@ -30,6 +30,8 @@
</I>&gt;<i> &gt;  #include &lt;unistd.h&gt;
</I>&gt;<i> &gt;  #endif
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; +#define DEFAULT_SQUID_IPC_PREFIX  &quot;/&quot; DEFAULT_IPC_PREFIX
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt;  // test cases change this
</I>&gt;<i> &gt;  const char *Ipc::Mem::Segment::BasePath = DEFAULT_STATEDIR;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; @@ -229,9 +231,9 @@
</I>&gt;<i> &gt;      if (nameIsPath) {
</I>&gt;<i> &gt;          name.append(BasePath);
</I>&gt;<i> &gt;          if (name[name.size()-1] != '/')
</I>&gt;<i> &gt; -            name.append('/');
</I>&gt;<i> &gt; +            name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i> &gt;      } else {
</I>&gt;<i> &gt; -        name.append('/');
</I>&gt;<i> &gt; +        name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i> &gt;          name.append(service_name.c_str());
</I>&gt;<i> &gt;          name.append('-');
</I>&gt;<i> &gt;      }
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Br
Gary.Wzl
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170315/594b3944/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170315/594b3944/attachment-0001.html</A>&gt;
</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008251.html">[squid-dev] To make squid works in snap world.
</A></li>
	<LI>Next message: <A HREF="008256.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8254">[ date ]</a>
              <a href="thread.html#8254">[ thread ]</a>
              <a href="subject.html#8254">[ subject ]</a>
              <a href="author.html#8254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
