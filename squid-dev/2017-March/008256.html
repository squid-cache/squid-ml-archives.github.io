<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] To make squid works in snap world.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3C5b4c1d97-0c38-07ae-657c-bb925891f934%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008254.html">
   <LINK REL="Next"  HREF="008258.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] To make squid works in snap world.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3C5b4c1d97-0c38-07ae-657c-bb925891f934%40measurement-factory.com%3E"
       TITLE="[squid-dev] To make squid works in snap world.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 15 04:48:12 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008254.html">[squid-dev] To make squid works in snap world.
</A></li>
        <LI>Next message: <A HREF="008258.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8256">[ date ]</a>
              <a href="thread.html#8256">[ thread ]</a>
              <a href="subject.html#8256">[ subject ]</a>
              <a href="author.html#8256">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/14/2017 09:52 PM, Gary Wang wrote:
&gt;<i> On Tue, Mar 14, 2017 at 11:49 PM, Alex Rousskov wrote:
</I>&gt;&gt;<i>     On 03/14/2017 08:44 AM, Gary Wang wrote:
</I>&gt;&gt;<i>     &gt;     About the DEFAULT_STATEDIR,
</I>&gt;&gt;<i>     &gt;     ...
</I>&gt;&gt;<i>     &gt;     DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;&gt;<i>     &gt;     ...
</I>&gt;&gt;<i>     &gt;     According to the above share memory namespace in snap world, it
</I>&gt;&gt;<i>     &gt; couldn't help on this either.
</I>
&gt;&gt;<i>     Why not make DEFAULT_STATEDIR configurable instead?
</I>
&gt;<i>    A: Actually, DEFAULT_IPC_PREFIX only changes the shared memory file name
</I>&gt;<i>        not the file path. So the usage of these two options are different. 
</I>
You are describing your implementation. I am asking why not support the
same functionality using a _different_ general implementation that
avoids adding a yet another option that controls IPC-related file names.
You added an option that changes the &quot;middle&quot; part of the full file
name. Why not make the existing constant that controls the &quot;prefix&quot; part
of the full file name configurable instead?

I understand that the two approaches result in [slightly] different
code, but if a single option can accomplish the desired outcome and
supports more use cases, then using that single option may be a better
approach.


&gt;<i> DEFAULT_STATEDIR only helps the case that the segment name is path.
</I>
Can the updated/renamed DEFAULT_STATEDIR be interpreted as

 &lt;path&gt; / &lt;filename prefix&gt;

where the first component is used if and only when nameIsPath is true
and the second component is optional? AFAICT, such an implementation
would cover the already supported use cases and your new use case.

For snap environments, the option could be set to something like:

  $(localstatedir)/run/squid/sem.snap.squid.



&gt;<i> Another concern is that even though we make DEFAULT_STATEDIR
</I>&gt;<i> configurable instead of introducing new option, STATEDIR, IPCDIR is not
</I>&gt;<i> suitable as end-user might specify the dir path for these options however the
</I>&gt;<i> purpose of DEFAULT_IPC_PREFIX is only add prefix to shared memory file name
</I>
I am not sure I understand the above concern, but perhaps my suggestion
to ignore the path component (as needed) would address it?


&gt;&gt;<i>     AFAICT, DEFAULT_STATEDIR is also used for IPC communications in
</I>&gt;&gt;<i>     src/ipc/Port.cc. Your patch does not change that code. This means that
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>     * either you forgot to change src/ipc/Port.cc to honor the new
</I>&gt;&gt;<i>     DEFAULT_IPC_PREFIX
</I>
&gt;<i> A: I will change src/ipc/Port.cc in the next commit once we reach an
</I>&gt;<i> agreement on the usage of compiler option.
</I>
For Squid to work in a snap world, will you need the same
sem.snap.@{SNAP_NAME}. prefix for Unix Domain Sockets as for shared
memory segments?

* If yes, then using a single option for both ipc/mem/Segment.cc and
ipc/Port.cc may work.

* Otherwise, we would have to add two different options, one for shared
memory segment names and one for UDS names.


Cheers,

Alex.


&gt;<i>     * or src/ipc/Port.cc cannot use DEFAULT_IPC_PREFIX for some reason (and,
</I>&gt;<i>     hence, DEFAULT_IPC_PREFIX is the wrong name because the parameter does
</I>&gt;<i>     not apply to some of the IPC code).
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; === modified file 'configure.ac &lt;<A HREF="http://configure.ac">http://configure.ac</A>&gt;'
</I>&gt;<i>     &gt; --- configure.ac &lt;<A HREF="http://configure.ac">http://configure.ac</A>&gt;      2017-01-28 03:54:15 +0000
</I>&gt;<i>     &gt; +++ configure.ac &lt;<A HREF="http://configure.ac">http://configure.ac</A>&gt;      2017-03-02 03:51:46 +0000
</I>&gt;<i>     &gt; @@ -311,6 +311,15 @@
</I>&gt;<i>     &gt;  ])
</I>&gt;<i>     &gt;  AC_SUBST(DEFAULT_SWAP_DIR)
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; +DEFAULT_IPC_PREFIX=&quot;&quot;
</I>&gt;<i>     &gt; +AC_ARG_WITH(ipcprefix,
</I>&gt;<i>     &gt; +  AS_HELP_STRING([--with-ipcprefix=NAME],
</I>&gt;<i>     &gt; +    [Default namespace prefix for shared memory object for ipc
</I>&gt;<i>     communication.
</I>&gt;<i>     &gt; +     Default is empty string and the share memory object name
</I>&gt;<i>     will be specified by squid. ]), [
</I>&gt;<i>     &gt; +   DEFAULT_IPC_PREFIX=&quot;$withval&quot;
</I>&gt;<i>     &gt; +])
</I>&gt;<i>     &gt; +AC_SUBST(DEFAULT_IPC_PREFIX)
</I>&gt;<i>     &gt; +
</I>&gt;<i>     &gt;  if test &quot;$squid_cv_compiler&quot; = &quot;gcc&quot;; then
</I>&gt;<i>     &gt;    GCCVER=`$CC -v 2&gt;&amp;1 | awk '$2 ==  &quot;version&quot; {print $3}'`
</I>&gt;<i>     &gt;    GCCVER2=`echo $GCCVER | awk '{print $1 * 100}'`
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; === modified file 'src/ipc/Makefile.am'
</I>&gt;<i>     &gt; --- src/ipc/Makefile.am       2017-01-01 00:16:45 +0000
</I>&gt;<i>     &gt; +++ src/ipc/Makefile.am       2017-03-02 03:51:46 +0000
</I>&gt;<i>     &gt; @@ -68,7 +68,7 @@
</I>&gt;<i>     &gt;       mem/Segment.cc \
</I>&gt;<i>     &gt;       mem/Segment.h
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; -DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i>     &gt; +DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i>     -DDEFAULT_IPC_PREFIX=\&quot;$(DEFAULT_IPC_PREFIX)\&quot;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;  install-data-local:
</I>&gt;<i>     &gt;       $(mkinstalldirs) $(DESTDIR)$(localstatedir)/run/squid;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; === modified file 'src/ipc/mem/Segment.cc'
</I>&gt;<i>     &gt; --- src/ipc/mem/Segment.cc    2017-01-01 00:16:45 +0000
</I>&gt;<i>     &gt; +++ src/ipc/mem/Segment.cc    2017-03-02 03:51:46 +0000
</I>&gt;<i>     &gt; @@ -30,6 +30,8 @@
</I>&gt;<i>     &gt;  #include &lt;unistd.h&gt;
</I>&gt;<i>     &gt;  #endif
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; +#define DEFAULT_SQUID_IPC_PREFIX  &quot;/&quot; DEFAULT_IPC_PREFIX
</I>&gt;<i>     &gt; +
</I>&gt;<i>     &gt;  // test cases change this
</I>&gt;<i>     &gt;  const char *Ipc::Mem::Segment::BasePath = DEFAULT_STATEDIR;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; @@ -229,9 +231,9 @@
</I>&gt;<i>     &gt;      if (nameIsPath) {
</I>&gt;<i>     &gt;          name.append(BasePath);
</I>&gt;<i>     &gt;          if (name[name.size()-1] != '/')
</I>&gt;<i>     &gt; -            name.append('/');
</I>&gt;<i>     &gt; +            name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i>     &gt;      } else {
</I>&gt;<i>     &gt; -        name.append('/');
</I>&gt;<i>     &gt; +        name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i>     &gt;          name.append(service_name.c_str());
</I>&gt;<i>     &gt;          name.append('-');
</I>&gt;<i>     &gt;      }
</I>

</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008254.html">[squid-dev] To make squid works in snap world.
</A></li>
	<LI>Next message: <A HREF="008258.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8256">[ date ]</a>
              <a href="thread.html#8256">[ thread ]</a>
              <a href="subject.html#8256">[ subject ]</a>
              <a href="author.html#8256">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
