<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] To make squid works in snap world.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3CCAHFd1HBmG3ES51AWYLLgzDMbRuJUCucWdFYdYczoLCGxuwAUrQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008256.html">
   <LINK REL="Next"  HREF="008267.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] To make squid works in snap world.</H1>
    <B>Gary Wang</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20To%20make%20squid%20works%20in%20snap%20world.&In-Reply-To=%3CCAHFd1HBmG3ES51AWYLLgzDMbRuJUCucWdFYdYczoLCGxuwAUrQ%40mail.gmail.com%3E"
       TITLE="[squid-dev] To make squid works in snap world.">gary.wang at canonical.com
       </A><BR>
    <I>Wed Mar 15 09:24:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008256.html">[squid-dev] To make squid works in snap world.
</A></li>
        <LI>Next message: <A HREF="008267.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8258">[ date ]</a>
              <a href="thread.html#8258">[ thread ]</a>
              <a href="subject.html#8258">[ subject ]</a>
              <a href="author.html#8258">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Regarding the confinement of usage of shared memory in snap world,
       Please take a look at the bug
       <A HREF="https://bugs.launchpad.net/snappy/+bug/1653955">https://bugs.launchpad.net/snappy/+bug/1653955</A>
       And Jamie's reply can be fuond in snapcraft maillist
       <A HREF="https://www.mail-archive.com/snapcraft@lists.snapcraft.io/">https://www.mail-archive.com/snapcraft@lists.snapcraft.io/</A>
msg02465.html

&quot;sem_open() is <A HREF="https://bugs.launchpad.net/snappy/+bug/1653955">https://bugs.launchpad.net/snappy/+bug/1653955</A> and
&lt;<A HREF="https://bugs.launchpad.net/snappy/+bug/1653955%C2%A0and">https://bugs.launchpad.net/snappy/+bug/1653955%C2%A0and</A>&gt; snapd 2.21

added support to allow /{dev,run}/shm/sem.snap.@{SNAP_NAME}.*. This is

sufficient to make use of sem_open() possible.&quot;

On Wed, Mar 15, 2017 at 12:48 PM, Alex Rousskov &lt;
<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 03/14/2017 09:52 PM, Gary Wang wrote:
</I>&gt;<i> &gt; On Tue, Mar 14, 2017 at 11:49 PM, Alex Rousskov wrote:
</I>&gt;<i> &gt;&gt;     On 03/14/2017 08:44 AM, Gary Wang wrote:
</I>&gt;<i> &gt;&gt;     &gt;     About the DEFAULT_STATEDIR,
</I>&gt;<i> &gt;&gt;     &gt;     ...
</I>&gt;<i> &gt;&gt;     &gt;     DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> &gt;&gt;     &gt;     ...
</I>&gt;<i> &gt;&gt;     &gt;     According to the above share memory namespace in snap world,
</I>&gt;<i> it
</I>&gt;<i> &gt;&gt;     &gt; couldn't help on this either.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;     Why not make DEFAULT_STATEDIR configurable instead?
</I>&gt;<i>
</I>&gt;<i> &gt;    A: Actually, DEFAULT_IPC_PREFIX only changes the shared memory file
</I>&gt;<i> name
</I>&gt;<i> &gt;        not the file path. So the usage of these two options are
</I>&gt;<i> different.
</I>&gt;<i>
</I>&gt;<i> You are describing your implementation. I am asking why not support the
</I>&gt;<i> same functionality using a _different_ general implementation that
</I>&gt;<i> avoids adding a yet another option that controls IPC-related file names.
</I>&gt;<i> You added an option that changes the &quot;middle&quot; part of the full file
</I>&gt;<i> name. Why not make the existing constant that controls the &quot;prefix&quot; part
</I>&gt;<i> of the full file name configurable instead?
</I>&gt;<i>
</I>&gt;<i> I understand that the two approaches result in [slightly] different
</I>&gt;<i> code, but if a single option can accomplish the desired outcome and
</I>&gt;<i> supports more use cases, then using that single option may be a better
</I>&gt;<i> approach.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; DEFAULT_STATEDIR only helps the case that the segment name is path.
</I>&gt;<i>
</I>&gt;<i> Can the updated/renamed DEFAULT_STATEDIR be interpreted as
</I>&gt;<i>
</I>&gt;<i>  &lt;path&gt; / &lt;filename prefix&gt;
</I>&gt;<i>
</I>&gt;<i> where the first component is used if and only when nameIsPath is true
</I>&gt;<i> and the second component is optional? AFAICT, such an implementation
</I>&gt;<i> would cover the already supported use cases and your new use case.
</I>&gt;<i>
</I>&gt;<i> For snap environments, the option could be set to something like:
</I>&gt;<i>
</I>&gt;<i>   $(localstatedir)/run/squid/sem.snap.squid.
</I>&gt;<i>
</I>&gt;<i>   A: I understood your point that a single option can keep clean code base.
</I>      But interpreting  DEFAULT_STATEDIR  as &lt;path&gt; / &lt;filename prefix&gt;
      is more like a trick. Wihout snap-related knowledge, normal developer
will
      treat the the option as an absolute path instead of combination
      of &lt;path&gt;/&lt;filename prefix&gt;

      I can make a change to fix it based on your comment.
      But please double-check if it's the right implementation.

      Meanwhile, according to shared memory file namespace
           /dev/shm/sem.snap.@{SNAP_NAME}.*
      If we use the option in the following way
          $(localstatedir)/run/squid/sem.snap.squid,
      which means SNAP_NAME would be &quot;squid&quot;,
     I have a quick look at ubuntu store and found that &quot;squid&quot; snap name
is registered by
     other developers. To avoid name disputes, there're two options
     1. change
          $(localstatedir)/run/squid/sem.snap.squid.
         to
          $(localstatedir)/run/squid/sem.snap.squid-snap.
     2. make STATEDIR configurable so developer can customize it.
     I perfer the latter one.

&gt;<i>
</I>&gt;<i> &gt; Another concern is that even though we make DEFAULT_STATEDIR
</I>&gt;<i> &gt; configurable instead of introducing new option, STATEDIR, IPCDIR is not
</I>&gt;<i> &gt; suitable as end-user might specify the dir path for these options
</I>&gt;<i> however the
</I>&gt;<i> &gt; purpose of DEFAULT_IPC_PREFIX is only add prefix to shared memory file
</I>&gt;<i> name
</I>&gt;<i>
</I>&gt;<i> I am not sure I understand the above concern, but perhaps my suggestion
</I>&gt;<i> to ignore the path component (as needed) would address it?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;     AFAICT, DEFAULT_STATEDIR is also used for IPC communications in
</I>&gt;<i> &gt;&gt;     src/ipc/Port.cc. Your patch does not change that code. This means
</I>&gt;<i> that
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;     * either you forgot to change src/ipc/Port.cc to honor the new
</I>&gt;<i> &gt;&gt;     DEFAULT_IPC_PREFIX
</I>&gt;<i>
</I>&gt;<i> &gt; A: I will change src/ipc/Port.cc in the next commit once we reach an
</I>&gt;<i> &gt; agreement on the usage of compiler option.
</I>&gt;<i>
</I>&gt;<i> For Squid to work in a snap world, will you need the same
</I>&gt;<i> sem.snap.@{SNAP_NAME}. prefix for Unix Domain Sockets as for shared
</I>&gt;<i> memory segments?
</I>&gt;<i>
</I>&gt;<i> * If yes, then using a single option for both ipc/mem/Segment.cc and
</I>&gt;<i> ipc/Port.cc may work.
</I>&gt;<i>
</I>&gt;<i> * Otherwise, we would have to add two different options, one for shared
</I>&gt;<i> memory segment names and one for UDS names.
</I>&gt;<i>
</I>&gt;<i>    A: No, I don't need the same prefix for UDS names. As you said, we might
</I>       need two different options.

&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     * or src/ipc/Port.cc cannot use DEFAULT_IPC_PREFIX for some reason
</I>&gt;<i> (and,
</I>&gt;<i> &gt;     hence, DEFAULT_IPC_PREFIX is the wrong name because the parameter
</I>&gt;<i> does
</I>&gt;<i> &gt;     not apply to some of the IPC code).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; === modified file 'configure.ac &lt;<A HREF="http://configure.ac">http://configure.ac</A>&gt;'
</I>&gt;<i> &gt;     &gt; --- configure.ac &lt;<A HREF="http://configure.ac">http://configure.ac</A>&gt;      2017-01-28 03:54:15
</I>&gt;<i> +0000
</I>&gt;<i> &gt;     &gt; +++ configure.ac &lt;<A HREF="http://configure.ac">http://configure.ac</A>&gt;      2017-03-02 03:51:46
</I>&gt;<i> +0000
</I>&gt;<i> &gt;     &gt; @@ -311,6 +311,15 @@
</I>&gt;<i> &gt;     &gt;  ])
</I>&gt;<i> &gt;     &gt;  AC_SUBST(DEFAULT_SWAP_DIR)
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; +DEFAULT_IPC_PREFIX=&quot;&quot;
</I>&gt;<i> &gt;     &gt; +AC_ARG_WITH(ipcprefix,
</I>&gt;<i> &gt;     &gt; +  AS_HELP_STRING([--with-ipcprefix=NAME],
</I>&gt;<i> &gt;     &gt; +    [Default namespace prefix for shared memory object for ipc
</I>&gt;<i> &gt;     communication.
</I>&gt;<i> &gt;     &gt; +     Default is empty string and the share memory object name
</I>&gt;<i> &gt;     will be specified by squid. ]), [
</I>&gt;<i> &gt;     &gt; +   DEFAULT_IPC_PREFIX=&quot;$withval&quot;
</I>&gt;<i> &gt;     &gt; +])
</I>&gt;<i> &gt;     &gt; +AC_SUBST(DEFAULT_IPC_PREFIX)
</I>&gt;<i> &gt;     &gt; +
</I>&gt;<i> &gt;     &gt;  if test &quot;$squid_cv_compiler&quot; = &quot;gcc&quot;; then
</I>&gt;<i> &gt;     &gt;    GCCVER=`$CC -v 2&gt;&amp;1 | awk '$2 ==  &quot;version&quot; {print $3}'`
</I>&gt;<i> &gt;     &gt;    GCCVER2=`echo $GCCVER | awk '{print $1 * 100}'`
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; === modified file 'src/ipc/Makefile.am'
</I>&gt;<i> &gt;     &gt; --- src/ipc/Makefile.am       2017-01-01 00:16:45 +0000
</I>&gt;<i> &gt;     &gt; +++ src/ipc/Makefile.am       2017-03-02 03:51:46 +0000
</I>&gt;<i> &gt;     &gt; @@ -68,7 +68,7 @@
</I>&gt;<i> &gt;     &gt;       mem/Segment.cc \
</I>&gt;<i> &gt;     &gt;       mem/Segment.h
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; -DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> &gt;     &gt; +DEFS += -DDEFAULT_STATEDIR=\&quot;$(localstatedir)/run/squid\&quot;
</I>&gt;<i> &gt;     -DDEFAULT_IPC_PREFIX=\&quot;$(DEFAULT_IPC_PREFIX)\&quot;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;  install-data-local:
</I>&gt;<i> &gt;     &gt;       $(mkinstalldirs) $(DESTDIR)$(localstatedir)/run/squid;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; === modified file 'src/ipc/mem/Segment.cc'
</I>&gt;<i> &gt;     &gt; --- src/ipc/mem/Segment.cc    2017-01-01 00:16:45 +0000
</I>&gt;<i> &gt;     &gt; +++ src/ipc/mem/Segment.cc    2017-03-02 03:51:46 +0000
</I>&gt;<i> &gt;     &gt; @@ -30,6 +30,8 @@
</I>&gt;<i> &gt;     &gt;  #include &lt;unistd.h&gt;
</I>&gt;<i> &gt;     &gt;  #endif
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; +#define DEFAULT_SQUID_IPC_PREFIX  &quot;/&quot; DEFAULT_IPC_PREFIX
</I>&gt;<i> &gt;     &gt; +
</I>&gt;<i> &gt;     &gt;  // test cases change this
</I>&gt;<i> &gt;     &gt;  const char *Ipc::Mem::Segment::BasePath = DEFAULT_STATEDIR;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; @@ -229,9 +231,9 @@
</I>&gt;<i> &gt;     &gt;      if (nameIsPath) {
</I>&gt;<i> &gt;     &gt;          name.append(BasePath);
</I>&gt;<i> &gt;     &gt;          if (name[name.size()-1] != '/')
</I>&gt;<i> &gt;     &gt; -            name.append('/');
</I>&gt;<i> &gt;     &gt; +            name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i> &gt;     &gt;      } else {
</I>&gt;<i> &gt;     &gt; -        name.append('/');
</I>&gt;<i> &gt;     &gt; +        name.append(DEFAULT_SQUID_IPC_PREFIX);
</I>&gt;<i> &gt;     &gt;          name.append(service_name.c_str());
</I>&gt;<i> &gt;     &gt;          name.append('-');
</I>&gt;<i> &gt;     &gt;      }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Br
Gary.Wzl
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170315/7fef1db5/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170315/7fef1db5/attachment-0001.html</A>&gt;
</PRE>










































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008256.html">[squid-dev] To make squid works in snap world.
</A></li>
	<LI>Next message: <A HREF="008267.html">[squid-dev] To make squid works in snap world.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8258">[ date ]</a>
              <a href="thread.html#8258">[ thread ]</a>
              <a href="subject.html#8258">[ subject ]</a>
              <a href="author.html#8258">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
