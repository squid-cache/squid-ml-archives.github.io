<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fix ext_session_acl to handle - when no argument is passed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20ext_session_acl%20to%20handle%20-%20when%20no%0A%20argument%20is%20passed&In-Reply-To=%3Cc5d695ad-5255-bd5c-ed5f-90808b0485f5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008310.html">
   <LINK REL="Next"  HREF="008318.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fix ext_session_acl to handle - when no argument is passed</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20ext_session_acl%20to%20handle%20-%20when%20no%0A%20argument%20is%20passed&In-Reply-To=%3Cc5d695ad-5255-bd5c-ed5f-90808b0485f5%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Fix ext_session_acl to handle - when no argument is passed">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar 22 12:44:55 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008310.html">[squid-dev] [PATCH] Fix ext_session_acl to handle - when no	argument is passed
</A></li>
        <LI>Next message: <A HREF="008318.html">[squid-dev] [PATCH] Fix ext_session_acl to handle - when no argument is passed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8312">[ date ]</a>
              <a href="thread.html#8312">[ thread ]</a>
              <a href="subject.html#8312">[ subject ]</a>
              <a href="author.html#8312">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/03/2017 11:04 p.m., Trever L. Adams wrote:
&gt;<i> Amos,
</I>&gt;<i> 
</I>&gt;<i> Sure. I am using squid-4.0.17-1.fc25.x86_64. If you follow the
</I>&gt;<i> directions in <A HREF="http://wiki.squid-cache.org/ConfigExamples/Portal/Splash,">http://wiki.squid-cache.org/ConfigExamples/Portal/Splash,</A>
</I>&gt;<i> they do not work. This is because Squid is sending the following for query:
</I>&gt;<i> &quot;# IP -&quot; (I am using %SRC not %LOGIN, the example shows this, other uses
</I>&gt;<i> and examples use %LOGIN, which doesn't apply in my case.). The plugin
</I>&gt;<i> does not work because for this to work it would expect &quot;# IP - LOGIN&quot;
</I>&gt;<i> for the login. My patch addresses this by ignoring anything after the &quot;
</I>&gt;<i> &quot; if it doesn't match expected data.
</I>&gt;<i> 
</I>&gt;<i> I have done this by testing my directly calling ext_session_acl and strace.
</I>&gt;<i> 
</I>&gt;<i> The down side of the patch is it may break installations where people
</I>&gt;<i> are working around this by adding the - before the LOGIN in the acl
</I>&gt;<i> lines in their configuration.
</I>&gt;<i> 
</I>&gt;<i> I believe my patch applies to all versions of the tree on github
</I>&gt;<i> provided that the location is appropriate (the code doesn't seem to have
</I>&gt;<i> changed).
</I>
Ah. This is a side effect of the change to using logformat tokens. The
%DATA field is always present now.

We cannot simply ignore any value in the lastdetail field since when the
helper is in passive mode it might be part of the session ID.

At best we need the helper to check for the exact string &quot; -&quot; and drop
that if it occurs. That should be safe enough with both modes because an
empty last parameter will be a unique match in both anyway - it might as
well be missing as &quot; -&quot; string. The DB entry will be different from what
one might expect, but have a consistent value for passsive mode.

&gt;<i> 
</I>&gt;<i> If you can point me to the appropriate repository, I can redo the patch
</I>&gt;<i> if desired.
</I>
No need. With the above change I'm re-writing the fix entirely.

Are you able to test the below patch works for you?
it passes my basic tests.

Cheers
Amos

=== modified file 'src/acl/external/session/ext_session_acl.cc'
--- src/acl/external/session/ext_session_acl.cc 2017-01-01 00:12:22 +0000
+++ src/acl/external/session/ext_session_acl.cc 2017-03-22 12:41:55 +0000
@@ -193,41 +193,47 @@
         int action = 0;
         const char *channel_id = strtok(request, &quot; &quot;);
         char *detail = strtok(NULL, &quot;\n&quot;);
         if (detail == NULL) {
             // Only 1 paramater supplied. We are expecting at least 2
(including the channel ID)
             fprintf(stderr, &quot;FATAL: %s is concurrent and requires the
concurrency option to be specified.\n&quot;, program_name);
             shutdown_db();
             exit(1);
         }
         char *lastdetail = strrchr(detail, ' ');
         size_t detail_len = strlen(detail);
         if (lastdetail) {
             if (strcmp(lastdetail, &quot; LOGIN&quot;) == 0) {
                 action = 1;
                 detail_len = (size_t)(lastdetail-detail);
                 *lastdetail = '\0';
             } else if (strcmp(lastdetail, &quot; LOGOUT&quot;) == 0) {
                 action = -1;
                 detail_len = (size_t)(lastdetail-detail);
                 *lastdetail = '\0';
+            } else if (!default_action &amp;&amp; strcmp(lastdetail, &quot; -&quot;) == 0) {
+                // no action; LOGIN/LOGOUT not supplied
+                // but truncate the '-' %DATA value given by Squid-4
and later
+                detail_len = (size_t)(lastdetail-detail);
+                *lastdetail = '\0';
             }
+            // else do nothing
         }
         if (action == -1) {
             session_logout(detail, detail_len);
             printf(&quot;%s OK message=\&quot;Bye\&quot;\n&quot;, channel_id);
         } else if (action == 1) {
             session_login(detail, detail_len);
             printf(&quot;%s OK message=\&quot;Welcome\&quot;\n&quot;, channel_id);
         } else if (session_active(detail, detail_len)) {
             if (fixed_timeout == 0) {
                 session_login(detail, detail_len);
             }
             printf(&quot;%s OK\n&quot;, channel_id);
         } else if (default_action == 1) {
             session_login(detail, detail_len);
             printf(&quot;%s ERR message=\&quot;Welcome\&quot;\n&quot;, channel_id);
         } else {
             printf(&quot;%s ERR message=\&quot;No session available\&quot;\n&quot;,
channel_id);
         }
     }
     shutdown_db();


</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008310.html">[squid-dev] [PATCH] Fix ext_session_acl to handle - when no	argument is passed
</A></li>
	<LI>Next message: <A HREF="008318.html">[squid-dev] [PATCH] Fix ext_session_acl to handle - when no argument is passed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8312">[ date ]</a>
              <a href="thread.html#8312">[ thread ]</a>
              <a href="subject.html#8312">[ subject ]</a>
              <a href="author.html#8312">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
