<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [RFC] Do not use idle dead peers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Do%20not%20use%20idle%20dead%20peers&In-Reply-To=%3Cf80791f0-e199-eedb-8331-ef1d659241f3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008309.html">
   <LINK REL="Next"  HREF="008310.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [RFC] Do not use idle dead peers</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BRFC%5D%20Do%20not%20use%20idle%20dead%20peers&In-Reply-To=%3Cf80791f0-e199-eedb-8331-ef1d659241f3%40measurement-factory.com%3E"
       TITLE="[squid-dev] [RFC] Do not use idle dead peers">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 22 16:01:20 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008309.html">[squid-dev] [RFC] Do not use idle dead peers
</A></li>
        <LI>Next message: <A HREF="008310.html">[squid-dev] [PATCH] Fix ext_session_acl to handle - when no	argument is passed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8317">[ date ]</a>
              <a href="thread.html#8317">[ thread ]</a>
              <a href="subject.html#8317">[ subject ]</a>
              <a href="author.html#8317">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/21/2017 10:27 PM, Amos Jeffries wrote:
&gt;<i> On 22/03/2017 10:27 a.m., Alex Rousskov wrote:
</I>&gt;&gt;<i>     This Request For Comments proposes to remove a subtle Squid
</I>&gt;&gt;<i> (mis)feature. If you happen to use the corresponding feature, please
</I>&gt;&gt;<i> speak up to protect it! If nobody defends this feature, we may remove it
</I>&gt;&gt;<i> (in order to get rid of its bad side effects).
</I>

&gt;<i> FYI: fixing the probe
</I>&gt;<i> behaviour would be useful, complete removal is not an option (yet).
</I>
I suspect your &quot;not an option&quot; opinion is based on incorrect assumption
about what I propose to remove (it is not the probing!) and/or what
probes remain after the proposed changes (all of them remain unchanged!).


&gt;<i> From squid-users traffic is appears still quite common for
</I>&gt;<i> administrators to disable all of ICP, HTCP, netDB, digests, and ICMP.
</I>
Agreed.


&gt;<i> the probes in question are the only way of the peer to be
</I>&gt;<i> detected as alive again.
</I>
This is incorrect. TCP probes (which cannot be disabled) are the primary
mechanism for dead peer revival. I do not propose to remove them (or any
other probe). This RFC does not even propose to change them. TCP probes
are initiated in peerProbeConnect(). That function does not go anywhere;
at the end of this email, I have re-quoted the summary diff showing that
function call for your reference.


&gt;<i> IFAIK touching this feature will result in changes to what status code
</I>&gt;<i> and/or error page Squid produces.
</I>
Yes, an individual transaction outcome might change in some cases
(usually for the better). No, the set of possible status codes/errors
across all cases remains exactly the same as before the change. That set
will continue to contain &quot;cannot find a way to forward&quot; and various &quot;I
tried to forward but failed&quot; errors.


&gt;<i> It currently should (modulo bugs) result in connection-failed or timeout
</I>&gt;<i> types of final error going to the client as the victum requests actively
</I>&gt;<i> fail to be forwarded to the truely-dead peer.
</I>
Yes, for the first failure (or a few first concurrent failures) after
the dead peer becomes &quot;idle&quot;. After the first failure (with an idle dead
peer), the dead peer is no longer considered idle, and Squid stops using
it for a while (until the peer becomes idle again). To paraphrase the
current code:

  const time_t ctimeout = peerConnectTimeout(p);
  const bool thisDeadPeerIsIdle =
    (squid_curtime - p-&gt;stats.last_connect_failure) &gt; 10*ctimeout;


&gt;<i> After the change I would expect to see more being successful trnsactions
</I>&gt;<i> - but only in the presence of other live peers or DIRECT being
</I>&gt;<i> permitted.
</I>
Yes. The exact preconditions for &quot;more successful transactions&quot; are more
complex than summarized above, but I do not think those details are
important for this discussion.


&gt;<i> The ones which remain unsuccessful
</I>&gt;<i> no-forwarding-path errors since now no paths would be detected as usable.
</I>&gt;<i>  That remaining error case needs to be checked for exact status code and
</I>&gt;<i> how it impacts on caching hierarchies and retry logic.
</I>
The set of possible errors for unsuccessful transactions does not
change: Some will try to connect and fail (because the peer died after
it was selected), and some will fail because there is still no
forwarding path left (because all peers are dead). Only the number of
each error in specific use cases may change, and even that change in
numbers should be minor in most use cases because only the first failure
(or the first few concurrent failures) when talking to an idle dead peer
are affected.


&gt;<i> Since the proposed change is so small has any of that behaviour been
</I>&gt;<i> tested already?
</I>
The change has not been implemented or tested (I would have posted a
PATCH instead of an RFC if it were), but the expected behavior already
happens everyday in unpatched Squid.


&gt;<i> Other possibilities (if we have to) would be;
</I>&gt;<i>  a) to flag the situation in the FwdServer object used to construct the
</I>&gt;<i> destination list and ensure these peers are put as absolute last-resort
</I>&gt;<i> destinations instead of where they would normally be placed.
</I>
IMO, it is conceptually wrong to use dead peers just because they are
&quot;idle&quot;. While we can indeed add dead peers as &quot;last resort&quot;, doing so
should not depend on the dead peer being &quot;idle&quot;. Thus, this kind of
feature is outside this RFC scope (but it will become easier to
implement if the proposed change is committed).


&gt;<i> Or maybe simpler;
</I>&gt;<i>  b) a new peer select algorithm to find only this type of peer and add
</I>&gt;<i> them only if all other algorithms fail to produce a list.
</I>
Yes, this is how the &quot;use dead peers as last resort&quot; idea in (a) should
be implemented if it is implemented. It is outside this RFC scope though.


&gt;&gt;<i> Does anybody need this &quot;use idle dead peers&quot; feature?
</I>
&gt;<i> I expect everyone who has explicitly disabled all other types of
</I>&gt;<i> peer-ALIVE detection and where never_direct forbids bypassing the peer.
</I>
Does the fact that TCP checks cannot be disabled and remain the primary
way of reviving dead peers change your answer?


Thank you,

Alex.


&gt;<i>  /// OK to add this peer to the list of possible request destinations?
</I>&gt;<i>  bool
</I>&gt;<i>  neighborUp(const CachePeer *p)
</I>&gt;<i>  {
</I>&gt;<i>      if (!p-&gt;tcp_up) { // the peer is DEAD
</I>&gt;<i> -        if (!peerProbeConnect(p))
</I>&gt;<i> +        peerProbeConnect(p);
</I>&gt;<i>              return false;
</I>&gt;<i>      }
</I>&gt;<i>  
</I>&gt;<i>      if (p-&gt;options.no_query)
</I>&gt;<i>          return true; // yes, add this peer
</I>

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008309.html">[squid-dev] [RFC] Do not use idle dead peers
</A></li>
	<LI>Next message: <A HREF="008310.html">[squid-dev] [PATCH] Fix ext_session_acl to handle - when no	argument is passed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8317">[ date ]</a>
              <a href="thread.html#8317">[ thread ]</a>
              <a href="subject.html#8317">[ subject ]</a>
              <a href="author.html#8317">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
