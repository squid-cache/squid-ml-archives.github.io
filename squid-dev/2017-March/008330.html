<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20on_unsupported_protocol%20rewrite%20to%20support%20tcp%0A%09connection%2C%20relay&In-Reply-To=%3Ctencent_6D1963DE3C849E556AB06803%40qq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008329.html">
   <LINK REL="Next"  HREF="008331.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay</H1>
    <B>钱国正</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20on_unsupported_protocol%20rewrite%20to%20support%20tcp%0A%09connection%2C%20relay&In-Reply-To=%3Ctencent_6D1963DE3C849E556AB06803%40qq.com%3E"
       TITLE="[squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay">richard.qian at magicwifi.com.cn
       </A><BR>
    <I>Mon Mar 27 06:35:18 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008329.html">[squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay
</A></li>
        <LI>Next message: <A HREF="008331.html">[squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8330">[ date ]</a>
              <a href="thread.html#8330">[ thread ]</a>
              <a href="subject.html#8330">[ subject ]</a>
              <a href="author.html#8330">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>If you want port 80 to just be relayed through - dont send it to Squid.
</I>
&gt;<i>You will probably be able to identify the DNS packets with your firewall
</I>&gt;<i>rules easier than Squid can tell it apart from a mangled HTTP message.
</I>


What I want to do is to use Squid ecap adaptation to modify some http response.
But during the running time, I found that some famous mobile app using 80 port
transport some unknown protocol (not http).


What if the protocol is not http, but using 80 port, can squid relay it to its target server?




 
 
 
------------------ Original ------------------
From:  &quot;Amos Jeffries&quot;&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt;;
Date:  Mon, Mar 27, 2017 11:59 AM
To:  &quot;钱国正&quot;&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">richard.qian at magicwifi.com.cn</A>&gt;; &quot;squid-dev&quot;&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>&gt;; 

Subject:  Re: on_unsupported_protocol rewrite to support tcp connection, relay

 
On 27/03/2017 3:15 p.m., 钱国正 wrote:
&gt;&gt;&gt;<i> I want to know what's the
</I>&gt;&gt;&gt;<i> pinning.serverConnection mean? and what it is used for?
</I>&gt;<i> 
</I>&gt;&gt;<i> Before we dive into low-level details, please allow me to ask an
</I>&gt;&gt;<i> important high-level question. Your answer may render those low-level
</I>&gt;&gt;<i> detail irrelevant:
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I want to rewrite the on_unsupported_protocol to support tcp connection
</I>&gt;&gt;&gt;<i> (non-http protocol, called httpdns not readable, no http header) and
</I>&gt;&gt;&gt;<i> relay it the server. [...] I need assign the server's address and port
</I>&gt;<i> 
</I>&gt;&gt;<i> Where will your code get the server address and port from? If the answer
</I>&gt;&gt;<i> is &quot;from the received httpdns message header&quot;, then please do not abuse
</I>&gt;&gt;<i> on_unsupported_protocol to support &quot;httpdns&quot;. Instead, add proper
</I>&gt;&gt;<i> support for httpdns (which may be limited to forwarding httpdns queries
</I>&gt;&gt;<i> to the right server if such blind forwarding makes sense).
</I>&gt;<i> 
</I>&gt;<i> No, I got it from `clientConnection-&gt;local`, the httpdns is just a tcp connection to server with
</I>&gt;<i> specified protocol, not known to me, it is designed by its user, use 80 port to transfer dns request.
</I>&gt;<i> 
</I>
If you want port 80 to just be relayed through - dont send it to Squid.

You will probably be able to identify the DNS packets with your firewall
rules easier than Squid can tell it apart from a mangled HTTP message.


&gt;&gt;<i> BTW, can you post a link to the &quot;httpdns&quot; protocol specification (not
</I>&gt;&gt;<i> API)? And what do you mean by &quot;not readable&quot;?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It is not a standard protocol in RFC or some standard specification, just some company use 
</I>&gt;<i> 80 (default for http protocol) port to transfer dns request, they do this because in China many 
</I>&gt;<i> ISP would use they own dns server in different places which makes it slow 
</I>&gt;<i> or unreachable to the some company's service.
</I>&gt;<i> 
</I>
Then please stop calling it &quot;httpdns&quot;. It is &quot;DNS&quot;. Calling it &quot;httpdns&quot;
implies some relationship to HTTP other than just stealing the port number.

There is actually a protocol called HTTPDNS being designed
(&lt;<A HREF="https://tools.ietf.org/html/draft-ietf-dnsop-dns-wireformat-http-00">https://tools.ietf.org/html/draft-ietf-dnsop-dns-wireformat-http-00</A>&gt;).
Squid supports relaying that already because it uses real HTTP messages
on port 80.

Amos
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170327/51adb759/attachment-0001.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170327/51adb759/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008329.html">[squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay
</A></li>
	<LI>Next message: <A HREF="008331.html">[squid-dev] on_unsupported_protocol rewrite to support tcp	connection, relay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8330">[ date ]</a>
              <a href="thread.html#8330">[ thread ]</a>
              <a href="subject.html#8330">[ subject ]</a>
              <a href="author.html#8330">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
