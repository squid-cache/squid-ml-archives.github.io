<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related checks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20configure.ac%20cleanup%20of%20BerkleyDB%20related%20checks&In-Reply-To=%3C3c391550-e509-7d89-d381-7d73cf0e9acb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008328.html">
   <LINK REL="Next"  HREF="008333.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related checks</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20configure.ac%20cleanup%20of%20BerkleyDB%20related%20checks&In-Reply-To=%3C3c391550-e509-7d89-d381-7d73cf0e9acb%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related checks">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Mar 27 13:57:46 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008328.html">[squid-dev] Squid-4 status update
</A></li>
        <LI>Next message: <A HREF="008333.html">[squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related	checks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8332">[ date ]</a>
              <a href="thread.html#8332">[ thread ]</a>
              <a href="subject.html#8332">[ subject ]</a>
              <a href="author.html#8332">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>While looking into the last remaining bits of bug 4610 I have found that
most of what we were doing for libdb / -ldb is not necessary any longer.

Most of the logic seems to be hangovers from when session helper was
using the BerkleyDB v1.85 compatibility interface. Some of it is
possibly still necessary for the time_quota helper, but that helper has
not been using it so far and needs an upgrade to match what happened to
session helper.

Changes:

* The helpers needing -ldb will not be built unless the library and
headers are available. So we can drop the Makefile LIB_DB substitutions
and always just link -ldb explicitly to these helpers.

NP: Anyone who needs small minimal binaries, can build with the
--as-needed linker flag, or without these helpers. This change has no
effect on other helpers or the main squid binary.

* Since we no longer need to check if -ldb is necessary, we can drop the
configure.ac and acinclude logic detecting that.

* Remove unused AC_CHECK_DECL(dbopen, ...)
 - resolves one &quot;FIXME&quot;

* Fix the time_quota helper check to only scan db.h header file contents
if that file is existing, and if the db_185.h file is not being used
instead.

* Fix the session helper check to only try compiling with the db.h
header if that header actually exists.

* De-duplicate the library header file detection shared by configure.ac
and the helpers required.m4 files (after the above two changes).

* Remove unused DBLIB variable from configure.ac.

Amos

-------------- next part --------------
=== modified file 'acinclude/lib-checks.m4'
--- acinclude/lib-checks.m4	2017-01-01 00:12:22 +0000
+++ acinclude/lib-checks.m4	2017-03-27 12:39:53 +0000
@@ -1,54 +1,27 @@
 ## Copyright (C) 1996-2017 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
-dnl checks whether dbopen needs -ldb to be added to libs
-dnl sets ac_cv_dbopen_libdb to either &quot;yes&quot; or &quot;no&quot;
-
-AC_DEFUN([SQUID_CHECK_DBOPEN_NEEDS_LIBDB],[
-  AC_CACHE_CHECK(if dbopen needs -ldb,ac_cv_dbopen_libdb, [
-    SQUID_STATE_SAVE(dbopen_libdb)
-    LIBS=&quot;$LIBS -ldb&quot;
-    AC_LINK_IFELSE([AC_LANG_PROGRAM([[
-#if HAVE_SYS_TYPES_H
-#include &lt;sys/types.h&gt;
-#endif
-#if HAVE_LIMITS_H
-#include &lt;limits.h&gt;
-#endif
-#if HAVE_DB_185_H
-#include &lt;db_185.h&gt;
-#elif HAVE_DB_H
-#include &lt;db.h&gt;
-#endif]], 
-[[dbopen(&quot;&quot;, 0, 0, DB_HASH, (void *)0L)]])],
-    [ac_cv_dbopen_libdb=&quot;yes&quot;],
-    [ac_cv_dbopen_libdb=&quot;no&quot;])
-    SQUID_STATE_ROLLBACK(dbopen_libdb)
-  ])
-])
-
-
 dnl check whether regex works by actually compiling one
 dnl sets squid_cv_regex_works to either yes or no
 
 AC_DEFUN([SQUID_CHECK_REGEX_WORKS],[
   AC_CACHE_CHECK([if the system-supplied regex lib actually works],squid_cv_regex_works,[
     AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
 #if HAVE_SYS_TYPES_H
 #include &lt;sys/types.h&gt;
 #endif
 #if HAVE_REGEX_H
 #include &lt;regex.h&gt; 
 #endif
 ]], [[
 regex_t t; regcomp(&amp;t,&quot;&quot;,0);]])],
     [ squid_cv_regex_works=yes ],
     [ squid_cv_regex_works=no ])
   ])
 ])
 
 

=== modified file 'configure.ac'
--- configure.ac	2017-01-13 05:14:03 +0000
+++ configure.ac	2017-03-27 12:16:04 +0000
@@ -2794,42 +2794,40 @@
   sys/shm.h \
   sys/socket.h \
   sys/stat.h \
   syscall.h \
   sys/syscall.h \
   sys/time.h \
   sys/types.h \
   sys/uio.h \
   sys/un.h \
   sys/vfs.h \
   sys/wait.h \
   syslog.h \
   time.h \
   unistd.h \
   utime.h \
   varargs.h \
   byteswap.h \
   glib.h \
   stdint.h \
   inttypes.h \
-  db.h \
-  db_185.h \
   wchar.h
 )
 
 AC_CHECK_HEADERS( \
   linux/netfilter_ipv4.h \
   linux/netfilter_ipv6/ip6_tables.h \
 ,,,
 SQUID_DEFAULT_INCLUDES
 #if HAVE_LIMITS_H
 #include &lt;limits.h&gt;
 #endif
 /* Netfilter ip(6)tables v1.4.0 has broken headers */
 #if HAVE_NETINET_IN_H
 #include &lt;netinet/in.h&gt;
 #endif
 )
 
 dnl *BSD dont include the dependencies for all their net/ and netinet/ files
 dnl We must include a few basic type headers for them to work.
 AC_CHECK_HEADERS( \
@@ -3129,66 +3127,40 @@
   SQUID_CHECK_SIN6_LEN_IN_SAI
 fi
 SQUID_CHECK_SS_LEN_IN_SOCKADDR_STORAGE
 SQUID_CHECK_SIN_LEN_IN_SOCKADDR_IN
 
 
 dnl Check for libdl, used by auth_modules/PAM
 if test &quot;x$with_dl&quot; = &quot;xyes&quot;; then
     AC_CHECK_LIB(dl, dlopen)
 fi
 
 dnl -lintl is needed on SCO version 3.2v4.2 for strftime()
 dnl Robert Side &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rside at aiinc.bc.ca</A>&gt;
 dnl Mon, 18 Jan 1999 17:48:00 GMT
 case &quot;$host&quot; in
 	*-pc-sco3.2*)
 		AC_CHECK_LIB(intl, strftime)
 		;;
 esac
 
-dnl Check for libdb
-dnl this is not fully functional if db.h is for a differend db version
-DBLIB=
-
-dnl check that dbopen is actually defined in the header
-dnl FIXME: in case of failure undef db-related includes etc.
-AC_CHECK_DECL(dbopen,,,[
-#if HAVE_SYS_TYPES_H
-#include &lt;sys/types.h&gt;
-#endif
-#if HAVE_LIMITS_H
-#include &lt;limits.h&gt;
-#endif
-#if HAVE_DB_185_H
-#include &lt;db_185.h&gt;
-#elif HAVE_DB_H
-#include &lt;db.h&gt;
-#endif])
-
-dnl 1.85
-SQUID_CHECK_DBOPEN_NEEDS_LIBDB
-if test &quot;x$ac_cv_dbopen_libdb&quot; = &quot;xyes&quot;; then
-    LIB_DB=&quot;-ldb&quot;
-fi
-AC_SUBST(LIB_DB)
-
 dnl System-specific library modifications
 dnl
 case &quot;$host&quot; in
   i386-*-solaris2.*)
     if test &quot;x$GCC&quot; = &quot;xyes&quot;; then
       AC_MSG_NOTICE([Removing -O for gcc on $host])
       CFLAGS=&quot;`echo $CFLAGS | sed -e 's/-O[[0-9g]]*//'`&quot;
     fi
   ;;
 
   *-sgi-irix*)
     AC_MSG_NOTICE([Removing -lsocket for IRIX...])
     LIBS=`echo $LIBS | sed -e s/-lsocket//`
     AC_MSG_NOTICE([Removing -lnsl for IRIX...])
     LIBS=`echo $LIBS | sed -e s/-lnsl//`
     ac_cv_lib_nsl_main=no
     AC_MSG_NOTICE([Removing -lbsd for IRIX...])
     LIBS=`echo $LIBS | sed -e s/-lbsd//`
   ;;
 dnl From: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">c0032033 at ws.rz.tu-bs.de</A> (Joerg Schumacher)

=== modified file 'src/acl/external/session/Makefile.am'
--- src/acl/external/session/Makefile.am	2017-01-01 00:12:22 +0000
+++ src/acl/external/session/Makefile.am	2017-03-27 12:38:33 +0000
@@ -1,19 +1,19 @@
 ## Copyright (C) 1996-2017 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
 include $(top_srcdir)/src/Common.am
 
 libexec_PROGRAMS= ext_session_acl
 man_MANS= ext_session_acl.8
 
 ext_session_acl_SOURCES= \
 	ext_session_acl.cc
 ext_session_acl_LDADD = \
 	$(COMPAT_LIB) \
-	$(LIB_DB)
+	-ldb
 
 EXTRA_DIST= ext_session_acl.8 required.m4

=== modified file 'src/acl/external/session/required.m4'
--- src/acl/external/session/required.m4	2017-01-01 00:12:22 +0000
+++ src/acl/external/session/required.m4	2017-03-27 12:41:08 +0000
@@ -1,8 +1,15 @@
 ## Copyright (C) 1996-2017 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
-AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include &lt;db.h&gt;]],[[DB_ENV *db_env = NULL; db_env_create(&amp;db_env, 0);]])],[BUILD_HELPER=&quot;session&quot;],[])
+AC_CHECK_HEADERS(db.h,[
+  AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include &lt;db.h&gt;]],[[
+    DB_ENV *db_env = nullptr;
+    db_env_create(&amp;db_env, 0);
+  ]])],[
+    BUILD_HELPER=&quot;session&quot;
+  ],[])
+])

=== modified file 'src/acl/external/time_quota/Makefile.am'
--- src/acl/external/time_quota/Makefile.am	2017-01-01 00:12:22 +0000
+++ src/acl/external/time_quota/Makefile.am	2017-03-27 12:40:40 +0000
@@ -1,21 +1,21 @@
 ## Copyright (C) 1996-2017 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
 include $(top_srcdir)/src/Common.am
 
 libexec_PROGRAMS= ext_time_quota_acl
 man_MANS= ext_time_quota_acl.8
 
 DEFS += -DDEFAULT_QUOTA_DB=\&quot;$(localstatedir)/ext_time_quota.db\&quot;
 
 ext_time_quota_acl_SOURCES= \
 	ext_time_quota_acl.cc
 ext_time_quota_acl_LDADD = \
 	$(COMPAT_LIB) \
-	$(LIB_DB)
+	-ldb
 
 EXTRA_DIST= ext_time_quota_acl.8 required.m4

=== modified file 'src/acl/external/time_quota/required.m4'
--- src/acl/external/time_quota/required.m4	2017-01-01 00:12:22 +0000
+++ src/acl/external/time_quota/required.m4	2017-03-27 12:39:29 +0000
@@ -1,9 +1,12 @@
 ## Copyright (C) 1996-2017 The Squid Software Foundation and contributors
 ##
 ## Squid software is distributed under GPLv2+ license and includes
 ## contributions from numerous individuals and organizations.
 ## Please see the COPYING and CONTRIBUTORS files for details.
 ##
 
-AC_CHECK_HEADERS([db_185.h],[BUILD_HELPER=&quot;time_quota&quot;])
-AC_EGREP_HEADER([dbopen],[/usr/include/db.h],[BUILD_HELPER=&quot;time_quota&quot;])
+AC_CHECK_HEADERS(db_185.h,[BUILD_HELPER=&quot;time_quota&quot;],[
+  AC_CHECK_HEADERS(db.h,[
+    AC_EGREP_HEADER([dbopen],[/usr/include/db.h],[BUILD_HELPER=&quot;time_quota&quot;])
+  ])
+])

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008328.html">[squid-dev] Squid-4 status update
</A></li>
	<LI>Next message: <A HREF="008333.html">[squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related	checks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8332">[ date ]</a>
              <a href="thread.html#8332">[ thread ]</a>
              <a href="subject.html#8332">[ subject ]</a>
              <a href="author.html#8332">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
