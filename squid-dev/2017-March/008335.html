<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Second adaptation missing for CONNECTs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Second%20adaptation%20missing%20for%20CONNECTs&In-Reply-To=%3Cfb0c8d8c-6651-bdcd-8b53-dad5e872013c%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008334.html">
   <LINK REL="Next"  HREF="008336.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Second adaptation missing for CONNECTs</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Second%20adaptation%20missing%20for%20CONNECTs&In-Reply-To=%3Cfb0c8d8c-6651-bdcd-8b53-dad5e872013c%40chtsanti.net%3E"
       TITLE="[squid-dev] [PATCH] Second adaptation missing for CONNECTs">christos at chtsanti.net
       </A><BR>
    <I>Fri Mar 31 13:21:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008334.html">[squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related	checks
</A></li>
        <LI>Next message: <A HREF="008336.html">[squid-dev] Build failed in Jenkins: template-full-matrix » clang,rs-fbsd-10 #314
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8335">[ date ]</a>
              <a href="thread.html#8335">[ thread ]</a>
              <a href="subject.html#8335">[ subject ]</a>
              <a href="author.html#8335">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

Squid does not send CONNECT request to adaptation services if the 
&quot;ssl_bump splice&quot; rule matched at step 2. This adaptation is important 
because the CONNECT request gains SNI information during the second 
SslBump step. This is a regression bug, possibly caused by the Squid bug 
4529 fix (trunk commits r14913 and r14914).

Notes
=====

Transparent interception vs normal proxy
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   For transparent CONNECT requests, the second request sent to the 
adaptation service (and url-rewriter etc), uses the SNI name as hostname 
in request url and Host header. This is is not true for normal CONNECT 
requests.

However the user still is able to gain SNI information using 
adaptation_meta. For example the following configuration line:

     adaptation_meta X-SNI-Info &quot;%ssl::&gt;sni&quot; all

Will send the SNI info using the X-SI-Info header to the ICAP service.


Avoid sending second CONNECT request to adaptation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The users may not want to send the second request to the adaptation 
services. In this case they can use acls as follows:

acl step1 at_step  SslBump1
acl step2 at_step  SslBump2
acl markSpliced annotate_client spliced=true

ssl_bump peek step1
ssl_bump splice step2 markSpliced

acl markedSpliced note spliced true

adaptation_access class_reqmodifing deny markSpliced
adaptation_access class_reqmodifing allow all




This is a Measurement Factory project.


-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-289-Second-adaptation-missing-for-CONNECTS-t4.patch
Type: text/x-patch
Size: 7193 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170331/179ec299/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170331/179ec299/attachment.bin</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008334.html">[squid-dev] [PATCH] configure.ac cleanup of BerkleyDB related	checks
</A></li>
	<LI>Next message: <A HREF="008336.html">[squid-dev] Build failed in Jenkins: template-full-matrix » clang,rs-fbsd-10 #314
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8335">[ date ]</a>
              <a href="thread.html#8335">[ thread ]</a>
              <a href="subject.html#8335">[ subject ]</a>
              <a href="author.html#8335">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
