<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] xstrndup has to go
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20xstrndup%20has%20to%20go&In-Reply-To=%3Cddf6de0d-efb3-ffe2-16d5-80e7c0140da7%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008560.html">
   <LINK REL="Next"  HREF="008655.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] xstrndup has to go</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20xstrndup%20has%20to%20go&In-Reply-To=%3Cddf6de0d-efb3-ffe2-16d5-80e7c0140da7%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] xstrndup has to go">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon May  1 17:40:18 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008560.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
        <LI>Next message: <A HREF="008655.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8563">[ date ]</a>
              <a href="thread.html#8563">[ thread ]</a>
              <a href="subject.html#8563">[ subject ]</a>
              <a href="author.html#8563">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/30/2017 11:26 PM, Amos Jeffries wrote:
&gt;<i> On 30/04/17 04:17, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 04/29/2017 02:33 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If that is too hard, making callers do the allocate bit themselves and
</I>&gt;&gt;&gt;<i> xstrncpy() instead should be a good medium-term workaround.
</I>&gt;&gt;<i> In general, it is impossible to correctly replace strndup() with a
</I>&gt;&gt;<i> simple allocate and strncpy() pair. I bet this impossibility is why
</I>&gt;&gt;<i> strndup() exists! strndup() is not a convenience function, but an
</I>&gt;&gt;<i> irreplaceable tool in a performance toolbox.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why is it impossible in general? Because you do not know how many bytes
</I>&gt;&gt;<i> to allocate (that number may be much smaller than n) and you cannot use
</I>&gt;&gt;<i> strlen() to find out because the array may not be 0-terminated. You need
</I>&gt;&gt;<i> strnlen(), which is usually not available where strndup() is not.
</I>
&gt;<i> We don't need to solve the general case. 
</I>
By &quot;general&quot;, I meant &quot;an average or typical use case in Squid code&quot;.
Some callers can probably allocate correctly for themselves, but some
cannot (or will break after surrounding code changes). The need for
strndup() is genuine and will remain for the foreseeable future.


&gt;&gt;&gt;&gt;<i> P.S. The OutOfBoundsException use case code fixed by this patch needs a
</I>&gt;&gt;&gt;&gt;<i> different fix (the one that does not allocate memory twice):
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>     xstrndup(explanatoryText.rawContent(), explanatoryText.length());
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> but we cannot do the above until xstrndup() implementation is fixed.
</I>&gt;&gt;&gt;<i> Not even by moving that caller to xmalloc() for itself and use
</I>&gt;&gt;&gt;<i> xstrncpy() ?
</I>
&gt;&gt;<i> xmalloc()+xstrncpy() is not &quot;doing the above&quot; it is doing something
</I>&gt;&gt;<i> else. I only claimed that we &quot;cannot do the above&quot; (literally). There
</I>&gt;&gt;<i> are other ways to achieve the same result, of course. None of those
</I>&gt;&gt;<i> other ways that I can think of (in the current code context) are better
</I>&gt;&gt;<i> than the proposed double-copy IMO.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sure, it is possible to do xmalloc()+memcpy() in this context instead of
</I>&gt;&gt;<i> xstrndup(), but, in this context, that would be arguably worse than
</I>&gt;&gt;<i> copying twice because it would replace a clear high-level code with
</I>&gt;&gt;<i> risky low-level manipulations on an error handling path.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If strdup(buf.c_str()) pattern appears often, we should add
</I>&gt;&gt;<i> SBuf::c_str_dup() that does xmalloc()+memcpy().
</I>
&gt;<i> strdup != strndup.
</I>
I know. I meant exactly what I said -- &quot;strdup&quot; (and &quot;If&quot;).


&gt;<i> My question was about that one use-case you highlighted as example, not
</I>&gt;<i> the general solution.
</I>
I know. I believe I have answered your question -- yes, we can xmalloc()
and strncpy() in that case, but we do not want to do that.

And it was not highlighted as an &quot;example&quot;. I mentioned it (in P.S.!)
only because the current fix there looks wrong and is slow. I wanted to
avoid a discussion of why I could not write a more efficient code there.
I naturally regret mentioning that at all now!


&gt;<i> over-allocation is not a huge problem
</I>&gt;<i> and whatever exception handler catches this will end with deallocation
</I>&gt;<i> quite quickly.
</I>
Agreed. We should not do xmalloc+strncpy there because we should not
replace a clear high-level code with risky low-level manipulations on an
error handling path. Overallocation is not a problem in this case.


&gt;<i> If this exception handler is stable enough now to be worth optimizing 
</I>
OT: In general, exception handlers performance is not a primary concern
because exceptions should not be used for something that is expected to
happen very often on a performance-sensitive path.


Cheers,

Alex.

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008560.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
	<LI>Next message: <A HREF="008655.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8563">[ date ]</a>
              <a href="thread.html#8563">[ thread ]</a>
              <a href="subject.html#8563">[ subject ]</a>
              <a href="author.html#8563">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
