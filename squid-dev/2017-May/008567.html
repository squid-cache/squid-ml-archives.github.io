<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] A new 'has' ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20A%20new%20%27has%27%20ACL&In-Reply-To=%3Ceddbbe00-1ab2-0d18-1b24-c1b2287c9c1d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008566.html">
   <LINK REL="Next"  HREF="008560.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] A new 'has' ACL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20A%20new%20%27has%27%20ACL&In-Reply-To=%3Ceddbbe00-1ab2-0d18-1b24-c1b2287c9c1d%40measurement-factory.com%3E"
       TITLE="[squid-dev] A new 'has' ACL">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue May  2 23:41:54 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008566.html">[squid-dev] A new 'has' ACL
</A></li>
        <LI>Next message: <A HREF="008560.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8567">[ date ]</a>
              <a href="thread.html#8567">[ thread ]</a>
              <a href="subject.html#8567">[ subject ]</a>
              <a href="author.html#8567">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>N.B. The discussion from here until the &quot;----&quot; marker is probably
unimportant because you later seem to confirm that &quot;has ALE&quot; is needed.
I am preserving this discussion in case I misjudged your confirmation
and/or in case this discussion will help resolve the remaining confusion
(after the marker).

On 05/02/2017 04:18 PM, Eduard Bagdasaryan wrote:
&gt;<i> On 02.05.2017 23:53, Alex Rousskov wrote:
</I>&gt;&gt;<i> AFAICT, r14752 deals with transactions originated by client requests and
</I>&gt;&gt;<i> broken client connections. Even if all those transactions are fully
</I>&gt;&gt;<i> covered, there are other transactions (e.g., ESI and Downloader
</I>&gt;&gt;<i> requests) that may or may not be covered (and seem to be completely
</I>&gt;&gt;<i> unrelated to r14752 changes!). Is there some kind of common interface
</I>&gt;&gt;<i> that essentially requires all transactions to have ALE now?
</I>
&gt;<i> I have not found any ALE manipulations inside ESI and Downloader
</I>&gt;<i> code, so that is probably unrelated.
</I>
Not sure I understand. Are you implying that Squid-initiated
transactions can never evaluate an ACL that requires ALE? Consider a
Downloader job that initiates a transaction which attempts to access
Squid cache, evaluating various caching directives, some of which may
use an external ACL that needs an ALE. If that code does not give
FilledChecklist an ALE, the admin will see warnings that &quot;has ALE&quot; is
meant to work around.

(The Downloader is used above as an example of a Squid-initiated
transaction -- I am not claiming that Downloader lacks ALE; based on
your research it does have ALE. This example illustrates that
transaction initiator code does not need to explicitly manipulate ALE to
trigger ALE-related ACL checks down the road).


&gt;<i> ClientHttpRequest is the object used in transactions,
</I>
Do all transactions (that may use ACLs) create a corresponding
ClientHttpRequest object? Downloader does. I do not think ESI does; it
seems to keep a link to the HTTP ClientHttpRequest object but I do not
know how that is used when it comes to ESI-triggered ACL checks. There
are also ICP/HTCP transactions, eCAP/ICAP transactions, netdb exchanges,
and Cache Digest transactions. There may be others. At least some of
them use ACLs or trigger ACLs use elsewhere.


&gt;<i> (including
</I>&gt;<i> Downloader and ESI code). This object owns its ALE, which is
</I>&gt;<i> created in the constructor. I have not found 'common interface'
</I>&gt;<i> you are talking about, but if all Squid transactions require
</I>&gt;<i> ClientHttpRequest object (which is probably true)
</I>
Why do you think it is probably true? What makes ClientHttpRequest
required for any code that might use ACLs?


&gt;<i> then they surely will have the corresponding ALE.
</I>
Even if that is true, &quot;having&quot; ALE and &quot;supplying every FilledChecklist
with ALE&quot; are two different things, right? Can we be sure that all that
code configures FilledChecklist with ALE?

To avoid misunderstanding, these are genuine questions -- I really do
not know the answers. I want to drop &quot;has ALE&quot; support, but you have not
convinced me that we can do that right now.


&gt;&gt;<i> &quot;The current ACL-driven code may feed an ACLFilledChecklist object
</I>&gt;&gt;<i> without ALE to an (ACLExternal) ACL that requires ALE.&quot;
</I>
&gt;<i> Yes.
</I>
OK, so you confirm that there is a problem and the remaining question is
whether we can fix it quickly (and drop &quot;has ALE&quot;).


&gt;&gt;<i> The question is whether we can &quot;fix this&quot; (i.e., guarantee correct ALE
</I>&gt;&gt;<i> presence when ALE is needed) _quickly_.
</I>
&gt;<i> I agree that it is possible large project, because I am not
</I>&gt;<i> sure that every ACL checking context have its ALE near at hand.
</I>
OK, so we keep &quot;has ALE&quot;.

Marker: --------


&gt;<i> ... and have our new 'has' ACL broken from the very beginning too.
</I>&gt;<i> As I tried to explain earlier, how can we rely on
</I>&gt;<i> ACLFilledChecklist::hasAle(), if the ALE itself have not been provided to
</I>&gt;<i> ACLFilledChecklist before?
</I>
I do not understand your concern. If ALE has not been provided to
ACLFilledChecklist, then ACLFilledChecklist::hasAle() returns false and
our &quot;has ALE&quot; ACL does not match, allowing the admin to avoid the
warning about the missing ALE while making sure her ACL-driven
directives do what they are supposed to do, even though there is no ALE.
Is not that exactly what we want? What &quot;breakage&quot; do you anticipate with
&quot;has ALE&quot;?

For example, before/without &quot;has ALE&quot;, the following directive might
produce numerous warnings and wrong Squid behavior in environments where
Squid evaluates store_miss for transactions that did not supply ALE to
FilledChecklist:

    store_miss deny foo

With &quot;has ALE&quot; in her toolbox, the admin can work around the problem:

    # option 1: store misses when ALE is missing
    store_miss allow !hasAle
    store_miss deny foo

    # option 2: do not store misses when ALE is missing
    store_miss deny !hasAle
    store_miss deny foo

(the choice is up to the admin -- we do not know what is the right
workaround in her environment)


Thank you,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008566.html">[squid-dev] A new 'has' ACL
</A></li>
	<LI>Next message: <A HREF="008560.html">[squid-dev] [PATCH] xstrndup has to go
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8567">[ date ]</a>
              <a href="thread.html#8567">[ thread ]</a>
              <a href="subject.html#8567">[ subject ]</a>
              <a href="author.html#8567">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
