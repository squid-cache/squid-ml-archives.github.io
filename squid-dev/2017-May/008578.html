<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Do not revive unconditionally dead peers after DNS refresh
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20revive%20unconditionally%20dead%20peers%0A%20after%20DNS%20refresh&In-Reply-To=%3C7319b015-d356-3d63-952a-7d35b66a73ea%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008597.html">
   <LINK REL="Next"  HREF="008606.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Do not revive unconditionally dead peers after DNS refresh</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20revive%20unconditionally%20dead%20peers%0A%20after%20DNS%20refresh&In-Reply-To=%3C7319b015-d356-3d63-952a-7d35b66a73ea%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Do not revive unconditionally dead peers after DNS refresh">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri May  5 21:33:55 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008597.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
        <LI>Next message: <A HREF="008606.html">[squid-dev] [PATCH] Do not revive unconditionally dead peers after DNS refresh
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8578">[ date ]</a>
              <a href="thread.html#8578">[ thread ]</a>
              <a href="subject.html#8578">[ subject ]</a>
              <a href="author.html#8578">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/27/2017 02:39 PM, Eduard Bagdasaryan wrote:
&gt;<i> +    // always start probing in order to effectively detect
</I>&gt;<i> +    // dead or revived peers
</I>&gt;<i> +    (void)peerProbeConnect(p);
</I>
I think we can simplify that comment while making it more precise:

    peerProbeConnect(p); // detect any died or revived peers ASAP

The (void) cast was correct, but is no longer needed after v5 r15133.

The above are minor polishing touches that could be done during commit,
but I am writing this message because I think we may be able to cover
one more corner case without significant changes...

Imagine a situation where the peers are already being probed during
peerDNSConfigure(). Patches Squid will do nothing nothing in this case.
However, the current probes may be using old/wrong IP addresses (or
other peer configuration parameters) and, hence, may produce wrong
result. This lack of a fresh probe may delay the discovery of a died or
revived peer and might even cause an HTTP transaction failure (in the
&quot;the peer has recently died&quot; case).

On the other hand, we still do not want to create too many concurrent or
too frequent probes so we want to continue to honor the current
peerProbeConnect() concurrency and rate limits.

Please see if the following small change allows Squid to handle the
above case better:

1. Add a boolean CachePeer::reprobe field, defaulted to false. It can be
described as &quot;whether to do another TCP probe after the current TCP probes&quot;.

2. peerProbeConnect() should clear the reprobe field after passing the
two if-statement guards and before entering the loop (even if there are
no IPs to probe). The right timing here would eliminate any implicit
reprobing loops while providing the desired functionality.

3. After closing the connection, peerProbeConnectDone() should call
peerProbeConnect() if reprobe is true.

4. Add a boolean reprobeIfBusy parameter to peerProbeConnect() with
false as the default value. peerDNSConfigure() will call
peerProbeConnect() with a true parameter value. peerProbeConnect() will
start by setting reprobe to (reprobe || reprobeIfBusy).

There may be more initialization/reporting/cloning steps needed, just
like for any other CachePeer data member, but the above reflects the
core logic. Adjust as needed, of course.


Thank you,

Alex.

</PRE>



































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008597.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
	<LI>Next message: <A HREF="008606.html">[squid-dev] [PATCH] Do not revive unconditionally dead peers after DNS refresh
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8578">[ date ]</a>
              <a href="thread.html#8578">[ thread ]</a>
              <a href="subject.html#8578">[ subject ]</a>
              <a href="author.html#8578">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
