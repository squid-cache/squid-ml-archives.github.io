<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20%27miss_access%27%20and%20%27cache%27%20checks%20when%0A%20no%20ACL%20rules%20matched&In-Reply-To=%3Cc35c3693-e28d-6049-c128-edf7743f5b56%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008576.html">
   <LINK REL="Next"  HREF="008595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Fix%20%27miss_access%27%20and%20%27cache%27%20checks%20when%0A%20no%20ACL%20rules%20matched&In-Reply-To=%3Cc35c3693-e28d-6049-c128-edf7743f5b56%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 12 04:54:05 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008576.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
        <LI>Next message: <A HREF="008595.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8593">[ date ]</a>
              <a href="thread.html#8593">[ thread ]</a>
              <a href="subject.html#8593">[ subject ]</a>
              <a href="author.html#8593">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/05/17 02:18, Eduard Bagdasaryan wrote:
&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> This patch fixes &quot;miss_access&quot; and &quot;cache&quot; checks when no ACL rules
</I>&gt;<i> matched.
</I>&gt;<i>
</I>&gt;<i> The miss_access code allowed transactions to reach origin server when no
</I>&gt;<i> &quot;allow&quot; rules matched (and no &quot;deny&quot; rule matched either). This could
</I>&gt;<i> happen when a miss_access directive ACL could not make a &quot;match&quot; or
</I>&gt;<i> &quot;mismatch&quot; decision (e.g., the admin used a slow ACL or an ACL that
</I>&gt;<i> required authentication when the user was not authenticated).
</I>&gt;<i>
</I>&gt;<i> Similarly, the &quot;cache&quot; directive code allowed requests to be served from
</I>&gt;<i> the cache (and responses to be stored in the cache) when no &quot;allow&quot; (and
</I>&gt;<i> &quot;deny&quot;) rules matched. This behavior (established in v5 r14984) does not
</I>&gt;<i> contradict &quot;Requests denied by this directive will not be...&quot;
</I>&gt;<i> documentation, though.
</I>&gt;<i>
</I>&gt;<i> I believe that both &quot;miss_access&quot; and &quot;cache&quot; directives should behave
</I>&gt;<i> like all other directives in similar contexts, i.e., &quot;deny&quot; in such
</I>&gt;<i> indeterminate cases because:
</I>
Unlike most other directives these two the &quot;deny&quot; action is their 
primary purpose. Where most actions are about allowing things which are 
otherwise not done, these two are about denying things which normally 
are done. The allow action is merely a way to avoid following deny lines.

These both have a long history, and the cache directive in particular is 
kind of twisted and non-intuitive since its current behaviour was 
created to be backwards consistent with &quot;no_cache allow&quot; implying the 
Cache-Control:no-cache header existence.

&gt;<i>
</I>&gt;<i> * It avoids problems with configurations like:
</I>&gt;<i>
</I>&gt;<i>    # broken if badGuys fails to match or mismatch (allows bad guys)
</I>&gt;<i>    acl_driven_option allow !badGuys
</I>&gt;<i>
</I>&gt;<i>   That is what trunk r12176 has partially fixed.
</I>&gt;<i>
</I>&gt;<i> * It makes ACL checking rules consistent with each other, especially if
</I>&gt;<i>   there is no good reason for making exception for these two cases.
</I>&gt;<i>
</I>
The other access lists which obviously treat non-allowed as denied are 
very recent additions. So using them as a template to re-write existing 
and widely used directives behaviour is not great.


It is very likely that this change will cause installations previously 
&quot;working&quot; to have large amounts of traffic suddenly stop caching, or 
start getting 403 denials. That violates our intentions of not doing 
things to surprise admin if we can avoid it.

If we make this not-allowed == denied behaviour formal for how 
allow/deny/dunno tristate directives map to boolean. We should first 
make -k parse perform the &quot;a fast-only directive uses a slow ACL!&quot; 
check, and make the existing one an ERROR for a few releases.
  Also going through the process to deprecate cache directive formally 
might be worth beginning - most old uses should be a straight rename to 
store_miss, but some will be send_hit or a mix of the two. Just adding a 
debugs statement to that effect on startup, reconfigure, and -k parse 
should do for a while.



&gt;<i> To help avoid similar problems in the future, and to improve code
</I>&gt;<i> consistency, I added an API that eliminates the need for direct
</I>&gt;<i> comparison with ACCESS_ALLOWED and ACCESS_DENIED.
</I>
These parts I like. The allowed() method addition bits would be nice to 
apply however the behaviour change issues turn out.

Amos

</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008576.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
	<LI>Next message: <A HREF="008595.html">[squid-dev] [PATCH] Fix 'miss_access' and 'cache' checks when no ACL rules matched
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8593">[ date ]</a>
              <a href="thread.html#8593">[ thread ]</a>
              <a href="subject.html#8593">[ subject ]</a>
              <a href="author.html#8593">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
