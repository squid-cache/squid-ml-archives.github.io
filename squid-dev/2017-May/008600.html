<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Create PID file ASAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Create%20PID%20file%20ASAP&In-Reply-To=%3C46a9a8c2-99f1-7824-7ef0-c8292fb24dfe%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008599.html">
   <LINK REL="Next"  HREF="008603.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Create PID file ASAP</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Create%20PID%20file%20ASAP&In-Reply-To=%3C46a9a8c2-99f1-7824-7ef0-c8292fb24dfe%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Create PID file ASAP">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Mon May 15 08:34:26 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008599.html">[squid-dev] [PATCH] check parameters for negotiate_wrapper
</A></li>
        <LI>Next message: <A HREF="008603.html">[squid-dev] [PATCH] Create PID file ASAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8600">[ date ]</a>
              <a href="thread.html#8600">[ thread ]</a>
              <a href="subject.html#8600">[ subject ]</a>
              <a href="author.html#8600">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,


With this fix applied, PID file is created right after configuration
finalization, before the allocation for any shared memory segments.

Late PID file creation allowed N+1 concurrent Squid instances to create
the same set of shared segments (overwriting each other segments),
resulting in extremely confusing havoc because the N instances would
later lose the race for the PID file (or some other critical resource)
creation and remove the segments. If that removal happened before a kid
of the single surviving instance started, that kid would fail to start
with open() errors in Segment.cc because the shared segment it tries to
open would be gone. Otherwise, that kid would fail to _restart_ after
any unrelated failures (possibly many days after the conflict), with
same errors, for the same reason.

Shared state corruption was also possible if different kids (of the
winning instance) opened (and started using) segments created (and
initialized) by different instances.

Situations with N+1 concurrent Squid instances are not uncommon because
many Squid service management scripts (or manual admin commands!)
* do not check whether another Squid is already running and/or
* incorrectly assume that &quot;squid -z&quot; does not daemonize.

This change finally makes starting N+1 Squid instances safe (AFAIK).

Also made daemonized and non-daemonized Squid create the PID file at the
same startup stage, reducing inconsistencies between the two modes.

This patch should be applied after applying PID file creation atomicity fix:
<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2017-May/008584.html">http://lists.squid-cache.org/pipermail/squid-dev/2017-May/008584.html</A>


Regards,

Eduard.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID-286-correct-pid-file-creation-timing-t2.patch
Type: text/x-patch
Size: 9830 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170515/be3b5353/attachment.bin">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170515/be3b5353/attachment.bin</A>&gt;
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008599.html">[squid-dev] [PATCH] check parameters for negotiate_wrapper
</A></li>
	<LI>Next message: <A HREF="008603.html">[squid-dev] [PATCH] Create PID file ASAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8600">[ date ]</a>
              <a href="thread.html#8600">[ thread ]</a>
              <a href="subject.html#8600">[ subject ]</a>
              <a href="author.html#8600">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
