<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Make PID file check/creation atomic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Make%20PID%20file%20check/creation%20atomic&In-Reply-To=%3Cba0ca3d9-646b-b3d2-3e32-336401a8cefb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008584.html">
   <LINK REL="Next"  HREF="008605.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Make PID file check/creation atomic</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Make%20PID%20file%20check/creation%20atomic&In-Reply-To=%3Cba0ca3d9-646b-b3d2-3e32-336401a8cefb%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Make PID file check/creation atomic">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 15 12:04:33 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008584.html">[squid-dev] [PATCH] Make PID file check/creation atomic
</A></li>
        <LI>Next message: <A HREF="008605.html">[squid-dev] [PATCH] Make PID file check/creation atomic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8604">[ date ]</a>
              <a href="thread.html#8604">[ thread ]</a>
              <a href="subject.html#8604">[ subject ]</a>
              <a href="author.html#8604">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/05/17 09:59, Eduard Bagdasaryan wrote:
&gt;<i> This patch makes PID file check/creation atomic to avoid associated
</I>&gt;<i> race conditions.
</I>
I do not see any use of atomic's in this patch. Please use std::atomic 
locks to ensure actually atomic operations on the file locks. Squid does 
have some child processes operating as threads so custom implementations 
that don't use real atomic's will fail under some circumstances.


&gt;<i>
</I>&gt;<i> Authors: Alex Rousskov, Eduard Bagdasaryan
</I>&gt;<i>
</I>&gt;<i> After this change, if N Squid instances are concurrently started shortly
</I>&gt;<i> after time TS, then exactly one Squid instance (X) will run (and have
</I>&gt;<i> the corresponding PID file). If another Squid instance has already been
</I>&gt;<i> running (with the corresponding PID file) at TS, then X will be that
</I>&gt;<i> &quot;old&quot; Squid instance. If no Squid instances were running at TS, then X
</I>&gt;<i> will be one of those new N Squids started after TS.
</I>&gt;<i>
</I>&gt;<i> Lack of atomic PID file operations caused unexpected Squid behavior:
</I>&gt;<i> * Mismatch between started Squid instance and stored PID file.
</I>&gt;<i> * Unexpected crashes due to failed allocation of shared resources,
</I>&gt;<i>   such as listening TCP ports or shared memory segments.
</I>&gt;<i>
</I>&gt;<i> A new File class guarantees atomic PID file operations using locks. We
</I>&gt;<i> tried to generalize/reuse Ssl::Lock from the certificate generation
</I>
What Ssl::Lock class?


Amos
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008584.html">[squid-dev] [PATCH] Make PID file check/creation atomic
</A></li>
	<LI>Next message: <A HREF="008605.html">[squid-dev] [PATCH] Make PID file check/creation atomic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8604">[ date ]</a>
              <a href="thread.html#8604">[ thread ]</a>
              <a href="subject.html#8604">[ subject ]</a>
              <a href="author.html#8604">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
