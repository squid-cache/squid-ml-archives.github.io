<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Happy%20Eyeballs%3A%20Use%20each%20fully%20resolved%0A%20destination%20ASAP&In-Reply-To=%3C0019bd59-e0fe-3ee2-86f5-2e3cf63474c8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008610.html">
   <LINK REL="Next"  HREF="008621.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Happy%20Eyeballs%3A%20Use%20each%20fully%20resolved%0A%20destination%20ASAP&In-Reply-To=%3C0019bd59-e0fe-3ee2-86f5-2e3cf63474c8%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May 16 09:31:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008610.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved	destination ASAP
</A></li>
        <LI>Next message: <A HREF="008621.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8612">[ date ]</a>
              <a href="thread.html#8612">[ thread ]</a>
              <a href="subject.html#8612">[ subject ]</a>
              <a href="author.html#8612">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/05/17 16:33, Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i>      The attached patch is the first in a short series of patches that
</I>&gt;<i> improve Squid support for the Happy Eyeballs principle. The motivation
</I>&gt;<i> for these patches has been discussed on the dns_wait_for_all thread:
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2016-September/006831.html">http://lists.squid-cache.org/pipermail/squid-dev/2016-September/006831.html</A>
</I>
NP: This is not implementing the Happy Eyeballs *algorithm* (it is an 
explicitly standardized algorithm name, not a principle). While it 
enables parallel lookup and use of different paths, the individual path 
IPs remain ordered such that dns_v4_first is still relevant. &quot;Happy 
Eyeballs&quot; algorithm is specifically a DNS feature.

&gt;<i> With this change, Squid no longer waits for all request forwarding
</I>&gt;<i> destinations to be resolved. Instead, it uses each fully resolved
</I>&gt;<i> destination as soon as it is needed. More info is in the patch preamble.
</I>
More correctly this code does not even begin to resolve some 
destinations until others are already started being connected to. It is 
a step back to non-deterministic forwarding timeouts.

&gt;<i> The next planned step is to deliver A and AAAA answers to the peer
</I>&gt;<i> selection code independently and ASAP. When both changes are combined,
</I>&gt;<i> the FwdState/tunneling code will receive IPvX addresses without waiting
</I>&gt;<i> for IPvY addresses (and/or other destination names) to be resolved,
</I>&gt;<i> making user eyeballs happier and, hence, facilitating IPv6 deployments.
</I>
*That* is the missing part of Happy Eyeballs. But as you note, is not 
included in this patch.

&gt;<i> This patch also adds reporting of peer type when dumping Connection
</I>&gt;<i> info. I removed operator &quot;&lt;&lt;&quot; definition from Connection.h header
</I>&gt;<i> because we should not burden all Connection users with these low-level
</I>&gt;<i> (and performance-unrelated) details. I also removed associated comments
</I>&gt;<i> because they were partially misleading (or perhaps outdated) and
</I>&gt;<i> partially misplaced (Connection.h is not the right place to state basic
</I>&gt;<i> C++ operator overloading rules). If there are no objections, I will
</I>&gt;<i> commit this minor improvement separately.
</I>&gt;<i>
</I>&gt;<i> No changes to FwdServer class but its declaration has been moved from
</I>&gt;<i> the PeerSelectState.h header to peer_select.cc because FwdServer is
</I>&gt;<i> unused by peerSelect() users.
</I>&gt;<i>
</I>&gt;<i> No changes to peerCountMcastPeers functionality. I only documented the
</I>&gt;<i> abuse and marked the abused ps_state field with XXX to prevent future
</I>&gt;<i> abuses.
</I>&gt;<i>
</I>
Audit:


in src/FwdState.cc:

* s/Will aborting forwarding/Will abort forwarding/


in src/peer_select.cc:

* psstate-&gt;lastError = NULL; // initiator owns the ErrorState object now
  - please use nullptr on moved or new lines

* The call to noteDestinationsEnd() with an error from peerSelectDnsResults() appears to abort *all* path connection attempts by the initiator with an error page if

  a) the first path had an error, or

  b) the DNS lookup for the path was slow enough that all previous paths
were tried and emptied from serverDestinations.

eg. for an IPv4-only network when the first N peers are unreachable (very fast TCP failover) and the Nth does not have
ipcache listed records (slow remote lookup).


Amos

</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008610.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved	destination ASAP
</A></li>
	<LI>Next message: <A HREF="008621.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8612">[ date ]</a>
              <a href="thread.html#8612">[ thread ]</a>
              <a href="subject.html#8612">[ subject ]</a>
              <a href="author.html#8612">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
