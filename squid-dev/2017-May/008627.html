<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Introduction%20/%20SslBump%20prototype%20patch%20to%20ignore%0A%20unknown%20ciphers&In-Reply-To=%3C8bbb8e9c-0330-c81f-3604-eb19c8d8895d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008626.html">
   <LINK REL="Next"  HREF="008628.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Introduction%20/%20SslBump%20prototype%20patch%20to%20ignore%0A%20unknown%20ciphers&In-Reply-To=%3C8bbb8e9c-0330-c81f-3604-eb19c8d8895d%40measurement-factory.com%3E"
       TITLE="[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May 17 20:01:32 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008626.html">[squid-dev] Introduction / SslBump prototype patch to ignore	unknown ciphers
</A></li>
        <LI>Next message: <A HREF="008628.html">[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8627">[ date ]</a>
              <a href="thread.html#8627">[ thread ]</a>
              <a href="subject.html#8627">[ subject ]</a>
              <a href="author.html#8627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/17/2017 12:09 PM, David Hogan wrote:
&gt;<i> ssl_bump peek       step1
</I>&gt;<i> ssl_bump peek       step2 whitelist
</I>&gt;<i> ssl_bump terminate  step2 blacklist
</I>&gt;<i> ssl_bump peek       step2
</I>&gt;<i> ssl_bump splice     step3
</I>
The above configuration looks strange but this is squid-dev not
squid-users, so I trust you have good reasons for terminating only at
step2 but also validating certificates (at step3). If not, you may want
to discuss your needs on squid-users.


&gt;<i> kid1| Error negotiating SSL on FD 13: error:140920F8:SSL
</I>&gt;<i> routines:SSL3_GET_SERVER_HELLO:unknown cipher returned (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> This is due to CHACHA20_POLY1305 being negotiated, which openssl on
</I>&gt;<i> CentOS 7 doesn’t recognise. This error prevents squid from further
</I>&gt;<i> validating the certificate or splicing the connection, even though use
</I>&gt;<i> of the cipher within squid isn't actually necessary for splicing.
</I>
That is correct. You are hitting a known limitation of the current
implementation -- step3 requires OpenSSL wire-level participation even
when splicing the connections. Squid v4 got rid of OpenSSL when
peeking/splicing during step2 (trunk r14670), but the same kind of
changes for splicing during step3 has not been sponsored.


&gt;<i> As an experiment, I developed a patch for the Centos 7 Squid 3.5.20
</I>&gt;<i> source (attached) 
</I>
FYI: Please use &quot;universal&quot; diff patches (diff options -U 30 and
--show-c-function). The Squid wiki has more instructions for developers.


&gt;<i> 1. What is the impact of calling checkForPeekAndSplice() from
</I>&gt;<i> Ssl::PeerConnector::handleNegotiateError()? 
</I>
IIRC, Ssl::PeerConnector::checkForPeekAndSplice() is the start of
SslBump step3. If your step2 action is not final, then you have to do
step3 or the transaction will stall.


&gt;<i> 2. Can anyone offer any advice on how server certificate validation
</I>&gt;<i> could proceed as normal after detecting (and ignoring) an unknown
</I>&gt;<i> cipher?
</I>
I am not sure I understand the question, but

* pure certificate validation is unrelated to ciphers

* actual validation code (in Squid or the validation helper) may look at
ciphers as well (e.g., to reject weak ciphers [for some sites])


&gt;<i> I have read elsewhere that this issue can be overcome by linking squid
</I>&gt;<i> against LibreSSL instead of OpenSSL,
</I>
Squid does not support LibreSSL (well). You might be able to resolve the
issue by linking with a newer OpenSSL version, but I have not checked
whether that is actually true.


&gt;<i> however I would much rather put
</I>&gt;<i> together a solution that doesn’t stray too far from the supported
</I>&gt;<i> packages of an operating system vendor.
</I>
Your vendor is probably not fast enough compared with the rate of
SslBump changes (unfortunately).


&gt;<i> I would also prefer to not
</I>&gt;<i> have to periodically deal with this each time a new cipher appears.
</I>
... or some other aspect of TLS communication changes.

Do you need Squid to validate certificates? If yes, you can probably
hack your personal Squid along the lines of your initial patch OR
sponsor/wait for OpenSSL wire-level removal from the splicing pathway.
If not, you may be able to solve your problem by adjusting your Squid
configuration.


HTH,

Alex.

</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008626.html">[squid-dev] Introduction / SslBump prototype patch to ignore	unknown ciphers
</A></li>
	<LI>Next message: <A HREF="008628.html">[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8627">[ date ]</a>
              <a href="thread.html#8627">[ thread ]</a>
              <a href="subject.html#8627">[ subject ]</a>
              <a href="author.html#8627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
