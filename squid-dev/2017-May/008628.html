<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Introduction%20/%20SslBump%20prototype%20patch%20to%20ignore%0A%20unknown%20ciphers&In-Reply-To=%3CCAHsu8wrVSde5%2Bo7sfYJ%3DiqNe4ZtB3fgQBz2f1eWAhCs1juaMdA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008627.html">
   <LINK REL="Next"  HREF="008629.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers</H1>
    <B>David Hogan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Introduction%20/%20SslBump%20prototype%20patch%20to%20ignore%0A%20unknown%20ciphers&In-Reply-To=%3CCAHsu8wrVSde5%2Bo7sfYJ%3DiqNe4ZtB3fgQBz2f1eWAhCs1juaMdA%40mail.gmail.com%3E"
       TITLE="[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers">david.q.hogan at gmail.com
       </A><BR>
    <I>Wed May 17 21:18:52 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008627.html">[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
</A></li>
        <LI>Next message: <A HREF="008629.html">[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8628">[ date ]</a>
              <a href="thread.html#8628">[ thread ]</a>
              <a href="subject.html#8628">[ subject ]</a>
              <a href="author.html#8628">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thank you for your response.

On 17 May 2017 at 21:01, Alex Rousskov &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 05/17/2017 12:09 PM, David Hogan wrote:
</I>&gt;&gt;<i> ssl_bump peek       step1
</I>&gt;&gt;<i> ssl_bump peek       step2 whitelist
</I>&gt;&gt;<i> ssl_bump terminate  step2 blacklist
</I>&gt;&gt;<i> ssl_bump peek       step2
</I>&gt;&gt;<i> ssl_bump splice     step3
</I>&gt;<i>
</I>&gt;<i> The above configuration looks strange but this is squid-dev not
</I>&gt;<i> squid-users, so I trust you have good reasons for terminating only at
</I>&gt;<i> step2 but also validating certificates (at step3). If not, you may want
</I>&gt;<i> to discuss your needs on squid-users.
</I>
I found that applying a blacklist at step3 resulted in too many false positives
caused by subjectAltName matches. For example, the certificate for
www.bing.com also lists hosts related to their ad network, which meant that
applying an ad blocklist at step3 would also block www.bing.com. I realise
that blocking at step2 is flawed as bypassing the blacklist is as simple as
not including SNI in the request, however I am hoping separately to figure
out how to match missing SNI and terminate, either by acl config or a patch.

I just tested that sending a fake SNI causes certificate verification error,
which is great.

&gt;&gt;<i> kid1| Error negotiating SSL on FD 13: error:140920F8:SSL
</I>&gt;&gt;<i> routines:SSL3_GET_SERVER_HELLO:unknown cipher returned (1/-1/0)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is due to CHACHA20_POLY1305 being negotiated, which openssl on
</I>&gt;&gt;<i> CentOS 7 doesnâ€™t recognise. This error prevents squid from further
</I>&gt;&gt;<i> validating the certificate or splicing the connection, even though use
</I>&gt;&gt;<i> of the cipher within squid isn't actually necessary for splicing.
</I>&gt;<i>
</I>&gt;<i> That is correct. You are hitting a known limitation of the current
</I>&gt;<i> implementation -- step3 requires OpenSSL wire-level participation even
</I>&gt;<i> when splicing the connections. Squid v4 got rid of OpenSSL when
</I>&gt;<i> peeking/splicing during step2 (trunk r14670), but the same kind of
</I>&gt;<i> changes for splicing during step3 has not been sponsored.
</I>
Or are you saying that the OpenSSL validation code could be used directly,
rather than having OpenSSL think it's doing a real handshake?

&gt;&gt;<i> As an experiment, I developed a patch for the Centos 7 Squid 3.5.20
</I>&gt;&gt;<i> source (attached)
</I>&gt;<i>
</I>&gt;<i> FYI: Please use &quot;universal&quot; diff patches (diff options -U 30 and
</I>&gt;<i> --show-c-function). The Squid wiki has more instructions for developers.
</I>
Sorry, i've attached an updated patch for any future discussion.

&gt;&gt;<i> 2. Can anyone offer any advice on how server certificate validation
</I>&gt;&gt;<i> could proceed as normal after detecting (and ignoring) an unknown
</I>&gt;&gt;<i> cipher?
</I>&gt;<i>
</I>&gt;<i> I am not sure I understand the question, but
</I>&gt;<i>
</I>&gt;<i> * pure certificate validation is unrelated to ciphers
</I>&gt;<i>
</I>&gt;<i> * actual validation code (in Squid or the validation helper) may look at
</I>&gt;<i> ciphers as well (e.g., to reject weak ciphers [for some sites])
</I>
We set up a server with both ChaCha20 and a self signed cert, with my
patch, no validation was performed and the connection was spliced.

&gt;&gt;<i> I have read elsewhere that this issue can be overcome by linking squid
</I>&gt;&gt;<i> against LibreSSL instead of OpenSSL,
</I>&gt;<i>
</I>&gt;<i> Squid does not support LibreSSL (well). You might be able to resolve the
</I>&gt;<i> issue by linking with a newer OpenSSL version, but I have not checked
</I>&gt;<i> whether that is actually true.
</I>
I tried the Fedora 26 alpha with Squid 4.0.11 and OpenSSL 1.1.0e, but had
the same unknown cipher issue.

&gt;<i> Do you need Squid to validate certificates? If yes, you can probably
</I>&gt;<i> hack your personal Squid along the lines of your initial patch OR
</I>&gt;<i> sponsor/wait for OpenSSL wire-level removal from the splicing pathway.
</I>&gt;<i> If not, you may be able to solve your problem by adjusting your Squid
</I>&gt;<i> configuration.
</I>
Certificate validation is a killer feature and given that it almost works all of
the time, I think i'll try and come up with a patch that ignores the unknown
cipher whilst still validating the certificate.

Thanks for your help,
Dave
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-3.5.20-unknown-cipher-ignore.patch
Type: application/octet-stream
Size: 3637 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170517/71b56b51/attachment-0001.obj">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170517/71b56b51/attachment-0001.obj</A>&gt;
</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008627.html">[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
</A></li>
	<LI>Next message: <A HREF="008629.html">[squid-dev] Introduction / SslBump prototype patch to ignore unknown ciphers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8628">[ date ]</a>
              <a href="thread.html#8628">[ thread ]</a>
              <a href="subject.html#8628">[ subject ]</a>
              <a href="author.html#8628">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
