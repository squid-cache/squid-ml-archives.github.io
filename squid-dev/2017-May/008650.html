<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Do not die silently when dying early
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20die%20silently%20when%20dying%20early&In-Reply-To=%3C6a5de70c-611b-6615-36a1-d5cecdfbb5da%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008649.html">
   <LINK REL="Next"  HREF="008651.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Do not die silently when dying early</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Do%20not%20die%20silently%20when%20dying%20early&In-Reply-To=%3C6a5de70c-611b-6615-36a1-d5cecdfbb5da%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] Do not die silently when dying early">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat May 20 11:04:52 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008649.html">[squid-dev] [PATCH] Do not die silently when dying early
</A></li>
        <LI>Next message: <A HREF="008651.html">[squid-dev] [PATCH] Do not die silently when dying early
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8650">[ date ]</a>
              <a href="thread.html#8650">[ thread ]</a>
              <a href="subject.html#8650">[ subject ]</a>
              <a href="author.html#8650">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/05/17 10:25, Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i>      The attached patch allows Squid to report various problems (e.g.,
</I>&gt;<i> mishandled exceptions) that may occur very early in Squid lifetime,
</I>&gt;<i> before proper logging is configured by the first _db_init() call.
</I>&gt;<i>
</I>&gt;<i> To enable such early reporting, we started with a trivial debug.cc change:
</I>&gt;<i>
</I>&gt;<i>    -FILE *debug_log = NULL;
</I>&gt;<i>    +FILE *debug_log = stderr;
</I>&gt;<i>
</I>&gt;<i> ... but then realized that debug_log may not be assigned early enough!
</I>&gt;<i> The resulting changes ensure that we can log (to stderr if necessary) as
</I>&gt;<i> soon as stderr itself is initialized. They also polish related logging
</I>&gt;<i> code, including localization of stderr checks and elimination of
</I>&gt;<i> double-closure during log rotation on Windows.
</I>&gt;<i>
</I>&gt;<i> These reporting changes do not bypass or eliminate any failures.
</I>&gt;<i>
</I>&gt;<i> This patch is independent from the &quot;Do not die silently when dying via
</I>&gt;<i> std::terminate()&quot; patch posted a few days ago, but, in combination, the
</I>&gt;<i> two patches fix reporting of early std::terminate() deaths.
</I>&gt;<i>
</I>
Audit:

in src/Debug.h:

* instead of adding yet another wrapper macro, please replace all uses 
of debug_log with DebugStream().
  - we already know from earlier macros that these just lead us to much 
more pain and long arguments in future developments.
  - the important comment by Duane in src/main.cc SquidShutdown() is now 
needing an update to reference the current symbol names.

in src/debug.cc:

* debugOpenLog()
  - since the bulk of the function is being altered please take the opportunity to remove the use of NULL in there.

  - in the else condition after fopen() we are writing explicitly to stderr then clearing TheLog. It seems to me that a better thing would be to do is write that notice to TheLog before clearing it, to perror() and then to TheLog after clearing it. Which should result in all places the admin might look getting the message, and the log writes can be via debugs() instead of fprintf().


Amos

</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008649.html">[squid-dev] [PATCH] Do not die silently when dying early
</A></li>
	<LI>Next message: <A HREF="008651.html">[squid-dev] [PATCH] Do not die silently when dying early
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8650">[ date ]</a>
              <a href="thread.html#8650">[ thread ]</a>
              <a href="subject.html#8650">[ subject ]</a>
              <a href="author.html#8650">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
