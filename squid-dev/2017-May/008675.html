<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Happy%20Eyeballs%3A%20Use%20each%20fully%20resolved%0A%20destination%20ASAP&In-Reply-To=%3C49d9d75b-3840-464d-108e-c557bafb2c6a%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="008671.html">
   <LINK REL="Next"  HREF="008677.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20Happy%20Eyeballs%3A%20Use%20each%20fully%20resolved%0A%20destination%20ASAP&In-Reply-To=%3C49d9d75b-3840-464d-108e-c557bafb2c6a%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May 24 20:42:50 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="008671.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
</A></li>
        <LI>Next message: <A HREF="008677.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8675">[ date ]</a>
              <a href="thread.html#8675">[ thread ]</a>
              <a href="subject.html#8675">[ subject ]</a>
              <a href="author.html#8675">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/24/2017 09:04 AM, Amos Jeffries wrote:
&gt;<i> For the 1st destination ps_state::handlePath() calls noteDestination()
</I>&gt;<i> which results in the entire TunnelState::startConnecting() /
</I>&gt;<i> FwdState::startConnectionOrFail() sequence happening synchronously
</I>&gt;<i> before returning to ps_state::handlePaths() and peerSelectDnsResults()
</I>&gt;<i> for the 2nd path.
</I>
That is correct, although the phrasing &quot;ENTIRE sequence&quot; implies some
significant delays that are usually not there. The &quot;sequence&quot; usually
stops &quot;soon&quot; because it starts an async job (e.g., a PeerConnector or a
Client job).


&gt;<i> There do not seem to be any performance gains from this redesign for
</I>&gt;<i> transactions where there are less than 3 upstream servers.
</I>
This is both incorrect and largely irrelevant:

* Incorrect: The new code makes forwarding faster in cases where there
are two (or more) destinations and the second destination requires a DNS
lookup -- the new code will start using the first destination sooner
and, in typical cases, will finish forwarding sooner. See my earlier
specific example for an illustration.

* Irrelevant: This performance gain is just a nice side effect. The
primary goal is to facilitate Happy Eyeballs (which requires this
parallelization and more).


&gt;<i> The synchronous processing may make the one transaction
</I>&gt;<i> reach connection faster, but that is just taking CPU cycles from /
</I>&gt;<i> slowing other transactions.
</I>
The patch parallelizes second DNS lookup and first HTTP transaction
execution. That parallelization is not about CPU cycles but about the
time the first HTTP transaction spends waiting for (blocked on) that
second (and usually unused) DNS lookup in the old code. The patched code
does not wait/block. Again, the gains from this optimization are not the
goal, but some environments will see them.


&gt;<i> It might be worth initiating that noteDestination() sub-path as async
</I>&gt;<i> step to avoid the remaining delay.
</I>
Yes, and my second thread email stated that much. However, the reason
for making that call async is not performance optimization (async calls
make performance worse, not better!) or delays. The reason is to shorten
the call stack, reducing the number of balls in the air and localizing bugs.


&gt;<i> The [forwarding timeout] is no longer determined by which component is
</I>&gt;<i> being problematic. It was nice being able to point squid-users questions
</I>&gt;<i> in roughly the right direction without resorting to logs very often.
</I>
Agreed. Happy Eyeballs is a more complex &quot;parallel&quot; algorithm than the
current sequential DNS-then-HTTP approach. Parallel algorithms are more
difficult to implement, understand, and support. Hopefully, we agree
that Squid should support Happy Eyeballs despite those costs. Thus, I do
not understand why you are discussing multiple possible reasons behind
timeouts here.

( FWIW, resorting to messy debugging logs is necessary primarily because
of poor reporting/triaging interfaces in Squid. It is possible to make
triage much better without resorting to debugging logs. Such
improvements would help triaging Happy Eyeballs as well. )


&gt;<i> 1c) server 5xx response arrives for A,
</I>&gt;<i>   - startConnectionOrFail() now has serverDestinations.empty() and an
</I>&gt;<i> error to deliver
</I>
Fixed in the attached take4 patch. The tunneling code already has
similar logic, but I missed it in the forwarding case.

I also explicitly cleared peer selection subscription when FwdState
tries to stop, just in case the self-clearing hack does not work.

An incremental diff showing changes since the last take is also attached.


Thank you,

Alex.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: SQUID69-use-destination-asap-t4.patch
Type: text/x-diff
Size: 89429 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170524/f54c70f4/attachment-0002.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170524/f54c70f4/attachment-0002.patch</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: incremental.patch
Type: text/x-diff
Size: 32351 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170524/f54c70f4/attachment-0003.patch">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20170524/f54c70f4/attachment-0003.patch</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008671.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
</A></li>
	<LI>Next message: <A HREF="008677.html">[squid-dev] [PATCH] Happy Eyeballs: Use each fully resolved destination ASAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8675">[ date ]</a>
              <a href="thread.html#8675">[ thread ]</a>
              <a href="subject.html#8675">[ subject ]</a>
              <a href="author.html#8675">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
