From squid3 at treenet.co.nz  Thu Nov  2 08:11:00 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 2 Nov 2017 21:11:00 +1300
Subject: [squid-dev] how does Squid 3.5 parse https responce
In-Reply-To: <tencent_9188F5685739BE5DB83CBD54E289EC3E8D07@qq.com>
References: <tencent_9188F5685739BE5DB83CBD54E289EC3E8D07@qq.com>
Message-ID: <63280d74-3bcd-d70b-3388-cb55d705e98e@treenet.co.nz>

On 02/11/17 15:14, G~D~Lunatic wrote:
> I want to know how the squid parse the body of certificate when they 
> send HTTPS requests and get the server's certificate.

HTTPS messages and TLS certificates are very different things.

> The operation of this part is in which class or function.
> 

This mailing list is for usage discussions. Code discussion happens on 
the squid-dev mailing list (Cc'd).

Amos

From squid3 at treenet.co.nz  Thu Nov  2 09:01:54 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 2 Nov 2017 22:01:54 +1300
Subject: [squid-dev] Perl script help needed
Message-ID: <eb444aaa-aaae-3f11-81a7-5e57ee3320c9@treenet.co.nz>

Hi all,

I am running into a tricky issue with the maintainer scripts that I'm 
not sure how to solve.

Anyone able to assist?

Amos

From rousskov at measurement-factory.com  Thu Nov  2 14:42:41 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 2 Nov 2017 08:42:41 -0600
Subject: [squid-dev] how does Squid 3.5 parse https responce
In-Reply-To: <63280d74-3bcd-d70b-3388-cb55d705e98e@treenet.co.nz>
References: <tencent_9188F5685739BE5DB83CBD54E289EC3E8D07@qq.com>
 <63280d74-3bcd-d70b-3388-cb55d705e98e@treenet.co.nz>
Message-ID: <cdc263fb-bfd3-3e50-5b52-ff1db8888bb8@measurement-factory.com>

On 02/11/17 15:14, G~D~Lunatic wrote:
> I want to know how the squid parse the body of certificate
> The operation of this part is in which class or function.

If you are asking about modern Squid code doing SslBump, then
Security::HandshakeParser::ParseCertificate() calls OpenSSL d2i_X509()
to parse a certificate.

Otherwise, IIRC, OpenSSL (or equivalent) parses certificates for Squid
(probably using d2i_X509() or some similar internal function).


HTH,

Alex.

From rousskov at measurement-factory.com  Thu Nov  2 15:01:22 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 2 Nov 2017 09:01:22 -0600
Subject: [squid-dev] Perl script help needed
In-Reply-To: <eb444aaa-aaae-3f11-81a7-5e57ee3320c9@treenet.co.nz>
References: <eb444aaa-aaae-3f11-81a7-5e57ee3320c9@treenet.co.nz>
Message-ID: <5b303b90-a811-7d62-c549-46395349353e@measurement-factory.com>

On 11/02/2017 03:01 AM, Amos Jeffries wrote:

> I am running into a tricky issue with the maintainer scripts that I'm
> not sure how to solve.
> 
> Anyone able to assist?
I can try.

Alex.

From rousskov at measurement-factory.com  Thu Nov  2 15:47:41 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 2 Nov 2017 09:47:41 -0600
Subject: [squid-dev] Squid 3.5 with nonblocking ecap adapter
In-Reply-To: <CAFyThp+67yMOrXfbMnfSccxXRop-pMihdmwLKuTZGqRa+X4rPg@mail.gmail.com>
References: <CAFyThpJ79PjfCJspusGzK1LeRL7-Qg5F7m_PrLLVYYRsWO-UAQ@mail.gmail.com>
 <572c5876-1762-3284-9b0c-93d2188f237a@measurement-factory.com>
 <CAFyThp+67yMOrXfbMnfSccxXRop-pMihdmwLKuTZGqRa+X4rPg@mail.gmail.com>
Message-ID: <8b20a9f5-09a4-425d-892b-05cbc5a331c6@measurement-factory.com>

On 11/02/2017 03:49 AM, Christof Gerber wrote:

> One thing I still don't fully understand is if the asynchronous way to
> program and operate Squid with an eCAP adapter necessarily relies on
> threads?

No, threads are just one popular way to achieve asynchrony. One may also
use multiple processes or (for some definition of asynchrony) event loops.


> Are A) and B) alternatives or the only options?

If you replace B's "threads" with "threads or other asynchrony
mechanisms", then yes, IMO. Threads are probably the most popular way to
achieve asynchrony in new code.


> I've seen that both the
> ClamAV and sample async adapter use pthreads. In my use case I need to
> do a simple hash lookup to a file socket somewhen during the eCAP
> interaction. As it will take some milliseconds until the response will
> be available on the socket I don't want to block Squid during this
> time. 

Yes, this is a common problem.


> But the eCAP adapter won't need to process/compute anything else
> during this time. So why would I bother to use threads? 

... because without threads (or processes or event loops) your adapter
lookup will block the whole Squid worker while waiting for socket I/O.

If you do not want to use threads or processes in your adapter, then you
can try to use an event loop model. That is what Squid uses internally
(each Squid worker does not have threads to process thousands of
transactions "concurrently").

To use an event loop model, your adapter will need to use non-blocking
socket I/O and schedule _one_ I/O loop iteration every ~X milliseconds,
when Squid calls your Service::resume(). Try googling "I/O loop" or
"select loop" for starting points if you are not familiar with that
design pattern. The overall host-adapter interaction would be very
similar to what you find in the sample and ClamAV adapters.

Disclaimer: I have not seen anybody using event loops with eCAP. I think
it is possible to implement that model, but there may be important
caveats that I am not aware of.


HTH,

Alex.


> On 1 November 2017 at 16:23, Alex Rousskov wrote:
>> On 11/01/2017 03:20 AM, Christof Gerber wrote:
>>
>>> [Will Squid] be blocked until the eCAP API call returns?
>>
>> To answer the exact question above: Yes, the Squid worker making an eCAP
>> API call will block until that call returns. The same is true for all
>> other API calls, all system calls, and all internal calls. This is how
>> C/C++ works. I am stating the obvious for the record, in case somebody
>> with a different (or insufficient) programming languages background
>> stumbles upon this thread.
>>
>> What you are really asking, I suspect, is whether Squid or the eCAP
>> library uses threads to automatically make eCAP adapter operations
>> asynchronous to the primary Squid operations. The answer to that
>> question is "no": The relevant Squid code does not use threads, and
>> there are no threads in the eCAP library code.
>>
>> Also, there is no magical layer between Squid and 99% of eCAP calls --
>> Squid calls go directly to your eCAP adapter code and vice versa. IIRC,
>> the only (unimportant) exception to that "direct calls" observation is
>> the eCAP service registry API, where there is a thin eCAP layer
>> insulating the adapter from the host application. That layer is also
>> synchronous though.
>>
>>
>>> Is there a way other than
>>> programming the eCAP adapter in asynchronous mode?
>>
>> I do not think there is a better alternative. AFAICT, you only have two
>> options:
>>
>>   A) Change Squid to move eCAP calls to thread(s).
>>   B) Use threads inside the adapter to make its operations asynchronous.
>>
>> As you know, the sample async adapter and the ClamAV adapter use (B).
>> That approach has its problems (because it currently does not require
>> the host application to be threads-aware), but it works reasonably well
>> for many use cases.
>>
>>
>> Cheers,
>>
>> Alex.


From vineetawasthi.technocrat at gmail.com  Sat Nov  4 10:16:46 2017
From: vineetawasthi.technocrat at gmail.com (Vineet Awasthi)
Date: Sat, 4 Nov 2017 15:46:46 +0530
Subject: [squid-dev] How does Squid blocks HTTP request
Message-ID: <CAAbd6H+5YwF1A9VRzH9e4uAu77V7-WE0FbeFZXA6cHvaW_=yeg@mail.gmail.com>

Hi,

I am trying to understand the squid and want to know how does squid handle
incoming HTTP request and filter the request based on the settings provided
in the squid.config file and how does request redirects to "Access Delayed
Page".
(The operation of this part is in which class or function).

-Vineet
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171104/e7848e92/attachment.html>

From squid3 at treenet.co.nz  Sat Nov  4 13:29:37 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 5 Nov 2017 02:29:37 +1300
Subject: [squid-dev] How does Squid blocks HTTP request
In-Reply-To: <CAAbd6H+5YwF1A9VRzH9e4uAu77V7-WE0FbeFZXA6cHvaW_=yeg@mail.gmail.com>
References: <CAAbd6H+5YwF1A9VRzH9e4uAu77V7-WE0FbeFZXA6cHvaW_=yeg@mail.gmail.com>
Message-ID: <58eec466-650f-8c9e-b49e-8a2672ac56cd@treenet.co.nz>

On 04/11/17 23:16, Vineet Awasthi wrote:
> Hi,
> 
> I am trying to understand the squid and want to know how does squid 
> handle incoming HTTP request and filter the request based on the 
> settings provided in the squid.config file and how does request 
> redirects to "Access Delayed Page".
> (The operation of this part is in which class or function).
> 

Uh, you just described what a significantly large portion of Squid code 
is for. Starting with "Http::NewServer" and ending with response delivery.

Is there anything more specific that you are trying to achieve than just 
understanding?

Amos

From 747620227 at qq.com  Mon Nov  6 00:50:44 2017
From: 747620227 at qq.com (=?gb18030?B?R35Efkx1bmF0aWM=?=)
Date: Mon, 6 Nov 2017 08:50:44 +0800
Subject: [squid-dev] thanks  for help
Message-ID: <tencent_05AE0E7C3D70057A45C4CFD97E1A00EBA608@qq.com>

thanks for help . because i'm a primary programmer, so my question maybe very concreteness. 

My purpose is complete a proxy . Now the problem is some  https website can't be reached. so i suppose that the certificate of  those https website were not parsed ,then the public key or the private  key was not gotten.
In my code of squid3.5.10 , there is a file named  ../src/ssl/support.cc  . I wonder whether store_session_cb() or other  similar function was responsible to establish ssl session ,then calls  the openssl internal function.
very very thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171106/3fd6fba1/attachment.html>

From vineetawasthi.technocrat at gmail.com  Sat Nov  4 22:11:52 2017
From: vineetawasthi.technocrat at gmail.com (Vineet Awasthi)
Date: Sun, 5 Nov 2017 03:41:52 +0530
Subject: [squid-dev] How does Squid blocks HTTP request
In-Reply-To: <58eec466-650f-8c9e-b49e-8a2672ac56cd@treenet.co.nz>
References: <CAAbd6H+5YwF1A9VRzH9e4uAu77V7-WE0FbeFZXA6cHvaW_=yeg@mail.gmail.com>
 <58eec466-650f-8c9e-b49e-8a2672ac56cd@treenet.co.nz>
Message-ID: <CAAbd6HLtpZnKDBu3v5AHrrnEjvLq6a4qtm5K4w_qx0sWuRVj0g@mail.gmail.com>

Thanks Amos, It is just for understanding and learning.I will update the
group if will get something interesting that can help to improve the Squid.
As of now i focusing on the two best part of squid - Access Control and
Caching and Please let me know if i need to understand some other stuff as
well.

-Vineet

On 4 November 2017 at 18:59, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 04/11/17 23:16, Vineet Awasthi wrote:
>
>> Hi,
>>
>> I am trying to understand the squid and want to know how does squid
>> handle incoming HTTP request and filter the request based on the settings
>> provided in the squid.config file and how does request redirects to "Access
>> Delayed Page".
>> (The operation of this part is in which class or function).
>>
>>
> Uh, you just described what a significantly large portion of Squid code is
> for. Starting with "Http::NewServer" and ending with response delivery.
>
> Is there anything more specific that you are trying to achieve than just
> understanding?
>
> Amos
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171105/aec46835/attachment.html>

From squid3 at treenet.co.nz  Mon Nov  6 16:42:02 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 7 Nov 2017 05:42:02 +1300
Subject: [squid-dev] thanks for help
In-Reply-To: <tencent_05AE0E7C3D70057A45C4CFD97E1A00EBA608@qq.com>
References: <tencent_05AE0E7C3D70057A45C4CFD97E1A00EBA608@qq.com>
Message-ID: <c46af2cd-f0bb-c9b1-3d36-d7488bf5958a@treenet.co.nz>

On 06/11/17 13:50, G~D~Lunatic wrote:
> thanks for help . because i'm a primary programmer, so my question maybe 
> very concreteness.
> 
> My purpose is complete a proxy . Now the problem is some https website 
> can't be reached. so i suppose that the certificate of those https 
> website were not parsed ,then the public key or the private key was not 
> gotten.

Do not make guesses. TLS is quite complex with many pieces to its puzzle.

You need to start with *exact* error which is occuring and find out 
which piece of software is generating it. Work from there to find out 
the cause.


> In my code of squid3.5.10 , there is a file named ../src/ssl/support.cc  
> . I wonder whether store_session_cb() or other similar function was 
> responsible to establish ssl session ,then calls the openssl internal 
> function.
> very very thank you.
> 

First thing to do when debugging TLS issues is to upgrade to the latest 
Squid. TLS is changing constantly these days, so a Squid from over two 
years ago is unlikely to work 100% with todays traffic.

Amos

From 747620227 at qq.com  Wed Nov  8 02:17:56 2017
From: 747620227 at qq.com (=?gb18030?B?R35Efkx1bmF0aWM=?=)
Date: Wed, 8 Nov 2017 10:17:56 +0800
Subject: [squid-dev] how to show the debug message
Message-ID: <tencent_662D7C2670FF7A52C40AD9361A60EB83AE08@qq.com>

how to show the debug message of squid?
do i need to recompose code or recompose configure file. thank you
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171108/643c7a91/attachment.html>

From squid3 at treenet.co.nz  Wed Nov  8 04:50:28 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 8 Nov 2017 17:50:28 +1300
Subject: [squid-dev] how to show the debug message
In-Reply-To: <tencent_662D7C2670FF7A52C40AD9361A60EB83AE08@qq.com>
References: <tencent_662D7C2670FF7A52C40AD9361A60EB83AE08@qq.com>
Message-ID: <807b41a5-dc48-2e26-9e1f-e89f3247135a@treenet.co.nz>

On 08/11/17 15:17, G~D~Lunatic wrote:
> how to show the debug message of squid?
> do i need to recompose code or recompose configure file. thank you
> 

See the bug reporting FAQ for details on retrieving debug info 
<https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_Squid>

Amos

From marcus.kool at urlfilterdb.com  Wed Nov  8 09:52:36 2017
From: marcus.kool at urlfilterdb.com (Marcus Kool)
Date: Wed, 8 Nov 2017 07:52:36 -0200
Subject: [squid-dev] wiki.squid-cache.org has an expired certificate
Message-ID: <cb036321-5478-abfd-368c-babd26f12f42@urlfilterdb.com>



From gkinkie at gmail.com  Wed Nov  8 09:55:44 2017
From: gkinkie at gmail.com (Kinkie)
Date: Wed, 8 Nov 2017 09:55:44 +0000
Subject: [squid-dev] wiki.squid-cache.org has an expired certificate
In-Reply-To: <cb036321-5478-abfd-368c-babd26f12f42@urlfilterdb.com>
References: <cb036321-5478-abfd-368c-babd26f12f42@urlfilterdb.com>
Message-ID: <CA+Y8hcM-ib3Pp0wRaCN2+tVzqGQYQ5=ubJ7gVKE6fnfVYNBEFg@mail.gmail.com>

Thanks for letting us know.
Now fixed.

On Wed, Nov 8, 2017 at 9:52 AM, Marcus Kool <marcus.kool at urlfilterdb.com> wrote:
>
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev



-- 
    Francesco

From 747620227 at qq.com  Thu Nov  9 02:19:22 2017
From: 747620227 at qq.com (=?gb18030?B?R35Efkx1bmF0aWM=?=)
Date: Thu, 9 Nov 2017 10:19:22 +0800
Subject: [squid-dev] squid3.5.27 can't show correctly https website.how can
	i certain the wrong area in code.
Message-ID: <tencent_E2643DD1758A4F002E57CF8CF825DB47E305@qq.com>

i used squid 3.5.27  . the website is www.hupu.com  . Serveral websites like this can't been shown correctly. 
i use command "./squid -k debug". The result like 
2017/11/08 16:06:03.996 kid1| 41,5| AsyncCall.cc(38) make: make call MaintainSwapSpace [call49573]
2017/11/08 16:06:03.996 kid1| 47,5| ufs/UFSSwapDir.cc(448) maintain: space still available in /usr/local/squid/var/cache/squid
2017/11/08 16:06:03.996 kid1| 41,7| event.cc(322) schedule: schedule: Adding 'MaintainSwapSpace', in 1.00 seconds
2017/11/08 16:06:03.996 kid1| 41,5| AsyncCallQueue.cc(57) fireNext: leaving MaintainSwapSpace()

i can't understand because i thought debug message come from following codes.
debugs(33, 3, "Connection gone while waiting for ssl_crtd helper reply; helper reply:" << reply);
debugs(33, 5, HERE << "Certificate for " << sslConnectHostOrIp << " was successfully recieved from ssl_crtd");

how can i certain the wrong area in code.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171109/8f6c99f2/attachment.html>

From liu747620227 at hotmail.com  Fri Nov 10 01:20:40 2017
From: liu747620227 at hotmail.com (Liu Mark)
Date: Fri, 10 Nov 2017 01:20:40 +0000
Subject: [squid-dev] how or where to show the debug message in squid code
Message-ID: <MA1PR01MB0117AE4CDF64DDFBDF51B4C988540@MA1PR01MB0117.INDPRD01.PROD.OUTLOOK.COM>

squid 3.5.27.   debug message in code such as

debugs(33, 5, HERE << "Certificate for " << sslConnectHostOrIp << " was 
successfully recieved from ssl_crtd");

where dose this message output. ...

Because i want to debug ssl in squid. thank you


From squid3 at treenet.co.nz  Fri Nov 10 02:39:55 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 10 Nov 2017 15:39:55 +1300
Subject: [squid-dev] how or where to show the debug message in squid code
In-Reply-To: <MA1PR01MB0117AE4CDF64DDFBDF51B4C988540@MA1PR01MB0117.INDPRD01.PROD.OUTLOOK.COM>
References: <MA1PR01MB0117AE4CDF64DDFBDF51B4C988540@MA1PR01MB0117.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <ee25a593-5470-8e6c-9ade-78b417cb21a9@treenet.co.nz>

On 10/11/17 14:20, Liu Mark wrote:
> squid 3.5.27.   debug message in code such as
> 
> debugs(33, 5, HERE << "Certificate for " << sslConnectHostOrIp << " was
> successfully recieved from ssl_crtd");
> 
> where dose this message output. ...
> 
> Because i want to debug ssl in squid. thank you
> 

See the bug reporting FAQ for details on retrieving debug info 
<https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_Squid>

Amos

From squid3 at treenet.co.nz  Fri Nov 10 03:42:48 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 10 Nov 2017 16:42:48 +1300
Subject: [squid-dev] squid3.5.27 can't show correctly https website.how
 can i certain the wrong area in code.
In-Reply-To: <tencent_E2643DD1758A4F002E57CF8CF825DB47E305@qq.com>
References: <tencent_E2643DD1758A4F002E57CF8CF825DB47E305@qq.com>
Message-ID: <ddc62035-5330-5e6a-9858-12d39ec2618f@treenet.co.nz>

On 09/11/17 15:19, G~D~Lunatic wrote:
> i used squid 3.5.27  . the website is www.hupu.com  . Serveral websites 
> like this can't been shown correctly.
> i use command "./squid -k debug". The result like
> 2017/11/08 16:06:03.996 kid1| 41,5| AsyncCall.cc(38) make: make call 
> MaintainSwapSpace [call49573]
> 2017/11/08 16:06:03.996 kid1| 47,5| ufs/UFSSwapDir.cc(448) maintain: 
> space still available in /usr/local/squid/var/cache/squid
> 2017/11/08 16:06:03.996 kid1| 41,7| event.cc(322) schedule: schedule: 
> Adding 'MaintainSwapSpace', in 1.00 seconds
> 2017/11/08 16:06:03.996 kid1| 41,5| AsyncCallQueue.cc(57) fireNext: 
> leaving MaintainSwapSpace()
> 
> i can't understand because i thought debug message come from following 
> codes.
The output you see on the screen with that command is the debug from the 
"squid" process you just ran to start the debugging happening in the 
proxy process that was already running.
  The output from the running Squid proxy is in cache.log. The instant 
it gets the debug signal that log should start to fill with its details, 
until it exists or gets another signal to disable the debugging again.


The above log entries do not come from, and have nothing to do with the 
code lines you quoted below.


> debugs(33, 3, "Connection gone while waiting for ssl_crtd helper reply; 
> helper reply:" << reply);
> debugs(33, 5, HERE << "Certificate for " << sslConnectHostOrIp << " was 
> successfully recieved from ssl_crtd");
> 
> how can i certain the wrong area in code.
> 


These debugs() lines you quoted are part of the TLS/SSL certificate 
helper API code. So only get output when that code runs.

* The first debugs() line is in the event of a ssl_crtd helper 
disconnecting/terminating/crashing unexpectedly.

This is an error situation, so you should never see it anywhere in your 
logs. If it does happen it means the helper crashed or something equally 
bad. So start debugging the helper itself, not Squid.

* The second debugs() line is in the event of a certificate being 
successfully received by Squid from that helper.

Obviously that should happen a lot and is not much use other than to 
identify timing of when things happened in the TLS/SSL processing.


Amos

From squid3 at treenet.co.nz  Fri Nov 10 12:45:34 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 11 Nov 2017 01:45:34 +1300
Subject: [squid-dev] =?utf-8?b?5Zue5aSN77yaICBzcXVpZDMuNS4yNyBjYW4ndCBz?=
 =?utf-8?q?how_correctly_https_website=2Ehowcan_i_certain_the_wrong_area_i?=
 =?utf-8?q?n_code=2E?=
In-Reply-To: <tencent_59F1E8A5134B65A76848AD47B8C2F155C00A@qq.com>
References: <tencent_E2643DD1758A4F002E57CF8CF825DB47E305@qq.com>
 <ddc62035-5330-5e6a-9858-12d39ec2618f@treenet.co.nz>
 <tencent_59F1E8A5134B65A76848AD47B8C2F155C00A@qq.com>
Message-ID: <57424718-e377-17f4-08f7-ba87b1df9365@treenet.co.nz>

[ Please keep replies going to the mailing list. ]

On 10/11/17 21:17, G~D~Lunatic wrote:
> very thank you .  What is the TLS/SSL certificate helper?

I mentioned it only because the debugs() lines you were talking were 
talking about a helper - which is a particular *type* of helper program...


> Because there're some problems when i accessed serveral https website, i 
> think i could add some debugs messages to find where wrong is.


Hold on. This is the first mention you have of any problem happening, 
after starting many threads asking how to debug Squid.

Please describe the details of these "some problems" that are happening. 
Then what you have done so far to look into them, and what you found out 
so far from those actions.



> So I just want to add and view debug information.
> Do you mind tell me more details on  how squid helps clients access the 
> HTTPS website, and which source files  should I focus on.
> If squid ask openssl to parse the certificate it received, then where 
> did it call the openssl interface API.

Unfortunately what you have been asking about is a whole complicated 
protocol and even more complicated code spread over multiple programs 
and libraries. There is no "just" debug and fix the problem. You have to 
know what pieces to look at first and what those pieces are supposed to 
look like.

You seem to be very much a beginner with these things and that means it 
is probably going to be very hard to do it yourself right now.

To give you proper help we have to know what you are trying to do - not 
just that you are trying to debug something unspecified, but what the 
problem *really* is that you are trying to solve.


Amos

From squid3 at treenet.co.nz  Mon Nov 13 01:59:46 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 13 Nov 2017 14:59:46 +1300
Subject: [squid-dev] =?utf-8?b?5Zue5aSN77yaIOWbnuWkje+8miAgc3F1aWQzLjUu?=
 =?utf-8?q?27_can=27t_show_correctly_https_website=2Ehowcan_i_certain_the_?=
 =?utf-8?q?wrong_area_in_code=2E?=
In-Reply-To: <tencent_3EF69AC6C83A97EB2C1F3A5C991E00B16706@qq.com>
References: <tencent_E2643DD1758A4F002E57CF8CF825DB47E305@qq.com>
 <ddc62035-5330-5e6a-9858-12d39ec2618f@treenet.co.nz>
 <tencent_59F1E8A5134B65A76848AD47B8C2F155C00A@qq.com>
 <57424718-e377-17f4-08f7-ba87b1df9365@treenet.co.nz>
 <tencent_3EF69AC6C83A97EB2C1F3A5C991E00B16706@qq.com>
Message-ID: <1b6fecf2-6fef-4957-aa92-75cc4bcde743@treenet.co.nz>

On 13/11/17 13:54, G~D~Lunatic wrote:
> Thank you .I'm a begginer indeed. firstly , i use squid 3.5.27 as a 
> transparent proxy. With the proxy , i access some https website like 
> www.hupu.com. But the webpage does not show correctly.  There are some 
> websize similar such as https://www.zhihu.com , https://www.jd.com/ and 
> mail.163.com(163.com is can't access not show correctly). So i want to 
> know where problem is or how to deal with it. Need your advice or help.
> 

Okay that is better. But please explain the "not show correctly".

  What is not "showing" ?
  How should it be showing?
  What HTTPS(S) transactions are involved with fetching that problematic 
content?
  How do those transactions appear to be going wrong?
  - not happening at all?
  - error messages?
  - unexpected status coming out of the proxy?

Details, details and lots more details :-)

Amos

From christos at chtsanti.net  Fri Nov 17 17:06:24 2017
From: christos at chtsanti.net (Christos Tsantilas)
Date: Fri, 17 Nov 2017 19:06:24 +0200
Subject: [squid-dev] New patches and squid-v4
Message-ID: <c4924426-049e-c346-ca62-95d9a5d34e15@chtsanti.net>

Hi all,

   I am a little confused about the procedure I should follow for 
applying patches to squid, specially for patches which should be 
included to squid-4.

For any mew patch, we are building a git-PR for merging it to 
squid-5/master. Should we make a git-PR for squid-4 too (and squid-3.5)? 
Or the squid-4 maintainer is responsible to extract the patch from 
squid-5 and merge it to squid-4?

Regards,
    Christos

From rousskov at measurement-factory.com  Fri Nov 17 17:45:34 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 17 Nov 2017 10:45:34 -0700
Subject: [squid-dev] New patches and squid-v4
In-Reply-To: <c4924426-049e-c346-ca62-95d9a5d34e15@chtsanti.net>
References: <c4924426-049e-c346-ca62-95d9a5d34e15@chtsanti.net>
Message-ID: <12125429-372b-4e4b-77f8-844c7f1212d5@measurement-factory.com>

On 11/17/2017 10:06 AM, Christos Tsantilas wrote:

> For any mew patch, we are building a git-PR for merging it to
> squid-5/master. Should we make a git-PR for squid-4 too (and squid-3.5)?
> Or the squid-4 maintainer is responsible to extract the patch from
> squid-5 and merge it to squid-4?

Amos is the primary decision maker on this, but I would suggest a simple
procedure that mimics closely the pre-GitHub procedure:

1. The maintainer is responsible for committing backports. To get the
benefits of automated testing, he or she may open GitHub PRs (one for
each backported feature for each branch), but there is currently no
requirement to do so.

2. Anybody can backport. The backporter can post a patch, but opening a
dedicated PR (as described in #1) reduces maintainer's load and offers
automated tests. Naturally, the less work the maintainer has to do and
the more confidence they have in the patch, the more likely he or she
will commit the backport. Thus, backporting PRs should be encouraged.

3. I failed to find a _standard_ way to do this, but backport PRs should
reference the original/master commit (where available), at the bottom of
the commit message. For example:

-----------
Fixed %<Hs, %<pt, %<tt, %<bs calculation bugs for error responses (#90)

Backports commit d81657759f3ac9f3e688b4b2e8051166a23f01e1
-----------

One alternative is to reuse a single GitHub PR for all backports, but in
my experience this is difficult to do correctly. It also prohibits
concurrent backports of the same feature to multiple branches. GitHub is
not just designed for that AFAICT.

Another alternative is to commit backported patches without a PR. Item
#1 allows for that.


HTH,

Alex.

From christos at chtsanti.net  Fri Nov 17 18:09:03 2017
From: christos at chtsanti.net (Christos Tsantilas)
Date: Fri, 17 Nov 2017 20:09:03 +0200
Subject: [squid-dev] New patches and squid-v4
In-Reply-To: <12125429-372b-4e4b-77f8-844c7f1212d5@measurement-factory.com>
References: <c4924426-049e-c346-ca62-95d9a5d34e15@chtsanti.net>
 <12125429-372b-4e4b-77f8-844c7f1212d5@measurement-factory.com>
Message-ID: <e3f3d461-6664-2474-d0cb-75220c3eb06f@chtsanti.net>

Στις 17/11/2017 07:45 μμ, ο Alex Rousskov έγραψε:
> On 11/17/2017 10:06 AM, Christos Tsantilas wrote:
> 
>> For any mew patch, we are building a git-PR for merging it to
>> squid-5/master. Should we make a git-PR for squid-4 too (and squid-3.5)?
>> Or the squid-4 maintainer is responsible to extract the patch from
>> squid-5 and merge it to squid-4?
> 
> Amos is the primary decision maker on this, but I would suggest a simple
> procedure that mimics closely the pre-GitHub procedure:
> 
> 1. The maintainer is responsible for committing backports. To get the
> benefits of automated testing, he or she may open GitHub PRs (one for
> each backported feature for each branch), but there is currently no
> requirement to do so.
> 
> 2. Anybody can backport. The backporter can post a patch, but opening a
> dedicated PR (as described in #1) reduces maintainer's load and offers
> automated tests. Naturally, the less work the maintainer has to do and
> the more confidence they have in the patch, the more likely he or she
> will commit the backport. Thus, backporting PRs should be encouraged.

I agree.
However in many cases the patches can just merged without any 
modification. A new PR in these cases may cause more load.


> 
> 3. I failed to find a _standard_ way to do this, but backport PRs should
> reference the original/master commit (where available), at the bottom of
> the commit message. For example:
> 
> -----------
> Fixed %<Hs, %<pt, %<tt, %<bs calculation bugs for error responses (#90)
> 
> Backports commit d81657759f3ac9f3e688b4b2e8051166a23f01e1
> -----------
> 
> One alternative is to reuse a single GitHub PR for all backports, but in
> my experience this is difficult to do correctly. It also prohibits
> concurrent backports of the same feature to multiple branches. GitHub is
> not just designed for that AFAICT.
> 
> Another alternative is to commit backported patches without a PR. Item
> #1 allows for that.
> 
> 
> HTH,
> 
> Alex.
> 


From rousskov at measurement-factory.com  Fri Nov 17 18:13:02 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 17 Nov 2017 11:13:02 -0700
Subject: [squid-dev] New patches and squid-v4
In-Reply-To: <e3f3d461-6664-2474-d0cb-75220c3eb06f@chtsanti.net>
References: <c4924426-049e-c346-ca62-95d9a5d34e15@chtsanti.net>
 <12125429-372b-4e4b-77f8-844c7f1212d5@measurement-factory.com>
 <e3f3d461-6664-2474-d0cb-75220c3eb06f@chtsanti.net>
Message-ID: <0c271526-e4ea-6053-36cd-b22709c6fe65@measurement-factory.com>

On 11/17/2017 11:09 AM, Christos Tsantilas wrote:

> However in many cases the patches can just merged without any
> modification. A new PR in these cases may cause more load.

Yes, but, except for really trivial changes (which are fairly rare), the
regression tests should still be executed. Our current tests suck, but
they will start getting better as soon as we are done with the merging bot.

Alex.

From squid3 at treenet.co.nz  Thu Nov 23 13:10:06 2017
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 24 Nov 2017 02:10:06 +1300
Subject: [squid-dev] State of things and stuff
Message-ID: <2c4a2fa7-3ee3-c3c8-f749-0324e96ad3fe@treenet.co.nz>

As some of you know since the git transition I've had a few issues with 
converting the maintainer scripts which has been the roadblock on our 
regular release schedule.

The biggest of those issues are now resolved, and the remainder can go 
back to being a manual process for now.

So I am planning to do a push on the outstanding backports over the next 
few days. That should give us next week for testing before a 4.0.22 
release on 2nd or 3rd October.

At this stage I am not planning on any more v3.5 releases, but that is 
still flexible so it is not formally deprecated (yet).

Amos

From gkinkie at gmail.com  Sun Nov 26 22:53:16 2017
From: gkinkie at gmail.com (Kinkie)
Date: Sun, 26 Nov 2017 22:53:16 +0000
Subject: [squid-dev] State of things and stuff
In-Reply-To: <2c4a2fa7-3ee3-c3c8-f749-0324e96ad3fe@treenet.co.nz>
References: <2c4a2fa7-3ee3-c3c8-f749-0324e96ad3fe@treenet.co.nz>
Message-ID: <CA+Y8hcMYBC8GZm7wAwb5zdNfNnDOtnt7YDjBvc7FNPOrXMZGDQ@mail.gmail.com>

Ok thanks!
Do we have a map of the missing bits? Maybe I could help there

On Thu, 23 Nov 2017 at 13:10, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> As some of you know since the git transition I've had a few issues with
> converting the maintainer scripts which has been the roadblock on our
> regular release schedule.
>
> The biggest of those issues are now resolved, and the remainder can go
> back to being a manual process for now.
>
> So I am planning to do a push on the outstanding backports over the next
> few days. That should give us next week for testing before a 4.0.22
> release on 2nd or 3rd October.
>
> At this stage I am not planning on any more v3.5 releases, but that is
> still flexible so it is not formally deprecated (yet).
>
> Amos
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
>
-- 
@mobile
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171126/5a61a4ef/attachment.html>

From gkinkie at gmail.com  Thu Nov 30 10:12:58 2017
From: gkinkie at gmail.com (Kinkie)
Date: Thu, 30 Nov 2017 10:12:58 +0000
Subject: [squid-dev] Stuck jenkins jobs
Message-ID: <CA+Y8hcPgWqTts31d8SL3eTTfE0KMrTRPkGjY9iVc8LMchasw5g@mail.gmail.com>

Hi,
  I've added the build-timeout plugin to jenkins; it'll abort
pull-request validation jobs that take "several times their usual
completion times". Let's see if it helps unstick the queue.

-- 
    Francesco

From rousskov at measurement-factory.com  Thu Nov 30 16:01:05 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 30 Nov 2017 09:01:05 -0700
Subject: [squid-dev] Stuck jenkins jobs
In-Reply-To: <CA+Y8hcPgWqTts31d8SL3eTTfE0KMrTRPkGjY9iVc8LMchasw5g@mail.gmail.com>
References: <CA+Y8hcPgWqTts31d8SL3eTTfE0KMrTRPkGjY9iVc8LMchasw5g@mail.gmail.com>
Message-ID: <5241e357-b441-48e3-da03-28a40beb1655@measurement-factory.com>

On 11/30/2017 03:12 AM, Kinkie wrote:

>   I've added the build-timeout plugin to jenkins; it'll abort
> pull-request validation jobs that take "several times their usual
> completion times". Let's see if it helps unstick the queue.

Thank you. Will these automated aborts be logged with the right actor
and sufficient detail to understand what happened?

Alex.

From gkinkie at gmail.com  Thu Nov 30 16:05:06 2017
From: gkinkie at gmail.com (Kinkie)
Date: Thu, 30 Nov 2017 16:05:06 +0000
Subject: [squid-dev] Stuck jenkins jobs
In-Reply-To: <5241e357-b441-48e3-da03-28a40beb1655@measurement-factory.com>
References: <CA+Y8hcPgWqTts31d8SL3eTTfE0KMrTRPkGjY9iVc8LMchasw5g@mail.gmail.com>
 <5241e357-b441-48e3-da03-28a40beb1655@measurement-factory.com>
Message-ID: <CA+Y8hcOi4utJUh=B0cH=-1Eb9DKppFzWDBN6FVE2n6+0M=dVUg@mail.gmail.com>

I believe so, let’s see in practice

On Thu, 30 Nov 2017 at 16:01, Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 11/30/2017 03:12 AM, Kinkie wrote:
>
> >   I've added the build-timeout plugin to jenkins; it'll abort
> > pull-request validation jobs that take "several times their usual
> > completion times". Let's see if it helps unstick the queue.
>
> Thank you. Will these automated aborts be logged with the right actor
> and sufficient detail to understand what happened?
>
> Alex.
>
-- 
@mobile
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20171130/91a4aafa/attachment.html>

From rousskov at measurement-factory.com  Thu Nov 30 17:54:47 2017
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 30 Nov 2017 10:54:47 -0700
Subject: [squid-dev] Squid 3.5 with nonblocking ecap adapter
In-Reply-To: <CAFyThpJgyzDj4Yt0u9kz-bDuu=pqToGOMRQVkot5PpHZqyfe2A@mail.gmail.com>
References: <CAFyThpJ79PjfCJspusGzK1LeRL7-Qg5F7m_PrLLVYYRsWO-UAQ@mail.gmail.com>
 <572c5876-1762-3284-9b0c-93d2188f237a@measurement-factory.com>
 <CAFyThp+67yMOrXfbMnfSccxXRop-pMihdmwLKuTZGqRa+X4rPg@mail.gmail.com>
 <8b20a9f5-09a4-425d-892b-05cbc5a331c6@measurement-factory.com>
 <CAFyThpJgyzDj4Yt0u9kz-bDuu=pqToGOMRQVkot5PpHZqyfe2A@mail.gmail.com>
Message-ID: <80552023-59cd-978f-509b-15fe37d5e0ef@measurement-factory.com>

On 11/30/2017 09:39 AM, Christof Gerber wrote:

> First tests with my eCAP adapter in asynchronous mode which performs
> lookups to non-blocking unix sockets seem promising.  I use std::queue
> to implement a FIFO queue in the adapter which tracks pointers to the
> file-descriptor (non-blocking unix socket) of pending lookups as well
> as a link (shared pointer) to the corresponding Xaction. Similiar as
> it is solved in ClamAV adapter.

Glad you are making progress!


> The difference though is that I do not use any threads for the actual
> asynchronous action. This of course is only possible for applications
> in which a second process on the other side of the socket is doing
> the work (processing the lookup) for which to finish one can poll
> within resume().

Correct. In the ClamAV adapter case, the primary ClamAV library call is
blocking so we used threads to make that asynchronous.


> One thing I noticed which I am concerned about:
> 
> Squid with one async ecap adapter attached decreases the content
> sending speed (squid -> ecap only) significantly (from ~64kB before to
> ~16kB per vbContent cycle). I wonder if this is due to the additional
> polling of (resume() and suspend()) that happens also every time
> before noteVbContentAvailable()? 

I think it might be, provided your adapter forces Squid to use a shorter
polling timeout:

* In (simplified) theory, polling should stop as soon as the first data
packet arrives, and so Squid should receive the same amount of data
regardless of the polling timeout.

* In practice, I would not be surprised if less frequent (higher
timeout) polling may result in larger data chunks accumulated by the TCP
stack. The theoretical "as soon as" principles are trumped by interrupt
granularity and kernel implementation assumptions/simplifications. In
other words, if we let the kernel poll longer, the kernel might poll
longer, even if there is some data available already. Since Squid reads
after polling, the longer we poll, the more data may arrive by the time
Squid reads.


> Is Squid reducing the file chunk size
> from 64kB to 16kB to meet the polling timeout time (polling interval)?

I do not think so. Squid should be using the same network buffer size
regardless of the polling timeout (unless there is some
hidden/unintended dependency that I do not know about). The amount of
data in that Squid buffer depends on network traffic, polling frequency,
and other external factors.


> As speed is only slow in the squid->ecap virgin body transaction and
> it stays the same as in non-async mode for the adapted body
> transaction (ecap -> squid), I wonder why Squid behaves like that and
> how I can change or influence that?

I would start by validating the working theory that the polling timeout
affects available virgin data sizes. Do larger adapter-set resume()
timeouts increase available virgin data sizes?

Alex.


> On 2 November 2017 at 16:47, Alex Rousskov wrote:
>> On 11/02/2017 03:49 AM, Christof Gerber wrote:
>>
>>> One thing I still don't fully understand is if the asynchronous way to
>>> program and operate Squid with an eCAP adapter necessarily relies on
>>> threads?
>>
>> No, threads are just one popular way to achieve asynchrony. One may also
>> use multiple processes or (for some definition of asynchrony) event loops.
>>
>>
>>> Are A) and B) alternatives or the only options?
>>
>> If you replace B's "threads" with "threads or other asynchrony
>> mechanisms", then yes, IMO. Threads are probably the most popular way to
>> achieve asynchrony in new code.
>>
>>
>>> I've seen that both the
>>> ClamAV and sample async adapter use pthreads. In my use case I need to
>>> do a simple hash lookup to a file socket somewhen during the eCAP
>>> interaction. As it will take some milliseconds until the response will
>>> be available on the socket I don't want to block Squid during this
>>> time.
>>
>> Yes, this is a common problem.
>>
>>
>>> But the eCAP adapter won't need to process/compute anything else
>>> during this time. So why would I bother to use threads?
>>
>> ... because without threads (or processes or event loops) your adapter
>> lookup will block the whole Squid worker while waiting for socket I/O.
>>
>> If you do not want to use threads or processes in your adapter, then you
>> can try to use an event loop model. That is what Squid uses internally
>> (each Squid worker does not have threads to process thousands of
>> transactions "concurrently").
>>
>> To use an event loop model, your adapter will need to use non-blocking
>> socket I/O and schedule _one_ I/O loop iteration every ~X milliseconds,
>> when Squid calls your Service::resume(). Try googling "I/O loop" or
>> "select loop" for starting points if you are not familiar with that
>> design pattern. The overall host-adapter interaction would be very
>> similar to what you find in the sample and ClamAV adapters.
>>
>> Disclaimer: I have not seen anybody using event loops with eCAP. I think
>> it is possible to implement that model, but there may be important
>> caveats that I am not aware of.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> On 1 November 2017 at 16:23, Alex Rousskov wrote:
>>>> On 11/01/2017 03:20 AM, Christof Gerber wrote:
>>>>
>>>>> [Will Squid] be blocked until the eCAP API call returns?
>>>>
>>>> To answer the exact question above: Yes, the Squid worker making an eCAP
>>>> API call will block until that call returns. The same is true for all
>>>> other API calls, all system calls, and all internal calls. This is how
>>>> C/C++ works. I am stating the obvious for the record, in case somebody
>>>> with a different (or insufficient) programming languages background
>>>> stumbles upon this thread.
>>>>
>>>> What you are really asking, I suspect, is whether Squid or the eCAP
>>>> library uses threads to automatically make eCAP adapter operations
>>>> asynchronous to the primary Squid operations. The answer to that
>>>> question is "no": The relevant Squid code does not use threads, and
>>>> there are no threads in the eCAP library code.
>>>>
>>>> Also, there is no magical layer between Squid and 99% of eCAP calls --
>>>> Squid calls go directly to your eCAP adapter code and vice versa. IIRC,
>>>> the only (unimportant) exception to that "direct calls" observation is
>>>> the eCAP service registry API, where there is a thin eCAP layer
>>>> insulating the adapter from the host application. That layer is also
>>>> synchronous though.
>>>>
>>>>
>>>>> Is there a way other than
>>>>> programming the eCAP adapter in asynchronous mode?
>>>>
>>>> I do not think there is a better alternative. AFAICT, you only have two
>>>> options:
>>>>
>>>>   A) Change Squid to move eCAP calls to thread(s).
>>>>   B) Use threads inside the adapter to make its operations asynchronous.
>>>>
>>>> As you know, the sample async adapter and the ClamAV adapter use (B).
>>>> That approach has its problems (because it currently does not require
>>>> the host application to be threads-aware), but it works reasonably well
>>>> for many use cases.
>>>>
>>>>
>>>> Cheers,
>>>>
>>>> Alex.
>>
> 
> 
> 


