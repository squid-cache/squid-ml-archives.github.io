<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Changed SSL bump event ordering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Changed%20SSL%20bump%20event%20ordering&In-Reply-To=%3Cd324b06b-b55e-ada5-3de3-77d07fe9fcde%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009303.html">
   <LINK REL="Next"  HREF="009296.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Changed SSL bump event ordering</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Changed%20SSL%20bump%20event%20ordering&In-Reply-To=%3Cd324b06b-b55e-ada5-3de3-77d07fe9fcde%40opendium.com%3E"
       TITLE="[squid-dev] Changed SSL bump event ordering">steve at opendium.com
       </A><BR>
    <I>Mon Sep 18 16:44:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009303.html">[squid-dev] Online Translator interface for Squid
</A></li>
        <LI>Next message: <A HREF="009296.html">[squid-dev] Changed SSL bump event ordering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9295">[ date ]</a>
              <a href="thread.html#9295">[ thread ]</a>
              <a href="subject.html#9295">[ subject ]</a>
              <a href="author.html#9295">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I'm not sure when this changed - more debugging tomorrow but I thought 
I'd post what I've found so far in case anyone has any input.

When peek/splice was first introduced, as far as I remember it worked 
like this (for transparently proxied connections):

1. Connection is accepted.
2. The ssl_bump ACL is checked for step 1 (my config produces a &quot;peek&quot; 
result).
3. The TLS session is peeked.
4. A fake CONNECT is produced containing the host name from the peeked SNI.
5. The spoof_client_ip, http_access, adaptation_access and cache ACLs 
are checked.
7. ICAP REQMOD callout
6. The ssl_bump ACL is checked for step 2.


Testing with Squid 3.5.26, this event order has changed, moving the 
peeking process until later:

1. Connection is accepted.
2. ssl_bump ACL is checked for step 1 (returning &quot;peek&quot;).
3. A fake CONNECT is produced containing the web server's IP address.
4. The spoof_client_ip, http_access, adaptation_access and cache ACLs 
are checked.
5. The TLS session is peeked.
6. The ssl_bump ACL is checked for step 2.
(The ICAP REQMOD callout no longer seems to happen)


This means the peeked SNI is no longer available when processing the 
majority of ACLs.  The upshot is that:
1. http_access ACL rules can only operate on the IP address, rather than 
the SNI.
2. The http_access ACL produces an HTTP response (e.g. a 302 redirect), 
Squid has to bump the connection.  Since the connection hasn't yet been 
peeked, the forged certificate contains the server's IP address rather 
than host name and the browser displays a security warning.


Looking at the code, client_side.cc:ConnStateData::fakeAConnectRequest() 
still contains the code to insert the SNI into the fake CONNECT:
     if (serverBump() &amp;&amp; !serverBump()-&gt;clientSni.isEmpty()) {
         connectHost.assign(serverBump()-&gt;clientSni);
         if (clientConnection-&gt;local.port() &gt; 0)
             connectHost.appendf(&quot;:%d&quot;,clientConnection-&gt;local.port());

However, this happens long before the connection is actually peeked.

I've not tested non-transparent mode yet.  Am I missing something or has 
this all changed at some point?

-- 
  - Steve Hill
    Technical Director
    Opendium    Online Safety / Web Filtering    <A HREF="http://www.opendium.com">http://www.opendium.com</A>

    Enquiries                 Support
    ---------                 -------
    <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>        <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>
    +44-1792-824568           +44-1792-825748
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009303.html">[squid-dev] Online Translator interface for Squid
</A></li>
	<LI>Next message: <A HREF="009296.html">[squid-dev] Changed SSL bump event ordering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9295">[ date ]</a>
              <a href="thread.html#9295">[ thread ]</a>
              <a href="subject.html#9295">[ subject ]</a>
              <a href="author.html#9295">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
