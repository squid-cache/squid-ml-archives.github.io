<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Changed SSL bump event ordering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Changed%20SSL%20bump%20event%20ordering&In-Reply-To=%3C0c5c8c3b-f090-f5d5-8bf5-418c9a6a2b01%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009295.html">
   <LINK REL="Next"  HREF="009297.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Changed SSL bump event ordering</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Changed%20SSL%20bump%20event%20ordering&In-Reply-To=%3C0c5c8c3b-f090-f5d5-8bf5-418c9a6a2b01%40measurement-factory.com%3E"
       TITLE="[squid-dev] Changed SSL bump event ordering">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Sep 18 18:33:15 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="009295.html">[squid-dev] Changed SSL bump event ordering
</A></li>
        <LI>Next message: <A HREF="009297.html">[squid-dev] Changed SSL bump event ordering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9296">[ date ]</a>
              <a href="thread.html#9296">[ thread ]</a>
              <a href="subject.html#9296">[ subject ]</a>
              <a href="author.html#9296">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/18/2017 10:44 AM, Steve Hill wrote:

&gt;<i> I'm not sure when this changed - more debugging tomorrow but I thought
</I>&gt;<i> I'd post what I've found so far in case anyone has any input.
</I>&gt;<i> 
</I>&gt;<i> When peek/splice was first introduced, as far as I remember it worked
</I>&gt;<i> like this (for transparently proxied connections):
</I>&gt;<i> 
</I>&gt;<i> 1. Connection is accepted.
</I>&gt;<i> 2. The ssl_bump ACL is checked for step 1 (my config produces a &quot;peek&quot;
</I>&gt;<i> result).
</I>&gt;<i> 3. The TLS session is peeked.
</I>&gt;<i> 4. A fake CONNECT is produced containing the host name from the peeked SNI.
</I>&gt;<i> 5. The spoof_client_ip, http_access, adaptation_access and cache ACLs
</I>&gt;<i> are checked.
</I>&gt;<i> 7. ICAP REQMOD callout
</I>&gt;<i> 6. The ssl_bump ACL is checked for step 2.
</I>

&gt;<i> Testing with Squid 3.5.26, this event order has changed, moving the
</I>&gt;<i> peeking process until later:
</I>&gt;<i> 
</I>&gt;<i> 1. Connection is accepted.
</I>&gt;<i> 2. ssl_bump ACL is checked for step 1 (returning &quot;peek&quot;).
</I>&gt;<i> 3. A fake CONNECT is produced containing the web server's IP address.
</I>&gt;<i> 4. The spoof_client_ip, http_access, adaptation_access and cache ACLs
</I>&gt;<i> are checked.
</I>&gt;<i> 5. The TLS session is peeked.
</I>&gt;<i> 6. The ssl_bump ACL is checked for step 2.
</I>&gt;<i> (The ICAP REQMOD callout no longer seems to happen)
</I>
AFAICT, neither summary is how things should work. The first is missing
IP-based CONNECT adaptation. The second is missing SNI-based CONNECT
adaptation. You need just the second one, but both should be there to
cover typical use cases.

Also, I would expect the first adaptation and http_access checks
_before_ the first ssl_bump check (as documented at the wiki page
below), not after it (as shown in your second list):

  <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>


&gt;<i> Am I missing something or has this all changed at some point?
</I>
This reminds me of the following fix, but I have not investigated (or
forgot) whether that fix is needed in v3.5, whether that fix is about
the same problem you are describing, and whether there are other
problems that may have similar symptoms:

<A HREF="https://github.com/squid-cache/squid/commit/75f6c253bcf019665b736ebc6d257cd56bfca400">https://github.com/squid-cache/squid/commit/75f6c253bcf019665b736ebc6d257cd56bfca400</A>

If it is not difficult, please see whether Squid v5/master works OK.


Thank you,

Alex.
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009295.html">[squid-dev] Changed SSL bump event ordering
</A></li>
	<LI>Next message: <A HREF="009297.html">[squid-dev] Changed SSL bump event ordering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9296">[ date ]</a>
              <a href="thread.html#9296">[ thread ]</a>
              <a href="subject.html#9296">[ subject ]</a>
              <a href="author.html#9296">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
