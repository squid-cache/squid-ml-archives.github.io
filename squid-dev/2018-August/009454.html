<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] TLS proxy-server connection optimization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20TLS%20proxy-server%20connection%20optimization&In-Reply-To=%3C2995e24b-676b-64fa-ca9a-58b0c84b60d0%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009453.html">
   <LINK REL="Next"  HREF="009457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] TLS proxy-server connection optimization</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20TLS%20proxy-server%20connection%20optimization&In-Reply-To=%3C2995e24b-676b-64fa-ca9a-58b0c84b60d0%40measurement-factory.com%3E"
       TITLE="[squid-dev] TLS proxy-server connection optimization">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Aug  4 02:45:03 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009453.html">[squid-dev] TLS proxy-server connection optimization
</A></li>
        <LI>Next message: <A HREF="009457.html">[squid-dev] Squid supports two-ssl auth as mated squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9454">[ date ]</a>
              <a href="thread.html#9454">[ thread ]</a>
              <a href="subject.html#9454">[ subject ]</a>
              <a href="author.html#9454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/03/2018 06:15 PM, Vishali Somaskanthan wrote:

&gt;<i> [Alex] Why does Squid close the (not pinned) Squid-to-server connection
</I>&gt;<i> in this case? What code/condition triggers that closure in your tests?
</I>&gt;<i> 
</I>&gt;<i> When the SSL-bump steps are
</I>&gt;<i> 1. *peek-splice and peek-peek-splice*, 
</I>
Ah, I see. This is a tunneled connection. It is equivalent to pinning
for most purposes, but the pinning methods are not used because
tunnel.cc code operates on both connections at once. Pinning methods are
mostly needed to associate the to-server connection with the future
from-client request, but tunnel.cc does not have future requests. It
only shovels bytes.

&gt;<i> we observe the behavior that squid does tunneling and presume that SSL
</I>&gt;<i> proxying is not happening in this case. 
</I>&gt;<i> Hence, after the series of writes, /keepGoingAfterRead()/ is called
</I>&gt;<i> where the following snippet triggers the closure from squid to server.
</I>&gt;<i> 
</I>&gt;<i> //* Only close the remote end if we've finished queueing data to it *//
</I>&gt;<i> /        if (from.len == 0 &amp;&amp; Comm::IsConnOpen(to.conn) ) {/
</I>&gt;<i> /            to.conn-&gt;close();/
</I>&gt;<i> 
</I>&gt;<i> Here, we would to like to do the optimization where instead of closing
</I>&gt;<i> them, we want to Push the connection to Pconn pool which can be used
</I>&gt;<i> later for a second request.
</I>
Let's assume you did that. How would Squid know which clients can reuse
that old to-server connection? Would any client requesting a tunnel to
the same server name be eligible? Any client requesting a tunnel to the
same server IP? A client with some specific TLS Hello properties? A
client from the same IP address as the disconnected client? A client
that is authorized by some new directive? Etc.

Would the to-server connection be reusable only when the client
connection was closed with a zero-length read? Or in some other cases?

Many of the above choices would break clients and/or servers. Some may
be safe in the hands of capable sysadmins. Your proposal has to document
your choice(s), explain why they are the best (or at least good), and
analyze the associated risks/problems.


&gt;<i> 2. *peek-bump*
</I>&gt;<i> *
</I>&gt;<i> As we have discussed already in the general forum
</I>&gt;<i> (<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/server-persistent-connections-and-cache-td4685973.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/server-persistent-connections-and-cache-td4685973.html</A>
</I>&gt;<i> &lt;<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/server-persistent-connections-and-cache-td4685973.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/server-persistent-connections-and-cache-td4685973.html</A>&gt;),
</I>&gt;<i> the table contains the cases where pinning happens and where not, we
</I>&gt;<i> would like to achieve the SSL persistence here from squid to-server
</I>&gt;<i> connection. When we unpin the connection it gets closed, and we would
</I>&gt;<i> like to retain them up in the pool. Please let me know what information
</I>&gt;<i> is required in this case for further validation. 
</I>
The bumping cases have pretty much the same unanswered questions as
splicing cases (and more). Bumping cases have access to HTTP-level
information (of bumped messages), but I do not know whether you need
that information to restrict reuse.

Please note that this is not so much about the code right now. It is
about deciding and documenting what you want Squid to do (differently)
at the level of detail sufficient for others to review your proposal and
make correct, informed recommendations.

Today, we do not know why you want to reuse some connections, and how
you want to map your needs to Squid configuration/functionality changes.
Thus, it is impossible to predict whether your future changes will be
accepted even if those changes are implemented correctly and beautifully.


HTH,

Alex.


&gt;<i> On Tue, Jul 31, 2018 at 4:29 PM, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 07/31/2018 05:00 PM, Vishali Somaskanthan wrote:
</I>&gt;<i>     &gt; If I peek @step1 and splice@ step2 -&gt; The connections are **not**
</I>&gt;<i>     pinned
</I>&gt;<i>     &gt; as such. However, Client-squid SSL+TCP termination results in
</I>&gt;<i>     &gt; squid-server SSL+TCP termination.
</I>&gt;<i> 
</I>&gt;<i>     Why does Squid close the (not pinned) Squid-to-server connection in this
</I>&gt;<i>     case? What code/condition triggers that closure in your tests?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; Please provide any insights on whether this is going to be a valid
</I>&gt;<i>     &gt; optimization and if we can come up with a set of rules where this
</I>&gt;<i>     &gt; could apply.
</I>&gt;<i> 
</I>&gt;<i>     With enough information/analysis, we should be able to correctly
</I>&gt;<i>     evaluate your proposal, but that proposal will have to be a lot more
</I>&gt;<i>     specific than &quot;We want to optimize TLS and evaluate if squid to-server
</I>&gt;<i>     TLS connection can be reused for consecutive requests from multiple
</I>&gt;<i>     clients&quot;. My question above is a (small) step towards formulating a
</I>&gt;<i>     specific &quot;We want to change Squid to do X instead of Y&quot; proposal.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Thank you,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Regards,
</I>&gt;<i> Vishali Somaskanthan
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i> 
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009453.html">[squid-dev] TLS proxy-server connection optimization
</A></li>
	<LI>Next message: <A HREF="009457.html">[squid-dev] Squid supports two-ssl auth as mated squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9454">[ date ]</a>
              <a href="thread.html#9454">[ thread ]</a>
              <a href="subject.html#9454">[ subject ]</a>
              <a href="author.html#9454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
