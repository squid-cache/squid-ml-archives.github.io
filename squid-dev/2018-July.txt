From squid3 at treenet.co.nz  Mon Jul  2 03:58:09 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 2 Jul 2018 15:58:09 +1200
Subject: [squid-dev] Squid-3.5 future
Message-ID: <867f6798-ea1f-b6f1-5e22-0524318f603e@treenet.co.nz>

Hi all,

Now that Squid-4 has finally achieved a stable release its time to
formally deprecated support for Squid-3.5 series.

  As per policy Squid-3.5 is officially deprecated as of today.

I would normally release a final 3.5 tarball alongside the 4.1 tarball.
But due to time constraints have not been able to this time.

So, the plan right now is to release that final 3.5 package next weekend
or soon thereafter. In the meanwhile I will be looking through the list
of backport candidates to see what looks reasonable. If anyone is aware
of patches in v4 which really should be in v3.5 please mention them as
followup to this message ASAP so I can give them closer consideration.

Keep in mind that patches touching say 100-ish lines or more are
starting to look "too big" for backport, and of course anything that
alters existing squid.conf or other UI behaviours is a no-go.


Cheers
Amos


From eliezer at ngtech.co.il  Mon Jul  9 18:00:01 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Mon, 09 Jul 2018 21:00:01 +0300
Subject: [squid-dev] Support lower case http/ spn format for
 realmd/adcli join support.
In-Reply-To: <2197768425D7F5479A0FFB3FEC212F7FF63D28C5@aesmail.surcouf.local>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>
 <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>
 <be402abb-32f4-4dc2-89c5-bf6e2d0e5986@email.android.com>
 <b6f1990d-b8ef-5e55-45a0-59ce4cbf64ae@treenet.co.nz>
 <2197768425D7F5479A0FFB3FEC212F7FF63D1EE1@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63D28C5@aesmail.surcouf.local>
Message-ID: <52ea2f31b5990cfe6648dc627ec55c2d@ngtech.co.il>

Mike,

It's better to have some noise around rather then slow and deadly 
silence.

Eliezer

On 2018-06-28 18:02, Mike Surcouf wrote:
> Adding to this after testing more I realised that adcli does not lower
> case the SPN.
> I am not sure how I came to that conclusion sorry for noise.
> 
> -----Original Message-----
> From: squid-dev [mailto:squid-dev-bounces at lists.squid-cache.org] On
> Behalf Of Mike Surcouf
> Sent: 28 June 2018 09:28
> To: 'Amos Jeffries'
> Cc: squid-dev at lists.squid-cache.org
> Subject: Re: [squid-dev] Support lower case http/ spn format for
> realmd/adcli join support.
> 
> Hi Amos thanks for that I need to correct you on the REALM bit though.
> 
> The bit before the slash in an SPN (service principal name) is SERVICE 
> not REALM
> 
> So for a computer that has a
> service =service
> fqdn= SomeComputer.example.com
> REALM= EXAMPLE.COM
> 
> service/SomeComputer.example.com at EXAMPLE.COM
> 
> So for a computer that has a
> service =HTTP
> fqdn= SomeComputer.example.com
> REALM= EXAMPLE.COM
> 
> HTTP/SomeComputer.example.com at EXAMPLE.COM
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev

-- 
----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

From eliezer at ngtech.co.il  Mon Jul  9 18:02:25 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Mon, 09 Jul 2018 21:02:25 +0300
Subject: [squid-dev] max_url : Pls, into squid.conf
In-Reply-To: <32f2e3d7-c0c4-3e8c-0787-15e82c301aca@treenet.co.nz>
References: <1528540539732-0.post@n4.nabble.com>
 <32f2e3d7-c0c4-3e8c-0787-15e82c301aca@treenet.co.nz>
Message-ID: <868e113e453a38ef71d71af761f95f0d@ngtech.co.il>

Hey Amos,

I have just stared observing 6K+ urls from google ads.

I know that web servers are ready for 16K URL's so I believe it should 
be added into one of the things in the road map.

Eliezer

On 2018-06-09 15:42, Amos Jeffries wrote:
> On 09/06/18 22:35, babajaga wrote:
>> I get a quite a few error msgs like
>> urlParse: URL too large (9182 bytes)
>> in cache.log
>> I suspect, they are most likely from some ads, however, they make the 
>> web
>> page appear slow to complete rendering.
>> 
>> Hesitating to patch defines.h directly, I kindly ask for
>> an additional parameter in squid.conf
>> 
> 
> This is not going to happen sorry. Unfortunately there are too many
> points in the code allocating buffers for URLs which do not use the
> MAX_URL definition.
> For example; I am this very minute testing a patch to remove one more 
> of
> those bits of code I just found trying to stuff a 8KB URL into a 4KB
> buffer :-(.
> 
> We have an ongoing project to remove the URL length limits from within
> Squid. Hopefully that will resolve the issue as it progresses without
> the need for a config option. If you are using Squid-3.5 you may see a
> reduction of these messages from Squid-4.
> 
> 
> PS. Squid is known to be one of the most lenient web agents. Most 
> origin
> servers and other proxies have smaller URL restrictions. So whatever
> application is trying to use >9KB URLs is unlikely to work generally
> over the Internet even if we resolve the Squid complaints.
> 
> Amos
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev

-- 
----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

From steve at opendium.com  Wed Jul 11 13:54:08 2018
From: steve at opendium.com (Steve Hill)
Date: Wed, 11 Jul 2018 14:54:08 +0100
Subject: [squid-dev] Terminating ICAP requests for aborted HTTP requests
Message-ID: <d9712b12-4e3a-b64b-65d8-dca3485166cc@opendium.com>


The ICAP spec doesn't make any comment on what a proxy should do if an 
HTTP client aborts part way through a rewritten response.

i.e. the HTTP client had made a request which has been forwarded onto 
the web server, the web server has started responding, Squid is sending 
the response body to the RESPMOD ICAP service and is forwarding the 
modified body to the client.  Part way through the download, the client 
(or maybe even the server?) drops the TCP connection.  What should Squid do?

My testing shows that the response body that is being sent to the ICAP 
server is cut short by Squid, by terminating it with a zero-length 
chunk.  This is also how fully successful ICAP requests are terminated 
and as the request has been terminated "normally", the ICAP connection 
can then be used for a new, unrelated, ICAP request.

But what if the ICAP server is doing some caching?  It has no way to 
know whether it has seen the complete object, or if the object has been 
cut short.

So, my question is: is Squid doing the right thing here, and if so how 
should the ICAP server know whether or not it has seen the complete 
object from the web server?  If the web server includes a Content-Length 
header then that could be compared to the final length of the body that 
the ICAP server has received, but this header is not mandatory and many 
requests do not include it.


The solutions that spring to my mind are:

1. Squid could just terminate the ICAP connection if the HTTP request is 
aborted.  The ICAP server would then be able to see that the connection 
was chopped before it received the terminating zero length chunk.  There 
may be a performance impact since Squid would need to establish a new 
connection for the next request.

2. Squid could add an "aborted" extension to the terminating chunk 
header.  i.e. in the same way that "0; ieof" is allowed, "0; aborted" 
could be used.  However, this is not part of the ICAP RFC and would 
therefore be non-standard behaviour that could break clients that have 
less robust parsers.

-- 
  - Steve Hill
    Technical Director
    Opendium    Online Safety / Web Filtering    http://www.opendium.com

    Enquiries:  sales at opendium.com      +44-1792-824568
    Support:    support at opendium.com    +44-1792-825748


    Opendium Limited is a company registered in England and Wales.
    Company No. 5465437
    Highfield House, 1 Brue Close, Bruton, Somerset, BA10 0HY, England.

From rousskov at measurement-factory.com  Wed Jul 11 15:46:08 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 11 Jul 2018 09:46:08 -0600
Subject: [squid-dev] Terminating ICAP requests for aborted HTTP requests
In-Reply-To: <d9712b12-4e3a-b64b-65d8-dca3485166cc@opendium.com>
References: <d9712b12-4e3a-b64b-65d8-dca3485166cc@opendium.com>
Message-ID: <eb1585f1-9282-7b95-9dea-5e1c72009897@measurement-factory.com>

On 07/11/2018 07:54 AM, Steve Hill wrote:

> the HTTP client had made a request which has been forwarded onto
> the web server, the web server has started responding, Squid is sending
> the response body to the RESPMOD ICAP service and is forwarding the
> modified body to the client.  Part way through the download, the client
> (or maybe even the server?) drops the TCP connection.  What should Squid
> do?

As far as ICAP is concerned, Squid should give the service everything
Squid has. Whether Squid continues to download the object is subject to
various factors such as object cachability and quick_abort_pct settings.
After giving everything, Squid should indicate a premature message
termination (as discussed below).


> My testing shows that the response body that is being sent to the ICAP
> server is cut short by Squid, by terminating it with a zero-length
> chunk.

Using last-chunk for aborted body termination is a bug. If Squid
terminates the body, it should not use the standard last-chunk. Like you
suggested below, Squid should either (half-)close the connection or
negotiate the use of a chunk extension, both indicating a premature body
termination.


> This is also how fully successful ICAP requests are terminated
> and as the request has been terminated "normally", the ICAP connection
> can then be used for a new, unrelated, ICAP request.

Yes, that is the advantage of sending a standard last-chunk, but that
performance advantage is not an excuse for lying to the ICAP service.


> The solutions that spring to my mind are:
> 
> 1. Squid could just terminate the ICAP connection if the HTTP request is
> aborted.  The ICAP server would then be able to see that the connection
> was chopped before it received the terminating zero length chunk.  There
> may be a performance impact since Squid would need to establish a new
> connection for the next request.

Agreed. Half-closing the connection would allow Squid to receive the
ICAP response which may be useful for logging/annotations, but I am not
sure many ICAP services and Squid itself support that without changes.


> 2. Squid could add an "aborted" extension to the terminating chunk
> header.  i.e. in the same way that "0; ieof" is allowed, "0; aborted"
> could be used.  However, this is not part of the ICAP RFC and would
> therefore be non-standard behaviour that could break clients that have
> less robust parsers.

Using non-negotiated chunk extensions will break many ICAP servers. The
new feature should be negotiated using the ICAP Allow mechanism. We have
used that mechanism for negotiating ICAP trailer support, for example:
https://tools.ietf.org/html/draft-rousskov-icap-trailers-01#section-5

Are you in a position to modify your ICAP service to support a new chunk
extension? If yes, I would recommend teaching Squid to use that
extension (when supported by the service) or terminate the ICAP
connection (otherwise).

It would be important to document the exact effects of that new
extension. For example, should the ICAP client expect an ICAP response?
I suspect the answer is yes because, in part, it would be difficult to
prevent an early response that may be already in-flight. Can the
extension be sent by ICAP servers? I suspect the answer is yes because
ICAP servers may face transaction termination conditions as well.

FWIW, I would probably reuse "ieof" instead of "abort". Its meaning
matches the intent and its reuse would allow implementations to reuse
the existing parsing code.


Cheers,

Alex.

From squid3 at treenet.co.nz  Wed Jul 11 16:16:54 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 12 Jul 2018 04:16:54 +1200
Subject: [squid-dev] Terminating ICAP requests for aborted HTTP requests
In-Reply-To: <eb1585f1-9282-7b95-9dea-5e1c72009897@measurement-factory.com>
References: <d9712b12-4e3a-b64b-65d8-dca3485166cc@opendium.com>
 <eb1585f1-9282-7b95-9dea-5e1c72009897@measurement-factory.com>
Message-ID: <541ef11e-b6c6-f816-c665-d70754ffa3f2@treenet.co.nz>

On 12/07/18 03:46, Alex Rousskov wrote:
> On 07/11/2018 07:54 AM, Steve Hill wrote:
> 
>> the HTTP client had made a request which has been forwarded onto
>> the web server, the web server has started responding, Squid is sending
>> the response body to the RESPMOD ICAP service and is forwarding the
>> modified body to the client.  Part way through the download, the client
>> (or maybe even the server?) drops the TCP connection.  What should Squid
>> do?
> 
> As far as ICAP is concerned, Squid should give the service everything
> Squid has. Whether Squid continues to download the object is subject to
> various factors such as object cachability and quick_abort_pct settings.
> After giving everything, Squid should indicate a premature message
> termination (as discussed below).
> 
> 
>> My testing shows that the response body that is being sent to the ICAP
>> server is cut short by Squid, by terminating it with a zero-length
>> chunk.
> 
> Using last-chunk for aborted body termination is a bug. If Squid
> terminates the body, it should not use the standard last-chunk. Like you
> suggested below, Squid should either (half-)close the connection or
> negotiate the use of a chunk extension, both indicating a premature body
> termination.

But the chunking here means end of *ICAP* message. Not end of HTTP message.

The ICAP server should use the HTTP message headers to know the HTTP
message sizes when possible. eg Content-Length and Content-Range values
indicate whether the HTTP delivered is complete or not.

HTTP Transfer-Encoding messages are a problem though. In absence of a
proper ICAP signal we should probably abort the ICAP connection at the
end of what Squid has (or intends to deliver, in the case the server
connection is also being dropped rather than response absorbed).

If there *is* an ICAP signal then Squid should of course use that in all
cases of early halted HTTP content. Even when it uses the last-chunk to
say where the ICAP message ends and the next may begin.

Amos

From steve at opendium.com  Thu Jul 12 08:34:34 2018
From: steve at opendium.com (Steve Hill)
Date: Thu, 12 Jul 2018 09:34:34 +0100
Subject: [squid-dev] Terminating ICAP requests for aborted HTTP requests
In-Reply-To: <541ef11e-b6c6-f816-c665-d70754ffa3f2@treenet.co.nz>
References: <d9712b12-4e3a-b64b-65d8-dca3485166cc@opendium.com>
 <eb1585f1-9282-7b95-9dea-5e1c72009897@measurement-factory.com>
 <541ef11e-b6c6-f816-c665-d70754ffa3f2@treenet.co.nz>
Message-ID: <da62177d-ea69-0ec6-34bd-2c632a0caf1e@opendium.com>

On 11/07/18 17:16, Amos Jeffries wrote:

> But the chunking here means end of *ICAP* message. Not end of HTTP message.
> 
> The ICAP server should use the HTTP message headers to know the HTTP
> message sizes when possible. eg Content-Length and Content-Range values
> indicate whether the HTTP delivered is complete or not.

Indeed, but many responses omit these headers, and it is therefore often 
not possible for the ICAP server to know whether it has seen the whole 
content.  Even HTTP responses that don't use a chunked transfer-encoding 
can omit these headers so long as the connection is closed at the end of 
the response.

I'm certainly not suggesting that Squid is "wrong" in the technical 
sense - it does follow the ICAP protocol specification.  Unfortunately 
the ICAP specification doesn't address aborted HTTP requests at all, so 
I'm wondering what a sensible way of addressing this is.

> If there *is* an ICAP signal then Squid should of course use that in all
> cases of early halted HTTP content. Even when it uses the last-chunk to
> say where the ICAP message ends and the next may begin.

As far as I'm aware, there is no ICAP signal for an aborted HTTP request 
- the spec does not address this at all.  Could be something for an 
updated ICAP RFC in the future though. :)

-- 
  - Steve Hill
    Technical Director
    Opendium    Online Safety / Web Filtering    http://www.opendium.com

    Enquiries:  sales at opendium.com      +44-1792-824568
    Support:    support at opendium.com    +44-1792-825748


    Opendium Limited is a company registered in England and Wales.
    Company No. 5465437
    Highfield House, 1 Brue Close, Bruton, Somerset, BA10 0HY, England.

From eliezer at ngtech.co.il  Thu Jul 12 09:16:14 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Thu, 12 Jul 2018 12:16:14 +0300
Subject: [squid-dev] StoeiD and ICAP services callouts, when it happens?
Message-ID: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>

I have been working from time to time on StoreID while I believe it useful
for targeted scenarios.

I can test and write different code but wanted to first ask since my memory
is a bit vauge.

 

Squid during it's client side callouts:

Runs a series of tests at:

https://github.com/squid-cache/squid/blob/d2a6dcba707c15484c255e7a569b90f7f1
186383/src/client_side_request.cc#L1723

 

https://github.com/squid-cache/squid/blob/d2a6dcba707c15484c255e7a569b90f7f1
186383/src/client_side_request.cc#L1750

 

>From what I understood this section and others are running in
a-synchronically.

So from my point of view now I understand that if I will use a request mod
ICAP service to inject a request header into the request
It would be available as a StoreID extra ie I can use:

 

store_id_extras "%>a/%>A %un %>rm myip=%la myport=%lp %{X-Store-Id}>h"

 

and I will be able to "send" the StoreID helper an extra header which can be
considered while returning squid the right StoreID.

If it's indeed true, is it possible to pass an ICAP response header into the
store_id_extras?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru <http://ngtech.co.il/lmgtfy/> 
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180712/277950fb/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image003.png
Type: image/png
Size: 11308 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180712/277950fb/attachment-0001.png>

From rousskov at measurement-factory.com  Thu Jul 12 14:52:51 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 12 Jul 2018 08:52:51 -0600
Subject: [squid-dev] Terminating ICAP requests for aborted HTTP requests
In-Reply-To: <541ef11e-b6c6-f816-c665-d70754ffa3f2@treenet.co.nz>
References: <d9712b12-4e3a-b64b-65d8-dca3485166cc@opendium.com>
 <eb1585f1-9282-7b95-9dea-5e1c72009897@measurement-factory.com>
 <541ef11e-b6c6-f816-c665-d70754ffa3f2@treenet.co.nz>
Message-ID: <5f9003cb-7404-3e3b-ce85-12b407cf280b@measurement-factory.com>

On 07/11/2018 10:16 AM, Amos Jeffries wrote:
> On 12/07/18 03:46, Alex Rousskov wrote:
>> Using last-chunk for aborted body termination is a bug. If Squid
>> terminates the body, it should not use the standard last-chunk. Like you
>> suggested below, Squid should either (half-)close the connection or
>> negotiate the use of a chunk extension, both indicating a premature body
>> termination.

> But the chunking here means end of *ICAP* message. Not end of HTTP message.

When an ICAP message delivery ends, the HTTP message delivery ends as
well: An HTTP message cannot be spread across multiple ICAP messages. In
many cases, the ICAP recipient cannot tell whether the HTTP message
delivery ended prematurely unless the ICAP sender closes the connection.
That inability to detect premature HTTP message termination is what this
thread is about.


> HTTP Transfer-Encoding messages are a problem though. In absence of a
> proper ICAP signal we should probably abort the ICAP connection at the
> end of what Squid has

Yes, that is option #1 suggested by Steve.


> If there *is* an ICAP signal then Squid should of course use that in all
> cases of early halted HTTP content.

There is no such signal. Adding that signal is option #2 suggested by Steve.


Alex.

From rousskov at measurement-factory.com  Thu Jul 12 16:00:51 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 12 Jul 2018 10:00:51 -0600
Subject: [squid-dev] StoeiD and ICAP services callouts, when it happens?
In-Reply-To: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>
References: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>
Message-ID: <e0b7417b-75c2-189e-7d19-bd0005a072fb@measurement-factory.com>

On 07/12/2018 03:16 AM, Eliezer Croitoru wrote:
> is it possible to pass an ICAP response header into the store_id_extras?

Yes, %adapt::<last_h should work in store_id_extras:

https://wiki.squid-cache.org/SquidFaq/OrderIsImportant#Callout_Sequence

Alex.

From eliezer at ngtech.co.il  Thu Jul 12 17:21:26 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Thu, 12 Jul 2018 20:21:26 +0300
Subject: [squid-dev] StoeiD and ICAP services callouts, when it happens?
In-Reply-To: <e0b7417b-75c2-189e-7d19-bd0005a072fb@measurement-factory.com>
References: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>
 <e0b7417b-75c2-189e-7d19-bd0005a072fb@measurement-factory.com>
Message-ID: <02d901d41a04$c3d5b120$4b811360$@ngtech.co.il>

I don't really understand how am I supposed to use it.
With regular logformat I am using:
%{X-Store-Id}>ha

And it works perfect.

So I tried using the next config line for store id:
store_id_extras "%>a/%>A %un %>rm myip=%la myport=%lp %{X-Store-Id}>ha"

which didn't worked as expected since it sends always "-".
I have now tried to understand what and how I should use the:
%adapt::<last_h

Or another option but doesn't matter how what I have tried I cannot
understand the right format that I should use in store_id_extras.
I have considered sending a meta header in the ICAP service but still I
cannot understand how I should use this log format.

If send into store_id_extrax one of the two:
- ICAP meta response header (in  a 204\206 response)
- ADAPTED request headaer (in a 204 response)

..Both in REQMOD only.

Then I can skip trying to code the addition of "X-Store-Id" ICAP header as a
StoreID from the ICAP service.

I need a working example since I'm really trying but couldn't understand how
to send one of the headers into the store_id_extras.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il


-----Original Message-----
From: Alex Rousskov [mailto:rousskov at measurement-factory.com] 
Sent: Thursday, July 12, 2018 7:01 PM
To: Eliezer Croitoru <eliezer at ngtech.co.il>; squid-dev at lists.squid-cache.org
Subject: Re: [squid-dev] StoeiD and ICAP services callouts, when it happens?

On 07/12/2018 03:16 AM, Eliezer Croitoru wrote:
> is it possible to pass an ICAP response header into the store_id_extras?

Yes, %adapt::<last_h should work in store_id_extras:

https://wiki.squid-cache.org/SquidFaq/OrderIsImportant#Callout_Sequence

Alex.


From rousskov at measurement-factory.com  Thu Jul 12 20:09:35 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 12 Jul 2018 14:09:35 -0600
Subject: [squid-dev] StoeiD and ICAP services callouts, when it happens?
In-Reply-To: <02d901d41a04$c3d5b120$4b811360$@ngtech.co.il>
References: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>
 <e0b7417b-75c2-189e-7d19-bd0005a072fb@measurement-factory.com>
 <02d901d41a04$c3d5b120$4b811360$@ngtech.co.il>
Message-ID: <3d608bcc-9520-9c4e-8251-4eff94041fab@measurement-factory.com>

On 07/12/2018 11:21 AM, Eliezer Croitoru wrote:

> With regular logformat I am using:
> %{X-Store-Id}>ha
> 
> And it works perfect.

%>ha does not log an ICAP response header. It logs an HTTP request
header. You asked about an ICAP response header.


> So I tried using the next config line for store id:
> store_id_extras "%>a/%>A %un %>rm myip=%la myport=%lp %{X-Store-Id}>ha"
> 
> which didn't worked as expected since it sends always "-".

Bugs notwithstanding, the above should work if your adaptation service
adds an X-Store-ID request header field to the adapted HTTP request. You
can check what headers Squid has for %>ha by specifying %>ha without any
parameters.


> I have now tried to understand what and how I should use the:
> %adapt::<last_h

Yes, %adapt::<last_h should work for logging the last ICAP response
header. Have you tried specified that logformat code, without any
parameters?


HTH,

Alex.




> -----Original Message-----
> From: Alex Rousskov [mailto:rousskov at measurement-factory.com] 
> Sent: Thursday, July 12, 2018 7:01 PM
> To: Eliezer Croitoru <eliezer at ngtech.co.il>; squid-dev at lists.squid-cache.org
> Subject: Re: [squid-dev] StoeiD and ICAP services callouts, when it happens?
> 
> On 07/12/2018 03:16 AM, Eliezer Croitoru wrote:
>> is it possible to pass an ICAP response header into the store_id_extras?
> 
> Yes, %adapt::<last_h should work in store_id_extras:
> 
> https://wiki.squid-cache.org/SquidFaq/OrderIsImportant#Callout_Sequence
> 
> Alex.
> 


From eliezer at ngtech.co.il  Thu Jul 12 20:17:23 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Thu, 12 Jul 2018 23:17:23 +0300
Subject: [squid-dev] Squid 4.1 "- TCP_DENIED/403' and IPv6 while
	"dns_v4_first on"
Message-ID: <037101d41a1d$586980b0$093c8210$@ngtech.co.il>

I'm testing Squid 4.1 and my proxy is showing TCP_DENIED when fetching
certificates like this:

 

1531425362.414 000000 - TCP_DENIED/403 3661 GET
http://www.microsoft.com/pki/certs/MicRooCerAut2011_2011_03_22.crt -
HIER_NONE/- text/html;charset=utf-8 Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-"
REP-CC: "-" REP-EXP: "-" VARY: "-" - REP-X-CACHE: "-" Adapted-X-Store-Id:
"-"

1531425364.299 000000 - TCP_DENIED/403 3661 GET
http://www.microsoft.com/pki/certs/MicRooCerAut2011_2011_03_22.crt -
HIER_NONE/- text/html;charset=utf-8 Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-"
REP-CC: "-" REP-EXP: "-" VARY: "-" - REP-X-CACHE: "-" Adapted-X-Store-Id:
"-"

 

If I'm not wrong Amos wrote that there is a special directive or ACL to
allow these since there is not originating from a client IP src address.

 

And also when I'm trying to access https://bugs.squid-cache.org/ with
SSL-BUMP on I am receiving the next page:


ERROR


The requested URL could not be retrieved

  _____  


The following error was encountered while trying to retrieve the URL:
https://bugs.squid-cache.org/*

Connection to 2001:4801:7827:102:ad34:6f78:b6dc:fbed failed.

The system returned: (101) Network is unreachable

The remote host or network may be down. Please try the request again.

Your cache administrator is webmaster.

 

  _____  

Generated Thu, 12 Jul 2018 20:01:40 GMT by squid4-testing (squid/4.1)

##END OF PAGE

 

With these access log lines:

1531425990.290 000000 - TCP_DENIED/403 3564 GET
http://cert.int-x3.letsencrypt.org/ - HIER_NONE/- text/html;charset=utf-8
Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" -
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.291 000355 10.0.0.28 NONE/200 0 CONNECT bugs.squid-cache.org:443
- HIER_DIRECT/2001:4801:7827:102:ad34:6f78:b6dc:fbed - Q-CC: "-" "-" Q-P:
"-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" 00:00:00:00:00:00
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.294 000000 - TCP_DENIED/403 3564 GET
http://cert.int-x3.letsencrypt.org/ - HIER_NONE/- text/html;charset=utf-8
Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" -
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.295 000359 10.0.0.28 NONE/200 0 CONNECT bugs.squid-cache.org:443
- HIER_DIRECT/2001:4801:7827:102:ad34:6f78:b6dc:fbed - Q-CC: "-" "-" Q-P:
"-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" 00:00:00:00:00:00
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.299 000000 10.0.0.28 NONE/503 4117 GET
https://bugs.squid-cache.org/index.cgi - HIER_NONE/- text/html Q-CC:
"no-cache" "no-cache" Q-P: "no-cache" "no-cache" Q-RANGE: "-" REP-CC: "-"
REP-EXP: "-" VARY: "Accept-Language" 00:00:00:00:00:00 REP-X-CACHE: "MISS
from squid4-testing" Adapted-X-Store-Id: "-"

1531425990.304 000000 - TCP_DENIED/403 3564 GET
http://cert.int-x3.letsencrypt.org/ - HIER_NONE/- text/html;charset=utf-8
Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" -
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.305 000365 10.0.0.28 NONE/200 0 CONNECT bugs.squid-cache.org:443
- HIER_DIRECT/2001:4801:7827:102:ad34:6f78:b6dc:fbed - Q-CC: "-" "-" Q-P:
"-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" 00:00:00:00:00:00
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.307 000000 - TCP_DENIED/403 3564 GET
http://cert.int-x3.letsencrypt.org/ - HIER_NONE/- text/html;charset=utf-8
Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" -
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.307 000000 - TCP_DENIED/403 3564 GET
http://cert.int-x3.letsencrypt.org/ - HIER_NONE/- text/html;charset=utf-8
Q-CC: "-" "-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" -
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.307 000372 10.0.0.28 NONE/200 0 CONNECT bugs.squid-cache.org:443
- HIER_DIRECT/2001:4801:7827:102:ad34:6f78:b6dc:fbed - Q-CC: "-" "-" Q-P:
"-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" 00:00:00:00:00:00
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.307 000368 10.0.0.28 NONE/200 0 CONNECT bugs.squid-cache.org:443
- HIER_DIRECT/2001:4801:7827:102:ad34:6f78:b6dc:fbed - Q-CC: "-" "-" Q-P:
"-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" 00:00:00:00:00:00
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531425990.339 000000 10.0.0.28 NONE/503 4117 GET
http://squid4-testing:3128/squid-internal-static/icons/SN.png - HIER_NONE/-
text/html Q-CC: "no-cache" "no-cache" Q-P: "no-cache" "no-cache" Q-RANGE:
"-" REP-CC: "-" REP-EXP: "-" VARY: "Accept-Language" 00:00:00:00:00:00
REP-X-CACHE: "MISS from squid4-testing" Adapted-X-Store-Id: "-"

1531425990.374 000000 10.0.0.28 NONE/503 4117 GET
https://bugs.squid-cache.org/favicon.ico - HIER_NONE/- text/html Q-CC:
"no-cache" "no-cache" Q-P: "no-cache" "no-cache" Q-RANGE: "-" REP-CC: "-"
REP-EXP: "-" VARY: "Accept-Language" 00:00:00:00:00:00 REP-X-CACHE: "MISS
from squid4-testing" Adapted-X-Store-Id: "-"

 

So the issue is a bit strange, is the remote IP is the issue or another
thing?

I looked at the archives and also the docs and from what I managed to make
sure the next resolve both issues which are tangled to each other:

## START squid.conf addition

acl internal transaction_initiator internal

 

# Deny requests to certain unsafe ports

http_access deny !Safe_ports

 

# Deny CONNECT to other than secure SSL ports

http_access deny CONNECT !SSL_ports

http_access allow internal

## END squid.conf addition

 

http://www.squid-cache.org/Versions/v4/cfgman/acl.html

 

Clarify that  there is a new type of ACL named "transaction_initiator" which
does couple good things.

 

I am not sure but it seems to me that some wiki page is missing regarding
this issue.
I can try to write one if no one else will sit on it in the next month.

 

All The Bests,

Eliezer

 

----

Eliezer Croitoru <http://ngtech.co.il/lmgtfy/> 
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180712/92fee28d/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image002.png
Type: image/png
Size: 11326 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180712/92fee28d/attachment-0001.png>

From eliezer at ngtech.co.il  Thu Jul 12 20:47:10 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Thu, 12 Jul 2018 23:47:10 +0300
Subject: [squid-dev] StoeiD and ICAP services callouts, when it happens?
In-Reply-To: <3d608bcc-9520-9c4e-8251-4eff94041fab@measurement-factory.com>
References: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>
 <e0b7417b-75c2-189e-7d19-bd0005a072fb@measurement-factory.com>
 <02d901d41a04$c3d5b120$4b811360$@ngtech.co.il>
 <3d608bcc-9520-9c4e-8251-4eff94041fab@measurement-factory.com>
Message-ID: <03ac01d41a21$81a0f7c0$84e2e740$@ngtech.co.il>

I tried it both on access logs and store_id_extras.
In the access log I am receiving this:
....ICAP-Header-Test: "Connection: close\r\nDate: Thu, 12 Jul 2018 20:42:04 GMT\r\nEncapsulated: req-hdr=0, null-body=1189\r\nIstag: YTGV-Predictor\r\nService: YouTube GoogleVideo Predictor ICAP serivce\r\n "

But on store_id_extras I am receiving for the same logformat ie
store_id_extras "%adapt::<last_h"
"... -"

Now I'm not sure if I'm doing something wrong or it's something else.
>From the access.log it seems that I am doing things the right way but from the store_id helper "input" it seems that something is wrong.

I tried to add both a custom header to the request with a 204(GET only..) and also tried the same by adding an ICAP response header.
(the ICAP response header was not injected in the output above)

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



-----Original Message-----
From: Alex Rousskov [mailto:rousskov at measurement-factory.com] 
Sent: Thursday, July 12, 2018 11:10 PM
To: squid-dev at lists.squid-cache.org
Cc: Eliezer Croitoru <eliezer at ngtech.co.il>
Subject: Re: [squid-dev] StoeiD and ICAP services callouts, when it happens?

On 07/12/2018 11:21 AM, Eliezer Croitoru wrote:

> With regular logformat I am using:
> %{X-Store-Id}>ha
> 
> And it works perfect.

%>ha does not log an ICAP response header. It logs an HTTP request
header. You asked about an ICAP response header.


> So I tried using the next config line for store id:
> store_id_extras "%>a/%>A %un %>rm myip=%la myport=%lp %{X-Store-Id}>ha"
> 
> which didn't worked as expected since it sends always "-".

Bugs notwithstanding, the above should work if your adaptation service
adds an X-Store-ID request header field to the adapted HTTP request. You
can check what headers Squid has for %>ha by specifying %>ha without any
parameters.


> I have now tried to understand what and how I should use the:
> %adapt::<last_h

Yes, %adapt::<last_h should work for logging the last ICAP response
header. Have you tried specified that logformat code, without any
parameters?


HTH,

Alex.




> -----Original Message-----
> From: Alex Rousskov [mailto:rousskov at measurement-factory.com] 
> Sent: Thursday, July 12, 2018 7:01 PM
> To: Eliezer Croitoru <eliezer at ngtech.co.il>; squid-dev at lists.squid-cache.org
> Subject: Re: [squid-dev] StoeiD and ICAP services callouts, when it happens?
> 
> On 07/12/2018 03:16 AM, Eliezer Croitoru wrote:
>> is it possible to pass an ICAP response header into the store_id_extras?
> 
> Yes, %adapt::<last_h should work in store_id_extras:
> 
> https://wiki.squid-cache.org/SquidFaq/OrderIsImportant#Callout_Sequence
> 
> Alex.
> 



From rousskov at measurement-factory.com  Thu Jul 12 22:00:14 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 12 Jul 2018 16:00:14 -0600
Subject: [squid-dev] StoeiD and ICAP services callouts, when it happens?
In-Reply-To: <03ac01d41a21$81a0f7c0$84e2e740$@ngtech.co.il>
References: <00f601d419c0$fbc69de0$f353d9a0$@ngtech.co.il>
 <e0b7417b-75c2-189e-7d19-bd0005a072fb@measurement-factory.com>
 <02d901d41a04$c3d5b120$4b811360$@ngtech.co.il>
 <3d608bcc-9520-9c4e-8251-4eff94041fab@measurement-factory.com>
 <03ac01d41a21$81a0f7c0$84e2e740$@ngtech.co.il>
Message-ID: <561a29c5-5798-afe4-430c-df3c47c00f35@measurement-factory.com>

On 07/12/2018 02:47 PM, Eliezer Croitoru wrote:
> I tried it both on access logs and store_id_extras.
> In the access log I am receiving this:
> ....ICAP-Header-Test: "Connection: close\r\nDate:...\r\n "
> 
> But on store_id_extras I am receiving for the same logformat ie
> store_id_extras "%adapt::<last_h"
> "... -"

Sounds like a Squid bug to me.

Alex.



> -----Original Message-----
> From: Alex Rousskov [mailto:rousskov at measurement-factory.com] 
> Sent: Thursday, July 12, 2018 11:10 PM
> To: squid-dev at lists.squid-cache.org
> Cc: Eliezer Croitoru <eliezer at ngtech.co.il>
> Subject: Re: [squid-dev] StoeiD and ICAP services callouts, when it happens?
> 
> On 07/12/2018 11:21 AM, Eliezer Croitoru wrote:
> 
>> With regular logformat I am using:
>> %{X-Store-Id}>ha
>>
>> And it works perfect.
> 
> %>ha does not log an ICAP response header. It logs an HTTP request
> header. You asked about an ICAP response header.
> 
> 
>> So I tried using the next config line for store id:
>> store_id_extras "%>a/%>A %un %>rm myip=%la myport=%lp %{X-Store-Id}>ha"
>>
>> which didn't worked as expected since it sends always "-".
> 
> Bugs notwithstanding, the above should work if your adaptation service
> adds an X-Store-ID request header field to the adapted HTTP request. You
> can check what headers Squid has for %>ha by specifying %>ha without any
> parameters.
> 
> 
>> I have now tried to understand what and how I should use the:
>> %adapt::<last_h
> 
> Yes, %adapt::<last_h should work for logging the last ICAP response
> header. Have you tried specified that logformat code, without any
> parameters?
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
> 
>> -----Original Message-----
>> From: Alex Rousskov [mailto:rousskov at measurement-factory.com] 
>> Sent: Thursday, July 12, 2018 7:01 PM
>> To: Eliezer Croitoru <eliezer at ngtech.co.il>; squid-dev at lists.squid-cache.org
>> Subject: Re: [squid-dev] StoeiD and ICAP services callouts, when it happens?
>>
>> On 07/12/2018 03:16 AM, Eliezer Croitoru wrote:
>>> is it possible to pass an ICAP response header into the store_id_extras?
>>
>> Yes, %adapt::<last_h should work in store_id_extras:
>>
>> https://wiki.squid-cache.org/SquidFaq/OrderIsImportant#Callout_Sequence
>>
>> Alex.
>>
> 


From eliezer at ngtech.co.il  Thu Jul 12 22:36:29 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Fri, 13 Jul 2018 01:36:29 +0300
Subject: [squid-dev] SSL-BUMP, Encryption and coding licensing.
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAL3wsAcc8JBJkMCbPuiQMGEBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAD7/qHTJBZgQJkR/wygAVVBAQAAAAA=@ngtech.co.il>

Hey Dev list,

 

Since StoreID and SSL-BUMP are in production I found myself asking:

What is proper?

Does a specific license means something?

Do I want to publish software or code with closed sources or open sources?

What is worth encryption or/and securing?

 

To understand why I got to these question I must clear something.

I don't think that every piece of code should be seen by just anybody.

I believe that there are good reasons out there to encrypt an  end-to-end
connection with whatever means necessary.

Before I delved into my StoreID  research I wrote a service that was caching
couple very big data providers(audio, video, DB and many other types).

It took me couple years to actually sit down for R&D so StoreID would be
publicly available.

One of the reasons for this is that once it's out in the open many will try
to use and maybe abuse it.

For some StoreID and caching is there just there to resolve a bandwidth
consumption or overload issue.

For others StoreID is heaven of the hackers, crackers and phishers.

 

At the time when I published my "Coordinator" R&D which used two Squid
instances for de-duplication there was a crucial issue it was targeting.

Many companies left their clients and users sensitive data such as login and
other details in plain text.

YouTube, Facebook and couple other companies had a CDN network that every
medium level hacker or phisher could just hijack without the client
knowledge.

I do believe that Google statistics can be used as power but only in the
right hands.

The funniest thing is that Google ads for some reason offers me ads for
things that I don't really need and I have no interest in.

But this is their business and I can open some sources to show weaknesses in
couple systems around the globe but..

I want my work to help others earn their living and to not snatch food from
a table worthy of it.

 

Due to the above I have looked at the BSD, GNU and APACHE licenses which are
kind of famous in the Open-Source world.

I noticed that I mostly want to publish source code under the BSD
license(3-clause) but I do want that the GPL type licenses will still exist.

I have seen(and correct me if I'm wrong) that there are couple types of BSD
software:

-          The Good

-          The Bad

-          The Weird

-          The Ugly

-          .

 

Giving someone the joy and happiness of earning what he deserves almost
never comes from "Google/Bing/Others foo".

The actual R&D and the stage of understanding what the code does and means
is what mainly gives joy or .. pain.

Satisfaction is another subject since I have seen pieces of code like "rm
-rf /" in the middle of a Makefile script.

Was it a typo, maybe malicious?(please share your mind)

 

I understand that we all get the opportunity for an error but it doesn't
justify doing and meaning bad things.

Today I am happy with StoreID and SSL-BUMP since I believe that these who
invested time and money have a purpose, a good one.

I have code that I wrote which I am protecting and holding the publication
since I care if someone will get hurt by it.

 

I want developers and admins to write good eCAP, ICAP and other pieces of
software related and un-related to Squid-Cache.

Due to this I decided that I will not publish specific pieces of code, so
these who invested time and money will be able to enjoy from their efforts.

 

I believe that a king worth his name not by having a good brain but by
having a good heart. brain is a blessing.

When a king sits in a court with Judges I believe he should respond when all
the sitting Judges and representatives of both sides finished presenting and
interrogating.

First the representatives should tell their story then the Judges should
react with questions and maybe even interrogation(not only the
representatives have this duty).

Then and only then and after both sides of the tables finished their actions
the time for the king words need to come out.

The king is allowed to do whatever he wants but he has the duty of doing and
making right.

A true king doesn't take control of a domain and do whatever he wants with
it.

A true king receives the domain by being worthy of it.

Sometimes I see code I can write in 5 minutes but when I see that the writer
posted a license I hold my breath and ask myself if it's right to compose my
own piece.

When I see encrypted and protected code I hold myself but. I do not like
con's!

One of the weird things I have seen is a JS sending pieces of a file bit by
bit from the background of the browser into a specific destination.

The browser can sit running a day sending data and while the client see no
issue with it he actually feeds more and more data to the other side.

This is where I got to a decision!

I like SSL-BUMP!!!

The Squid-Cache project might look like an old piece of software that
doesn't do threading or couple other things but it's a great piece of code.

 

I have a ready to use 2018 current YouTube and google video caching and
filtering service but.

I will not publish the sources yet.

 

I would like to say thank you to this great Development team of the project
that since V3.2 changed attitude from "caching as much as want" to "cache
what's worthy of it".

I believe that many admins now understands more about IT security due to
this amazing project.

 

I would like to hear from you what do you think is not worth publishing.

Let say I have a code that can take one of google nodes, what should I do?

I can write a code that meets a SPEC\blueprint but is licensed, would it be
OK to write a software that does the same but with my original code and
license?

What is the right way to tell a sysadmin or a webmaster that his site can be
compromised?
Would hacking the site "symbolically" ie add some text into the site is OK?
.. not talking about tearing apart the site, just adding a tiny JS popup
like the cookie warning that many sites show?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru <http://ngtech.co.il/lmgtfy/> 
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180713/fb65855b/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image002.png
Type: image/png
Size: 11324 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180713/fb65855b/attachment-0001.png>

From eliezer at ngtech.co.il  Wed Jul 18 12:25:10 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Wed, 18 Jul 2018 15:25:10 +0300
Subject: [squid-dev] TCP_MISS_ABORTED/000 when accessing squid-internal-mgr
	page
Message-ID: <01e801d41e92$5f270c00$1d752400$@ngtech.co.il>

I have tried to access squid manage pages using curl and squidclient and got
the next weird results in the access.log.

 

TCP_MISS_ABORTED/000

 

The weird thing is that I am receiving 200 as a response:

 

 

 

Commands and logs:

### START

[root at squid4-testing check-systemd-squid]# curl
127.0.0.1:3128/squid-internal-mgr/info

Squid Object Cache: Version 4.1

Build Info:

Service Name: squid

Start Time:     Wed, 18 Jul 2018 11:45:21 GMT

Current Time:   Wed, 18 Jul 2018 12:19:18 GMT

<SNIP>

         28037 on-disk objects

[root at squid4-testing check-systemd-squid]# curl
127.0.0.1:3128/squid-internal-mgr/menu

index                  Cache Manager Interface                 public

menu                   Cache Manager Menu                      public

<SNIP>

server_list            Peer Cache Statistics                   public

[root at squid4-testing check-systemd-squid]# fg

tail /var/log/squid/access.log -f

1531916358.717 000000 127.0.0.1 TCP_MISS_ABORTED/000 0 GET
http://squid4-testing:3128/squid-internal-mgr/info - HIER_NONE/- - Q-CC: "-"
"-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-"
00:00:00:00:00:00 REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

1531916361.505 000000 127.0.0.1 TCP_MISS_ABORTED/000 0 GET
http://squid4-testing:3128/squid-internal-mgr/menu - HIER_NONE/- - Q-CC: "-"
"-" Q-P: "-" "-" Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-"
00:00:00:00:00:00 REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

.

1531916504.216 000000 ::1 TCP_MISS_ABORTED/000 0 GET
cache_object://localhost/menu - HIER_NONE/- - Q-CC: "-" "-" Q-P: "-" "-"
Q-RANGE: "-" REP-CC: "-" REP-EXP: "-" VARY: "-" 00-00-00-00-00-00-00-00
REP-X-CACHE: "-" Adapted-X-Store-Id: "-"

### END

 

Also:

[root at squid4-testing check-systemd-squid]#  curl
127.0.0.1:3128/squid-internal-mgr/menu -I

HTTP/1.1 200 OK

Server: squid/4.1

Mime-Version: 1.0

Date: Wed, 18 Jul 2018 12:22:50 GMT

Content-Type: text/plain

Expires: Wed, 18 Jul 2018 12:22:50 GMT

Last-Modified: Wed, 18 Jul 2018 12:22:50 GMT

Connection: close

### END

 

So. a bug on 4.1?

 

Eliezer

 

----

Eliezer Croitoru <http://ngtech.co.il/lmgtfy/> 
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180718/7b632357/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image003.png
Type: image/png
Size: 11317 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180718/7b632357/attachment.png>

From eliezer at ngtech.co.il  Wed Jul 18 16:56:35 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Wed, 18 Jul 2018 19:56:35 +0300
Subject: [squid-dev] Allowing the admin to decide if a specific DNS+ip is ok
	for caching.
Message-ID: <034c01d41eb8$49adce10$dd096a30$@ngtech.co.il>

Hey Squid-Dev's,

 

Currently Squid-Cache forces Host Header Forgery on http and https requests.

-          https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery

Squid is working properly or "the best" when the client and the proxy use
the same DNS service.

In the past I have asked about defining a bumped connection as secured and
to disable host header forgery checks on some of these.

The conditions are:

-          Squid validates that the server certificate is valid against the
local CA bundles (an admin can add or remove a certificate manually or
automatically)

-          The admin defines an external tool that verifies and/or allows
host header forgery to be disabled per request.

 

I am in the middle of testing 4.1 and wondering what is expected from 4.1
regarding host header forgery.

Was there any change of policy?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru <http://ngtech.co.il/lmgtfy/> 
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180718/7606c81c/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image003.png
Type: image/png
Size: 11308 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180718/7606c81c/attachment-0001.png>

From squid3 at treenet.co.nz  Thu Jul 19 07:46:09 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 19 Jul 2018 19:46:09 +1200
Subject: [squid-dev] Allowing the admin to decide if a specific DNS+ip
 is ok for caching.
In-Reply-To: <034c01d41eb8$49adce10$dd096a30$@ngtech.co.il>
References: <034c01d41eb8$49adce10$dd096a30$@ngtech.co.il>
Message-ID: <1c5d2b0f-cc9c-7aa0-bbae-263ae1ef11c6@treenet.co.nz>

On 19/07/18 04:56, Eliezer Croitoru wrote:
> Hey Squid-Dev’s,
> 
>  
> 
> Currently Squid-Cache forces Host Header Forgery on http and https requests.
> 
> -          https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery
> 

Forces? no. Prevents.

> Squid is working properly or “the best” when the client and the proxy
> use the same DNS service.
> 
> In the past I have asked about defining a bumped connection as secured
> and to disable host header forgery checks on some of these.
> 

Having a connection be bumped does not mean the requests decrypted from
that connection are meant for that server. DONT_VERIFY_PEER and such
false "workaround" are still very common things for admin to do.

A client or intermediary can as easily forge the SNI value on TLS setup
as a Host header in plain-text HTTP. The resulting problems in both
cases are the same.



> The conditions are:
> 
> -          Squid validates that the server certificate is valid against
> the local CA bundles (an admin can add or remove a certificate manually
> or automatically)
> 
> -          The admin defines an external tool that verifies and/or
> allows host header forgery to be disabled per request.
> 
>  
> 
> I am in the middle of testing 4.1 and wondering what is expected from
> 4.1 regarding host header forgery.
> 
> Was there any change of policy?
> 

No changes from Squid-3 are expected in terms of these checks. There may
be changes in TLS handling which decrypt more (or less) requests.

Any requests which *are* decrypted, the initial CONNECT (from SNI) are
expected to be verified.
 TPROXY / NAT intercepted traffic is verified against the against the
dst-IP of the intercepted client TCP connection.
 Bumped and non-intercepted traffic (in strict verify mode) against the
server-IP from initial client CONNECT tunnel.

Amos

From eliezer at ngtech.co.il  Fri Jul 20 08:56:17 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Fri, 20 Jul 2018 11:56:17 +0300
Subject: [squid-dev] Allowing the admin to decide if a specific DNS+ip
	is ok for caching.
In-Reply-To: <1c5d2b0f-cc9c-7aa0-bbae-263ae1ef11c6@treenet.co.nz>
References: <034c01d41eb8$49adce10$dd096a30$@ngtech.co.il>
 <1c5d2b0f-cc9c-7aa0-bbae-263ae1ef11c6@treenet.co.nz>
Message-ID: <04f601d42007$8583e320$908ba960$@ngtech.co.il>

OK.

So we will try to make the whole environment more secure rather than more "profitable".
I think that in general it's a good concept and doesn't sound like some "OCD" alike issue.

I will try to write an article about 4.1 release with this point in mind.

Thanks,
Eliezer

* I do not really care if someone will think or thinks that my articles are profiting me in any way....

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



-----Original Message-----
From: squid-dev [mailto:squid-dev-bounces at lists.squid-cache.org] On Behalf Of Amos Jeffries
Sent: Thursday, July 19, 2018 10:46 AM
To: squid-dev at lists.squid-cache.org
Subject: Re: [squid-dev] Allowing the admin to decide if a specific DNS+ip is ok for caching.

On 19/07/18 04:56, Eliezer Croitoru wrote:
> Hey Squid-Dev’s,
> 
>  
> 
> Currently Squid-Cache forces Host Header Forgery on http and https requests.
> 
> -          https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery
> 

Forces? no. Prevents.

> Squid is working properly or “the best” when the client and the proxy
> use the same DNS service.
> 
> In the past I have asked about defining a bumped connection as secured
> and to disable host header forgery checks on some of these.
> 

Having a connection be bumped does not mean the requests decrypted from
that connection are meant for that server. DONT_VERIFY_PEER and such
false "workaround" are still very common things for admin to do.

A client or intermediary can as easily forge the SNI value on TLS setup
as a Host header in plain-text HTTP. The resulting problems in both
cases are the same.



> The conditions are:
> 
> -          Squid validates that the server certificate is valid against
> the local CA bundles (an admin can add or remove a certificate manually
> or automatically)
> 
> -          The admin defines an external tool that verifies and/or
> allows host header forgery to be disabled per request.
> 
>  
> 
> I am in the middle of testing 4.1 and wondering what is expected from
> 4.1 regarding host header forgery.
> 
> Was there any change of policy?
> 

No changes from Squid-3 are expected in terms of these checks. There may
be changes in TLS handling which decrypt more (or less) requests.

Any requests which *are* decrypted, the initial CONNECT (from SNI) are
expected to be verified.
 TPROXY / NAT intercepted traffic is verified against the against the
dst-IP of the intercepted client TCP connection.
 Bumped and non-intercepted traffic (in strict verify mode) against the
server-IP from initial client CONNECT tunnel.

Amos
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev


From luhliari at redhat.com  Mon Jul 30 17:11:42 2018
From: luhliari at redhat.com (Lubos Uhliarik)
Date: Mon, 30 Jul 2018 13:11:42 -0400 (EDT)
Subject: [squid-dev] Squid versioning
In-Reply-To: <557739186.18438897.1532970364113.JavaMail.zimbra@redhat.com>
Message-ID: <306721930.18439574.1532970702731.JavaMail.zimbra@redhat.com>

Hey all, 

I wanted to ask, how is it now with squid versioning. Is configuration from version 4.1 backward 
compatible with version 4.0? Are you using semver (https://semver.org/) now?

Best,

--
Lubos Uhliarik
Software Engineer - EMEA ENG Developer Experience
RH - Brno - TPB-C - 1D221
IRC: zero_byte at irc.freenode.net

RED HAT | TRIED. TESTED. TRUSTED.
Every airline in the Fortune 500 relies on Red Hat.
Find out why at http://www.redhat.com/en/about/trusted

Red Hat Inc. http://cz.redhat.com

From squid3 at treenet.co.nz  Mon Jul 30 18:40:03 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 31 Jul 2018 06:40:03 +1200
Subject: [squid-dev] Squid versioning
In-Reply-To: <306721930.18439574.1532970702731.JavaMail.zimbra@redhat.com>
References: <306721930.18439574.1532970702731.JavaMail.zimbra@redhat.com>
Message-ID: <f23c03eb-af24-1fc4-5b68-506eec4b1a1e@treenet.co.nz>

On 31/07/18 05:11, Lubos Uhliarik wrote:
> Hey all, 
> 
> I wanted to ask, how is it now with squid versioning. Is configuration from version 4.1 backward 
> compatible with version 4.0?

Maybe, but don't count on it. 4.0.z are betas where things are slightly
broken at points. 4.y (with y > 0) are the stable/production version(s)
resulting from those.


> Are you using semver (https://semver.org/) now?

If anything we have diverged further. We have removed the MINOR category
for stable releases, only using it for the betas.

Amos

From vishali.somaskanthan at viptela.com  Tue Jul 31 23:00:17 2018
From: vishali.somaskanthan at viptela.com (Vishali Somaskanthan)
Date: Tue, 31 Jul 2018 16:00:17 -0700
Subject: [squid-dev] TLS proxy-server connection optimization
Message-ID: <CABfsTT4a8ePKF7BRHkJ5940FT7-mMJ=yRpQFk6H-WDSAG+Gskw@mail.gmail.com>

Hi All,

I am Vishali Somaskanthan. I have been playing around with proxies for
sometime now. I have been experimenting squid for quite a time and my focus
is on the SSL persistence part.

We are planning to qualify if certain optimization can be added at the
SSL/TLS layer. In squid, we have observed that TCP connection persistence
is available. We want to optimize TLS and evaluate if squid to-server TLS
connection can be reused for consecutive requests from multiple clients.

We want to understand the scenarios under which this can be achieved. For
example, for requests coming from same/different clients to same server,
staggered over separate client-squid connections (one after the other).

*Current support in Squid:*



There has been a detailed discussion on this in the general forum on the
trials with respect to the above mentioned scenario. http://squid-web-pro
xy-cache.1019090.n4.nabble.com/server-persistent-connections
-and-cache-td4685973.html


This is my observed behavior with Squid.


   - If I peek @step1 and bump@ step2 -> The connections are pinned.
   Client-squid SSL+TCP termination results in squid-server SSL+TCP
   termination.


   - If I peek @step1 and splice@ step2 -> The connections are **not**
   pinned as such. However, Client-squid SSL+TCP termination results in
   squid-server SSL+TCP termination.



Please provide any insights on whether this is going to be a valid
optimization and if we can come up with a set of rules where this could
apply.

-- 
Regards,
Vishali Somaskanthan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180731/75c153e7/attachment.html>

From rousskov at measurement-factory.com  Tue Jul 31 23:29:42 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 31 Jul 2018 17:29:42 -0600
Subject: [squid-dev] TLS proxy-server connection optimization
In-Reply-To: <CABfsTT4a8ePKF7BRHkJ5940FT7-mMJ=yRpQFk6H-WDSAG+Gskw@mail.gmail.com>
References: <CABfsTT4a8ePKF7BRHkJ5940FT7-mMJ=yRpQFk6H-WDSAG+Gskw@mail.gmail.com>
Message-ID: <211c4e40-1ce6-24ca-7446-9ad5e317d441@measurement-factory.com>

On 07/31/2018 05:00 PM, Vishali Somaskanthan wrote:
> If I peek @step1 and splice@ step2 -> The connections are **not** pinned
> as such. However, Client-squid SSL+TCP termination results in
> squid-server SSL+TCP termination.

Why does Squid close the (not pinned) Squid-to-server connection in this
case? What code/condition triggers that closure in your tests?


> Please provide any insights on whether this is going to be a valid
> optimization and if we can come up with a set of rules where this
> could apply.

With enough information/analysis, we should be able to correctly
evaluate your proposal, but that proposal will have to be a lot more
specific than "We want to optimize TLS and evaluate if squid to-server
TLS connection can be reused for consecutive requests from multiple
clients". My question above is a (small) step towards formulating a
specific "We want to change Squid to do X instead of Y" proposal.


Thank you,

Alex.

From noman.ict.mbstu at gmail.com  Tue Jul 31 20:27:52 2018
From: noman.ict.mbstu at gmail.com (Abu Noman)
Date: Wed, 1 Aug 2018 02:27:52 +0600
Subject: [squid-dev] How to rewrite URL in squid proxy server according to
 client's custom request header?
Message-ID: <CAPDDJgGju5yPgqcrh8hme5wiRasFdg8fCG5nnLt8U1v9w_FNYQ@mail.gmail.com>

How can I rewrite the destination in Squid proxy server according to the
client's request header?

*Details:*
If I call an API like GET www.google.com HTTP/1.0\r\nGo:www.google.com.bd then
Squid proxy will call to GET www.google.com.bd HTTP/1.0. The rewrite URL
will be changed according to clients request.
Regards,
---------------
Abu Noman
*Software Engineer*
Augmedix, Inc.
Dhaka, Bangladesh.
Mobile: +88 01717 717 488
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180801/db62120b/attachment.html>

