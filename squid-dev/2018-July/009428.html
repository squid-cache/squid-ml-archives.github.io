<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Terminating ICAP requests for aborted HTTP requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Terminating%20ICAP%20requests%20for%20aborted%20HTTP%20requests&In-Reply-To=%3Cd9712b12-4e3a-b64b-65d8-dca3485166cc%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009427.html">
   <LINK REL="Next"  HREF="009429.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Terminating ICAP requests for aborted HTTP requests</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Terminating%20ICAP%20requests%20for%20aborted%20HTTP%20requests&In-Reply-To=%3Cd9712b12-4e3a-b64b-65d8-dca3485166cc%40opendium.com%3E"
       TITLE="[squid-dev] Terminating ICAP requests for aborted HTTP requests">steve at opendium.com
       </A><BR>
    <I>Wed Jul 11 13:54:08 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009427.html">[squid-dev] max_url : Pls, into squid.conf
</A></li>
        <LI>Next message: <A HREF="009429.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9428">[ date ]</a>
              <a href="thread.html#9428">[ thread ]</a>
              <a href="subject.html#9428">[ subject ]</a>
              <a href="author.html#9428">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
The ICAP spec doesn't make any comment on what a proxy should do if an 
HTTP client aborts part way through a rewritten response.

i.e. the HTTP client had made a request which has been forwarded onto 
the web server, the web server has started responding, Squid is sending 
the response body to the RESPMOD ICAP service and is forwarding the 
modified body to the client.  Part way through the download, the client 
(or maybe even the server?) drops the TCP connection.  What should Squid do?

My testing shows that the response body that is being sent to the ICAP 
server is cut short by Squid, by terminating it with a zero-length 
chunk.  This is also how fully successful ICAP requests are terminated 
and as the request has been terminated &quot;normally&quot;, the ICAP connection 
can then be used for a new, unrelated, ICAP request.

But what if the ICAP server is doing some caching?  It has no way to 
know whether it has seen the complete object, or if the object has been 
cut short.

So, my question is: is Squid doing the right thing here, and if so how 
should the ICAP server know whether or not it has seen the complete 
object from the web server?  If the web server includes a Content-Length 
header then that could be compared to the final length of the body that 
the ICAP server has received, but this header is not mandatory and many 
requests do not include it.


The solutions that spring to my mind are:

1. Squid could just terminate the ICAP connection if the HTTP request is 
aborted.  The ICAP server would then be able to see that the connection 
was chopped before it received the terminating zero length chunk.  There 
may be a performance impact since Squid would need to establish a new 
connection for the next request.

2. Squid could add an &quot;aborted&quot; extension to the terminating chunk 
header.  i.e. in the same way that &quot;0; ieof&quot; is allowed, &quot;0; aborted&quot; 
could be used.  However, this is not part of the ICAP RFC and would 
therefore be non-standard behaviour that could break clients that have 
less robust parsers.

-- 
  - Steve Hill
    Technical Director
    Opendium    Online Safety / Web Filtering    <A HREF="http://www.opendium.com">http://www.opendium.com</A>

    Enquiries:  <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">sales at opendium.com</A>      +44-1792-824568
    Support:    <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">support at opendium.com</A>    +44-1792-825748


    Opendium Limited is a company registered in England and Wales.
    Company No. 5465437
    Highfield House, 1 Brue Close, Bruton, Somerset, BA10 0HY, England.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009427.html">[squid-dev] max_url : Pls, into squid.conf
</A></li>
	<LI>Next message: <A HREF="009429.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9428">[ date ]</a>
              <a href="thread.html#9428">[ thread ]</a>
              <a href="subject.html#9428">[ subject ]</a>
              <a href="author.html#9428">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
