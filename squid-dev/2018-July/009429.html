<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Terminating ICAP requests for aborted HTTP requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Terminating%20ICAP%20requests%20for%20aborted%20HTTP%20requests&In-Reply-To=%3Ceb1585f1-9282-7b95-9dea-5e1c72009897%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009428.html">
   <LINK REL="Next"  HREF="009430.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Terminating ICAP requests for aborted HTTP requests</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Terminating%20ICAP%20requests%20for%20aborted%20HTTP%20requests&In-Reply-To=%3Ceb1585f1-9282-7b95-9dea-5e1c72009897%40measurement-factory.com%3E"
       TITLE="[squid-dev] Terminating ICAP requests for aborted HTTP requests">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 11 15:46:08 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009428.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
        <LI>Next message: <A HREF="009430.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9429">[ date ]</a>
              <a href="thread.html#9429">[ thread ]</a>
              <a href="subject.html#9429">[ subject ]</a>
              <a href="author.html#9429">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/11/2018 07:54 AM, Steve Hill wrote:

&gt;<i> the HTTP client had made a request which has been forwarded onto
</I>&gt;<i> the web server, the web server has started responding, Squid is sending
</I>&gt;<i> the response body to the RESPMOD ICAP service and is forwarding the
</I>&gt;<i> modified body to the client.  Part way through the download, the client
</I>&gt;<i> (or maybe even the server?) drops the TCP connection.  What should Squid
</I>&gt;<i> do?
</I>
As far as ICAP is concerned, Squid should give the service everything
Squid has. Whether Squid continues to download the object is subject to
various factors such as object cachability and quick_abort_pct settings.
After giving everything, Squid should indicate a premature message
termination (as discussed below).


&gt;<i> My testing shows that the response body that is being sent to the ICAP
</I>&gt;<i> server is cut short by Squid, by terminating it with a zero-length
</I>&gt;<i> chunk.
</I>
Using last-chunk for aborted body termination is a bug. If Squid
terminates the body, it should not use the standard last-chunk. Like you
suggested below, Squid should either (half-)close the connection or
negotiate the use of a chunk extension, both indicating a premature body
termination.


&gt;<i> This is also how fully successful ICAP requests are terminated
</I>&gt;<i> and as the request has been terminated &quot;normally&quot;, the ICAP connection
</I>&gt;<i> can then be used for a new, unrelated, ICAP request.
</I>
Yes, that is the advantage of sending a standard last-chunk, but that
performance advantage is not an excuse for lying to the ICAP service.


&gt;<i> The solutions that spring to my mind are:
</I>&gt;<i> 
</I>&gt;<i> 1. Squid could just terminate the ICAP connection if the HTTP request is
</I>&gt;<i> aborted.  The ICAP server would then be able to see that the connection
</I>&gt;<i> was chopped before it received the terminating zero length chunk.  There
</I>&gt;<i> may be a performance impact since Squid would need to establish a new
</I>&gt;<i> connection for the next request.
</I>
Agreed. Half-closing the connection would allow Squid to receive the
ICAP response which may be useful for logging/annotations, but I am not
sure many ICAP services and Squid itself support that without changes.


&gt;<i> 2. Squid could add an &quot;aborted&quot; extension to the terminating chunk
</I>&gt;<i> header.  i.e. in the same way that &quot;0; ieof&quot; is allowed, &quot;0; aborted&quot;
</I>&gt;<i> could be used.  However, this is not part of the ICAP RFC and would
</I>&gt;<i> therefore be non-standard behaviour that could break clients that have
</I>&gt;<i> less robust parsers.
</I>
Using non-negotiated chunk extensions will break many ICAP servers. The
new feature should be negotiated using the ICAP Allow mechanism. We have
used that mechanism for negotiating ICAP trailer support, for example:
<A HREF="https://tools.ietf.org/html/draft-rousskov-icap-trailers-01#section-5">https://tools.ietf.org/html/draft-rousskov-icap-trailers-01#section-5</A>

Are you in a position to modify your ICAP service to support a new chunk
extension? If yes, I would recommend teaching Squid to use that
extension (when supported by the service) or terminate the ICAP
connection (otherwise).

It would be important to document the exact effects of that new
extension. For example, should the ICAP client expect an ICAP response?
I suspect the answer is yes because, in part, it would be difficult to
prevent an early response that may be already in-flight. Can the
extension be sent by ICAP servers? I suspect the answer is yes because
ICAP servers may face transaction termination conditions as well.

FWIW, I would probably reuse &quot;ieof&quot; instead of &quot;abort&quot;. Its meaning
matches the intent and its reuse would allow implementations to reuse
the existing parsing code.


Cheers,

Alex.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009428.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
	<LI>Next message: <A HREF="009430.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9429">[ date ]</a>
              <a href="thread.html#9429">[ thread ]</a>
              <a href="subject.html#9429">[ subject ]</a>
              <a href="author.html#9429">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
