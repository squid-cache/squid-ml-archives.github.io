<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Terminating ICAP requests for aborted HTTP requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Terminating%20ICAP%20requests%20for%20aborted%20HTTP%20requests&In-Reply-To=%3C541ef11e-b6c6-f816-c665-d70754ffa3f2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009429.html">
   <LINK REL="Next"  HREF="009431.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Terminating ICAP requests for aborted HTTP requests</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Terminating%20ICAP%20requests%20for%20aborted%20HTTP%20requests&In-Reply-To=%3C541ef11e-b6c6-f816-c665-d70754ffa3f2%40treenet.co.nz%3E"
       TITLE="[squid-dev] Terminating ICAP requests for aborted HTTP requests">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 11 16:16:54 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009429.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
        <LI>Next message: <A HREF="009431.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9430">[ date ]</a>
              <a href="thread.html#9430">[ thread ]</a>
              <a href="subject.html#9430">[ subject ]</a>
              <a href="author.html#9430">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/07/18 03:46, Alex Rousskov wrote:
&gt;<i> On 07/11/2018 07:54 AM, Steve Hill wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> the HTTP client had made a request which has been forwarded onto
</I>&gt;&gt;<i> the web server, the web server has started responding, Squid is sending
</I>&gt;&gt;<i> the response body to the RESPMOD ICAP service and is forwarding the
</I>&gt;&gt;<i> modified body to the client.  Part way through the download, the client
</I>&gt;&gt;<i> (or maybe even the server?) drops the TCP connection.  What should Squid
</I>&gt;&gt;<i> do?
</I>&gt;<i> 
</I>&gt;<i> As far as ICAP is concerned, Squid should give the service everything
</I>&gt;<i> Squid has. Whether Squid continues to download the object is subject to
</I>&gt;<i> various factors such as object cachability and quick_abort_pct settings.
</I>&gt;<i> After giving everything, Squid should indicate a premature message
</I>&gt;<i> termination (as discussed below).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> My testing shows that the response body that is being sent to the ICAP
</I>&gt;&gt;<i> server is cut short by Squid, by terminating it with a zero-length
</I>&gt;&gt;<i> chunk.
</I>&gt;<i> 
</I>&gt;<i> Using last-chunk for aborted body termination is a bug. If Squid
</I>&gt;<i> terminates the body, it should not use the standard last-chunk. Like you
</I>&gt;<i> suggested below, Squid should either (half-)close the connection or
</I>&gt;<i> negotiate the use of a chunk extension, both indicating a premature body
</I>&gt;<i> termination.
</I>
But the chunking here means end of *ICAP* message. Not end of HTTP message.

The ICAP server should use the HTTP message headers to know the HTTP
message sizes when possible. eg Content-Length and Content-Range values
indicate whether the HTTP delivered is complete or not.

HTTP Transfer-Encoding messages are a problem though. In absence of a
proper ICAP signal we should probably abort the ICAP connection at the
end of what Squid has (or intends to deliver, in the case the server
connection is also being dropped rather than response absorbed).

If there *is* an ICAP signal then Squid should of course use that in all
cases of early halted HTTP content. Even when it uses the last-chunk to
say where the ICAP message ends and the next may begin.

Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009429.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
	<LI>Next message: <A HREF="009431.html">[squid-dev] Terminating ICAP requests for aborted HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9430">[ date ]</a>
              <a href="thread.html#9430">[ thread ]</a>
              <a href="subject.html#9430">[ subject ]</a>
              <a href="author.html#9430">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
