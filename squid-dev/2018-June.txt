From eduard.bagdasaryan at measurement-factory.com  Thu Jun  7 22:13:38 2018
From: eduard.bagdasaryan at measurement-factory.com (Eduard Bagdasaryan)
Date: Fri, 8 Jun 2018 01:13:38 +0300
Subject: [squid-dev] Use MAX_URL for first line limitation
Message-ID: <69d5771a-979a-b574-8169-e6ee5ed151bf@measurement-factory.com>

Hi Squid developers,


There is a bug in Squid when using %>ru log format code for
relatively large URLs of size between MAX_URL=8K and 64K. In this
case, a dash "-" is logged, whereas another, similar %ru logs the
URL (or its prefix), as expected. We found a solution for this bug,
introducing a new AccessLogEntry virgin URL field, and using it
inside Format::assemble() for LFT_CLIENT_REQ_URI (when
request is nil). However, this solution itself is
insufficient: with it, in %>ru Squid logs large and small URLs
differently.  For example, Squid strips whitespaces from small URLs,
while keeping them for large ones.

We considered two possible solutions:

1. Adjust urlParse() to process large URLs (instead of returning when
    noticing an URL exceeds MAX_URL). This solution can be
    problematic, because the parsed URL can even exceed 64K limit (e.g.,
    after applying rfc1738_unescape()).

2. Adjust Http::One::RequestParser::parseRequestFirstLine(), immediately
    rejecting requests with URLs exceeding MAX_URL (use it instead of
    Config.maxRequestHeaderSize). As a result, access.log would get
    "error:request-too-large" for such requests. This solution looks
    better, since anyway, Squid eventually denies such requests and,
    moreover, there are many contexts in Squid tied up to that MAX_URL
    limitation.

   So, the question is: can we go on with (2) without breaking something?
   Or probably there are any other(better) alternative approaches?


Thank you,

Eduard.


From rousskov at measurement-factory.com  Thu Jun  7 23:18:02 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 7 Jun 2018 17:18:02 -0600
Subject: [squid-dev] Use MAX_URL for first line limitation
In-Reply-To: <69d5771a-979a-b574-8169-e6ee5ed151bf@measurement-factory.com>
References: <69d5771a-979a-b574-8169-e6ee5ed151bf@measurement-factory.com>
Message-ID: <9dc0b958-73c3-ba18-d2c6-dbcc81e233dd@measurement-factory.com>

On 06/07/2018 04:13 PM, Eduard Bagdasaryan wrote:

> in %>ru Squid logs large and small URLs differently.  For example,
> Squid strips whitespaces from small URLs, while keeping them for
> large ones.

Is %ru logging consistent with regard to small and large URLs?

* If it is, should we use the same approach to make %>ru consistent?

* Otherwise, we should keep both %ru and %>ru in mind when deciding
whether (and how) to make logging consistent. For example, it would be
OK to ignore this inconsistency if making things consistent requires too
much out-of-scope work.


> 2. Adjust Http::One::RequestParser::parseRequestFirstLine(), immediately
>    rejecting requests with URLs exceeding MAX_URL (use it instead of
>    Config.maxRequestHeaderSize). As a result, access.log would get
>    "error:request-too-large" for such requests. This solution looks
>    better, since anyway, Squid eventually denies such requests and,
>    moreover, there are many contexts in Squid tied up to that MAX_URL
>    limitation.
> 
>   So, the question is: can we go on with (2) without breaking something?

Clarification: (2) is already known to "break something" -- after (2),
some refused transactions that were previously logged with the actual
URL (prefix) in %ru would be logged with a largely useless
"error:request-too-large" URL. Which evil is lesser:

  a) hiding actual %ru URL for requests with URLs between ~8K and ~64K
  b) inconsistent logging of small vs large URLs


>   Or probably there are any other(better) alternative approaches?

Yes, that is the other important question. FWIW, I do not know any
better solutions that do not require fixing the 8K/64K problem itself
(which is way out of %>ru fixing scope).


Thank you,

Alex.
P.S. Here, "inconsistent logging" means that two URLs with identical 7K
prefix may be logged differently if one of the URLs is longer than 8K.
Scripts and humans can be easily confused by such inconsistent logging,
and URL lengths are often at the mercy of highly variable parameters
such as search strings, session IDs, context descriptions, etc.

From squid3 at treenet.co.nz  Fri Jun  8 08:46:37 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 8 Jun 2018 20:46:37 +1200
Subject: [squid-dev] Use MAX_URL for first line limitation
In-Reply-To: <9dc0b958-73c3-ba18-d2c6-dbcc81e233dd@measurement-factory.com>
References: <69d5771a-979a-b574-8169-e6ee5ed151bf@measurement-factory.com>
 <9dc0b958-73c3-ba18-d2c6-dbcc81e233dd@measurement-factory.com>
Message-ID: <1a5d90f0-6951-e001-dbe3-8b0bdef6fd0b@treenet.co.nz>

On 08/06/18 11:18, Alex Rousskov wrote:
> On 06/07/2018 04:13 PM, Eduard Bagdasaryan wrote:
> 
>> in %>ru Squid logs large and small URLs differently.  For example,
>> Squid strips whitespaces from small URLs, while keeping them for
>> large ones.
> 
> Is %ru logging consistent with regard to small and large URLs?
> 
> * If it is, should we use the same approach to make %>ru consistent?
> 

For a quick fix yes.

Longer term; all Squid code using char* buffers and MAX_URL for URL
storage is obsolete and needs fixing to use class URL (or an SBuf) instead.

Amos

From eduard.bagdasaryan at measurement-factory.com  Fri Jun  8 13:43:43 2018
From: eduard.bagdasaryan at measurement-factory.com (Eduard Bagdasaryan)
Date: Fri, 8 Jun 2018 16:43:43 +0300
Subject: [squid-dev] Use MAX_URL for first line limitation
In-Reply-To: <1a5d90f0-6951-e001-dbe3-8b0bdef6fd0b@treenet.co.nz>
References: <69d5771a-979a-b574-8169-e6ee5ed151bf@measurement-factory.com>
 <9dc0b958-73c3-ba18-d2c6-dbcc81e233dd@measurement-factory.com>
 <1a5d90f0-6951-e001-dbe3-8b0bdef6fd0b@treenet.co.nz>
Message-ID: <3649ddde-9387-b0aa-6448-9b1843389b69@measurement-factory.com>

Yes, %>ru is consistent for small and large URLs.

FYI: this problem existed in the past for %>ru, but was fixed at master
r11274. I have a feeling that the way how setLogUri() fixes malformed
requests was not the best choice (in fact, there is a code duplication
between setLogUri() and urlParse(), and, moreover, I suspect that
encoding methods like rfc1738_escape_unescaped() may be applied
several times with destructive consequences).

However, probably in this small step we could leave those problems
aside and just unify %>ru and %ru 'cleanup' procedure, as suggested.
I see a simple fix: in One::Server::buildHttpRequest() initialize
our new ALE::virginUrlForMissingRequest with http->log_uri just
after setLogUri() (i.e., when the URL was clean-upped already).


Eduard.


On 08.06.2018 11:46, Amos Jeffries wrote:
> On 08/06/18 11:18, Alex Rousskov wrote:
>> On 06/07/2018 04:13 PM, Eduard Bagdasaryan wrote:
>>
>>> in %>ru Squid logs large and small URLs differently.  For example,
>>> Squid strips whitespaces from small URLs, while keeping them for
>>> large ones.
>> Is %ru logging consistent with regard to small and large URLs?
>>
>> * If it is, should we use the same approach to make %>ru consistent?
>>
> For a quick fix yes.
>
> Longer term; all Squid code using char* buffers and MAX_URL for URL
> storage is obsolete and needs fixing to use class URL (or an SBuf) instead.
>
> Amos
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev


From augustus_meyer at yahoo.de  Sat Jun  9 10:35:39 2018
From: augustus_meyer at yahoo.de (babajaga)
Date: Sat, 9 Jun 2018 03:35:39 -0700 (MST)
Subject: [squid-dev] max_url : Pls, into squid.conf
Message-ID: <1528540539732-0.post@n4.nabble.com>

I get a quite a few error msgs like
urlParse: URL too large (9182 bytes)
in cache.log
I suspect, they are most likely from some ads, however, they make the web
page appear slow to complete rendering.

Hesitating to patch defines.h directly, I kindly ask for
an additional parameter in squid.conf







--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Development-f1042840.html

From squid3 at treenet.co.nz  Sat Jun  9 12:42:20 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 10 Jun 2018 00:42:20 +1200
Subject: [squid-dev] max_url : Pls, into squid.conf
In-Reply-To: <1528540539732-0.post@n4.nabble.com>
References: <1528540539732-0.post@n4.nabble.com>
Message-ID: <32f2e3d7-c0c4-3e8c-0787-15e82c301aca@treenet.co.nz>

On 09/06/18 22:35, babajaga wrote:
> I get a quite a few error msgs like
> urlParse: URL too large (9182 bytes)
> in cache.log
> I suspect, they are most likely from some ads, however, they make the web
> page appear slow to complete rendering.
> 
> Hesitating to patch defines.h directly, I kindly ask for
> an additional parameter in squid.conf
> 

This is not going to happen sorry. Unfortunately there are too many
points in the code allocating buffers for URLs which do not use the
MAX_URL definition.
For example; I am this very minute testing a patch to remove one more of
those bits of code I just found trying to stuff a 8KB URL into a 4KB
buffer :-(.

We have an ongoing project to remove the URL length limits from within
Squid. Hopefully that will resolve the issue as it progresses without
the need for a config option. If you are using Squid-3.5 you may see a
reduction of these messages from Squid-4.


PS. Squid is known to be one of the most lenient web agents. Most origin
servers and other proxies have smaller URL restrictions. So whatever
application is trying to use >9KB URLs is unlikely to work generally
over the Internet even if we resolve the Squid complaints.

Amos

From squid3 at treenet.co.nz  Sat Jun  9 13:48:26 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 10 Jun 2018 01:48:26 +1200
Subject: [squid-dev] Squid-4 status update
In-Reply-To: <d03e4106-8287-e943-0b73-2243b6bb030b@treenet.co.nz>
References: <d03e4106-8287-e943-0b73-2243b6bb030b@treenet.co.nz>
Message-ID: <d9e8feb2-3554-2698-78ae-1dc2233d6faa@treenet.co.nz>

Hi everybody,

So far as I am aware these are the only remaining issues blocking stable
release:


* Bug 4710 - crash with on_unsupported_protocol and eCAP

 This may already be gone. I have not been able to reproduce it in the
current v4 code. If we dont have confirmation that it is still relevant
I intend to ignore it for the release.


* Bug 4843 - GCC v8.0 support

 Awaiting QA re-review completion.


* A crash in "squid -k parse" is passed a misconfigured squid.conf.

 Awaiting QA review.


4.0.25 should be out in a few days for testing of the many current bug
fixes in v4 (hopefully the above included).


So, if there are any other issues that need attention before Squid-4
goes stable now is the time to mention them.


Thank you all for a LOT of hard work.


Amos

From desis at ymail.com  Mon Jun 11 19:48:30 2018
From: desis at ymail.com (desis)
Date: Mon, 11 Jun 2018 12:48:30 -0700 (MST)
Subject: [squid-dev] squid to assign dedicated ip to clients behind same
	network/router
Message-ID: <1528746510652-0.post@n4.nabble.com>

 0
down vote
favorite

I have successfully installed squid server (On Centos) .. My servers has
five ip addresses . I have configured all 5 ip addresses for squid... so
clients can connect with any ip address and with tcp_outgoing_address client
will get same ip address from which ip address he is connecting.

But the problem is all my clients are behind a same router and having the
same public ip address.

Now the problem is .. Let see client one use server 1.1.1.0 ip address to
connect squid first, he is getting server 1.1.1.0 ip address for his public
ip.

Now Client two using server 2.2.2.0 ip address to connect squid , he is
getting server 2.2.2.0 ip adddress for his public ip ...

But at this moment client's one public ip address is changing to 2.2.2.0 .

How I can configure squid, so each client will get dedicated public ip
address from server at the same ip .




--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Development-f1042840.html

From desis at ymail.com  Mon Jun 11 19:53:51 2018
From: desis at ymail.com (desis)
Date: Mon, 11 Jun 2018 12:53:51 -0700 (MST)
Subject: [squid-dev] squid to assign dedicated ip to clients behind same
	network/router
Message-ID: <1528746831633-0.post@n4.nabble.com>

I have successfully installed squid server (On Centos) .. My servers has five
ip addresses . I have configured all 5 ip addresses for squid... so clients
can connect with any ip address and with tcp_outgoing_address client will
get same ip address from which ip address he is connecting.

But the problem is all my clients are behind a same router and having the
same public ip address.

Now the problem is .. Let see client one use server 1.1.1.0 ip address to
connect squid first, he is getting server 1.1.1.0 ip address for his public
ip.

Now Client two using server 2.2.2.0 ip address to connect squid , he is
getting server 2.2.2.0 ip adddress for his public ip ...

But at this moment client's one public ip address is changing to 2.2.2.0 .

How I can configure squid, so each client will get dedicated public ip
address from server at the same ip .




--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Development-f1042840.html

From desis at ymail.com  Mon Jun 11 19:50:58 2018
From: desis at ymail.com (BdNewMarket)
Date: Mon, 11 Jun 2018 19:50:58 +0000 (UTC)
Subject: [squid-dev] squid to assign dedicated ip to clients behind same
	network/router
References: <1913162894.3332001.1528746658097.ref@mail.yahoo.com>
Message-ID: <1913162894.3332001.1528746658097@mail.yahoo.com>

I have successfully installed squid server (On Centos) .. My servers has five ip addresses . I have configured all 5 ip addresses for squid... so clients can connect with any ip address and with tcp_outgoing_address client will get same ip address from which ip address he is connecting.

But the problem is all my clients are behind a same router and having the same public ip address.

Now the problem is .. Let see client one use server 1.1.1.0 ip address to connect squid first, he is getting server 1.1.1.0 ip address for his public ip.

Now Client two using server 2.2.2.0 ip address to connect squid , he is getting server 2.2.2.0 ip adddress for his public ip ...

But at this moment client's one public ip address is changing to 2.2.2.0 .

How I can configure squid, so each client will get dedicated public ip address from server at the same ip .

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180611/295a96c5/attachment.html>

From bogdan.stoica at epfl.ch  Sun Jun 17 08:36:04 2018
From: bogdan.stoica at epfl.ch (Stoica Bogdan Alexandru)
Date: Sun, 17 Jun 2018 08:36:04 +0000
Subject: [squid-dev] Squid test-suite / benchmarks
Message-ID: <8fab8e64a9014823bd9bd1a960d96e90@rexe.intranet.epfl.ch>

Hi all,

I've asked the same questions on the squid-user distribution list, but perhaps is better to ask the developers.

We're a small research team interested in benchmarking Squid for a research project.
In short, we would like to exercise as much code as possible (i.e., good code coverage).
Do you have any suggestions on the which benchmarks to use? Or, even better, is there anything that Squid uses internally that can be shared for research?

Thanks a lot for your help!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180617/e09ffed4/attachment.html>

From squid3 at treenet.co.nz  Mon Jun 18 04:35:59 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 18 Jun 2018 16:35:59 +1200
Subject: [squid-dev] Squid test-suite / benchmarks
In-Reply-To: <8fab8e64a9014823bd9bd1a960d96e90@rexe.intranet.epfl.ch>
References: <8fab8e64a9014823bd9bd1a960d96e90@rexe.intranet.epfl.ch>
Message-ID: <fe73e65b-9ecc-4c31-29ae-3227a14825a0@treenet.co.nz>

On 17/06/18 20:36, Stoica Bogdan Alexandru wrote:
> Hi all,
> 
> 
> I’ve asked the same questions on the squid-user distribution list, but
> perhaps is better to ask the developers.
> 
>  
> 
> We’re a small research team interested in benchmarking Squid for a
> research project.
> 
> In short, we would like to exercise as much code as possible (i.e., good
> code coverage).
> 
> Do you have any suggestions on the which benchmarks to use? Or, even
> better, is there anything that Squid uses internally that can be shared
> for research?

The internal testing is pretty much what Alex and I already mentioned on
squid-users.

Others on the list may have extra ideas. Though if you don't get any
reply than this you're not being ignored, just means none has any better
ideas.


Cheers
Amos

From squid3 at treenet.co.nz  Mon Jun 18 04:57:43 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 18 Jun 2018 16:57:43 +1200
Subject: [squid-dev] squid to assign dedicated ip to clients behind same
 network/router
In-Reply-To: <1528746510652-0.post@n4.nabble.com>
References: <1528746510652-0.post@n4.nabble.com>
Message-ID: <1fe541ce-798a-7949-7ca4-d9acd76a6b26@treenet.co.nz>

[ this dev list is not appropriate for proxy usage questions. Please
address questions and requests for help using Squid to the squid-users
mailign list. ]


On 12/06/18 07:48, desis wrote:
> 
> I have successfully installed squid server (On Centos) .. My servers has

Which version of Squid on what version of CentOS.

Squid versions older than the 3.5 series are not supported by us. AFAIK
the problem you describe does not happen with a correctly configured
Squid-3.5.


> five ip addresses . I have configured all 5 ip addresses for squid... so
> clients can connect with any ip address and with tcp_outgoing_address client
> will get same ip address from which ip address he is connecting.
> 
> But the problem is all my clients are behind a same router and having the
> same public ip address.

The joys of NAT and IPv4-only networks.

The only real solution to that is to upgrade your network such that it
does not NAT clients into the same IP address. You may require IPv6 to
achieve that.


> 
> Now the problem is .. Let see client one use server 1.1.1.0 ip address to
> connect squid first, he is getting server 1.1.1.0 ip address for his public
> ip.
> 
> Now Client two using server 2.2.2.0 ip address to connect squid , he is
> getting server 2.2.2.0 ip adddress for his public ip ...
> 
> But at this moment client's one public ip address is changing to 2.2.2.0 .

There is nothing Squid can do about a *client* IP address. All it can do
it *request* the OS to use certain outgoing IP on its own connections.


Going forward you need to be aware that HTTP is a multiplexing protocol.
Any connection between proxy and a server can be used by any client who
needs content from that server.

This is how HTTP is designed to work. To multiplex connections and
maximize pipeline efficiencies, in order to reduce the pressures of port
number consumption. Without it proxies can flood the network with
short-lived TCP connections and consume all available ports on every
machine along the traffic path.


Amos

From eliezer at ngtech.co.il  Fri Jun 22 10:25:23 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Fri, 22 Jun 2018 13:25:23 +0300
Subject: [squid-dev] PROXY protocol and TPROXY, can they go together?
In-Reply-To: <33a8b0dc-359a-3e01-42fe-dad0e4d5f392@treenet.co.nz>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGDVRrtF13VDjYYZR9MgvgYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAze1iQlI01RJfm+FO2rm9bAQAAAAA=@ngtech.co.il>
 <33a8b0dc-359a-3e01-42fe-dad0e4d5f392@treenet.co.nz>
Message-ID: <c44eca00eddf6241ebf8b0a33a0e9919@ngtech.co.il>

Hey Amos,

The custom LB is to only try and filter before the connections reach's 
squid http and non-http traffic.
Currently I have a prototype which intercepts using TPROXY by itself and 
identifies couple protocols.

The reason for this LB is that I get a more flexible way around the 
connection.
My code can enforce specific ACL's based on specific characteristics of 
the client and\or the server.

Iptables does it's work fine but lacks the ability to dynamically handle 
and identify specific traffic.
For example the nDPI iptables module:
- https://github.com/vel21ripn/nDPI

which is being used in couple products and a similar module also exists 
on many commercial products but still lacks some degree of flexibility.
The kernel land is indeed fast and maybe efficient but is binding the 
programmers to C and it's libraries and compilers let alone licenses.

Currently on a 40+ cores machine with 128GB ram I can run a full blown 
layer 7 proxy for a big network(/16+) and the CPU is almost always 
loaded below 10%.

I do not intent to develop my proxy too much since others have done this 
already but it's nice to see that more products can enter the market 
easily.

Thanks,
Eliezer


On 2018-05-15 22:36, Amos Jeffries wrote:
> On 16/05/18 02:09, Eliezer Croitoru wrote:
>> Hey Squid-Dev,
>> 
>> I am in the middle of writing a load balancer \ router (almost done) 
>> for
>> squid with TPROXY in it.
>> 
>> The load balancer sits on the Squid machine and intercepts the 
>> connections.
>> 
>> I want to send Squid instances a new connection on a PROXY protocol
>> enabled http_port but that squid will use TPROXY on the outgoing
>> connection based on the PROXY protocol details.
>> 
>>  
>> 
>> Would it be possible? I think it should but not sure.
>> 
> 
> Maybe. Since both software are on the same machine it should get past
> the kernel protections against arbitrary spoofing.
> 
> You will have to check that BOTH dst-IP:port and src-IP:port pairs are
> correctly relayed by the PROXY protocol. If not the TPROXY will end up
> with mangled socket state and undefined behaviour (probably breakage).
> 
> 
>>  
>> 
>> My plan is to try and load balance connections between multiple squid
>> instances\workers for filtering purposes and PIN each of the instances
>> to a CPU (20+ cores Physical host).
>> 
>> How reasonable is this idea?
> 
> You don't need a custom LB. iptables is sufficient, or other firewalls
> if you have a non-Linux machine.
> 
> 
> <https://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend#Frontend_Balancer_Alternative_1:_iptables>
> 
> You should be able to fit those LB lines into a normal TPROXY config.
> Just replace the "-j REDIRECT" with the "-j TPROXY --tproxy-mark ...".
> 
> Amos
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev

-- 
----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

From eliezer at ngtech.co.il  Fri Jun 22 10:33:11 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Fri, 22 Jun 2018 13:33:11 +0300
Subject: [squid-dev] Block users dynamically
In-Reply-To: <90c785d8-3356-bfeb-f3a6-5dfea3fee9bd@urlfilterdb.com>
References: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
 <426b96c9-e209-170f-0b96-251a39fed27d@urlfilterdb.com>
 <CAAqh3JL2cjJ-2Er-guQYuK5bUH6cx51=myvzQ5CF1JK7j-_shA@mail.gmail.com>
 <90c785d8-3356-bfeb-f3a6-5dfea3fee9bd@urlfilterdb.com>
Message-ID: <6dc0ee6a5e7498404e390abbfd8580bf@ngtech.co.il>

I am pretty sure it was pointed towards Dean and the top\tip of thread.

But well also for ufdbGuard, have you ever considered using an external 
ACL helper api?
Or maybe an ICAP one?

..I can try to look at the ufdbGuard helper code and compile an ICAP 
service based on this but... only if someone needs or wants it.

Eliezer

On 2018-05-30 15:01, Marcus Kool wrote:
> On 30/05/18 08:55, Daniel Berredo wrote:
>> Have you ever considered using an external ACL helper?
> 
> eh, for what ?
> 
>> On Tue, May 29, 2018, 9:57 PM Marcus Kool <marcus.kool at urlfilterdb.com 
>> <mailto:marcus.kool at urlfilterdb.com>> wrote:
>> 
>> 
>>     On 28/05/18 15:10, dean wrote:
>>      > I am implementing modifications to Squid 3.5.27 for a thesis 
>> job. At some point in the code, I need to block a user. What I'm doing 
>> is writing to an external file that is used in the
>>     configuration,
>>      > like Squish does. But it does not block the user, however when 
>> I reconfigure Squid if it blocks it. Is there something I do not know? 
>> When I change the file, should I reconfigure Squid? Is there
>>      > another way to block users dynamically from the Squid code?
>> 
>>     You can use ufdbGuard for this purpose.  ufdbGuard is a free URL 
>> redirector for Squid which can be configured to read lists of 
>> usernames or list of IP addresses every X minutes (default for X is 
>> 15).
>>     So if you control a blacklist with usernames and write the name of 
>> the user to a defined file, ufdbguardd will block these users.
>>     If the user must be blocked immediately you need to reload 
>> ufdbguardd, otherwise you wait until the configured time interval to 
>> reread the userlist expires and so after a few minutes the user gets
>>     blocked.
>> 
>>     Note that reloading ufdbguardd does not interfere with Squid and 
>> all activity by browsers and squid continues normally.
>> 
>>     Marcus
>> 
>>     _______________________________________________
>>     squid-dev mailing list
>>     squid-dev at lists.squid-cache.org 
>> <mailto:squid-dev at lists.squid-cache.org>
>>     http://lists.squid-cache.org/listinfo/squid-dev
>> 
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev

-- 
----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

From eliezer at ngtech.co.il  Fri Jun 22 10:38:17 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Fri, 22 Jun 2018 13:38:17 +0300
Subject: [squid-dev] squid to assign dedicated ip to clients behind same
 network/router
In-Reply-To: <1528746831633-0.post@n4.nabble.com>
References: <1528746831633-0.post@n4.nabble.com>
Message-ID: <77cc31152c64e35e32c3ab5fbda214e8@ngtech.co.il>

Hey Desis,

What exactly the proxy needs to do? only access the network?
Also caching?
Are you using SSL-BUMP?

There are couple ways to achieve what you want but if you don't need 
Squid Cache special features then maybe you wouldn't need it 
specifically.

Eliezer

On 2018-06-11 22:53, desis wrote:
> I have successfully installed squid server (On Centos) .. My servers 
> has five
> ip addresses . I have configured all 5 ip addresses for squid... so 
> clients
> can connect with any ip address and with tcp_outgoing_address client 
> will
> get same ip address from which ip address he is connecting.
> 
> But the problem is all my clients are behind a same router and having 
> the
> same public ip address.
> 
> Now the problem is .. Let see client one use server 1.1.1.0 ip address 
> to
> connect squid first, he is getting server 1.1.1.0 ip address for his 
> public
> ip.
> 
> Now Client two using server 2.2.2.0 ip address to connect squid , he is
> getting server 2.2.2.0 ip adddress for his public ip ...
> 
> But at this moment client's one public ip address is changing to 
> 2.2.2.0 .
> 
> How I can configure squid, so each client will get dedicated public ip
> address from server at the same ip .
> 
> 
> 
> 
> --
> Sent from:
> http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Development-f1042840.html
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev

-- 
----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

From squid3 at treenet.co.nz  Tue Jun 26 07:33:15 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 26 Jun 2018 19:33:15 +1200
Subject: [squid-dev] Squid-4.1 (stable)
In-Reply-To: <d9e8feb2-3554-2698-78ae-1dc2233d6faa@treenet.co.nz>
References: <d03e4106-8287-e943-0b73-2243b6bb030b@treenet.co.nz>
 <d9e8feb2-3554-2698-78ae-1dc2233d6faa@treenet.co.nz>
Message-ID: <9d51e14d-137b-001c-e3d1-d504c3fbfcca@treenet.co.nz>


The latest Squid-4 beta has now passed 14 days with no new major bugs
being reported. That means I can start the final countdown for the
Squid-4.1 release.

Unless something new comes up I intend to bundle that release on 2018-06-30.


Amos

From gkinkie at gmail.com  Tue Jun 26 12:07:43 2018
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Tue, 26 Jun 2018 13:07:43 +0100
Subject: [squid-dev] Squid-4.1 (stable)
In-Reply-To: <9d51e14d-137b-001c-e3d1-d504c3fbfcca@treenet.co.nz>
References: <d03e4106-8287-e943-0b73-2243b6bb030b@treenet.co.nz>
 <d9e8feb2-3554-2698-78ae-1dc2233d6faa@treenet.co.nz>
 <9d51e14d-137b-001c-e3d1-d504c3fbfcca@treenet.co.nz>
Message-ID: <CA+Y8hcN8K_X6k7wjdQOhNLHdT5NE1YAejfKang1MFCSzATE5eQ@mail.gmail.com>

Great!

Looking forward to it

On Tue, Jun 26, 2018 at 8:33 AM Amos Jeffries <squid3 at treenet.co.nz> wrote:

>
> The latest Squid-4 beta has now passed 14 days with no new major bugs
> being reported. That means I can start the final countdown for the
> Squid-4.1 release.
>
> Unless something new comes up I intend to bundle that release on
> 2018-06-30.
>
>
> Amos
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180626/5e280471/attachment.html>

From mikes at surcouf.co.uk  Tue Jun 26 18:36:46 2018
From: mikes at surcouf.co.uk (Mike Surcouf)
Date: Tue, 26 Jun 2018 18:36:46 +0000
Subject: [squid-dev] Support lower case http/ spn format for realmd/adcli
	join support.
Message-ID: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>

This can be seen here but also applies to other helpers that use Kerberos.

https://github.com/squid-cache/squid/blob/5b74111aff8948e869959113241adada0cd488c2/src/auth/negotiate/kerberos/negotiate_kerberos_auth.cc#L490

adcli (which realmd uses for AD joins)  supports lowercases all SPNs when adding them to a keytab.
Whether HTTP/ or http/ SPNs are valid is up for debate and really depends on the convention of the tool in question but I see no harm in supporting lowercase http/ in addition to HTTP/ SPNs.
As far as I can see even supplying your own SPN does not allow http/ (lowercase)

This would provide compatibility with adcli and realmd join which are common tools for AD management on CentOS/RHEL.

Thanks

Mike


From mikes at surcouf.co.uk  Tue Jun 26 18:53:37 2018
From: mikes at surcouf.co.uk (Mike Surcouf)
Date: Tue, 26 Jun 2018 18:53:37 +0000
Subject: [squid-dev] Support lower case http/ spn format for
 realmd/adcli	join support.
In-Reply-To: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
Message-ID: <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>

Correction

> supports lowercases all SPNs

should read 

lowercases all SPNs (you don’t have an option)

so it always produces http/hostname at REALM.COM

This is a conscious decision by the adcli team

https://bugs.freedesktop.org/show_bug.cgi?id=84749


-----Original Message-----
From: squid-dev [mailto:squid-dev-bounces at lists.squid-cache.org] On Behalf Of Mike Surcouf
Sent: 26 June 2018 19:37
To: 'squid-dev at lists.squid-cache.org'
Subject: [squid-dev] Support lower case http/ spn format for realmd/adcli join support.

This can be seen here but also applies to other helpers that use Kerberos.

https://github.com/squid-cache/squid/blob/5b74111aff8948e869959113241adada0cd488c2/src/auth/negotiate/kerberos/negotiate_kerberos_auth.cc#L490

adcli (which realmd uses for AD joins)  supports lowercases all SPNs when adding them to a keytab.
Whether HTTP/ or http/ SPNs are valid is up for debate and really depends on the convention of the tool in question but I see no harm in supporting lowercase http/ in addition to HTTP/ SPNs.
As far as I can see even supplying your own SPN does not allow http/ (lowercase)

This would provide compatibility with adcli and realmd join which are common tools for AD management on CentOS/RHEL.

Thanks

Mike

_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev

From squid3 at treenet.co.nz  Wed Jun 27 18:11:42 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 28 Jun 2018 06:11:42 +1200
Subject: [squid-dev] Support lower case http/ spn format for
 realmd/adcli join support.
In-Reply-To: <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>
Message-ID: <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>

On 27/06/18 06:53, Mike Surcouf wrote:
> Correction
> 
>> supports lowercases all SPNs
> 
> should read 
> 
> lowercases all SPNs (you don’t have an option)
> 
> so it always produces http/hostname at REALM.COM
> 
> This is a conscious decision by the adcli team
> 
> https://bugs.freedesktop.org/show_bug.cgi?id=84749
> 

I don't see any explicit decision by them to use only lower-case. Just
statements that AD accepts case-insensitive inputs so they don't care to
do anything special.


Case insensitivity is a Microsoft custom extension. It cannot be relied
on in non-MS software :
"
Service Principal Names (SPNs) are not case sensitive when used by
Microsoft Windows-based computers. However, an SPN can be used by any
type of computer system. Many of these computer systems, especially
UNIX-based systems, are case-sensitive and require the proper case to
function properly. Care should be taken to use the proper case
particularly when an SPN can be used by a non-Windows-based computer.

Refer this: http://technet.microsoft.com/en-us/library/cc731241(WS.10).aspx
"


Squid also does not parse these details itself. The library being used
by the helper is responsible for all processing of the local machines
keytab. Squid only parses a token of opaque bytes from HTTP message
headers and passes it as opaque string it to the auth helpers. Our
Kerberos helpers use several libraries, and the one which you are using
apparently has case sensitivity for the SPN.



On the technical side:

Kerberos documents just defer to the protocols where the elements of SPN
are sourced. So some segments in the SPN are case sensitive and others
are not, depending on what type of use the SPN is put.
 eg DNS defines hostname as insensitive, so that part is. Some auth
systems define realm as insensitive, others as case-sensitive - so that
part *might be* (or not. ouch!).


FWIW, following that deferrance style - the HTTP protocol defines its
protocol name as case-sensitive and has a significant difference between
"HTTP" (transport / messaging syntax) and "http" (URL scheme/syntax,
possibly used over non-HTTP transports).

So technically / in theory:
 * if the SPN is for access to HTTP transport (as Squid SPN are)
   - then the "HTTP/" portion should be upper case only.

 * if the SPN is for use of http:// resource URLs (eg, as opposed to
ftp:// URLs fetched with HTTP)
 - it can be any case.


Squid does not go to that second URL-specific level of detail with
authentication and SPNs. Also, since one is required upper case, and the
other doesn't matter going upper case would be the best choice for us if
we did normalize rather than handle as opaque strings anyway.


HTH
Amos

From mikes at surcouf.co.uk  Wed Jun 27 20:24:33 2018
From: mikes at surcouf.co.uk (Mike Surcouf)
Date: Wed, 27 Jun 2018 20:24:33 +0000
Subject: [squid-dev] Support lower case http/ spn format for
	realmd/adcli join support.
In-Reply-To: <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>, 
 <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>
Message-ID: <be402abb-32f4-4dc2-89c5-bf6e2d0e5986@email.android.com>

Thanks Amos for your comprehensive reply..  open SSH requires lower case host/ and as you say windows doesn't seem to care so they solved it for that case but seems that uppercase is the convention for HTTP.
  Do you have an official reference for HTTP/. As the official uppercase format of SPN for http protocol.i will then file a bug on the adcli repo.

On 27 Jun 2018 7:11 pm, Amos Jeffries <squid3 at treenet.co.nz> wrote:
On 27/06/18 06:53, Mike Surcouf wrote:
> Correction
>
>> supports lowercases all SPNs
>
> should read
>
> lowercases all SPNs (you don’t have an option)
>
> so it always produces http/hostname at REALM.COM
>
> This is a conscious decision by the adcli team
>
> https://bugs.freedesktop.org/show_bug.cgi?id=84749
>

I don't see any explicit decision by them to use only lower-case. Just
statements that AD accepts case-insensitive inputs so they don't care to
do anything special.


Case insensitivity is a Microsoft custom extension. It cannot be relied
on in non-MS software :
"
Service Principal Names (SPNs) are not case sensitive when used by
Microsoft Windows-based computers. However, an SPN can be used by any
type of computer system. Many of these computer systems, especially
UNIX-based systems, are case-sensitive and require the proper case to
function properly. Care should be taken to use the proper case
particularly when an SPN can be used by a non-Windows-based computer.

Refer this: http://technet.microsoft.com/en-us/library/cc731241(WS.10).aspx
"


Squid also does not parse these details itself. The library being used
by the helper is responsible for all processing of the local machines
keytab. Squid only parses a token of opaque bytes from HTTP message
headers and passes it as opaque string it to the auth helpers. Our
Kerberos helpers use several libraries, and the one which you are using
apparently has case sensitivity for the SPN.



On the technical side:

Kerberos documents just defer to the protocols where the elements of SPN
are sourced. So some segments in the SPN are case sensitive and others
are not, depending on what type of use the SPN is put.
 eg DNS defines hostname as insensitive, so that part is. Some auth
systems define realm as insensitive, others as case-sensitive - so that
part *might be* (or not. ouch!).


FWIW, following that deferrance style - the HTTP protocol defines its
protocol name as case-sensitive and has a significant difference between
"HTTP" (transport / messaging syntax) and "http" (URL scheme/syntax,
possibly used over non-HTTP transports).

So technically / in theory:
 * if the SPN is for access to HTTP transport (as Squid SPN are)
   - then the "HTTP/" portion should be upper case only.

 * if the SPN is for use of http:// resource URLs (eg, as opposed to
ftp:// URLs fetched with HTTP)
 - it can be any case.


Squid does not go to that second URL-specific level of detail with
authentication and SPNs. Also, since one is required upper case, and the
other doesn't matter going upper case would be the best choice for us if
we did normalize rather than handle as opaque strings anyway.


HTH
Amos
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180627/da524aaa/attachment.html>

From squid3 at treenet.co.nz  Wed Jun 27 22:20:51 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 28 Jun 2018 10:20:51 +1200
Subject: [squid-dev] Support lower case http/ spn format for
 realmd/adcli join support.
In-Reply-To: <be402abb-32f4-4dc2-89c5-bf6e2d0e5986@email.android.com>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>
 <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>
 <be402abb-32f4-4dc2-89c5-bf6e2d0e5986@email.android.com>
Message-ID: <b6f1990d-b8ef-5e55-45a0-59ce4cbf64ae@treenet.co.nz>

On 28/06/18 08:24, Mike Surcouf wrote:
> Thanks Amos for your comprehensive reply..  open SSH requires lower case
> host/ and as you say windows doesn't seem to care so they solved it for
> that case but seems that uppercase is the convention for HTTP.
>   Do you have an official reference for HTTP/. As the official uppercase
> format of SPN for http protocol.i will then file a bug on the adcli repo.
> 


If I'm understanding the descriptions right it is
<https://tools.ietf.org/html/rfc4120#section-6.2> .

with the SPN being "realm/principal"

6.1 says realm is case sensitive.

6.2 says principal is case insensitive and syntax may be of several
types, one of those being:

  principal = name '@' host

I am taking an educated guess that since the resulting syntax of those
would look like REALM/SomeName at example.org that is what the SPN string
is based on.



The case of "HTTP" as in transport is RFC 7230. Specifically section 2.6
(<https://tools.ietf.org/html/rfc7230#section-2.6>) where the exact
octets are prescribed:

"
     HTTP-name     = %x48.54.54.50 ; "HTTP", case-sensitive
"

Anything else is non-compliant with HTTP and may contain arbitrary other
errors in both syntax and behaviour - handle at own risk, etc.


Amos

From mikes at surcouf.co.uk  Thu Jun 28 08:27:50 2018
From: mikes at surcouf.co.uk (Mike Surcouf)
Date: Thu, 28 Jun 2018 08:27:50 +0000
Subject: [squid-dev] Support lower case http/ spn format for
 realmd/adcli join support.
In-Reply-To: <b6f1990d-b8ef-5e55-45a0-59ce4cbf64ae@treenet.co.nz>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>
 <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>
 <be402abb-32f4-4dc2-89c5-bf6e2d0e5986@email.android.com>
 <b6f1990d-b8ef-5e55-45a0-59ce4cbf64ae@treenet.co.nz>
Message-ID: <2197768425D7F5479A0FFB3FEC212F7FF63D1EE1@aesmail.surcouf.local>

Hi Amos thanks for that I need to correct you on the REALM bit though.

The bit before the slash in an SPN (service principal name) is SERVICE not REALM

So for a computer that has a 
service =service
fqdn= SomeComputer.example.com
REALM= EXAMPLE.COM

service/SomeComputer.example.com at EXAMPLE.COM

So for a computer that has a 
service =HTTP
fqdn= SomeComputer.example.com
REALM= EXAMPLE.COM

HTTP/SomeComputer.example.com at EXAMPLE.COM

From mikes at surcouf.co.uk  Thu Jun 28 15:02:17 2018
From: mikes at surcouf.co.uk (Mike Surcouf)
Date: Thu, 28 Jun 2018 15:02:17 +0000
Subject: [squid-dev] Support lower case http/ spn format for
 realmd/adcli join support.
In-Reply-To: <2197768425D7F5479A0FFB3FEC212F7FF63D1EE1@aesmail.surcouf.local>
References: <2197768425D7F5479A0FFB3FEC212F7FF63CD1F3@aesmail.surcouf.local>
 <2197768425D7F5479A0FFB3FEC212F7FF63CD5C4@aesmail.surcouf.local>
 <066f7e42-2a7b-da6e-cab7-ca5ae4abb881@treenet.co.nz>
 <be402abb-32f4-4dc2-89c5-bf6e2d0e5986@email.android.com>
 <b6f1990d-b8ef-5e55-45a0-59ce4cbf64ae@treenet.co.nz>
 <2197768425D7F5479A0FFB3FEC212F7FF63D1EE1@aesmail.surcouf.local>
Message-ID: <2197768425D7F5479A0FFB3FEC212F7FF63D28C5@aesmail.surcouf.local>

Adding to this after testing more I realised that adcli does not lower case the SPN. 
I am not sure how I came to that conclusion sorry for noise.

-----Original Message-----
From: squid-dev [mailto:squid-dev-bounces at lists.squid-cache.org] On Behalf Of Mike Surcouf
Sent: 28 June 2018 09:28
To: 'Amos Jeffries'
Cc: squid-dev at lists.squid-cache.org
Subject: Re: [squid-dev] Support lower case http/ spn format for realmd/adcli join support.

Hi Amos thanks for that I need to correct you on the REALM bit though.

The bit before the slash in an SPN (service principal name) is SERVICE not REALM

So for a computer that has a 
service =service
fqdn= SomeComputer.example.com
REALM= EXAMPLE.COM

service/SomeComputer.example.com at EXAMPLE.COM

So for a computer that has a 
service =HTTP
fqdn= SomeComputer.example.com
REALM= EXAMPLE.COM

HTTP/SomeComputer.example.com at EXAMPLE.COM
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev

