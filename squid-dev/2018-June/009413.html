<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] PROXY protocol and TPROXY, can they go together?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20PROXY%20protocol%20and%20TPROXY%2C%20can%20they%20go%20together%3F&In-Reply-To=%3Cc44eca00eddf6241ebf8b0a33a0e9919%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009411.html">
   <LINK REL="Next"  HREF="009414.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] PROXY protocol and TPROXY, can they go together?</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20PROXY%20protocol%20and%20TPROXY%2C%20can%20they%20go%20together%3F&In-Reply-To=%3Cc44eca00eddf6241ebf8b0a33a0e9919%40ngtech.co.il%3E"
       TITLE="[squid-dev] PROXY protocol and TPROXY, can they go together?">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Jun 22 10:25:23 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009411.html">[squid-dev] Squid test-suite / benchmarks
</A></li>
        <LI>Next message: <A HREF="009414.html">[squid-dev] Block users dynamically
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9413">[ date ]</a>
              <a href="thread.html#9413">[ thread ]</a>
              <a href="subject.html#9413">[ subject ]</a>
              <a href="author.html#9413">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Amos,

The custom LB is to only try and filter before the connections reach's 
squid http and non-http traffic.
Currently I have a prototype which intercepts using TPROXY by itself and 
identifies couple protocols.

The reason for this LB is that I get a more flexible way around the 
connection.
My code can enforce specific ACL's based on specific characteristics of 
the client and\or the server.

Iptables does it's work fine but lacks the ability to dynamically handle 
and identify specific traffic.
For example the nDPI iptables module:
- <A HREF="https://github.com/vel21ripn/nDPI">https://github.com/vel21ripn/nDPI</A>

which is being used in couple products and a similar module also exists 
on many commercial products but still lacks some degree of flexibility.
The kernel land is indeed fast and maybe efficient but is binding the 
programmers to C and it's libraries and compilers let alone licenses.

Currently on a 40+ cores machine with 128GB ram I can run a full blown 
layer 7 proxy for a big network(/16+) and the CPU is almost always 
loaded below 10%.

I do not intent to develop my proxy too much since others have done this 
already but it's nice to see that more products can enter the market 
easily.

Thanks,
Eliezer


On 2018-05-15 22:36, Amos Jeffries wrote:
&gt;<i> On 16/05/18 02:09, Eliezer Croitoru wrote:
</I>&gt;&gt;<i> Hey Squid-Dev,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I am in the middle of writing a load balancer \ router (almost done) 
</I>&gt;&gt;<i> for
</I>&gt;&gt;<i> squid with TPROXY in it.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The load balancer sits on the Squid machine and intercepts the 
</I>&gt;&gt;<i> connections.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I want to send Squid instances a new connection on a PROXY protocol
</I>&gt;&gt;<i> enabled http_port but that squid will use TPROXY on the outgoing
</I>&gt;&gt;<i> connection based on the PROXY protocol details.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Would it be possible? I think it should but not sure.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Maybe. Since both software are on the same machine it should get past
</I>&gt;<i> the kernel protections against arbitrary spoofing.
</I>&gt;<i> 
</I>&gt;<i> You will have to check that BOTH dst-IP:port and src-IP:port pairs are
</I>&gt;<i> correctly relayed by the PROXY protocol. If not the TPROXY will end up
</I>&gt;<i> with mangled socket state and undefined behaviour (probably breakage).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> My plan is to try and load balance connections between multiple squid
</I>&gt;&gt;<i> instances\workers for filtering purposes and PIN each of the instances
</I>&gt;&gt;<i> to a CPU (20+ cores Physical host).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> How reasonable is this idea?
</I>&gt;<i> 
</I>&gt;<i> You don't need a custom LB. iptables is sufficient, or other firewalls
</I>&gt;<i> if you have a non-Linux machine.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend#Frontend_Balancer_Alternative_1:_iptables">https://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend#Frontend_Balancer_Alternative_1:_iptables</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> You should be able to fit those LB lines into a normal TPROXY config.
</I>&gt;<i> Just replace the &quot;-j REDIRECT&quot; with the &quot;-j TPROXY --tproxy-mark ...&quot;.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>
-- 
----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">eliezer at ngtech.co.il</A>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009411.html">[squid-dev] Squid test-suite / benchmarks
</A></li>
	<LI>Next message: <A HREF="009414.html">[squid-dev] Block users dynamically
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9413">[ date ]</a>
              <a href="thread.html#9413">[ thread ]</a>
              <a href="subject.html#9413">[ subject ]</a>
              <a href="author.html#9413">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
