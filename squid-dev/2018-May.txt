From squid3 at treenet.co.nz  Wed May  9 11:05:08 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 9 May 2018 23:05:08 +1200
Subject: [squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
Message-ID: <b271f3ca-6f73-0e05-5124-b1f73959cba1@treenet.co.nz>

Proposed changes to this helper to fix strcat / strncat buffer overread
/ overflow issues.

The approach takes three parts:

* adds a makeHexString function to replace many for-loops catenating
bits of strings together with hex conversion into a second buffer.
Replacing with a snprintf() and buffer overflow handling.

* a copy of Ip::Address::lookupHostIp to convert the input string into
IP address binary format, then generate the hex string using the above
new hex function instead of looped sub-string concatenations across
several buffers.
 This removes all the "00" and "0000" strncat() calls and allows far
simpler code even with added buffer overflow handling.

* replace multiple string part concatenations with a few simpler calls
to snprintf() for all the search_ip buffer constructions. Adding buffer
overflow handling as needed for the new calls.


Amos
-------------- next part --------------
A non-text attachment was scrubbed...
Name: eDirectory_gcc8_mk2.patch
Type: text/x-patch
Size: 19953 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180509/0e2de4f4/attachment.bin>

From rousskov at measurement-factory.com  Wed May  9 14:42:21 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 9 May 2018 08:42:21 -0600
Subject: [squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
In-Reply-To: <b271f3ca-6f73-0e05-5124-b1f73959cba1@treenet.co.nz>
References: <b271f3ca-6f73-0e05-5124-b1f73959cba1@treenet.co.nz>
Message-ID: <2156ec89-8396-5752-7e56-00800805ffe3@measurement-factory.com>

On 05/09/2018 05:05 AM, Amos Jeffries wrote:
> Proposed changes to this helper to fix strcat / strncat buffer overread
> / overflow issues.

I have no objections overall.

* I am not excited about duplicating Ip::Address pieces, but such
duplication cannot be prohibited while we do not allow Ip::Address into
helpers.

* I am not excited about using so much error-prone low-level code
instead of safer/modern approaches, but that is not enough to block
these fixes, especially since they are confined to a helper.


I cannot validate low-level code changes, but I did spot a few potential
problems:


> +        if (strlen(dn) > sizeof(l->dn))
> +            return LDAP_ERR_OOB; /* DN too large */

If l->dn will be 0-terminated, then the condition should be ">=".


> +    memset(&want, 0, sizeof(struct addrinfo));

Using sizeof(want) is safer in such contexts.

makeHexString() is very dangerous because it does not really check for
bufb overflows despite (misleadingly) implying otherwise. It should be
given two size-related parameters (e.g., lena and sizeb) so that it can
be implemented safely.

makeHexString() assumes that bufb buffer is 0-terminated. It should at
least document that fact. It should also document that it _appends_ to
bufb (rather than naturally copying the answer into the provided
buffer). I suggest renaming this function into appendAsHex().


> +    struct addrinfo *dst = nullptr;
> +    if (makeIpBinary(dst, ip)) {
...
>      }
>  
> +    freeaddrinfo(dst);

makeIpBinary() API is not documented, but, AFAICT, freeing should be
moved inside the above if-statement. You may also want to check whether
dst is nil there. Given the current usage, I would change makeIpBinary()
to take a single parameter and return a pointer instead.


Many variables can (and, hence, should) be "const". Some should be
eliminated completely (e.g., "err").


HTH,

Alex.

From squid3 at treenet.co.nz  Sat May 12 03:03:28 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 12 May 2018 15:03:28 +1200
Subject: [squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
In-Reply-To: <2156ec89-8396-5752-7e56-00800805ffe3@measurement-factory.com>
References: <b271f3ca-6f73-0e05-5124-b1f73959cba1@treenet.co.nz>
 <2156ec89-8396-5752-7e56-00800805ffe3@measurement-factory.com>
Message-ID: <c0329ca8-9307-4577-6c00-461220a0e21b@treenet.co.nz>

Opened PR 204 with the below changes...

On 10/05/18 02:42, Alex Rousskov wrote:
> On 05/09/2018 05:05 AM, Amos Jeffries wrote:
>> Proposed changes to this helper to fix strcat / strncat buffer overread
>> / overflow issues.
> 
> I have no objections overall.
> 
> * I am not excited about duplicating Ip::Address pieces, but such
> duplication cannot be prohibited while we do not allow Ip::Address into
> helpers.
> 
> * I am not excited about using so much error-prone low-level code
> instead of safer/modern approaches, but that is not enough to block
> these fixes, especially since they are confined to a helper.
> 
> 
> I cannot validate low-level code changes, but I did spot a few potential
> problems:
> 
> 
>> +        if (strlen(dn) > sizeof(l->dn))
>> +            return LDAP_ERR_OOB; /* DN too large */
> 
> If l->dn will be 0-terminated, then the condition should be ">=".
> 
> 
>> +    memset(&want, 0, sizeof(struct addrinfo));
> 
> Using sizeof(want) is safer in such contexts.

done.

> 
> makeHexString() is very dangerous because it does not really check for
> bufb overflows despite (misleadingly) implying otherwise. It should be
> given two size-related parameters (e.g., lena and sizeb) so that it can
> be implemented safely.

Added the missing checks.

> 
> makeHexString() assumes that bufb buffer is 0-terminated. It should at
> least document that fact. It should also document that it _appends_ to
> bufb (rather than naturally copying the answer into the provided
> buffer). I suggest renaming this function into appendAsHex().
> 

Changed the internals instead. This was not supposed to be an append
action and no callers use it that way. So it now begins by setting the
first char of bufb to null and works from there.

> 
>> +    struct addrinfo *dst = nullptr;
>> +    if (makeIpBinary(dst, ip)) {
> ...
>>      }
>>  
>> +    freeaddrinfo(dst);
> 
> makeIpBinary() API is not documented, but, AFAICT, freeing should be
> moved inside the above if-statement. You may also want to check whether
> dst is nil there. Given the current usage, I would change makeIpBinary()
> to take a single parameter and return a pointer instead.
> 

Done as suggested.

> 
> Many variables can (and, hence, should) be "const". Some should be
> eliminated completely (e.g., "err").
> 

Um, I'm not seeing any that are being changed by this patch and not
already const. err is now gone.

Amos

From eliezer at ngtech.co.il  Tue May 15 14:09:52 2018
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Tue, 15 May 2018 17:09:52 +0300
Subject: [squid-dev] PROXY protocol and TPROXY, can they go together?
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAGDVRrtF13VDjYYZR9MgvgYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAze1iQlI01RJfm+FO2rm9bAQAAAAA=@ngtech.co.il>

Hey Squid-Dev,

 

I am in the middle of writing a load balancer \ router (almost done) for
squid with TPROXY in it.

The load balancer sits on the Squid machine and intercepts the connections.

I want to send Squid instances a new connection on a PROXY protocol enabled
http_port but that squid will use TPROXY on the outgoing connection based on
the PROXY protocol details.

 

Would it be possible? I think it should but not sure.

 

My plan is to try and load balance connections between multiple squid
instances\workers for filtering purposes and PIN each of the instances to a
CPU (20+ cores Physical host).

How reasonable is this idea?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru <http://ngtech.co.il/lmgtfy/> 
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180515/c02f513b/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.png
Type: image/png
Size: 11308 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180515/c02f513b/attachment.png>

From squid3 at treenet.co.nz  Tue May 15 19:36:53 2018
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 16 May 2018 07:36:53 +1200
Subject: [squid-dev] PROXY protocol and TPROXY, can they go together?
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAGDVRrtF13VDjYYZR9MgvgYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAze1iQlI01RJfm+FO2rm9bAQAAAAA=@ngtech.co.il>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGDVRrtF13VDjYYZR9MgvgYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAze1iQlI01RJfm+FO2rm9bAQAAAAA=@ngtech.co.il>
Message-ID: <33a8b0dc-359a-3e01-42fe-dad0e4d5f392@treenet.co.nz>

On 16/05/18 02:09, Eliezer Croitoru wrote:
> Hey Squid-Dev,
> 
> I am in the middle of writing a load balancer \ router (almost done) for
> squid with TPROXY in it.
> 
> The load balancer sits on the Squid machine and intercepts the connections.
> 
> I want to send Squid instances a new connection on a PROXY protocol
> enabled http_port but that squid will use TPROXY on the outgoing
> connection based on the PROXY protocol details.
> 
>  
> 
> Would it be possible? I think it should but not sure.
> 

Maybe. Since both software are on the same machine it should get past
the kernel protections against arbitrary spoofing.

You will have to check that BOTH dst-IP:port and src-IP:port pairs are
correctly relayed by the PROXY protocol. If not the TPROXY will end up
with mangled socket state and undefined behaviour (probably breakage).


>  
> 
> My plan is to try and load balance connections between multiple squid
> instances\workers for filtering purposes and PIN each of the instances
> to a CPU (20+ cores Physical host).
> 
> How reasonable is this idea?

You don't need a custom LB. iptables is sufficient, or other firewalls
if you have a non-Linux machine.

 <https://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend#Frontend_Balancer_Alternative_1:_iptables>

You should be able to fit those LB lines into a normal TPROXY config.
Just replace the "-j REDIRECT" with the "-j TPROXY --tproxy-mark ...".

Amos

From d.martin at estudiantes.matcom.uh.cu  Mon May 28 18:10:46 2018
From: d.martin at estudiantes.matcom.uh.cu (dean)
Date: Mon, 28 May 2018 14:10:46 -0400
Subject: [squid-dev] Block users dynamically
Message-ID: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>

I am implementing modifications to Squid 3.5.27 for a thesis job. At 
some point in the code, I need to block a user. What I'm doing is 
writing to an external file that is used in the configuration, like 
Squish does. But it does not block the user, however when I reconfigure 
Squid if it blocks it. Is there something I do not know? When I change 
the file, should I reconfigure Squid? Is there another way to block 
users dynamically from the Squid code?


From rousskov at measurement-factory.com  Tue May 29 20:56:24 2018
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 29 May 2018 14:56:24 -0600
Subject: [squid-dev] Block users dynamically
In-Reply-To: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
References: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
Message-ID: <c4966411-d3d7-9036-4761-f2b08bcbfe4e@measurement-factory.com>

On 05/28/2018 12:10 PM, dean wrote:

> What I'm doing is
> writing to an external file that is used in the configuration, like
> Squish does. But it does not block the user,

The lack of Squid reaction is expected -- Squid does not monitor
configuration files for changes.


> When I change the file, should I reconfigure Squid? 

Yes, if you want Squid to know about configuration changes, you have to
reconfigure (or restart) Squid after making those changes.


> Is there another way to block
> users dynamically from the Squid code?

Yes, of course. Nearly all existing Squid blocking decisions are done
"dynamically" (for some definition of "dynamic"), and you can add more
code that blocks users. There are many examples in the code, including

    git grep -10E 'Config.accessList.(http|reply)'

FWIW, in most cases, adding an external ACL helper or adding a new ACL
type is better than hard-coding your blocking logic into Squid.


HTH,

Alex.

From marcus.kool at urlfilterdb.com  Wed May 30 00:56:58 2018
From: marcus.kool at urlfilterdb.com (Marcus Kool)
Date: Tue, 29 May 2018 21:56:58 -0300
Subject: [squid-dev] Block users dynamically
In-Reply-To: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
References: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
Message-ID: <426b96c9-e209-170f-0b96-251a39fed27d@urlfilterdb.com>


On 28/05/18 15:10, dean wrote:
> I am implementing modifications to Squid 3.5.27 for a thesis job. At some point in the code, I need to block a user. What I'm doing is writing to an external file that is used in the configuration, 
> like Squish does. But it does not block the user, however when I reconfigure Squid if it blocks it. Is there something I do not know? When I change the file, should I reconfigure Squid? Is there 
> another way to block users dynamically from the Squid code?

You can use ufdbGuard for this purpose.  ufdbGuard is a free URL redirector for Squid which can be configured to read lists of usernames or list of IP addresses every X minutes (default for X is 15).
So if you control a blacklist with usernames and write the name of the user to a defined file, ufdbguardd will block these users.
If the user must be blocked immediately you need to reload ufdbguardd, otherwise you wait until the configured time interval to reread the userlist expires and so after a few minutes the user gets 
blocked.

Note that reloading ufdbguardd does not interfere with Squid and all activity by browsers and squid continues normally.

Marcus


From marcus.kool at urlfilterdb.com  Wed May 30 12:01:41 2018
From: marcus.kool at urlfilterdb.com (Marcus Kool)
Date: Wed, 30 May 2018 09:01:41 -0300
Subject: [squid-dev] Block users dynamically
In-Reply-To: <CAAqh3JL2cjJ-2Er-guQYuK5bUH6cx51=myvzQ5CF1JK7j-_shA@mail.gmail.com>
References: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
 <426b96c9-e209-170f-0b96-251a39fed27d@urlfilterdb.com>
 <CAAqh3JL2cjJ-2Er-guQYuK5bUH6cx51=myvzQ5CF1JK7j-_shA@mail.gmail.com>
Message-ID: <90c785d8-3356-bfeb-f3a6-5dfea3fee9bd@urlfilterdb.com>



On 30/05/18 08:55, Daniel Berredo wrote:
> Have you ever considered using an external ACL helper?

eh, for what ?

> On Tue, May 29, 2018, 9:57 PM Marcus Kool <marcus.kool at urlfilterdb.com <mailto:marcus.kool at urlfilterdb.com>> wrote:
> 
> 
>     On 28/05/18 15:10, dean wrote:
>      > I am implementing modifications to Squid 3.5.27 for a thesis job. At some point in the code, I need to block a user. What I'm doing is writing to an external file that is used in the
>     configuration,
>      > like Squish does. But it does not block the user, however when I reconfigure Squid if it blocks it. Is there something I do not know? When I change the file, should I reconfigure Squid? Is there
>      > another way to block users dynamically from the Squid code?
> 
>     You can use ufdbGuard for this purpose.  ufdbGuard is a free URL redirector for Squid which can be configured to read lists of usernames or list of IP addresses every X minutes (default for X is 15).
>     So if you control a blacklist with usernames and write the name of the user to a defined file, ufdbguardd will block these users.
>     If the user must be blocked immediately you need to reload ufdbguardd, otherwise you wait until the configured time interval to reread the userlist expires and so after a few minutes the user gets
>     blocked.
> 
>     Note that reloading ufdbguardd does not interfere with Squid and all activity by browsers and squid continues normally.
> 
>     Marcus
> 
>     _______________________________________________
>     squid-dev mailing list
>     squid-dev at lists.squid-cache.org <mailto:squid-dev at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-dev
> 

From vovohelo at gmail.com  Wed May 30 11:55:00 2018
From: vovohelo at gmail.com (Daniel Berredo)
Date: Wed, 30 May 2018 08:55:00 -0300
Subject: [squid-dev] Block users dynamically
In-Reply-To: <426b96c9-e209-170f-0b96-251a39fed27d@urlfilterdb.com>
References: <e32e7af2-e674-36b9-ab13-9164ddf26ad5@estudiantes.matcom.uh.cu>
 <426b96c9-e209-170f-0b96-251a39fed27d@urlfilterdb.com>
Message-ID: <CAAqh3JL2cjJ-2Er-guQYuK5bUH6cx51=myvzQ5CF1JK7j-_shA@mail.gmail.com>

Have you ever considered using an external ACL helper?

On Tue, May 29, 2018, 9:57 PM Marcus Kool <marcus.kool at urlfilterdb.com>
wrote:

>
> On 28/05/18 15:10, dean wrote:
> > I am implementing modifications to Squid 3.5.27 for a thesis job. At
> some point in the code, I need to block a user. What I'm doing is writing
> to an external file that is used in the configuration,
> > like Squish does. But it does not block the user, however when I
> reconfigure Squid if it blocks it. Is there something I do not know? When I
> change the file, should I reconfigure Squid? Is there
> > another way to block users dynamically from the Squid code?
>
> You can use ufdbGuard for this purpose.  ufdbGuard is a free URL
> redirector for Squid which can be configured to read lists of usernames or
> list of IP addresses every X minutes (default for X is 15).
> So if you control a blacklist with usernames and write the name of the
> user to a defined file, ufdbguardd will block these users.
> If the user must be blocked immediately you need to reload ufdbguardd,
> otherwise you wait until the configured time interval to reread the
> userlist expires and so after a few minutes the user gets
> blocked.
>
> Note that reloading ufdbguardd does not interfere with Squid and all
> activity by browsers and squid continues normally.
>
> Marcus
>
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20180530/1b945196/attachment.html>

