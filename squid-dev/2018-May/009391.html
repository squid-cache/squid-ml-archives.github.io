<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20ext_edirectory_userip_acl%20refactoring&In-Reply-To=%3C2156ec89-8396-5752-7e56-00800805ffe3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009390.html">
   <LINK REL="Next"  HREF="009392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20ext_edirectory_userip_acl%20refactoring&In-Reply-To=%3C2156ec89-8396-5752-7e56-00800805ffe3%40measurement-factory.com%3E"
       TITLE="[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May  9 14:42:21 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009390.html">[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
</A></li>
        <LI>Next message: <A HREF="009392.html">[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9391">[ date ]</a>
              <a href="thread.html#9391">[ thread ]</a>
              <a href="subject.html#9391">[ subject ]</a>
              <a href="author.html#9391">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/09/2018 05:05 AM, Amos Jeffries wrote:
&gt;<i> Proposed changes to this helper to fix strcat / strncat buffer overread
</I>&gt;<i> / overflow issues.
</I>
I have no objections overall.

* I am not excited about duplicating Ip::Address pieces, but such
duplication cannot be prohibited while we do not allow Ip::Address into
helpers.

* I am not excited about using so much error-prone low-level code
instead of safer/modern approaches, but that is not enough to block
these fixes, especially since they are confined to a helper.


I cannot validate low-level code changes, but I did spot a few potential
problems:


&gt;<i> +        if (strlen(dn) &gt; sizeof(l-&gt;dn))
</I>&gt;<i> +            return LDAP_ERR_OOB; /* DN too large */
</I>
If l-&gt;dn will be 0-terminated, then the condition should be &quot;&gt;=&quot;.


&gt;<i> +    memset(&amp;want, 0, sizeof(struct addrinfo));
</I>
Using sizeof(want) is safer in such contexts.

makeHexString() is very dangerous because it does not really check for
bufb overflows despite (misleadingly) implying otherwise. It should be
given two size-related parameters (e.g., lena and sizeb) so that it can
be implemented safely.

makeHexString() assumes that bufb buffer is 0-terminated. It should at
least document that fact. It should also document that it _appends_ to
bufb (rather than naturally copying the answer into the provided
buffer). I suggest renaming this function into appendAsHex().


&gt;<i> +    struct addrinfo *dst = nullptr;
</I>&gt;<i> +    if (makeIpBinary(dst, ip)) {
</I>...
&gt;<i>      }
</I>&gt;<i>  
</I>&gt;<i> +    freeaddrinfo(dst);
</I>
makeIpBinary() API is not documented, but, AFAICT, freeing should be
moved inside the above if-statement. You may also want to check whether
dst is nil there. Given the current usage, I would change makeIpBinary()
to take a single parameter and return a pointer instead.


Many variables can (and, hence, should) be &quot;const&quot;. Some should be
eliminated completely (e.g., &quot;err&quot;).


HTH,

Alex.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009390.html">[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
</A></li>
	<LI>Next message: <A HREF="009392.html">[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9391">[ date ]</a>
              <a href="thread.html#9391">[ thread ]</a>
              <a href="subject.html#9391">[ subject ]</a>
              <a href="author.html#9391">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
