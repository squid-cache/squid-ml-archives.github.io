<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20ext_edirectory_userip_acl%20refactoring&In-Reply-To=%3Cc0329ca8-9307-4577-6c00-461220a0e21b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009391.html">
   <LINK REL="Next"  HREF="009393.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20%5BPATCH%5D%20ext_edirectory_userip_acl%20refactoring&In-Reply-To=%3Cc0329ca8-9307-4577-6c00-461220a0e21b%40treenet.co.nz%3E"
       TITLE="[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat May 12 03:03:28 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009391.html">[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
</A></li>
        <LI>Next message: <A HREF="009393.html">[squid-dev] PROXY protocol and TPROXY, can they go together?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9392">[ date ]</a>
              <a href="thread.html#9392">[ thread ]</a>
              <a href="subject.html#9392">[ subject ]</a>
              <a href="author.html#9392">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Opened PR 204 with the below changes...

On 10/05/18 02:42, Alex Rousskov wrote:
&gt;<i> On 05/09/2018 05:05 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> Proposed changes to this helper to fix strcat / strncat buffer overread
</I>&gt;&gt;<i> / overflow issues.
</I>&gt;<i> 
</I>&gt;<i> I have no objections overall.
</I>&gt;<i> 
</I>&gt;<i> * I am not excited about duplicating Ip::Address pieces, but such
</I>&gt;<i> duplication cannot be prohibited while we do not allow Ip::Address into
</I>&gt;<i> helpers.
</I>&gt;<i> 
</I>&gt;<i> * I am not excited about using so much error-prone low-level code
</I>&gt;<i> instead of safer/modern approaches, but that is not enough to block
</I>&gt;<i> these fixes, especially since they are confined to a helper.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I cannot validate low-level code changes, but I did spot a few potential
</I>&gt;<i> problems:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> +        if (strlen(dn) &gt; sizeof(l-&gt;dn))
</I>&gt;&gt;<i> +            return LDAP_ERR_OOB; /* DN too large */
</I>&gt;<i> 
</I>&gt;<i> If l-&gt;dn will be 0-terminated, then the condition should be &quot;&gt;=&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> +    memset(&amp;want, 0, sizeof(struct addrinfo));
</I>&gt;<i> 
</I>&gt;<i> Using sizeof(want) is safer in such contexts.
</I>
done.

&gt;<i> 
</I>&gt;<i> makeHexString() is very dangerous because it does not really check for
</I>&gt;<i> bufb overflows despite (misleadingly) implying otherwise. It should be
</I>&gt;<i> given two size-related parameters (e.g., lena and sizeb) so that it can
</I>&gt;<i> be implemented safely.
</I>
Added the missing checks.

&gt;<i> 
</I>&gt;<i> makeHexString() assumes that bufb buffer is 0-terminated. It should at
</I>&gt;<i> least document that fact. It should also document that it _appends_ to
</I>&gt;<i> bufb (rather than naturally copying the answer into the provided
</I>&gt;<i> buffer). I suggest renaming this function into appendAsHex().
</I>&gt;<i> 
</I>
Changed the internals instead. This was not supposed to be an append
action and no callers use it that way. So it now begins by setting the
first char of bufb to null and works from there.

&gt;<i> 
</I>&gt;&gt;<i> +    struct addrinfo *dst = nullptr;
</I>&gt;&gt;<i> +    if (makeIpBinary(dst, ip)) {
</I>&gt;<i> ...
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> +    freeaddrinfo(dst);
</I>&gt;<i> 
</I>&gt;<i> makeIpBinary() API is not documented, but, AFAICT, freeing should be
</I>&gt;<i> moved inside the above if-statement. You may also want to check whether
</I>&gt;<i> dst is nil there. Given the current usage, I would change makeIpBinary()
</I>&gt;<i> to take a single parameter and return a pointer instead.
</I>&gt;<i> 
</I>
Done as suggested.

&gt;<i> 
</I>&gt;<i> Many variables can (and, hence, should) be &quot;const&quot;. Some should be
</I>&gt;<i> eliminated completely (e.g., &quot;err&quot;).
</I>&gt;<i> 
</I>
Um, I'm not seeing any that are being changed by this patch and not
already const. err is now gone.

Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009391.html">[squid-dev] [PATCH] ext_edirectory_userip_acl refactoring
</A></li>
	<LI>Next message: <A HREF="009393.html">[squid-dev] PROXY protocol and TPROXY, can they go together?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9392">[ date ]</a>
              <a href="thread.html#9392">[ thread ]</a>
              <a href="subject.html#9392">[ subject ]</a>
              <a href="author.html#9392">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
