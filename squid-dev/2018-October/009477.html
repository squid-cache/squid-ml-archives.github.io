<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Incremental parsing of chunked quoted extensions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Incremental%20parsing%20of%20chunked%20quoted%20extensions&In-Reply-To=%3C0fd0b5d2-9ed0-bba0-b72c-95af9ee06f76%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009476.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Incremental parsing of chunked quoted extensions</H1>
    <B>Eduard Bagdasaryan</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Incremental%20parsing%20of%20chunked%20quoted%20extensions&In-Reply-To=%3C0fd0b5d2-9ed0-bba0-b72c-95af9ee06f76%40measurement-factory.com%3E"
       TITLE="[squid-dev] Incremental parsing of chunked quoted extensions">eduard.bagdasaryan at measurement-factory.com
       </A><BR>
    <I>Tue Oct 16 11:49:23 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="009476.html">[squid-dev] Incremental parsing of chunked quoted extensions
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9477">[ date ]</a>
              <a href="thread.html#9477">[ thread ]</a>
              <a href="subject.html#9477">[ subject ]</a>
              <a href="author.html#9477">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Since there have not been any objections so far, I am going
to start implementing the incremental parsing approach,
outlined here.


Eduard.

On 05.10.2018 18:34, Alex Rousskov wrote:
&gt;<i> I doubt that writing code to explicitly buffer the whole line before
</I>&gt;<i> parsing extensions is necessary. It is definitely not desirable because
</I>&gt;<i> it slows things down in_common_  cases. I would adjust the code to
</I>&gt;<i> follow this sketch instead:
</I>&gt;<i>
</I>&gt;<i>      while (!atEof()) {
</I>&gt;<i>          if (skipLineTerminator())
</I>&gt;<i>              return true; // reached the end of extensions (if any)
</I>&gt;<i>          if (parseChunkExtension())
</I>&gt;<i>              continue; // got one extension; there may be more
</I>&gt;<i>          if (tok.skipAll(NotLF) &amp;&amp; skip(LF))
</I>&gt;<i>              throw &quot;cannot parse chunk extension&quot;; // &lt;garbage&gt; CR*LF
</I>&gt;<i>          return false; // need more data to finish parsing extension
</I>&gt;<i>      }
</I>&gt;<i>      return false; // need data to start parsing extension or CRLF
</I>&gt;<i>
</I>&gt;<i> where skipLineTerminator() is, essentially,
</I>&gt;<i>
</I>&gt;<i>      return tok.skip(CRLF)) || (relaxed_parser &amp;&amp; tok.skipOne(LF));
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As you can see, the above sketch is optimized for the common cases and
</I>&gt;<i> blindly seeks to the end of the line only in rare cases of partially
</I>&gt;<i> received or malformed extensions.
</I>&gt;<i>
</I>&gt;<i> Please note that whether the above sketch is used incrementally is an
</I>&gt;<i> _orthogonal_  question:
</I>&gt;<i>
</I>&gt;<i> * In incremental parsing, a successful parseChunkExtension() would
</I>&gt;<i> update object state to remember the parsed extension and advance the
</I>&gt;<i> parsing position to never come back to the same spot. The loop caller
</I>&gt;<i> would advance the parsing position/state if (and only if) the loop
</I>&gt;<i> returns true.
</I>&gt;<i>
</I>&gt;<i> * In non-incremental parsing, a successful parseChunkExtension() would
</I>&gt;<i> update its parameter (not shown) to remember the parsed extension. The
</I>&gt;<i> loop caller would update object state (&quot;committing&quot; that not shown
</I>&gt;<i> parameter info) and advance the parsing position if (and only if) the
</I>&gt;<i> loop returns true. [ Alternatively, a successful parseChunkExtension()
</I>&gt;<i> would update object state directly, sometimes overwriting the previous
</I>&gt;<i> (identical) value many times. The current useOriginBody code uses that
</I>&gt;<i> simpler scheme. However, even with this simpler alternative, the
</I>&gt;<i> advancement is controlled by the loop caller. ]
</I>&gt;<i>
</I>&gt;<i> Should we fix and continue to use incremental parsing here or abandon
</I>&gt;<i> it? The answer probably depends on overall code simplicity. Since we
</I>&gt;<i> have to use incremental parsing for parsing chunked encoding as a whole
</I>&gt;<i> (as discussed in the beginning of this email), we may continue to use it
</I>&gt;<i> for parsing extensions if (and only if) doing so does not complicate things.
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009476.html">[squid-dev] Incremental parsing of chunked quoted extensions
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9477">[ date ]</a>
              <a href="thread.html#9477">[ thread ]</a>
              <a href="subject.html#9477">[ subject ]</a>
              <a href="author.html#9477">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
