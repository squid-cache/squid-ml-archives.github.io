From eliezer at ngtech.co.il  Sat Feb  2 19:36:08 2019
From: eliezer at ngtech.co.il (eliezer at ngtech.co.il)
Date: Sat, 2 Feb 2019 21:36:08 +0200
Subject: [squid-dev] Squid-5 status update
In-Reply-To: <e3094579-c62a-8a46-39e5-2a8291e217ae@treenet.co.nz>
References: <e3094579-c62a-8a46-39e5-2a8291e217ae@treenet.co.nz>
Message-ID: <02e401d4bb2e$8bfb77f0$a3f267d0$@ngtech.co.il>

First:
https://www.ietf.org/archive/id/draft-rousskov-icap-trailers-01.txt

Looks very nice.
Second, Le t me know when the beta will be ready and packages will be up and running for testing purposes.
I am still testing 4.5 but it seems like working as expected with all the new refresh_pattern removal of overrides.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il


-----Original Message-----
From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Sunday, January 27, 2019 10:41
To: Squid Developers <squid-dev at lists.squid-cache.org>
Subject: [squid-dev] Squid-5 status update

Hi all,

 So being January and fielding questions about when v5 will be released
I have taken a look at the state of trunk/HEAD/master code to see
whether or not there is enough change to be worth a new Squid series.

Right now things are looking close but not quite enough.


The details I am looking at right now:

 * 8 new functionality features. Either specifically named features
  that have their own release notes section, or a bunch of related
  UI setting changes that add together to be noteworthy.

  see <https://wiki.squid-cache.org/Squid-5> for the list as of today.

 Ideally what I look for is an arbitrary 10 features. So this is close
enough, but also has room to wait for more.


 * approx. 30k LOC unique to master/v5

Historically there have been around 100k per year. v4 was an oddity with
having to wait for compiler support and some major late-added features.

Higher LOC change tends to mean we have made a lot of progress on the
code polishing and features added actually are significant. If we let it
get too high before beta the expected bug count goes up likewise and
beta testing takes a lot longer.
 If the v3 past is a good indicator of future bug finds, then this 30k
LOC would indicate 8-12 months of beta ahead already.


 * the LOC changes appear to be roughly evenly split in this past two
years between v5 changes, v4 fixes.

This is quite a bit higher than previous cycles and a good indicator
that we are not really ready to stop working on those fixes and move on
to testing stability of the new v5 code.


 * ~6 weeks to accumulate changes sufficient to pass the arbitrary
watermark for new packaging to be worthwhile.

Ideally that series would be stable enough that it takes regularly 8
week turnarounds before focus could be switched to a new series.


These last two are the main reasons I have now to delay starting v5
beta. Next look in a few months to see if/how things have changed.

That said we are getting close, so please start considering what
features you want to finish off to get included.


Amos

_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev


From eliezer at ngtech.co.il  Tue Feb  5 11:33:22 2019
From: eliezer at ngtech.co.il (Eliezer Croitoru)
Date: Tue, 5 Feb 2019 13:33:22 +0200
Subject: [squid-dev] Debian buster testing 4.x builds
Message-ID: <004601d4bd46$99e180c0$cda48240$@ngtech.co.il>

I have started Debian buster 4.x testing.

Currently what I came up with is :

/usr/sbin/squid -v

Squid Cache: Version 4.5

Service Name: squid

 

This binary uses OpenSSL 1.1.1a  20 Nov 2018. For legal restrictions on
distribution see https://www.openssl.org/source/license.html

 

configure options:  '--prefix=/usr' '--sysconfdir=/etc'
'--localstatedir=/var' '--datadir=/usr/share/squid'
'--sysconfdir=/etc/squid' '--libexecdir=/usr/lib/squid'
'--mandir=/usr/share/man' '--enable-inline' '--enable-async-io=8'
'--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap'
'--enable-delay-pools' '--enable-cache-digests' '--enable-icap-client'
'--enable-follow-x-forwarded-for'
'--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB
' '--enable-auth-digest=file,LDAP'
'--enable-auth-negotiate=kerberos,wrapper' '--enable-auth-ntlm=fake'
'--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,se
ssion,SQL_session,unix_group,wbinfo_group'
'--enable-url-rewrite-helpers=fake' '--enable-eui' '--enable-esi'
'--enable-icmp' '--enable-zph-qos' '--with-swapdir=/var/spool/squid'
'--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid'
'--with-filedescriptors=65536' '--with-default-user=proxy' '--enable-snmp'
'--with-openssl' '--enable-ssl-crtd' '--disable-arch-native'
'--enable-linux-netfilter'

 

Which seems nice.

 

Should I check it with clang also else then gcc?

 

Eliezer

 

----

 <http://ngtech.co.il/main-en/> Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20190205/81845d43/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.png
Type: image/png
Size: 11310 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20190205/81845d43/attachment.png>

From gkinkie at gmail.com  Tue Feb 12 08:29:16 2019
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Tue, 12 Feb 2019 08:29:16 +0000
Subject: [squid-dev] ARMv7 build nodes
Message-ID: <CA+Y8hcPA_YBi01L7emRH7cuHRdSD1B-zcrzbS-wTsM8U-Wb2fw@mail.gmail.com>

Hi all,
  https://build.squid-cache.org/job/5-matrix-arm/ is our first
ARMv7(32bit) build node - docker/linux/raspberry pi 3.
  Next up, hopefully, FreeBSD on aarch64 (banana pi).

-- 
    Francesco

From eliezer at ngtech.co.il  Fri Feb 22 07:32:03 2019
From: eliezer at ngtech.co.il (eliezer at ngtech.co.il)
Date: Fri, 22 Feb 2019 09:32:03 +0200
Subject: [squid-dev] Where can I see the build nodes status,
	5.x doesn't build for me.
Message-ID: <005901d4ca80$b4c2ffd0$1e48ff70$@ngtech.co.il>

I have tried to build latest 5.0.x tar.bz2 but got into an error ( I
understand it's possible).
Where can I see the matrix build?( I don't have the new urls.)
 
Output snippet:
/src/helper/ChildConfig.cc &&\
mv -f $depbase.Tpo $depbase.Plo
depbase=`echo Reply.lo | sed 's|[^/]*$|.deps/&|;s|\.lo$||'`;\
/bin/sh ../../libtool  --tag=CXX   --mode=compile g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2   -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2   -g -O2 -std=c++11 -MT Reply.lo -MD -MP
-MF $depbase.Tpo -c -o Reply.lo
../../../squid-5.0.0-20190221-re008097c6/src/helper/Reply.cc &&\
mv -f $depbase.Tpo $depbase.Plo
depbase=`echo ReservationId.lo | sed 's|[^/]*$|.deps/&|;s|\.lo$||'`;\
/bin/sh ../../libtool  --tag=CXX   --mode=compile g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2   -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2   -g -O2 -std=c++11 -MT ReservationId.lo
-MD -MP -MF $depbase.Tpo -c -o ReservationId.lo
../../../squid-5.0.0-20190221-re008097c6/src/helper/ReservationId.cc &&\
mv -f $depbase.Tpo $depbase.Plo
libtool: compile:  g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2 -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2 -g -O2 -std=c++11 -MT ChildConfig.lo -MD
-MP -MF .deps/ChildConfig.Tpo -c
../../../squid-5.0.0-20190221-re008097c6/src/helper/ChildConfig.cc  -fPIC
-DPIC -o .libs/ChildConfig.o
libtool: compile:  g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2 -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2 -g -O2 -std=c++11 -MT Reply.lo -MD -MP
-MF .deps/Reply.Tpo -c
../../../squid-5.0.0-20190221-re008097c6/src/helper/Reply.cc  -fPIC -DPIC -o
.libs/Reply.o
libtool: compile:  g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2 -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2 -g -O2 -std=c++11 -MT ReservationId.lo
-MD -MP -MF .deps/ReservationId.Tpo -c
../../../squid-5.0.0-20190221-re008097c6/src/helper/ReservationId.cc  -fPIC
-DPIC -o .libs/ReservationId.o
libtool: compile:  g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2 -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2 -g -O2 -std=c++11 -MT ReservationId.lo
-MD -MP -MF .deps/ReservationId.Tpo -c
../../../squid-5.0.0-20190221-re008097c6/src/helper/ReservationId.cc -o
ReservationId.o >/dev/null 2>&1
In file included from
../../../squid-5.0.0-20190221-re008097c6/src/helper/Reply.cc:14:0:
../../../squid-5.0.0-20190221-re008097c6/src/helper.h:264:13: error: 'map'
in namespace 'std' does not name a type
     typedef std::map<uint64_t, Requests::iterator> RequestIndex;
             ^
../../../squid-5.0.0-20190221-re008097c6/src/helper.h:265:5: error:
'RequestIndex' does not name a type
     RequestIndex requestsIndex; ///< maps request IDs to requests
     ^
libtool: compile:  g++ -DHAVE_CONFIG_H
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\"
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\"
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"
-I../../../squid-5.0.0-20190221-re008097c6
-I../../../squid-5.0.0-20190221-re008097c6/include
-I../../../squid-5.0.0-20190221-re008097c6/lib
-I../../../squid-5.0.0-20190221-re008097c6/src -I../../include
-I/usr/include/libxml2 -Wall -Wpointer-arith -Wwrite-strings -Wcomments
-Wshadow -Woverloaded-virtual -Werror -Wno-deprecated-register -pipe
-D_REENTRANT -I/usr/include/libxml2 -g -O2 -std=c++11 -MT ChildConfig.lo -MD
-MP -MF .deps/ChildConfig.Tpo -c
../../../squid-5.0.0-20190221-re008097c6/src/helper/ChildConfig.cc -o
ChildConfig.o >/dev/null 2>&1
cc1plus: error: unrecognized command line option "-Wno-deprecated-register"
[-Werror]
cc1plus: all warnings being treated as errors
make[5]: *** [Reply.lo] Error 1
make[5]: *** Waiting for unfinished jobs....
make[5]: Leaving directory
`/var/lib/jenkins/workspace/squid5-tar.xz/build/confdir/src/helper'
make[4]: *** [all-recursive] Error 1
make[4]: Leaving directory
`/var/lib/jenkins/workspace/squid5-tar.xz/build/confdir/src'
make[3]: *** [all] Error 2
make[3]: Leaving directory
`/var/lib/jenkins/workspace/squid5-tar.xz/build/confdir/src'
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory
`/var/lib/jenkins/workspace/squid5-tar.xz/build/confdir'
make[1]: *** [build] Error 2
make[1]: Leaving directory `/var/lib/jenkins/workspace/squid5-tar.xz/build'
make: *** [all] Error 2
Build step 'Execute shell' marked build as failure
Finished: FAILURE
Page generated: Feb 22, 2019 9:26:31 AM ISTREST
<http://centos7-x64.squid.build:8080/job/squid5-tar.xz/5/api/> APIJenkins
ver. 2.150.3 <https://jenkins.io/> 
 
 
Thanks,
Eliezer
 
----
 <http://ngtech.co.il/main-en/> Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20190222/f28a12c3/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.png
Type: image/png
Size: 11295 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20190222/f28a12c3/attachment-0001.png>

From rousskov at measurement-factory.com  Fri Feb 22 17:08:16 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 22 Feb 2019 10:08:16 -0700
Subject: [squid-dev] Efficient FD annotations
Message-ID: <a2117aa5-7413-415f-6370-e221ffae9082@measurement-factory.com>

In https://github.com/squid-cache/squid/pull/270#discussion_r259316609


> In src/comm.cc:
> 
>> @@ -424,7 +424,7 @@ comm_init_opened(const Comm::ConnectionPointer &conn,
>      debugs(5, 5, HERE << conn << " is a new socket");
>  
>      assert(!isOpen(conn->fd));
> -    fd_open(conn->fd, FD_SOCKET, note);
> +    fd_open(conn->fd, FD_SOCKET, SBuf(note));


> Alex: I do not think we should introduce this performance regression
> on a common code path. Better debugging/reporting is just not worth
> it. I have ideas on how this regression can be avoided (and debugging
> improved), but I do not want to waste time detailing and discussing
> them if you do not want to spend a lot more time on this PR.


> Amos: Since this PR is about fixing the compile error I don't want to
> complicate it any further. But do want to hear these ideas. Can you
> post them to squid-dev so we can go over it separately please.


IMO, the best way to annotate file descriptors (and other objects) for
debugging/reporting purposes is to store pointers to their current
owners and/or objects currently responsible for FD processing. Very
roughly speaking:

class fde
{
  ...

  /* current FD handling context */

  /// Comm::Connection this FD belongs to
  WeakConnectionPointer connection;

  /// Client that created this FD
  WeakClientPointer creator;

  /// Server that accepted this FD
  WeakServerPointer acceptor;

  /// generic FD owner/handler
  /// (to cover exceptional contexts missed above?)
  WeakFdOwnerPointer owner;

  /// poor man's generic FD owner/handler/operation description
  /// (to cover performance-ignorant contexts missed above)
  SBuf note;
};


Copying a pointer is a cheap operation; its performance expense is worth
providing that extra information to developers and sysadmins. The heavy
price of interpreting/reporting owner details is only paid when that
extra information is actually requested/used, allowing us to provide a
lot more useful details (than a short summary which we can compute and
stuff into an SBuf every time we manipulate an FD).

Designing the right set of context pointers requires making difficult
decisions such as whether the fde class should point to acceptor/creator
(as shown in the above oversimplified sketch) or the Comm::Connection
class should do that instead. FWIW, the latter makes more sense to me
now, but I have not given it enough thought.

Implementing weak pointers correctly (including efficiently) OR
convincing ourselves that certain strong pointers are acceptable in this
context is also a serious challenge.


IMO, we should be moving towards this design while continuing to provide
sketchy/stale/truncated/limited FD info without performance regressions.

Fortunately, the two approaches can co-exist nicely: Want more/better
details? Invest in the right approach for the context you are interested
in. Just want to continue to provide the bare minimum? Continue to use
expensive fixed annotation buffers (without slowing things down further)
and/or cheap constant SBuf annotations.


HTH,

Alex.


