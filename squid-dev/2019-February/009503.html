<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Efficient FD annotations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Efficient%20FD%20annotations&In-Reply-To=%3Ca2117aa5-7413-415f-6370-e221ffae9082%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009502.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Efficient FD annotations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Efficient%20FD%20annotations&In-Reply-To=%3Ca2117aa5-7413-415f-6370-e221ffae9082%40measurement-factory.com%3E"
       TITLE="[squid-dev] Efficient FD annotations">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Feb 22 17:08:16 UTC 2019</I>
    <P><UL>
        <LI>Previous message: <A HREF="009502.html">[squid-dev] Where can I see the build nodes status,	5.x doesn't build for me.
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9503">[ date ]</a>
              <a href="thread.html#9503">[ thread ]</a>
              <a href="subject.html#9503">[ subject ]</a>
              <a href="author.html#9503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In <A HREF="https://github.com/squid-cache/squid/pull/270#discussion_r259316609">https://github.com/squid-cache/squid/pull/270#discussion_r259316609</A>


&gt;<i> In src/comm.cc:
</I>&gt;<i> 
</I>&gt;&gt;<i> @@ -424,7 +424,7 @@ comm_init_opened(const Comm::ConnectionPointer &amp;conn,
</I>&gt;<i>      debugs(5, 5, HERE &lt;&lt; conn &lt;&lt; &quot; is a new socket&quot;);
</I>&gt;<i>  
</I>&gt;<i>      assert(!isOpen(conn-&gt;fd));
</I>&gt;<i> -    fd_open(conn-&gt;fd, FD_SOCKET, note);
</I>&gt;<i> +    fd_open(conn-&gt;fd, FD_SOCKET, SBuf(note));
</I>

&gt;<i> Alex: I do not think we should introduce this performance regression
</I>&gt;<i> on a common code path. Better debugging/reporting is just not worth
</I>&gt;<i> it. I have ideas on how this regression can be avoided (and debugging
</I>&gt;<i> improved), but I do not want to waste time detailing and discussing
</I>&gt;<i> them if you do not want to spend a lot more time on this PR.
</I>

&gt;<i> Amos: Since this PR is about fixing the compile error I don't want to
</I>&gt;<i> complicate it any further. But do want to hear these ideas. Can you
</I>&gt;<i> post them to squid-dev so we can go over it separately please.
</I>

IMO, the best way to annotate file descriptors (and other objects) for
debugging/reporting purposes is to store pointers to their current
owners and/or objects currently responsible for FD processing. Very
roughly speaking:

class fde
{
  ...

  /* current FD handling context */

  /// Comm::Connection this FD belongs to
  WeakConnectionPointer connection;

  /// Client that created this FD
  WeakClientPointer creator;

  /// Server that accepted this FD
  WeakServerPointer acceptor;

  /// generic FD owner/handler
  /// (to cover exceptional contexts missed above?)
  WeakFdOwnerPointer owner;

  /// poor man's generic FD owner/handler/operation description
  /// (to cover performance-ignorant contexts missed above)
  SBuf note;
};


Copying a pointer is a cheap operation; its performance expense is worth
providing that extra information to developers and sysadmins. The heavy
price of interpreting/reporting owner details is only paid when that
extra information is actually requested/used, allowing us to provide a
lot more useful details (than a short summary which we can compute and
stuff into an SBuf every time we manipulate an FD).

Designing the right set of context pointers requires making difficult
decisions such as whether the fde class should point to acceptor/creator
(as shown in the above oversimplified sketch) or the Comm::Connection
class should do that instead. FWIW, the latter makes more sense to me
now, but I have not given it enough thought.

Implementing weak pointers correctly (including efficiently) OR
convincing ourselves that certain strong pointers are acceptable in this
context is also a serious challenge.


IMO, we should be moving towards this design while continuing to provide
sketchy/stale/truncated/limited FD info without performance regressions.

Fortunately, the two approaches can co-exist nicely: Want more/better
details? Invest in the right approach for the context you are interested
in. Just want to continue to provide the bare minimum? Continue to use
expensive fixed annotation buffers (without slowing things down further)
and/or cheap constant SBuf annotations.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009502.html">[squid-dev] Where can I see the build nodes status,	5.x doesn't build for me.
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9503">[ date ]</a>
              <a href="thread.html#9503">[ thread ]</a>
              <a href="subject.html#9503">[ subject ]</a>
              <a href="author.html#9503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
