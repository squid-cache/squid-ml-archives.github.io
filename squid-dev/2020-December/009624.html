<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%20CONNECT%0A%20requests&In-Reply-To=%3CCAHMdmWGESdHQ%3DAymwQ_MmaK4Jc8OEodNRu%3DoiXobQ%2BnoVkbNLA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   <LINK REL="Next"  HREF="009625.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests</H1>
    <B>Alexey Sergin</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%20CONNECT%0A%20requests&In-Reply-To=%3CCAHMdmWGESdHQ%3DAymwQ_MmaK4Jc8OEodNRu%3DoiXobQ%2BnoVkbNLA%40mail.gmail.com%3E"
       TITLE="[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests">alexey.sergin at gmail.com
       </A><BR>
    <I>Thu Dec 10 20:33:12 UTC 2020</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="009625.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9624">[ date ]</a>
              <a href="thread.html#9624">[ thread ]</a>
              <a href="subject.html#9624">[ subject ]</a>
              <a href="author.html#9624">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Squid Developers.

I'm a software engineer.

My team uses Squid with an ICAP server. We have noticed that Squid leaks
file descriptor and memory when (reqmod) ICAP server replies with http &quot;403
Forbidden&quot; on http CONNECT request.

Here is a step-by-step description of the problematic scenario:
- An http client connects to Squid and sends CONNECT request (for example,
&quot;curl -q -x <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> <A HREF="https://example.com">https://example.com</A>&quot;);
- Squid sends CONNECT request to the (reqmod) ICAP server;
- ICAP server sends back a &quot;403 Forbidden&quot; http response;
- Squid sends &quot;403 Forbidden&quot; http response to the http client (in the
example above, curl reports &quot;Received HTTP code 403 from proxy after
CONNECT&quot;);
- Squid writes to cache.log a message like &quot;kick abandoning &lt;....&gt;&quot;;
- Squid does not close the file descriptor used for http client connection.

Those file descriptors and associated memory do pile up. For instance,
after 200.000 forbidden requests squid (built from git master) has ~200.000
open descriptors and consumes ~4 Gb RAM. On production deployment with
1000+ users it takes less than a day for Squid to eat out all available RAM.

It seems that the same problem was previously reported here:
<A HREF="http://www.squid-cache.org/mail-archive/squid-users/201301/0096.html">http://www.squid-cache.org/mail-archive/squid-users/201301/0096.html</A>

Message &quot;kick abandoning &lt;....&gt;&quot; comes from ConnStateData::kick() in
client_side.cc. Closing clientConnection right after
&quot;debugs(&lt;....&gt;abandoning&lt;....&gt;)&quot; fixes the leak.

Is it ok to always close() clientConnection when &quot;abandoning&quot; thing
happens? Are there any known scenarios where this close() would be
inappropriate?

Could you please give me some advice on a better/proper fix, if close() at
&quot;abandoning&quot; time is wrong?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201210/5b492a6a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201210/5b492a6a/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="009625.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9624">[ date ]</a>
              <a href="thread.html#9624">[ thread ]</a>
              <a href="subject.html#9624">[ subject ]</a>
              <a href="author.html#9624">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
