<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%0A%20CONNECT%20requests&In-Reply-To=%3C023601d6cf39%2417596b70%24460c4250%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009624.html">
   <LINK REL="Next"  HREF="009627.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests</H1>
    <B>Eliezer Croitor</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%0A%20CONNECT%20requests&In-Reply-To=%3C023601d6cf39%2417596b70%24460c4250%24%40gmail.com%3E"
       TITLE="[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests">ngtech1ltd at gmail.com
       </A><BR>
    <I>Thu Dec 10 21:11:54 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009624.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
        <LI>Next message (by thread): <A HREF="009627.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9625">[ date ]</a>
              <a href="thread.html#9625">[ thread ]</a>
              <a href="subject.html#9625">[ subject ]</a>
              <a href="author.html#9625">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Alexey,

 

What version of Squid are you using?

Can you provide a setup example for re-production?

I can write the relevant ICAP service however I am missing pcap file to understand the ICAP sessions.

If you can supply couple(2-3 or more) ICAP connections pcap I can try to see what happens in the connection level.

 

&gt;<i>From my experience there is much differences between holding the ICAP session open or closed after once request.
</I>
The reason for this is that like HTTP/1.0 ICAP is a “blocking”(don’t remember the exact word, Alex might remember).

There for if the proxy has 800 requests per seconds it’s better for the setup to open new connection per request to match the load.

It will const memory and CPU in the short term but in the long term the clients requests will bock less and..

It will probably consume less then the ICAP connections memory leak.

 

Waiting,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">ngtech1ltd at gmail.com</A>&gt; 

 

From: squid-dev &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alexey Sergin
Sent: Thursday, December 10, 2020 10:33 PM
To: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
Subject: [squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests

 

Hello Squid Developers.

I'm a software engineer.

My team uses Squid with an ICAP server. We have noticed that Squid leaks file descriptor and memory when (reqmod) ICAP server replies with http &quot;403 Forbidden&quot; on http CONNECT request.

Here is a step-by-step description of the problematic scenario:
- An http client connects to Squid and sends CONNECT request (for example, &quot;curl -q -x <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> <A HREF="https://example.com">https://example.com</A>&quot;);
- Squid sends CONNECT request to the (reqmod) ICAP server;
- ICAP server sends back a &quot;403 Forbidden&quot; http response;
- Squid sends &quot;403 Forbidden&quot; http response to the http client (in the example above, curl reports &quot;Received HTTP code 403 from proxy after CONNECT&quot;);
- Squid writes to cache.log a message like &quot;kick abandoning &lt;....&gt;&quot;;
- Squid does not close the file descriptor used for http client connection.

Those file descriptors and associated memory do pile up. For instance, after 200.000 forbidden requests squid (built from git master) has ~200.000 open descriptors and consumes ~4 Gb RAM. On production deployment with 1000+ users it takes less than a day for Squid to eat out all available RAM.

It seems that the same problem was previously reported here: <A HREF="http://www.squid-cache.org/mail-archive/squid-users/201301/0096.html">http://www.squid-cache.org/mail-archive/squid-users/201301/0096.html</A>

Message &quot;kick abandoning &lt;....&gt;&quot; comes from ConnStateData::kick() in client_side.cc. Closing clientConnection right after &quot;debugs(&lt;....&gt;abandoning&lt;....&gt;)&quot; fixes the leak.

Is it ok to always close() clientConnection when &quot;abandoning&quot; thing happens? Are there any known scenarios where this close() would be inappropriate?

Could you please give me some advice on a better/proper fix, if close() at &quot;abandoning&quot; time is wrong?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201210/355e1ff6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201210/355e1ff6/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009624.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
	<LI>Next message (by thread): <A HREF="009627.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9625">[ date ]</a>
              <a href="thread.html#9625">[ thread ]</a>
              <a href="subject.html#9625">[ subject ]</a>
              <a href="author.html#9625">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
