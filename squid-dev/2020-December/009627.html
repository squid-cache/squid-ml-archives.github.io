<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%0A%20CONNECT%20requests&In-Reply-To=%3CCAHMdmWH9eU80-oTYycNJikHJ3R3r0OQ8EbTxqoR7A5VjGEzoyA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009625.html">
   <LINK REL="Next"  HREF="009626.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests</H1>
    <B>Alexey Sergin</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%0A%20CONNECT%20requests&In-Reply-To=%3CCAHMdmWH9eU80-oTYycNJikHJ3R3r0OQ8EbTxqoR7A5VjGEzoyA%40mail.gmail.com%3E"
       TITLE="[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests">alexey.sergin at gmail.com
       </A><BR>
    <I>Fri Dec 11 17:21:41 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009625.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
        <LI>Next message (by thread): <A HREF="009626.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9627">[ date ]</a>
              <a href="thread.html#9627">[ thread ]</a>
              <a href="subject.html#9627">[ subject ]</a>
              <a href="author.html#9627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Eliezer!


&gt;<i> What version of Squid are you using?
</I>
I have reproduced the leak on squid versions: 4.8, 5.0.4, git master
38da9c24e.
In production deployment we use squid 4.x


&gt;<i> Can you provide a setup example for re-production?
</I>
Blow are the steps to reproduce the problem on the CentOS 7 system.

Test icap server is based on Example3 from
<A HREF="https://github.com/Peoplecantfly/icapserver/blob/master/TUTORIAL.md">https://github.com/Peoplecantfly/icapserver/blob/master/TUTORIAL.md</A>
The only difference is that implementations of example_REQMOD and
example_RESPMOD methods are swapped.

1. Put the following code to file server.py:
# vvvvvvvvvvvvvvvv
# vvv cut here vvv
# vvvvvvvvvvvvvvvv
import time
import threading

from icapserver import *

class ExampleICAPHandler(BaseICAPRequestHandler):

    def example_OPTIONS(self):
        self.set_icap_response(200)
        self.set_icap_header('Methods', 'RESPMOD, REQMOD')
        self.set_icap_header('Service',
            'ICAP Server' + ' ' + self._server_version)
        self.set_icap_header('Options-TTL', '3600')
        self.set_icap_header('Preview', '0')
        self.send_headers(False)

    def example_RESPMOD(self):
        self.no_adaptation_required()

    def example_REQMOD(self):
        if self.has_body:
            while True:
                if self.read_chunk() == '':
                    break
        self.set_icap_response(200)
        self.set_enc_status('HTTP/1.1 451 Unavailable For Legal Reasons')
        self.send_headers(False)

class ExampleICAPServer():

    def __init__(self, addr='', port=13440):
        self.addr = addr
        self.port = port

    def start(self):
        self.server = ICAPServer((self.addr, self.port), ExampleICAPHandler)
        self.thread = threading.Thread(target=self.server.serve_forever)
        self.thread.start()
        return True

    def stop(self):
        self.server.shutdown()
        self.server.server_close()
        self.thread.join(2)
        return True


try:
    server = ExampleICAPServer()
    server.start()
    print 'Use Control-C to exit'
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    server.stop()
    print &quot;Finished&quot;
# ^^^^^^^^^^^^^^^^
# ^^^ cut here ^^^
# ^^^^^^^^^^^^^^^^

2. Prepare environment for test icap server:
# yum install -y python2-virtualenv
# virtualenv-2 icapserver
# source icapserver/bin/activate
# pip install icapserver

3. Run the test icap server:
# source icapserver/bin/activate
# python server.py &amp;

4. Install squid version 4 or above (built with --enable-icap-client).

5. Rewrite /etc/squid/squid.conf:
cache deny all
cache_mem 0
shutdown_lifetime 5 seconds
http_port 3128
acl localnet src 127.0.0.1
http_access deny !localnet
http_access allow all
icap_enable on
icap_service example_req reqmod_precache <A HREF="icap://127.0.0.1:13440/example">icap://127.0.0.1:13440/example</A>
adaptation_access example_req allow all
icap_service_failure_limit -1

6. Apply squid configuration changes:
# systemctl restart squid

7. Initiate http request:
# curl -q -x <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> <A HREF="https://example.com">https://example.com</A>

8. Output of curl should look like:
curl: (56) Received HTTP code 451 from proxy after CONNECT

9. Leaked descriptor is in a CLOSE-WAIT state:
# ss -natpo | grep CLOSE-WAIT


&gt;<i> If you can supply couple(2-3 or more) ICAP connections pcap I can try to
</I>see what happens in the connection level.

Pcap file with 3 connections attached.


&gt;<i> &gt;From my experience there is much differences between holding the ICAP
</I>session open or closed after once request.
&gt;<i> The reason for this is that like HTTP/1.0 ICAP is a “blocking”(don’t
</I>remember the exact word, Alex might remember).
&gt;<i> There for if the proxy has 800 requests per seconds it’s better for the
</I>setup to open new connection per request to match the load.
&gt;<i> It will const memory and CPU in the short term but in the long term the
</I>clients requests will bock less and..
&gt;<i> It will probably consume less then the ICAP connections memory leak.
</I>
Leak happens both with and without the load.
Http client connections do leak, but ICAP connections do not.


&gt;<i> There for if the proxy has 800 requests per seconds it’s better for the
</I>setup to open new connection per request to match the load.

Production ICAP server reports &quot;Max-Connections: 5000&quot; in response to ICAP
OPTIONS request.
Is in sufficient? If not, what should ICAP server do, and what should be
done squid (and in squid.conf), to achieve the &quot;open new connection per
request&quot; behaviour?


Thanks!

On Fri, Dec 11, 2020 at 12:11 AM Eliezer Croitor &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">ngtech1ltd at gmail.com</A>&gt;
wrote:

&gt;<i> Hey Alexey,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What version of Squid are you using?
</I>&gt;<i>
</I>&gt;<i> Can you provide a setup example for re-production?
</I>&gt;<i>
</I>&gt;<i> I can write the relevant ICAP service however I am missing pcap file to
</I>&gt;<i> understand the ICAP sessions.
</I>&gt;<i>
</I>&gt;<i> If you can supply couple(2-3 or more) ICAP connections pcap I can try to
</I>&gt;<i> see what happens in the connection level.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From my experience there is much differences between holding the ICAP
</I>&gt;<i> session open or closed after once request.
</I>&gt;<i>
</I>&gt;<i> The reason for this is that like HTTP/1.0 ICAP is a “blocking”(don’t
</I>&gt;<i> remember the exact word, Alex might remember).
</I>&gt;<i>
</I>&gt;<i> There for if the proxy has 800 requests per seconds it’s better for the
</I>&gt;<i> setup to open new connection per request to match the load.
</I>&gt;<i>
</I>&gt;<i> It will const memory and CPU in the short term but in the long term the
</I>&gt;<i> clients requests will bock less and..
</I>&gt;<i>
</I>&gt;<i> It will probably consume less then the ICAP connections memory leak.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Waiting,
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* squid-dev &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev-bounces at lists.squid-cache.org</A>&gt; *On Behalf Of
</I>&gt;<i> *Alexey Sergin
</I>&gt;<i> *Sent:* Thursday, December 10, 2020 10:33 PM
</I>&gt;<i> *To:* <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> *Subject:* [squid-dev] File descriptor leak at ICAP reqmod rewrites of
</I>&gt;<i> CONNECT requests
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hello Squid Developers.
</I>&gt;<i>
</I>&gt;<i> I'm a software engineer.
</I>&gt;<i>
</I>&gt;<i> My team uses Squid with an ICAP server. We have noticed that Squid leaks
</I>&gt;<i> file descriptor and memory when (reqmod) ICAP server replies with http &quot;403
</I>&gt;<i> Forbidden&quot; on http CONNECT request.
</I>&gt;<i>
</I>&gt;<i> Here is a step-by-step description of the problematic scenario:
</I>&gt;<i> - An http client connects to Squid and sends CONNECT request (for example,
</I>&gt;<i> &quot;curl -q -x <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> <A HREF="https://example.com">https://example.com</A>&quot;);
</I>&gt;<i> - Squid sends CONNECT request to the (reqmod) ICAP server;
</I>&gt;<i> - ICAP server sends back a &quot;403 Forbidden&quot; http response;
</I>&gt;<i> - Squid sends &quot;403 Forbidden&quot; http response to the http client (in the
</I>&gt;<i> example above, curl reports &quot;Received HTTP code 403 from proxy after
</I>&gt;<i> CONNECT&quot;);
</I>&gt;<i> - Squid writes to cache.log a message like &quot;kick abandoning &lt;....&gt;&quot;;
</I>&gt;<i> - Squid does not close the file descriptor used for http client connection.
</I>&gt;<i>
</I>&gt;<i> Those file descriptors and associated memory do pile up. For instance,
</I>&gt;<i> after 200.000 forbidden requests squid (built from git master) has ~200.000
</I>&gt;<i> open descriptors and consumes ~4 Gb RAM. On production deployment with
</I>&gt;<i> 1000+ users it takes less than a day for Squid to eat out all available RAM.
</I>&gt;<i>
</I>&gt;<i> It seems that the same problem was previously reported here:
</I>&gt;<i> <A HREF="http://www.squid-cache.org/mail-archive/squid-users/201301/0096.html">http://www.squid-cache.org/mail-archive/squid-users/201301/0096.html</A>
</I>&gt;<i>
</I>&gt;<i> Message &quot;kick abandoning &lt;....&gt;&quot; comes from ConnStateData::kick() in
</I>&gt;<i> client_side.cc. Closing clientConnection right after
</I>&gt;<i> &quot;debugs(&lt;....&gt;abandoning&lt;....&gt;)&quot; fixes the leak.
</I>&gt;<i>
</I>&gt;<i> Is it ok to always close() clientConnection when &quot;abandoning&quot; thing
</I>&gt;<i> happens? Are there any known scenarios where this close() would be
</I>&gt;<i> inappropriate?
</I>&gt;<i>
</I>&gt;<i> Could you please give me some advice on a better/proper fix, if close() at
</I>&gt;<i> &quot;abandoning&quot; time is wrong?
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201211/a8fc9610/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201211/a8fc9610/attachment-0001.htm</A>&gt;
-------------- next part --------------
cache deny all
cache_mem 0
shutdown_lifetime 5 seconds
http_port 3128
acl localnet src 127.0.0.1
http_access deny !localnet
http_access allow all
icap_enable on
icap_service example_req reqmod_precache <A HREF="icap://127.0.0.1:13440/example">icap://127.0.0.1:13440/example</A>
adaptation_access example_req allow all
icap_service_failure_limit -1
-------------- next part --------------
A non-text attachment was scrubbed...
Name: example.pcap
Type: application/vnd.tcpdump.pcap
Size: 6416 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201211/a8fc9610/attachment-0001.pcap">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201211/a8fc9610/attachment-0001.pcap</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: server.py
Type: text/x-python
Size: 1498 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201211/a8fc9610/attachment-0001.py">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20201211/a8fc9610/attachment-0001.py</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009625.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
	<LI>Next message (by thread): <A HREF="009626.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9627">[ date ]</a>
              <a href="thread.html#9627">[ thread ]</a>
              <a href="subject.html#9627">[ subject ]</a>
              <a href="author.html#9627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
