<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%0A%20CONNECT%20requests&In-Reply-To=%3C008f01d6d0d2%24d22c3370%2476849a50%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009626.html">
   <LINK REL="Next"  HREF="009629.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests</H1>
    <B>Eliezer Croitor</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20File%20descriptor%20leak%20at%20ICAP%20reqmod%20rewrites%20of%0A%20CONNECT%20requests&In-Reply-To=%3C008f01d6d0d2%24d22c3370%2476849a50%24%40gmail.com%3E"
       TITLE="[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests">ngtech1ltd at gmail.com
       </A><BR>
    <I>Sat Dec 12 22:04:52 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009626.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
        <LI>Next message (by thread): <A HREF="009629.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9628">[ date ]</a>
              <a href="thread.html#9628">[ thread ]</a>
              <a href="subject.html#9628">[ subject ]</a>
              <a href="author.html#9628">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Seems like above my paygrade..


----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">ngtech1ltd at gmail.com</A>

-----Original Message-----
From: squid-dev &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
Sent: Friday, December 11, 2020 5:40 PM
To: Alexey Sergin &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">alexey.sergin at gmail.com</A>&gt;; <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
Subject: Re: [squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests

On 12/10/20 3:33 PM, Alexey Sergin wrote:

&gt;<i> - Squid writes to cache.log a message like &quot;kick abandoning &lt;....&gt;&quot;;
</I>
These messages indicate a Squid bug, most likely in REQMOD request
satisfaction implementation specific to CONNECT use cases. The messages
are not prefixed with a &quot;BUG&quot; label, but they should be.


&gt;<i> - Squid does not close the file descriptor used for http client connection.
</I>
Yes, that is a likely side effect of the above-mentioned bug.


&gt;<i> client_side.cc. Closing clientConnection right after
</I>&gt;<i> &quot;debugs(&lt;....&gt;abandoning&lt;....&gt;)&quot; fixes the leak.
</I>
&gt;<i> Is it ok to always close() clientConnection when &quot;abandoning&quot; thing
</I>&gt;<i> happens? 
</I>
&gt;<i> Are there any known scenarios where this close() would be
</I>&gt;<i> inappropriate?
</I>
Unknown. Such a closure (alone) is not a proper fix. If well-tested, it
may be considered to be a good-enough workaround, but no more than that.

What is currently missing (at least) is understanding of what is going
on. The correct fix, whatever it is, would be determined by that
understanding.

In general, responding with a 403 does not invalidate the client
connection, so it does not have to be closed. Said that, I am sure there
are use cases where such closure would be a good idea. I would not be
surprised if Squid closes the connection after denying regular requests.


&gt;<i> Could you please give me some advice on a better/proper fix, if close()
</I>&gt;<i> at &quot;abandoning&quot; time is wrong?
</I>
Unfortunately, I cannot. Somebody needs to investigate the problem and
identify the bug in ConnStateData::kick() logic (or elsewhere).

Alex.
_______________________________________________
squid-dev mailing list
<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009626.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
	<LI>Next message (by thread): <A HREF="009629.html">[squid-dev] File descriptor leak at ICAP reqmod rewrites of CONNECT requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9628">[ date ]</a>
              <a href="thread.html#9628">[ thread ]</a>
              <a href="subject.html#9628">[ subject ]</a>
              <a href="author.html#9628">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
