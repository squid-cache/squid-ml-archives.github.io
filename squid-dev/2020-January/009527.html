<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Efficient FD annotations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Efficient%20FD%20annotations&In-Reply-To=%3C488434a9-d602-8a56-d775-f7e31208deb9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   <LINK REL="Next"  HREF="009528.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Efficient FD annotations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Efficient%20FD%20annotations&In-Reply-To=%3C488434a9-d602-8a56-d775-f7e31208deb9%40measurement-factory.com%3E"
       TITLE="[squid-dev] Efficient FD annotations">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan  6 15:28:37 UTC 2020</I>
    <P><UL>
        
        <LI>Next message: <A HREF="009528.html">[squid-dev] Efficient FD annotations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9527">[ date ]</a>
              <a href="thread.html#9527">[ thread ]</a>
              <a href="subject.html#9527">[ subject ]</a>
              <a href="author.html#9527">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>For the record: The ideas below are superseded by the concept of the
code context introduced in commit ccfbe8f, including the
fde::codeContext field. --Alex


On 2/22/19 12:08 PM, Alex Rousskov wrote:
&gt;<i> In <A HREF="https://github.com/squid-cache/squid/pull/270#discussion_r259316609">https://github.com/squid-cache/squid/pull/270#discussion_r259316609</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> In src/comm.cc:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> @@ -424,7 +424,7 @@ comm_init_opened(const Comm::ConnectionPointer &amp;conn,
</I>&gt;&gt;<i>      debugs(5, 5, HERE &lt;&lt; conn &lt;&lt; &quot; is a new socket&quot;);
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i>      assert(!isOpen(conn-&gt;fd));
</I>&gt;&gt;<i> -    fd_open(conn-&gt;fd, FD_SOCKET, note);
</I>&gt;&gt;<i> +    fd_open(conn-&gt;fd, FD_SOCKET, SBuf(note));
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Alex: I do not think we should introduce this performance regression
</I>&gt;&gt;<i> on a common code path. Better debugging/reporting is just not worth
</I>&gt;&gt;<i> it. I have ideas on how this regression can be avoided (and debugging
</I>&gt;&gt;<i> improved), but I do not want to waste time detailing and discussing
</I>&gt;&gt;<i> them if you do not want to spend a lot more time on this PR.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Amos: Since this PR is about fixing the compile error I don't want to
</I>&gt;&gt;<i> complicate it any further. But do want to hear these ideas. Can you
</I>&gt;&gt;<i> post them to squid-dev so we can go over it separately please.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> IMO, the best way to annotate file descriptors (and other objects) for
</I>&gt;<i> debugging/reporting purposes is to store pointers to their current
</I>&gt;<i> owners and/or objects currently responsible for FD processing. Very
</I>&gt;<i> roughly speaking:
</I>&gt;<i> 
</I>&gt;<i> class fde
</I>&gt;<i> {
</I>&gt;<i>   ...
</I>&gt;<i> 
</I>&gt;<i>   /* current FD handling context */
</I>&gt;<i> 
</I>&gt;<i>   /// Comm::Connection this FD belongs to
</I>&gt;<i>   WeakConnectionPointer connection;
</I>&gt;<i> 
</I>&gt;<i>   /// Client that created this FD
</I>&gt;<i>   WeakClientPointer creator;
</I>&gt;<i> 
</I>&gt;<i>   /// Server that accepted this FD
</I>&gt;<i>   WeakServerPointer acceptor;
</I>&gt;<i> 
</I>&gt;<i>   /// generic FD owner/handler
</I>&gt;<i>   /// (to cover exceptional contexts missed above?)
</I>&gt;<i>   WeakFdOwnerPointer owner;
</I>&gt;<i> 
</I>&gt;<i>   /// poor man's generic FD owner/handler/operation description
</I>&gt;<i>   /// (to cover performance-ignorant contexts missed above)
</I>&gt;<i>   SBuf note;
</I>&gt;<i> };
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Copying a pointer is a cheap operation; its performance expense is worth
</I>&gt;<i> providing that extra information to developers and sysadmins. The heavy
</I>&gt;<i> price of interpreting/reporting owner details is only paid when that
</I>&gt;<i> extra information is actually requested/used, allowing us to provide a
</I>&gt;<i> lot more useful details (than a short summary which we can compute and
</I>&gt;<i> stuff into an SBuf every time we manipulate an FD).
</I>&gt;<i> 
</I>&gt;<i> Designing the right set of context pointers requires making difficult
</I>&gt;<i> decisions such as whether the fde class should point to acceptor/creator
</I>&gt;<i> (as shown in the above oversimplified sketch) or the Comm::Connection
</I>&gt;<i> class should do that instead. FWIW, the latter makes more sense to me
</I>&gt;<i> now, but I have not given it enough thought.
</I>&gt;<i> 
</I>&gt;<i> Implementing weak pointers correctly (including efficiently) OR
</I>&gt;<i> convincing ourselves that certain strong pointers are acceptable in this
</I>&gt;<i> context is also a serious challenge.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> IMO, we should be moving towards this design while continuing to provide
</I>&gt;<i> sketchy/stale/truncated/limited FD info without performance regressions.
</I>&gt;<i> 
</I>&gt;<i> Fortunately, the two approaches can co-exist nicely: Want more/better
</I>&gt;<i> details? Invest in the right approach for the context you are interested
</I>&gt;<i> in. Just want to continue to provide the bare minimum? Continue to use
</I>&gt;<i> expensive fixed annotation buffers (without slowing things down further)
</I>&gt;<i> and/or cheap constant SBuf annotations.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="009528.html">[squid-dev] Efficient FD annotations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9527">[ date ]</a>
              <a href="thread.html#9527">[ thread ]</a>
              <a href="subject.html#9527">[ subject ]</a>
              <a href="author.html#9527">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
