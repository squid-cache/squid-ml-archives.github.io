<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Non TLS connections to HTTP and SSL_BUMP ports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Non%20TLS%20connections%20to%20HTTP%20and%20SSL_BUMP%20ports&In-Reply-To=%3Ca9b0c452-4c0f-75af-e8bc-628b5bfbe888%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009597.html">
   <LINK REL="Next"  HREF="009599.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Non TLS connections to HTTP and SSL_BUMP ports</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Non%20TLS%20connections%20to%20HTTP%20and%20SSL_BUMP%20ports&In-Reply-To=%3Ca9b0c452-4c0f-75af-e8bc-628b5bfbe888%40measurement-factory.com%3E"
       TITLE="[squid-dev] Non TLS connections to HTTP and SSL_BUMP ports">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jul  5 14:10:07 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009597.html">[squid-dev] Non TLS connections to HTTP and SSL_BUMP ports
</A></li>
        <LI>Next message (by thread): <A HREF="009599.html">[squid-dev] Non TLS connections to HTTP and SSL_BUMP ports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9598">[ date ]</a>
              <a href="thread.html#9598">[ thread ]</a>
              <a href="subject.html#9598">[ subject ]</a>
              <a href="author.html#9598">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/4/20 5:33 PM, Eliezer Croitor wrote:

&gt;<i> What about connections on intercepted port which are either non TLS/SSL
</I>
Non TLS/SSL connections intercepted on https_port are handled according
to on_unsupported_protocol settings.


&gt;<i> or when squid had some server or client negotiation issues?
</I>
There are many nuances here, but &quot;Squid negotiation&quot; usually implies
that the bump decision has been made, and Squid is sending its own TLS
secrets instead of forwarding client ones. Bumping errors are,
essentially, transport errors. The connection(s) will probably be
closed. If Squid-server negotiation fails, then the client will be
bumped, and a Squid error response will be sent to the client.


&gt;<i> The first issue with TLS connections is that if for any reason the proxy
</I>&gt;<i> didn’t managed to negotiate and establish a TLS connection with the
</I>&gt;<i> server, the client is STUCK.
</I>
I do not know what you mean by &quot;stuck&quot; exactly, but, bugs
notwithstanding, Squid-server negotiation failures do not lead to
stalled clients. In the worst case, Squid-server negotiation may
timeout, but even that should not result in a client waiting forever.


&gt;<i> - Proxy side “retries” toward the TLS server
</I>
Retries usually make sense if something is changed for the next attempt.
AFAICT, you propose that the second attempt will be done in splicing
mode (despite the previous decision to bump), increasing the chances of
&quot;success&quot; (for some definition of success). Please correct me if I
misunderstood.


&gt;<i> The sketch of such a function can be
</I>
&gt;<i> - If TLS handshake exists, try to parse
</I>
&gt;<i> - If parse is OK try to connect the remote server else throw
</I>&gt;<i> the connection into some ACL
</I>
&gt;<i> - If the remote server responds well to a TLS handshare, bump
</I>&gt;<i> else spice
</I>
All of the above is already supported except the very last bit -- Squid
does not splice on Squid-server TLS negotiation failures. Moreover,
splicing the client and the server after a TLS negotiation failure is
technically impossible -- the server already expects Squid secrets, not
client secrets.

It would be possible to establish another TLS connection with the server
and splice that new connection with the old client connection. One could
add some kind of on_tls_connect_failure directive to enable and control
that behavior. If that feature is needed to support some reasonable use
case, I think its quality implementation should be welcomed.


HTH,

Alex.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009597.html">[squid-dev] Non TLS connections to HTTP and SSL_BUMP ports
</A></li>
	<LI>Next message (by thread): <A HREF="009599.html">[squid-dev] Non TLS connections to HTTP and SSL_BUMP ports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9598">[ date ]</a>
              <a href="thread.html#9598">[ thread ]</a>
              <a href="subject.html#9598">[ subject ]</a>
              <a href="author.html#9598">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
