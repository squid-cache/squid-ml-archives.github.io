<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20tls_key_log%3A%20report%20TLS%20pre-master%20secrets%2C%0A%20other%20key%20material&In-Reply-To=%3Cac5cadd3-7e7b-7bde-d83b-6313a25c9b96%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009605.html">
   <LINK REL="Next"  HREF="009612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20tls_key_log%3A%20report%20TLS%20pre-master%20secrets%2C%0A%20other%20key%20material&In-Reply-To=%3Cac5cadd3-7e7b-7bde-d83b-6313a25c9b96%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 29 18:41:05 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009605.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets,	other key material
</A></li>
        <LI>Next message (by thread): <A HREF="009612.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9611">[ date ]</a>
              <a href="thread.html#9611">[ thread ]</a>
              <a href="subject.html#9611">[ subject ]</a>
              <a href="author.html#9611">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/15/20 3:14 PM, Alex Rousskov wrote:

&gt;<i>     I propose to add a new tls_key_log directive to record TLS
</I>&gt;<i> pre-master secret (and related encryption details) for to- and
</I>&gt;<i> from-Squid TLS connections. This very useful triage feature is common
</I>&gt;<i> for browsers and some networking tools. Wireshark supports it[1]. You
</I>&gt;<i> might know it as SSLKEYLOGFILE. It has been requested by several Squid
</I>&gt;<i> admins. A draft documentation of the proposed directive is at the end of
</I>&gt;<i> this email.
</I>&gt;<i> 
</I>&gt;<i> [1] <A HREF="https://wiki.wireshark.org/TLS#Using_the_.28Pre.29-Master-Secret">https://wiki.wireshark.org/TLS#Using_the_.28Pre.29-Master-Secret</A>
</I>&gt;<i> 
</I>&gt;<i> If you have any feature scope adjustments, implementation wishes, or
</I>&gt;<i> objections to this feature going in, please let me know!
</I>

FYI: Factory is starting to implement this feature.

Alex.


&gt;<i> FTR, we have considered providing similar support by adding new
</I>&gt;<i> logformat %code(s) to the existing access_log. While doing so would
</I>&gt;<i> reduce and simplify code changes, we ultimately rejected that design
</I>&gt;<i> because the combination of the following factors renders it inferior and
</I>&gt;<i> insufficient on several levels:
</I>&gt;<i> 
</I>&gt;<i> 1. Some TLS connections are reflected in access logs a long time
</I>&gt;<i>    after they are established (e.g., when the connection serves
</I>&gt;<i>    a long CONNECT tunnel). During triage, admins may need the
</I>&gt;<i>    ability to decipher a live connection much sooner.
</I>&gt;<i> 
</I>&gt;<i> 2. Some TLS connections are never reflected in access logs at all
</I>&gt;<i>    (e.g., when Squid opens but does not use an outgoing TLS connection
</I>&gt;<i>    or crashes when parsing the first request on an incoming one). Info
</I>&gt;<i>    gaps often create triage suspicions: Did we drop something else?
</I>&gt;<i> 
</I>&gt;<i> 3. A single access_log record may correspond to many from-Squid
</I>&gt;<i>    connections, especially when Squid retries peer failures. Logging
</I>&gt;<i>    keys for all these connections would require accumulating the keys in
</I>&gt;<i>    the master transaction and then dumping them as a part of a new
</I>&gt;<i>    %code. Adding (and dumping) repeated ALE fields is awkward.
</I>&gt;<i> 
</I>&gt;<i> 4. Manually creating ACLs to limit access log records to the first
</I>&gt;<i>    transaction on a connection would be a must for most deployments
</I>&gt;<i>    using this feature. Doing so is far from trivial and related
</I>&gt;<i>    configuration errors are difficult to triage. We could add a new
</I>&gt;<i>    ACL type for this purpose, but even that is tricky because a
</I>&gt;<i>    single master transaction may have many associated connections.
</I>&gt;<i>    And logging secrets for every transaction creates too much noise.
</I>&gt;<i> 
</I>&gt;<i> 5. Configuration flexibility offered by logformat is likely to
</I>&gt;<i>    remain largely unused by the new feature because tools like
</I>&gt;<i>    Wireshark _automatically_ find relevant records when deciphering
</I>&gt;<i>    captured traffic. Augmenting these logs with other transaction
</I>&gt;<i>    details (typical for access log uses) would be mostly useless.
</I>&gt;<i> 
</I>&gt;<i> 6. New %codes would be awkward to use in a regular access log because
</I>&gt;<i>    they may expand into a variable number of lines, going against the
</I>&gt;<i>    traditional line-oriented, &quot;fixed&quot; format access log use.
</I>&gt;<i> 
</I>&gt;<i> While some of the above items have workarounds, a few do not, and the
</I>&gt;<i> whole combination looks rather grim/unfriendly. We should attack this
</I>&gt;<i> problem from the other end -- a new simple configuration dedicated to
</I>&gt;<i> this useful feature.
</I>&gt;<i> 
</I>&gt;<i> We propose to structure this new directive so that it is easy to add
</I>&gt;<i> advanced access_log-like features later if needed (while reusing the
</I>&gt;<i> corresponding access_log code). For example, if users find that they
</I>&gt;<i> want to maintain multiple TLS key logs or augment log records with
</I>&gt;<i> connection details, we can add that support by borrowing access_log
</I>&gt;<i> options and code without backward compatibility concerns. The new
</I>&gt;<i> required &quot;if&quot; keyword in front of the ACL list allows for seamless
</I>&gt;<i> addition of new directive options in the future.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> ---------- draft squid.conf directive documentation ------------
</I>&gt;<i> 
</I>&gt;<i> tls_key_log
</I>&gt;<i> 
</I>&gt;<i> Configures whether and where Squid records pre-master secret and
</I>&gt;<i> related encryption details for TLS connections accepted or established
</I>&gt;<i> by Squid. These connections include connections accepted at
</I>&gt;<i> https_port, TLS connections opened to origin servers/cache_peers/ICAP
</I>&gt;<i> services, and TLS tunnels bumped by Squid using the SslBump feature.
</I>&gt;<i> This log (a.k.a. SSLKEYLOGFILE) is meant for triage with traffic
</I>&gt;<i> inspection tools like Wireshark.
</I>&gt;<i> 
</I>&gt;<i>     tls_key_log &lt;filename&gt; if &lt;acl&gt;...
</I>&gt;<i> 
</I>&gt;<i> WARNING: This log allows anybody to decrypt the corresponding
</I>&gt;<i> encrypted TLS connections, both in-flight and postmortem.
</I>&gt;<i> 
</I>&gt;<i> At most one log file is supported at this time. Repeated tls_key_log
</I>&gt;<i> directives are treated as fatal configuration errors. By default, no
</I>&gt;<i> log is created or updated.
</I>&gt;<i> 
</I>&gt;<i> If the log file does not exist, Squid creates it. Otherwise, Squid
</I>&gt;<i> appends an existing log file.
</I>&gt;<i> 
</I>&gt;<i> The directive is consulted whenever a TLS connection is accepted or
</I>&gt;<i> established by Squid. TLS connections that fail the handshake may be
</I>&gt;<i> logged if Squid got enough information to form a log record. A record
</I>&gt;<i> is logged only if all of the configured ACLs match.
</I>&gt;<i> 
</I>&gt;<i> Squid does not buffer these log records -- the worker blocks until
</I>&gt;<i> each record is written. File system buffering may speed things up, but
</I>&gt;<i> consider placing this triage log in a memory-based partition.
</I>&gt;<i> 
</I>&gt;<i> This log is rotated based on the logfile_rotate settings.
</I>&gt;<i> 
</I>&gt;<i> Logging errors are reported to cache.log but are otherwise ignored.
</I>&gt;<i> 
</I>&gt;<i> While transport-related ACLs like src and dst should work, Squid may
</I>&gt;<i> not have access to higher-level information. For example, when logging
</I>&gt;<i> accepted https_port connections, Squid does not yet have access to the
</I>&gt;<i> expected HTTPS request. Similarly, an HTTPS response is not available
</I>&gt;<i> when logging most TLS connections established by Squid.
</I>&gt;<i> 
</I>&gt;<i> The log record format is meant to be compatible with TLS deciphering
</I>&gt;<i> features of Wireshark which include support for TLS v1.3 fields such
</I>&gt;<i> as CLIENT_EARLY_TRAFFIC_SECRET and SERVER_TRAFFIC_SECRET_0. A single
</I>&gt;<i> log record usually spans multiple lines. Technical documentation for
</I>&gt;<i> that format is maintained inside the Wireshark code (e.g., see
</I>&gt;<i> tls_keylog_process_lines() comments as of Wireshark commit
</I>&gt;<i> e3d44136f0f0026c5e893fa249f458073f3b7328).
</I>&gt;<i> 
</I>&gt;<i> This clause only supports fast acl types.
</I>&gt;<i> See <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A> for details.
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009605.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets,	other key material
</A></li>
	<LI>Next message (by thread): <A HREF="009612.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9611">[ date ]</a>
              <a href="thread.html#9611">[ thread ]</a>
              <a href="subject.html#9611">[ subject ]</a>
              <a href="author.html#9611">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
