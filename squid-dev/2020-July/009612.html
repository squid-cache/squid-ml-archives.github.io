<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20tls_key_log%3A%20report%20TLS%20pre-master%20secrets%2C%0A%20other%20key%20material&In-Reply-To=%3C8f3b6a6a-00a6-6496-5558-2e9eb363950d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009611.html">
   <LINK REL="Next"  HREF="009613.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20tls_key_log%3A%20report%20TLS%20pre-master%20secrets%2C%0A%20other%20key%20material&In-Reply-To=%3C8f3b6a6a-00a6-6496-5558-2e9eb363950d%40treenet.co.nz%3E"
       TITLE="[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 30 10:28:40 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009611.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
        <LI>Next message (by thread): <A HREF="009613.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9612">[ date ]</a>
              <a href="thread.html#9612">[ thread ]</a>
              <a href="subject.html#9612">[ subject ]</a>
              <a href="author.html#9612">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/07/20 6:41 am, Alex Rousskov wrote:
&gt;<i> On 7/15/20 3:14 PM, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>     I propose to add a new tls_key_log directive to record TLS
</I>&gt;&gt;<i> pre-master secret (and related encryption details) for to- and
</I>&gt;&gt;<i> from-Squid TLS connections. This very useful triage feature is common
</I>&gt;&gt;<i> for browsers and some networking tools. Wireshark supports it[1]. You
</I>&gt;&gt;<i> might know it as SSLKEYLOGFILE. It has been requested by several Squid
</I>&gt;&gt;<i> admins. A draft documentation of the proposed directive is at the end of
</I>&gt;&gt;<i> this email.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [1] <A HREF="https://wiki.wireshark.org/TLS#Using_the_.28Pre.29-Master-Secret">https://wiki.wireshark.org/TLS#Using_the_.28Pre.29-Master-Secret</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you have any feature scope adjustments, implementation wishes, or
</I>&gt;&gt;<i> objections to this feature going in, please let me know!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> FYI: Factory is starting to implement this feature.
</I>&gt;<i> 
</I>
Sorry I forgot to reply to this earlier.

Two design points:

1) It seems to me these bits are part of the handshake. So would come in
either as members/args of the %handshake logformat macros (some not yet
implemented) or as secondary %handshake_foo macros in the style %cert_*
macros use.


2) Please do use the logging logic implemented for access_log, just with
the next directive as list of log outputs to write at the appropriate
logging trigger time.

I accept the reasoning for not using access_log directive. This will
need a new log directive with different times when it triggers output
written there. However (most of) the implementation logic of access_log
should be usable for this new output.



&gt;&gt;<i> We propose to structure this new directive so that it is easy to add
</I>&gt;&gt;<i> advanced access_log-like features later if needed (while reusing the
</I>&gt;&gt;<i> corresponding access_log code). For example, if users find that they
</I>&gt;&gt;<i> want to maintain multiple TLS key logs or augment log records with
</I>&gt;&gt;<i> connection details, we can add that support by borrowing access_log
</I>&gt;&gt;<i> options and code without backward compatibility concerns. The new
</I>&gt;&gt;<i> required &quot;if&quot; keyword in front of the ACL list allows for seamless
</I>&gt;&gt;<i> addition of new directive options in the future.
</I>&gt;&gt;<i>
</I>

Accepted, provided the directive *does* support access_log feature
addition. The plan below does not meet that criteria. Some changes
inline below to make it do so.


&gt;&gt;<i> ---------- draft squid.conf directive documentation ------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> tls_key_log
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Configures whether and where Squid records pre-master secret and
</I>&gt;&gt;<i> related encryption details for TLS connections accepted or established
</I>&gt;&gt;<i> by Squid. These connections include connections accepted at
</I>&gt;&gt;<i> https_port, TLS connections opened to origin servers/cache_peers/ICAP
</I>&gt;&gt;<i> services, and TLS tunnels bumped by Squid using the SslBump feature.
</I>&gt;&gt;<i> This log (a.k.a. SSLKEYLOGFILE) is meant for triage with traffic
</I>&gt;&gt;<i> inspection tools like Wireshark.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     tls_key_log &lt;filename&gt; if &lt;acl&gt;...
</I>&gt;&gt;<i>
</I>
Please allow extension points for options and modules:

  tls_key_log stdio:&lt;filename&gt; [options] if &lt;acl&gt;...


The &quot;stdio:&quot; module name is to allow for sharing the access_log config
parser and future expansion to logging modules like daemon: which we
will doubtless be asked for later.



&gt;&gt;<i> WARNING: This log allows anybody to decrypt the corresponding
</I>&gt;&gt;<i> encrypted TLS connections, both in-flight and postmortem.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At most one log file is supported at this time. Repeated tls_key_log
</I>&gt;&gt;<i> directives are treated as fatal configuration errors. By default, no
</I>&gt;&gt;<i> log is created or updated.
</I>
With ACL support it seems reasonable to support multiple logs. We should
be able to re-use (with minor change to pass the list of log outputs to
the function) the logic access_log has for writing to a list of outputs.


&gt;&gt;<i>
</I>&gt;&gt;<i> If the log file does not exist, Squid creates it. Otherwise, Squid
</I>&gt;&gt;<i> appends an existing log file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The directive is consulted whenever a TLS connection is accepted or
</I>&gt;&gt;<i> established by Squid. TLS connections that fail the handshake may be
</I>&gt;&gt;<i> logged if Squid got enough information to form a log record. A record
</I>&gt;&gt;<i> is logged only if all of the configured ACLs match.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid does not buffer these log records -- the worker blocks until
</I>&gt;&gt;<i> each record is written. File system buffering may speed things up, but
</I>&gt;&gt;<i> consider placing this triage log in a memory-based partition.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This log is rotated based on the logfile_rotate settings.
</I>&gt;&gt;<i>
</I>
Please don't use solely that directive. The new directive should have a
rotate=N option of its own. Only using the global directive as a default
if that option is unset.


Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009611.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
	<LI>Next message (by thread): <A HREF="009613.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9612">[ date ]</a>
              <a href="thread.html#9612">[ thread ]</a>
              <a href="subject.html#9612">[ subject ]</a>
              <a href="author.html#9612">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
