<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20tls_key_log%3A%20report%20TLS%20pre-master%20secrets%2C%0A%20other%20key%20material&In-Reply-To=%3Ce23adc5a-5f5f-cb47-cdcd-e0caa651289a%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009612.html">
   <LINK REL="Next"  HREF="009606.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20tls_key_log%3A%20report%20TLS%20pre-master%20secrets%2C%0A%20other%20key%20material&In-Reply-To=%3Ce23adc5a-5f5f-cb47-cdcd-e0caa651289a%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jul 30 16:58:08 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009612.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
        <LI>Next message (by thread): <A HREF="009606.html">[squid-dev] OpenSSL 3.0 support at last
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9613">[ date ]</a>
              <a href="thread.html#9613">[ thread ]</a>
              <a href="subject.html#9613">[ subject ]</a>
              <a href="author.html#9613">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/30/20 6:28 AM, Amos Jeffries wrote:
&gt;&gt;<i> On 7/15/20 3:14 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i>     I propose to add a new tls_key_log directive to record TLS
</I>&gt;&gt;&gt;<i> pre-master secret (and related encryption details) for to- and
</I>&gt;&gt;&gt;<i> from-Squid TLS connections. This very useful triage feature is common
</I>&gt;&gt;&gt;<i> for browsers and some networking tools. Wireshark supports it[1]. You
</I>&gt;&gt;&gt;<i> might know it as SSLKEYLOGFILE. It has been requested by several Squid
</I>&gt;&gt;&gt;<i> admins. A draft documentation of the proposed directive is at the end of
</I>&gt;&gt;&gt;<i> this email.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [1] <A HREF="https://wiki.wireshark.org/TLS#Using_the_.28Pre.29-Master-Secret">https://wiki.wireshark.org/TLS#Using_the_.28Pre.29-Master-Secret</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If you have any feature scope adjustments, implementation wishes, or
</I>&gt;&gt;&gt;<i> objections to this feature going in, please let me know!
</I>

&gt;<i> Two design points:
</I>&gt;<i> 
</I>&gt;<i> 1) It seems to me these bits are part of the handshake. So would come in
</I>&gt;<i> either as members/args of the %handshake logformat macros (some not yet
</I>&gt;<i> implemented) or as secondary %handshake_foo macros in the style %cert_*
</I>&gt;<i> macros use.
</I>
Sure, if somebody wants to add a new logformat %code to log secrets,
they should do that. It would not be a good solution for the problems
tls_key_log is solving, but it could be useful for other reasons, of
course. That addition will probably be able to reuse some of the
tls_key_log code as well.

As for reusing %handshake for such logging, I am not sure: Connection
secrets cannot be a part of the plain text handshake (for obvious
reasons). Logging encrypted secrets does not help. If somebody wants to
add plain text secrets logging via a new %handshake parameter, they
should double check whether all the secrets are truly a part of the
encrypted handshake -- I suspect that the handshake actually ends sooner
and/or contains secret _derivatives_.

At any rate, these details are all outside the tls_key_log scope. We do
not need to investigate or agree on them right now AFAICT. If I missed
your point, please clarify.


&gt;<i> 2) Please do use the logging logic implemented for access_log, just with
</I>&gt;<i> the next directive as list of log outputs to write at the appropriate
</I>&gt;<i> logging trigger time.
</I>
Sorry, I do not understand what the above paragraph means. The term
&quot;logging logic implemented for access_log&quot; is so broad that I cannot
tell what you are trying to subtract or add to the proposed tls_key_log
directive interface and/or its implementation. If this is already
covered by the specific discussion below, then just skip to that!


&gt;<i> I accept the reasoning for not using access_log directive. This will
</I>&gt;<i> need a new log directive with different times when it triggers output
</I>&gt;<i> written there. 
</I>
Yes.


&gt;<i> However (most of) the implementation logic of access_log
</I>&gt;<i> should be usable for this new output.
</I>
I see no reason to repeat access_log interface mistakes (e.g., the
special &quot;none&quot; destination) and no need to support some of the
powerful/complex access_log features in tls_key_log (e.g., logformat),
but perhaps you are not asking for any of that. Please be more specific
if this is not covered by the discussion below.


&gt;&gt;&gt;<i>     tls_key_log &lt;filename&gt; if &lt;acl&gt;...
</I>
&gt;<i> Please allow extension points for options and modules:
</I>&gt;<i> 
</I>&gt;<i>   tls_key_log stdio:&lt;filename&gt; [options] if &lt;acl&gt;...
</I>
We will requite the ugly &quot;stdio:&quot; suffix to avoid arguing about it.

Future addition of optional parameters was already supported; there were
just no such options until you requested rotate=N below.


&gt;&gt;&gt;<i> At most one log file is supported at this time. Repeated tls_key_log
</I>&gt;&gt;&gt;<i> directives are treated as fatal configuration errors. By default, no
</I>&gt;&gt;&gt;<i> log is created or updated.
</I>
&gt;<i> With ACL support it seems reasonable to support multiple logs. We should
</I>&gt;<i> be able to re-use (with minor change to pass the list of log outputs to
</I>&gt;<i> the function) the logic access_log has for writing to a list of outputs.
</I>
I agree that supporting multiple tls_key_log is reasonable. I would
leave that feature for a future seamless improvement -- that is why
repeated tls_key_log directives are treated as a fatal configuration
error for now.

The existing multi-log logic for access_logs is confusing for admins and
has serious implementation bugs. I do not think we should model the new
feature on that interface or code. However, we do not need to agree on
this aspect. It can and should be decided later, driven, in part, by
real use cases for multilog support.


&gt;&gt;&gt;<i> This log is rotated based on the logfile_rotate settings.
</I>
&gt;<i> Please don't use solely that directive. The new directive should have a
</I>&gt;<i> rotate=N option of its own. Only using the global directive as a default
</I>&gt;<i> if that option is unset.
</I>
Will add to avoid arguing about it.


Thank you,

Alex.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009612.html">[squid-dev] RFC: tls_key_log: report TLS pre-master secrets, other key material
</A></li>
	<LI>Next message (by thread): <A HREF="009606.html">[squid-dev] OpenSSL 3.0 support at last
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9613">[ date ]</a>
              <a href="thread.html#9613">[ thread ]</a>
              <a href="subject.html#9613">[ subject ]</a>
              <a href="author.html#9613">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
