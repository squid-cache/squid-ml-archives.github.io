<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: Modernizing sources using clang-tidy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Modernizing%20sources%20using%20clang-tidy&In-Reply-To=%3Caae7e04a-8c08-fe19-59cd-0a396a227573%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009586.html">
   <LINK REL="Next"  HREF="009587.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: Modernizing sources using clang-tidy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Modernizing%20sources%20using%20clang-tidy&In-Reply-To=%3Caae7e04a-8c08-fe19-59cd-0a396a227573%40treenet.co.nz%3E"
       TITLE="[squid-dev] RFC: Modernizing sources using clang-tidy">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat May 30 19:22:00 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009586.html">[squid-dev] cppunit -&gt; googletest / gmock?
</A></li>
        <LI>Next message (by thread): <A HREF="009587.html">[squid-dev] RFC: Modernizing sources using clang-tidy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9583">[ date ]</a>
              <a href="thread.html#9583">[ thread ]</a>
              <a href="subject.html#9583">[ subject ]</a>
              <a href="author.html#9583">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/04/20 2:02 pm, Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>     Squid sources contain a lot of poorly written, obsolete, and
</I>&gt;<i> inconsistent code that (objectively) complicates development and
</I>&gt;<i> (unfortunately) increases tensions among developers during review.
</I>&gt;<i> 
</I>&gt;<i> Some of those problems can be solved using tools that modify sources.
</I>&gt;<i> Clang-tidy is one such tool: <A HREF="https://clang.llvm.org/extra/clang-tidy/">https://clang.llvm.org/extra/clang-tidy/</A>
</I>&gt;<i> It contains 150+ &quot;checks&quot; that can automatically fix some common
</I>&gt;<i> problems by studying the syntax tree produced by the clang compiler.
</I>&gt;<i> Understanding the code at that level allows clang-tidy to attack
</I>&gt;<i> problems that simple scripts cannot touch.
</I>&gt;<i> 
</I>&gt;<i> I have not studied most of the clang-tidy checks, but did try a few
</I>&gt;<i> listed at the end of this email. You can see the whole list of checks at
</I>&gt;<i> <A HREF="https://clang.llvm.org/extra/clang-tidy/checks/list.html">https://clang.llvm.org/extra/clang-tidy/checks/list.html</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Here are a few pros and cons of using clang-tidy compared to our own
</I>&gt;<i> custom scripts:
</I>&gt;<i> 
</I>&gt;<i> Pros:
</I>&gt;<i> 
</I>&gt;<i> * maintained and improved by others
</I>&gt;<i> * can fix problems that our scripts cannot see
</I>&gt;<i> * covers a few rules from C++ Core Guidelines and popular Style Guides
</I>&gt;<i> * arguably less likely to accidentally screw things up than our scripts
</I>&gt;<i> 
</I>
In order to switch we should be looking for a tool that improves over
the status-quo. Which is both astyle plus the custom scripts.

All of the above are high-level abstractions that the existing astyle
tool provides by itself. So no valid reason for changing is visible yet.


What I have seen from kinkies work is a few cases of little things like
ability to fix whitespace inside () conditionals and before
function/method parameter lists. Which is something astyle has not been
able to do for us and would be difficult to script.



&gt;<i> Cons:
</I>&gt;<i> 
</I>&gt;<i> * Requires installation of clang, clang-tidy-10, bear. It is not
</I>&gt;<i> difficult in a CI environment, but may be too much for occasional
</I>&gt;<i> contributors.
</I>
 Likewise same issues with needing a specific astyle version. So this is
more of a non-Pro than a Con.


&gt;<i> 
</I>&gt;<i> * Clang-tidy misses files that do not participate in a specific build
</I>&gt;<i> (e.g., misses many compat/ files that are not needed for an actual
</I>&gt;<i> build). Applying clang-tidy to all sources will be difficult.
</I>&gt;<i> 
</I>&gt;<i> * Clang-tidy misses code lines that do not participate in a specific
</I>&gt;<i> build (e.g., lines inside `#if HEADERS_LOG` where HEADERS_LOG was not
</I>&gt;<i> defined). Applying clang-tidy to all lines will be impractical.
</I>&gt;<i> 
</I>&gt;<i> * Clang-tidy would be difficult to customize or adjust (probably
</I>&gt;<i> requires building clang from scratch and writing low-level AST
</I>&gt;<i> manipulation code).
</I>&gt;<i> 
</I>
These are all regressions. Severity varies, but IMO we will need to
solve them somehow in order to remove the astyle usage. Otherwise we
would end up this just being an additional tool on the stack - rather
than a full replacement for astyle+scripts.


&gt;<i> * Clang-tidy is relatively slow -- the whole repository scan takes
</I>&gt;<i> approximately 15-30 minutes per rule in my limited tests. Combining
</I>&gt;<i> rules speeds things up, but it may still be too slow to run during every
</I>&gt;<i> PR check on the current CI hardware.
</I>&gt;<i> 
</I>
The current source-maintenance takes 5-10 minutes on master today and
with the scripts/maintenance/ automating growing I expect that to increase.


&gt;<i> * We do not have any clang-tidy experts on the development team (AFAIK).
</I>&gt;<i> 
</I>
Not much of a con, we do not exactly have an astyle expert either. The
benefit of third-party tooling is that we don't need an expert. Just
someone able to read the documentation and test config settings when we
want to update the style policy.


&gt;<i> 
</I>&gt;<i> I will itemize a few checks that I tried. The &quot;diff&quot; links below show
</I>&gt;<i> unpolished and partial changes introduced by the corresponding checks.
</I>&gt;<i> If we decide to use clang-tidy in principle, we will need to fine-tune
</I>&gt;<i> each check options (at least) to get the most out of the tool.
</I>&gt;<i> 
</I>&gt;<i> * modernize-use-override
</I>&gt;<i> 
</I>&gt;<i> Adds &quot;override&quot; (and removes &quot;virtual&quot;) keywords from class declarations.
</I>&gt;<i> 
</I>&gt;<i> This check is very useful not just because &quot;override&quot; helps prevent
</I>&gt;<i> difficult-to-detect bugs but because it is very difficult to transition
</I>&gt;<i> to using &quot;override&quot; _gradually_ -- some compilers reject class
</I>&gt;<i> declarations that have a mixture of with-override and without-override
</I>&gt;<i> methods. Moreover, adding override keywords to old class declarations is
</I>&gt;<i> rather time-consuming because it is often not obvious (to a human)
</I>&gt;<i> whether the class introduces a new interface or overrides and old one.
</I>&gt;<i> 
</I>&gt;<i> Diff: <A HREF="https://github.com/measurement-factory/squid/commit/d00d0a8">https://github.com/measurement-factory/squid/commit/d00d0a8</A>
</I>&gt;<i> 
</I>
I like.

&gt;<i> 
</I>&gt;<i> * performance-...
</I>&gt;<i> 
</I>&gt;<i> Clang-tidy has a few checks focusing on performance optimizations. The
</I>&gt;<i> following commit shows a combination of the following four checks:
</I>&gt;<i> performance-trivially-destructible, performance-unnecessary-value-param,
</I>&gt;<i> performance-for-range-copy, performance-move-const-arg
</I>&gt;<i> 
</I>&gt;<i> Diff: <A HREF="https://github.com/measurement-factory/squid/commit/1ae5d7c">https://github.com/measurement-factory/squid/commit/1ae5d7c</A>
</I>&gt;<i> 
</I>
IMO this is something we should have a


&gt;<i> 
</I>&gt;<i> * modernize-use-nullptr
</I>&gt;<i> 
</I>&gt;<i> Replaces NULL and 0 constants with C++11 nullptr:
</I>&gt;<i> <A HREF="https://clang.llvm.org/extra/clang-tidy/checks/modernize-use-nullptr.html">https://clang.llvm.org/extra/clang-tidy/checks/modernize-use-nullptr.html</A>
</I>&gt;<i> 
</I>&gt;<i> While replacing most NULLs is possible with a simple script, this check
</I>&gt;<i> may be a better solution because it can safely cover more NULL uses and
</I>&gt;<i> also converts bare 0s which would be impossible using a script.
</I>&gt;<i> 
</I>&gt;<i> Diff: <A HREF="https://github.com/measurement-factory/squid/commit/4242604">https://github.com/measurement-factory/squid/commit/4242604</A>
</I>&gt;<i> 
</I>
As I mentioned earlier when kinkie tried this; I do not like this
particular tool feature. The &quot;upgrade&quot; it does is far too simplistic for
a style polishing update. If the end goal were simply to eradicate NULL
- this would be fine. But the goal of using this tool is to ensure a
good quality formatting style. A simplistic s/NULL/nullptr/ leaves quite
a few code lines looking just as ugly as they were with NULL.

IMO we would be better off going the scripted way to remove the subset
of cases we can automate and catch the rest with manual edits and in review.


&gt;<i> 
</I>&gt;<i> In summary, I think investing in clang-tidy would be worth it because
</I>&gt;<i> the tool can address several important problems that we would otherwise
</I>&gt;<i> have to leave untreated. It would take some time to agree on a set of
</I>&gt;<i> checks and then properly configure/tune each one, but I think it is
</I>&gt;<i> doable. I am not sure whether these checks should be applied on each PR
</I>&gt;<i> check or periodically, but we can figure it out as we go.
</I>&gt;<i> 
</I>&gt;<i> I am not aware of any viable alternatives.
</I>&gt;<i> 
</I>&gt;<i> What do you think?
</I>&gt;<i> 
</I>
I like a few things the tool does. But so far it seems like something we
want to run across the code occasionally. eg as a Jenkins test job.
Additional to, rather than replacement for astyle.

Amos
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009586.html">[squid-dev] cppunit -&gt; googletest / gmock?
</A></li>
	<LI>Next message (by thread): <A HREF="009587.html">[squid-dev] RFC: Modernizing sources using clang-tidy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9583">[ date ]</a>
              <a href="thread.html#9583">[ thread ]</a>
              <a href="subject.html#9583">[ subject ]</a>
              <a href="author.html#9583">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
