<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] cppunit -&gt; googletest / gmock?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20cppunit%20-%3E%20googletest%20/%20gmock%3F&In-Reply-To=%3CCA%2BY8hcOVN5TO2kyZu%2BJhUKt9y%2B4NnmV%3DFZkgqeqTfRfjF7mEsg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009584.html">
   <LINK REL="Next"  HREF="009586.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] cppunit -&gt; googletest / gmock?</H1>
    <B>Francesco Chemolli</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20cppunit%20-%3E%20googletest%20/%20gmock%3F&In-Reply-To=%3CCA%2BY8hcOVN5TO2kyZu%2BJhUKt9y%2B4NnmV%3DFZkgqeqTfRfjF7mEsg%40mail.gmail.com%3E"
       TITLE="[squid-dev] cppunit -&gt; googletest / gmock?">gkinkie at gmail.com
       </A><BR>
    <I>Sun May 31 19:05:37 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009584.html">[squid-dev] cppunit -&gt; googletest / gmock?
</A></li>
        <LI>Next message (by thread): <A HREF="009586.html">[squid-dev] cppunit -&gt; googletest / gmock?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9585">[ date ]</a>
              <a href="thread.html#9585">[ thread ]</a>
              <a href="subject.html#9585">[ subject ]</a>
              <a href="author.html#9585">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, May 30, 2020 at 7:38 PM Amos Jeffries &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 31/05/20 5:27 am, Francesco Chemolli wrote:
</I>&gt;<i> &gt; Hi all,
</I>&gt;<i> &gt;    starting from a PR in a conversation with Alex about our current
</I>&gt;<i> &gt; approach to unit testing being painful, I've checked what alternatives
</I>&gt;<i> &gt; would we have and how practical would they be.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; An easy first option would be googletest/googlemock.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On a lazy afternoon, I've tried seeing how useful/painful it would be to
</I>&gt;<i> &gt; try it, by porting one test over - it's quite trivial and doesn't
</I>&gt;<i> &gt; require mocking, so I'll try a more complicated one next - to start a
</I>&gt;<i> &gt; conversation about the topic.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You can find the test branch at
</I>&gt;<i> <A HREF="https://github.com/kinkie/squid/tree/gtest">https://github.com/kinkie/squid/tree/gtest</A> .
</I>&gt;<i> &gt; I've only touched two files, a newly-created src/tests/testMemGtest and
</I>&gt;<i> &gt; src/Makefile.am .
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The output from the test run is at
</I>&gt;<i> <A HREF="https://paste.ubuntu.com/p/3sgTDN7rNm/">https://paste.ubuntu.com/p/3sgTDN7rNm/</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What do you think?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My initial thoughts:
</I>&gt;<i> &gt; - it is somewhat simpler and more powerful than cppunit
</I>&gt;<i> &gt; - setting the test environment up is easy but at this time it can only
</I>&gt;<i> &gt; be done from source. Adding it to the build farm images is
</I>&gt;<i> straightforward
</I>&gt;<i>
</I>&gt;<i> That is a problem. The unit tests are run by pretty much everyone
</I>&gt;<i> building Squid.
</I>&gt;<i>
</I>
We should be able to bundle gtest if needed; we only distribute in source
form and it wouldn't be part of distfiles so it shouldn't be a problem
downstream either, I believe


&gt;<i> It is not a complete blocker, but having a process more complex than
</I>&gt;<i> simple dependency install does pose a relatively major hurdle that any
</I>&gt;<i> framework has to get over to be of much utility.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; - the license is BSD 3-clause new
</I>&gt;<i> &gt; (<A HREF="https://github.com/google/googletest/blob/master/LICENSE">https://github.com/google/googletest/blob/master/LICENSE</A>)
</I>&gt;<i> &gt; - googlemock promises to be vastly superior to our current approach
</I>&gt;<i>
</I>&gt;<i> Where are you seeing evidence of this?
</I>&gt;<i>
</I>
Also including answer on Alex' question:
- <A HREF="https://stackoverflow.com/questions/7922289/googletest-vs-cppun">https://stackoverflow.com/questions/7922289/googletest-vs-cppun</A>
it-the-facts
&lt;<A HREF="https://stackoverflow.com/questions/7922289/googletest-vs-cppunit-the-facts">https://stackoverflow.com/questions/7922289/googletest-vs-cppunit-the-facts</A>&gt;
- trivial but it builds up: not generally necessary to have .h and .cc for
simple cases
- comparison table:
<A HREF="https://socialcompare.com/en/comparison/c-unit-testing-framework">https://socialcompare.com/en/comparison/c-unit-testing-framework</A>
- gmock/gtest is used in broadly-used projects (e.g. chromium) - I'm not
sure


So far I'm basing on documentation, found at
<A HREF="https://github.com/google/googletest/blob/master/googlemock/docs/cook_book.md">https://github.com/google/googletest/blob/master/googlemock/docs/cook_book.md</A>
 .
I see:
- a more structured approach to mocking, and more infrastructure to do it
- ON_CALL and EXPECT_CALL patterns to define actions and expectations on
class methods (method called once / called multiple times). This can also
allow to change the behaviour of a mocked object on different tests without
having to remock it all
- matchers on called methods
- moched methods can different return values depending on arguments, and
check for complex sequences of calls to methods (call a() with some
arguments, then either b() or c(), if it's c() must be followe by d()
- for object, the concept of &quot;uninteresting calls&quot; that get ignored, and
can be defaulted



&gt;<i> The main issue we have with cppunit itself is that when a test fails it
</I>&gt;<i> is not clear from the output which assertion occurred, nor why. One is
</I>&gt;<i> left having to try and trigger the unit failure again manually and gdb
</I>&gt;<i> from there.
</I>&gt;<i>
</I>&gt;<i> This can be worked around by following best-practice in unit test
</I>&gt;<i> implementation. But people contributing to Squid have not been doing so
</I>&gt;<i> consistently, and it is just a workaround.
</I>&gt;<i>
</I>&gt;<i> I do see somewhat more verbose output in the logs, and slightly less
</I>&gt;<i> code to implement (no .h class). Which is a nice gain, but not what I
</I>&gt;<i> would call &quot;vastly superior&quot;.
</I>&gt;<i>
</I>
Right. A lot of value comes from the combination with gmock.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; - porting memTest took me about one hour, mostly caused by us including
</I>&gt;<i> &gt; cppunit headers from squid.h (WUT? A PR is coming up to unentangle that)
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Converting tests from one framework to another is not a problem. We just
</I>&gt;<i> have nobody doing the legwork. Case in point being the old tests not
</I>&gt;<i> even using cppunit.
</I>&gt;<i>
</I>
&gt;<i>
</I>&gt;<i> The main problem(s) we have with testing of Squid is dev participation:
</I>&gt;<i>
</I>&gt;<i>  a) people are not writing tests to cover new code, and
</I>&gt;<i>  b) people are not writing/updating tests to cover bug fixes, and
</I>&gt;<i>  c) tests written are generally not following best practice design.
</I>&gt;<i>
</I>&gt;<i> IIRC Alex an I have different ideas about the ideal focus of testing;
</I>&gt;<i>  * I prefer the micro-test approach to demonstrate a high quality proof
</I>&gt;<i> of code reliability.
</I>&gt;<i>  * Alex has stated a preference for high level black-box testing of
</I>&gt;<i> behaviour vs design requirements.
</I>&gt;<i>
</I>
TBH I favour unit tests as well. But if we can have black box texting (and
there are compliance testing frameworks to do that for us) that'd really
increase the confidence in correctness over time. The two do not cancel
each other, luckily. The former can do fast-feedback return, the latter can
say &quot;something is wrong&quot; and then we can - if needed - bisect to point to a
specific commit


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20200531/abfbc88a/attachment.html">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20200531/abfbc88a/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009584.html">[squid-dev] cppunit -&gt; googletest / gmock?
</A></li>
	<LI>Next message (by thread): <A HREF="009586.html">[squid-dev] cppunit -&gt; googletest / gmock?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9585">[ date ]</a>
              <a href="thread.html#9585">[ thread ]</a>
              <a href="subject.html#9585">[ subject ]</a>
              <a href="author.html#9585">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
