<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Squid 4.13: too much memory used for ACL url_regex when big list file used
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Squid%204.13%3A%20too%20much%20memory%20used%20for%20ACL%20url_regex%0A%20when%20big%20list%20file%20used&In-Reply-To=%3Ccee5b9ca-42ab-2c1b-9013-1c942f796115%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009703.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Squid 4.13: too much memory used for ACL url_regex when big list file used</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Squid%204.13%3A%20too%20much%20memory%20used%20for%20ACL%20url_regex%0A%20when%20big%20list%20file%20used&In-Reply-To=%3Ccee5b9ca-42ab-2c1b-9013-1c942f796115%40treenet.co.nz%3E"
       TITLE="[squid-dev] Squid 4.13: too much memory used for ACL url_regex when big list file used">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 17 01:38:23 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009703.html">[squid-dev] Squid 4.13: too much memory used for ACL url_regex when big list file used
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9705">[ date ]</a>
              <a href="thread.html#9705">[ thread ]</a>
              <a href="subject.html#9705">[ subject ]</a>
              <a href="author.html#9705">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/08/21 5:45 am, Meridoff wrote:
&gt;<i> Hello, I have simplest squid config with such acl:
</I>&gt;<i> 
</I>&gt;<i> acl a1 url_regex &quot;/tmp/urls.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> In /tmp/urls.txt there are about 220 000 URL regexps, most of them in 
</I>&gt;<i> such form (example):
</I>&gt;<i> ^(https?|ftp)://([a-z0-9.-]+\.)?nicebox\.pro(/.*)?$
</I>&gt;<i> OR
</I>&gt;<i> ^(https?|ftp)://order-yudobashi-com\.363q1\.bar/
</I>&gt;<i> 
</I>&gt;<i> There are a lot of memory used by squid for such configuration: about 
</I>&gt;<i> 2GB. Without this command: about 30MB used.
</I>
Are those numbers without traffic going through?
ie. just Squid loading the configuration then does nothing.

&gt;<i> 
</I>&gt;<i> So aprxm. 10KB for 1 regexp. Is it normal? I think it is too big..
</I>&gt;<i> 
</I>
regex rules get aggregated into longer compound lines, then compiled 
into a binary form for the regex library to handle. It is not easy to 
tell how the compiled form will compare in size to the original strings.


&gt;<i> I think that such big consumption is because of regexps , for simple 
</I>&gt;<i> strings (for example, domains or IPs) consumption will be less.
</I>&gt;<i> 
</I>
Sure. &quot;Simple strings&quot; will be not much larger than the size of the file 
input - though there is some extra memory used for indexing etc.


&gt;<i> How I can decrease memory consumption for such big regexp lists in ACLs 
</I>&gt;<i> ? May be some fix in squid or some fix in regexp lists ?
</I>&gt;<i> 
</I>
First thing to do is figure out where the memory is being consumed.

This command:
  squidclient mgr:mem

Will produce a spreadhsheet in TSV format of the memory allocations your 
Squid has. Look through that for the big memory spenders, with an eye on 
the regex one(s) you are suspicious of.


Amos
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009703.html">[squid-dev] Squid 4.13: too much memory used for ACL url_regex when big list file used
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9705">[ date ]</a>
              <a href="thread.html#9705">[ thread ]</a>
              <a href="subject.html#9705">[ subject ]</a>
              <a href="author.html#9705">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
