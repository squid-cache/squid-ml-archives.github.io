From ngtech1ltd at gmail.com  Wed Jan  6 19:49:57 2021
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Wed, 6 Jan 2021 21:49:57 +0200
Subject: [squid-dev] I have seen this patch for Host Header forgery,
 I need translation.
Message-ID: <00a301d6e465$261f8cc0$725ea640$@gmail.com>

Hey,

I know a bit about host header forgery.
However I have seen this patch and was wondering about the effect it would
have on a proxy:
https://github.com/NethServer/dev/issues/5348

The best solution is that the DNS world would be "perfected" however in the
real world there are
other consideration.
For example I have seen that specific domain names are generated
"on-demand",
After a basic confirmation in the HTTP/HTTPS level the client can try to
access a set of dynamic domains.

I am still not sure what is the right approach about the current logs.
It's pretty annoying if the admin knows that it happens however if he will
disable it by "default"
There are other side effects.

Logs, yes?no?.. nut sure..

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon




From ngtech1ltd at gmail.com  Thu Jan  7 03:26:32 2021
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Thu, 7 Jan 2021 05:26:32 +0200
Subject: [squid-dev] [squid-users] Host header forgery detected on
 domain: mobile.pipe.aria.microsoft.com
In-Reply-To: <450c138a-042c-a08d-a104-710d706b521c@measurement-factory.com>
References: <00a401d6e465$26cd31e0$746795a0$@gmail.com>
 <450c138a-042c-a08d-a104-710d706b521c@measurement-factory.com>
Message-ID: <00b101d6e4a4$e5be45f0$b13ad1d0$@gmail.com>

Hey Alex,

The main issue now is the extensive logging.
For a tiny server with a single desktop client the cache.log  are expending a *lot*.
I have a problem with discarding these logs but for this specific case where the ttl is very low ie: lower < 30/20/10 seconds
We can expect for this to happen so we can disable the logs since the service continue to work with this low ttl.
The only and main issue is the extensive logging which is wrong.

Should we continue this on Squid-dev?

Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Wednesday, January 6, 2021 10:42 PM
To: squid-users at lists.squid-cache.org
Cc: Eliezer Croitoru <ngtech1ltd at gmail.com>
Subject: Re: [squid-users] Host header forgery detected on domain: mobile.pipe.aria.microsoft.com

On 1/6/21 2:49 PM, Eliezer Croitoru wrote:

> I am trying to think about the right solution for the next issue:
> SECURITY ALERT: Host header forgery detected on conn18767
> local=52.114.32.24:443 remote=192.168.189.52:65107 FD 15 flags=33 (local IP
> does not match any domain IP)

As you know, this has been discussed many times on this list before,
including recently[1]. I doubt anything has changed since then.

[1]
http://lists.squid-cache.org/pipermail/squid-users/2020-November/022912.html


> All of the hosts use the same DNS service in the LAN however for some reason
> both squid and the client are resolving different addresses
> in a period of  10  Seconds.

The "however for some reason" part feels misleading to me -- what you
observe is the direct, expected consequence of the low-TTL environment
you have described. There is no contradiction or uncertainty here AFAICT.


> The solution I am thinking is to force a minimum of 60 seconds caching using
> dnsmasq or another caching service.

FTR: Increasing DNS response TTL will reduce the number/probability of
false positives in forged Host header detection. No more. No less.


> Can we teach (theoretically) squid a way to look at these short TTLs as
> something to decide by an ACL?

Yes, it is possible. There is positive_dns_ttl already which specifies
an upper bound. One could add a similar positive_dns_ttl_min option that
would specify the lower bound. Like virtually any Squid directive, it
can be made conditional on ACLs.

IMO, violating DNS TTLs is not the right solution for this problem
though. See my response on the [1] thread for a better medium-term solution.


HTH,

Alex.


From rousskov at measurement-factory.com  Thu Jan  7 16:08:04 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 7 Jan 2021 11:08:04 -0500
Subject: [squid-dev] [squid-users] Host header forgery detected on
 domain: mobile.pipe.aria.microsoft.com
In-Reply-To: <00b101d6e4a4$e5be45f0$b13ad1d0$@gmail.com>
References: <00a401d6e465$26cd31e0$746795a0$@gmail.com>
 <450c138a-042c-a08d-a104-710d706b521c@measurement-factory.com>
 <00b101d6e4a4$e5be45f0$b13ad1d0$@gmail.com>
Message-ID: <05fbb740-83f3-9f55-67ae-1a5d5b03e7a8@measurement-factory.com>

On 1/6/21 10:26 PM, Eliezer Croitoru wrote:

> The main issue now is the extensive logging.

Please note that excessive logging may be the main issue for you and
_some_ Squid admins. For many, the main issue is denied transactions.
For some, it is cache misses. For some, it is a combination of things.
These facts make any single simple solution inapplicable to some use cases.

For example, you can trivially decrease the number (or, with a few more
code lines, frequency) of these messages, but it will not help with the
other problems I mentioned. FWIW, Factory is working on making all
level-0/1 messages configurable that way, but we need more time to
finish that project.

This does not mean that any simple partial solution is going to be
rejected, but please be very careful/specific in defining the problem
when proposing (or asking for) a solution.


> Should we continue this on Squid-dev?

IMO, if you are going to discuss the problem and possible
functionality-level solutions, then squid-users may be the best place
for that. If you are going to discuss code changes and similar
developer-level issues, use squid-dev.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Wednesday, January 6, 2021 10:42 PM
> To: squid-users at lists.squid-cache.org
> Cc: Eliezer Croitoru <ngtech1ltd at gmail.com>
> Subject: Re: [squid-users] Host header forgery detected on domain: mobile.pipe.aria.microsoft.com
> 
> On 1/6/21 2:49 PM, Eliezer Croitoru wrote:
> 
>> I am trying to think about the right solution for the next issue:
>> SECURITY ALERT: Host header forgery detected on conn18767
>> local=52.114.32.24:443 remote=192.168.189.52:65107 FD 15 flags=33 (local IP
>> does not match any domain IP)
> 
> As you know, this has been discussed many times on this list before,
> including recently[1]. I doubt anything has changed since then.
> 
> [1]
> http://lists.squid-cache.org/pipermail/squid-users/2020-November/022912.html
> 
> 
>> All of the hosts use the same DNS service in the LAN however for some reason
>> both squid and the client are resolving different addresses
>> in a period of  10  Seconds.
> 
> The "however for some reason" part feels misleading to me -- what you
> observe is the direct, expected consequence of the low-TTL environment
> you have described. There is no contradiction or uncertainty here AFAICT.
> 
> 
>> The solution I am thinking is to force a minimum of 60 seconds caching using
>> dnsmasq or another caching service.
> 
> FTR: Increasing DNS response TTL will reduce the number/probability of
> false positives in forged Host header detection. No more. No less.
> 
> 
>> Can we teach (theoretically) squid a way to look at these short TTLs as
>> something to decide by an ACL?
> 
> Yes, it is possible. There is positive_dns_ttl already which specifies
> an upper bound. One could add a similar positive_dns_ttl_min option that
> would specify the lower bound. Like virtually any Squid directive, it
> can be made conditional on ACLs.
> 
> IMO, violating DNS TTLs is not the right solution for this problem
> though. See my response on the [1] thread for a better medium-term solution.
> 
> 
> HTH,
> 
> Alex.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 


From h.kawai at ntt.com  Thu Jan 14 00:47:49 2021
From: h.kawai at ntt.com (Hideyuki Kawai)
Date: Thu, 14 Jan 2021 00:47:49 +0000
Subject: [squid-dev] effective acl for tcp_outgoing_address
Message-ID: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>

Hi, this is Kawai.

Please let me send inquiry as followings.

### Requirement ###
1. Kerberos auth with Active Directory	: auth_param ..... 	<- Success
2. "Security group" check which is gotten from AD : external_acl_type ...(using ext_kerberos_ldap_group_acl)   <- success
3. Different outgoing IP based on "Security group" : tcp_outgoing_address + external_acl  <- fail

### Inquiry ###
1. "external_acl" can not use on tcp_outgoing_address. Because the external_acl type is slow.
   My understanding is correct?
2. If yes, how to solve my requirement?

Please let me inform your comment and knowledge.
Thanks in advance.

-------------------------------------
h.kawai at ntt.com
-------------------------------------

From ngtech1ltd at gmail.com  Thu Jan 14 11:36:12 2021
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Thu, 14 Jan 2021 13:36:12 +0200
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
Message-ID: <000001d6ea69$76d62660$64827320$@gmail.com>

It's more of an users question.

Just to clear it out, the tcp_outgoing_address is a fast acl just when the decision is "required"
You can "pre-cook" the value of a specific note when the connection is only at the first http_access level.
An example for a setup which does probably what you want based on htaccess passwords you can here:
https://github.com/elico/vagrant-squid-outgoing-addresses

It's a vagrant lab which demonstrate this.

Let me know if it helps you or you need clarification.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of Hideyuki Kawai
Sent: Thursday, January 14, 2021 2:48 AM
To: squid-dev at lists.squid-cache.org
Subject: [squid-dev] effective acl for tcp_outgoing_address

Hi, this is Kawai.

Please let me send inquiry as followings.

### Requirement ###
1. Kerberos auth with Active Directory	: auth_param ..... 	<- Success
2. "Security group" check which is gotten from AD : external_acl_type ...(using ext_kerberos_ldap_group_acl)   <- success
3. Different outgoing IP based on "Security group" : tcp_outgoing_address + external_acl  <- fail

### Inquiry ###
1. "external_acl" can not use on tcp_outgoing_address. Because the external_acl type is slow.
   My understanding is correct?
2. If yes, how to solve my requirement?

Please let me inform your comment and knowledge.
Thanks in advance.

-------------------------------------
h.kawai at ntt.com
-------------------------------------
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev


From h.kawai at ntt.com  Thu Jan 14 12:21:45 2021
From: h.kawai at ntt.com (Hideyuki Kawai)
Date: Thu, 14 Jan 2021 12:21:45 +0000
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <000001d6ea69$76d62660$64827320$@gmail.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <000001d6ea69$76d62660$64827320$@gmail.com>
Message-ID: <OSBPR01MB2776A52783B597EFDDD39DB5E8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>

Dear Eliezer

Thank you for your reply.
Could you let me ask you about your comment.

"slow acl" can use in tcp_outgoing_address?

Best regards,
Kawai

-------------------------------------
h.kawai at ntt.com
-------------------------------------
-----Original Message-----
From: Eliezer Croitoru <ngtech1ltd at gmail.com> 
Sent: Thursday, January 14, 2021 8:36 PM
To: Hideyuki Kawai（川井秀行） <h.kawai at ntt.com>
Cc: squid-dev at lists.squid-cache.org
Subject: RE: [squid-dev] effective acl for tcp_outgoing_address

It's more of an users question.

Just to clear it out, the tcp_outgoing_address is a fast acl just when the decision is "required"
You can "pre-cook" the value of a specific note when the connection is only at the first http_access level.
An example for a setup which does probably what you want based on htaccess passwords you can here:
https://github.com/elico/vagrant-squid-outgoing-addresses

It's a vagrant lab which demonstrate this.

Let me know if it helps you or you need clarification.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of Hideyuki Kawai
Sent: Thursday, January 14, 2021 2:48 AM
To: squid-dev at lists.squid-cache.org
Subject: [squid-dev] effective acl for tcp_outgoing_address

Hi, this is Kawai.

Please let me send inquiry as followings.

### Requirement ###
1. Kerberos auth with Active Directory	: auth_param ..... 	<- Success
2. "Security group" check which is gotten from AD : external_acl_type ...(using ext_kerberos_ldap_group_acl)   <- success
3. Different outgoing IP based on "Security group" : tcp_outgoing_address + external_acl  <- fail

### Inquiry ###
1. "external_acl" can not use on tcp_outgoing_address. Because the external_acl type is slow.
   My understanding is correct?
2. If yes, how to solve my requirement?

Please let me inform your comment and knowledge.
Thanks in advance.

-------------------------------------
h.kawai at ntt.com
-------------------------------------
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev


From ngtech1ltd at gmail.com  Thu Jan 14 12:47:00 2021
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Thu, 14 Jan 2021 14:47:00 +0200
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <OSBPR01MB2776A52783B597EFDDD39DB5E8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <000001d6ea69$76d62660$64827320$@gmail.com>
 <OSBPR01MB2776A52783B597EFDDD39DB5E8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
Message-ID: <000101d6ea73$5ac11430$10433c90$@gmail.com>

Sorry there was a typo.
There are couple of places in the code that check ACLS.
IN -> PROXY PARSERS -> OUT

Fast acls are these for places which we cannot or won't delay the request.
The place which can take slow acls are before the OUT(simplified example abvoe).
You can apply slow ACLS at http_access layer and the notes are staying withing the request/session.
But on the OUT stage squid will not "stop" or "hold" the request until the helper will respond.

The IP address choice is in the "kernel" level so we must have the resolution for this "fast" and not "s-l-o-w".

I hope this answers you. If not .. ask again.

Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: Hideyuki Kawai <h.kawai at ntt.com> 
Sent: Thursday, January 14, 2021 2:22 PM
To: Eliezer Croitoru <ngtech1ltd at gmail.com>
Cc: squid-dev at lists.squid-cache.org
Subject: RE: [squid-dev] effective acl for tcp_outgoing_address

Dear Eliezer

Thank you for your reply.
Could you let me ask you about your comment.

"slow acl" can use in tcp_outgoing_address?

Best regards,
Kawai

-------------------------------------
h.kawai at ntt.com
-------------------------------------
-----Original Message-----
From: Eliezer Croitoru <ngtech1ltd at gmail.com> 
Sent: Thursday, January 14, 2021 8:36 PM
To: Hideyuki Kawai（川井秀行） <h.kawai at ntt.com>
Cc: squid-dev at lists.squid-cache.org
Subject: RE: [squid-dev] effective acl for tcp_outgoing_address

It's more of an users question.

Just to clear it out, the tcp_outgoing_address is a fast acl just when the decision is "required"
You can "pre-cook" the value of a specific note when the connection is only at the first http_access level.
An example for a setup which does probably what you want based on htaccess passwords you can here:
https://github.com/elico/vagrant-squid-outgoing-addresses

It's a vagrant lab which demonstrate this.

Let me know if it helps you or you need clarification.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of Hideyuki Kawai
Sent: Thursday, January 14, 2021 2:48 AM
To: squid-dev at lists.squid-cache.org
Subject: [squid-dev] effective acl for tcp_outgoing_address

Hi, this is Kawai.

Please let me send inquiry as followings.

### Requirement ###
1. Kerberos auth with Active Directory	: auth_param ..... 	<- Success
2. "Security group" check which is gotten from AD : external_acl_type ...(using ext_kerberos_ldap_group_acl)   <- success
3. Different outgoing IP based on "Security group" : tcp_outgoing_address + external_acl  <- fail

### Inquiry ###
1. "external_acl" can not use on tcp_outgoing_address. Because the external_acl type is slow.
   My understanding is correct?
2. If yes, how to solve my requirement?

Please let me inform your comment and knowledge.
Thanks in advance.

-------------------------------------
h.kawai at ntt.com
-------------------------------------
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev



From rousskov at measurement-factory.com  Thu Jan 14 14:25:10 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 14 Jan 2021 09:25:10 -0500
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
Message-ID: <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>

On 1/13/21 7:47 PM, Hideyuki Kawai wrote:

> 1. "external_acl" can not use on tcp_outgoing_address. Because the
> external_acl type is slow. My understanding is correct?


Yes, your understanding is correct. There are cases where a slow ACL
"usually works" with a tcp_outgoing_address directive due to ACL caching
side effects, and there are many examples on the web abusing those side
effects, but you should not rely on such accidents when using modern
Squid versions.


> 2. If yes, how to solve my requirement?

Use an annotation approach instead. The "note" ACL is fast, and the
external ACL helper can annotate transactions (and connections) in
modern Squids. The only difficulty with this approach is to find a
directive that satisfies all of the conditions below:

1. supports slow ACLs
2. evaluated after the info needed by the external ACL helper is known
3. evaluated before tcp_outgoing_address

In many cases, http_access is such a directive, but YMMV.


HTH,

Alex.
P.S. FWIW, I can agree with one Eliezer statement on this thread: This
thread belongs to squid-users, not squid-dev.

From squid3 at treenet.co.nz  Thu Jan 14 23:16:27 2021
From: squid3 at treenet.co.nz (=?UTF-8?B?4oCqQW1vcyBKZWZmcmllc+KArA==?=)
Date: Fri, 15 Jan 2021 12:16:27 +1300
Subject: [squid-dev] effective acl for tcp_outgoing_address
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>
Message-ID: <5tsuf1-9kt4pz52gjrr-sj1tmc1pseu-y5j9m4cbwm8m92z118-ut4wz8-gx5dqtx5ph6v-arjf4wxynyt4-etg4yder81a6ui0rr8jo4dk-ymhfhr-cp9lbk-rv4elpoi6p8q-ezsi3wkfans197ahu6.1610665970058@email.android.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210115/9d4a870b/attachment.htm>

From h.kawai at ntt.com  Fri Jan 15 00:54:18 2021
From: h.kawai at ntt.com (Hideyuki Kawai)
Date: Fri, 15 Jan 2021 00:54:18 +0000
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <5tsuf1-9kt4pz52gjrr-sj1tmc1pseu-y5j9m4cbwm8m92z118-ut4wz8-gx5dqtx5ph6v-arjf4wxynyt4-etg4yder81a6ui0rr8jo4dk-ymhfhr-cp9lbk-rv4elpoi6p8q-ezsi3wkfans197ahu6.1610665970058@email.android.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>
 <5tsuf1-9kt4pz52gjrr-sj1tmc1pseu-y5j9m4cbwm8m92z118-ut4wz8-gx5dqtx5ph6v-arjf4wxynyt4-etg4yder81a6ui0rr8jo4dk-ymhfhr-cp9lbk-rv4elpoi6p8q-ezsi3wkfans197ahu6.1610665970058@email.android.com>
Message-ID: <OSBPR01MB2776A074F7FBA166AE84C6C6E8A70@OSBPR01MB2776.jpnprd01.prod.outlook.com>

Dear Amos, Alex, Eliezer,

Thank you for your support.
Sorry for my low experience and knowledge…

Your comment is helpful for me, and could you let me know more about "note" ACL.
I can not understand it, even checking the website.

Q1. Could you let me know about “note” ACL?
Q2. If possible, sample config which is using(combined) “ext_kerberos_ldap_group_acl” and “tcp_outgoing_address” and “note ACL”.

Again, thanks for your support.

Best regards,
Kawai

From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of ?Amos Jeffries?
Sent: Friday, January 15, 2021 8:16 AM
To: Alex Rousskov <rousskov at measurement-factory.com>; squid-dev at lists.squid-cache.org
Subject: Re: [squid-dev] effective acl for tcp_outgoing_address

FYI, this use case is why recent versions of kerberos auth helper being used in the OP config produces group= annotations for authenticated users. The note ACL mentioned can check for group SSID any of the fast access checks.

Amos


-------- Original message --------
From: Alex Rousskov <rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>>
Date: Fri, 15 Jan 2021, 03:25
To: squid-dev at lists.squid-cache.org<mailto:squid-dev at lists.squid-cache.org>
Subject: Re: [squid-dev] effective acl for tcp_outgoing_address
On 1/13/21 7:47 PM, Hideyuki Kawai wrote:

> 1. "external_acl" can not use on tcp_outgoing_address. Because the
> external_acl type is slow. My understanding is correct?


Yes, your understanding is correct. There are cases where a slow ACL
"usually works" with a tcp_outgoing_address directive due to ACL caching
side effects, and there are many examples on the web abusing those side
effects, but you should not rely on such accidents when using modern
Squid versions.


> 2. If yes, how to solve my requirement?

Use an annotation approach instead. The "note" ACL is fast, and the
external ACL helper can annotate transactions (and connections) in
modern Squids. The only difficulty with this approach is to find a
directive that satisfies all of the conditions below:

1. supports slow ACLs
2. evaluated after the info needed by the external ACL helper is known
3. evaluated before tcp_outgoing_address

In many cases, http_access is such a directive, but YMMV.


HTH,

Alex.
P.S. FWIW, I can agree with one Eliezer statement on this thread: This
thread belongs to squid-users, not squid-dev.
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org<mailto:squid-dev at lists.squid-cache.org>
http://lists.squid-cache.org/listinfo/squid-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210115/661ddc10/attachment-0001.htm>

From ngtech1ltd at gmail.com  Fri Jan 15 09:08:28 2021
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Fri, 15 Jan 2021 11:08:28 +0200
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <OSBPR01MB2776A074F7FBA166AE84C6C6E8A70@OSBPR01MB2776.jpnprd01.prod.outlook.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>
 <5tsuf1-9kt4pz52gjrr-sj1tmc1pseu-y5j9m4cbwm8m92z118-ut4wz8-gx5dqtx5ph6v-arjf4wxynyt4-etg4yder81a6ui0rr8jo4dk-ymhfhr-cp9lbk-rv4elpoi6p8q-ezsi3wkfans197ahu6.1610665970058@email.android.com>
 <OSBPR01MB2776A074F7FBA166AE84C6C6E8A70@OSBPR01MB2776.jpnprd01.prod.outlook.com>
Message-ID: <CABA8h=SRhAaShavAg3xFVTYLNoD+7NvP563_i_ZpzPQqsVFaWw@mail.gmail.com>

if you will provide a squid.conf we can try to use this and give you an
example.

On Fri, Jan 15, 2021, 02:54 Hideyuki Kawai <h.kawai at ntt.com> wrote:

> Dear Amos, Alex, Eliezer,
>
>
>
> Thank you for your support.
>
> Sorry for my low experience and knowledge…
>
>
>
> Your comment is helpful for me, and could you let me know more about
> "note" ACL.
>
> I can not understand it, even checking the website.
>
>
>
> Q1. Could you let me know about “note” ACL?
>
> Q2. If possible, sample config which is using(combined)
> “ext_kerberos_ldap_group_acl” and “tcp_outgoing_address” and “note ACL”.
>
>
>
> Again, thanks for your support.
>
>
>
> Best regards,
>
> Kawai
>
>
>
> *From:* squid-dev <squid-dev-bounces at lists.squid-cache.org> *On Behalf Of
> *?Amos Jeffries?
> *Sent:* Friday, January 15, 2021 8:16 AM
> *To:* Alex Rousskov <rousskov at measurement-factory.com>;
> squid-dev at lists.squid-cache.org
> *Subject:* Re: [squid-dev] effective acl for tcp_outgoing_address
>
>
>
> FYI, this use case is why recent versions of kerberos auth helper being
> used in the OP config produces group= annotations for authenticated users.
> The note ACL mentioned can check for group SSID any of the fast access
> checks.
>
> Amos
>
>
>
> -------- Original message --------
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Date: Fri, 15 Jan 2021, 03:25
> To: squid-dev at lists.squid-cache.org
> Subject: Re: [squid-dev] effective acl for tcp_outgoing_address
>
> On 1/13/21 7:47 PM, Hideyuki Kawai wrote:
>
> > 1. "external_acl" can not use on tcp_outgoing_address. Because the
> > external_acl type is slow. My understanding is correct?
>
>
> Yes, your understanding is correct. There are cases where a slow ACL
> "usually works" with a tcp_outgoing_address directive due to ACL caching
> side effects, and there are many examples on the web abusing those side
> effects, but you should not rely on such accidents when using modern
> Squid versions.
>
>
> > 2. If yes, how to solve my requirement?
>
> Use an annotation approach instead. The "note" ACL is fast, and the
> external ACL helper can annotate transactions (and connections) in
> modern Squids. The only difficulty with this approach is to find a
> directive that satisfies all of the conditions below:
>
> 1. supports slow ACLs
> 2. evaluated after the info needed by the external ACL helper is known
> 3. evaluated before tcp_outgoing_address
>
> In many cases, http_access is such a directive, but YMMV.
>
>
> HTH,
>
> Alex.
> P.S. FWIW, I can agree with one Eliezer statement on this thread: This
> thread belongs to squid-users, not squid-dev.
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
>
> _______________________________________________
> squid-dev mailing list
> squid-dev at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-dev
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210115/f2b36fce/attachment.htm>

From h.kawai at ntt.com  Wed Jan 20 04:35:56 2021
From: h.kawai at ntt.com (Hideyuki Kawai)
Date: Wed, 20 Jan 2021 04:35:56 +0000
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>
Message-ID: <OSBPR01MB27762FEF08A0BFFADC72518AE8A20@OSBPR01MB2776.jpnprd01.prod.outlook.com>

Dear Mr.Alex,

Thank you very much for your reply.

I have one more question about slow acl type related with tcp_outgoing_address.
(I give up the solution based on "AD security group.)

Then, I would like to map ip address based on username which is required proxy_auth (kerberos).
Because, based on the squid docs (http://www.squid-cache.org/Doc/config/tcp_outgoing_address/), tcp_outgoing_address can map based on "username".
However, such acl types (ident, proxy_auth) are slow type. (http://www.squid-cache.org/Doc/config/acl/)
So, it seems also can not use to cp_outgoing_address.... (I confused.)

Do you have any comment?
If you give some comment my question, it is helpful for my understanding...

====== reference (http://www.squid-cache.org/Doc/config/acl/) ======
	acl aclname ident [-i] username ...
	acl aclname ident_regex [-i] pattern ...
	  # string match on ident output [slow]
	  # use REQUIRED to accept any non-null ident.

	acl aclname proxy_auth [-i] username ...
	acl aclname proxy_auth_regex [-i] pattern ...
	  # perform http authentication challenge to the client and match against
	  # supplied credentials [slow]
	  #
	  # takes a list of allowed usernames.
	  # use REQUIRED to accept any valid username.
	  #
	  # Will use proxy authentication in forward-proxy scenarios, and plain
	  # http authenticaiton in reverse-proxy scenarios
	  #
	  # NOTE: when a Proxy-Authentication header is sent but it is not
	  # needed during ACL checking the username is NOT logged
	  # in access.log.
	  #
	  # NOTE: proxy_auth requires a EXTERNAL authentication program
	  # to check username/password combinations (see
	  # auth_param directive).
	  #
	  # NOTE: proxy_auth can't be used in a transparent/intercepting proxy
	  # as the browser needs to be configured for using a proxy in order
	  # to respond to proxy authentication.
======================

Best regards,
Kawai

-------------------------------------
h.kawai at ntt.com
-------------------------------------

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Thursday, January 14, 2021 11:25 PM
To: squid-dev at lists.squid-cache.org
Cc: Hideyuki Kawai（川井秀行） <h.kawai at ntt.com>
Subject: Re: [squid-dev] effective acl for tcp_outgoing_address

On 1/13/21 7:47 PM, Hideyuki Kawai wrote:

> 1. "external_acl" can not use on tcp_outgoing_address. Because the 
> external_acl type is slow. My understanding is correct?


Yes, your understanding is correct. There are cases where a slow ACL "usually works" with a tcp_outgoing_address directive due to ACL caching side effects, and there are many examples on the web abusing those side effects, but you should not rely on such accidents when using modern Squid versions.


> 2. If yes, how to solve my requirement?

Use an annotation approach instead. The "note" ACL is fast, and the external ACL helper can annotate transactions (and connections) in modern Squids. The only difficulty with this approach is to find a directive that satisfies all of the conditions below:

1. supports slow ACLs
2. evaluated after the info needed by the external ACL helper is known 3. evaluated before tcp_outgoing_address

In many cases, http_access is such a directive, but YMMV.


HTH,

Alex.
P.S. FWIW, I can agree with one Eliezer statement on this thread: This thread belongs to squid-users, not squid-dev.

From rousskov at measurement-factory.com  Wed Jan 20 19:48:17 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 20 Jan 2021 14:48:17 -0500
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <OSBPR01MB27762FEF08A0BFFADC72518AE8A20@OSBPR01MB2776.jpnprd01.prod.outlook.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <c8db3a75-f15f-ae3c-0006-63cb6b2076a9@measurement-factory.com>
 <OSBPR01MB27762FEF08A0BFFADC72518AE8A20@OSBPR01MB2776.jpnprd01.prod.outlook.com>
Message-ID: <6cc3e207-4eb2-e8f0-08df-c78d1147082e@measurement-factory.com>

On 1/19/21 11:35 PM, Hideyuki Kawai wrote:

> I would like to map ip address based on username which is required proxy_auth (kerberos).
> Because, based on the squid docs (http://www.squid-cache.org/Doc/config/tcp_outgoing_address/), tcp_outgoing_address can map based on "username".
> However, such acl types (ident, proxy_auth) are slow type. (http://www.squid-cache.org/Doc/config/acl/)
> So, it seems also can not use to cp_outgoing_address.... (I confused.)

You should be discussing this on squid-users, not squid-dev.


I hear several questions in your email:

Q1: Are ident and proxy_auth ACLs slow?

Answer: They are slow when the transaction first encounters them because
the first encounter triggers various (slow/asynchronous) authentication
procedures.

However, IIRC, these ACLs become fast when the same transaction has been
 successfully authenticated already -- post-authentication, Squid just
needs to check whether the already authenticated user matches the name
in the ACL parameter. That check can be performed instantaneously.

You may see the first authentication-related rule to have a special
REQUIRED keyword instead of a specific user name. Once that rule is
(slowly) evaluated for a transaction, that transaction can treat
specific authentication ACLs as "fast".


Q2: How to use a slow ACL with a directive that only supports fast ACLs?

Answer: Do not use a slow ACL with a directive that only supports fast
ACLs. Instead, use a slow ACL with an earlier directive that supports
slow ACLs _and_ remember the result of that earlier evaluation. The
remember the result of any ACL evaluation, use annotate_transaction or
annotate_client ACLs. To recall the that result, use a note ACL.

Every transaction in Squid goes through a series of directives. In most
cases, if your directive DF cannot handle slow ACLs, there is an earlier
directive DS that can:

  * directive1
  * directive2
  ...
  * http_access
  ...
  * tcp_outgoing_address
  ...
  * directive30
  ...

In many cases, http_access is a directive that is suitable for slow ACL
evaluation. YMMV.


Q3: Would not evaluating an ACL in the "wrong" directive change
transaction processing?

Answer: By itself, ACL evaluation does not trigger directive
application. The directive is applied only if all first-level ACLs in
the directive rule match. If necessary, this can be used to successfully
evaluate an ACL without triggering the directive application.

For example, the following http_access rule will never match, but, if it
is reached (i.e. if http_access is evaluated but all previous rules, if
any, do not match), it will annotate the transaction (or the client) as
transaction (or client) that should be using an specific outgoing address.

  acl userIsBob proxy_auth Bob
  acl markToUseAddressX annotate_client address=x
  http_access deny userIsBob markToUseAddressX !all

  acl markedToUseAddressX note address x
  tcp_outgoing_address x markedToUseAddressX


If you need to do many annotations, then you can either create many
http_access rules or, using basic boolean logic and all-of and any-of
ACLs, it is possible to group all those annotations into one top-level ACL:

  http_access deny annotateAsNeeded !all

Again, nothing is denied here.


HTH,

Alex.



> 
> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Thursday, January 14, 2021 11:25 PM
> To: squid-dev at lists.squid-cache.org
> Cc: Hideyuki Kawai（川井秀行） <h.kawai at ntt.com>
> Subject: Re: [squid-dev] effective acl for tcp_outgoing_address
> 
> On 1/13/21 7:47 PM, Hideyuki Kawai wrote:
> 
>> 1. "external_acl" can not use on tcp_outgoing_address. Because the 
>> external_acl type is slow. My understanding is correct?
> 
> 
> Yes, your understanding is correct. There are cases where a slow ACL "usually works" with a tcp_outgoing_address directive due to ACL caching side effects, and there are many examples on the web abusing those side effects, but you should not rely on such accidents when using modern Squid versions.
> 
> 
>> 2. If yes, how to solve my requirement?
> 
> Use an annotation approach instead. The "note" ACL is fast, and the external ACL helper can annotate transactions (and connections) in modern Squids. The only difficulty with this approach is to find a directive that satisfies all of the conditions below:
> 
> 1. supports slow ACLs
> 2. evaluated after the info needed by the external ACL helper is known 3. evaluated before tcp_outgoing_address
> 
> In many cases, http_access is such a directive, but YMMV.
> 
> 
> HTH,
> 
> Alex.
> P.S. FWIW, I can agree with one Eliezer statement on this thread: This thread belongs to squid-users, not squid-dev.
> 


From ngtech1ltd at gmail.com  Thu Jan 21 08:42:19 2021
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Thu, 21 Jan 2021 10:42:19 +0200
Subject: [squid-dev] effective acl for tcp_outgoing_address
In-Reply-To: <OSBPR01MB2776A52783B597EFDDD39DB5E8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
References: <OSBPR01MB27761737DD693F62BB2EA57AE8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
 <000001d6ea69$76d62660$64827320$@gmail.com>
 <OSBPR01MB2776A52783B597EFDDD39DB5E8A80@OSBPR01MB2776.jpnprd01.prod.outlook.com>
Message-ID: <002801d6efd1$54dfe150$fe9fa3f0$@gmail.com>

Hey,

As Alex gave you the technical details.

At runtime of squid there is a sequence of events and acls validation.
http_access is validated as a slow acl first long before tcp_outgoing_address is happening.
If you will apply a "dummy" rule in the http_access like what Alex has suggested
you would be able to make sure that when the tcp_outgoing_address validation happens
a "pre-cooked"(this is how I call it) or a pre-determined session note will be "sticked" to the session details.

This is a simplified:
https://github.com/elico/vagrant-squid-outgoing-addresses/blob/master/shared/squid.conf#L14

squid.conf which includes the usage of a note from a helper that will always match like "all" should always be true
(which is used in alex example).

Let me know if it still doesn't make sense.

Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: Hideyuki Kawai <h.kawai at ntt.com> 
Sent: Thursday, January 14, 2021 2:22 PM
To: Eliezer Croitoru <ngtech1ltd at gmail.com>
Cc: squid-dev at lists.squid-cache.org
Subject: RE: [squid-dev] effective acl for tcp_outgoing_address

Dear Eliezer

Thank you for your reply.
Could you let me ask you about your comment.

"slow acl" can use in tcp_outgoing_address?

Best regards,
Kawai

-------------------------------------
h.kawai at ntt.com
-------------------------------------
-----Original Message-----
From: Eliezer Croitoru <ngtech1ltd at gmail.com> 
Sent: Thursday, January 14, 2021 8:36 PM
To: Hideyuki Kawai（川井秀行） <h.kawai at ntt.com>
Cc: squid-dev at lists.squid-cache.org
Subject: RE: [squid-dev] effective acl for tcp_outgoing_address

It's more of an users question.

Just to clear it out, the tcp_outgoing_address is a fast acl just when the decision is "required"
You can "pre-cook" the value of a specific note when the connection is only at the first http_access level.
An example for a setup which does probably what you want based on htaccess passwords you can here:
https://github.com/elico/vagrant-squid-outgoing-addresses

It's a vagrant lab which demonstrate this.

Let me know if it helps you or you need clarification.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Zoom: Coming soon


-----Original Message-----
From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of Hideyuki Kawai
Sent: Thursday, January 14, 2021 2:48 AM
To: squid-dev at lists.squid-cache.org
Subject: [squid-dev] effective acl for tcp_outgoing_address

Hi, this is Kawai.

Please let me send inquiry as followings.

### Requirement ###
1. Kerberos auth with Active Directory	: auth_param ..... 	<- Success
2. "Security group" check which is gotten from AD : external_acl_type ...(using ext_kerberos_ldap_group_acl)   <- success
3. Different outgoing IP based on "Security group" : tcp_outgoing_address + external_acl  <- fail

### Inquiry ###
1. "external_acl" can not use on tcp_outgoing_address. Because the external_acl type is slow.
   My understanding is correct?
2. If yes, how to solve my requirement?

Please let me inform your comment and knowledge.
Thanks in advance.

-------------------------------------
h.kawai at ntt.com
-------------------------------------
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-dev



From freekwon at gmail.com  Wed Jan 27 06:53:36 2021
From: freekwon at gmail.com (Hyukin Kwon)
Date: Wed, 27 Jan 2021 15:53:36 +0900
Subject: [squid-dev] About SQUID sizing
Message-ID: <CANLkt_Ls0tBvG=+54dSSz=doTNUpgphGTT85_Q56QREadH237Q@mail.gmail.com>

Hi Squid development team,

I have one quick question about sizing.
Actually, I am trying to install a SQUID proxy for 2,000 users. So, I am
finding out the h/w requirements for that and I am thinking of,
2vCPU and 8GB Mem, 50GB HDD(without Caching function)

Is it reasonable for that?
Any sizing calculation method?

I appreciate your help in advance,

Cheers,
Hugh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210127/debd6157/attachment.htm>

From ngtech1ltd at gmail.com  Wed Jan 27 16:53:05 2021
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Wed, 27 Jan 2021 18:53:05 +0200
Subject: [squid-dev] About SQUID sizing
In-Reply-To: <CANLkt_Ls0tBvG=+54dSSz=doTNUpgphGTT85_Q56QREadH237Q@mail.gmail.com>
References: <CANLkt_Ls0tBvG=+54dSSz=doTNUpgphGTT85_Q56QREadH237Q@mail.gmail.com>
Message-ID: <000401d6f4cc$e3a78280$aaf68780$@gmail.com>

Hey,

 

This post is more of a Squid-Users question rather then squid-dev  to my understanding.

 

The technical way to look at it is not the sum of “global” users but rather their load on the system.

For 2k users you are better with more CPU ie 4+ vCPU and the 8GB RAM can be enough for many use cases.

The best way to start with this is capturing some data/stats on the network/fw level.

You can start with the exact system ie 4vCPU 8GB ram only as a router\firewall.

Then collect some details on the actual connections that are being used in the network.

I can recommend on Prometheus which I have used to get some nice graphs on systems.

There are ways to use Prometheus to graph Linux iptables/nftables/kernel conntrack which
is what I believe you should start from.

After you will have at-least a week of this stats you might be able to start and calculate more things.

 

Amos or Alex might know by heart what is the calculation that was mentioned here many times
regarding the amount of ram allocated per connection/request/session.

 

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:ngtech1ltd at gmail.com> ngtech1ltd at gmail.com

Zoom: Coming soon

 

 

From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of Hyukin Kwon
Sent: Wednesday, January 27, 2021 8:54 AM
To: squid-dev at lists.squid-cache.org
Subject: [squid-dev] About SQUID sizing

 

Hi Squid development team,

 

I have one quick question about sizing.

Actually, I am trying to install a SQUID proxy for 2,000 users. So, I am finding out the h/w requirements for that and I am thinking of,

2vCPU and 8GB Mem, 50GB HDD(without Caching function)

 

Is it reasonable for that?

Any sizing calculation method?

 

I appreciate your help in advance,

 

Cheers,

Hugh

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210127/b0a7e2ca/attachment.htm>

