<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] effective acl for tcp_outgoing_address
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20effective%20acl%20for%20tcp_outgoing_address&In-Reply-To=%3C6cc3e207-4eb2-e8f0-08df-c78d1147082e%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009642.html">
   <LINK REL="Next"  HREF="009645.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] effective acl for tcp_outgoing_address</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20effective%20acl%20for%20tcp_outgoing_address&In-Reply-To=%3C6cc3e207-4eb2-e8f0-08df-c78d1147082e%40measurement-factory.com%3E"
       TITLE="[squid-dev] effective acl for tcp_outgoing_address">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jan 20 19:48:17 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009642.html">[squid-dev] effective acl for tcp_outgoing_address
</A></li>
        <LI>Next message (by thread): <A HREF="009645.html">[squid-dev] About SQUID sizing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9643">[ date ]</a>
              <a href="thread.html#9643">[ thread ]</a>
              <a href="subject.html#9643">[ subject ]</a>
              <a href="author.html#9643">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/19/21 11:35 PM, Hideyuki Kawai wrote:

&gt;<i> I would like to map ip address based on username which is required proxy_auth (kerberos).
</I>&gt;<i> Because, based on the squid docs (<A HREF="http://www.squid-cache.org/Doc/config/tcp_outgoing_address/">http://www.squid-cache.org/Doc/config/tcp_outgoing_address/</A>), tcp_outgoing_address can map based on &quot;username&quot;.
</I>&gt;<i> However, such acl types (ident, proxy_auth) are slow type. (<A HREF="http://www.squid-cache.org/Doc/config/acl/">http://www.squid-cache.org/Doc/config/acl/</A>)
</I>&gt;<i> So, it seems also can not use to cp_outgoing_address.... (I confused.)
</I>
You should be discussing this on squid-users, not squid-dev.


I hear several questions in your email:

Q1: Are ident and proxy_auth ACLs slow?

Answer: They are slow when the transaction first encounters them because
the first encounter triggers various (slow/asynchronous) authentication
procedures.

However, IIRC, these ACLs become fast when the same transaction has been
 successfully authenticated already -- post-authentication, Squid just
needs to check whether the already authenticated user matches the name
in the ACL parameter. That check can be performed instantaneously.

You may see the first authentication-related rule to have a special
REQUIRED keyword instead of a specific user name. Once that rule is
(slowly) evaluated for a transaction, that transaction can treat
specific authentication ACLs as &quot;fast&quot;.


Q2: How to use a slow ACL with a directive that only supports fast ACLs?

Answer: Do not use a slow ACL with a directive that only supports fast
ACLs. Instead, use a slow ACL with an earlier directive that supports
slow ACLs _and_ remember the result of that earlier evaluation. The
remember the result of any ACL evaluation, use annotate_transaction or
annotate_client ACLs. To recall the that result, use a note ACL.

Every transaction in Squid goes through a series of directives. In most
cases, if your directive DF cannot handle slow ACLs, there is an earlier
directive DS that can:

  * directive1
  * directive2
  ...
  * http_access
  ...
  * tcp_outgoing_address
  ...
  * directive30
  ...

In many cases, http_access is a directive that is suitable for slow ACL
evaluation. YMMV.


Q3: Would not evaluating an ACL in the &quot;wrong&quot; directive change
transaction processing?

Answer: By itself, ACL evaluation does not trigger directive
application. The directive is applied only if all first-level ACLs in
the directive rule match. If necessary, this can be used to successfully
evaluate an ACL without triggering the directive application.

For example, the following http_access rule will never match, but, if it
is reached (i.e. if http_access is evaluated but all previous rules, if
any, do not match), it will annotate the transaction (or the client) as
transaction (or client) that should be using an specific outgoing address.

  acl userIsBob proxy_auth Bob
  acl markToUseAddressX annotate_client address=x
  http_access deny userIsBob markToUseAddressX !all

  acl markedToUseAddressX note address x
  tcp_outgoing_address x markedToUseAddressX


If you need to do many annotations, then you can either create many
http_access rules or, using basic boolean logic and all-of and any-of
ACLs, it is possible to group all those annotations into one top-level ACL:

  http_access deny annotateAsNeeded !all

Again, nothing is denied here.


HTH,

Alex.



&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; 
</I>&gt;<i> Sent: Thursday, January 14, 2021 11:25 PM
</I>&gt;<i> To: <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Hideyuki Kawai（川井秀行） &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">h.kawai at ntt.com</A>&gt;
</I>&gt;<i> Subject: Re: [squid-dev] effective acl for tcp_outgoing_address
</I>&gt;<i> 
</I>&gt;<i> On 1/13/21 7:47 PM, Hideyuki Kawai wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> 1. &quot;external_acl&quot; can not use on tcp_outgoing_address. Because the 
</I>&gt;&gt;<i> external_acl type is slow. My understanding is correct?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Yes, your understanding is correct. There are cases where a slow ACL &quot;usually works&quot; with a tcp_outgoing_address directive due to ACL caching side effects, and there are many examples on the web abusing those side effects, but you should not rely on such accidents when using modern Squid versions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 2. If yes, how to solve my requirement?
</I>&gt;<i> 
</I>&gt;<i> Use an annotation approach instead. The &quot;note&quot; ACL is fast, and the external ACL helper can annotate transactions (and connections) in modern Squids. The only difficulty with this approach is to find a directive that satisfies all of the conditions below:
</I>&gt;<i> 
</I>&gt;<i> 1. supports slow ACLs
</I>&gt;<i> 2. evaluated after the info needed by the external ACL helper is known 3. evaluated before tcp_outgoing_address
</I>&gt;<i> 
</I>&gt;<i> In many cases, http_access is such a directive, but YMMV.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> P.S. FWIW, I can agree with one Eliezer statement on this thread: This thread belongs to squid-users, not squid-dev.
</I>&gt;<i> 
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009642.html">[squid-dev] effective acl for tcp_outgoing_address
</A></li>
	<LI>Next message (by thread): <A HREF="009645.html">[squid-dev] About SQUID sizing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9643">[ date ]</a>
              <a href="thread.html#9643">[ thread ]</a>
              <a href="subject.html#9643">[ subject ]</a>
              <a href="author.html#9643">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
