<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Strategy about build farm nodes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3Ca5e9410f-b6e9-0ecd-f83a-e2ba44f7b73a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009673.html">
   <LINK REL="Next"  HREF="009675.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Strategy about build farm nodes</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3Ca5e9410f-b6e9-0ecd-f83a-e2ba44f7b73a%40treenet.co.nz%3E"
       TITLE="[squid-dev] Strategy about build farm nodes">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun May 16 07:31:45 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009673.html">[squid-dev] Strategy about build farm nodes
</A></li>
        <LI>Next message (by thread): <A HREF="009675.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9674">[ date ]</a>
              <a href="thread.html#9674">[ thread ]</a>
              <a href="subject.html#9674">[ subject ]</a>
              <a href="author.html#9674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/05/21 2:29 am, Alex Rousskov wrote:
&gt;<i> On 5/3/21 12:41 AM, Francesco Chemolli wrote:
</I>&gt;&gt;<i> - we want our QA environment to match what users will use. For this
</I>&gt;&gt;<i> reason, it is not sensible that we just stop upgrading our QA nodes,
</I>&gt;<i> 
</I>&gt;<i> I see flaws in reasoning, but I do agree with the conclusion -- yes, we
</I>&gt;<i> should upgrade QA nodes. Nobody has proposed a ban on upgrades AFAICT!
</I>&gt;<i> 
</I>&gt;<i> The principles I have proposed allow upgrades that do not violate key
</I>&gt;<i> invariants. For example, if a proposed upgrade would break master, then
</I>&gt;<i> master has to be changed _before_ that upgrade actually happens, not
</I>&gt;<i> after. Upgrades must not break master.
</I>
So ... a node is added/upgraded. It runs and builds master fine. Then 
added to the matrices some of the PRs start failing.

*THAT* is the situation I see happening recently. Master itself working 
fine and &quot;huge amounts of pain, the sky is falling&quot; complaints from a 
couple of people.

Sky is not falling. Master is no more nor less broken and buggy than it 
was before sysadmin touched Jenkins.

The PR itself is no more, nor less, &quot;broken&quot; than it would be if for 
example - it was only tested on Linux nodes and fails to compile on 
Windows. As the case for master *right now* happens to be.


&gt;<i> 
</I>&gt;<i> What this means in terms of sysadmin steps for doing upgrades is up to
</I>&gt;<i> you. You are doing the hard work here, so you can optimize it the way
</I>&gt;<i> that works best for _you_. If really necessary, I would not even object
</I>&gt;<i> to trial upgrades (that may break master for an hour or two) as long as
</I>&gt;<i> you monitor the results and undo the breaking changes quickly and
</I>&gt;<i> proactively (without relying on my pleas to fix Jenkins to detect
</I>&gt;<i> breakages). I do not know what is feasible and what the best options
</I>&gt;<i> are, but, again, it is up to _you_ how to optimize this (while observing
</I>&gt;<i> the invariants).
</I>&gt;<i> 
</I>
Uhm. Respectfully, from my perspective the above paragraph conflicts 
directly with actions taken.

 From what I can tell kinkie (as sysadmin) *has* been making a new node 
and testing it first. Not just against master but the main branches and 
most active PRs before adding it for the *post-merge* matrix testing 
snapshot production.

   But still threads like this one with complaints appear.



I understand there is some specific pain you have encountered to trigger 
the complaint. Can we get down to documenting as exactly as possible 
what the particular pain was?

  Much of the processes we are discussing are scripted automation not 
human processing mistakes. Handling such pain points as bugs with 
bugzilla &quot;Project&quot; section would be best. Re-designing the entire system 
policy just moves us all to another set of unknown bugs when the scripts 
are re-coded to meet that policy.


&gt;<i> 
</I>&gt;&gt;<i> - I believe we should define four tiers of runtime environments, and
</I>&gt;&gt;<i> reflect these in our test setup:
</I>&gt;<i> 
</I>&gt;&gt;<i>   1. current and stable (e.g. ubuntu-latest-lts).
</I>&gt;&gt;<i>   2. current (e.g. fedora 34)
</I>&gt;&gt;<i>   3. bleeding edge
</I>&gt;&gt;<i>   4. everything else - this includes freebsd and openbsd
</I>&gt;<i> 
</I>&gt;<i> I doubt this classification is important to anybody _outside_ this
</I>&gt;<i> discussion, so I am OK with whatever classification you propose to
</I>&gt;<i> satisfy your internal needs.
</I>&gt;<i> 
</I>
IIRC this is the 5th iteration of ground-up redesign for this wheel.

Test designs that do not fit into our merge and release process sequence 
have proven time and again to be broken and painful to Alex when they 
operate as-designed. For the rest of us it is this constant re-build of 
automation which is the painful part.


A. dev pre-PR testing
    - random individual OS.
    - matrix of everything (anybranch-*-matrix)

B. PR submission testing
    - which OS for master (5-pr-test) ?
    - which OS for beta (5-pr-test) ?
    - which OS for stable (5-pr-test) ?

Are all of those sets the same identical OS+compilers? no.
Why are they forced to be the same matrix test?
   IIRC, policy forced on sysadmin with previous pain complaints.

Are we getting painful experiences from this?
   Yes. Lack of branch-specific testing before D on beta and stable 
causes those branches to break a lot more often at last-minute before 
releases than master. Adding random days/weeks to each scheduled release.


C. merge testing
    - which OS for master (5-pr-auto) ?
    - which OS for beta (5-pr-auto) ?
    - which OS for stable (5-pr-auto) ?
      NP: maintainer does manual override on beta/stable merges.

Are all of those sets the same identical OS+compilers? no.
   Why are they forced to be the same matrix test? Anubis

Are we getting painful experiences from this? yes. see (B).


D. pre-release testing (snapshots + formal)
    - which OS for master (trunk-matrix) ?
    - which OS for beta (5-matrix) ?
    - which OS for stable (4-matrix) ?

Are all of those sets the same identical OS+compilers? no.
Are we forcing them to use the same matrix test? no.
Are we getting painful experiences from this? maybe.
   Most loud complaints have been about &quot;breaking master&quot; which is the 
most volatile branch testing on the most volatile OS.



FTR: the reason all those matrices have '5-' prefix is because several 
redesigns ago the system was that master/trunk had a matrix which the 
sysadmin added nodes to as OS upgraded. During branching vN the 
maintainer would clone/freeze that matrix into an N-foo which would be 
used to test the code against OS+compilers which the code in the vN 
branch was designed to build on.


Can we have the people claiming pain specify exactly what the pain is 
coming from, and let the sysadmin/developer(s) with specialized 
knowledge of the automation in that area decide how best to fix it?


&gt;<i> 
</I>&gt;&gt;<i> I believe we should focus on the first two tiers for our merge workflow,
</I>&gt;&gt;<i> but then expect devs to fix any breakages in the third and fourth tiers
</I>&gt;&gt;<i> if caused by their PR,
</I>&gt;<i> 
</I>&gt;<i> FWIW, I do not understand what &quot;focus&quot; implies in this statement, and
</I>&gt;<i> why developers should _not_ &quot;fix any breakages&quot; revealed by the tests in
</I>&gt;<i> the first two tiers.
</I>&gt;<i> 
</I>&gt;<i> The rules I have in mind use two natural tiers:
</I>&gt;<i> 
</I>&gt;<i> * If a PR cannot pass a required CI test, that PR has to change before
</I>&gt;<i> it can be merged.
</I>&gt;<i> 
</I>&gt;<i> * If a PR cannot pass an optional CI test, it is up to PR author and
</I>&gt;<i> reviewers to decide what to do next.
</I>
That is already the case. Already well documented and understood.

I see no need to change anything based on those criteria. Ergo you have 
some undeclared criteria leading to whatever pain triggered this 
discussion. Maybe the pain is some specific bug that does not need a 
whole discussion and re-design by committee?


&gt;<i> 
</I>&gt;<i> These are very simple rules that do not require developer knowledge of
</I>&gt;<i> any complex test node tiers that we might define/use internally.
</I>&gt;<i> 
</I>
This is the first I've heard about dev having to have such knowledge. 
Maybe because they are already *how we do things*. Red-herring argument?


&gt;<i> Needless to say, the rules assume that the tests themselves are correct.
</I>&gt;<i> If not, the broken tests need to be fixed (by the Squid Project) before
</I>&gt;<i> the first bullet/rule above can be meaningfully applied (the second one
</I>&gt;<i> is flexible enough to allow PR author and reviewers to ignore optional
</I>&gt;<i> test failures).
</I>&gt;<i> 
</I>
There is a hidden assumption here too. About the test being applied 
correctly.

I posit that is the real bug we need to sort out. We could keep on 
&quot;correcting&quot; the node sets (aka tests) back and forward between being 
suitable for master or suitable for release branches. That just shuffles 
the pain from one end of the system to the other.

Make Anubis and Jenkins use different matrix for each branch at the B 
and C process stages above. Only then will discussion of what nodes to 
add to what test/matrix actually make progress.



&gt;<i> 
</I>&gt;&gt;<i> Breakages due to changes in nodes (e.g. introducing a new distro
</I>&gt;&gt;<i> version) would be on me and would not stop the merge workflow.
</I>&gt;<i> 
</I>&gt;<i> What you do internally to _avoid_ breakage is up to you, but the primary
</I>&gt;<i> goal is to _prevent_ CI breakage (rather than to keep CI nodes &quot;up to
</I>&gt;<i> date&quot;!).
</I>
The principle (&quot;invariant&quot; in Alex terminology?) with nodes is that they 
represent the OS environment a typical developer can be assumed to be 
running on that OS version+compiler combination.

Distros release security updates to their &quot;stable&quot; versions. Therefore 
to stay true to the goal we require constant small upgrades as an 
ongoing part of sysadmin maintenance.

Adding new nodes with next distro release versions is a manual process 
not related to keeping existing nodes up to date (which is automated?).

 From time to time distros break their own ability to compile things. 
This is to be expected on distros with rolling release and ironically 
LTS release (which get *less* testing of updates than normal releases).
It does not indicate &quot;broken master&quot; nor &quot;broken CI&quot; in any way.


&gt;<i> 
</I>&gt;<i> There are many ways to break CI and detect those breakages, of course,
</I>&gt;<i> but if master cannot pass required tests after a CI change, then the
</I>&gt;<i> change broke CI.
</I>
I have yet to see the code in master be corrupted by CI changes in such 
a way that it could not build on peoples development machines.

What we do have going on is network timeouts, DNS resolution, CPU wait 
timeouts, and rarely _automated_ CI upgrades all causing short-term 
failure to pass a test.

A PR fixing newly highlighted bugs gets around the latter. Any pain (eg 
master blocked for 2 days waiting on the fix PR to merge) is a normal 
problem with that QA process and should not be attributed to the CI change.


&gt;<i> 
</I>&gt;&gt;<i> What I would place on each individual dev is the case where a PR breaks
</I>&gt;&gt;<i> something in the trunk-matrix,trunk-arm32-matrix, trunk-arm64-matrix,
</I>&gt;&gt;<i> trunk-openbsd-matrix, trunk-freebsd-matrix builds, even if the 5-pr-test
</I>&gt;&gt;<i> and 5-pr-auto builds fail to detect the breakage because it happens on a
</I>&gt;&gt;<i> unstable or old platform. &gt;
</I>&gt;<i> This feels a bit out of topic for me, but I think you are saying that
</I>&gt;<i> some CI tests called trunk-matrix, trunk-arm32-matrix,
</I>&gt;<i> trunk-arm64-matrix, trunk-openbsd-matrix, trunk-freebsd-matrix should be
</I>&gt;<i> classified as _required_.
</I>
That is how I read the statement too.

&gt;<i> In other words, a PR must pass those CI tests
</I>&gt;<i> before it can be merged. Is that the situation today? Or are you
</I>&gt;<i> proposing some changes to the list of required CI tests? What are those
</I>&gt;<i> changes?
</I>&gt;<i> 
</I>
No, situation today is that those matrix are new ones only recently 
created by sysadmin and not used for any of the merge or release process 
criteria. The BSD though were once checked in the general 5-pr-test 
required for PR testing.


IMO, it's a good point. We do need to stop the practice of just dropping 
support for any OS where attempting to build finds existing bugs in 
master (aka &quot;breaks master, sky falling&quot;). More focus on fixing those 
bugs to increase portability and grow the Squid community beyond the 
subset of RHEL and Ubuntu users.


Amos
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009673.html">[squid-dev] Strategy about build farm nodes
</A></li>
	<LI>Next message (by thread): <A HREF="009675.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9674">[ date ]</a>
              <a href="thread.html#9674">[ thread ]</a>
              <a href="subject.html#9674">[ subject ]</a>
              <a href="author.html#9674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
