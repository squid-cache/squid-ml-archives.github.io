<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Strategy about build farm nodes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3C5d1ec3b0-f266-8397-4766-69269670d21b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009674.html">
   <LINK REL="Next"  HREF="009676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Strategy about build farm nodes</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3C5d1ec3b0-f266-8397-4766-69269670d21b%40measurement-factory.com%3E"
       TITLE="[squid-dev] Strategy about build farm nodes">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun May 16 23:56:01 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009674.html">[squid-dev] Strategy about build farm nodes
</A></li>
        <LI>Next message (by thread): <A HREF="009676.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9675">[ date ]</a>
              <a href="thread.html#9675">[ thread ]</a>
              <a href="subject.html#9675">[ subject ]</a>
              <a href="author.html#9675">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/16/21 3:31 AM, Amos Jeffries wrote:
&gt;<i> On 4/05/21 2:29 am, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 5/3/21 12:41 AM, Francesco Chemolli wrote:
</I>&gt;&gt;&gt;<i> - we want our QA environment to match what users will use. For this
</I>&gt;&gt;&gt;<i> reason, it is not sensible that we just stop upgrading our QA nodes,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I see flaws in reasoning, but I do agree with the conclusion -- yes, we
</I>&gt;&gt;<i> should upgrade QA nodes. Nobody has proposed a ban on upgrades AFAICT!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The principles I have proposed allow upgrades that do not violate key
</I>&gt;&gt;<i> invariants. For example, if a proposed upgrade would break master, then
</I>&gt;&gt;<i> master has to be changed _before_ that upgrade actually happens, not
</I>&gt;&gt;<i> after. Upgrades must not break master.
</I>&gt;<i> 
</I>&gt;<i> So ... a node is added/upgraded. It runs and builds master fine. Then
</I>&gt;<i> added to the matrices some of the PRs start failing.
</I>
It is easy to misunderstand what is going on because there is no good
visualization of complex PR-master-Jenkins_nodes-Jenkins_failures
relationships. Several kinds of PR test failures are possible. I will
describe the two most relevant to your email:

* PR test failures due to problems introduced by PRs should be welcomed
at any time. CI improvements are allowed to find new bugs in open PRs.
Such findings, even when discovered at the &quot;last minute&quot;, should be seen
as an overall positive event or progress -- our CI was able to identify
a problem before it got officially accepted! I do not recall anybody
complaining about such failures recently.

* PR test failures due to the existing master code are not welcomed.
They represent a CI failure. In these cases, if the latest master code
is tested with the same test after the problematic CI change, then that
master test will fail. Nothing a PR can do in this situation can fix
this kind of failure because it is not PR changes that are causing the
failure -- CI changes broke the master branch, not just the PR! This
kind of failures are the responsibility of CI administrators, and PR
authors should complain about them, especially when there are no signs
of CI administrators aware of and working on addressing the problem.

A good example of a failure of the second kind a -Wrange-loop-construct
error in a PR that does not touch any range loops (Jenkins conveniently
deleted the actual failed test, but my GitHub comment and PR contents
may be enough to restore what happened):
<A HREF="https://github.com/squid-cache/squid/pull/806#issuecomment-827924821">https://github.com/squid-cache/squid/pull/806#issuecomment-827924821</A>


[I am skipping the exaggerations (about other people exaggerations) that
were, AFAICT, driven by mis-classifying the failures of the second kind
as regular PR failures of the first kind.]


&gt;&gt;<i> What this means in terms of sysadmin steps for doing upgrades is up to
</I>&gt;&gt;<i> you. You are doing the hard work here, so you can optimize it the way
</I>&gt;&gt;<i> that works best for _you_. If really necessary, I would not even object
</I>&gt;&gt;<i> to trial upgrades (that may break master for an hour or two) as long as
</I>&gt;&gt;<i> you monitor the results and undo the breaking changes quickly and
</I>&gt;&gt;<i> proactively (without relying on my pleas to fix Jenkins to detect
</I>&gt;&gt;<i> breakages). I do not know what is feasible and what the best options
</I>&gt;&gt;<i> are, but, again, it is up to _you_ how to optimize this (while observing
</I>&gt;&gt;<i> the invariants).
</I>

&gt;<i> Uhm. Respectfully, from my perspective the above paragraph conflicts
</I>&gt;<i> directly with actions taken.
</I>
My paragraph is not really about any taken actions so there cannot be
any such conflict AFAICT.


&gt;<i> From what I can tell kinkie (as sysadmin) *has* been making a new node
</I>&gt;<i> and testing it first. Not just against master but the main branches and
</I>&gt;<i> most active PRs before adding it for the *post-merge* matrix testing
</I>&gt;<i> snapshot production.
</I>
The above summary does not match the (second kind of) PR test failures
that I have observed and asked Francesco to address. Those failures were
triggered by the latest master code, not PR changes. No PR changes would
have fixed those test failures. In fact, an &quot;empty&quot; PR that introduces
no code changes at all would have failed as well. See above for one
recent example.


&gt;<i>   But still threads like this one with complaints appear.
</I>
This squid-dev thread did not contain any complaints AFAICT. Francesco
is trying to get consensus on how to handle CI upgrades/changes. He is
doing the right thing and nobody is complaining about it.


&gt;<i> I understand there is some specific pain you have encountered to trigger
</I>&gt;<i> the complaint. Can we get down to documenting as exactly as possible
</I>&gt;<i> what the particular pain was?
</I>
Well, I apparently do not know what you call &quot;complaint&quot;, so I cannot
answer this exact question, but if you are looking for a recent PR test
failure that triggered this squid-dev thread, then please see the GitHub
link above.



&gt;<i> Test designs that do not fit into our merge and release process sequence
</I>&gt;<i> have proven time and again to be broken and painful to Alex when they
</I>&gt;<i> operate as-designed. For the rest of us it is this constant re-build of
</I>&gt;<i> automation which is the painful part.
</I>
While I am not sure what you are talking about specifically, I think
that any design that causes pain should be changed. Your phrasing
suggests some dissatisfaction with that natural (IMO) expectation, so I
am probably missing something. Please rephrase if this is important.


&gt;<i> B. PR submission testing
</I>&gt;<i>    - which OS for master (5-pr-test) ?
</I>&gt;<i>    - which OS for beta (5-pr-test) ?
</I>&gt;<i>    - which OS for stable (5-pr-test) ?
</I>&gt;<i> 
</I>&gt;<i> Are all of those sets the same identical OS+compilers? no.
</I>&gt;<i> Why are they forced to be the same matrix test?
</I>
I do not understand the question. Are you asking why Jenkins uses the
same 5-pr-test configuration for all three branches (master, beta, _and_
stable)? I do not know the answer.


&gt;<i> IIRC, policy forced on sysadmin with previous pain complaints.
</I>
Complaints, even legitimate ones, should not shape a policy. Goals and
principles should do that.

I remember one possibly related discussion where we were trying to
reduce Jenkins/PR wait times by changing which tests are run at what PR
merging stages, but that is probably a different issue because your
question appears to be about a single merging stage.


&gt;<i> C. merge testing
</I>&gt;<i>    - which OS for master (5-pr-auto) ?
</I>&gt;<i>    - which OS for beta (5-pr-auto) ?
</I>&gt;<i>    - which OS for stable (5-pr-auto) ?
</I>&gt;<i>      NP: maintainer does manual override on beta/stable merges.
</I>&gt;<i> 
</I>&gt;<i> Are all of those sets the same identical OS+compilers? no.
</I>&gt;<i>   Why are they forced to be the same matrix test? Anubis
</I>
This is too cryptic for me to understand, but Anubis does not force any
tests on anybody -- it simply checks that the required tests have
passed. I am not aware of any Anubis bugs in this area, but please
correct me if I am wrong.


&gt;<i> D. pre-release testing (snapshots + formal)
</I>&gt;<i>    - which OS for master (trunk-matrix) ?
</I>&gt;<i>    - which OS for beta (5-matrix) ?
</I>&gt;<i>    - which OS for stable (4-matrix) ?
</I>&gt;<i> 
</I>&gt;<i> Are all of those sets the same identical OS+compilers? no.
</I>&gt;<i> Are we forcing them to use the same matrix test? no.
</I>&gt;<i> Are we getting painful experiences from this? maybe.
</I>&gt;<i>   Most loud complaints have been about &quot;breaking master&quot; which is the
</I>&gt;<i> most volatile branch testing on the most volatile OS.
</I>
FWIW, I think you misunderstood what those &quot;complaints&quot; where about. I
do not know how that relates to the above questions/answers though.


&gt;<i> FTR: the reason all those matrices have '5-' prefix is because several
</I>&gt;<i> redesigns ago the system was that master/trunk had a matrix which the
</I>&gt;<i> sysadmin added nodes to as OS upgraded. During branching vN the
</I>&gt;<i> maintainer would clone/freeze that matrix into an N-foo which would be
</I>&gt;<i> used to test the code against OS+compilers which the code in the vN
</I>&gt;<i> branch was designed to build on.
</I>
I think the above description implies that some time ago we were (more)
careful about (not) adding new nodes when testing stable branches. We
did not want a CI change to break a stable branch. That sounds like the
right principle to me (and it should apply to beta and master as well).
How that specific principle is accomplished is not important (to me) so
CI admins should propose whatever technique they think is best.


&gt;<i> Can we have the people claiming pain specify exactly what the pain is
</I>&gt;<i> coming from, and let the sysadmin/developer(s) with specialized
</I>&gt;<i> knowledge of the automation in that area decide how best to fix it?
</I>
We can, and that is exactly what is going on in this thread AFAICT. This
particular thread was caused by CI changes breaking master, and
Francesco was discussing how to avoid such breakages in the future.

There are other goals/principles to observe, of course, and it is
possible that Francesco is proposing more changes to optimize something
else as well, but that is something only he can clarify (if needed).

AFAICT, Francesco and I are on the same page regarding not breaking
master anymore -- he graciously agreed to prevent such breakages in the
future, and I am very thankful that he did. Based on your comments
discussing several cases where such master breakage is, in your opinion,
OK, you currently disagree with that principle. I do not know why.


&gt;&gt;<i> I believe we should focus on the first two tiers for our merge workflow,
</I>&gt;&gt;<i> but then expect devs to fix any breakages in the third and fourth tiers
</I>&gt;&gt;<i> if caused by their PR, 
</I>
&gt;&gt;<i> The rules I have in mind use two natural tiers:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * If a PR cannot pass a required CI test, that PR has to change before
</I>&gt;&gt;<i> it can be merged.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * If a PR cannot pass an optional CI test, it is up to PR author and
</I>&gt;&gt;<i> reviewers to decide what to do next.
</I>

&gt;<i> That is already the case. Already well documented and understood.
</I>
&gt;<i> I see no need to change anything based on those criteria. 
</I>
I hope so! I stated those rules in direct response to, what seemed to me
like, a far more complex 4-tier proposal by Francesco. I did not state
them to change some Project policy. I state them in hope to understand
(and/or simplify) his proposal.


&gt;&gt;<i> These are very simple rules that do not require developer knowledge of
</I>&gt;&gt;<i> any complex test node tiers that we might define/use internally.
</I>
&gt;<i> This is the first I've heard about dev having to have such knowledge.
</I>
Perhaps you interpreted the email I was replying to differently than I
did. I hope the above paragraph clarifies the situation.


&gt;&gt;<i> Needless to say, the rules assume that the tests themselves are correct.
</I>&gt;&gt;<i> If not, the broken tests need to be fixed (by the Squid Project) before
</I>&gt;&gt;<i> the first bullet/rule above can be meaningfully applied (the second one
</I>&gt;&gt;<i> is flexible enough to allow PR author and reviewers to ignore optional
</I>&gt;&gt;<i> test failures).
</I>
&gt;<i> There is a hidden assumption here too. About the test being applied
</I>&gt;<i> correctly.
</I>
For me, test application (i.e. what tests are applied to what software)
correctness is a part of the overall tests correctness (which naturally
has many components). From that point of view, there is no hidden
assumption here.


&gt;<i> I posit that is the real bug we need to sort out. We could keep on
</I>&gt;<i> &quot;correcting&quot; the node sets (aka tests) back and forward between being
</I>&gt;<i> suitable for master or suitable for release branches. That just shuffles
</I>&gt;<i> the pain from one end of the system to the other.
</I>
&gt;<i> Make Anubis and Jenkins use different matrix for each branch at the B
</I>&gt;<i> and C process stages above. Only then will discussion of what nodes to
</I>&gt;<i> add to what test/matrix actually make progress.
</I>
Anubis is pretty much a red herring here AFAICT -- IIRC, Anubis just
checks that enough required tests have passed. The test results are
supplied by Jenkins and Semaphore CI.

If you think that each target branch should have its own set of Jenkins
tests for a staged commit, then I see no problem with that per se. You
or Francesco should configure GitHub and Jenkins accordingly.

I recommend grouping all those tests under one name (that single name
can be unique to each target branch), so that Anubis can be told how
many tests to expect using a single number (rather than many
branch-specific settings). If that grouping becomes a serious problem,
we can change Anubis to support a different number of tests for
different target branches.


&gt;<i> The principle (&quot;invariant&quot; in Alex terminology?) with nodes is that they
</I>&gt;<i> represent the OS environment a typical developer can be assumed to be
</I>&gt;<i> running on that OS version+compiler combination.
</I>
FWIW, that principle or invariant (I often use those two words
interchangeably) feels a bit unfortunate to me: Given scarce resources,
our CI tests should not target Squid developers. They should target
typical Squid _deployments_ instead. Fortunately, the difference is
often minor.


&gt;<i> Distros release security updates to their &quot;stable&quot; versions. Therefore
</I>&gt;<i> to stay true to the goal we require constant small upgrades as an
</I>&gt;<i> ongoing part of sysadmin maintenance.
</I>
Yes, I think we are all in agreement that nodes should be upgraded.
Deployments often do not upgrade their OSes as often as distros do, even
for &quot;security&quot; reasons, but we have to pick the lesser of two evils and
upgrade as often as we can (correctly).

The only possible disagreement that I know of is about _prerequisites_
for an upgrade, as revisited below.


&gt;<i> Adding new nodes with next distro release versions is a manual process
</I>&gt;<i> not related to keeping existing nodes up to date (which is automated?).
</I>
Sure. And new nodes should not be added if that addition breaks master.


&gt;<i> From time to time distros break their own ability to compile things.
</I>&gt;<i> It does not indicate &quot;broken master&quot; nor &quot;broken CI&quot; in any way.
</I>
Distro changes cannot indicate &quot;broken master&quot; or &quot;broken CI&quot; _until_ we
actually apply them to our CI nodes. If upgrading a node would break or
broke master (as already defined many times), then that upgrade should
not be done or should be undone (until the master is changed to allow
the upgrade to proceed). Keeping master tests successful is a key
upgrade precondition IMO.


&gt;&gt;<i> There are many ways to break CI and detect those breakages, of course,
</I>&gt;&gt;<i> but if master cannot pass required tests after a CI change, then the
</I>&gt;&gt;<i> change broke CI.
</I>
&gt;<i> I have yet to see the code in master be corrupted by CI changes in such
</I>&gt;<i> a way that it could not build on peoples development machines.
</I>
FWIW, I do not see how the above assertion (or anything about peoples
development machines) is relevant to this discussion about Project CI
and the official merge process.


&gt;<i> What we do have going on is network timeouts, DNS resolution, CPU wait
</I>&gt;<i> timeouts, and rarely _automated_ CI upgrades all causing short-term
</I>&gt;<i> failure to pass a test.
</I>
Intermittent failures (DNS and such) are out of scope here.

CI upgrades, automated or not, should not break master. If they
accidentally do, they should be reverted. If reversal is not possible,
they should not be attempted in the first place.


&gt;<i> A PR fixing newly highlighted bugs gets around the latter. Any pain (eg
</I>&gt;<i> master blocked for 2 days waiting on the fix PR to merge) is a normal
</I>&gt;<i> problem with that QA process and should not be attributed to the CI change.
</I>
I do not understand why a problem caused by the CI change should not be
attributed to that CI change.



&gt;<i> We do need to stop the practice of just dropping
</I>&gt;<i> support for any OS where attempting to build finds existing bugs in
</I>&gt;<i> master (aka &quot;breaks master, sky falling&quot;). More focus on fixing those
</I>&gt;<i> bugs to increase portability and grow the Squid community beyond the
</I>&gt;<i> subset of RHEL and Ubuntu users.
</I>
If somebody can add support for more environments (and adding that
support does not make things worse for Squid), then they should
certainly add that support! I see no relationship with this discussion
-- nobody here wants to prohibit such useful activities, and the &quot;do not
break master&quot; invariant can be upheld while adding such support.


Alex.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009674.html">[squid-dev] Strategy about build farm nodes
</A></li>
	<LI>Next message (by thread): <A HREF="009676.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9675">[ date ]</a>
              <a href="thread.html#9675">[ thread ]</a>
              <a href="subject.html#9675">[ subject ]</a>
              <a href="author.html#9675">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
