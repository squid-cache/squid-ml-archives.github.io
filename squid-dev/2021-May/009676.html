<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Strategy about build farm nodes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3C555533c5fe9916b2bc5de7fcedbadfcc%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009675.html">
   <LINK REL="Next"  HREF="009678.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Strategy about build farm nodes</H1>
    <B>squid3 at treenet.co.nz</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3C555533c5fe9916b2bc5de7fcedbadfcc%40treenet.co.nz%3E"
       TITLE="[squid-dev] Strategy about build farm nodes">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 17 02:19:41 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009675.html">[squid-dev] Strategy about build farm nodes
</A></li>
        <LI>Next message (by thread): <A HREF="009678.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9676">[ date ]</a>
              <a href="thread.html#9676">[ thread ]</a>
              <a href="subject.html#9676">[ subject ]</a>
              <a href="author.html#9676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2021-05-17 11:56, Alex Rousskov wrote:
&gt;<i> On 5/16/21 3:31 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 4/05/21 2:29 am, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 5/3/21 12:41 AM, Francesco Chemolli wrote:
</I>&gt;&gt;&gt;&gt;<i> - we want our QA environment to match what users will use. For this
</I>&gt;&gt;&gt;&gt;<i> reason, it is not sensible that we just stop upgrading our QA nodes,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I see flaws in reasoning, but I do agree with the conclusion -- yes, 
</I>&gt;&gt;&gt;<i> we
</I>&gt;&gt;&gt;<i> should upgrade QA nodes. Nobody has proposed a ban on upgrades 
</I>&gt;&gt;&gt;<i> AFAICT!
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The principles I have proposed allow upgrades that do not violate key
</I>&gt;&gt;&gt;<i> invariants. For example, if a proposed upgrade would break master, 
</I>&gt;&gt;&gt;<i> then
</I>&gt;&gt;&gt;<i> master has to be changed _before_ that upgrade actually happens, not
</I>&gt;&gt;&gt;<i> after. Upgrades must not break master.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> So ... a node is added/upgraded. It runs and builds master fine. Then
</I>&gt;&gt;<i> added to the matrices some of the PRs start failing.
</I>&gt;<i> 
</I>&gt;<i> It is easy to misunderstand what is going on because there is no good
</I>&gt;<i> visualization of complex PR-master-Jenkins_nodes-Jenkins_failures
</I>&gt;<i> relationships. Several kinds of PR test failures are possible. I will
</I>&gt;<i> describe the two most relevant to your email:
</I>&gt;<i> 
</I>&gt;<i> * PR test failures due to problems introduced by PRs should be welcomed
</I>&gt;<i> at any time.
</I>
Strawman here. This is both general statement and not relevant to CI 
changes or design(s) we are discussing.

&gt;<i> CI improvements are allowed to find new bugs in open PRs.
</I>
IMO the crux is that word &quot;new&quot;. CI improvements very rarely find new 
bugs. What it actually finds and intentionally so is *existing bugs* the 
old CI config wrongly ignored.

&gt;<i> Such findings, even when discovered at the &quot;last minute&quot;, should be 
</I>&gt;<i> seen
</I>&gt;<i> as an overall positive event or progress -- our CI was able to identify
</I>&gt;<i> a problem before it got officially accepted! I do not recall anybody
</I>&gt;<i> complaining about such failures recently.
</I>&gt;<i> 
</I>
Conclusion being that due to the rarity of &quot;new bugs&quot; CI improvements 
very rarely get complained about due to them.


&gt;<i> * PR test failures due to the existing master code are not welcomed.
</I>
That is not as black/white as the statement above implies. There are 
some master branch bugs we don't want to block PRs merging, and there 
are some (rarely) we absolutely do not want any PRs to change master 
until fixed.

&gt;<i> They represent a CI failure.
</I>
IMO this is absolutely false. The whole point of improving CI is to find 
those &quot;existing&quot; bugs which the previous CI config wrong missed.

e.g. v4+ currently do not build on Windows. We know this, but the 
current CI testing does not show it. Upgrading the CI to include a test 
for Windows is not a &quot;CI failure&quot;.


&gt;<i> In these cases, if the latest master code
</I>&gt;<i> is tested with the same test after the problematic CI change, then that
</I>&gt;<i> master test will fail. Nothing a PR can do in this situation can fix
</I>&gt;<i> this kind of failure because it is not PR changes that are causing the
</I>&gt;<i> failure -- CI changes broke the master branch,
</I>
Ah. &quot;broke the master branch&quot; is a bit excessive. master is not broken 
any more or less than it already was.

What is *actually* broken is the CI test results.


&gt;<i> not just the PR! This
</I>&gt;<i> kind of failures are the responsibility of CI administrators, and PR
</I>&gt;<i> authors should complain about them, especially when there are no signs
</I>&gt;<i> of CI administrators aware of and working on addressing the problem.
</I>&gt;<i> 
</I>
*IF* all the conditions and assumptions contained in that final sentence 
are true I would agree. Such case points to incompetence or neglect on 
part of the sysadmin who broken *the CI test* then abandoned fixing it - 
complaints are reasonable there.

  [ Is kinkie acting incompetently on a regular basis? I think no. ]

Otherwise, short periods between sysadmin thinking it was a safe change 
and reverting as breakage appeared is to be expected. That is why we 
have sysadmin doing advance notices for us all to be aware of CI changes 
planned. Complaints still happen, but not much reason to redesign the 
sysadmin practices and automation (which is yet more CI change, ...).


&gt;<i> A good example of a failure of the second kind a -Wrange-loop-construct
</I>&gt;<i> error in a PR that does not touch any range loops (Jenkins conveniently
</I>&gt;<i> deleted the actual failed test, but my GitHub comment and PR contents
</I>&gt;<i> may be enough to restore what happened):
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/806#issuecomment-827924821">https://github.com/squid-cache/squid/pull/806#issuecomment-827924821</A>
</I>&gt;<i> 
</I>
Thank you.

I see here two distros which have &quot;rolling release&quot; being updated by 
sysadmin from producing outdated and wrong test results, to producing 
correct test results. This is a correct change in line with the goal of 
our nodes representing what a user running that OS would see building 
Squid master or PRs.
   One distro changed compiler and both turned on a new warning by 
default which exposed existing Squid bugs. Exactly as intended.

IMO we can expect to occur on a regular basis and it is specific to 
&quot;rolling release&quot; distros. We can resolve it by having those OS only 
build in the N-matrix applied before releases, instead of the matrix 
blocking PR tests or merging.

  If we are all agreed, kinkie or I can implement ASAP.


&lt;skip&gt;
&gt;<i> 
</I>&gt;&gt;<i> B. PR submission testing
</I>&gt;&gt;<i>    - which OS for master (5-pr-test) ?
</I>&gt;&gt;<i>    - which OS for beta (5-pr-test) ?
</I>&gt;&gt;<i>    - which OS for stable (5-pr-test) ?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Are all of those sets the same identical OS+compilers? no.
</I>&gt;&gt;<i> Why are they forced to be the same matrix test?
</I>&gt;<i> 
</I>&gt;<i> I do not understand the question. Are you asking why Jenkins uses the
</I>&gt;<i> same 5-pr-test configuration for all three branches (master, beta, 
</I>&gt;<i> _and_
</I>&gt;<i> stable)? I do not know the answer.
</I>&gt;<i> 
</I>
So can we agree that they should be different tests?

  If we are all agreed, that can be implemented.

After test separation we have the choice of OS to answer those questions 
I posed.

My idea is to go through distrowatch (see file attached) and sync the 
tests with OS that provide that vN (or lower) of Squid as part of its 
release. Of course, following the sysadmin testing process for any 
additions wanted.


&gt;<i> 
</I>&gt;&gt;<i> IIRC, policy forced on sysadmin with previous pain complaints.
</I>&gt;<i> 
</I>&gt;<i> Complaints, even legitimate ones, should not shape a policy. Goals and
</I>&gt;<i> principles should do that.
</I>&gt;<i> 
</I>&gt;<i> I remember one possibly related discussion where we were trying to
</I>&gt;<i> reduce Jenkins/PR wait times by changing which tests are run at what PR
</I>&gt;<i> merging stages, but that is probably a different issue because your
</I>&gt;<i> question appears to be about a single merging stage.
</I>&gt;<i> 
</I>
I think it was the discussion re-inventing the policy prior to that 
performance one.

&gt;<i> 
</I>&gt;&gt;<i> C. merge testing
</I>&gt;&gt;<i>    - which OS for master (5-pr-auto) ?
</I>&gt;&gt;<i>    - which OS for beta (5-pr-auto) ?
</I>&gt;&gt;<i>    - which OS for stable (5-pr-auto) ?
</I>&gt;&gt;<i>      NP: maintainer does manual override on beta/stable merges.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Are all of those sets the same identical OS+compilers? no.
</I>&gt;&gt;<i>   Why are they forced to be the same matrix test? Anubis
</I>&gt;<i> 
</I>&gt;<i> This is too cryptic for me to understand, but Anubis does not force any
</I>&gt;<i> tests on anybody -- it simply checks that the required tests have
</I>&gt;<i> passed. I am not aware of any Anubis bugs in this area, but please
</I>&gt;<i> correct me if I am wrong.
</I>&gt;<i> 
</I>
My understanding was that Anubis only has ability to check PRs against 
its auto branch which tracks master. Ability to have it track other 
non-master branches and merge there is not available for use.

If that ability were available, we would need to implement different 
matrix as with N-pr-test to use it without guaranteed pain points.

IMO we should look into this. But it is a technical project for sysadmin 
+ Eduard to coordinate. Not a policy thing.


&gt;<i> 
</I>&gt;&gt;<i> D. pre-release testing (snapshots + formal)
</I>&gt;&gt;<i>    - which OS for master (trunk-matrix) ?
</I>&gt;&gt;<i>    - which OS for beta (5-matrix) ?
</I>&gt;&gt;<i>    - which OS for stable (4-matrix) ?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Are all of those sets the same identical OS+compilers? no.
</I>&gt;&gt;<i> Are we forcing them to use the same matrix test? no.
</I>&gt;&gt;<i> Are we getting painful experiences from this? maybe.
</I>&gt;&gt;<i>   Most loud complaints have been about &quot;breaking master&quot; which is the
</I>&gt;&gt;<i> most volatile branch testing on the most volatile OS.
</I>&gt;<i> 
</I>&gt;<i> FWIW, I think you misunderstood what those &quot;complaints&quot; where about. I
</I>&gt;<i> do not know how that relates to the above questions/answers though.
</I>&gt;<i> 
</I>
Maybe. Our different view on what comprises &quot;breaking master&quot; certainly 
confuses interpretations when the phrase is used as the 
problem/complaint/report description.


&gt;<i> 
</I>&gt;&gt;<i> FTR: the reason all those matrices have '5-' prefix is because several
</I>&gt;&gt;<i> redesigns ago the system was that master/trunk had a matrix which the
</I>&gt;&gt;<i> sysadmin added nodes to as OS upgraded. During branching vN the
</I>&gt;&gt;<i> maintainer would clone/freeze that matrix into an N-foo which would be
</I>&gt;&gt;<i> used to test the code against OS+compilers which the code in the vN
</I>&gt;&gt;<i> branch was designed to build on.
</I>&gt;<i> 
</I>&gt;<i> I think the above description implies that some time ago we were (more)
</I>&gt;<i> careful about (not) adding new nodes when testing stable branches. We
</I>&gt;<i> did not want a CI change to break a stable branch. That sounds like the
</I>&gt;<i> right principle to me (and it should apply to beta and master as well).
</I>&gt;<i> How that specific principle is accomplished is not important (to me) so
</I>&gt;<i> CI admins should propose whatever technique they think is best.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Can we have the people claiming pain specify exactly what the pain is
</I>&gt;&gt;<i> coming from, and let the sysadmin/developer(s) with specialized
</I>&gt;&gt;<i> knowledge of the automation in that area decide how best to fix it?
</I>&gt;<i> 
</I>&gt;<i> We can, and that is exactly what is going on in this thread AFAICT. 
</I>&gt;<i> This
</I>&gt;<i> particular thread was caused by CI changes breaking master, and
</I>&gt;<i> Francesco was discussing how to avoid such breakages in the future.
</I>&gt;<i> 
</I>&gt;<i> There are other goals/principles to observe, of course, and it is
</I>&gt;<i> possible that Francesco is proposing more changes to optimize something
</I>&gt;<i> else as well, but that is something only he can clarify (if needed).
</I>&gt;<i> 
</I>&gt;<i> AFAICT, Francesco and I are on the same page regarding not breaking
</I>&gt;<i> master anymore -- he graciously agreed to prevent such breakages in the
</I>&gt;<i> future, and I am very thankful that he did. Based on your comments
</I>&gt;<i> discussing several cases where such master breakage is, in your 
</I>&gt;<i> opinion,
</I>&gt;<i> OK, you currently disagree with that principle. I do not know why.
</I>&gt;<i> 
</I>
I think we differ in our definitions of &quot;breaking master&quot;. You seem to 
be including breakage of things in the CI system itself which I consider 
outside of &quot;master&quot;, or expected results of normal sysadmin activity. I 
hope my response to the two use-cases you present at the top of this 
email clarify.


Amos
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: squid_distros_2021.txt
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210517/1ca3ab6e/attachment-0001.txt">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210517/1ca3ab6e/attachment-0001.txt</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009675.html">[squid-dev] Strategy about build farm nodes
</A></li>
	<LI>Next message (by thread): <A HREF="009678.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9676">[ date ]</a>
              <a href="thread.html#9676">[ thread ]</a>
              <a href="subject.html#9676">[ subject ]</a>
              <a href="author.html#9676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
