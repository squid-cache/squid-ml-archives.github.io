<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Strategy about build farm nodes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3CCA%2BY8hcNWpzCO3y4w%3D6XaV-ZK8uK7tmQNzgJY-8AfeZ0pB7vhNQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="009679.html">
   <LINK REL="Next"  HREF="009681.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Strategy about build farm nodes</H1>
    <B>Francesco Chemolli</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Strategy%20about%20build%20farm%20nodes&In-Reply-To=%3CCA%2BY8hcNWpzCO3y4w%3D6XaV-ZK8uK7tmQNzgJY-8AfeZ0pB7vhNQ%40mail.gmail.com%3E"
       TITLE="[squid-dev] Strategy about build farm nodes">gkinkie at gmail.com
       </A><BR>
    <I>Mon May 17 19:32:15 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009679.html">[squid-dev] Strategy about build farm nodes
</A></li>
        <LI>Next message (by thread): <A HREF="009681.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9680">[ date ]</a>
              <a href="thread.html#9680">[ thread ]</a>
              <a href="subject.html#9680">[ subject ]</a>
              <a href="author.html#9680">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, May 17, 2021 at 8:32 PM Alex Rousskov &lt;
<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 5/17/21 2:17 AM, Francesco Chemolli wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Our Linux environments are docker containers on amd64, armv7l and arm64.
</I>&gt;<i> &gt; On a roughly monthly cadence, I pull from our dockerfiles repo
</I>&gt;<i> &gt; (<A HREF="https://github.com/kinkie/dockerfiles">https://github.com/kinkie/dockerfiles</A>) and
</I>&gt;<i> &gt; $ make all push
</I>&gt;<i>
</I>&gt;<i> Does that &quot;make push&quot; command automatically switch Jenkins CI to using
</I>&gt;<i> the new/pushed containers? Or is that a separate manual step?
</I>&gt;<i>
</I>
Right now that's automatic.
I'm pondering the best way to have a staging step; Docker supports
versioning of images but we're using that feature to implement multiarch.
In order to rely on that I'll need to change the naming conventions we rely
on.


&gt;<i> &gt;&gt;&gt; What I would place on each individual dev is the case where a PR breaks
</I>&gt;<i> &gt;&gt;&gt; something in the trunk-matrix,trunk-arm32-matrix, trunk-arm64-matrix,
</I>&gt;<i> &gt;&gt;&gt; trunk-openbsd-matrix, trunk-freebsd-matrix builds
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; I think you are saying that
</I>&gt;<i> &gt;&gt; some CI tests called trunk-matrix, trunk-arm32-matrix,
</I>&gt;<i> &gt;&gt; trunk-arm64-matrix, trunk-openbsd-matrix, trunk-freebsd-matrix should be
</I>&gt;<i> &gt;&gt; classified as _required_.
</I>&gt;<i>
</I>&gt;<i> &gt; That is how I read the statement too.
</I>&gt;<i>
</I>&gt;<i> ... but it sounds like that is _not_ what you (Francesco) is actually
</I>&gt;<i> proposing because you are essentialy saying &quot;that ideal would be
</I>&gt;<i> impractical&quot; in the paragraph below. Assuming that you are not attacking
</I>&gt;<i> your own proposal, that means Amos and I do not know what your proposal
</I>&gt;<i> is -- we both guessed incorrectly...
</I>&gt;<i>
</I>
The overarching objectives are:
- focus on where most users probably are
- allow iterating quickly giving some signal on tracked branches
- allow landing quickly with more signal
- be slow but exhaustive on every other platform we can cover. Do not block
landing new code on less common or harder to test on platforms, but still
rely on devs to own their changes there, too.

&gt;<i> In a word of infinite resources and very efficient testing, sure.
</I>&gt;<i> &gt; But in a space where a single os/compiler combo takes 2hrs on Linux and
</I>&gt;<i> &gt; 4hrs on Freebsd or openbsd, and a full 5-pr-test takes 6 hours end to
</I>&gt;<i> &gt; end, we need to optimize or making any of these requirements blocking
</I>&gt;<i> &gt; would make these times get 4+ times larger (a full trunk-matrix takes
</I>&gt;<i> &gt; just about a day on amd64, 2 days on arm64), and the complaint would
</I>&gt;<i> &gt; then be that development or release is slowed down by the amount of
</I>&gt;<i> &gt; testing done.
</I>&gt;<i>
</I>&gt;<i> FWIW, I think that full round of PR tests (i.e. one initial set plus one
</I>&gt;<i> staging set) should not exceed ~24 hours, _including_ any wait/queuing
</I>&gt;<i> time. This kind of delay should still allow for reasonable progress with
</I>&gt;<i> PRs AFAICT. This includes any release PRs, of course. If we exceed these
</I>&gt;<i> limits (or whatever limits we can agree on), then we should add testing
</I>&gt;<i> resources and/or drop tests.
</I>

Is everyone okay with such a slow turnaround?


&gt;<i> &gt; My proposal aims to test/land the PR on the systems where we can be
</I>&gt;<i> &gt; efficient and that are relevant, and fix any remaining after-the-fact
</I>&gt;<i> &gt; issues with followup, PRs, that remain a soft requirement for the dev
</I>&gt;<i> &gt; introducing the change.
</I>&gt;<i>
</I>&gt;<i> Here, I think you are proposing to make some tests optional. Which ones?
</I>&gt;<i>
</I>
Not the tests, but the platforms. Things like gentoo, fedora rawhide,
freebsd, openbsd.
Testing is slower there, so results will lag and we need to batch, running
a full test suite every week or so


&gt;<i> &gt; For instance: we currently have a lot of different build-time
</I>&gt;<i> &gt; configurations meant to save core memory in runtime environments. Is it
</I>&gt;<i> &gt; maybe time to revisit this decision and move these checks to run time?
</I>&gt;<i>
</I>&gt;<i> Sure, quality proposals for removing #ifdefs should be welcomed, one
</I>&gt;<i> (group of) #ifdefs at a time. We can warn squid-users in advance in case
</I>&gt;<i> somebody wants to provide evidence of harm.
</I>&gt;<i>
</I>
I'm glad this is having buy-in. Are there any other opinions (for or
against)?


&gt;<i> &gt; Unfortunately, one of the problems we have is that we're running blind.
</I>&gt;<i> &gt; We don't know what configurations our users deploy; we can only assume
</I>&gt;<i> &gt; and that makes this conversation much more susceptible to opinions and
</I>&gt;<i> &gt; harder to build consensus on
</I>&gt;<i>
</I>&gt;<i> Yes, we are blind, but I doubt we should care much about actual
</I>&gt;<i> configuration in this specific context. If we can remove an #ifdef
</I>&gt;<i> without serious negative consequences, we should remove it. We can avoid
</I>&gt;<i> long discussions by allowing anybody with concrete evidence of problems
</I>&gt;<i> to block any particular removal. I bet that conservative approach would
</I>&gt;<i> still allow for the removal of many #ifdefs.
</I>&gt;<i>
</I>
Sounds good to me

FWIW, I do not think reducing the number of #ifdefs will solve our
&gt;<i> primary CI problems. I believe we should reduce the number of platforms
</I>&gt;<i> we test on and then use Foundation resources to speed up and improve the
</I>&gt;<i> remaining tests.
</I>&gt;<i>
</I>
Each test build is right now 4 full builds and test suites:
autodetected, minimal, maximum, everytthing-in-except-for-auth

Can we reduce them to 2? If so, which ones? that would be the guide to
#ifdef removal


&gt;<i> HTH,
</I>&gt;<i>
</I>
It does; thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210517/4eb65b93/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-dev/attachments/20210517/4eb65b93/attachment-0001.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009679.html">[squid-dev] Strategy about build farm nodes
</A></li>
	<LI>Next message (by thread): <A HREF="009681.html">[squid-dev] Strategy about build farm nodes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9680">[ date ]</a>
              <a href="thread.html#9680">[ thread ]</a>
              <a href="subject.html#9680">[ subject ]</a>
              <a href="author.html#9680">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
