From kk at sudo-i.net  Mon Nov  1 07:59:25 2021
From: kk at sudo-i.net (kk at sudo-i.net)
Date: Mon, 01 Nov 2021 08:59:25 +0100
Subject: [squid-dev] 
 =?utf-8?q?request_for_change_handling_hostStrictVeri?=
 =?utf-8?q?fy?=
Message-ID: <38-617f9e80-1-7cdebb00@168115853>


On Saturday, October 30, 2021 01:14 GMT, Alex Rousskov <rousskov at measurement-factory.com> wrote:
?On 10/29/21 8:37 PM, Amos Jeffries wrote:
> On 30/10/21 11:09, Alex Rousskov wrote:
>> On 10/26/21 5:46 PM, kk at sudo-i.net wrote:
>>
>>> - Squid enforces the Client to use SNI
>>> - Squid lookup IP for SNI (DNS resolution).
>>> - Squid forces the client to go to the resolved IP
>>
>> AFAICT, the above strategy is in conflict with the "SECURITY NOTE"
>> paragraph in host_verify_strict documentation: If Squid strays from the
>> intended IP using client-supplied destination info, then malicious
>> applets will escape browser IP-based protections. Also, SNI obfuscation
>> or encryption may make this strategy ineffective or short-lived.
>>
>> AFAICT, in the majority of deployments, the mismatch between the
>> intended IP address and the SNI/Host header can be correctly handled
>> automatically and without creating serious problems for the user. Squid
>> already does the right thing in some cases. Somebody should carefully
>> expand that coverage to intercepted traffic. Frankly, I am somewhat
>> surprised nobody has done that yet given the number of complaints!

> IIRC the "right thing" as defined by TLS for SNI verification is that it
> be the same as the host/domain name from the wrapper protocol (i.e. the
> Host header / URL domain from HTTPS messages). Since Squid uses the SNI
> at step2 as Host value it already gets checked against the intercepted IP


Just to avoid misunderstanding, my email was _not_ about SNI
verification. I was talking about solving the problem this thread is
devoted to (and a specific solution proposed in the opening email on the
thread).

Alex.
_______________________________________________
squid-dev mailing list
squid-dev at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-devThanks Alex & Amos.

Not sure what do you mean with "Somebody should carefully expand that coverage to intercepted traffic"?
>then malicious applets will escape browser IP-based protections.
Browser should perform IP-based protection on browser(client) level and should therefor not traverse squid.



--?
Kevin Klopfenstein
Bellevuestrasse 103
3095 Spiegel, CH
sudo-i.net
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20211101/c9c0dcc5/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 5102 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20211101/c9c0dcc5/attachment.bin>

From squid3 at treenet.co.nz  Mon Nov  1 12:01:40 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 2 Nov 2021 01:01:40 +1300
Subject: [squid-dev] request for change handling hostStrictVerify
In-Reply-To: <38-617f9e80-1-7cdebb00@168115853>
References: <38-617f9e80-1-7cdebb00@168115853>
Message-ID: <3d83d79f-48cf-210c-6280-ce6d447ea3d8@treenet.co.nz>

On 1/11/21 20:59, kk wrote:
> 
> On Saturday, October 30, 2021 01:14 GMT, Alex Rousskov wrote:
>> On 10/29/21 8:37 PM, Amos Jeffries wrote:
>> > On 30/10/21 11:09, Alex Rousskov wrote:
>> >> On 10/26/21 5:46 PM, kk wrote:
>> >>
>> >>> - Squid enforces the Client to use SNI
>> >>> - Squid lookup IP for SNI (DNS resolution).
>> >>> - Squid forces the client to go to the resolved IP
>> >>

>  >then malicious applets will escape browser IP-based protections.
> Browser should perform IP-based protection on browser(client) level and 
> should therefor not traverse squid.

Your suggestion of making Squid "forces the client to go to the resolved 
IP" bypasses any protections the Browser might do.

This would make the CVE-2009-0801 situation happen all over again. Just 
with SNI as the bypass method instead of Host header.

Amos

From rousskov at measurement-factory.com  Mon Nov  1 14:58:15 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 1 Nov 2021 10:58:15 -0400
Subject: [squid-dev] request for change handling hostStrictVerify
In-Reply-To: <38-617f9e80-1-7cdebb00@168115853>
References: <38-617f9e80-1-7cdebb00@168115853>
Message-ID: <d897b6fb-f35b-8808-e2d9-3e7e36c97fb5@measurement-factory.com>

On 11/1/21 3:59 AM, kk at sudo-i.net wrote:
> On Saturday, October 30, 2021 01:14 GMT, Alex Rousskov wrote:
>> >> AFAICT, in the majority of deployments, the mismatch between the
>> >> intended IP address and the SNI/Host header can be correctly handled
>> >> automatically and without creating serious problems for the user. Squid
>> >> already does the right thing in some cases. Somebody should carefully
>> >> expand that coverage to intercepted traffic. Frankly, I am somewhat
>> >> surprised nobody has done that yet given the number of complaints!

> Not sure what do you mean with "Somebody should carefully expand that
> coverage to intercepted traffic"?

I meant that somebody should create a high-quality pull request that
modifies Squid source code to properly address the problem you, AFAICT,
are suffering from. There is already code that handles similar
situations correctly.

Alex.

From kk at sudo-i.net  Tue Nov  2 08:25:43 2021
From: kk at sudo-i.net (kk at sudo-i.net)
Date: Tue, 02 Nov 2021 09:25:43 +0100
Subject: [squid-dev] 
 =?utf-8?q?request_for_change_handling_hostStrictVeri?=
 =?utf-8?q?fy?=
In-Reply-To: <d897b6fb-f35b-8808-e2d9-3e7e36c97fb5@measurement-factory.com>
Message-ID: <38-6180f600-5-7cdebb00@168115919>


On Monday, November 01, 2021 14:58 GMT, Alex Rousskov <rousskov at measurement-factory.com> wrote:
?On 11/1/21 3:59 AM, kk at sudo-i.net wrote:
> On Saturday, October 30, 2021 01:14 GMT, Alex Rousskov wrote:
>> >> AFAICT, in the majority of deployments, the mismatch between the
>> >> intended IP address and the SNI/Host header can be correctly handled
>> >> automatically and without creating serious problems for the user. Squid
>> >> already does the right thing in some cases. Somebody should carefully
>> >> expand that coverage to intercepted traffic. Frankly, I am somewhat
>> >> surprised nobody has done that yet given the number of complaints!

> Not sure what do you mean with "Somebody should carefully expand that
> coverage to intercepted traffic"?

I meant that somebody should create a high-quality pull request that
modifies Squid source code to properly address the problem you, AFAICT,
are suffering from. There is already code that handles similar
situations correctly.

Alex.

Ok Alex, I will try to implement it.
https://github.com/chifu1234/squid

--?
Kevin Klopfenstein
Bellevuestrasse 103
3095 Spiegel, CH
sudo-i.net
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20211102/8adae16e/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/x-pkcs7-signature
Size: 5102 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20211102/8adae16e/attachment.bin>

From rousskov at measurement-factory.com  Tue Nov  2 15:26:47 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 2 Nov 2021 11:26:47 -0400
Subject: [squid-dev] request for change handling hostStrictVerify
In-Reply-To: <38-6180f600-5-7cdebb00@168115919>
References: <38-6180f600-5-7cdebb00@168115919>
Message-ID: <854f5273-1c87-c97f-53b2-f82e409fcfac@measurement-factory.com>

On 11/2/21 4:25 AM, kk at sudo-i.net wrote:
> 
> On Monday, November 01, 2021 14:58 GMT, Alex Rousskov
> <rousskov at measurement-factory.com> wrote:
> ?
>> On 11/1/21 3:59 AM, kk at sudo-i.net wrote:
>> > On Saturday, October 30, 2021 01:14 GMT, Alex Rousskov wrote:
>> >> >> AFAICT, in the majority of deployments, the mismatch between the
>> >> >> intended IP address and the SNI/Host header can be correctly handled
>> >> >> automatically and without creating serious problems for the
>> user. Squid
>> >> >> already does the right thing in some cases. Somebody should
>> carefully
>> >> >> expand that coverage to intercepted traffic. Frankly, I am somewhat
>> >> >> surprised nobody has done that yet given the number of complaints!
>>
>> > Not sure what do you mean with "Somebody should carefully expand that
>> > coverage to intercepted traffic"?
>>
>> I meant that somebody should create a high-quality pull request that
>> modifies Squid source code to properly address the problem you, AFAICT,
>> are suffering from. There is already code that handles similar
>> situations correctly.


> I will try to implement it.

Please note that implementing correct changes in this area may be
difficult, especially if you are not familiar with relevant Squid code
and the invariants it is trying to uphold. Please do not expect the
changes to be officially accepted just because they "work" in your use case.

It is your call whether or how to approach this task, but if you find
yourself modifying a lot of Squid code, especially code that seems
mysterious, you might want to pause and sketch a solution for the
discussion here on squid-dev or via a Draft PR on GitHub.


HTH,

Alex.

