<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Alternate origin server selection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Alternate%20origin%20server%20selection&In-Reply-To=%3Ca7135e35-52dd-f937-b33c-80a60f12a047%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009715.html">
   <LINK REL="Next"  HREF="009718.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Alternate origin server selection</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Alternate%20origin%20server%20selection&In-Reply-To=%3Ca7135e35-52dd-f937-b33c-80a60f12a047%40measurement-factory.com%3E"
       TITLE="[squid-dev] Alternate origin server selection">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct 28 15:41:23 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009715.html">[squid-dev] Alternate origin server selection
</A></li>
        <LI>Next message (by thread): <A HREF="009718.html">[squid-dev] Alternate origin server selection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9716">[ date ]</a>
              <a href="thread.html#9716">[ thread ]</a>
              <a href="subject.html#9716">[ subject ]</a>
              <a href="author.html#9716">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/28/21 9:24 AM, Steve Hill wrote:

&gt;<i> For transparently proxied traffic, the client makes a connection to
</I>&gt;<i> www.google.com's IP address, which Squid intercepts.&#160; Squid must then
</I>&gt;<i> SSL-peek the request to figure out that it is connecting to
</I>&gt;<i> www.google.com.&#160; The onward connection can then be redirected to the
</I>&gt;<i> virtual IP.
</I>
IIRC, Google has recommended (to my surprise) something like that as
well, for environments where DNS modifications are inappropriate and
bumping is possible. I cannot find that recommendation now, unfortunately.


&gt;<i> There is code to do this:
</I>&gt;<i> &#160; <A HREF="https://github.com/squid-cache/squid/pull/924">https://github.com/squid-cache/squid/pull/924</A>
</I>&gt;<i> This allows an external ACL to record an alt-host note, or an ICAP
</I>&gt;<i> server to return an X-Alt-Host header, specifying a new origin server to
</I>&gt;<i> connect to.
</I>&gt;<i>
</I>&gt;<i> The pull request was rejected, as it adds CVE-2009-0801 vulnerabilities.
</I>&gt;<i> 
</I>&gt;<i> I'm hoping for some guidance on the best way to achieve this.
</I>

While I disagree with some of the assertions made in that PR review and
the unilateral approach to closing that PR, I hope we can find a
positive way forward here. Your use case deserves Squid support IMO.


AFAICT, the primary obstacle here is that Squid pins the connection
while obtaining the origin server certificate. Please confirm that
without that origin server certificate you cannot make the decision
whether to redirect the HTTP request. In other words, the
client-intended destination IP address and the client-supplied SNI are
not sufficient to correctly determine whether the connection must be
bumped (in relevant cases).

Also, if you need the server certificate indeed, please confirm that
when the origin server uses TLS v1.3, the proposed scheme will have to
fully bump the Squid-server connection before redirecting the request.
Just staring at the TLS ServerHello will not be enough because the
origin certificate comes later, in the encrypted records.


I hope to suggest the right solution based on your feedback.


Thank you,

Alex.
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009715.html">[squid-dev] Alternate origin server selection
</A></li>
	<LI>Next message (by thread): <A HREF="009718.html">[squid-dev] Alternate origin server selection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9716">[ date ]</a>
              <a href="thread.html#9716">[ thread ]</a>
              <a href="subject.html#9716">[ subject ]</a>
              <a href="author.html#9716">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
