<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Alternate origin server selection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Alternate%20origin%20server%20selection&In-Reply-To=%3C18a1cb18-c0b8-7558-3614-07e4deea86bd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009720.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Alternate origin server selection</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Alternate%20origin%20server%20selection&In-Reply-To=%3C18a1cb18-c0b8-7558-3614-07e4deea86bd%40measurement-factory.com%3E"
       TITLE="[squid-dev] Alternate origin server selection">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Oct 29 14:38:12 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009720.html">[squid-dev] Alternate origin server selection
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9721">[ date ]</a>
              <a href="thread.html#9721">[ thread ]</a>
              <a href="subject.html#9721">[ subject ]</a>
              <a href="author.html#9721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/29/21 9:57 AM, Steve Hill wrote:

&gt;<i> Ok, I've gone back and looked over my old debug logs.&#160; It appears what
</I>&gt;<i> was actually happening was:
</I>&gt;<i> 
</I>&gt;<i> - Client sends &quot;CONNECT www.google.com:443&quot;.
</I>&gt;<i> - Connection with TLS made to forcesafesearch.google.com.
</I>&gt;<i> - Client sends &quot;GET / HTTP/1.1\r\nHost: www.google.com&quot;
</I>&gt;<i> - Squid runs the peer selector to find peers for www.google.com (i.e.
</I>&gt;<i> the host contained in the GET request).
</I>&gt;<i> - It finds the appropriate pinned connection:
</I>&gt;<i> client_side.cc(3872) borrowPinnedConnection: conn28
</I>&gt;<i> local=81.187.83.66:52488 remote=216.239.38.120:443 HIER_DIRECT FD 18
</I>&gt;<i> flags=1
</I>&gt;<i> - Squid then logs:
</I>&gt;<i> &#160; FwdState.cc(472) fail: ERR_ZERO_SIZE_OBJECT &quot;Bad Gateway&quot;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <A HREF="https://www.google.com/">https://www.google.com/</A>
</I>&gt;<i> &#160; FwdState.cc(484) fail: pconn race happened
</I>&gt;<i> &#160; FwdState.cc(494) fail: zero reply on pinned connection
</I>
The above looks like a persistent connection race, way after SslBump
bumped the connections. This kind of races seem unrelated to everything
we have discussed on this thread so far, but I may be missing something.


&gt;<i> Unfortunately, I cannot reproduce this problem now.
</I>
Well, if you want to reproduce it, you probably can do that using a
custom origin server, but I do not see the point: There is nothing
particularly &quot;wrong&quot; in the above sequence AFAICT; races happen.
However, it is possible that the above log is lying or misleading, and
there was actually a different problem, a problem related to previous
discussions, but it manifested itself as ERR_ZERO_SIZE_OBJECT &quot;pconn
race happened&quot; diagnostic.


&gt;<i> I can remove the unpinning code and submit a new pull request, which now
</I>&gt;<i> works ok for me.&#160; But I'm very wary that I did originally have problems
</I>&gt;<i> with that which I can no longer reproduce.
</I>
Unfortunately, I did not have a chance to study the rejected pull
request before it was rejected, so I cannot advise you on whether
subtracting something from that pull request will result in changes that
should be, in principle, accepted.

I suggest to imagine that the rejected pull request did not exist
(instead of using it as a starting/reference point) and then describe
the problem and the proposed solution from scratch. You can do that here
or via a new pull request. The best avenue may depend on whether your
code changes alter some key Squid principles. If they do, it might be
best to get an agreement on those changes here, but GitHub discussions
have better access to code and better formatting abilities.


Cheers,

Alex.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009720.html">[squid-dev] Alternate origin server selection
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9721">[ date ]</a>
              <a href="thread.html#9721">[ thread ]</a>
              <a href="subject.html#9721">[ subject ]</a>
              <a href="author.html#9721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
