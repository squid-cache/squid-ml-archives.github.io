<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: Reject repeated same-name annotations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Reject%20repeated%20same-name%20annotations&In-Reply-To=%3C5489c27f-a7d2-d4aa-0b63-be091d827899%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009837.html">
   <LINK REL="Next"  HREF="009839.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: Reject repeated same-name annotations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Reject%20repeated%20same-name%20annotations&In-Reply-To=%3C5489c27f-a7d2-d4aa-0b63-be091d827899%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: Reject repeated same-name annotations">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 15 23:56:06 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009837.html">[squid-dev] RFC: Reject repeated same-name annotations
</A></li>
        <LI>Next message (by thread): <A HREF="009839.html">[squid-dev] Possible bug with file-descriptor parameter in configure of squid-6.0.0-20221210-r71f62e86e
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9838">[ date ]</a>
              <a href="thread.html#9838">[ thread ]</a>
              <a href="subject.html#9838">[ subject ]</a>
              <a href="author.html#9838">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/15/22 17:27, <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">ngtech1ltd at gmail.com</A> wrote:

&gt;<i> I must admit that I didn't understand it enough to make sense on what
</I>&gt;<i> specific scenario for example it will affect.
</I>
Here is a configuration example:

   # Let's mark certain allowed transactions as green and hot:
   acl markCertain annotate_transaction color=green t=hot color=grn
   http_access allow certainSlowAclHere markAsGreen

   # And then use 10.0.0.1 for those certain transactions:
   acl markedAsGreen note color green
   tcp_outgoing_address 10.0.0.1 markedAsGreen

The above will not use 10.0.0.1 for transactions that should use that 
outgoing address because somebody accidentally overwritten the color on 
the annotate_transaction line. We are actually coloring matching 
transactions &quot;grn&quot; instead of &quot;green&quot; now, and the above 
tcp_outgoing_address rule does not match.


Such errors a more difficult to spot when the offending acl line is in a 
different configuration file than the correct acl line. They are even 
more difficult to spot when the problem is hidden in a helper response!


&gt;<i> I assumed that what would happen is that if ... a single response
</I>&gt;<i> will contain multiple notes with the same key these will be
</I>&gt;<i> appended.
</I>
No, they will not be appended. Or, to be more precise, they may not be 
appended in every case. The actual results vary depending on the 
annotation source, Squid version, etc. What happens is currently an 
undefined behavior.


&gt;<i> From what I understood until now a single helper that will respond
</I>&gt;<i> with multiple note_1=v note_1=v Will trigger a fatal error
</I>
No, bad helper responses will not trigger fatal errors. They will 
trigger non-fatal ERROR messages.

Only misconfigurations (e.g., the above squid.conf example) will be fatal.


&gt;<i> However, if multiple helpers will send both each in it's turn a
</I>&gt;<i> note_1=v these will be appended.
</I>
IIRC, annotations from earlier helper responses will be overwritten by 
annotations in the later ones. However, this RFC is _not_ about multiple 
responses, so let's not lose our focus, even if my recollection is 
wrong. :-)


&gt;<i> I agree that the result should be predictable however if logs can
</I>&gt;<i> help to trace the issue I believe it's predicted enough to not say
</I>&gt;<i> about the current situation &quot;un-predictable&quot;.
</I>
Currently, ALL,1 cache.log is silent about same-name annotations in many 
cases. Debugging cache.log does not count, of course (and it would be 
rather difficult to triage these problems in a busy debugging cache.log 
anyway). As far as Squid administration is concerned, the biggest 
trouble is not in figuring out where the problem is. It is knowing that 
there is a problem (e.g., that users that should be blocked are actually 
allowed when everybody seems &quot;happy&quot;).


Also, the value of this RFC is not just in making Squid safer. It also 
helps with enhancing Squid code, adding features. Right now, if Bob 
tries to add a feature involving annotations, Alice may shoot it down 
because the new code does not handle same-name annotations the same way 
as the code Alice happens to know about (while Bob is copying another 
piece of code that handles similar situation differently or inventing 
his own thing).


We need to fix this mess from both development and administration point 
of view.


Hope this clarifies,

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-dev &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Thursday, 15 December 2022 23:30
</I>&gt;<i> To: Squid Developers &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>&gt;
</I>&gt;<i> Subject: [squid-dev] RFC: Reject repeated same-name annotations
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>       I propose to adjust Squid code to reject repeated same-name
</I>&gt;<i> annotations from each and every source that supplies annotations:
</I>&gt;<i> 
</I>&gt;<i> * &quot;note&quot; directive
</I>&gt;<i> * adaptation_meta directive
</I>&gt;<i> * annotate_transaction ACL [1]
</I>&gt;<i> * annotate_client ACL [1]
</I>&gt;<i> * adaptation services responses (eCAP and ICAP)
</I>&gt;<i> * helper responses
</I>&gt;<i> 
</I>&gt;<i> If this RFC is approved: A configuration that contains a directive with
</I>&gt;<i> repeated same-name annotations will be rejected with a fatal ERROR[2]. A
</I>&gt;<i> helper or service response that contains repeated same-name annotations
</I>&gt;<i> will trigger a non-fatal (to Squid or transaction) cache.log ERROR[2].
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Currently, Squid treats repeated same-name annotations inconsistently.
</I>&gt;<i> Depending on the annotation source, Squid processing code may
</I>&gt;<i> 
</I>&gt;<i> * use the first same-name annotation and ignore repetitions
</I>&gt;<i> * use the last same-name annotation and ignore repetitions
</I>&gt;<i> * use all same-name annotations, honoring repetitions
</I>&gt;<i> 
</I>&gt;<i> These inconsistencies make it difficult to improve/enhance/optimize
</I>&gt;<i> Squid code, while Squid ignorance hides misconfigurations and
</I>&gt;<i> helper/service implementation bugs, including problems that may be
</I>&gt;<i> related to access controls and other sensitive matters.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any objections or better ideas?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> [1] In this context, we are talking about same-name annotations
</I>&gt;<i> mentioned in the corresponding ACL _configuration_ (i.e. all &quot;acl&quot;
</I>&gt;<i> directives with a given ACL name). A repeated _computation_ of
</I>&gt;<i> annotate_foo ACL will continue to deal with same-name annotations as
</I>&gt;<i> documented -- a &quot;name+=value&quot; configuration will continue to append
</I>&gt;<i> values to the existing same-name annotation, while a &quot;name=value&quot;
</I>&gt;<i> configuration will continue to overwrite any existing same-name annotation.
</I>&gt;<i> 
</I>&gt;<i> [2] Repeated same-name annotations that all have identical _values_ will
</I>&gt;<i> be flagged with a WARNING instead. Some overly simplistic configuration
</I>&gt;<i> generators, complicated configurations build from many include files,
</I>&gt;<i> and dumb helpers/services might generate repeated same-everything
</I>&gt;<i> annotations. Since such repetitions can be _safely_ ignored (honoring
</I>&gt;<i> just one name=value pair among all the identical ones), we do not have
</I>&gt;<i> to reject the configuration or log an ERROR because of them.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-dev mailing list
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">squid-dev at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-dev">http://lists.squid-cache.org/listinfo/squid-dev</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009837.html">[squid-dev] RFC: Reject repeated same-name annotations
</A></li>
	<LI>Next message (by thread): <A HREF="009839.html">[squid-dev] Possible bug with file-descriptor parameter in configure of squid-6.0.0-20221210-r71f62e86e
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9838">[ date ]</a>
              <a href="thread.html#9838">[ thread ]</a>
              <a href="subject.html#9838">[ subject ]</a>
              <a href="author.html#9838">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
