<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: Adding a new line to a regex
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Adding%20a%20new%20line%20to%20a%20regex&In-Reply-To=%3C8fc0225b-faa5-0116-f2a8-7c400eceae6e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009757.html">
   <LINK REL="Next"  HREF="009758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: Adding a new line to a regex</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Adding%20a%20new%20line%20to%20a%20regex&In-Reply-To=%3C8fc0225b-faa5-0116-f2a8-7c400eceae6e%40treenet.co.nz%3E"
       TITLE="[squid-dev] RFC: Adding a new line to a regex">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jan 21 17:42:08 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009757.html">[squid-dev] RFC: Adding a new line to a regex
</A></li>
        <LI>Next message (by thread): <A HREF="009758.html">[squid-dev] RFC: Adding a new line to a regex
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9756">[ date ]</a>
              <a href="thread.html#9756">[ thread ]</a>
              <a href="subject.html#9756">[ subject ]</a>
              <a href="author.html#9756">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/01/22 10:32, Alex Rousskov wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>      We have a use case where a regex in squid.conf should contain/match
</I>&gt;<i> a new line (i.e. ASCII LF). I do not know whether there are similar use
</I>&gt;<i> cases with the existing squid.conf regex directives, but that is not
</I>&gt;<i> important because we are adding a _new_ directive that will need such
</I>&gt;<i> support. This email discusses the problem and proposes how to add a new
</I>&gt;<i> line (and other special characters) to regexes found in squid.conf and such.
</I>

With the current mix of squid.conf parsers this RFC seems irrelevant to me.

The developer designing a new directive also writes the parse_*() 
function that processes the config file line. All they have to do is 
avoid using the parser functions which implicitly do the problematic 
behaviour.
  The fact that there is logic imposing this problem at all is a bug to 
be resolved. But that is something for a different RFC.


&gt;<i> 
</I>&gt;<i> Programming languages usually have standard mechanisms for adding
</I>&gt;<i> special characters to strings from which regexes are compiled. We all
</I>&gt;<i> know that &quot;a\nb&quot; uses LF byte in the C++ string literal. Other bytes can
</I>&gt;<i> be added as well: <A HREF="https://en.cppreference.com/w/cpp/language/escape">https://en.cppreference.com/w/cpp/language/escape</A>
</I>&gt;<i> 
</I>
There was a plan from 2014 (re-attempted by Christos 2016) to migrate 
Squid from the GNURegex dependency to more flexible C++11 regex library 
which supports many regex languages. With that plan the UI would only 
need an option flag or pattern prefix to specify which language a 
pattern uses.

That plan was put on hold due to feature-incomplete GCC 4.8 versions 
being distributed by CentOS 7 and RHEL needing to build Squid.

One Core Developer (you Alex) has repeatedly expressed a strong opinion 
veto'ing the addition/removal of features to Squid-6 while they are 
still officially supported by a small set of &quot;officially supported&quot; 
Vendors. RHEL and CentOS being in that set.


When combined, those two design limitations mean the C++11 regex library 
cannot be implemented in a Squid released prior to June 2024.



IMO that plan is still a good one for long-term. However you design your 
new directive UI please make it compatible with that.


&gt;<i> Unfortunately, squid.conf syntax lacks a similar general mechanism.
</I>
This is not a property of squid.conf design choices. It is an artifact 
of the GNURegex language.

Until Squid gets a major upgrade to support other regex languages. We 
are stuck with these pattern limitations.

  In
&gt;<i> most cases, it is possible to work around that limitation by entering
</I>&gt;<i> special symbols directly. However, that trick causes various headaches
</I>&gt;<i> and does not work for new lines at all because squid.conf preprocessor
</I>&gt;<i> and parameter parser use/strip all new lines; the code compiling the
</I>&gt;<i> regular expression will simply not see any.
</I>&gt;<i> 
</I>&gt;<i> In POSIX regex(7), the two-character \n escape sequence is referring to
</I>&gt;<i> the ASCII character 'n', not the new line/LF character, so entering \n
</I>&gt;<i> (two characters) into a squid.conf regex value will not work if one
</I>&gt;<i> wants to match ASCII LF.
</I>&gt;<i> 
</I>&gt;<i> There are many options for adding this functionality to regexes used in
</I>&gt;<i> _new_ squid.conf contexts (i.e. contexts aware of this enhancement).
</I>&gt;<i> Here is a fairly representative sample:
</I>&gt;<i> 
</I>&gt;<i> 1a. Recognize just \n escape sequence in squid.conf regexes
</I>&gt;<i>     Pros: Simple.
</I>&gt;<i>     Cons: Converting old regexes[1] requires careful checking[2].
</I>&gt;<i>     Cons: Cannot detect typos in escape sequences. \r is accepted.
</I>&gt;<i>     Cons: Cannot address other, similar use cases (e.g., ASCII CR).
</I>&gt;<i> 
</I>&gt;<i> 1b. Recognize all C escape sequences in squid.conf regexes
</I>&gt;<i>     Pros: Can detect typos -- unsupported escape sequences.
</I>&gt;<i>     Cons: Poor readability: Double-escaping of all for-regex backslashes!
</I>&gt;<i>     Cons: Converting old regexes requires non-trivial automation.
</I>&gt;<i> 
</I>
As you mention these \-escape is a feature of POSIX Regular Expression 
language.

Taking this step we will no longer to honestly say that Squid is only 
supporting GNU &quot;regex&quot; patterns. Open the floodgate and you will find a 
mountain of admin wanting the other POSIX features for one reason or 
another.

We would be better accepting the long-ago planned migration to C++11 
regex than taking more half-measures like implementing \-escape patterns 
ourselves.


&gt;<i> 
</I>&gt;<i> 2a. Recognize %byte{n} logformat-like sequence in squid.conf regexes
</I>&gt;<i>     Pros: Simple.
</I>&gt;<i>     Cons: Converting old regexes[1] requires careful checking[3].
</I>&gt;<i>     Cons: Cannot detect typos in logformat-like sequences.
</I>&gt;<i>     Cons: Does not support other advanced use cases (e.g., %tr).
</I>&gt;<i> 
</I>&gt;<i> 2b. Recognize %byte{n} and logformat sequences in squid.conf regexes
</I>&gt;<i>     Pros: Can detect typos -- unsupported logformat sequences.
</I>&gt;<i>     Cons: The need to escape % in regexes will surprise admins.
</I>&gt;<i>     Cons: Converting old regexes requires (simple) automation.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 3. Use composition to combine regexes and some special strings:
</I>&gt;<i>     regex1 + &quot;\n&quot; + regex2
</I>&gt;<i>     or
</I>&gt;<i>     regex1 + %byte{10} + regex2
</I>&gt;<i>     Pros: Old regexes can be safely used without any conversions.
</I>&gt;<i>     Cons: Requires new, complex composition expressions/syntax.
</I>&gt;<i>     Cons: A bit difficult to read.
</I>&gt;<i>     Cons: Requires a lot of development.
</I>&gt;<i> 
</I>
Please no. There are enough regex languages confusing people. Lets not 
be responsible for creating yet another.

That is my clear &quot;no&quot; vote on all (2) and (3) idea variants.

&gt;<i> 
</I>&gt;<i> 4. Use 2b but only when regex is given to a special function:
</I>&gt;<i>     substitute_logformat_codes(regex)
</I>&gt;<i>     Pros: Old regexes can be safely used without any conversions.
</I>&gt;<i>     Pros: New regexes do not need to escape % (by default).
</I>&gt;<i>     Pros: Extendable to old regex configuration contexts.
</I>&gt;<i>     Pros: Extendable to non-regex configuration contexts.
</I>&gt;<i>     Pros: Reusing the existing parameters(...)-like call syntax.
</I>&gt;<i>     Cons: A bit more difficult to read than 1a or 2a.
</I>&gt;<i>     Cons: Duplicates &quot;quoted string&quot; approach in some directives[4].
</I>&gt;<i>     Cons: Requires arguing about the new function name :-).
</I>&gt;<i> 
</I>
Or (5) Alex puts aside his objection blocking the plan to convert Squid 
to C++11 regex library.


Cheers
Amos
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009757.html">[squid-dev] RFC: Adding a new line to a regex
</A></li>
	<LI>Next message (by thread): <A HREF="009758.html">[squid-dev] RFC: Adding a new line to a regex
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9756">[ date ]</a>
              <a href="thread.html#9756">[ thread ]</a>
              <a href="subject.html#9756">[ subject ]</a>
              <a href="author.html#9756">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
