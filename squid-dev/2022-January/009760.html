<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: Adding a new line to a regex
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Adding%20a%20new%20line%20to%20a%20regex&In-Reply-To=%3C6dc0b76a-3843-579b-2d7c-dc39db0bf8cd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009759.html">
   <LINK REL="Next"  HREF="009762.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: Adding a new line to a regex</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Adding%20a%20new%20line%20to%20a%20regex&In-Reply-To=%3C6dc0b76a-3843-579b-2d7c-dc39db0bf8cd%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: Adding a new line to a regex">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Jan 22 04:17:02 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009759.html">[squid-dev] RFC: Adding a new line to a regex
</A></li>
        <LI>Next message (by thread): <A HREF="009762.html">[squid-dev] [squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9760">[ date ]</a>
              <a href="thread.html#9760">[ thread ]</a>
              <a href="subject.html#9760">[ subject ]</a>
              <a href="author.html#9760">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>TLDR: Solutions #4 (substitute_logformat_codes) and #6 (STL regex) are
still leading. The next key question is: Do we want this feature to be
the last drop that brings STL regex support to Squid? If yes, #6 wins
IMO. Two followup questions at the end of the email, below details...


On 1/21/22 8:59 PM, Amos Jeffries wrote:
&gt;<i> On 22/01/22 08:36, Alex Rousskov wrote:
</I>&gt;&gt;<i> TLDR: I am adding solution #6 into the mix based on Amos email (#5 was
</I>&gt;&gt;<i> taken by Eduard). Amos needs to clarify why he thinks that Squid master
</I>&gt;&gt;<i> branch cannot accept STL-based regexes &quot;now&quot;. After that, we can decide
</I>&gt;&gt;<i> whether #6 remains a viable candidate. Details below.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 1/21/22 12:42 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 20/01/22 10:32, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> We have a use case where a regex in squid.conf should contain/match
</I>&gt;&gt;&gt;&gt;<i> a new line [...] This email discusses the problem and proposes how
</I>&gt;&gt;&gt;&gt;<i> to add a new line (and other special characters) to regexes found
</I>&gt;&gt;&gt;&gt;<i> in squid.conf and such.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> With the current mix of squid.conf parsers this RFC seems irrelevant
</I>&gt;&gt;&gt;<i> to me.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not understand the relationship between &quot;the current mix of
</I>&gt;&gt;<i> squid.conf parsers&quot; and this RFC relevance. This RFC is relevant because
</I>&gt;&gt;<i> it is about a practical solution to a real problem facing real Squid
</I>&gt;&gt;<i> admins.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Sentence #2 of the RFC explicitly states that admin needs are not
</I>&gt;<i> relevant &quot;I do not know whether there are similar use
</I>&gt;<i> cases with the existing squid.conf regex directives&quot;
</I>
There is no connection between that sentence and admin needs:

* Admin needs are not limited to the existing squid.conf regex directives.

* It is possible that similar needs do exist for the existing squid.conf
regex directives. I just do not know it. This existence is not required
for the RFC to be relevant (because of the first bullet).


&gt;<i> The same sentence delimits RFC scope as: &quot;adding a _new_ directive that
</I>&gt;<i> will need such support.&quot;
</I>
Correct.


&gt;<i> That means the syntax defining how the regex pattern is configured does
</I>&gt;<i> not yet exist. It is not necessary for the developer to design their
</I>&gt;<i> _new_ UI syntax in a way that exposes admin to this problem in the first
</I>&gt;<i> place. Simply design the
</I>
The above paragraph was cut short, but I agree with its beginning: It is
not necessary. In fact, I would say that hitting the problem we are
trying to solve would be a very bad idea! However, our definition of
&quot;way that exposes&quot; may differ.


&gt;&gt;<i> Whether Squid has one parser or ten, good ones or bad ones, is relevant
</I>&gt;&gt;<i> to how the solution is implemented/integrated with Squid, of course, but
</I>&gt;&gt;<i> that is already a part of the analysis on this thread.
</I>
&gt;<i> Very relevant.
</I>
Glad we agree.


&gt;<i> RFC cites &quot;squid.conf preprocessor and parameter parser
</I>&gt;<i> use/strip all new lines&quot; as a problem.
</I>&gt;<i>
</I>&gt;<i> I point out that this behaviour depends on *which* config parser is
</I>&gt;<i> chosen to be used by the (again _new_) directive. It should be an
</I>&gt;<i> implementation detail for the dev, not design consideration for this RFC.
</I>
The behavior I described is rooted in the _preprocessor_ behavior, so
one cannot work around it by inventing a new directive parser. By the
time we get to the directive parser, it is already too late -- the new
lines are already stripped.

Finally, even if we modify the preprocessor to preserve new lines in
some special cases, preserving real new lines is actually not a good
solution at all! That solution results in very awkward-looking
configuration statements. The code would not care, of course, but humans
writing those statements will. All of the proposed solutions are better IMO.


&gt;<i> I must state that I do not see much in the say of squid.conf syntax
</I>&gt;<i> discussion in the RFC text. It seems to focus a lot on syntax inside the
</I>&gt;<i> regex pattern.
</I>
... which is obviously a part of the encompassing squid.conf syntax, but
it does not really matter -- if you prefer to think of this RFC as
discussing regex pattern syntax, you can do that and still make correct
decisions AFAICT.


&gt;<i> IMO regex is such a complicated situation that we should avoid having
</I>&gt;<i> special things inside or on top of its syntax. That is a recipe for
</I>&gt;<i> admin pain.
</I>
I agree, we should, but we also should solve the problem this RFC is
addressing. The problem obviously has acceptable solutions. There is no
reason to say &quot;regex are too complicated&quot; and walk away. We can make
things better here by finding the best solution we can find.


&gt;&gt;<i> 6. Use STL regex features that support \n and similar escape sequences
</I>&gt;&gt;<i> Pros: Supports much more than just advanced escape sequences!
</I>&gt;&gt;<i> Pros: The new syntax is easy to document by referencing library docs.
</I>&gt;<i> 
</I>&gt;<i> Pro: we do not have to write any part of pattern matching ourselves.
</I>&gt;<i> Simpler config parser.
</I>&gt;<i> 
</I>&gt;<i> Pro: we do not have to maintain custom code supporting special
</I>&gt;<i> behaviours in regex pattern configuration.
</I>&gt;<i> 
</I>&gt;<i> Pro: we do not have to provide additional user support for non-standard
</I>&gt;<i> squid.conf patterns.
</I>&gt;<i> 
</I>&gt;<i> Pro: we do not have to waste brain cycles designing how to integrate
</I>&gt;<i> syntax into regex patterns cleanly.
</I>
Some of the new Pros above are serious exaggerations, but I do not think
we need to fight over these details at this point.


&gt;&gt;<i> Cons: Requires serious changes to the internal regex support in Squid.
</I>
&gt;<i> IIRC, the changes are not as serious as it may seem. The largest part is
</I>&gt;<i> squid.conf parser alteration to accept the proposals flag/prefix and
</I>&gt;<i> patterns cleanly. Beyond that is just a switch of container which is
</I>&gt;<i> easy (not trivial, just easy).
</I>
Given the poor state of some underlying C++ classes, and the code using
them, it will not be easy to do this correctly IMO. I have seen easier
changes take a lot of iterations to get right and to merge, for many
reasons that are still here.

However, I do not think we have to argue about the exact difficulty
level of this task for now. You say &quot;easy&quot;. I say &quot;serious&quot;. I doubt
this vague difference in our estimates will decide which solution is the
best. If it will, we can come back to this item.


&gt;&gt;<i> Cons: Miserable STL regex performance in some environments[1,2]?
</I>&gt;<i> 
</I>&gt;<i> IMO this is balanced by Squid existing regex being well known to have
</I>&gt;<i> similar performance issues.
</I>
We can always make things much worse by adding STL regex library-induced
delays to the existing Squid delays. AFAICT, many folks believe that the
GNU regex library we are using is much faster than some popular STL
library implementations. Whether most of that difference is in memory
allocations and whether most of those memory allocations are equally bad
for existing GNU regex code in Squid is currently unknown.

I suspect we will not know for sure until we implement at least some
rudimentary form of STL regex support so that we can do a meaningful
test (for a given STL implementation).


&gt;&gt;<i> Cons: Converting old regexes requires (complex) automation.
</I>&gt;<i> 
</I>&gt;<i> Disagree this is problem.
</I>&gt;<i> 
</I>&gt;<i> GNU regex is predecessor syntax behind all modern regex variants. We can
</I>&gt;<i> retain GNUregex as the default pattern and require language flag/prefix
</I>&gt;<i> for patterns needing modern features.
</I>
We can, but this is not what this Cons item is talking about. This
specific Cons item is talking about the cost of a decision by an admin
and/or (eventually) the Squid Project to switch to _one_ (new) regex
style everywhere. At that point, complex conversion will be required.

You may believe that that moment will never come. I am not so sure
because there is obviously value in using (new) regexes and using one
regex style everywhere. I do not think we need to agree on this.


&gt;&gt;<i> Cons: Requires dropping GCC v4.8 support.
</I>&gt;&gt;<i> Cons: Amos thinks Squid cannot support STL regex until 2024.
</I>&gt;<i> 
</I>&gt;<i> the technical part of my earlier statement is already
</I>&gt;<i> covered by the GCC 4.8 line.
</I>
Since I did not know what your assertions regard 2024 are based on, I
could not safely merge the two entries. If this is just about GCC v4.8,
I will disregard the second one.


&gt;&gt;<i> [2] STL does not allow us to define a custom allocator for its regexes.
</I>&gt;&gt;<i> Various STL implementations have various hidden workarounds, but we will
</I>&gt;&gt;<i> be at their (varying) mercy.
</I>
&gt;<i> probably should be a Con in its own right.
</I>
Sure, let's treat it as such.



&gt;&gt;&gt;<i> One Core Developer (you Alex) has repeatedly expressed a strong opinion
</I>&gt;&gt;&gt;<i> veto'ing the addition/removal of features to Squid-6 while they are
</I>&gt;&gt;&gt;<i> still officially supported by a small set of &quot;officially supported&quot;
</I>&gt;&gt;&gt;<i> Vendors. RHEL and CentOS being in that set.
</I>
&gt;&gt;<i> Sorry, I have no idea what you are talking about.
</I>
&gt;<i> Your latest voicing of it was in
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2021-December/009743.html">http://lists.squid-cache.org/pipermail/squid-dev/2021-December/009743.html</A>
</I>
Nothing in that email precludes stopping GCC v4.8 support in master.


&gt;&gt;<i> &quot;
</I>&gt;&gt;<i> Any
</I>&gt;&gt;<i> known Squid regression affecting the &quot;main&quot; environment should block the
</I>&gt;&gt;<i> PR introducing that regression IMO.
</I>&gt;&gt;<i> &quot;
</I>
I still believe the above assertion is correct, but it is irrelevant
here. Regression tests do not drive what Project changes are possible.
*We* decide which environments we support, not our regression tests!


&gt;<i> The definition of &quot;main&quot; under discussion in that thread never reached
</I>&gt;<i> consensus to change away from the existing OS represented by the Jenkins
</I>&gt;<i> 5-pr-test nodes. So (for now) it still includes LTS versions of RHEL /
</I>&gt;<i> CentOS 7 shipping the broken GCC 4.8.x std::regex.
</I>
Yes, but so what?! We have the power to decide:

1. Whether master must continue to support GCC v4.8. If we decide that
we should drop that support (for various good reasons beyond this RFC),
then we will obviously stop testing Squid for GCC v4.8 regressions or
move those tests into the &quot;optional&quot; or non-blocking categories.

2. Whether the new feature must be available in GCC v4.8 builds. If
there are good reasons to base this feature on STL regexes, and good
reasons to keep GCC v4.8 support, then we _can_ make the new feature
conditional on newer compilers. Doing so increases implementation
complexity and support headaches, but it is technically possible. We
already have a Cons item to remind us about this problem. I am not
saying this is something we should do, only that this is an option to
consider.

I knew I was not repeatedly vetoing dropping GCC v4.8. Glad this was
clarified, putting one more wild misinterpretation behind us.


Do you think we should bite the bullet and add STL regex support to
Squid master branch?

If yes, I suggest _postponing_ the decision regarding GCC v4.8 support
until it becomes clear how difficult it would be to make the new code
_compile_ on GCC v4.8? I know it is not going to _work_, but Squid can
easily detect that and reject configurations that are using new regexes
with GCC v4.8 builds. &quot;Sorry, you cannot use this regex with this
binary&quot; errors are not ideal, but this approach saves a lot of work, and
adds support for the vast majority of Squid deployments that are willing
to run master/v6.


Thank you,

Alex.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009759.html">[squid-dev] RFC: Adding a new line to a regex
</A></li>
	<LI>Next message (by thread): <A HREF="009762.html">[squid-dev] [squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9760">[ date ]</a>
              <a href="thread.html#9760">[ thread ]</a>
              <a href="subject.html#9760">[ subject ]</a>
              <a href="author.html#9760">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
