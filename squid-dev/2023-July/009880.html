<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: Transitioning ipcache and fqdncache to ClpMap
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Transitioning%20ipcache%20and%20fqdncache%20to%20ClpMap&In-Reply-To=%3C2bae8fea-8598-a0b9-e74a-024edb9d60af%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009879.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: Transitioning ipcache and fqdncache to ClpMap</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20Transitioning%20ipcache%20and%20fqdncache%20to%20ClpMap&In-Reply-To=%3C2bae8fea-8598-a0b9-e74a-024edb9d60af%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: Transitioning ipcache and fqdncache to ClpMap">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jul 11 13:50:27 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009879.html">[squid-dev] RFC: Transitioning ipcache and fqdncache to ClpMap
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9880">[ date ]</a>
              <a href="thread.html#9880">[ thread ]</a>
              <a href="subject.html#9880">[ subject ]</a>
              <a href="author.html#9880">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/11/23 03:35, Francesco Chemolli wrote:

&gt;<i> I'd like to start working on transitioning ipcache and fqdncache to 
</I>&gt;<i> ClpMap.
</I>
Thank you. Please _plan_ to convert them both (as you are already doing 
here!), but then convert them one at a time (to avoid duplicating 
review/modification efforts). I bet we will need at least 6 &quot;minimal&quot; 
PRs here.


&gt;<i> There is only one snag,
</I>
FWIW, I did not check all the details, but I see two more snags, 
including a very important/difficult one:

2. ipcache.cc code &quot;locks&quot; entries to prevent their removal from the 
cache in certain cases. See ipcache_entry::locks. The corresponding code 
already has serious problems, but the approach itself needs to be 
refactored using RefCount, so that a cache entry can be removed from the 
cache at any time. This is not going to be easy and will require at 
least one dedicated PR, but I believe it is an essential preliminary step.

3. We should also remove ipcache_low and ipcache_high directives before 
the conversion. Those two parameters do not make sense for an 
instant-removal cache: They are not needed for anything useful, create 
performance anomalies, and increase code/configuration complexity. The 
corresponding logic is not supported by ClpMap.


Now back to your snag #1:

&gt;<i> the current configuration directives specify a cache 
</I>&gt;<i> size in number of entries, where ClpMap specifies a max size.
</I>&gt;<i> 
</I>&gt;<i> I can see two ways forward:
</I>&gt;<i> 1. Add a second max-size parameter to ClpMap, ensuring that it starts 
</I>&gt;<i> expunging entries when the maximum capacity in either memory use or 
</I>&gt;<i> number of entries is reached
</I>
I am not against this option, especially if we deprecate/remove existing 
count-based configuration (ipcache_size and friends) and add byte-based 
configuration to replace it (the directive name is to be determined).


&gt;<i> 2. guesstimate how many bytes of memory an ipcache/fqdncache&#160;uses, and 
</I>&gt;<i> convert
</I>
I support this option if we deprecate/remove existing counter-based 
configuration (ipcache_size and friends) and add bytes-based 
configuration (the directive name is to be determined). I prefer this 
option in this case because it avoids making ClpMap code more complex 
long-term just to accommodate a short-term deprecation need. The extra 
code complexity is not huge, but cache limit enforcement is tricky, and 
the history of the related ClpMap code suggests that adding a new limit 
vector will take several (likely painful) iterations.


&gt;<i> Regardless, I believe that from the user-facing perspective, a solid way 
</I>&gt;<i> forward is to give to the ipcache_size and fqdncache_size directives an 
</I>&gt;<i> option to specify a max size in entries or, by adding a memory-size 
</I>&gt;<i> suffix, in used memory, and possibly deprecate the max-size-in-entries 
</I>&gt;<i> option in Squid 7 and retire it in squid 8.
</I>
In the vast majority of deployments, the existing count-based limit is 
inferior to the byte-based limit because memory bytes is a real resource 
that admins understand and have to optimize/ration/limit (while the 
number of entries has no direct relationship to anything most admins 
should care about). Thus, long-term, we should provide byte-based 
configuration options.

To keep things simple and to facilitate deprecation, I recommend adding 
two new directives instead of making the existing directives more 
complex. Naming is a separate/secondary issue, but we can model the new 
names based on the two existing primary caches (cache_dir and 
cache_mem).  Alternatively, we can use a more natural(?) word order. 
Here are a few variants (from most to least preferred by me):

* dns_cache and reverse_dns_cache
* cache_dns and cache_dns_reverse
* cache_ip and cache_domain


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009879.html">[squid-dev] RFC: Transitioning ipcache and fqdncache to ClpMap
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9880">[ date ]</a>
              <a href="thread.html#9880">[ thread ]</a>
              <a href="subject.html#9880">[ subject ]</a>
              <a href="author.html#9880">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
