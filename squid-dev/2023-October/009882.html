<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20make%20FOLLOW_X_FORWARDED_FOR%20unconditional&In-Reply-To=%3C75259d19-7550-4614-a850-de7b726c30dd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009881.html">
   <LINK REL="Next"  HREF="009884.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20make%20FOLLOW_X_FORWARDED_FOR%20unconditional&In-Reply-To=%3C75259d19-7550-4614-a850-de7b726c30dd%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Oct 10 19:19:05 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009881.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
        <LI>Next message (by thread): <A HREF="009884.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9882">[ date ]</a>
              <a href="thread.html#9882">[ thread ]</a>
              <a href="subject.html#9882">[ subject ]</a>
              <a href="author.html#9882">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-10-10 12:17, Francesco Chemolli wrote:

&gt;<i> what if we removed the configure option for&#160;FOLLOW_X_FORWARDED_FOR, and
</I>&gt;<i> made it unconditionally part of Squid?
</I>
Some Squid deployments will silently break AFAICT.


&gt;<i> It is on by default,
</I>
Here, &quot;it&quot; should be viewed as a combination of FOLLOW_X_FORWARDED_FOR 
and the directives that macro enables (by default). Unfortunately, some 
of those directives are on by default[1]. This implies that, after we 
remove FOLLOW_X_FORWARDED_FOR, a Squid built with 
--disable-follow-x-forwarded-for will start doing something it was not 
doing before, and the behavior changes should be assumed to be 
significant until you can prove otherwise.


&gt;<i> and it is controlled by runtime configuration,
</I>
... but not in a good way: Squid code cannot tell whether 
follow_x_forwarded_for is &quot;enabled&quot; beyond checking 
FOLLOW_X_FORWARDED_FOR. It is possible to change that, but changing that 
(and adjusting how other related directives are checked!) requires 
non-trivial work. See (B) below.


&gt;<i> removing the compile-time option would ensure we have better testing 
</I>&gt;<i> coverage.
</I>
Indeed. I support removal of this and similar unnecessary compile-time 
options, but because related directives[1] are _on_ by default (in 
--enable-follow-x-forwarded-for and equivalent builds), we should not 
just enable this feature, screwing up folks that disabled it explicitly 
in their builds.

Also, the current implementation of XFF code is fairly expensive -- it 
requires slow ACL checks. If we just remove that FOLLOW_X_FORWARDED_FOR 
guard, we will be adding quite a few wasted CPU cycles to all Squid 
builds that (used to) disable that feature.


[1] squid.conf directives that are enabled by default in 
--enable-follow-x-forwarded-for and equivalent builds include: 
log_uses_indirect_client, adaptation_uses_indirect_client, 
acl_uses_indirect_client, delay_pool_uses_indirect_client.


I see a few possible strategies here:

A) Make ./configure --disable-follow-x-forwarded-for fail. Easy to 
implement but kind of goes against ./configure tradition and leaves a 
backward compatibility hack in Squid code. It also forces admins that do 
_not_ want this feature to disable 4+ directives they do not care about 
-- bad UX. I am against this option.

B) Make all *_uses_indirect_client and similar directives default to off 
unless the configuration contains an explicit follow_x_forwarded_for 
rule. Warn if one of those directives is explicitly on when there are no 
explicit follow_x_forwarded_for rules. This requires non-trivial work. 
That work will probably fix a few existing bugs. I support this option.


HTH,

Alex.


&gt;<i> AccessLogEntry.cc:#if FOLLOW_X_FORWARDED_FOR
</I>&gt;<i> AccessLogEntry.cc-    if (Config.onoff.log_uses_indirect_client &amp;&amp; request)
</I>&gt;<i> AccessLogEntry.cc-        log_ip = request-&gt;indirect_client_addr;
</I>&gt;<i> AccessLogEntry.cc-    else
</I>&gt;<i> AccessLogEntry.cc-#endif
</I>&gt;<i> AccessLogEntry.cc-        if (tcpClient)
</I>&gt;<i> AccessLogEntry.cc-            log_ip = tcpClient-&gt;remote;
</I>&gt;<i> AccessLogEntry.cc-        else
</I>&gt;<i> AccessLogEntry.cc-            log_ip = cache.caddr;
</I>

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009881.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
	<LI>Next message (by thread): <A HREF="009884.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9882">[ date ]</a>
              <a href="thread.html#9882">[ thread ]</a>
              <a href="subject.html#9882">[ subject ]</a>
              <a href="author.html#9882">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
