<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20make%20FOLLOW_X_FORWARDED_FOR%20unconditional&In-Reply-To=%3Cc37ebcc0-e0a9-4276-bf31-c8f0577aa1f9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009882.html">
   <LINK REL="Next"  HREF="009888.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20make%20FOLLOW_X_FORWARDED_FOR%20unconditional&In-Reply-To=%3Cc37ebcc0-e0a9-4276-bf31-c8f0577aa1f9%40treenet.co.nz%3E"
       TITLE="[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 11 07:15:50 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009882.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
        <LI>Next message (by thread): <A HREF="009888.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9884">[ date ]</a>
              <a href="thread.html#9884">[ thread ]</a>
              <a href="subject.html#9884">[ subject ]</a>
              <a href="author.html#9884">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/10/23 08:19, Alex Rousskov wrote:
&gt;<i> On 2023-10-10 12:17, Francesco Chemolli wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> what if we removed the configure option for&#160;FOLLOW_X_FORWARDED_FOR, and
</I>&gt;&gt;<i> made it unconditionally part of Squid?
</I>&gt;<i> 
</I>&gt;<i> Some Squid deployments will silently break AFAICT.
</I>&gt;<i> 
</I>
In what way specifically?


&gt;<i> 
</I>&gt;&gt;<i> It is on by default,
</I>&gt;<i> 
</I>&gt;<i> Here, &quot;it&quot; should be viewed as a combination of FOLLOW_X_FORWARDED_FOR 
</I>&gt;<i> and the directives that macro enables (by default). Unfortunately, some 
</I>&gt;<i> of those directives are on by default[1]. This implies that, after we 
</I>&gt;<i> remove FOLLOW_X_FORWARDED_FOR, a Squid built with 
</I>&gt;<i> --disable-follow-x-forwarded-for will start doing something it was not 
</I>&gt;<i> doing before, and the behavior changes should be assumed to be 
</I>&gt;<i> significant until you can prove otherwise.
</I>&gt;<i> 
</I>
The Proof is in cf.data.pre:
&quot;
   NAME: follow_x_forwarded_for
...
   DEFAULT_IF_NONE: deny all
   DEFAULT_DOC: X-Forwarded-For header will be ignored.
&quot;

Removing FOLLOW_X_FORWARDED_FOR will make installations which previously 
were not able to run with follow_x_forwarded_for configured would begin 
behaving as if &quot;follow_x_forwarded_for deny all&quot; was configured.

That is behaviorally the same as --disable-follow-x-forwarded-for.



&gt;<i> 
</I>&gt;&gt;<i> and it is controlled by runtime configuration,
</I>&gt;<i> 
</I>&gt;<i> ... but not in a good way: Squid code cannot tell whether 
</I>&gt;<i> follow_x_forwarded_for is &quot;enabled&quot; beyond checking 
</I>&gt;<i> FOLLOW_X_FORWARDED_FOR. It is possible to change that, but changing that 
</I>&gt;<i> (and adjusting how other related directives are checked!) requires 
</I>&gt;<i> non-trivial work. See (B) below.
</I>&gt;<i> 
</I>
I do not see a transition problem here.

As per the above cf.data.pre contents, only installations which already 
were using --enable-follow-x-forwarded-for were able to set the related 
configuration options. They would not see any change.


&gt;<i> 
</I>&gt;&gt;<i> removing the compile-time option would ensure we have better testing 
</I>&gt;&gt;<i> coverage.
</I>&gt;<i> 
</I>&gt;<i> Indeed. I support removal of this and similar unnecessary compile-time 
</I>&gt;<i> options, but because related directives[1] are _on_ by default (in 
</I>&gt;<i> --enable-follow-x-forwarded-for and equivalent builds), we should not 
</I>&gt;<i> just enable this feature, screwing up folks that disabled it explicitly 
</I>&gt;<i> in their builds.
</I>
IMO that is easily resolved. Just drop the DEFAULT_IF_NONE stanza from 
cf.data.pre and modify the if-statement in 
ClientRequestContext::clientAccessCheck() to set 
http-&gt;request-&gt;indirect_client_addr whenever 
&quot;!Config.accessList.followXFF&quot;.
That will avoid any &quot;screwing over&quot; because the &quot;indirect&quot; IP would be 
the same as the &quot;direct&quot; IP under the above default 
follow_x_forwarded_for behavior.

Even if admin has misconfigured one of those *_indirect_client settings 
the implicit/default &quot;follow_x_forwarded_for deny all&quot; makes the correct 
IP be used.


&gt;<i> 
</I>&gt;<i> Also, the current implementation of XFF code is fairly expensive -- it 
</I>&gt;<i> requires slow ACL checks. If we just remove that FOLLOW_X_FORWARDED_FOR 
</I>&gt;<i> guard, we will be adding quite a few wasted CPU cycles to all Squid 
</I>&gt;<i> builds that (used to) disable that feature.
</I>&gt;<i> 
</I>
Dropping the &quot;DEFAULT_IF_NONE&quot; stanza entirely avoids all the ACL costs 
by default, without changing the above behavior analysis that proves IMO 
this feature as safe to enable.

Bonus: it would also avoid the ACL cycles currently wasted on 
installations where the feature is already enabled but not configured.

Extra bonus: any logic which specifically relies on testing 
(!)FOLLOW_X_FORWARDED_FOR can switch to checking 
(!)Config.accessList.followXFF instead.


&gt;<i> 
</I>&gt;<i> [1] squid.conf directives that are enabled by default in 
</I>&gt;<i> --enable-follow-x-forwarded-for and equivalent builds include: 
</I>&gt;<i> log_uses_indirect_client, adaptation_uses_indirect_client, 
</I>&gt;<i> acl_uses_indirect_client, delay_pool_uses_indirect_client.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I see a few possible strategies here:
</I>&gt;<i> 
</I>&gt;<i> A) Make ./configure --disable-follow-x-forwarded-for fail. Easy to 
</I>&gt;<i> implement but kind of goes against ./configure tradition and leaves a 
</I>&gt;<i> backward compatibility hack in Squid code. It also forces admins that do 
</I>&gt;<i> _not_ want this feature to disable 4+ directives they do not care about 
</I>&gt;<i> -- bad UX. I am against this option.
</I>
Unnecessary. For reasons detailed above.

&gt;<i> 
</I>&gt;<i> B) Make all *_uses_indirect_client and similar directives default to off 
</I>&gt;<i> unless the configuration contains an explicit follow_x_forwarded_for 
</I>&gt;<i> rule.
</I>
&gt;<i> Warn if one of those directives is explicitly on when there are no 
</I>&gt;<i> explicit follow_x_forwarded_for rules. This requires non-trivial work. 
</I>
IMO this is optional. A &quot;nice to have&quot; UI behaviour that a lot of 
squid.conf settings could do, but do not (yet).

The future ConfigParser redesign project changes are likely to make this 
type of check a lot easier to implement in an entirely different way 
than it would have to be done right now. So IMO there is no hurry to 
rush/require this change.


&gt;<i> That work will probably fix a few existing bugs. I support this option.
</I>&gt;<i> 
</I>

C) Just drop the DEFAULT_IF_NONE stanza from cf.data.pre and modify the 
if-statement in ClientRequestContext::clientAccessCheck() like so:

&quot;
    if (!http-&gt;request-&gt;flags.doneFollowXff()) {

         /* we always trust the direct client address for actual use */
         http-&gt;request-&gt;indirect_client_addr = http-&gt;request-&gt;client_addr;
         http-&gt;request-&gt;indirect_client_addr.port(0);

         if (Config.accessList.followXFF &amp;&amp;
             http-&gt;request-&gt;header.has(Http::HdrType::X_FORWARDED_FOR)) {

... current logic except above indirect_client_addr lines ...

         }
         return;
     }
&quot;


HTH
Amos
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009882.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
	<LI>Next message (by thread): <A HREF="009888.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9884">[ date ]</a>
              <a href="thread.html#9884">[ thread ]</a>
              <a href="subject.html#9884">[ subject ]</a>
              <a href="author.html#9884">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
