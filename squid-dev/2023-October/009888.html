<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20make%20FOLLOW_X_FORWARDED_FOR%20unconditional&In-Reply-To=%3C63379553-9173-4abf-8f41-3523221f214a%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009884.html">
   <LINK REL="Next"  HREF="009885.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20RFC%3A%20make%20FOLLOW_X_FORWARDED_FOR%20unconditional&In-Reply-To=%3C63379553-9173-4abf-8f41-3523221f214a%40measurement-factory.com%3E"
       TITLE="[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct 11 15:41:03 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009884.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
        <LI>Next message (by thread): <A HREF="009885.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9888">[ date ]</a>
              <a href="thread.html#9888">[ thread ]</a>
              <a href="subject.html#9888">[ subject ]</a>
              <a href="author.html#9888">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-10-11 03:15, Amos Jeffries wrote:
&gt;<i> On 11/10/23 08:19, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 2023-10-10 12:17, Francesco Chemolli wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> what if we removed the configure option for&#160;FOLLOW_X_FORWARDED_FOR, and
</I>&gt;&gt;&gt;<i> made it unconditionally part of Squid?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some Squid deployments will silently break AFAICT.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> In what way specifically?
</I>
I believe my original email have provided specific problems. Your 
response assessed some of those specific problems are &quot;easily resolved&quot;. 
Thus, AFAICT, you know at least of some specific problems and do not 
need me to answer this particular question.


&gt;&gt;<i> some of those directives are on by default[1]. This implies that, 
</I>&gt;&gt;<i> after we remove FOLLOW_X_FORWARDED_FOR, a Squid built with 
</I>&gt;&gt;<i> --disable-follow-x-forwarded-for will start doing something it was not 
</I>&gt;&gt;<i> doing before, and the behavior changes should be assumed to be 
</I>&gt;&gt;<i> significant until you can prove otherwise.
</I>
&gt;<i> The Proof is in cf.data.pre:
</I>&gt;<i> &quot;
</I>&gt;<i>  &#160; NAME: follow_x_forwarded_for
</I>&gt;<i> ...
</I>&gt;<i>  &#160; DEFAULT_IF_NONE: deny all
</I>&gt;<i>  &#160; DEFAULT_DOC: X-Forwarded-For header will be ignored.
</I>&gt;<i> &quot;
</I>&gt;<i> 
</I>&gt;<i> Removing FOLLOW_X_FORWARDED_FOR will make installations which previously 
</I>&gt;<i> were not able to run with follow_x_forwarded_for configured would begin 
</I>&gt;<i> behaving as if &quot;follow_x_forwarded_for deny all&quot; was configured.
</I>
&gt;<i> That is behaviorally the same as --disable-follow-x-forwarded-for.
</I>
If you exclude performance from &quot;behavior&quot;, then, yes, 
follow_x_forwarded_for will be behaviorally the same as with 
--disable-follow-x-forwarded-for.

However, even if we ignore performance, follow_x_forwarded_for is not 
the whole story because, as I said, there are _other_ affected 
squid.conf directives[1] that will become turned on by default if we 
remove FOLLOW_X_FORWARDED_FOR guard. Any correct proof must account for 
those directives code as well. The above proof does not.


&gt;&gt;<i> Squid code cannot tell whether 
</I>&gt;&gt;<i> follow_x_forwarded_for is &quot;enabled&quot; beyond checking 
</I>&gt;&gt;<i> FOLLOW_X_FORWARDED_FOR. It is possible to change that, but changing 
</I>&gt;&gt;<i> that (and adjusting how other related directives are checked!) 
</I>&gt;&gt;<i> requires non-trivial work. See (B) below.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I do not see a transition problem here.
</I>&gt;<i> 
</I>&gt;<i> As per the above cf.data.pre contents, only installations which already 
</I>&gt;<i> were using --enable-follow-x-forwarded-for were able to set the related 
</I>&gt;<i> configuration options. They would not see any change.
</I>
My concern is (still) about installations that were using 
--disable-follow-x-forwarded for. Those installations will see a change 
[because they will get a bunch of options and the corresponding code 
that gets enabled by default in their environment after the upgrade].


&gt;<i> IMO that is easily resolved. Just drop the DEFAULT_IF_NONE stanza from 
</I>&gt;<i> cf.data.pre and modify the if-statement in 
</I>&gt;<i> ClientRequestContext::clientAccessCheck() to set 
</I>&gt;<i> http-&gt;request-&gt;indirect_client_addr whenever 
</I>&gt;<i> &quot;!Config.accessList.followXFF&quot;.
</I>
I agree that this DEFAULT_IF_NONE should be dropped during this 
conversion (or in a separate minimal PR; BTW, all &quot;DEFAULT_IF_NONE: deny 
all&quot; should probably be removed, with the corresponding code adjusted as 
needed).

I disagree that the above change alone is an acceptable solution. Among 
other things mentioned in my original response, we should refactor so 
that callers cannot use indirect_client_addr when it was not set, and so 
that indirect_client_addr is only set when an follow_x_forwarded_for 
match has allowed it to be set.

Most likely, access to the client address should be protected (wrapped 
in a parameterized accessor method). This protection is probably a good 
idea regardless, but if Francesco does not want to implement (B), then 
this kind of protection may become an essential part of the proof.


&gt;<i> That will avoid any &quot;screwing over&quot; because the &quot;indirect&quot; IP would be 
</I>&gt;<i> the same as the &quot;direct&quot; IP under the above default 
</I>&gt;<i> follow_x_forwarded_for behavior.
</I>
Setting indirect_client_addr to an address other than the indirect 
client address is an obvious code quality problem that we should avoid. 
Relying on indirect_client_addr being set (to any value) by code X, when 
we know that code X is not reached in some cases is another problem we 
should avoid in this refactoring.


&gt;&gt;<i> [1] squid.conf directives that are enabled by default in 
</I>&gt;&gt;<i> --enable-follow-x-forwarded-for and equivalent builds include: 
</I>&gt;&gt;<i> log_uses_indirect_client, adaptation_uses_indirect_client, 
</I>&gt;&gt;<i> acl_uses_indirect_client, delay_pool_uses_indirect_client.
</I>

&gt;&gt;<i> B) Make all *_uses_indirect_client and similar directives default to 
</I>&gt;&gt;<i> off unless the configuration contains an explicit 
</I>&gt;&gt;<i> follow_x_forwarded_for rule.
</I>&gt;<i> 
</I>&gt;&gt;<i> Warn if one of those directives is explicitly on when there are no 
</I>&gt;&gt;<i> explicit follow_x_forwarded_for rules. This requires non-trivial work. 
</I>
&gt;<i> IMO this is optional. A &quot;nice to have&quot; UI behaviour that a lot of 
</I>&gt;<i> squid.conf settings could do, but do not (yet).
</I>
I agree that a misconfiguration warning is an optional improvement. It 
is very easy to implement though, and I would encourage Francesco to 
start in that direction (i.e. the direction of a good solution) rather 
than starting by adding more hacks and workarounds.

Overall, a PR that enables configuration options that should not be 
enabled is much worse than a PR does does not have that flaw, even if 
both PRs result in the same &quot;behavior&quot; of then-current Squid code due to 
workarounds in the worse PR. This is especially true when the problem 
was foreseen before the start of the development and has a 
straightforward solution, with several positive side-effects.


&gt;<i> C) Just drop the DEFAULT_IF_NONE stanza from cf.data.pre and modify the 
</I>&gt;<i> if-statement in ClientRequestContext::clientAccessCheck() like so:
</I>&gt;<i> 
</I>&gt;<i> &quot;
</I>&gt;<i>  &#160;&#160; if (!http-&gt;request-&gt;flags.doneFollowXff()) {
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160; /* we always trust the direct client address for actual use */
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160; http-&gt;request-&gt;indirect_client_addr = http-&gt;request-&gt;client_addr;
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160; http-&gt;request-&gt;indirect_client_addr.port(0);
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160; if (Config.accessList.followXFF &amp;&amp;
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; http-&gt;request-&gt;header.has(Http::HdrType::X_FORWARDED_FOR)) {
</I>&gt;<i> 
</I>&gt;<i> ... current logic except above indirect_client_addr lines ...
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160; }
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160; return;
</I>&gt;<i>  &#160;&#160;&#160; }
</I>&gt;<i> &quot;
</I>
See above for (C) analysis. Let's do this right instead of adding 
another hack on top of an already problematic (but currently optional!) 
XFF code.


Thank you,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009884.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
	<LI>Next message (by thread): <A HREF="009885.html">[squid-dev] RFC: make FOLLOW_X_FORWARDED_FOR unconditional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9888">[ date ]</a>
              <a href="thread.html#9888">[ thread ]</a>
              <a href="subject.html#9888">[ subject ]</a>
              <a href="author.html#9888">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
