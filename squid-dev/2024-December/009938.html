<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-dev] Convert store_client into AsyncJob
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Convert%20store_client%20into%20AsyncJob&In-Reply-To=%3Ce2f34f41-73f8-4fb0-947f-1620625e9ad3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009937.html">
   <LINK REL="Next"  HREF="009939.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-dev] Convert store_client into AsyncJob</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-dev%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-dev%5D%20Convert%20store_client%20into%20AsyncJob&In-Reply-To=%3Ce2f34f41-73f8-4fb0-947f-1620625e9ad3%40measurement-factory.com%3E"
       TITLE="[squid-dev] Convert store_client into AsyncJob">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Dec 27 22:18:21 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009937.html">[squid-dev] Introducing myself to Squid Devs
</A></li>
        <LI>Next message (by thread): <A HREF="009939.html">[squid-dev] Proposal: clean our git tags up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9938">[ date ]</a>
              <a href="thread.html#9938">[ thread ]</a>
              <a href="subject.html#9938">[ subject ]</a>
              <a href="author.html#9938">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-12-27 01:07, Shailesh Vashishth wrote:

&gt;<i> I am trying to do the following ToDo in store_client.cc.
</I>&gt;<i> // TODO: Convert store_client into AsyncJob; make this call asynchronous
</I>
I do not recommend working on that to-do:

1. It is too complex, requiring good understanding of AsyncJob design 
that may be difficult to obtain through reading documentation alone.

2. It may be premature because we probably should &quot;Merge store_client 
into StoreClient&quot; first (or at the same time), as documented in another 
TODO in StoreClient.h.

3. The change requires serious testing that would be difficult to 
perform and nearly impossible to validate via review.


&gt;<i> storeClientCopy2(this, sc);
</I>
&gt;<i> Please help me understand why we need to make this call asynchronous?
</I>
The relevant StoreEntry::invokeHandlers() code is best interpreted as 
the following pseudo-code loop:

     for (const auto &amp;client: entry-&gt;store_clients)
         client-&gt;do_something_complex_with(entry);

In other words, the code is contacting individual store_client tasks in 
a loop while asking each task to perform complex actions with numerous 
side effects, including cases where an action of one task affects 
another task (and/or the looping/entry object itself!).

This is essentially spaghetti code in disguise, where (very indirect!) 
recursive function calls and same-object recursive &quot;visits&quot; have 
replaced classic &quot;goto&quot; statements: 
<A HREF="https://en.wikipedia.org/wiki/Spaghetti_code">https://en.wikipedia.org/wiki/Spaghetti_code</A>

Experience shows that humans are terrible at writing and especially 
maintaining correct spaghetti code. This specific invokeHandlers() loop 
has caused many costly problems! Not all of them have been solved IIRC.


Asynchronous calls untangle this mess because they prevent recursive 
calls and revisits. They have their own cons, of course, but they are a 
part of a much better overall design.


HTH,

Alex.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009937.html">[squid-dev] Introducing myself to Squid Devs
</A></li>
	<LI>Next message (by thread): <A HREF="009939.html">[squid-dev] Proposal: clean our git tags up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9938">[ date ]</a>
              <a href="thread.html#9938">[ thread ]</a>
              <a href="subject.html#9938">[ subject ]</a>
              <a href="author.html#9938">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-dev">More information about the squid-dev
mailing list</a><br>
</body></html>
