From yngcho at nwcdcloud.cn  Thu Jun  5 08:04:09 2025
From: yngcho at nwcdcloud.cn (Yang, Chao)
Date: Thu, 5 Jun 2025 08:04:09 +0000
Subject: [squid-dev] [Issue Report] Squid forward request to 0.0.0.0/8
Message-ID: <9f2ee826cd454f898e2dcb7042173bf3@nwcdcloud.cn>

Dear Squid Support Team,
Hope you are everything well.

I meet a strange issue and hope you could give some suggestions.

Background:
I am using squid as a proxy to register my SUSE EC2 Instance in AWS. I installed squid in Amazon Linux 2023 and just modify /etc/squid/squid.conf file "http_access deny all" to "http_access allow all".

After that , I set the enviroment in SUSE Instance(172.31.45.49 is Squid instance):
    env | grep proxy
    https_proxy=http://172.31.45.49:3128
    http_proxy=http://172.31.45.49:3128
    no_proxy=169.254.169.254

When I tried to register SUSE instance with command "registercloudguest --force-new", got the following error(/var/log/cloudregister):
===================================================================================================================
2025-06-05 05:23:34,418 ERROR:  Registration failed: Registering system to registration proxy https://smt-ec2.susecloud.net

Updating system details on https://smt-ec2.susecloud.net ...

Activating sle-module-web-scripting 15.5 x86_64 ...
-> Adding service to system ...
command '/usr/bin/zypper --non-interactive refs Web_and_Scripting_Module_x86_64' failed
Error: zypper returned 1 with 'Unexpected exception.
Unknown error reading from 'plugin:/susecloud?credentials=Web_and_Scripting_Module_x86_64&path=/services/2494'
History:
- Not ready to read within timeout.

Please file a bug report about this.
See http://en.opensuse.org/Zypper/Troubleshooting for instructions.' (exit status 1)
===================================================================================================================

Action taken:
I found there are lots of strange log when I register SUSE as below(/var/log/squid/access.log):
===================================================================================================================
1749103351.951      3 172.31.47.207 TCP_DENIED/403 3804 CONNECT 0.0.10.40:1 - HIER_NONE/- text/html
1749103366.975      4 172.31.47.207 TCP_DENIED/403 3802 CONNECT 0.0.9.96:7 - HIER_NONE/- text/html
1749103375.466  59932 172.31.47.207 TCP_TUNNEL/503 0 CONNECT 0.0.9.102:443 - HIER_DIRECT/0.0.9.102 -
===================================================================================================================

After I edited the config file(/etc/squid/squid.conf) and add the following:
    acl invalid_dst dst 0.0.0.0/8
    http_access deny invalid_dst

I could register SUSE without any error.

When I access Amazon S3 using squid instance, there is no any strange IP in the access log.

I checked /etc/hosts and no any information of "0.0.0.0/8"

Action Required:
Do you know why squid forward request to 0.0.0.0/8?

Thank you!

Best Regards
Yang Chao
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20250605/4ec7495e/attachment.htm>

From squid3 at treenet.co.nz  Thu Jun  5 10:49:03 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 5 Jun 2025 22:49:03 +1200
Subject: [squid-dev] [Issue Report] Squid forward request to 0.0.0.0/8
In-Reply-To: <9f2ee826cd454f898e2dcb7042173bf3@nwcdcloud.cn>
References: <9f2ee826cd454f898e2dcb7042173bf3@nwcdcloud.cn>
Message-ID: <d16d152a-cc2e-49d2-bff8-24bb6182c93d@treenet.co.nz>

On 5/06/25 20:04, Yang, Chao wrote:
> 
> I found there are lots of strange log when I register SUSE as below(/ 
> var/log/squid/access.log):
> 
> / 
> ===================================================================================================================/
> 
> /1749103351.951????? 3 172.31.47.207 TCP_DENIED/403 3804 CONNECT 
> 0.0.10.40:1 - HIER_NONE/- text/html/
> 

Squid received the HTTP request "CONNECT 0.0.10.40:1".

The port 1 is forbidden by SSL_ports, so Squid sent a 403 Denied response.


> /1749103366.975????? 4 172.31.47.207 TCP_DENIED/403 3802 CONNECT 
> 0.0.9.96:7 - HIER_NONE/- text/html/
> 

Squid received the HTTP request "CONNECT 0.0.9.96:7".

The port 7 is forbidden by SSL_ports, so Squid sent a 403 Denied response.


> /1749103375.466? 59932 172.31.47.207 TCP_TUNNEL/503 0 CONNECT 
> 0.0.9.102:443 - HIER_DIRECT/0.0.9.102 -/
> 

Squid received the HTTP request "CONNECT 0.0.9.102:443".

The port 443 is valid for HTTPS, so Squid opened a tunnel to that server 
(successfully). The connection closed after 59.9 seconds, with no data 
sent to the client.


> / 
> ===================================================================================================================/
> 
> After I edited the config file(/etc/squid/squid.conf) and add the following:
> 
>  ??? acl invalid_dst dst 0.0.0.0/8
> 
>  ????http_access deny invalid_dst
> 
> I could register SUSE without any error.


The error is something inside the SUSE zypper or the plugin it is using 
to access their cloud services. Whoever coded it did not expect that IP 
address range to work in "public" Internet.

Squid is just trying to do what it is told to do. It looks to me like it 
is working.



> 
> When I access Amazon S3 using squid instance, there is no any strange IP 
> in the access log.
> 

That being an entirely different company and/or web service. One can 
expect them to be different.


> I checked /etc/hosts and no any information of "0.0.0.0/8"
> 

Those IPs are being sent to Squid directly by the "registercloudguest" 
software.  Why, is a different question and should be taken up with the 
SUSE people or whoever wrote the zypper plugin that tool is using.



> *Action Required:*
> 
> Do you know why squid forward request to 0.0.0.0/8?
> 

As you have discovered that range is used by Cloud services. Typically 
for internal messaging. In some of the environments Squid operates it is 
treated as equivalent to a LAN range for VMs.


Cheers
Amos

From tessarek at evermeet.cx  Thu Jun 26 20:59:59 2025
From: tessarek at evermeet.cx (Helmut K. C. Tessarek)
Date: Thu, 26 Jun 2025 16:59:59 -0400
Subject: [squid-dev] compiling squid 7.0.2 on Debian abends
Message-ID: <e857bc28-29f0-4da5-9815-3a4a6bf97714@evermeet.cx>

Hello,

According to the web site I'm supposed to send issues with the beta version to 
this address.

When I compile squid 7.0.2 on Debian, it abends with the following error:

---------
make[5]: Leaving directory '/ext/squid-7.0.2/src/auth/ntlm/fake'
Making all in SMB_LM
make[5]: Entering directory '/ext/squid-7.0.2/src/auth/ntlm/SMB_LM'
depbase=`echo ntlm_smb_lm_auth.o | sed 's|[^/]*$|.deps/&|;s|\.o$||'`;\
g++ -std=c++17 -DHAVE_CONFIG_H -DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\" 
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\" 
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"   -I../../../.. -I../../../../include 
-I../../../../lib -I../../../../src -I../../../../include  -I../../../../libltdl 
-isystem /usr/include/mit-krb5   -Wall -Wextra -Wimplicit-fallthrough=5 
-Wpointer-arith -Wwrite-strings -Wcomments -Wshadow -Wmissing-declarations 
-Woverloaded-virtual -Werror -pipe -D_REENTRANT -O2 -march=native -MT 
ntlm_smb_lm_auth.o -MD -MP -MF $depbase.Tpo -c -o ntlm_smb_lm_auth.o 
ntlm_smb_lm_auth.cc &&\
mv -f $depbase.Tpo $depbase.Po
ntlm_smb_lm_auth.cc:351:1: error: no previous declaration for ?void 
timeout_during_auth(int)? [-Werror=missing-declarations]
   351 | timeout_during_auth(int)
       | ^~~~~~~~~~~~~~~~~~~
ntlm_smb_lm_auth.cc: In function ?void manage_request()?:
ntlm_smb_lm_auth.cc:540:57: error: no match for ?operator<? (operand types are 
?NtlmError? and ?int?)
   540 |         if (ntlm_validate_packet(fast_header, NTLM_ANY) < 0) {
       |             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ^ ~
       |                                 |                         |
       |                                 NtlmError                 int
cc1plus: all warnings being treated as errors
make[5]: *** [Makefile:854: ntlm_smb_lm_auth.o] Error 1
make[5]: Leaving directory '/ext/squid-7.0.2/src/auth/ntlm/SMB_LM'
make[4]: *** [Makefile:909: all-recursive] Error 1
make[4]: Leaving directory '/ext/squid-7.0.2/src/auth/ntlm'
make[3]: *** [Makefile:964: all-recursive] Error 1
make[3]: Leaving directory '/ext/squid-7.0.2/src/auth'
make[2]: *** [Makefile:6079: all-recursive] Error 1
make[2]: Leaving directory '/ext/squid-7.0.2/src'
make[1]: *** [Makefile:5061: all] Error 2
make[1]: Leaving directory '/ext/squid-7.0.2/src'
make: *** [Makefile:601: all-recursive] Error 1
---------

The config.log is available for 7 days (until 2025-07-03 20:36:17 UTC):
https://evermeet.cx/paste/config.2dvf.log

Debian 12.11
Linux squid 6.1.0-37-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.140-1 (2025-05-22) 
x86_64 GNU/Linux

Cheers,
   K. C.

-- 
regards Helmut K. C. Tessarek              KeyID 0x172380A011EF4944
Key fingerprint = 8A55 70C1 BD85 D34E ADBC 386C 1723 80A0 11EF 4944

/*
    Thou shalt not follow the NULL pointer for chaos and madness
    await thee at its end.
*/

-------------- next part --------------
A non-text attachment was scrubbed...
Name: OpenPGP_signature.asc
Type: application/pgp-signature
Size: 840 bytes
Desc: OpenPGP digital signature
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20250626/c9407b7e/attachment.sig>

From squid3 at treenet.co.nz  Sat Jun 28 18:01:27 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 29 Jun 2025 06:01:27 +1200
Subject: [squid-dev] compiling squid 7.0.2 on Debian abends
In-Reply-To: <e857bc28-29f0-4da5-9815-3a4a6bf97714@evermeet.cx>
References: <e857bc28-29f0-4da5-9815-3a4a6bf97714@evermeet.cx>
Message-ID: <e2f5ab38-f2b5-4fd7-8ee4-50683c3dfaf4@treenet.co.nz>

On 27/06/25 08:59, Helmut K. C. Tessarek wrote:
> Hello,
> 
> According to the web site I'm supposed to send issues with the beta 
> version to this address.
> 
> When I compile squid 7.0.2 on Debian, it abends with the following error:
> 
> ---------
...
> ntlm_smb_lm_auth.cc:351:1: error: no previous declaration for ?void 
> timeout_during_auth(int)? [-Werror=missing-declarations]
>  ? 351 | timeout_during_auth(int)
>  ????? | ^~~~~~~~~~~~~~~~~~~
> ntlm_smb_lm_auth.cc: In function ?void manage_request()?:
> ntlm_smb_lm_auth.cc:540:57: error: no match for ?operator<? (operand 
> types are ?NtlmError? and ?int?)
>  ? 540 |???????? if (ntlm_validate_packet(fast_header, NTLM_ANY) < 0) {
>  ????? |???????????? ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ^ ~
>  ????? |???????????????????????????????? |???????????????????????? |
>  ????? |???????????????????????????????? NtlmError???????????????? int


Please remove "SMB_LM" from the list of NTLM helpers to build. This 
helper is deprecated and removed in later Squid releases.


FTR; The LanManager protocols from 1970-1980's that it implemented were 
deprecated in 2006 as "highly insecure" even back then, and no longer 
part of any Windows software.

HTH
Amos


From tessarek at evermeet.cx  Sun Jun 29 00:08:23 2025
From: tessarek at evermeet.cx (Helmut K. C. Tessarek)
Date: Sat, 28 Jun 2025 20:08:23 -0400
Subject: [squid-dev] compiling squid 7.0.2 on Debian abends
In-Reply-To: <e2f5ab38-f2b5-4fd7-8ee4-50683c3dfaf4@treenet.co.nz>
References: <e2f5ab38-f2b5-4fd7-8ee4-50683c3dfaf4@treenet.co.nz>
Message-ID: <c6942281-6d9e-4a83-8803-b8a15153e278@evermeet.cx>

Hey Amos,

Thanks, this worked.

I am not using SMB_LM anyway, I just grabbed the config line from a Debian or 
Fedora source package.

What I find a bit strange though is that configure did not complain and spit out 
an error. If SMB_LM does not work, the option should be removed from configure. 
If it is still there and configurable, it should compile nonetheless.
This is just an observation, not a complaint.

All that being said, I am happy with the solution to remove it.

Cheers,
   K. C.

-- 
regards Helmut K. C. Tessarek              KeyID 0x172380A011EF4944
Key fingerprint = 8A55 70C1 BD85 D34E ADBC 386C 1723 80A0 11EF 4944

/*
    Thou shalt not follow the NULL pointer for chaos and madness
    await thee at its end.
*/

-------------- next part --------------
A non-text attachment was scrubbed...
Name: OpenPGP_signature.asc
Type: application/pgp-signature
Size: 840 bytes
Desc: OpenPGP digital signature
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20250628/d937d9b4/attachment.sig>

From gkinkie at gmail.com  Sun Jun 29 14:41:09 2025
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Sun, 29 Jun 2025 15:41:09 +0100
Subject: [squid-dev] compiling squid 7.0.2 on Debian abends
In-Reply-To: <c6942281-6d9e-4a83-8803-b8a15153e278@evermeet.cx>
References: <e2f5ab38-f2b5-4fd7-8ee4-50683c3dfaf4@treenet.co.nz>
 <c6942281-6d9e-4a83-8803-b8a15153e278@evermeet.cx>
Message-ID: <CA+Y8hcOuApZN=DZD9bmnPUHvjNXNf-qBW_hTK7t_E8gpC4Yhjg@mail.gmail.com>

On Sun, Jun 29, 2025 at 3:29?PM Helmut K. C. Tessarek
<tessarek at evermeet.cx> wrote:
>
> Hey Amos,
>
> Thanks, this worked.
>
> I am not using SMB_LM anyway, I just grabbed the config line from a Debian or
> Fedora source package.
>
> What I find a bit strange though is that configure did not complain and spit out
> an error. If SMB_LM does not work, the option should be removed from configure.
> If it is still there and configurable, it should compile nonetheless.
> This is just an observation, not a complaint.

You are right.
SMB_LM has been removed from master/v8 but not from v7. It is a very
old piece of software which is insecure and, as we have seen here,
bitrotten. It is likely broken since commit 1e37143c7d (PR 676) from
December 2023, and the fact that is being only noticed now can show
how little it is used (or built).

Does anyone have any objections to backporting commit f53a024a40 (PR
2009) removing it to v7?

-- 
    Francesco

From tessarek at evermeet.cx  Sun Jun 29 17:28:03 2025
From: tessarek at evermeet.cx (Helmut K. C. Tessarek)
Date: Sun, 29 Jun 2025 13:28:03 -0400
Subject: [squid-dev] compiling squid 7.0.2 on Debian abends
In-Reply-To: <CA+Y8hcOuApZN=DZD9bmnPUHvjNXNf-qBW_hTK7t_E8gpC4Yhjg@mail.gmail.com>
References: <e2f5ab38-f2b5-4fd7-8ee4-50683c3dfaf4@treenet.co.nz>
 <c6942281-6d9e-4a83-8803-b8a15153e278@evermeet.cx>
 <CA+Y8hcOuApZN=DZD9bmnPUHvjNXNf-qBW_hTK7t_E8gpC4Yhjg@mail.gmail.com>
Message-ID: <ab3f33b3-a8d4-4d8e-9a6f-82aa183ea99e@evermeet.cx>

On 2025-06-29 10:41, Francesco Chemolli wrote:
> You are right.
> SMB_LM has been removed from master/v8 but not from v7. It is a very
> old piece of software which is insecure and, as we have seen here,
> bitrotten. It is likely broken since commit 1e37143c7d (PR 676) from
> December 2023, and the fact that is being only noticed now can show
> how little it is used (or built).

I guess the source package maintainers just left it in there for years. Strange 
since Debian is all about security. Maybe the maintainer overlooked the fact 
that this part was totally insecure.

> Does anyone have any objections to backporting commit f53a024a40 (PR
> 2009) removing it to v7?

I don't have a binding vote, but I am all for it. ;-)

Cheers,
   K. C.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: OpenPGP_signature.asc
Type: application/pgp-signature
Size: 840 bytes
Desc: OpenPGP digital signature
URL: <http://lists.squid-cache.org/pipermail/squid-dev/attachments/20250629/b42f20b0/attachment.sig>

