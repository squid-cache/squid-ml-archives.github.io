[From nobody Fri Feb  6 12:00:01 2015
X-Envelope-From: &lt;gcwsd-squid-dev@m.gmane.org&gt;
X-Envelope-To: &lt;squid-dev@squid-cache.org&gt;
Received: from plane.gmane.org (unknown)
 by lists.squid-cache.org(Postfix 2.11.0/8.13.0) with SMTP id unknown
 Thu, 05 Feb 2015 23:04:14 +0000
 (envelope-from &lt;gcwsd-squid-dev@m.gmane.org&gt;
Received: from list by plane.gmane.org with local (Exim 4.69)
 (envelope-from &lt;gcwsd-squid-dev@m.gmane.org&gt;) id 1YJVSR-000650-US
 for squid-dev@squid-cache.org; Fri, 06 Feb 2015 00:03:35 +0100
Received: from moeller.plus.com ([81.174.172.105])
 by main.gmane.org with esmtp (Gmexim 0.1 (Debian))
 id 1AlnuQ-0007hv-00
 for &lt;squid-dev@squid-cache.org&gt;; Fri, 06 Feb 2015 00:03:35 +0100
Received: from huaraz by moeller.plus.com with local (Gmexim 0.1 (Debian))
 id 1AlnuQ-0007hv-00
 for &lt;squid-dev@squid-cache.org&gt;; Fri, 06 Feb 2015 00:03:35 +0100
X-Injected-Via-Gmane: http://gmane.org/
To: squid-dev@squid-cache.org
From: &quot;Markus Moeller&quot; &lt;huaraz@moeller.plus.com&gt;
Subject: [PATCH]  small kerberos fixes for trunk
Date: Thu, 5 Feb 2015 23:03:20 -0000
Lines: 230
Message-ID: &lt;mb0srt$h38$1@ger.gmane.org&gt;
Mime-Version: 1.0
Content-Type: multipart/mixed;
 boundary=&quot;----=_NextPart_000_045C_01D04197.EF41FA10&quot;
X-Complaints-To: usenet@ger.gmane.org
X-Gmane-NNTP-Posting-Host: moeller.plus.com
X-MSMail-Priority: Normal
Importance: Normal
X-Newsreader: Microsoft Windows Live Mail 16.4.3528.331
X-MimeOLE: Produced By Microsoft MimeOLE V16.4.3528.331

This is a multi-part message in MIME format.

------=_NextPart_000_045C_01D04197.EF41FA10
Content-Type: text/plain;
	format=flowed;
	charset=&quot;iso-8859-1&quot;;
	reply-type=original
Content-Transfer-Encoding: 7bit

Hi Amos,

   I have attached a small patch for the following:

  1) Hardcode Solaris 10 gss library flags as the Solaris version still does 
not support krb5-config --libs gssapi
  2) Fix for negotiate authentication helper tobe backward compatible with 
krb5.conf settings
  3) Some variable checks in kerberos ldap helper.


Regards
Markus 

------=_NextPart_000_045C_01D04197.EF41FA10
Content-Type: application/octet-stream;
	name=&quot;kerberos.patch&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;kerberos.patch&quot;

=3D=3D=3D modified file 'configure.ac'=0A=
--- configure.ac	2015-02-01 07:05:48 +0000=0A=
+++ configure.ac	2015-02-04 23:02:46 +0000=0A=
@@ -1611,6 +1611,8 @@=0A=
     if test &quot;x$SOLARIS_BROKEN_KRB5CONFIG_GSSAPI&quot; =3D &quot;x&quot;; then=0A=
       LIB_KRB5_CFLAGS=3D&quot;`$ac_krb5_config --cflags gssapi 2&gt;/dev/null` =
$LIB_KRB5_CFLAGS&quot;=0A=
       LIB_KRB5_LIBS=3D&quot;`$ac_krb5_config --libs gssapi 2&gt;/dev/null` =
$LIB_KRB5_LIBS&quot;=0A=
+    else=0A=
+      LIB_KRB5_LIBS=3D&quot;-L/usr/lib -R/usr/lib -lgss $LIB_KRB5_LIBS&quot;=0A=
     fi=0A=
   else=0A=
     ## For some OS pkg-config is broken or unavailable.=0A=
=0A=
=3D=3D=3D modified file =
'helpers/negotiate_auth/kerberos/negotiate_kerberos_auth.cc'=0A=
--- helpers/negotiate_auth/kerberos/negotiate_kerberos_auth.cc	=
2015-01-13 07:25:36 +0000=0A=
+++ helpers/negotiate_auth/kerberos/negotiate_kerberos_auth.cc	=
2015-02-01 15:24:29 +0000=0A=
@@ -105,7 +105,7 @@=0A=
         return NULL;=0A=
     }=0A=
     rc =3D getaddrinfo(hostname, NULL, NULL, &amp;hres);=0A=
-    if (rc !=3D 0) {=0A=
+    if (rc !=3D 0 || hres =3D=3D NULL ) {=0A=
         debug((char *) &quot;%s| %s: ERROR: resolving hostname with =
getaddrinfo: %s failed\n&quot;,=0A=
               LogTime(), PROGRAM, gai_strerror(rc));=0A=
         fprintf(stderr,=0A=
@@ -339,10 +339,8 @@=0A=
     gss_buffer_desc type_id =3D GSS_C_EMPTY_BUFFER;=0A=
 #endif=0A=
 #endif=0A=
-#if HAVE_PAC_SUPPORT || HAVE_KRB5_MEMORY_KEYTAB=0A=
     krb5_context context =3D NULL;=0A=
     krb5_error_code ret;=0A=
-#endif=0A=
     long length =3D 0;=0A=
     static int err =3D 0;=0A=
     int opt, log =3D 0, norealm =3D 0;=0A=
@@ -352,6 +350,7 @@=0A=
     char *service_principal =3D NULL;=0A=
     char *keytab_name =3D NULL;=0A=
     char *keytab_name_env =3D NULL;=0A=
+    char default_keytab[MAXPATHLEN];=0A=
 #if HAVE_KRB5_MEMORY_KEYTAB=0A=
     char *memory_keytab_name =3D NULL;=0A=
 #endif=0A=
@@ -536,9 +535,14 @@=0A=
         putenv(keytab_name_env);=0A=
     } else {=0A=
         keytab_name_env =3D getenv(&quot;KRB5_KTNAME&quot;);=0A=
-        if (!keytab_name_env)=0A=
-            keytab_name =3D xstrdup(&quot;/etc/krb5.keytab&quot;);=0A=
-        else=0A=
+        if (!keytab_name_env) {=0A=
+            ret =3D krb5_init_context(&amp;context);=0A=
+            if (!check_k5_err(context, &quot;krb5_init_context&quot;, ret)) {=0A=
+                krb5_kt_default_name(context, default_keytab, =
MAXPATHLEN);=0A=
+            }=0A=
+            keytab_name =3D default_keytab;=0A=
+            krb5_free_context(context);=0A=
+        } else=0A=
             keytab_name =3D xstrdup(keytab_name_env);=0A=
     }=0A=
     debug((char *) &quot;%s| %s: INFO: Setting keytab to %s\n&quot;, LogTime(), =
PROGRAM, keytab_name);=0A=
=0A=
=3D=3D=3D modified file =
'helpers/negotiate_auth/kerberos/negotiate_kerberos_pac.cc'=0A=
--- helpers/negotiate_auth/kerberos/negotiate_kerberos_pac.cc	2015-01-13 =
07:25:36 +0000=0A=
+++ helpers/negotiate_auth/kerberos/negotiate_kerberos_pac.cc	2015-01-15 =
22:54:00 +0000=0A=
@@ -141,9 +141,9 @@=0A=
 int=0A=
 checkustr(RPC_UNICODE_STRING *string)=0A=
 {=0A=
-    uint32_t size,off,len;=0A=
 =0A=
     if (string-&gt;pointer !=3D 0) {=0A=
+        uint32_t size,off,len;=0A=
         align(4);=0A=
         size =3D (uint32_t)((p[bpos]&lt;&lt;0) | (p[bpos+1]&lt;&lt;8) | =
(p[bpos+2]&lt;&lt;16) | (p[bpos+3]&lt;&lt;24));=0A=
         bpos =3D bpos+4;=0A=
@@ -168,7 +168,6 @@=0A=
 {=0A=
     if (GroupIds!=3D 0) {=0A=
         uint32_t ngroup;=0A=
-        uint32_t sauth;=0A=
         int l;=0A=
 =0A=
         align(4);=0A=
@@ -182,6 +181,7 @@=0A=
 =0A=
         Rids=3D(char **)xcalloc(GroupCount*sizeof(char*),1);=0A=
         for ( l=3D0; l&lt;(int)GroupCount; l++) {=0A=
+            uint32_t sauth;=0A=
             Rids[l]=3D(char *)xcalloc(4*sizeof(char),1);=0A=
             memcpy((void *)Rids[l],(void *)&amp;p[bpos],4);=0A=
             sauth =3D get4byt();=0A=
@@ -196,11 +196,16 @@=0A=
 char *=0A=
 getdomaingids(char *ad_groups, uint32_t DomainLogonId, char **Rids, =
uint32_t GroupCount)=0A=
 {=0A=
+    if (!ad_groups) {=0A=
+        debug((char *) &quot;%s| %s: ERR: No space to store groups\n&quot;,=0A=
+              LogTime(), PROGRAM);=0A=
+        return NULL;=0A=
+    }=0A=
+=0A=
     if (DomainLogonId!=3D 0) {=0A=
         uint32_t nauth;=0A=
         uint8_t rev;=0A=
         uint64_t idauth;=0A=
-        uint32_t sauth;=0A=
         char dli[256];=0A=
         char *ag;=0A=
         size_t length;=0A=
@@ -251,6 +256,7 @@=0A=
 =0A=
         snprintf(dli,sizeof(dli),&quot;S-%d-%lu&quot;,rev,(long unsigned =
int)idauth);=0A=
         for ( l=3D0; l&lt;(int)nauth; l++ ) {=0A=
+            uint32_t sauth;=0A=
             sauth =3D get4byt();=0A=
             snprintf((char =
*)&amp;dli[strlen(dli)],sizeof(dli)-strlen(dli),&quot;-%u&quot;,sauth);=0A=
         }=0A=
@@ -286,23 +292,23 @@=0A=
 =0A=
         for ( l=3D0; l&lt;(int)SidCount; l++ ) {=0A=
             char es[256];=0A=
-            uint32_t nauth;=0A=
-            uint8_t rev;=0A=
-            uint64_t idauth;=0A=
-            uint32_t sauth;=0A=
-            int k;=0A=
 =0A=
             if (pa[l] !=3D 0) {=0A=
+                uint32_t nauth;=0A=
+                uint8_t rev;=0A=
+                uint64_t idauth;=0A=
+=0A=
                 nauth =3D get4byt();=0A=
 =0A=
                 length =3D 1+1+6+nauth*4;=0A=
                 ag =3D (char *)xcalloc((length)*sizeof(char),1);=0A=
                 memcpy((void *)ag,(const void*)&amp;p[bpos],length);=0A=
                 if (!ad_groups) {=0A=
-                    if (!pstrcpy(ad_groups,&quot;group=3D&quot;)) {=0A=
-                        debug((char *) &quot;%s| %s: WARN: Too many groups ! =
size &gt; %d : %s\n&quot;,=0A=
-                              LogTime(), PROGRAM, MAX_PAC_GROUP_SIZE, =
ad_groups);=0A=
-                    }=0A=
+                    debug((char *) &quot;%s| %s: ERR: No space to store =
groups\n&quot;,=0A=
+                          LogTime(), PROGRAM);=0A=
+                    xfree(pa);=0A=
+                    xfree(ag);=0A=
+                    return NULL;=0A=
                 } else {=0A=
                     if (!pstrcat(ad_groups,&quot; group=3D&quot;)) {=0A=
                         debug((char *) &quot;%s| %s: WARN: Too many groups ! =
size &gt; %d : %s\n&quot;,=0A=
@@ -328,7 +334,8 @@=0A=
                 idauth =3D get6byt_be();=0A=
 =0A=
                 snprintf(es,sizeof(es),&quot;S-%d-%lu&quot;,rev,(long unsigned =
int)idauth);=0A=
-                for ( k=3D0; k&lt;(int)nauth; k++ ) {=0A=
+                for (int k=3D0; k&lt;(int)nauth; k++ ) {=0A=
+                    uint32_t sauth;=0A=
                     sauth =3D get4byt();=0A=
                     snprintf((char =
*)&amp;es[strlen(es)],sizeof(es)-strlen(es),&quot;-%u&quot;,sauth);=0A=
                 }=0A=
@@ -365,6 +372,12 @@=0A=
     char **Rids=3DNULL;=0A=
     int l=3D0;=0A=
 =0A=
+    if (!ad_groups) {=0A=
+        debug((char *) &quot;%s| %s: ERR: No space to store groups\n&quot;,=0A=
+            LogTime(), PROGRAM);=0A=
+        return NULL;=0A=
+    }=0A=
+=0A=
     ad_data =3D (krb5_data *)xcalloc(1,sizeof(krb5_data));=0A=
 =0A=
 #define KERB_LOGON_INFO 1=0A=
=0A=

------=_NextPart_000_045C_01D04197.EF41FA10--


]