<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Jul&nbsp;12,&nbsp;2015&nbsp;at&nbsp;2:34&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;12/07/2015&nbsp;5:42&nbsp;a.m.,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;<br>
&gt; &nbsp; this&nbsp;patch&nbsp;saves&nbsp;and&nbsp;restores&nbsp;errno&nbsp;around&nbsp;calls&nbsp;to&nbsp;strftime&nbsp;in&lt;br&gt;<br>
&gt;&nbsp;debugLogTime,&nbsp;preventing&nbsp;harmless&nbsp;errors&nbsp;in&nbsp;these&nbsp;calls&nbsp;from&nbsp;clobbering&lt;br&gt;<br>
&gt;&nbsp;errno,&nbsp;thus&nbsp;messing&nbsp;up&nbsp;xstrerror()&nbsp;calls&nbsp;within&nbsp;debugs().&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;1)&nbsp;xerrno&nbsp;is&nbsp;a&nbsp;local&nbsp;variable&nbsp;in&nbsp;lots&nbsp;of&nbsp;places&nbsp;in&nbsp;the&nbsp;code.&nbsp;This&nbsp;patch&lt;br&gt;<br>
introduces&nbsp;shadowing&nbsp;errors.&nbsp;Please&nbsp;call&nbsp;it&nbsp;debug_xerrno.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ok,&nbsp;no&nbsp;problem.&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
2)&nbsp;The&nbsp;snprintf()&nbsp;call&nbsp;directly&nbsp;after&nbsp;restoring&nbsp;errno&nbsp;in&nbsp;the&nbsp;top&nbsp;chunk&lt;br&gt;<br>
may&nbsp;alter&nbsp;the&nbsp;original&nbsp;errno&nbsp;in&nbsp;rare&nbsp;cases&nbsp;as&nbsp;well.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Are&nbsp;you&nbsp;sure?&nbsp;The&nbsp;snprintf&nbsp;manual&nbsp;page&nbsp;doesn&#39;t&nbsp;mention&nbsp;that.&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
Which&nbsp;is&nbsp;a&nbsp;good&nbsp;example&nbsp;of&nbsp;why&nbsp;we&nbsp;simply&nbsp;can&#39;t&nbsp;rely&nbsp;on&nbsp;errno&nbsp;being&lt;br&gt;<br>
correct&nbsp;for&nbsp;any&nbsp;length&nbsp;of&nbsp;time&nbsp;in&nbsp;C++.&nbsp;Things&nbsp;such&nbsp;as&nbsp;errno&nbsp;changes&nbsp;by&lt;br&gt;<br>
operator&lt;&lt;&nbsp;implementations,&nbsp;print()&nbsp;methods,&nbsp;implicit&nbsp;calls&nbsp;to&nbsp;copy&lt;br&gt;<br>
constructors/destructors,&nbsp;and&nbsp;exlicit&nbsp;function/method&nbsp;calls&nbsp;are&nbsp;also&lt;br&gt;<br>
possible&nbsp;in&nbsp;ways&nbsp;we&nbsp;are&nbsp;unlikely&nbsp;to&nbsp;be&nbsp;predict.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;are&nbsp;still&nbsp;going&nbsp;to&nbsp;have&nbsp;to&nbsp;do&nbsp;a&nbsp;global&nbsp;removal&nbsp;of&nbsp;xstrerror()&nbsp;anyway.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;do&nbsp;not&nbsp;object&nbsp;on&nbsp;the&nbsp;technical&nbsp;merit.&nbsp;&lt;br&gt;At&nbsp;the&nbsp;same&nbsp;time,&nbsp;there&nbsp;are&nbsp;too&nbsp;many&nbsp;to&nbsp;do&nbsp;it&nbsp;incrementally,&nbsp;and&nbsp;we&nbsp;already&nbsp;failed&nbsp;to&nbsp;reach&nbsp;a&nbsp;consensus&nbsp;on&nbsp;flag-day&nbsp;commit&nbsp;for&nbsp;HERE&nbsp;removal.&nbsp;Sure,&nbsp;maybe&nbsp;xstrerror()+HERE&nbsp;removal&nbsp;will&nbsp;reach&nbsp;a&nbsp;mass&nbsp;critical&nbsp;enough&nbsp;to&nbsp;support&nbsp;the&nbsp;flag-day-commit&nbsp;camp,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;that&nbsp;happening,&nbsp;and&nbsp;we&nbsp;already&nbsp;have&nbsp;quite&nbsp;a&nbsp;but&nbsp;of&nbsp;rework&nbsp;due&nbsp;to&nbsp;HERE&nbsp;being&nbsp;left&nbsp;in&nbsp;changed&nbsp;code.&nbsp;We&#39;d&nbsp;end&nbsp;up&nbsp;for&nbsp;years&nbsp;with&nbsp;a&nbsp;half-done&nbsp;migration.&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
IMO,&nbsp;we&nbsp;should&nbsp;move&nbsp;xstrerror()&nbsp;to&nbsp;Debugs.h&nbsp;and&nbsp;make&nbsp;it&nbsp;use&nbsp;the&lt;br&gt;<br>
debug_xerrno&nbsp;local&nbsp;variable&nbsp;instead&nbsp;of&nbsp;errno.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Maybe&nbsp;we&nbsp;could&nbsp;change&nbsp;debugLogTime&nbsp;to&nbsp;return&nbsp;a&nbsp;std::string&nbsp;instead&nbsp;of&nbsp;a&nbsp;const&nbsp;char&nbsp;*,&nbsp;and&nbsp;format&nbsp;it&nbsp;ourselves&nbsp;using&nbsp;a&nbsp;stringbuf&nbsp;instead&nbsp;of&nbsp;using&nbsp;strftime.&nbsp;Or&nbsp;we&nbsp;could&nbsp;maybe&nbsp;do&nbsp;something&nbsp;like&nbsp;this:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;int&nbsp;_squid_errno;&lt;br&gt;&lt;/div&gt;&lt;div&gt;const&nbsp;char&nbsp;*xstrerror()&nbsp;{&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;return&nbsp;xstrerr(_squid_errno);&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;/div&gt;#define&nbsp;debugs(SECTION,&nbsp;LEVEL,&nbsp;CONTENT)&nbsp;\&lt;br&gt;  &nbsp;do&nbsp;{&nbsp;\&lt;br&gt;       &nbsp;if&nbsp;((Debug::level&nbsp;=&nbsp;(LEVEL))&nbsp;&lt;=&nbsp;Debug::Levels[SECTION])&nbsp;{&nbsp;\&lt;br&gt;           &nbsp;Debug::sectionLevel&nbsp;=&nbsp;Debug::Levels[SECTION];&nbsp;\&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;           &nbsp;_squid_errno&nbsp;=&nbsp;errno;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;           &nbsp;std::ostream&nbsp;&amp;_dbo=Debug::getDebugOut();&nbsp;\&lt;br&gt;           &nbsp;if&nbsp;(Debug::level&nbsp;&gt;&nbsp;DBG_IMPORTANT)&nbsp;\&lt;br&gt;               &nbsp;_dbo&nbsp;&lt;&lt;&nbsp;SkipBuildPrefix(__FILE__)&lt;&lt;&quot;(&quot;&lt;&lt;__LINE__&lt;&lt;&quot;)&nbsp;&quot;&lt;&lt;__FUNCTION__&lt;&lt;&quot;:&nbsp;&quot;;&nbsp;\&lt;br&gt;           &nbsp;_dbo&nbsp;&lt;&lt;&nbsp;CONTENT;&nbsp;\&lt;br&gt;           &nbsp;Debug::finishDebug();&nbsp;\&lt;br&gt;       &nbsp;}&nbsp;\&lt;br&gt;  &nbsp;}&nbsp;while&nbsp;(/*CONSTCOND*/&nbsp;0)&lt;br&gt;&lt;br&gt;&lt;div&gt;This&nbsp;would&nbsp;make&nbsp;xstrerror&nbsp;only&nbsp;work&nbsp;within&nbsp;debugs();&nbsp;maybe&nbsp;we&nbsp;could&nbsp;add&nbsp;a&nbsp;guard&nbsp;against&nbsp;it&nbsp;by&nbsp;setting&nbsp;_squid_errno&nbsp;to&nbsp;some&nbsp;invalid&nbsp;value&nbsp;and&nbsp;checking&nbsp;it&nbsp;in&nbsp;xstrerror.&nbsp;Yes,&nbsp;it&#39;s&nbsp;ugly.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;until&nbsp;we&nbsp;reach&nbsp;a&nbsp;consensus,&nbsp;I&#39;d&nbsp;like&nbsp;authorization&nbsp;to&nbsp;move&nbsp;forward&nbsp;with&nbsp;the&nbsp;revised&nbsp;patch&nbsp;I&#39;m&nbsp;attaching.&nbsp;It&#39;s&nbsp;far&nbsp;from&nbsp;ideal,&nbsp;but&nbsp;it&#39;s&nbsp;a&nbsp;step.&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt; &nbsp; &nbsp;Francesco&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
