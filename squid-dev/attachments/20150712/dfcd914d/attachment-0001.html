<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;I&nbsp;tried&nbsp;it.&nbsp;Unfortunately&nbsp;it&nbsp;fails&nbsp;for&nbsp;those&nbsp;cases&nbsp;of&nbsp;debugs()&nbsp;which&nbsp;do&nbsp;not&nbsp;use&nbsp;xstrerror,&nbsp;e.g.&lt;br&gt;&lt;br&gt;../../src/esi/Element.h:&nbsp;In&nbsp;member&nbsp;function&nbsp;&#39;virtual&nbsp;bool&nbsp;ESIElement::addElement(ESIElement::Pointer)&#39;:&lt;br&gt;../../src/esi/Element.h:64:74:&nbsp;error:&nbsp;unused&nbsp;variable&nbsp;&#39;_squid_errno&#39;&nbsp;[-Werror=unused-variable]&lt;br&gt;        &nbsp;debugs(86,5,&nbsp;&quot;ESIElement::addElement:&nbsp;Failed&nbsp;for&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;this);&lt;br&gt;&lt;br&gt;:(&lt;br&gt;&lt;/div&gt;I&nbsp;believe&nbsp;putting&nbsp;the&nbsp;burden&nbsp;of&nbsp;saving&nbsp;state&nbsp;to&nbsp;the&nbsp;caller&nbsp;is&nbsp;way&nbsp;too&nbsp;intrusive:&nbsp;a&nbsp;simple&nbsp;count&nbsp;places&nbsp;the&nbsp;number&nbsp;of&nbsp;xstrerror&nbsp;calls&nbsp;at&nbsp;about&nbsp;260.&lt;br&gt;&lt;/div&gt;So&nbsp;we&#39;re&nbsp;back&nbsp;to&nbsp;square&nbsp;one,&nbsp;the&nbsp;-v2&nbsp;patch.&nbsp;Do&nbsp;you&nbsp;see&nbsp;any&nbsp;other&nbsp;options?&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Jul&nbsp;12,&nbsp;2015&nbsp;at&nbsp;8:12&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;12/07/2015&nbsp;5:45&nbsp;p.m.,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Sun,&nbsp;Jul&nbsp;12,&nbsp;2015&nbsp;at&nbsp;2:34&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;12/07/2015&nbsp;5:42&nbsp;a.m.,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;<br>
&gt;&gt;&gt; &nbsp; this&nbsp;patch&nbsp;saves&nbsp;and&nbsp;restores&nbsp;errno&nbsp;around&nbsp;calls&nbsp;to&nbsp;strftime&nbsp;in&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;debugLogTime,&nbsp;preventing&nbsp;harmless&nbsp;errors&nbsp;in&nbsp;these&nbsp;calls&nbsp;from&nbsp;clobbering&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;errno,&nbsp;thus&nbsp;messing&nbsp;up&nbsp;xstrerror()&nbsp;calls&nbsp;within&nbsp;debugs().&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;1)&nbsp;xerrno&nbsp;is&nbsp;a&nbsp;local&nbsp;variable&nbsp;in&nbsp;lots&nbsp;of&nbsp;places&nbsp;in&nbsp;the&nbsp;code.&nbsp;This&nbsp;patch&lt;br&gt;<br>
&gt;&gt;&nbsp;introduces&nbsp;shadowing&nbsp;errors.&nbsp;Please&nbsp;call&nbsp;it&nbsp;debug_xerrno.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Ok,&nbsp;no&nbsp;problem.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;2)&nbsp;The&nbsp;snprintf()&nbsp;call&nbsp;directly&nbsp;after&nbsp;restoring&nbsp;errno&nbsp;in&nbsp;the&nbsp;top&nbsp;chunk&lt;br&gt;<br>
&gt;&gt;&nbsp;may&nbsp;alter&nbsp;the&nbsp;original&nbsp;errno&nbsp;in&nbsp;rare&nbsp;cases&nbsp;as&nbsp;well.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Are&nbsp;you&nbsp;sure?&nbsp;The&nbsp;snprintf&nbsp;manual&nbsp;page&nbsp;doesn&#39;t&nbsp;mention&nbsp;that.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Which&nbsp;is&nbsp;a&nbsp;good&nbsp;example&nbsp;of&nbsp;why&nbsp;we&nbsp;simply&nbsp;can&#39;t&nbsp;rely&nbsp;on&nbsp;errno&nbsp;being&lt;br&gt;<br>
&gt;&gt;&nbsp;correct&nbsp;for&nbsp;any&nbsp;length&nbsp;of&nbsp;time&nbsp;in&nbsp;C++.&nbsp;Things&nbsp;such&nbsp;as&nbsp;errno&nbsp;changes&nbsp;by&lt;br&gt;<br>
&gt;&gt;&nbsp;operator&lt;&lt;&nbsp;implementations,&nbsp;print()&nbsp;methods,&nbsp;implicit&nbsp;calls&nbsp;to&nbsp;copy&lt;br&gt;<br>
&gt;&gt;&nbsp;constructors/destructors,&nbsp;and&nbsp;exlicit&nbsp;function/method&nbsp;calls&nbsp;are&nbsp;also&lt;br&gt;<br>
&gt;&gt;&nbsp;possible&nbsp;in&nbsp;ways&nbsp;we&nbsp;are&nbsp;unlikely&nbsp;to&nbsp;be&nbsp;predict.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;We&nbsp;are&nbsp;still&nbsp;going&nbsp;to&nbsp;have&nbsp;to&nbsp;do&nbsp;a&nbsp;global&nbsp;removal&nbsp;of&nbsp;xstrerror()&nbsp;anyway.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;do&nbsp;not&nbsp;object&nbsp;on&nbsp;the&nbsp;technical&nbsp;merit.&lt;br&gt;<br>
&gt;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,&nbsp;there&nbsp;are&nbsp;too&nbsp;many&nbsp;to&nbsp;do&nbsp;it&nbsp;incrementally,&nbsp;and&nbsp;we&nbsp;already&lt;br&gt;<br>
&gt;&nbsp;failed&nbsp;to&nbsp;reach&nbsp;a&nbsp;consensus&nbsp;on&nbsp;flag-day&nbsp;commit&nbsp;for&nbsp;HERE&nbsp;removal.&nbsp;Sure,&lt;br&gt;<br>
&gt;&nbsp;maybe&nbsp;xstrerror()+HERE&nbsp;removal&nbsp;will&nbsp;reach&nbsp;a&nbsp;mass&nbsp;critical&nbsp;enough&nbsp;to&nbsp;support&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;flag-day-commit&nbsp;camp,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;that&nbsp;happening,&nbsp;and&nbsp;we&nbsp;already&lt;br&gt;<br>
&gt;&nbsp;have&nbsp;quite&nbsp;a&nbsp;but&nbsp;of&nbsp;rework&nbsp;due&nbsp;to&nbsp;HERE&nbsp;being&nbsp;left&nbsp;in&nbsp;changed&nbsp;code.&nbsp;We&#39;d&nbsp;end&lt;br&gt;<br>
&gt;&nbsp;up&nbsp;for&nbsp;years&nbsp;with&nbsp;a&nbsp;half-done&nbsp;migration.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;IMO,&nbsp;we&nbsp;should&nbsp;move&nbsp;xstrerror()&nbsp;to&nbsp;Debugs.h&nbsp;and&nbsp;make&nbsp;it&nbsp;use&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;debug_xerrno&nbsp;local&nbsp;variable&nbsp;instead&nbsp;of&nbsp;errno.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Maybe&nbsp;we&nbsp;could&nbsp;change&nbsp;debugLogTime&nbsp;to&nbsp;return&nbsp;a&nbsp;std::string&nbsp;instead&nbsp;of&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;const&nbsp;char&nbsp;*,&nbsp;and&nbsp;format&nbsp;it&nbsp;ourselves&nbsp;using&nbsp;a&nbsp;stringbuf&nbsp;instead&nbsp;of&nbsp;using&lt;br&gt;<br>
&gt;&nbsp;strftime.&nbsp;Or&nbsp;we&nbsp;could&nbsp;maybe&nbsp;do&nbsp;something&nbsp;like&nbsp;this:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;int&nbsp;_squid_errno;&lt;br&gt;<br>
&gt;&nbsp;const&nbsp;char&nbsp;*xstrerror()&nbsp;{&lt;br&gt;<br>
&gt; &nbsp; return&nbsp;xstrerr(_squid_errno);&lt;br&gt;<br>
&gt;&nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;Since&nbsp;this&nbsp;is&nbsp;in&nbsp;a&nbsp;header&nbsp;the&nbsp;function&nbsp;needs&nbsp;to&nbsp;be&nbsp;explicitly&nbsp;&#39;inline&#39;.&lt;br&gt;<br>
The&nbsp;variable&nbsp;needs&nbsp;explict&nbsp;extern&nbsp;with&nbsp;debug.cc&nbsp;safe&nbsp;initialization,&nbsp;etc.&lt;br&gt;<br>
&lt;br&gt;<br>
Far&nbsp;simpler&nbsp;and&nbsp;nicer&nbsp;to&nbsp;leave&nbsp;it&nbsp;as&nbsp;a&nbsp;macro:&lt;br&gt;<br>
 #define&nbsp;xstrerror()&nbsp;xstrerr(_sauid_errno)&lt;br&gt;<br>
&lt;br&gt;<br>
where&nbsp;_squid_errno&nbsp;as&nbsp;a&nbsp;local&nbsp;to&nbsp;the&nbsp;if-statement&nbsp;scope&nbsp;below.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;#define&nbsp;debugs(SECTION,&nbsp;LEVEL,&nbsp;CONTENT)&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp;do&nbsp;{&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;((Debug::level&nbsp;=&nbsp;(LEVEL))&nbsp;&lt;=&nbsp;Debug::Levels[SECTION])&nbsp;{&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Debug::sectionLevel&nbsp;=&nbsp;Debug::Levels[SECTION];&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _squid_errno&nbsp;=&nbsp;errno;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; std::ostream&nbsp;&amp;_dbo=Debug::getDebugOut();&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(Debug::level&nbsp;&gt;&nbsp;DBG_IMPORTANT)&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _dbo&nbsp;&lt;&lt;&nbsp;SkipBuildPrefix(__FILE__)&lt;&lt;&quot;(&quot;&lt;&lt;__LINE__&lt;&lt;&quot;)&lt;br&gt;<br>
&gt;&nbsp;&quot;&lt;&lt;__FUNCTION__&lt;&lt;&quot;:&nbsp;&quot;;&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _dbo&nbsp;&lt;&lt;&nbsp;CONTENT;&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Debug::finishDebug();&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp;}&nbsp;while&nbsp;(/*CONSTCOND*/&nbsp;0)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;This&nbsp;would&nbsp;make&nbsp;xstrerror&nbsp;only&nbsp;work&nbsp;within&nbsp;debugs();&nbsp;maybe&nbsp;we&nbsp;could&nbsp;add&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;guard&nbsp;against&nbsp;it&nbsp;by&nbsp;setting&nbsp;_squid_errno&nbsp;to&nbsp;some&nbsp;invalid&nbsp;value&nbsp;and&nbsp;checking&lt;br&gt;<br>
&gt;&nbsp;it&nbsp;in&nbsp;xstrerror.&nbsp;Yes,&nbsp;it&#39;s&nbsp;ugly.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Yes,&nbsp;which&nbsp;is&nbsp;why&nbsp;I&nbsp;requested&nbsp;xstrerror()&nbsp;move&nbsp;to&nbsp;Debug.h&nbsp;as&nbsp;part&nbsp;of&nbsp;the&lt;br&gt;<br>
change.&nbsp;The&nbsp;code&nbsp;not&nbsp;using&nbsp;debugs()&nbsp;can&nbsp;and&nbsp;should&nbsp;use&nbsp;xstrerr(foo)&nbsp;instead.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;But&nbsp;until&nbsp;we&nbsp;reach&nbsp;a&nbsp;consensus,&nbsp;I&#39;d&nbsp;like&nbsp;authorization&nbsp;to&nbsp;move&nbsp;forward&nbsp;with&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;revised&nbsp;patch&nbsp;I&#39;m&nbsp;attaching.&nbsp;It&#39;s&nbsp;far&nbsp;from&nbsp;ideal,&nbsp;but&nbsp;it&#39;s&nbsp;a&nbsp;step.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;IIRC&nbsp;we&nbsp;already&nbsp;have&nbsp;agreement&nbsp;on&nbsp;removal&nbsp;of&nbsp;xstrerror()&nbsp;globally.&nbsp;Its&lt;br&gt;<br>
not&nbsp;as&nbsp;large&nbsp;as&nbsp;HERE&nbsp;removal&nbsp;and&nbsp;will&nbsp;fix&nbsp;many&nbsp;hidden&nbsp;bugs.&lt;br&gt;<br>
&lt;br&gt;<br>
Moving&nbsp;xstrerror()&nbsp;to&nbsp;a&nbsp;debugs-internal&nbsp;mechanism&nbsp;will&nbsp;actually&nbsp;reduce&lt;br&gt;<br>
the&nbsp;size&nbsp;of&nbsp;that&nbsp;change.&nbsp;Which&nbsp;is&nbsp;why&nbsp;I&#39;m&nbsp;continuing&nbsp;with&nbsp;this&nbsp;thread&nbsp;of&lt;br&gt;<br>
discussion&nbsp;at&nbsp;all.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt; &nbsp; &nbsp;Francesco&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
