<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi,&lt;br&gt;&lt;/div&gt; &nbsp;LGTM;+1&nbsp;(only&nbsp;request:&nbsp;turn&lt;br&gt;if&nbsp;(!getConcurrentRequestCount())&lt;br&gt;&lt;/div&gt;into&lt;br&gt;if&nbsp;(getConcurrentRequestCount()&nbsp;==&nbsp;0)&lt;br&gt;&lt;/div&gt;to&nbsp;improve&nbsp;readability.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Good&nbsp;one!&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Jul&nbsp;17,&nbsp;2015&nbsp;at&nbsp;8:15&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;When&nbsp;Squid&nbsp;which&nbsp;are&nbsp;processing&nbsp;a&nbsp;lot&nbsp;of&nbsp;traffic,&nbsp;using&nbsp;persistent&lt;br&gt;<br>
client&nbsp;connections,&nbsp;or&nbsp;dealing&nbsp;with&nbsp;long&nbsp;duration&nbsp;requests&nbsp;are&nbsp;shutdown&lt;br&gt;<br>
they&nbsp;can&nbsp;exit&nbsp;with&nbsp;a&nbsp;lot&nbsp;of&nbsp;connections&nbsp;still&nbsp;open.&nbsp;The&lt;br&gt;<br>
shutdown_lifetime&nbsp;directive&nbsp;exists&nbsp;to&nbsp;allow&nbsp;time&nbsp;for&nbsp;existing&lt;br&gt;<br>
transactions&nbsp;to&nbsp;complete,&nbsp;but&nbsp;this&nbsp;is&nbsp;not&nbsp;always&nbsp;possible&nbsp;and&nbsp;has&nbsp;no&lt;br&gt;<br>
effect&nbsp;on&nbsp;idle&nbsp;connections.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;result&nbsp;is&nbsp;a&nbsp;large&nbsp;dump&nbsp;of&nbsp;aborted&nbsp;FD&nbsp;entries&nbsp;being&nbsp;logged&nbsp;as&nbsp;the&nbsp;TCP&lt;br&gt;<br>
sockets&nbsp;get&nbsp;abruptly&nbsp;reset.&nbsp;Potentially&nbsp;active&nbsp;transactions&nbsp;cache&lt;br&gt;<br>
objects&nbsp;being&nbsp;&quot;corrupted&quot;&nbsp;in&nbsp;the&nbsp;process.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;makes&nbsp;ConnStateData&nbsp;and&nbsp;its&nbsp;children&nbsp;implement&nbsp;Runner&nbsp;API&nbsp;callbacks&lt;br&gt;<br>
to&nbsp;receive&nbsp;signals&nbsp;about&nbsp;Squid&nbsp;shutdown.&nbsp;Which&nbsp;allows&nbsp;their&nbsp;close()&lt;br&gt;<br>
handlers&nbsp;to&nbsp;be&nbsp;run&nbsp;properly&nbsp;and&nbsp;make&nbsp;use&nbsp;of&nbsp;AsyncCalls&nbsp;API.&nbsp;Idle&nbsp;client&lt;br&gt;<br>
connections&nbsp;are&nbsp;closed&nbsp;immediately&nbsp;on&nbsp;the&nbsp;startShutdown()&nbsp;signal,&nbsp;so&lt;br&gt;<br>
their&nbsp;closure&nbsp;CPU&nbsp;cycles&nbsp;happens&nbsp;during&nbsp;the&nbsp;shutdown&nbsp;grace&nbsp;period.&lt;br&gt;<br>
&lt;br&gt;<br>
An&nbsp;extra&nbsp;0-delay&nbsp;event&nbsp;step&nbsp;is&nbsp;added&nbsp;to&nbsp;SignalEngine&nbsp;shutdown&nbsp;sequence&lt;br&gt;<br>
with&nbsp;a&nbsp;new&nbsp;Runner&nbsp;registry&nbsp;hook&nbsp;&#39;endingShutdown&#39;&nbsp;is&nbsp;added&nbsp;to&nbsp;signal&nbsp;that&lt;br&gt;<br>
the&nbsp;shutdown_lifetime&nbsp;grace&nbsp;period&nbsp;is&nbsp;over&nbsp;for&nbsp;closure&nbsp;of&nbsp;active&lt;br&gt;<br>
transactions.&nbsp;All&nbsp;network&nbsp;FD&nbsp;sockets&nbsp;should&nbsp;be&nbsp;considered&nbsp;unusable&nbsp;fro&lt;br&gt;<br>
read()/write()&nbsp;at&nbsp;that&nbsp;point&nbsp;since&nbsp;close&nbsp;handlers&nbsp;may&nbsp;have&nbsp;already&nbsp;been&lt;br&gt;<br>
scheduled&nbsp;by&nbsp;other&nbsp;Runners.&nbsp;AsyncCall&#39;s&nbsp;may&nbsp;still&nbsp;be&nbsp;scheduled&nbsp;to&lt;br&gt;<br>
release&nbsp;resources.&lt;br&gt;<br>
&lt;br&gt;<br>
Also&nbsp;adds&nbsp;a&nbsp;DeregisterRunner()&nbsp;API&nbsp;action&nbsp;to&nbsp;remove&nbsp;Runners&nbsp;dynamically&lt;br&gt;<br>
from&nbsp;the&nbsp;registered&nbsp;set.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;Squid&nbsp;shutdown&nbsp;sequence&nbsp;is&nbsp;now:&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;shutdown&nbsp;signal&nbsp;received:&lt;br&gt;<br>
 -&nbsp;listening&nbsp;sockets&nbsp;closed&lt;br&gt;<br>
 -&nbsp;idle&nbsp;client&nbsp;connections&nbsp;closed&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;shutdown&nbsp;grace&nbsp;period&nbsp;ends:&lt;br&gt;<br>
 -&nbsp;remaining&nbsp;client&nbsp;connections&nbsp;closed&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;shutdown&nbsp;finishes:&lt;br&gt;<br>
 -&nbsp;main&nbsp;signal&nbsp;and&nbsp;Async&nbsp;loop&nbsp;halted&lt;br&gt;<br>
 -&nbsp;all&nbsp;memory&nbsp;free&#39;d&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Server&nbsp;connections&nbsp;which&nbsp;are&nbsp;PINNED&nbsp;or&nbsp;in&nbsp;active&nbsp;use&nbsp;during&nbsp;the&lt;br&gt;<br>
endingShutdown&nbsp;execution&nbsp;will&nbsp;be&nbsp;closed&nbsp;cleanly&nbsp;as&nbsp;a&nbsp;side-effect&nbsp;of&nbsp;the&lt;br&gt;<br>
client&nbsp;closures.&nbsp;Otherwise&nbsp;there&nbsp;is&nbsp;no&nbsp;change&nbsp;to&nbsp;server&nbsp;connections&nbsp;or&lt;br&gt;<br>
other&nbsp;FD&nbsp;sockets&nbsp;behaviour&nbsp;on&nbsp;shutdown.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;br&gt;_______________________________________________&lt;br&gt;<br>
squid-dev&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&gt;squid-dev@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-dev&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt; &nbsp; &nbsp;Francesco&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
