<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Jul&nbsp;26,&nbsp;2015&nbsp;at&nbsp;10:23&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;27/07/2015&nbsp;4:48&nbsp;a.m.,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&gt;&nbsp;HI,&lt;br&gt;<br>
&gt; &nbsp; the&nbsp;low-hanging&nbsp;fruits&nbsp;from&nbsp;Coverity&#39;s&nbsp;analysis&nbsp;have&nbsp;been&nbsp;picked,&nbsp;now&lt;br&gt;<br>
&gt;&nbsp;working&nbsp;on&nbsp;somewhat&nbsp;more&nbsp;complex&nbsp;fixes.&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;attached&nbsp;patch&nbsp;takes&nbsp;a&nbsp;hint&nbsp;from&nbsp;two&nbsp;benign&nbsp;coverity&nbsp;defects&nbsp;to:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&gt;&nbsp;-&nbsp;refactor&nbsp;Digest&nbsp;auth&#39;s&nbsp;field&nbsp;lookup&nbsp;table&nbsp;to&nbsp;use&nbsp;a&nbsp;std::map&nbsp;instead&nbsp;of&lt;br&gt;<br>
&gt;&nbsp;abusing&nbsp;httpHeaderFieldsInfo;&nbsp;this&nbsp;improves&nbsp;readability&nbsp;and&nbsp;size&nbsp;of&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;code,&nbsp;and&nbsp;has&nbsp;the&nbsp;added&nbsp;small&nbsp;bonus&nbsp;of&nbsp;lowering&nbsp;the&nbsp;lookup&nbsp;cost&nbsp;from&nbsp;linear&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;logarithmic&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;Digest&nbsp;code&nbsp;has&nbsp;been&nbsp;run-tested.&nbsp;I&#39;d&nbsp;like&nbsp;feedback&nbsp;on&nbsp;its&nbsp;style,&nbsp;as&lt;br&gt;<br>
&gt;&nbsp;httpHeaderFieldsInfo&nbsp;is&nbsp;abused&nbsp;similarly&nbsp;elswehere&nbsp;and&nbsp;I&#39;m&nbsp;considering&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;apply&nbsp;it&nbsp;elsewhere&nbsp;as&nbsp;well;&nbsp;it&nbsp;can&nbsp;then&nbsp;be&nbsp;further&nbsp;refined&nbsp;to&nbsp;get&nbsp;O(1)&nbsp;via&lt;br&gt;<br>
&gt;&nbsp;a&nbsp;carefully-chosen&nbsp;hash&nbsp;(via&nbsp;std::unsorted_map)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;My&nbsp;thoughts:&nbsp;(sorry&nbsp;if&nbsp;its&nbsp;a&nbsp;bit&nbsp;rambling)&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;dont&nbsp;like&nbsp;spawning&nbsp;lots&nbsp;of&nbsp;new&nbsp;classes&nbsp;for&nbsp;basic&nbsp;things.&nbsp;I&nbsp;know&nbsp;its&lt;br&gt;<br>
essentially&nbsp;the&nbsp;C++&nbsp;way.&nbsp;But&nbsp;applying&nbsp;pattern&nbsp;theory&nbsp;can&nbsp;go&nbsp;too&nbsp;far&lt;br&gt;<br>
sometimes.&nbsp;And&nbsp;this&nbsp;patterns&nbsp;usage&nbsp;is&nbsp;one&nbsp;case&nbsp;where&nbsp;I&nbsp;can&nbsp;see&nbsp;exactly&lt;br&gt;<br>
that&nbsp;happening.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;have&nbsp;a&nbsp;struct,&nbsp;a&nbsp;class,&nbsp;an&nbsp;enum&nbsp;and&nbsp;array.&nbsp;Thats&nbsp;a&nbsp;lot&nbsp;of&nbsp;custom&lt;br&gt;<br>
infrastructure&nbsp;just&nbsp;to&nbsp;represent&nbsp;a&nbsp;simple&nbsp;set&nbsp;of&nbsp;name:id.&nbsp;We&nbsp;could&nbsp;as&lt;br&gt;<br>
easily&nbsp;have&nbsp;std::map&lt;const&nbsp;char*,&nbsp;enum&gt;&nbsp;holding&nbsp;that&nbsp;directly&nbsp;and&nbsp;avoid&lt;br&gt;<br>
all&nbsp;the&nbsp;local&nbsp;types&nbsp;except&nbsp;enum.&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;are&nbsp;already&nbsp;5&nbsp;headers&nbsp;currently&nbsp;in&nbsp;Squid&nbsp;that&nbsp;need&nbsp;these&nbsp;same&lt;br&gt;<br>
operations&nbsp;applied,&nbsp;and&nbsp;at&nbsp;least&nbsp;as&nbsp;many&nbsp;more&nbsp;that&nbsp;should&nbsp;but&nbsp;dont&nbsp;even&lt;br&gt;<br>
use&nbsp;the&nbsp;current&nbsp;HttpHeaderFieldAttrs&nbsp;related&nbsp;types&nbsp;yet.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
struct&nbsp;HttpDigestFieldAttrs&nbsp;should&nbsp;be&nbsp;a&nbsp;template&nbsp;class&nbsp;so&nbsp;we&nbsp;dont&nbsp;have&lt;br&gt;<br>
to&nbsp;re-implement&nbsp;a&nbsp;new&nbsp;little&nbsp;struct&nbsp;for&nbsp;each&nbsp;enum.&lt;br&gt;<br>
&lt;br&gt;<br>
BUT,&nbsp;notice&nbsp;that&nbsp;generalizing&nbsp;that&nbsp;same&nbsp;structure&nbsp;is&nbsp;also&nbsp;where&nbsp;the&nbsp;enum&lt;br&gt;<br>
casting&nbsp;hack&nbsp;for&nbsp;HttpHeaderFieldAttrs&nbsp;comes&nbsp;from&nbsp;in&nbsp;the&nbsp;first&nbsp;place.&lt;br&gt;<br>
 The&nbsp;probkem&nbsp;was&nbsp;template&nbsp;style&nbsp;breaks&nbsp;with&nbsp;C++03&nbsp;compilers&nbsp;thinking&nbsp;all&lt;br&gt;<br>
enums&nbsp;are&nbsp;of&nbsp;&quot;int&quot;&nbsp;type.&nbsp;Enter&nbsp;lots&nbsp;of&nbsp;repeated-instantiation&nbsp;complaints&lt;br&gt;<br>
from&nbsp;dumb&nbsp;compilers.&lt;br&gt;<br>
 I&#39;ve&nbsp;not&nbsp;tried&nbsp;it&nbsp;with&nbsp;current&nbsp;C++11&nbsp;compilers&nbsp;which&nbsp;are&nbsp;quite&nbsp;a&nbsp;bit&lt;br&gt;<br>
smarter.&nbsp;It&nbsp;may&nbsp;work&nbsp;now&nbsp;(or&nbsp;not).&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;*that*&nbsp;can&nbsp;be&nbsp;solved&nbsp;then&nbsp;refactoring&nbsp;HttpHeaderFieldAttrs&nbsp;to&nbsp;a&lt;br&gt;<br>
template&nbsp;is&nbsp;better&nbsp;way&nbsp;forward.&nbsp;Maybe&nbsp;followed&nbsp;by&nbsp;replacing&nbsp;or&lt;br&gt;<br>
refactoring&nbsp;the&nbsp;HttpHeaderFieldInfo&nbsp;bits&nbsp;to&nbsp;avoid&nbsp;the&nbsp;performance&lt;br&gt;<br>
problem&nbsp;you&nbsp;identified.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Hi,&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp;no&nbsp;rambling,&nbsp;it&#39;s&nbsp;ok.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Actually,&nbsp;the&nbsp;performance&nbsp;improvement&nbsp;is&nbsp;just&nbsp;a&nbsp;nice&nbsp;byproduct,&nbsp;that&#39;s&nbsp;not&nbsp;the&nbsp;objective&nbsp;at&nbsp;all,&nbsp;as&nbsp;I&nbsp;tried&nbsp;explaining&nbsp;in&nbsp;the&nbsp;merge&nbsp;proposal.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;The&nbsp;actual&nbsp;problem&nbsp;I&nbsp;was&nbsp;addressing&nbsp;is&nbsp;the&nbsp;multiple&nbsp;C&nbsp;casts&nbsp;used&nbsp;to&nbsp;try&nbsp;and&nbsp;coerce&nbsp;anything&nbsp;resembling&nbsp;a&nbsp;map&lt;const&nbsp;char&nbsp;*,&nbsp;int&gt;&nbsp;into&nbsp;an&nbsp;http/1&nbsp;header&nbsp;table,&nbsp;simply&nbsp;because&nbsp;there&nbsp;is&nbsp;code&nbsp;in&nbsp;squid&nbsp;which&nbsp;implements&nbsp;that&nbsp;map&nbsp;as&nbsp;a&nbsp;header&nbsp;table&nbsp;(and&nbsp;rather&nbsp;naively,&nbsp;at&nbsp;that&nbsp;-&nbsp;linear&nbsp;scan&nbsp;is&nbsp;SO&nbsp;fifties&nbsp;;)&nbsp;).&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;In&nbsp;fact,&nbsp;I&nbsp;argue&nbsp;that&nbsp;the&nbsp;proposed&nbsp;version&nbsp;is&nbsp;actually&nbsp;simpler&nbsp;than&nbsp;the&nbsp;previous&nbsp;code;&nbsp;it&nbsp;can&nbsp;maybe&nbsp;even&nbsp;be&nbsp;simplified&nbsp;further&nbsp;but&nbsp;not&nbsp;much&nbsp;further,&nbsp;let&#39;s&nbsp;go&nbsp;over&nbsp;it&nbsp;a&nbsp;bit&nbsp;toghether&nbsp;if&nbsp;you&nbsp;want.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;struct&nbsp;HttpDigestFieldAttrs&nbsp;is&nbsp;there&nbsp;simply&nbsp;to&nbsp;have&nbsp;a&nbsp;convenient&nbsp;representation&nbsp;of&nbsp;the&nbsp;header&nbsp;table&nbsp;DigestAttrs.&nbsp;It&nbsp;makes&nbsp;no&nbsp;attempt&nbsp;to&nbsp;be&nbsp;anything&nbsp;different.&nbsp;Can&nbsp;it&nbsp;be&nbsp;turned&nbsp;into&nbsp;GenericInitializerFromStringTo&lt;enum&nbsp;foo&gt;&nbsp;?&nbsp;Yes.&nbsp;Is&nbsp;it&nbsp;worth&nbsp;it&nbsp;for&nbsp;3&nbsp;LOC?&nbsp;not&nbsp;so&nbsp;sure.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;DigestFieldslookupTable_t&nbsp;is&nbsp;probably&nbsp;what&nbsp;you&nbsp;are&nbsp;lashing&nbsp;out&nbsp;at,&nbsp;I&nbsp;bet.&lt;br&gt;Yes,&nbsp;it&nbsp;could&nbsp;be&nbsp;made&nbsp;generic&nbsp;and&nbsp;templatized&nbsp;to&nbsp;represent&nbsp;a&nbsp;SBuf-to-anything&nbsp;with&nbsp;a&nbsp;static&nbsp;table&nbsp;initializer.&nbsp;I&nbsp;haven&#39;t&nbsp;tried&nbsp;that&nbsp;as&nbsp;that&nbsp;may&nbsp;be&nbsp;PMO&nbsp;and&nbsp;it&nbsp;may&nbsp;preclude&nbsp;turning&nbsp;the&nbsp;index&nbsp;from&nbsp;a&nbsp;map&nbsp;to&nbsp;an&nbsp;unordered_map&nbsp;with&nbsp;a&nbsp;table-specific&nbsp;hasher&nbsp;(gperf-generated&nbsp;or&nbsp;hand-written,&nbsp;it&#39;s&nbsp;rather&nbsp;trivial&nbsp;to&nbsp;do&nbsp;it&nbsp;in&nbsp;this&nbsp;and&nbsp;in&nbsp;many&nbsp;other&nbsp;cases&nbsp;we&nbsp;care&nbsp;about).&lt;br&gt;Doing&nbsp;that&nbsp;with&nbsp;a&nbsp;generic&nbsp;would&nbsp;be&nbsp;harder,&nbsp;require&nbsp;roughly&nbsp;about&nbsp;as&nbsp;much&nbsp;code,&nbsp;and&nbsp;for&nbsp;a&nbsp;&lt;20-LOC&nbsp;class,&nbsp;would&nbsp;probably&nbsp;be&nbsp;overdesign.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;The&nbsp;patch&nbsp;has&nbsp;been&nbsp;build-tested&nbsp;successfully&nbsp;on&nbsp;all&nbsp;platforms&nbsp;we&nbsp;care&nbsp;about,&nbsp;and&nbsp;run-tested&nbsp;(refactoring&nbsp;went&nbsp;in&nbsp;two&nbsp;phases:&nbsp;add&nbsp;new&nbsp;code,&nbsp;assert()&nbsp;that&nbsp;it&nbsp;behaves&nbsp;like&nbsp;the&nbsp;old&nbsp;code&nbsp;and&nbsp;run-test,&nbsp;rip&nbsp;old&nbsp;code&nbsp;out).&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;IMVHO&nbsp;HttpHeaderFieldAttrs&nbsp;is&nbsp;poor&nbsp;legacy,&nbsp;and&nbsp;deserves&nbsp;a&nbsp;thankful&nbsp;and&nbsp;merciful&nbsp;eviction&nbsp;from&nbsp;our&nbsp;code-base&nbsp;:)&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt; &nbsp; &nbsp;Kinkie&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
