<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Jul&nbsp;29,&nbsp;2015&nbsp;at&nbsp;11:31&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;30/07/2015&nbsp;9:10&nbsp;a.m.,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;<br>
&gt; &nbsp; &nbsp;I&#39;m&nbsp;starting&nbsp;to&nbsp;work&nbsp;on&nbsp;refactoring&nbsp;HttpHeader&nbsp;to&nbsp;use&nbsp;LookupTable,&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;boy&nbsp;that&nbsp;code&nbsp;is&nbsp;a&nbsp;mess..&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Since&nbsp;it&#39;s&nbsp;going&nbsp;to&nbsp;take&nbsp;significant&nbsp;effort,&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;get&nbsp;feedback&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;changes&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;implement,&nbsp;so&nbsp;not&nbsp;to&nbsp;end&nbsp;in&nbsp;long&nbsp;discussions&nbsp;later.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Current&nbsp;data&nbsp;structures:&lt;br&gt;<br>
&gt;&nbsp;HeadersAttrs:&nbsp;static&nbsp;declaration&nbsp;of&nbsp;header&nbsp;name,&nbsp;header&nbsp;ID,&nbsp;header&nbsp;type&lt;br&gt;<br>
&gt;&nbsp;(string/int/etc).&nbsp;Must&nbsp;be&nbsp;sorted&nbsp;by&nbsp;numeric&nbsp;value&nbsp;of&nbsp;ID&lt;br&gt;<br>
&gt;&nbsp;Headers:&nbsp;built&nbsp;at&nbsp;initialization&nbsp;time&nbsp;from&nbsp;HeadersAttrs,&nbsp;it&#39;s&nbsp;an&nbsp;array&nbsp;of&lt;br&gt;<br>
&gt;&nbsp;(name,&nbsp;id,&nbsp;type,&nbsp;stats)&nbsp;structs&lt;br&gt;<br>
&gt;&nbsp;ListHeadersArr,&nbsp;GeneralHeadersArr,&nbsp;EntityHeadersArr,&nbsp;RequestHeadersArr,&lt;br&gt;<br>
&gt;&nbsp;ReplyHeadersArr,&nbsp;etc:&nbsp;lists&nbsp;of&nbsp;headers&nbsp;ID&nbsp;(possibly&nbsp;overlapping)&nbsp;which&nbsp;are&lt;br&gt;<br>
&gt;&nbsp;used&nbsp;to&nbsp;generate..&lt;br&gt;<br>
&gt;&nbsp;ListHeadersMask,&nbsp;GeneralHeadersArr,&nbsp;EntityHeadersArr&nbsp;etc:&nbsp;bitmaps&nbsp;used&lt;br&gt;<br>
&gt;&nbsp;(only)&nbsp;by&nbsp;HttpHeaderStats&nbsp;to&nbsp;assemble&nbsp;different&nbsp;stats&nbsp;sets&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;seem&nbsp;to&nbsp;recall&nbsp;a&nbsp;hop-by-hop&nbsp;headers&nbsp;lists&nbsp;as&nbsp;well&nbsp;and&nbsp;the&lt;br&gt;<br>
request/reply&nbsp;lists&nbsp;being&nbsp;used&nbsp;by&nbsp;message&nbsp;filtering&nbsp;logic&nbsp;to&nbsp;strip&nbsp;away&lt;br&gt;<br>
invalid&nbsp;and&nbsp;hop-by-hop&nbsp;headers&nbsp;?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&nbsp;was&nbsp;a&nbsp;partial&nbsp;list.&nbsp;But&nbsp;yes,&nbsp;we&nbsp;need&nbsp;a&nbsp;quick&nbsp;way&nbsp;to&nbsp;understand&nbsp;some&nbsp;spec&nbsp;characteristics&nbsp;of&nbsp;any&nbsp;given&nbsp;header,&nbsp;defined&nbsp;by&nbsp;ID.&nbsp;Current&nbsp;approach&nbsp;is&nbsp;very&nbsp;effective&nbsp;at&nbsp;packing&nbsp;the&nbsp;information&nbsp;but&nbsp;very&nbsp;low-level,&nbsp;but&nbsp;very&nbsp;low-level&nbsp;and&nbsp;probably&nbsp;not&nbsp;very&nbsp;much&nbsp;effective.&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt;&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;turn&nbsp;these&nbsp;into:&lt;br&gt;<br>
&gt;&nbsp;headerTable:&nbsp;LookupTable&lt;&gt;::Record&nbsp;mapping&nbsp;header&nbsp;name&nbsp;to&nbsp;header&nbsp;ID,&nbsp;used&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;generate&nbsp;...&lt;br&gt;<br>
&gt;&nbsp;headerLookupTable:&nbsp;a&nbsp;fast&nbsp;lookup&nbsp;table&nbsp;of&nbsp;header&nbsp;names&nbsp;to&nbsp;ids&lt;br&gt;<br>
&gt;&nbsp;headerStatsTable:&nbsp;a&nbsp;std::vector&lt;HttpHeaderFieldStat&gt;&nbsp;indexed&nbsp;by&nbsp;header&nbsp;ID&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;collect&nbsp;the&nbsp;statistics&nbsp;currently&nbsp;in&nbsp;Headers[id].stats.&lt;br&gt;<br>
&gt;&nbsp;headerDescription:&nbsp;a&nbsp;std::vector&nbsp;keyed&nbsp;by&nbsp;header&nbsp;ID&nbsp;containing&nbsp;header&nbsp;type&lt;br&gt;<br>
&gt;&nbsp;(currently&nbsp;in&nbsp;Headers[id].type),&nbsp;possibly&nbsp;header&nbsp;name&nbsp;(if&nbsp;useful),&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;bitfield&nbsp;noting&nbsp;if&nbsp;HTTP_HDR{LIST,GENERAL,REQUEST,REPLY,...}.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;There&nbsp;are&nbsp;some&nbsp;possible&nbsp;optimizations,&nbsp;but&nbsp;at&nbsp;a&nbsp;minimum&nbsp;this&nbsp;should&nbsp;help&lt;br&gt;<br>
&gt;&nbsp;keep&nbsp;information&nbsp;more&nbsp;organized&nbsp;while&nbsp;introducing&nbsp;no&nbsp;performance&lt;br&gt;<br>
&gt;&nbsp;regressions.&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;do&nbsp;you&nbsp;think?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;In&nbsp;my&nbsp;brief&nbsp;look&nbsp;the&nbsp;other&nbsp;day&nbsp;I&nbsp;thought&nbsp;a&nbsp;small&nbsp;struct&nbsp;{ID,&nbsp;type,&nbsp;group&lt;br&gt;<br>
bitmask}&nbsp;could&nbsp;be&nbsp;used&nbsp;as&nbsp;the&nbsp;EnumType&nbsp;on&nbsp;LookupTable.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;don&#39;t&nbsp;like&nbsp;the&nbsp;idea,&nbsp;as&nbsp;it&nbsp;makes&nbsp;the&nbsp;header&nbsp;name&nbsp;the&nbsp;primary&nbsp;key.&nbsp;We&nbsp;want&nbsp;the&nbsp;primary&nbsp;key&nbsp;to&nbsp;be&nbsp;header&nbsp;ID,&nbsp;and&nbsp;header&nbsp;name&nbsp;just&nbsp;an&nbsp;index.&nbsp;It&nbsp;really&nbsp;is&nbsp;two&nbsp;different&nbsp;users:&nbsp;1.&nbsp;given&nbsp;a&nbsp;header&nbsp;name,&nbsp;get&nbsp;the&nbsp;ID;&nbsp;2.&nbsp;given&nbsp;an&nbsp;ID,&nbsp;get&nbsp;the&nbsp;header&#39;s&nbsp;characteristics.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;can&nbsp;do&nbsp;it&nbsp;by&nbsp;changing&nbsp;LookupType&nbsp;to&nbsp;be&nbsp;parametric&nbsp;on&nbsp;Record&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;template&nbsp;&lt;typename&nbsp;EnumType&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;typedef&nbsp;struct&nbsp;LookupTableRecord&lt;br&gt;{&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &nbsp;const&nbsp;char&nbsp;*name;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &nbsp;EnumType&nbsp;id;&lt;br&gt;&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;template&lt;typename&nbsp;Enumtype,&nbsp;typename&nbsp;RecordType&nbsp;=&nbsp;LookupTableRecord&lt;EnumType&gt;&nbsp;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;class&nbsp;LookupTable&lt;br&gt;{&lt;br&gt;  &nbsp;//...&lt;br&gt;}&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;would&nbsp;make&nbsp;it&nbsp;so&nbsp;that&nbsp;someone&nbsp;could&nbsp;define&nbsp;a&nbsp;custom&nbsp;Record&nbsp;type,&nbsp;and&nbsp;as&nbsp;long&nbsp;as&nbsp;that&nbsp;record&nbsp;type&nbsp;matches&nbsp;the&nbsp;signature&nbsp;of&nbsp;LookupTableRecord,&nbsp;LookupTable&nbsp;won&#39;t&nbsp;care.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;also&nbsp;has&nbsp;the&nbsp;advantate&nbsp;of&nbsp;not&nbsp;needing&nbsp;to&nbsp;fill&nbsp;in&nbsp;different&nbsp;data&nbsp;structures&nbsp;from&nbsp;the&nbsp;static&nbsp;initializer&nbsp;table.&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;id&nbsp;of&nbsp;each&nbsp;row&nbsp;in&nbsp;the&nbsp;initializer&nbsp;table&nbsp;is&nbsp;equal&nbsp;to&nbsp;the&nbsp;index&nbsp;of&nbsp;that&nbsp;row&nbsp;(which&nbsp;is&nbsp;an&nbsp;already-present&nbsp;requirement),&nbsp;then&nbsp;the&nbsp;initializer&nbsp;table&nbsp;will&nbsp;carry&nbsp;all&nbsp;the&nbsp;read-only&nbsp;information&nbsp;we&nbsp;need.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Plan&nbsp;#2:&nbsp;change&nbsp;the&nbsp;LookupTable&nbsp;API&nbsp;to&nbsp;allow&nbsp;filling&nbsp;it&nbsp;in&nbsp;from&nbsp;the&nbsp;outside,&nbsp;and&nbsp;initialize&nbsp;it&nbsp;from&nbsp;the&nbsp;module&nbsp;init&nbsp;code&nbsp;(just&nbsp;like&nbsp;now).&nbsp;This&nbsp;way&nbsp;we&nbsp;can&nbsp;have&nbsp;a&nbsp;single&nbsp;big&nbsp;table&nbsp;with&nbsp;all&nbsp;the&nbsp;relevant&nbsp;information&nbsp;and&nbsp;fill&nbsp;in&nbsp;different&nbsp;data&nbsp;structures&nbsp;during&nbsp;the&nbsp;initialization&nbsp;loop.&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
LookupTable&nbsp;really&nbsp;only&nbsp;needs&nbsp;a&nbsp;POD&nbsp;type&nbsp;that&nbsp;can&nbsp;be&nbsp;copied&nbsp;cheaply&nbsp;for&lt;br&gt;<br>
its&nbsp;stored&nbsp;type.&nbsp;Enum&nbsp;/&nbsp;int&nbsp;is&nbsp;the&nbsp;simplest&nbsp;of&nbsp;those&nbsp;but&nbsp;not&nbsp;mandatory.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;that&nbsp;works&nbsp;then&nbsp;you&nbsp;can&nbsp;collapse&nbsp;headerLookupTable&nbsp;and&lt;br&gt;<br>
headerDescription&nbsp;into&nbsp;one&nbsp;list&nbsp;that&nbsp;efficiently&nbsp;looks&nbsp;up&nbsp;all&nbsp;data&nbsp;for&lt;br&gt;<br>
the&nbsp;header.&nbsp;Getting&nbsp;rid&nbsp;of&nbsp;the&nbsp;multiple&nbsp;sub-list&nbsp;type&nbsp;arrays.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;proposed&nbsp;change&nbsp;to&nbsp;LookupTable&nbsp;seems&nbsp;more&nbsp;elegant&nbsp;to&nbsp;me&nbsp;and&nbsp;is&nbsp;tested&nbsp;working;&nbsp;what&nbsp;do&nbsp;you&nbsp;think?&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt; &nbsp; &nbsp;Kinkie&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
