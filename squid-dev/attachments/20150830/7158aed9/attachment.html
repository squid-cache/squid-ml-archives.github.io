<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;kkjuOn&nbsp;Aug&nbsp;28,&nbsp;2015&nbsp;7:24&nbsp;PM,&nbsp;&quot;Alex&nbsp;Rousskov&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;On&nbsp;08/28/2015&nbsp;09:02&nbsp;AM,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Thu,&nbsp;Aug&nbsp;27,&nbsp;2015&nbsp;at&nbsp;9:28&nbsp;PM,&nbsp;Alex&nbsp;Rousskov&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; On&nbsp;08/27/2015&nbsp;08:58&nbsp;AM,&nbsp;Kinkie&nbsp;wrote:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt; &nbsp; this&nbsp;patch&nbsp;turns&nbsp;StoreEntry&nbsp;into&nbsp;MEMPROXY_CLASS,&nbsp;getting&nbsp;rid&nbsp;of&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;default&nbsp;constructors.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt; &nbsp; In&nbsp;the&nbsp;process,&nbsp;it&nbsp;turns&nbsp;hash_link&nbsp;into&nbsp;a&nbsp;class,&nbsp;giving&nbsp;it&nbsp;a&nbsp;default&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;constructor&nbsp;in&nbsp;order&nbsp;to&nbsp;support&nbsp;nonzeroing&nbsp;pools.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt; &nbsp; The&nbsp;old&nbsp;custom&nbsp;allocator&nbsp;also&nbsp;gave&nbsp;a&nbsp;nonstandard&nbsp;chunk&nbsp;size;&nbsp;that&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;tweak&nbsp;should&nbsp;not&nbsp;be&nbsp;necessary&nbsp;anymore.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Can&nbsp;you&nbsp;explain&nbsp;why&nbsp;that&nbsp;tweak&nbsp;should&nbsp;not&nbsp;be&nbsp;necessary&nbsp;any&nbsp;more?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;was&nbsp;discussed&nbsp;on&nbsp;IRC&nbsp;(log&nbsp;edited&nbsp;for&nbsp;clarity,&nbsp;date&nbsp;is&nbsp;2015-08-20)&lt;br&gt;<br>
&lt;br&gt;<br>
Does&nbsp;not&nbsp;seem&nbsp;like&nbsp;it&nbsp;was&nbsp;_explained_&nbsp;though.&lt;br&gt;<br>
&lt;br&gt;<br>
Our&nbsp;vague&nbsp;understanding&nbsp;of&nbsp;the&nbsp;original&nbsp;code&nbsp;seems&nbsp;to&nbsp;revolve&nbsp;around&lt;br&gt;<br>
something&nbsp;like&nbsp;&quot;larger&nbsp;chunk&nbsp;size&nbsp;was&nbsp;specified&nbsp;to&nbsp;allocate&nbsp;large&nbsp;number&lt;br&gt;<br>
of&nbsp;StoreEntry&nbsp;objects&nbsp;efficiently&quot;.&nbsp;It&nbsp;is&nbsp;not&nbsp;clear&nbsp;to&nbsp;me&nbsp;why&nbsp;allocating&lt;br&gt;<br>
large&nbsp;number&nbsp;of&nbsp;StoreEntry&nbsp;objects&nbsp;efficiently&nbsp;no&nbsp;longer&nbsp;requires&nbsp;larger&lt;br&gt;<br>
chunks.&lt;br&gt;<br>
&lt;br&gt;<br>
It&nbsp;is&nbsp;strange&nbsp;that&nbsp;your&nbsp;proposed&nbsp;commit&nbsp;message&nbsp;claims&nbsp;that&nbsp;something&lt;br&gt;<br>
should&nbsp;not&nbsp;be&nbsp;needed&nbsp;any&nbsp;more&nbsp;but&nbsp;we&nbsp;do&nbsp;not&nbsp;actually&nbsp;know&nbsp;whether&nbsp;it&nbsp;is&lt;br&gt;<br>
needed&nbsp;or&nbsp;not.&nbsp;If&nbsp;this&nbsp;goes&nbsp;in,&nbsp;I&nbsp;would&nbsp;recommend&nbsp;clearly&nbsp;stating&nbsp;that&lt;br&gt;<br>
your&nbsp;are&nbsp;changing&nbsp;something&nbsp;potentially&nbsp;major&nbsp;that&nbsp;you&nbsp;_hope_&nbsp;has&nbsp;no&lt;br&gt;<br>
negative&nbsp;performance&nbsp;effects.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&lt;yadi&gt;&nbsp;kinkie:&nbsp;I&nbsp;think&nbsp;this&nbsp;calls&nbsp;for&nbsp;an&nbsp;experimental&nbsp;targeted&lt;br&gt;<br>
&gt;&nbsp;conversion&nbsp;with&nbsp;lots&nbsp;of&nbsp;tests&nbsp;on&nbsp;what&nbsp;behaviour&nbsp;is&nbsp;affected.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;would&nbsp;agree&nbsp;in&nbsp;general,&nbsp;but&nbsp;I&nbsp;doubt&nbsp;you&nbsp;can&nbsp;run&nbsp;relevant&nbsp;tests&nbsp;in&nbsp;this&lt;br&gt;<br>
case.&nbsp;Perhaps&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;avoid&nbsp;this&nbsp;particular&nbsp;part&nbsp;of&nbsp;the&nbsp;change&lt;br&gt;<br>
and&nbsp;keep&nbsp;the&nbsp;StoreEntry&nbsp;chunk&nbsp;sizes&nbsp;the&nbsp;same&nbsp;as&nbsp;they&nbsp;are&nbsp;today?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Unfortunately&nbsp;not&nbsp;if&nbsp;we&nbsp;want&nbsp;to&nbsp;proceed&nbsp;with&nbsp;MEMPROXY_CLASS&nbsp;conversion,&nbsp;which&nbsp;doesn&#39;t&nbsp;expose&nbsp;that&nbsp;method,&nbsp;and&nbsp;MEMPROXY_CLASS&nbsp;is&nbsp;with&nbsp;this&nbsp;branch&nbsp;the&nbsp;easiest&nbsp;(I&nbsp;would&nbsp;dare&nbsp;to&nbsp;say&nbsp;standard)&nbsp;way&nbsp;to&nbsp;go&nbsp;to&nbsp;non-zeroing&nbsp;pools.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;I&#39;ve&nbsp;tried&nbsp;to&nbsp;figure&nbsp;out&nbsp;the&nbsp;code&nbsp;some&nbsp;more;&nbsp;comments&nbsp;highlight&nbsp;that&nbsp;it&#39;s&nbsp;an&nbsp;optimization&nbsp;feature,&nbsp;which&nbsp;is&nbsp;only&nbsp;effective&nbsp;with&nbsp;the&nbsp;chunked&nbsp;allocator&nbsp;-&nbsp;it&nbsp;is&nbsp;otherwise&nbsp;a&nbsp;nop.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;I&nbsp;believe&nbsp;this&nbsp;hint&nbsp;its&nbsp;is&nbsp;meant&nbsp;to&nbsp;try&nbsp;and&nbsp;alter&nbsp;the&nbsp;behavior&nbsp;of&nbsp;the&nbsp;chunked&nbsp;allocator&nbsp;-&nbsp;in&nbsp;a&nbsp;roundabout&nbsp;way&nbsp;-&nbsp;hinting&nbsp;that&nbsp;the&nbsp;objects&nbsp;in&nbsp;the&nbsp;pool&nbsp;are&nbsp;important&nbsp;and&nbsp;thus&nbsp;to&nbsp;try&nbsp;and&nbsp;make&nbsp;that&nbsp;particular&nbsp;object&nbsp;pool&nbsp;less&nbsp;sensitive&nbsp;to&nbsp;memory&nbsp;pressure,&nbsp;by&nbsp;ensuring&nbsp;that&nbsp;if&nbsp;even&nbsp;a&nbsp;single&nbsp;StoreEntry&nbsp;can&nbsp;be&nbsp;allocated,&nbsp;there&nbsp;will&nbsp;be&nbsp;at&nbsp;least&nbsp;(chunk_size/obj_size&nbsp;-1)&nbsp;available&nbsp;memory&nbsp;areas&nbsp;until&nbsp;all&nbsp;of&nbsp;them&nbsp;have&nbsp;been&nbsp;released.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Maybe&nbsp;we&nbsp;could&nbsp;test&nbsp;the&nbsp;effects&nbsp;of&nbsp;this&nbsp;optimization&nbsp;by&nbsp;setting&nbsp;a&nbsp;low&nbsp;memory_pools_limit,&nbsp;but&nbsp;then&nbsp;whatever&nbsp;gap&nbsp;in&nbsp;performance&nbsp;would&nbsp;probably&nbsp;be&nbsp;dwarfed&nbsp;by&nbsp;fallback&nbsp;to&nbsp;malloc&nbsp;when&nbsp;allocating&nbsp;other&nbsp;objects&nbsp;due&nbsp;to&nbsp;the&nbsp;pressure.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;In&nbsp;other&nbsp;words,&nbsp;I&nbsp;suspect&nbsp;that&nbsp;whatever&nbsp;is&nbsp;the&nbsp;optimization&nbsp;value&nbsp;of&nbsp;chunk&nbsp;size&nbsp;setting,&nbsp;it&nbsp;is&nbsp;dwarfed&nbsp;by&nbsp;other&nbsp;effects&nbsp;and&nbsp;is&nbsp;speculative;&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;we&nbsp;have&nbsp;a&nbsp;sure&nbsp;gain&nbsp;by&nbsp;not&nbsp;initializing&nbsp;objects&nbsp;twice&nbsp;(one&nbsp;when&nbsp;zeroing&nbsp;the&nbsp;pool,&nbsp;and&nbsp;then&nbsp;in&nbsp;the&nbsp;constructor).&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;For&nbsp;this&nbsp;reason,&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;go&nbsp;ahead&nbsp;with&nbsp;the&nbsp;merge,&nbsp;I&nbsp;agree&nbsp;it&#39;s&nbsp;a&nbsp;good&nbsp;idea&nbsp;to&nbsp;isolate&nbsp;this&nbsp;patch&nbsp;into&nbsp;a&nbsp;separate&nbsp;commit,&nbsp;and&nbsp;to&nbsp;mark&nbsp;it&nbsp;as&nbsp;potentially&nbsp;performance-impacting&nbsp;in&nbsp;the&nbsp;commit&nbsp;message.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;you&nbsp;agree.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt; &nbsp;Kinkie&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
