<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Calibri,&nbsp;sans-serif;&quot;&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;Hi,&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;span&nbsp;id=&quot;OLK_SRC_BODY_SECTION&quot;&gt;<br>
&lt;div&gt;<br>
&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Calibri,&nbsp;sans-serif;&quot;&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;have&nbsp;worked&nbsp;out&nbsp;a&nbsp;simple&nbsp;fix&nbsp;for&nbsp;this&nbsp;bug&nbsp;&lt;a&nbsp;href=&quot;http://bugs.squid-cache.org/show_bug.cgi?id=4337&quot;&gt;http://bugs.squid-cache.org/show_bug.cgi?id=4337&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;To&nbsp;test&nbsp;I’ve&nbsp;copied&nbsp;the&nbsp;code&nbsp;which&nbsp;adds&nbsp;the&nbsp;certificate&nbsp;to&nbsp;the&nbsp;chain&nbsp;from&nbsp;ConnStateData::getSslContextDone&nbsp;to&nbsp;ConnStateData::getSslContextStart&nbsp;inside&nbsp;the&nbsp;sslBump&nbsp;decision&nbsp;(if&nbsp;(sslServerBump&nbsp;&amp;&amp;&nbsp;(sslServerBump-&gt;act.step1&nbsp;==&nbsp;Ssl::bumpPeek&nbsp;||&nbsp;sslServerBump-&gt;act.step1<br>
&nbsp;==&nbsp;Ssl::bumpStare)))&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Addition:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SSL_CTX&nbsp;*&nbsp;ctx&nbsp;=&nbsp;SSL_get_SSL_CTX(ssl);&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X509&nbsp;*cert&nbsp;=&nbsp;port-&gt;signingCert.get();&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(SSL_CTX_add_extra_chain_cert(ctx,&nbsp;cert))&nbsp;{&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;increase&nbsp;the&nbsp;certificate&nbsp;lock&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CRYPTO_add(&amp;(cert-&gt;references),1,CRYPTO_LOCK_X509);&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;int&nbsp;ssl_error&nbsp;=&nbsp;ERR_get_error();&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(33,&nbsp;DBG_IMPORTANT,&nbsp;&quot;WARNING:&nbsp;can&nbsp;not&nbsp;add&nbsp;signing&nbsp;certificate&nbsp;to&nbsp;SSL&nbsp;context&nbsp;chain:&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;ERR_error_string(ssl_error,&nbsp;NULL));&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ssl::addChainToSslContext(ctx,&nbsp;port-&gt;certsToChain.get());&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;There&nbsp;will&nbsp;be&nbsp;a&nbsp;better&nbsp;way&nbsp;of&nbsp;this&nbsp;(definitely&nbsp;one&nbsp;that&nbsp;doesn’t&nbsp;involve&nbsp;duplication&nbsp;of&nbsp;code)&nbsp;but&nbsp;it&nbsp;at&nbsp;least&nbsp;pin-points&nbsp;the&nbsp;problem.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/span&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
