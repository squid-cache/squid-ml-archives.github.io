<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt; SQUID_MAXFD&nbsp;==&nbsp;256,&nbsp;but&nbsp;Sqid_MaxFD&nbsp;==&nbsp;4096,&nbsp;and&nbsp;SQUID_MAXFD_LIMIT&nbsp;==&nbsp;1024&lt;br&gt;it&#39;s&nbsp;like,&nbsp;that&nbsp;some&nbsp;code&nbsp;uses&nbsp;SQUID_MAXFD,&nbsp;and&nbsp;some&nbsp;Squid_MaxFD&lt;br&gt; it&#39;s&nbsp;looks&nbsp;that&nbsp;it&nbsp;is&nbsp;supposed,&nbsp;that&nbsp;SQUID_MAXFD&nbsp;always&nbsp;&gt;=&nbsp;Squid_MaxFD,&nbsp;but&nbsp;in&nbsp;main.cc&nbsp;there&nbsp;is&nbsp;possibility&nbsp;to&nbsp;get&nbsp;Squis_MaxFD&nbsp;&gt;&nbsp;SQUID_MAXFD&nbsp;(in&nbsp;getrlimit&nbsp;branch:&nbsp;setMaxFD)&lt;br&gt;so,&nbsp;it&nbsp;looks&nbsp;like&nbsp;architecture&nbsp;bug&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;fix,&nbsp;sorry.&lt;br&gt;but&nbsp;in&nbsp;our&nbsp;case&nbsp;we&nbsp;will&nbsp;try&nbsp;to&nbsp;sync&nbsp;all&nbsp;values&nbsp;to&nbsp;1024,&nbsp;hope&nbsp;it&nbsp;helps&nbsp;to&nbsp;fix&nbsp;bug&nbsp;in&nbsp;squid.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2016-10-18&nbsp;17:48&nbsp;GMT+03:00&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&lt;/span&gt;:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;10/18/2016&nbsp;03:44&nbsp;AM,&nbsp;oleg&nbsp;gv&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;nfds=284,&nbsp;so&nbsp;loop&nbsp;ends&nbsp;on&nbsp;283&nbsp;and&nbsp;pfds[283]&nbsp;is&nbsp;buggy&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I/o&nbsp;module&nbsp;is &nbsp;src/comm/ModPoll.cc,&nbsp;method&nbsp;Comm::DoSelect(int&nbsp;msec)&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;stack&nbsp;we&nbsp;see&nbsp;that&nbsp;pfds[SQUID_MAXFD=256],&nbsp;so&nbsp;is&nbsp;less&nbsp;than&nbsp;nfds&nbsp;in&nbsp;loop.&lt;br&gt;<br>
&gt;&nbsp;May&nbsp;be&nbsp;malloc&nbsp;nfds?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;If&nbsp;your&nbsp;maxfd&nbsp;is&nbsp;bigger&nbsp;than&nbsp;SQUID_MAXFD&nbsp;than&nbsp;the&nbsp;bug&nbsp;is&nbsp;elsewhere&nbsp;and&lt;br&gt;<br>
dynamically&nbsp;allocating&nbsp;pfds&nbsp;is&nbsp;not&nbsp;the&nbsp;right&nbsp;fix&nbsp;(even&nbsp;though&nbsp;it&nbsp;will&lt;br&gt;<br>
&quot;work&quot;).&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;suspect&nbsp;your&nbsp;Squid&nbsp;is&nbsp;creating&nbsp;creating&nbsp;or&nbsp;accepting&nbsp;a&nbsp;descriptor&nbsp;that&lt;br&gt;<br>
exceeds&nbsp;SQUID_MAXFD-1.&nbsp;Biggest_FD+1&nbsp;cannot&nbsp;be&nbsp;allowed&nbsp;to&nbsp;exceed&nbsp;the&lt;br&gt;<br>
misnamed&nbsp;SQUID_MAXFD&nbsp;limit.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;combination&nbsp;looks&nbsp;like&nbsp;a&nbsp;big&nbsp;red&nbsp;flag&nbsp;to&nbsp;me:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;struct&nbsp;pollfd&nbsp;pfds[SQUID_MAXFD];&lt;br&gt;<br>
 &nbsp; &nbsp;...&lt;br&gt;<br>
 &nbsp; &nbsp;maxfd&nbsp;=&nbsp;Biggest_FD&nbsp;+&nbsp;1;&lt;br&gt;<br>
 &nbsp; &nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;maxfd;&nbsp;++i)&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;...&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;pfds[nfds].fd&nbsp;=&nbsp;i;&lt;br&gt;<br>
&lt;br&gt;<br>
That&nbsp;code&nbsp;is&nbsp;missing&nbsp;assert(maxfd&nbsp;&lt;=&nbsp;SQUID_MAXFD)&nbsp;which&nbsp;will&nbsp;fail&nbsp;in&lt;br&gt;<br>
your&nbsp;case.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;want&nbsp;a&nbsp;workaround,&nbsp;try&nbsp;building&nbsp;Squid&nbsp;with&nbsp;a&nbsp;reasonable&nbsp;number&nbsp;of&lt;br&gt;<br>
maximum&nbsp;descriptors&nbsp;(e.g.,&nbsp;16K,&nbsp;32K,&nbsp;or&nbsp;64K).&nbsp;If&nbsp;that&nbsp;number&nbsp;is&nbsp;never&lt;br&gt;<br>
reached&nbsp;in&nbsp;your&nbsp;environment,&nbsp;the&nbsp;code&nbsp;will&nbsp;appear&nbsp;to&nbsp;work.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;want&nbsp;to&nbsp;try&nbsp;a&nbsp;quick&nbsp;fix,&nbsp;replace&nbsp;SQUID_MAXFD&nbsp;with&nbsp;(Biggest_FD&nbsp;+&lt;br&gt;<br>
1)&nbsp;when&nbsp;declaring&nbsp;pfds.&nbsp;You&nbsp;may&nbsp;need&nbsp;to&nbsp;ignore/disable&nbsp;compiler&nbsp;warnings&lt;br&gt;<br>
about&nbsp;C++&nbsp;arrays&nbsp;with&nbsp;dynamic&nbsp;sizes.&nbsp;Alternatively,&nbsp;you&nbsp;can&nbsp;allocate&lt;br&gt;<br>
pfds&nbsp;dynamically&nbsp;(as&nbsp;you&nbsp;suggested).&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;want&nbsp;to&nbsp;fix&nbsp;the&nbsp;bug,&nbsp;audit&nbsp;all&nbsp;Biggest_FD-&nbsp;and&lt;br&gt;<br>
SQUID_MAXFD-related&nbsp;code&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;two&nbsp;are&nbsp;always&nbsp;in&nbsp;sync.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;2016-10-18&nbsp;8:29&nbsp;GMT+03:00&nbsp;Amos&nbsp;Jeffries:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; FYI:&nbsp;Squid-3.5.23&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet.&nbsp;What&nbsp;is&nbsp;the&nbsp;output&nbsp;of&nbsp;&quot;squid&nbsp;-v&quot;&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; On&nbsp;18/10/2016&nbsp;5:01&nbsp;a.m.,&nbsp;oleg&nbsp;gv&nbsp;wrote:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;I&nbsp;have&nbsp;big&nbsp;traffic&nbsp;(at&nbsp;least&nbsp;100&nbsp;computers)&nbsp;,&nbsp;and&nbsp;squid&nbsp;often&nbsp;crashed&nbsp;in&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;Comm::DoSelect(int&nbsp;msec)&nbsp;function.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;I&nbsp;have&nbsp;interception&nbsp;mode&nbsp;and&nbsp;NAT&nbsp;redirect.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;In&nbsp;coredump&nbsp;I&nbsp;saw&nbsp;then&nbsp;bug&nbsp;is&nbsp;in&nbsp;next&nbsp;fragment&nbsp;of&nbsp;code:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;446│ &nbsp; &nbsp; &nbsp; &nbsp; for&nbsp;(size_t&nbsp;loopIndex&nbsp;=&nbsp;0;&nbsp;loopIndex&nbsp;&lt;&nbsp;nfds;&nbsp;++loopIndex)&nbsp;{&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;447│ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fde&nbsp;*F;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;448│ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int&nbsp;revents&nbsp;=&nbsp;pfds[loopIndex].revents;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;449│ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd&nbsp;=&nbsp;pfds[loopIndex].fd;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;450│&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;451│ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(fd&nbsp;==&nbsp;-1)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;452│ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;453│&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;454├&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(fd_table[fd].flags.read_&lt;wbr&gt;pending)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;455│ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; revents&nbsp;|=&nbsp;POLLIN;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;SIGSEGV&nbsp;occured&nbsp;often&nbsp;(about&nbsp;1&nbsp;time&nbsp;in&nbsp;a&nbsp;minute)&nbsp;in&nbsp;line&nbsp;454&nbsp;:&nbsp;fd=-66012128&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;,&nbsp;loopindex=283&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;(gdb)&nbsp;p&nbsp;pfds[282]&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;$17&nbsp;=&nbsp;{fd&nbsp;=&nbsp;291,&nbsp;events&nbsp;=&nbsp;64,&nbsp;revents&nbsp;=&nbsp;0} &nbsp; --&nbsp;looks&nbsp;ok&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;(gdb)&nbsp;p&nbsp;pfds[283]&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;$18&nbsp;=&nbsp;{fd&nbsp;=&nbsp;-66012128,&nbsp;events&nbsp;=&nbsp;32595,&nbsp;revents&nbsp;=&nbsp;0} &nbsp;--&nbsp;looks&nbsp;strange&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;spoiled&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;(gdb)&nbsp;p&nbsp;Biggest_FD&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;$19&nbsp;=&nbsp;292&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; What&nbsp;is&nbsp;the&nbsp;nfds&nbsp;value&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; It&nbsp;looks&nbsp;to&nbsp;me&nbsp;like&nbsp;only&nbsp;282&nbsp;FD&nbsp;have&nbsp;operations&nbsp;to&nbsp;perform&nbsp;on&nbsp;this&nbsp;I/O&lt;br&gt;<br>
&gt; &nbsp; &nbsp; cycle.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; What&nbsp;I/O&nbsp;module&nbsp;is&nbsp;being&nbsp;used?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;src/comm/ModDevPoll.cc:Comm::&lt;wbr&gt;DoSelect(int&nbsp;msec)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;src/comm/ModPoll.cc:Comm::&lt;wbr&gt;DoSelect(int&nbsp;msec)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Amos&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
&gt; &nbsp; &nbsp; squid-dev&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&gt;squid-dev@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&nbsp;&lt;mailto:&lt;a&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&gt;squid-dev@lists.squid-&lt;wbr&gt;cache.org&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-dev&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-dev&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
&gt;&nbsp;squid-dev&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&gt;squid-dev@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-dev&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
