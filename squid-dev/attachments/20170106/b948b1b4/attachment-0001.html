<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=windows-1252&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class=&quot;moz-cite-prefix&quot;&gt;On&nbsp;06.01.2017&nbsp;15:27,&nbsp;Amos&nbsp;Jeffries<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:23c730b91294cecb5d78b59c2120fa27@treenet.co.nz&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;As&nbsp;a&nbsp;result,&nbsp;the&nbsp;code&nbsp;responsible&nbsp;for&nbsp;lower-case<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;transformation&nbsp;was&nbsp;not&nbsp;executed.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;That&nbsp;is&nbsp;intentional&nbsp;behaviour&nbsp;for&nbsp;several&nbsp;reasons;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;it&nbsp;improves&nbsp;transparency&nbsp;and&nbsp;reduces&nbsp;risks&nbsp;from&nbsp;proxy<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fingerprinting&nbsp;by&nbsp;systems&nbsp;probing&nbsp;the&nbsp;URI&nbsp;scheme&nbsp;handling&nbsp;by&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transport&nbsp;agents&nbsp;(ie,&nbsp;fingerprinting&nbsp;Squid).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;unknown&nbsp;URI&nbsp;schemes&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;handled&nbsp;properly&nbsp;as<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case-insensitive&nbsp;by&nbsp;the&nbsp;experimental&nbsp;agents&nbsp;sending&nbsp;and&nbsp;receiving<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;messages.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;also,&nbsp;(and&nbsp;more&nbsp;importantly);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;patch&nbsp;does&nbsp;not&nbsp;change&nbsp;this,&nbsp;i.e.,&nbsp;&quot;unknown&quot;&nbsp;images&nbsp;are&nbsp;still<br>
&nbsp;&nbsp;&nbsp;&nbsp;stored&nbsp;without&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;down-casing.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:23c730b91294cecb5d78b59c2120fa27@treenet.co.nz&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3)&nbsp;the&nbsp;transport&nbsp;protocol&nbsp;label&nbsp;and&nbsp;URI&nbsp;scheme&nbsp;label&nbsp;are&nbsp;still<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conflated.&nbsp;The&nbsp;scheme&nbsp;down-casing&nbsp;procedure&nbsp;is&nbsp;_only_&nbsp;applicable<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when&nbsp;translating&nbsp;from&nbsp;ProtocolType_str&nbsp;labels&nbsp;(upper&nbsp;case)&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scheme&nbsp;label&nbsp;(lower&nbsp;case).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;avoid&nbsp;misunderstanding&nbsp;I&nbsp;pay&nbsp;your&nbsp;attention&nbsp;that&nbsp;the&nbsp;unpatched<br>
&nbsp;&nbsp;&nbsp;&nbsp;Squid&nbsp;did&nbsp;not&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;down-case&nbsp;at&nbsp;all&nbsp;(i.e.&nbsp;for&nbsp;known&nbsp;ProtocolType_str&nbsp;schemes&nbsp;too).&nbsp;In<br>
&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;words,&nbsp;when&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;receiving<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;charset=windows-1252&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;HTTP://example.com&quot;&gt;HTTP://example.com&lt;/a&gt;&nbsp;&quot;HTTP&quot;&nbsp;was&nbsp;not&nbsp;down-cased.&nbsp;Just&nbsp;this&nbsp;violates<br>
&nbsp;&nbsp;&nbsp;&nbsp;HTTP&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;caching&nbsp;rules:&nbsp;two&nbsp;different&nbsp;cache&nbsp;entries&nbsp;were&nbsp;created&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;HTTP://example.com&quot;&gt;HTTP://example.com&lt;/a&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://example.com&quot;&gt;http://example.com&lt;/a&gt;&nbsp;requests.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:23c730b91294cecb5d78b59c2120fa27@treenet.co.nz&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4)&nbsp;storing&nbsp;the&nbsp;down-cased&nbsp;string&nbsp;for&nbsp;registered&nbsp;protocols&nbsp;of&nbsp;each<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;URI&nbsp;avoids&nbsp;many&nbsp;explicit&nbsp;down-casing&nbsp;operations&nbsp;on&nbsp;use/display&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;URI&nbsp;scheme.&nbsp;Note&nbsp;that&nbsp;is&nbsp;specific&nbsp;to&nbsp;the&nbsp;known&nbsp;protocols.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;There&nbsp;are&nbsp;many&nbsp;more&nbsp;points&nbsp;of&nbsp;code&nbsp;displaying&nbsp;the&nbsp;scheme&nbsp;than<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setting&nbsp;it.&nbsp;So&nbsp;this&nbsp;is&nbsp;a&nbsp;significant&nbsp;performance&nbsp;gain&nbsp;despite&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overhead&nbsp;of&nbsp;allocating&nbsp;and&nbsp;own-casing&nbsp;a&nbsp;new&nbsp;SBuf&nbsp;per&nbsp;UriScheme<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;your&nbsp;patch&nbsp;notes&nbsp;with&nbsp;an&nbsp;XXX.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;am&nbsp;not&nbsp;against&nbsp;allocating&nbsp;and&nbsp;storing&nbsp;down-cased&nbsp;SBuf&nbsp;&quot;image_&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;(for&nbsp;performance&nbsp;sake).&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;related&nbsp;XXX&nbsp;is&nbsp;about &nbsp;allocating&nbsp;SBuf&nbsp;which&nbsp;we&nbsp;probably&nbsp;can<br>
&nbsp;&nbsp;&nbsp;&nbsp;avoid&nbsp;in&nbsp;future&nbsp;optimization.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;example,&nbsp;we&nbsp;could&nbsp;do&nbsp;this&nbsp;by&nbsp;converting&nbsp;ProtocolType_str&nbsp;to&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;array&nbsp;of&nbsp;SBufs,&nbsp;thus&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;avoiding&nbsp;image_&nbsp;member&nbsp;allocation&nbsp;when&nbsp;dealing&nbsp;with&nbsp;known&nbsp;protocols.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:23c730b91294cecb5d78b59c2120fa27@treenet.co.nz&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There&nbsp;are&nbsp;a&nbsp;couple&nbsp;of&nbsp;XXX&nbsp;and&nbsp;one&nbsp;of&nbsp;them&nbsp;(about&nbsp;&quot;broken&nbsp;caller&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROTO_NONE)&nbsp;needs&nbsp;clarification.&nbsp;This&nbsp;caller&nbsp;uses&nbsp;PROTO_NONE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(i.e.,&nbsp;absent&nbsp;scheme)&nbsp;together&nbsp;with&nbsp;&quot;http&quot;&nbsp;scheme&nbsp;image&nbsp;inside<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientReplyContext::createStoreEntry()&nbsp;which&nbsp;looks&nbsp;inconsistent<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;probably&nbsp;is&nbsp;a&nbsp;bug.&nbsp;Am&nbsp;I&nbsp;missing&nbsp;anything&nbsp;there?<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thats&nbsp;an&nbsp;odd&nbsp;case.&nbsp;I'm&nbsp;not&nbsp;exactly&nbsp;sure&nbsp;what&nbsp;we&nbsp;should&nbsp;be&nbsp;doing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;there.&nbsp;Thus&nbsp;the&nbsp;unusual&nbsp;parameter&nbsp;combo.&nbsp;It&nbsp;was&nbsp;done&nbsp;that&nbsp;way&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;minimize&nbsp;breakage&nbsp;with&nbsp;old&nbsp;code&nbsp;-&nbsp;so&nbsp;the&nbsp;request&nbsp;can&nbsp;be&nbsp;detected<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;missing&nbsp;scheme&nbsp;(avoid&nbsp;confusing&nbsp;with&nbsp;a&nbsp;real&nbsp;HTTP&nbsp;URL)&nbsp;if<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anything&nbsp;tries&nbsp;to&nbsp;compare&nbsp;it,&nbsp;but&nbsp;still&nbsp;generates&nbsp;a&nbsp;reasonably<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;correct&nbsp;URL&nbsp;if&nbsp;its&nbsp;dumped&nbsp;to&nbsp;store&nbsp;files.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Since&nbsp;you&nbsp;agree&nbsp;that&nbsp;it&nbsp;is&nbsp;an&nbsp;&quot;odd&quot;&nbsp;case&nbsp;(and&nbsp;we&nbsp;are&nbsp;not&nbsp;going&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;fix&nbsp;it&nbsp;right&nbsp;now)&nbsp;I&nbsp;would&nbsp;leave&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;&quot;broken&nbsp;caller&quot;&nbsp;XXX.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Please&nbsp;note&nbsp;that&nbsp;the&nbsp;major&nbsp;problem&nbsp;here&nbsp;is&nbsp;probably&nbsp;the&nbsp;caching<br>
&nbsp;&nbsp;&nbsp;&nbsp;problem&nbsp;as&nbsp;I&nbsp;noted&nbsp;above.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;have&nbsp;not&nbsp;fully&nbsp;investigated&nbsp;whether&nbsp;it&nbsp;has&nbsp;security&nbsp;aspects,&nbsp;i.e.,<br>
&nbsp;&nbsp;&nbsp;&nbsp;affects&nbsp;some&nbsp;URL&nbsp;based&nbsp;ACLs&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;comparing&nbsp;with&nbsp;stored&nbsp;URLs.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Eduard.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
