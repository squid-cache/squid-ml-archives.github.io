committer: Alexander Gozman <a.gozman@securitycode.ru>
timestamp: Tue 2017-02-14 13:29:52 +0300
message:
  Native FTP relay: NAT and TPROXY interception fixes.
diff:
=== modified file 'src/servers/FtpServer.cc'
--- src/servers/FtpServer.cc	2017-01-01 00:14:42 +0000
+++ src/servers/FtpServer.cc	2017-02-14 10:29:52 +0000
@@ -1455,7 +1455,19 @@
 
     // Use local IP address of the control connection as the source address
     // of the active data connection, or some clients will refuse to accept.
-    conn->setAddrs(clientConnection->local, cltAddr);
+    if (clientConnection->flags & COMM_TRANSPARENT) {
+        conn->setAddrs(clientConnection->local, cltAddr);
+        conn->flags |= COMM_TRANSPARENT;
+    } else {
+        // In case of NAT interception squid's local address
+        // will be used for outgoing connection.
+        conn->local.setAnyAddr();
+        conn->remote = cltAddr;
+
+        if (conn->remote.isIPv4())
+            conn->local.setIPv4();
+    }
+
     // RFC 959 requires active FTP connections to originate from port 20
     // but that would preclude us from supporting concurrent transfers! (XXX?)
     conn->local.port(0);