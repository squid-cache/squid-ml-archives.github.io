<tt>
&lt;div&gt;&gt;If&nbsp;you&nbsp;want&nbsp;port&nbsp;80&nbsp;to&nbsp;just&nbsp;be&nbsp;relayed&nbsp;through&nbsp;-&nbsp;dont&nbsp;send&nbsp;it&nbsp;to&nbsp;Squid.&lt;br&gt;&lt;br&gt;&gt;You&nbsp;will&nbsp;probably&nbsp;be&nbsp;able&nbsp;to&nbsp;identify&nbsp;the&nbsp;DNS&nbsp;packets&nbsp;with&nbsp;your&nbsp;firewall&lt;br&gt;&gt;rules&nbsp;easier&nbsp;than&nbsp;Squid&nbsp;can&nbsp;tell&nbsp;it&nbsp;apart&nbsp;from&nbsp;a&nbsp;mangled&nbsp;HTTP&nbsp;message.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;I&nbsp;want&nbsp;to&nbsp;do&nbsp;is&nbsp;to&nbsp;use&nbsp;Squid&nbsp;ecap&nbsp;adaptation&nbsp;to&nbsp;modify&nbsp;some&nbsp;http&nbsp;response.&lt;/div&gt;&lt;div&gt;But&nbsp;during&nbsp;the&nbsp;running&nbsp;time,&nbsp;I&nbsp;found&nbsp;that&nbsp;some&nbsp;famous&nbsp;mobile&nbsp;app&nbsp;using&nbsp;80&nbsp;port&lt;/div&gt;&lt;div&gt;transport&nbsp;some&nbsp;unknown&nbsp;protocol&nbsp;(not&nbsp;http).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;if&nbsp;the&nbsp;protocol&nbsp;is&nbsp;not&nbsp;http,&nbsp;but&nbsp;using&nbsp;80&nbsp;port,&nbsp;can&nbsp;squid&nbsp;relay&nbsp;it&nbsp;to&nbsp;its&nbsp;target&nbsp;server?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;sign&nbsp;signid=&quot;-1&quot;&gt;&lt;/sign&gt;&lt;/div&gt;&lt;div&gt;&lt;qzone&gt;&lt;/qzone&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;div&gt;&lt;includetail&gt;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;div&nbsp;style=&quot;font:Verdana&nbsp;normal&nbsp;14px;color:#000;&quot;&gt;&lt;div&nbsp;style=&quot;FONT-SIZE:&nbsp;12px;FONT-FAMILY:&nbsp;Arial&nbsp;Narrow;padding:2px&nbsp;0&nbsp;2px&nbsp;0;&quot;&gt;------------------&nbsp;Original&nbsp;------------------&lt;/div&gt;&lt;div&nbsp;style=&quot;FONT-SIZE:&nbsp;12px;background:#efefef;padding:8px;&quot;&gt;&lt;div&nbsp;id=&quot;menu_sender&quot;&gt;&lt;b&gt;From:&nbsp;&lt;/b&gt;&nbsp;&quot;Amos&nbsp;Jeffries&quot;&lt;squid3@treenet.co.nz&gt;;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Date:&nbsp;&lt;/b&gt;&nbsp;Mon,&nbsp;Mar&nbsp;27,&nbsp;2017&nbsp;11:59&nbsp;AM&lt;/div&gt;&lt;div&gt;&lt;b&gt;To:&nbsp;&lt;/b&gt;&nbsp;&quot;钱国正&quot;&lt;richard.qian@magicwifi.com.cn&gt;;&nbsp;&quot;squid-dev&quot;&lt;squid-dev@lists.squid-cache.org&gt;;&nbsp;&lt;wbr&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Subject:&nbsp;&lt;/b&gt;&nbsp;Re:&nbsp;on_unsupported_protocol&nbsp;rewrite&nbsp;to&nbsp;support&nbsp;tcp&nbsp;connection,&nbsp;relay&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&lt;/div&gt;On&nbsp;27/03/2017&nbsp;3:15&nbsp;p.m.,&nbsp;钱国正&nbsp;wrote:&lt;br&gt;&gt;&gt;&gt;&nbsp;I&nbsp;want&nbsp;to&nbsp;know&nbsp;what's&nbsp;the&lt;br&gt;&gt;&gt;&gt;&nbsp;pinning.serverConnection&nbsp;mean?&nbsp;and&nbsp;what&nbsp;it&nbsp;is&nbsp;used&nbsp;for?&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;Before&nbsp;we&nbsp;dive&nbsp;into&nbsp;low-level&nbsp;details,&nbsp;please&nbsp;allow&nbsp;me&nbsp;to&nbsp;ask&nbsp;an&lt;br&gt;&gt;&gt;&nbsp;important&nbsp;high-level&nbsp;question.&nbsp;Your&nbsp;answer&nbsp;may&nbsp;render&nbsp;those&nbsp;low-level&lt;br&gt;&gt;&gt;&nbsp;detail&nbsp;irrelevant:&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&gt;&nbsp;I&nbsp;want&nbsp;to&nbsp;rewrite&nbsp;the&nbsp;on_unsupported_protocol&nbsp;to&nbsp;support&nbsp;tcp&nbsp;connection&lt;br&gt;&gt;&gt;&gt;&nbsp;(non-http&nbsp;protocol,&nbsp;called&nbsp;httpdns&nbsp;not&nbsp;readable,&nbsp;no&nbsp;http&nbsp;header)&nbsp;and&lt;br&gt;&gt;&gt;&gt;&nbsp;relay&nbsp;it&nbsp;the&nbsp;server.&nbsp;[...]&nbsp;I&nbsp;need&nbsp;assign&nbsp;the&nbsp;server's&nbsp;address&nbsp;and&nbsp;port&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;Where&nbsp;will&nbsp;your&nbsp;code&nbsp;get&nbsp;the&nbsp;server&nbsp;address&nbsp;and&nbsp;port&nbsp;from?&nbsp;If&nbsp;the&nbsp;answer&lt;br&gt;&gt;&gt;&nbsp;is&nbsp;&quot;from&nbsp;the&nbsp;received&nbsp;httpdns&nbsp;message&nbsp;header&quot;,&nbsp;then&nbsp;please&nbsp;do&nbsp;not&nbsp;abuse&lt;br&gt;&gt;&gt;&nbsp;on_unsupported_protocol&nbsp;to&nbsp;support&nbsp;&quot;httpdns&quot;.&nbsp;Instead,&nbsp;add&nbsp;proper&lt;br&gt;&gt;&gt;&nbsp;support&nbsp;for&nbsp;httpdns&nbsp;(which&nbsp;may&nbsp;be&nbsp;limited&nbsp;to&nbsp;forwarding&nbsp;httpdns&nbsp;queries&lt;br&gt;&gt;&gt;&nbsp;to&nbsp;the&nbsp;right&nbsp;server&nbsp;if&nbsp;such&nbsp;blind&nbsp;forwarding&nbsp;makes&nbsp;sense).&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;No,&nbsp;I&nbsp;got&nbsp;it&nbsp;from&nbsp;`clientConnection-&gt;local`,&nbsp;the&nbsp;httpdns&nbsp;is&nbsp;just&nbsp;a&nbsp;tcp&nbsp;connection&nbsp;to&nbsp;server&nbsp;with&lt;br&gt;&gt;&nbsp;specified&nbsp;protocol,&nbsp;not&nbsp;known&nbsp;to&nbsp;me,&nbsp;it&nbsp;is&nbsp;designed&nbsp;by&nbsp;its&nbsp;user,&nbsp;use&nbsp;80&nbsp;port&nbsp;to&nbsp;transfer&nbsp;dns&nbsp;request.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&lt;br&gt;If&nbsp;you&nbsp;want&nbsp;port&nbsp;80&nbsp;to&nbsp;just&nbsp;be&nbsp;relayed&nbsp;through&nbsp;-&nbsp;dont&nbsp;send&nbsp;it&nbsp;to&nbsp;Squid.&lt;br&gt;&lt;br&gt;You&nbsp;will&nbsp;probably&nbsp;be&nbsp;able&nbsp;to&nbsp;identify&nbsp;the&nbsp;DNS&nbsp;packets&nbsp;with&nbsp;your&nbsp;firewall&lt;br&gt;rules&nbsp;easier&nbsp;than&nbsp;Squid&nbsp;can&nbsp;tell&nbsp;it&nbsp;apart&nbsp;from&nbsp;a&nbsp;mangled&nbsp;HTTP&nbsp;message.&lt;br&gt;&lt;br&gt;&lt;br&gt;&gt;&gt;&nbsp;BTW,&nbsp;can&nbsp;you&nbsp;post&nbsp;a&nbsp;link&nbsp;to&nbsp;the&nbsp;&quot;httpdns&quot;&nbsp;protocol&nbsp;specification&nbsp;(not&lt;br&gt;&gt;&gt;&nbsp;API)?&nbsp;And&nbsp;what&nbsp;do&nbsp;you&nbsp;mean&nbsp;by&nbsp;&quot;not&nbsp;readable&quot;?&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;standard&nbsp;protocol&nbsp;in&nbsp;RFC&nbsp;or&nbsp;some&nbsp;standard&nbsp;specification,&nbsp;just&nbsp;some&nbsp;company&nbsp;use&nbsp;&lt;br&gt;&gt;&nbsp;80&nbsp;(default&nbsp;for&nbsp;http&nbsp;protocol)&nbsp;port&nbsp;to&nbsp;transfer&nbsp;dns&nbsp;request,&nbsp;they&nbsp;do&nbsp;this&nbsp;because&nbsp;in&nbsp;China&nbsp;many&nbsp;&lt;br&gt;&gt;&nbsp;ISP&nbsp;would&nbsp;use&nbsp;they&nbsp;own&nbsp;dns&nbsp;server&nbsp;in&nbsp;different&nbsp;places&nbsp;which&nbsp;makes&nbsp;it&nbsp;slow&nbsp;&lt;br&gt;&gt;&nbsp;or&nbsp;unreachable&nbsp;to&nbsp;the&nbsp;some&nbsp;company's&nbsp;service.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&lt;br&gt;Then&nbsp;please&nbsp;stop&nbsp;calling&nbsp;it&nbsp;&quot;httpdns&quot;.&nbsp;It&nbsp;is&nbsp;&quot;DNS&quot;.&nbsp;Calling&nbsp;it&nbsp;&quot;httpdns&quot;&lt;br&gt;implies&nbsp;some&nbsp;relationship&nbsp;to&nbsp;HTTP&nbsp;other&nbsp;than&nbsp;just&nbsp;stealing&nbsp;the&nbsp;port&nbsp;number.&lt;br&gt;&lt;br&gt;There&nbsp;is&nbsp;actually&nbsp;a&nbsp;protocol&nbsp;called&nbsp;HTTPDNS&nbsp;being&nbsp;designed&lt;br&gt;(&lt;https://tools.ietf.org/html/draft-ietf-dnsop-dns-wireformat-http-00&gt;).&lt;br&gt;Squid&nbsp;supports&nbsp;relaying&nbsp;that&nbsp;already&nbsp;because&nbsp;it&nbsp;uses&nbsp;real&nbsp;HTTP&nbsp;messages&lt;br&gt;on&nbsp;port&nbsp;80.&lt;br&gt;&lt;br&gt;Amos&lt;br&gt;&lt;/div&gt;&lt;!--&lt;![endif]--&gt;&lt;/includetail&gt;&lt;/div&gt;
</tt>
