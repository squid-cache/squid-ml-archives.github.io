<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Hello,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;am&nbsp;attaching&nbsp;an&nbsp;improved&nbsp;version&nbsp;of&nbsp;the&nbsp;patch&nbsp;posted&nbsp;before.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;v4&nbsp;r15081.&nbsp;What&nbsp;was&nbsp;fixed:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Correctly&nbsp;purge&nbsp;StoreEntries,&nbsp;'disconnected'&nbsp;from&nbsp;the&nbsp;Store&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;   &nbsp;(unlinking&nbsp;by&nbsp;a&nbsp;valid&nbsp;cache_key&nbsp;in&nbsp;these&nbsp;cases).&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Do&nbsp;not&nbsp;release&nbsp;just&nbsp;created&nbsp;keyless&nbsp;StoreEntries.&nbsp;This&nbsp;caused&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;   &nbsp;several&nbsp;problems,&nbsp;such&nbsp;as&nbsp;calling&nbsp;key-dependent&nbsp;methods&nbsp;with&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;nil&nbsp;key,&nbsp;setting&nbsp;the&nbsp;private&nbsp;key&nbsp;twice&nbsp;and&nbsp;setting&nbsp;the&nbsp;private<br>
&nbsp;&nbsp;&nbsp;&nbsp;key&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;   &nbsp;to&nbsp;be&nbsp;overwritten&nbsp;by&nbsp;the&nbsp;public&nbsp;key&nbsp;later&nbsp;in&nbsp;some&nbsp;other&nbsp;callers.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Fixed&nbsp;tests/testRock&nbsp;test&nbsp;case,&nbsp;to&nbsp;conform&nbsp;to&nbsp;the&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;   &nbsp;&quot;do&nbsp;not&nbsp;overwrite&nbsp;an&nbsp;existing&nbsp;(and&nbsp;identical)&nbsp;disk&nbsp;entry&quot;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;   &nbsp;requirement.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;Documented&nbsp;several&nbsp;methods&nbsp;and&nbsp;eliminated&nbsp;some&nbsp;code&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;   &nbsp;duplication&nbsp;(hasMemStore()&nbsp;and&nbsp;hasTransients()&nbsp;helper&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;methods).&nbsp;More&nbsp;work&nbsp;needed&nbsp;in&nbsp;this&nbsp;direction.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Eduard.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class=&quot;moz-cite-prefix&quot;&gt;On&nbsp;01.06.2017&nbsp;19:27,&nbsp;Eduard&nbsp;Bagdasaryan<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cite=&quot;mid:68a0d7fb-6e14-195c-b167-fc9bdbea4643@measurement-factory.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;Hello,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;patch&nbsp;fixes&nbsp;Squid&nbsp;bug&nbsp;4505.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Before&nbsp;this&nbsp;change,&nbsp;SMP&nbsp;Squid&nbsp;with&nbsp;SMP-aware&nbsp;caches&nbsp;sometimes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;does&nbsp;not&nbsp;purge&nbsp;cache&nbsp;entries.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;Squid&nbsp;finds&nbsp;a&nbsp;requested&nbsp;entry&nbsp;in&nbsp;the&nbsp;memory&nbsp;cache,&nbsp;it&nbsp;does<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;not<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check&nbsp;whether&nbsp;the&nbsp;same&nbsp;entry&nbsp;is&nbsp;also&nbsp;stored&nbsp;in&nbsp;a&nbsp;cache_dir.&nbsp;The<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StoreEntry&nbsp;object&nbsp;may&nbsp;become&nbsp;associated&nbsp;with&nbsp;its&nbsp;store&nbsp;entry&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memory&nbsp;cache&nbsp;but&nbsp;not&nbsp;with&nbsp;its&nbsp;store&nbsp;entry&nbsp;on&nbsp;disk.&nbsp;This<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inconsistency<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;causes&nbsp;two&nbsp;known&nbsp;problems:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;Squid&nbsp;may&nbsp;needlessly&nbsp;swap&nbsp;out&nbsp;the&nbsp;memory&nbsp;hit&nbsp;to&nbsp;disk,&nbsp;either<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;overwriting&nbsp;an&nbsp;existing&nbsp;(and&nbsp;identical)&nbsp;disk&nbsp;entry&nbsp;or,&nbsp;worse,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;creating&nbsp;a&nbsp;duplicate&nbsp;entry&nbsp;on&nbsp;another&nbsp;disk.&nbsp;In&nbsp;the&nbsp;second&nbsp;case,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;two&nbsp;disk&nbsp;entries&nbsp;are&nbsp;not&nbsp;synchronized&nbsp;and&nbsp;may&nbsp;eventually&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;differ&nbsp;if&nbsp;one&nbsp;of&nbsp;them&nbsp;is&nbsp;removed&nbsp;or&nbsp;updated.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Squid&nbsp;may&nbsp;not&nbsp;delete&nbsp;a&nbsp;stale&nbsp;disk&nbsp;entry&nbsp;when&nbsp;needed,&nbsp;violating<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;various&nbsp;HTTP&nbsp;MUSTs,&nbsp;and&nbsp;eventually&nbsp;serving&nbsp;stale&nbsp;[disk]&nbsp;cache<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;to&nbsp;clients.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Another&nbsp;purging&nbsp;problem&nbsp;is&nbsp;not&nbsp;caused&nbsp;by&nbsp;the&nbsp;above&nbsp;inconsistency:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;A&nbsp;DELETE&nbsp;request&nbsp;or&nbsp;equivalent&nbsp;may&nbsp;come&nbsp;for&nbsp;the&nbsp;entry&nbsp;which&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;still<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;locked&nbsp;for&nbsp;writing.&nbsp;Squid&nbsp;fails&nbsp;to&nbsp;get&nbsp;a&nbsp;lock&nbsp;for&nbsp;such&nbsp;an&nbsp;entry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;order&nbsp;to&nbsp;purge&nbsp;it)&nbsp;and&nbsp;the&nbsp;entry&nbsp;remains&nbsp;in&nbsp;disk&nbsp;and/or&nbsp;memory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;solve&nbsp;the&nbsp;first&nbsp;two&nbsp;problems:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;StoreEntry::mayStartSwapout()&nbsp;now&nbsp;avoids&nbsp;needless&nbsp;swapouts&nbsp;by<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checking<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;whether&nbsp;StoreEntry&nbsp;was&nbsp;fully&nbsp;loaded,&nbsp;is&nbsp;being&nbsp;loaded,&nbsp;or&nbsp;could<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;have<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;been&nbsp;loaded&nbsp;from&nbsp;disk.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;fix&nbsp;problem&nbsp;#3:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;new&nbsp;Store::Controller::unlinkByKey()&nbsp;method&nbsp;purges&nbsp;(or&nbsp;marks<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;deletion&nbsp;if&nbsp;purging&nbsp;is&nbsp;impossible)&nbsp;all&nbsp;the&nbsp;matching&nbsp;store<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;without&nbsp;loading&nbsp;the&nbsp;StoreEntry&nbsp;information&nbsp;from&nbsp;stores.&nbsp;The&nbsp;lack<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;StoreEntry&nbsp;creation&nbsp;reduces&nbsp;waste&nbsp;of&nbsp;resources&nbsp;(the&nbsp;StoreEntry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;would&nbsp;have&nbsp;to&nbsp;be&nbsp;deleted&nbsp;anyway)&nbsp;_and_&nbsp;allows&nbsp;us&nbsp;to&nbsp;mark<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;being-created<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;entries&nbsp;(that&nbsp;are&nbsp;locked&nbsp;for&nbsp;writing&nbsp;and,&nbsp;hence,&nbsp;cannot&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loaded&nbsp;into<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;a&nbsp;StoreEntry&nbsp;object).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Note&nbsp;that&nbsp;even&nbsp;if&nbsp;Squid&nbsp;properly&nbsp;avoids&nbsp;storing&nbsp;duplicate&nbsp;disk<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some&nbsp;cache_dir&nbsp;manipulations&nbsp;by&nbsp;humans&nbsp;and&nbsp;Squid&nbsp;crashes&nbsp;may&nbsp;lead<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;such&nbsp;duplicates&nbsp;being&nbsp;present. &nbsp;This&nbsp;patch&nbsp;leaves&nbsp;dealing&nbsp;with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;potential<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duplicates&nbsp;out&nbsp;of&nbsp;scope&nbsp;except&nbsp;it&nbsp;guarantees&nbsp;that&nbsp;if&nbsp;an&nbsp;entry&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deleted,&nbsp;then&nbsp;all&nbsp;[possible]&nbsp;duplicates&nbsp;are&nbsp;deleted&nbsp;as&nbsp;well.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Also&nbsp;added&nbsp;StoreEntry&nbsp;helper&nbsp;methods&nbsp;to&nbsp;prevent&nbsp;direct<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;manipulation&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;individual&nbsp;disk-related&nbsp;data&nbsp;members&nbsp;(swap_dirn,&nbsp;swap_filen,&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;swap_status).&nbsp;These&nbsp;methods&nbsp;help&nbsp;keep&nbsp;these&nbsp;related&nbsp;data&nbsp;members<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coherent&nbsp;state&nbsp;and&nbsp;minimize&nbsp;code&nbsp;duplication.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Also&nbsp;tightened&nbsp;rules&nbsp;around&nbsp;several&nbsp;Storage&nbsp;methods:&nbsp;A&nbsp;storage<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;method<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;must&nbsp;not&nbsp;be&nbsp;given&nbsp;a&nbsp;StoreEntry&nbsp;object&nbsp;unless&nbsp;that&nbsp;object&nbsp;belongs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;that<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Also&nbsp;do&nbsp;not&nbsp;mark&nbsp;Transients&nbsp;entry&nbsp;as&nbsp;&quot;waitingToBeFreed&quot;&nbsp;when&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;simply&nbsp;closed&nbsp;for&nbsp;writing.&nbsp;This&nbsp;flag&nbsp;is&nbsp;used&nbsp;to&nbsp;mark&nbsp;locked<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;deletion&nbsp;and&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;&quot;completed&quot;&nbsp;transient<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entries&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;avoid&nbsp;confusion.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXX:&nbsp;SMP&nbsp;cache&nbsp;purges&nbsp;may&nbsp;continue&nbsp;to&nbsp;malfunction&nbsp;when&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Transients<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;table&nbsp;is&nbsp;missing.&nbsp;Currently,&nbsp;Transients&nbsp;are&nbsp;created&nbsp;only&nbsp;when&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collapsed_forwarding&nbsp;is&nbsp;on.&nbsp;After&nbsp;Squid&nbsp;bug&nbsp;4579&nbsp;is&nbsp;fixed,&nbsp;every<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StoreEntry&nbsp;will&nbsp;have&nbsp;the&nbsp;corresponding&nbsp;Transients&nbsp;entry&nbsp;and&nbsp;vice<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;versa,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extending&nbsp;these&nbsp;fixes&nbsp;to&nbsp;all&nbsp;SMP&nbsp;environments.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Since&nbsp;this&nbsp;work&nbsp;started&nbsp;long&nbsp;ago&nbsp;and&nbsp;is&nbsp;v4-based,&nbsp;I&nbsp;am&nbsp;attaching<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;existing&nbsp;v4&nbsp;patch&nbsp;for&nbsp;review&nbsp;now&nbsp;and&nbsp;start&nbsp;converting&nbsp;it&nbsp;to&nbsp;v5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;plan&nbsp;to&nbsp;post&nbsp;final&nbsp;v5&nbsp;version&nbsp;after&nbsp;the&nbsp;review&nbsp;is&nbsp;over.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thanks,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Eduard.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;fieldset&nbsp;class=&quot;mimeAttachmentHeader&quot;&gt;&lt;/fieldset&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;_______________________________________________<br>
squid-dev&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&gt;squid-dev@lists.squid-cache.org&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&gt;http://lists.squid-cache.org/listinfo/squid-dev&lt;/a&gt;<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
