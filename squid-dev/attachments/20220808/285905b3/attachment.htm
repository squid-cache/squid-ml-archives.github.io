<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Moving&nbsp;this&nbsp;thread&nbsp;to&nbsp;the&nbsp;squid-dev&nbsp;list&nbsp;as&nbsp;the&nbsp;PR&nbsp;below&nbsp;has&nbsp;been&nbsp;opened&nbsp;to&nbsp;propose&nbsp;a&nbsp;fix&nbsp;to&nbsp;the&nbsp;ephemeral&nbsp;port&nbsp;exhaustion&nbsp;problem&nbsp;we&nbsp;had&nbsp;experienced&nbsp;with&nbsp;ver&nbsp;5.5. &lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/squid-cache/squid/pull/1115&quot;&gt;https://github.com/squid-cache/squid/pull/1115&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;to&nbsp;Alex&nbsp;and&nbsp;others&nbsp;for&nbsp;providing&nbsp;pointers&nbsp;in&nbsp;this&nbsp;regards.&nbsp;Apologies&nbsp;if&nbsp;I&nbsp;have&nbsp;missed&nbsp;out&nbsp;any&nbsp;requirements&nbsp;on&nbsp;the&nbsp;PR,&nbsp;please&nbsp;let&nbsp;me&nbsp;know&nbsp;and&nbsp;I&nbsp;can&nbsp;update&nbsp;as&nbsp;needed.&nbsp;The&nbsp;fix&nbsp;proposed is&nbsp;based&nbsp;on&nbsp;the&nbsp;post&nbsp;below&nbsp;from&nbsp;Cloudflare&nbsp;that&nbsp;had&nbsp;experienced&nbsp;this&nbsp;issue&nbsp;with&nbsp;their&nbsp;own&nbsp;applications. &lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://blog.cloudflare.com/how-to-stop-running-out-of-ephemeral-ports-and-start-to-love-long-lived-connections/&quot;&gt;https://blog.cloudflare.com/how-to-stop-running-out-of-ephemeral-ports-and-start-to-love-long-lived-connections/&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;were&nbsp;hitting&nbsp;the&nbsp;errors&nbsp;stated&nbsp;on&nbsp;the&nbsp;PR&nbsp;as&nbsp;soon&nbsp;as&nbsp;the&nbsp;system&nbsp;exhausted&nbsp;1x &lt;span&nbsp;style=&quot;color:rgb(36,41,47);font-family:-apple-system,&quot;system-ui&quot;,&quot;Segoe&nbsp;UI&quot;,Helvetica,Arial,sans-serif,&quot;Apple&nbsp;Color&nbsp;Emoji&quot;,&quot;Segoe&nbsp;UI&nbsp;Emoji&quot;;font-size:14px&quot;&gt;ip_local_port_range&nbsp;concurrent&nbsp;TCP&nbsp;sessions. &lt;/span&gt;With&nbsp;this&nbsp;fix,&nbsp;we&nbsp;have&nbsp;been&nbsp;able&nbsp;to&nbsp;scale&nbsp;well&nbsp;beyond&nbsp;that&nbsp;(&nbsp;&gt;&nbsp;100k&nbsp;concurrent&nbsp;outbound&nbsp;TCP&nbsp;sessions).&nbsp;This&nbsp;patch&nbsp;has&nbsp;been&nbsp;running&nbsp;in&nbsp;our&nbsp;production&nbsp;environment&nbsp;for&nbsp;close&nbsp;to&nbsp;2&nbsp;months&nbsp;without&nbsp;any&nbsp;new&nbsp;issues.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;you have&nbsp;any&nbsp;questions,&nbsp;and&nbsp;again&nbsp;apologize if&nbsp;I&nbsp;forgot&nbsp;to&nbsp;include&nbsp;something&nbsp;before&nbsp;or&nbsp;with&nbsp;the&nbsp;PR.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&lt;/div&gt;&lt;div&gt;Praveen&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;----------&nbsp;Forwarded&nbsp;message&nbsp;---------&lt;br&gt;From:&nbsp;&lt;strong&nbsp;class=&quot;gmail_sendername&quot;&nbsp;dir=&quot;auto&quot;&gt;Alex&nbsp;Rousskov&lt;/strong&gt;&nbsp;&lt;span&nbsp;dir=&quot;auto&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&lt;/span&gt;&lt;br&gt;Date:&nbsp;Tue,&nbsp;Jun&nbsp;21,&nbsp;2022&nbsp;at&nbsp;2:11&nbsp;PM&lt;br&gt;Subject:&nbsp;Re:&nbsp;[squid-users]&nbsp;Scaling&nbsp;concurrent&nbsp;TCP&nbsp;sessions&nbsp;beyond&nbsp;ephemeral&nbsp;port&nbsp;range&lt;br&gt;To:&nbsp;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;On&nbsp;6/19/22&nbsp;12:48,&nbsp;Praveen&nbsp;Ponakanti&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;is&nbsp;the&nbsp;process&nbsp;to&nbsp;have&nbsp;this&nbsp;code&nbsp;patch&nbsp;upstreamed&nbsp;for&nbsp;future&nbsp;squid&nbsp;&lt;br&gt;<br>
&gt;&nbsp;versions?&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;short,&nbsp;just&nbsp;post&nbsp;a&nbsp;quality&nbsp;pull&nbsp;request&nbsp;on&nbsp;GitHub&nbsp;(or&nbsp;find&nbsp;somebody&nbsp;&lt;br&gt;<br>
who&nbsp;can&nbsp;guide&nbsp;your&nbsp;code&nbsp;towards&nbsp;official&nbsp;acceptance&nbsp;for&nbsp;you).&nbsp;For&nbsp;&lt;br&gt;<br>
details,&nbsp;please&nbsp;see&nbsp;&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/MergeProcedure&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/MergeProcedure&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Thank&nbsp;you,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Fri,&nbsp;May&nbsp;20,&nbsp;2022&nbsp;at&nbsp;9:31&nbsp;PM&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; On&nbsp;20/05/22&nbsp;19:44,&nbsp;Praveen&nbsp;Ponakanti&nbsp;wrote:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;Hi&nbsp;Alex,&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;Thanks&nbsp;for&nbsp;going&nbsp;through&nbsp;several&nbsp;steps&nbsp;to&nbsp;help&nbsp;mitigate&nbsp;src&nbsp;port&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;exhaustion.&nbsp;We&nbsp;are&nbsp;looking&nbsp;to&nbsp;achieve&nbsp;400-500%&nbsp;more&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;concurrent connections&nbsp;if&nbsp;we&nbsp;could&nbsp;:)&nbsp;as&nbsp;there&nbsp;is&nbsp;a&lt;br&gt;<br>
&gt; &nbsp; &nbsp; significant buffer&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;on&nbsp;the&nbsp;available&nbsp;CPU.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Then&nbsp;you&nbsp;require&nbsp;at&nbsp;least&nbsp;4,&nbsp;maybe&nbsp;5,&nbsp;IP&nbsp;addresses&nbsp;to&nbsp;handle&nbsp;that&nbsp;many&lt;br&gt;<br>
&gt; &nbsp; &nbsp; concurrent&nbsp;connections&nbsp;with&nbsp;Squid.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;would&nbsp;like&nbsp;to&nbsp;investigate&nbsp;going&nbsp;beyond&nbsp;the&nbsp;ephemeral&nbsp;port&nbsp;range&nbsp;for&nbsp;&lt;br&gt;<br>
&gt;&nbsp;some&nbsp;specific&nbsp;destination&nbsp;IP:PORT&nbsp;addresses.&nbsp;For&nbsp;that&nbsp;it&nbsp;appears&nbsp;squid&nbsp;&lt;br&gt;<br>
&gt;&nbsp;does&nbsp;not&nbsp;round-robin&nbsp;requests&nbsp;if&nbsp;we&nbsp;use&nbsp;multiple&nbsp;tcp_outgoing_addresses.&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;could&nbsp;use&nbsp;ACL’s&nbsp;to&nbsp;pick&nbsp;a&nbsp;different&nbsp;outbound&nbsp;IP&nbsp;based&nbsp;on&nbsp;the&nbsp;clients&nbsp;&lt;br&gt;<br>
&gt;&nbsp;source&nbsp;IP,&nbsp;however&nbsp;that&nbsp;is&nbsp;not&nbsp;very&nbsp;ideal&nbsp;in&nbsp;our&nbsp;environment&nbsp;as&nbsp;our&nbsp;&lt;br&gt;<br>
&gt;&nbsp;clients&nbsp;aren’t&nbsp;always&nbsp;equally&nbsp;split&nbsp;by&nbsp;subnet.&nbsp;However,&nbsp;if&nbsp;we&nbsp;could&nbsp;&lt;br&gt;<br>
&gt;&nbsp;split&nbsp;by&nbsp;the&nbsp;client’s&nbsp;source&nbsp;port&nbsp;that&nbsp;might&nbsp;help&nbsp;achieve&nbsp;this.&nbsp;For&nbsp;&lt;br&gt;<br>
&gt;&nbsp;example&nbsp;something&nbsp;like:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;pool1&nbsp;clientport&nbsp;0-32768&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;pool2&nbsp;clientport&nbsp;32769-65536&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;tcp_outgoing_address&nbsp;10.1.0.1&nbsp;pool1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;tcp_outgoing_address&nbsp;10.1.0.2&nbsp;pool2&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Squid&#39;s&nbsp;ACLs&nbsp;currently&nbsp;do&nbsp;not&nbsp;allow&nbsp;filtering&nbsp;by&nbsp;the&nbsp;client&#39;s&nbsp;source&nbsp;&lt;br&gt;<br>
&gt;&nbsp;port.&nbsp;We&nbsp;could&nbsp;look&nbsp;into&nbsp;a&nbsp;separate&nbsp;patch&nbsp;to&nbsp;add&nbsp;this&nbsp;functionality&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;squid’s&nbsp;ACL&nbsp;code&nbsp;if&nbsp;that&nbsp;makes&nbsp;sense.&nbsp;Or&nbsp;is&nbsp;there&nbsp;a&nbsp;better&nbsp;way&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;achieve&nbsp;this?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Thanks&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Praveen&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;The&nbsp;option&nbsp;to&nbsp;use&nbsp;multiple&nbsp;tcp_outoing_addresses&nbsp;appears&nbsp;to&nbsp;be&lt;br&gt;<br>
&gt; &nbsp; &nbsp; promising&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;along&nbsp;with&nbsp;some&nbsp;tweaks&nbsp;to&nbsp;the&nbsp;TCP&nbsp;timeouts.&nbsp;I&nbsp;guess&nbsp;we&nbsp;could&nbsp;use&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ACLs&nbsp;to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;pick&nbsp;a&nbsp;different&nbsp;outbound&nbsp;IP&nbsp;based&nbsp;on&nbsp;the&nbsp;requesting&nbsp;client&#39;s&lt;br&gt;<br>
&gt; &nbsp; &nbsp; prefix.&nbsp;We&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;had&nbsp;not&nbsp;considered&nbsp;that&nbsp;option&nbsp;as&nbsp;the&nbsp;ephemeral&nbsp;ports&nbsp;were&nbsp;no&nbsp;longer&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;available to&nbsp;other&nbsp;applications&nbsp;when&nbsp;squid&nbsp;uses&nbsp;most&nbsp;of&nbsp;them&nbsp;with&nbsp;a&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;single&nbsp;outbound&nbsp;IP&nbsp;configured.&nbsp;We&nbsp;are&nbsp;also&nbsp;looking&nbsp;to&nbsp;modify&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; code&nbsp;to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;use&nbsp;the&nbsp;IP_BIND_ADDRESS_NO_PORT&nbsp;sockopt&nbsp;as&nbsp;that&nbsp;could&nbsp;help&nbsp;delay&lt;br&gt;<br>
&gt; &nbsp; &nbsp; port&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;assignment&nbsp;with&nbsp;the&nbsp;bind()&nbsp;call&nbsp;on&nbsp;the&nbsp;outbound&nbsp;TCP&nbsp;sessions&nbsp;(to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;hopefully&nbsp;allow&nbsp;access&nbsp;to&nbsp;the&nbsp;4-tuple&nbsp;on&nbsp;the&nbsp;socket).&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Patches&nbsp;welcome.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; However,&nbsp;please&nbsp;be&nbsp;aware&nbsp;that&nbsp;use&nbsp;of&nbsp;the&nbsp;4-tuple&nbsp;is&nbsp;often&nbsp;no&nbsp;different&lt;br&gt;<br>
&gt; &nbsp; &nbsp; from&nbsp;the&nbsp;3-tuple&nbsp;since&nbsp;the&nbsp;dst-port&nbsp;is&nbsp;typically&nbsp;identical&nbsp;for&nbsp;all&lt;br&gt;<br>
&gt; &nbsp; &nbsp; outgoing&nbsp;traffic&nbsp;to&nbsp;a&nbsp;given&nbsp;dst-IP.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Cheers&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Amos&lt;br&gt;<br>
&gt; &nbsp; &nbsp; _______________________________________________&lt;br&gt;<br>
&gt; &nbsp; &nbsp; squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;mailto:&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
