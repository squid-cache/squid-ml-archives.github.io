<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Hi&nbsp;all,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;We&nbsp;found&nbsp;a&nbsp;way&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;leak:&nbsp;set&nbsp;up&nbsp;squid&nbsp;to&nbsp;run&nbsp;in&nbsp;intercept&nbsp;mode +&nbsp;SSL&nbsp;description +&nbsp;memory&nbsp;pools&nbsp;off&nbsp;(to&nbsp;ease&nbsp;identifying&nbsp;the&nbsp;leak)&nbsp;and&nbsp;then&nbsp;generate&nbsp;requests&nbsp;to&nbsp;sites&nbsp;with&nbsp;invalid&nbsp;certs&nbsp;(eg,&nbsp;CA&nbsp;not&nbsp;installed),&nbsp;for&nbsp;instance: curl&nbsp;-k&nbsp;&lt;a&nbsp;href=&quot;https://slscr.update.microsoft.com&quot;&gt;https://slscr.update.microsoft.com&lt;/a&gt;.&nbsp;squidclient&nbsp;mgr:mem&nbsp;should&nbsp;show&nbsp;ever&nbsp;increasing&nbsp;HttpRequest&nbsp;instances.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;As&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;tell,&nbsp;the&nbsp;HttpRequest&nbsp;object&nbsp;created&nbsp;in ConnStateData::buildFakeRequest()&nbsp;is&nbsp;never&nbsp;freed&nbsp;because&nbsp;its&nbsp;refcount&nbsp;&gt;&nbsp;0.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Any&nbsp;ideas&nbsp;where&nbsp;an&nbsp;HTTPMSGUNLOCK()&nbsp;might&nbsp;be&nbsp;missing?&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Thanks!&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Wed,&nbsp;Jan&nbsp;18,&nbsp;2023&nbsp;at&nbsp;11:28 AM&nbsp;Hamilton&nbsp;Coutinho&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:hamilton.coutinho@gmail.com&quot;&gt;hamilton.coutinho@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Hi&nbsp;Alex,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Thanks&nbsp;for&nbsp;the&nbsp;prompt&nbsp;reply!&nbsp;Thanks&nbsp;also&nbsp;for&nbsp;the&nbsp;clarifications.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Agreed,&nbsp;I&nbsp;just&nbsp;realized&nbsp;the&nbsp;requests&nbsp;seem&nbsp;to&nbsp;be&nbsp;failing&nbsp;with Http::scServiceUnavailable,&nbsp;so&nbsp;my&nbsp;focus&nbsp;turned&nbsp;to Security::PeerConnector::sslCrtvdHandleReply()&nbsp;and&nbsp;friends.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Best.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Wed,&nbsp;Jan&nbsp;18,&nbsp;2023&nbsp;at&nbsp;11:11&nbsp;AM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;1/18/23&nbsp;13:46,&nbsp;Hamilton&nbsp;Coutinho&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;are&nbsp;observing&nbsp;what&nbsp;seems&nbsp;to&nbsp;be&nbsp;several&nbsp;objects&nbsp;leaking&nbsp;in&nbsp;the&nbsp;output&nbsp;&lt;br&gt;<br>
&gt;&nbsp;mgr:mem,&nbsp;to&nbsp;the&nbsp;tune&nbsp;of&nbsp;10s&nbsp;of&nbsp;1000s&nbsp;&lt;br&gt;<br>
&gt;&nbsp;of HttpRequest, HttpHeaderEntry, Comm::Connection, Security::ErrorDetail, cbdata&nbsp;PeekingPeerConnector&nbsp;(31),&nbsp;etc.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;dumped&nbsp;a&nbsp;core&nbsp;and&nbsp;managed&nbsp;to&nbsp;find&nbsp;some&nbsp;HttpRequest&nbsp;objects&nbsp;and&nbsp;they&nbsp;&lt;br&gt;<br>
&gt;&nbsp;all&nbsp;seem&nbsp;to&nbsp;have&nbsp;failed&nbsp;in&nbsp;the&nbsp;same&nbsp;way,&nbsp;with&nbsp;an&nbsp;ERR_SECURE_CONNECT_FAIL&nbsp;&lt;br&gt;<br>
&gt;&nbsp;category,&nbsp;for&nbsp;a&nbsp;site&nbsp;that&nbsp;has&nbsp;a&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;a&nbsp;CA&nbsp;authority&nbsp;not&nbsp;&lt;br&gt;<br>
&gt;&nbsp;available&nbsp;to&nbsp;squid.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;If&nbsp;I&nbsp;would&nbsp;guess,&nbsp;the&nbsp;origin&nbsp;of&nbsp;the&nbsp;problem&nbsp;might&nbsp;be&nbsp;in&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Ssl::PeekingPeerConnector::checkForPeekAndSpliceMatched():&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;if&nbsp;(finalAction&nbsp;==&nbsp;Ssl::bumpTerminate)&nbsp;{&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bail(new&nbsp;ErrorState(ERR_SECURE_CONNECT_FAIL,&nbsp;Http::scForbidden,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request.getRaw(),&nbsp;al));&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;clientConn-&gt;close();&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;clientConn&nbsp;=&nbsp;nullptr;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Wondering&nbsp;if&nbsp;assigning&nbsp;null&nbsp;to&nbsp;clientConn&nbsp;there&nbsp;would&nbsp;be&nbsp;premature.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
FWIW,&nbsp;that&nbsp;connection&nbsp;pointer&nbsp;reset&nbsp;itself&nbsp;looks&nbsp;OK&nbsp;to&nbsp;me.&nbsp;ConnStateData&nbsp;&lt;br&gt;<br>
and/or&nbsp;others&nbsp;should&nbsp;have&nbsp;a&nbsp;connection&nbsp;closure&nbsp;handler&nbsp;attached&nbsp;to&nbsp;the&nbsp;&lt;br&gt;<br>
clientConn&nbsp;descriptor.&nbsp;That&nbsp;handler&nbsp;should&nbsp;be&nbsp;notified&nbsp;by&nbsp;Comm&nbsp;and&nbsp;&lt;br&gt;<br>
initiate&nbsp;cleanup&nbsp;of&nbsp;the&nbsp;objects&nbsp;responsible&nbsp;for&nbsp;client-Squid&nbsp;communication.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;bail()&nbsp;call&nbsp;above&nbsp;should&nbsp;inform&nbsp;the&nbsp;requestor&nbsp;about&nbsp;the&nbsp;&lt;br&gt;<br>
error/termination&nbsp;and&nbsp;terminate&nbsp;this&nbsp;AsyncJob.&nbsp;That&nbsp;requestor&nbsp;should&nbsp;&lt;br&gt;<br>
then&nbsp;close&nbsp;the&nbsp;Squid-server&nbsp;connection&nbsp;and&nbsp;clean&nbsp;up&nbsp;associated&nbsp;state.&lt;br&gt;<br>
&lt;br&gt;<br>
While&nbsp;there&nbsp;may&nbsp;be&nbsp;bugs&nbsp;in&nbsp;those&nbsp;&quot;should...&quot;&nbsp;sequences,&nbsp;please&nbsp;note&nbsp;that&nbsp;&lt;br&gt;<br>
the&nbsp;pasted&nbsp;code&nbsp;is&nbsp;not&nbsp;related&nbsp;to&nbsp;handling&nbsp;of&nbsp;untrusted&nbsp;origin&nbsp;servers&nbsp;&lt;br&gt;<br>
(unless&nbsp;your&nbsp;ssl_bump&nbsp;rules&nbsp;specifically&nbsp;activate&nbsp;the&nbsp;terminate&nbsp;action&nbsp;&lt;br&gt;<br>
upon&nbsp;discovering&nbsp;such&nbsp;an&nbsp;origin&nbsp;server).&nbsp;The&nbsp;pasted&nbsp;code&nbsp;is&nbsp;reacting&nbsp;to&nbsp;&lt;br&gt;<br>
an&nbsp;&quot;ssl_bump&nbsp;terminate&quot;&nbsp;rule&nbsp;matching.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-dev&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-dev@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-dev&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Hamilton&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;gmail_signature_prefix&quot;&gt;--&nbsp;&lt;/span&gt;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Hamilton&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
