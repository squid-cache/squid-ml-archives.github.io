<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Hello&nbsp;all,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;We&nbsp;moved&nbsp;one&nbsp;step&nbsp;closer&nbsp;to&nbsp;the&nbsp;root&nbsp;cause.&nbsp;We&nbsp;bisected the&nbsp;code&nbsp;and&nbsp;found&nbsp;out&nbsp;that&nbsp;the&nbsp;commit&nbsp;that&nbsp;introduced&nbsp;the&nbsp;leak&nbsp;is:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;$&nbsp;git&nbsp;show&nbsp;--stat&nbsp; 800967afde7921eb22a2711c5a75b5cd9c9d7178&lt;br&gt;commit&nbsp;800967afde7921eb22a2711c5a75b5cd9c9d7178&nbsp;(HEAD)&lt;br&gt;Author:&nbsp;Christos&nbsp;Tsantilas&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:christos@chtsanti.net&quot;&gt;christos@chtsanti.net&lt;/a&gt;&gt;&lt;br&gt;Date:&nbsp; &nbsp;Mon&nbsp;Feb&nbsp;22&nbsp;21:15:32&nbsp;2021&nbsp;+0000&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;Handling&nbsp;missing&nbsp;issuer&nbsp;certificates&nbsp;for&nbsp;TLSv1.3&nbsp;(#766)&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;Prior&nbsp;to&nbsp;TLS&nbsp;v1.3&nbsp;Squid&nbsp;could&nbsp;detect&nbsp;and&nbsp;fetch&nbsp;missing&nbsp;intermediate&lt;br&gt; &nbsp; &nbsp;server&nbsp;certificates&nbsp;by&nbsp;parsing&nbsp;TLS&nbsp;ServerHello.&nbsp;TLS&nbsp;v1.3&nbsp;encrypts&nbsp;the&lt;br&gt; &nbsp; &nbsp;relevant&nbsp;part&nbsp;of&nbsp;the&nbsp;handshake,&nbsp;making&nbsp;such&nbsp;&quot;prefetch&quot;&nbsp;impossible.&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;Instead&nbsp;of&nbsp;looking&nbsp;for&nbsp;certificates&nbsp;in&nbsp;TLS&nbsp;ServerHello,&nbsp;Squid&nbsp;now&nbsp;waits&lt;br&gt; &nbsp; &nbsp;for&nbsp;the&nbsp;OpenSSL&nbsp;built-in&nbsp;certificate&nbsp;validation&nbsp;to&nbsp;fail&nbsp;with&nbsp;an&lt;br&gt; &nbsp; &nbsp;X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY&nbsp;error.&nbsp;Squid-supplied&lt;br&gt; &nbsp; &nbsp;verify_callback&nbsp;function&nbsp;tells&nbsp;OpenSSL&nbsp;to&nbsp;ignore&nbsp;that&nbsp;error.&nbsp;Squid&lt;br&gt; &nbsp; &nbsp;SSL_connect()-calling&nbsp;code&nbsp;detects&nbsp;that&nbsp;the&nbsp;error&nbsp;was&nbsp;ignored&nbsp;and,&nbsp;if&lt;br&gt; &nbsp; &nbsp;possible,&nbsp;fetches&nbsp;the&nbsp;missing&nbsp;certificates&nbsp;and&nbsp;orchestrates&nbsp;certificate&lt;br&gt; &nbsp; &nbsp;chain&nbsp;validation&nbsp;outside&nbsp;the&nbsp;SSL_connect()&nbsp;sequence.&nbsp;If&nbsp;that&nbsp;validation&lt;br&gt; &nbsp; &nbsp;is&nbsp;successful,&nbsp;Squid&nbsp;continues&nbsp;with&nbsp;SSL_connect().&nbsp;See&nbsp;comments&nbsp;inside&lt;br&gt; &nbsp; &nbsp;Security::PeerConnector::negotiate()&nbsp;for&nbsp;low-level&nbsp;details.&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;In&nbsp;some&nbsp;cases,&nbsp;OpenSSL&nbsp;is&nbsp;able&nbsp;to&nbsp;complete&nbsp;SSL_connect()&nbsp;with&nbsp;an&nbsp;ignored&lt;br&gt; &nbsp; &nbsp;X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY&nbsp;error.&nbsp;If&nbsp;Squid&nbsp;validation&lt;br&gt; &nbsp; &nbsp;fails&nbsp;afterwards,&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;is&nbsp;closed&nbsp;(before&nbsp;any&nbsp;payload&nbsp;is&lt;br&gt; &nbsp; &nbsp;exchanged).&nbsp;Ideally,&nbsp;the&nbsp;negotiation&nbsp;with&nbsp;an&nbsp;untrusted&nbsp;server&nbsp;should&nbsp;not&lt;br&gt; &nbsp; &nbsp;complete,&nbsp;but&nbsp;complexity&nbsp;BIO&nbsp;changes&nbsp;required&nbsp;to&nbsp;prevent&nbsp;such&nbsp;premature&lt;br&gt; &nbsp; &nbsp;completion&nbsp;is&nbsp;probably&nbsp;not&nbsp;worth&nbsp;reaching&nbsp;that&nbsp;ideal,&nbsp;especially&nbsp;since&lt;br&gt; &nbsp; &nbsp;all&nbsp;of&nbsp;this&nbsp;is&nbsp;just&nbsp;a&nbsp;workaround.&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;The&nbsp;long-term&nbsp;solution&nbsp;is&nbsp;adding&nbsp;SSL_ERROR_WANT_RETRY_VERIFY&nbsp;to&nbsp;OpenSSL,&lt;br&gt; &nbsp; &nbsp;giving&nbsp;an&nbsp;application&nbsp;a&nbsp;chance&nbsp;to&nbsp;download&nbsp;the&nbsp;missing&nbsp;certificates&lt;br&gt; &nbsp; &nbsp;during&nbsp;SSL_connect()&nbsp;negotiations.&nbsp;We&nbsp;assist&nbsp;OpenSSL&nbsp;team&nbsp;with&nbsp;that&lt;br&gt; &nbsp; &nbsp;change,&nbsp;but&nbsp;it&nbsp;will&nbsp;not&nbsp;be&nbsp;available&nbsp;at&nbsp;least&nbsp;until&nbsp;OpenSSL&nbsp;v3.0.&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;This&nbsp;description&nbsp;and&nbsp;changes&nbsp;are&nbsp;not&nbsp;specific&nbsp;to&nbsp;SslBump&nbsp;code&nbsp;paths.&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;This&nbsp;is&nbsp;a&nbsp;Measurement&nbsp;Factory&nbsp;project.&lt;br&gt;&lt;br&gt; acinclude/lib-checks.m4&nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;6&nbsp;++&lt;br&gt; compat/openssl.h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; 30&nbsp;+++++++++&lt;br&gt; src/security/Handshake.cc&nbsp; &nbsp; &nbsp;|&nbsp; 46&nbsp;--------------&lt;br&gt; src/security/Handshake.h&nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;5&nbsp;+-&lt;br&gt; src/security/Io.cc&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; 27&nbsp;++++++++&lt;br&gt; src/security/Io.h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; 14&nbsp;+++-&lt;br&gt; src/security/PeerConnector.cc&nbsp;|&nbsp;211&nbsp;++++++++++++++++++++++++++++++++++++++++++++-----------------&lt;br&gt; src/security/PeerConnector.h&nbsp; |&nbsp; 46&nbsp;++++++++++----&lt;br&gt; src/security/Session.h&nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;4&nbsp;++&lt;br&gt; src/ssl/bio.cc&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;7&nbsp;--&lt;br&gt; src/ssl/bio.h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;8&nbsp;---&lt;br&gt; src/ssl/gadgets.h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;1&nbsp;+&lt;br&gt; src/ssl/support.cc&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;355&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------&lt;br&gt; src/ssl/support.h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; 57&nbsp;+++++++++++++++--&lt;br&gt; src/tests/stub_libsecurity.cc&nbsp;|&nbsp; &nbsp;4&nbsp;+-&lt;br&gt; 15&nbsp;files&nbsp;changed,&nbsp;582&nbsp;insertions(+),&nbsp;239&nbsp;deletions(-)&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Thu,&nbsp;Mar&nbsp;23,&nbsp;2023&nbsp;at&nbsp;4:56 PM&nbsp;Hamilton&nbsp;Coutinho&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:hamilton.coutinho@gmail.com&quot;&gt;hamilton.coutinho@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Hi&nbsp;all,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;We&nbsp;found&nbsp;a&nbsp;way&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;leak:&nbsp;set&nbsp;up&nbsp;squid&nbsp;to&nbsp;run&nbsp;in&nbsp;intercept&nbsp;mode +&nbsp;SSL&nbsp;description +&nbsp;memory&nbsp;pools&nbsp;off&nbsp;(to&nbsp;ease&nbsp;identifying&nbsp;the&nbsp;leak)&nbsp;and&nbsp;then&nbsp;generate&nbsp;requests&nbsp;to&nbsp;sites&nbsp;with&nbsp;invalid&nbsp;certs&nbsp;(eg,&nbsp;CA&nbsp;not&nbsp;installed),&nbsp;for&nbsp;instance: curl&nbsp;-k&nbsp;&lt;a&nbsp;href=&quot;https://slscr.update.microsoft.com&quot;&nbsp;target=&quot;_blank&quot;&gt;https://slscr.update.microsoft.com&lt;/a&gt;.&nbsp;squidclient&nbsp;mgr:mem&nbsp;should&nbsp;show&nbsp;ever&nbsp;increasing&nbsp;HttpRequest&nbsp;instances.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;As&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;tell,&nbsp;the&nbsp;HttpRequest&nbsp;object&nbsp;created&nbsp;in ConnStateData::buildFakeRequest()&nbsp;is&nbsp;never&nbsp;freed&nbsp;because&nbsp;its&nbsp;refcount&nbsp;&gt;&nbsp;0.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Any&nbsp;ideas&nbsp;where&nbsp;an&nbsp;HTTPMSGUNLOCK()&nbsp;might&nbsp;be&nbsp;missing?&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Thanks!&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Wed,&nbsp;Jan&nbsp;18,&nbsp;2023&nbsp;at&nbsp;11:28 AM&nbsp;Hamilton&nbsp;Coutinho&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:hamilton.coutinho@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;hamilton.coutinho@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Hi&nbsp;Alex,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Thanks&nbsp;for&nbsp;the&nbsp;prompt&nbsp;reply!&nbsp;Thanks&nbsp;also&nbsp;for&nbsp;the&nbsp;clarifications.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Agreed,&nbsp;I&nbsp;just&nbsp;realized&nbsp;the&nbsp;requests&nbsp;seem&nbsp;to&nbsp;be&nbsp;failing&nbsp;with Http::scServiceUnavailable,&nbsp;so&nbsp;my&nbsp;focus&nbsp;turned&nbsp;to Security::PeerConnector::sslCrtvdHandleReply()&nbsp;and&nbsp;friends.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Best.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Wed,&nbsp;Jan&nbsp;18,&nbsp;2023&nbsp;at&nbsp;11:11&nbsp;AM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;1/18/23&nbsp;13:46,&nbsp;Hamilton&nbsp;Coutinho&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;are&nbsp;observing&nbsp;what&nbsp;seems&nbsp;to&nbsp;be&nbsp;several&nbsp;objects&nbsp;leaking&nbsp;in&nbsp;the&nbsp;output&nbsp;&lt;br&gt;<br>
&gt;&nbsp;mgr:mem,&nbsp;to&nbsp;the&nbsp;tune&nbsp;of&nbsp;10s&nbsp;of&nbsp;1000s&nbsp;&lt;br&gt;<br>
&gt;&nbsp;of HttpRequest, HttpHeaderEntry, Comm::Connection, Security::ErrorDetail, cbdata&nbsp;PeekingPeerConnector&nbsp;(31),&nbsp;etc.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;dumped&nbsp;a&nbsp;core&nbsp;and&nbsp;managed&nbsp;to&nbsp;find&nbsp;some&nbsp;HttpRequest&nbsp;objects&nbsp;and&nbsp;they&nbsp;&lt;br&gt;<br>
&gt;&nbsp;all&nbsp;seem&nbsp;to&nbsp;have&nbsp;failed&nbsp;in&nbsp;the&nbsp;same&nbsp;way,&nbsp;with&nbsp;an&nbsp;ERR_SECURE_CONNECT_FAIL&nbsp;&lt;br&gt;<br>
&gt;&nbsp;category,&nbsp;for&nbsp;a&nbsp;site&nbsp;that&nbsp;has&nbsp;a&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;a&nbsp;CA&nbsp;authority&nbsp;not&nbsp;&lt;br&gt;<br>
&gt;&nbsp;available&nbsp;to&nbsp;squid.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;If&nbsp;I&nbsp;would&nbsp;guess,&nbsp;the&nbsp;origin&nbsp;of&nbsp;the&nbsp;problem&nbsp;might&nbsp;be&nbsp;in&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Ssl::PeekingPeerConnector::checkForPeekAndSpliceMatched():&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;if&nbsp;(finalAction&nbsp;==&nbsp;Ssl::bumpTerminate)&nbsp;{&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bail(new&nbsp;ErrorState(ERR_SECURE_CONNECT_FAIL,&nbsp;Http::scForbidden,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request.getRaw(),&nbsp;al));&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;clientConn-&gt;close();&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;clientConn&nbsp;=&nbsp;nullptr;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Wondering&nbsp;if&nbsp;assigning&nbsp;null&nbsp;to&nbsp;clientConn&nbsp;there&nbsp;would&nbsp;be&nbsp;premature.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
FWIW,&nbsp;that&nbsp;connection&nbsp;pointer&nbsp;reset&nbsp;itself&nbsp;looks&nbsp;OK&nbsp;to&nbsp;me.&nbsp;ConnStateData&nbsp;&lt;br&gt;<br>
and/or&nbsp;others&nbsp;should&nbsp;have&nbsp;a&nbsp;connection&nbsp;closure&nbsp;handler&nbsp;attached&nbsp;to&nbsp;the&nbsp;&lt;br&gt;<br>
clientConn&nbsp;descriptor.&nbsp;That&nbsp;handler&nbsp;should&nbsp;be&nbsp;notified&nbsp;by&nbsp;Comm&nbsp;and&nbsp;&lt;br&gt;<br>
initiate&nbsp;cleanup&nbsp;of&nbsp;the&nbsp;objects&nbsp;responsible&nbsp;for&nbsp;client-Squid&nbsp;communication.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;bail()&nbsp;call&nbsp;above&nbsp;should&nbsp;inform&nbsp;the&nbsp;requestor&nbsp;about&nbsp;the&nbsp;&lt;br&gt;<br>
error/termination&nbsp;and&nbsp;terminate&nbsp;this&nbsp;AsyncJob.&nbsp;That&nbsp;requestor&nbsp;should&nbsp;&lt;br&gt;<br>
then&nbsp;close&nbsp;the&nbsp;Squid-server&nbsp;connection&nbsp;and&nbsp;clean&nbsp;up&nbsp;associated&nbsp;state.&lt;br&gt;<br>
&lt;br&gt;<br>
While&nbsp;there&nbsp;may&nbsp;be&nbsp;bugs&nbsp;in&nbsp;those&nbsp;&quot;should...&quot;&nbsp;sequences,&nbsp;please&nbsp;note&nbsp;that&nbsp;&lt;br&gt;<br>
the&nbsp;pasted&nbsp;code&nbsp;is&nbsp;not&nbsp;related&nbsp;to&nbsp;handling&nbsp;of&nbsp;untrusted&nbsp;origin&nbsp;servers&nbsp;&lt;br&gt;<br>
(unless&nbsp;your&nbsp;ssl_bump&nbsp;rules&nbsp;specifically&nbsp;activate&nbsp;the&nbsp;terminate&nbsp;action&nbsp;&lt;br&gt;<br>
upon&nbsp;discovering&nbsp;such&nbsp;an&nbsp;origin&nbsp;server).&nbsp;The&nbsp;pasted&nbsp;code&nbsp;is&nbsp;reacting&nbsp;to&nbsp;&lt;br&gt;<br>
an&nbsp;&quot;ssl_bump&nbsp;terminate&quot;&nbsp;rule&nbsp;matching.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-dev&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-dev@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-dev@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-dev&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-dev&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Hamilton&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&gt;--&nbsp;&lt;/span&gt;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Hamilton&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;gmail_signature_prefix&quot;&gt;--&nbsp;&lt;/span&gt;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;Hamilton&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
