<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202.7.STABLE9%20%26%20Error%20with%20option%20deny_info%20from%0A%20local%20requests&In-Reply-To=%3C547C359A.604%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000985.html">
   <LINK REL="Next"  HREF="001003.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202.7.STABLE9%20%26%20Error%20with%20option%20deny_info%20from%0A%20local%20requests&In-Reply-To=%3C547C359A.604%40treenet.co.nz%3E"
       TITLE="[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec  1 09:32:10 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000985.html">[squid-users] Squid 3.4.9 RPM release
</A></li>
        <LI>Next message (by thread): <A HREF="001003.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#982">[ date ]</a>
              <a href="thread.html#982">[ thread ]</a>
              <a href="subject.html#982">[ subject ]</a>
              <a href="author.html#982">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 29/11/2014 2:40 a.m., Mark Riede wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have a strange behavior with Squid 2.7.STABLE9 and local
</I>&gt;<i> requests which should be intercept by the option deny_info.
</I>&gt;<i> 
</I>
1) *Please* upgrade your Squid. 2.7 has been unsupported for more than 5
years now and is seriously out of date with modern web traffic needs.

2) &quot;intercept&quot; and how deny_info works are completely unrelated concepts.


&gt;<i> I am using Squid as a reverse proxy. I have configured a list of 
</I>&gt;<i> subdomains (i.e. subdomain.domain.tld) in a file via the option 
</I>&gt;<i> dstdomain, which will be forwarded to the defined cache peer.
</I>&gt;<i> There is an additional list of domains (i.e. *.domain.tld) which
</I>&gt;<i> match via wildcard to all other domains, which are not absolutely
</I>&gt;<i> defined yet and will be forwarded to a custom error page via the
</I>&gt;<i> option deny_info.
</I>&gt;<i> 
</I>&gt;<i> The problem is that requests forwarded to the ip of the server,
</I>&gt;<i> i.e. 192.168.0.1, will be catched up by the option deny_info. But,
</I>&gt;<i> when the request is forwarded to the ip of the localhost
</I>&gt;<i> (127.0.0.1), the option deny_info will not match.
</I>
?? *all* traffic to the cache_peer is &quot;forwarded to the ip 127.0.0.1&quot;
since that IP *is* the cache_peer's IP.


127.0.0.1 (and ::1) are special purpose IP addresses. Traffic is not
permitted to go to/from it from a global-scope IP address. When you
send to/from a localhost IP then it is mandatory for the TCP system to
use the localhost IP as source.


&gt;<i> Now the strange behaviour is that requests to the ip of the
</I>&gt;<i> localhost but with the destination domain subdomain.domain.tld will
</I>&gt;<i> be answered successfully. I need a fix because clients get the
</I>&gt;<i> custom error page for requests via http (NAT to 192.168.0.1) but
</I>&gt;<i> not the same response via https (nginx to 127.0.0.1). I don&#180;t know
</I>&gt;<i> where or how I can fix this problem or do more debugging.
</I>

Why is nginx not forwarding proper HTTP messages with the relevant
Host: header contents to Squid? the HTTP message syntax is no
different when sent over TLS port 443 as when sent over TCP port 80.

- From your description it sounds like nginx is sending to Squid
messages with URL <A HREF="https://127.0.0.1/*">https://127.0.0.1/*</A> which cannot be expected to
exist in your list of acceptible domains.


Also, why are you not using Squid to receive and direct both HTTP and
HTTPS traffic to the relevant servers?
 Squid accepts port 443 traffic with an https_port directive just fine.


&gt;<i> 
</I>&gt;<i> # Config http_access allow localhost
</I>
The above rule permits all traffic from 127.0.0.1 to go through this
proxy *no matter what*. From your description that would be all
traffic arriving from nginx **AND** any traffic you direct at
127.0.0.1 IP from any other software.

It is a very bad thing to do, particularly for a reverse-proxy. Remove
it and traffic from nginx (and yoru 127.0.0.1 tests) will start to
obey the other rules. Not a complete fix, but required for Squid to
work as you expect.

&gt;<i> acl foo dstdomain &quot;/file&quot; acl foo_deny dstdom_regex &quot;/ file _deny&quot; 
</I>&gt;<i> http_access allow foo
</I>
When testing this ACL with a raw-IP Squid will lookup reverse-DNS of
the IPand compare the result with contents of /file.
Meaning 127.0.0.1 == &quot;localhost&quot; --&gt; is &quot;localhost&quot; one of the peer
hosted domain names? should not be.

&gt;<i> cache_peer 127.0.0.1 parent 8080 0 no-query originserver name=srv1
</I>login=PASS
&gt;<i> cache_peer_access srv1 allow foo cache_peer_access srv1 deny all 
</I>&gt;<i> deny_info ERR_FOO foo_deny http_access deny foo_deny http_access
</I>&gt;<i> deny all
</I>&lt;snip&gt;

The rest of these rules match your intended behaviour of Squid.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUfDWaAAoJELJo5wb/XPRjfEYH/1KMTu400wRO0wmz6RURlUwB
6jVEqWGc+rYV1hvtjZe5PtvJW8nMxF6idP0SU2aj/GWoGmcusrq413sAsoQhwEYT
lGAlDhU08c6aQ5r7ZyNY9TMNip8OJS6NPYEWV07Nw34QuJcQXbHUEC9VTAjboQqa
VYfnrBZIbMXFY3wkdhGkyNm4m/Uz5scOZ2lKAVabhZ4wHEu/NVMYISD3mEIHNiT7
rLT9/dqZaj/KHn1Vb5Z31k3szija9ZMh2Gu6A5tg3TfpelBVrbCXFOzoHIJMN7es
eRScL64c2KZ1PMpTMrTUzq1ILcOIuXcVDSdcj610Tcp524u0ssQ1vteJqj8kFak=
=8Dhf
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000985.html">[squid-users] Squid 3.4.9 RPM release
</A></li>
	<LI>Next message (by thread): <A HREF="001003.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#982">[ date ]</a>
              <a href="thread.html#982">[ thread ]</a>
              <a href="subject.html#982">[ subject ]</a>
              <a href="author.html#982">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
