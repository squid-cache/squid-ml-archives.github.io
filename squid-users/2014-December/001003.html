<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202.7.STABLE9%20%26%20Error%20with%20option%20deny_info%20from%0A%20local%20requests&In-Reply-To=%3C166D4EE577088449BA7DD4367005D8642E1D10E1%40s015011.office.babiel.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000982.html">
   <LINK REL="Next"  HREF="001005.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests</H1>
    <B>Mark Riede</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202.7.STABLE9%20%26%20Error%20with%20option%20deny_info%20from%0A%20local%20requests&In-Reply-To=%3C166D4EE577088449BA7DD4367005D8642E1D10E1%40s015011.office.babiel.com%3E"
       TITLE="[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests">m.riede at babiel.com
       </A><BR>
    <I>Wed Dec  3 14:49:34 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000982.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
        <LI>Next message (by thread): <A HREF="001005.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1003">[ date ]</a>
              <a href="thread.html#1003">[ thread ]</a>
              <a href="subject.html#1003">[ subject ]</a>
              <a href="author.html#1003">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 29/11/2014 2:40 a.m., Mark Riede wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I have a strange behavior with Squid 2.7.STABLE9 and local requests 
</I>&gt;<i> &gt; which should be intercept by the option deny_info.
</I>&gt;<i> &gt; 
</I>
&gt;<i> 1) *Please* upgrade your Squid. 2.7 has been unsupported for more than 5 years now and is seriously out of date with modern web traffic needs.
</I>That is not an option. We are already migrating to an other software.

&gt;<i> 2) &quot;intercept&quot; and how deny_info works are completely unrelated concepts.
</I>&quot;intercept&quot; was the wrong word. The word &quot;match&quot; ist more appropiate.

&gt;<i> &gt; I am using Squid as a reverse proxy. I have configured a list of 
</I>&gt;<i> &gt; subdomains (i.e. subdomain.domain.tld) in a file via the option 
</I>&gt;<i> &gt; dstdomain, which will be forwarded to the defined cache peer.
</I>&gt;<i> &gt; There is an additional list of domains (i.e. *.domain.tld) which match 
</I>&gt;<i> &gt; via wildcard to all other domains, which are not absolutely defined 
</I>&gt;<i> &gt; yet and will be forwarded to a custom error page via the option 
</I>&gt;<i> &gt; deny_info.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The problem is that requests forwarded to the ip of the server, i.e. 
</I>&gt;<i> &gt; 192.168.0.1, will be catched up by the option deny_info. But, when the 
</I>&gt;<i> &gt; request is forwarded to the ip of the localhost (127.0.0.1), the 
</I>&gt;<i> &gt; option deny_info will not match.
</I>
&gt;<i> ?? *all* traffic to the cache_peer is &quot;forwarded to the ip 127.0.0.1&quot;
</I>&gt;<i> since that IP *is* the cache_peer's IP.
</I>Ok, I think it needs a little bit more explanation.
External requests will be forwarded via nat to internal IP 192.168.0.1 and the option deny_info works well.
But when the nginx sends a request to the squid with the destination IP 127.0.0.1 the option deny_info does not work.

&gt;<i> 127.0.0.1 (and ::1) are special purpose IP addresses. Traffic is not permitted to go to/from it from a global-scope IP address. When you send to/from a localhost IP then it is mandatory for the TCP system to use the localhost IP as source.
</I>

&gt;<i> &gt; Now the strange behaviour is that requests to the ip of the localhost 
</I>&gt;<i> &gt; but with the destination domain subdomain.domain.tld will be answered 
</I>&gt;<i> &gt; successfully. I need a fix because clients get the custom error page 
</I>&gt;<i> &gt; for requests via http (NAT to 192.168.0.1) but not the same response 
</I>&gt;<i> &gt; via https (nginx to 127.0.0.1). I don&#180;t know where or how I can fix 
</I>&gt;<i> &gt; this problem or do more debugging.
</I>

&gt;<i> Why is nginx not forwarding proper HTTP messages with the relevant
</I>&gt;<i> Host: header contents to Squid? the HTTP message syntax is no different when sent over TLS port 443 as when sent over TCP port 80.
</I>Nginx is forwarding the request with a proper HTTP-Header because the option cache_peer is working well. We are able to cache HTTPS-Requests so far.
It seems that the option deny_info does not work well. 

&gt;<i> - From your description it sounds like nginx is sending to Squid messages with URL <A HREF="https://127.0.0.1/*">https://127.0.0.1/*</A> which cannot be expected to exist in your list of acceptible domains.
</I>
&gt;<i> Also, why are you not using Squid to receive and direct both HTTP and HTTPS traffic to the relevant servers?
</I>&gt;<i>  Squid accepts port 443 traffic with an https_port directive just fine.
</I>Because we are using the Squid for multiple clients and Squid in our version ist not able to handle multiple certificates.

&gt;<i> &gt; 
</I>&gt;<i> &gt; # Config http_access allow localhost
</I>
&gt;<i> The above rule permits all traffic from 127.0.0.1 to go through this proxy *no matter what*. From your description that would be all traffic arriving from nginx **AND** any traffic you direct at
</I>&gt;<i> 127.0.0.1 IP from any other software.
</I>Thank you for your consideration. I will consider it.

&gt;<i> It is a very bad thing to do, particularly for a reverse-proxy. Remove it and traffic from nginx (and yoru 127.0.0.1 tests) will start to obey the other rules. Not a complete fix, but required for Squid to work as you expect.
</I>
&gt;<i> &gt; acl foo dstdomain &quot;/file&quot; acl foo_deny dstdom_regex &quot;/ file _deny&quot; 
</I>&gt;<i> &gt; http_access allow foo
</I>
&gt;<i> When testing this ACL with a raw-IP Squid will lookup reverse-DNS of the IPand compare the result with contents of /file.
</I>&gt;<i> Meaning 127.0.0.1 == &quot;localhost&quot; --&gt; is &quot;localhost&quot; one of the peer hosted domain names? should not be.
</I>Which version was in use?
Is it possible to override this behaviour?
I don&#180;t think it is the right location of the problem. Everything works well except the option deny_info.

&gt;<i> &gt; cache_peer 127.0.0.1 parent 8080 0 no-query originserver name=srv1
</I>&gt;<i> login=PASS
</I>&gt;<i> &gt; cache_peer_access srv1 allow foo cache_peer_access srv1 deny all 
</I>&gt;<i> &gt; deny_info ERR_FOO foo_deny http_access deny foo_deny http_access deny 
</I>&gt;<i> &gt; all
</I>&gt;<i> &lt;snip&gt;
</I>
&gt;<i> The rest of these rules match your intended behaviour of Squid.
</I>
&gt;<i> Amos
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2.0.22 (MingW32)
</I>
&gt;<i> iQEcBAEBAgAGBQJUfDWaAAoJELJo5wb/XPRjfEYH/1KMTu400wRO0wmz6RURlUwB
</I>&gt;<i> 6jVEqWGc+rYV1hvtjZe5PtvJW8nMxF6idP0SU2aj/GWoGmcusrq413sAsoQhwEYT
</I>&gt;<i> lGAlDhU08c6aQ5r7ZyNY9TMNip8OJS6NPYEWV07Nw34QuJcQXbHUEC9VTAjboQqa
</I>&gt;<i> VYfnrBZIbMXFY3wkdhGkyNm4m/Uz5scOZ2lKAVabhZ4wHEu/NVMYISD3mEIHNiT7
</I>&gt;<i> rLT9/dqZaj/KHn1Vb5Z31k3szija9ZMh2Gu6A5tg3TfpelBVrbCXFOzoHIJMN7es
</I>&gt;<i> eRScL64c2KZ1PMpTMrTUzq1ILcOIuXcVDSdcj610Tcp524u0ssQ1vteJqj8kFak=
</I>&gt;<i> =8Dhf
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000982.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
	<LI>Next message (by thread): <A HREF="001005.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1003">[ date ]</a>
              <a href="thread.html#1003">[ thread ]</a>
              <a href="subject.html#1003">[ subject ]</a>
              <a href="author.html#1003">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
