<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202.7.STABLE9%20%26%20Error%20with%20option%20deny_info%20from%0A%20local%20requests&In-Reply-To=%3C166D4EE577088449BA7DD4367005D8642E1D39A2%40s015011.office.babiel.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001005.html">
   <LINK REL="Next"  HREF="000983.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests</H1>
    <B>Mark Riede</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202.7.STABLE9%20%26%20Error%20with%20option%20deny_info%20from%0A%20local%20requests&In-Reply-To=%3C166D4EE577088449BA7DD4367005D8642E1D39A2%40s015011.office.babiel.com%3E"
       TITLE="[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests">m.riede at babiel.com
       </A><BR>
    <I>Thu Dec  4 12:55:42 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001005.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
        <LI>Next message (by thread): <A HREF="000983.html">[squid-users] Best way to deny access to URLs in Squid 3.3.x?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1008">[ date ]</a>
              <a href="thread.html#1008">[ thread ]</a>
              <a href="subject.html#1008">[ subject ]</a>
              <a href="author.html#1008">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>That was the fix. I&#180;ve removed the line ' http_access allow localhost'.
Thank you.

-----Urspr&#252;ngliche Nachricht-----
Von: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>] 
Gesendet: Mittwoch, 3. Dezember 2014 16:39
An: Mark Riede; '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>'
Betreff: Re: AW: [squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 4/12/2014 3:49 a.m., Mark Riede wrote:
&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> # Config http_access allow localhost
</I>&gt;<i> 
</I>&gt;&gt;<i> The above rule permits all traffic from 127.0.0.1 to go through this 
</I>&gt;&gt;<i> proxy *no matter what*. From your description that would be all 
</I>&gt;&gt;<i> traffic arriving from nginx **AND** any traffic you direct at 
</I>&gt;&gt;<i> 127.0.0.1 IP from any other software.
</I>&gt;<i> Thank you for your consideration. I will consider it.
</I>&gt;<i> 
</I>&gt;&gt;<i> It is a very bad thing to do, particularly for a reverse-proxy.
</I>&gt;&gt;<i> Remove it and traffic from nginx (and yoru 127.0.0.1 tests) will 
</I>&gt;&gt;<i> start to obey the other rules. Not a complete fix, but required for 
</I>&gt;&gt;<i> Squid to work as you expect.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> acl foo dstdomain &quot;/file&quot; acl foo_deny dstdom_regex &quot;/ file _deny&quot; 
</I>&gt;&gt;&gt;<i> http_access allow foo
</I>&gt;<i> 
</I>&gt;&gt;<i> When testing this ACL with a raw-IP Squid will lookup reverse-DNS of 
</I>&gt;&gt;<i> the IPand compare the result with contents of /file. Meaning
</I>&gt;&gt;<i> 127.0.0.1 == &quot;localhost&quot; --&gt; is &quot;localhost&quot; one of the peer hosted 
</I>&gt;&gt;<i> domain names? should not be.
</I>&gt;<i> Which version was in use? Is it possible to override this behaviour?
</I>
Only after an upgrade to a current Squid-3 version for the DNS no-lookup feature.

You do not actually need the &quot;http_access allow localhost&quot; line at all though. All it seems to be doing is causing this problem.

If you were perhapse relying on it for access to the Squid cachemgr reports, then replace it with this:
  acl mgr url_regex -i ^cache_<A HREF="object://">object://</A>
  http_access allow localhost mgr


&gt;<i> I don&#180;t think it is the right location of the problem. Everything 
</I>&gt;<i> works well except the option deny_info.
</I>
The &quot;deny_info ... foo_deny&quot; is just an instruction/directive on the &quot;foo_deny&quot; ACL to what will happen IF (and only IF) foo_deny is used in http_access to deny a request.

If the either of the previous http_access allow lines are being acted on then it will not happen.

&quot;allow localhost&quot; will act on 127.0.0.1/localhost nginx requests in your config. Causing the foo_deny never to be enacted. Causing the deny_info to not happen. See?


Assuming Nginx is presenting Squid with correct Host headers then removing the &quot;http_access allow localhost&quot; is all you need to fix the deny_info problem.

After changing that you may still see some *other* errors with traffic from Nginx. For those you will need to investigate the Host header in those requests and decide what is the right thing to be done to fix that other problem.

HTH
Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUfy59AAoJELJo5wb/XPRjGzwIANhBfDa56/sjgMvx2mlvUasV
Oet0PGyFfdCkaY+cKcFIxERWUnAripXhK0JdasQ7795uOZRMIKbTVYy6mKF8/EoN
HsIkW6VaKJ3x15E1kebKSIqANcpcWl0nX6SrswODJGRG561QcXdSZ+k1NwOOPWpv
YbBKRcVs5WhW+AaRh+e9bLU/K152PVyY44A6/sY7MavhmMc91EIxgrw77v3tUIus
HIm4Lidr6D868iRqnimVu7TRCZnHwCWInYv0sy7gFQU5/EEh6nOrWRceJ9MYHU2k
bFjh4t+ixGBcYv0NwnXVOaC1mise/VoCitjWmZ9zbooQby/d7B3mooIpDJXF8uE=
=RwXb
-----END PGP SIGNATURE-----
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001005.html">[squid-users] 2.7.STABLE9 &amp; Error with option deny_info from local requests
</A></li>
	<LI>Next message (by thread): <A HREF="000983.html">[squid-users] Best way to deny access to URLs in Squid 3.3.x?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1008">[ date ]</a>
              <a href="thread.html#1008">[ thread ]</a>
              <a href="subject.html#1008">[ subject ]</a>
              <a href="author.html#1008">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
