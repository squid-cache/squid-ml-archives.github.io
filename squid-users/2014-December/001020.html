<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.3.8 NTLM Group Authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.3.8%20NTLM%20Group%20Authentication&In-Reply-To=%3C5481B26F.1090204%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001019.html">
   <LINK REL="Next"  HREF="001021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.3.8 NTLM Group Authentication</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.3.8%20NTLM%20Group%20Authentication&In-Reply-To=%3C5481B26F.1090204%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.3.8 NTLM Group Authentication">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec  5 13:26:07 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001019.html">[squid-users] Squid 3.3.8 NTLM Group Authentication
</A></li>
        <LI>Next message (by thread): <A HREF="001021.html">[squid-users] Packet Marking for Traffic Shaping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1020">[ date ]</a>
              <a href="thread.html#1020">[ thread ]</a>
              <a href="subject.html#1020">[ subject ]</a>
              <a href="author.html#1020">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 6/12/2014 12:55 a.m., Rich549 wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm having problems getting NTLM authentication to work.  I need it
</I>&gt;<i> to only allow members of the Internet_Users AD group to be able to
</I>&gt;<i> access the internet.  Instead it is only allowing the websites that
</I>&gt;<i> I've marked as OK for all users (a lot of this config came from my
</I>&gt;<i> SquidNT installation).
</I>&gt;<i> 
</I>&gt;<i> My config is as follows:
</I>&gt;<i> 
</I>&gt;<i> ##	WELCOME TO SQUID 3.3.8 #	----------------------------
</I>&gt;<i> 
</I>&gt;<i> #-----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I>#DEFAULTS
&gt;<i> #-----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I>http_port 3128

&gt;<i> hierarchy_stoplist cgi-bin ? acl QUERY urlpath_regex cgi-bin \? 
</I>&gt;<i> cache deny QUERY
</I>
The above QUERY and hierarchy_stoplist actions are not much use in
recent Squid versions. There is a refresh_pattern (mentioned below)
that replaces them.

&gt;<i> acl apache rep_header Server ^Apache cache_mem 1024 MB
</I>&gt;<i> 
</I>&gt;<i> #-----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I># AUTHENTICATION
&gt;<i> #-----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I>#
&gt;<i> # ### negotiate kerberos and ntlm authentication #auth_param
</I>&gt;<i> negotiate program /usr/local/bin/negotiate_wrapper -d --ntlm 
</I>&gt;<i> /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=DOMAIN --kerberos
</I>&gt;<i> /usr/lib/squid3/negotiate_kerberos_auth -d -s GSS_C_NO_NAME
</I>&gt;<i> domain=HAMMONDS --kerberos /usr/lib/squid3/negotiate_kerberos_auth
</I>&gt;<i> srvham09.domain.com #auth_param negotiate children 10 #auth_param
</I>&gt;<i> negotiate keep_alive off
</I>&gt;<i> 
</I>&gt;<i> ### pure ntlm authentication auth_param ntlm program
</I>&gt;<i> /usr/bin/ntlm_auth --diagnostics 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=HAMMONDS auth_param
</I>&gt;<i> ntlm children 10 auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> ### provide basic authentication via ldap for clients not
</I>&gt;<i> authenticated via kerberos/ntlm #auth_param basic program
</I>&gt;<i> /usr/lib/squid3/basic_ldap_auth -b &quot;dc=domain,dc=com&quot; -D
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at domain.com</A> -W /etc/squid3/ldappass.txt -f sAMAccountName=%s
</I>&gt;<i> -h srvham09.domain.com #auth_param basic children 10 #auth_param
</I>&gt;<i> basic realm Internet Proxy #auth_param basic credentialsttl 1
</I>&gt;<i> minute
</I>&gt;<i> 
</I>&gt;<i> ### acl for proxy auth and ldap authorizations acl auth proxy_auth
</I>&gt;<i> REQUIRED #acl localnet src 172.31.0.0/16
</I>&gt;<i> 
</I>&gt;<i> ### set helper processes external_acl_type internet_domain_group
</I>&gt;<i> %LOGIN /usr/lib/squid3/ext_ldap_group_acl -b
</I>&gt;<i> &quot;ou=Service_Accounts,dc=domain,dc=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at domain.com</A> -W
</I>&gt;<i> /etc/squid3/ldappass.txt -f 
</I>&gt;<i> &quot;cn=Internet_Users,ou=Domain_Groups,dn=domain,dn=com&quot;
</I>&gt;<i> srvham09.domain.com
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #-------------------------------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I>### Allow authenticated users
&gt;<i> #-------------------------------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I>acl InetAllow external internet_domain_group Internet_Users
&gt;<i> 
</I>&gt;<i> #-------------------------------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> 
</I>### Bypass Authentication
&gt;<i> #-------------------------------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>  # These domains will be reachable without authentication acl
</I>&gt;<i> OK_Unauthenticated dstdomain .domain.com .force24.co.uk
</I>&gt;<i> .trakit.uk.net 194.73.60.21 .stanford.edu 171.65.103.68
</I>&gt;<i> 212.100.232.212 acl OK_Unauthenticated dstdomain .canonical.com
</I>&gt;<i> .sophos.com .ubuntu.com .oracle.com .bt.com .refreshthis.com acl
</I>&gt;<i> OK_Unauthenticated dstdomain .oanda.com .dell.com .launchpad.net 
</I>&gt;<i> acl OK_Unauthenticated dstdomain .dashboards.my-tmac.co.uk
</I>&gt;<i> 
</I>&gt;<i> #Squid Access Denied Screen acl OK_Unauthenticated dstdomain
</I>&gt;<i> .squid-cache.org
</I>&gt;<i> 
</I>&gt;<i> # ------------------------------------------------ # ------
</I>&gt;<i> Permit/Deny access as appropriate ------- #
</I>&gt;<i> ------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> http_access allow OK_Unauthenticated http_access allow InetAllow
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080 refresh_pattern ^gopher:	1440
</I>&gt;<i> 0%	1440
</I>
Missing pattern:
  refresh_pattern -i (/cgi-bin/|\?) 0 0% 0

&gt;<i> refresh_pattern .		0	20%	4320 shutdown_lifetime 10 seconds acl all
</I>&gt;<i> src 0.0.0.0/0.0.0.0 acl localhost src 127.0.0.1/255.255.255.255 acl
</I>&gt;<i> to_localhost dst 127.0.0.0/8
</I>
You are likely getting startup warnings about the above ACL
definitions. ACLs all, manager, localhost, and to_localhost are
predefined in your Squid version. Remove the above lines from your config.


&gt;<i> acl SSL_ports port 443 563 acl Safe_ports port 80		# http acl
</I>&gt;<i> Safe_ports port 21		# ftp acl Safe_ports port 443 563	# https,
</I>&gt;<i> snews acl Safe_ports port 70		# gopher acl Safe_ports port 210		#
</I>&gt;<i> wais acl Safe_ports port 1025-65535	# unregistered ports acl
</I>&gt;<i> Safe_ports port 280		# http-mgmt acl Safe_ports port 488		#
</I>&gt;<i> gss-http acl Safe_ports port 591		# filemaker acl Safe_ports port
</I>&gt;<i> 777		# multiling http acl Safe_ports port 4004	# Radii website
</I>&gt;<i> download site uses this port acl Safe_ports port 10000	# Webmin
</I>
The above two ports are included in the range 1024-65535 (unregistered
ports). No need to add them specially.

&gt;<i> acl Safe_ports port 900		# Swat acl Safe_ports port 82		# Pacejet
</I>&gt;<i> request - test site hosted on HTTP 82 acl Safe_ports port 81		#
</I>&gt;<i> Image plus test server (hepplewhite) acl CONNECT method CONNECT 
</I>&gt;<i> http_access allow manager localhost http_access deny manager 
</I>&gt;<i> http_access deny !Safe_ports http_access deny CONNECT !SSL_ports 
</I>&gt;<i> http_access deny all http_reply_access allow all icp_access allow
</I>&gt;<i> all cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">otrs at domain.com</A> forwarded_for off
</I>&gt;<i> 
</I>&gt;<i> When I try to browse to any of the whitelisted websites the
</I>&gt;<i> cache.log shows an NTLM process starting so it looks like it's
</I>&gt;<i> making sure that I'm an authenticated user but isn't controlling my
</I>&gt;<i> access correctly.
</I>
It should not be doing anything with NTLM  when you request the
whitelisted domains or raw-IP addresses.

* With your config it should start the helper processes right at teh
beginning when you start Squid, or if some of them die unexpectedly
early they should be restarted on a following login.

* Squid should do some lookups via the already running helpers only
when non-whiteisted domains are requested.


IIRC there was an issue with login when external ACL was the first ACL
to be tested. Try using a &quot;http_access deny !auth&quot; after the whitelist
and before the group check.
Like so:

  http_access allow OK_Unauthenticated
  http_access deny !auth
  http_access allow InetAllow


HTH
Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUgbJvAAoJELJo5wb/XPRjNRAIAMp1eqekS+RxJrl0+ewg9jEH
CXONklru2cAvTA5pKkZtUE/NDLgRVyZAPE0P4/UYQumgXFPyeIfHnTOxUYaPiMVt
yD/ITGs8p8/BnsE9DGEbUJ0AS4Dex+PjLxfuCwoEFc2SVX3EqxfyWJIuwNJJFo3E
pDhqoa8+LpsbJvJNeV21IWB6D51fq4RW0rsLQW+mA/xLFD2bFdYdAO/hknTXSq/w
wTdLACc3+gDoyfEDd48p8Bi1tO+bAu8xsWVGtDPNKIz0KOCp81mexweqtYHuKINC
EVrVXb2lLdtc/QqM+XCUC5coB8n1FT26+npd3QJRHZuisNRyspA3g3ibeARl2+w=
=lPSb
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001019.html">[squid-users] Squid 3.3.8 NTLM Group Authentication
</A></li>
	<LI>Next message (by thread): <A HREF="001021.html">[squid-users] Packet Marking for Traffic Shaping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1020">[ date ]</a>
              <a href="thread.html#1020">[ thread ]</a>
              <a href="subject.html#1020">[ subject ]</a>
              <a href="author.html#1020">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
