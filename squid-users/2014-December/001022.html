<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3CE6B2517F8D6DBF4CABB8F38ACA367E783435DD36%40Draco.dawnsign.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000993.html">
   <LINK REL="Next"  HREF="001024.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64</H1>
    <B>Doug Sampson</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3CE6B2517F8D6DBF4CABB8F38ACA367E783435DD36%40Draco.dawnsign.com%3E"
       TITLE="[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64">dougs at dawnsign.com
       </A><BR>
    <I>Fri Dec  5 22:17:08 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000993.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
        <LI>Next message (by thread): <A HREF="001024.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1022">[ date ]</a>
              <a href="thread.html#1022">[ thread ]</a>
              <a href="subject.html#1022">[ subject ]</a>
              <a href="author.html#1022">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 26/11/2014 8:59 a.m., Doug Sampson wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks, Amos, for your pointers.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've commented out all the fresh_patterns lines appearing above
</I>&gt;<i> &gt; the last two lines.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I also have dropped diskd in favor of using aufs exclusively,
</I>&gt;<i> &gt; taking out the min-size parameter. I've commented out the
</I>&gt;<i> &gt; diskd_program support option. In the previous version of squid
</I>&gt;<i> &gt; (2.7) I had split the cache_dir into two types with great success
</I>&gt;<i> &gt; using coss and aufs. Previously I had only aufs and performance
</I>&gt;<i> &gt; wasn't where I wanted it. Apparently coss is no longer supported in
</I>&gt;<i> &gt; the 3.x version of squid atop FreeBSD.
</I>&gt;<i> 
</I>&gt;<i> COSS has been replaced with Rock storage type in Squid-3. They should
</I>&gt;<i> be used in roughly similar ways in terms of traffic optimization.
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The pathname for the cache swap logs have been fixed. Apparently
</I>&gt;<i> &gt; this came from a squid.conf example that I copied in parts. Would
</I>&gt;<i> &gt; this be the reason why we are seeing the error messages in
</I>&gt;<i> &gt; /var/log/messages regarding swapping mentioned in my original
</I>&gt;<i> &gt; post?
</I>&gt;<i> 
</I>&gt;<i> No. I think that is coming out of the OS kernel memory management. It
</I>&gt;<i> uses the term &quot;swap&quot; as well in regards to disk backed virtual memory.
</I>&gt;<i> 
</I>&gt;<i> If your system is &quot;swapping&quot; (using that disk backed &quot;swap memory&quot;)
</I>&gt;<i> while running Squid then you will get terrible performance as a matter
</I>&gt;<i> of course since the Squid cache index and cache_meme is often very
</I>&gt;<i> large in RAM and accessed often.
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The hierarchy_stoplist line has been stripped out as you say it is
</I>&gt;<i> &gt; deprecated.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The mem .TSV file is attached herewith.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Currently I have the cache_dir located on the OS disk and all of
</I>&gt;<i> &gt; the cache logging files on a second drive. Is this the optimal
</I>&gt;<i> &gt; setup of cache-dir and logs?
</I>&gt;<i> 
</I>&gt;<i> I would do it the other way around. Logs are appended with a small
</I>&gt;<i> amount of data each transaction, whereas the main cache_dir has a
</I>&gt;<i> relativey large % of the bandwidth throughput being written out to it
</I>&gt;<i> constantly (less % in recent Squid, but still a lot). The dik most
</I>&gt;<i> likely to die early is the one holding cache_dir.
</I>&gt;<i> 
</I>I'm still running into the issue of being out of available space in the swapfile on my system. I've attached another TSV file indicating the various type of memory being in use and whatnot. Is there anything in there that screams out?

Amos, you said earlier that it was the OS system that needed to be tuned. Are there any references to where I can fine-tune it for Squid usage? I looked here <A HREF="http://oss.org.cn/man/newsoft/squid/Squid_FAQ/FAQ-8.html#how-much-ram">http://oss.org.cn/man/newsoft/squid/Squid_FAQ/FAQ-8.html#how-much-ram</A> and I'm unable to figure out a way to decrease the amount of memory that I could use. I tried limiting cache_mem to 1344 MB from some higher value but that didn't work. What are some of the methods that FreeBSD 10.0 users using to limit the use of memory that Squid uses?

Sort of fixing the memory leaks, it looks like I need to consider the possibility of restarting the Squid service on a regular basis (i.e. at least once a week) in order to enable Squid to perform at an acceptable level and to avoid clogging /var/log/messages with such messages as follows:

&lt;...&gt;
+swap_pager_getswapspace(15): failed
+swap_pager_getswapspace(2): failed
+swap_pager_getswapspace(16): failed
+swap_pager_getswapspace(16): failed
&lt;...&gt;

Is this a common practice among squid admins to restart squid periodically?

Thank you!

~Doug
 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-internal-mgr_MEM_20141205.tsv
Type: text/tab-separated-values
Size: 15791 bytes
Desc: squid-internal-mgr_MEM_20141205.tsv
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20141205/89b5c3ee/attachment.tsv">http://lists.squid-cache.org/pipermail/squid-users/attachments/20141205/89b5c3ee/attachment.tsv</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000993.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
	<LI>Next message (by thread): <A HREF="001024.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1022">[ date ]</a>
              <a href="thread.html#1022">[ thread ]</a>
              <a href="subject.html#1022">[ subject ]</a>
              <a href="author.html#1022">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
