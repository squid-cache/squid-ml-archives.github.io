<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3C54829B70.9080000%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001022.html">
   <LINK REL="Next"  HREF="001053.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3C54829B70.9080000%40treenet.co.nz%3E"
       TITLE="[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Dec  6 06:00:16 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001022.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
        <LI>Next message (by thread): <A HREF="001053.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1024">[ date ]</a>
              <a href="thread.html#1024">[ thread ]</a>
              <a href="subject.html#1024">[ subject ]</a>
              <a href="author.html#1024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 6/12/2014 11:17 a.m., Doug Sampson wrote:
&gt;&gt;<i> On 26/11/2014 8:59 a.m., Doug Sampson wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks, Amos, for your pointers.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I've commented out all the fresh_patterns lines appearing
</I>&gt;&gt;&gt;<i> above the last two lines.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I also have dropped diskd in favor of using aufs exclusively, 
</I>&gt;&gt;&gt;<i> taking out the min-size parameter. I've commented out the 
</I>&gt;&gt;&gt;<i> diskd_program support option. In the previous version of squid 
</I>&gt;&gt;&gt;<i> (2.7) I had split the cache_dir into two types with great
</I>&gt;&gt;&gt;<i> success using coss and aufs. Previously I had only aufs and
</I>&gt;&gt;&gt;<i> performance wasn't where I wanted it. Apparently coss is no
</I>&gt;&gt;&gt;<i> longer supported in the 3.x version of squid atop FreeBSD.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> COSS has been replaced with Rock storage type in Squid-3. They
</I>&gt;&gt;<i> should be used in roughly similar ways in terms of traffic
</I>&gt;&gt;<i> optimization.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The pathname for the cache swap logs have been fixed.
</I>&gt;&gt;&gt;<i> Apparently this came from a squid.conf example that I copied in
</I>&gt;&gt;&gt;<i> parts. Would this be the reason why we are seeing the error
</I>&gt;&gt;&gt;<i> messages in /var/log/messages regarding swapping mentioned in
</I>&gt;&gt;&gt;<i> my original post?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> No. I think that is coming out of the OS kernel memory
</I>&gt;&gt;<i> management. It uses the term &quot;swap&quot; as well in regards to disk
</I>&gt;&gt;<i> backed virtual memory.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If your system is &quot;swapping&quot; (using that disk backed &quot;swap
</I>&gt;&gt;<i> memory&quot;) while running Squid then you will get terrible
</I>&gt;&gt;<i> performance as a matter of course since the Squid cache index and
</I>&gt;&gt;<i> cache_meme is often very large in RAM and accessed often.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The hierarchy_stoplist line has been stripped out as you say it
</I>&gt;&gt;&gt;<i> is deprecated.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The mem .TSV file is attached herewith.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Currently I have the cache_dir located on the OS disk and all
</I>&gt;&gt;&gt;<i> of the cache logging files on a second drive. Is this the
</I>&gt;&gt;&gt;<i> optimal setup of cache-dir and logs?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I would do it the other way around. Logs are appended with a
</I>&gt;&gt;<i> small amount of data each transaction, whereas the main cache_dir
</I>&gt;&gt;<i> has a relativey large % of the bandwidth throughput being written
</I>&gt;&gt;<i> out to it constantly (less % in recent Squid, but still a lot).
</I>&gt;&gt;<i> The dik most likely to die early is the one holding cache_dir.
</I>&gt;&gt;<i> 
</I>&gt;<i> I'm still running into the issue of being out of available space in
</I>&gt;<i> the swapfile on my system. I've attached another TSV file
</I>&gt;<i> indicating the various type of memory being in use and whatnot. Is
</I>&gt;<i> there anything in there that screams out?
</I>&gt;<i> 
</I>
Nothing particularly stands out as leaking. Although the cache memory
pages (mem_node) in-use size is suspiciously close to half what you
say the OS is reporting.

That makes me suspect that your OS is rounding up its allocations to
8KB of memory for each node. If that is the case the simplest
workaround is to reduce cache_mem size down to below the point where
the box will swap.


If you are game for it I have been wondering if we need to enable
chunking for 64-bit systems. To test that run squid with environment
variable MEMPOOLS=1.
 Memory should then be allocated in larger blocks, but utilized much
more compactly within those blocks for an overall saving on objects
like mem_node. It is currently a rarely used feature though, so I'm
not sure if there are any issues hiding.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUgptwAAoJELJo5wb/XPRjLbUIAJjORv/denfKNTA53cxrN7CU
Cbyc3m6yqiM4Mi0J0VNS2qPUJYd69sSGkz4Q4XtpoKLPjO8i8glcVDg8ncoKMokj
E3rJbpj4tcdukPmvJ8XlQRqlAfYANTQK6wGvfhmQOlNqPjtKi6eB7HZR75LWNFlM
aj/6Ij15cfM0OI9KQW5PyKwxLwTmZhDn3g0RTHdbzho9GZOjfZEYA0Wn2eMDNqOM
JIwsamBp6KFCN7w/6Mw2I0+guVOpFALDd35M39HdapEuzwauuNrt5F1DvD+rSIa+
8iBKRcDtB3tsaFWyIilFoxCbTTdtdggDhiN0FfT/KEebtZb+A5PI+IQIFWszNzc=
=5tf8
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001022.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
	<LI>Next message (by thread): <A HREF="001053.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1024">[ date ]</a>
              <a href="thread.html#1024">[ thread ]</a>
              <a href="subject.html#1024">[ subject ]</a>
              <a href="author.html#1024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
