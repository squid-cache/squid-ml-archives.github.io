<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Running SCCM through Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Running%20SCCM%20through%20Squid&In-Reply-To=%3C54850988.3010709%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001030.html">
   <LINK REL="Next"  HREF="001038.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Running SCCM through Squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Running%20SCCM%20through%20Squid&In-Reply-To=%3C54850988.3010709%40treenet.co.nz%3E"
       TITLE="[squid-users] Running SCCM through Squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec  8 02:14:32 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001030.html">[squid-users] Running SCCM through Squid
</A></li>
        <LI>Next message (by thread): <A HREF="001038.html">[squid-users] Help for Squid buiding up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1035">[ date ]</a>
              <a href="thread.html#1035">[ thread ]</a>
              <a href="subject.html#1035">[ subject ]</a>
              <a href="author.html#1035">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 8/12/2014 8:32 a.m., John Gardner wrote:
&gt;<i> Hi everyone, I'm posting this in the hope that someone will have
</I>&gt;<i> some experience in connecting Microsoft System Center Configuration
</I>&gt;<i> Manager (SCCM) through a Squid Reverse Proxy in Internet-Based
</I>&gt;<i> Client Management mode.  Basically, at the moment we use SCCM
</I>&gt;<i> through an MS TMG server in Reverse Proxy configuration and this
</I>&gt;<i> works (probably because Microsoft have lots documentation on this
</I>&gt;<i> on their site), but due to the fact that MS are phasing out TMG, we
</I>&gt;<i> want another solution for patching our laptops when they are off
</I>&gt;<i> the network but on the Internet.
</I>&gt;<i> 
</I>&gt;<i> What should happen is that when a laptop is off the LAN but on the 
</I>&gt;<i> Internet, it communicates back to the SCCM server via HTTPS
</I>&gt;<i> through port 443. The authentication happens as there is a
</I>&gt;<i> certificate on the laptop which has a organisational CA in common
</I>&gt;<i> and once authenticated, all of the patches should roll out.
</I>&gt;<i> 
</I>&gt;<i> When we try to connect through Squid, the traffic does get through 
</I>&gt;<i> from the laptop to the SCCM server, but we do have issues.
</I>&gt;<i> 
</I>&gt;<i> The configuration in Squid is as follows (running on Squid 3.4);
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> https_port xx.xx.xx.44:443 accel 
</I>&gt;<i> cert=/usr/newrprgate/CertAuth/ibcm.ourdomain.com/ibcm.crt 
</I>&gt;<i> key=/usr/newrprgate/CertAuth/ibcm.ourdomain.com/ibcm_key.pem 
</I>&gt;<i> cipher=ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:RC4+RSA:+HIGH:+MEDIUM 
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3 defaultsite=server_4.btstl.co.uk 
</I>&gt;<i> cache_peer xx.xx.xx.60 parent 443 0 no-query originserver
</I>&gt;<i> login=PASS connection-auth=on ssl 
</I>&gt;<i> sslcert=/usr/newrprgate/CertAuth/ibcm.ourdomain.com/peer_keys/IBCM.pem
</I>&gt;<i>
</I>&gt;<i> 
</I>sslversion=1 sslflags=DONT_VERIFY_PEER front-end-https
&gt;<i> name=server_4_https acl sites_server_4 dstdomain
</I>&gt;<i> ibcm.ourdomain.com cache_peer_access server_4_https allow
</I>&gt;<i> sites_server_4 cache_peer_access server_4_https deny all
</I>&gt;<i> 
</I>&gt;<i> And the log looks like this;
</I>&gt;<i> 
</I>&gt;<i> 81.XX.XX.XX - - [05/Dec/2014:11:43:33 +0000] &quot;CCM_POST 
</I>&gt;<i> <A HREF="https://ibcm.ourdomain.com/ccm_system/request">https://ibcm.ourdomain.com/ccm_system/request</A> HTTP/1.1&quot; 403 1560 
</I>&gt;<i> TCP_MISS:FIRSTUP_PARENT
</I>&lt;snip&gt;

&gt;<i> 
</I>&gt;<i> So obviously, we are connecting, but getting a 403 error back.
</I>&gt;<i> The configuration on the SCCM server does appear to be correct, so
</I>&gt;<i> we are examining whether we have configured the Squid part
</I>&gt;<i> correctly... Does anyone have any experience of doing this?
</I>&gt;<i> 
</I>
Assuming Jason is right about it being a not-quite-HTTP protocol can
you please enable debug_options 11,2 to see what messages SCCM is
sending to Squid. I might be able to do something about it.

Also check that you have this at or near the top of your http_access
rules:
  http_access allow sites_server_4

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUhQmHAAoJELJo5wb/XPRj8cAIAIk3BMDvxfCpn+8b0MzIVN8E
61lyU1KesNrvS9irv07LN6iro7Wj79TXqDPRcZ95OHnnHUyvjoBtBUvHJoADQvWQ
2sU0ZU37UjBRP5xLvaoA4uDT2JH/UJbxVdY5k55yiKqzlPw9ma7IF71Tw0xSzcnz
P5f2Mai+w4agkXo1s2p6aVHqf0G0ZkHryYZcE7tT8/ee2gDPelhbB3wShcpcuvOS
Qt5x9MS7pdU3SC6bpam01kf1pOxMaRLVdyk9u3t5pXcKAmPZR8FDAS1K5kpmJuXH
r+277c90PPFQzUIwJrki1T7nn+dGFtYVvs8IntCUUIrfjO+iC1+iKkz1KvelCUM=
=LHwZ
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001030.html">[squid-users] Running SCCM through Squid
</A></li>
	<LI>Next message (by thread): <A HREF="001038.html">[squid-users] Help for Squid buiding up
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1035">[ date ]</a>
              <a href="thread.html#1035">[ thread ]</a>
              <a href="subject.html#1035">[ subject ]</a>
              <a href="author.html#1035">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
