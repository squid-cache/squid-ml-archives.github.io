<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent proxy with Peek and Splice feature.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20proxy%20with%20Peek%20and%20Splice%20feature.&In-Reply-To=%3C5486E286.7020201%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001036.html">
   <LINK REL="Next"  HREF="001155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent proxy with Peek and Splice feature.</H1>
    <B>Vadim Rogoziansky</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20proxy%20with%20Peek%20and%20Splice%20feature.&In-Reply-To=%3C5486E286.7020201%40gmail.com%3E"
       TITLE="[squid-users] Transparent proxy with Peek and Splice feature.">vrogoziansky.squid at gmail.com
       </A><BR>
    <I>Tue Dec  9 11:52:38 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001036.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
        <LI>Next message (by thread): <A HREF="001155.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1058">[ date ]</a>
              <a href="thread.html#1058">[ thread ]</a>
              <a href="subject.html#1058">[ subject ]</a>
              <a href="author.html#1058">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yeap, squid perfectly &quot;splice&quot; the destination domain after step1 or 
step2 or step3 when the browser is set to use proxy directly.
But, it does not work in case of transparent proxy. Squid uses the 
destination IP address instead of SNI details.

The example of using client IP address is below:
2014/11/27 01:15:22.851| DomainData.cc(110) match: aclMatchDomainList: 
'212.42.77.232' NOT found

Thank you guys.


11/29/2014 6:17 AM, Amos Jeffries &#1085;&#1072;&#1087;&#1080;&#1089;&#1072;&#1074;(&#1083;&#1072;):
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 28/11/2014 2:48 a.m., Vadim Rogoziansky wrote:
</I>&gt;&gt;<i> Hello Amos.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for answer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There was made an investigation related to squid's peek and splice
</I>&gt;&gt;<i> issues in transparent mode. One-line explanation is as follows - in
</I>&gt;&gt;<i> intercept mode squid can't get a server host name from the request
</I>&gt;&gt;<i> header and uses clent IP address instead for both fake cert
</I>&gt;&gt;<i> generation and as a SNI record in server bump SSL handshaking. This
</I>&gt;&gt;<i> is the root of the problem. However this can be fixed if squid uses
</I>&gt;&gt;<i> SNI field taken from client TLS Hello message for that purposes.
</I>&gt;&gt;<i> Can you hack squid in this way? What do you think?
</I>&gt;<i> I think peek-n-splice is supposed to already be doing that.
</I>&gt;<i>
</I>&gt;<i> However it does depend on whether you are bumping the connection at
</I>&gt;<i> step 1 (before ClientHello), step 2 (after ClientHello, before
</I>&gt;<i> ServerHello), or step 3 (after both ClientHello and ServerHello) of
</I>&gt;<i> the TLS handshake whether the SNI details are present.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2.0.22 (MingW32)
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBAgAGBQJUeUjPAAoJELJo5wb/XPRj6QEIAOHrR8wmDcjkfgUh2UtPwpHP
</I>&gt;<i> vVkPMEuIrUq9Gxx3uSojCZjlFJPuCQ2UafS1p8LuxcEQ+TRmUFbAu4AkKoO2RoZ5
</I>&gt;<i> 7fCGoiXTwn4TzFf0pLh9SPBq9j12OJ3uT28EEqbILrT0sbKP02xK/qiJfCLR61Ev
</I>&gt;<i> vprAdggapbKg/ns1l1H3BBgZR2A4W/abQPIq6/Eu/r+7nYK6L2oOdqPDWTJjudMV
</I>&gt;<i> 8D9sdOD9mYYryrdptU0GLh9Q/V5QEhipSkuA936iZ0Dfa2ZSr4gphJyaRAFWSMf3
</I>&gt;<i> q502lZy+ASkDa2vAbjALRBgn3VwYWl8KBQcypUKF4UXtaLtF0EIrLMun+p4QxUM=
</I>&gt;<i> =44aG
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001036.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
	<LI>Next message (by thread): <A HREF="001155.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1058">[ date ]</a>
              <a href="thread.html#1058">[ thread ]</a>
              <a href="subject.html#1058">[ subject ]</a>
              <a href="author.html#1058">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
