<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Debugging slow access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20slow%20access&In-Reply-To=%3C5488724B.9080304%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001065.html">
   <LINK REL="Next"  HREF="001061.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Debugging slow access</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20slow%20access&In-Reply-To=%3C5488724B.9080304%40opendium.com%3E"
       TITLE="[squid-users] Debugging slow access">steve at opendium.com
       </A><BR>
    <I>Wed Dec 10 16:18:19 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001065.html">[squid-users] [squid-announce] Squid 3.4.10 is available
</A></li>
        <LI>Next message (by thread): <A HREF="001061.html">[squid-users] Parent Proxy Cache Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1060">[ date ]</a>
              <a href="thread.html#1060">[ thread ]</a>
              <a href="subject.html#1060">[ subject ]</a>
              <a href="author.html#1060">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I'm looking for advice on figuring out what is causing intermittent high 
CPU usage.

I'm seeing this on multiple servers - most of the time everything is 
fine and I see the Squid workers using maybe 20% CPU each, but every so 
often all the workers sit at the top of the process list in &quot;top&quot;, using 
 &gt; 97% CPU each and users report very sluggish web access.

Using squidclient during &quot;sluggish&quot; periods is also very slow, with 
Squid taking several seconds to respond to the http requests.  The 
number of requests being handled by squid during the slow periods isn't 
especially high (maybe ~20 / second) and is certainly lower than the 
number of requests at other times - probably because it is taking so 
long to answer requests, but this seems to indicate that it isn't simply 
overloaded and having to deal with too many requests at once.

The during the &quot;slow&quot; periods, squid's servicing of requests seems very 
bursty in nature - I see a whole bunch of requests over a few hundred 
milliseconds and then nothing for maybe half a second.  There are no log 
entries that seem to coincide with these problems.

If I firewall off the clients, the load drops back to zero, so it seems 
this is something a client is doing that is causing Squid to expend a 
huge amount of CPU handling the request, rather than Squid getting stuck 
in a loop or similar.

Restarting squid seems to temporarily fix the problem, but it invariably 
comes back again at some point.

Notably the median service time go up:
	HTTP Requests (All):   0.30178  0.40454
	Cache Misses:          0.70906  0.65348
	Cache Hits:            0.00000  0.00000
	Near Hits:             0.00000  0.00000
	Not-Modified Replies:  0.00000  0.00000
	DNS Lookups:           0.02893  0.03092
	ICP Queries:           0.00000  0.00000

	UP Time:	11657.399 seconds
	CPU Time:	8843.268 seconds
	CPU Usage:	111.23%
	CPU Usage, 5 minute avg:	144.81%
	CPU Usage, 60 minute avg:	153.58%
	Maximum Resident Size: 2937536 KB
	Page faults with physical i/o: 3


Compared to (recently restarted):
	HTTP Requests (All):   0.09477  0.09477
	Cache Misses:          0.11465  0.11465
	Cache Hits:            0.00000  0.00000
	Near Hits:             0.00000  0.00000
	Not-Modified Replies:  0.00000  0.00000
	DNS Lookups:           0.00953  0.00953
	ICP Queries:           0.00000  0.00000

	UP Time:	293.336 seconds
	CPU Time:	127.775 seconds
	CPU Usage:	43.56%
	CPU Usage, 5 minute avg:	47.40%
	CPU Usage, 60 minute avg:	47.40%
	Maximum Resident Size: 799808 KB
	Page faults with physical i/o: 0


Is there any advice on how to track down what the problem is?

This Squid is doing:
  - No caching
  - ICAP
  - External ACLs
  - Auth (Negotiate and Basic)
  - SSL bump
  - Both TPROXY and non-transparent (majority of the traffic is 
non-transparent)
  - Uses an upstream proxy for most HTTP (not HTTPS)

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001065.html">[squid-users] [squid-announce] Squid 3.4.10 is available
</A></li>
	<LI>Next message (by thread): <A HREF="001061.html">[squid-users] Parent Proxy Cache Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1060">[ date ]</a>
              <a href="thread.html#1060">[ thread ]</a>
              <a href="subject.html#1060">[ subject ]</a>
              <a href="author.html#1060">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
