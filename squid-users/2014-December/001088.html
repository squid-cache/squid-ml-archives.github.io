<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Skype bypass using ssl_bump peek
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20bypass%20using%20ssl_bump%20peek&In-Reply-To=%3C548AC2AA.3040509%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001084.html">
   <LINK REL="Next"  HREF="001133.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Skype bypass using ssl_bump peek</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20bypass%20using%20ssl_bump%20peek&In-Reply-To=%3C548AC2AA.3040509%40treenet.co.nz%3E"
       TITLE="[squid-users] Skype bypass using ssl_bump peek">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec 12 10:25:46 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001084.html">[squid-users] Skype bypass using ssl_bump peek
</A></li>
        <LI>Next message (by thread): <A HREF="001133.html">[squid-users] Skype bypass using ssl_bump peek
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1088">[ date ]</a>
              <a href="thread.html#1088">[ thread ]</a>
              <a href="subject.html#1088">[ subject ]</a>
              <a href="author.html#1088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 12/12/2014 10:31 p.m., Yu-Hsuan Liao wrote:
&gt;<i> Hello everyone,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to using Squid 3.5's new feature peek-and-splice to
</I>&gt;<i> bypass Skype connection I'm a little confused about ssl_bump
</I>&gt;<i> steps, the wiki says that
</I>&gt;<i> 
</I>&gt;<i> peek Receive client (step SslBump1) or server (step SslBump2) 
</I>&gt;<i> certificate while preserving the possibility of splicing the 
</I>&gt;<i> connection.
</I>&gt;<i> 
</I>&gt;<i> My question is: does ssl_bump make decision to bump or splice
</I>&gt;<i> connection when Squid gets the ServerHello message?
</I>&gt;<i> 
</I>&gt;<i> cos I found that Skype voice connection is first
</I>&gt;<i> 
</I>
a) ssl_bump called (step 1) to decide what to do with no info but TCP
packet details available.

&gt;<i> 1. client send Client Hello
</I>
b) ssl_bump called again (step 2) to decide what to do with only
client and TCP details available.

&gt;<i> 2. server send Server Hello
</I>
c) ssl_bump called again (step 3) to decide what to do with all
client, server and TCP details available.

&gt;<i> 
</I>&gt;<i> then began the skype data payload transmit(non-SSL format, not the 
</I>&gt;<i> rest SSL handshake)
</I>&gt;<i> 
</I>&gt;<i> so that I still got the &quot;Error negotiating SSL connection on FD&quot; 
</I>&gt;<i> message in cache.log
</I>&gt;<i> 
</I>&gt;<i> Does peek-and-splice function cover above situation, or I just 
</I>&gt;<i> misunderstand the usage of ssl_bump peek?
</I>&gt;<i> 
</I>
Not if you nee dto wait for the Skype payload before deciding what to
do during the bumping process.
If the TLS hello from either end included ALPN or a useful SNI value
they might be used to determine a step during bumping. Though I dont
think Squid acts on ALPN values yet.


&gt;<i> my squid ver. is 3.5.0.3
</I>&gt;<i> 
</I>&gt;<i> squid.config setting is
</I>&gt;<i> 
</I>&gt;<i> acl skype_list dstdomain &quot;skype_list&quot; ssl_bump peek skype_list 
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> 
</I>
Only if &quot;skype_list&quot; matches the TCP packet IP address (without rDNS
being looked up) will the peek happen.

I think you need to add at_step ACL test to peek always at step1, then
do the other actions at step2 once SNI (domain name) is possibly
available.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUisKqAAoJELJo5wb/XPRjNasIAOKpSpii9cuB1u3khGuADMKF
QQpyWrPYoJ4jG1HZRYz+w4SEkRYyDVqv16FA8o6/Pgbxknie/GRgqAdUAxF8iTAk
t96kDd9O8Futr/67iK/a7ry3ejW+IA4siJuZIpTl1FGx1Ku8W1I1lEOdjcJIJRSe
NfPmVc/ok6v9sKXmoTbbcMoG5YzBLE+g/LM5HQywMmTs0FMzrtgrfd6OTU+phV+Z
dkDGYo2pcKWjYuT+KXP3jw6Z37rENH4GxpKKHWXuzV3tvSpc30ACBxZ3Lk8N5417
1G9IcmDJoPoz7JBQMH+CVgtCMBJaEhtcodZkzCxvSejacMewu5N1oDKbRtaCGaM=
=D4zK
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001084.html">[squid-users] Skype bypass using ssl_bump peek
</A></li>
	<LI>Next message (by thread): <A HREF="001133.html">[squid-users] Skype bypass using ssl_bump peek
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1088">[ date ]</a>
              <a href="thread.html#1088">[ thread ]</a>
              <a href="subject.html#1088">[ subject ]</a>
              <a href="author.html#1088">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
