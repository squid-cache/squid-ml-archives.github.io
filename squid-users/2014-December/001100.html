<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] After a Successful PURGE, Still Get TCP-DENIED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20After%20a%20Successful%20PURGE%2C%20Still%20Get%20TCP-DENIED&In-Reply-To=%3C548D204C.1020002%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001099.html">
   <LINK REL="Next"  HREF="001101.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] After a Successful PURGE, Still Get TCP-DENIED</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20After%20a%20Successful%20PURGE%2C%20Still%20Get%20TCP-DENIED&In-Reply-To=%3C548D204C.1020002%40treenet.co.nz%3E"
       TITLE="[squid-users] After a Successful PURGE, Still Get TCP-DENIED">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Dec 14 05:29:48 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001099.html">[squid-users] After a Successful PURGE, Still Get TCP-DENIED
</A></li>
        <LI>Next message (by thread): <A HREF="001101.html">[squid-users] After a Successful PURGE, Still Get TCP-DENIED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1100">[ date ]</a>
              <a href="thread.html#1100">[ thread ]</a>
              <a href="subject.html#1100">[ subject ]</a>
              <a href="author.html#1100">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 14/12/2014 5:49 p.m., dkovacevic wrote:
&gt;<i> I have an external_acl_type directive which returns &quot;OK&quot; or &quot;ERR&quot;
</I>&gt;<i> depending on a database query.
</I>
Ok.

&gt;<i> 
</I>&gt;<i> The problem is this: when the database is updated, which should
</I>&gt;<i> permit the site to be accessed,
</I>
Ok.

&gt;<i> Squid has the previous response cached,
</I>
Irrelevant. ACL managing *access* to an object does not matter where
it comes from, the only thing that matters is whether access is
allowed/denied.

&gt;<i> the result being continued &quot;access denied&quot; responses until either
</I>&gt;<i> Squid is restarted or the result expires (where?).
</I>
generated != cached.

&quot;Access denied&quot; object is being generated by Squid. Results
*generated* by Squid are not cached by Squid.

&gt;<i> 
</I>&gt;<i> I attempted to clear the cache by using PURGE request via
</I>&gt;<i> squidclient, which is successful in clearing the cache, but not the
</I>&gt;<i> result decision (TCP-DENIED). After running the PURGE, doing a
</I>&gt;<i> refresh in browser causes another lookup in Squid- but Squid then
</I>&gt;<i> returns &quot;access-denied&quot; (no database query).
</I>&gt;<i> 
</I>&gt;<i> What do I need to do to force Squid to check the ACL after a
</I>&gt;<i> browser refresh?
</I>
You seem to be mistaking what is cached.

1) The DB has an internal cache of query/response, the DB lookup
result from the helepr may becoming from there. SQL/relational
databases ACID compliance prevents this cache interferring if the DB
has been updated, but if you are using a NoSQL database or distributed
cluster DB it can affect things quite badly.

2) Some helpers have internal caches to quickly respond to queries.
external ACL helpers not so much becasue of #3, but this is a possibility.

3) Squid has a cache for each helpers responses. Such that if you send
the same query twice the repeats get serviced quickly from the helper
cache. This is controlled by the various ttl=, negative_ttl= and
cache= options of external_acl_type directive.
  <A HREF="http://www.squid-cache.org/Doc/config/external_acl_type/">http://www.squid-cache.org/Doc/config/external_acl_type/</A>

4) Squid has an HTTP object cache for *external* server produced
objects in the HTTP traffic.
 - PURGE is an HTTP method, it only affects this cache.


I think #3 is what you are having trouble with. The default is 60
minutes caching for helper responses. So there will be a 1 hour delay
between updating the DB and any change visible in Squid HTTP responses.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUjSBKAAoJELJo5wb/XPRj6UAH/2x7iTYM6gx1+kQ0YJmh1vsF
ckebcQVXHpb8ww2G+LmH0D7LVCz4OlsdxXEYM5lVHxoIa6BNBnlvXONGk3Y/8l78
yLBEHdj1lktAigpleU2TI+4tVVKFdRWBEqQF0ICzxFVsmH4GKWgT+I0EJ6b/bsAO
VExbR0bKd1mqXWG08yEpcXlrLug8eVMTo8qsn8eyCVsRpjKhW1fp2g2i+TncwLqy
eg2HqTEQBnCkkjIA2dwzQkSFhRKiEpa1xcwF6+6pDSY82nU/MvCPG+MYLRBaH8FL
BopNwjKQyMiLK5QxOFK5z2FCKIUseFGtvjioctBATESFdX1LYqZWG408mJg248U=
=Me+/
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001099.html">[squid-users] After a Successful PURGE, Still Get TCP-DENIED
</A></li>
	<LI>Next message (by thread): <A HREF="001101.html">[squid-users] After a Successful PURGE, Still Get TCP-DENIED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1100">[ date ]</a>
              <a href="thread.html#1100">[ thread ]</a>
              <a href="subject.html#1100">[ subject ]</a>
              <a href="author.html#1100">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
