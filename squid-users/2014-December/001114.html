<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Parent Proxy Cache Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Parent%20Proxy%20Cache%20Problem&In-Reply-To=%3C548F38E7.3030600%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001110.html">
   <LINK REL="Next"  HREF="001067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Parent Proxy Cache Problem</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Parent%20Proxy%20Cache%20Problem&In-Reply-To=%3C548F38E7.3030600%40treenet.co.nz%3E"
       TITLE="[squid-users] Parent Proxy Cache Problem">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec 15 19:39:19 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001110.html">[squid-users] Parent Proxy Cache Problem
</A></li>
        <LI>Next message (by thread): <A HREF="001067.html">[squid-users] Existing root certificate not working with SSL Bump (squid 3.3.10)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1114">[ date ]</a>
              <a href="thread.html#1114">[ thread ]</a>
              <a href="subject.html#1114">[ subject ]</a>
              <a href="author.html#1114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 16/12/2014 2:26 a.m., squeeky wrote:
&gt;&gt;<i> Please check your config for &quot;proxy-only&quot; option on the link to
</I>&gt;&gt;<i> parent proxy. That alone will prevent caching.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If that option is not there, please post your config.
</I>&gt;<i> 
</I>&gt;<i> Still having issues with with getting content that is served from
</I>&gt;<i> parent to cache locally.
</I>

You dont say what Squid version. Some of the things below were only
ever relevant in Squid-2 series releases. If you are using anything
older than Squid-3.4 please seriously consider an upgrade.


&gt;<i> Config below:
</I>&gt;<i> 
</I>&gt;<i> http_port 10.77.40.8:8080 icp_port 7
</I>
&gt;<i> dns_v4_first off
</I>
Above line is a default anyway, you can remove it completely.

&gt;<i> pid_filename /var/run/squid.pid cache_effective_user proxy 
</I>&gt;<i> cache_effective_group proxy error_default_language en
</I>
The above 4 lines should all be default values for those directives too.

&gt;<i> icon_directory /usr/pbi/squid-i386/etc/squid/icons visible_hostname
</I>&gt;<i> localhost
</I>
NP: how are your clients expected to fetch icons from
<A HREF="http://localhost/...">http://localhost/...</A> URLs ?
 - *visible* hostname is supposed to be a DNs domain name which your
Squid can be contacted on.

&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at localhost</A>
</I>
Ditto for emailing you probems reoports to <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at localhost.</A>

Note that Squid itself tries to email you crash reports at this
address too.


&gt;<i> access_log /var/squid/logs/access.log cache_log
</I>&gt;<i> /var/squid/logs/cache.log cache_store_log none sslcrtd_children 0 
</I>&gt;<i> logfile_rotate 0 shutdown_lifetime 3 seconds # Allow local
</I>&gt;<i> network(s) on interface(s)
</I>

Em. Squid is layer 4-7 software. Has nothing to do with layer-3
interfaces.

&quot;localnet&quot; ACL is supposed to list the valid LAN network range(s)
where Squid can expect traffic to flow in from.

&gt;<i> acl localnet src  10.77.40.0/21 forwarded_for off via off 
</I>&gt;<i> httpd_suppress_version_string on uri_whitespace strip
</I>&gt;<i> 
</I>&gt;<i> # Break HTTP standard for flash videos. Keep them in cache even if
</I>&gt;<i> asked not to. refresh_pattern -i \.flv$ 10080 90% 999999
</I>&gt;<i> ignore-no-cache override-expire ignor e-private
</I>&gt;<i> 
</I>&gt;<i> # Let the clients favorite video site through with full caching acl
</I>&gt;<i> youtube dstdomain .youtube.com cache allow youtube
</I>
This might be your problem. Squid ACLs have an implicit default action
which is the opposite of the last explicit action. So what you have
configured above is equivalent to:

   cache allow youtube
   cache deny all

That &quot;deny all&quot; implicit action will block caching for a huge amount
of traffic.


Also, Squid caches everything is can by default. The purpose of the
cache directive is to allow you to *prevent* things caching.

I think you should remove the config lines:
&quot;
 # Let the clients favorite video site through with full caching
 acl youtube dstdomain .youtube.com
 cache allow youtube&quot;
&quot;



&gt;<i> 
</I>&gt;<i> # Windows Update refresh_pattern range_offset_limit -1 
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> microsoft.com/.*\.(cab|exe|ms[i|u|f]|asf|wm[v|a]|dat|zip) 432 0 80%
</I>&gt;<i> 43200 reload-into-ims refresh_pattern -i 
</I>&gt;<i> windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|asf|wm[v|a]|dat|zip) 4320
</I>&gt;<i> 80% 43200 reload-into-ims refresh_pattern -i 
</I>&gt;<i> my.windowsupdate.website.com/.*\.(cab|exe|ms[i|u|f]|asf|wm[v| 
</I>&gt;<i> a]|dat|zip) 4320 80% 43200 reload-into-ims cache_mem 100 MB 
</I>&gt;<i> maximum_object_size_in_memory 32 KB memory_replacement_policy heap
</I>&gt;<i> LFUDA
</I>&gt;<i> 
</I>&gt;<i> cache_replacement_policy heap LFUDA cache_dir ufs /var/squid/cache
</I>&gt;<i> 6000 32 256 minimum_object_size 0 KB maximum_object_size 5000000
</I>&gt;<i> KB
</I>

Your biggest cache is only 6GB in size. You truely expect to cache
many up-to-5GB objects there?



&gt;<i> offline_mode oncache_swap_low 90 cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>
Notice the above instruction.

&gt;<i> refresh_pattern ^ftp:    1440  20%  10080 refresh_pattern ^gopher:
</I>&gt;<i> 1440  0%  1440 refresh_pattern -i (/cgi-bin/|\?) 0  0%  0 
</I>&gt;<i> refresh_pattern .    0  20%  4320 # No redirector configured
</I>&gt;<i> 
</I>&gt;<i> #Remote proxies
</I>&gt;<i> 
</I>&gt;<i> # Setup some default acls acl allsrc src all
</I>
Why are you defining &quot;allsrc&quot; as a special name?
There is nothing special being done when it matches, just use &quot;all&quot;
instead.


&gt;<i> acl localhost src 127.0.0.1/32 acl safeports port 21 70 80 210 280
</I>&gt;<i> 443 488 563 591 631 777 901  3128 1025-65535
</I>
NOTE: 3128 is part of the 1025-65535 number range.

&gt;<i> 
</I>&gt;<i> acl sslports port 443 563 acl manager proto cache_object acl purge
</I>&gt;<i> method PURGE acl connect method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Define protocols used for redirects acl HTTP proto HTTP acl HTTPS
</I>&gt;<i> proto HTTPS
</I>&gt;<i> 
</I>&gt;<i> acl allowed_subnets src IP.REMOVED.FOR.SECURITY
</I>
NOTE: I hope that is not he same IP as the cache_peer below. If it is
you are explicitly allowing traffic to loop infinitely between the
peer and your Squid.

&gt;<i> acl blacklist dstdom_regex -i &quot;/var/squid/acl/blacklist.acl&quot; 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny manager http_access allow purge localhost 
</I>&gt;<i> http_access deny purge http_access deny !safeports http_access deny
</I>&gt;<i> CONNECT !sslports
</I>&gt;<i> 
</I>&gt;<i> # Always allow localhost connections http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> request_body_max_size 0 KB
</I>
Another default setting being explicitly configured. You should be
able to remove the above line.

&gt;<i> delay_pools 1 delay_class 1 2 delay_parameters 1 -1/-1 -1/-1 
</I>&gt;<i> delay_initial_bucket_level 100 delay_access 1 allow allsrc
</I>
So, you want Squid to do a lot of complicated per-packet byte
accounting/management in order *not* to apply byte-rate limits ?

Erase the above delay_* directives and your Squid will work a bit faster.


&gt;<i> 
</I>&gt;<i> # Reverse Proxy settings
</I>&gt;<i> 
</I>&gt;<i> # Custom options refresh_pattern -i .ipa$ 4320 100% 259200
</I>&gt;<i> override-expire reload-into-ims ignore -reload refresh_pattern -i
</I>&gt;<i> .pkg$ 4320 100% 259200 override-expire reload-into-ims ignore 
</I>&gt;<i> -reload refresh_pattern -i .ipsw$ 4320 100% 259200 override-expire
</I>&gt;<i> reload-into-ims ignor e-reload
</I>&gt;<i> 
</I>
None of these refresh_patterns have any effect. They are not above the
default refresh_patterns with that notice about putting your own
patterns above them.


&gt;<i> cache_peer IP.REMOVED.FOR.SECURITY parent 8080 0 default 
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> # Block access to blacklist domains http_access deny blacklist #
</I>&gt;<i> Setup allowed acls # Allow local network(s) on interface(s) 
</I>&gt;<i> http_access allow allowed_subnets http_access allow localnet #
</I>&gt;<i> Default block all to be sure http_access deny allsrc
</I>&gt;<i> 
</I>

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUjzjnAAoJELJo5wb/XPRjiN4IAK8dj6AGVorC4olSVPtx1fyg
ZB4HTu7WYtNLHNTfoMxq7oLucvftCHIxwTNP+s2l3MbyvcaM4sceBpeALo0EL6wN
V5zN4Kt+MV0lolZMSuM7bfCqndNdN5eErRxAi99iwZXpbNZN0OEabqEoLL7kGX76
sNTXWCvXl9mvhVL0oWJHRN5tm8Gyv9BezZMJnY/zKdwMtb1zT7QEEZC+WCCH1s+6
2uB+tlf/ZMyFzairhXnYcC2PgjI4T5QbgsZcCPGbmGwIG3EbArbnUDIyPqqsJvaV
u8v/I1E7kQmEY2lrj8pDrfZLGVbQIv56Pa5R/Xof4B472snBLykG+R3wz/KalTI=
=dr00
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001110.html">[squid-users] Parent Proxy Cache Problem
</A></li>
	<LI>Next message (by thread): <A HREF="001067.html">[squid-users] Existing root certificate not working with SSL Bump (squid 3.3.10)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1114">[ date ]</a>
              <a href="thread.html#1114">[ thread ]</a>
              <a href="subject.html#1114">[ subject ]</a>
              <a href="author.html#1114">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
