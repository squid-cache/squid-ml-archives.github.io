<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Splicing a connection if server cert cannot be verified
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Splicing%20a%20connection%20if%20server%20cert%20cannot%20be%0A%20verified&In-Reply-To=%3C548F403A.9040803%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001112.html">
   <LINK REL="Next"  HREF="001116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Splicing a connection if server cert cannot be verified</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Splicing%20a%20connection%20if%20server%20cert%20cannot%20be%0A%20verified&In-Reply-To=%3C548F403A.9040803%40treenet.co.nz%3E"
       TITLE="[squid-users] Splicing a connection if server cert cannot be verified">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec 15 20:10:34 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001112.html">[squid-users] Splicing a connection if server cert cannot be	verified
</A></li>
        <LI>Next message (by thread): <A HREF="001116.html">[squid-users] Splicing a connection if server cert cannot be verified
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1115">[ date ]</a>
              <a href="thread.html#1115">[ thread ]</a>
              <a href="subject.html#1115">[ subject ]</a>
              <a href="author.html#1115">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 16/12/2014 8:11 a.m., Soren Madsen (DREIJER) wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> By default, I want to bump all connections through my Squid
</I>&gt;<i> instance. However, while testing I've discovered lots of sites that
</I>&gt;<i> use SSLv3
</I>

Offering SSLv3 from a server is suicide these days. Those sites should
be on the fast decline, or at very least shunned like plague victims.
Lookup POODLE if you dont know why already.


&gt;<i> or self-signed certificates,
</I>
Nothing wrong with self-signed though. Much *more* secure than CA
validated certs when used in DANE protocol.

&gt;<i> in which case I'd like to fall back to TLS passthrough mode and let
</I>&gt;<i> the client decide whether it wants to trust the server or not. In
</I>&gt;<i> other words, if Squid cannot successfully bump a connection, I
</I>&gt;<i> don't want to fail the connection, but rather step out of the way
</I>&gt;<i> and let the client decide what to do.
</I>&gt;<i> 
</I>&gt;<i> The ideal solution, I think, would be to optimistically attempt to 
</I>&gt;<i> bump the connection, but if it fails due to e.g. a bad server cert,
</I>&gt;<i> a new connection can be established with the original client
</I>&gt;<i> hello.
</I>&gt;<i> 
</I>&gt;<i> I was hoping the new peek and splice functionality would be able
</I>&gt;<i> to help me in this regard: 
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i> 
</I>&gt;<i> As far as I can tell, the 'stare' action is what I'm interested in 
</I>&gt;<i> here although it appears it's not a focus of the current 
</I>&gt;<i> implementation, and the 'peek' action has the following limitation 
</I>&gt;<i> note about 'Peeking at the server often precludes bumping': &quot;We
</I>&gt;<i> could teach Squid to abandon the current server connection and then
</I>&gt;<i> bump a newly open one. This is something we do not want to do as it
</I>&gt;<i> is likely to create an even worse operational problems with Squids
</I>&gt;<i> being auto-blocked for opening and closing connections in vein.&quot;
</I>&gt;<i> 
</I>&gt;<i> I'm confused about this. Couldn't Squid just cache the information 
</I>&gt;<i> about whether it has previously refrained from bumping a
</I>&gt;<i> connection due to a bad server cert (or other errors) and only
</I>&gt;<i> check with the server once the cache expires? That should avoid
</I>&gt;<i> triggering any alarms on the server.
</I>
Happy eyeballs clients open multiple connections in parallel, causing
Squid to be seen opening just as many. Adding the above behaviour
would make the number of connections hammering the server multiply by
*at least* 2.

Also, with modern HTTPS load balancers every since connection is
potentially going to a different real backend server, with different
TLS settings even if the domain, IP, and port details are exactly
identical. Things could also change with no notice as admin fix
transient problems.

If you are going to bypass bumping based on vague-ish criteria then
you might as well just not bump. That gets you away from all those
technical probems, and a host of legal issues as well.


AIUI, the basic problem that &quot;precludes bumping&quot; is that in order to
peek at the serverHello some clientHello has to already have been
sent. Squid is already locked into using the features advertised in
that clientHello or dying - with no middle ground. Most times the
client and Squid do not actually have identical capabilities so
peeking the serverHello then either bump or splice actions will break
depending on which clientHello Squid sent.


&gt;<i> 
</I>&gt;<i> Maybe I'm misreading the document. I was hoping somebody here on
</I>&gt;<i> the list could explain to me if I can achieve the above behavior.
</I>&gt;<i> 
</I>
I suspect you actually need the certificate mimic behaviour. Where
Squid generates a server cert as close as possible to the original,
including errors so the client can decide how to handle them.


HTH
Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUj0A6AAoJELJo5wb/XPRjBFgH/3G1mlMG/qMMcPH772Txy53I
iW7vi6is+V015UTKOxYs8cygB4eSFCtL8gXc2+y8ezOsZbSYX9kxCNqChul8clRE
fR8Bo+IldSP7ZcK8lBdoQdPVWz061P+OeyXnvz39ehajXaiXjOrstmT/G4HPWK79
vknA4aznvEnOZN/7qjcF9Arf2BbOQh7JzoO1hLD0XO2jKhS5E+/LbdJgw4i5tH+k
d8ZdxGSmFO/A7J1IZM9tH1bpuXQa3GSGHgEEDnPz7bMKw2mIKCoDV+BxNpqa9gsu
uWjNwEmA4/KAx5JzA/fYOGWDZDh3vsnUXcovRWxlEOB2N24EINz6I4bkTvdqLsY=
=1lCG
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001112.html">[squid-users] Splicing a connection if server cert cannot be	verified
</A></li>
	<LI>Next message (by thread): <A HREF="001116.html">[squid-users] Splicing a connection if server cert cannot be verified
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1115">[ date ]</a>
              <a href="thread.html#1115">[ thread ]</a>
              <a href="subject.html#1115">[ subject ]</a>
              <a href="author.html#1115">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
