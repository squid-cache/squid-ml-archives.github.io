<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 'cache' config option and rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%27cache%27%20config%20option%20and%20rewrite&In-Reply-To=%3C5490286B.9000603%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001119.html">
   <LINK REL="Next"  HREF="001129.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 'cache' config option and rewrite</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%27cache%27%20config%20option%20and%20rewrite&In-Reply-To=%3C5490286B.9000603%40treenet.co.nz%3E"
       TITLE="[squid-users] 'cache' config option and rewrite">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Dec 16 12:41:15 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001119.html">[squid-users] 'cache' config option and rewrite
</A></li>
        <LI>Next message (by thread): <A HREF="001129.html">[squid-users] Strange entries in access.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1120">[ date ]</a>
              <a href="thread.html#1120">[ thread ]</a>
              <a href="subject.html#1120">[ subject ]</a>
              <a href="author.html#1120">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 16/12/2014 11:01 p.m., James Harper wrote:
&gt;<i> I have a rewrite rule so that any request for a list of apt
</I>&gt;<i> repositories (acl dstdomain) are rewritten to instead go to my
</I>&gt;<i> apt-cacher server, and then a &quot;cache deny&quot; rule to make sure squid
</I>&gt;<i> doesn't cache files from these repositories. This seemed to be
</I>&gt;<i> working fine but my latest attempt at a debian install kept failing
</I>&gt;<i> because the gpg signature didn't match. It turns that that squid
</I>&gt;<i> was actually caching these requests, which is the opposite of what
</I>&gt;<i> I wanted as it meant that the sig and the file got out of sync (I
</I>&gt;<i> guess apt-cacher doesn't return a proper indication of what is
</I>&gt;<i> allowed to be cached and what isn't... so the sig was cached but
</I>&gt;<i> the file wasn't, or something like that)
</I>&gt;<i> 
</I>&gt;<i> It turns out that &quot;cache deny &lt;dstdomain acl&gt;&quot; is processed after
</I>&gt;<i> the rewrite, and against the rewritten url, so I needed to also
</I>&gt;<i> exclude requests for my server running apt-cacher.
</I>&gt;<i> 
</I>&gt;<i> So for example:
</I>&gt;<i> 
</I>&gt;<i> acl apt_repo dstdomain ftp.au.debian.org acl apt_cacher browser
</I>&gt;<i> apt-cacher # apt-cacher itself
</I>&gt;<i> 
</I>&gt;<i> cache deny apt_repo cache deny apt_cacher cache allow all
</I>&gt;<i> 
</I>&gt;<i> but I needed to add:
</I>&gt;<i> 
</I>&gt;<i> acl apt_repo dstdomain my.apt.cacher.server
</I>&gt;<i> 
</I>&gt;<i> This is kind of obvious in retrospect, but is it described anywhere
</I>&gt;<i> which rules apply against the url before it is rewritten and which
</I>&gt;<i> are applied to the rewritten url?
</I>&gt;<i> 
</I>
URL re-write is a type of request adaptation.

The operational sequence of HTTP request processing is roughly:
 * parse + header interpretation
 * network traffic security/policy checks (http_access etc)
 * request adaptation (ICAP, eCAP, URL-rewrite/redirect)
 * security policy checks on adapted content (adapted_http_access etc)
 * source type selection (Store-ID rewrite, cache/store_hit directive)
 * client connection QoS setup
 * source-type specific file/worker/server setup
 * fetching the response

I'm not sure if we have it documented anywhere outside the code.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUkChqAAoJELJo5wb/XPRjJVoIAKyyiJY4koPWKXwQy7FBpcCR
Ts0K/glXs2dRDtElp5ijZo7qoxyKPHoE8/H5gJ97f6wb76syctKZNsjYbPjTStNo
G9qSN9prjo18MvYRZupmz6LTGeE+jKAeAcpoNiqprIAsR3H2uQpTAd0lXYIVGZly
EZ8v//IntiGGfEMFP6VP26AD6eG3uTXwUDEa0msv/PcuXTq0uH2monaMQU/aLzhr
rmxAPmLe/x6z0OqY6by/LCk4qFLfFe9lfA3MG2RnJh/ZAy/b6FeApGMQpAX+XfmK
it1U9uZIQUsxKpd6zKP6Ekk7T/j4AD1ImDwK0K03vfj9uKA+Svp/XSlhc9FEam8=
=XGfH
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001119.html">[squid-users] 'cache' config option and rewrite
</A></li>
	<LI>Next message (by thread): <A HREF="001129.html">[squid-users] Strange entries in access.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1120">[ date ]</a>
              <a href="thread.html#1120">[ thread ]</a>
              <a href="subject.html#1120">[ subject ]</a>
              <a href="author.html#1120">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
