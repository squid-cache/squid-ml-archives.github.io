<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] citrix receiver not authenticating with squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20citrix%20receiver%20not%20authenticating%20with%20squid&In-Reply-To=%3C1418757190.2481.8.camel%40desktop.bpk2.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001130.html">
   <LINK REL="Next"  HREF="001123.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] citrix receiver not authenticating with squid</H1>
    <B>Brendan Kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20citrix%20receiver%20not%20authenticating%20with%20squid&In-Reply-To=%3C1418757190.2481.8.camel%40desktop.bpk2.com%3E"
       TITLE="[squid-users] citrix receiver not authenticating with squid">bpk678 at gmail.com
       </A><BR>
    <I>Tue Dec 16 19:13:10 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001130.html">[squid-users] citrix receiver not authenticating with squid
</A></li>
        <LI>Next message (by thread): <A HREF="001123.html">[squid-users] squid rotating between many ips
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1131">[ date ]</a>
              <a href="thread.html#1131">[ thread ]</a>
              <a href="subject.html#1131">[ subject ]</a>
              <a href="author.html#1131">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2014-12-16 at 19:40 +0100, Natxo Asenjo wrote:
&gt;<i> hi,
</I>&gt;<i> 
</I>&gt;<i> we have 2 centos 6 hosts providing a load-balanced squid service
</I>&gt;<i> (behind keepalived and haproxy; haproxy sends requests to both squids)
</I>&gt;<i> and authenticating users against an Active Directory environment. This
</I>&gt;<i> is working really nice.
</I>&gt;<i> 
</I>&gt;<i> Our users log in their desktops and using the negotiate authenticator
</I>&gt;<i> squid_kerb_auth they get automatically logged in the proxies. As a
</I>&gt;<i> fall back for users using them but not logging in to the kerberos AD
</I>&gt;<i> domain, we offer ldap authentication as well. That works fine too.
</I>&gt;<i> 
</I>&gt;<i> However, some of our users need to log in to other organizations
</I>&gt;<i> desktops using the citrix reciever plugin and Internet Explorer. And
</I>&gt;<i> there it fails. The plugin does not use the negotiate authenticator
</I>&gt;<i> apparently so it falls back to the ldap authenticator. This works for
</I>&gt;<i> a few minutes, but after some time the receiver ldap authentication
</I>&gt;<i> pop up re-appears, and then again, and again. Not nice.
</I>&gt;<i> 
</I>&gt;<i> Does anyone have squid working to access citrix vpn sites without this
</I>&gt;<i> problem? Do you know what setting to tweak?
</I>&gt;<i> 
</I>&gt;<i> Could it be that the load-balanced setting is provoking this? Should I
</I>&gt;<i> have the haproxy config as a primary/slave instead of both masters?
</I>&gt;<i> 
</I>&gt;<i> This is a piece of the log file:
</I>&gt;<i> 
</I>&gt;<i> 172.20.4.33 - - [16/Dec/2014:14:59:47 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 407 3996 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_DENIED:NONE
</I>&gt;<i> 172.20.4.33 - - [16/Dec/2014:14:59:48 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 407 3996 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_DENIED:NONE
</I>&gt;<i> 172.20.4.33 - - [16/Dec/2014:14:59:48 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 407 3996 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_DENIED:NONE
</I>&gt;<i> 172.20.4.33 - <A HREF="https://lists.squid-cache.org/listinfo/squid-users">user at DOMAIN</A> [16/Dec/2014:15:00:03 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 200 20472 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_MISS:DIRECT
</I>&gt;<i> 172.20.4.33 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">-user at DOMAIN</A> [16/Dec/2014:15:00:03 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 200 41726 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_MISS:DIRECT
</I>&gt;<i> 172.20.4.33 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">-user at DOMAIN</A> [16/Dec/2014:15:00:28 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 200 20447 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_MISS:DIRECT
</I>&gt;<i> 172.20.4.33 - - [16/Dec/2014:15:01:37 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 407 3996 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_DENIED:NONE
</I>&gt;<i> 172.20.4.33 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">-user at DOMAIN</A> [16/Dec/2014:15:01:54 +0100] &quot;CONNECT
</I>&gt;<i> login.site.com:443 HTTP/1.0&quot; 200 32958 &quot;-&quot; &quot;Mozilla/5.0 (compatible;
</I>&gt;<i> MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)&quot; TCP_MISS:DIRECT
</I>&gt;<i> 
</I>&gt;<i> My squid.conf for completeness
</I>&gt;<i> 
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32 ::1
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/squid_kerb_auth -i -s
</I>&gt;<i> HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy.domain.tld at DOMAIN.TLD</A>
</I>&gt;<i> auth_param negotiate children 10
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/lib/squid/squid_ldap_auth -b
</I>&gt;<i> dc=domain,dc=tld -f &quot;samaccountname=%s&quot; -s sub -D user -W
</I>&gt;<i> /etc/squid/squid_ldap_bi
</I>&gt;<i> nd -h dc1.domain.tld,dc2.domain.tld,dc3.domain.tld -p 3268 -Z
</I>&gt;<i> auth_param basic children 10
</I>&gt;<i> auth_param basic realm Proxy LDAP Authentication
</I>&gt;<i> auth_param basic credentialsttl 8 hours
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 1494
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> http_access allow auth
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> # We recommend you to use at least the following line.
</I>&gt;<i> hierarchy_stoplist cgi-bin ?
</I>&gt;<i> 
</I>&gt;<i> logformat combined %&gt;a %ui %un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st
</I>&gt;<i> &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %Ss:%Sh
</I>&gt;<i> access_log /var/log/squid/combined.log combined
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance.
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Groeten,
</I>&gt;<i> natxo
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
citrix sessions are not SSL sessions, so any bumping will need to exempt
the traffic from inspection.  citrix uses some encryption that is not
considered HTTPS/SSL

are you able to implement NTLM?  we dont run squid at work, but i do
force kerberos auth and fallback to ntlm when we have to.  none of the
users have issues with proxy auth in those cases.  not sure if kerberos
or ntlm auth is used.

are the raw citrix ports (1434 or whatever) being used, or is it being
tunneled over 443?  maybe you need to look at the SSL_PORTS list and add
the raw ports to the list.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001130.html">[squid-users] citrix receiver not authenticating with squid
</A></li>
	<LI>Next message (by thread): <A HREF="001123.html">[squid-users] squid rotating between many ips
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1131">[ date ]</a>
              <a href="thread.html#1131">[ thread ]</a>
              <a href="subject.html#1131">[ subject ]</a>
              <a href="author.html#1131">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
