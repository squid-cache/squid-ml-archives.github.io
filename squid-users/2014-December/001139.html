<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Splicing a connection if server cert cannot be verified
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Splicing%20a%20connection%20if%20server%20cert%20cannot%20be%0A%20verified&In-Reply-To=%3CBY2PR03MB364CB522A2CDAFB73417400D56D0%40BY2PR03MB364.namprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001124.html">
   <LINK REL="Next"  HREF="001109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Splicing a connection if server cert cannot be verified</H1>
    <B>Soren Madsen (DREIJER)</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Splicing%20a%20connection%20if%20server%20cert%20cannot%20be%0A%20verified&In-Reply-To=%3CBY2PR03MB364CB522A2CDAFB73417400D56D0%40BY2PR03MB364.namprd03.prod.outlook.com%3E"
       TITLE="[squid-users] Splicing a connection if server cert cannot be verified">sdreijer at microsoft.com
       </A><BR>
    <I>Wed Dec 17 17:25:39 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001124.html">[squid-users] Splicing a connection if server cert cannot be verified
</A></li>
        <LI>Next message (by thread): <A HREF="001109.html">[squid-users] squid_ldap_auth: WARNING,	could not bind to binddn 'Invalid credentials'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1139">[ date ]</a>
              <a href="thread.html#1139">[ thread ]</a>
              <a href="subject.html#1139">[ subject ]</a>
              <a href="author.html#1139">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

&gt;<i> &gt; Yes, but Squid has no way of trusting a self-signed cert. When Squid
</I>&gt;<i> &gt; mints a server cert on the fly and sends it to the client, the client
</I>&gt;<i> &gt; won't have any idea that the cert was originally self-signed. Like the
</I>&gt;<i> &gt; previous scenario, I'd want to step out of the way and defer the
</I>&gt;<i> &gt; decision to the client.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> The global list of CAs which non-self-signed certs validate against is explicitly
</I>&gt;<i> loaded into the SSL library. It is not a built-in list.
</I>&gt;<i> 
</I>&gt;<i> All you have to do to trust a &quot;self-signed&quot; cert is add the CA signing it to your
</I>&gt;<i> trusted set.
</I>
I don't think you quite understand what I'm saying here. I can't run around and add new self-signed certs to Squid every time users discover broken sites; even worse, for SSLv3 connections, there's nothing &quot;to add&quot; that will fix future connections apart from permanently exempting the target site from bumping.

I want to bump connections ONLY when I can do so reliably, i.e. when I trust the server's cert and the connection is not SSLv3. In all other cases, I want to bail out and let the client decide what to do. The self-signed cert might be expected and trusted by the client depending on the target site. This way, my proxy isn't degrading connectivity for users and I get extra visibility into most connections by applying bumping opportunistically.
 
&gt;<i> &gt;&gt; AIUI, the basic problem that &quot;precludes bumping&quot; is that in order to
</I>&gt;<i> &gt;&gt; peek at the serverHello some clientHello has to already have been
</I>&gt;<i> &gt;&gt; sent. Squid is already locked into using the features advertised in
</I>&gt;<i> &gt;&gt; that clientHello or dying - with no middle ground.
</I>&gt;<i> &gt;&gt; Most times the client and Squid do not actually have identical
</I>&gt;<i> &gt;&gt; capabilities so peeking the serverHello then either bump or splice
</I>&gt;<i> &gt;&gt; actions will break depending on which clientHello Squid sent.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I don't see why that is a problem if you just recreate the connection
</I>&gt;<i> &gt; to the server. That is, you first try bumping the connection by
</I>&gt;<i> &gt; sending a new clientHello to the server, and if the server cert cannot
</I>&gt;<i> &gt; be verified, a new connection is established and the original
</I>&gt;<i> &gt; clientHello is sent to the server.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> &quot;just&quot; recreating the connection to the server means discarding the old one.
</I>&gt;<i> Which is not anywhere near as nice a proposition once you look beyond the
</I>&gt;<i> single proxy.
</I>&gt;<i> 
</I>&gt;<i> The details, you can skip if you want to avoid...
</I>&gt;<i> 
</I>&gt;<i> * Each aborted connection means 15 minutes TCP TIME_WAIT delay before
</I>&gt;<i> that TCP socket can be re-used.
</I>&gt;<i> 
</I>&gt;<i> * TCP/IP limits software to 63K sockets per IP address (64K total with
</I>&gt;<i> 1024 reserved).
</I>&gt;<i> 
</I>&gt;<i> Using multiple outbound connections to discover some behaviour is what the
</I>&gt;<i> browser &quot;happy eyeballs&quot; algoithm is all about. They are just looking for
</I>&gt;<i> connectino handshake speed rather than cert properties.
</I>&gt;<i> 
</I>&gt;<i> - - Browsers are operating on rate of 10's to hundreds of single requests per
</I>&gt;<i> minute. With all 64K per-IP sockets on that machine dedicated to the one
</I>&gt;<i> end user.
</I>&gt;<i> 
</I>&gt;<i> - - Proxies are individually dealing with requests on the rate of 10's or 100's of
</I>&gt;<i> thousand requests per minute. Sharing socets between hundreds or
</I>&gt;<i> thousands of end-users.
</I>&gt;<i> 
</I>&gt;<i> At that speed 64K sockets per IP address are consumed very quickly already.
</I>&gt;<i> Squid is limited to a very few over 10K new connections/minute per IP
</I>&gt;<i> address on the machine. We get away with higher rates by having HITs,
</I>&gt;<i> collapsed-forwarding and by multiplexing requests onto server connections.
</I>&gt;<i>  =&gt; multiplex is the biggest gainer which is not possible with HTTPS traffic,
</I>&gt;<i> despite bumping.
</I>
Like you just mentioned, Squid's clever socket sharing algorithms cannot be used for HTTPS traffic, so I don't quite understand the argument you're making here. If Squid has to terminate a connection because it doesn't trust the target server due to a bad cert, that connection will be subject to the TCP TIME_WAIT delay anyway. Squid might as well note the fact that the site is broken in a cache somewhere, so that the next time a connection is established to that same host, Squid won't try to bump the connection.

&gt;<i> It is a little bit safer to allow Squid to use SSLv3 to servers which are still
</I>&gt;<i> broken, than to allow clients to SSLv3 to Squid. At least half of the
</I>&gt;<i> connectivity you have soemthign to do with becomes trustworthy even
</I>&gt;<i> though the overall end-2-end security is no better (yet).
</I>
Perhaps, but then again, not really. :) It gives the user a false sense of security when it looks like they are connected to a server with TLS 1.2 when half of the connection is in fact done over SSLv3.

Let me try to reset the conversation here a bit: 

Given my goal of opportunistically bumping connections and avoid degrading connectivity for the users of the proxy in cases where I can't successfully bump a connection, what would you do to achieve this?

Thanks,
Soren

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001124.html">[squid-users] Splicing a connection if server cert cannot be verified
</A></li>
	<LI>Next message (by thread): <A HREF="001109.html">[squid-users] squid_ldap_auth: WARNING,	could not bind to binddn 'Invalid credentials'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1139">[ date ]</a>
              <a href="thread.html#1139">[ thread ]</a>
              <a href="subject.html#1139">[ subject ]</a>
              <a href="author.html#1139">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
