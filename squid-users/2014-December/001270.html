<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Skype bypass using ssl_bump peek
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20bypass%20using%20ssl_bump%20peek&In-Reply-To=%3C54A2DDE8.8050704%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001134.html">
   <LINK REL="Next"  HREF="001089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Skype bypass using ssl_bump peek</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20bypass%20using%20ssl_bump%20peek&In-Reply-To=%3C54A2DDE8.8050704%40measurement-factory.com%3E"
       TITLE="[squid-users] Skype bypass using ssl_bump peek">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Dec 30 17:16:24 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001134.html">[squid-users] Skype bypass using ssl_bump peek
</A></li>
        <LI>Next message (by thread): <A HREF="001089.html">[squid-users] ICAP: how to get port of X-Client-IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1270">[ date ]</a>
              <a href="thread.html#1270">[ thread ]</a>
              <a href="subject.html#1270">[ subject ]</a>
              <a href="author.html#1270">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/12/2014 02:31 AM, Yu-Hsuan Liao wrote:

&gt;<i> I'm trying to using Squid 3.5's new feature peek-and-splice to bypass
</I>&gt;<i> Skype connection
</I>&gt;<i> I'm a little confused about ssl_bump steps,
</I>&gt;<i> the wiki says that
</I>&gt;<i> 
</I>&gt;<i> peek Receive client (step SslBump1) or server (step SslBump2)
</I>&gt;<i> certificate while preserving the possibility of splicing the
</I>&gt;<i> connection.
</I>

&gt;<i> My question is: does ssl_bump make decision to bump or splice connection
</I>&gt;<i> when Squid gets the ServerHello message?
</I>
Squid makes the final decision to bump (or splice) the connection when
the first ssl_bump bump (or ssl_bump splice) rule matches. Whether that
final rule matches during step1, step2, or step3 depends on how you
write your ssl_bump configuration (and on traffic).


The peek/stare actions are for receiving information from client and
server. Due to how SSL is designed, these actions usually have side
effects as detailed on the wiki page: peeking usually implies eventual
splicing and staring usually implies eventual bumping. Thus, you have to
be careful how you get the information you need.


&gt;<i> cos I found that Skype voice connection is first
</I>&gt;<i> 
</I>&gt;<i> 1. client send Clien tHello
</I>&gt;<i> 2. server send Server Hello
</I>&gt;<i> 
</I>&gt;<i> then began the skype data payload transmit(non-SSL format, not the
</I>&gt;<i> rest SSL handshake)
</I>&gt;<i> 
</I>&gt;<i> so that I still got the &quot;Error negotiating SSL connection on FD&quot;
</I>&gt;<i> message in cache.log
</I>&gt;<i> 
</I>&gt;<i> Does peek-and-splice function cover above situation, or I just
</I>&gt;<i> misunderstand the usage of ssl_bump peek?
</I>
If Skype client and server Hello information is standard (supported by
OpenSSL), then splicing connection should work at step1 or step2. For
example, the following configurations should work:

  ssl_bump splice isSkype
  ...

or

  ssl_bump peek all
  ssl_bump splice isSkype
  ...

where &quot;isSkype&quot; is your custom ACL that matches Skype traffic. It is
difficult to write such an ACL, as discussed below.


If those Hello exchanges are not supported by OpenSSL, then you must
splice at step1 without peeking:

  ssl_bump splice isSkype
  ...



&gt;<i> acl skype_list dstdomain &quot;skype_list&quot;
</I>&gt;<i> ssl_bump peek skype_list
</I>&gt;<i> ssl_bump stare all
</I>
This configuration will most likely not work because you are staring
(which usually implies eventual bumping) at step2. You cannot bump a
non-SSL connection. Moreover, I would be concerned about dstdomain
matching at step1 where Squid has access to CONNECT (forward proxy) or
TCP-level (intercepting proxy) information only and may be forced to do
a reverse DNS lookup.


The proper way to handle all this complexity is via automatic
non-HTTP/non-SSL traffic bypass rather than hand-written rules that try
to identify such traffic on a case-by-case basis. Unfortunately, the
corresponding Squid feature got stuck in Squid Project review for a few
months now. We have not given up on it though.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001134.html">[squid-users] Skype bypass using ssl_bump peek
</A></li>
	<LI>Next message (by thread): <A HREF="001089.html">[squid-users] ICAP: how to get port of X-Client-IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1270">[ date ]</a>
              <a href="thread.html#1270">[ thread ]</a>
              <a href="subject.html#1270">[ subject ]</a>
              <a href="author.html#1270">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
