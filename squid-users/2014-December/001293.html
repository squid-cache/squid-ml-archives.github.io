<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3 SSL bump: Google drive application could not connect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203%20SSL%20bump%3A%20Google%20drive%20application%20could%0A%20not%20connect&In-Reply-To=%3C54A3E763.7080909%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001292.html">
   <LINK REL="Next"  HREF="001288.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3 SSL bump: Google drive application could not connect</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203%20SSL%20bump%3A%20Google%20drive%20application%20could%0A%20not%20connect&In-Reply-To=%3C54A3E763.7080909%40gmail.com%3E"
       TITLE="[squid-users] Squid 3 SSL bump: Google drive application could not connect">yvoinov at gmail.com
       </A><BR>
    <I>Wed Dec 31 12:09:07 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001292.html">[squid-users] Squid 3 SSL bump: Google drive application could not connect
</A></li>
        <LI>Next message (by thread): <A HREF="001288.html">[squid-users] Squid Deployment Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1293">[ date ]</a>
              <a href="thread.html#1293">[ thread ]</a>
              <a href="subject.html#1293">[ subject ]</a>
              <a href="author.html#1293">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1
 
Also, finally, gents.

Google Drive application uses network:

# Google Drive
74.125.201.0/24

in my region. ;)

So to bypass bump you must specify this network as dst with no bumping.

WBR, Yuri

31.12.2014 18:00, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A> &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Send squid-users mailing list submissions to
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> To subscribe or unsubscribe via the World Wide Web, visit
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> or, via email, send a message with subject or body 'help' to
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> You can reach the person managing the list at
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-owner at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> When replying, please edit your Subject line so it is more specific
</I>&gt;<i> than &quot;Re: Contents of squid-users digest...&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Today's Topics:
</I>&gt;<i>
</I>&gt;<i>    1. Re: Squid Deployment Questions (Amos Jeffries)
</I>&gt;<i>    2. Re: Squid 3 SSL bump: Google drive application could not
</I>&gt;<i>       connect (James Harper)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> Message: 1
</I>&gt;<i> Date: Wed, 31 Dec 2014 22:55:18 +1300
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Squid Deployment Questions
</I>&gt;<i> Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">54A3C806.4010405 at treenet.co.nz</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=utf-8
</I>&gt;<i>
</I>&gt;<i> On 31/12/2014 6:59 p.m., Evan Blackstone wrote:
</I>&gt;<i> &gt; Hey all, Wondering if I could get some advice on potentially
</I>&gt;<i> &gt; setting up a Squid forward proxy on my network. I'm not a Linux
</I>&gt;<i> &gt; novice by any means, but I'm not experienced in server
</I>&gt;<i> &gt; administration, log review, etc.
</I>&gt;<i>
</I>&gt;<i> &gt; We're needing to deploy a simple non-caching, non-peering forward
</I>&gt;<i> &gt; proxy to integrate with an ICAP server for web filtering. My plan
</I>&gt;<i> &gt; is pretty basic...here's my network config:
</I>&gt;<i>
</I>&gt;<i> &gt; Internet --&gt; Cisco ASA --&gt; DMZ --&gt; Internal LAN
</I>&gt;<i>
</I>&gt;<i> &gt; I've received conflicting advice on whether or not there's any
</I>&gt;<i> &gt; advantage to putting a forward proxy on the DMZ vs. internal LAN.
</I>&gt;<i> &gt; In any case, 'm wanting to deploy an explicit proxy with a single
</I>&gt;<i> &gt; NIC. Workstations will use a PAC file, etc. to point to the proxy.
</I>&gt;<i>
</I>&gt;<i> &gt; If the server is on the DMZ, I'd allow 80/443 from the internal LAN
</I>&gt;<i> &gt; to the DMZ, then allow 80/443 from the proxy to outside. I'd also
</I>&gt;<i> &gt; be allowing the proxy to internal LAN for ICAP, syslog, and
</I>&gt;<i> &gt; possibly NTP. The proxy would have a single interface...although it
</I>&gt;<i> &gt; would NAT to outside for internet access, there would be no ports
</I>&gt;<i> &gt; open on the outside interface.
</I>&gt;<i>
</I>&gt;<i> Like Eliezer mentioned if ICAP services are in the LAN place the proxy
</I>&gt;<i> there. Placing the proxy in the DMZ if ICAP services are in the LAN
</I>&gt;<i> means the traffic has to flow across the DMZ&lt;-&gt;LAN pathways three
</I>&gt;<i> times - limiting your traffic to 1/3 of line speed on the slowest NIC
</I>&gt;<i> along the way.
</I>&gt;<i>
</I>&gt;<i> Similarly using a single NIC machine means the HTTP traffic through
</I>&gt;<i> the proxy is already limited to 1.2 the speed of that NIC. If it's not
</I>&gt;<i> a Gbit NIC then using two NIC (for separate inbound and outbound
</I>&gt;<i> flows) will allow Squid to run at capacity - which is somewhat over
</I>&gt;<i> 50Mbps these days and increasing a little each release.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Based on some testing I've done, my squid.conf would be pretty
</I>&gt;<i> &gt; basic...
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow internalnetwork cache deny internalnetwork
</I>&gt;<i> &gt; always_direct allow internalnetwork http_access deny all etc.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No need for always_direct. Nor for &quot;cache deny internalnetwork&quot;.
</I>&gt;<i>
</I>&gt;<i> You could use &quot;cache deny all&quot; to prevent all HTTP caching but a small
</I>&gt;<i> amount of memory-only cache is good for improving responses to the
</I>&gt;<i> topmost popular URLs. Squid has a default 256MB of memory cache to
</I>&gt;<i> store approx 10K objects (cache_mem directive).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; My questions are:
</I>&gt;<i>
</I>&gt;<i> &gt; Does it sound like I'm on the right track here? Would the above
</I>&gt;<i> &gt; described configuration be safe? I've read that Squid should listen
</I>&gt;<i> &gt; only on an internal interface? What about when the server only has
</I>&gt;<i> &gt; one?
</I>&gt;<i>
</I>&gt;<i> Use the default squid.conf as a basis and extend as necessary. It has
</I>&gt;<i> the basic security measures that are important. For a quick start you
</I>&gt;<i> only need to ensure *localnet* ACL is defined with your LAN IP ranges
</I>&gt;<i> and you are good to go as a forward proxy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Internal/external interface makes no difference when there is only one
</I>&gt;<i> NIC.
</I>&gt;<i>
</I>&gt;<i> The default config is safe enough to reject traffic from external
</I>&gt;<i> sources (non-localnet), but you can be extra sure with either a
</I>&gt;<i> firewall block in the routers preventing non-LAN connections inbound
</I>&gt;<i> to the proxy machine.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; What level of risk would I be assuming (regular patching included)?
</I>&gt;<i> &gt; Given that I'm relatively new to monitoring Linux servers for
</I>&gt;<i> &gt; security, etc., is this a bad idea? I'm not really sure what to be
</I>&gt;<i> &gt; looking for log-wise in terms of compromise. I have edge devices
</I>&gt;<i> &gt; and monitoring on the perimeter, but I don't really know what to
</I>&gt;<i> &gt; look for on the server itself...
</I>&gt;<i>
</I>&gt;<i> Squid is one of (if not The) most hardened proxies available. It can
</I>&gt;<i> basically only be compromised in two ways:
</I>&gt;<i> 1) corruption of cached objects - you dont have any on disk, and
</I>&gt;<i> avoiding the refresh_pattern override/ignores removes the risk of
</I>&gt;<i> memory objects corruption.
</I>&gt;<i>
</I>&gt;<i> 2) infection of the binaries that make up Squid - this is not
</I>&gt;<i> detectable from within Squid anyway. A system AV scanner (or regular
</I>&gt;<i> update schedule) is required for that.
</I>&gt;<i>
</I>&gt;<i> Squid does crash in a numer of ways, but that is a fail-closed DoS
</I>&gt;<i> type event rather than compromise.
</I>&gt;<i>
</I>&gt;<i> * You should monitor cache.log for anything that mentions &quot;assertion&quot;
</I>&gt;<i> or &quot;FATAL&quot;. These are Squid bugs and self-DoS vulnerability. We are
</I>&gt;<i> always interested in finding out how these happen and fixing.
</I>&gt;<i>
</I>&gt;<i> * access.log monitoring is a possibility. One can usually find web
</I>&gt;<i> exploits being attempted on *other* services in a Squid access.log, so
</I>&gt;<i> monitoring it like one woud la web server log for suspicious URL
</I>&gt;<i> requests can be useful to proactively identify compromised clients.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Safe_ports and SSL_ports ACLs in the default config map out blocks
</I>&gt;<i> on the ports with known security issues.
</I>&gt;<i>
</I>&gt;<i> You may have clients with web apps needing special ports accessible
</I>&gt;<i> via CONNECT. Take the usual due-diligence there as if you were opening
</I>&gt;<i> a firewall port for unrestricted use, then if you wish add the port
</I>&gt;<i> number to SSL_ports ACL (Safe_ports should already be open for 1024 or
</I>&gt;<i> larger port numbers).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You can enable the to_localhost rules which are commented out by
</I>&gt;<i> default to protect against clients accessing services on the Squid
</I>&gt;<i> machine itself (if any exist accessible over localhost interface).
</I>&gt;<i> Though on a dedicated proxy the SSL_Ports rule should already be
</I>&gt;<i> taking care of that.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Am I approaching this the wrong way? Should I be looking at putting
</I>&gt;<i> &gt; it on the inside LAN? Would such an approach leave my network
</I>&gt;<i> &gt; vulnerable should the Squid box get owned?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Since the purpose of a proxy is to be reachable from LAN clients the
</I>&gt;<i> security impact on Squid itself is no different in either position.
</I>&gt;<i>
</I>&gt;<i> The security balance is betweeen whether the rest of the machine
</I>&gt;<i> access methods (including the ICAP servers security &quot;footprint&quot;) are
</I>&gt;<i> more/worse secure in either position vs the traffic costs mentioned above.
</I>&gt;<i>
</I>&gt;<i> NP: ICAP servers and particularly the unencrypted TCP connections to
</I>&gt;<i> them are the weakest point, since they have the ability to alter the
</I>&gt;<i> HTTP traffic contents in arbitrary ways. Explicitly not touching the
</I>&gt;<i> traffic content is one of the security hardening aspects of Squid.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Message: 2
</I>&gt;<i> Date: Wed, 31 Dec 2014 11:11:36 +0000
</I>&gt;<i> From: James Harper &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">james at ejbdigital.com.au</A>&gt;
</I>&gt;<i> To: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&quot;
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] Squid 3 SSL bump: Google drive application
</I>&gt;<i>     could not connect
</I>&gt;<i> Message-ID:
</I>&gt;<i>    
</I>&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">HKNPR04MB1933D74D5F5A53D56ED20C8E85F0 at HKNPR04MB193.apcprd04.prod.outlook.com</A>&gt;
&gt;<i>    
</I>&gt;<i> Content-Type: text/plain; charset=&quot;utf-8&quot;
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Probably non-HTTPS protocol being used.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As bumping gets more popular we are hearing about a number of services
</I>&gt;&gt;<i> abusing port 443 for non-HTTPS protocols on the false assumption that
</I>&gt;&gt;<i> the TLS layer goes all the way to the origin server without
</I>&gt;&gt;<i> inspection. That has never been a true assumption, CDN frontends have
</I>&gt;&gt;<i> always decrypted.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I've mentioned it before, and it's been pointed out that it probably
</I>doesn't scale, but I wrote a callout helper for this reason and for
better logging.
&gt;<i>
</I>&gt;<i> Basically:
</I>&gt;<i>
</I>&gt;<i> external_acl_type cert_callout concurrency=20 %DST %PORT
</I>/usr/local/squid/libexec/ext_cert_callout_acl
&gt;<i> acl is_ssl external cert_callout IS_SSL
</I>&gt;<i> ssl_bump bump is_ssl
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> The helper connects to the IP:port and tries to obtain the
</I>certificate, and then caches the result (in an sqlite database). If it
can't do so within a fairly short time it returns failure (but keeps
trying a bit longer and caches it for next time). Alternatively if the
IP used to be SSL but is now timing out it returns the previously cached
value. Negative results are cached for an increasing amount of time each
time it fails, on the basis that it probably isn't SSL.
&gt;<i>
</I>&gt;<i> So it's somewhat optimistic - on a slow link or for a slow server a
</I>given IP:port might be spliced the first time when it should be bumped,
but it will learn fairly quickly. And for non-SSL connections that
appear to just hang in response to the request there will be an
additional delay the first time. But otherwise it learns about the
target without requiring admin intervention.
&gt;<i>
</I>&gt;<i> It also returns the name of the cert so it can be logged instead of
</I>the IP (for transparent connections), although that isn't ideal as the
same IP might be used for many services (google/youtube/etc)
&gt;<i>
</I>&gt;<i> I can post it if anyone is interested, although it would require a bit
</I>of work to be completely useful.
&gt;<i>
</I>&gt;<i> James
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Subject: Digest Footer
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> End of squid-users Digest, Vol 4, Issue 75
</I>&gt;<i> ******************************************
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBAgAGBQJUo+djAAoJENNXIZxhPexGcEAH/Ap3Vx/czpznQaAAtKoeHK/k
6NXQTJVYxC5FkSV9S4UXGjp+DcWd4bIsIPC0oZ0ZJ7W67d98qC0lP3ciC6rBwPnB
cV9pzA2ewL73dWQJOwd1rtX44ZVvAgA9uDlg0zW7ZDrrefw1ACxgPvD2Ta2EHNsI
QD8FwMSA7I5IGc2jgYeL0uILnWX64BuTUw/r1zIbm6uMaRERjxWOujNGNgu6ToRL
GKOwdxbZIDGBKYo8LmYG1gv5urvVVtZ2ghpZN9iyFrdSmpBNU9wyPc/OssowY0jX
5Qy9qQD5xWlYpsslivS90WzXdgMpd+n0livRpfIXUStTu6r3juTt34awAG9MzF4=
=QCIn
-----END PGP SIGNATURE-----

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20141231/c9de397b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20141231/c9de397b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001292.html">[squid-users] Squid 3 SSL bump: Google drive application could not connect
</A></li>
	<LI>Next message (by thread): <A HREF="001288.html">[squid-users] Squid Deployment Questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1293">[ date ]</a>
              <a href="thread.html#1293">[ thread ]</a>
              <a href="subject.html#1293">[ subject ]</a>
              <a href="author.html#1293">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
