<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3 SSL bump: Google drive application could not connect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203%20SSL%20bump%3A%20Google%20drive%20application%20could%0A%20not%20connect&In-Reply-To=%3CAM3PR04MB450807CF39B164A9ABB1E7F8F5F0%40AM3PR04MB450.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001291.html">
   <LINK REL="Next"  HREF="001265.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3 SSL bump: Google drive application could not connect</H1>
    <B>Rafael Akchurin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203%20SSL%20bump%3A%20Google%20drive%20application%20could%0A%20not%20connect&In-Reply-To=%3CAM3PR04MB450807CF39B164A9ABB1E7F8F5F0%40AM3PR04MB450.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] Squid 3 SSL bump: Google drive application could not connect">rafael.akchurin at diladele.com
       </A><BR>
    <I>Wed Dec 31 13:11:08 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001291.html">[squid-users] Squid 3 SSL bump: Google drive application could not connect
</A></li>
        <LI>Next message (by thread): <A HREF="001265.html">[squid-users] Squid 3 SSL bump: Google drive application could not	connect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1295">[ date ]</a>
              <a href="thread.html#1295">[ thread ]</a>
              <a href="subject.html#1295">[ subject ]</a>
              <a href="author.html#1295">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please James do if it is possible.

Best regards,
Rafael

-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of James Harper
Sent: Wednesday, December 31, 2014 12:12 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid 3 SSL bump: Google drive application could not connect

&gt;<i> 
</I>&gt;<i> Probably non-HTTPS protocol being used.
</I>&gt;<i> 
</I>&gt;<i> As bumping gets more popular we are hearing about a number of services 
</I>&gt;<i> abusing port 443 for non-HTTPS protocols on the false assumption that 
</I>&gt;<i> the TLS layer goes all the way to the origin server without 
</I>&gt;<i> inspection. That has never been a true assumption, CDN frontends have 
</I>&gt;<i> always decrypted.
</I>&gt;<i> 
</I>
I've mentioned it before, and it's been pointed out that it probably doesn't scale, but I wrote a callout helper for this reason and for better logging.

Basically:

external_acl_type cert_callout concurrency=20 %DST %PORT /usr/local/squid/libexec/ext_cert_callout_acl
acl is_ssl external cert_callout IS_SSL
ssl_bump bump is_ssl
ssl_bump splice all

The helper connects to the IP:port and tries to obtain the certificate, and then caches the result (in an sqlite database). If it can't do so within a fairly short time it returns failure (but keeps trying a bit longer and caches it for next time). Alternatively if the IP used to be SSL but is now timing out it returns the previously cached value. Negative results are cached for an increasing amount of time each time it fails, on the basis that it probably isn't SSL.

So it's somewhat optimistic - on a slow link or for a slow server a given IP:port might be spliced the first time when it should be bumped, but it will learn fairly quickly. And for non-SSL connections that appear to just hang in response to the request there will be an additional delay the first time. But otherwise it learns about the target without requiring admin intervention.

It also returns the name of the cert so it can be logged instead of the IP (for transparent connections), although that isn't ideal as the same IP might be used for many services (google/youtube/etc)

I can post it if anyone is interested, although it would require a bit of work to be completely useful.

James

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001291.html">[squid-users] Squid 3 SSL bump: Google drive application could not connect
</A></li>
	<LI>Next message (by thread): <A HREF="001265.html">[squid-users] Squid 3 SSL bump: Google drive application could not	connect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1295">[ date ]</a>
              <a href="thread.html#1295">[ thread ]</a>
              <a href="subject.html#1295">[ subject ]</a>
              <a href="author.html#1295">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
