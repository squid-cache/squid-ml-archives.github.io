<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Correctly implementing peak-splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Correctly%20implementing%20peak-splice&In-Reply-To=%3C1415019600.2899.11.camel%40JamesiMac%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000589.html">
   <LINK REL="Next"  HREF="000602.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Correctly implementing peak-splice</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Correctly%20implementing%20peak-splice&In-Reply-To=%3C1415019600.2899.11.camel%40JamesiMac%3E"
       TITLE="[squid-users] Correctly implementing peak-splice">jlay at slave-tothe-box.net
       </A><BR>
    <I>Mon Nov  3 13:00:00 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000589.html">[squid-users] Correctly implementing peak-splice
</A></li>
        <LI>Next message (by thread): <A HREF="000602.html">[squid-users] Correctly implementing peak-splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#593">[ date ]</a>
              <a href="thread.html#593">[ thread ]</a>
              <a href="subject.html#593">[ subject ]</a>
              <a href="author.html#593">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2014-11-03 at 12:24 +0200, Christos Tsantilas wrote:
&gt;<i> On 10/30/2014 02:06 PM, James Lay wrote:
</I>&gt;<i> &gt; Hello all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here is my complete config for trying out peek/splice.  This currently
</I>&gt;<i> &gt; does not work..is there something obvious that I'm mission?  Current
</I>&gt;<i> &gt; error is:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Oct 30 06:03:14 gateway squid: 192.168.1.110 - - [30/Oct/2014:06:03:14
</I>&gt;<i> &gt; -0600] &quot;GET <A HREF="https://www.google.com/">https://www.google.com/</A> HTTP/1.1&quot; 503 3854
</I>&gt;<i> &gt; TAG_NONE:HIER_NONE
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; and on the page I get a 71 protocol error and a SSL3_WRITE_PENDING:bad
</I>&gt;<i> &gt; write retry.
</I>&gt;<i> 
</I>&gt;<i> - You should use at_step acl to configure different bumping modes on 
</I>&gt;<i> each bumping step.
</I>&gt;<i> 
</I>&gt;<i> - If you used &quot;peek&quot; mode on SslBump1 and SslBump2 steps then on 
</I>&gt;<i> SslBump3 step you should use &quot;splice&quot;. If you select &quot;bump&quot; the most 
</I>&gt;<i> possible is that you got SSL connection errors.
</I>&gt;<i> The &quot;peek&quot; mode on SslBump3 step is interpreted as &quot;bump&quot; mode.
</I>&gt;<i> 
</I>&gt;<i> -if you selected peek mode on SslBump1 and SslBump2 steps, in most 
</I>&gt;<i> cases, you can select only &quot;terminate&quot; or &quot;splice&quot; for SslBump3 step.
</I>&gt;<i> 
</I>&gt;<i> The following configuration should work:
</I>&gt;<i> 
</I>&gt;<i> # Bumping steps:
</I>&gt;<i> acl step1 at_step  SslBump1
</I>&gt;<i> acl step2 at_step  SslBump2
</I>&gt;<i> acl step3 at_step  SslBump3
</I>&gt;<i> 
</I>&gt;<i> # Selecting bumping mode
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 all
</I>&gt;<i> ssl_bump splice step3 all
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i>      Christos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
Thanks Christos,

So here's where I'm at...my full test config below:

acl localnet src 192.168.1.0/24

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 777         # multiling http

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

acl CONNECT method CONNECT
acl allowed_sites url_regex &quot;/opt/etc/squid/url.txt&quot;
acl all_others dst all
acl SSL method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access allow manager localhost
http_access deny manager

http_access allow allowed_sites
http_access deny all_others
http_access allow localnet
http_access allow localhost

http_access deny all
icp_access deny all

sslproxy_cert_error allow all

sslproxy_options ALL
sslproxy_flags DONT_VERIFY_PEER

ssl_bump peek step1 all
ssl_bump peek step2 all
ssl_bump splice step3 all

http_port 192.168.1.253:3128 intercept
https_port 192.168.1.253:3129 intercept ssl-bump
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
cert=/opt/sslsplit/sslsplit.crt key=/opt/sslsplit/sslsplitca.key
options=ALL sslflags=NO_SESSION_REUSE

always_direct allow all

logformat common %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st %Ss:%
Sh %ssl::&gt;cert_subject

access_log syslog:daemon.info common

The above works, but allows all sites regardless of what's in url.txt.
Additionally, there's no logging of any kind.  The allow part makes
sense as this is the last ACL, the no logging part is confusing.  If I
add:

acl broken_sites dst 69.25.139.128/25
acl broken_sites dst 65.55.0.0/16
acl broken_sites dst 72.246.0.0/16
acl broken_sites dst 54.224.0.0/12
acl broken_sites dst 17.0.0.0/8
acl broken_sites dst 69.192.0.0/16
acl broken_sites dst 209.59.128.0/18
acl broken_sites dst 173.194.0.0/16
acl broken_sites dst 107.20.0.0/14
acl broken_sites dst 54.72.0.0/13
acl broken_sites dst 54.80.0.0/12
acl broken_sites dst 23.0.0.0/12
acl broken_sites dst 23.192.0.0/11
acl broken_sites dst 8.25.205.0/24
acl broken_sites dst 75.126.0.0/16
acl broken_sites dst 74.125.0.0/16
acl broken_sites dst 192.195.204.0/24
acl broken_sites dst 96.16.0.0/15

and change to
ssl_bump peek step1 broken_sites
ssl_bump peek step2 broken_sites
ssl_bump splice step3 broken_sites

that works, but again...I get no logging, which is worse then &quot;ssl_bump
splice broken_sites&quot;, and defeats the purpose of trying to avoid having
to create the broken_sites ACL in the first place.  Lastly, if I try and
change splice to peek or bump it's broken with odd log entries such as:

Nov  3 05:45:23 gateway (squid-1): 192.168.1.110 - -
[03/Nov/2014:05:45:23 -0700] &quot;GET <A HREF="https://www.google.com/">https://www.google.com/</A> HTTP/1.1&quot; 503
3854 TAG_NONE:HIER_NONE -
Nov  3 05:45:31 gateway (squid-1): 192.168.1.110 - -
[03/Nov/2014:05:45:31 -0700] &quot;CONNECT 206.190.36.45:443 HTTP/1.1&quot; 403
3402 TCP_DENIED:HIER_NONE -
Nov  3 05:45:31 gateway (squid-1): 192.168.1.110 - -
[03/Nov/2014:05:45:31 -0700] &quot;#026#003#001 %BB/%CESsJ%B3%C2%BC%CC%BD%90
HTTP/1.1&quot; 400 3577 TAG_NONE:HIER_NONE -

Is there something I am missing?  I've been really reading through the
squid site, but I can't find any examples of peek splice.  Thank you.

James


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000589.html">[squid-users] Correctly implementing peak-splice
</A></li>
	<LI>Next message (by thread): <A HREF="000602.html">[squid-users] Correctly implementing peak-splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#593">[ date ]</a>
              <a href="thread.html#593">[ thread ]</a>
              <a href="subject.html#593">[ subject ]</a>
              <a href="author.html#593">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
