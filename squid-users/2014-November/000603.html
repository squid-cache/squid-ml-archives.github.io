<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Correctly implementing peak-splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Correctly%20implementing%20peak-splice&In-Reply-To=%3C1415103984.2837.13.camel%40JamesiMac%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000602.html">
   <LINK REL="Next"  HREF="000627.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Correctly implementing peak-splice</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Correctly%20implementing%20peak-splice&In-Reply-To=%3C1415103984.2837.13.camel%40JamesiMac%3E"
       TITLE="[squid-users] Correctly implementing peak-splice">jlay at slave-tothe-box.net
       </A><BR>
    <I>Tue Nov  4 12:26:24 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000602.html">[squid-users] Correctly implementing peak-splice
</A></li>
        <LI>Next message (by thread): <A HREF="000627.html">[squid-users] Correctly implementing peak-splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#603">[ date ]</a>
              <a href="thread.html#603">[ thread ]</a>
              <a href="subject.html#603">[ subject ]</a>
              <a href="author.html#603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2014-11-04 at 12:32 +0200, Christos Tsantilas wrote:
&gt;<i> On 11/03/2014 03:00 PM, James Lay wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks Christos,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So here's where I'm at...my full test config below:
</I>&gt;<i> &gt; ......
</I>&gt;<i> &gt;......
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; logformat common %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st %Ss:%
</I>&gt;<i> &gt; Sh %ssl::&gt;cert_subject
</I>&gt;<i> 
</I>&gt;<i> The %ssl::&gt;cert_subject will print the subject of the client 
</I>&gt;<i> certificate, if there is any. In most cases the client does not sent any 
</I>&gt;<i> certificate.
</I>&gt;<i> Logging the server certificate subject is not yet implemented.
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The above works, but allows all sites regardless of what's in url.txt.
</I>&gt;<i> 
</I>&gt;<i> If you want to use a list of urls to restrict sites which should bumped 
</I>&gt;<i> you should use an external_acl helper.
</I>&gt;<i> You can send to the external_acl helpers the client SNI informations (on 
</I>&gt;<i> at_step SslBump2) and/OR the server certificate subject (on at_step 
</I>&gt;<i> SslBump3).
</I>&gt;<i> 
</I>&gt;<i> &gt; Additionally, there's no logging of any kind.  The allow part makes
</I>&gt;<i> &gt; sense as this is the last ACL, the no logging part is confusing.  If I
</I>&gt;<i> &gt; add:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl broken_sites dst 69.25.139.128/25
</I>&gt;<i> &gt; acl .....
</I>&gt;<i>  &gt; .....
</I>&gt;<i> &gt; and change to
</I>&gt;<i> &gt; ssl_bump peek step1 broken_sites
</I>&gt;<i> &gt; ssl_bump peek step2 broken_sites
</I>&gt;<i> &gt; ssl_bump splice step3 broken_sites
</I>&gt;<i> 
</I>&gt;<i> This is will splice any connection to broken_sites and will not bump any 
</I>&gt;<i> other request.
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; that works, but again...I get no logging, which is worse then &quot;ssl_bump
</I>&gt;<i> &gt; splice broken_sites&quot;, and defeats the purpose of trying to avoid having
</I>&gt;<i> &gt; to create the broken_sites ACL in the first place.  Lastly, if I try and
</I>&gt;<i> &gt; change splice to peek or bump it's broken with odd log entries such as:
</I>&gt;<i> 
</I>&gt;<i> Will help if you describe what are you trying to do.
</I>&gt;<i> The acl broken_sites includes only IP addresses. Looks that the 
</I>&gt;<i> peek-and-splice is not needed in your application.
</I>&gt;<i> You can just use &quot;ssl_bump none broken_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Nov  3 05:45:23 gateway (squid-1): 192.168.1.110 - -
</I>&gt;<i> &gt; [03/Nov/2014:05:45:23 -0700] &quot;GET <A HREF="https://www.google.com/">https://www.google.com/</A> HTTP/1.1&quot; 503
</I>&gt;<i> &gt; 3854 TAG_NONE:HIER_NONE -
</I>&gt;<i> &gt; Nov  3 05:45:31 gateway (squid-1): 192.168.1.110 - -
</I>&gt;<i> &gt; [03/Nov/2014:05:45:31 -0700] &quot;CONNECT 206.190.36.45:443 HTTP/1.1&quot; 403
</I>&gt;<i> &gt; 3402 TCP_DENIED:HIER_NONE -
</I>&gt;<i> &gt; Nov  3 05:45:31 gateway (squid-1): 192.168.1.110 - -
</I>&gt;<i> &gt; [03/Nov/2014:05:45:31 -0700] &quot;#026#003#001 %BB/%CESsJ%B3%C2%BC%CC%BD%90
</I>&gt;<i> &gt; HTTP/1.1&quot; 400 3577 TAG_NONE:HIER_NONE -
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there something I am missing?  I've been really reading through the
</I>&gt;<i> &gt; squid site, but I can't find any examples of peek splice.  Thank you.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; James
</I>
Thanks a bunch Christos,

That list of IP's is things like apple.com, textnow.me, and windows
updates...IP's that simply don't bump well.  My setup is a linux box
that's a router...one NIC internal IP, the other external IP.  Via
iptables redirect, I'm transparently intercepting the web traffic of a
few devices, only allowing them access to the list of sites in url.txt.
At issue with using the broken_sites list, is that I have to just
specify large chucks of netblocks, which I lose control and visibility
of.  What I'm really hoping for is for a way for squid to be able to, in
my case at least, look at either the server_name extension in the Client
Hello, or, if that's not present, look at the dNSName of certificate
being sent, check the access against url.txt, and either allow or deny.

Ssl_bump does work well for most sites...and I understand we are
performing a man in the middle attack so it's not supposed to be easy.
Again my hope isn't really to perform a mitm...more of an access control
type thing.  Thanks again Christos...I hope I explained this well
enough.

James




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000602.html">[squid-users] Correctly implementing peak-splice
</A></li>
	<LI>Next message (by thread): <A HREF="000627.html">[squid-users] Correctly implementing peak-splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#603">[ date ]</a>
              <a href="thread.html#603">[ thread ]</a>
              <a href="subject.html#603">[ subject ]</a>
              <a href="author.html#603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
