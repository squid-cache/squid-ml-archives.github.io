<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RFC2616 headers in bumped requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C5458DBD0.2050306%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000600.html">
   <LINK REL="Next"  HREF="000839.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RFC2616 headers in bumped requests</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C5458DBD0.2050306%40treenet.co.nz%3E"
       TITLE="[squid-users] RFC2616 headers in bumped requests">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov  4 13:59:44 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000600.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
        <LI>Next message (by thread): <A HREF="000839.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#605">[ date ]</a>
              <a href="thread.html#605">[ thread ]</a>
              <a href="subject.html#605">[ subject ]</a>
              <a href="author.html#605">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 4/11/2014 11:17 p.m., Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> Squid (correctly) inserts Via and X-Forwarded-For headers into
</I>&gt;<i> requests that it is proxying.  However, in the case of encrypted
</I>&gt;<i> traffic, the server and client are expecting the traffic to reach
</I>&gt;<i> the other end as-is, since usually this could not be intercepted.
</I>&gt;<i> With SSL bumped requests this is no longer true - the proxy can
</I>&gt;<i> (and does) modify the traffic, by inserting these headers.
</I>&gt;<i> 
</I>&gt;<i> So I'm asking the question: is this behavior considered desirable,
</I>&gt;<i> or should we be attempting to modify the request as little as
</I>&gt;<i> possible for compatibility reasons?
</I>
It is desirable. More so for intercepted SSL traffic than for regular
HTTP traffic. These headers convey the important information about the
path the traffic took to reach each endpoint. Only with full
information can the endpoints accurately assign security trust/context
on the message.

&gt;<i> 
</I>&gt;<i> I've just come across a web server that throws its toys out of the
</I>&gt;<i> pram when it sees a Via header in an HTTPS request, and
</I>&gt;<i> unfortunately it's quite a big one - Yahoo.  See this request:
</I>&gt;<i> 
</I>&gt;<i> ----- GET /news/degrees-lead-best-paid-careers-141513989.html
</I>&gt;<i> HTTP/1.1 Host: uk.finance.yahoo.com Via: 1.1
</I>&gt;<i> 
</I>
That is unfortunately an invalid HTTP Via header. It is mandatory to
contain the host field even if it contains a host alias for the real
FQDN. If that is what is actually being transfered the server is right
in complaining.


&gt;<i> HTTP/1.1 301 Moved Permanently Date: Tue, 04 Nov 2014 09:55:40 GMT 
</I>&gt;<i> Via: http/1.1 yts212.global.media.ir2.yahoo.com
</I>&gt;<i> (ApacheTrafficServer [c s f ]), http/1.1 r04.ycpi.ams.yahoo.net
</I>&gt;<i> (ApacheTrafficServer [cMsSfW])
</I>
As you can see here the upstream server itself is inserting Via
headers to HTTPS traffic due to a CDN at the server end.

It is reporting that the HTTPS request is being sent unencrypted over
their portion of the network. Not terrible if we assume its their
internal LAN or VPN network, but it cearly demonstrates how realistic
is that end-to-end encryption assumption you say the client and server
have.


&gt;<i> Server: ATS Strict-Transport-Security: max-age=172800 Location: 
</I>&gt;<i> <A HREF="https://uk.finance.yahoo.com/news/degrees-lead-best-paid-careers-141513989.html">https://uk.finance.yahoo.com/news/degrees-lead-best-paid-careers-141513989.html</A>
</I>&gt;<i>
</I>&gt;<i> 
</I>Content-Length: 0
&gt;<i> Age: 0 Connection: keep-alive -----
</I>&gt;<i> 
</I>&gt;<i> Compare to:
</I>&gt;<i> 
</I>&gt;<i> ----- GET /news/degrees-lead-best-paid-careers-141513989.html
</I>&gt;<i> HTTP/1.1 Host: uk.finance.yahoo.com
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 OK ... -----
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Note that the 301 that they return when a Via header is present
</I>&gt;<i> just points back at the same URI, so the client never gets the
</I>&gt;<i> object it requested.
</I>&gt;<i> 
</I>&gt;<i> For now I have worked around it with: request_header_access Via
</I>&gt;<i> deny https request_header_access X-Forwarded-For deny https But it
</I>&gt;<i> does make me wonder if inserting the headers into bumped traffic is
</I>&gt;<i> a sensible thing to do.
</I>&gt;<i> 
</I>
If you can please chek that Via header being emitted by your Squid
when things break. And also whether your Squid is contacting their
server on an HTTPS or HTTP port.
 If your Squid is contacting their HTTP port for un-encrypted traffic
this redirect is competely expected.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUWNvPAAoJELJo5wb/XPRjmsoH/3d9CswaasIZRKlEuu1dQ0a2
/KFZmxhKJDHKYT4yQva+l0og6/FwhFdaUNr0s6xhVfyfUG/fRX2KALCElXl9Bbbe
y3qKrFVSGBJXdXZ/Pysv5ZixKBGBXeiHF4akGZZpK3zexgUjb/+NYg5CrDVi7omi
NbbZE/cTmYa2ZlrlG0F0v5hxlIhjTmyhxJNBR5PWKHWCkYZMnc4cynjrCnNzSmnX
LuY1pFSE9SCRovE3kUgZRB5tDfdk7bNOLfjMHBW1B9p/INRrmnTTVxhxKmPadzWn
9I0IOlusNSYrgYE9mQCp+TYQhVhDRuTN9LubIuuYsC5mHmSdW2WMUs0ExkyOhOM=
=lJ19
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000600.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
	<LI>Next message (by thread): <A HREF="000839.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#605">[ date ]</a>
              <a href="thread.html#605">[ thread ]</a>
              <a href="subject.html#605">[ subject ]</a>
              <a href="author.html#605">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
