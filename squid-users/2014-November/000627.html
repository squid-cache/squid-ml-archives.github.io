<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Correctly implementing peak-splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Correctly%20implementing%20peak-splice&In-Reply-To=%3C5459FAD8.7010005%40chtsanti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000603.html">
   <LINK REL="Next"  HREF="000629.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Correctly implementing peak-splice</H1>
    <B>Christos Tsantilas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Correctly%20implementing%20peak-splice&In-Reply-To=%3C5459FAD8.7010005%40chtsanti.net%3E"
       TITLE="[squid-users] Correctly implementing peak-splice">christos at chtsanti.net
       </A><BR>
    <I>Wed Nov  5 10:24:24 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000603.html">[squid-users] Correctly implementing peak-splice
</A></li>
        <LI>Next message (by thread): <A HREF="000629.html">[squid-users] Correctly implementing peak-splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#627">[ date ]</a>
              <a href="thread.html#627">[ thread ]</a>
              <a href="subject.html#627">[ subject ]</a>
              <a href="author.html#627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/04/2014 02:26 PM, James Lay wrote:
&gt;<i>
</I>&gt;<i> Thanks a bunch Christos,
</I>&gt;<i>
</I>&gt;<i> That list of IP's is things like apple.com, textnow.me, and windows
</I>&gt;<i> updates...IP's that simply don't bump well.  My setup is a linux box
</I>&gt;<i> that's a router...one NIC internal IP, the other external IP.  Via
</I>&gt;<i> iptables redirect, I'm transparently intercepting the web traffic of a
</I>&gt;<i> few devices, only allowing them access to the list of sites in url.txt.
</I>&gt;<i> At issue with using the broken_sites list, is that I have to just
</I>&gt;<i> specify large chucks of netblocks, which I lose control and visibility
</I>&gt;<i> of.  What I'm really hoping for is for a way for squid to be able to, in
</I>&gt;<i> my case at least, look at either the server_name extension in the Client
</I>
You need to build your own external_acl helper which will take as input 
the client sni (server_name extension). Read squid wiki for informations 
about external acl helpers:
  <A HREF="http://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.29">http://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.29</A>

It is easy to build one in perl or as a shell script. I am suggesting to 
build an external_acl helper which return &quot;OK&quot; when the sni matches or 
no sni information exist.

You can use the following configuration or similar:
#
external_acl_type EXTACL %ssl::&gt;sni /path-to-my/external-acl-helper.sh
acl EXTACL external EXTACL

acl step1 at_step  SslBump1
acl step2 at_step  SslBump2
acl step3 at_step  SslBump3

# At first step peek all
ssl_bump peek step1 all
ssl_bump splice step2 EXTACL
ssl_bump bump all


&gt;<i> Hello, or, if that's not present, look at the dNSName of certificate
</I>&gt;<i> being sent, check the access against url.txt, and either allow or deny.
</I>
In your case the server certificate informations will not work well. At 
the time this information is available:
     1) in peek mode, you can not bump any more
     2) in stare mode, you can not splice any more.
There are exceptions to the above rules (for example in case the client 
uses the same SSL library with squid) but the SSL protocol is enough 
safe to not allow us to make something better than this.

Regards,
    Christos

&gt;<i>
</I>&gt;<i> Ssl_bump does work well for most sites...and I understand we are
</I>&gt;<i> performing a man in the middle attack so it's not supposed to be easy.
</I>&gt;<i> Again my hope isn't really to perform a mitm...more of an access control
</I>&gt;<i> type thing.  Thanks again Christos...I hope I explained this well
</I>&gt;<i> enough.
</I>&gt;<i>
</I>&gt;<i> James
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000603.html">[squid-users] Correctly implementing peak-splice
</A></li>
	<LI>Next message (by thread): <A HREF="000629.html">[squid-users] Correctly implementing peak-splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#627">[ date ]</a>
              <a href="thread.html#627">[ thread ]</a>
              <a href="subject.html#627">[ subject ]</a>
              <a href="author.html#627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
