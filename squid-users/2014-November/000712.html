<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU-Usage%20with%20squid%203.4.9%20%28and/or%203.4.4%29&In-Reply-To=%3C5460F8CC.5020303%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000707.html">
   <LINK REL="Next"  HREF="000713.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU-Usage%20with%20squid%203.4.9%20%28and/or%203.4.4%29&In-Reply-To=%3C5460F8CC.5020303%40urlfilterdb.com%3E"
       TITLE="[squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Mon Nov 10 17:41:32 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000707.html">[squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)
</A></li>
        <LI>Next message (by thread): <A HREF="000713.html">[squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#712">[ date ]</a>
              <a href="thread.html#712">[ thread ]</a>
              <a href="subject.html#712">[ subject ]</a>
              <a href="author.html#712">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;&gt;<i> during our last tests (with 3.4.x) we also tried the worker
</I>&gt;&gt;<i> option. it does not matter if workers are enabled or not. with more
</I>&gt;&gt;<i> workers the cpu rise seems to be somewhat slower. so it is not
</I>&gt;&gt;<i> connected to (smp)workers. it is the external auth helper -
</I>&gt;&gt;<i> although the squid process and not the helper does consume all the
</I>&gt;&gt;<i> cpu...
</I>&gt;<i>
</I>&gt;<i> The only difference between SMP and non-SMP mode here is that non-SMP
</I>&gt;<i> has 1 worker doing all the work with one CPU core, whereas SMP mode
</I>&gt;<i> has several workers. They can all hit the same issues independently
</I>&gt;<i> for the same reason(s).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am of the understanding that the code associated with the helper
</I>&gt;<i> processe is using a lot of CPU doing *something* that consumes a lot
</I>&gt;<i> of cycles.
</I>&gt;<i>
</I>&gt;<i> There is a bunch of code doing cache lookups on previous helper
</I>&gt;<i> queries, queueing new lookups, generating and parsing strings in the
</I>&gt;<i> I/O, and even sometimes running whole trees of ACL logics when the
</I>&gt;<i> helper(s) respond.
</I>&gt;<i>   So to get anywhere on this complaint it is important to know what
</I>&gt;<i> (from the above set of things) exactly the CPU is doing.
</I>
Indeed but setting debug_options to ALL,9 does not work since the log file
already is too big and unmanageable even before Squid begins to do
thing that consumes CPU time.

I have a script for a daemon that I wrote. The script is executes when
the daemon receives a fatal signal (e.g. SIGSEGV):  the daemon catches
SIGSEV and executes the script which saves a stack trace (using gdb)
of all threads in a file, and then finally the daemon exits.  It is a
nice debug tool.
Maybe we can make a similar script for Squid that does something
like this:
collect the pids of all processes and then for all pids run gdb
that attaches to the process, dumps a stack trace and detaches.
The script can even do it 25 times to have a better insight in what
squid does.
An administrator can then run the script at the time that CPU peaks
and send the output to the Squid developers.
Do you like the idea?

Another idea is to implement a user-defined signal handler, say
on receipt of SIGUSR2, squid sets the debug_options to ALL,9
without rereading the config file, and after 3 seconds sets
the debug_options back to the configured value.
This way you get a 3-second sample of what Squid is doing at a
specific time and the log file will have a reasonable size.

Marcus

&gt;<i> Amos
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2.0.22 (MingW32)
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBAgAGBQJUYODRAAoJELJo5wb/XPRjvrkH/RBEitKpvLcWypNPCCrMTtw6
</I>&gt;<i> tKftf9gz4og6GOkUiipE0qNLTMgWvV7Fk9/By3vhEGNL+WpQG5UEWCbfpc2h2RdL
</I>&gt;<i> H5tIWJGnXcsV1PGwYI1cuyDpanNs6EnSvKnSGTZ2DdWabiFEOPr9FR/8QtVqpUdS
</I>&gt;<i> EK3uMpnmZ0mbo7auDIPxwa7CYh44tC/C3VMZSto+peB1ikiDonU9B0tXVEFCheeE
</I>&gt;<i> B0IWs8FaoYByVd54lL6cYPz7HcOtyt2Hb6uyPJyQVrrEJs2JuI4ZQh0X7B2mbzAi
</I>&gt;<i> HK8wBbDcyC4ZKagq4ABQIYHsxwqxiNFD6v9ntXBjZpORG1opXLMSBAh9K0Ycq5s=
</I>&gt;<i> =5pNQ
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000707.html">[squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)
</A></li>
	<LI>Next message (by thread): <A HREF="000713.html">[squid-users] High CPU-Usage with squid 3.4.9 (and/or 3.4.4)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#712">[ date ]</a>
              <a href="thread.html#712">[ thread ]</a>
              <a href="subject.html#712">[ subject ]</a>
              <a href="author.html#712">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
