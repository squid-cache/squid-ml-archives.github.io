<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] https intercept breaks non-HTTPS port 443 traffic?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https%20intercept%20breaks%20non-HTTPS%20port%20443%20traffic%3F&In-Reply-To=%3C546193AB.4090108%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000717.html">
   <LINK REL="Next"  HREF="000719.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] https intercept breaks non-HTTPS port 443 traffic?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https%20intercept%20breaks%20non-HTTPS%20port%20443%20traffic%3F&In-Reply-To=%3C546193AB.4090108%40treenet.co.nz%3E"
       TITLE="[squid-users] https intercept breaks non-HTTPS port 443 traffic?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 11 04:42:19 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000717.html">[squid-users] https intercept breaks non-HTTPS port 443 traffic?
</A></li>
        <LI>Next message (by thread): <A HREF="000719.html">[squid-users] Fallback auth method
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#718">[ date ]</a>
              <a href="thread.html#718">[ thread ]</a>
              <a href="subject.html#718">[ subject ]</a>
              <a href="author.html#718">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 11/11/2014 5:00 p.m., Jason Haar wrote:
&gt;<i> Hi there
</I>&gt;<i> 
</I>&gt;<i> Now that I've got ssl-bump working with port 443 intercept, I now
</I>&gt;<i> find non-HTTPS apps that operate on port 443 no longer work. eg for
</I>&gt;<i> ssl-bump in standard proxy mode I had an ACL to disable bump when
</I>&gt;<i> an application (like Skype, which doesn't use HTTPS) tried
</I>&gt;<i> CONNECT-ing to ip addresses, but with intercept mode that needed to
</I>&gt;<i> be removed as all outbound https intercepted sessions begin with
</I>&gt;<i> them being to an ip address.
</I>&gt;<i> 
</I>&gt;<i> I just brought up a remote SSH server on port 443 and when I try
</I>&gt;<i> to telnet to it, instead of getting the OpenSSH banner, I see
</I>&gt;<i> nothing, but the remote server receives a SSL transaction from
</I>&gt;<i> squid. All makes sense, but is there a way for bump to &quot;fail open&quot;
</I>&gt;<i> on non-SSL traffic? I see squid 3.5 mentions &quot;peek&quot; and &quot;at_step&quot; -
</I>&gt;<i> are those components going to be the mechanism to solve this issue?
</I>&gt;<i> Just curious, I'm only testing/playing with intercepting port 443,
</I>&gt;<i> but it's interesting to see where this is going
</I>
Since you are experimenting and learning ... it is very important at
present to know where the HTTPS support is coming from as well as
going to.

In particular that for classical HTTPS support the proxy offloads all
SSL configuration setup and port 443 traffic to the OpenSSL library.
So Squid-3.1 and older never had anything at all to do with the
handshakes.

Bumping is gradually changing that, with Squid taking on more and more
responsibility for ever lower levels of the TLS encryption. Initial
client-first mode jumped in to replace the ServerHello wth a static
cert. Then client-first/server-first +mimic taking responsibility for
the high level certificate exchange process. Now 3.5 peek-n-splice
makes Squid responsible for the individual low-level bytes being
transferred around in TLS - though mostly as a spy-in-the-middle.
 Its an arms race, with Squid (in the persons of Measurement Factory
and sponsors) vs the entire TLS security community.

Personally I think we should have just applied QoS limiting on CONNECT
tunnels or started issuing 426 responses mandating TLS to the proxy.
But sponsors pay the bills and that kind of paradigm shift leads to
some obvious pain, whereas ssl-bump hides the pain until reality bites
back.

&gt;<i> 
</I>&gt;<i> Finally, when I attempted this connection, cache.log reported
</I>&gt;<i> 
</I>&gt;<i> fwdNegotiateSSL: Error negotiating SSL connection on FD 25: 
</I>&gt;<i> error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> I guess that's it squealing about getting non-SSL content back from
</I>&gt;<i> the server (ie the SSH banner). Shouldn't that be a bit more
</I>&gt;<i> verbose - to help sysadmins figure out what was behind it. eg
</I>&gt;<i> 
</I>&gt;<i> fwdNegotiateSSL: Error negotiating SSL connection from 
</I>&gt;<i> 192.168.22.11:44382 -&gt; 1.2.3.4:443 (FD 25): error:140770FC:SSL 
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:unknown protocol (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> At the very least, with that I could have a cronjob grep through
</I>&gt;<i> my cache.log to auto-create a &quot;bump none&quot; acl ;-)
</I>
That is a direct result specific to the server-first logic in your
Squid version being applied to the traffic. It will change if
client-first is applied, and as version upgrades change the logic
itself. Neat idea though :-)

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUYZOoAAoJELJo5wb/XPRjfRYIAJQ4CjWUpj+ZMw8ViLgeeu3D
hQHPbx9ln1NXAyk9KwiEGdwEBuVe6rTk4X3q+fCvdl8/1kHdVrRw3mNeIIJJRW8h
gbH6h0E+Oi6tL6jBs4pMsTqSjCsNK01nQtkDylHIVDKPLo7KUUyhJWBjiy4npxoq
VC37ufs8vtqrU76d7seTBGOCRWHQ+DoOAv+kPzJDQ3Z9YOfd/peD8qxfhHiHbw3R
fmkOh8n66f8qDwKUtnJjTUqvww3/akrAKFlIFnTcWvsED9vwHnxrNChTg8rdq27n
DgVF9GY5QZ3bFsScmMCQbl96lPE12SE+jIZU6aYrKOxCEC/D5izGBb5Dsmt3peI=
=+JVQ
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000717.html">[squid-users] https intercept breaks non-HTTPS port 443 traffic?
</A></li>
	<LI>Next message (by thread): <A HREF="000719.html">[squid-users] Fallback auth method
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#718">[ date ]</a>
              <a href="thread.html#718">[ thread ]</a>
              <a href="subject.html#718">[ subject ]</a>
              <a href="author.html#718">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
