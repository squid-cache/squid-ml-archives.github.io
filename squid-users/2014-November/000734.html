<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connecting%20directly%20to%20ssl-bump%20intercept%20port%0A%20causes%20runaway%20CPU&In-Reply-To=%3C5462F74D.8060609%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000733.html">
   <LINK REL="Next"  HREF="000752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connecting%20directly%20to%20ssl-bump%20intercept%20port%0A%20causes%20runaway%20CPU&In-Reply-To=%3C5462F74D.8060609%40treenet.co.nz%3E"
       TITLE="[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov 12 05:59:41 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000733.html">[squid-users] connecting directly to ssl-bump intercept port causes	runaway CPU
</A></li>
        <LI>Next message (by thread): <A HREF="000752.html">[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#734">[ date ]</a>
              <a href="thread.html#734">[ thread ]</a>
              <a href="subject.html#734">[ subject ]</a>
              <a href="author.html#734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 12/11/2014 5:49 p.m., Jason Haar wrote:
&gt;<i> Hi there
</I>&gt;<i> 
</I>&gt;<i> I was reading this list about the issue with google.com and was
</I>&gt;<i> playing around - and I used telnet to connect directly to the
</I>&gt;<i> intercept ssl-bump port. End result was squid immediately went to
</I>&gt;<i> 99% CPU, and the cache.log started reporting
</I>&gt;<i> 
</I>&gt;<i> WARNING! Your cache is running out of filedescriptors WARNING! Your
</I>&gt;<i> cache is running out of filedescriptors WARNING! Your cache is
</I>&gt;<i> running out of filedescriptors
</I>&gt;<i> 
</I>&gt;<i> The box staggered to it's knees, so I had to kill squid. Restarted
</I>&gt;<i> it and everything is fine - until I do that again. If I let the
</I>&gt;<i> network redirecting work (ie make outbound port 443 connections),
</I>&gt;<i> this doesn't happen - it's only if I directly connect to the
</I>&gt;<i> intercept port
</I>

Otherwise known as a &quot;Forwarding loop&quot; or &quot;Denial of Service&quot;
depending on whether it breaks the client request, the server, or your
whole network connectivity.


Short answer:

That being one of the &quot;NAT security vulnerabilities&quot; mentioned as
reason for mangle table rules.
  <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>
  <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>

... and a core reason for using Via header.

... and incidentally why Squid complains about not having a
forward-proxy port to use in some configurations.


Long answer:
What do you think &quot;server-first&quot; means ? (hint step 3 below).

1) Your telnet opened a connection.

2) The TCP packet IPs told Squid the server you were connecting to was
itself on port 3126.

3) Squid connected there to fetch the SSL certificate details.

4) The TCP connection from Squid to Squid:3126 was opened.

5) go back to #2


HTTP has the Via header mechanism to restrict the loop to protect
against the DoS becoming a wide problem. But notice how no HTTP is
taking place, Squid is still trying to perform the TLS/SSL operations.
There is no protection at the TCP layer.


&gt;<i> 
</I>&gt;<i> I have my &quot;http_port intercept&quot; and &quot;https_port intercept&quot; set 
</I>&gt;<i> identically (except for the ssl stuff of course), and yet if I
</I>&gt;<i> telnet to the http_port set to intercept, this does NOT happen - it
</I>&gt;<i> works fine...
</I>

No. &quot;works fine&quot; is a wrong conclusion. This could only &quot;work&quot; if you
sent Squid a test HTTP message with forward-proxy URL syntax. When you
start actually using the port for real traffic with port-80 URL syntax
it will break with forwarding loops like above.


Please stop using telnet and manual data entry to test HTTP services.
If you knew enough about the protocol to type it into telnet correctly
the above loop problems would not be surprising you.

A proper HTTP client software like squidclient, wget, curl, or even a
full browser should be used.


Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUYvdMAAoJELJo5wb/XPRjL04H+gKhrYJ20swYkWCOsVrjyRnl
/t3up7PhwKSEaguNnbdkCaT9B/5t3uft+hp9VpiEZkEuTub+JYPWn/3Z2ugCSqKf
k1uiRjHboex+AEILNc5o5fny1CKyXRdCzOArqXvrrTBLOeWGx+Sc5QL+8tiC3g27
ZJ3ldgWS9O7ewdWhp24ReCjgGufq0oWz0PC6BsCVy0qilLjBK4yk+E/xI0Ht3nVj
YTU6lNUzli4Sb0ElMHpJkGbF8lh0e48iEvyIyHdYvTMmbf3gR/lD51mS9XNzrxMu
CiDX7Ok4M/ELdadNG7kgWvKzAZVlySb+63Xaix1CyGzJlWHSwISaH2QLnsASbP0=
=bnBC
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000733.html">[squid-users] connecting directly to ssl-bump intercept port causes	runaway CPU
</A></li>
	<LI>Next message (by thread): <A HREF="000752.html">[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#734">[ date ]</a>
              <a href="thread.html#734">[ thread ]</a>
              <a href="subject.html#734">[ subject ]</a>
              <a href="author.html#734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
