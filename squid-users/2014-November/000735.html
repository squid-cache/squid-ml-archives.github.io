<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] R: R: Problem with Squid 3.4 and transparent SSL proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20R%3A%20R%3A%20Problem%20with%20Squid%203.4%20and%20transparent%20SSL%20proxy&In-Reply-To=%3C88EF58F000EC4B4684700C2AA3A73D7A04F5323FBEE9%40W2008DC01.ColliniConsulting.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000730.html">
   <LINK REL="Next"  HREF="000771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] R: R: Problem with Squid 3.4 and transparent SSL proxy</H1>
    <B>Job</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20R%3A%20R%3A%20Problem%20with%20Squid%203.4%20and%20transparent%20SSL%20proxy&In-Reply-To=%3C88EF58F000EC4B4684700C2AA3A73D7A04F5323FBEE9%40W2008DC01.ColliniConsulting.lan%3E"
       TITLE="[squid-users] R: R: Problem with Squid 3.4 and transparent SSL proxy">Job at colliniconsulting.it
       </A><BR>
    <I>Wed Nov 12 08:55:47 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000730.html">[squid-users] R: Problem with Squid 3.4 and transparent SSL	proxy
</A></li>
        <LI>Next message (by thread): <A HREF="000771.html">[squid-users] R: R: Problem with Squid 3.4 and transparent SSL proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#735">[ date ]</a>
              <a href="thread.html#735">[ thread ]</a>
              <a href="subject.html#735">[ subject ]</a>
              <a href="author.html#735">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you Amos, for everything.

I route with REDIRECT all outgoing connection to port tcp/443 from my LAN:

iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3130

in squid, i have these configurations:

http_port 3128
http_port 3129 intercept
https_port 3130 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=16MB cert=/etc/squid/ssl/squid.pem key=/etc/squid/ssl/squid.key cipher=ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:DHE-RSA-CAMELLIA128-SHA:AES128-SHA:RC4-SHA:HIGH:!aNULL:!MD5:!ADH

Do you think my iptables rule is wrong?

Thank you!
Francesco


________________________________________
Da: Amos Jeffries [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>]
Inviato: mercoled&#236; 12 novembre 2014 4.25
A: Job; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Oggetto: Re: R: [squid-users] Problem with Squid 3.4 and transparent SSL proxy

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 12/11/2014 5:40 a.m., Job wrote:
&gt;&gt;<i> That means in your case avoid directly connecting to the
</I>&gt;&gt;<i> intercepting port. Connect to port 80/443 on some Internet server
</I>&gt;&gt;<i> instead and see
</I>&gt;<i> if&gt; the packets are properly delivered through Squid.
</I>&gt;&gt;<i> Also, avoid telnet for the 443 tests. Use an HTTPS client.
</I>&gt;<i>
</I>&gt;<i> Hello Amos and thank you, first of all.
</I>&gt;<i>
</I>&gt;<i> I started squid in debug mode and now i see it:
</I>&gt;<i>
</I>&gt;<i> 2014/11/11 17:40:17| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;<i> local=192.168.10.254:3130 remote=192.168.10.109:52024 FD 12
</I>&gt;<i> flags=33: (92) Protocol not available
</I>&gt;<i>
</I>
That means that the NAT system has no record of the transaction being
intercepted.

The kind of error which shows up when you deliver traffic directly
from client 192.168.10.109 to an &quot;http_port 3130 intercept&quot; port on
Squid without going through NAT on the Squid box.


&gt;<i> 192.168.10.254 is lan-firewall gateway 192.168.10.109 is the
</I>&gt;<i> workstation where i am trying to surfing on 443 port
</I>&gt;<i>
</I>&gt;<i> When redirecting the 443 port to squid https_port, errors appears.
</I>
Details are critical. Please feel free to flood us with details. Some
of them will be important and we dont know which until we have them.
It is very hard to help an any useful way without lots of details
about what you are doing *exactly*, whats happening *exactly*, and
whats wrong with the happening.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUYtM0AAoJELJo5wb/XPRjHzsH/ip3kd7kv8PSgBBAtiVVZ3ws
8ACmAd3upZs4gZy0WRDRGRiL3uQtnWW7DBte7qWOWWMqdmos+5YNG9WH8hFZ+ZzY
awCG6EvtCjVAzuWGRMMe5FkX4fa8yhutoNFZbOYT33CKfWDQTw5tbljR8PH5PIXc
9h0p8MBqPMZyTJUv13szaGzZENZl88xZ3Chg/OMd7DHdEhTi+Ko8qC2n9mTnhFpg
mnChkgG+Y4XRGKTLECTJGOk7OoxFknPmAWpuPZwAcgQXtr1r3rwnCDjfnp9rSWr/
Gz9wQ4Yt2qcB7rIkDtfbnAjLWOtyn2b958sM0h9xdHFY7legYLNDwN/RkbZ/hEA=
=pNAq
-----END PGP SIGNATURE-----
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000730.html">[squid-users] R: Problem with Squid 3.4 and transparent SSL	proxy
</A></li>
	<LI>Next message (by thread): <A HREF="000771.html">[squid-users] R: R: Problem with Squid 3.4 and transparent SSL proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#735">[ date ]</a>
              <a href="thread.html#735">[ thread ]</a>
              <a href="subject.html#735">[ subject ]</a>
              <a href="author.html#735">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
