<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cannot purge items that are not upstream anymore
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cannot%20purge%20items%20that%20are%20not%20upstream%20anymore&In-Reply-To=%3C54635F40.105%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000741.html">
   <LINK REL="Next"  HREF="000746.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cannot purge items that are not upstream anymore</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cannot%20purge%20items%20that%20are%20not%20upstream%20anymore&In-Reply-To=%3C54635F40.105%40treenet.co.nz%3E"
       TITLE="[squid-users] Cannot purge items that are not upstream anymore">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov 12 13:23:12 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000741.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
        <LI>Next message (by thread): <A HREF="000746.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#743">[ date ]</a>
              <a href="thread.html#743">[ thread ]</a>
              <a href="subject.html#743">[ subject ]</a>
              <a href="author.html#743">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 13/11/2014 1:55 a.m., Hussam Al-Tayeb wrote:
&gt;<i> On Thursday 13 November 2014 01:39:27 Amos Jeffries wrote:
</I>&gt;&gt;<i> On 13/11/2014 12:17 a.m., Hussam Al-Tayeb wrote:
</I>&gt;&gt;&gt;<i> Hello. I have a problem with 'squidclient -m PURGE' and also
</I>&gt;&gt;&gt;<i> the purge command. They won't purge urls from disk that are
</I>&gt;&gt;&gt;<i> not available online anymore or redirect to other links.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> PURGE was designed for use in HTTP/1.0. It does not handle
</I>&gt;&gt;<i> HTTP/1.1 negotiated content / variants at all well.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> For example, 
</I>&gt;&gt;&gt;<i> <A HREF="http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b64">http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b64</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 
</I>e8d563.jpg
&gt;&gt;<i> which corresponds to /home/squid/00/BB/0000BBC0
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Even &quot;purge -e &quot;static.firedrive.com&quot; -c /etc/squid/squid.conf
</I>&gt;&gt;&gt;<i> -P 0x01&quot; reads it but will not really remove it from disk. Are
</I>&gt;&gt;&gt;<i> such files stuck on disk forever?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> No. Cache is a temporary storage location. Think of it as a
</I>&gt;&gt;<i> buffer in the network.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> They will exist only until a) the storage space is needed for 
</I>&gt;&gt;<i> something else, or b) the timestamp in their Expires: header, or
</I>&gt;&gt;<i> c) an origin server informs Squid they are no longer existing.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> PURGE method was a way to fake (c).
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> What would the correct way to clear them?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> By obeying HTTP protocol. HTTP has built-in mechanisms for doing
</I>&gt;&gt;<i> that automatically.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Or you can just delete the disk file. Squid will auto-detect the 
</I>&gt;&gt;<i> removal at some point when it needs to use or delete the object.
</I>&gt;&gt;<i> Until then it will just under-count the amount of used disk.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________ squid-users
</I>&gt;&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> head /home/squid/00/BB/0000BBC0 -n20
</I>&gt;<i> 
</I>&gt;<i> &#65533;u&#65533;&#65533;(&#9618;&#65533;&#65533;,&#65533;|&#65533;S&#65533;| 
</I>&gt;<i> &#65533;S&#65533;&#65533;f7&#65533;P`<A HREF="Uhttp://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b64e8d563.jpg">Uhttp://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b64e8d563.jpg</A>
</I>&gt;<i>
</I>&gt;<i> 
</I>R&quot;accept-encoding=&quot;gzip,%20deflate&quot;HTTP/1.1 200 OK

... notice and remember the accept-encoding=* value in quotes above.
We shall get back to that later.

Now for a little tale of woe...

On this Date:

&gt;<i> Date: Tue, 26 Aug 2014 12:25:13 GMT
</I>
... the

&gt;<i> Server: cloudflare-nginx
</I>
... representing static.firedrive.com has expicitly with complete
authority state that the:

&gt;<i> Content-Type: image/jpeg
</I>
... otherwise known as:

&gt;<i> ETag: &quot;5090c137-2efb&quot;
</I>
... should remain in cache until:

&gt;<i> Expires: Fri, 23 Aug 2024 12:25:13 GMT
</I>
... should remain in cache until Aug 2024.

Furthermore that:

&gt;<i> Last-Modified: Wed, 31 Oct 2012 06:12:07 GMT Cache-Control: public,
</I>&gt;<i> max-age=315360000
</I>
... there is no need for any recipient storing the object to even
check for validity again until Oct 2022.


&gt;<i> Access-Control-Allow-Origin: * Access-Control-Allow-Methods: GET,
</I>&gt;<i> POST, OPTIONS Access-Control-Allow-Headers:
</I>&gt;<i> Origin,Referer,Accept-Encoding,Accept- 
</I>&gt;<i> Language,Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-
</I>&gt;<i>
</I>&gt;<i> 
</I>Modified-Since,Cache-Control,Content-Type,X-Forwarded-For,X-Forwarded-Proto
&gt;<i> CF-Cache-Status: HIT Vary: Accept-Encoding Accept-Ranges: bytes 
</I>&gt;<i> CF-RAY: 160002c2e4730887-FRA Content-Length: 12027 Connection:
</I>&gt;<i> Keep-Alive Set-Cookie:
</I>&gt;<i> __cfduid=dfcf568ed46ef827243b3d6c342b3bdc41409055913424; 
</I>&gt;<i> expires=Mon, 23-Dec-2019 23:50:00 GMT; path=/;
</I>&gt;<i> domain=.firedrive.com; HttpOnly
</I>
... and that the Cookies it served up shall remain on the users
machine until Dec 2019. Thereafter this object shall be served without
any Cookie.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Expires header is in the past. 
</I>&gt;<i> &quot;<A HREF="http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b64e8d563.jpg">http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b64e8d563.jpg</A>&quot;
</I>&gt;<i>
</I>&gt;<i> 
</I>Sending HTTP request ... done.
&gt;<i> HTTP/1.1 404 Not Found Server: squid Mime-Version: 1.0 Date: Wed,
</I>&gt;<i> 12 Nov 2014 12:54:13 GMT Content-Length: 0 X-Cache: MISS from
</I>&gt;<i> SERV1 X-Cache-Lookup: NONE from SERV1:3129 Via: 1.1 SERV1 (squid) 
</I>&gt;<i> Connection: close
</I>&gt;<i> 
</I>&gt;<i> Is that why  squidclient -m PURGE -h 127.0.0.1 -p 3129 says not
</I>&gt;<i> found in cache?
</I>
The Vary: header is why your PURGE is not doing anything. It means you
have to find and send in the exactly right value for Accept-Encoding,
in order for PURGE to find and erase the actual object.

The request *not* having an Accept-Encoding header is one of the
possible variations of values. In particular it is the one which is
foudn to already be absent from your cache by your PURGE command.

This is where that quoted string up top of the object file comes in.
What is cached on disk is the object for:
squidclient -m PURGE -p 3129 -H 'Accept-Encoding: gzip, deflate\n'

The purge tool has not been updated in some years and does not support
these types of variant commonly found in HTTP/1.1 traffic.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUY18/AAoJELJo5wb/XPRjEOMH+wXFvkHoSGbZMLKMZHmGfk6m
8CtmBoICMAhHsQ34vKNNn5ENZU79MuaI2OeTyDXK/xekr0/WnRmyAL+iQYRD+/B+
D9L4TJxNznx/8io5AAJ1rTU0Ua81Ey3mCgB9af7zabUICNb2pnSFx53ju8PMc6WR
FIre5qbBT+eeSxY3IHlyp61eqcvKqf1yYOnutAXSDarodvlUsydspjEMfxBYjpUT
8zAQq7cCxDb2H2jamFFaQhh4x+AR5yOEQ8jRCIhQgP8M2E0Cm6lorAVpeVS9sTv3
82DKXKNN+NaLKtiAhMMBx4LVeXmjQU6farLSz2Xj94WFLWsI7uE7fTyDzX2AaAs=
=RPQc
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000741.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
	<LI>Next message (by thread): <A HREF="000746.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#743">[ date ]</a>
              <a href="thread.html#743">[ thread ]</a>
              <a href="subject.html#743">[ subject ]</a>
              <a href="author.html#743">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
