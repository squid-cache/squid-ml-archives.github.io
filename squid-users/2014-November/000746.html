<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cannot purge items that are not upstream anymore
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cannot%20purge%20items%20that%20are%20not%20upstream%20anymore&In-Reply-To=%3C2620417.F4s5CzuQaP%40hades%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000743.html">
   <LINK REL="Next"  HREF="000748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cannot purge items that are not upstream anymore</H1>
    <B>Hussam Al-Tayeb</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cannot%20purge%20items%20that%20are%20not%20upstream%20anymore&In-Reply-To=%3C2620417.F4s5CzuQaP%40hades%3E"
       TITLE="[squid-users] Cannot purge items that are not upstream anymore">hussam at visp.net.lb
       </A><BR>
    <I>Wed Nov 12 14:04:04 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000743.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
        <LI>Next message (by thread): <A HREF="000748.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#746">[ date ]</a>
              <a href="thread.html#746">[ thread ]</a>
              <a href="subject.html#746">[ subject ]</a>
              <a href="author.html#746">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thursday 13 November 2014 02:23:12 Amos Jeffries wrote:
&gt;<i> On 13/11/2014 1:55 a.m., Hussam Al-Tayeb wrote:
</I>&gt;<i> &gt; On Thursday 13 November 2014 01:39:27 Amos Jeffries wrote:
</I>&gt;<i> &gt;&gt; On 13/11/2014 12:17 a.m., Hussam Al-Tayeb wrote:
</I>&gt;<i> &gt;&gt;&gt; Hello. I have a problem with 'squidclient -m PURGE' and also
</I>&gt;<i> &gt;&gt;&gt; the purge command. They won't purge urls from disk that are
</I>&gt;<i> &gt;&gt;&gt; not available online anymore or redirect to other links.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; PURGE was designed for use in HTTP/1.0. It does not handle
</I>&gt;<i> &gt;&gt; HTTP/1.1 negotiated content / variants at all well.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;&gt; For example,
</I>&gt;<i> &gt;&gt;&gt; <A HREF="http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b">http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b</A>
</I>&gt;<i> &gt;&gt;&gt; 64
</I>&gt;<i> 
</I>&gt;<i> e8d563.jpg
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; which corresponds to /home/squid/00/BB/0000BBC0
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;&gt; Even &quot;purge -e &quot;static.firedrive.com&quot; -c /etc/squid/squid.conf
</I>&gt;<i> &gt;&gt;&gt; -P 0x01&quot; reads it but will not really remove it from disk. Are
</I>&gt;<i> &gt;&gt;&gt; such files stuck on disk forever?
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; No. Cache is a temporary storage location. Think of it as a
</I>&gt;<i> &gt;&gt; buffer in the network.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; They will exist only until a) the storage space is needed for
</I>&gt;<i> &gt;&gt; something else, or b) the timestamp in their Expires: header, or
</I>&gt;<i> &gt;&gt; c) an origin server informs Squid they are no longer existing.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; PURGE method was a way to fake (c).
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;&gt; What would the correct way to clear them?
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; By obeying HTTP protocol. HTTP has built-in mechanisms for doing
</I>&gt;<i> &gt;&gt; that automatically.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Or you can just delete the disk file. Squid will auto-detect the
</I>&gt;<i> &gt;&gt; removal at some point when it needs to use or delete the object.
</I>&gt;<i> &gt;&gt; Until then it will just under-count the amount of used disk.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Amos
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; _______________________________________________ squid-users
</I>&gt;<i> &gt;&gt; mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; head /home/squid/00/BB/0000BBC0 -n20
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &#65533;u&#65533;&#65533;(&#9618;&#65533;&#65533;,&#65533;|&#65533;S&#65533;|
</I>&gt;<i> &gt; &#65533;S&#65533;&#65533;f7&#65533;P`<A HREF="Uhttp://static.firedrive.com/dynamic/previews/75/27577be2d6d86af2">Uhttp://static.firedrive.com/dynamic/previews/75/27577be2d6d86af2</A>
</I>&gt;<i> &gt; 0265734b64e8d563.jpg
</I>&gt;<i> R&quot;accept-encoding=&quot;gzip,%20deflate&quot;HTTP/1.1 200 OK
</I>&gt;<i> 
</I>&gt;<i> ... notice and remember the accept-encoding=* value in quotes above.
</I>&gt;<i> We shall get back to that later.
</I>&gt;<i> 
</I>&gt;<i> Now for a little tale of woe...
</I>&gt;<i> 
</I>&gt;<i> On this Date:
</I>&gt;<i> &gt; Date: Tue, 26 Aug 2014 12:25:13 GMT
</I>&gt;<i> 
</I>&gt;<i> ... the
</I>&gt;<i> 
</I>&gt;<i> &gt; Server: cloudflare-nginx
</I>&gt;<i> 
</I>&gt;<i> ... representing static.firedrive.com has expicitly with complete
</I>&gt;<i> 
</I>&gt;<i> authority state that the:
</I>&gt;<i> &gt; Content-Type: image/jpeg
</I>&gt;<i> 
</I>&gt;<i> ... otherwise known as:
</I>&gt;<i> &gt; ETag: &quot;5090c137-2efb&quot;
</I>&gt;<i> 
</I>&gt;<i> ... should remain in cache until:
</I>&gt;<i> &gt; Expires: Fri, 23 Aug 2024 12:25:13 GMT
</I>&gt;<i> 
</I>&gt;<i> ... should remain in cache until Aug 2024.
</I>&gt;<i> 
</I>&gt;<i> Furthermore that:
</I>&gt;<i> &gt; Last-Modified: Wed, 31 Oct 2012 06:12:07 GMT Cache-Control: public,
</I>&gt;<i> &gt; max-age=315360000
</I>&gt;<i> 
</I>&gt;<i> ... there is no need for any recipient storing the object to even
</I>&gt;<i> check for validity again until Oct 2022.
</I>&gt;<i> 
</I>&gt;<i> &gt; Access-Control-Allow-Origin: * Access-Control-Allow-Methods: GET,
</I>&gt;<i> &gt; POST, OPTIONS Access-Control-Allow-Headers:
</I>&gt;<i> &gt; Origin,Referer,Accept-Encoding,Accept-
</I>&gt;<i> &gt; Language,Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,I
</I>&gt;<i> &gt; f-
</I>&gt;<i> Modified-Since,Cache-Control,Content-Type,X-Forwarded-For,X-Forwarded-Proto
</I>&gt;<i> 
</I>&gt;<i> &gt; CF-Cache-Status: HIT Vary: Accept-Encoding Accept-Ranges: bytes
</I>&gt;<i> &gt; CF-RAY: 160002c2e4730887-FRA Content-Length: 12027 Connection:
</I>&gt;<i> &gt; Keep-Alive Set-Cookie:
</I>&gt;<i> &gt; __cfduid=dfcf568ed46ef827243b3d6c342b3bdc41409055913424;
</I>&gt;<i> &gt; expires=Mon, 23-Dec-2019 23:50:00 GMT; path=/;
</I>&gt;<i> &gt; domain=.firedrive.com; HttpOnly
</I>&gt;<i> 
</I>&gt;<i> ... and that the Cookies it served up shall remain on the users
</I>&gt;<i> machine until Dec 2019. Thereafter this object shall be served without
</I>&gt;<i> any Cookie.
</I>&gt;<i> 
</I>&gt;<i> &gt; The Expires header is in the past.
</I>&gt;<i> &gt; &quot;<A HREF="http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b6">http://static.firedrive.com/dynamic/previews/75/27577be2d6d86af20265734b6</A>
</I>&gt;<i> &gt; 4e8d563.jpg&quot;
</I>&gt;<i> Sending HTTP request ... done.
</I>&gt;<i> 
</I>&gt;<i> &gt; HTTP/1.1 404 Not Found Server: squid Mime-Version: 1.0 Date: Wed,
</I>&gt;<i> &gt; 12 Nov 2014 12:54:13 GMT Content-Length: 0 X-Cache: MISS from
</I>&gt;<i> &gt; SERV1 X-Cache-Lookup: NONE from SERV1:3129 Via: 1.1 SERV1 (squid)
</I>&gt;<i> &gt; Connection: close
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Is that why  squidclient -m PURGE -h 127.0.0.1 -p 3129 says not
</I>&gt;<i> &gt; found in cache?
</I>&gt;<i> 
</I>&gt;<i> The Vary: header is why your PURGE is not doing anything. It means you
</I>&gt;<i> have to find and send in the exactly right value for Accept-Encoding,
</I>&gt;<i> in order for PURGE to find and erase the actual object.
</I>&gt;<i> 
</I>&gt;<i> The request *not* having an Accept-Encoding header is one of the
</I>&gt;<i> possible variations of values. In particular it is the one which is
</I>&gt;<i> foudn to already be absent from your cache by your PURGE command.
</I>&gt;<i> 
</I>&gt;<i> This is where that quoted string up top of the object file comes in.
</I>&gt;<i> What is cached on disk is the object for:
</I>&gt;<i> squidclient -m PURGE -p 3129 -H 'Accept-Encoding: gzip, deflate\n'
</I>&gt;<i> 
</I>&gt;<i> The purge tool has not been updated in some years and does not support
</I>&gt;<i> these types of variant commonly found in HTTP/1.1 traffic.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
Ok, thank you for the explanation. seems wget and curl also say 
&quot;X-Cache: MISS from SERV1
X-Cache-Lookup: NONE from SERV1:3129&quot;

So the current natural ways of purging the object is waiting till squid runs 
out of space and rotates old objects or reaching the Expire date of 2024, 
correct?
Both options are ok. I just wanted to make sure squid is self cleaning even if 
things take time.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000743.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
	<LI>Next message (by thread): <A HREF="000748.html">[squid-users] Cannot purge items that are not upstream anymore
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#746">[ date ]</a>
              <a href="thread.html#746">[ thread ]</a>
              <a href="subject.html#746">[ subject ]</a>
              <a href="author.html#746">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
