<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with https://www.google.com and squid	interception
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20https%3A//www.google.com%20and%20squid%0A%09interception&In-Reply-To=%3C5463A68F.8090002%40nanosec.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000750.html">
   <LINK REL="Next"  HREF="000733.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with https://www.google.com and squid	interception</H1>
    <B>Peter Gross</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20https%3A//www.google.com%20and%20squid%0A%09interception&In-Reply-To=%3C5463A68F.8090002%40nanosec.com%3E"
       TITLE="[squid-users] Problem with https://www.google.com and squid	interception">pag at nanosec.com
       </A><BR>
    <I>Wed Nov 12 18:27:27 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000750.html">[squid-users] Problem with https://www.google.com and	squid	interception
</A></li>
        <LI>Next message (by thread): <A HREF="000733.html">[squid-users] connecting directly to ssl-bump intercept port causes	runaway CPU
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#751">[ date ]</a>
              <a href="thread.html#751">[ thread ]</a>
              <a href="subject.html#751">[ subject ]</a>
              <a href="author.html#751">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/11/2014 11:47 AM, Peter Gross wrote:
&gt;<i> Hi,
</I>&gt;<i> I am a new user of Squid and would first like to thank the developers
</I>&gt;<i> for this excellent software. This is my first post to the mailing list
</I>&gt;<i> ... I have been tasked with setting up quite restrictive web access
</I>&gt;<i> control at work. I plan to use an intercepting squid proxy with SSL
</I>&gt;<i> bump. There will also be WCCPv2 to/from a Cisco IOS router. Since this
</I>&gt;<i> is quite a bit of complexity, I though it prudent to start slowly, in
</I>&gt;<i> steps. So first -- to get my feet wet -- I set up squid (version 3.4.8,
</I>&gt;<i> built using rpmbuild from the src rpm from ngtech) on a home linux
</I>&gt;<i> server (Centos 5.11 -- no Cisco at home) which is also the firewall
</I>&gt;<i> router for my home network. I also decided to start out with plain
</I>&gt;<i> vanilla proxying (no interception -- use browser setting). This worked
</I>&gt;<i> fine. I then tested HTTP interception by changing squid.conf from:
</I>&gt;<i> http_port 3128
</I>&gt;<i>    -to-
</I>&gt;<i> http_port 3128 intercept
</I>
Based on a suggestion from Amos Jeffries, I changed my squid.conf 
http_port directives to:

http_port 192.168.101.253:3128
http_port 192.168.101.253:3129 intercept
#https_port 192.168.101.253:3130 intercept ssl-bump 
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.pem

Note that the https_port directive is commented out for now because I 
just wanted to get HTTP interception working first. I have changed to 
using the default proxy port of 3128 as a (no-intercept) forwarding port 
and changed the intercept port to use 3129. Also -- and this may be 
important in my case -- I added the squid server internal LAN IP address 
to the http_port directives. This host has multiple NICs and I wonder if 
not specifying the eth1 address (eth0 is for internet access) that 
something weird happened before. In any case going to 
<A HREF="https://www.google.com">https://www.google.com</A> now works every time (keeping fingers crossed).


&gt;<i> and adding the following rule to my shorewall firewall:
</I>&gt;<i> REDIRECT:info   loc:192.168.101.9       3128    tcp     http
</I>&gt;<i>
</I>&gt;<i> I wanted to test intercepting just one host before turning it on for all
</I>&gt;<i> hosts and wireless devices in my network.
</I>&gt;<i>
</I>&gt;<i> 192.168.101.9 is another Centos PC on my network. Squid is running on
</I>&gt;<i> 192.168.101.253.
</I>&gt;<i>
</I>&gt;<i> The interception seemed to work fine ... access.log showed lots of
</I>&gt;<i> successful proxy activity. Then came the problem: going to
</I>&gt;<i> <A HREF="https://www.google.com">https://www.google.com</A> failed (not every time, but frequently). If I
</I>&gt;<i> turned off the REDIRECT line in the shorewall rules file and restarted
</I>&gt;<i> shorewall, no problem. This seemed very peculiar because no HTTPS
</I>&gt;<i> traffic should be redirected to the proxy. Here are the errors that
</I>&gt;<i> showed up in cache.log when redirection (NAT-ing) was on:
</I>&gt;<i>
</I>&gt;<i> 2014/11/11 11:03:42 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;<i> local=192.168.101.253:3128 remote=192.168.101.9:34165 FD 11 flags=33:
</I>&gt;<i> (92) Protocol not available
</I>&gt;<i>
</I>&gt;<i> Note that other HTTPS sites worked fine! It appears to be confined to a
</I>&gt;<i> google specific issue.
</I>&gt;<i>
</I>&gt;<i> Thanks for any comments/suggestions you might have,
</I>&gt;<i> --peter
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000750.html">[squid-users] Problem with https://www.google.com and	squid	interception
</A></li>
	<LI>Next message (by thread): <A HREF="000733.html">[squid-users] connecting directly to ssl-bump intercept port causes	runaway CPU
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#751">[ date ]</a>
              <a href="thread.html#751">[ thread ]</a>
              <a href="subject.html#751">[ subject ]</a>
              <a href="author.html#751">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
