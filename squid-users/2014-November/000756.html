<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] connecting directly to ssl-bump intercept port	causes runaway CPU
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connecting%20directly%20to%20ssl-bump%20intercept%20port%0A%09causes%20runaway%20CPU&In-Reply-To=%3C5463C6A1.6090709%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000752.html">
   <LINK REL="Next"  HREF="000753.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] connecting directly to ssl-bump intercept port	causes runaway CPU</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connecting%20directly%20to%20ssl-bump%20intercept%20port%0A%09causes%20runaway%20CPU&In-Reply-To=%3C5463C6A1.6090709%40ngtech.co.il%3E"
       TITLE="[squid-users] connecting directly to ssl-bump intercept port	causes runaway CPU">eliezer at ngtech.co.il
       </A><BR>
    <I>Wed Nov 12 20:44:17 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000752.html">[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
</A></li>
        <LI>Next message (by thread): <A HREF="000753.html">[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#756">[ date ]</a>
              <a href="thread.html#756">[ thread ]</a>
              <a href="subject.html#756">[ subject ]</a>
              <a href="author.html#756">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hey Jason,

Indeed it is nasty.
I do not remember now how I advised in the past to defend against this
issue.
There is a &quot;risk&quot; in every system operation and this is one of them.
You indeed found this &quot;bug&quot; or security vulnerability!

Specially on linux the main way to handle this issue is disabling
direct access to the intercepting port.
The options on linux are basically iptables mangle table rules.
There is however the specific case that iptables do not cover and it's
the case is:(sysadmin R rated knowledge ahead)
using a remote ip with a specific address such as localhost which is
defined on the proxy.
practical example:
# nc -v 8.8.8.8 80
&gt;<i> GET <A HREF="http://localhost/">http://localhost/</A> HTTP/1.1 Host: localhost
</I>...
##END of example
The above example was tested in the past on too many systems and was
and still on some there.
Some will call it a bug and others will call it a feature.
I would say something similar to what I have seen in the old movie &quot;3
ninjas&quot;:
&quot;with power comes responsibility&quot;

Squid has the means to defend against such vulnerability but only a
good admin will be able to use them.

All The Bests,
Eliezer

* 3 ninjas(PG) - <A HREF="http://www.imdb.com/title/tt0103596/">http://www.imdb.com/title/tt0103596/</A>


On 11/12/2014 09:15 PM, Jason Haar wrote:
&gt;<i> Ah! Yeah - nasty
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Please stop using telnet and manual data entry to test HTTP
</I>&gt;&gt;&gt;<i> services. If you knew enough about the protocol to type it into
</I>&gt;&gt;&gt;<i> telnet correctly the above loop problems would not be
</I>&gt;&gt;&gt;<i> surprising you.
</I>&gt;&gt;&gt;<i> 
</I>&gt;<i> So you're saying this is expected behaviour? Squid with HTTPS
</I>&gt;<i> intercept enabled is vulnerable to DoS attacks with a simple
</I>&gt;<i> 3-way?
</I>&gt;<i> 
</I>&gt;<i> Now that you have explained it to me, I can see the issue, but I
</I>&gt;<i> think squid needs to do something about it. eg when squid starts it
</I>&gt;<i> could make a note of all it's own IP addresses:ports, then if
</I>&gt;<i> someone asks squid to connect to those combinations, reject it.
</I>&gt;<i> There is no valid case where squid should ever be used to connect
</I>&gt;<i> to itself that I can think of
</I>&gt;<i> 
</I>&gt;<i> I just made the following changes
</I>&gt;<i> 
</I>&gt;<i> acl localSquidServer    src 127.0.0.1 proxy.ip.address deny_info
</I>&gt;<i> ERR_LOCALSQUID    localSquidServer http_access deny
</I>&gt;<i> localSquidServer
</I>&gt;<i> 
</I>&gt;<i> Now when I connect to the HTTP (not https!) intercept port, I see
</I>&gt;<i> the html error page ERR_LOCALSQUID - great - works like it says on
</I>&gt;<i> the box. However, that deny doesn't trigger for https (it's the
</I>&gt;<i> first http_access entry BTW). Shouldn't that be a mechanism to
</I>&gt;<i> filter this DoS out? If not, shouldn't there be &quot;https_access&quot; to
</I>&gt;<i> achieve the same thing? I also tried using iptables to exclude such
</I>&gt;<i> connections, but my proxy is my default gateway and I couldn't come
</I>&gt;<i> up with a rule that worked without breaking redirection all
</I>&gt;<i> together.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> A proper HTTP client software like squidclient, wget, curl, or
</I>&gt;&gt;&gt;<i> even a full browser should be used.
</I>&gt;<i> I explicit mentioned telnet (nc is the same) because it means it 
</I>&gt;<i> triggers on any successful TCP 3-way handshake - no data needs to
</I>&gt;<i> flow for the fault to trigger. If I call &quot;curl
</I>&gt;<i> <A HREF="http://proxy.server:3127">http://proxy.server:3127</A>&quot; it also triggers the runaway CPU (3127
</I>&gt;<i> being my https intercept port of course).
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQEcBAEBAgAGBQJUY8agAAoJENxnfXtQ8ZQUVZwIAIYMgkYvUwvBG346VIeTFso5
b5qyzM9iTk6M/xWKO9Ml3ZfNh2EE4yFcdSyj3du+dRwXYadqRmOOn+FOskEWHIrd
4S5K/7wF3fsXFXJbie54QwY1o32rS8R4ZA/3NANrJt+n5/kHTccp/7UtQm5rCL/8
9eKAvQPBqvx/hfB1nfZkRpbMn5bHJKG0LUQDigmCIKBMkgjFoBRfpiFz5TNHcohS
/n7JZAUalCLqpfI9n1TSZ43wfvzKj+/f0ToEEdyxXH7K6+/QfjKeQYhAkhmNNpky
T1/ceT4/QQGzcClxnv4Lm/ZOLk37s+UWHCevvvJGlfGjUIO/5D9JAtLSfY6gG4E=
=AiTp
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000752.html">[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
</A></li>
	<LI>Next message (by thread): <A HREF="000753.html">[squid-users] connecting directly to ssl-bump intercept port causes runaway CPU
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#756">[ date ]</a>
              <a href="thread.html#756">[ thread ]</a>
              <a href="subject.html#756">[ subject ]</a>
              <a href="author.html#756">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
