<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache peer problem with two squid one Tproxy	---&gt;normal Porxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20problem%20with%20two%20squid%20one%20Tproxy%0A%09---%3Enormal%20Porxy&In-Reply-To=%3C001d01cfff45%248c493cf0%24a4dbb6d0%24%40netstream.ps%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000764.html">
   <LINK REL="Next"  HREF="000768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache peer problem with two squid one Tproxy	---&gt;normal Porxy</H1>
    <B>Ahmed Allzaeem</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20problem%20with%20two%20squid%20one%20Tproxy%0A%09---%3Enormal%20Porxy&In-Reply-To=%3C001d01cfff45%248c493cf0%24a4dbb6d0%24%40netstream.ps%3E"
       TITLE="[squid-users] cache peer problem with two squid one Tproxy	---&gt;normal Porxy">ahmed.zaeem at netstream.ps
       </A><BR>
    <I>Thu Nov 13 13:27:15 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000764.html">[squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy
</A></li>
        <LI>Next message (by thread): <A HREF="000768.html">[squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#766">[ date ]</a>
              <a href="thread.html#766">[ thread ]</a>
              <a href="subject.html#766">[ subject ]</a>
              <a href="author.html#766">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos , thanks for all explanation.

But the problem solved when I added the following directives to the tproxy server :
##############################
forwarded_for off
request_header_access Allow allow all
request_header_access Authorization allow all
request_header_access WWW-Authenticate allow all
request_header_access Proxy-Authorization allow all
request_header_access Proxy-Authenticate allow all
request_header_access Cache-Control allow all
request_header_access Content-Encoding allow all
request_header_access Content-Length allow all
request_header_access Content-Type allow all
request_header_access Date allow all
request_header_access Expires allow all
request_header_access Host allow all
request_header_access If-Modified-Since allow all
request_header_access Last-Modified allow all
request_header_access Location allow all
request_header_access Pragma allow all
request_header_access Accept allow all
request_header_access Accept-Charset allow all
request_header_access Accept-Encoding allow all
request_header_access Accept-Language allow all
request_header_access Content-Language allow all
request_header_access Mime-Version allow all
request_header_access Retry-After allow all
request_header_access Title allow all
request_header_access Connection allow all
request_header_access Proxy-Connection allow all
request_header_access User-Agent allow all
request_header_access Cookie allow all
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access All allow all
#############################


Now everything is working fine with with me

But one last thing I need.

I need the tproxy server forward the packet with the original ip of the clients .... I mean I want to still keeping the tproxy function whereas now all cliewnts to to the peer with the ip of the tproxy server.

I need each user go to the parent proxy with the original ip

Can I do it with directive ?

Again , here is the directive I put on the tproxy to go to to parent :

cache_peer 77.221.104.97  parent 3127 0 no-query no-digest no-tproxy proxy-only


thank you alot

-----Original Message-----
From: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>] 
Sent: Wednesday, November 12, 2014 6:55 PM
To: Ahmed Allzaeem; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 13/11/2014 7:39 p.m., Ahmed Allzaeem wrote:
&gt;<i> Hi amos
</I>&gt;<i> 
</I>&gt;<i> I have changed the both hostnames on two servers :
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at tproxy</A> ~]# hostname tproxy.com
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at parent</A> ~]# hostname parent.com
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Good.

&gt;<i> but , as I told u last time I can see traffic &quot;miss&quot; on the normal 
</I>&gt;<i> proxy , and &quot;miss&quot; on the tproxy server.
</I>&gt;<i> 
</I>&gt;<i> But it says access denied  from normal proxy
</I>&gt;<i> 
</I>&gt;<i> I mean on the normal proxy &quot;parent&quot; there is only miss and no Denied 
</I>&gt;<i> hits , but it give me error access denid.
</I>
Just to double check. The access.log records a TCP_MISS/403 ?

 That is a &quot;Access denied&quot; error coming from the origin server.


PS. DENIED is rejection. HIT is acceptance. A single proxy cannot accept and reject at the same time.

&gt;<i> 
</I>&gt;<i> Also I made sure that the ip of tproxy is allowed by acl on the normal 
</I>&gt;<i> proxy&quot;parent&quot;
</I>&gt;<i> 
</I>
Good.

&gt;<i> 
</I>&gt;<i> Again , here is the  cache log @ the parent proxy , still says a loop 
</I>&gt;<i> occurring :
</I>&gt;<i> 
</I>&gt;<i> 2014/11/12 23:33:24 kid1| WARNING: Forwarding loop detected for: 
</I>&gt;<i> GET / HTTP/1.1
</I>
URL &quot;/&quot; is *not* a forward-proxy syntax URL. It is an origin server syntax URL.

This URL syntax should only ever be seen as the first (tproxy) configured proxy. Never at the parent. For the parent to receive this message syntax is an &quot;Invalid Request&quot; error.

This is therefore very, very strange.


&gt;<i> Host: abc.com User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64;
</I>&gt;<i> rv:33.0) Gecko/20100101 Firefox/33.0 Accept:
</I>&gt;<i> text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</I>&gt;<i> Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Via:
</I>&gt;<i> 1.1 squid (squid/3.4.3)
</I>
Notice how this is neither &quot;tproxy.com&quot; nor &quot;parent.com&quot; which your hostname is set to.

Lets try the shortcut for now and set visible_hostname in both proxies to the relevant tproxy.com//parent.com/


&gt;<i> X-Forwarded-For: 176.58.79.248 Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>
The *only* ways a normal forward-proxy parent could be recording
forwarding loops is:

1) Via header already contains its hostname.

2) the URL domain:port resolves in DNS to the proxy listening IP:port.

3) the parent proxy is configured to use itself as a cache_peer.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUZB2aAAoJELJo5wb/XPRjV7AIAI6OZaoaftNd2QoTVHb/6FB8
9rFKQLc1zRfLHTBCO0QM1tq4eph751Gk0SFnzzr0gNw9Mzbg6Tkbkrtkt1jtu33m
I0dQ5YOzJpcYhuZ1ufXoMXjV1ihcw33BQit1w80QV/rclQqlYSqMcHXfK1t0bR5n
B4oplYBSVxZ+1ttAAUFdVNp//yT7vrNGQezudEsxhkvqOpiaajZcIK5S3AT8msi1
/TYtOoWhVa/nkZDUxMa/BGzAaeq2SED/RQdgCZcCrvCRfbahzFc4nGAtcDho0HVZ
yFIYCN5vmEhYfg/0kEkLj4jgiJA9VpfwTOdAX9lGPEHGzO36f8h94lFZoPEFMJU=
=+YST
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000764.html">[squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy
</A></li>
	<LI>Next message (by thread): <A HREF="000768.html">[squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#766">[ date ]</a>
              <a href="thread.html#766">[ thread ]</a>
              <a href="subject.html#766">[ subject ]</a>
              <a href="author.html#766">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
