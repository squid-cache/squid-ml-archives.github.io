<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20problem%20with%20two%20squid%20one%20Tproxy%0A%20---%3Enormal%20Porxy&In-Reply-To=%3C54643018.9000601%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000766.html">
   <LINK REL="Next"  HREF="000758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20problem%20with%20two%20squid%20one%20Tproxy%0A%20---%3Enormal%20Porxy&In-Reply-To=%3C54643018.9000601%40treenet.co.nz%3E"
       TITLE="[squid-users] cache peer problem with two squid one Tproxy ---&gt;normal Porxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov 13 04:14:16 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000766.html">[squid-users] cache peer problem with two squid one Tproxy	---&gt;normal Porxy
</A></li>
        <LI>Next message (by thread): <A HREF="000758.html">[squid-users] OT: why does openssl-1.0.1f not like	https://www.bnz.co.nz/?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#768">[ date ]</a>
              <a href="thread.html#768">[ thread ]</a>
              <a href="subject.html#768">[ subject ]</a>
              <a href="author.html#768">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 14/11/2014 2:27 a.m., Ahmed Allzaeem wrote:
&gt;<i> Hi Amos , thanks for all explanation.
</I>&gt;<i> 
</I>&gt;<i> But the problem solved when I added the following directives to the
</I>&gt;<i> tproxy server : ############################## forwarded_for off
</I>
* that breaks any possibility of the parent proxy identifying what the
client IP was.

&gt;<i> request_header_access Via deny all
</I>
This alone breaks the forwarding loop detection. Just prevents you
seeing whats going on.


&gt;<i> Now everything is working fine with with me
</I>&gt;<i> 
</I>
Whatever looping was going on is still happening out of sight and
could bite at any time.

&gt;<i> But one last thing I need.
</I>&gt;<i> 
</I>&gt;<i> I need the tproxy server forward the packet with the original ip of
</I>&gt;<i> the clients .... I mean I want to still keeping the tproxy function
</I>&gt;<i> whereas now all cliewnts to to the peer with the ip of the tproxy
</I>&gt;<i> server.
</I>&gt;<i> 
</I>&gt;<i> I need each user go to the parent proxy with the original ip
</I>
 user != client.

In the context of TPROXY a client is a piece of machinery or software.
A User remains a person or logical identity.

When traffic arrives at the parent proxy the user remains whoever
started the transaction the *client* however actually *is* the tproxy
regardless of what the IPs say.

&gt;<i> 
</I>&gt;<i> Can I do it with directive ?
</I>
Spoofing arbitrary outgoing IPs is not supported behaviour. (It is
also actively illegal in places.)

If the parent proxy is not receiving TPROXY packets directly it cannot
spoof the outgoing.

To do what you ask will require *both* proxies to be setup as TPROXY,
no cache_peer link between them. The network routing must pass packets
from machine A (users) through machine B (child proxy) through machine
C (parent proxy) as if they were regular routers in a chain.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUZDAYAAoJELJo5wb/XPRjllEIAMo1zAQvRy1cSJaxy64i2ZKy
GaMnSwe14c255aDV2Pmr8tPTWv9udA/g+t1D25fM3RMEiut2aN5n2g6ArWABPpXX
bJOjPZiq+SkaZZq1JLP4ncTfk5TyLxVXxuRJnAAVyGZpX0lyoD/EoXAvBLpZf3EN
Fhx3EnKq0baf/pHtu1UAnuCdU0eVHElAfk/srLpSS42O8O56RAzjjZ24QltIWmys
e1nUIYnbzRhF1krD3QLKTWR14Tq76Ww2syB3TpRlHrH2SH3JNMa2wA+u9pYSKGO8
URSoMguyYjQkF/S6mWxfXHpvJ/hl0uvs8RoMzWVSI7pLP17y3nM7FDaqmlmJqGk=
=NJbJ
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000766.html">[squid-users] cache peer problem with two squid one Tproxy	---&gt;normal Porxy
</A></li>
	<LI>Next message (by thread): <A HREF="000758.html">[squid-users] OT: why does openssl-1.0.1f not like	https://www.bnz.co.nz/?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#768">[ date ]</a>
              <a href="thread.html#768">[ thread ]</a>
              <a href="subject.html#768">[ subject ]</a>
              <a href="author.html#768">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
