<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Centralized Squid - design and implementation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Centralized%20Squid%20-%20design%20and%20implementation&In-Reply-To=%3C1416156703.4763.12.camel%40desktop.bpk2.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000823.html">
   <LINK REL="Next"  HREF="000826.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Centralized Squid - design and implementation</H1>
    <B>Brendan Kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Centralized%20Squid%20-%20design%20and%20implementation&In-Reply-To=%3C1416156703.4763.12.camel%40desktop.bpk2.com%3E"
       TITLE="[squid-users] Centralized Squid - design and implementation">bpk678 at gmail.com
       </A><BR>
    <I>Sun Nov 16 16:51:43 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000823.html">[squid-users] Centralized Squid - design and implementation
</A></li>
        <LI>Next message (by thread): <A HREF="000826.html">[squid-users] Centralized Squid - design and implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#824">[ date ]</a>
              <a href="thread.html#824">[ thread ]</a>
              <a href="subject.html#824">[ subject ]</a>
              <a href="author.html#824">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 2014-11-16 at 17:22 +0100, Kinkie wrote:
&gt;<i> On Sun, Nov 16, 2014 at 4:54 PM, alberto &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">alberto.furia at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hello everyone,
</I>&gt;<i> &gt; first of all thanks to the community of squid for such a great job.
</I>&gt;<i> 
</I>&gt;<i> Hello Alberto,
</I>&gt;<i> 
</I>&gt;<i> [...]
</I>&gt;<i> 
</I>&gt;<i> &gt; I have some questions that I would like to share with you:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. I would like to leave the solution we are using now (wpad balancing). In
</I>&gt;<i> &gt; a situation like the one I have described, centralized squid serving the
</I>&gt;<i> &gt; spokes/branches, which is the best solution for clustering/HA? If one of the
</I>&gt;<i> &gt; centralized nodes had to &quot;die&quot; I would like client machines not to remain
</I>&gt;<i> &gt; &quot;hanging&quot; but to continue working on an active node without disruption. A
</I>&gt;<i> &gt; hierarchy of proxy would be the solution?
</I>&gt;<i> 
</I>&gt;<i> If you want to maximize the efficiency of your balancing solution, you
</I>&gt;<i> probably want a slightly different approach: instead of using the
</I>&gt;<i> client-ip as hashing mechanism, you want to hash on the destination
</I>&gt;<i> host.
</I>&gt;<i> e.g. have a pac-file like (untested, and to be adjusted):
</I>&gt;<i> 
</I>&gt;<i> function FindProxyForURL(url, host) {
</I>&gt;<i>    var dest_ip = dnsResolve(host);
</I>&gt;<i>    var dest_hash= dest_ip.slice(-1) % 2;
</I>&gt;<i>    if (dest_hash)
</I>&gt;<i>      return &quot;PROXY local_proxy1:port; PROXY local_proxy2:port; DIRECT&quot;;
</I>&gt;<i>    return &quot;PROXY local_proxy2:port; PROXY local_proxy1:port; DIRECT&quot;
</I>&gt;<i> }
</I>&gt;<i> This will balance by the final digit of the destination IP of the
</I>&gt;<i> service. The downside is that it requires DNS lookups by the clients,
</I>&gt;<i> and that if the primary local proxy fails, it takes a few seconds (up
</I>&gt;<i> to 30) for clients to give up and fail over to secondary.
</I>&gt;<i> 
</I>&gt;<i> local_proxies can then either go direct to the origin server (if
</I>&gt;<i> intranet) or use a balancing mechanism such as carp (see the
</I>&gt;<i> documentation for the cache_peer directive in squid) to maximize
</I>&gt;<i> efficiency, especially for Internet destinations.
</I>&gt;<i> 
</I>&gt;<i> The only single-point-of-failure at the HTTP level in this design is
</I>&gt;<i> the PACfile server, it'll be up to you to make that reliable.
</I>&gt;<i> 
</I>&gt;<i> &gt; 2. Bearing in mind that all users will be AD authenticated, which url
</I>&gt;<i> &gt; filtering/blacklist solution do you suggest?
</I>&gt;<i> &gt; In the past I have worked a lot with squidguard and dansguardian but now
</I>&gt;<i> &gt; they don't seem to be the state of the art anymore.
</I>&gt;<i> &gt; I've been thinking about two different solutions:
</I>&gt;<i> &gt;   2a. To use the native acl squid with the squidblacklist.org lists
</I>&gt;<i> &gt; (<A HREF="http://www.squidblacklist.org/">http://www.squidblacklist.org/</A>)
</I>&gt;<i> &gt;   2b. To use urlfilterdb (<A HREF="http://www.urlfilterdb.com/products/overview.html">http://www.urlfilterdb.com/products/overview.html</A>)
</I>&gt;<i> 
</I>&gt;<i> I don't know, sorry.
</I>&gt;<i> 
</I>&gt;<i> &gt; 3. Which GNU/Linux distro do you suggest me? I was thinking about Debian
</I>&gt;<i> &gt; Jessie (just frozen) or CentOS7.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/BestOsForSquid">http://wiki.squid-cache.org/BestOsForSquid</A>
</I>&gt;<i> 
</I>
i have all my squid instances (only 2 right now) share their caches:
cache_peer 192.168.25.1 sibling 3128    4827    htcp=no-clr
and
cache_peer 192.168.50.1 sibling 3128    4827    htcp=no-clr

which allows for anything cached to be served from local cache or a
sibling, instead of from the internet.  the likelihood of the sibling
cache being faster than the internet is high.

i use HAProxy to load balance based on the least number of connections
associated with the a pool member.  since i am sharing caches, i dont
need to pin a client or request to any particular proxy, at all or for
only a period of time.  with HAProxy, i only see a couple of seconds
interruption when one proxy goes offline.  generally this is trivial in
the end user experience.  i have it logging when instances go offline or
come back online, and the stats web interface is handy for quickly
checking status.

while i dont have any suggestions about which filtering option to use, i
will note that DansGuardian versions i have found are only HTTP/1.0
compliant, so you are likely losing gzip compression at the protocol
layer, and caching is likely affected, too.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000823.html">[squid-users] Centralized Squid - design and implementation
</A></li>
	<LI>Next message (by thread): <A HREF="000826.html">[squid-users] Centralized Squid - design and implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#824">[ date ]</a>
              <a href="thread.html#824">[ thread ]</a>
              <a href="subject.html#824">[ subject ]</a>
              <a href="author.html#824">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
