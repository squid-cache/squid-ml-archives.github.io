<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Removing cache credentials
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Removing%20cache%20credentials&In-Reply-To=%3C54699AD1.8030504%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000835.html">
   <LINK REL="Next"  HREF="000837.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Removing cache credentials</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Removing%20cache%20credentials&In-Reply-To=%3C54699AD1.8030504%40treenet.co.nz%3E"
       TITLE="[squid-users] Removing cache credentials">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Nov 17 06:50:57 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000835.html">[squid-users] Removing cache credentials
</A></li>
        <LI>Next message (by thread): <A HREF="000837.html">[squid-users] Removing cache credentials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#836">[ date ]</a>
              <a href="thread.html#836">[ thread ]</a>
              <a href="subject.html#836">[ subject ]</a>
              <a href="author.html#836">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 17/11/2014 5:26 p.m., Victor Sudakov wrote:
&gt;<i> Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> If we speak about Kerberos authentication. On the very first 
</I>&gt;&gt;&gt;<i> request, the browser receives a &quot;407 Proxy Authentication
</I>&gt;&gt;&gt;<i> Required&quot; reply and learns that it is expected to provide
</I>&gt;&gt;&gt;<i> credentials. For a certain amount of time, the browser knows
</I>&gt;&gt;&gt;<i> that it should send the credentials with every request without
</I>&gt;&gt;&gt;<i> waiting for an 407 reply.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> How long is this amount of time? Is it like forever?  Is there
</I>&gt;&gt;&gt;<i> ever a limit after which the browser will try again to send a
</I>&gt;&gt;&gt;<i> request without credentials? Maybe after a browser restart or
</I>&gt;&gt;&gt;<i> what?
</I>&gt;&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Negotiate/Kerberos (and NTLM) do not authenticate the request.
</I>&gt;&gt;<i> They abuse HTTP to authenticate the TCP connection underneath
</I>&gt;&gt;<i> HTTP. So the credentials must be re-used for the entire lifetime
</I>&gt;&gt;<i> of that TCP connection. Changing credentials means tearing down
</I>&gt;&gt;<i> that whole TCP connection.
</I>&gt;<i> 
</I>&gt;<i> As far as I understood you, there would be a &quot;407 Proxy
</I>&gt;<i> Authentication Required&quot; and &quot;Proxy-Authorization: Negotiate&quot; pair
</I>&gt;<i> in each TCP connection between browser and proxy.
</I>
407 is repeated as many times as necesary until the client starts
sending valid credentials. Proxy-Authorization is used on every
request containing any credentials. That is the basic requirement for
any HTTP auth schemes.

They are not a pair. Since there is no requirement for anything to
follow the 407. Nor is there even a requirement for the two messages
to be sent on the same TCP connection (eg &quot;auth_param ... keep_alive
off&quot;). Statelessness is fun sometimes.

&gt;<i> 
</I>&gt;<i> If the connection is used for several requests, only the first
</I>&gt;<i> HTTP request in the connection would contain authentication info.
</I>
No. Once authentication is accepted on a connection the credentials
token MUST be sent on all following requests.

 - So far that is basic HTTP auth requirements. Now things get weird...

Lack of Negotiate credentials on any request is a sign of injection
attack being performed and the TCP connection must be torn down.

To do that tear-down Squid can send 407 challenge with
Connection:close such that the client can resume with
re-authentication on new TCP connection(s) without waiting for any 407.


&gt;<i> But each new TCP connection is re-authenticated by HTTP. Is this
</I>&gt;<i> correct?
</I>
Not really. A TCP connection may be used for multiple requests before
one needs to authenticate and kicks out a 407.

If you offer Basic Digest, Bearer or other properly HTTP compliant
auth schemes there is even the possibility that multiple different
types of credentials were happily being multiplexed over the single
connection until NTLM/Negotiate gets in the way.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUaZrRAAoJELJo5wb/XPRjCNIH/2/Shwg113XcpKnyF+CATG8C
vxpa88xuajuqiwHRBtPd6caQDbnQi05HXuoD+RUmS+bhLeHhFg/5AZPswnCLLp7N
SmoOcc7yB80+0/Cmy31CpfO0QWm5GnkMHM40Kj7Lftms2AUKdOtmxoBITJYKTmPf
hXEktNtD78K8rB0qHg5s38Z/wd3K7YNvGTBlNacbpLM0TYx1CELkccA7ifx+t3Ut
rLKqZJHUbSWAhmBeHs6eLu2KXp+0ZA1gp5HqDmg7XaRtzWAJpy9K0+zpPEVdVZcz
rYPsCjdOuesHrWc99pNp4d3RFggXQ6298eJHthhNwqdVwMhhkfRGcp1fyNNIx2E=
=8j6B
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000835.html">[squid-users] Removing cache credentials
</A></li>
	<LI>Next message (by thread): <A HREF="000837.html">[squid-users] Removing cache credentials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#836">[ date ]</a>
              <a href="thread.html#836">[ thread ]</a>
              <a href="subject.html#836">[ subject ]</a>
              <a href="author.html#836">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
