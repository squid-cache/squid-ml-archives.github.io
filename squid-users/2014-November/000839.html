<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RFC2616 headers in bumped requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C5469CD2B.8080802%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000605.html">
   <LINK REL="Next"  HREF="000847.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RFC2616 headers in bumped requests</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C5469CD2B.8080802%40opendium.com%3E"
       TITLE="[squid-users] RFC2616 headers in bumped requests">steve at opendium.com
       </A><BR>
    <I>Mon Nov 17 10:25:47 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000605.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
        <LI>Next message (by thread): <A HREF="000847.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#839">[ date ]</a>
              <a href="thread.html#839">[ thread ]</a>
              <a href="subject.html#839">[ subject ]</a>
              <a href="author.html#839">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/11/14 13:59, Amos Jeffries wrote:

&gt;&gt;<i> I've just come across a web server that throws its toys out of the
</I>&gt;&gt;<i> pram when it sees a Via header in an HTTPS request, and
</I>&gt;&gt;<i> unfortunately it's quite a big one - Yahoo.  See this request:
</I>&gt;<i> 
</I>&gt;&gt;<i> ----- GET /news/degrees-lead-best-paid-careers-141513989.html
</I>&gt;&gt;<i> HTTP/1.1 Host: uk.finance.yahoo.com Via: 1.1
</I>&gt;<i> 
</I>&gt;<i> That is unfortunately an invalid HTTP Via header. It is mandatory to
</I>&gt;<i> contain the host field even if it contains a host alias for the real
</I>&gt;<i> FQDN. If that is what is actually being transfered the server is right
</I>&gt;<i> in complaining.
</I>
It looks like I copied and pasted this wrong in my original email, I
have just retested and squid sends:
  Via: 1.1 iceni2.opendium.net (squid/3.4.9)

&gt;&gt;<i> For now I have worked around it with: request_header_access Via
</I>&gt;&gt;<i> deny https request_header_access X-Forwarded-For deny https But it
</I>&gt;&gt;<i> does make me wonder if inserting the headers into bumped traffic is
</I>&gt;&gt;<i> a sensible thing to do.
</I>&gt;<i> 
</I>&gt;<i> If you can please chek that Via header being emitted by your Squid
</I>&gt;<i> when things break. And also whether your Squid is contacting their
</I>&gt;<i> server on an HTTPS or HTTP port.
</I>&gt;<i>  If your Squid is contacting their HTTP port for un-encrypted traffic
</I>&gt;<i> this redirect is competely expected.
</I>
This is definitely occurring when contacting the server on HTTPS with a
valid Via header:

$ openssl s_client -connect uk.finance.yahoo.com:443 -servername
uk.finance.yahoo.com
CONNECTED(00000003)
depth=3 C = US, O = &quot;VeriSign, Inc.&quot;, OU = Class 3 Public Primary
Certification Authority
verify return:1
depth=2 C = US, O = &quot;VeriSign, Inc.&quot;, OU = VeriSign Trust Network, OU =
&quot;(c) 2006 VeriSign, Inc. - For authorized use only&quot;, CN = VeriSign Class
3 Public Primary Certification Authority - G5
verify return:1
depth=1 C = US, O = &quot;VeriSign, Inc.&quot;, OU = VeriSign Trust Network, OU =
Terms of use at <A HREF="https://www.verisign.com/rpa">https://www.verisign.com/rpa</A> (c)10, CN = VeriSign Class
3 Secure Server CA - G3
verify return:1
depth=0 C = US, ST = California, L = Sunnyvale, O = Yahoo Inc., CN =
www.yahoo.com
verify return:1
---
Certificate chain
 0 s:/C=US/ST=California/L=Sunnyvale/O=Yahoo Inc./CN=www.yahoo.com
   i:/C=US/O=VeriSign, Inc./OU=VeriSign Trust Network/OU=Terms of use at
<A HREF="https://www.verisign.com/rpa">https://www.verisign.com/rpa</A> (c)10/CN=VeriSign Class 3 Secure Server CA - G3
 1 s:/C=US/O=VeriSign, Inc./OU=VeriSign Trust Network/OU=Terms of use at
<A HREF="https://www.verisign.com/rpa">https://www.verisign.com/rpa</A> (c)10/CN=VeriSign Class 3 Secure Server CA - G3
   i:/C=US/O=VeriSign, Inc./OU=VeriSign Trust Network/OU=(c) 2006
VeriSign, Inc. - For authorized use only/CN=VeriSign Class 3 Public
Primary Certification Authority - G5
 2 s:/C=US/O=VeriSign, Inc./OU=VeriSign Trust Network/OU=(c) 2006
VeriSign, Inc. - For authorized use only/CN=VeriSign Class 3 Public
Primary Certification Authority - G5
   i:/C=US/O=VeriSign, Inc./OU=Class 3 Public Primary Certification
Authority
---
[certificate removed]
---
GET /news/degrees-lead-best-paid-careers-141513989.html HTTP/1.1
Host: uk.finance.yahoo.com
Via: 1.1 iceni2.opendium.net (squid/3.4.9)

HTTP/1.1 301 Moved Permanently
Date: Mon, 17 Nov 2014 10:20:57 GMT
Via: http/1.1 yts272.global.media.ir2.yahoo.com (ApacheTrafficServer [c
s f ]), http/1.1 r15.ycpi.dee.yahoo.net (ApacheTrafficServer [cMsSfW])
Server: ATS
Strict-Transport-Security: max-age=172800
Location:
<A HREF="https://uk.finance.yahoo.com/news/degrees-lead-best-paid-careers-141513989.html">https://uk.finance.yahoo.com/news/degrees-lead-best-paid-careers-141513989.html</A>
Content-Length: 0
Age: 0
Connection: keep-alive

-- 

 - Steve

-- 

 - Steve Hill
   Technical Director
   Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
   Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
   Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
   Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
   Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
   Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
   Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
   Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000605.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
	<LI>Next message (by thread): <A HREF="000847.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#839">[ date ]</a>
              <a href="thread.html#839">[ thread ]</a>
              <a href="subject.html#839">[ subject ]</a>
              <a href="author.html#839">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
