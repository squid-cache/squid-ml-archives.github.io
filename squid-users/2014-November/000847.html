<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RFC2616 headers in bumped requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C546A7111.70605%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000839.html">
   <LINK REL="Next"  HREF="000883.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RFC2616 headers in bumped requests</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C546A7111.70605%40treenet.co.nz%3E"
       TITLE="[squid-users] RFC2616 headers in bumped requests">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Nov 17 22:05:05 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000839.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
        <LI>Next message (by thread): <A HREF="000883.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#847">[ date ]</a>
              <a href="thread.html#847">[ thread ]</a>
              <a href="subject.html#847">[ subject ]</a>
              <a href="author.html#847">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 17/11/2014 11:25 p.m., Steve Hill wrote:
&gt;<i> On 04/11/14 13:59, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I've just come across a web server that throws its toys out of
</I>&gt;&gt;&gt;<i> the pram when it sees a Via header in an HTTPS request, and 
</I>&gt;&gt;&gt;<i> unfortunately it's quite a big one - Yahoo.  See this request:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ----- GET /news/degrees-lead-best-paid-careers-141513989.html 
</I>&gt;&gt;&gt;<i> HTTP/1.1 Host: uk.finance.yahoo.com Via: 1.1
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> That is unfortunately an invalid HTTP Via header. It is mandatory
</I>&gt;&gt;<i> to contain the host field even if it contains a host alias for
</I>&gt;&gt;<i> the real FQDN. If that is what is actually being transfered the
</I>&gt;&gt;<i> server is right in complaining.
</I>&gt;<i> 
</I>&gt;<i> It looks like I copied and pasted this wrong in my original email,
</I>&gt;<i> I have just retested and squid sends: Via: 1.1 iceni2.opendium.net
</I>&gt;<i> (squid/3.4.9)
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> For now I have worked around it with: request_header_access
</I>&gt;&gt;&gt;<i> Via deny https request_header_access X-Forwarded-For deny https
</I>&gt;&gt;&gt;<i> But it does make me wonder if inserting the headers into bumped
</I>&gt;&gt;&gt;<i> traffic is a sensible thing to do.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If you can please chek that Via header being emitted by your
</I>&gt;&gt;<i> Squid when things break. And also whether your Squid is
</I>&gt;&gt;<i> contacting their server on an HTTPS or HTTP port. If your Squid
</I>&gt;&gt;<i> is contacting their HTTP port for un-encrypted traffic this
</I>&gt;&gt;<i> redirect is competely expected.
</I>&gt;<i> 
</I>&gt;<i> This is definitely occurring when contacting the server on HTTPS
</I>&gt;<i> with a valid Via header:
</I>&gt;<i> 
</I>
Would you mind running an experiment for me?

To see what happens if Squid delivers either of these Via headers
instead of its current output:

  Via: HTTPS/1.1 iceni2.opendium.net (squid/3.4.9)

  Via: TLS/1.2 iceni2.opendium.net (squid/3.4.9)

Setting it with request_header_access/replace should do.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUanERAAoJELJo5wb/XPRjbX0IAIsacfWnhx0zsP8AIzjXFvIr
bg1c19Hbgk2OmcxpBMA3b5cWggqPnZskUkQ/SLZphjt9z/tIbMa5Mgl0Ih7vTg5X
Z9GhX+gf3YoM2WLMymWnvzCRzQ6NwZKs856TFWYtM0gV8HPRFlVyGBp8cxya4yYh
rdGcp++yAC2LmvIGmELnQtXf74XyaIBw+exWwXCokHPh3MTD1CmsrD8rm1WJ2tBC
JnTxT5p8QL2NcuCAQqw9uZuckG9aVUsAOOdxSO8l7rkcQnuRJZKm3ZO7y4/kYrcU
XO1riDW0Ow0Xx0HAF/HMkz+pux2sPVvMeDa3JSP07sIVrcc8eaISZPXaC3n8FBQ=
=Xwwe
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000839.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
	<LI>Next message (by thread): <A HREF="000883.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#847">[ date ]</a>
              <a href="thread.html#847">[ thread ]</a>
              <a href="subject.html#847">[ subject ]</a>
              <a href="author.html#847">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
