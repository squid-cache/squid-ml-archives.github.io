<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Centralized Squid - design and implementation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Centralized%20Squid%20-%20design%20and%20implementation&In-Reply-To=%3C1416314377.4763.35.camel%40desktop.bpk2.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000856.html">
   <LINK REL="Next"  HREF="000863.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Centralized Squid - design and implementation</H1>
    <B>Brendan Kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Centralized%20Squid%20-%20design%20and%20implementation&In-Reply-To=%3C1416314377.4763.35.camel%40desktop.bpk2.com%3E"
       TITLE="[squid-users] Centralized Squid - design and implementation">bpk678 at gmail.com
       </A><BR>
    <I>Tue Nov 18 12:39:37 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000856.html">[squid-users] Centralized Squid - design and implementation
</A></li>
        <LI>Next message (by thread): <A HREF="000863.html">[squid-users] Centralized Squid - design and implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#858">[ date ]</a>
              <a href="thread.html#858">[ thread ]</a>
              <a href="subject.html#858">[ subject ]</a>
              <a href="author.html#858">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2014-11-18 at 08:35 -0300, Carlos Defoe wrote:
&gt;<i> Well, you just wrote a load balancer in PHP, with a load balancing
</I>&gt;<i> algorithm in it. It serves the same purpose as HAproxy (I don't really
</I>&gt;<i> use HAproxy, so I don't know, but I use the F5 big-ip which is
</I>&gt;<i> perfectly capable of testing Internet links behind squid). In you
</I>&gt;<i> scheme, WPAD is being used to tell the clients where the load balancer
</I>&gt;<i> (a webserver with a php script) is, and PAC probably as the answer
</I>&gt;<i> format, which returns a currently valid proxy node address directly to
</I>&gt;<i> the client. But as far as I know, once the client gets the PAC answer,
</I>&gt;<i> it willl not refresh until the browser is restarted, so it might be a
</I>&gt;<i> small problem there.
</I>&gt;<i> 
</I>&gt;<i> But it is a good solution, as proved by your decade of using it, and
</I>&gt;<i> much cheaper than a F5. As for the DNS trick, it is intended to
</I>&gt;<i> increase high availability of the web servers that are serving
</I>&gt;<i> wpad.dat (or your php script), because if it runs on only one
</I>&gt;<i> webserver, at some point no clients will find anything at all.
</I>&gt;<i> 
</I>&gt;<i> Well, there's a lot of ways of doing the same thing, including ucarp,
</I>&gt;<i> squid cache_peer as Amos said... It's just a matter of picking the one
</I>&gt;<i> that fits.
</I>&gt;<i> 
</I>&gt;<i> On Tue, Nov 18, 2014 at 3:31 AM, Jason Haar &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Jason_Haar at trimble.com</A>&gt; wrote:
</I>&gt;<i> &gt; On 18/11/14 16:07, Carlos Defoe wrote:
</I>&gt;<i> &gt;&gt; As for my scenario, I also use wpad to configure some exceptions, some
</I>&gt;<i> &gt;&gt; clients that will use a completely different proxy, etc...
</I>&gt;<i> &gt; Our &quot;wpad.dat&quot; is actually a PHP script which tests that the &quot;official&quot;
</I>&gt;<i> &gt; proxy (per client subnet) is actually working (with caching of the
</I>&gt;<i> &gt; results for performance reasons of course), if not it flicks them off to
</I>&gt;<i> &gt; another site's proxy server. Much better than trying to do dynamic DNS
</I>&gt;<i> &gt; tricks with a local HAproxy. ie if you have actually lost local Internet
</I>&gt;<i> &gt; access due to an ISP outage, HAproxy isn't going to help. But if WPAD
</I>&gt;<i> &gt; knows that a WAN-connected proxy is still working - why not point your
</I>&gt;<i> &gt; users at that instead
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We've been doing this for 10+ years, 99% of the time it's never needed,
</I>&gt;<i> &gt; but when it's needed, it works :-)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Cheers
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Jason Haar
</I>&gt;<i> &gt; Corporate Information Security Manager, Trimble Navigation Ltd.
</I>&gt;<i> &gt; Phone: +1 408 481 8171
</I>&gt;<i> &gt; PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
web servers providing pac/wpad dont need to be a single point of
failure, given that multiple instances of web servers can be behind a
load balancer, just like squid.  i have this arrangement, and get plenty
of reliability out of it.  it scales well too.

i have setup my VIP for the proxies in such a way that if you hit port
8080 you get load balanced to the pool with all members in it.  if you
hit the VIP on port 8081, you get load balanced to a pool with only the
first proxy in it, 8082 goes to the second proxy, etc.  this allows me
to test each proxy individually, and because the VIP name is the same,
the same kerberos ticket satisfies the auth requests.  at work, we have
F5s as well, and as a service check we attempt to GET some content we
host, and attempt to GET google or cnn.  the check requires that at
least one of the GETs succeed, in order to mark the device up.  i dont
have the external check in my HAProxy configs, but might have to look
into it.

as for my pac/wpad script, i have logic in it to send requests proxied
or unproxied, based on my design or security decisions.  i have logic
for direct access domains, direct access hosts, direct access networks,
proxied domains (forces the use of the proxy, overriding any other
logic), proxied hosts (again, override logic), and hosts that are forced
via a specific proxy by sending the request to a specific port on the
VIP.

the bulk of my access will be proxied, and i return the VIP on port 8080
as the primary proxy, and then ports 8081, 8082, etc as secondary,
tertiary, and so on.  that way the browser will always get all possible
avenues for access, should something be wrong with one or more of the
VIPs.  what i am not sure of is if HAProxy will reply with a RST when no
pool member(s) is/are available for a given VIP/pool.  we have this
setup at work on the F5s, and i'm not sure if i have it in HAProxy (or
if i can do it at all).

i would suggest that if you use a pac/wpad solution, you look into
pactester, which is a google summer of code project that executes pac
files and provides output indicating what actions would be returned to
the browser, given a URL.  so, with my setup if i call pactester and
give it <A HREF="http://www.google.com,">http://www.google.com,</A> it returns to me:

PROXY proxy.bpk2.com:8080; PROXY proxy.bpk2.com:8081; PROXY
proxy.bpk2.com:8082

if i call pactester with <A HREF="http://www.bpk2.com,">http://www.bpk2.com,</A> it returns to me:

DIRECT

with a bit of scripting and a couple of files with URLs in them, i can
quickly evaluate my proxy script, validate the logic and perform a
rudimentary syntax and punctuation check on any changes i make to the
script.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000856.html">[squid-users] Centralized Squid - design and implementation
</A></li>
	<LI>Next message (by thread): <A HREF="000863.html">[squid-users] Centralized Squid - design and implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#858">[ date ]</a>
              <a href="thread.html#858">[ thread ]</a>
              <a href="subject.html#858">[ subject ]</a>
              <a href="author.html#858">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
