<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-3.4.8  intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-3.4.8%20%20intercept&In-Reply-To=%3C546C281B.5010103%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000864.html">
   <LINK REL="Next"  HREF="000953.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-3.4.8  intercept</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-3.4.8%20%20intercept&In-Reply-To=%3C546C281B.5010103%40treenet.co.nz%3E"
       TITLE="[squid-users] squid-3.4.8  intercept">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov 19 05:18:19 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000864.html">[squid-users] squid-3.4.8  intercept
</A></li>
        <LI>Next message (by thread): <A HREF="000953.html">[squid-users] cannot start Squid 3.4.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#868">[ date ]</a>
              <a href="thread.html#868">[ thread ]</a>
              <a href="subject.html#868">[ subject ]</a>
              <a href="author.html#868">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 19/11/2014 6:59 a.m., Frank wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Since upgrading from 3.1.22 to 3.4.8 I have been unable to get the 
</I>&gt;<i> transparent mode to accept my IP.  I am seeing permission denied in
</I>&gt;<i> the transaction when I do a packet dump. I have read the
</I>&gt;<i> documentation making changes for 3.4.8. I even allowed everything
</I>&gt;<i> and no go.
</I>&gt;<i> 
</I>&gt;<i> I also compiled squid and here is my configure script:
</I>&gt;<i> 
</I>&gt;<i> ./configure \ --prefix=/usr/share/squid-3.4.8  \ 
</I>&gt;<i> --libdir=/usr/lib${LIBDIRSUFFIX} \ --sysconfdir=/etc/squid \ 
</I>&gt;<i> --localstatedir=/var/log/squid \ --datadir=/usr/share/squid-3.4.8
</I>&gt;<i> \ --with-pidfile=/var/run/squid/squid.pid \ --mandir=/usr/man \ 
</I>&gt;<i> --with-logdir=/var/log/squid \ --enable-snmp \ 
</I>&gt;<i> --enable-ipf-transparent \ --enable-ipfw-transparent #
</I>&gt;<i> --enable-auth=&quot;basic&quot; \ #  --enable-basic-auth-helpers=&quot;NCSA&quot; \ #
</I>&gt;<i> --enable-linux-netfilter \ #  --enable-async-io \ #
</I>&gt;<i> --disable-strict-error-checking
</I>&gt;<i> 
</I>&gt;<i> My machine the browser is on:
</I>&gt;<i> 
</I>&gt;<i> 66.159.32.31
</I>&gt;<i> 
</I>&gt;<i> The machine that is running squid:
</I>&gt;<i> 
</I>&gt;<i> 66.159.47.22
</I>&gt;<i> 
</I>&gt;<i> Here is my squid.conf
</I>&gt;<i> 
</I>&gt;<i> ===================================================================================
</I>&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # # Recommended minimum configuration: #
</I>&gt;<i> 
</I>&gt;<i> cache_effective_user  squid cache_effective_group  squid
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks. # Adapt to
</I>&gt;<i> list your (internal) IP networks from where browsing # should be
</I>&gt;<i> allowed acl localnet src all    # RFC1918 possible internal
</I>&gt;<i> network
</I>
You are thus naming yourself the owner and operator with the *entire*
Internet as your LAN.


&gt;<i> #acl localnet src 66.159.32.0/24        # RFC1918 possible internal
</I>&gt;<i> network #acl localnet src 108.161.167.0/24      # RFC1918 possible
</I>&gt;<i> internal network #acl localnet src 66.159.47.0/24        # RFC1918
</I>&gt;<i> possible internal network #acl localnet src 127.0.0.0/24  # RFC1918
</I>&gt;<i> possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443 acl Safe_ports port 80          # http acl
</I>&gt;<i> Safe_ports port 21          # ftp acl Safe_ports port 443         #
</I>&gt;<i> https acl Safe_ports port 70          # gopher acl Safe_ports port
</I>&gt;<i> 210         # wais acl Safe_ports port 1025-65535  # unregistered
</I>&gt;<i> ports acl Safe_ports port 280         # http-mgmt acl Safe_ports
</I>&gt;<i> port 488         # gss-http acl Safe_ports port 591         #
</I>&gt;<i> filemaker acl Safe_ports port 777         # multiling http acl
</I>&gt;<i> CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # # Recommended minimum Access Permission configuration: # # Deny
</I>&gt;<i> requests to certain unsafe ports ########http_access deny
</I>&gt;<i> !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports 
</I>&gt;<i> ###########http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>
Undo the above disabling. When accepting traffic from anywhere on the
Internt it becomes more critical than ever that you block malicious
port usage.


&gt;<i> # Only allow cachemgr access from localhost 
</I>&gt;<i> ###############http_access allow localhost manager
</I>&gt;<i> 
</I>&gt;<i> ###############http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect
</I>&gt;<i> innocent # web applications running on the proxy server who think
</I>&gt;<i> the only # one who can access services on &quot;localhost&quot; is a local
</I>&gt;<i> user ############http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> # # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS 
</I>&gt;<i> # # Example rule allowing access from your local networks. # Adapt
</I>&gt;<i> localnet in the ACL section to list your (internal) IP networks #
</I>&gt;<i> from where browsing should be allowed
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy #http_access deny
</I>&gt;<i> all http_access allow all
</I>
You already allow localnet (aka 'all'). Undo this.

&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128 http_port 3128 http_port 3129
</I>&gt;<i> intercept
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
This is irrelevant. You have no cache_peer setting to bypass.

&lt;snip&gt;
&gt;<i> ==================================================================================
</I>&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> And I have configured my browser to use HTTP Proxy 66.159.47.22
</I>&gt;<i> Port 3129
</I>
Boom!. There is the problem #1.

* &quot;http_port 3128&quot; is for explicitly configured browsers.

* &quot;http_port 3129 intercept&quot; is for NAT intercepted traffic.

You MUST NOT combine the two traffic types on one port. The
reject/deny you are seeing are just the tip of the iceberg of problems
when that happens.

&gt;<i> 
</I>&gt;<i> I also setup iptables on my machine as follows and that didn't
</I>&gt;<i> work either. Same permission denied.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /sbin/iptables -t nat -A OUTPUT -p tcp -s 66.159.32.31 --dport 80
</I>&gt;<i> -j DNAT --to 66.159.47.22:3129
</I>
DNAT/REDIRECT of traffic entering Squid *MUST* be performed on the
Squid machine itself.

Here is the config you shoudld be using:
 &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;


Use normal routing to get the traffic from your users machine(s) to
the proxy machine. There are some examples here:
 &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>&gt;

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUbCgJAAoJELJo5wb/XPRjvioIALkqGbHFtXCZpww3/i3IzuAC
PpcRaYAXSqJxKcdncoSxfBtHiig1OxyARdSDqJ/PWRLEuVBkOG/uL5fHD19gwRaN
6aOsO/IZu8+Fg7Fl+DLVkoVsOKeRj4guyJOBVyPAQXRyOEzpBe6N6WjCpDHVzh3c
iT5qVbHs9iHDZjy809OqUB5+bzL/PmgKeDrbnYpUlBKniehgP7LL86aim3tE9mc7
Kr00oltPEEGZ/gyuAp9zy2DiLYj+IYlE9NrkZE9/larCrZNLl4Vd4rRznxqhowQQ
6nJslTpOm63zg/f4UwGzOfCW7XdqZC0ZXunn04rQKbN/Z18teWvare0al/HUxyA=
=2boS
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000864.html">[squid-users] squid-3.4.8  intercept
</A></li>
	<LI>Next message (by thread): <A HREF="000953.html">[squid-users] cannot start Squid 3.4.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#868">[ date ]</a>
              <a href="thread.html#868">[ thread ]</a>
              <a href="subject.html#868">[ subject ]</a>
              <a href="author.html#868">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
