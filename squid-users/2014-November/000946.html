<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent proxy with Peek and Splice feature.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20proxy%20with%20Peek%20and%20Splice%20feature.&In-Reply-To=%3C54772BB5.5010101%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000927.html">
   <LINK REL="Next"  HREF="000959.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent proxy with Peek and Splice feature.</H1>
    <B>Vadim Rogoziansky</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20proxy%20with%20Peek%20and%20Splice%20feature.&In-Reply-To=%3C54772BB5.5010101%40gmail.com%3E"
       TITLE="[squid-users] Transparent proxy with Peek and Splice feature.">vrogoziansky.squid at gmail.com
       </A><BR>
    <I>Thu Nov 27 13:48:37 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000927.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
        <LI>Next message (by thread): <A HREF="000959.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#946">[ date ]</a>
              <a href="thread.html#946">[ thread ]</a>
              <a href="subject.html#946">[ subject ]</a>
              <a href="author.html#946">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Amos.

Thank you for answer.

There was made an investigation related to squid's peek and splice 
issues in transparent mode.
One-line explanation is as follows - in intercept mode squid can't get a 
server host name from the request header and uses clent IP address 
instead for both fake cert generation and as a SNI record in server bump 
SSL handshaking. This is the root of the problem. However this can be 
fixed if squid uses SNI field taken from client TLS Hello message for 
that purposes. Can you hack squid in this way? What do you think?

Many thanks.


11/26/2014 11:33 AM, Amos Jeffries &#1085;&#1072;&#1087;&#1080;&#1089;&#1072;&#1074;(&#1083;&#1072;):
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> On 26/11/2014 7:22 a.m., Vadim Rogoziansky wrote:
</I>&gt;&gt;<i> Hello All.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My goal is to do ssl bumping in transparent proxy mode with domain
</I>&gt;&gt;<i> exclude possibility. Let me tell you about squid's strange
</I>&gt;&gt;<i> behaviour when I'm trying to do it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In browsers it says something like this: /This server could not
</I>&gt;&gt;<i> prove that it is www.ukr.net; its security certificate is
</I>&gt;&gt;<i> from212.42.76.253. This may be caused by a misconfiguration or an
</I>&gt;&gt;<i> attacker intercepting your connection.//
</I>&gt;&gt;<i> //NET::ERR_CERT_COMMON_NAME_INVALID// //Subject: 212.42.76.253// /
</I>&gt;&gt;<i> Looks like squid takes the CN from the certificate as IP address of
</I>&gt;&gt;<i> the destination domain.
</I>&gt;<i> Squid takes the IP address from the TCP packet. Which is all that is
</I>&gt;<i> available in NAT intercepted traffic at bumping step #1.
</I>&gt;<i>
</I>&gt;<i> The ACLs you have therefore determine that &quot;bump&quot; action is to happen.
</I>&gt;<i> Correct?
</I>&gt;<i>
</I>&gt;<i> The cert details are therefore mimic'ed from what gets delivered by
</I>&gt;<i> the server.
</I>&gt;<i>
</I>&gt;<i> It may be that the server is depending on SNI to generate its own
</I>&gt;<i> cert, but since Squid deos not have that domain name already an
</I>&gt;<i> IP-based cert comes back.
</I>&gt;<i>
</I>&gt;<i> It may also be that some ISP upstream of you is bumping the encryption
</I>&gt;<i> with client-first method.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> But, everything works smoothly when I use proxy in non transparent
</I>&gt;&gt;<i> mode and put it to the browser directly .
</I>&gt;<i> In which case the browser sends domain name to the proxy in its
</I>&gt;<i> CONNECT message starting the HTTPS. The possible results are very
</I>&gt;<i> different.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2.0.22 (MingW32)
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBAgAGBQJUdZ5sAAoJELJo5wb/XPRj0qIIANBjuFvq45hPmcaj/NYL6bza
</I>&gt;<i> 7ttt5Gn+tn8E5KH7T4wfQhUXr91UIsYWfOswfnVAAlBevIO/iFVoDN5hAOveuhIl
</I>&gt;<i> ra/0eGti1EpZ3LHJiAqmo0mHsrz3v9+PAduVrXgUJLyYDiM0xctg0nRhj2u166VX
</I>&gt;<i> j0IL3g8CKEw+KiWVJM9HdLaDEz9fYtHBO8UHhKDDE94O9yxScIvB+GAhN4YlTtrE
</I>&gt;<i> z65VJkSCEw+3vH6XcrrkF2aEnB20jeEGiV5puO2cPoJpgcg3ic8sMVEfa/Z1qwqa
</I>&gt;<i> KCkj2XI28wBCIovCV+AfBhpvW0o8eVFbt4ESodLTmwjUvU+m8zxky/9cjO5kyLE=
</I>&gt;<i> =kgug
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000927.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
	<LI>Next message (by thread): <A HREF="000959.html">[squid-users] Transparent proxy with Peek and Splice feature.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#946">[ date ]</a>
              <a href="thread.html#946">[ thread ]</a>
              <a href="subject.html#946">[ subject ]</a>
              <a href="author.html#946">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
