<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3CE6B2517F8D6DBF4CABB8F38ACA367E7834342AF7%40Draco.dawnsign.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000921.html">
   <LINK REL="Next"  HREF="000922.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64</H1>
    <B>Doug Sampson</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3CE6B2517F8D6DBF4CABB8F38ACA367E7834342AF7%40Draco.dawnsign.com%3E"
       TITLE="[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64">dougs at dawnsign.com
       </A><BR>
    <I>Tue Nov 25 19:59:27 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000921.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
        <LI>Next message (by thread): <A HREF="000922.html">[squid-users] Persistent Connections - only one side
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#952">[ date ]</a>
              <a href="thread.html#952">[ thread ]</a>
              <a href="subject.html#952">[ subject ]</a>
              <a href="author.html#952">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 25/11/2014 9:06 a.m., Doug Sampson wrote:
</I>&gt;<i> &gt; Recently due to squid 2.7 being EOL'ed, we migrated our squid
</I>&gt;<i> &gt; server to version 3.4.9 on a FreeBSD 10.0-RELEASE running on 64-bit
</I>&gt;<i> &gt; hardware. We started seeing paging file being swapped out
</I>&gt;<i> &gt; eventually running out of available memory. From the time squid
</I>&gt;<i> &gt; gets started it usually takes about two days before we see these
</I>&gt;<i> &gt; entries in /var/log/messages as follows:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; +swap_pager_getswapspace(16): failed +swap_pager_getswapspace(16):
</I>&gt;<i> &gt; failed +swap_pager_getswapspace(16): failed
</I>&gt;<i> &gt; +swap_pager_getswapspace(12): failed +swap_pager_getswapspace(16):
</I>&gt;<i> &gt; failed +swap_pager_getswapspace(12): failed
</I>&gt;<i> &gt; +swap_pager_getswapspace(6): failed +swap_pager_getswapspace(16):
</I>&gt;<i> &gt; failed
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Looking at the 'top' results, I see that the swap file has been
</I>&gt;<i> &gt; totally exhausted. Memory used by squid hovers around 2.3GB out of
</I>&gt;<i> &gt; the total 3GB of system memory.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am not sure what is causing these memory leaks. After rebooting,
</I>&gt;<i> &gt; squid-internal-mgr/info shows the following statistics:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Squid Object Cache: Version 3.4.9 Build Info: Start Time:	Mon, 24
</I>&gt;<i> &gt; Nov 2014 18:39:08 GMT Current Time:	Mon, 24 Nov 2014 19:39:13 GMT
</I>&gt;<i> &gt; Connection information for squid: Number of clients accessing
</I>&gt;<i> &gt; cache:	18 Number of HTTP requests received:	10589 Number of ICP
</I>&gt;<i> &gt; messages received:	0 Number of ICP messages sent:	0 Number of
</I>&gt;<i> &gt; queued ICP replies:	0 Number of HTCP messages received:	0 Number of
</I>&gt;<i> &gt; HTCP messages sent:	0 Request failure ratio:	 0.00 Average HTTP
</I>&gt;<i> &gt; requests per minute since start:	176.2 Average ICP messages per
</I>&gt;<i> &gt; minute since start:	0.0 Select loop called: 763993 times, 4.719 ms
</I>&gt;<i> &gt; avg Cache information for squid: Hits as % of all requests:	5min:
</I>&gt;<i> &gt; 3.2%, 60min: 17.0% Hits as % of bytes sent:	5min: 2.0%, 60min:
</I>&gt;<i> &gt; 6.7% Memory hits as % of hit requests:	5min: 0.0%, 60min: 37.2%
</I>&gt;<i> &gt; Disk hits as % of hit requests:	5min: 22.2%, 60min: 33.2% Storage
</I>&gt;<i> &gt; Swap size:	7361088 KB Storage Swap capacity:	58.5% used, 41.5%
</I>&gt;<i> &gt; free Storage Mem size:	54348 KB Storage Mem capacity:	 3.9%
</I>&gt;<i> used,
</I>&gt;<i> &gt; 96.1% free Mean Object Size:	23.63 KB Requests given to unlinkd:	1
</I>&gt;<i> &gt; Median Service Times (seconds)  5 min    60 min: HTTP Requests
</I>&gt;<i> &gt; (All):   0.10857  0.19742 Cache Misses:          0.10857  0.32154
</I>&gt;<i> &gt; Cache Hits:            0.08265  0.01387 Near Hits:
</I>&gt;<i> &gt; 0.15048  0.12106 Not-Modified Replies:  0.00091  0.00091 DNS
</I>&gt;<i> &gt; Lookups:           0.05078  0.05078 ICP Queries:           0.00000
</I>&gt;<i> &gt; 0.00000 Resource usage for squid: UP Time:	3605.384 seconds CPU
</I>&gt;<i> &gt; Time:	42.671 seconds CPU Usage:	1.18% CPU Usage, 5 minute avg:
</I>&gt;<i> &gt; 0.72% CPU Usage, 60 minute avg:	1.17% Maximum Resident Size: 845040
</I>&gt;<i> &gt; KB Page faults with physical i/o: 20 Memory accounted for: Total
</I>&gt;<i> &gt; accounted:       105900 KB memPoolAlloc calls:   2673353
</I>&gt;<i> &gt; memPoolFree calls:    2676487 File descriptor usage for squid:
</I>&gt;<i> &gt; Maximum number of file descriptors:   87516 Largest file desc
</I>&gt;<i> &gt; currently in use:    310 Number of file desc currently in use:
</I>&gt;<i> &gt; 198 Files queued for open:                   0 Available number of
</I>&gt;<i> &gt; file descriptors: 87318 Reserved number of file descriptors:   100
</I>&gt;<i> &gt; Store Disk files open:                   0 Internal Data
</I>&gt;<i> &gt; Structures: 311543 StoreEntries 4421 StoreEntries with MemObjects
</I>&gt;<i> &gt; 4416 Hot Object Cache Items 311453 on-disk objects
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I will post another one tomorrow that will indicate growing
</I>&gt;<i> &gt; memory/swapfile consumption.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here is my squid.conf:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # OPTIONS FOR AUTHENTICATION #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> # 1st four lines for
</I>&gt;<i> &gt; auth_param basic children 5 auth_param basic realm Squid
</I>&gt;<i> &gt; proxy-caching web server auth_param basic credentialsttl 2 hours
</I>&gt;<i> &gt; auth_param basic casesensitive off #  next three lines for kerberos
</I>&gt;<i> &gt; authentication (needed to use usernames) #  used in conjunction
</I>&gt;<i> &gt; with &quot;acl auth proxy_auth&quot; line below #auth_param negotiate program
</I>&gt;<i> &gt; /usr/local/libexec/squid/negotiate_kerberos_auth -i #auth_param
</I>&gt;<i> &gt; negotiate children 50 startup=10 idle=5 #auth_param negotiate
</I>&gt;<i> &gt; keep_alive on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # ACCESS CONTROLS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> &gt; # Adapt to list your (internal) IP networks from where browsing #
</I>&gt;<i> &gt; should be allowed #acl manager proto cache_object acl manager
</I>&gt;<i> &gt; url_regex -i ^cache_<A HREF="object://">object://</A> /squid-internal-mgr/ acl adminhost
</I>&gt;<i> &gt; src 192.168.1.149 acl localnet src 192.168.1.0/24	# RFC1918
</I>&gt;<i> &gt; possible internal network acl localnet src fc00::/7           # RFC
</I>&gt;<i> &gt; 4193 local private network range acl localnet src fe80::/10
</I>&gt;<i> &gt; # RFC 4291 link-local (directly plugged) machines acl webserver src
</I>&gt;<i> &gt; 198.168.1.35 acl some_big_clients src 192.168.1.149/32 #CI53
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # We want to limit downloads of these type of files # Put this all
</I>&gt;<i> &gt; in one line acl magic_words url_regex -i ftp .exe .mp3 .vqf .tar.gz
</I>&gt;<i> &gt; .gz .rpm .zip .rar .avi .mpeg .mpe .mpg .qt .ram .rm .iso .raw .wav
</I>&gt;<i> &gt; .dmg .mp4 .img # We don't block .html, .gif, .jpg and similar
</I>&gt;<i> &gt; files, because they # generally don't consume much bandwidth
</I>&gt;<i> 
</I>&gt;<i> But you do. Whenever the domain name or path contains any of the byte
</I>&gt;<i> sequences in that regex above. The entire websites
</I>&gt;<i> <A HREF="http://www.divx.com/">http://www.divx.com/</A>  and <A HREF="http://isohunt.com/">http://isohunt.com/</A> for example.
</I>&gt;<i> 
</I>&gt;<i> And whats wrong with adding more HITs ? even if they are small enough
</I>&gt;<i> not to use much cache space.
</I>&gt;<i> 
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # OPTIONS WHICH AFFECT THE NEIGHBOR SELECTION ALGORITHM #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> hierarchy_stoplist cgi-bin ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ... but you dont have neighbours. This is also deprecated anyway.
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # MEMORY CACHE OPTIONS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> cache_mem 1366 MB
</I>&gt;<i> &gt; #cache_mem 2134 MB #maximum_object_size_in_memory 64 KB
</I>&gt;<i> &gt; maximum_object_size_in_memory 128 KB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # DISK CACHE OPTIONS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> &gt; cache_dir aufs /data/squid/aufs_cache 4096 16 256 min-size=131073
</I>&gt;<i> &gt; cache_dir diskd /data/squid/diskd_cache 8192 16 256 Q1=64 Q2=72
</I>&gt;<i> &gt; max-size=131072
</I>&gt;<i> 
</I>&gt;<i> Why the segregation between diskd and aufs?
</I>&gt;<i> 
</I>&gt;<i> The only difference between these cache types is the method if I/O
</I>&gt;<i> performed accessing the disk. AUFS is threaded SMP, diskd is
</I>&gt;<i> multi-process SMP.
</I>&gt;<i> 
</I>&gt;<i> NP: FreeBSD 10 seem to have resolved the issues Squid AUFS has with
</I>&gt;<i> older BSD and people are now noticing the speed issues with diskd.
</I>&gt;<i> 
</I>&gt;<i> The official recommendation is currently to use AUFS with FreeBSD 10+
</I>&gt;<i> and diskd with older FreeBSD.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; #maximum_object_size 122880 KB maximum_object_size 153600 KB
</I>&gt;<i> &gt; cache_swap_low 90 cache_swap_high 95
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # LOGFILE OPTIONS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> access_log daemon:/data/squid/logs/access.log
</I>&gt;<i> &gt; cache_store_log daemon:/data/squid/logs/store.log cache_swap_log
</I>&gt;<i> &gt; /var/spool/squid/%s
</I>&gt;<i> 
</I>&gt;<i> What is this %s ??
</I>&gt;<i> 
</I>&gt;<i> &gt; logfile_rotate 28
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # OPTIONS FOR TROUBLESHOOTING #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> cache_log /data/squid/logs/cache.log
</I>&gt;<i> &gt; # Leave coredumps in the first cache dir coredump_dir /data/squid
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # OPTIONS FOR EXTERNAL SUPPORT PROGRAMS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> diskd_program /usr/local/libexec/squid/diskd
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Unless you are replacing this helper with a custom-built one with
</I>&gt;<i> strange name this should not be configured explicitly in Squid-3.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; # OPTIONS FOR TUNING THE CACHE #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> refresh_pattern <A HREF="http://.*\.windowsupdate\.microsoft\.com/">http://.*\.windowsupdate\.microsoft\.com/</A> 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://office\.microsoft\.com/">http://office\.microsoft\.com/</A> 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://windowsupdate\.microsoft\.com/">http://windowsupdate\.microsoft\.com/</A> 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://w?xpsp[0-9">http://w?xpsp[0-9</A>]\.microsoft\.com/ 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://w2ksp[0-9">http://w2ksp[0-9</A>]\.microsoft\.com/ 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://download\.microsoft\.com/">http://download\.microsoft\.com/</A> 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://download\.macromedia\.com/">http://download\.macromedia\.com/</A> 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern <A HREF="http://ftp\.software\.ibm\.com/">http://ftp\.software\.ibm\.com/</A> 0 80% 20160
</I>&gt;<i> &gt; refresh_pattern         cgi-bin         1 20% 2 refresh_pattern
</I>&gt;<i> &gt; \.asp$          1 20% 2 refresh_pattern         \.acgi$         1
</I>&gt;<i> &gt; 20% 2 refresh_pattern         \.cgi$          1 20% 2
</I>&gt;<i> &gt; refresh_pattern         \.pl$           1 20% 2 refresh_pattern
</I>&gt;<i> &gt; \.shtml$        1 20% 2 refresh_pattern         \.php3$         1
</I>&gt;<i> &gt; 20% 2 refresh_pattern         \?              1 20% 2
</I>&gt;<i> &gt; refresh_pattern         \.gif$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.png$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.jpg$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.ico$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.bom\.gov\.au     30   20%       120
</I>&gt;<i> &gt; refresh_pattern         \.html$           480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.htm$            480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.css$            480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.js$             480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.class$        10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.zip$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.jpeg$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mid$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.shtml$          480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.exe$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.thm$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.wav$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mp4$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.txt$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.cab$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.au$           10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mov$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.xbm$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.ram$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.iso$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.avi$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.chtml$          480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.thb$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.dcr$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.bmp$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.phtml$          480   50%     22160
</I>&gt;<i> &gt; refresh_pattern         \.mpg$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.pdf$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.art$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.swf$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.flv$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.x-flv$        10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mp3$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.ra$           10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.spl$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.viv$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.doc$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.gz$           10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.Z$            10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.tgz$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.tar$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.vrm$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.vrml$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.aif$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.aifc$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.aiff$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.arj$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.c$            10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.cpt$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.dir$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.dxr$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.hqx$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.jpe$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.lha$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.lzh$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.midi$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.movie$        10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mp2$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mpe$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mpeg$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.mpga$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.pl$           10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.ppt$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.ps$           10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.qt$           10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.qtm$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.rar$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.ras$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.sea$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.sit$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.tif$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.tiff$         10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.snd$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         \.wrl$          10080   90%     43200
</I>&gt;<i> &gt; refresh_pattern         ^ftp:           1440    60%     22160
</I>&gt;<i> &gt; refresh_pattern         ^gopher:        1440    20%     1440
</I>&gt;<i> &gt; refresh_pattern         -i (cgi-bin|\?) 0       0%      0
</I>&gt;<i> &gt; refresh_pattern         .               480     50%     22160
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> That is a LOT of regex comparisions the proxy is having to do at least
</I>&gt;<i> once per-request.
</I>&gt;<i> 
</I>&gt;<i> The special rules you have up the top for &quot;cgi-bin&quot; and &quot;\?&quot; are also
</I>&gt;<i> violating HTTP safe behaviour. The default rule we provide is highly
</I>&gt;<i> tuned to handle caching of those responses safely without breaking old
</I>&gt;<i> legacy scripts.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> At least most of them end with $ anchor point to prevent random URLs
</I>&gt;<i> matching.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; # ADMINISTRATIVE PARAMETERS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at example.com</A>
</I>&gt;<i> &gt; mail_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at example.com</A> cache_effective_user squid
</I>&gt;<i> &gt; cache_effective_group squid
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # DELAY POOL PARAMETERS #
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> delay_pools 2
</I>&gt;<i> &gt; delay_class 1 2 # When big_files are being downloaded, the first
</I>&gt;<i> &gt; 5MB (625000 * 8 bits) are # downloaded at max network speed. Once
</I>&gt;<i> &gt; the file size limit of 5MB is reached, # download speed drops to
</I>&gt;<i> &gt; 438,000 bits or 3,504,000 MB per sec. Current # contracted Internet
</I>&gt;<i> &gt; connection speed w/ TP is at 7MB per sec. delay_parameters 1
</I>&gt;<i> &gt; 750000/750000 438000/625000
</I>&gt;<i> 
</I>&gt;<i> &gt; acl big_files url_regex -i ftp .exe .mp3 .vqf .tar.gz .gz .rpm .zip
</I>&gt;<i> &gt; .rar .avi .mpeg .mpe .mpg .qt .ram .rm .iso .raw .wav .dmg .mp4
</I>&gt;<i> &gt; .img .flv .wmv .divx .mov .bz2 .deb
</I>&gt;<i> 
</I>&gt;<i> Another long list of regex patterns. Notice how these are permitted to
</I>&gt;<i> match anywhere in the entie URL. Including domain names.
</I>&gt;<i> 
</I>&gt;<i> FTP traffic in particular is not guaranteed to be &quot;big files&quot;.
</I>&gt;<i> 
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt; Intially, I set mem_cache=2134MB and after noticing these memory
</I>&gt;<i> &gt; leaks, I dropped it down to 1344MB. Memory leaks are still
</I>&gt;<i> &gt; occurring.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Am I using anything that is known to cause memory leaks?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If there is additional information that you need, please do not
</I>&gt;<i> &gt; hesitate to ask! Thanks.
</I>&gt;<i> 
</I>&gt;<i> A copy of the manager &quot;mem&quot; report would be very useful to see whats
</I>&gt;<i> using the memory.
</I>&gt;<i>  Note that it is a TSV format, so please save as .tsv file and attach.
</I>&gt;<i> rather than cut-n-pasting inline.
</I>&gt;<i> 
</I>
Thanks, Amos, for your pointers. 

I've commented out all the fresh_patterns lines appearing above the last two lines. 

I also have dropped diskd in favor of using aufs exclusively, taking out the min-size parameter. I've commented out the diskd_program support option. In the previous version of squid (2.7) I had split the cache_dir into two types with great success using coss and aufs. Previously I had only aufs and performance wasn't where I wanted it. Apparently coss is no longer supported in the 3.x version of squid atop FreeBSD.

The pathname for the cache swap logs have been fixed. Apparently this came from a squid.conf example that I copied in parts. Would this be the reason why we are seeing the error messages in /var/log/messages regarding swapping mentioned in my original post?

The hierarchy_stoplist line has been stripped out as you say it is deprecated.

The mem .TSV file is attached herewith.

Currently I have the cache_dir located on the OS disk and all of the cache logging files on a second drive. Is this the optimal setup of cache-dir and logs?

Your comments are much appreciated!

~Doug
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: squid-internal-mgr_MEM.txt
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20141125/29500fc5/attachment.txt">http://lists.squid-cache.org/pipermail/squid-users/attachments/20141125/29500fc5/attachment.txt</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000921.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
	<LI>Next message (by thread): <A HREF="000922.html">[squid-users] Persistent Connections - only one side
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#952">[ date ]</a>
              <a href="thread.html#952">[ thread ]</a>
              <a href="subject.html#952">[ subject ]</a>
              <a href="author.html#952">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
