<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RFC2616 headers in bumped requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C547AC9EC.6010800%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000883.html">
   <LINK REL="Next"  HREF="000612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RFC2616 headers in bumped requests</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RFC2616%20headers%20in%20bumped%20requests&In-Reply-To=%3C547AC9EC.6010800%40treenet.co.nz%3E"
       TITLE="[squid-users] RFC2616 headers in bumped requests">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Nov 30 07:40:28 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000883.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
        <LI>Next message (by thread): <A HREF="000612.html">[squid-users] assertion failed: client_side.cc:1515: &quot;connIsUsable(http-&gt;getConn())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#964">[ date ]</a>
              <a href="thread.html#964">[ thread ]</a>
              <a href="subject.html#964">[ subject ]</a>
              <a href="author.html#964">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 20/11/2014 11:51 p.m., Steve Hill wrote:
&gt;<i> On 17/11/14 22:05, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Would you mind running an experiment for me?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> To see what happens if Squid delivers either of these Via
</I>&gt;&gt;<i> headers instead of its current output:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Via: HTTPS/1.1 iceni2.opendium.net (squid/3.4.9)
</I>&gt;<i> 
</I>&gt;<i> The HTTPS/1.1 one appears to work correctly.
</I>&gt;<i> 
</I>&gt;&gt;<i> Via: TLS/1.2 iceni2.opendium.net (squid/3.4.9)
</I>&gt;<i> 
</I>&gt;<i> The web server produces the same broken redirect as before when I
</I>&gt;<i> send TLS/1.2.
</I>&gt;<i> 
</I>&gt;&gt;<i> Setting it with request_header_access/replace should do.
</I>&gt;<i> 
</I>&gt;<i> I've tested this in Squid with request_header_access/replace and 
</I>&gt;<i> confirmed with openssl's s_client directly.
</I>&gt;<i> 
</I>

Just to followup, there will not be a permanent change made to Squid
because:

1) &quot;HTTPS&quot; is a common name for an entire stack of protocols. Since it
is a whole stack of protocols (HTTP-on-TLS-on-TCP-on-IP...) it is not
being registered by IANA as a label for an individual protocol.

2) the Via headers indicates the single top-level protocol. Which is
actually HTTP for both port 80 and 443 traffic, even though port 443
is HTTP being transmitted over TLS connections. Thus Squid Via header
is correct.


The ATS server has at least three bugs;

A) it is emitting some unknown &quot;http/1.1&quot; protocol. The &quot;HTTP&quot;
protocol label is case-sensitive as defined in RFC 7230.

B) it is attempting to determine security from the Via header. As the
server operators themselves should know (due to the &quot;http/1.1&quot; usage
by their own server) the presence of any top-level HTTP is no
indicator for or against security of the underlying network connection.

C) it is redirecting to the same <A HREF="https://">https://</A> URI which is being delivered
to it. The server itself is uniquely in a position to be aware of
these types of loop and so expected not to cause them. (Squid opening
a port 443 connection is dead giveaway they are getting <A HREF="https://">https://</A> even
if it is proxied).


PS. that said, the workaround should be enough to get things going
again until the ATS people fix their bugs.

Cheers
Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUesnsAAoJELJo5wb/XPRj5RYIAIzYJF0nbjG24jR3i73rVQSl
BUcUdwsfwo/KFDSDmqHBlgiN5qcxAt2pZcKzmyGevqmY+nwUQSBUwCvigWXh5tT1
vhrjAB4iuJfFefQqHac4ZtflVID5ft4hSLcwfxdlRwcld5XvNubU5L4bBLNkOuja
1JAezYn+EJtonhQsC7ZxecWPiDCMo/sUgtDjWjoYu3Awtn/A0mNQpzmPfsUyQyjI
c/2hwTZFPcPruwleZ6kB4/XXcfSRCKVpdI/U/nuPeoEXraO+n6ZhU6Y+6LfaHO26
osmgBf3DM2NirHSI67Ewgk9++JeFAd0v0MASFdzlH97da5SxIGy8yva1bl38Ii0=
=6EbN
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000883.html">[squid-users] RFC2616 headers in bumped requests
</A></li>
	<LI>Next message (by thread): <A HREF="000612.html">[squid-users] assertion failed: client_side.cc:1515: &quot;connIsUsable(http-&gt;getConn())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#964">[ date ]</a>
              <a href="thread.html#964">[ thread ]</a>
              <a href="subject.html#964">[ subject ]</a>
              <a href="author.html#964">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
