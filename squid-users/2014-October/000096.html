<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] transparent proxy https and self signed certificate error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20proxy%20https%20and%20self%20signed%0A%20certificate%20error&In-Reply-To=%3C5430DAC5.8030802%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000092.html">
   <LINK REL="Next"  HREF="000097.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] transparent proxy https and self signed certificate error</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20proxy%20https%20and%20self%20signed%0A%20certificate%20error&In-Reply-To=%3C5430DAC5.8030802%40treenet.co.nz%3E"
       TITLE="[squid-users] transparent proxy https and self signed certificate error">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Oct  5 05:44:37 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000092.html">[squid-users] transparent proxy https and self signed certificate	error
</A></li>
        <LI>Next message (by thread): <A HREF="000097.html">[squid-users] transparent proxy https and self signed certificate error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96">[ date ]</a>
              <a href="thread.html#96">[ thread ]</a>
              <a href="subject.html#96">[ subject ]</a>
              <a href="author.html#96">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 5/10/2014 1:29 p.m., Robert Watson wrote:
&gt;<i> using squid 3.4.8, compiled from source with ./configure flags 
</I>&gt;<i> --enable-icap-client --enable-ssl --enable-ssl-crtd configured
</I>&gt;<i> iptables for transparent proxy (redirect 80 to 3128) and everything
</I>&gt;<i> works fine
</I>&gt;<i> 
</I>&gt;<i> configured iptables for transparent proxy (redirect 443 to 3127)
</I>&gt;<i> but can't get transparent proxy for https to work my squid.conf 
</I>&gt;<i> ... # Squid https port https_port 3127 intercept ssl-bump
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/etc/squid/ssl_cert/XXX.pem acl broken_sites dstdomain
</I>&gt;<i> .example.com ssl_bump none localhost ssl_bump none broken_sites 
</I>&gt;<i> ssl_bump server-first all sslproxy_cert_error allow all 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER sslcrtd_program
</I>&gt;<i> /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB 
</I>&gt;<i> sslcrtd_children 32 startup=5 idle=1
</I>&gt;<i> 
</I>&gt;<i> when visiting google (or any other https site) chrome complains 
</I>&gt;<i> NET::ERR_CERT_AUTHORITY_INVALID I tried using internet explorer as
</I>&gt;<i> admin and imported the self signed certificate but that hasn't
</I>&gt;<i> helped
</I>&gt;<i> 
</I>&gt;<i> can anyone please with how to debug this thanks, Robert
</I>
To debug you will need a packet capture with full packet bodies
(tcpdump -s 0) of the TCP connection between browser and Squid, and
the connection between Squid and server.
Wireshark should be able to decrypt the TLS/SSL handshakes to see what
differences or corruption is happening.


FYI: When testing be sure to clear/empty the ssl_crtd database if any
changes are made to CA keys.



PS. Google with Chrome appear these days to be the champions of
unbreakable TLS, their software is continually being updated to
use/invent new TLS features that close loopholes in TLS design which
allow ssl-bump to take place. What worked last month has no guarantee
of working today, same again next month.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUMNrEAAoJELJo5wb/XPRj7QAIAMVZ5SOc+X8vWlMdbgyNhNJR
k//TmLRMdwZ1qxFBHTF3t+I7JVua2b+DDp0fU6Ubq6WvoARNBQGPQdI0XfOtrnLQ
3lsBCkU8NZuXt2LeoKG6eNPaNyuhom7HeFzmwELgM4SuASxbO4mpBxET8Tg1XYwQ
VdSruqwx0hwhb5g4yeXWEIflkILc1A5cTAAbNGXIHpWbqMmwvnav5KWCfDhesHEU
CdxuyZJnUZwv/uRYSaiiYebUECTS/Zl8JkGvCXe5zheLwT2Wcor3urUXIK3gPToz
dy8FJ7lRGSSIJNkiQO4iNwI28vYkJHP2u3yFMFOdu4r/jN7WRgaY2LSpaQF+pqc=
=teuE
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000092.html">[squid-users] transparent proxy https and self signed certificate	error
</A></li>
	<LI>Next message (by thread): <A HREF="000097.html">[squid-users] transparent proxy https and self signed certificate error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96">[ date ]</a>
              <a href="thread.html#96">[ thread ]</a>
              <a href="subject.html#96">[ subject ]</a>
              <a href="author.html#96">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
