<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] problem with basic_ldap_auth
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20with%20basic_ldap_auth&In-Reply-To=%3C543603DE.706%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000164.html">
   <LINK REL="Next"  HREF="000211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] problem with basic_ldap_auth</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20with%20basic_ldap_auth&In-Reply-To=%3C543603DE.706%40treenet.co.nz%3E"
       TITLE="[squid-users] problem with basic_ldap_auth">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct  9 03:41:18 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000164.html">[squid-users] problem with basic_ldap_auth
</A></li>
        <LI>Next message (by thread): <A HREF="000211.html">[squid-users] problem with basic_ldap_auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#207">[ date ]</a>
              <a href="thread.html#207">[ thread ]</a>
              <a href="subject.html#207">[ subject ]</a>
              <a href="author.html#207">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 7/10/2014 11:33 p.m., masterx81 wrote:
&gt;<i> Hi to all! I'm having an issue on squid 3.3.13 using
</I>&gt;<i> basic_ldap_auth. I'm using the following helpers: auth_param
</I>&gt;<i> negotiate program /usr/local/bin/negotiate_wrapper --ntlm 
</I>&gt;<i> /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> --domain=DOMAIN --kerberos /usr/local/bin/squid_kerb_auth -s
</I>&gt;<i> GSS_C_NO_NAME auth_param negotiate children 10 auth_param negotiate
</I>&gt;<i> keep_alive on
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=DOMAIN auth_param ntlm
</I>&gt;<i> children 10 auth_param ntlm keep_alive on
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/local/squid/libexec/basic_ldap_auth
</I>&gt;<i> -v 3 -R -b &quot;dc=domain,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at domain.local</A> -W
</I>&gt;<i> /etc/squid/ldappass.txt -d -f sAMAccountName=%s -h
</I>&gt;<i> srv-dc1.domain.local auth_param basic children 10 auth_param basic
</I>&gt;<i> realm Proxy DOMAIN auth_param basic credentialsttl 1 minute
</I>&gt;<i> 
</I>&gt;<i> NTLM and kerberos are working correctly, but the basic helper seem
</I>&gt;<i> to not work well. The browser ask me 3 times the password, then
</I>&gt;<i> give me the cache error. After this, windows save the credentials
</I>&gt;<i> in it's cache (seen in account manager) and if i close and reopen
</I>&gt;<i> the browser it work but seem to use NTLM as i get the ticket in the
</I>&gt;<i> cache.log. In che cache.log i not see any line of the basic helper
</I>&gt;<i> also with the -d switch. If i call the helper manually from command
</I>&gt;<i> line it works and give me &quot;OK&quot; if i pass correct user/pass and &quot;ERR
</I>&gt;<i> Success&quot; if i pass wrong credentials.
</I>&gt;<i> 
</I>&gt;<i> Before the 3.3.13 i was using a 3.4.x version, and all was working
</I>&gt;<i> ok, but i've had the need to go back as on 3.4 i have huge cpu
</I>&gt;<i> utilization using NTLM. On the 3.3.13 cpu usage is really low but
</I>&gt;<i> seen that there is this throuble with basic helpers.... Some have a
</I>&gt;<i> suggestion for me?
</I>
Firstly the popup does not mean Basic. It only means the browser is
not able to automatically find any credentials that work.

If it is &quot;saving&quot; the NTLM credentials in password manager it means
those are the credentials which eventually worked after the user input.

The way auth is supposed to work is that the browser tries the most
secure method it is offered then falls back to ever less secure methods.

So what *should* be happening is the following. The first one to
succeed is used:

 1. automatic attempt to use Negotiate/Kerberos
 2. automatic attempt to use Negotiate/NTLM
 3. automatic attempt to use NTLM
 4. automatic attempt to use Basic
 5. popup request for Negotiate/Kerberos credentials
 6. popup request for Negotiate/NTLM credentials
 7. popup request for NTLM credentials
       --&gt; the one you say is working.
 8. popup request for Basic credentials
 9. display error page sent in last received 401/407/403 message.

* The password manager or system API lacking any of the credentials
may skip the HTTP transaction part of 'automatic' steps.
* User clicking cancel may skip the HTTP part of the popup steps.
* 403 response skips from any point to step 9.

You can test this a bit better by placing some strange text in the
Basic auth &quot;Realm&quot; parameter. Only if that text appears in the popup
box is Basic auth being requested.

debug_options 11,2 can be used to get a trace of teh HTTP traffic.
Which can be used to see the auth types being attempted by the client.

Also, the helpers should all provide -d parameter to print debug info
about their actions.

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUNgPeAAoJELJo5wb/XPRj164IAOKM/YeG6AKdaxMAT6kPELPG
TEbxLOZyZ13eFIZpY5kR1u0Wx6jZL/nsmSk7vs7UmEOdVc4YQSYktTjxf8cfpbrP
NF2fc2+6IPrnSzyoJ7aNatqDSMBnwPneo0AG6xj9/jFsSeCN/HAqELf5ngIOZFXQ
eMSodljKBWzp4epXyB/J8BvQL4Ng0hCy1yisAR1fsQupo8SLgCwVaMrZ10ZJxrsR
ourgX57M/qvOmEknSHDGO3PZAa1iFBY2iwEyDMa31P2oLZxJ/SiXUoeDSs3zkXJb
hzgFUxTzsyoQTr8g9ZekMlmAa3+QAw0NwST/Y6s2AZcbOKKBVcH3evO2FKyvvjg=
=aiaz
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000164.html">[squid-users] problem with basic_ldap_auth
</A></li>
	<LI>Next message (by thread): <A HREF="000211.html">[squid-users] problem with basic_ldap_auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#207">[ date ]</a>
              <a href="thread.html#207">[ thread ]</a>
              <a href="subject.html#207">[ subject ]</a>
              <a href="author.html#207">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
