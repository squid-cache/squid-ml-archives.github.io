<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] blockVirgin Works for CONNECT but Custom Response does not work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20blockVirgin%20Works%20for%20CONNECT%20but%20Custom%20Response%0A%20does%20not%20work&In-Reply-To=%3C5437F8CC.1050305%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000228.html">
   <LINK REL="Next"  HREF="000242.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] blockVirgin Works for CONNECT but Custom Response does not work</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20blockVirgin%20Works%20for%20CONNECT%20but%20Custom%20Response%0A%20does%20not%20work&In-Reply-To=%3C5437F8CC.1050305%40measurement-factory.com%3E"
       TITLE="[squid-users] blockVirgin Works for CONNECT but Custom Response does not work">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Oct 10 15:18:36 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000228.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
        <LI>Next message (by thread): <A HREF="000242.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#231">[ date ]</a>
              <a href="thread.html#231">[ thread ]</a>
              <a href="subject.html#231">[ subject ]</a>
              <a href="author.html#231">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/09/2014 11:57 PM, Jatin Bhasin wrote:

&gt;<i> adaptation_masterx_shared_names X-Virus-ID
</I>&gt;<i> acl toBump note X-Virus-ID yes
</I>&gt;<i> ssl_bump client-first toBump
</I>
OK.


&gt;<i> My eCap adapter functions which returns yes for the X-Virus-ID are:
</I>&gt;<i> =================================================================
</I>&gt;<i> const libecap::Area Adapter::Xaction::option(const libecap::Name &amp;name) const
</I>&gt;<i> {
</I>&gt;<i> std::string str = &quot;yes&quot;;
</I>&gt;<i> return libecap::Area(str.data(), str.size());
</I>&gt;<i> }
</I>
Two bugs here:

* You are returning a pointer to str, which is a temporary, on-stack
storage. Use libecap::Area::FromTempString() instead.

* You are returning &quot;yes&quot; value for all option names. The return value
should be conditional on name parameter being lequal to
libecap::metaVirusId (&quot;X-Virus-ID&quot;).

These two bugs may not actually affect you (for several reasons), but
you should fix them anyway.


&gt;<i> --------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> void Adapter::Xaction::visitEachOption(libecap::NamedValueVisitor
</I>&gt;<i> &amp;visitor) const
</I>&gt;<i> {
</I>&gt;<i> std::string str = &quot;yes&quot;;
</I>&gt;<i>     visitor.visit(libecap::metaVirusId, libecap::Area(str.data(), str.size()));
</I>&gt;<i> }
</I>
There is no need for std::string in this case, but the above code is not
buggy, just inefficient.


&gt;<i> Looking at cache.log I see that X-Virus-ID is set to yes but the eCap
</I>&gt;<i> adapter functions. But I do not know that how it will be picked up
</I>&gt;<i> note acl. Please suggest.
</I>
I agree that Squid seems to receive the X-Virus-ID:yes metaheader from
the eCAP adapter, but your toBump ACL still does not match. I cannot
tell why that is [not] happening by looking at the cache log, unfortunately.

You may want to add debugging to ACLNoteData::match and
ACLNoteData::matchNotes in src/acl/NoteData.cc to see if the ACL code
has access to the eCAP history with X-Virus-ID metaheader.

The only theory I can offer right now is that the code handling
annotations for CONNECT requests is broken and does not store or does
not preserve annotations received from eCAP adapters. CONNECT requests
are treated specially in Squid. You can try to test that theory by
annotating GET requests, for example.

Another good test is to log your annotation to access.log using %note
logformat code. If it is not logged, Squid probably lost it. If it is
logged, then the ACL code does not have access to the information for
some reason. This test can be done for both CONNECT and GET requests.


HTH,

Alex.



&gt;<i> On Sat, Aug 23, 2014 at 10:24 AM, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 08/21/2014 07:06 PM, Jatin Bhasin wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So, can somebody suggest me if there is a way to pass a flag to squid
</I>&gt;&gt;&gt;<i> from ecap adapter to decrypt a site regardless of what ACL says. For
</I>&gt;&gt;&gt;<i> example if I have an acl as below which says do not decrypt
</I>&gt;&gt;&gt;<i> www.888.com but If my ecap adapter could pass a message to squid
</I>&gt;&gt;&gt;<i> asking it to decrypt www.888.com (for that session only) and ignore
</I>&gt;&gt;&gt;<i> the below acl.
</I>&gt;&gt;&gt;<i> Is it possible?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Given a recent-enough Squid version, an adaptation service can control
</I>&gt;&gt;<i> Squid behavior via the annotations mechanism and the &quot;note&quot; ACL
</I>&gt;&gt;<i> associated with it. For example, your eCAP adapter can return an
</I>&gt;&gt;<i> X-Bump:yes annotation(**) that Squid can then match using the note ACL.
</I>&gt;&gt;<i> Something along these untested lines:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl note toBump X-Bump yes
</I>&gt;&gt;<i>   ssl_bump server-first toBump
</I>&gt;&gt;<i>   ssl_bump server-first ...
</I>&gt;&gt;<i>   ssl_bump none all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This mechanism should be supported for ssl_bump ACLs but I have not
</I>&gt;&gt;<i> tested that claim myself.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> (**) In eCAP terminology, an X-Bump:yes annotation is an adapter
</I>&gt;&gt;<i> transaction option named X-Bump with a &quot;yes&quot; value. See
</I>&gt;&gt;<i> libecap::Options, which is a parent of libecap::adapter::Xaction.
</I>&gt;&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000228.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
	<LI>Next message (by thread): <A HREF="000242.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#231">[ date ]</a>
              <a href="thread.html#231">[ thread ]</a>
              <a href="subject.html#231">[ subject ]</a>
              <a href="author.html#231">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
