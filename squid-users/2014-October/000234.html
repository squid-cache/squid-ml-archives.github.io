<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL bump , high memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20%2C%20high%20memory%20usage&In-Reply-To=%3C543808BF.70704%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000269.html">
   <LINK REL="Next"  HREF="000238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL bump , high memory usage</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20%2C%20high%20memory%20usage&In-Reply-To=%3C543808BF.70704%40opendium.com%3E"
       TITLE="[squid-users] SSL bump , high memory usage">steve at opendium.com
       </A><BR>
    <I>Fri Oct 10 16:26:39 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000269.html">[squid-users] unexplained MISSes
</A></li>
        <LI>Next message (by thread): <A HREF="000238.html">[squid-users] SSL bump , high memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#234">[ date ]</a>
              <a href="thread.html#234">[ thread ]</a>
              <a href="subject.html#234">[ subject ]</a>
              <a href="author.html#234">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I think I've identified the bulk of the memory &quot;leak&quot; I've been tracking
down for the past few days.  As it turns out, it doesn't seem to be a
leak, but a problem with the SSL certificate caching.

The certificate cache is set by dynamic_cert_mem_cache_size and defaults
to 4MB.  Squid assumes an SSL context is 1KB, so we can cache up to 4096
certificates:

/// TODO: Replace on real size.
#define SSL_CTX_SIZE 1024

Unfortunately the assumed size isn't even close - it looks like an SSL
context usually weighs in at about 900KB!  So the default limit means
the cache can actually grow to around 3.6GB.  To make matters worse,
each worker gets its own cache, so in an 8-way SMP configuration, the
default &quot;4MB&quot; cache size limit actually ends up as around 30GB.


Possible fixes:
1. Stick with a static SSL_CTX_SIZE but use a more accurate estimate (I
suggest 1MB / context, based on my observations).
2. Calculate the context sizes correctly.
3. In the config, specify the maximum number of certificates to be
cached, rather than their total size.


In any case, as it stands the defaults are pretty much guaranteed to
cause a server to run out of memory.

How &quot;heavy weight&quot; is SSL context generation anyway?  i.e. if we expect
to generate 20 certificates a minute (which is what I see on a
production system in the first 5 minutes after startup), is that going
to place a significant load on the system, or is that ok?

the 900KB context size that I've observed seems pretty big to me.  Does
it sound reasonable, or is there some extra data being cached along with
the context that could have been freed earlier?


The instrumentation isn't good enough to be able to spot where this
memory usage originates without extensive debugging.  The memory isn't
allocated to memory pools, so mgr:mem doesn't show it, and
mgr:cached_ssl_cert relies on the incorrect estimate, so appears small
and inconsequential.  The processes can clearly be seen to grow rapidly,
but it all just shows up as unaccounted memory in mgr:info.  Secondly,
mgr:cached_ssl_cert doesn't appear to work with SMP workers.


My Squid process sizes are still larger than I would expect, so I'll
need to do more investigation, but reducing dynamic_cert_mem_cache_size
has stopped the rapid unbounded growth I have been seeing.

-- 

 - Steve Hill
   Technical Director
   Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
   Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
   Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
   Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
   Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
   Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
   Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
   Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000269.html">[squid-users] unexplained MISSes
</A></li>
	<LI>Next message (by thread): <A HREF="000238.html">[squid-users] SSL bump , high memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#234">[ date ]</a>
              <a href="thread.html#234">[ thread ]</a>
              <a href="subject.html#234">[ subject ]</a>
              <a href="author.html#234">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
