<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL bump , high memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20%2C%20high%20memory%20usage&In-Reply-To=%3C54381347.1060508%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000234.html">
   <LINK REL="Next"  HREF="000244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL bump , high memory usage</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20%2C%20high%20memory%20usage&In-Reply-To=%3C54381347.1060508%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL bump , high memory usage">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct 10 17:11:35 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000234.html">[squid-users] SSL bump , high memory usage
</A></li>
        <LI>Next message (by thread): <A HREF="000244.html">[squid-users] open socket: (13) Permission denied
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#238">[ date ]</a>
              <a href="thread.html#238">[ thread ]</a>
              <a href="subject.html#238">[ subject ]</a>
              <a href="author.html#238">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 11/10/2014 5:26 a.m., Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> I think I've identified the bulk of the memory &quot;leak&quot; I've been
</I>&gt;<i> tracking down for the past few days.  As it turns out, it doesn't
</I>&gt;<i> seem to be a leak, but a problem with the SSL certificate caching.
</I>&gt;<i> 
</I>&gt;<i> The certificate cache is set by dynamic_cert_mem_cache_size and
</I>&gt;<i> defaults to 4MB.  Squid assumes an SSL context is 1KB, so we can
</I>&gt;<i> cache up to 4096 certificates:
</I>&gt;<i> 
</I>&gt;<i> /// TODO: Replace on real size. #define SSL_CTX_SIZE 1024
</I>&gt;<i> 
</I>&gt;<i> Unfortunately the assumed size isn't even close - it looks like an
</I>&gt;<i> SSL context usually weighs in at about 900KB!  So the default limit
</I>&gt;<i> means the cache can actually grow to around 3.6GB.  To make matters
</I>&gt;<i> worse, each worker gets its own cache, so in an 8-way SMP
</I>&gt;<i> configuration, the default &quot;4MB&quot; cache size limit actually ends up
</I>&gt;<i> as around 30GB.
</I>
Aha, yes. That is <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4005">http://bugs.squid-cache.org/show_bug.cgi?id=4005</A>

If I'm understanding the discussions so far the &quot;leak&quot; is data stored
internally by OpenSSL when allocating certificate contexts. In this
case the generated cert chain and additional data. Squid has no way to
know how big that all is (varies between just a few KB and your MB),
so only accounts for what it can see.

Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUOBNHAAoJELJo5wb/XPRjgV0IANZpG56V3WrgjLPuLIDcOaJa
vqGXUbjZNzFVl6IMxXSdgxjZrjTwMzlYzYig3JQ0HUTwxSF8akXaNSLrGrZEW2mp
35w5ks9G3fh897P25prScyhWIuEV6KJOvWYxyseWNvRdth/EJRrTGLUJsv59US1E
b/W2251VOPJqCcEDovxBV2hvXMtBhJKQ0re+xhy5ot6EHs2TzSAdLqJlei5XypWg
FOwhHpwmcqPFyc3JlklSakTNcri0tNgswebNmp6Xbcs1Js4r0PRH7uNohr76wDJC
YmX1VfYX64aQxkkl1l4rlRW+PKEm7UHXZjlOnAxqKqiq+89VApw93pKkE6DoePc=
=fGD9
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000234.html">[squid-users] SSL bump , high memory usage
</A></li>
	<LI>Next message (by thread): <A HREF="000244.html">[squid-users] open socket: (13) Permission denied
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#238">[ date ]</a>
              <a href="thread.html#238">[ thread ]</a>
              <a href="subject.html#238">[ subject ]</a>
              <a href="author.html#238">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
