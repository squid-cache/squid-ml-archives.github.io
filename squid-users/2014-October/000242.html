<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] blockVirgin Works for CONNECT but Custom Response does not work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20blockVirgin%20Works%20for%20CONNECT%20but%20Custom%20Response%0A%20does%20not%20work&In-Reply-To=%3CCAGRJihXWNenmX3iff34v0AqHodsb%2BNyEJFnF6E%2BMteA3LqKpBA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000231.html">
   <LINK REL="Next"  HREF="000264.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] blockVirgin Works for CONNECT but Custom Response does not work</H1>
    <B>Jatin Bhasin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20blockVirgin%20Works%20for%20CONNECT%20but%20Custom%20Response%0A%20does%20not%20work&In-Reply-To=%3CCAGRJihXWNenmX3iff34v0AqHodsb%2BNyEJFnF6E%2BMteA3LqKpBA%40mail.gmail.com%3E"
       TITLE="[squid-users] blockVirgin Works for CONNECT but Custom Response does not work">jbhasin83 at gmail.com
       </A><BR>
    <I>Sat Oct 11 03:03:41 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000231.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
        <LI>Next message (by thread): <A HREF="000264.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#242">[ date ]</a>
              <a href="thread.html#242">[ thread ]</a>
              <a href="subject.html#242">[ subject ]</a>
              <a href="author.html#242">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

I changed my ACL's a bit to see annotations in access.log file. My web
browser is point to squid port 3127.

So squid.conf is as below:  (first two lines are for note logging as
you suggested.)
---------------------------------------------
logformat with_note %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un
%Sh/%&lt;a %mt %note
access_log /var/log/squid/access.log with_note
adaptation_masterx_shared_names X-Virus-ID
acl toBump note X-Virus-ID yes
acl p3127 myportname 3127
ssl_bump client-first p3127          (Hence all requests will be bumped.)

I made changes to the eCap adapter as you had suggested. But I do not
see any annotations in access.log file.


1412995864.045      7 10.100.249.11 TAG_NONE/200 0 CONNECT
www.bwin.com:443 - HIER_NONE/- - -
1412995867.108   2573 10.100.249.11 TCP_MISS/200 10122 GET
<A HREF="https://www.bwin.com/">https://www.bwin.com/</A> - HIER_DIRECT/195.72.134.135 text/html -


Now i I introduce another paramter in the squid.conf file as below:

note X-Virus-ID yes p3127

And I get following in access.log  (so this is definitely not coming
from my eCap adapter but because of the note directive above)

1412996265.992      7 10.100.249.11 TAG_NONE/200 0 CONNECT
www.bwin.com:443 - HIER_NONE/- - X-Virus-ID:%20yes%0D%0A
1412996266.159     87 10.100.249.11 TAG_NONE/200 1400 GET
<A HREF="https://www.bwin.com/">https://www.bwin.com/</A> - HIER_NONE/- - X-Virus-ID:%20yes%0D%0A



Now, this makes me feel that annotations from my eCap adapter are not
travelling to squid for both CONNECT and GET.

So, would my eCap adapter has to do something else to let squid know
that the annotations its providing is a note.

Thanks,
Jatin


On Sat, Oct 11, 2014 at 2:18 AM, Alex Rousskov
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 10/09/2014 11:57 PM, Jatin Bhasin wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> adaptation_masterx_shared_names X-Virus-ID
</I>&gt;&gt;<i> acl toBump note X-Virus-ID yes
</I>&gt;&gt;<i> ssl_bump client-first toBump
</I>&gt;<i>
</I>&gt;<i> OK.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> My eCap adapter functions which returns yes for the X-Virus-ID are:
</I>&gt;&gt;<i> =================================================================
</I>&gt;&gt;<i> const libecap::Area Adapter::Xaction::option(const libecap::Name &amp;name) const
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i> std::string str = &quot;yes&quot;;
</I>&gt;&gt;<i> return libecap::Area(str.data(), str.size());
</I>&gt;&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Two bugs here:
</I>&gt;<i>
</I>&gt;<i> * You are returning a pointer to str, which is a temporary, on-stack
</I>&gt;<i> storage. Use libecap::Area::FromTempString() instead.
</I>&gt;<i>
</I>&gt;<i> * You are returning &quot;yes&quot; value for all option names. The return value
</I>&gt;<i> should be conditional on name parameter being lequal to
</I>&gt;<i> libecap::metaVirusId (&quot;X-Virus-ID&quot;).
</I>&gt;<i>
</I>&gt;<i> These two bugs may not actually affect you (for several reasons), but
</I>&gt;<i> you should fix them anyway.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> --------------------------------------------------------------------------------------------------------------------
</I>&gt;&gt;<i> void Adapter::Xaction::visitEachOption(libecap::NamedValueVisitor
</I>&gt;&gt;<i> &amp;visitor) const
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i> std::string str = &quot;yes&quot;;
</I>&gt;&gt;<i>     visitor.visit(libecap::metaVirusId, libecap::Area(str.data(), str.size()));
</I>&gt;&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> There is no need for std::string in this case, but the above code is not
</I>&gt;<i> buggy, just inefficient.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Looking at cache.log I see that X-Virus-ID is set to yes but the eCap
</I>&gt;&gt;<i> adapter functions. But I do not know that how it will be picked up
</I>&gt;&gt;<i> note acl. Please suggest.
</I>&gt;<i>
</I>&gt;<i> I agree that Squid seems to receive the X-Virus-ID:yes metaheader from
</I>&gt;<i> the eCAP adapter, but your toBump ACL still does not match. I cannot
</I>&gt;<i> tell why that is [not] happening by looking at the cache log, unfortunately.
</I>&gt;<i>
</I>&gt;<i> You may want to add debugging to ACLNoteData::match and
</I>&gt;<i> ACLNoteData::matchNotes in src/acl/NoteData.cc to see if the ACL code
</I>&gt;<i> has access to the eCAP history with X-Virus-ID metaheader.
</I>&gt;<i>
</I>&gt;<i> The only theory I can offer right now is that the code handling
</I>&gt;<i> annotations for CONNECT requests is broken and does not store or does
</I>&gt;<i> not preserve annotations received from eCAP adapters. CONNECT requests
</I>&gt;<i> are treated specially in Squid. You can try to test that theory by
</I>&gt;<i> annotating GET requests, for example.
</I>&gt;<i>
</I>&gt;<i> Another good test is to log your annotation to access.log using %note
</I>&gt;<i> logformat code. If it is not logged, Squid probably lost it. If it is
</I>&gt;<i> logged, then the ACL code does not have access to the information for
</I>&gt;<i> some reason. This test can be done for both CONNECT and GET requests.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> On Sat, Aug 23, 2014 at 10:24 AM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 08/21/2014 07:06 PM, Jatin Bhasin wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> So, can somebody suggest me if there is a way to pass a flag to squid
</I>&gt;&gt;&gt;&gt;<i> from ecap adapter to decrypt a site regardless of what ACL says. For
</I>&gt;&gt;&gt;&gt;<i> example if I have an acl as below which says do not decrypt
</I>&gt;&gt;&gt;&gt;<i> www.888.com but If my ecap adapter could pass a message to squid
</I>&gt;&gt;&gt;&gt;<i> asking it to decrypt www.888.com (for that session only) and ignore
</I>&gt;&gt;&gt;&gt;<i> the below acl.
</I>&gt;&gt;&gt;&gt;<i> Is it possible?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Given a recent-enough Squid version, an adaptation service can control
</I>&gt;&gt;&gt;<i> Squid behavior via the annotations mechanism and the &quot;note&quot; ACL
</I>&gt;&gt;&gt;<i> associated with it. For example, your eCAP adapter can return an
</I>&gt;&gt;&gt;<i> X-Bump:yes annotation(**) that Squid can then match using the note ACL.
</I>&gt;&gt;&gt;<i> Something along these untested lines:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   acl note toBump X-Bump yes
</I>&gt;&gt;&gt;<i>   ssl_bump server-first toBump
</I>&gt;&gt;&gt;<i>   ssl_bump server-first ...
</I>&gt;&gt;&gt;<i>   ssl_bump none all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This mechanism should be supported for ssl_bump ACLs but I have not
</I>&gt;&gt;&gt;<i> tested that claim myself.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i> (**) In eCAP terminology, an X-Bump:yes annotation is an adapter
</I>&gt;&gt;&gt;<i> transaction option named X-Bump with a &quot;yes&quot; value. See
</I>&gt;&gt;&gt;<i> libecap::Options, which is a parent of libecap::adapter::Xaction.
</I>&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000231.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
	<LI>Next message (by thread): <A HREF="000264.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#242">[ date ]</a>
              <a href="thread.html#242">[ thread ]</a>
              <a href="subject.html#242">[ subject ]</a>
              <a href="author.html#242">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
