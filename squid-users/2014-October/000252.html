<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] unexplained MISSes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20unexplained%20MISSes&In-Reply-To=%3C42DE25A255671C44A93A7B58470DC09C482473A6%40Michelle.aplitec.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000237.html">
   <LINK REL="Next"  HREF="000282.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] unexplained MISSes</H1>
    <B>Josep Borrell</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20unexplained%20MISSes&In-Reply-To=%3C42DE25A255671C44A93A7B58470DC09C482473A6%40Michelle.aplitec.local%3E"
       TITLE="[squid-users] unexplained MISSes">jborrell at central.aplitec.com
       </A><BR>
    <I>Sat Oct 11 14:36:18 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000237.html">[squid-users] unexplained MISSes
</A></li>
        <LI>Next message (by thread): <A HREF="000282.html">[squid-users] unexplained MISSes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#252">[ date ]</a>
              <a href="thread.html#252">[ thread ]</a>
              <a href="subject.html#252">[ subject ]</a>
              <a href="author.html#252">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

I know that the first request is always a miss.
I'm reproducing the same v&#237;deo from the same PC, and same browser erasing the cache between tests.

Are there any doc that explain the meaning of all responses like ORIGINAL_DST ?
And are there any way to know the reason of a MISS or a HIT ?
I tried with the debug options, but the reason of a MISS isn't there.

Thanks

Josep


-----Mensaje original-----
De: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] En nombre de Amos Jeffries
Enviado el: viernes, 10 de octubre de 2014 19:05
Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Asunto: Re: [squid-users] unexplained MISSes

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 11/10/2014 5:00 a.m., Josep Borrell wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm trying build a squid server that can cache youtube request for a 
</I>&gt;<i> school. I'm using squid 3.4.7 compiled from source on Ubuntu server 
</I>&gt;<i> 14.04 I have a lot of request that are cached, but not served from 
</I>&gt;<i> cache and generate a TCP_MISS/200 I'm trying to figure why this 
</I>&gt;<i> requests are not served from cache. Please find attached squid.conf 
</I>&gt;<i> and cache.log sample with debug enabled.
</I>&gt;<i> 
</I>&gt;<i> I hope someone can help me.
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Josep
</I>&gt;<i> 
</I>&gt;<i> *************************************************** access.log
</I>&gt;<i> *******************************************************************
</I>&gt;<i>
</I>&gt;<i>  1412953551.775    167 192.168.1.112 TCP_MISS/200 4344 GET
</I>&gt;<i> <A HREF="http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg">http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg</A> -
</I>&gt;<i> ORIGINAL_DST/74.125.230.3 image/jpeg
</I>&gt;<i> 
</I>
I see ORIGINAL_DST, meaning you are intercepting users traffic. This interception action naturally imposes some big problems which Squid has to deal with.

IF the domain name does not specifically resolve for Squid to the same IP the user/client was contacting the object is NOT safely cacheable.
Squid will therefore not cache it, so as to prevent one smart-alec student causing <A HREF="http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg">http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg</A> to be fetched from a malware host - thus infecting anyone else loading the &quot;image&quot; they get back.

That required decision by Squid may be part of your problem, or not.
Check the log file for mentions of &quot;Host header forgery&quot; by this clients connection or the previous one(s) fetching that same URL.

NP: if there is *none* previously fetching the URL, there is your answer. For it to have become cached someone has to fetch it - the first fetch is *always* a MISS.


&gt;<i> ****************************** cache.log
</I>&gt;<i> **********************************************************************
</I>&gt;<i> ********************
</I>&gt;<i>
</I>&gt;<i> 
</I>- ----------
&gt;<i> 2014/10/10 17:05:51.772| ctx: enter level  0:
</I>&gt;<i> '<A HREF="http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg">http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg</A>' 
</I>&gt;<i> 2014/10/10 17:05:51.773| http.cc(705) processReplyHeader:
</I>&gt;<i> processReplyHeader: key '9F1BB8D27BED16A8B74F8995105B2941' 
</I>&gt;<i> 2014/10/10 17:05:51.773| http.cc(749) processReplyHeader: HTTP Server 
</I>&gt;<i> local=192.168.111.10:59210 remote=74.125.230.3:80 FD 65
</I>&gt;<i> flags=1 2014/10/10 17:05:51.773| http.cc(750) processReplyHeader:
</I>&gt;<i> HTTP Server REPLY: --------- HTTP/1.1 200 OK Content-Type:
</I>&gt;<i> image/jpeg Last-Modified: Thu, 01 Jan 1970 00:23:21 GMT Date: Fri,
</I>&gt;<i> 10 Oct 2014 10:45:51 GMT Expires: Fri, 10 Oct 2014 16:45:51 GMT
</I>&gt;<i> X-Content-Type-Options: nosniff Server: sffe Content-Length: 3861
</I>&gt;<i> X-XSS-Protection: 1; mode=block Age: 15619 Cache-Control: public,
</I>&gt;<i> max-age=21600 Alternate-Protocol: 80:quic,p=0.01
</I>&gt;<i> 
</I>&gt;<i> &#239;&#191;&#189;&#239;&#191;&#189;&#239;&#191;&#189;&#239;&#191;&#189; ---------- 2014/10/10 17:05:51.773| ctx: exit level
</I>&gt;<i> 0 2014/10/10 17:05:51.773| ctx: enter level  0:
</I>&gt;<i> '<A HREF="http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg">http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg</A>' 
</I>&gt;<i> 2014/10/10 17:05:51.773| http.cc(919) haveParsedReplyHeaders: HTTP
</I>&gt;<i> CODE: 200 2014/10/10 17:05:51.773| refresh.cc(247) refreshCheck:
</I>&gt;<i> refreshCheck:
</I>&gt;<i> '<A HREF="http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg">http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg</A>' 
</I>&gt;<i> 2014/10/10 17:05:51.773| refresh.cc(262) refreshCheck:
</I>&gt;<i> refreshCheck: Matched '^http:\/\/ytimg\.com\.squid\.internal.*
</I>&gt;<i> 604800 80%% 4794000' 2014/10/10 17:05:51.773| refresh.cc(264)
</I>&gt;<i> refreshCheck:  age:    15679 2014/10/10 17:05:51.773|
</I>&gt;<i> refresh.cc(266) refreshCheck:  check_time:     Fri, 10 Oct 2014
</I>&gt;<i> 15:06:51 GMT 2014/10/10 17:05:51.773| refresh.cc(268) refreshCheck:
</I>&gt;<i> entry-&gt;timestamp:       Fri, 10 Oct 2014 10:45:32 GMT 2014/10/10
</I>&gt;<i> 17:05:51.773| refresh.cc(171) refreshStaleness: FRESH: expires
</I>&gt;<i> 1412959532 &gt;= check_time 1412953611 2014/10/10 17:05:51.773|
</I>&gt;<i> refresh.cc(288) refreshCheck: Staleness = -1 2014/10/10 17:05:51.773| 
</I>&gt;<i> refresh.cc(373) refreshCheck: refreshCheck: object isn't stale.. 
</I>&gt;<i> 2014/10/10 17:05:51.773| refresh.cc(375)
</I>&gt;<i> refreshCheck: refreshCheck: returning FRESH_EXPIRES 2014/10/10 
</I>&gt;<i> 17:05:51.773| http.cc(482) cacheableReply: YES because HTTP status
</I>&gt;<i> 200
</I>

That image is cacheable according to its headers. Provided the next client fetches it again within the next 99mins, and the interception limits do not prevent storage.

Check for mentions of &quot;Host header forgery&quot; by this same user/client or the previous one fetching this URL.


&gt;<i> 
</I>&gt;<i> **********************************************************************
</I>&gt;<i> squid.conf *******************************************************
</I>&gt;<i> 
</I>&gt;<i> # debug helper #debug_options 84,3 #debug Refresh Calculation 
</I>&gt;<i> #debug_options 22,3 # HTTP #debug_options 11,3
</I>&gt;<i> 
</I>&gt;<i> debug_options 11,3 22,3 84,3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl customernet src 172.16.212.154/32 acl customernet src
</I>&gt;<i> 192.168.1.0/24
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443 acl SSL_ports port 873  # rsync
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80         # http acl Safe_ports port 21
</I>&gt;<i> # ftp acl Safe_ports port 443        # https acl Safe_ports port 70
</I>&gt;<i> # gopher acl Safe_ports port 210        # wais acl Safe_ports port
</I>&gt;<i> 1025-65535 # unregistered ports acl Safe_ports port 280        #
</I>&gt;<i> http-mgmt acl Safe_ports port 488        # gss-http acl Safe_ports
</I>&gt;<i> port 591        # filemaker acl Safe_ports port 777        #
</I>&gt;<i> multiling http acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports http_access deny CONNECT !SSL_ports 
</I>&gt;<i> http_access allow localhost manager http_access deny manager 
</I>&gt;<i> http_access allow localhost http_access allow customernet http_access 
</I>&gt;<i> deny all # http_access allow all
</I>&gt;<i> 
</I>&gt;<i> #HTTPS (SSL) trafic interception options always_direct allow SSL_ports 
</I>&gt;<i> ssl_bump server-first SSL_ports #sslproxy_cert_error deny all 
</I>&gt;<i> #sslproxy_flags DONT_VERIFY_PEER sslcrtd_program 
</I>&gt;<i> /usr/lib/squid3/ssl_crtd -s /var/spool/squid3_ssldb -M 4MB 
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> 
</I>&gt;<i> acl rewritedoms dstdomain .c.youtube.com .googlevideo.com .ytimg.com 
</I>&gt;<i> store_id_program /usr/lib/squid3/storeid_file_rewrite
</I>&gt;<i> /etc/squid3/storeid_rewrite store_id_children 40 startup=10 idle=5
</I>&gt;<i> concurrency=0 store_id_access allow rewritedoms store_id_access deny 
</I>&gt;<i> all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 http_port 8080 intercept https_port 8081 intercept 
</I>&gt;<i> ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>&gt;<i> cert=/etc/squid3/ssl_cert/squidcert.pem
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> forward_max_tries 25 cache_mem 2 GB maximum_object_size_in_memory
</I>&gt;<i> 25 MB maximum_object_size 1 GB
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid-v2 dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/spool/squid3 cache_replacement_policy heap LFUDA 
</I>&gt;<i> cache_dir aufs /var/spool/squid3 14000 16 256
</I>
14GB of disk trying to cache YT videos may not be enough space.

If the objects being fetched above were legitimately discarded to make room for newer content then MISS is entirely to be expected.

&gt;<i> 
</I>&gt;<i> refresh_pattern
</I>&gt;<i> ^http:\/\/video-srv\.(googlevideo|youtube)\.com\.squid\.internal.*
</I>&gt;<i> 10080 80%  79900 override-lastmod override-expire ignore-reload 
</I>&gt;<i> ignore-must-revalidate ignore-private refresh_pattern
</I>&gt;<i> ^http:\/\/ytimg\.com\.squid\.internal.*  10080 80%  79900 
</I>&gt;<i> override-lastmod override-expire ignore-reload ignore-must-revalidate 
</I>&gt;<i> ignore-private
</I>

If you look at those server reply headers you can see the Cache-Control explicitly says the reply is &quot;public&quot;. This means that the &quot;ignore-private&quot; setting is useless on these images.
 * ignoring privacy controls is a highly nasty thing to do to start with. I suggest strongly that you remove it from the ytimg pattern options as unnecessary.

Also, here is an artifact of the override options which you may not be
aware:

 The Expires header coming from YT indicates that the reply is cacheable for 6hrs from the time it was generated. That is 21600 seconds, no less.
 Your override-expires is actively *reducing* the storage time to
10800 seconds (the 'min' field of the pattern options).

 Therefore to maximise caching you should *drop* the override-expires option on the ytimg pattern.


NP: override-lastmod is usually also a bad thing to do, but I see you are actually hitting THE use-case for which it legitimately exist...
server emitting incorrect Last-Modified value (1970? sure).



Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUOBHWAAoJELJo5wb/XPRjGv4H/iKpL4UUBOXVsy7BixBeM5xp
JoyRtwRcfH8ksI/G622KANQ2XzOMLyYr9BX5X8ofBGjT8WRRxEbQDzp/EVADB7+6
xO/OwW2413YiYSmgszOTx0joAdUFB4R4ShnCEjDHQ6RJFKIquQql58hDN+6eGHFZ
AkzrlL+V+CzkpOGWmu51kBLlaSMQJ2SaWOJMw0ykn4giuL87XYeRyQ9seFR9Q5Ll
7cKi0QZflcCvDnwa87vPfnvsQfBF/cFjuv7/NigGsO8IklgQ/T3xPf+A6WVXmURj
USLjOmFFsA6xaLZMBeUnmWo4kjX5iYXT1S14yQokpf+DUPfaM0+bt/hUFNLnkuk=
=1TqK
-----END PGP SIGNATURE-----
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000237.html">[squid-users] unexplained MISSes
</A></li>
	<LI>Next message (by thread): <A HREF="000282.html">[squid-users] unexplained MISSes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#252">[ date ]</a>
              <a href="thread.html#252">[ thread ]</a>
              <a href="subject.html#252">[ subject ]</a>
              <a href="author.html#252">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
