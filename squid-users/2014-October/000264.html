<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] blockVirgin Works for CONNECT but Custom Response does not work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20blockVirgin%20Works%20for%20CONNECT%20but%20Custom%20Response%0A%20does%20not%20work&In-Reply-To=%3CCAGRJihXc6s-bQZq01J7wjihJBmuvWQSvQNFLUtbm6OQ1iJp%3DEg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000242.html">
   <LINK REL="Next"  HREF="000225.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] blockVirgin Works for CONNECT but Custom Response does not work</H1>
    <B>Jatin Bhasin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20blockVirgin%20Works%20for%20CONNECT%20but%20Custom%20Response%0A%20does%20not%20work&In-Reply-To=%3CCAGRJihXc6s-bQZq01J7wjihJBmuvWQSvQNFLUtbm6OQ1iJp%3DEg%40mail.gmail.com%3E"
       TITLE="[squid-users] blockVirgin Works for CONNECT but Custom Response does not work">jbhasin83 at gmail.com
       </A><BR>
    <I>Mon Oct 13 01:42:07 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000242.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
        <LI>Next message (by thread): <A HREF="000225.html">[squid-users] 501 error within a webpage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#264">[ date ]</a>
              <a href="thread.html#264">[ thread ]</a>
              <a href="subject.html#264">[ subject ]</a>
              <a href="author.html#264">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

I think I have found the reason that why the annotation from eCap
adapter NOT being passed to NoteData.cc. But I still need your
suggestion to fix this.

So here is my analysis:

1) In src/acl/NoteData.cc function ACLNoteData::match(HttpRequest *request)

    if (request-&gt;notes != NULL &amp;&amp; matchNotes(request-&gt;notes.getRaw()))
               (This is used when there is note directive in
squid.conf file)
        return true;


    if (ah != NULL &amp;&amp; ah-&gt;metaHeaders != NULL &amp;&amp;
matchNotes(ah-&gt;metaHeaders.getRaw()))                   (This is used
when there is adaptation_meta in squid.conf file)
        return true;

2) In src/adaptation/ecap/XactionRep.cc function
Adaptation::Ecap::XactionRep::start()

    if (ah != NULL) {
        // retrying=false because ecap never retries transactions
        adaptHistoryId = ah-&gt;recordXactStart(service().cfg().key,
current_time, false);
        typedef Notes::iterator ACAMLI;
        for (ACAMLI i = Adaptation::Config::metaHeaders.begin(); i !=
Adaptation::Config::metaHeaders.end(); ++i) {
            const char *v = (*i)-&gt;match(request, reply);
            if (v) {
                if (ah-&gt;metaHeaders == NULL)
                    ah-&gt;metaHeaders = new NotePairs();
                if (!ah-&gt;metaHeaders-&gt;hasPair((*i)-&gt;key.termedBuf(), v))
                    ah-&gt;metaHeaders-&gt;add((*i)-&gt;key.termedBuf(), v);
            }
        }
    }


As per the above code ah-&gt;metaHeaders will only be populated if
adaptation_meta option is present in squid.conf file.

So in my case ah-&gt;metaHeaders is NULL  (And when I added
adaptation_meta X-Virus-ID yes all in squid.conf then I could get a
match on my toBump acl and hence my CONNECT transaction was bumped.
But I want to achieve the same behavior using eCap adapter)


Also I changed the squid.conf file for access.log as below:
logformat with_note %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un
%Sh/%&lt;a %mt %note %adapt::&lt;last_h


And I could see that eCap adapter X-Virus-ID:yes in the access.log
(%adapt::&lt;last_h)

So, I think I am very close to pass X-Virus-ID:yes as a meta header.
Can you suggest me how I can do it. (I think it may require a code
change in XactionRep.cc but I am not sure.) Please suggest.

Thanks,
Jatin




On Sat, Oct 11, 2014 at 2:03 PM, Jatin Bhasin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jbhasin83 at gmail.com</A>&gt; wrote:
&gt;<i> Hi Alex,
</I>&gt;<i>
</I>&gt;<i> I changed my ACL's a bit to see annotations in access.log file. My web
</I>&gt;<i> browser is point to squid port 3127.
</I>&gt;<i>
</I>&gt;<i> So squid.conf is as below:  (first two lines are for note logging as
</I>&gt;<i> you suggested.)
</I>&gt;<i> ---------------------------------------------
</I>&gt;<i> logformat with_note %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un
</I>&gt;<i> %Sh/%&lt;a %mt %note
</I>&gt;<i> access_log /var/log/squid/access.log with_note
</I>&gt;<i> adaptation_masterx_shared_names X-Virus-ID
</I>&gt;<i> acl toBump note X-Virus-ID yes
</I>&gt;<i> acl p3127 myportname 3127
</I>&gt;<i> ssl_bump client-first p3127          (Hence all requests will be bumped.)
</I>&gt;<i>
</I>&gt;<i> I made changes to the eCap adapter as you had suggested. But I do not
</I>&gt;<i> see any annotations in access.log file.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 1412995864.045      7 10.100.249.11 TAG_NONE/200 0 CONNECT
</I>&gt;<i> www.bwin.com:443 - HIER_NONE/- - -
</I>&gt;<i> 1412995867.108   2573 10.100.249.11 TCP_MISS/200 10122 GET
</I>&gt;<i> <A HREF="https://www.bwin.com/">https://www.bwin.com/</A> - HIER_DIRECT/195.72.134.135 text/html -
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now i I introduce another paramter in the squid.conf file as below:
</I>&gt;<i>
</I>&gt;<i> note X-Virus-ID yes p3127
</I>&gt;<i>
</I>&gt;<i> And I get following in access.log  (so this is definitely not coming
</I>&gt;<i> from my eCap adapter but because of the note directive above)
</I>&gt;<i>
</I>&gt;<i> 1412996265.992      7 10.100.249.11 TAG_NONE/200 0 CONNECT
</I>&gt;<i> www.bwin.com:443 - HIER_NONE/- - X-Virus-ID:%20yes%0D%0A
</I>&gt;<i> 1412996266.159     87 10.100.249.11 TAG_NONE/200 1400 GET
</I>&gt;<i> <A HREF="https://www.bwin.com/">https://www.bwin.com/</A> - HIER_NONE/- - X-Virus-ID:%20yes%0D%0A
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now, this makes me feel that annotations from my eCap adapter are not
</I>&gt;<i> travelling to squid for both CONNECT and GET.
</I>&gt;<i>
</I>&gt;<i> So, would my eCap adapter has to do something else to let squid know
</I>&gt;<i> that the annotations its providing is a note.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Jatin
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sat, Oct 11, 2014 at 2:18 AM, Alex Rousskov
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 10/09/2014 11:57 PM, Jatin Bhasin wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> adaptation_masterx_shared_names X-Virus-ID
</I>&gt;&gt;&gt;<i> acl toBump note X-Virus-ID yes
</I>&gt;&gt;&gt;<i> ssl_bump client-first toBump
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OK.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My eCap adapter functions which returns yes for the X-Virus-ID are:
</I>&gt;&gt;&gt;<i> =================================================================
</I>&gt;&gt;&gt;<i> const libecap::Area Adapter::Xaction::option(const libecap::Name &amp;name) const
</I>&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;<i> std::string str = &quot;yes&quot;;
</I>&gt;&gt;&gt;<i> return libecap::Area(str.data(), str.size());
</I>&gt;&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Two bugs here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * You are returning a pointer to str, which is a temporary, on-stack
</I>&gt;&gt;<i> storage. Use libecap::Area::FromTempString() instead.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * You are returning &quot;yes&quot; value for all option names. The return value
</I>&gt;&gt;<i> should be conditional on name parameter being lequal to
</I>&gt;&gt;<i> libecap::metaVirusId (&quot;X-Virus-ID&quot;).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These two bugs may not actually affect you (for several reasons), but
</I>&gt;&gt;<i> you should fix them anyway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --------------------------------------------------------------------------------------------------------------------
</I>&gt;&gt;&gt;<i> void Adapter::Xaction::visitEachOption(libecap::NamedValueVisitor
</I>&gt;&gt;&gt;<i> &amp;visitor) const
</I>&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;<i> std::string str = &quot;yes&quot;;
</I>&gt;&gt;&gt;<i>     visitor.visit(libecap::metaVirusId, libecap::Area(str.data(), str.size()));
</I>&gt;&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There is no need for std::string in this case, but the above code is not
</I>&gt;&gt;<i> buggy, just inefficient.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Looking at cache.log I see that X-Virus-ID is set to yes but the eCap
</I>&gt;&gt;&gt;<i> adapter functions. But I do not know that how it will be picked up
</I>&gt;&gt;&gt;<i> note acl. Please suggest.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I agree that Squid seems to receive the X-Virus-ID:yes metaheader from
</I>&gt;&gt;<i> the eCAP adapter, but your toBump ACL still does not match. I cannot
</I>&gt;&gt;<i> tell why that is [not] happening by looking at the cache log, unfortunately.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You may want to add debugging to ACLNoteData::match and
</I>&gt;&gt;<i> ACLNoteData::matchNotes in src/acl/NoteData.cc to see if the ACL code
</I>&gt;&gt;<i> has access to the eCAP history with X-Virus-ID metaheader.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The only theory I can offer right now is that the code handling
</I>&gt;&gt;<i> annotations for CONNECT requests is broken and does not store or does
</I>&gt;&gt;<i> not preserve annotations received from eCAP adapters. CONNECT requests
</I>&gt;&gt;<i> are treated specially in Squid. You can try to test that theory by
</I>&gt;&gt;<i> annotating GET requests, for example.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Another good test is to log your annotation to access.log using %note
</I>&gt;&gt;<i> logformat code. If it is not logged, Squid probably lost it. If it is
</I>&gt;&gt;<i> logged, then the ACL code does not have access to the information for
</I>&gt;&gt;<i> some reason. This test can be done for both CONNECT and GET requests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Sat, Aug 23, 2014 at 10:24 AM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> On 08/21/2014 07:06 PM, Jatin Bhasin wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So, can somebody suggest me if there is a way to pass a flag to squid
</I>&gt;&gt;&gt;&gt;&gt;<i> from ecap adapter to decrypt a site regardless of what ACL says. For
</I>&gt;&gt;&gt;&gt;&gt;<i> example if I have an acl as below which says do not decrypt
</I>&gt;&gt;&gt;&gt;&gt;<i> www.888.com but If my ecap adapter could pass a message to squid
</I>&gt;&gt;&gt;&gt;&gt;<i> asking it to decrypt www.888.com (for that session only) and ignore
</I>&gt;&gt;&gt;&gt;&gt;<i> the below acl.
</I>&gt;&gt;&gt;&gt;&gt;<i> Is it possible?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Given a recent-enough Squid version, an adaptation service can control
</I>&gt;&gt;&gt;&gt;<i> Squid behavior via the annotations mechanism and the &quot;note&quot; ACL
</I>&gt;&gt;&gt;&gt;<i> associated with it. For example, your eCAP adapter can return an
</I>&gt;&gt;&gt;&gt;<i> X-Bump:yes annotation(**) that Squid can then match using the note ACL.
</I>&gt;&gt;&gt;&gt;<i> Something along these untested lines:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>   acl note toBump X-Bump yes
</I>&gt;&gt;&gt;&gt;<i>   ssl_bump server-first toBump
</I>&gt;&gt;&gt;&gt;<i>   ssl_bump server-first ...
</I>&gt;&gt;&gt;&gt;<i>   ssl_bump none all
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> This mechanism should be supported for ssl_bump ACLs but I have not
</I>&gt;&gt;&gt;&gt;<i> tested that claim myself.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;&gt;<i> (**) In eCAP terminology, an X-Bump:yes annotation is an adapter
</I>&gt;&gt;&gt;&gt;<i> transaction option named X-Bump with a &quot;yes&quot; value. See
</I>&gt;&gt;&gt;&gt;<i> libecap::Options, which is a parent of libecap::adapter::Xaction.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000242.html">[squid-users] blockVirgin Works for CONNECT but Custom Response does not work
</A></li>
	<LI>Next message (by thread): <A HREF="000225.html">[squid-users] 501 error within a webpage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#264">[ date ]</a>
              <a href="thread.html#264">[ thread ]</a>
              <a href="subject.html#264">[ subject ]</a>
              <a href="author.html#264">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
