<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] unexplained MISSes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20unexplained%20MISSes&In-Reply-To=%3C543CA2D1.3070506%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000252.html">
   <LINK REL="Next"  HREF="000269.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] unexplained MISSes</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20unexplained%20MISSes&In-Reply-To=%3C543CA2D1.3070506%40treenet.co.nz%3E"
       TITLE="[squid-users] unexplained MISSes">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct 14 04:13:05 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000252.html">[squid-users] unexplained MISSes
</A></li>
        <LI>Next message (by thread): <A HREF="000269.html">[squid-users] unexplained MISSes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#282">[ date ]</a>
              <a href="thread.html#282">[ thread ]</a>
              <a href="subject.html#282">[ subject ]</a>
              <a href="author.html#282">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 12/10/2014 3:36 a.m., Josep Borrell wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> I know that the first request is always a miss. I'm reproducing the
</I>&gt;<i> same v&#237;deo from the same PC, and same browser erasing the cache
</I>&gt;<i> between tests.
</I>&gt;<i> 
</I>&gt;<i> Are there any doc that explain the meaning of all responses like
</I>&gt;<i> ORIGINAL_DST ?
</I>
<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidLogs#Hierarchy_Codes">http://wiki.squid-cache.org/SquidFaq/SquidLogs#Hierarchy_Codes</A>

ORIGINAL_DST is when interception is used. It is like DIRECT, but with
transparency in regards to server IP the client is contacting.

Since so many people have confused &quot;interception proxy&quot; with
&quot;transparent proxy&quot; we have enabled transparent request handling by
default whenever interception is performed. You can use the
client_dst_passthru option to turn off server-IP transparency.


&gt;<i> And are there any way to know the reason of a MISS or a HIT ? I
</I>&gt;<i> tried with the debug options, but the reason of a MISS isn't
</I>&gt;<i> there.
</I>
The reasons for HIT/MISS are simple; a HIT can only happen if there is
a matching object in cache, REFRESH if there is a stale object in
cache, and MISS if there is no object in cache.

The reasons why (or not) an object is available gets more complicated
and occurs on the *previous* transaction for the same URL. That gets
logic in many different areas having a veto on caching. The main areas
are the store logic and refresh logics. But in particular with
interception the Host security checks also have a large say.

With both interception and store-id acting on the transaction the
story gets even more complicated.
 - you found no mention of forgery detection in your log, so we can
ignore that bit of potential complication.
 - store-id means that not just any previous transaction, but also any
previous transaction(s) sharing the same store-ID will affect the
cache state for this URL.

Amos


&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Josep
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Mensaje original----- De: squid-users En nombre de Amos
</I>&gt;<i> Jeffries
</I>&gt;<i> 
</I>&gt;<i> On 11/10/2014 5:00 a.m., Josep Borrell wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm trying build a squid server that can cache youtube request
</I>&gt;&gt;<i> for a school. I'm using squid 3.4.7 compiled from source on
</I>&gt;&gt;<i> Ubuntu server 14.04 I have a lot of request that are cached, but
</I>&gt;&gt;<i> not served from cache and generate a TCP_MISS/200 I'm trying to
</I>&gt;&gt;<i> figure why this requests are not served from cache. Please find
</I>&gt;&gt;<i> attached squid.conf and cache.log sample with debug enabled.
</I>&gt;<i> 
</I>&gt;&gt;<i> I hope someone can help me.
</I>&gt;<i> 
</I>&gt;&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;&gt;<i> Josep
</I>&gt;<i> 
</I>&gt;&gt;<i> *************************************************** access.log 
</I>&gt;&gt;<i> *******************************************************************
</I>&gt;<i>
</I>&gt;&gt;<i>  1412953551.775    167 192.168.1.112 TCP_MISS/200 4344 GET 
</I>&gt;&gt;<i> <A HREF="http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg">http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg</A> - 
</I>&gt;&gt;<i> ORIGINAL_DST/74.125.230.3 image/jpeg
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I see ORIGINAL_DST, meaning you are intercepting users traffic.
</I>&gt;<i> This interception action naturally imposes some big problems which
</I>&gt;<i> Squid has to deal with.
</I>&gt;<i> 
</I>&gt;<i> IF the domain name does not specifically resolve for Squid to the
</I>&gt;<i> same IP the user/client was contacting the object is NOT safely
</I>&gt;<i> cacheable. Squid will therefore not cache it, so as to prevent one
</I>&gt;<i> smart-alec student causing
</I>&gt;<i> <A HREF="http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg">http://i1.ytimg.com/vi/9_iANxI-Mrc/default.jpg</A> to be fetched from a
</I>&gt;<i> malware host - thus infecting anyone else loading the &quot;image&quot; they
</I>&gt;<i> get back.
</I>&gt;<i> 
</I>&gt;<i> That required decision by Squid may be part of your problem, or
</I>&gt;<i> not. Check the log file for mentions of &quot;Host header forgery&quot; by
</I>&gt;<i> this clients connection or the previous one(s) fetching that same
</I>&gt;<i> URL.
</I>&gt;<i> 
</I>&gt;<i> NP: if there is *none* previously fetching the URL, there is your
</I>&gt;<i> answer. For it to have become cached someone has to fetch it - the
</I>&gt;<i> first fetch is *always* a MISS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> ****************************** cache.log 
</I>&gt;&gt;<i> **********************************************************************
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>********************
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;&gt;<i> 2014/10/10 17:05:51.772| ctx: enter level  0: 
</I>&gt;&gt;<i> '<A HREF="http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg">http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg</A>' 
</I>&gt;&gt;<i> 2014/10/10 17:05:51.773| http.cc(705) processReplyHeader: 
</I>&gt;&gt;<i> processReplyHeader: key '9F1BB8D27BED16A8B74F8995105B2941' 
</I>&gt;&gt;<i> 2014/10/10 17:05:51.773| http.cc(749) processReplyHeader: HTTP
</I>&gt;&gt;<i> Server local=192.168.111.10:59210 remote=74.125.230.3:80 FD 65 
</I>&gt;&gt;<i> flags=1 2014/10/10 17:05:51.773| http.cc(750)
</I>&gt;&gt;<i> processReplyHeader: HTTP Server REPLY: --------- HTTP/1.1 200 OK
</I>&gt;&gt;<i> Content-Type: image/jpeg Last-Modified: Thu, 01 Jan 1970 00:23:21
</I>&gt;&gt;<i> GMT Date: Fri, 10 Oct 2014 10:45:51 GMT Expires: Fri, 10 Oct 2014
</I>&gt;&gt;<i> 16:45:51 GMT X-Content-Type-Options: nosniff Server: sffe
</I>&gt;&gt;<i> Content-Length: 3861 X-XSS-Protection: 1; mode=block Age: 15619
</I>&gt;&gt;<i> Cache-Control: public, max-age=21600 Alternate-Protocol:
</I>&gt;&gt;<i> 80:quic,p=0.01
</I>&gt;<i> 
</I>&gt;&gt;<i> &#239;&#191;&#189;&#239;&#191;&#189;&#239;&#191;&#189;&#239;&#191;&#189; ---------- 2014/10/10 17:05:51.773| ctx: exit level 
</I>&gt;&gt;<i> 0 2014/10/10 17:05:51.773| ctx: enter level  0: 
</I>&gt;&gt;<i> '<A HREF="http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg">http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg</A>' 
</I>&gt;&gt;<i> 2014/10/10 17:05:51.773| http.cc(919) haveParsedReplyHeaders:
</I>&gt;&gt;<i> HTTP CODE: 200 2014/10/10 17:05:51.773| refresh.cc(247)
</I>&gt;&gt;<i> refreshCheck: refreshCheck: 
</I>&gt;&gt;<i> '<A HREF="http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg">http://ytimg.com.squid.internal/vi/9_iANxI-Mrc/default.jpg</A>' 
</I>&gt;&gt;<i> 2014/10/10 17:05:51.773| refresh.cc(262) refreshCheck: 
</I>&gt;&gt;<i> refreshCheck: Matched '^http:\/\/ytimg\.com\.squid\.internal.* 
</I>&gt;&gt;<i> 604800 80%% 4794000' 2014/10/10 17:05:51.773| refresh.cc(264) 
</I>&gt;&gt;<i> refreshCheck:  age:    15679 2014/10/10 17:05:51.773| 
</I>&gt;&gt;<i> refresh.cc(266) refreshCheck:  check_time:     Fri, 10 Oct 2014 
</I>&gt;&gt;<i> 15:06:51 GMT 2014/10/10 17:05:51.773| refresh.cc(268)
</I>&gt;&gt;<i> refreshCheck: entry-&gt;timestamp:       Fri, 10 Oct 2014 10:45:32
</I>&gt;&gt;<i> GMT 2014/10/10 17:05:51.773| refresh.cc(171) refreshStaleness:
</I>&gt;&gt;<i> FRESH: expires 1412959532 &gt;= check_time 1412953611 2014/10/10
</I>&gt;&gt;<i> 17:05:51.773| refresh.cc(288) refreshCheck: Staleness = -1
</I>&gt;&gt;<i> 2014/10/10 17:05:51.773| refresh.cc(373) refreshCheck:
</I>&gt;&gt;<i> refreshCheck: object isn't stale.. 2014/10/10 17:05:51.773|
</I>&gt;&gt;<i> refresh.cc(375) refreshCheck: refreshCheck: returning
</I>&gt;&gt;<i> FRESH_EXPIRES 2014/10/10 17:05:51.773| http.cc(482)
</I>&gt;&gt;<i> cacheableReply: YES because HTTP status 200
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> That image is cacheable according to its headers. Provided the next
</I>&gt;<i> client fetches it again within the next 99mins, and the
</I>&gt;<i> interception limits do not prevent storage.
</I>&gt;<i> 
</I>&gt;<i> Check for mentions of &quot;Host header forgery&quot; by this same
</I>&gt;<i> user/client or the previous one fetching this URL.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> **********************************************************************
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>squid.conf *******************************************************
&gt;<i> 
</I>&gt;&gt;<i> # debug helper #debug_options 84,3 #debug Refresh Calculation 
</I>&gt;&gt;<i> #debug_options 22,3 # HTTP #debug_options 11,3
</I>&gt;<i> 
</I>&gt;&gt;<i> debug_options 11,3 22,3 84,3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> acl customernet src 172.16.212.154/32 acl customernet src 
</I>&gt;&gt;<i> 192.168.1.0/24
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> acl SSL_ports port 443 acl SSL_ports port 873  # rsync
</I>&gt;<i> 
</I>&gt;&gt;<i> acl Safe_ports port 80         # http acl Safe_ports port 21 #
</I>&gt;&gt;<i> ftp acl Safe_ports port 443        # https acl Safe_ports port
</I>&gt;&gt;<i> 70 # gopher acl Safe_ports port 210        # wais acl Safe_ports
</I>&gt;&gt;<i> port 1025-65535 # unregistered ports acl Safe_ports port 280
</I>&gt;&gt;<i> # http-mgmt acl Safe_ports port 488        # gss-http acl
</I>&gt;&gt;<i> Safe_ports port 591        # filemaker acl Safe_ports port 777
</I>&gt;&gt;<i> # multiling http acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;&gt;<i> http_access deny !Safe_ports http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i>  http_access allow localhost manager http_access deny manager 
</I>&gt;&gt;<i> http_access allow localhost http_access allow customernet
</I>&gt;&gt;<i> http_access deny all # http_access allow all
</I>&gt;<i> 
</I>&gt;&gt;<i> #HTTPS (SSL) trafic interception options always_direct allow
</I>&gt;&gt;<i> SSL_ports ssl_bump server-first SSL_ports #sslproxy_cert_error
</I>&gt;&gt;<i> deny all #sslproxy_flags DONT_VERIFY_PEER sslcrtd_program 
</I>&gt;&gt;<i> /usr/lib/squid3/ssl_crtd -s /var/spool/squid3_ssldb -M 4MB 
</I>&gt;&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> 
</I>&gt;&gt;<i> acl rewritedoms dstdomain .c.youtube.com .googlevideo.com
</I>&gt;&gt;<i> .ytimg.com store_id_program /usr/lib/squid3/storeid_file_rewrite 
</I>&gt;&gt;<i> /etc/squid3/storeid_rewrite store_id_children 40 startup=10
</I>&gt;&gt;<i> idle=5 concurrency=0 store_id_access allow rewritedoms
</I>&gt;&gt;<i> store_id_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> http_port 3128 http_port 8080 intercept https_port 8081 intercept
</I>&gt;&gt;<i>  ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB 
</I>&gt;&gt;<i> cert=/etc/squid3/ssl_cert/squidcert.pem
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> forward_max_tries 25 cache_mem 2 GB
</I>&gt;&gt;<i> maximum_object_size_in_memory 25 MB maximum_object_size 1 GB
</I>&gt;<i> 
</I>&gt;&gt;<i> visible_hostname squid-v2 dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> coredump_dir /var/spool/squid3 cache_replacement_policy heap
</I>&gt;&gt;<i> LFUDA cache_dir aufs /var/spool/squid3 14000 16 256
</I>&gt;<i> 
</I>&gt;<i> 14GB of disk trying to cache YT videos may not be enough space.
</I>&gt;<i> 
</I>&gt;<i> If the objects being fetched above were legitimately discarded to
</I>&gt;<i> make room for newer content then MISS is entirely to be expected.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> refresh_pattern 
</I>&gt;&gt;<i> ^http:\/\/video-srv\.(googlevideo|youtube)\.com\.squid\.internal.*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 
</I>10080 80%  79900 override-lastmod override-expire ignore-reload
&gt;&gt;<i> ignore-must-revalidate ignore-private refresh_pattern 
</I>&gt;&gt;<i> ^http:\/\/ytimg\.com\.squid\.internal.*  10080 80%  79900 
</I>&gt;&gt;<i> override-lastmod override-expire ignore-reload
</I>&gt;&gt;<i> ignore-must-revalidate ignore-private
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If you look at those server reply headers you can see the
</I>&gt;<i> Cache-Control explicitly says the reply is &quot;public&quot;. This means
</I>&gt;<i> that the &quot;ignore-private&quot; setting is useless on these images. *
</I>&gt;<i> ignoring privacy controls is a highly nasty thing to do to start
</I>&gt;<i> with. I suggest strongly that you remove it from the ytimg pattern
</I>&gt;<i> options as unnecessary.
</I>&gt;<i> 
</I>&gt;<i> Also, here is an artifact of the override options which you may not
</I>&gt;<i> be aware:
</I>&gt;<i> 
</I>&gt;<i> The Expires header coming from YT indicates that the reply is
</I>&gt;<i> cacheable for 6hrs from the time it was generated. That is 21600
</I>&gt;<i> seconds, no less. Your override-expires is actively *reducing* the
</I>&gt;<i> storage time to 10800 seconds (the 'min' field of the pattern
</I>&gt;<i> options).
</I>&gt;<i> 
</I>&gt;<i> Therefore to maximise caching you should *drop* the
</I>&gt;<i> override-expires option on the ytimg pattern.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> NP: override-lastmod is usually also a bad thing to do, but I see
</I>&gt;<i> you are actually hitting THE use-case for which it legitimately
</I>&gt;<i> exist... server emitting incorrect Last-Modified value (1970?
</I>&gt;<i> sure).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________ squid-users mailing
</I>&gt;<i> list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> 
</I>&gt;<i> _______________________________________________ squid-users mailing
</I>&gt;<i> list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUPKLRAAoJELJo5wb/XPRjvSIIAKLTnKZa/Vnde559Z+LsXaCP
I50ewcN6yejWKBQECTPbATwnyyyvnhvM0OIj5KoHDOYbAZQZpoEgzf3ID0VppFKn
PLl/2xe3Frs+fxZJxgbUzvgCxvvmk7O5xd5w4Uuks0Rx3dYMo76DFyamKo5hnGXH
4594zS7tWVwhYfsrtw6WeVRifmiw68NjHGsRPve9v0rKTttUGS6WxF+aHK7ZcKQ0
n+eyDdm5bGv1kHqMkhNvmJ4fBk8LoROChpQnQIwp0lm7IJzvi1XwPOk90a/kll4u
lOYRXIeogv7B1DmTNwxThzAi6FknlMZYx3PGdUSU7QTEEQW5kJ1TCdyB9y7Iebo=
=SfGo
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000252.html">[squid-users] unexplained MISSes
</A></li>
	<LI>Next message (by thread): <A HREF="000269.html">[squid-users] unexplained MISSes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#282">[ date ]</a>
              <a href="thread.html#282">[ thread ]</a>
              <a href="subject.html#282">[ subject ]</a>
              <a href="author.html#282">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
