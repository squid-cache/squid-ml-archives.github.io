<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20http_access%20deny%20for%20dstdomain%20acl%20not%20denying%0A%20access%20to%20url..%20what%20am%20I%20doing%20wrong%3F&In-Reply-To=%3C543E1070.4050100%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000309.html">
   <LINK REL="Next"  HREF="000311.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20http_access%20deny%20for%20dstdomain%20acl%20not%20denying%0A%20access%20to%20url..%20what%20am%20I%20doing%20wrong%3F&In-Reply-To=%3C543E1070.4050100%40treenet.co.nz%3E"
       TITLE="[squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 15 06:13:04 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000309.html">[squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?
</A></li>
        <LI>Next message (by thread): <A HREF="000311.html">[squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#310">[ date ]</a>
              <a href="thread.html#310">[ thread ]</a>
              <a href="subject.html#310">[ subject ]</a>
              <a href="author.html#310">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


And the key difference in these configs is not the ACL contents, but
the ordering in which they are matched.

Mirzas' config starts by telling Squid everything on the LAN/localnet
is allowed. Ok, fine, Squid will do that.

Walters' config will tell Squid a limited set of things to allow, then
some things to deny, then implicitly allow everything else [1][2].
Whichever rule actually matches the FB requests will be applied by
Squid, with a limited set of initial allow/bypass the likelihood that
a deny following will match is higher.


[1] this is not a great situation, because any remote attack which can
figure out a way past your regex ACLs can use the proxy for whatever
they please[2].

[2] I hope you just omitted the localnet ACL checks which should
follow the ones you showed.

Amos



On 15/10/2014 6:56 p.m., Walter H. wrote:
&gt;<i> acl allow_urls url_regex -i &quot;/etc/squid/allowurls-regex-acl.squid&quot;
</I>&gt;<i> (a) acl block_urls url_regex -i
</I>&gt;<i> &quot;/etc/squid/blockurls-regex-acl.squid&quot; (b) acl allow_urlpaths
</I>&gt;<i> urlpath_regex -i &quot;/etc/squid/allowurlpaths-regex-acl.squid&quot; (c) acl
</I>&gt;<i> block_urlpaths urlpath_regex -i 
</I>&gt;<i> &quot;/etc/squid/blockurlpaths-regex-acl.squid&quot; (d) acl
</I>&gt;<i> allow_domains_list dstdomain 
</I>&gt;<i> &quot;/etc/squid/allowdomains-list-acl.squid&quot; (e) acl block_domains_list
</I>&gt;<i> dstdomain &quot;/etc/squid/blockdomains-list-acl.squid&quot; (f) acl
</I>&gt;<i> block_domains_listex dstdomain 
</I>&gt;<i> &quot;/etc/squid/blockdomains-listex-acl.squid&quot; (g) acl
</I>&gt;<i> allow_domains_regex dstdom_regex -i 
</I>&gt;<i> &quot;/etc/squid/allowdomains-regex-acl.squid&quot; (h) acl
</I>&gt;<i> block_domains_regex dstdom_regex -i 
</I>&gt;<i> &quot;/etc/squid/blockdomains-regex-acl.squid&quot; (i) acl block_hosts_list
</I>&gt;<i> dst &quot;/etc/squid/blockhosts-list-acl.squid&quot; (j) deny_info
</I>&gt;<i> ERR_URL_BLOCKED block_urls deny_info ERR_URL_BLOCKED
</I>&gt;<i> block_urlpaths deny_info ERR_DOMAIN_BLOCKED block_domains_list 
</I>&gt;<i> deny_info ERR_DOMAIN_BLOCKED block_domains_listex deny_info
</I>&gt;<i> ERR_DOMAIN_BLOCKED block_domains_regex deny_info ERR_HOST_BLOCKED
</I>&gt;<i> block_hosts_list http_access allow allow_urls http_access allow
</I>&gt;<i> allow_urlpaths http_access allow allow_domains_list http_access
</I>&gt;<i> allow allow_domains_regex http_access deny block_urls http_access
</I>&gt;<i> deny block_urlpaths http_access deny block_domains_list http_access
</I>&gt;<i> deny block_domains_listex http_access deny block_domains_regex 
</I>&gt;<i> http_access deny block_hosts_list
</I>&gt;<i> 
</I>&gt;<i> (a), (b) look like this: 
</I>&gt;<i> &quot;^http:\/\/websupport\.wdc\.com\/sfclickcount.asp\?&quot; (c), (d) look
</I>&gt;<i> like this: &quot;^\/cgi-bin\/&quot; (e), (f), (g) look like this:
</I>&gt;<i> &quot;www.googletagmanager.com&quot; (h), (i) look like this:
</I>&gt;<i> &quot;^banner(s)?[0-9]*\.&quot; (j) looks like this: &quot;85.17.30.143&quot;
</I>&gt;<i> 
</I>&gt;<i> (g) comes from a source like: e.g.
</I>&gt;<i> <A HREF="http://winhelp2002.mvps.org/hosts.htm">http://winhelp2002.mvps.org/hosts.htm</A>
</I>&gt;<i> 
</I>&gt;<i> On 15.10.2014 02:05, Mirza Dedic wrote:
</I>&gt;&gt;<i> Trying to understand what I am doing wrong with my ACLs (yes I've
</I>&gt;&gt;<i> read the ACL guide on squid site.. but still confused).. My
</I>&gt;&gt;<i> client is 172.16.10.101, trying to block access to facebook (and
</I>&gt;&gt;<i> other dstdomain file lists), but it is not working from the
</I>&gt;&gt;<i> client I can still access fb.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Is this because I have this rule below..?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12 http_access allow localnet
</I>&gt;&gt;<i> 
</I>&gt;<i> yes
</I>&gt;<i> 
</I>&gt;&gt;<i> Instead of denying everything access and manually maintaining
</I>&gt;&gt;<i> rules, I want to allow http/https access for everything except
</I>&gt;&gt;<i> explicitly defined ACLs (in this case the facebook acl as a
</I>&gt;&gt;<i> test).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I've tried to set debugging to debug_options ALL,1 33,2 to see
</I>&gt;&gt;<i> more info on ACLs (read on some site this is the debug flags to
</I>&gt;&gt;<i> set) but I don't see any ACL details in my access.log file.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> my squid.conf (for SQUID 3.3.3) file is below..
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal
</I>&gt;&gt;<i> network acl localnet src 172.16.0.0/12  # RFC1918 possible
</I>&gt;&gt;<i> internal network acl localnet src 192.168.0.0/16 # RFC1918
</I>&gt;&gt;<i> possible internal network
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl SSL_ports port 443 8180 8443 563 1494 2598 8531 acl
</I>&gt;&gt;<i> Safe_ports port 80# http acl Safe_ports port 81 # http for
</I>&gt;&gt;<i> Pacific Brokerage acl Safe_ports port 21# ftp acl Safe_ports port
</I>&gt;&gt;<i> 443 563# http acl Safe_ports port 70# gopher acl Safe_ports port
</I>&gt;&gt;<i> 210# wais acl Safe_ports port 280# http-mgmt acl Safe_ports port
</I>&gt;&gt;<i> 488# gss-http acl Safe_ports port 591# filemaker acl Safe_ports
</I>&gt;&gt;<i> port 777# multiling http acl Safe_ports port 8080 8081 8082 8088
</I>&gt;&gt;<i> 8180 acl Safe_ports port 3128 # Squid http server acl Safe_ports
</I>&gt;&gt;<i> port 1494 2598 # ICA - Citrix acl Safe_ports port 7000 8000 #
</I>&gt;&gt;<i> Oracle acl Safe_ports port 9000 # Oracle acl Safe_ports port
</I>&gt;&gt;<i> 8530# WSUS acl Safe_ports port 55905# WSUS acl Safe_ports port
</I>&gt;&gt;<i> 1025-65535# unregistered ports acl CONNECT method CONNECT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access allow localhost manager http_access deny manager 
</I>&gt;&gt;<i> http_access deny !Safe_ports http_access deny CONNECT !SSL_ports 
</I>&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> *acl ads dstdomain &quot;/etc/squid/blacklists/ads/domains&quot;* *acl
</I>&gt;&gt;<i> adult dstdomain &quot;/etc/squid/blacklists/adult/domains&quot;* *acl
</I>&gt;&gt;<i> gambling dstdomain &quot;/etc/squid/blacklists/gambling/domains&quot;* *acl
</I>&gt;&gt;<i> fb dstdomain .facebook.com*
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access allow localnet http_access allow localhost
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> *http_access deny ads adult gambling fb*
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 8080 dns_nameservers 172.16.11.3 172.16.11.2
</I>&gt;&gt;<i> 172.16.11.1 visible_hostname www-proxy
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> hierarchy_stoplist cgi-bin ?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> logformat oppy %ts.%03tu %6tr %&gt;a %&gt;A %Ss/%03&gt;Hs %&lt;st %rm %ru
</I>&gt;&gt;<i> %[un %Sh/%&lt;a %mt access_log daemon:/var/log/squid/access.log
</I>&gt;&gt;<i> oppy cache_store_log daemon:/var/log/squid/store.log cache_log
</I>&gt;&gt;<i> /var/log/squid/cache.log cache_mem 64 MB logfile_rotate 4 
</I>&gt;&gt;<i> debug_options ALL,1 # ACL Debug Options # debug_options ALL,1
</I>&gt;&gt;<i> 33,2 # debug_options ALL,1 33,2 28,9 coredump_dir
</I>&gt;&gt;<i> /var/log/squid/squid
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> shutdown_lifetime 3 seconds dns_v4_first on retry_on_error on 
</I>&gt;&gt;<i> forward_max_tries 25 forward_timeout 30 seconds connect_timeout
</I>&gt;&gt;<i> 30 seconds read_timeout 30 seconds request_timeout 30 seconds 
</I>&gt;&gt;<i> persistent_request_timeout 1 minute
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> cache_dir ufs /var/cache/squid 100 16 256 cache_mgr
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ittechs at domain.com</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> snmp_port 0 icp_port 0 htcp_port 0
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> refresh_pattern ^ftp:144020%10080 refresh_pattern
</I>&gt;&gt;<i> ^gopher:14400%1440 refresh_pattern -i (/cgi-bin/|\?) 00%0 
</I>&gt;&gt;<i> refresh_pattern .020%4320
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________ squid-users
</I>&gt;&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________ squid-users mailing
</I>&gt;<i> list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUPhBwAAoJELJo5wb/XPRjFLsH/3EJAnFmG1ClS+eK4kxViyBK
XzDLC3baYIGThunpiTMnX/rrrG9pi3HAouikeXbnfl+iGIovOrKsHA7oxZUXJbdG
Fs9sdfN8FDbQK8fJePR0TzP0EtbwNWn86LcP3CDt2U9C7yldORtu8jCR72hyvO6H
S1FWh3G6NUzuFLU+7UIxWVBUwMNCkT8knhXpfZ0G8gELFyXgoIJKoZXJob73nV0+
xfLQqJ4alYSvNYmAIdmS+zozgCS/vwDexk9uMJgywE15axSGUKPOgHXpxiTuI3hu
oEDfHW2I7VrGIFd8963LB5sR50HJoZFSkDUkthAFp2Gj+sjsj7+gv1B/DKz79W8=
=2aeX
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000309.html">[squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?
</A></li>
	<LI>Next message (by thread): <A HREF="000311.html">[squid-users] http_access deny for dstdomain acl not denying access to url.. what am I doing wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#310">[ date ]</a>
              <a href="thread.html#310">[ thread ]</a>
              <a href="subject.html#310">[ subject ]</a>
              <a href="author.html#310">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
