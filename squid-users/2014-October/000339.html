<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl-bump doesn't decrypt https traffic - please help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20doesn%27t%20decrypt%20https%20traffic%20-%20please%0A%20help&In-Reply-To=%3C543F9BF1.80300%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000334.html">
   <LINK REL="Next"  HREF="000340.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl-bump doesn't decrypt https traffic - please help</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20doesn%27t%20decrypt%20https%20traffic%20-%20please%0A%20help&In-Reply-To=%3C543F9BF1.80300%40treenet.co.nz%3E"
       TITLE="[squid-users] ssl-bump doesn't decrypt https traffic - please help">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct 16 10:20:33 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000334.html">[squid-users] ssl-bump doesn't decrypt https traffic - please help
</A></li>
        <LI>Next message (by thread): <A HREF="000340.html">[squid-users] ssl-bump doesn't decrypt https traffic - please help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#339">[ date ]</a>
              <a href="thread.html#339">[ thread ]</a>
              <a href="subject.html#339">[ subject ]</a>
              <a href="author.html#339">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 16/10/2014 9:13 p.m., apfelstrudel wrote:
&gt;<i> Hello. I am trying to get ssl-bump to decrypt https traffic
</I>&gt;<i> transparently so that I could filter out adult videos from youtube
</I>&gt;<i> and to globally enforce google safesearch on my network with
</I>&gt;<i> diladele web safety. I also want to run dansguardian to filter
</I>&gt;<i> http. I managed to pass https traffic transparently to squid but
</I>&gt;<i> ssl-bump doesn't decrypt it. In logs I can see the https websites
</I>&gt;<i> but in an encrypted form of website's.ip.address:port
</I>&gt;<i> (45.231.21.56:443 for example) instead of https url (like
</I>&gt;<i> <A HREF="https://youtube.com">https://youtube.com</A>). That means that traffic is still encrypted
</I>&gt;<i> and because of that, diladele can't filter https. The squid is
</I>&gt;<i> installed on an eee pc netbook with fedora 20 installed. This
</I>&gt;<i> machine is also my router and a network gateway. 172.16.34.254 is
</I>&gt;<i> the ip on which the netbook &quot;sees&quot; the internal network, which
</I>&gt;<i> consists of: 1 tp-link router directly connected to the eee. Thas
</I>&gt;<i> router is connected wirelessly (Wi-Fi antenna) to the second
</I>&gt;<i> TP-Link router (bridge) in my house. The bridge router is then
</I>&gt;<i> connected by an ethernet cable to another router to which my
</I>&gt;<i> devices finally (phone, tablet, pc, printer) connect. So in
</I>&gt;<i> summary:  My device (PC, tablet, phone) ----&gt; Router (Netgear)
</I>&gt;<i> ----&gt; TP-Link Bridge Router ------&gt; Router (TP-Link) ----&gt; Network
</I>&gt;<i> gateway/router (eee pc running fedora 20) with squid installed.
</I>&gt;<i> With the current configuration dansguardian works (http), diladele
</I>&gt;<i> web safety works (only http) and the https traffic is passed
</I>&gt;<i> transparently through squid, but not decrypted:
</I>&gt;<i> 
</I>&gt;<i> 172.16.34.253 TCP_MISS/301 848 GET <A HREF="http://pl-pl.facebook.com/">http://pl-pl.facebook.com/</A> -
</I>&gt;<i> HIER_DIRECT/31.13.93.97 text/html 172.16.34.254 TCP_MISS/200 50622
</I>&gt;<i> CONNECT 2.22.52.26:443 - HIER_DIRECT/2.22.52.26 -  &lt;----- this
</I>&gt;<i> should be <A HREF="https://pl-pl.facebook.com">https://pl-pl.facebook.com</A> but ssl-bump doesn't decrypt
</I>&gt;<i> traffic.
</I>&gt;<i> 
</I>
Nope, the log line is correct. It simply states that a tunnel
CONNECT-ion was requested by the client to some server on port 443,
Squid permitted it.

Please read <A HREF="http://tools.ietf.org/html/rfc7230#section-5.3.3">http://tools.ietf.org/html/rfc7230#section-5.3.3</A> for
details of the URL syntax. The surrounding section 5.3.* contain
details of other URL types you may also spot in your logs.

What it demonstrates is that your test client software is explicitly
configured to use Squid as a proxy on port 3125 with no interception
happening (and thus none of the ssl-bump ports being used).

Or, that the client software is configured to use some other proxy
elsewhere which has its explicit proxy port on 80.



&gt;<i> The IP addresses on the beginning of each line are different
</I>&gt;<i> because http requests go from dansguardian internally. The https
</I>&gt;<i> requests go directly from my internal network.
</I>&gt;<i> 
</I>&gt;<i> Here's my squid.conf: acl localnet src 10.0.0.0/8 # RFC1918
</I>&gt;<i> possible internal network acl localnet src 172.16.0.0/12 # RFC1918
</I>&gt;<i> possible internal network acl localnet src 192.168.0.0/16 # RFC1918
</I>&gt;<i> possible internal network acl localnet src fc00::/7 # RFC 4193
</I>&gt;<i> local private network range acl localnet src fe80::/10 # RFC 4291
</I>&gt;<i> link-local (directly plugged) machines acl to_localhost dst
</I>&gt;<i> 127.0.0.1/8
</I>
 NP: to_localhost is pre-defined to be the specific IP addresses which
is dangerous to receive general traffic on. That includes the 127.*
ranges.

&gt;<i> acl SSL_ports port 443 acl Safe_ports port 80 # http acl Safe_ports
</I>&gt;<i> port 21 # ftp acl Safe_ports port 443 # https acl Safe_ports port
</I>&gt;<i> 70 # gopher acl Safe_ports port 210 # wais acl Safe_ports port
</I>&gt;<i> 1025-65535 # unregistered ports acl Safe_ports port 280 #
</I>&gt;<i> http-mgmt acl Safe_ports port 488 # gss-http acl Safe_ports port
</I>&gt;<i> 591 # filemaker acl Safe_ports port 777 # multiling http acl
</I>&gt;<i> CONNECT method CONNECT # Deny requests to certain unsafe ports 
</I>&gt;<i> http_access deny !Safe_ports # Deny CONNECT to other than secure
</I>&gt;<i> SSL ports http_access deny CONNECT !SSL_ports # Only allow cachemgr
</I>&gt;<i> access from localhost http_access allow localhost manager 
</I>&gt;<i> http_access deny manager http_access allow localnet http_access
</I>&gt;<i> allow localhost
</I>
Since DG is operating on the same machine you would do well to:
 a) ensure DG is configured to pass proxy traffic to Squid via 127.0.0.1
 b) configure DG to send X-Forwarded-For header
 c) add the following to squid.conf:

  follow_x_forwarded_for allow localhost
  follow_x_forwarded_for deny all

that will let Squid log the details of clients connecting to DG.


&gt;<i> # And finally deny all other access to this proxy http_access allow
</I>&gt;<i> all
</I>
... pretty funny way to configure &quot;deny all&quot;.

BTW: the clients IP is part of &quot;localnet&quot; definition. So legitimate
traffic should not be getting to that &quot;allow all&quot;. Only remote
(attackers?) will be benefit from that rule.

ALso, all http_access lines after this one are useless garbage. They
will never match.

&gt;<i> http_access allow CONNECT http_access allow to_localhost include
</I>&gt;<i> &quot;/opt/qlproxy/etc/squid/squid.acl&quot; # Squid normally listens to port
</I>&gt;<i> 3128 # Dansguardian's port: http_port 3125
</I>
Just use 3128 for DansGuardian.

The existence of ssl-bump options does not matter for DG output HTTP
traffic going through there.

Whereas, if CONNECT tunnels are being passed to DG (or created by DG
to relay HTTPS traffic) then you need them to be bumped.


&gt;<i> # HTTPS ports, required by diladele web safety: http_port 3126
</I>&gt;<i> intercept
</I>
... this 3126 is not an HTTPS port as documented. It is fine as
configured. Just saying your comment above it is misleading.

&gt;<i> https_port 3127 transparent ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/opt/qlproxy/etc/myca.pem 
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/opt/qlproxy/etc/myca.pem 
</I>&gt;<i> always_direct allow all ssl_bump client-first all
</I>
client-first bumping does not work much anymore. Use server-first instead.

If you are not using the test squid versions for bumping, you need to
upgrade. ssl-bump functionality is part of an arms race between
browsers and websites trying to increase security &amp; privacy and admin
like you trying to break it. Like any arms race the technology changes
fast.

&lt;snip remainder of the config&gt;

Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUP5vxAAoJELJo5wb/XPRjbdgH/Rw/THpi0hMDt9zzyLQCOty/
fm9Ija0r83V8sfTpBzlRj35S4ZpQT2hf4+94OJNIZIueW75nAvMUYfRnvn1r6C6w
j+hXumdo2PxhQ+TQhuqgbSUNpXEm2x93CQETKKf3dlWlDAXxtNBSoKClNpHOHWcZ
FZxPb/fyEBd6s26wt3Q49qbJ1Sg7o0D7aVRh7rPlnC4MS4jmkDamDIgQ7ouW62I6
5eI1sLgYkLpdcM0P/nhNy+JSH3NgayHledrFPYHdBgjn+Co4G72M7XGS4dUfwM4t
mQKg6QtTUPma9mR7iNkXTFIw0lJLrbQz98d9Mt78PwqEmJrcAywhqB9qbU1rQLE=
=UaVG
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000334.html">[squid-users] ssl-bump doesn't decrypt https traffic - please help
</A></li>
	<LI>Next message (by thread): <A HREF="000340.html">[squid-users] ssl-bump doesn't decrypt https traffic - please help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#339">[ date ]</a>
              <a href="thread.html#339">[ thread ]</a>
              <a href="subject.html#339">[ subject ]</a>
              <a href="author.html#339">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
