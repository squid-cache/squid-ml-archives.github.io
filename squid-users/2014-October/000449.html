<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%0A%20Kerberos%20and%20FireFox%20%28Was%3A%20Re%3A%20leaking%20memory%20in%20squid%203.4.8%20and%0A%203.4.7.%29&In-Reply-To=%3CCAHsHsyuHJwb95kCSoh-uJ4MnNM5jrTxHCMxOstGXcQExud-LjQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000448.html">
   <LINK REL="Next"  HREF="000450.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)</H1>
    <B>Carlos Defoe</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%0A%20Kerberos%20and%20FireFox%20%28Was%3A%20Re%3A%20leaking%20memory%20in%20squid%203.4.8%20and%0A%203.4.7.%29&In-Reply-To=%3CCAHsHsyuHJwb95kCSoh-uJ4MnNM5jrTxHCMxOstGXcQExud-LjQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)">carlosdefoe at gmail.com
       </A><BR>
    <I>Thu Oct 23 12:13:41 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000448.html">[squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)
</A></li>
        <LI>Next message (by thread): <A HREF="000450.html">[squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#449">[ date ]</a>
              <a href="thread.html#449">[ thread ]</a>
              <a href="subject.html#449">[ subject ]</a>
              <a href="author.html#449">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I had this kind of 100% CPU problem with auth helpers when upgrading
to squid 3.4. I use negotiate_wrapper, kerberos, ntlm and basic auth.
Then I had to fall back to 3.3 and it is production until now, with
some troubles with broken clients, but with normal cpu usage most of
the time.
Can you try with squid 3.3 and see if that version don't have the same problem?

On Thu, Oct 23, 2014 at 8:41 AM, Victor Sudakov
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sudakov at sibptus.tomsk.ru</A>&gt; wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> Amos Jeffries wrote:
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; And about the basic issues that you were having with
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; performance, does it help to run Kerberos instead of NTLM
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; (it should...)?
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt; I have even moved squid to a new virtual machine (FreeBSD
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt; 9.3-RELEASE under VMWare, 1 GB RAM) and performance still
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt; sucks royally.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I don't know what's happening with squid but this kind of CPU
</I>&gt;&gt;<i> &gt; consumption is just not normal:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, it both is and it isn't.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid *will* use the CPU hardware right up too the 100% limit if it
</I>&gt;&gt;<i> has any need to that is normal.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Needing to for long periods of time is not particularly normal ...
</I>&gt;&gt;<i> except under conditions where the traffic load is too high for the
</I>&gt;&gt;<i> server hardware to cope with.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did see a scenario with behaviour exactly like this at a client some
</I>&gt;&gt;<i> time back. After detailed analysis it turned out that their NTLM
</I>&gt;&gt;<i> helper had been so slow that clients traffic spent more time waiting
</I>&gt;&gt;<i> for next auth action than processing requests.
</I>&gt;<i>
</I>&gt;<i> Looks like my scenario but I am already using a Kerberos helper.
</I>&gt;<i>
</I>&gt;<i> I'll increase the number of virtual CPUs tonight. The OS kernel should
</I>&gt;<i> parallel the authentication children for 2 CPUs, maybe that will make
</I>&gt;<i> a difference.
</I>&gt;<i>
</I>&gt;&gt;<i>  But when they moved to the higher performance Kerberos and a simpler
</I>&gt;&gt;<i> proxy configuration the client traffic throughput increased to a
</I>&gt;&gt;<i> req/sec rate faster than the server could cope (3x previous rate).
</I>&gt;&gt;<i>  It thus was bottlenecked by 100% CPU speed limit rather than by NTLM
</I>&gt;&gt;<i> delays.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, &quot;normal&quot; depends on what exactly is the cause of the behaviour.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What req/sec traffic rates are you seeing on what you consider a
</I>&gt;&gt;<i> &quot;normal&quot; / older proxy compared to this one?
</I>&gt;<i>
</I>&gt;<i> The number of clients and queries is exactly the same as with the
</I>&gt;<i> older proxy. Nothing has changed other than squid version. Besides,
</I>&gt;<i> the older proxy was using the LM auth helper.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, what are the heleprs stats looking like in the cachemgr report?
</I>&gt;<i>
</I>&gt;<i> Here it is:
</I>&gt;<i>
</I>&gt;<i> Sending HTTP request ... done.
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: squid/3.4.8
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Thu, 23 Oct 2014 11:37:16 GMT
</I>&gt;<i> Content-Type: text/plain
</I>&gt;<i> Expires: Thu, 23 Oct 2014 11:37:16 GMT
</I>&gt;<i> Last-Modified: Thu, 23 Oct 2014 11:37:16 GMT
</I>&gt;<i> X-Cache: MISS from proxy.sibptus.transneft.ru
</I>&gt;<i> X-Cache-Lookup: MISS from proxy.sibptus.transneft.ru:3128
</I>&gt;<i> Via: 1.1 proxy.sibptus.transneft.ru (squid/3.4.8)
</I>&gt;<i> Connection: close
</I>&gt;<i>
</I>&gt;<i> Negotiate Authenticator Statistics:
</I>&gt;<i> program: /usr/local/libexec/squid/negotiate_kerberos_auth
</I>&gt;<i> number active: 25 of 100 (0 shutting down)
</I>&gt;<i> requests sent: 51956
</I>&gt;<i> replies received: 51956
</I>&gt;<i> queue length: 0
</I>&gt;<i> avg service time: 1 msec
</I>&gt;<i>
</I>&gt;<i>    ID #      FD     PID  # Requests       # Replies      Flags     Time  Offset Request
</I>&gt;<i>       0       9    9803       32120           32120               0.001       0 (none)
</I>&gt;<i>       0      11    9804        9412            9412               0.011       0 (none)
</I>&gt;<i>       0      13    9805        4477            4477               0.011       0 (none)
</I>&gt;<i>       0      15    9806        2338            2338               0.011       0 (none)
</I>&gt;<i>       0      17    9807        1320            1320               0.009       0 (none)
</I>&gt;<i>       0     380    9809         789             789               0.009       0 (none)
</I>&gt;<i>       0     393    9810         521             521               0.011       0 (none)
</I>&gt;<i>       0     396    9811         332             332               0.025       0 (none)
</I>&gt;<i>       0     398    9812         221             221               0.025       0 (none)
</I>&gt;<i>       0     400    9813         144             144               0.025       0 (none)
</I>&gt;<i>       0     402    9814         100             100               0.024       0 (none)
</I>&gt;<i>       0     404    9815          58              58               1.211       0 (none)
</I>&gt;<i>       0     406    9816          38              38               1.211       0 (none)
</I>&gt;<i>       0     408    9817          29              29               1.211       0 (none)
</I>&gt;<i>       0     410    9818          20              20               1.211       0 (none)
</I>&gt;<i>       0     577    9902          13              13               1.211       0 (none)
</I>&gt;<i>       0     587    9903           8               8               1.211       0 (none)
</I>&gt;<i>       0     651    9904           5               5               1.211       0 (none)
</I>&gt;<i>       0     668    9905           4               4               1.211       0 (none)
</I>&gt;<i>       0     673    9906           3               3               1.211       0 (none)
</I>&gt;<i>       0     677    9907           2               2               3.669       0 (none)
</I>&gt;<i>       0     679    9908           1               1               3.669       0 (none)
</I>&gt;<i>       0     681    9909           1               1               3.669       0 (none)
</I>&gt;<i>       0     684    9910           0               0               0.000       0 (none)
</I>&gt;<i>       0     688    9911           0               0               0.000       0 (none)
</I>&gt;<i>
</I>&gt;<i> Flags key:
</I>&gt;<i>
</I>&gt;<i>    B = BUSY
</I>&gt;<i>    C = CLOSING
</I>&gt;<i>    R = RESERVED
</I>&gt;<i>    S = SHUTDOWN PENDING
</I>&gt;<i>    P = PLACEHOLDER
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> - --
</I>&gt;<i> Victor Sudakov,  VAS4-RIPE, VAS47-RIPN
</I>&gt;<i> sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sudakov at sibptus.tomsk.ru</A>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v1
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBAgAGBQJUSOlbAAoJEA2k8lmbXsY0r7AIAJhEAcUYajdnLa+geOlMblaG
</I>&gt;<i> 8w+EyzWX6H+Sg1qaevBi28rB16qo0aAez4SY+GvTtle3qUnGdU3xpMxOKz+F4LV9
</I>&gt;<i> 8Rz47bV4XfTyB8o4YF7ukFE9u/1CGQP+wk9FKGWZwpANiaE633PyMnEG0ftJYo1i
</I>&gt;<i> dK96bCBMhNjArbwqKGgR1SQgO7KfJhVYspLs8700d/sgV2d8xx7FXoxICLhyG6Xz
</I>&gt;<i> N+yUETFn6el6CUFnM+YGKBXylfzp56KQg92pP/TNYZ9cj7vH4vKDsexmq3VrACTn
</I>&gt;<i> FsF7cz3vQWMaBrsTSLExFzcSm2Gri5WewjeMR9HBzxNBCw24VvbSn0CL7e5sbRw=
</I>&gt;<i> =0Hh1
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000448.html">[squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)
</A></li>
	<LI>Next message (by thread): <A HREF="000450.html">[squid-users] Squid, Kerberos and FireFox (Was: Re: leaking memory in squid 3.4.8 and 3.4.7.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#449">[ date ]</a>
              <a href="thread.html#449">[ thread ]</a>
              <a href="subject.html#449">[ subject ]</a>
              <a href="author.html#449">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
