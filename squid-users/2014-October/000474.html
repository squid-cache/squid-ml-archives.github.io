<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Kerberos Authentication Failing for Windows 7+ with BH gss_accept_sec_context() failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20Authentication%20Failing%20for%20Windows%207%2B%0A%20with%20BH%20gss_accept_sec_context%28%29%20failed&In-Reply-To=%3C5DF2361E-14D1-4C80-B39C-0EAAEBFAB76C%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000473.html">
   <LINK REL="Next"  HREF="000476.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Kerberos Authentication Failing for Windows 7+ with BH gss_accept_sec_context() failed</H1>
    <B>Pedro Lobo</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20Authentication%20Failing%20for%20Windows%207%2B%0A%20with%20BH%20gss_accept_sec_context%28%29%20failed&In-Reply-To=%3C5DF2361E-14D1-4C80-B39C-0EAAEBFAB76C%40gmail.com%3E"
       TITLE="[squid-users] Kerberos Authentication Failing for Windows 7+ with BH gss_accept_sec_context() failed">palobo at gmail.com
       </A><BR>
    <I>Sat Oct 25 09:53:56 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000473.html">[squid-users] Kerberos Authentication Failing for Windows 7+ with BH gss_accept_sec_context() failed
</A></li>
        <LI>Next message (by thread): <A HREF="000476.html">[squid-users] Kerberos Authentication Failing for Windows 7+	with BH gss_accept_sec_context() failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#474">[ date ]</a>
              <a href="thread.html#474">[ thread ]</a>
              <a href="subject.html#474">[ subject ]</a>
              <a href="author.html#474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Dan,

Well now I feel incredibly stupid!!! Just checked and it seems something must've changed the permissions on my keytab file (I did mention it was working at one time). For some odd reason, although squid user and group both owned the key tab file, only user had read permissions. I haven't yet figured out what might have changed those permissions (maybe some troubleshooting I did earlier), but fixing the permissions seems to have sorted the problem.

Thanks everybody for your help. Have a great weekend!

Cheers,
Pedro

Monday I'll do a little more testing with the pilot group, but at least 

On 25 Oct 2014, at 10:41, Dan Charlesworth wrote:

&gt;<i> I was recently receiving this (incredibly vague) error. Turns out my squid user didn&#8217;t have permission to read the keytab.
</I>&gt;<i>
</I>&gt;<i> On Sat, Oct 25, 2014 at 8:37 PM, Pedro Lobo &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">palobo at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Markus,
</I>&gt;&gt;<i> I used msktutil to create the keytab.
</I>&gt;&gt;<i> 	msktutil -c -s HTTP/proxy01tst.fake.net -h proxy01tst.fake.net -k
</I>&gt;&gt;<i> /etc/squid3/PROXY.keytab --computer-name proxy01-tst --upn
</I>&gt;&gt;<i> HTTP/proxy01tst.fake.net --server srv01.fake.net --verbose
</I>&gt;&gt;<i> Output of klist -ekt:
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 proxy01-tst$@FAKE.NET (arcfour-hmac)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 proxy01-tst$@FAKE.NET
</I>&gt;&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 proxy01-tst$@FAKE.NET
</I>&gt;&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy01tst.FAKE.net at FAKE.NET</A>
</I>&gt;&gt;<i> (arcfour-hmac)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy01tst.FAKE.net at FAKE.NET</A>
</I>&gt;&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy01tst.FAKE.net at FAKE.NET</A>
</I>&gt;&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy01tst.FAKE.net at FAKE.NET</A>
</I>&gt;&gt;<i> (arcfour-hmac)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy01tst.FAKE.net at FAKE.NET</A>
</I>&gt;&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;&gt;<i> 	   2 10/24/2014 22:59:50 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy01tst.FAKE.net at FAKE.NET</A>
</I>&gt;&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;&gt;<i> Yep, using MIT Kerberos
</I>&gt;&gt;<i> Thanks in advance for any help.
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i> Pedro
</I>&gt;&gt;<i> On 25 Oct 2014, at 1:26, Markus Moeller wrote:
</I>&gt;&gt;&gt;<i> Hi Pedro,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> How did you create your keytab ?  What does klist &#8211;ekt
</I>&gt;&gt;&gt;<i> &lt;squid.keytab&gt; show ( I assume you use MIT Kerberos) ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Markus
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &quot;Pedro Lobo&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">palobo at gmail.com</A>&gt; wrote in message
</I>&gt;&gt;&gt;<i> news:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">40E1E0E7-50C6-4117-94AA-50B06573430A at gmail.com...</A>
</I>&gt;&gt;&gt;<i> Hi Squid Gurus,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm at my wit's end and in dire need of some squid expertise.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We've got a production environment with a couple of squid 2.7 servers
</I>&gt;&gt;&gt;<i> using NTLM and basic authentication. Recently though, we decided to
</I>&gt;&gt;&gt;<i> upgrade and I'm now setting up squid 3.3 with Kerberos and NTLM
</I>&gt;&gt;&gt;<i> Fallback. I've followed just about every guide I could find and in my
</I>&gt;&gt;&gt;<i> testing environment, things were working great. Now that I've hooked
</I>&gt;&gt;&gt;<i> it up to the main domain, things are awry.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If I use a machine that's not part of the domain, NTLM kicks in and I
</I>&gt;&gt;&gt;<i> can surf the web fine. If I use a Windows XP or Windows Server 2003,
</I>&gt;&gt;&gt;<i> kerberos works just fine, however, if I use a machine Windows 7, 8 or
</I>&gt;&gt;&gt;<i> 2008 server, I keep getting a popup asking me to authenticate and even
</I>&gt;&gt;&gt;<i> then, it's and endless loop until it fails. My cache.log is littered
</I>&gt;&gt;&gt;<i> with:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> negotiate_kerberos_auth.cc(200): pid=1607 :2014/10/24 23:03:01|
</I>&gt;&gt;&gt;<i> negotiate_kerberos_auth: ERROR: gss_accept_sec_context() failed:
</I>&gt;&gt;&gt;<i> Unspecified GSS failure.  Minor code may provide more information.
</I>&gt;&gt;&gt;<i> 2014/10/24 23:03:01| ERROR: Negotiate Authentication validating user.
</I>&gt;&gt;&gt;<i> Error returned 'BH gss_accept_sec_context() failed: Unspecified GSS
</I>&gt;&gt;&gt;<i> failure.  Minor code may provide more information. '
</I>&gt;&gt;&gt;<i> The odd thing, is that this has worked before. Help me Obi Wan...
</I>&gt;&gt;&gt;<i> You're my only hope! :)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Current Setup
</I>&gt;&gt;&gt;<i> Squid 3.3 running on Ubuntu 14.04 server. It's connected to a 2003
</I>&gt;&gt;&gt;<i> server with function level 2000 (I know, we're trying to fase out the
</I>&gt;&gt;&gt;<i> older servers).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> krb5.conf
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [libdefaults]
</I>&gt;&gt;&gt;<i>  default_realm = FAKE.NET
</I>&gt;&gt;&gt;<i>  dns_lookup_kdc = yes
</I>&gt;&gt;&gt;<i>  dns_lookup_realm = yes
</I>&gt;&gt;&gt;<i>  ticket_lifetime = 24h
</I>&gt;&gt;&gt;<i>  default_keytab_name = /etc/squid3/PROXY.keytab
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ; for Windows 2003
</I>&gt;&gt;&gt;<i>  default_tgs_enctypes = rc4-hmac des-cbc-crc des-cbc-md5
</I>&gt;&gt;&gt;<i>  default_tkt_enctypes = rc4-hmac des-cbc-crc des-cbc-md5
</I>&gt;&gt;&gt;<i>  permitted_enctypes = rc4-hmac des-cbc-crc des-cbc-md5
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [realms]
</I>&gt;&gt;&gt;<i>  FAKE.NET = {
</I>&gt;&gt;&gt;<i>          kdc = srv01.fake.net
</I>&gt;&gt;&gt;<i>          kdc = srv02.fake.net
</I>&gt;&gt;&gt;<i>          kdc = srv03.fake.net
</I>&gt;&gt;&gt;<i>          admin_server = srv01.fake.net
</I>&gt;&gt;&gt;<i>          default_domain = fake.net
</I>&gt;&gt;&gt;<i>  }
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [domain_realm]
</I>&gt;&gt;&gt;<i>  .fake.net = FAKE.NET
</I>&gt;&gt;&gt;<i>  fake.net = FAKE.NET
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [logging]
</I>&gt;&gt;&gt;<i> kdc = FILE:/var/log/kdc.log
</I>&gt;&gt;&gt;<i> admin_server = FILE:/var/log/kadmin.log
</I>&gt;&gt;&gt;<i> default = FILE:/var/log/krb5lib.log
</I>&gt;&gt;&gt;<i> squid.conf
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> auth_param negotiate program /usr/lib/squid3/negotiate_kerberos_auth
</I>&gt;&gt;&gt;<i> -d -r -s HTTP/proxy01tst.fake.net
</I>&gt;&gt;&gt;<i> auth_param negotiate children 20 startup=0 idle=1
</I>&gt;&gt;&gt;<i> auth_param negotiate keep_alive off
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;&gt;&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=FAKE.NET
</I>&gt;&gt;&gt;<i> auth_param ntlm children 10
</I>&gt;&gt;&gt;<i> auth_param ntlm keep_alive off
</I>&gt;&gt;&gt;<i> Cheers,
</I>&gt;&gt;&gt;<i> Pedro
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --------------------------------------------------------------------------------
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20141025/aecd9499/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20141025/aecd9499/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 536 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20141025/aecd9499/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20141025/aecd9499/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000473.html">[squid-users] Kerberos Authentication Failing for Windows 7+ with BH gss_accept_sec_context() failed
</A></li>
	<LI>Next message (by thread): <A HREF="000476.html">[squid-users] Kerberos Authentication Failing for Windows 7+	with BH gss_accept_sec_context() failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#474">[ date ]</a>
              <a href="thread.html#474">[ thread ]</a>
              <a href="subject.html#474">[ subject ]</a>
              <a href="author.html#474">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
