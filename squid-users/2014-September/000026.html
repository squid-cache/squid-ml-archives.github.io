<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] leaking memory in squid 3.4.8 and 3.4.7.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20leaking%20memory%20in%20squid%203.4.8%20and%203.4.7.&In-Reply-To=%3C542ABA7F.6010401%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000017.html">
   <LINK REL="Next"  HREF="000029.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] leaking memory in squid 3.4.8 and 3.4.7.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20leaking%20memory%20in%20squid%203.4.8%20and%203.4.7.&In-Reply-To=%3C542ABA7F.6010401%40treenet.co.nz%3E"
       TITLE="[squid-users] leaking memory in squid 3.4.8 and 3.4.7.">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 30 14:13:19 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000017.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
        <LI>Next message (by thread): <A HREF="000029.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26">[ date ]</a>
              <a href="thread.html#26">[ thread ]</a>
              <a href="subject.html#26">[ subject ]</a>
              <a href="author.html#26">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 29/09/2014 10:04 p.m., Steve Hill wrote:
&gt;<i> On 28.09.14 08:34, Eliezer Croitoru wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Also to minimize the leak source try to share more information
</I>&gt;&gt;<i> about your usage. Are you using SMP workers or not? What is the
</I>&gt;&gt;<i> mem and info options in the cache manager page data? Did you
</I>&gt;&gt;<i> tried &quot;cache deny all&quot; acl to minimize the source of the leak?
</I>&gt;<i> 
</I>&gt;<i> For what its worth, I'm also seeing a big memory leak on multiple 
</I>&gt;<i> servers under Squid 3.4.6:
</I>&gt;<i> 
</I>&gt;<i> I have two basic Squid configurations - one of them is a plain
</I>&gt;<i> caching proxy and is _not_ leaking.  The other does no caching, but
</I>&gt;<i> is doing ICAP, external ACLs, SSL bumping and TPROXY and leaks like
</I>&gt;<i> a sieve (several gigabytes a day).
</I>&gt;<i> 
</I>&gt;<i> I _think_ I have narrowed it down to something ICAP related and
</I>&gt;<i> I'm currently valgrinding.  Unfortunately I can't seem to get the
</I>&gt;<i> valgrind instrumentation to work so I'm having to do without (I
</I>&gt;<i> compile --with-valgrind-debug but &quot;squidclient mgr:mem&quot; doesn't
</I>&gt;<i> produce a valgrind report).  I have noticed that there are a _lot_
</I>&gt;<i> of memory errors reported by valgrind though (uninitialised
</I>&gt;<i> memory).
</I>
IIRC the valgrind report is strangely at the end of mgr:info rather
than mgr:mem. It also only lists details if there is *real* leaked memory.

With one small exception all the reports of memory &quot;leaks&quot; in
3.2/3.3/3.4 series are in fact memory over-allocations. The difference
is that over-allocated memory is still referenced by some part of
Squid, so it *does not* show up in a leak finder like valgrind.

For example; most of Victors &quot;leak&quot; was in fact thousands of hung
asynchronous code chains/threads waiting for some network I/O which
could never happen, or if it does not for some very long time. Still
perfectly accessible to Squid via the index of active IDENT lookups
(ie not leaked), but should have been explicitly released already.



&gt;<i> 
</I>&gt;<i> Pretty much all of the leaky memory is showing up as unaccounted: 
</I>&gt;<i> Memory accounted for: Total accounted:        84306 KB   3% memPool
</I>&gt;<i> accounted:      84306 KB   3% memPool unaccounted:   2917158 KB
</I>&gt;<i> 97%
</I>&gt;<i> 
</I>&gt;<i> I am using SMP workers, but turning that off doesn't fix the
</I>&gt;<i> issue.
</I>&gt;<i> 
</I>
If you are using a 64-bit OS then the unaccounted numbers there are
bogus. They are based on mallinfo() lookup results which suffer from
32-bit wrap issues. Use the OS command line to get a memory report
from top or similar instead.

HTH
Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUKrp/AAoJELJo5wb/XPRjfgEH/jMS0eZ0y/rZ4k4nZAprDCmr
+iJrBOR7/7yObQ4FEZlX793qofky760x35VuHvVantzl0oy2CNk2rCmluI85WOTn
i4WYfCvU/1J5ECp9PnodcslldgFM8TXcG5yuXhj2Ro36Prs0RYuXvwC7cuf4ASd9
BuoP/RCbNjlJFwHoHEcXM35OLMU0dshnSZ6YnesLOZODRUz9qNJK/x1Q0xeXAXBC
LjRatV2IEr8O5iV6BqTHQDVHOAUuG/m35dIeruyeg6r3pLngtR8PYxWfLsdTVxfP
UUjN4EoVozpyuIytvB4/PYSKDkFf8AtQbEnznXtnuyaWZR49/E8kpSp4bd61fyg=
=x7XO
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000017.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
	<LI>Next message (by thread): <A HREF="000029.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26">[ date ]</a>
              <a href="thread.html#26">[ thread ]</a>
              <a href="subject.html#26">[ subject ]</a>
              <a href="author.html#26">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
