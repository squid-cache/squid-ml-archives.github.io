<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] leaking memory in squid 3.4.8 and 3.4.7.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20leaking%20memory%20in%20squid%203.4.8%20and%203.4.7.&In-Reply-To=%3C542AC87D.7040806%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000029.html">
   <LINK REL="Next"  HREF="000027.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] leaking memory in squid 3.4.8 and 3.4.7.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20leaking%20memory%20in%20squid%203.4.8%20and%203.4.7.&In-Reply-To=%3C542AC87D.7040806%40treenet.co.nz%3E"
       TITLE="[squid-users] leaking memory in squid 3.4.8 and 3.4.7.">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 30 15:13:01 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000029.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
        <LI>Next message (by thread): <A HREF="000027.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32">[ date ]</a>
              <a href="thread.html#32">[ thread ]</a>
              <a href="subject.html#32">[ subject ]</a>
              <a href="author.html#32">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 1/10/2014 3:59 a.m., Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> On 30.09.14 15:13, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> IIRC the valgrind report is strangely at the end of mgr:info
</I>&gt;&gt;<i> rather than mgr:mem.
</I>&gt;<i> 
</I>&gt;<i> In that case the wiki is wrong. :) Anyway, it doesn't show up on
</I>&gt;<i> either of them for me so I guess you might be right that it isn't
</I>&gt;<i> &quot;real&quot; leaked memory.  (I still thought I'd see some indication
</I>&gt;<i> that it was invoking the valgrind report though, even if it
</I>&gt;<i> contained no data)
</I>&gt;<i> 
</I>&gt;&gt;<i> With one small exception all the reports of memory &quot;leaks&quot; in 
</I>&gt;&gt;<i> 3.2/3.3/3.4 series are in fact memory over-allocations. The
</I>&gt;&gt;<i> difference is that over-allocated memory is still referenced by
</I>&gt;&gt;<i> some part of Squid, so it *does not* show up in a leak finder
</I>&gt;&gt;<i> like valgrind.
</I>&gt;<i> 
</I>&gt;<i> Do you have any advice for finding out what memory is still
</I>&gt;<i> referenced in large amounts?  Since this is unaccounted memory, it
</I>&gt;<i> presumably doesn't appear in mgr:mem (at least, I can't see
</I>&gt;<i> anything obvious in there)?
</I>&gt;<i> 
</I>&gt;<i> I'm trying to figure out if there's a way of convincing valgrind to
</I>&gt;<i> dump info about all the currently allocated memory while the
</I>&gt;<i> program is still running - there would be a lot of legitimate stuff
</I>&gt;<i> in the report, but hopefully a few hundred MB of memory that
</I>&gt;<i> shouldn't be there would stick out like a sore thumb.
</I>
That would be lovely. If you can find it I'd like to know too :-)

A third option is using a ALL,9 cache.log tracer. We have begun
instrumenting class contstructors and destructors with debug
statements to record their lifetimes regardless of whether they are
accounted. A lot are not yet done though.
 The bzr repo contains a debug script at scripts/find-alive.pl which
correlates constructors to destructors in that log. It is useful for
scanning a cache.log while Squid is still running, crashed, or paused
in debugger to show what Jobs/requests etc are currently active.

&gt;<i> 
</I>&gt;&gt;<i> If you are using a 64-bit OS then the unaccounted numbers there
</I>&gt;&gt;<i> are bogus. They are based on mallinfo() lookup results which
</I>&gt;&gt;<i> suffer from 32-bit wrap issues. Use the OS command line to get a
</I>&gt;&gt;<i> memory report from top or similar instead.
</I>&gt;<i> 
</I>&gt;<i> In this case I don't believe the data is bogus.  I have 8 workers,
</I>&gt;<i> which top shows as: 26249 squid     20   0  871m 782m 5348 S  0.7
</I>&gt;<i> 10.0   8:44.81 squid 26245 squid     20   0  732m 644m 5344 S  0.3
</I>&gt;<i> 8.3   8:00.77 squid 26244 squid     20   0  706m 617m 5348 S  1.0
</I>&gt;<i> 7.9   7:42.29 squid 26250 squid     20   0  699m 613m 5348 S  3.6
</I>&gt;<i> 7.9   4:43.49 squid 26246 squid     20   0  699m 612m 5348 S  2.3
</I>&gt;<i> 7.9   6:12.78 squid 26251 squid     20   0  662m 576m 5348 S  0.7
</I>&gt;<i> 7.4   5:45.11 squid 26248 squid     20   0  649m 564m 5348 S  2.3
</I>&gt;<i> 7.2   9:22.91 squid 26247 squid     20   0  603m 518m 5348 S  1.3
</I>&gt;<i> 6.6   4:45.47 squid
</I>&gt;<i> 
</I>&gt;<i> Adding the sizes in the &quot;virt&quot; column gives me 5621MB.  The
</I>&gt;<i> combined RSS is 4926MB.  Process 26250 has just 2MB in swap, the
</I>&gt;<i> rest have no swap at all.  I guess the difference between the RSS
</I>&gt;<i> and Virt totals can probably be almost entirely accounted for by
</I>&gt;<i> the executables.
</I>&gt;<i> 
</I>&gt;<i> mallinfo() says there is about 4897MB in the arena - close enough
</I>&gt;<i> to sum of the RSS that I'm inclined to believe it.  Since no one
</I>&gt;<i> process exceeds 2GB, mallinfo() is probably trustworthy in this
</I>&gt;<i> case.
</I>&gt;<i> 
</I>&gt;<i> The accounted for memory is 440MB - potentially higher than I
</I>&gt;<i> would expect for a Squid with caching disabled, but certainly low
</I>&gt;<i> enough to not be an immediate concern.  But that gives us about
</I>&gt;<i> 4.4GB of memory unaccounted for (by subtracting 440MB from the sum
</I>&gt;<i> of the RSS as shown by top).
</I>&gt;<i> 
</I>&gt;<i> 4.4GB of unaccounted memory after running for just 6 hours is a 
</I>&gt;<i> significant amount, and if left to their own devices Squid
</I>&gt;<i> continues to eat all the memory, leaving the machine thrashing
</I>&gt;<i> swap.
</I>&gt;<i> 
</I>&gt;<i> I count 531 sockets in netstat, so my guess is that it isn't just
</I>&gt;<i> data associated with some open sockets: netstat -apn|egrep
</I>&gt;<i> '26249|26245|26244|26250|26246|26251|26248|26247' -c 531
</I>&gt;<i> 
</I>&gt;<i> 
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUKsh9AAoJELJo5wb/XPRjUnAIALX5yfqY/XOVOcH90OXUree2
sHDJdCB5zlr4EO94qvichnkUm5bCMlg78dkPv8Nwyd43nG4SUUBNt4nh2dvZxYHn
8scHWFA1ZMsbl3k3dQ3eEHNCm+PfugvBo34ZokkMpSR8mLZhh9vqxXDhh9rwj6ez
K8mKnYMbNI/z/DOHhJxcM1NdnbYIyO84EUQfb9RGaJaKb8LDNLt4j6yCEeKa2Z8N
YcnPdA9VZZ3RCpImq0Py8U0kZbCPPBRs+cJAvUIgaAO080ZTrbF+bLZ+dHe4W7hA
JMxXUD4lfEy2HVja2+jfKBcJQwVCDwBK0tcu76bQ64WIrfuIIc/NyIOBwEhPT1I=
=cLQ3
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000029.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
	<LI>Next message (by thread): <A HREF="000027.html">[squid-users] leaking memory in squid 3.4.8 and 3.4.7.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32">[ date ]</a>
              <a href="thread.html#32">[ thread ]</a>
              <a href="subject.html#32">[ subject ]</a>
              <a href="author.html#32">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
