<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] redirect all ports to squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20redirect%20all%20ports%20to%20squid&In-Reply-To=%3C2207092051854955ae5ff49b9e9b25e9%40SIXPR04MB304.apcprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000035.html">
   <LINK REL="Next"  HREF="000039.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] redirect all ports to squid</H1>
    <B>James Harper</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20redirect%20all%20ports%20to%20squid&In-Reply-To=%3C2207092051854955ae5ff49b9e9b25e9%40SIXPR04MB304.apcprd04.prod.outlook.com%3E"
       TITLE="[squid-users] redirect all ports to squid">james at ejbdigital.com.au
       </A><BR>
    <I>Tue Sep 30 21:49:30 UTC 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000035.html">[squid-users] redirect all ports to squid
</A></li>
        <LI>Next message (by thread): <A HREF="000039.html">[squid-users] redirect all ports to squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38">[ date ]</a>
              <a href="thread.html#38">[ thread ]</a>
              <a href="subject.html#38">[ subject ]</a>
              <a href="author.html#38">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> 
</I>&gt;<i> It's possible to redirect all ports to squid ? thru iptables ?
</I>&gt;<i> For example port 25 smtp,143 imap, etc...
</I>&gt;<i> Can squid handle that. In transparent mode.
</I>
Yes. Kind of. You need:
. An appropriate rule in iptables nat table that ends with -j REDIRECT --to-ports 3129 (or whatever port you are listening on for this traffic)
. A https_port definition in squid.conf on that port with ssl-bump and a certificate (certificate doesn't get used unless you are doing actual https but the syntax requires it) and a port name
. an acl attached to the name of the listeners myportname
. an ssl_bump none that matches the traffic you are interested in (all if you aren't doing https interception)

Now that you know you can do it, consider:
. I've asked this question on the list and the response from people who really do know what they are talking about is that squid is not designed as a general tcp proxy and there are probably other solutions that work better
. squid currently doesn't allow a sensible termination of the connection if it isn't allowed, or if there is nothing listening at the other end. Your smtp/pop3/imap/etc application won't like that.
. you have to do authentication out-of-band (eg ident), but that's the same with transparent http anyway

To do this really nicely, squid would need:
. a &quot;tcp_port&quot; instead of &quot;http_port&quot; designed for exactly this sort of thing
. a way to call out to the destination before accepting the connection so that a 'connection refused' could be given if there is nothing listening
. a way to simply drop the connection if it doesn't succeed rather than the default response squid gives
. a way to redirect traffic to a helper (eg SMTP/IMAP/POP3 filter to scan for viruses, etc) (maybe this already exists already via other means?)

So in short it works, but not as well as it could, and you might be better of finding another solution. The main reason I was interested is that Squid already has a very nice acl implementation, and there are already a number of good log analysis tools for it.

James


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000035.html">[squid-users] redirect all ports to squid
</A></li>
	<LI>Next message (by thread): <A HREF="000039.html">[squid-users] redirect all ports to squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38">[ date ]</a>
              <a href="thread.html#38">[ thread ]</a>
              <a href="subject.html#38">[ subject ]</a>
              <a href="author.html#38">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
