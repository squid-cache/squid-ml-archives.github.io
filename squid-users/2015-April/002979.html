<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid with slow client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20slow%20client&In-Reply-To=%3C551B44DB.5040006%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="002980.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid with slow client</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20slow%20client&In-Reply-To=%3C551B44DB.5040006%40treenet.co.nz%3E"
       TITLE="[squid-users] squid with slow client">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr  1 01:07:39 UTC 2015</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="002980.html">[squid-users] ssl_bump problem with tw.bid.yahoo.com in transparent	proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2979">[ date ]</a>
              <a href="thread.html#2979">[ thread ]</a>
              <a href="subject.html#2979">[ subject ]</a>
              <a href="author.html#2979">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/04/2015 11:18 a.m., Hector Chan wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> How does squid behave when it is downloading a 5+GB file with a slow
</I>&gt;<i> client?  I see my client (curl) exited with error code 18 (
</I>&gt;<i> CURLE_PARTIAL_FILE) when downloading a 5+GB file from squid.  It was a
</I>&gt;<i> cache miss, so the file was actually being fetched from the origin server.
</I>&gt;<i> When it is cache hit, I don't see the curl error.
</I>&gt;<i> 
</I>&gt;<i> What I observed was that squid was downloading from the origin server at
</I>&gt;<i> about 750 KB/s, and the client was downloading from squid at about 10 to 50
</I>&gt;<i> KB/s.  The client was geographically far from squid.
</I>
Depends on several factors:

* whether the Content-Length, Transfer-Encoding, or neither is presented
by the server in headers, and

* what the cacheable object size limits are for Squid, and

* how far down into the object the transaction has reached, and

* whether collapsed forwarding is in effect, and

* whether ICAP is being used on it, and

* whether range processing is in effect


Squid has a 64KB server read buffer plus a client write buffer. These
two are limited by the readahead_gap directive if it is smaller. In
general that readahead_gap amount is what Squid has buffered for the
client and will not read from server any more than has been sent to the
client (TCP buffering and I/O latency can make things get a bit higher -
but for Squid purposes that bit is already &quot;sent&quot;).

If the size is known from Content-Length (or a Range offset) Squid can
select the appropriate place to store the data from server (as well as
delivering to the client). It could be cache_mem (RAM), or cache_dir
(disk), or transient / not cached (RAM).

If the content-length header is absent (none or Transfer-Encoding used)
all objects start off assuming they can be cached in memory, which is
fast. Once it gets past maximum_object_size_in_memory Squid pushes it
out to disk (which is quite a bit slower), and if it gets so large it
cant even store there it should get updated to transient memory (fast
again). In transient memory the bits sent to the client(s) are discarded
and only the readahead_gap window is retained in RAM.

If Range processing is in effect the range_offset_limit and
quick_abort_* directives determine whether Squid fetches data from the
server before/after the client requested range. This will be fetched at
full speed of the connection between Squid and server.

If collapsed forwarding is in effect the client which initiated the
first fetch is in control of how much is read and how fast. Other
clients are just tagging along receiving duplicate copies of what Squid
has available.

If ICAP is being used there are ICAP I/O buffers of 64KB also affecting
delivery and readahead_gap covers what has not yet been sent to client.


&gt;<i> 
</I>&gt;<i> I am using the ufs disk cache:
</I>&gt;<i> 
</I>&gt;<i> cache_replacement_policy lru
</I>&gt;<i> minimum_object_size 1 bytes
</I>&gt;<i> cache_dir ufs /data/squid/cache 130000 16 256 max-size=26843545600
</I>
I expect you would be better served with using the min-size= parameter
on the cache_dir line instead of setting the global Squid minimum object
size. HTTP/1.1 commonly has a fair amount of 0-byte messages (30x for
example) that are cacheable and might be stored in cache_mem quite
easily for good performance.

&gt;<i> 
</I>&gt;<i> Here is the error I found in cache.log:
</I>&gt;<i> 
</I>&gt;<i> 2015/03/18 16:53:07.263| client_side_reply.cc(1185) replyStatus:
</I>&gt;<i> clientReplyStatus: transfer is DONE
</I>&gt;<i> 2015/03/18 16:53:07.263| client_side_reply.cc(1201) replyStatus:
</I>&gt;<i> clientReplyStatus: client didn't get all it expected
</I>&gt;<i> 2015/03/18 16:53:07.263| cbdata.cc(510) cbdataReferenceValid:
</I>&gt;<i> cbdataReferenceValid: 0x1707a48
</I>&gt;<i> 2015/03/18 16:53:07.263| client_side.cc(1917) stopSending: sending error
</I>&gt;<i> (local=127.0.0.1:8443 remote=127.0.0.1:54359 FD 8 flags=1):
</I>&gt;<i> STREAM_UNPLANNED_COMPLETE; old receiving erro
</I>&gt;<i> r: none
</I>
I read this as something happened with the server communication that
aborted the delivery. eg the server disconnecting with a TCP RST/abort
instead of a normal connection closure.
Although the trace above only indicates that the client was not finished
receiving when the dosconnect happened, no details on what caused it to
happen.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="002980.html">[squid-users] ssl_bump problem with tw.bid.yahoo.com in transparent	proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2979">[ date ]</a>
              <a href="thread.html#2979">[ thread ]</a>
              <a href="subject.html#2979">[ subject ]</a>
              <a href="author.html#2979">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
