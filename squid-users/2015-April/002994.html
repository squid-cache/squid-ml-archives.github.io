<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] help with tcp_outgoing_address trying to balace	traffic based on username
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20tcp_outgoing_address%20trying%20to%20balace%0A%09traffic%20based%20on%20username&In-Reply-To=%3CCAMZauGoVTsfOMHU2xT_gv5hM68w3BtEjFO8-soNDbB29fvpGXQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003108.html">
   <LINK REL="Next"  HREF="003001.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] help with tcp_outgoing_address trying to balace	traffic based on username</H1>
    <B>Alberto Perez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20tcp_outgoing_address%20trying%20to%20balace%0A%09traffic%20based%20on%20username&In-Reply-To=%3CCAMZauGoVTsfOMHU2xT_gv5hM68w3BtEjFO8-soNDbB29fvpGXQ%40mail.gmail.com%3E"
       TITLE="[squid-users] help with tcp_outgoing_address trying to balace	traffic based on username">alberto2perez at gmail.com
       </A><BR>
    <I>Mon Apr  6 21:01:26 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003108.html">[squid-users] Random SSL bump DB corruption
</A></li>
        <LI>Next message (by thread): <A HREF="003001.html">[squid-users] help with tcp_outgoing_address trying to balace traffic based on username
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2994">[ date ]</a>
              <a href="thread.html#2994">[ thread ]</a>
              <a href="subject.html#2994">[ subject ]</a>
              <a href="author.html#2994">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone
I've been trying to make a traffic load balancing between two links
based on username using tcp_outgoing_address

My squid setup only use authorization with an external_acl which
returns the username based on the client ip.

In my first failure trying to setup this, I found (with the help of
Amos) that tcp_outgoing_address only works with fast acls, so ext_user
acl doesn't work there, Amos recommend me to use NOTE acl for matching
annotations in transactions, at first it looks to work fine but now I
am realizing that only a very small part of the traffic is been going
through the correct link.

I can't find any good documentation related to note acl with some
samples or cases of usage, so I hope some one can correct my config
and/or point me the right direction to achieve this.


Inside my external acl I mark some users like this.
// if username is one of fast users
fwrite(STDOUT, &quot;OK user=$username clt_conn_tag=55\n&quot;);

So theoretically both user and clt_conn_tag values can be matched with
NOTE ACL, as far as i know, I use also clt_conn_tag for testing but it
should be enough with user mark.


#this is fast users declaration tests ive tried with both commented
and uncommented acl.
acl nodo_users ext_user &quot;/etc/squid3/users/nodo_users&quot;
#acl fast_users note clt_conn_tag 55
acl fast_users note user &quot;/etc/squid3/users/nodo_users&quot;

nodo_users is a list of fast users,  the tcp_outgoing_address is used
like this

#fast link for fast users
tcp_outgoing_address xx.xx.xx.01 fast_users
# default slow link
tcp_outgoing_address xx.xx.xx.02

Traffic of fast users is intermitent between the two links and much
more using the slow link than the fast link (opposite than expected).
External ACL TTL is 3 sec, so I asume that the correct balancing is
made only when squid checks de acl and mark the request, but this mark
isnt persistent.

Please, any help with this will be appreciated.

Thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150406/70c9ca0b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150406/70c9ca0b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003108.html">[squid-users] Random SSL bump DB corruption
</A></li>
	<LI>Next message (by thread): <A HREF="003001.html">[squid-users] help with tcp_outgoing_address trying to balace traffic based on username
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2994">[ date ]</a>
              <a href="thread.html#2994">[ thread ]</a>
              <a href="subject.html#2994">[ subject ]</a>
              <a href="author.html#2994">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
