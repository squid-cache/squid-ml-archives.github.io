<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] help with tcp_outgoing_address trying to balace traffic based on username
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20tcp_outgoing_address%20trying%20to%20balace%0A%20traffic%20based%20on%20username&In-Reply-To=%3C5524B3AC.10805%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002994.html">
   <LINK REL="Next"  HREF="002995.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] help with tcp_outgoing_address trying to balace traffic based on username</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20tcp_outgoing_address%20trying%20to%20balace%0A%20traffic%20based%20on%20username&In-Reply-To=%3C5524B3AC.10805%40treenet.co.nz%3E"
       TITLE="[squid-users] help with tcp_outgoing_address trying to balace traffic based on username">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr  8 04:50:52 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002994.html">[squid-users] help with tcp_outgoing_address trying to balace	traffic based on username
</A></li>
        <LI>Next message (by thread): <A HREF="002995.html">[squid-users] hi , i don't receive any info from squid-users at lists.squid-cache.org now
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3001">[ date ]</a>
              <a href="thread.html#3001">[ thread ]</a>
              <a href="subject.html#3001">[ subject ]</a>
              <a href="author.html#3001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/04/2015 9:01 a.m., Alberto Perez wrote:
&gt;<i> Hi everyone
</I>&gt;<i> I've been trying to make a traffic load balancing between two links
</I>&gt;<i> based on username using tcp_outgoing_address
</I>&gt;<i> 
</I>&gt;<i> My squid setup only use authorization with an external_acl which
</I>&gt;<i> returns the username based on the client ip.
</I>&gt;<i> 
</I>&gt;<i> In my first failure trying to setup this, I found (with the help of
</I>&gt;<i> Amos) that tcp_outgoing_address only works with fast acls, so ext_user
</I>&gt;<i> acl doesn't work there, Amos recommend me to use NOTE acl for matching
</I>&gt;<i> annotations in transactions, at first it looks to work fine but now I
</I>&gt;<i> am realizing that only a very small part of the traffic is been going
</I>&gt;<i> through the correct link.
</I>&gt;<i> 
</I>&gt;<i> I can't find any good documentation related to note acl with some
</I>&gt;<i> samples or cases of usage, so I hope some one can correct my config
</I>&gt;<i> and/or point me the right direction to achieve this.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Inside my external acl I mark some users like this.
</I>&gt;<i> // if username is one of fast users
</I>&gt;<i> fwrite(STDOUT, &quot;OK user=$username clt_conn_tag=55\n&quot;);
</I>&gt;<i> 
</I>&gt;<i> So theoretically both user and clt_conn_tag values can be matched with
</I>&gt;<i> NOTE ACL, as far as i know, I use also clt_conn_tag for testing but it
</I>&gt;<i> should be enough with user mark.
</I>
Yes and no...

 The user= is a per-message note. Each message needs to be individually
checked by the helpers ACL to get the note attached.

 The clt_conn_tag= is a per-connection note. Once its assigned all
traffic received[**] on that same persistent client connection will be
tagged with it. Any future checks of the helper will only update the
notes value (if anything).

[**] its not quite as reliable as it seems. Multiple requests may be
parsed off the connection and processed in parallel before the first one
gets tagged. What happens for tagging (or not) on the parallel ones is
not easily determined. Usually they end up tagged by the same logics
that caused the initial mesage tag to be set on the connection, but not
guaranteed.


&gt;<i> 
</I>&gt;<i> #this is fast users declaration tests ive tried with both commented
</I>&gt;<i> and uncommented acl.
</I>&gt;<i> acl nodo_users ext_user &quot;/etc/squid3/users/nodo_users&quot;
</I>&gt;<i> #acl fast_users note clt_conn_tag 55
</I>&gt;<i> acl fast_users note user &quot;/etc/squid3/users/nodo_users&quot;
</I>&gt;<i> 
</I>&gt;<i> nodo_users is a list of fast users,  the tcp_outgoing_address is used
</I>&gt;<i> like this
</I>&gt;<i> 
</I>&gt;<i> #fast link for fast users
</I>&gt;<i> tcp_outgoing_address xx.xx.xx.01 fast_users
</I>&gt;<i> # default slow link
</I>&gt;<i> tcp_outgoing_address xx.xx.xx.02
</I>&gt;<i> 
</I>&gt;<i> Traffic of fast users is intermitent between the two links and much
</I>&gt;<i> more using the slow link than the fast link (opposite than expected).
</I>
The relationship between what network link is used and tcp_outgoing_* is
a lot more fuzzy than most people seems to think. The whole system NAT
infrastructure, routing and other TCP stack mechanisms are sitting in
between the Squid request for binding that IP and what actually leaves
the device. Those systems could be changing the packet in any way, or
even just routing it out the other NIC.


&gt;<i> External ACL TTL is 3 sec, so I asume that the correct balancing is
</I>&gt;<i> made only when squid checks de acl and mark the request, but this mark
</I>&gt;<i> isnt persistent.
</I>
Yes, Squid needs to check the external ACL and mark each request with
the notes. That should happen in the http_access rules though. The
&quot;user=&quot; note is set by both external ACL helper and authentication helpers.
 If you have a mix of those helpers then weird stuff can appear to be
happening depending on order they are checked.
 If you are bypassing the helper check for any traffic weird things can
happen for that traffic.


&gt;<i> 
</I>&gt;<i> Please, any help with this will be appreciated.
</I>
What is your current squid.conf content?

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002994.html">[squid-users] help with tcp_outgoing_address trying to balace	traffic based on username
</A></li>
	<LI>Next message (by thread): <A HREF="002995.html">[squid-users] hi , i don't receive any info from squid-users at lists.squid-cache.org now
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3001">[ date ]</a>
              <a href="thread.html#3001">[ thread ]</a>
              <a href="subject.html#3001">[ subject ]</a>
              <a href="author.html#3001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
