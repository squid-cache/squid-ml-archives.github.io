<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3CCAA8_PU6TaKQqM6AvA%3DO%2BgN-g%2BUZm7JQ7LfO-cCrYi0YbPZOfPw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003004.html">
   <LINK REL="Next"  HREF="003006.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy</H1>
    <B>Jaydeep Kubavat</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3CCAA8_PU6TaKQqM6AvA%3DO%2BgN-g%2BUZm7JQ7LfO-cCrYi0YbPZOfPw%40mail.gmail.com%3E"
       TITLE="[squid-users] Transparent Proxy">jaykbvt at gmail.com
       </A><BR>
    <I>Wed Apr  8 11:50:17 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003004.html">[squid-users] Transparent Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003006.html">[squid-users] Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3005">[ date ]</a>
              <a href="thread.html#3005">[ thread ]</a>
              <a href="subject.html#3005">[ subject ]</a>
              <a href="author.html#3005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

As suggested by Amos...I've configured squid box with bellow mentioned
config.

I followed this doc
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>

1. Configured iptables as:

Table: filter
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
num  target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination

Table: mangle
Chain PREROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp
dpt:3129

Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
num  target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source               destination

Table: nat
Chain PREROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    ACCEPT     tcp  --  10.58.200.33         0.0.0.0/0           tcp
dpt:80
2    DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp
dpt:80 to:10.58.200.33:3129

Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination


2. squid with http_port 3129 intercept

3. PCAP result

&quot;3&quot;,&quot;1.539609&quot;,&quot;10.210.83.247&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;28754&#8594;80 [SYN]
Seq=0 Win=8192 Len=0 MSS=1360 WS=256 SACK_PERM=1&quot;

&quot;4&quot;,&quot;1.539680&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;80&#8594;28754 [SYN,
ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460 SACK_PERM=1 WS=64&quot;

&quot;19&quot;,&quot;2.717863&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
SACK_PERM=1 WS=64&quot;

&quot;31&quot;,&quot;7.613768&quot;,&quot;10.210.83.247&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;64&quot;,&quot;[TCP Spurious
Retransmission] 28754&#8594;80 [SYN] Seq=0 Win=8192 Len=0 MSS=1360 SACK_PERM=1&quot;

&quot;32&quot;,&quot;7.613835&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
SACK_PERM=1 WS=64&quot;

&quot;43&quot;,&quot;8.917825&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
SACK_PERM=1 WS=64&quot;

&quot;167&quot;,&quot;20.917840&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
SACK_PERM=1 WS=64&quot;

&quot;485&quot;,&quot;44.917837&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
SACK_PERM=1 WS=64&quot;

&quot;962&quot;,&quot;93.117870&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
SACK_PERM=1 WS=64&quot;

-- 
Thanks &amp; Regards
Jaykbvt

On Wed, Apr 8, 2015 at 2:50 PM, Jaydeep Kubavat &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jaykbvt at gmail.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I've configured a transparent squid proxy on a centos 6.6 with single NIC.
</I>&gt;<i>
</I>&gt;<i> There is Cisco ISG in between with L4 redirection on www traffic.
</I>&gt;<i>
</I>&gt;<i> The requests are coming on port 80 from client and ISG forwards that to
</I>&gt;<i> port 80 on my squid server.
</I>&gt;<i>
</I>&gt;<i> So there is no iptables configured on squid server.
</I>&gt;<i>
</I>&gt;<i> Client requests are not reaching upto my squid instance.
</I>&gt;<i>
</I>&gt;<i> I'm getting the following in pcap on squid box.
</I>&gt;<i>
</I>&gt;<i> =========================
</I>&gt;<i>
</I>&gt;<i> &quot;129&quot;,&quot;79.114808&quot;,&quot;10.210.83.246&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;39546&#8594;80
</I>&gt;<i> [SYN] Seq=0 Win=14600 Len=0 MSS=1360 SACK_PERM=1 TSval=2686675 TSecr=0
</I>&gt;<i> WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;130&quot;,&quot;79.114946&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;80&#8594;39546
</I>&gt;<i> [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460 SACK_PERM=1 TSval=509402603
</I>&gt;<i> TSecr=2686675 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;145&quot;,&quot;82.115674&quot;,&quot;10.210.83.246&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP Spurious
</I>&gt;<i> Retransmission] 39546&#8594;80 [SYN] Seq=0 Win=14600 Len=0 MSS=1360 SACK_PERM=1
</I>&gt;<i> TSval=2686976 TSecr=0 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;146&quot;,&quot;82.115748&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 TSval=509405604 TSecr=2686675 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;151&quot;,&quot;83.113859&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 TSval=509406603 TSecr=2686675 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;165&quot;,&quot;88.145376&quot;,&quot;10.210.83.246&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP Spurious
</I>&gt;<i> Retransmission] 39546&#8594;80 [SYN] Seq=0 Win=14600 Len=0 MSS=1360 SACK_PERM=1
</I>&gt;<i> TSval=2687578 TSecr=0 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;166&quot;,&quot;88.145450&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 TSval=509411634 TSecr=2686675 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;176&quot;,&quot;89.113837&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 TSval=509412603 TSecr=2686675 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> &quot;285&quot;,&quot;101.113833&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 TSval=509424603 TSecr=2686675 WS=64&quot;
</I>&gt;<i>
</I>&gt;<i> =========================
</I>&gt;<i>
</I>&gt;<i> my squid is configured default, only
</I>&gt;<i>
</I>&gt;<i> http_port 3130
</I>&gt;<i> http_port 80 intercept
</I>&gt;<i>
</I>&gt;<i> are changed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Thanks &amp; Regards
</I>&gt;<i> Jaykbvt
</I>&gt;<i>
</I>


-- 
Thanks &amp; Regards
Jaykbvt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150408/3f59f6d4/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150408/3f59f6d4/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003004.html">[squid-users] Transparent Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003006.html">[squid-users] Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3005">[ date ]</a>
              <a href="thread.html#3005">[ thread ]</a>
              <a href="subject.html#3005">[ subject ]</a>
              <a href="author.html#3005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
