<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3C1054110223.45555.1428495978562.JavaMail.open-xchange%40oxbaltgw06.schlund.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003005.html">
   <LINK REL="Next"  HREF="003007.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy</H1>
    <B>alex at imaginers.org</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3C1054110223.45555.1428495978562.JavaMail.open-xchange%40oxbaltgw06.schlund.de%3E"
       TITLE="[squid-users] Transparent Proxy">alex at imaginers.org
       </A><BR>
    <I>Wed Apr  8 12:26:18 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003005.html">[squid-users] Transparent Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003007.html">[squid-users] NTLM authentication problems with HTTP 1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3006">[ date ]</a>
              <a href="thread.html#3006">[ thread ]</a>
              <a href="subject.html#3006">[ subject ]</a>
              <a href="author.html#3006">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
first of all what error do you get at client side? Timeout? Blank Page?
I'm also running squid in an ISG setup, my squid version is Squid Cache: Version
3.1.10 on Centos 6.5
Few things to check:
1) please ensure the iptables-rules are hit correctly by issuing .f.e:
iptables -t mangle -vnL
 
2)if you see packets please make sure you do not have a redirect-loop, run squid
in debug mode or enable logging.
an example error can be found here:
<A HREF="http://www.squid-cache.org/mail-archive/squid-users/201004/0538.html">http://www.squid-cache.org/mail-archive/squid-users/201004/0538.html</A>
 
3) it's enough to configure port redirection once, you can do it with iptables
on the squid box (as you did below) or directly at the ISG, if you have defined
a server Pool it will look like that (probably ;))
redirect server-group REDIRECT_SERVERS
 server ip xx.xx.xx.xx port 80
for iptables-redirect
or
server ip xx.xx.xx.xx port 3129
for isg redirect
 
4) All problems I had with that setup basically were router configuration
errors. If L4 redirect does not work did you try next-hop rerouting without
altering the ports?
In a Cisco ISG setup make sure the squid box uses the ISG for the return traffic
and can't reach the clients directly, also make sure you are capturing the right
traffic and not blocking the return packets ect.
 
HTH,
Alex
 
 

&gt;<i> Jaydeep Kubavat &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jaykbvt at gmail.com</A>&gt; hat am 8. April 2015 um 13:50 geschrieben:
</I>&gt;<i> 
</I>&gt;<i>  Hi,
</I>&gt;<i>   
</I>&gt;<i>  As suggested by Amos...I've configured squid box with bellow mentioned
</I>&gt;<i> config.
</I>&gt;<i>   
</I>&gt;<i>  I followed this doc
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>
</I>&gt;<i>   
</I>&gt;<i>  1. Configured iptables as:
</I>&gt;<i>   
</I>&gt;<i>  Table: filter
</I>&gt;<i>  Chain INPUT (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Chain FORWARD (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Chain OUTPUT (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Table: mangle
</I>&gt;<i>  Chain PREROUTING (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>  1 DROP tcp --&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt;&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt; tcp dpt:3129
</I>&gt;<i>   
</I>&gt;<i>  Chain INPUT (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Chain FORWARD (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Chain OUTPUT (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Chain POSTROUTING (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>  Table: nat
</I>&gt;<i>  Chain PREROUTING (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>  1 ACCEPT tcp -- 10.58.200.33&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt; tcp dpt:80
</I>&gt;<i>  2 DNAT tcp --&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt;&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt; tcp dpt:80
</I>&gt;<i> to:&lt;<A HREF="http://10.58.200.33:3129">http://10.58.200.33:3129</A>&gt;
</I>&gt;<i>   
</I>&gt;<i>  Chain POSTROUTING (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>  1 MASQUERADE all --&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt;&lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt;
</I>&gt;<i>   
</I>&gt;<i>  Chain OUTPUT (policy ACCEPT)
</I>&gt;<i>  num target prot opt source destination
</I>&gt;<i>   
</I>&gt;<i>   
</I>&gt;<i>  2. squid with http_port 3129 intercept
</I>&gt;<i>   
</I>&gt;<i>  3. PCAP result
</I>&gt;<i>   
</I>&gt;<i>  &quot;3&quot;,&quot;1.539609&quot;,&quot;10.210.83.247&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;28754&#8594;80 [SYN]
</I>&gt;<i> Seq=0 Win=8192 Len=0 MSS=1360 WS=256 SACK_PERM=1&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;4&quot;,&quot;1.539680&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;80&#8594;28754 [SYN, ACK]
</I>&gt;<i> Seq=0 Ack=1 Win=14600 Len=0 MSS=1460 SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;19&quot;,&quot;2.717863&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;31&quot;,&quot;7.613768&quot;,&quot;10.210.83.247&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;64&quot;,&quot;[TCP Spurious
</I>&gt;<i> Retransmission] 28754&#8594;80 [SYN] Seq=0 Win=8192 Len=0 MSS=1360 SACK_PERM=1&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;32&quot;,&quot;7.613835&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;43&quot;,&quot;8.917825&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;167&quot;,&quot;20.917840&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;485&quot;,&quot;44.917837&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  &quot;962&quot;,&quot;93.117870&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.247&quot;,&quot;TCP&quot;,&quot;68&quot;,&quot;[TCP
</I>&gt;<i> Retransmission] 80&#8594;28754 [SYN, ACK] Seq=0 Ack=1 Win=14600 Len=0 MSS=1460
</I>&gt;<i> SACK_PERM=1 WS=64&quot;
</I>&gt;<i>   
</I>&gt;<i>  --
</I>&gt;<i>  Thanks &amp; Regards
</I>&gt;<i>  Jaykbvt
</I>&gt;<i> 
</I>&gt;<i>  On Wed, Apr 8, 2015 at 2:50 PM, Jaydeep Kubavat &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jaykbvt at gmail.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jaykbvt at gmail.com</A>&gt; &gt; wrote:
</I>&gt;<i>    &gt; &gt;    Hi,
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    I've configured a transparent squid proxy on a centos 6.6 with single
</I>&gt;<i> &gt; NIC.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;    There is Cisco ISG in between with L4 redirection on www traffic.
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    The requests are coming on port 80 from client and ISG forwards that to
</I>&gt;<i> &gt; port 80 on my squid server.
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    So there is no iptables configured on squid server.
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    Client requests are not reaching upto my squid instance.
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    I'm getting the following in pcap on squid box.
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    =========================
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;129&quot;,&quot;79.114808&quot;,&quot;10.210.83.246&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;39546&#8594;80
</I>&gt;<i> &gt; [SYN] Seq=0 Win=14600 Len=0 MSS=1360 SACK_PERM=1 TSval=2686675 TSecr=0
</I>&gt;<i> &gt; WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;130&quot;,&quot;79.114946&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;80&#8594;39546
</I>&gt;<i> &gt; [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460 SACK_PERM=1 TSval=509402603
</I>&gt;<i> &gt; TSecr=2686675 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;145&quot;,&quot;82.115674&quot;,&quot;10.210.83.246&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Spurious Retransmission] 39546&#8594;80 [SYN] Seq=0 Win=14600 Len=0 MSS=1360
</I>&gt;<i> &gt; SACK_PERM=1 TSval=2686976 TSecr=0 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;146&quot;,&quot;82.115748&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> &gt; SACK_PERM=1 TSval=509405604 TSecr=2686675 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;151&quot;,&quot;83.113859&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> &gt; SACK_PERM=1 TSval=509406603 TSecr=2686675 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;165&quot;,&quot;88.145376&quot;,&quot;10.210.83.246&quot;,&quot;10.58.200.33&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Spurious Retransmission] 39546&#8594;80 [SYN] Seq=0 Win=14600 Len=0 MSS=1360
</I>&gt;<i> &gt; SACK_PERM=1 TSval=2687578 TSecr=0 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;166&quot;,&quot;88.145450&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> &gt; SACK_PERM=1 TSval=509411634 TSecr=2686675 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;176&quot;,&quot;89.113837&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> &gt; SACK_PERM=1 TSval=509412603 TSecr=2686675 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    &quot;285&quot;,&quot;101.113833&quot;,&quot;10.58.200.33&quot;,&quot;10.210.83.246&quot;,&quot;TCP&quot;,&quot;76&quot;,&quot;[TCP
</I>&gt;<i> &gt; Retransmission] 80&#8594;39546 [SYN, ACK] Seq=0 Ack=1 Win=14480 Len=0 MSS=1460
</I>&gt;<i> &gt; SACK_PERM=1 TSval=509424603 TSecr=2686675 WS=64&quot;
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    =========================
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    my squid is configured default, only
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    http_port 3130
</I>&gt;<i> &gt;    http_port 80 intercept
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    are changed.
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;     
</I>&gt;<i> &gt;    --
</I>&gt;<i> &gt;    Thanks &amp; Regards
</I>&gt;<i> &gt;    Jaykbvt
</I>&gt;<i> &gt;  &gt; 
</I>&gt;<i> 
</I>&gt;<i>   
</I>&gt;<i>  --
</I>&gt;<i>  Thanks &amp; Regards
</I>&gt;<i>  Jaykbvt
</I>&gt;<i>  _______________________________________________
</I>&gt;<i>  squid-users mailing list
</I>&gt;<i>  <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>  <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150408/c9eae1be/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150408/c9eae1be/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003005.html">[squid-users] Transparent Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003007.html">[squid-users] NTLM authentication problems with HTTP 1.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3006">[ date ]</a>
              <a href="thread.html#3006">[ thread ]</a>
              <a href="subject.html#3006">[ subject ]</a>
              <a href="author.html#3006">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
