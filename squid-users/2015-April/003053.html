<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.3%20can%27t%20get%20peek%20and%20splice%20to%20not%20bump%0A%20certain%20sites&In-Reply-To=%3CCAGUJm7bWQq0ttRbk4jesL-PLnGuDxfVeeoC2dv6ZjzbD%2BCx9JA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003052.html">
   <LINK REL="Next"  HREF="003054.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites</H1>
    <B>Nathan Hoad</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.3%20can%27t%20get%20peek%20and%20splice%20to%20not%20bump%0A%20certain%20sites&In-Reply-To=%3CCAGUJm7bWQq0ttRbk4jesL-PLnGuDxfVeeoC2dv6ZjzbD%2BCx9JA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites">nathan at getoffmalawn.com
       </A><BR>
    <I>Mon Apr 13 00:25:28 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003052.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump	certain sites
</A></li>
        <LI>Next message (by thread): <A HREF="003054.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3053">[ date ]</a>
              <a href="thread.html#3053">[ thread ]</a>
              <a href="subject.html#3053">[ subject ]</a>
              <a href="author.html#3053">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Stan,

For peek and splice, you need to decide based on the SNI name, not the
domain name, which for 3.5 means you need to use an external ACL
helper that processes %ssl::&gt;sni. For 4.0 there will be a server_name
ACL you can use instead.

On top of that, you also need to make sure this external ACL helper
runs at the correct &quot;bump step&quot;, with the at_step ACL, e.g...

external_acl_type sni ttl=30 concurrency=X children-max=Y
children-startup=Z %ssl::&gt;sni /path/to/your/helper

acl sni_exclusions external sni
acl tcp_level at_step SslBump1
acl client_hello_peeked at_step SslBump2

ssl_bump peek tcp_level all
ssl_bump splice client_hello_peeked sni_exclusions
ssl_bump bump all

Hope that helps,

Nathan.

On 13 April 2015 at 04:12, Stanford Prescott &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">stan.prescott at gmail.com</A>&gt; wrote:
&gt;<i> I would like to give my users the ability to &quot;not bump&quot; certain sites. I
</I>&gt;<i> tried to use the examples given on the SSLPeekandSplice wiki page but can't
</I>&gt;<i> get it to work.
</I>&gt;<i>
</I>&gt;<i> This is a snippet of my squid.conf file.
</I>&gt;<i>
</I>&gt;<i> https_port 192.168.10.1:808 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem
</I>&gt;<i>
</I>&gt;<i> http_port 192.168.20.1:800 intercept
</I>&gt;<i> https_port 192.168.20.1:808 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem
</I>&gt;<i>
</I>&gt;<i> http_port 127.0.0.1:800 intercept
</I>&gt;<i>
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> sslproxy_session_cache_size 4 MB
</I>&gt;<i>
</I>&gt;<i> acl serverIsBank dstdomain wellsfargo.com
</I>&gt;<i>
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i>
</I>&gt;<i> ssl_bump none localhostgreen
</I>&gt;<i> ssl_bump none localhostpurple
</I>&gt;<i>
</I>&gt;<i> ssl_bump splice serverIsBank
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> sslcrtd_program /var/smoothwall/mods/proxy/libexec/ssl_crtd -s
</I>&gt;<i> /var/smoothwall/mods/proxy/lib/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> When I start squid I don't get any error messages and all pages, http and
</I>&gt;<i> https, load properly. The problem is, using the example above, the
</I>&gt;<i> <A HREF="https://www.wellsfargo.com">https://www.wellsfargo.com</A> website is still getting bumped, evidenced by the
</I>&gt;<i> appearance of the ssl website in the web proxy access logs. When I don't
</I>&gt;<i> have ssl_bump enabled then no https websites appear in the access logs, as
</I>&gt;<i> it should be. But, enabling ssl_bump and peek and splice, web sites that I
</I>&gt;<i> am trying not to bump still seem to be getting bumped.
</I>&gt;<i>
</I>&gt;<i> Any suggestions on how to properly &quot;not bump&quot; certain websites.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Stan
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003052.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump	certain sites
</A></li>
	<LI>Next message (by thread): <A HREF="003054.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3053">[ date ]</a>
              <a href="thread.html#3053">[ thread ]</a>
              <a href="subject.html#3053">[ subject ]</a>
              <a href="author.html#3053">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
