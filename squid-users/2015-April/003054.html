<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.3%20can%27t%20get%20peek%20and%20splice%20to%20not%20bump%0A%20certain%20sites&In-Reply-To=%3CCAGUJm7aCWmacrsufrj9aKw%2BLe%2BkF50GEtz2XB9tUbVNJqBW6cw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003053.html">
   <LINK REL="Next"  HREF="003055.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites</H1>
    <B>Nathan Hoad</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.3%20can%27t%20get%20peek%20and%20splice%20to%20not%20bump%0A%20certain%20sites&In-Reply-To=%3CCAGUJm7aCWmacrsufrj9aKw%2BLe%2BkF50GEtz2XB9tUbVNJqBW6cw%40mail.gmail.com%3E"
       TITLE="[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites">nathan at getoffmalawn.com
       </A><BR>
    <I>Mon Apr 13 02:37:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003053.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
        <LI>Next message (by thread): <A HREF="003055.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3054">[ date ]</a>
              <a href="thread.html#3054">[ thread ]</a>
              <a href="subject.html#3054">[ subject ]</a>
              <a href="author.html#3054">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Stan,

So one of the things that peek and splice added was support for the
Server Name Indication SSL extension, which let's Squid make bumping
decisions more accurately based on the hostname, rather than the IP
address. Prior to this, bumping on only the IP address caused issues
for virtual hosting and such.

As for a good write-up, this is about the best you can get, which
covers the protocol itself:
<A HREF="http://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.29">http://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.29</A>

Essentially external ACLs are processes that Squid will write
&quot;requests&quot; to, which are line-based and configured according to the
format specifiers in your external_acl_type directive. The helper
process should read the request and decide if it's a &quot;match&quot;, then
write back to Squid, which Squid will take action on. All
communication is over standard input/output.

Writing external ACLs is usually quite specialised to the situation,
so it's difficult to find concrete examples that will do what you
want. Using the configuration I mentioned earlier, you could write a
simple helper like so (this one is in Python):

import sys

line = sys.stdin.read()

# run loop until an empty read, which indicates the process should shut down.
while line:
    concurrency_id, sni = line.split()

    if sni == 'wellsfargo.com':
        sys.stdout.write('%s OK\n' % concurrency_id)
    else:
        sys.stdout.write('%s ERR\n' % concurrency_id)

    line = sys.stdin.read()

So when Squid sends a request to the helper process, if the servername
is for 'wellsfargo.com', it will be considered a match, i.e. it will
not be bumped, else it won't match, so it will be bumped later in the
SSL bump process.

If you need clarification on anything, feel free to ask! This is quite
a bit of information to absorb I know :)

Hope that helps,

Nathan.

On 13 April 2015 at 12:01, Stanford Prescott &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">stan.prescott at gmail.com</A>&gt; wrote:
&gt;<i> Thanks for your response, Nathan. I'm sure what you suggest would be very
</I>&gt;<i> helpful, if I knew anything about ACL helpers and how to use them to not
</I>&gt;<i> bump certain sites. I'm thinking the sni is what is actually used to
</I>&gt;<i> identify the sites to not bump?
</I>&gt;<i>
</I>&gt;<i> Is there a good write-up somewhere of how to create these ACL helpers and
</I>&gt;<i> how to use them?
</I>&gt;<i>
</I>&gt;<i> On Sun, Apr 12, 2015 at 8:25 PM, Nathan Hoad &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nathan at getoffmalawn.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Stan,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For peek and splice, you need to decide based on the SNI name, not the
</I>&gt;&gt;<i> domain name, which for 3.5 means you need to use an external ACL
</I>&gt;&gt;<i> helper that processes %ssl::&gt;sni. For 4.0 there will be a server_name
</I>&gt;&gt;<i> ACL you can use instead.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On top of that, you also need to make sure this external ACL helper
</I>&gt;&gt;<i> runs at the correct &quot;bump step&quot;, with the at_step ACL, e.g...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> external_acl_type sni ttl=30 concurrency=X children-max=Y
</I>&gt;&gt;<i> children-startup=Z %ssl::&gt;sni /path/to/your/helper
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl sni_exclusions external sni
</I>&gt;&gt;<i> acl tcp_level at_step SslBump1
</I>&gt;&gt;<i> acl client_hello_peeked at_step SslBump2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek tcp_level all
</I>&gt;&gt;<i> ssl_bump splice client_hello_peeked sni_exclusions
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hope that helps,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Nathan.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 13 April 2015 at 04:12, Stanford Prescott &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">stan.prescott at gmail.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; I would like to give my users the ability to &quot;not bump&quot; certain sites. I
</I>&gt;&gt;<i> &gt; tried to use the examples given on the SSLPeekandSplice wiki page but
</I>&gt;&gt;<i> &gt; can't
</I>&gt;&gt;<i> &gt; get it to work.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; This is a snippet of my squid.conf file.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; https_port 192.168.10.1:808 intercept ssl-bump
</I>&gt;&gt;<i> &gt; generate-host-certificates=on
</I>&gt;&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt; cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; http_port 192.168.20.1:800 intercept
</I>&gt;&gt;<i> &gt; https_port 192.168.20.1:808 intercept ssl-bump
</I>&gt;&gt;<i> &gt; generate-host-certificates=on
</I>&gt;&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt; cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; http_port 127.0.0.1:800 intercept
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; sslproxy_cert_error allow all
</I>&gt;&gt;<i> &gt; sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;<i> &gt; sslproxy_session_cache_size 4 MB
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; acl serverIsBank dstdomain wellsfargo.com
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump server-first all
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump none localhostgreen
</I>&gt;&gt;<i> &gt; ssl_bump none localhostpurple
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump splice serverIsBank
</I>&gt;&gt;<i> &gt; ssl_bump peek all
</I>&gt;&gt;<i> &gt; ssl_bump bump all
</I>&gt;&gt;<i> &gt; sslcrtd_program /var/smoothwall/mods/proxy/libexec/ssl_crtd -s
</I>&gt;&gt;<i> &gt; /var/smoothwall/mods/proxy/lib/ssl_db -M 4MB
</I>&gt;&gt;<i> &gt; sslcrtd_children 5
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; When I start squid I don't get any error messages and all pages, http
</I>&gt;&gt;<i> &gt; and
</I>&gt;&gt;<i> &gt; https, load properly. The problem is, using the example above, the
</I>&gt;&gt;<i> &gt; <A HREF="https://www.wellsfargo.com">https://www.wellsfargo.com</A> website is still getting bumped, evidenced by
</I>&gt;&gt;<i> &gt; the
</I>&gt;&gt;<i> &gt; appearance of the ssl website in the web proxy access logs. When I don't
</I>&gt;&gt;<i> &gt; have ssl_bump enabled then no https websites appear in the access logs,
</I>&gt;&gt;<i> &gt; as
</I>&gt;&gt;<i> &gt; it should be. But, enabling ssl_bump and peek and splice, web sites that
</I>&gt;&gt;<i> &gt; I
</I>&gt;&gt;<i> &gt; am trying not to bump still seem to be getting bumped.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Any suggestions on how to properly &quot;not bump&quot; certain websites.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Thanks,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Stan
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; squid-users mailing list
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003053.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
	<LI>Next message (by thread): <A HREF="003055.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3054">[ date ]</a>
              <a href="thread.html#3054">[ thread ]</a>
              <a href="subject.html#3054">[ subject ]</a>
              <a href="author.html#3054">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
