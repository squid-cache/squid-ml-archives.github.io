<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] does http_port sssl-bump work	require-proxy-header?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20does%20http_port%20sssl-bump%20work%0A%09require-proxy-header%3F&In-Reply-To=%3CCAMjA_B%3DKXV7Qe%2BwB2wkoyyXqjrs9q_DsCAjRc7Rpfy%2BUcg9_Cw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003074.html">
   <LINK REL="Next"  HREF="003086.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] does http_port sssl-bump work	require-proxy-header?</H1>
    <B>Yuhua Wu</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20does%20http_port%20sssl-bump%20work%0A%09require-proxy-header%3F&In-Reply-To=%3CCAMjA_B%3DKXV7Qe%2BwB2wkoyyXqjrs9q_DsCAjRc7Rpfy%2BUcg9_Cw%40mail.gmail.com%3E"
       TITLE="[squid-users] does http_port sssl-bump work	require-proxy-header?">ywu at bitglass.com
       </A><BR>
    <I>Tue Apr 14 22:14:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003074.html">[squid-users] does http_port sssl-bump work	require-proxy-header?
</A></li>
        <LI>Next message (by thread): <A HREF="003086.html">[squid-users] does http_port sssl-bump work	require-proxy-header?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3083">[ date ]</a>
              <a href="thread.html#3083">[ thread ]</a>
              <a href="subject.html#3083">[ subject ]</a>
              <a href="author.html#3083">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I found out what is wrong, but I am not familar to squid code, so I post
here to see if someone can show me the next step:

The problem is at this part of code:
void
ClientHttpRequest::sslBumpStart()
{
    debugs(85, 5, HERE &lt;&lt; &quot;Confirming &quot; &lt;&lt; Ssl::bumpMode(sslBumpNeed_) &lt;&lt;
           &quot;-bumped CONNECT tunnel on FD &quot; &lt;&lt; getConn()-&gt;clientConnection);
    getConn()-&gt;sslBumpMode = sslBumpNeed_;

    AsyncCall::Pointer bumpCall = commCbCall(85, 5,
&quot;ClientSocketContext::sslBumpEstablish&quot;,
                                  CommIoCbPtrFun(&amp;SslBumpEstablish, this));

    if (request-&gt;flags.interceptTproxy || request-&gt;flags.intercepted) {
        CommIoCbParams &amp;params = GetCommParams&lt;CommIoCbParams&gt;(bumpCall);
        params.flag = Comm::OK;
        params.conn = getConn()-&gt;clientConnection;
        ScheduleCallHere(bumpCall);
        return;
    }

    // send an HTTP 200 response to kick client SSL negotiation
    // TODO: Unify with tunnel.cc and add a Server(?) header
    static const char *const conn_established = &quot;HTTP/1.1 200 Connection
established\r\n\r\n&quot;;
    Comm::Write(getConn()-&gt;clientConnection, conn_established,
strlen(conn_established), bumpCall, NULL);
}

if require-proxy-header is not used, then request-&gt;flags.interceptTproxy is
0, and when requir-proxy-header is used, the
request-&gt;flags.interceptTproxy is 1!

since request-&gt;flags.interceptTproxy is 1, the 200 status code for CONNECT
call is not sent. (The last part of code sending 200 status code is
skipped.)

Any kind help?

Alex


On Tue, Apr 14, 2015 at 10:05 AM, Yuhua Wu &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ywu at bitglass.com</A>&gt; wrote:

&gt;<i> I think, in the sslbump mode, if PROXY protocol is enabled, client cannot
</I>&gt;<i> set up the SSL tunnel with squid after CONNECT call succeeds. I remember
</I>&gt;<i> that HAProxy will send PROXY protocol line during ssl negotiation. If squid
</I>&gt;<i> does not parse the PROXY protocol header during SSL negotiation, this will
</I>&gt;<i> cause the problem.
</I>&gt;<i>
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> On Mon, Apr 13, 2015 at 7:56 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 14/04/2015 4:47 a.m., Yuhua Wu wrote:
</I>&gt;&gt;<i> &gt; For example, is this configuration supported?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; http_port 3129 require-proxy-header ssl-bump &#8230;&#8230;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; By the way, we added acl rules:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; acl frontend src 10.0.0.0/8
</I>&gt;&gt;<i> &gt; proxy_protocol_access allow frontend
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Alex
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes that should work.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;<A HREF="http://www.squid-cache.org/Versions/v3/3.5/RELEASENOTES.html#ss2.7">http://www.squid-cache.org/Versions/v3/3.5/RELEASENOTES.html#ss2.7</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Your above config example decrypts the traffic through the following
</I>&gt;&gt;<i> layers:
</I>&gt;&gt;<i>   HTTPS over HTTP/1.x over PROXY/TCP ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As you can see the PROXY and HTTPS layers are separate protocols that
</I>&gt;&gt;<i> dont interact.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150414/c4170140/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150414/c4170140/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003074.html">[squid-users] does http_port sssl-bump work	require-proxy-header?
</A></li>
	<LI>Next message (by thread): <A HREF="003086.html">[squid-users] does http_port sssl-bump work	require-proxy-header?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3083">[ date ]</a>
              <a href="thread.html#3083">[ thread ]</a>
              <a href="subject.html#3083">[ subject ]</a>
              <a href="author.html#3083">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
