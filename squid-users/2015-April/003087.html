<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache-control: no-cache=&quot;set-cookie&quot; prevents	caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache-control%3A%20no-cache%3D%22set-cookie%22%20prevents%0A%09caching&In-Reply-To=%3C552E2062.7020800%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003082.html">
   <LINK REL="Next"  HREF="003084.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache-control: no-cache=&quot;set-cookie&quot; prevents	caching</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache-control%3A%20no-cache%3D%22set-cookie%22%20prevents%0A%09caching&In-Reply-To=%3C552E2062.7020800%40treenet.co.nz%3E"
       TITLE="[squid-users] cache-control: no-cache=&quot;set-cookie&quot; prevents	caching">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 15 08:25:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003082.html">[squid-users] cache-control: no-cache=&quot;set-cookie&quot; prevents caching
</A></li>
        <LI>Next message (by thread): <A HREF="003084.html">[squid-users] Delay pool change
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3087">[ date ]</a>
              <a href="thread.html#3087">[ thread ]</a>
              <a href="subject.html#3087">[ subject ]</a>
              <a href="author.html#3087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/04/2015 9:49 a.m., Sriram Devadas wrote:
&gt;<i> Squid version 3.5.3.
</I>&gt;<i> When the http response received by Squid contains a no-cache=&quot;set-cookie&quot;, the response is not cached. cache.log has the line:
</I>&gt;<i> 2015/04/14 18:24:38.027 kid1| http.cc(359) cacheableReply: NO because server reply Cache-Control:no-cache has parameters
</I>&gt;<i> 
</I>&gt;<i> The relevant source code is in http.cc:
</I>&gt;<i>         if (rep-&gt;cache_control &amp;&amp; rep-&gt;cache_control-&gt;hasNoCache() &amp;&amp; rep-&gt;cache_control-&gt;noCache().size() &gt; 0) {
</I>&gt;<i>             /* TODO: we are allowed to cache when no-cache= has parameters.
</I>&gt;<i>              * Provided we strip away any of the listed headers unless they are revalidated
</I>&gt;<i>              * successfully (ie, must revalidate AND these headers are prohibited on stale replies).
</I>&gt;<i>              * That is a bit tricky for squid right now so we avoid caching entirely.
</I>&gt;<i>              */
</I>&gt;<i>             debugs(22, 3, HERE &lt;&lt; &quot;NO because server reply Cache-Control:no-cache has parameters&quot;);
</I>&gt;<i>             return 0;
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i> I have read the TODO comment but do not know if this applies to the set-cookie parameter too.
</I>&gt;<i> Is it okay to add a condition here not to return if the cache-control header contains only no-cache=&quot;set-cookie&quot;?
</I>
I dont think so. At least by itself that is not enough.

The existing code is there to enact the generic fail-safe action
permitted of the HTTP specification. To treat any unsupported no-cache
condition from the server as a no-store.

That is currently being done because there has been zero testing of the
code paths your propose change would enable. Please feel free to go
ahead and do that testing, patches that improve the caching are very
welcome.

But be aware there are very likely also some missing code elsewhere that
causes broken behaviour. This change requires that the header stripping
or updating on replies to clients operates correctly in the presence of
all possibly 20x and 30x response codes. More on that below...


&gt;<i> In client_side_reply.cc the no-cache=&quot;set-cookie&quot; seems to be handled correctly, the set-cookie header is removed in the response, which I am guessing removes this header correctly in the response:
</I>&gt;<i>     if (is_hit)
</I>&gt;<i>         hdr-&gt;delById(HDR_SET_COOKIE);
</I>&gt;<i> 
</I>
Well no, this would likely (untested) cause a significant amount of
traffic to have wrongly missing Set-Cookie. Today that traffic is a
MISS, but MiSS guarantees correct headers.

The (is_hit) condition is wrongly positioned in the code sequence (far
too late currently). Its also not handling any other headers that could
be listed by no-cache=&quot;...&quot;.

There are two options that would do it right, for all headers as easily
as for Set-Cookie alone:

1) going through the no-cache list and stripping away all those headers
from the cached copy before it got stored (and in collapsed-forwarding
code paths before object sharing).

or,

2) The same removal of headers in the code where object is loaded from
cache (and in collapsed-forwarding code paths before object sharing).
The header needs to be erased from the cached copy that could be sent to
clients, AND all same-named headers the origin server provides on its
revalidation 30x response needs to be added in their place later in
those 30x handling code paths.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003082.html">[squid-users] cache-control: no-cache=&quot;set-cookie&quot; prevents caching
</A></li>
	<LI>Next message (by thread): <A HREF="003084.html">[squid-users] Delay pool change
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3087">[ date ]</a>
              <a href="thread.html#3087">[ thread ]</a>
              <a href="subject.html#3087">[ subject ]</a>
              <a href="author.html#3087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
