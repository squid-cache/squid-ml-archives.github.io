<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Configuration assistance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Configuration%20assistance&In-Reply-To=%3C552E2D71.5060109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003073.html">
   <LINK REL="Next"  HREF="003080.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Configuration assistance</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Configuration%20assistance&In-Reply-To=%3C552E2D71.5060109%40treenet.co.nz%3E"
       TITLE="[squid-users] Configuration assistance">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 15 09:20:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003073.html">[squid-users] Configuration assistance
</A></li>
        <LI>Next message (by thread): <A HREF="003080.html">[squid-users] assertion failed: comm.cc:178: &quot;fd_table[conn-&gt;fd].halfClosedReader != NULL&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3092">[ date ]</a>
              <a href="thread.html#3092">[ thread ]</a>
              <a href="subject.html#3092">[ subject ]</a>
              <a href="author.html#3092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/04/2015 4:25 a.m., HiP-HiPpO wrote:
&gt;<i> Hello-
</I>&gt;<i> 
</I>&gt;<i>   I'm using squid version 3.5.3 and I could use some help with
</I>&gt;<i> configuration.
</I>
First up, lets be clear: This is going to be difficult.

The Apache setup you had appears to have been severely violating the
HTTP *and* HTTPS protocols security requirements.

You *will* have different behaviour from one endpoint or the other just
by not using Apache.


&gt;<i> 
</I>&gt;<i>   Squid will be installed at AWS, most clients will be within a corporate
</I>&gt;<i> network and will not be able to access the service by configuring proxy
</I>&gt;<i> settings in a browser.
</I>
NOTE: That logic is false.

 Corporate networks / LAN are *the* use-case which is best suited to
explicit browser configuration. You have AD policy, WPAD DHCP, WPAD DNS,
user login scripts ror batch jobs, etc available to push out the
settings. Other use-cases do not have some of those options, or they do
not work as well as in a LAN environment.


&gt;<i>  Instead DNS will be used to resolve to the Squid
</I>&gt;<i> service.  The Squid service will authenticate users via SLDAP.  The
</I>&gt;<i> service will need to be able to intercept both clear and TLS HTTP traffic
</I>&gt;<i> in order to insert an Authorization header.
</I>
At first reading this makes no sense. But what you go on to describe is
in fact a reverse-proxy.

SO.. forget the word &quot;intercept&quot;, it has nothing to do with what you
have set up.

&gt;<i> 
</I>&gt;<i>   The request flow would be something like;
</I>&gt;<i> 
</I>&gt;<i> Client browser requests http(s)://proxy-hostX.test.com
</I>&gt;<i> (where 0 &lt; X &lt; 50)
</I>&gt;<i> 
</I>&gt;<i> Squid will need to intercept the request and add an Authorization header.
</I>
Okay, ignoring the word &quot;intercept&quot;, what you have here is just a proxy
that performs login to some backend service(s).

Fairly standard, though you have not said what authentication scheme the
backend is using. That is an important detail.


&gt;<i> Squid will need to rewrite the request to the origin server.  In this
</I>&gt;<i> case, the origin server name is hostX.test.com
</I>&gt;<i> 
</I>&gt;<i> Squid will then intercept the server response and direct that response to
</I>&gt;<i> an ICAP server to modify all embedded links to be the same as the
</I>&gt;<i> request.  All links in the response will need to be rewritten to
</I>&gt;<i> http(s)://proxy-hostX.test.com
</I>

This is where you start to have problems. Still ignoring the word
&quot;intercept&quot;, you have a proxy that uses ICAP adaptation to re-write both
requests and response, mapping public URI resources to some essentially
completely different private/intenral resoruce URIs.

This ICAP part is very difficult, complex, and has nothing to do with
Squid. So what it (ICAP) actually does to the traffic is not relevant
here. In squid.conf you just need both a REQMOD and RESPMOD service
configured. ICAP service does all the complex bits.

NOTE: be aware that mapping between <A HREF="http://">http://</A> and <A HREF="https://">https://</A> scheme is
expressly forbidden by both HTTP and HTTPS specifications. The security
vulnerabilities introduced by doing so are extremely dangerous and have
many unknowable side-effects. You need to be careful that ICAP service
used does not cause it to happen.

&gt;<i> 
</I>&gt;<i> I have official wildcard certificates for the domain.  i.e. *.test.com
</I>&gt;<i> 
</I>

&gt;<i> Squid will also need to retrieve group memberships from SLDAP and authorize
</I>&gt;<i> user access to hostX based on group memberships.  If the user is in the
</I>&gt;<i> groups host30 and host43, then access is allowed to only host30.test.com
</I>&gt;<i> and host43.test.com
</I>
The SLDAP part for finding group details and adding auth to the backend
is pretty standard. Some limits apply, but pretty easy to do.

BUT ... How do you determine which user made which request?

The usual way is for clients to perform HTTP login to Squid. Anything
else gets much harder, particularly for reverse-proxy.


So, taking note of the fixed terminology I supplied above the wiki
config examples should now be more useful to you:

You have a reverse-proxy doing virtual hosting
(&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting">http://wiki.squid-cache.org/ConfigExamples/Reverse/VirtualHosting</A>&gt;)
also in HTTPS with wildcard certificate
(&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Reverse/SslWithWildcardCertifiate">http://wiki.squid-cache.org/ConfigExamples/Reverse/SslWithWildcardCertifiate</A>&gt;)
to multiple backend servers
(&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Reverse/MultipleWebservers">http://wiki.squid-cache.org/ConfigExamples/Reverse/MultipleWebservers</A>&gt;).

You have ICAP services performing REQMOD and RESPMOD traffic adaptation:
 &lt;wiki.squid-cache.org/Features/ICAP&gt;

You are performing some form of user identification, with group access
controls
(&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Groups">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Groups</A>&gt;),
followed by authentication to the backend servers
(&lt;<A HREF="http://www.squid-cache.org/Doc/config/cache_peer/">http://www.squid-cache.org/Doc/config/cache_peer/</A>&gt; see login=
authentication options).


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003073.html">[squid-users] Configuration assistance
</A></li>
	<LI>Next message (by thread): <A HREF="003080.html">[squid-users] assertion failed: comm.cc:178: &quot;fd_table[conn-&gt;fd].halfClosedReader != NULL&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3092">[ date ]</a>
              <a href="thread.html#3092">[ thread ]</a>
              <a href="subject.html#3092">[ subject ]</a>
              <a href="author.html#3092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
