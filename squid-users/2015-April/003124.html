<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid downloading huge amounts of un-requested data
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20downloading%20huge%20amounts%20of%20un-requested%0A%20data&In-Reply-To=%3C552F463B.2090106%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003121.html">
   <LINK REL="Next"  HREF="003136.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid downloading huge amounts of un-requested data</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20downloading%20huge%20amounts%20of%20un-requested%0A%20data&In-Reply-To=%3C552F463B.2090106%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid downloading huge amounts of un-requested data">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr 16 05:18:51 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003121.html">[squid-users] Squid downloading huge amounts of un-requested data
</A></li>
        <LI>Next message (by thread): <A HREF="003136.html">[squid-users] Squid downloading huge amounts of un-requested	data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3124">[ date ]</a>
              <a href="thread.html#3124">[ thread ]</a>
              <a href="subject.html#3124">[ subject ]</a>
              <a href="author.html#3124">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/04/2015 3:16 p.m., iridium191 wrote:
&gt;<i> Hi Forum,
</I>&gt;<i> 
</I>&gt;<i> We're running Squid Version 3.3.8 (from repository) on Ubuntu server 14.04
</I>&gt;<i> LTS x64 as a caching proxy server for a mixed Linux/Windows network. 
</I>&gt;<i> We were attempting to cache apt-get and Windows updates using various
</I>&gt;<i> refresh patterns but commented them out a few weeks ago after an issue where
</I>&gt;<i> the squid server had downloaded over 100GB of data over 24 hours but in that
</I>&gt;<i> time had served only about 6GB to clients. 100GB represents almost our
</I>&gt;<i> entire normal monthly traffic. Most of the incoming Squid traffic was from
</I>&gt;<i> Windows updates or Akamai servers. Prior to that the server had been running
</I>&gt;<i> for months without an issue.
</I>&gt;<i> Unfortunately the same thing happened again last night. The only remanent of
</I>&gt;<i> the Windows Update cache commands we forgot to uncomment in squid.conf were:
</I>&gt;<i> range_offset_limit 200 MB WindowsUpdate 
</I>&gt;<i> maximum_object_size 1 GB
</I>&gt;<i> quick_abort_min -1
</I>&gt;<i> 
</I>&gt;<i> which we have since commented out and restarted the Squid server.
</I>
Leave the maximum_object_size, the default is to only cache 4 MB objects
and anything else becomes a MISS to consume more upstream bandwidth.

The range_offset_limit and quick_abort_min are what causes more download
for Range requests than what clients requested.


&gt;<i> 
</I>&gt;<i> The incoming traffic to Squid is being recorded by the syslog of our ASA5510
</I>&gt;<i> firewall and corroborated by our ISP's management console. Clients can only
</I>&gt;<i> access the internet through the proxy. The outgoing traffic statistics are
</I>&gt;<i> being reported by SARG, SquidAnalyzer and a custom tcpdump script of all
</I>&gt;<i> traffic from the server and all three agree.
</I>&gt;<i> 
</I>&gt;<i> So our question- is there any way that Squid can download content
</I>&gt;<i> repeatedly, and many times in excess of what our clients are actually
</I>&gt;<i> requesting? How can we debug this issue further? 
</I>

Several.

* Remote server not supporting HTTP/1.1 304 revalidation properly.
Results in the server delivering 200 response + full object data to
Squid when a 304 would suffice and Squid only delivers 304 to the client.

* Misconfigured / open proxy. When remote users abuse the proxy all
traffic goes over the WAN interfaces. Measurement tools that
differentiate by NIC on the Squid machine will see this as massive
amounts of WAN traffic relative to LAN.

* Long polling connections.

* ICAP. The ICAP service may be doing anything that triggers lots of WAN
traffic use. It can require full objects - forcing the same behaviour as
quick_abort_*, it can do its own downloads - traffic not used by Squid
at all but still used, it can make lots of requests

* squidguard. Same as with ICAP it can be doing its own downloads. Also
URL-rewritten traffic does not relay the client reuqest to the server,
but the re-writer generated request. This is another way server 200
responses can become 200 when only 304 were necessary.



&gt;<i>  relevant squid.conf
</I>
Is missing many configuration details that must be present for an
operational proxy. Specifically the access controls to determine if the
open proxy issues are relevant.


With all that logging and traffic measurement are you able to track down
an example transaction where Squid fetches more from the network than it
delivers to the client.

Squids cachemgr utilization report has a breakdown of how much traffic
is used by each I/O type. It can help identify where to look at closer.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003121.html">[squid-users] Squid downloading huge amounts of un-requested data
</A></li>
	<LI>Next message (by thread): <A HREF="003136.html">[squid-users] Squid downloading huge amounts of un-requested	data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3124">[ date ]</a>
              <a href="thread.html#3124">[ thread ]</a>
              <a href="subject.html#3124">[ subject ]</a>
              <a href="author.html#3124">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
