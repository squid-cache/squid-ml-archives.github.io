<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] how to achieve squid to handle 2000 concurrent connections?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20how%20to%20achieve%20squid%20to%20handle%202000%20concurrent%0A%20connections%3F&In-Reply-To=%3C55344F34.1070607%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003171.html">
   <LINK REL="Next"  HREF="003301.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] how to achieve squid to handle 2000 concurrent connections?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20how%20to%20achieve%20squid%20to%20handle%202000%20concurrent%0A%20connections%3F&In-Reply-To=%3C55344F34.1070607%40treenet.co.nz%3E"
       TITLE="[squid-users] how to achieve squid to handle 2000 concurrent connections?">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Apr 20 00:58:28 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003171.html">[squid-users] how to achieve squid to handle 2000 concurrent	connections?
</A></li>
        <LI>Next message (by thread): <A HREF="003301.html">[squid-users] how to achieve squid to handle 2000 concurrent connections?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3173">[ date ]</a>
              <a href="thread.html#3173">[ thread ]</a>
              <a href="subject.html#3173">[ subject ]</a>
              <a href="author.html#3173">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/04/2015 9:58 p.m., Abdelouahed Haitoute wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I&#8217;ve got the following setup, each application on its own virtual machine:
</I>&gt;<i> 
</I>&gt;<i> Client (sends http-requests to proxy)&#8212;&gt; Squid (sends http-requests to apache based on destination IP and round robin to multiple apache machines) &#8212;&gt; Apache (setting up a two way ssl to the requested server) &#8212;&gt; HTTPS-server
</I>&gt;<i> 
</I>&gt;<i> This setup works great, and I have the Apache and the HTTPS-server its performance tuned. Both can handle 2000 concurrent connections of file sizes up to 10MB.
</I>&gt;<i> 
</I>&gt;<i> Unfortunately I haven&#8217;t been successful with the Squid-server. After a while I&#8217;m getting the following error messages in the log:
</I>&gt;<i> 1429432828.200  62854 10.10.7.16 TCP_MISS_ABORTED/000 0 GET <A HREF="http://https.example.com/index.html">http://https.example.com/index.html</A> - ROUNDROBIN_PARENT/192.168.0.20 -
</I>&gt;<i> 
</I>&gt;<i> The Squid virtual machine contains the following:
</I>&gt;<i> CentOS 7.1 with latest updates
</I>&gt;<i> Squid Cache: Version 3.3.8
</I>&gt;<i> CPU: Intel Xeon E312xx (Sandy Bridge) - 1799.998 MHz (4 cores)
</I>&gt;<i> Memory: 4096 MiB
</I>&gt;<i> Harddisk: 10 GiB, SCSI, raw, cache none
</I>&gt;<i> 
</I>&gt;<i> When I execute a performance test with 2000 concurrent connections handling a file size of 10KB on each request.
</I>&gt;<i> # ab -n 10000 -c 2000 -X 10.10.7.15:3128 <A HREF="http://https.example.com/index.html">http://https.example.com/index.html</A>
</I>
You are wrong. &quot;ab -c 2000&quot; to a non-caching proxy means *4000*
concurrent connections being handled by the proxy. Web server only loads
the file object once.

A non-caching proxy requires +1 connection to server for each inbound
client connection ( 2000 + 2000 = 4K concurrent connections ).


&gt;<i> This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;
</I>&gt;<i> Copyright 1996 Adam Twiss, Zeus Technology Ltd, <A HREF="http://www.zeustech.net/">http://www.zeustech.net/</A>
</I>&gt;<i> Licensed to The Apache Software Foundation, <A HREF="http://www.apache.org/">http://www.apache.org/</A>
</I>&gt;<i> 
</I>&gt;<i> Benchmarking https.rinis.nl [through 10.10.7.15:3128] (be patient)
</I>&gt;<i> Completed 1000 requests
</I>&gt;<i> Completed 2000 requests
</I>&gt;<i> Completed 3000 requests
</I>&gt;<i> Completed 4000 requests
</I>&gt;<i> Completed 5000 requests
</I>&gt;<i> Completed 6000 requests
</I>&gt;<i> Completed 7000 requests
</I>&gt;<i> Completed 8000 requests
</I>&gt;<i> apr_pollset_poll: The timeout specified has expired (70007)
</I>
Squid is still responding by the client has given up. As shown by the
_ABORTED in the squid log.


&gt;<i> Total of 8610 requests completed
</I>&gt;<i> 
</I>&gt;<i> I have the command &quot;vmstat 5&#8221; running on the squid server:
</I>&gt;<i> procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
</I>&gt;<i>  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</I>&gt;<i>  2  0      0 3823916    764 124992    0    0   519    26  237  503  2  3 92  3  0
</I>&gt;<i>  0  0      0 3823744    764 125072    0    0     0     0   44   79  0  0 100  0  0
</I>&gt;<i>  0  0      0 3823776    764 125044    0    0     0     2   39   70  0  0 100  0  0
</I>&gt;<i>  0  0      0 3729540    764 139116    0    0     1     0 2145  257  1  2 97  0  0
</I>&gt;<i>  0  0      0 3728432    764 139888    0    0     0    46 2297  594  1  1 97  0  0
</I>&gt;<i>  0  0      0 3726484    764 140892    0    0     0    39 2869  581  2  1 97  0  0
</I>&gt;<i>  0  0      0 3725528    764 141376    0    0     0     0 2843  648  2  2 96  0  0
</I>&gt;<i>  0  0      0 3724980    764 142008    0    0     0    69 2824  529  2  1 97  0  0
</I>&gt;<i>  0  0      0 3724584    764 142540    0    0     0     0 2742  472  2  1 97  0  0
</I>&gt;<i>  0  0      0 3723696    764 143004    0    0     0     0 2511  577  2  1 97  0  0
</I>&gt;<i>  0  0      0 3722840    764 143200    0    0     0    12  884  228  1  1 99  0  0
</I>&gt;<i>  0  0      0 3722704    764 142900    0    0     0     0  136  127  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722504    764 142744    0    0     0     0   40   70  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722456    764 142784    0    0     0   114   37   68  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722208    764 142832    0    0     0     0   41   68  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722480    764 142280    0    0     0     0  179   82  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722544    764 142140    0    0     0     7   41   75  0  0 100  0  0
</I>&gt;<i> procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
</I>&gt;<i>  r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
</I>&gt;<i>  1  0      0 3722544    764 142136    0    0     0     0   36   67  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722996    764 141552    0    0     0     0   42   75  0  0 100  0  0
</I>&gt;<i>  0  0      0 3722980    764 141568    0    0     0     0   37   68  0  0 100  0  0
</I>&gt;<i>  0  0      0 3723028    764 141524    0    0     0     0   36   66  0  0 100  0  0
</I>&gt;<i>  0  0      0 3736816    764 130352    0    0     0     0  809  114  0  0 99  0  0
</I>&gt;<i>  0  0      0 3737544    764 130268    0    0     0    41   42   74  0  0 100  0  0
</I>&gt;<i> 
</I>&gt;<i> It looks like the hardware has enough resources during the benchmark test.
</I>&gt;<i> 
</I>&gt;<i> I&#8217;ve got the following squid.conf running:
</I>&gt;<i> cache_peer 192.168.0.18 parent 3128 0 round-robin no-query no-digest
</I>&gt;<i> cache_peer 192.168.0.20 parent 3128 0 round-robin no-query no-digest
</I>&gt;<i> 
</I>&gt;<i> acl development_net dst 192.168.0.0/24
</I>&gt;<i> cache_peer_access 192.168.0.18 allow development_net
</I>&gt;<i> cache_peer_access 192.168.0.20 allow development_net
</I>&gt;<i> 
</I>&gt;<i> never_direct allow all
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> maximum_object_size_in_memory 16 MB
</I>&gt;<i> cache_mem 2048 MB
</I>&gt;<i> 
</I>&gt;<i> The squid must not cache at all.
</I>
The dont bother setting cache_mem to 2GB. The memory cache wont be used.

Also note that the lack of caching is *worsening* your performance
results. When memory cache is used the FD usage is halved, and the time
to respond is greatly increased (factor of approx 100 in latency reduction).
 Consider removing the &quot;cache deny all&quot; when you get this into
production. The 2GB memory cache you assigned can help a *lot* for quick
short term bursts of high traffic (ie. some DoS situations).


I do not see any SMP configuration in your Squid. Meaning that its
operating all those 4K connections with a single process on a single
1.7GHz core. Thats not much processor to work with.

Try adding this to your config file:
 workers 2


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003171.html">[squid-users] how to achieve squid to handle 2000 concurrent	connections?
</A></li>
	<LI>Next message (by thread): <A HREF="003301.html">[squid-users] how to achieve squid to handle 2000 concurrent connections?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3173">[ date ]</a>
              <a href="thread.html#3173">[ thread ]</a>
              <a href="subject.html#3173">[ subject ]</a>
              <a href="author.html#3173">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
