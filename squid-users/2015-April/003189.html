<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5Bsquid%20%5D%20externalAclLookup%3A%20%27wbinfo_group_helper%27%0A%20queue%20overload.&In-Reply-To=%3C5535C7F5.8040102%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003175.html">
   <LINK REL="Next"  HREF="003233.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5Bsquid%20%5D%20externalAclLookup%3A%20%27wbinfo_group_helper%27%0A%20queue%20overload.&In-Reply-To=%3C5535C7F5.8040102%40treenet.co.nz%3E"
       TITLE="[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Apr 21 03:45:57 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003175.html">[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper'	queue overload.
</A></li>
        <LI>Next message (by thread): <A HREF="003233.html">[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3189">[ date ]</a>
              <a href="thread.html#3189">[ thread ]</a>
              <a href="subject.html#3189">[ subject ]</a>
              <a href="author.html#3189">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/04/2015 7:31 p.m., Jagannath Naidu wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I am having this issue very frequently. Please help on this.
</I>&gt;<i> 
</I>&gt;<i> I get these errors randomly, mostly when usage is at very peak. (800 users)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /var/log/squid/cache.log
</I>&gt;<i> 
</I>&gt;<i> 2015/04/20 12:37:40| externalAclLookup: 'wbinfo_group_helper' queue
</I>&gt;<i> overload (ch=0x7fc99e2ce518)
</I>
What do you think &quot;overload&quot; means?
 The helper is unable to cope with the traffic load being passed to it.

Here is the biggest hint:
&gt;<i>
</I>&gt;<i> in /var/log/messages,  I get the following errors
</I>&gt;<i>
</I>&gt;<i> pr 20 12:59:15 GGNPROXY01 winbindd[1910]:   winbindd: Exceeding 200 client
</I>&gt;<i> connections, no idle connection found
</I>



&gt;<i> Then squid stops working. For squid to start work again, I have to dlete
</I>&gt;<i> the cache and restart the squid &quot;squid -k reconfigure&quot;, and then squid
</I>&gt;<i> restart.
</I>
What Squid version are you using?

&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> 
</I>&gt;<i> max_filedesc 17192
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 172.16.50.61/24
</I>
You have an entire /24 (256 IPs) assigned to this machine?

I think you need to remove that &quot;/24&quot; part if the *.61 is the local
machines *public* IP.


&gt;<i> http_access allow manager localhost
</I>&gt;<i> dns_nameservers 172.16.3.34 10.1.2.91
</I>&gt;<i> acl allowips src 172.16.58.187 172.16.16.192 172.16.58.113 172.16.58.63
</I>&gt;<i> 172.16.58.98 172.16.60.244 172.16.58.165 172.16.58.157
</I>&gt;<i> http_access allow allowips
</I>
&gt;<i> auth_param basic realm Squid proxy-caching web server
</I>&gt;<i> auth_param basic credentialsttl 2 hours external_acl_type nt_group ttl=0
</I>&gt;<i> children=60 %LOGIN /usr/lib64/squid/wbinfo_group.pl
</I>
The above two very mangled config lines are useless. Remove them.

&gt;<i> acl localnet src 172.16.0.0/24
</I>
Its a bit strange that none of the localhost machine IPs
(172.16.50.0-172.16.50.255) are part of the LAN its plugged into
172.16.0.0-172.16.0.255.


&gt;<i> acl localnet src fc00::/7 # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10 # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=HTMEDIA.NET
</I>
Okay you have configured NTLM...

&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=HTMEDIA.NET
</I>
... but twice. With different settings. Only these last ones will have
any effect.


&gt;<i> auth_param ntlm children 600
</I>&gt;<i> auth_param ntlm keep_alive off
</I>
&gt;<i> auth_param negotiate children 150
</I>&gt;<i> auth_param negotiate keep_alive off
</I>&gt;<i> visible_hostname GGNPROXY01.HTMEDIA.NET
</I>&gt;<i> external_acl_type wbinfo_group_helper ttl=0 children=40 %LOGIN
</I>&gt;<i> /usr/lib64/squid/wbinfo_group.pl -d
</I>&gt;<i> auth_param negotiate keep_alive off
</I>
You have several useless configuration lines for Negotiate auth which is
not being used in any way. Remove those.


&gt;<i> acl Safe_ports port 8080 #https
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> acl google dstdomain -i &quot;/etc/squid/google_site.com&quot;
</I>&gt;<i> http_access allow google
</I>&gt;<i> acl sq1 external wbinfo_group_helper &quot;/etc/squid/HT/sq1&quot;
</I>&gt;<i> acl sq2 external wbinfo_group_helper &quot;/etc/squid/HT/sq2&quot;
</I>&gt;<i> acl sq3 external wbinfo_group_helper &quot;/etc/squid/HT/sq3&quot;
</I>&gt;<i> acl sq4 external wbinfo_group_helper &quot;/etc/squid/HT/sq4&quot;
</I>&gt;<i> acl sq5 external wbinfo_group_helper &quot;/etc/squid/HT/sq5&quot;
</I>&gt;<i> acl pro1 external wbinfo_group_helper &quot;/etc/squid/HT/pro1&quot;
</I>&gt;<i> acl pro2 external wbinfo_group_helper &quot;/etc/squid/HT/pro2&quot;
</I>&gt;<i> acl pro3 external wbinfo_group_helper &quot;/etc/squid/HT/pro3&quot;
</I>&gt;<i> acl pro4 external wbinfo_group_helper &quot;/etc/squid/HT/pro4&quot;
</I>&gt;<i> acl pro5 external wbinfo_group_helper &quot;/etc/squid/HT/pro5&quot;
</I>&gt;<i> acl pro6 external wbinfo_group_helper &quot;/etc/squid/HT/pro6&quot;
</I>&gt;<i> acl webvip external wbinfo_group_helper &quot;/etc/squid/HT/webvip&quot;
</I>&gt;<i> acl allgroup external wbinfo_group_helper &quot;/etc/squid/HT/allgreop&quot;
</I>&gt;<i> acl restricted external wbinfo_group_helper &quot;/etc/squid/HT/restricted&quot;
</I>&gt;<i> acl ad_auth proxy_auth REQUIRE
</I>
You already have an ACL named &quot;auth&quot; which performs authentication.
The above line is not useful. Remove it and replace all uses of
&quot;ad_auth&quot; ACL with &quot;auth&quot; ACL.

&gt;<i> acl allowwebsites dstdomain -i &quot;/blacklists/allowedwebsite/domains&quot;
</I>&gt;<i> acl allowwebsites_url url_regex -i &quot;/blacklists/allowedwebsite/url&quot;
</I>&gt;<i> http_access allow allowwebsites
</I>&gt;<i> http_access allow allowwebsites_url
</I>&gt;<i> acl shopping dstdomain -i &quot;/etc/squid/shopping.txt&quot;
</I>&gt;<i> acl social_networking dstdomain -i &quot;/blacklists/social/social.networking&quot;
</I>&gt;<i> acl youtube dstdomain -i .youtube.com
</I>&gt;<i> http_access allow Safe_ports pro1 pro2 pro3 pro4 pro5 pro6 webvip
</I>
Incorrect use of &quot;Safe_ports&quot; security check. Correct usage is to deny
access to all *unsafe* ports. They are unsafe because HTTP can be
smuggled within the ports native protocol to attack your proxy.

Once the correct security protections for Safe_port and CONNECT tunnels
have been moved up the top remove the &quot;Safe_ports&quot; check from this line.

This line is also very odd in another way. ACL tests in a single line
are AND'ed together - so this means the request must be from a user who is:
  authenticated AND a member of group pro1 AND pro2 AND pro3 AND pro4
AND pro5 AND pro6 AND webvip

This hints at what your main helper problem is. The above line requires
7 group helper lookups *per request*. The winbind helper has a maximum
of 200 simultaneous connections. This line alone will limit your proxy
just under 30 new visitors per second (that becomes 60 lookups/sec
before queue overload).
 The helper result caching will help a lot, but you also have a LOT of
other group checks being made and 800 users.


&gt;<i> http_access allow youtube pro5
</I>&gt;<i> http_access allow youtube pro6
</I>&gt;<i> http_access allow youtube webvip
</I>&gt;<i> http_access deny youtube
</I>&gt;<i> http_access allow shopping pro5
</I>&gt;<i> http_access allow shopping pro6
</I>&gt;<i> http_access allow shopping webvip
</I>&gt;<i> http_access deny shopping
</I>
Optimization hint:
 &quot;youtube&quot; and &quot;shopping&quot; have the same allow/deny criteria. It would be
worth combining them into one ACL.

&gt;<i> http_access allow social_networking pro2
</I>&gt;<i> http_access allow social_networking pro4
</I>&gt;<i> http_access allow social_networking pro6
</I>&gt;<i> http_access allow social_networking webvip
</I>&gt;<i> http_access deny social_networking
</I>&gt;<i> acl porn_site1   dstdomain &quot;/etc/squid/blacklists/porn/domains.txt&quot;
</I>&gt;<i> acl porn_site2   dstdom_regex -i &quot;/etc/squid/blacklists/porn/expressions&quot;
</I>&gt;<i> acl porn_site3   dstdom_regex -i &quot;/etc/squid/blacklists/porn/urls.txt&quot;
</I>&gt;<i> acl audio_video1   dstdomain &quot;/etc/squid/blacklists/audio-video/urls.txt&quot;
</I>&gt;<i> ###################### THERE ARE TOO MANY acls and http_access , so not
</I>&gt;<i> bothering with vast linux
</I>
I will bet a lot of those ACLs are also calling the group helper too yes?

&gt;<i> http_access allow liquorinfo webvip
</I>&gt;<i> http_access deny liquorinfo
</I>&gt;<i> http_access allow ad_auth
</I>&gt;<i> http_access allow auth
</I>
Once you have removed ad_auth ACL, this becomes:
 http_access allow auth
 http_access allow auth

I hope you can see how redundant that is.

Also, its very likely that the &quot;allow auth&quot; is a useless operation after
a great many group checks have also performed authentication. That &quot;TOO
MANY acls and https_access&quot; list you omitted will be needed to determine
that.


&gt;<i> http_access allow sq1 sq2
</I>&gt;<i> acl NTLMUsers proxy_auth REQUIRED
</I>
You already have an ACL named &quot;auth&quot; which performs authentication.
The above line is not being used in any way. Remove it.

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
These are basic security protection against Denial of Service and other
types of protocol smuggling attacks. They only work when they are used
*above* your custom &quot;allow&quot; rules.

Move these two lines above your &quot;http_access allow google&quot; line.



&gt;<i> http_port 8080
</I>&gt;<i> hierarchy_stoplist cgi-bin ?
</I>
The above line is not useful these days. Remove it.

&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_dir aufs /var/spool/squid 20384 32 512
</I>&gt;<i> cache_mem 50 MB
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> cache_swap_low 85
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> maximum_object_size 5 MB
</I>&gt;<i> maximum_object_size_in_memory 50 KB
</I>&gt;<i> ipcache_size 5240
</I>&gt;<i> ipcache_low 90
</I>&gt;<i> ipcache_high 95
</I>&gt;<i> cache_mgr amit
</I>&gt;<i> cachemgr_passwd ****
</I>
I hope that was not your real cachemgr password you just published on a
public mailing list.


&gt;<i> acl SSL_ports port 443
</I>
The above is a duplicate config line. Remove it.

&gt;<i> http_access allow CONNECT SSL_ports
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> url_rewrite_program /usr/local/bin/squidGuard -c
</I>&gt;<i> /usr/local/squidGuard/squidGuard.conf
</I>&gt;<i> 
</I>

Now, as to solving your problem:

1) Clean up your config. Reduce the amount of redundant or unused
things. I've mentioned a few above.

2) Run &quot;squid -k parse&quot; and fix any other problems it highlights.

3) optimize your ACls and http_access rules. I've mentioned a few, such
as moving the main security checks to the top so DoS traffic does not
put load on the helpers and other ACLs.

I believe though that you will probably find Squid works much better
having the following access controls pattern:
&quot;
 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

 # if they are not authenticated, they will not be in a group
 http_access deny !auth

 # assuming that webvip are the group with full access?
 http_access allow webvip

 # your long list of per-site group check ACLs go here
 ...

 # this is where defining the LAN ranges correctly comes in.
 # note that users have authenticated simply to get near here
 http_access allow localnet
 http_access deny all
&quot;


4) consider an upgrade to Squid 3.4+. The &quot;notes&quot; ACL type offers much
more efficient ACL testing with a custom group lookup helper. The all-of
and any-of ACL types can also much reduce your http_access lines.

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003175.html">[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper'	queue overload.
</A></li>
	<LI>Next message (by thread): <A HREF="003233.html">[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3189">[ date ]</a>
              <a href="thread.html#3189">[ thread ]</a>
              <a href="subject.html#3189">[ subject ]</a>
              <a href="author.html#3189">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
