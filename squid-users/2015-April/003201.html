<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid downloading huge amounts of un-requested data
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20downloading%20huge%20amounts%20of%20un-requested%0A%20data&In-Reply-To=%3C55363C08.5080801%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003136.html">
   <LINK REL="Next"  HREF="003127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid downloading huge amounts of un-requested data</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20downloading%20huge%20amounts%20of%20un-requested%0A%20data&In-Reply-To=%3C55363C08.5080801%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid downloading huge amounts of un-requested data">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Apr 21 12:01:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003136.html">[squid-users] Squid downloading huge amounts of un-requested	data
</A></li>
        <LI>Next message (by thread): <A HREF="003127.html">[squid-users] squid with outlook and other applications
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3201">[ date ]</a>
              <a href="thread.html#3201">[ thread ]</a>
              <a href="subject.html#3201">[ subject ]</a>
              <a href="author.html#3201">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/04/2015 12:51 p.m., iridium191 wrote:
&gt;<i> Thanks for your response Amos, it is much appreciated. 
</I>&gt;<i> The config is below, with comments excluded - we've done tests in the past
</I>&gt;<i> to confirm it is not an open proxy and don't believe it is. Any commnts you
</I>&gt;<i> may have would also be appreciated.
</I>&gt;<i> The past excessive download events correlated with Microsoft patch Tuesdays
</I>&gt;<i> or in the most recent case deploying a new Windows server and then manually
</I>&gt;<i> updating it, which made us suspect that our refresh rules attempting to
</I>&gt;<i> cache Windows updates was the cause of the problem.
</I>&gt;<i> 
</I>&gt;<i> In the config squidguard should be bypassed for Windows updates and
</I>&gt;<i> squidclamav uses its own whitelist to bypass Windows update sites.
</I>
Okay. Noted, and confirmed by the below config.

&gt;<i> 
</I>&gt;<i> Our traffic monitoring so far has been aggregated, so we could see that
</I>&gt;<i> 103GB of http traffic was directed to the squid server from the firewall,
</I>&gt;<i> and of that 15GB came from Microsoft, 12GB from akamai server 1 etc.. You're
</I>&gt;<i> right we didn't consider that something other than squid on the server may
</I>&gt;<i> be causing the requests.
</I>&gt;<i> 
</I>
Now that you mention clamav ... I had some issues on my own proxies a
while back where the freshclam auto-update daemon had partially crashed
and on resume was unable to validate the AV updates properly. That
pushed it into a loop of re-downloading the entire virus signatures file
every few minutes - while the file was only a few dozen KB the constant
repeating grew to many GBs over the course of the month before it was
caught.



&gt;<i> The cache utilization report looks interesting in that we may be able to
</I>&gt;<i> script it for more real-time notification of excessive traffic rather than
</I>&gt;<i> relying on the morning firewall report. Are there any definitions of the
</I>&gt;<i> various counters, eg client_http.kbytes_in, client_http.kbytes_in ?
</I>
Not that I'm aware of. They should be self-explanatory from the naming
though.

client_http.kbytes_in -&gt; KB received in to Squid from all clients using
HTTP protocol.


The section headers explain how long a time period the counters below it
cover (5min, 60min, totals since last restart, etc).

&gt;<i> 
</I>&gt;<i> Thanks again,
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280                # http-mgmt
</I>&gt;<i> acl Safe_ports port 488                # gss-http
</I>&gt;<i> acl Safe_ports port 591                # filemaker
</I>&gt;<i> acl Safe_ports port 777                # multiling http
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl ftp proto FTP
</I>&gt;<i> 
</I>&gt;<i> acl manager url_regex -i ^cache_<A HREF="object://">object://</A> /squid-internal-mgr/
</I>&gt;<i> acl Purge method PURGE
</I>&gt;<i> 
</I>&gt;<i> acl Local_Networks src 10.250.111.0/24 10.250.112.0/24
</I>&gt;<i> acl BypassCache dst 10.250.111.0/24 10.250.112.0/24
</I>&gt;<i> acl BypassCache dst 146.178.211.0/24
</I>&gt;<i> 
</I>&gt;<i> acl BypassCacheDomains dstdomain &quot;/etc/squid3/BypassCacheDomains&quot;
</I>&gt;<i> acl RestrictedUsers proxy_auth &quot;/etc/squid3/RestrictedUsers&quot;
</I>&gt;<i> 
</I>&gt;<i> # ACLs for Windows Updates &amp; other exceptions
</I>&gt;<i> acl WindowsUpdate dstdomain &quot;/etc/squid3/WindowsUpdate&quot;
</I>&gt;<i> acl Whitelist_Domains dstdomain &quot;/etc/squid3/Whitelist_Domains&quot;
</I>&gt;<i> 
</I>&gt;<i> # ACL to allow monitoring of entire proxy chain from 10.250.111.124 without
</I>&gt;<i> authentication 
</I>&gt;<i> acl MonitorProxy src 10.250.111.124/32
</I>&gt;<i> 
</I>&gt;<i> acl Get_Username proxy_auth REQUIRED
</I>
The above ACL is unused and does nothing.

&gt;<i> 
</I>&gt;<i> # Bypass squidguard for whitelisted domains
</I>&gt;<i> redirector_access deny Whitelist_Domains
</I>&gt;<i> redirector_access deny WindowsUpdate
</I>&gt;<i> # Bypass squidguard for local sites 
</I>&gt;<i> redirector_access deny BypassCache
</I>&gt;<i> redirector_access deny BypassCacheDomains
</I>&gt;<i> 
</I>&gt;<i> # Bypass connections to local network and TLS
</I>&gt;<i> always_direct allow BypassCache
</I>
always_direct does not seem to do what you think it does. All it does is
prevent Squid using a cache_peer to service those requests. They are
still proxied by *this* Squid.

&gt;<i> cache deny BypassCache
</I>&gt;<i> always_direct allow BypassCacheDomains
</I>&gt;<i> cache deny BypassCacheDomains
</I>&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access allow localhost Purge
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny Purge
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> http_access deny !Local_Networks
</I>&gt;<i> http_access allow Whitelist_Domains
</I>&gt;<i> http_access allow WindowsUpdate
</I>&gt;<i> http_access allow MonitorProxy
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> # Allow connection to HTTPS sites from the local network
</I>&gt;<i> http_access allow CONNECT SSL_ports Local_Networks
</I>&gt;<i> http_access allow ftp
</I>&gt;<i> http_access allow !RestrictedUsers
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 8080
</I>&gt;<i> visible_hostname Squid3
</I>&gt;<i> hierarchy_stoplist cgi-bin ?
</I>&gt;<i> 
</I>&gt;<i> # Log file locations
</I>&gt;<i> access_log daemon:/var/log/squid3/access.log squid
</I>&gt;<i> cache_store_log none
</I>&gt;<i> cache_log /var/log/squid3/cache.log
</I>&gt;<i> 
</I>&gt;<i> # Disk cache directory.
</I>&gt;<i> cache_dir aufs /squid_cache/Squid3Cache 25000 16 256
</I>&gt;<i> cache_mem 2000 MB
</I>&gt;<i> maximum_object_size_in_memory 1 MB
</I>&gt;<i> 
</I>&gt;<i> # Windows Update
</I>&gt;<i> #range_offset_limit 200 MB WindowsUpdate 
</I>&gt;<i> maximum_object_size 1 GB
</I>&gt;<i> #quick_abort_min -1
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 127.0.0.1
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_send_client_username on
</I>&gt;<i> icap_client_username_encode off
</I>&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i> icap_service service_req reqmod_precache bypass=0
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i> adaptation_access service_req allow all
</I>&gt;<i> icap_service service_resp respmod_precache bypass=0
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i> adaptation_access service_resp allow all
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>&gt;<i> url_rewrite_children 20 startup=0 idle=1 concurrency=0
</I>&gt;<i> 
</I>&gt;<i> #Do not show client IP address
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for off
</I>&gt;<i> 
</I>&gt;<i> #Rules to anonymize http headers
</I>&gt;<i> request_header_access Allow allow all
</I>&gt;<i> request_header_access Authorization allow all
</I>&gt;<i> request_header_access WWW-Authenticate allow all
</I>&gt;<i> request_header_access Proxy-Authorization allow all
</I>&gt;<i> request_header_access Proxy-Authenticate allow all
</I>&gt;<i> request_header_access Content-Encoding allow all
</I>&gt;<i> request_header_access Content-Length allow all
</I>&gt;<i> request_header_access Content-Type allow all
</I>&gt;<i> request_header_access Date allow all
</I>&gt;<i> request_header_access Expires allow all
</I>&gt;<i> request_header_access Host allow all
</I>&gt;<i> request_header_access If-Modified-Since allow all
</I>&gt;<i> request_header_access Last-Modified allow all
</I>&gt;<i> request_header_access Location allow all
</I>&gt;<i> request_header_access Pragma allow all
</I>&gt;<i> request_header_access Accept allow all
</I>&gt;<i> request_header_access Accept-Charset allow all
</I>&gt;<i> request_header_access Accept-Encoding allow all
</I>&gt;<i> request_header_access Accept-Language allow all
</I>&gt;<i> request_header_access Content-Language allow all
</I>&gt;<i> request_header_access Mime-Version allow all
</I>&gt;<i> request_header_access Retry-After allow all
</I>&gt;<i> request_header_access Title allow all
</I>&gt;<i> request_header_access Connection allow all
</I>&gt;<i> request_header_access Proxy-Connection allow all
</I>&gt;<i> request_header_access Cookie allow all
</I>&gt;<i> ###request_header_access All deny all
</I>

These ones are response-only headers and you can remove from the list:
 Last-Modified, Location, Retry-After, Date, WWW-Authenticate,
Proxy-Authenticate, Expires

I recommend adding the Expect, ETag, TE, Transfer-Encoding, If-Match,
If-None-Match, If-Unmodified-Since, Range and If-Range headers to the
above allow lists. That will allow HTTP/1.1 persistent connections and
revalidations to work a lot better.

Come to think of it the Range/If-Range and ETag not being allowed is
probably related to your problem.

You can remove Proxy-Connection. Its an obsolete header Squid does not
emit. Mime-Version and Title are also pretty useless unless you have
WebDAV clients.

Accept-Charset and Accept-Language are not commonly useful and have a
large impact on anonymity. Removing them from your allow list could be
beneficial.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003136.html">[squid-users] Squid downloading huge amounts of un-requested	data
</A></li>
	<LI>Next message (by thread): <A HREF="003127.html">[squid-users] squid with outlook and other applications
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3201">[ date ]</a>
              <a href="thread.html#3201">[ thread ]</a>
              <a href="subject.html#3201">[ subject ]</a>
              <a href="author.html#3201">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
