<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] WARNING: Tos value ... adjusted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20WARNING%3A%20Tos%20value%20...%20adjusted&In-Reply-To=%3C553884B3.9010809%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003219.html">
   <LINK REL="Next"  HREF="003238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] WARNING: Tos value ... adjusted</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20WARNING%3A%20Tos%20value%20...%20adjusted&In-Reply-To=%3C553884B3.9010809%40treenet.co.nz%3E"
       TITLE="[squid-users] WARNING: Tos value ... adjusted">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr 23 05:35:47 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003219.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
        <LI>Next message (by thread): <A HREF="003238.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3225">[ date ]</a>
              <a href="thread.html#3225">[ thread ]</a>
              <a href="subject.html#3225">[ subject ]</a>
              <a href="author.html#3225">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/04/2015 9:14 a.m., Nick Rogers wrote:
&gt;<i> After upgrading from 3.4.x to 3.5.x, I've noticed a new error message with
</I>&gt;<i> my squid configuration. Apparently squid 3.5 no longer allows setting the
</I>&gt;<i> two lower-most ECN bits of the ToS byte.
</I>
Allowing it and leaving it up to admin was causing too much confusion
over mysteriously dropped traffic.

Attempts to bit-shift values were not backward compatible. So instead we
opted to take a bitmask hex value as the TOS parameter and explicitly
forbid with warning the ECN bits being set in that mask.


&gt;<i> I realize that this is to
</I>&gt;<i> encourage people to use the modernized definition of ToS being a 6 bit DSCP
</I>&gt;<i> field and a two bit ECN field, however enforcing this in the configuration
</I>&gt;<i> parser introduces a big problem for me. I use the ToS byte as a way to tag
</I>&gt;<i> outbound requests from squid based on ACLs, to then queue the traffic
</I>&gt;<i> differently via PF + ALTQ engine on FreeBSD. This is a way to queue upload
</I>&gt;<i> traffic from squid on a per-IP/ACL basis. Having 256 values (8 bit ToS) to
</I>&gt;<i> work with is a lot preferable than only 64 (6 bit DSCP field). I'm not sure
</I>&gt;<i> if I care if the ECN bits are set, as it is likely scrubbed away by my
</I>&gt;<i> upstream ISP,
</I>
ECN is an end-to-end property of the packets. It does not get scrubbed
away. Your ISP probably uses MPLS these days, so these packets existing
your network with ECN set cause your network to be marked as a congested
zone - any packets going from another congested network to yours get
*dropped* until the congestion in one of the networks gets resolved. It
can also trigger nasty actions such as TCP throttling on the other end
of the connection.

NP: Do you find your ISP service is &quot;a little shitty&quot; with packet loss
and traffic slowing down occasionally? ECN and/or ICMP congestion
control breakage is often the cause. Could be self-inflicted.


&gt;<i> or I can normalize it with PF. The point is I really need to
</I>&gt;<i> be able to tag outgoing packets with the full 8 bits of the ToS byte, not
</I>&gt;<i> just 6. I've been doing this for nearly a decade since early squid 2.x.
</I>&gt;<i> 
</I>&gt;<i> So my question is, is the squid team willing to revert this change
</I>&gt;<i> entirely, and leave it up to the admin to decide what ToS values are
</I>&gt;<i> appropriate. Or are you guys now pretty adamant about never setting the ECN
</I>&gt;<i> field?
</I>
ECN is pretty standard these days. Any casual update or upgrade to the
machine software, hardware, or configuration anywhere in the network(s)
it communicates over could result in unwanted traffic loss or worse
behaviour.

If you are in the practice of using those bits in the TOS value you are
of course free to patch the mask removal yourself, but we wont be
publishing new versions of Squid that touch the ECN bits - ie. not while
IPv4 is still in wide use.

IPv6 handles DSCP+ECN better and is artificially limited by this. But we
feel that is justified temporarily to avoid confusion and problems when
mapping DSCP between IPv4 and IPv6 traffic.


&gt;<i> 
</I>&gt;<i> It looks like the change got snuck into this commit along with fixing some
</I>&gt;<i> other tcp outgoing tos bugs. It really caught me off-guard because there is
</I>&gt;<i> no mention of this new behavior in the changelog.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/commit/651ba437462fb5fde21f8d3b66d09afa1e069d5c">https://github.com/squid-cache/squid/commit/651ba437462fb5fde21f8d3b66d09afa1e069d5c</A>
</I>&gt;<i> 
</I>
The TOS directives have always been documented as being for the
DiffServ/DSCP values. The only reason they ever allowed those ECN bits
to be set in the first place is that they pre-date ECNs existence.

Sorry that we missed out the documentation update mentioning that
change. A note is going in now.


&gt;<i> The enforcement happens in src/cache_cf.cc. Its 5 lines of code that seem
</I>&gt;<i> trivial to either remove or make configurable, however I am not sure how to
</I>&gt;<i> go about making it configurable. I am debating just patching my squid
</I>&gt;<i> builds to remove the check against the ToS field, but I would like to use
</I>&gt;<i> unmodified squid 3.5.x. I'm not sure if going from 256 to 64 possible
</I>&gt;<i> fields is possible for my deployments.
</I>
It better be. Any software not supporting ECN will have problems
operating over VPN, IPSEC or MLPS.

NOTE: We have the NETMASK feature made available on Linux now for
systems that need large numbers of packet flow tag values within the
local machine. I'm not aware of any equivalent on non-Linux systems, but
if they exist in PF (other than setting the TOS bits) then we are open
to supporting that.

Amos



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003219.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
	<LI>Next message (by thread): <A HREF="003238.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3225">[ date ]</a>
              <a href="thread.html#3225">[ thread ]</a>
              <a href="subject.html#3225">[ subject ]</a>
              <a href="author.html#3225">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
