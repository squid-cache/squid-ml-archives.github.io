<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5Bsquid%20%5D%20externalAclLookup%3A%20%27wbinfo_group_helper%27%0A%20queue%20overload.&In-Reply-To=%3CCA%2B8bHvzhgS%3D-u5zx1a82uWk0jC62qS1HmaUoawn7eW1W43ZHfA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003189.html">
   <LINK REL="Next"  HREF="003176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.</H1>
    <B>Jagannath Naidu</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5Bsquid%20%5D%20externalAclLookup%3A%20%27wbinfo_group_helper%27%0A%20queue%20overload.&In-Reply-To=%3CCA%2B8bHvzhgS%3D-u5zx1a82uWk0jC62qS1HmaUoawn7eW1W43ZHfA%40mail.gmail.com%3E"
       TITLE="[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.">jagannath.naidu at fosteringlinux.com
       </A><BR>
    <I>Thu Apr 23 09:41:09 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003189.html">[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.
</A></li>
        <LI>Next message (by thread): <A HREF="003176.html">[squid-users] Odp: Re:  ACLs work in a half
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3233">[ date ]</a>
              <a href="thread.html#3233">[ thread ]</a>
              <a href="subject.html#3233">[ subject ]</a>
              <a href="author.html#3233">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

regrets, I am late.

On 21 April 2015 at 09:15, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 20/04/2015 7:31 p.m., Jagannath Naidu wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am having this issue very frequently. Please help on this.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I get these errors randomly, mostly when usage is at very peak. (800
</I>&gt;<i> users)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; /var/log/squid/cache.log
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2015/04/20 12:37:40| externalAclLookup: 'wbinfo_group_helper' queue
</I>&gt;<i> &gt; overload (ch=0x7fc99e2ce518)
</I>&gt;<i>
</I>&gt;<i> What do you think &quot;overload&quot; means?
</I>&gt;<i>  The helper is unable to cope with the traffic load being passed to it.
</I>&gt;<i>
</I>&gt;<i> Here is the biggest hint:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; in /var/log/messages,  I get the following errors
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; pr 20 12:59:15 GGNPROXY01 winbindd[1910]:   winbindd: Exceeding 200
</I>&gt;<i> client
</I>&gt;<i> &gt; connections, no idle connection found
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Then squid stops working. For squid to start work again, I have to dlete
</I>&gt;<i> &gt; the cache and restart the squid &quot;squid -k reconfigure&quot;, and then squid
</I>&gt;<i> &gt; restart.
</I>&gt;<i>
</I>&gt;<i> What Squid version are you using?
</I>&gt;<i>
</I>&gt;<i> my squid version  squid-3.1.10-19.el6_4.x86_64
</I>


&gt;<i> &gt;
</I>&gt;<i> &gt; squid.conf
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; max_filedesc 17192
</I>&gt;<i> &gt; acl manager proto cache_object
</I>&gt;<i> &gt; acl localhost src 172.16.50.61/24
</I>&gt;<i>
</I>&gt;<i> changed to &quot;acl localhost src 172.16.50.6*1*&quot; already
</I>

&gt;<i> You have an entire /24 (256 IPs) assigned to this machine?
</I>&gt;<i>
</I>&gt;<i> I think you need to remove that &quot;/24&quot; part if the *.61 is the local
</I>&gt;<i> machines *public* IP.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow manager localhost
</I>&gt;<i> &gt; dns_nameservers 172.16.3.34 10.1.2.91
</I>&gt;<i> &gt; acl allowips src 172.16.58.187 172.16.16.192 172.16.58.113 172.16.58.63
</I>&gt;<i> &gt; 172.16.58.98 172.16.60.244 172.16.58.165 172.16.58.157
</I>&gt;<i> &gt; http_access allow allowips
</I>&gt;<i>
</I>&gt;<i> &gt; auth_param basic realm Squid proxy-caching web server
</I>&gt;<i> &gt; auth_param basic credentialsttl 2 hours external_acl_type nt_group ttl=0
</I>&gt;<i> &gt; children=60 %LOGIN /usr/lib64/squid/wbinfo_group.pl
</I>&gt;<i>
</I>&gt;<i> The above two very mangled config lines are useless. Remove them.
</I>&gt;<i>
</I>&gt;<i> &gt; acl localnet src 172.16.0.0/24
</I>&gt;<i>
</I>

changed


&gt;<i> Its a bit strange that none of the localhost machine IPs
</I>&gt;<i> (172.16.50.0-172.16.50.255) are part of the LAN its plugged into
</I>&gt;<i> 172.16.0.0-172.16.0.255.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl localnet src fc00::/7 # RFC 4193 local private network range
</I>&gt;<i> &gt; acl localnet src fe80::/10 # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> &gt; auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> &gt; --helper-protocol=squid-2.5-ntlmssp --domain=HTMEDIA.NET
</I>&gt;<i>
</I>&gt;<i> Okay you have configured NTLM...
</I>&gt;<i>
</I>&gt;<i> &gt; auth_param ntlm program /usr/bin/ntlm_auth
</I>&gt;<i> &gt; --helper-protocol=squid-2.5-ntlmssp --domain=HTMEDIA.NET
</I>&gt;<i>
</I>&gt;<i> ... but twice. With different settings. Only these last ones will have
</I>&gt;<i> any effect.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; auth_param ntlm children 600
</I>&gt;<i> &gt; auth_param ntlm keep_alive off
</I>&gt;<i>
</I>&gt;<i> &gt; auth_param negotiate children 150
</I>&gt;<i> &gt; auth_param negotiate keep_alive off
</I>&gt;<i> &gt; visible_hostname GGNPROXY01.HTMEDIA.NET
</I>&gt;<i> &gt; external_acl_type wbinfo_group_helper ttl=0 children=40 %LOGIN
</I>&gt;<i> &gt; /usr/lib64/squid/wbinfo_group.pl -d
</I>&gt;<i> &gt; auth_param negotiate keep_alive off
</I>&gt;<i>
</I>&gt;<i> You have several useless configuration lines for Negotiate auth which is
</I>&gt;<i> not being used in any way. Remove those.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl Safe_ports port 8080 #https
</I>&gt;<i> &gt; acl SSL_ports port 443
</I>&gt;<i> &gt; acl Safe_ports port 80          # http
</I>&gt;<i> &gt; acl Safe_ports port 21          # ftp
</I>&gt;<i> &gt; acl Safe_ports port 443 # https
</I>&gt;<i> &gt; acl Safe_ports port 70          # gopher
</I>&gt;<i> &gt; acl Safe_ports port 210         # wais
</I>&gt;<i> &gt; acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> &gt; acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> &gt; acl Safe_ports port 488         # gss-http
</I>&gt;<i> &gt; acl Safe_ports port 591         # filemaker
</I>&gt;<i> &gt; acl Safe_ports port 777         # multiling http
</I>&gt;<i> &gt; acl CONNECT method CONNECT
</I>&gt;<i> &gt; acl auth proxy_auth REQUIRED
</I>&gt;<i> &gt; acl google dstdomain -i &quot;/etc/squid/google_site.com&quot;
</I>&gt;<i> &gt; http_access allow google
</I>&gt;<i> &gt; acl sq1 external wbinfo_group_helper &quot;/etc/squid/HT/sq1&quot;
</I>&gt;<i> &gt; acl sq2 external wbinfo_group_helper &quot;/etc/squid/HT/sq2&quot;
</I>&gt;<i> &gt; acl sq3 external wbinfo_group_helper &quot;/etc/squid/HT/sq3&quot;
</I>&gt;<i> &gt; acl sq4 external wbinfo_group_helper &quot;/etc/squid/HT/sq4&quot;
</I>&gt;<i> &gt; acl sq5 external wbinfo_group_helper &quot;/etc/squid/HT/sq5&quot;
</I>&gt;<i> &gt; acl pro1 external wbinfo_group_helper &quot;/etc/squid/HT/pro1&quot;
</I>&gt;<i> &gt; acl pro2 external wbinfo_group_helper &quot;/etc/squid/HT/pro2&quot;
</I>&gt;<i> &gt; acl pro3 external wbinfo_group_helper &quot;/etc/squid/HT/pro3&quot;
</I>&gt;<i> &gt; acl pro4 external wbinfo_group_helper &quot;/etc/squid/HT/pro4&quot;
</I>&gt;<i> &gt; acl pro5 external wbinfo_group_helper &quot;/etc/squid/HT/pro5&quot;
</I>&gt;<i> &gt; acl pro6 external wbinfo_group_helper &quot;/etc/squid/HT/pro6&quot;
</I>&gt;<i> &gt; acl webvip external wbinfo_group_helper &quot;/etc/squid/HT/webvip&quot;
</I>&gt;<i> &gt; acl allgroup external wbinfo_group_helper &quot;/etc/squid/HT/allgreop&quot;
</I>&gt;<i> &gt; acl restricted external wbinfo_group_helper &quot;/etc/squid/HT/restricted&quot;
</I>&gt;<i> &gt; acl ad_auth proxy_auth REQUIRE
</I>&gt;<i>
</I>&gt;<i> You already have an ACL named &quot;auth&quot; which performs authentication.
</I>&gt;<i> The above line is not useful. Remove it and replace all uses of
</I>&gt;<i> &quot;ad_auth&quot; ACL with &quot;auth&quot; ACL.
</I>&gt;<i>
</I>&gt;<i> &gt; acl allowwebsites dstdomain -i &quot;/blacklists/allowedwebsite/domains&quot;
</I>&gt;<i> &gt; acl allowwebsites_url url_regex -i &quot;/blacklists/allowedwebsite/url&quot;
</I>&gt;<i> &gt; http_access allow allowwebsites
</I>&gt;<i> &gt; http_access allow allowwebsites_url
</I>&gt;<i> &gt; acl shopping dstdomain -i &quot;/etc/squid/shopping.txt&quot;
</I>&gt;<i> &gt; acl social_networking dstdomain -i &quot;/blacklists/social/social.networking&quot;
</I>&gt;<i> &gt; acl youtube dstdomain -i .youtube.com
</I>&gt;<i> &gt; http_access allow Safe_ports pro1 pro2 pro3 pro4 pro5 pro6 webvip
</I>&gt;<i>
</I>&gt;<i> Incorrect use of &quot;Safe_ports&quot; security check. Correct usage is to deny
</I>&gt;<i> access to all *unsafe* ports. They are unsafe because HTTP can be
</I>&gt;<i> smuggled within the ports native protocol to attack your proxy.
</I>&gt;<i>
</I>&gt;<i> Once the correct security protections for Safe_port and CONNECT tunnels
</I>&gt;<i> have been moved up the top remove the &quot;Safe_ports&quot; check from this line.
</I>&gt;<i>
</I>&gt;<i> This line is also very odd in another way. ACL tests in a single line
</I>&gt;<i> are AND'ed together - so this means the request must be from a user who is:
</I>&gt;<i>   authenticated AND a member of group pro1 AND pro2 AND pro3 AND pro4
</I>&gt;<i> AND pro5 AND pro6 AND webvip
</I>&gt;<i>
</I>&gt;<i> This hints at what your main helper problem is. The above line requires
</I>&gt;<i> 7 group helper lookups *per request*. The winbind helper has a maximum
</I>&gt;<i> of 200 simultaneous connections. This line alone will limit your proxy
</I>&gt;<i> just under 30 new visitors per second (that becomes 60 lookups/sec
</I>&gt;<i> before queue overload).
</I>&gt;<i>  The helper result caching will help a lot, but you also have a LOT of
</I>&gt;<i> other group checks being made and 800 users.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow youtube pro5
</I>&gt;<i> &gt; http_access allow youtube pro6
</I>&gt;<i> &gt; http_access allow youtube webvip
</I>&gt;<i> &gt; http_access deny youtube
</I>&gt;<i> &gt; http_access allow shopping pro5
</I>&gt;<i> &gt; http_access allow shopping pro6
</I>&gt;<i> &gt; http_access allow shopping webvip
</I>&gt;<i> &gt; http_access deny shopping
</I>&gt;<i>
</I>&gt;<i> Optimization hint:
</I>&gt;<i>  &quot;youtube&quot; and &quot;shopping&quot; have the same allow/deny criteria. It would be
</I>&gt;<i> worth combining them into one ACL.
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow social_networking pro2
</I>&gt;<i> &gt; http_access allow social_networking pro4
</I>&gt;<i> &gt; http_access allow social_networking pro6
</I>&gt;<i> &gt; http_access allow social_networking webvip
</I>&gt;<i> &gt; http_access deny social_networking
</I>&gt;<i> &gt; acl porn_site1   dstdomain &quot;/etc/squid/blacklists/porn/domains.txt&quot;
</I>&gt;<i> &gt; acl porn_site2   dstdom_regex -i &quot;/etc/squid/blacklists/porn/expressions&quot;
</I>&gt;<i> &gt; acl porn_site3   dstdom_regex -i &quot;/etc/squid/blacklists/porn/urls.txt&quot;
</I>&gt;<i> &gt; acl audio_video1   dstdomain &quot;/etc/squid/blacklists/audio-video/urls.txt&quot;
</I>&gt;<i> &gt; ###################### THERE ARE TOO MANY acls and http_access , so not
</I>&gt;<i> &gt; bothering with vast linux
</I>&gt;<i>
</I>&gt;<i> I will bet a lot of those ACLs are also calling the group helper too yes?
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow liquorinfo webvip
</I>&gt;<i> &gt; http_access deny liquorinfo
</I>&gt;<i> &gt; http_access allow ad_auth
</I>&gt;<i> &gt; http_access allow auth
</I>&gt;<i>
</I>&gt;<i> Once you have removed ad_auth ACL, this becomes:
</I>&gt;<i>  http_access allow auth
</I>&gt;<i>  http_access allow auth
</I>&gt;<i>
</I>&gt;<i> I hope you can see how redundant that is.
</I>&gt;<i>
</I>&gt;<i> Also, its very likely that the &quot;allow auth&quot; is a useless operation after
</I>&gt;<i> a great many group checks have also performed authentication. That &quot;TOO
</I>&gt;<i> MANY acls and https_access&quot; list you omitted will be needed to determine
</I>&gt;<i> that.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow sq1 sq2
</I>&gt;<i> &gt; acl NTLMUsers proxy_auth REQUIRED
</I>&gt;<i>
</I>&gt;<i> You already have an ACL named &quot;auth&quot; which performs authentication.
</I>&gt;<i> The above line is not being used in any way. Remove it.
</I>&gt;<i>
</I>&gt;<i> &gt; http_access deny !Safe_ports
</I>&gt;<i> &gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> These are basic security protection against Denial of Service and other
</I>&gt;<i> types of protocol smuggling attacks. They only work when they are used
</I>&gt;<i> *above* your custom &quot;allow&quot; rules.
</I>&gt;<i>
</I>&gt;<i> Move these two lines above your &quot;http_access allow google&quot; line.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_port 8080
</I>&gt;<i> &gt; hierarchy_stoplist cgi-bin ?
</I>&gt;<i>
</I>&gt;<i> The above line is not useful these days. Remove it.
</I>&gt;<i>
</I>&gt;<i> &gt; cache_effective_user squid
</I>&gt;<i> &gt; cache_dir aufs /var/spool/squid 20384 32 512
</I>&gt;<i> &gt; cache_mem 50 MB
</I>&gt;<i> &gt; cache_replacement_policy heap LFUDA
</I>&gt;<i> &gt; cache_swap_low 85
</I>&gt;<i> &gt; cache_swap_high 95
</I>&gt;<i> &gt; maximum_object_size 5 MB
</I>&gt;<i> &gt; maximum_object_size_in_memory 50 KB
</I>&gt;<i> &gt; ipcache_size 5240
</I>&gt;<i> &gt; ipcache_low 90
</I>&gt;<i> &gt; ipcache_high 95
</I>&gt;<i> &gt; cache_mgr amit
</I>&gt;<i> &gt; acl SSL_ports port 443
</I>&gt;<i>
</I>&gt;<i> The above is a duplicate config line. Remove it.
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow CONNECT SSL_ports
</I>&gt;<i> &gt; coredump_dir /var/spool/squid
</I>&gt;<i> &gt; refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> &gt; refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> &gt; refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> &gt; refresh_pattern .               0       20%     4320
</I>&gt;<i> &gt; url_rewrite_program /usr/local/bin/squidGuard -c
</I>&gt;<i> &gt; /usr/local/squidGuard/squidGuard.conf
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now, as to solving your problem:
</I>&gt;<i>
</I>&gt;<i> 1) Clean up your config. Reduce the amount of redundant or unused
</I>&gt;<i> things. I've mentioned a few above.
</I>&gt;<i>
</I>&gt;<i> 2) Run &quot;squid -k parse&quot; and fix any other problems it highlights.
</I>&gt;<i>
</I>&gt;<i> 3) optimize your ACls and http_access rules. I've mentioned a few, such
</I>&gt;<i> as moving the main security checks to the top so DoS traffic does not
</I>&gt;<i> put load on the helpers and other ACLs.
</I>&gt;<i>
</I>&gt;<i> I believe though that you will probably find Squid works much better
</I>&gt;<i> having the following access controls pattern:
</I>&gt;<i> &quot;
</I>&gt;<i>  http_access deny !Safe_ports
</I>&gt;<i>  http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i>  # if they are not authenticated, they will not be in a group
</I>&gt;<i>  http_access deny !auth
</I>&gt;<i>
</I>&gt;<i>  # assuming that webvip are the group with full access?
</I>&gt;<i>  http_access allow webvip
</I>&gt;<i>
</I>&gt;<i>  # your long list of per-site group check ACLs go here
</I>&gt;<i>  ...
</I>&gt;<i>
</I>&gt;<i>  # this is where defining the LAN ranges correctly comes in.
</I>&gt;<i>  # note that users have authenticated simply to get near here
</I>&gt;<i>  http_access allow localnet
</I>&gt;<i>  http_access deny all
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 4) consider an upgrade to Squid 3.4+. The &quot;notes&quot; ACL type offers much
</I>&gt;<i> more efficient ACL testing with a custom group lookup helper. The all-of
</I>&gt;<i> and any-of ACL types can also much reduce your http_access lines.
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


Thank you Amos, I will check and will update the list.


-- 
Thanks &amp; Regards

B Jagannath
Keen &amp; Able Computers Pvt. Ltd.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150423/4e7744c9/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150423/4e7744c9/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003189.html">[squid-users] [squid ] externalAclLookup: 'wbinfo_group_helper' queue overload.
</A></li>
	<LI>Next message (by thread): <A HREF="003176.html">[squid-users] Odp: Re:  ACLs work in a half
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3233">[ date ]</a>
              <a href="thread.html#3233">[ thread ]</a>
              <a href="subject.html#3233">[ subject ]</a>
              <a href="author.html#3233">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
