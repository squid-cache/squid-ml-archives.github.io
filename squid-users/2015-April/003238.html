<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] WARNING: Tos value ... adjusted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20WARNING%3A%20Tos%20value%20...%20adjusted&In-Reply-To=%3CCAKOb%3DYYvg3hSmyzV9JcKiREJaiEo%3DFGpqR4OtarEnFOzhgnKGg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003225.html">
   <LINK REL="Next"  HREF="003244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] WARNING: Tos value ... adjusted</H1>
    <B>Nick Rogers</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20WARNING%3A%20Tos%20value%20...%20adjusted&In-Reply-To=%3CCAKOb%3DYYvg3hSmyzV9JcKiREJaiEo%3DFGpqR4OtarEnFOzhgnKGg%40mail.gmail.com%3E"
       TITLE="[squid-users] WARNING: Tos value ... adjusted">ncrogers at gmail.com
       </A><BR>
    <I>Thu Apr 23 18:26:40 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003225.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
        <LI>Next message (by thread): <A HREF="003244.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3238">[ date ]</a>
              <a href="thread.html#3238">[ thread ]</a>
              <a href="subject.html#3238">[ subject ]</a>
              <a href="author.html#3238">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Apr 22, 2015 at 10:35 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 23/04/2015 9:14 a.m., Nick Rogers wrote:
</I>&gt;<i> &gt; After upgrading from 3.4.x to 3.5.x, I've noticed a new error message
</I>&gt;<i> with
</I>&gt;<i> &gt; my squid configuration. Apparently squid 3.5 no longer allows setting the
</I>&gt;<i> &gt; two lower-most ECN bits of the ToS byte.
</I>&gt;<i>
</I>&gt;<i> Allowing it and leaving it up to admin was causing too much confusion
</I>&gt;<i> over mysteriously dropped traffic.
</I>&gt;<i>
</I>&gt;<i> Attempts to bit-shift values were not backward compatible. So instead we
</I>&gt;<i> opted to take a bitmask hex value as the TOS parameter and explicitly
</I>&gt;<i> forbid with warning the ECN bits being set in that mask.
</I>&gt;<i>
</I>
Can you elaborate on how you would bit-shift the values to still use the
ECN field and not cause mysterious problems. For example, using ECN bits of
00 and 11, but not 01 or 10?


&gt;<i>
</I>&gt;<i> &gt; I realize that this is to
</I>&gt;<i> &gt; encourage people to use the modernized definition of ToS being a 6 bit
</I>&gt;<i> DSCP
</I>&gt;<i> &gt; field and a two bit ECN field, however enforcing this in the
</I>&gt;<i> configuration
</I>&gt;<i> &gt; parser introduces a big problem for me. I use the ToS byte as a way to
</I>&gt;<i> tag
</I>&gt;<i> &gt; outbound requests from squid based on ACLs, to then queue the traffic
</I>&gt;<i> &gt; differently via PF + ALTQ engine on FreeBSD. This is a way to queue
</I>&gt;<i> upload
</I>&gt;<i> &gt; traffic from squid on a per-IP/ACL basis. Having 256 values (8 bit ToS)
</I>&gt;<i> to
</I>&gt;<i> &gt; work with is a lot preferable than only 64 (6 bit DSCP field). I'm not
</I>&gt;<i> sure
</I>&gt;<i> &gt; if I care if the ECN bits are set, as it is likely scrubbed away by my
</I>&gt;<i> &gt; upstream ISP,
</I>&gt;<i>
</I>&gt;<i> ECN is an end-to-end property of the packets. It does not get scrubbed
</I>&gt;<i> away. Your ISP probably uses MPLS these days, so these packets existing
</I>&gt;<i> your network with ECN set cause your network to be marked as a congested
</I>&gt;<i> zone - any packets going from another congested network to yours get
</I>&gt;<i> *dropped* until the congestion in one of the networks gets resolved. It
</I>&gt;<i> can also trigger nasty actions such as TCP throttling on the other end
</I>&gt;<i> of the connection.
</I>&gt;<i>
</I>
My understanding was something else has to happen in my TCP config for ECN
to have an effect, not simply just setting the field in the packet. For
example, in FreeBSD I have the &quot;net.inet.tcp.ecn.enable&quot; sysctl set to 0. I
guess this assumption is wrong? Thanks for clarifying.

&gt;<i>
</I>&gt;<i> NP: Do you find your ISP service is &quot;a little shitty&quot; with packet loss
</I>&gt;<i> and traffic slowing down occasionally? ECN and/or ICMP congestion
</I>&gt;<i> control breakage is often the cause. Could be self-inflicted.
</I>&gt;<i>
</I>
I haven't noticed this explicitly, as I have a few hundred deployments, all
with different ISPs, but that is not to say its not happening.


&gt;<i>
</I>&gt;<i> &gt; or I can normalize it with PF. The point is I really need to
</I>&gt;<i> &gt; be able to tag outgoing packets with the full 8 bits of the ToS byte, not
</I>&gt;<i> &gt; just 6. I've been doing this for nearly a decade since early squid 2.x.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So my question is, is the squid team willing to revert this change
</I>&gt;<i> &gt; entirely, and leave it up to the admin to decide what ToS values are
</I>&gt;<i> &gt; appropriate. Or are you guys now pretty adamant about never setting the
</I>&gt;<i> ECN
</I>&gt;<i> &gt; field?
</I>&gt;<i>
</I>&gt;<i> ECN is pretty standard these days. Any casual update or upgrade to the
</I>&gt;<i> machine software, hardware, or configuration anywhere in the network(s)
</I>&gt;<i> it communicates over could result in unwanted traffic loss or worse
</I>&gt;<i> behaviour.
</I>&gt;<i>
</I>&gt;<i> If you are in the practice of using those bits in the TOS value you are
</I>&gt;<i> of course free to patch the mask removal yourself, but we wont be
</I>&gt;<i> publishing new versions of Squid that touch the ECN bits - ie. not while
</I>&gt;<i> IPv4 is still in wide use.
</I>&gt;<i>
</I>
I understand the reasoning now. Thanks.


&gt;<i>
</I>&gt;<i> IPv6 handles DSCP+ECN better and is artificially limited by this. But we
</I>&gt;<i> feel that is justified temporarily to avoid confusion and problems when
</I>&gt;<i> mapping DSCP between IPv4 and IPv6 traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It looks like the change got snuck into this commit along with fixing
</I>&gt;<i> some
</I>&gt;<i> &gt; other tcp outgoing tos bugs. It really caught me off-guard because there
</I>&gt;<i> is
</I>&gt;<i> &gt; no mention of this new behavior in the changelog.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/commit/651ba437462fb5fde21f8d3b66d09afa1e069d5c">https://github.com/squid-cache/squid/commit/651ba437462fb5fde21f8d3b66d09afa1e069d5c</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> The TOS directives have always been documented as being for the
</I>&gt;<i> DiffServ/DSCP values. The only reason they ever allowed those ECN bits
</I>&gt;<i> to be set in the first place is that they pre-date ECNs existence.
</I>&gt;<i>
</I>&gt;<i> Sorry that we missed out the documentation update mentioning that
</I>&gt;<i> change. A note is going in now.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The enforcement happens in src/cache_cf.cc. Its 5 lines of code that seem
</I>&gt;<i> &gt; trivial to either remove or make configurable, however I am not sure how
</I>&gt;<i> to
</I>&gt;<i> &gt; go about making it configurable. I am debating just patching my squid
</I>&gt;<i> &gt; builds to remove the check against the ToS field, but I would like to use
</I>&gt;<i> &gt; unmodified squid 3.5.x. I'm not sure if going from 256 to 64 possible
</I>&gt;<i> &gt; fields is possible for my deployments.
</I>&gt;<i>
</I>&gt;<i> It better be. Any software not supporting ECN will have problems
</I>&gt;<i> operating over VPN, IPSEC or MLPS.
</I>&gt;<i>
</I>
So to clarify, squid is implicitly ECN capable, but manually overriding the
ECN field via tcp_outgoing_tos was causing problems?


&gt;<i> NOTE: We have the NETMASK feature made available on Linux now for
</I>&gt;<i> systems that need large numbers of packet flow tag values within the
</I>&gt;<i> local machine. I'm not aware of any equivalent on non-Linux systems, but
</I>&gt;<i> if they exist in PF (other than setting the TOS bits) then we are open
</I>&gt;<i> to supporting that.
</I>&gt;<i>
</I>
Yeah, I've looked into that before. Unfortunately there is nothing like
that in FreeBSD that is supported by PF that I am aware of.

Thanks for your feedback.

Amos
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150423/225febc3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150423/225febc3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003225.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
	<LI>Next message (by thread): <A HREF="003244.html">[squid-users] WARNING: Tos value ... adjusted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3238">[ date ]</a>
              <a href="thread.html#3238">[ thread ]</a>
              <a href="subject.html#3238">[ subject ]</a>
              <a href="author.html#3238">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
