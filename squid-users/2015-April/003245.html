<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Using Squid as a Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20Squid%20as%20a%20Transparent%20Proxy&In-Reply-To=%3CCAAg1D6BT%3DYfJk_hZWG%2B%3DYw7ChPxbbRx9pF6AFLBO8mC0KmP%3DZQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003366.html">
   <LINK REL="Next"  HREF="003249.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Using Squid as a Transparent Proxy</H1>
    <B>Srinath Krishna</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20Squid%20as%20a%20Transparent%20Proxy&In-Reply-To=%3CCAAg1D6BT%3DYfJk_hZWG%2B%3DYw7ChPxbbRx9pF6AFLBO8mC0KmP%3DZQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Using Squid as a Transparent Proxy">srinath.krishna at gmail.com
       </A><BR>
    <I>Fri Apr 24 02:29:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003366.html">[squid-users] squid-users Digest, Vol 8, Issue 52
</A></li>
        <LI>Next message (by thread): <A HREF="003249.html">[squid-users] Using Squid as a Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3245">[ date ]</a>
              <a href="thread.html#3245">[ thread ]</a>
              <a href="subject.html#3245">[ subject ]</a>
              <a href="author.html#3245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,

I'm trying my hands with openvswitch and squid. This is what I want to
achieve.

The client tries to connect to the server. This packet is handled through
an openvswitch and it's sent to a machine running squid for proxying. The
machine running squid sees the packet with client to server but iptables
rules help in delivering this packet up the stack. On a cache hit, squid
responds back to the client and also installs iptables rules on the fly and
hence the source IP is that of the server.

This is achieved through the following configuration in squid.conf.

http_port 3128 intercept

With this configuration however, on a cache miss case, squid uses it's IP
address as the source IP to connect to the server. What I expect is squid
to use the client's IP address to establish this new connection to the
server. From the squid.conf, I believe I need to use the tproxy mode with
the http_port directive, but I'm stumped about what iptables rules to
configure.

I'm trying to follow the steps here (
<A HREF="http://wiki.squid-cache.org/Features/Tproxy4#Feature:_TPROXY_version_4.1.2B-_Support">http://wiki.squid-cache.org/Features/Tproxy4#Feature:_TPROXY_version_4.1.2B-_Support</A>)
but no luck yet. And I don't understand why I'd need to use WCCP for
something like this.

I expect squid to use the client's IP address and the reverse traffic from
the server will make it's way to squid's box through openvswitch. All squid
has to do is install an iptable rule on the fly for the outgoing connection
to use the client's IP address and also have a corresponding reverse rule
to translate from the client's IP address to squid's IP address.

The kernel that I'm using is 3.16 and it has the nf_conntrack and xt_TPROXY
modules insmoded. Can someone help me with this?

Thanks,
Srinath
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150423/e0d15488/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150423/e0d15488/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003366.html">[squid-users] squid-users Digest, Vol 8, Issue 52
</A></li>
	<LI>Next message (by thread): <A HREF="003249.html">[squid-users] Using Squid as a Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3245">[ date ]</a>
              <a href="thread.html#3245">[ thread ]</a>
              <a href="subject.html#3245">[ subject ]</a>
              <a href="author.html#3245">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
