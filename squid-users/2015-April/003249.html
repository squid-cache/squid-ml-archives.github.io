<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Using Squid as a Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20Squid%20as%20a%20Transparent%20Proxy&In-Reply-To=%3C5539BBBB.6040001%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003245.html">
   <LINK REL="Next"  HREF="003253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Using Squid as a Transparent Proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20Squid%20as%20a%20Transparent%20Proxy&In-Reply-To=%3C5539BBBB.6040001%40treenet.co.nz%3E"
       TITLE="[squid-users] Using Squid as a Transparent Proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Apr 24 03:42:51 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003245.html">[squid-users] Using Squid as a Transparent Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003253.html">[squid-users] Using Squid as a Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3249">[ date ]</a>
              <a href="thread.html#3249">[ thread ]</a>
              <a href="subject.html#3249">[ subject ]</a>
              <a href="author.html#3249">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/04/2015 2:29 p.m., Srinath Krishna wrote:
&gt;<i> Hello all,
</I>&gt;<i> 
</I>&gt;<i> I'm trying my hands with openvswitch and squid. This is what I want to
</I>&gt;<i> achieve.
</I>&gt;<i> 
</I>&gt;<i> The client tries to connect to the server. This packet is handled through
</I>&gt;<i> an openvswitch and it's sent to a machine running squid for proxying. The
</I>&gt;<i> machine running squid sees the packet with client to server but iptables
</I>&gt;<i> rules help in delivering this packet up the stack. On a cache hit, squid
</I>&gt;<i> responds back to the client and also installs iptables rules on the fly and
</I>&gt;<i> hence the source IP is that of the server.
</I>
No. Squid has nothing to do with any of that. The kernel TPROXY module
does it all.

&gt;<i>
</I>&gt;<i> This is achieved through the following configuration in squid.conf.
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> 
</I>
&quot;intercept&quot; means NAT. Which cannot do what you are asking for.

&gt;<i> With this configuration however, on a cache miss case, squid uses it's IP
</I>&gt;<i> address as the source IP to connect to the server. What I expect is squid
</I>&gt;<i> to use the client's IP address to establish this new connection to the
</I>&gt;<i> server. From the squid.conf, I believe I need to use the tproxy mode with
</I>
Correct.

&gt;<i> the http_port directive, but I'm stumped about what iptables rules to
</I>&gt;<i> configure.
</I>
That would be the lines listed in
&lt;<A HREF="http://wiki.squid-cache.org/Features/Tproxy4#iptables_Configuration">http://wiki.squid-cache.org/Features/Tproxy4#iptables_Configuration</A>&gt;

Also, make sure that any rules in the &quot;iptable -t nat &quot; which you may
have setup for the NAT intercept configuration are removed. They *will*
break TPROXY kernel module operations.

iptables is just one of many networking layers than need configuring
though before TPROXY will work. The rest of the page explains.

&gt;<i> 
</I>&gt;<i> I'm trying to follow the steps here (
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/Tproxy4#Feature:_TPROXY_version_4.1.2B-_Support">http://wiki.squid-cache.org/Features/Tproxy4#Feature:_TPROXY_version_4.1.2B-_Support</A>)
</I>&gt;<i> but no luck yet. And I don't understand why I'd need to use WCCP for
</I>&gt;<i> something like this.
</I>
You dont. Please read the _title_ of the WCCP section again. Slowly.


&gt;<i> 
</I>&gt;<i> I expect squid to use the client's IP address and the reverse traffic from
</I>&gt;<i> the server will make it's way to squid's box through openvswitch.
</I>
You expect a lot. Behind the single tproxy flag in squid.conf the entire
routing system of your whole network has to be configured to ensure that
above &quot;expected&quot; flow is what the packets actually do.

If there is any potential path through the network where server packets
can reach the client directly without being diverted back through Squid
there will be hanging connections. The client will drop them because the
TCP connection was not client initiated.



&gt;<i> All squid
</I>&gt;<i> has to do is install an iptable rule on the fly for the outgoing connection
</I>&gt;<i> to use the client's IP address and also have a corresponding reverse rule
</I>&gt;<i> to translate from the client's IP address to squid's IP address.
</I>
That is the purpose of the TPROXY kernel module. It does all the
netfilter/firewall bits when instructed to by Squid.

&gt;<i> 
</I>&gt;<i> The kernel that I'm using is 3.16 and it has the nf_conntrack and xt_TPROXY
</I>&gt;<i> modules insmoded. Can someone help me with this?
</I>&gt;<i> 
</I>
Provided you also have a recent Squid version, built with the
appropriate components (netfilter and libcap2).

All you should need is the configuration in section 1.3, 1.5, 1.6.1, and
possibly 1.7 of that Tproxy4 wiki page.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003245.html">[squid-users] Using Squid as a Transparent Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003253.html">[squid-users] Using Squid as a Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3249">[ date ]</a>
              <a href="thread.html#3249">[ thread ]</a>
              <a href="subject.html#3249">[ subject ]</a>
              <a href="author.html#3249">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
