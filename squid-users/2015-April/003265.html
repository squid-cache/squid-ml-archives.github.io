<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Config audit for 3.5.3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Config%20audit%20for%203.5.3&In-Reply-To=%3C553AFB08.2090900%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003258.html">
   <LINK REL="Next"  HREF="003266.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Config audit for 3.5.3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Config%20audit%20for%203.5.3&In-Reply-To=%3C553AFB08.2090900%40treenet.co.nz%3E"
       TITLE="[squid-users] Config audit for 3.5.3">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Apr 25 02:25:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003258.html">[squid-users] Config audit for 3.5.3
</A></li>
        <LI>Next message (by thread): <A HREF="003266.html">[squid-users] Config audit for 3.5.3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3265">[ date ]</a>
              <a href="thread.html#3265">[ thread ]</a>
              <a href="subject.html#3265">[ subject ]</a>
              <a href="author.html#3265">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/04/2015 12:50 a.m., James Lay wrote:
&gt;<i> Hey all.
</I>&gt;<i> 
</I>&gt;<i> Topic says it....I'm running squid-3.5.3-20150420-r13802 and wanted to
</I>&gt;<i> see if there's anything glaring that I'm missing/have misconfigured.  My
</I>&gt;<i> setup is squid is running on a router, one nic external, one nic
</I>&gt;<i> internal.  This is running as a transparent proxy with iptables doing a
</I>&gt;<i> redirect to ports 3128 and 3129.  Config below:
</I>&gt;<i> 
</I>&gt;<i> #############################################################
</I>&gt;<i> acl localnet src 192.168.1.0/24
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl broken_sites dst 96.16.0.0/15
</I>&gt;<i> &lt;others redacted&gt;
</I>&gt;<i> acl broken_sites dst 54.160.0.0/12
</I>&gt;<i> acl allowed_sites url_regex &quot;/opt/etc/squid/url.txt&quot;
</I>&gt;<i> acl all_others dst all
</I>
Using &quot;dst all&quot; is very inefficient. It requires Squid to perform DNS
lookups just to answer &quot;yes&quot;. Unless there is some unusual reason
requiring that you might as well use the provided &quot;all&quot; ACL for faster
operation.


&gt;<i> acl SSL method CONNECT
</I>
This is a bit dangerous. CONNECT does not necessarily mean SSL - even
with the port 443 restriction.  CONNECT could as easily contain a tunnel
to email server and be pumping spam, or literally any other type of
traffic to any other server. Spam emails, FTP, BitTorrent, and Skype are
pretty popular protocols seen with CONNECT.

So you can easily mistake security rules about SSL and create allow
policies that make you vulnerable to some nasty attacks.

Its also a redundant ACL definition with the default CONNECT ACL earlier.

&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access allow allowed_sites
</I>&gt;<i> http_access allow broken_sites
</I>&gt;<i> 
</I>&gt;<i> http_access deny all_others 
</I>
The above being equivalent to &quot;deny all&quot; makes the below rules not do
anything. I dont know yoru policy, maybe you did.

Consider whether that is what you expected/wanted to happen.


&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> icp_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow broken_sites
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_options ALL
</I>&gt;<i> acl p3129 myportname 3129
</I>
This name &quot;3129&quot; does not match any listening port name. See below...


&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> #ssl_bump splice broken_sites
</I>&gt;<i> ssl_bump bump p3129
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.1.253:3128 intercept 
</I>
... in the absence of a name= parameter the default name for tis port is
&quot;192.168.1.253:3128&quot;.

&gt;<i> https_port 192.168.1.253:3129 intercept ssl-bump
</I>&gt;<i> cert=/opt/sslsplit/sslsplit.crt key=/opt/sslsplit/sslsplitca.key
</I>&gt;<i> cafile=/opt/sslsplit/sslsplitca.pem generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB sslflags=NO_SESSION_REUSE
</I>
... in the absence of a name= parameter the default name for tis port is
&quot;192.168.1.253:3129&quot;.

Do you see the pattern?
 set the name= parameter eplicitly or it becomes teh *string* value of
the host:port field.


&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
Has no use in your config.

&gt;<i> 
</I>&gt;<i> logformat common %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st %Ss:%
</I>&gt;<i> Sh %ssl::&gt;cert_subject
</I>
Bad: do not re-define built in format definitions please.

Either use the provided format, or use a different name if you need the
custom one.

&gt;<i> 
</I>&gt;<i> access_log syslog:daemon.info common
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (cgi-bin|\?)	0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> icp_port 3130
</I>
You are initializing ICP port, but also configured &quot;icp_access deny all&quot;.

To disble ICP leave remove the icp_* directives from your config.

To enable ICP, configure the icp_access to allow some sources to make
queries.

&gt;<i> 
</I>&gt;<i> coredump_dir /opt/var
</I>&gt;<i> #############################################################
</I>&gt;<i> 
</I>&gt;<i> My goal has been to at least get the domain logged on any https access,
</I>&gt;<i> but alas some sites show:
</I>&gt;<i> 
</I>&gt;<i> Apr 24 06:39:32 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i> [24/Apr/2015:06:39:32 -0600] &quot;CONNECT 216.58.216.162:443 HTTP/1.1&quot; 200
</I>&gt;<i> 401 TCP_TUNNEL:ORIGINAL_DST -
</I>&gt;<i> 
</I>
With interception + your custom rule using %ru you should always see
raw-IP:port. If you see a TLS SNI domain in there *that* is a bug. &quot;%ru&quot;
is explicitly asking for the client-presented CONNECT *URL*, not the
server details.


That &quot;TCP_TUNNEL&quot; will always happen whenever the protocol found on port
443 is not HTTPS.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003258.html">[squid-users] Config audit for 3.5.3
</A></li>
	<LI>Next message (by thread): <A HREF="003266.html">[squid-users] Config audit for 3.5.3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3265">[ date ]</a>
              <a href="thread.html#3265">[ thread ]</a>
              <a href="subject.html#3265">[ subject ]</a>
              <a href="author.html#3265">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
