<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid	3.4.12
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Happy%20Eyeballs%20and%20%22connect_timeout%22%20in%20squid%0A%093.4.12&In-Reply-To=%3C5540D66E.3000004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003318.html">
   <LINK REL="Next"  HREF="003328.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid	3.4.12</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Happy%20Eyeballs%20and%20%22connect_timeout%22%20in%20squid%0A%093.4.12&In-Reply-To=%3C5540D66E.3000004%40treenet.co.nz%3E"
       TITLE="[squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid	3.4.12">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 29 13:02:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003318.html">[squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid 3.4.12
</A></li>
        <LI>Next message (by thread): <A HREF="003328.html">[squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid	3.4.12
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3322">[ date ]</a>
              <a href="thread.html#3322">[ thread ]</a>
              <a href="subject.html#3322">[ subject ]</a>
              <a href="author.html#3322">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/04/2015 7:38 p.m., Tom Tom wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> I'm running squid (3.4.12) on a IPv6/IPv4-dual-stack system.
</I>&gt;<i> 
</I>&gt;<i> While accessing the test-site &quot;<A HREF="http://test.rx.td.h.labs.apnic.net">http://test.rx.td.h.labs.apnic.net</A>&quot;, I
</I>&gt;<i> encountered a 60s connection-timeout (configurable with
</I>&gt;<i> connect_timeout) while squid is making 5 IPv6-connection-attempts
</I>&gt;<i> (SYN), before it tries to connect with IPv4 (which is working on the
</I>&gt;<i> test-site). I can decrease the &quot;connect_timeout&quot;-value to 1 second.
</I>&gt;<i> This behaves in a better &quot;surf&quot;-experience and results in a 1s-timeout
</I>&gt;<i> (also only 1 IPv6-SYN) instead of the default 60s timeout.
</I>&gt;<i> 
</I>&gt;<i> Why does squid not tries to connect first IPv6 (based on the host's
</I>&gt;<i> address preference-policy) and then - in case of a failure - switch to
</I>&gt;<i> IPv4 during a 300ms timeout (like current Browsers are doing)?
</I>
Several reasons:

1) The default builds and installs do try IPv6 first in accordance with
RFC 6540. Check your config for a &quot;dns_v4_first&quot; directive which forces
IPv4 to be tried first.


2) Squid is not the OS built-in resolver. Any obeying of that policy by
Squid is purely arbitrary. The host systems DNS resolver policy does not
supposed to affect standalone resolvers such as Squids internal one.
Particularly when there are squid.conf directives overriding the
resolv.conf behaviour (eg. dns_nameservers).

dns_v4_first was a partial implementation added for
&lt;<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3086">http://bugs.squid-cache.org/show_bug.cgi?id=3086</A>&gt;.


3) when performed by middleware such as Squid the &quot;Happy Eyeballs&quot;
algorithm is heavily destructive.

A browser is consuming at minimum 2 network sockets to perform &quot;Happy
Eyeballs&quot;.

At the middlware each of those translates to potentially 3 sockets
(total 6 proxy sockets, 2 outgoing server sockets). If the middleware
were to perform &quot;Happy Eyeballs&quot; itself that would increase to 4 sockets
(total 8 proxy sockets, 4 outgoing server sockets).

A typical network connection travels through at least 2 sometimes 3
proxies when CDN are involved. With each proxy hop doubling the number
of server sockets we easily reach a total of 16 inbound sockets on the
poor backend server to deal with for each single browser connection.

Proxies and servers are already dealing with scales of 10,000 - 100,000
clients at once. Multiplying the network resource load by a factor of 8
would easily push the scale up into millions. Which is a little hard to
deal with when constrained to only 65535 ports per IP address.

Of course the browsers dont care about that because they have only a few
sockets to deal with and plenty of RAM, time, and ports. For them it was
easy.

Instead we *obey HTTP* by caching, multiplexing requests over persistent
connections, and keeping a pool of idle server connections that have
already been setup. Often that works faster than even &quot;Happy Eyeballs&quot; can.

Horror story over, we do have
&lt;<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3552">http://bugs.squid-cache.org/show_bug.cgi?id=3552</A>&gt; though as I mention
in there we need slightly different ways that work better for proxies
than the prescribed browsers server-unfriendly algorithm.

&gt;<i> 
</I>&gt;<i> Can I enforce a &quot;browser behaviour&quot; (300ms) for squid?
</I>
Nope. The big reason for this one is that the config directive is scaled
in whole seconds along with most timeouts in Squid.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003318.html">[squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid 3.4.12
</A></li>
	<LI>Next message (by thread): <A HREF="003328.html">[squid-users] Happy Eyeballs and &quot;connect_timeout&quot; in squid	3.4.12
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3322">[ date ]</a>
              <a href="thread.html#3322">[ thread ]</a>
              <a href="subject.html#3322">[ subject ]</a>
              <a href="author.html#3322">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
