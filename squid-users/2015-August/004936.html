<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Why is overlapping dstdomains a FATAL error now?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20is%20overlapping%20dstdomains%20a%20FATAL%20error%20now%3F&In-Reply-To=%3C55C42556.4080807%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004935.html">
   <LINK REL="Next"  HREF="004937.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Why is overlapping dstdomains a FATAL error now?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20is%20overlapping%20dstdomains%20a%20FATAL%20error%20now%3F&In-Reply-To=%3C55C42556.4080807%40treenet.co.nz%3E"
       TITLE="[squid-users] Why is overlapping dstdomains a FATAL error now?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug  7 03:26:14 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004935.html">[squid-users] Why is overlapping dstdomains a FATAL error now?
</A></li>
        <LI>Next message (by thread): <A HREF="004937.html">[squid-users] Why is overlapping dstdomains a FATAL error now?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4936">[ date ]</a>
              <a href="thread.html#4936">[ thread ]</a>
              <a href="subject.html#4936">[ subject ]</a>
              <a href="author.html#4936">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/08/2015 11:48 a.m., Benjamin E. Nichols wrote:
&gt;<i> Agreed, whoever decided it was a wise decision to make this a stop error
</I>&gt;<i> should be fired or at the very least, slapped in the back of the head.
</I>&gt;<i> 
</I>&gt;<i> On 8/6/2015 6:44 PM, Dan Charlesworth wrote:
</I>&gt;&gt;<i> This used to just cause a WARNING right? Is this really a good enough
</I>&gt;&gt;<i> reason to stop Squid from starting up?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2015/08/07 09:25:43| ERROR: '.ssl.gstatic.com
</I>&gt;&gt;<i> &lt;<A HREF="http://ssl.gstatic.com/">http://ssl.gstatic.com/</A>&gt;' is a subdomain of '.gstatic.com
</I>&gt;&gt;<i> &lt;<A HREF="http://gstatic.com/">http://gstatic.com/</A>&gt;'
</I>&gt;&gt;<i> 2015/08/07 09:25:43| ERROR: You need to remove '.ssl.gstatic.com
</I>&gt;&gt;<i> &lt;<A HREF="http://ssl.gstatic.com/">http://ssl.gstatic.com/</A>&gt;' from the ACL named 'cache_bypass_domains'
</I>&gt;&gt;<i> FATAL: Bungled /etc/squid/squid.conf line 149: acl
</I>&gt;&gt;<i> cache_bypass_domains dstdomain &quot;/acls/lists/8/squid_domains&#8221;
</I>&gt;&gt;<i>
</I>
It *seems* very daft. But there actually is a very good reason.

Squid stores these data into a splay tree structure as it goes. Adding
to a splay tree is a one-way operation. There is no remove short of
dumping the entire squid.conf and re-configuring.

[ just a side note: we *are* actively in the process of trying to
eradicate these splay trees and use another type of fast hash we could
remove from. ]

There are several cases for what the loaded file may contain:

A)
 .gstatic.com
 .ssl.gstatic.com

B)
 .gstatic.com
 .gstatic.com

C)
 .gstatic.com
 gstatic.com

D)
 .ssl.gstatic.com
 .gstatic.com

E)
 gstatic.com
 .gstatic.com


Cases (A, B, C) will happily go along and add .gstatic.com to the ACL.
The next one is an overlap with a more narrow matching range than
already in the tree.
 These *are* nicely displayed as WARNING, and just ignored by Squid as
it continues to run. If you put &quot;acl all src 0.0.0.0&quot; into a squid-3
config you can see that happen.


Cases (D, E) are special. The first entry already added to the ACL splay
will match *less* than the second one.
 Now the way using a splay tree works is that for any lookup one of them
will be 'closer' and thus match. But not always the same one.
 So adding both to the splay will cause domains in the non-overlap area
to randomly be blocked or allowed.
 These are what you are seeing displayed as ERROR.

So then we get back to how restarting the entire reconfigure process
from scratch is needed to remove the first entry from the splay tree.

---&gt; Doing a reconfigure will only load the same details in the same
order unless manually fixed first.

Squid must halt and wait for you to fix this. If it is left running the
config *will not* be doing what you intended Squid to do. That is FATAL.


And BTW, finding these issues in manually edited or third-party lists is
one of the reasons one should always run &quot;squid -k parse&quot; before loading
new config.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004935.html">[squid-users] Why is overlapping dstdomains a FATAL error now?
</A></li>
	<LI>Next message (by thread): <A HREF="004937.html">[squid-users] Why is overlapping dstdomains a FATAL error now?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4936">[ date ]</a>
              <a href="thread.html#4936">[ thread ]</a>
              <a href="subject.html#4936">[ subject ]</a>
              <a href="author.html#4936">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
