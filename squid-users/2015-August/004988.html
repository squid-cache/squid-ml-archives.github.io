<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to have squid as safe as (e.g.) firefox?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20have%20squid%20as%20safe%20as%20%28e.g.%29%20firefox%3F&In-Reply-To=%3C55CC33D2.6010004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004987.html">
   <LINK REL="Next"  HREF="005001.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to have squid as safe as (e.g.) firefox?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20have%20squid%20as%20safe%20as%20%28e.g.%29%20firefox%3F&In-Reply-To=%3C55CC33D2.6010004%40treenet.co.nz%3E"
       TITLE="[squid-users] How to have squid as safe as (e.g.) firefox?">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Aug 13 06:06:10 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004987.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
        <LI>Next message (by thread): <A HREF="005001.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4988">[ date ]</a>
              <a href="thread.html#4988">[ thread ]</a>
              <a href="subject.html#4988">[ subject ]</a>
              <a href="author.html#4988">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/08/2015 9:20 a.m., Jeremie Rafin wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> If I browse on the internet **without** a proxy like squid, and if I
</I>use a browser like firefox, the certificate management of SSL
connections looks, as far as I feel it, safe and secure.
&gt;<i> 
</I>
Firstly;

Technically a clean install of Squid with default options is more secure
than any browser you will be able to find.

Because it comes configured for forward-proxy. Which does not touch the
TLS traffic in any way but relays CONNECT tunnels. Inside the tunnel the
browser&lt;-&gt;server security is in operating control, which makes the Squid
relay equally secure as whatever the browser and server would agree to
without Squid.

Additionally, Squid enforces that HTTPS tunnels only go to port 443.
Which is something the browsers do not do. Making Squid better in this
one way on top of all the things the browsers do inside their tunnel.


Secondly;

 the feeling of security you have with browser is a lie. Pure &quot;security
theatre&quot;, done so well that you and billions of others can't even see it.

What you are doing is trusting a very large set of nearly a thousand CA
entities. Including most of those governments with bad reputations now
for surveillance, and a lot of corporations with agendas of their own.
For all sorts of reasons which you have no knowledge or control over.
Yes, someone has vetted that their published intentions were good to get
them into the list, but it was not you. For you and everyone else it is
almost blind trust.

At any time *one*, just one, of them could sign a faked certificate.
When that happens no user will be able to tell the difference without
detailed digging down into the browser cert information.

The only reason these things come to light at all is when the ability is
abused in obvious user-visible ways for dictatorial censorship or
malware attacks. Or the few vigilant an knowledgable people actively
seeking it out catch it in the act. Its not the CA action that was seen
first, but the abuse of power it allowed.

Thankfully the repercussions of being wiped from the global CA list are
severe enough to prevent power abuse in amost cases. But there have been
some exceptions even so.

So security threatre. Its been working so far, but only just.


&gt;<i> One of my favorite web pages to test this is:
</I>&gt;<i> <A HREF="https://revoked.grc.com/">https://revoked.grc.com/</A> Going on this site must generate an error
</I>&gt;<i> such as a &quot;revoked
</I>certificate&quot; reject.
&gt;<i> 
</I>&gt;<i> But, if I browse with squid &quot;behind&quot;, configured with SSL bumping
</I>&gt;<i> and
</I>host certificate generation (in such a way my proxy works well for
https), this site (<A HREF="https://revoked.grc.com/">https://revoked.grc.com/</A>) is **not** filtered. Which
is, to my eye, a big security hole...


For anything other than blind relay to have happened in Squid with
regards to HTTPS you have to configure it to happen. We try to make the
defaults secure in a reasonable way that works for general use. Just
like the browser people do.


You have configured certificate generation. By definition that means
that a *newly generated* certificate is being used to the browser. Not
the one that was revoked.

You have also configured &quot;sslproxy_cert_error deny all&quot; which forces
Squid to accept and ignore all possible origin server certificate
errors. Including revocation.

I hope you can see/understand the result.


&gt;<i> 
</I>&gt;<i> Questions (I am searching for answers for several months, without
</I>success):
&gt;<i> 
</I>&gt;<i> -while using squid, is it possible to have a SSL/HTTPS level of
</I>security at least as high as with a reference like firefox (assuming
this is a reference; in my humble opinion, regarding certificate
management, it is, as I don't know better)?

Yes.

&gt;<i> 
</I>&gt;<i> -do you know any implementation of NSS library (the security library
</I>of firefox, probably safer than openssl) for certificate checking helper
(cf. sslcrtvalidator_program)?
&gt;<i> 
</I>
No. Just the OpenSSL one we provide so far.

I'm still working on getting library-agnostic TLS support rolled into
Squid. But the main effort has been on the squid binary, not the helpers
yet.


&gt;<i> -how to manage certificate lists, especially automatic updates of
</I>&gt;<i> them
</I>(e.g. use of OSCP inside squid helpers)? Could we access to tweaks like
maximum acceptable age of certificate validity, white and black lists of
trust authorities, exclusion of autosigned certificate, etc?

The OSCP specifications and library documentation is the best place to
look for that kind of thing.

How the helper determines valid/invalid is intentionally outside the
squid operating scope.

Within squid itself we use the library API lookup which hides/abstracts
that detail.


&gt;<i> 
</I>&gt;<i> Thanks for any help, any suggestion! J&#233;r&#233;mie
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> PS1: some of test web pages, for which, to my mind, security fails with squid:
</I>&gt;<i> -<A HREF="https://revoked.grc.com">https://revoked.grc.com</A> (my &quot;favorite&quot;; must fail browsing)
</I>&gt;<i> -<A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> (to get a big picture, especially if OCSP stapling is active)
</I>&gt;<i> -<A HREF="https://www.howsmyssl.com/">https://www.howsmyssl.com/</A> (not as good as previous; provides another point of view)
</I>&gt;<i> 
</I>&gt;<i> PS2: my squid 3.5 works on a debian wheezy 7.6; here is my
</I>&gt;<i> squid.conf
</I>(only my adds in top of the default file content); so far I try to have
transparent (implicit) proxy but explicit proxy is not better (only
simpler configuration):
&gt;<i> 
</I>&gt;<i> # SSL bumping configuration
</I>&gt;<i> http_port 3126 intercept
</I>&gt;<i> https_port 3127 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> sslcrtd_program /usr/local/squid-3.5/lib/squid/ssl_crtd -s /var/spool/squid3_ssldb -M 4MB
</I>&gt;<i> 
</I>&gt;<i> # SSL Options - to mimic firefox; some of keys are weaks but some of my favorite websites need them :(
</I>&gt;<i> sslproxy_options NO_SSLv2,No_Compression
</I>&gt;<i> sslproxy_cipher ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-ECDSA-RC4-SHA:DHE-RSA-AES256-SHA:AES256-SHA:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA:AES128-SHA:DES-CBC3-SHA:RC4-SHA:RC4-MD5:!aNULL:!eNULL:!EXPORT:!DSS:!DES:!3DES:!PSK
</I>
Careful. Squid will do what you tell it to.

In order for this to be more secure than the browser, you will have to
ensure that each of these things you are allowing actually are more
secure than what it does. And that you are not allowing anything that
the browser decides is bad.


&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> 
</I>&gt;<i> # Splice access lists
</I>&gt;<i> acl splice_client src 192.168.2.30
</I>&gt;<i> acl splice_domain dstdomain .paypal.com
</I>&gt;<i> acl splice_dst dst 66.211.169.66 66.211.169.3
</I>&gt;<i> 
</I>&gt;<i> # HTTPS access
</I>
Nope, &quot;TLS access&quot; is better description.

HTTPS is two protocol layers; a HTTP layer over a TLS layer (like
&quot;TCP/IP&quot; is actually TCP over IP layer).

ssl_bump directive controls only the TLS later actions. The http_access
rules later deal with the decrypted HTTP layer - but only if it was
allowed to be decrypted (&quot;bump&quot; action) by these rules.


&gt;<i> ssl_bump splice splice_client
</I>
Splice is equivalent to blind tunnelling, but can be done after Squid
has played with the certififcates a bit (using read-only accesses).

Since splice_client is based only on src-IP and nothing TLS layer
related it is better to use &quot;none&quot; instead of splice action on the above
rule. The true secure blind-tunnel will then be done.


&gt;<i> ssl_bump splice splice_domain
</I>
This is a good example of how dstdomain fails. You are deciding whether
to splice instead of interpret the HTTP message. Based on details inside
that HTTP message which has not yet been interpreted.

Make sure you are using the latest 3.5 release, and use the
&quot;ssl::server_name&quot; insted of dstdomain in the ACL definition.


&gt;<i> ssl_bump splice splice_dst
</I>
&gt;<i> ssl_bump server-first all
</I>
DO NOT mix the old and new config styles together. server-first requires
doing things like emitting a fake server cert to the client before
reading soem of the client handshake details the splicing needs. But you
have already spliced a bunch of transactions from the earlier rules.

&gt;<i> 
</I>&gt;<i> # Hide PROXY
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> 
</I>
Does *not* hide the proxy.

Hides the *client* by actively &quot;shouting&quot; the proxy details out to the
world in protocol places where the client details would normally go.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004987.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
	<LI>Next message (by thread): <A HREF="005001.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4988">[ date ]</a>
              <a href="thread.html#4988">[ thread ]</a>
              <a href="subject.html#4988">[ subject ]</a>
              <a href="author.html#4988">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
