<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bridge/Tproxy: https dns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bridge/Tproxy%3A%20https%20dns&In-Reply-To=%3C55D2C2D9.5080301%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005024.html">
   <LINK REL="Next"  HREF="005059.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bridge/Tproxy: https dns</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bridge/Tproxy%3A%20https%20dns&In-Reply-To=%3C55D2C2D9.5080301%40treenet.co.nz%3E"
       TITLE="[squid-users] Bridge/Tproxy: https dns">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 18 05:30:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005024.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
        <LI>Next message (by thread): <A HREF="005059.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5030">[ date ]</a>
              <a href="thread.html#5030">[ thread ]</a>
              <a href="subject.html#5030">[ subject ]</a>
              <a href="author.html#5030">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/08/2015 12:25 a.m., Pedro Correia Sardinha wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to setup a Squid server simple as possible just to review the
</I>&gt;<i> web use in office using the last stable version 3.5.7.
</I>&gt;<i> 
</I>
And you chose TPROXY with ssl-bump'ing. The two most complex features to
setup. lol.

&gt;<i> I setup the bridge with 2 NIC, br0 with IP 192.168.0.5 and I had disable
</I>&gt;<i> IPv6 on boot in my Slackware Current (Fri Aug 14 2015) server.
</I>
Sigh. Ever heard of IPv6-over-IPv4, 6-in-4, 6to4, etc. ?
All protocols designed to &quot;fix&quot; connectivity going through machines
setup like yours.

And why bother disabling a (BCP 177) mandatory part of the kernel?
The correct way to handle unwanted traffic is to firewall it. Not to
play around with kernel internals.

&lt;snip&gt;
&gt;<i> My squid.conf:
</I>
&gt;<i> tcp_outgoing_address 85.138.204.43
</I>
This is irrelevant with TPROXY. The client IP address is used instead.

For the regular forward-proxy traffic on port 3128 the machines default
IP will be used.


&gt;<i> dns_v4_first on
</I>&gt;<i> pinger_enable off
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> https_port 3130 ssl-bump tproxy generate-host-certificates=off
</I>&gt;<i> cert=/etc/squid/ssl/squid.pem cafile=/etc/squid/ssl/squid.pem
</I>&gt;<i> always_direct allow ssl-bump_port
</I>&gt;<i> ssl_bump none all
</I>
You have configued Squid not to even look at the TLS details.


&gt;<i> dns_nameservers 8.8.8.8 8.8.4.4
</I>&gt;<i> access_log daemon:/var/log/squid/access.log squid
</I>&gt;<i> cache deny all
</I>&gt;<i> pid_filename /var/run/squid/squid.pid
</I>&gt;<i> coredump_dir /var/log/squid/cache/squid
</I>&gt;<i> visible_hostname myservername.domain.local
</I>&gt;<i> 
</I>&gt;<i> In general the configuration (squid.conf) it's working but has some
</I>&gt;<i> incomplete behaviors as shows in log files.
</I>&gt;<i> 
</I>&gt;<i> access.log (I know this is Facebook but there are no dns resolusion in
</I>&gt;<i> https, just IP):
</I>&gt;<i> 1439811492.625   2377 192.168.0.102 TCP_TUNNEL/200 3574 CONNECT
</I>&gt;<i> 31.13.90.2:443 - ORIGINAL_DST/31.13.90.2 -
</I>

What sort of resolution were you expecting?

* The above log line is recording the TCP connection. TCP packets do not
have any &quot;domain name&quot; fields that need resolving to IP addresses.

* you also configured Squid not to look at the TLS details where it
might have found an SNI entry with server domain name.

The result is that Squid is working purely with TPROXY IP addresses and
setting up a TCP tunnel to relay the traffic through.


&gt;<i> 
</I>&gt;<i> cache.log:
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Cache-Control: max-age=504747
</I>&gt;<i> Content-Type: application/ocsp-response
</I>&gt;<i> Date: Mon, 17 Aug 2015 11:38:03 GMT
</I>&gt;<i> ETag: &quot;55d15943-1d7&quot;
</I>&gt;<i> Expires: Sun, 23 Aug 2015 23:38:03 GMT
</I>&gt;<i> Last-Modified: Mon, 17 Aug 2015 03:47:15 GMT
</I>&gt;<i> Server: ECS (mad/439C)
</I>&gt;<i> X-Cache: HIT
</I>&gt;<i> Content-Length: 471
</I>&gt;<i> X-Cache: MISS from squidhead2.skywalker.local
</I>&gt;<i> Via: 1.1 squidhead2.skywalker.local (squid/3.5.7)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> ----------
</I>&gt;<i> 2015/08/17 12:38:09.067 kid1| store.cc(955) checkCachable:
</I>&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2015/08/17 12:38:09.067 kid1| store.cc(955) checkCachable:
</I>&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2015/08/17 12:38:09.067 kid1| store.cc(955) checkCachable:
</I>&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>

Above is all the end of some transaction that was started earlier. No
useful details in the provided log snippet about it.



This is where a transaction actually starts:

&gt;<i> 2015/08/17 12:38:10.248 kid1| TcpAcceptor.cc(222) doAccept: New connection
</I>&gt;<i> on FD 12
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| TcpAcceptor.cc(297) acceptNext: connection on
</I>&gt;<i> local=0.0.0.0:3130 remote=[::] FD 12 flags=25
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| client_side.cc(3890)
</I>
Notice how the connection local IP:port details change from port 3130 to
port 443. Thats TPROXY working.

&gt;<i> httpsSslBumpAccessCheckDone: sslBump not needed for local=31.13.90.2:443
</I>&gt;<i> remote=192.168.0.102 FD 50 flags=17
</I>
This is the &quot;ssl_bump none&quot; action working (by not doing anything TLS
related) exactly as you configured.

Squid is now processing an internally generated CONNECT request
representing the intercepted TPROXY connection in a way that can be
logged and/or relayed to other proxies if it needs to.

&gt;<i> 2015/08/17 12:38:10.248 kid1| client_side.cc(2337) parseHttpRequest: HTTP
</I>&gt;<i> Client local=31.13.90.2:443 remote=192.168.0.102 FD 50 flags=17
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| client_side.cc(2338) parseHttpRequest: HTTP
</I>&gt;<i> Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> CONNECT 31.13.90.2:443 HTTP/1.1
</I>&gt;<i> Host: 31.13.90.2:443
</I>&gt;<i> ---------
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| client_side_request.cc(741)
</I>&gt;<i> clientAccessCheckDone: The request CONNECT 31.13.90.2:443 is ALLOWED; last
</I>&gt;<i> ACL checked: localnet
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| client_side_request.cc(717)
</I>&gt;<i> clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| client_side_request.cc(741)
</I>&gt;<i> clientAccessCheckDone: The request CONNECT 31.13.90.2:443 is ALLOWED; last
</I>&gt;<i> ACL checked: localnet
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| peer_select.cc(280) peerSelectDnsPaths: Found
</I>&gt;<i> sources for '31.13.90.2:443'
</I>
The CONNECT request uses a raw-IP address provided by TPROXY. There is
no name to resolve.

&gt;<i> 2015/08/17 12:38:10.248 kid1| peer_select.cc(281) peerSelectDnsPaths:
</I>&gt;<i> always_direct = ALLOWED
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| peer_select.cc(282) peerSelectDnsPaths:
</I>&gt;<i>  never_direct = DENIED
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| peer_select.cc(288) peerSelectDnsPaths:
</I>&gt;<i>  ORIGINAL_DST = local=192.168.0.102 remote=31.13.90.2:443 flags=25
</I>&gt;<i> 2015/08/17 12:38:10.248 kid1| peer_select.cc(295) peerSelectDnsPaths:
</I>&gt;<i>  timedout = 0
</I>
... stuff happens for 2 seconds...

&gt;<i> 2015/08/17 12:38:12.621 kid1| client_side.cc(815) swanSong: local=
</I>&gt;<i> 31.13.90.2:443 remote=192.168.0.102 flags=17
</I>&gt;<i> 2015/08/17 12:38:12.625 kid1| client_side.cc(815) swanSong: local=
</I>&gt;<i> 31.13.90.2:443 remote=192.168.0.102 flags=17
</I>
Then the connection closes.

Looks perfectly normal and expected behaviour to me considering what you
configured.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The logs with http (port 80) has the name resolution of navigation.
</I>&gt;<i> 
</I>&gt;<i> I disabled pinger because give some error:
</I>&lt;snip&gt;
&gt;<i> 2015/08/17 12:49:55| FATAL: pinger: Unable to open any ICMP sockets.
</I>
Okay. Not a big problem. The pinger helper needs its suid bit set, which
is not working on all system installations yet. Disabling it is fine.


&gt;<i> Do I have to setup local DNS server? the internal DNS of squid can't handle
</I>&gt;<i> https in Tproxy?
</I>&gt;<i> What's missing to have name resolution in https traffic as its showed in
</I>&gt;<i> http traffic?
</I>
Whats missing is the SSL-bumping part. HTTPS works differently to HTTP.

The URL domain name and all the rest of the HTTP message is encrypted
*in full*. There is simply no client HTTP message involved if you don't
decrypt.

As I mentioned above what you are seeing in the log is a Squid-generated
CONNECT message. Its the HTTP representation of the intercepted TCP SYN
packet and contains purely raw-IP:port details.

TLS does have an SNI record which is sent by browsers un-encrypted that
can be used as domain for some things. BUT, that requires &quot;ssl_bump
peek&quot; action at minimum, and has no guarantee of actually being present.

SNI is also still a new feature, and is not used for these fake CONNECT
requests anyway (since they represent the TCP SYN). So you wont see any
log difference in 3.5 even if you do let your Squid use it for ACLs.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005024.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
	<LI>Next message (by thread): <A HREF="005059.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5030">[ date ]</a>
              <a href="thread.html#5030">[ thread ]</a>
              <a href="subject.html#5030">[ subject ]</a>
              <a href="author.html#5030">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
