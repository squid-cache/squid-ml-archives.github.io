<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20debian%20Jessie%20squid%20with%20auth%0A%20%28kerberos/ntlm/basic%29%20ERROR%20type%20NTLM%20type%203&In-Reply-To=%3C55D2D308.405%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005072.html">
   <LINK REL="Next"  HREF="005027.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20debian%20Jessie%20squid%20with%20auth%0A%20%28kerberos/ntlm/basic%29%20ERROR%20type%20NTLM%20type%203&In-Reply-To=%3C55D2D308.405%40treenet.co.nz%3E"
       TITLE="[squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 18 06:39:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005072.html">[squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
</A></li>
        <LI>Next message (by thread): <A HREF="005027.html">[squid-users] Question on developing customized Cache Selection algorithm from Round Robin, Least Load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5032">[ date ]</a>
              <a href="thread.html#5032">[ thread ]</a>
              <a href="subject.html#5032">[ subject ]</a>
              <a href="author.html#5032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/08/2015 3:06 a.m., L.P.H. van Belle wrote:
&gt;<i> Hai all, 
</I>&gt;<i>  
</I>&gt;<i> I have a Debian Jessie setup with squid 3.4 , all debian packages. 
</I>&gt;<i> Im using samba 4 AD as domain controllers for my kerberos authentication. 
</I>&gt;<i>  
</I>&gt;<i> I've a setup as followed here : 
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory">http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory</A> 
</I>&gt;<i>  
</I>&gt;<i> I have my kerberos auth working, so i dont type any password with a &quot;domain joined computer&quot;  when i want to internet. 
</I>&gt;<i> I Have my Ldap auth working, for my &quot;Non windows, non domain joined&quot; Devices. 
</I>&gt;<i>  
</I>&gt;<i> Now, i need to give users access to the internet, a non domain joined, windows PC. 
</I>&gt;<i>  
</I>&gt;<i> Im getting :  ( with markus negotiate_wrapper 1.0.1  ) 
</I>&gt;<i> 2015/08/17 16:31:51 kid1| ERROR: Negotiate Authentication validating user. Result: {result=BH, notes={message: NT_STATUS_UNSUCCESSFUL * NT_STATUS_UNSUCCESSFUL; }
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Got 'YR TlR....   =' from squid (length: 59). 
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Decode 'TlR... =' (decoded length: 40).
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: received type 1 NTLM token
</I>
Type 1 NTLM.

&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Return 'TT TlR......  AA= * 
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Got 'KK TlR....  8=' from squid (length: 711).
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Decode 'TlR.....8=' (decoded length: 530).
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: received type 3 NTLM token
</I>&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Return 'BH NT_STATUS_UNSUCCESSFUL * NT_STATUS_UNSUCCESSFUL
</I>&gt;<i> 2015/08/17 16:32:03 kid1| ERROR: Negotiate Authentication validating user. Result: {result=BH, notes={message: NT_STATUS_UNSUCCESSFUL * NT_STATUS_UNSUCCESSFUL; }} 
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> I know the following : ( and correct me if im thinking wrong here.) 
</I>&gt;<i> ## 1) Pure Kerberos. Passthrough auth for windows users with windows DOMAIN JOINED pc's.
</I>&gt;<i> ##    Fallback to Ldap for NON WINDOWS NON DOMAIN JOINED Devices.
</I>&gt;<i> ##    NO NTLM. AKA, a windows pc, NOT JOINED in the domain, with end up in always user popup for auth.
</I>&gt;<i> ##    Which will always fail because of NTLM TYPE 1 and TYPE 2, authorisations.
</I>&gt;<i> ## 2) NEGOTIATE AUTH, which will do all of above, but also authenticated Windows PC's Not domain Joined.
</I>
Regarding (1):

* &quot;Pure kerberos&quot; aka &quot;Kerberos &quot; auth scheme is not supported in Squid.
Only Negotate/Kerberos. It was accepted by Squid-2 as an alias for
Negotiate, but Squid-3 operates differently and it was dropped for now.

* Rejecting NTLM (ie Negotiate/NTLM) is an artifact of the Squid
kerberos-only helper rejecting NTLM tokens. Nothing more.

You could reject the Negotiate/Kerberos tokens by configuring a
NTLM-only helper in the &quot;auth_param negotiate program&quot;.

* off-domain machines only ever worked using Basic authentication or
similar protocols called LanMan which sent passwords inside NTLM or
Negotiate/NTLM tokens. But LanMan are so insecure they are no longer
supported.
 NP: if you have a client that will only authenticate with LanMan (SMB
LM) protocols you are better off security-wise not authenticating it at
all. At least that stops it broadcasting the users password to the world.


Regarding (2):

* The machine still does need to be domain joined, at least recently
enough to have a valid Kerberos token. What can be avoided is being
connected &quot;live&quot; during the handshake itself.

 But that is a feature of the client software not related to Squid. So
some clients support it, most actually dont.


&gt;<i> 
</I>&gt;<i> But i recieve a type 3 NTLM token...  
</I>&gt;<i>  
</I>
You also received NTLM type 1 prior to it. I suspect a machine not
joined to the domain is trying to use NTLM, which requires being on the
domain.

There is no problem with this *unless* the client machine is refusing to
fallback to Negotiate/Kerberos or Basic auth after the failure.

There is no reason a popup should occur unless all forms of
Negotiate/Kerberos Negotiate/NTLM, NTLM, and Basic which are offered by
the proxy have failed.


&gt;<i>  
</I>&gt;<i> This are the configs have tested and these 2 work. 
</I>&gt;<i> For kerberos auth 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid3/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hostname.fqdn at REALM</A>    
</I>&gt;<i>  
</I>&gt;<i> for basic auth 
</I>&gt;<i> auth_param basic program /usr/lib/squid3/basic_ldap_auth -R \
</I>&gt;<i>     -b &quot;dc=internal,dc=domain,dc=tld&quot; \
</I>&gt;<i>     -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ldap-bind at internal.domain.tld</A> -W /etc/squid3/private/ldap-bind \
</I>&gt;<i>     -f (|(userPrincipalName=%s)(sAMAccountName=%s)) \
</I>&gt;<i>     -h addc.internal.domain.tld  
</I>&gt;<i> 
</I>&gt;<i> These dont work. 
</I>
I assume that by the positioning of your &quot;these&quot; statements you meant
the above work, and the below dont.

&gt;<i>  
</I>&gt;<i> auth_param negotiate program /usr/lib/squid3/negotiate_wrapper_auth -d \
</I>&gt;<i>     --ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=BAZRTD \
</I>&gt;<i>     --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d -s GSS_C_NO_NAME
</I>&gt;<i> or 
</I>&gt;<i> auth_param negotiate program /usr/local/bin/negotiate_wrapper -d \
</I>&gt;<i>     --ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=BAZRTD \
</I>&gt;<i>     --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d -s GSS_C_NO_NAME
</I>&gt;<i> 
</I>&gt;<i> tried here the supplied wrapper with squid.:     /usr/lib/squid3/negotiate_wrapper_auth  
</I>&gt;<i> and i have tried the negotiate_wrapper of Markus, as the wiki.squid-cache.org also says  here
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory">http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory</A>   ( Install negotiate_wrapper )  
</I>&gt;<i>  
</I>&gt;<i> the kerberos part works but not the ntlm . 
</I>
One puzzling thing is why Win7 client is trying to use NTLM in the first
place. NTLM is disabled by default in Vista and later due to its lack of
security.

Try adding &quot;auth_param negotiate keep_alive off&quot; to close connections
when Negotiate/NTLM is used and force the client to retry with other
auth credentials on a clean connection.


&gt;<i>  
</I>&gt;<i> when i try with only: 
</I>&gt;<i>  
</I>&gt;<i> ### pure ntlm authentication
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=EXAMPLE
</I>&gt;<i> auth_param ntlm children 10
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i>  
</I>&gt;<i> im also unable to authenticat on the proxy. 
</I>
NTLM will only work with current MS software if the client is joined to
the domain, and if NTLM is explicitly re-enabled.

The 1970-80's LanMan protocols are no longer supported since 2006 (WinXP
SP3). The most secure of these can be decrypted in under 50 milliseconds
- ie &quot;live&quot;.

Ironically that was exactly how Squid helpers used to work for
off-domain clients all through the 2000's. LanMan passwords being
decrypted in real-time allowed Basic auth APIs in AD to be used. Giving
the appearance that off-domain machines were authenticating securely,
when in fact they were just broadcasting their passwords about. Not a
good situation.

The old 1990's NTLM v1 and v2 are also on the way out since Vista. NTLM
v1 can be decrypted in a few seconds, v2 in a few minutes.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005072.html">[squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
</A></li>
	<LI>Next message (by thread): <A HREF="005027.html">[squid-users] Question on developing customized Cache Selection algorithm from Round Robin, Least Load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5032">[ date ]</a>
              <a href="thread.html#5032">[ thread ]</a>
              <a href="subject.html#5032">[ subject ]</a>
              <a href="author.html#5032">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
