<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FW: debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20debian%20Jessie%20squid%20with%20auth%0A%20%28kerberos/ntlm/basic%29%20ERROR%20type%20NTLM%20type%203&In-Reply-To=%3Cvmime.55d2e633.57e6.264bd9653dad75e3%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005036.html">
   <LINK REL="Next"  HREF="005034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FW: debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20debian%20Jessie%20squid%20with%20auth%0A%20%28kerberos/ntlm/basic%29%20ERROR%20type%20NTLM%20type%203&In-Reply-To=%3Cvmime.55d2e633.57e6.264bd9653dad75e3%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] FW: debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3">belle at bazuin.nl
       </A><BR>
    <I>Tue Aug 18 08:00:51 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005036.html">[squid-users] Question on developing customized Cache Selection algorithm from Round Robin, Least Load
</A></li>
        <LI>Next message (by thread): <A HREF="005034.html">[squid-users] FW: debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5033">[ date ]</a>
              <a href="thread.html#5033">[ thread ]</a>
              <a href="subject.html#5033">[ subject ]</a>
              <a href="author.html#5033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai Amos, 

Thank you for your very clear responce.. few small questions..

Is there a way to setup the proxy for the following.
1) use negotiate kerberos for auth, ( which is working already for all domain joined machines )
2) use a fall back that works, for now basic ldap works for non windows machines, and domain joined machines.
3) use any other fallback way for authentication users on windows machines, that are not in the domain.
	and without modify-ing anything in windows. as these are often guest machines. 

Is a link to a radius server an option, dont have a radus jet, but can be installed. 
and radius is also comming for my wifi authentication. 
whould that fix my problem (3) above, in a authentication fallback setup. 


&gt;<i>One puzzling thing is why Win7 client is trying to use NTLM in 
</I>&gt;<i>the first
</I>&gt;<i>place. NTLM is disabled by default in Vista and later due to 
</I>&gt;<i>its lack of
</I>&gt;<i>security.
</I>&gt;<i>
</I>&gt;<i>Try adding &quot;auth_param negotiate keep_alive off&quot; to close connections
</I>&gt;<i>when Negotiate/NTLM is used and force the client to retry with other
</I>&gt;<i>auth credentials on a clean connection.
</I>
these : 
&gt;&gt;<i> auth_param negotiate program /usr/lib/squid3/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hostname.fqdn at REALM</A>    
</I>and 
&gt;&gt;<i> auth_param negotiate program /usr/local/bin/negotiate_wrapper
</I>These lines, work both for negotiate kerberos.  
The last, when useing : /usr/local/bin/negotiate_wrapper was tested with the parameter 
negotiate keep_alive off. 

Above works fine with the domain joined pc, but not with the &quot;non domain joined&quot; PC. 
the negotiate kerberos works very good, but the fall back not. ( as you explained ) 

I found that if i setup with only basic_ldap_auth, against the AD, then i can use both,
domain joined and not domain joined, but the first time it always gives a popup for authenticating. 
If once authenticated, it keeps it authenticated, aka windows/IE keeps the login and password. 
even if i clear the history. 

Why i dont want this... 
If a user is logging in the domain, and kerberos auth is used, then when going on internet, 
the &quot;correct&quot; aka logged in user, is always used. 
but when i use basic_ldap_auth, then it gives the user to put in an other username/password at popup, 
then it remembers the login and a user now is internetting with an other users name. 

So, when im right, a fallback for all is not possible, due to NTLM auth? 

And a big thank you for your responce. 


Greetz, 

Louis


&gt;<i>-----Oorspronkelijk bericht-----
</I>&gt;<i>Van: squid-users 
</I>&gt;<i>[mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Amos Jeffries
</I>&gt;<i>Verzonden: dinsdag 18 augustus 2015 8:39
</I>&gt;<i>Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>Onderwerp: Re: [squid-users] debian Jessie squid with auth 
</I>&gt;<i>(kerberos/ntlm/basic) ERROR type NTLM type 3
</I>&gt;<i>
</I>&gt;<i>On 18/08/2015 3:06 a.m., L.P.H. van Belle wrote:
</I>&gt;&gt;<i> Hai all, 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> I have a Debian Jessie setup with squid 3.4 , all debian packages. 
</I>&gt;&gt;<i> Im using samba 4 AD as domain controllers for my kerberos 
</I>&gt;<i>authentication. 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> I've a setup as followed here : 
</I>&gt;&gt;<i> 
</I>&gt;<i><A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Windows">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Windows</A>
</I>&gt;<i>ActiveDirectory 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> I have my kerberos auth working, so i dont type any password 
</I>&gt;<i>with a &quot;domain joined computer&quot;  when i want to internet. 
</I>&gt;&gt;<i> I Have my Ldap auth working, for my &quot;Non windows, non domain 
</I>&gt;<i>joined&quot; Devices. 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> Now, i need to give users access to the internet, a non 
</I>&gt;<i>domain joined, windows PC. 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> Im getting :  ( with markus negotiate_wrapper 1.0.1  ) 
</I>&gt;&gt;<i> 2015/08/17 16:31:51 kid1| ERROR: Negotiate Authentication 
</I>&gt;<i>validating user. Result: {result=BH, notes={message: 
</I>&gt;<i>NT_STATUS_UNSUCCESSFUL * NT_STATUS_UNSUCCESSFUL; }
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Got 'YR TlR....   =' 
</I>&gt;<i>from squid (length: 59). 
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Decode 'TlR... =' 
</I>&gt;<i>(decoded length: 40).
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: received type 1 NTLM token
</I>&gt;<i>
</I>&gt;<i>Type 1 NTLM.
</I>

&gt;<i>
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Return 'TT TlR......  AA= * 
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Got 'KK TlR....  8=' 
</I>&gt;<i>from squid (length: 711).
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Decode 'TlR.....8=' 
</I>&gt;<i>(decoded length: 530).
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: received type 3 NTLM token
</I>&gt;&gt;<i> 2015/08/17 16:32:03| negotiate_wrapper: Return 'BH 
</I>&gt;<i>NT_STATUS_UNSUCCESSFUL * NT_STATUS_UNSUCCESSFUL
</I>&gt;&gt;<i> 2015/08/17 16:32:03 kid1| ERROR: Negotiate Authentication 
</I>&gt;<i>validating user. Result: {result=BH, notes={message: 
</I>&gt;<i>NT_STATUS_UNSUCCESSFUL * NT_STATUS_UNSUCCESSFUL; }} 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> I know the following : ( and correct me if im thinking wrong here.) 
</I>&gt;&gt;<i> ## 1) Pure Kerberos. Passthrough auth for windows users with 
</I>&gt;<i>windows DOMAIN JOINED pc's.
</I>&gt;&gt;<i> ##    Fallback to Ldap for NON WINDOWS NON DOMAIN JOINED Devices.
</I>&gt;&gt;<i> ##    NO NTLM. AKA, a windows pc, NOT JOINED in the domain, 
</I>&gt;<i>with end up in always user popup for auth.
</I>&gt;&gt;<i> ##    Which will always fail because of NTLM TYPE 1 and TYPE 
</I>&gt;<i>2, authorisations.
</I>&gt;&gt;<i> ## 2) NEGOTIATE AUTH, which will do all of above, but also 
</I>&gt;<i>authenticated Windows PC's Not domain Joined.
</I>&gt;<i>
</I>&gt;<i>Regarding (1):
</I>&gt;<i>
</I>&gt;<i>* &quot;Pure kerberos&quot; aka &quot;Kerberos &quot; auth scheme is not supported 
</I>&gt;<i>in Squid.
</I>&gt;<i>Only Negotate/Kerberos. It was accepted by Squid-2 as an alias for
</I>&gt;<i>Negotiate, but Squid-3 operates differently and it was dropped for now.
</I>&gt;<i>
</I>&gt;<i>* Rejecting NTLM (ie Negotiate/NTLM) is an artifact of the Squid
</I>&gt;<i>kerberos-only helper rejecting NTLM tokens. Nothing more.
</I>&gt;<i>
</I>&gt;<i>You could reject the Negotiate/Kerberos tokens by configuring a
</I>&gt;<i>NTLM-only helper in the &quot;auth_param negotiate program&quot;.
</I>&gt;<i>
</I>&gt;<i>* off-domain machines only ever worked using Basic authentication or
</I>&gt;<i>similar protocols called LanMan which sent passwords inside NTLM or
</I>&gt;<i>Negotiate/NTLM tokens. But LanMan are so insecure they are no longer
</I>&gt;<i>supported.
</I>&gt;<i> NP: if you have a client that will only authenticate with LanMan (SMB
</I>&gt;<i>LM) protocols you are better off security-wise not authenticating it at
</I>&gt;<i>all. At least that stops it broadcasting the users password to 
</I>&gt;<i>the world.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Regarding (2):
</I>&gt;<i>
</I>&gt;<i>* The machine still does need to be domain joined, at least recently
</I>&gt;<i>enough to have a valid Kerberos token. What can be avoided is being
</I>&gt;<i>connected &quot;live&quot; during the handshake itself.
</I>&gt;<i>
</I>&gt;<i> But that is a feature of the client software not related to Squid. So
</I>&gt;<i>some clients support it, most actually dont.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> But i recieve a type 3 NTLM token...  
</I>&gt;&gt;<i>  
</I>&gt;<i>
</I>&gt;<i>You also received NTLM type 1 prior to it. I suspect a machine not
</I>&gt;<i>joined to the domain is trying to use NTLM, which requires being on the
</I>&gt;<i>domain.
</I>&gt;<i>
</I>&gt;<i>There is no problem with this *unless* the client machine is 
</I>&gt;<i>refusing to
</I>&gt;<i>fallback to Negotiate/Kerberos or Basic auth after the failure.
</I>&gt;<i>
</I>&gt;<i>There is no reason a popup should occur unless all forms of
</I>&gt;<i>Negotiate/Kerberos Negotiate/NTLM, NTLM, and Basic which are offered by
</I>&gt;<i>the proxy have failed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> This are the configs have tested and these 2 work. 
</I>&gt;&gt;<i> For kerberos auth 
</I>&gt;&gt;<i> auth_param negotiate program 
</I>&gt;<i>/usr/lib/squid3/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hostname.fqdn at REALM</A>    
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> for basic auth 
</I>&gt;&gt;<i> auth_param basic program /usr/lib/squid3/basic_ldap_auth -R \
</I>&gt;&gt;<i>     -b &quot;dc=internal,dc=domain,dc=tld&quot; \
</I>&gt;&gt;<i>     -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ldap-bind at internal.domain.tld</A> -W 
</I>&gt;<i>/etc/squid3/private/ldap-bind \
</I>&gt;&gt;<i>     -f (|(userPrincipalName=%s)(sAMAccountName=%s)) \
</I>&gt;&gt;<i>     -h addc.internal.domain.tld  
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> These dont work. 
</I>&gt;<i>
</I>&gt;<i>I assume that by the positioning of your &quot;these&quot; statements you meant
</I>&gt;<i>the above work, and the below dont.
</I>&gt;<i>
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> auth_param negotiate program 
</I>&gt;<i>/usr/lib/squid3/negotiate_wrapper_auth -d \
</I>&gt;&gt;<i>     --ntlm /usr/bin/ntlm_auth --diagnostics 
</I>&gt;<i>--helper-protocol=squid-2.5-ntlmssp --domain=BAZRTD \
</I>&gt;&gt;<i>     --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d -s 
</I>&gt;<i>GSS_C_NO_NAME
</I>&gt;&gt;<i> or 
</I>&gt;&gt;<i> auth_param negotiate program /usr/local/bin/negotiate_wrapper -d \
</I>&gt;&gt;<i>     --ntlm /usr/bin/ntlm_auth --diagnostics 
</I>&gt;<i>--helper-protocol=squid-2.5-ntlmssp --domain=BAZRTD \
</I>&gt;&gt;<i>     --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d -s 
</I>&gt;<i>GSS_C_NO_NAME
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> tried here the supplied wrapper with squid.:     
</I>&gt;<i>/usr/lib/squid3/negotiate_wrapper_auth  
</I>&gt;&gt;<i> and i have tried the negotiate_wrapper of Markus, as the 
</I>&gt;<i>wiki.squid-cache.org also says  here
</I>&gt;&gt;<i> 
</I>&gt;<i><A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Windows">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Windows</A>
</I>&gt;<i>ActiveDirectory   ( Install negotiate_wrapper )  
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> the kerberos part works but not the ntlm . 
</I>&gt;<i>
</I>&gt;<i>One puzzling thing is why Win7 client is trying to use NTLM in 
</I>&gt;<i>the first
</I>&gt;<i>place. NTLM is disabled by default in Vista and later due to 
</I>&gt;<i>its lack of
</I>&gt;<i>security.
</I>&gt;<i>
</I>&gt;<i>Try adding &quot;auth_param negotiate keep_alive off&quot; to close connections
</I>&gt;<i>when Negotiate/NTLM is used and force the client to retry with other
</I>&gt;<i>auth credentials on a clean connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> when i try with only: 
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> ### pure ntlm authentication
</I>&gt;&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics 
</I>&gt;<i>--helper-protocol=squid-2.5-ntlmssp --domain=EXAMPLE
</I>&gt;&gt;<i> auth_param ntlm children 10
</I>&gt;&gt;<i> auth_param ntlm keep_alive off
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> im also unable to authenticat on the proxy. 
</I>&gt;<i>
</I>&gt;<i>NTLM will only work with current MS software if the client is joined to
</I>&gt;<i>the domain, and if NTLM is explicitly re-enabled.
</I>&gt;<i>
</I>&gt;<i>The 1970-80's LanMan protocols are no longer supported since 
</I>&gt;<i>2006 (WinXP
</I>&gt;<i>SP3). The most secure of these can be decrypted in under 50 
</I>&gt;<i>milliseconds
</I>&gt;<i>- ie &quot;live&quot;.
</I>&gt;<i>
</I>&gt;<i>Ironically that was exactly how Squid helpers used to work for
</I>&gt;<i>off-domain clients all through the 2000's. LanMan passwords being
</I>&gt;<i>decrypted in real-time allowed Basic auth APIs in AD to be used. Giving
</I>&gt;<i>the appearance that off-domain machines were authenticating securely,
</I>&gt;<i>when in fact they were just broadcasting their passwords about. Not a
</I>&gt;<i>good situation.
</I>&gt;<i>
</I>&gt;<i>The old 1990's NTLM v1 and v2 are also on the way out since Vista. NTLM
</I>&gt;<i>v1 can be decrypted in a few seconds, v2 in a few minutes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>HTH
</I>&gt;<i>Amos
</I>&gt;<i>_______________________________________________
</I>&gt;<i>squid-users mailing list
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i><A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005036.html">[squid-users] Question on developing customized Cache Selection algorithm from Round Robin, Least Load
</A></li>
	<LI>Next message (by thread): <A HREF="005034.html">[squid-users] FW: debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5033">[ date ]</a>
              <a href="thread.html#5033">[ thread ]</a>
              <a href="subject.html#5033">[ subject ]</a>
              <a href="author.html#5033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
