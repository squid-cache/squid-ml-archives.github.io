<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bridge/Tproxy: https dns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bridge/Tproxy%3A%20https%20dns&In-Reply-To=%3CCADLGAbK2PcSbSMehhXyN7sJtCWNKubPRkcwDKr%2ByeZBj%3DjNiDA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005030.html">
   <LINK REL="Next"  HREF="005062.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bridge/Tproxy: https dns</H1>
    <B>Pedro Correia Sardinha</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bridge/Tproxy%3A%20https%20dns&In-Reply-To=%3CCADLGAbK2PcSbSMehhXyN7sJtCWNKubPRkcwDKr%2ByeZBj%3DjNiDA%40mail.gmail.com%3E"
       TITLE="[squid-users] Bridge/Tproxy: https dns">correiasardinha at gmail.com
       </A><BR>
    <I>Tue Aug 18 16:54:11 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005030.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
        <LI>Next message (by thread): <A HREF="005062.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5059">[ date ]</a>
              <a href="thread.html#5059">[ thread ]</a>
              <a href="subject.html#5059">[ subject ]</a>
              <a href="author.html#5059">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you Amos for the review.

Following your advice... trying to use the pure transparent proxy (Tproxy)
but getting different behaviours with google domains in google chrome and
after adding peek there aren't still no names in https addresses.

First create ssl certs directory, just to check later.
/usr/lib64/squid/ssl_crtd -c -s /var/log/squid/lib/ssl_db

remove from squid.conf:
#tcp_outgoing_address
#always_direct allow ssl-bump_port
#ssl_bump none all

add to squid.conf:
ssl_bump splice localnet
ssl_bump peek all
ssl_bump splice all

I removed IPv6 restriction in kernel and in new squid compile without
--disable-ipv6 option. And I added some similiar IPv6 rules to Tproxy boot
script.

I continue to not generate-host-certificates(=off), I can check it in
ssl_db directory. But, just for testing, if I change
generate-host-certificates to on then there are certificates changes with
my self CA Autority notice in Google Chrome related to google sites, some
other sites tested get the certificate in right way. In IE and Firefox
there are no certificates issues.
A workaround for this issue in Google Chrome with websites in google
domains was create a specific acl for IP from google domains and splice
first like did with localnet:
acl google dst &quot;/etc/squid/google.txt&quot;
...
ssl_bump splice google
...

After those changes and setup ssl-bump with peek for most of sites (e.g.
facebook) but still no names in logs, just the IP in https navigation.

access.log:
1439907457.958     49 192.168.0.102 TCP_MISS/200 910 POST
<A HREF="http://ocsp.digicert.com/">http://ocsp.digicert.com/</A> - ORIGINAL_DST/93.184.220.29
application/ocsp-response
1439907466.798  59053 192.168.0.102 TCP_TUNNEL/200 3944 CONNECT
212.113.184.216:443 - ORIGINAL_DST/212.113.184.216 -
1439907472.813  58798 192.168.0.102 TCP_TUNNEL/200 8320 CONNECT
212.113.185.35:443 - ORIGINAL_DST/212.113.185.35 -
1439907472.817  59014 192.168.0.102 TCP_TUNNEL/200 5234 CONNECT
212.113.184.221:443 - ORIGINAL_DST/212.113.184.221 -
1439907490.935  65674 192.168.0.102 TCP_TUNNEL/200 4207 CONNECT
54.171.32.174:443 - ORIGINAL_DST/54.171.32.174 -
1439907527.998 115712 192.168.0.102 TCP_TUNNEL/200 5485 CONNECT
54.192.61.197:443 - ORIGINAL_DST/54.192.61.197 -
1439907545.804 122741 192.168.0.102 TCP_TUNNEL/200 5817 CONNECT
132.245.50.66:443 - ORIGINAL_DST/132.245.50.66 -


cache.log:
---------
HTTP/1.1 200 OK
Accept-Ranges: bytes
Cache-Control: max-age=499906
Content-Type: application/ocsp-response
Date: Tue, 18 Aug 2015 14:17:31 GMT
ETag: &quot;55d2d1da-1d7&quot;
Expires: Tue, 25 Aug 2015 02:17:31 GMT
Last-Modified: Tue, 18 Aug 2015 06:34:02 GMT
Server: ECS (mad/42F2)
X-Cache: HIT
Content-Length: 471
X-Cache: MISS from squidhead2.skywalker.local
Via: 1.1 squidhead2.skywalker.local (squid/3.5.7)
Connection: keep-alive
----------
2015/08/18 15:17:37.958 kid1| store.cc(955) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2015/08/18 15:17:37.958 kid1| store.cc(955) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2015/08/18 15:17:37.958 kid1| store.cc(955) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2015/08/18 15:17:38.152 kid1| TcpAcceptor.cc(222) doAccept: New connection
on FD 15
2015/08/18 15:17:38.152 kid1| TcpAcceptor.cc(297) acceptNext: connection on
local=[::]:3130 remote=[::] FD 15 flags=25
2015/08/18 15:17:38.153 kid1| client_side.cc(3890)
httpsSslBumpAccessCheckDone: sslBump not needed for local=31.13.90.6:443
remote=192.168.0.102 FD 40 flags=17
2015/08/18 15:17:38.153 kid1| client_side.cc(2337) parseHttpRequest: HTTP
Client local=31.13.90.6:443 remote=192.168.0.102 FD 40 flags=17
2015/08/18 15:17:38.153 kid1| client_side.cc(2338) parseHttpRequest: HTTP
Client REQUEST:
---------
CONNECT 31.13.90.6:443 HTTP/1.1
Host: 31.13.90.6:443
----------
2015/08/18 15:17:38.153 kid1| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT 31.13.90.6:443 is ALLOWED; last
ACL checked: ssl-bump_port
2015/08/18 15:17:38.153 kid1| client_side_request.cc(717)
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2015/08/18 15:17:38.153 kid1| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT 31.13.90.6:443 is ALLOWED; last
ACL checked: ssl-bump_port
2015/08/18 15:17:38.153 kid1| peer_select.cc(280) peerSelectDnsPaths: Found
sources for '31.13.90.6:443'
2015/08/18 15:17:38.153 kid1| peer_select.cc(281) peerSelectDnsPaths:
always_direct = DENIED
2015/08/18 15:17:38.153 kid1| peer_select.cc(282) peerSelectDnsPaths:
 never_direct = DENIED
2015/08/18 15:17:38.153 kid1| peer_select.cc(288) peerSelectDnsPaths:
 ORIGINAL_DST = local=192.168.0.102 remote=31.13.90.6:443 flags=25
2015/08/18 15:17:38.153 kid1| peer_select.cc(295) peerSelectDnsPaths:
 timedout = 0
2015/08/18 15:17:38.156 kid1| TcpAcceptor.cc(222) doAccept: New connection
on FD 15
2015/08/18 15:17:38.156 kid1| TcpAcceptor.cc(297) acceptNext: connection on
local=[::]:3130 remote=[::] FD 15 flags=25
2015/08/18 15:17:38.156 kid1| client_side.cc(3890)
httpsSslBumpAccessCheckDone: sslBump not needed for local=31.13.90.6:443
remote=192.168.0.102 FD 42 flags=17
2015/08/18 15:17:38.156 kid1| client_side.cc(2337) parseHttpRequest: HTTP
Client local=31.13.90.6:443 remote=192.168.0.102 FD 42 flags=17
2015/08/18 15:17:38.156 kid1| client_side.cc(2338) parseHttpRequest: HTTP
Client REQUEST:
---------
CONNECT 31.13.90.6:443 HTTP/1.1
Host: 31.13.90.6:443
----------
2015/08/18 15:17:38.157 kid1| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT 31.13.90.6:443 is ALLOWED; last
ACL checked: ssl-bump_port
2015/08/18 15:17:38.157 kid1| client_side_request.cc(717)
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2015/08/18 15:17:38.157 kid1| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT 31.13.90.6:443 is ALLOWED; last
ACL checked: ssl-bump_port
2015/08/18 15:17:38.157 kid1| peer_select.cc(280) peerSelectDnsPaths: Found
sources for '31.13.90.6:443'
2015/08/18 15:17:38.157 kid1| peer_select.cc(281) peerSelectDnsPaths:
always_direct = DENIED
2015/08/18 15:17:38.157 kid1| peer_select.cc(282) peerSelectDnsPaths:
 never_direct = DENIED
2015/08/18 15:17:38.157 kid1| peer_select.cc(288) peerSelectDnsPaths:
 ORIGINAL_DST = local=192.168.0.102 remote=31.13.90.6:443 flags=25
2015/08/18 15:17:38.157 kid1| peer_select.cc(295) peerSelectDnsPaths:
 timedout = 0
2015/08/18 15:17:45.351 kid1| TcpAcceptor.cc(222) doAccept: New connection
on FD 15
2015/08/18 15:17:45.351 kid1| TcpAcceptor.cc(297) acceptNext: connection on
local=[::]:3130 remote=[::] FD 15 flags=25
2015/08/18 15:17:45.351 kid1| client_side.cc(3890)
httpsSslBumpAccessCheckDone: sslBump not needed for local=212.113.185.24:443
remote=192.168.0.102 FD 46 flags=17
2015/08/18 15:17:45.351 kid1| client_side.cc(2337) parseHttpRequest: HTTP
Client local=212.113.185.24:443 remote=192.168.0.102 FD 46 flags=17
2015/08/18 15:17:45.351 kid1| client_side.cc(2338) parseHttpRequest: HTTP
Client REQUEST:
---------
CONNECT 212.113.185.24:443 HTTP/1.1
Host: 212.113.185.24:443
----------
2015/08/18 15:17:45.351 kid1| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT 212.113.185.24:443 is ALLOWED;
last ACL checked: ssl-bump_port
2015/08/18 15:17:45.351 kid1| client_side_request.cc(717)
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2015/08/18 15:17:45.351 kid1| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT 212.113.185.24:443 is ALLOWED;
last ACL checked: ssl-bump_port
2015/08/18 15:17:45.351 kid1| peer_select.cc(280) peerSelectDnsPaths: Found
sources for '212.113.185.24:443'
2015/08/18 15:17:45.351 kid1| peer_select.cc(281) peerSelectDnsPaths:
always_direct = DENIED
2015/08/18 15:17:45.351 kid1| peer_select.cc(282) peerSelectDnsPaths:
 never_direct = DENIED
2015/08/18 15:17:45.351 kid1| peer_select.cc(288) peerSelectDnsPaths:
 ORIGINAL_DST = local=192.168.0.102 remote=212.113.185.24:443 flags=25
2015/08/18 15:17:45.351 kid1| peer_select.cc(295) peerSelectDnsPaths:
 timedout = 0

Can I ask what I missed?
Thank you for your time.



On Tue, Aug 18, 2015 at 6:30 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 18/08/2015 12:25 a.m., Pedro Correia Sardinha wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm trying to setup a Squid server simple as possible just to review the
</I>&gt;<i> &gt; web use in office using the last stable version 3.5.7.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> And you chose TPROXY with ssl-bump'ing. The two most complex features to
</I>&gt;<i> setup. lol.
</I>&gt;<i>
</I>&gt;<i> &gt; I setup the bridge with 2 NIC, br0 with IP 192.168.0.5 and I had disable
</I>&gt;<i> &gt; IPv6 on boot in my Slackware Current (Fri Aug 14 2015) server.
</I>&gt;<i>
</I>&gt;<i> Sigh. Ever heard of IPv6-over-IPv4, 6-in-4, 6to4, etc. ?
</I>&gt;<i> All protocols designed to &quot;fix&quot; connectivity going through machines
</I>&gt;<i> setup like yours.
</I>&gt;<i>
</I>&gt;<i> And why bother disabling a (BCP 177) mandatory part of the kernel?
</I>&gt;<i> The correct way to handle unwanted traffic is to firewall it. Not to
</I>&gt;<i> play around with kernel internals.
</I>&gt;<i>
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt; My squid.conf:
</I>&gt;<i>
</I>&gt;<i> &gt; tcp_outgoing_address 85.138.204.43
</I>&gt;<i>
</I>&gt;<i> This is irrelevant with TPROXY. The client IP address is used instead.
</I>&gt;<i>
</I>&gt;<i> For the regular forward-proxy traffic on port 3128 the machines default
</I>&gt;<i> IP will be used.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; dns_v4_first on
</I>&gt;<i> &gt; pinger_enable off
</I>&gt;<i> &gt; http_port 3128
</I>&gt;<i> &gt; http_port 3129 tproxy
</I>&gt;<i> &gt; https_port 3130 ssl-bump tproxy generate-host-certificates=off
</I>&gt;<i> &gt; cert=/etc/squid/ssl/squid.pem cafile=/etc/squid/ssl/squid.pem
</I>&gt;<i> &gt; always_direct allow ssl-bump_port
</I>&gt;<i> &gt; ssl_bump none all
</I>&gt;<i>
</I>&gt;<i> You have configued Squid not to even look at the TLS details.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; dns_nameservers 8.8.8.8 8.8.4.4
</I>&gt;<i> &gt; access_log daemon:/var/log/squid/access.log squid
</I>&gt;<i> &gt; cache deny all
</I>&gt;<i> &gt; pid_filename /var/run/squid/squid.pid
</I>&gt;<i> &gt; coredump_dir /var/log/squid/cache/squid
</I>&gt;<i> &gt; visible_hostname myservername.domain.local
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In general the configuration (squid.conf) it's working but has some
</I>&gt;<i> &gt; incomplete behaviors as shows in log files.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; access.log (I know this is Facebook but there are no dns resolusion in
</I>&gt;<i> &gt; https, just IP):
</I>&gt;<i> &gt; 1439811492.625   2377 192.168.0.102 TCP_TUNNEL/200 3574 CONNECT
</I>&gt;<i> &gt; 31.13.90.2:443 - ORIGINAL_DST/31.13.90.2 -
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What sort of resolution were you expecting?
</I>&gt;<i>
</I>&gt;<i> * The above log line is recording the TCP connection. TCP packets do not
</I>&gt;<i> have any &quot;domain name&quot; fields that need resolving to IP addresses.
</I>&gt;<i>
</I>&gt;<i> * you also configured Squid not to look at the TLS details where it
</I>&gt;<i> might have found an SNI entry with server domain name.
</I>&gt;<i>
</I>&gt;<i> The result is that Squid is working purely with TPROXY IP addresses and
</I>&gt;<i> setting up a TCP tunnel to relay the traffic through.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache.log:
</I>&gt;<i> &gt; HTTP/1.1 200 OK
</I>&gt;<i> &gt; Accept-Ranges: bytes
</I>&gt;<i> &gt; Cache-Control: max-age=504747
</I>&gt;<i> &gt; Content-Type: application/ocsp-response
</I>&gt;<i> &gt; Date: Mon, 17 Aug 2015 11:38:03 GMT
</I>&gt;<i> &gt; ETag: &quot;55d15943-1d7&quot;
</I>&gt;<i> &gt; Expires: Sun, 23 Aug 2015 23:38:03 GMT
</I>&gt;<i> &gt; Last-Modified: Mon, 17 Aug 2015 03:47:15 GMT
</I>&gt;<i> &gt; Server: ECS (mad/439C)
</I>&gt;<i> &gt; X-Cache: HIT
</I>&gt;<i> &gt; Content-Length: 471
</I>&gt;<i> &gt; X-Cache: MISS from squidhead2.skywalker.local
</I>&gt;<i> &gt; Via: 1.1 squidhead2.skywalker.local (squid/3.5.7)
</I>&gt;<i> &gt; Connection: keep-alive
</I>&gt;<i> &gt; ----------
</I>&gt;<i> &gt; 2015/08/17 12:38:09.067 kid1| store.cc(955) checkCachable:
</I>&gt;<i> &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> &gt; 2015/08/17 12:38:09.067 kid1| store.cc(955) checkCachable:
</I>&gt;<i> &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> &gt; 2015/08/17 12:38:09.067 kid1| store.cc(955) checkCachable:
</I>&gt;<i> &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Above is all the end of some transaction that was started earlier. No
</I>&gt;<i> useful details in the provided log snippet about it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is where a transaction actually starts:
</I>&gt;<i>
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| TcpAcceptor.cc(222) doAccept: New
</I>&gt;<i> connection
</I>&gt;<i> &gt; on FD 12
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| TcpAcceptor.cc(297) acceptNext: connection
</I>&gt;<i> on
</I>&gt;<i> &gt; local=0.0.0.0:3130 remote=[::] FD 12 flags=25
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| client_side.cc(3890)
</I>&gt;<i>
</I>&gt;<i> Notice how the connection local IP:port details change from port 3130 to
</I>&gt;<i> port 443. Thats TPROXY working.
</I>&gt;<i>
</I>&gt;<i> &gt; httpsSslBumpAccessCheckDone: sslBump not needed for local=31.13.90.2:443
</I>&gt;<i> &gt; remote=192.168.0.102 FD 50 flags=17
</I>&gt;<i>
</I>&gt;<i> This is the &quot;ssl_bump none&quot; action working (by not doing anything TLS
</I>&gt;<i> related) exactly as you configured.
</I>&gt;<i>
</I>&gt;<i> Squid is now processing an internally generated CONNECT request
</I>&gt;<i> representing the intercepted TPROXY connection in a way that can be
</I>&gt;<i> logged and/or relayed to other proxies if it needs to.
</I>&gt;<i>
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| client_side.cc(2337) parseHttpRequest: HTTP
</I>&gt;<i> &gt; Client local=31.13.90.2:443 remote=192.168.0.102 FD 50 flags=17
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| client_side.cc(2338) parseHttpRequest: HTTP
</I>&gt;<i> &gt; Client REQUEST:
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; CONNECT 31.13.90.2:443 HTTP/1.1
</I>&gt;<i> &gt; Host: 31.13.90.2:443
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| client_side_request.cc(741)
</I>&gt;<i> &gt; clientAccessCheckDone: The request CONNECT 31.13.90.2:443 is ALLOWED;
</I>&gt;<i> last
</I>&gt;<i> &gt; ACL checked: localnet
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| client_side_request.cc(717)
</I>&gt;<i> &gt; clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| client_side_request.cc(741)
</I>&gt;<i> &gt; clientAccessCheckDone: The request CONNECT 31.13.90.2:443 is ALLOWED;
</I>&gt;<i> last
</I>&gt;<i> &gt; ACL checked: localnet
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| peer_select.cc(280) peerSelectDnsPaths:
</I>&gt;<i> Found
</I>&gt;<i> &gt; sources for '31.13.90.2:443'
</I>&gt;<i>
</I>&gt;<i> The CONNECT request uses a raw-IP address provided by TPROXY. There is
</I>&gt;<i> no name to resolve.
</I>&gt;<i>
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| peer_select.cc(281) peerSelectDnsPaths:
</I>&gt;<i> &gt; always_direct = ALLOWED
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| peer_select.cc(282) peerSelectDnsPaths:
</I>&gt;<i> &gt;  never_direct = DENIED
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| peer_select.cc(288) peerSelectDnsPaths:
</I>&gt;<i> &gt;  ORIGINAL_DST = local=192.168.0.102 remote=31.13.90.2:443 flags=25
</I>&gt;<i> &gt; 2015/08/17 12:38:10.248 kid1| peer_select.cc(295) peerSelectDnsPaths:
</I>&gt;<i> &gt;  timedout = 0
</I>&gt;<i>
</I>&gt;<i> ... stuff happens for 2 seconds...
</I>&gt;<i>
</I>&gt;<i> &gt; 2015/08/17 12:38:12.621 kid1| client_side.cc(815) swanSong: local=
</I>&gt;<i> &gt; 31.13.90.2:443 remote=192.168.0.102 flags=17
</I>&gt;<i> &gt; 2015/08/17 12:38:12.625 kid1| client_side.cc(815) swanSong: local=
</I>&gt;<i> &gt; 31.13.90.2:443 remote=192.168.0.102 flags=17
</I>&gt;<i>
</I>&gt;<i> Then the connection closes.
</I>&gt;<i>
</I>&gt;<i> Looks perfectly normal and expected behaviour to me considering what you
</I>&gt;<i> configured.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The logs with http (port 80) has the name resolution of navigation.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I disabled pinger because give some error:
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt; 2015/08/17 12:49:55| FATAL: pinger: Unable to open any ICMP sockets.
</I>&gt;<i>
</I>&gt;<i> Okay. Not a big problem. The pinger helper needs its suid bit set, which
</I>&gt;<i> is not working on all system installations yet. Disabling it is fine.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Do I have to setup local DNS server? the internal DNS of squid can't
</I>&gt;<i> handle
</I>&gt;<i> &gt; https in Tproxy?
</I>&gt;<i> &gt; What's missing to have name resolution in https traffic as its showed in
</I>&gt;<i> &gt; http traffic?
</I>&gt;<i>
</I>&gt;<i> Whats missing is the SSL-bumping part. HTTPS works differently to HTTP.
</I>&gt;<i>
</I>&gt;<i> The URL domain name and all the rest of the HTTP message is encrypted
</I>&gt;<i> *in full*. There is simply no client HTTP message involved if you don't
</I>&gt;<i> decrypt.
</I>&gt;<i>
</I>&gt;<i> As I mentioned above what you are seeing in the log is a Squid-generated
</I>&gt;<i> CONNECT message. Its the HTTP representation of the intercepted TCP SYN
</I>&gt;<i> packet and contains purely raw-IP:port details.
</I>&gt;<i>
</I>&gt;<i> TLS does have an SNI record which is sent by browsers un-encrypted that
</I>&gt;<i> can be used as domain for some things. BUT, that requires &quot;ssl_bump
</I>&gt;<i> peek&quot; action at minimum, and has no guarantee of actually being present.
</I>&gt;<i>
</I>&gt;<i> SNI is also still a new feature, and is not used for these fake CONNECT
</I>&gt;<i> requests anyway (since they represent the TCP SYN). So you wont see any
</I>&gt;<i> log difference in 3.5 even if you do let your Squid use it for ACLs.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150818/2caa9cdf/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150818/2caa9cdf/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005030.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
	<LI>Next message (by thread): <A HREF="005062.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5059">[ date ]</a>
              <a href="thread.html#5059">[ thread ]</a>
              <a href="subject.html#5059">[ subject ]</a>
              <a href="author.html#5059">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
