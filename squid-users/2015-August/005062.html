<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bridge/Tproxy: https dns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bridge/Tproxy%3A%20https%20dns&In-Reply-To=%3C55D36D7D.6040901%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005059.html">
   <LINK REL="Next"  HREF="005025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bridge/Tproxy: https dns</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bridge/Tproxy%3A%20https%20dns&In-Reply-To=%3C55D36D7D.6040901%40treenet.co.nz%3E"
       TITLE="[squid-users] Bridge/Tproxy: https dns">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 18 17:38:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005059.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
        <LI>Next message (by thread): <A HREF="005025.html">[squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5062">[ date ]</a>
              <a href="thread.html#5062">[ thread ]</a>
              <a href="subject.html#5062">[ subject ]</a>
              <a href="author.html#5062">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/08/2015 4:54 a.m., Pedro Correia Sardinha wrote:
&gt;<i> Thank you Amos for the review.
</I>&gt;<i> 
</I>&gt;<i> Following your advice... trying to use the pure transparent proxy (Tproxy)
</I>&gt;<i> but getting different behaviours with google domains in google chrome and
</I>&gt;<i> after adding peek there aren't still no names in https addresses.
</I>
Like I said. peek allows you to do ACL stuff with a server name. But it
wont show up in the log because the log is showing  the TCP SYN
equivalent CONNECT request. *TCP* uses just IP:port details.

&gt;<i> 
</I>&gt;<i> First create ssl certs directory, just to check later.
</I>&gt;<i> /usr/lib64/squid/ssl_crtd -c -s /var/log/squid/lib/ssl_db
</I>&gt;<i> 
</I>&gt;<i> remove from squid.conf:
</I>&gt;<i> #tcp_outgoing_address
</I>&gt;<i> #always_direct allow ssl-bump_port
</I>&gt;<i> #ssl_bump none all
</I>&gt;<i> 
</I>&gt;<i> add to squid.conf:
</I>&gt;<i> ssl_bump splice localnet
</I>
&quot;splice&quot; is the same as just doing a tunnel. This should just do the
same thing as your earlier &quot;none&quot; configuration for all traffic arriving
from &quot;localnet&quot; machines. Which should be about 100% of your traffic yes?

So it does not even reach the peek...

&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> I removed IPv6 restriction in kernel and in new squid compile without
</I>&gt;<i> --disable-ipv6 option. And I added some similiar IPv6 rules to Tproxy boot
</I>&gt;<i> script.
</I>&gt;<i> 
</I>&gt;<i> I continue to not generate-host-certificates(=off), I can check it in
</I>
I dont quite undertand that sentence. Missing words?

&gt;<i> ssl_db directory. But, just for testing, if I change
</I>&gt;<i> generate-host-certificates to on then there are certificates changes with
</I>&gt;<i> my self CA Autority notice in Google Chrome related to google sites, some
</I>&gt;<i> other sites tested get the certificate in right way. In IE and Firefox
</I>&gt;<i> there are no certificates issues.
</I>&gt;<i> A workaround for this issue in Google Chrome with websites in google
</I>&gt;<i> domains was create a specific acl for IP from google domains and splice
</I>&gt;<i> first like did with localnet:
</I>&gt;<i> acl google dst &quot;/etc/squid/google.txt&quot;
</I>
No. Use an ACL type of &quot;ssl::server_name&quot;.

 acl google ssl::server_name &quot;/etc/squid/google.txt&quot;
 acl step1 at_step SslBump1

 ssl_bump peek step1
 ssl_bump splice google
 ssl_bump bump all

That will use the SNI details from the peek to match against the google
domain names the browser is requesting. You can splice based on that
before any decryption or cert generation happens.

Then bump everything else.

&gt;<i> ...
</I>&gt;<i> ssl_bump splice google
</I>&gt;<i> ...
</I>
Yes Google Chrome was created by Google (surprise). They embed their
legitimate CA certificate for their web servers directly into the
browser itself in a feature they call &quot;cert pinning&quot;.

Whatever your Squid generates cannot match that certificate because you
dont have Googles private credential key.

&gt;<i> 
</I>&gt;<i> After those changes and setup ssl-bump with peek for most of sites (e.g.
</I>&gt;<i> facebook) but still no names in logs, just the IP in https navigation.
</I>&gt;<i> 
</I>&gt;<i> access.log:
</I>&gt;<i> 1439907457.958     49 192.168.0.102 TCP_MISS/200 910 POST
</I>&gt;<i> <A HREF="http://ocsp.digicert.com/">http://ocsp.digicert.com/</A> - ORIGINAL_DST/93.184.220.29
</I>&gt;<i> application/ocsp-response
</I>&gt;<i> 1439907466.798  59053 192.168.0.102 TCP_TUNNEL/200 3944 CONNECT
</I>&gt;<i> 212.113.184.216:443 - ORIGINAL_DST/212.113.184.216 -
</I>&gt;<i> 1439907472.813  58798 192.168.0.102 TCP_TUNNEL/200 8320 CONNECT
</I>&gt;<i> 212.113.185.35:443 - ORIGINAL_DST/212.113.185.35 -
</I>&gt;<i> 1439907472.817  59014 192.168.0.102 TCP_TUNNEL/200 5234 CONNECT
</I>&gt;<i> 212.113.184.221:443 - ORIGINAL_DST/212.113.184.221 -
</I>&gt;<i> 1439907490.935  65674 192.168.0.102 TCP_TUNNEL/200 4207 CONNECT
</I>&gt;<i> 54.171.32.174:443 - ORIGINAL_DST/54.171.32.174 -
</I>&gt;<i> 1439907527.998 115712 192.168.0.102 TCP_TUNNEL/200 5485 CONNECT
</I>&gt;<i> 54.192.61.197:443 - ORIGINAL_DST/54.192.61.197 -
</I>&gt;<i> 1439907545.804 122741 192.168.0.102 TCP_TUNNEL/200 5817 CONNECT
</I>&gt;<i> 132.245.50.66:443 - ORIGINAL_DST/132.245.50.66 -
</I>&gt;<i> 
</I>
Still TUNNEL'ing. Probably that first &quot;splice&quot; this time. Two ways to
reach the same result.


&gt;<i> 
</I>&gt;<i> cache.log:
</I>&lt;snip&gt;

&gt;<i> 2015/08/18 15:17:38.152 kid1| TcpAcceptor.cc(222) doAccept: New connection
</I>&gt;<i> on FD 15
</I>&gt;<i> 2015/08/18 15:17:38.152 kid1| TcpAcceptor.cc(297) acceptNext: connection on
</I>&gt;<i> local=[::]:3130 remote=[::] FD 15 flags=25
</I>&gt;<i> 2015/08/18 15:17:38.153 kid1| client_side.cc(3890)
</I>&gt;<i> httpsSslBumpAccessCheckDone: sslBump not needed for local=31.13.90.6:443
</I>&gt;<i> remote=192.168.0.102 FD 40 flags=17
</I>
&quot;not needed&quot; still because of splice implying TUNNEL.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005059.html">[squid-users] Bridge/Tproxy: https dns
</A></li>
	<LI>Next message (by thread): <A HREF="005025.html">[squid-users] debian Jessie squid with auth (kerberos/ntlm/basic) ERROR type NTLM type 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5062">[ date ]</a>
              <a href="thread.html#5062">[ thread ]</a>
              <a href="subject.html#5062">[ subject ]</a>
              <a href="author.html#5062">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
