<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] can't get bump to work anymore on 3.5.7?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20get%20bump%20to%20work%20anymore%20on%203.5.7%3F&In-Reply-To=%3C55D455CF.9030907%40trimble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005070.html">
   <LINK REL="Next"  HREF="005081.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] can't get bump to work anymore on 3.5.7?</H1>
    <B>Jason Haar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20get%20bump%20to%20work%20anymore%20on%203.5.7%3F&In-Reply-To=%3C55D455CF.9030907%40trimble.com%3E"
       TITLE="[squid-users] can't get bump to work anymore on 3.5.7?">Jason_Haar at trimble.com
       </A><BR>
    <I>Wed Aug 19 10:09:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005070.html">[squid-users] can't get bump to work anymore on 3.5.7?
</A></li>
        <LI>Next message (by thread): <A HREF="005081.html">[squid-users] can't get bump to work anymore on 3.5.7?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5073">[ date ]</a>
              <a href="thread.html#5073">[ thread ]</a>
              <a href="subject.html#5073">[ subject ]</a>
              <a href="author.html#5073">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/08/15 16:07, Alex Rousskov wrote:
&gt;<i> Your interpretation is correct: Your configuration tells Squid to peek
</I>&gt;<i> at steps #1 and #2 and then try to bump at step #3. Unfortunately, the
</I>&gt;<i> last two actions (peeking at step #2 and then bumping at step #3) are
</I>&gt;<i> usually not compatible. Please see the Limitations section at
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>

Ah! I used to use &quot;external_acl_type&quot; to run a script that would check
the SSL status of the host:port and that would allow squid to decide
whether to bump or splice. I'd turned it off for whatever reason - I
guess that's why it was working before. (in all of this I am speaking in
the context of transparent TLS - I realize for the formal proxy scenario
you typically have the SNI name/hostname via the CONNECT method). Sure
enough, once I deleted the peeks, it started bumping

So is there no way to get the SNI field from the client without breaking
the opportunity for bump? It's just that my testing has already shown
everyone using CloudFlare for HTTPS is now protected by their WAF
technology - which rejects SSL sessions that don't contain SNI. So if
you are wanting to (transparently) bump HTTPS, you can't use peek - but
you need peek in order to discover the SNI hostname, because if you
don't have that then  acls using ssl::server_name_regex and/or
&quot;external_acl_type&quot; will basically get rejected talking to vast numbers
of https servers in the world. This is a bit of a catch-22

My packet sniffer implies the SNI details is in the first TLS packet
sent from the client (ie pre-encryption). So couldn't squid just make a
note of that detail? Sort of a &quot;pre-peek&quot; I guess? I read about how
there are so many SSL extensions/etc that squid will always be running
afoul of issues if it tries to be too smart, but can't we look at this as

1. client-&gt;server (3-way TCP handshake)
2. client sends first TLS packet (contains extensions data - including
SNI). Gets to squid server
3. squid can extract that data, and make decisions immediately just on
that one packet. It can compare with acls and decide to bump or splice
4. if bump, squid forms the client-&gt;squid TLS channel and a separate
squid-&gt;server TLS channel
5. if splice, squid now forms a TCP channel to the server, then forwards
that first TLS packet, then &quot;joins the two ends&quot;
6. waits for next client packet


If all HTTPS transactions contained the hostname (because of CONNECT or
SNI), then squid could be set to default to bump, but to splice known
&quot;un-bumpable&quot; sites  - due to pinning or because they are not actually
HTTPS sites (eg Skype). It just seems like it's currently limited to
default splice, with bumping explicit things? (which I can't believe is
useful)

-- 
Cheers

Jason Haar
Corporate Information Security Manager, Trimble Navigation Ltd.
Phone: +1 408 481 8171
PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005070.html">[squid-users] can't get bump to work anymore on 3.5.7?
</A></li>
	<LI>Next message (by thread): <A HREF="005081.html">[squid-users] can't get bump to work anymore on 3.5.7?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5073">[ date ]</a>
              <a href="thread.html#5073">[ thread ]</a>
              <a href="subject.html#5073">[ subject ]</a>
              <a href="author.html#5073">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
