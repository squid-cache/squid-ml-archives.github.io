<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to have squid as safe as (e.g.) firefox?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20have%20squid%20as%20safe%20as%20%28e.g.%29%20firefox%3F&In-Reply-To=%3C55D4B854.3080506%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005082.html">
   <LINK REL="Next"  HREF="005088.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to have squid as safe as (e.g.) firefox?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20have%20squid%20as%20safe%20as%20%28e.g.%29%20firefox%3F&In-Reply-To=%3C55D4B854.3080506%40treenet.co.nz%3E"
       TITLE="[squid-users] How to have squid as safe as (e.g.) firefox?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 19 17:09:40 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005082.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
        <LI>Next message (by thread): <A HREF="005088.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5086">[ date ]</a>
              <a href="thread.html#5086">[ thread ]</a>
              <a href="subject.html#5086">[ subject ]</a>
              <a href="author.html#5086">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/08/2015 3:43 a.m., Jeremie Rafin wrote:
&gt;<i> Amos and Alex,
</I>&gt;<i> 
</I>&gt;<i> Thanks a lot for all your advises. I appreciate your helpful comments! :))
</I>&gt;<i> 
</I>&gt;<i> Nevertheless, all is not cristal clear for me. I have setup a sandbox (virtual box with squid 3.5.7 on debian 7.6; for transparent proxy, I have setup NAT iptables and IP route to run client through squid; my client browser is configured with squid certificate) and have tried many configurations. I am still a little bit lost...
</I>&gt;<i> 
</I>&gt;<i> Let me sum-up my needs, first. In a family context, I would like:
</I>&gt;<i> -a) to black/white list accesses (with e.g. squidguard);
</I>
Use ufdbguard if you actually have to have one of these. SG is a dead
project.

Or just use an ACL blacklist/whitelist in squid.conf. Far simpler.


&gt;<i> -b) to check for content (with e.g. diladele or e2guardian);
</I>
Use an ICAP / eCAP service instead. It will greatly simplify your next
requirements implementation ...

&gt;<i> -c) to do that for https (because more and more sites cipher links, like google);
</I>&gt;<i> -d) not to check for content for a given (spliced) sites (like banks);
</I>&gt;<i> -e) not to degrade security; for instance, revoked CA must not succeed in access, even if bumped;
</I>&gt;<i> -f) [nice to have]: to do this in a transparent proxy way; but explicit proxy would also be ok, if required.
</I>&gt;<i> 
</I>&gt;<i> Second, as per your advises, and some searches, I have setup this configuration (from the default one, unchanged; no third party, yet):
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Black list: meteofrance (http) and google (https)
</I>&gt;<i> acl blacklist dstdomain .meteofrance.com
</I>&gt;<i> acl sslblacklist ssl::server_name .google.fr
</I>&gt;<i> http_access deny blacklist
</I>&gt;<i> http_access deny sslblacklist
</I>

Is that &quot;sslblacklist&quot; test in http_access actually matching?

I didn't think we had ssl_server_name working outside the ssl_bump rules
yet. Good news if we do.


&gt;<i> 
</I>&gt;<i> # Non bumped list (only spliced): wellsfargo
</I>&gt;<i> acl splicelist ssl::server_name .wellsfargo.com
</I>&gt;<i> 
</I>&gt;<i> # SSL configuration
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice step2 splicelist
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> # Web access
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> http_port 3126 intercept
</I>&gt;<i> https_port 3127 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> sslcrtd_program /usr/local/squid-3.5/lib/squid/ssl_crtd -s /var/spool/squid3_ssldb -M 4MB
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> With this config file, I am able to satisfy my requirements a, b
</I>(ready for), c, d and f (I mean a, b, c and d are ok in transparent and
explicit modes). But e fails: <A HREF="https://revoked.grc.com/">https://revoked.grc.com/</A> is not rejected.
&gt;<i> 
</I>&gt;<i> So, even if I think my configuration is much cleaner thanks to you
</I>(you will probably comment), I have still the same feeling of degrading
the security when bumping. Hence, my main question remains (title of the
thread): how to get (at least) revocation working (requirement &quot;e&quot;)?
&gt;<i> 
</I>

I was about to suggest the CRL file loading option. But I see that
Squid-3 did not actually expose that option in squid.conf, even though
the code behind it was present. I guess that is another new config
feature coming in Squid-4 then, since its now possible.

For now in 3.5 there is still the cert validator helper. Should be
possible through that I think.


&gt;<i> 
</I>&gt;<i> During my investigation, I have met some other difficulties (these
</I>points are less important than above main question, but are still obscur
for me):
&gt;<i> 
</I>&gt;<i> -&quot;peek&quot;/&quot;splice&quot;/&quot;bump&quot;: nothing is logged in access.log (I tried a
</I>&quot;debug_options ALL,9&quot;; no success); I have read in some post that
nothing is logged yet, but I double check: is it planed (or done) to get
log for SSL decision?

I hoping it will be eventually. But Christos appears to be concentrating
on getting the underlying security operations working well and finalized.

&gt;<i> 
</I>&gt;<i> -with this SSL configuration:
</I>&gt;<i> #
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> # SSL configuration
</I>&gt;<i> ssl_bump splice splicelist
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> #
</I>&gt;<i>  -all works but **only in explicit proxy**; in transparent, the HTTPS are failing (no certification???); if I add a &quot;ssl_bump peek all&quot; before the &quot;bump&quot; rule, all https accesses are peeked (poken?) or spliced; nothing is bumped (in explicit and transparent); is it normal?
</I>&gt;<i>  -furthermore, google is not blacklisted **only** in transparent mode! Why?
</I>&gt;<i>  -the wiki (<A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>) does not mention this need of step1/step2 (like first configuration) for having splice/bump decision working well in transparent mode, does it?
</I>&gt;<i> 
</I>&gt;<i> -I noticed a quite similar unexpected behavior for &quot;ssl_bump terminate&quot; without &quot;step1/step2&quot;; for instance, a simple &quot;ssl_bump terminate all&quot; gives:
</I>&gt;<i>  -in transparent mode: no effet (no bump, no black list), all is spliced (or poken);
</I>&gt;<i>  -in explicit mode: google is rejected but every other https works (in a non bumped way);
</I>&gt;<i> Why?
</I>&gt;<i> Note that &quot;terminate&quot; behaves logically (i.e. as I would expect) with a preceeding &quot;acl step1 at_step SslBump1/acl step2 at_step SslBump2/ssl_bump peek step1 all&quot;. With &quot;all&quot; or, for instance, with &quot;sslblacklist&quot;.
</I>&gt;<i> 
</I>

The page is outdated, essentially unchanged from when the whole feature
was a wishlist plan and no actual code. So it does not reflect much of
what the latest code actually does when bugs and workaround hacks are
accounted for.

There is another patch coming down to 3.5 in the next few days which
will resolve a lot of the little oddities in the actions selected. It
should make the behaviour more accurately follow that documentation.



&lt;snip, but remembering the feedback for later&gt;
&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Hide PROXY
</I>&gt;&gt;&gt;<i> via off
</I>&gt;&gt;&gt;<i> forwarded_for delete
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does *not* hide the proxy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hides the *client* by actively &quot;shouting&quot; the proxy details out to the
</I>&gt;&gt;<i> world in protocol places where the client details would normally go.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This is another interesting topic -maybe not the right place here.
</I>&gt;<i> The goal is to get video streaming: some web sites refuse to provide video if a proxy is detected (because of broadcast laws); to debug I use these sites (streaming web site is very slow): 
</I>&gt;<i>  <A HREF="http://whatismyipaddress.com/proxy-check">http://whatismyipaddress.com/proxy-check</A>
</I>&gt;<i>  <A HREF="http://proxydetect.com/">http://proxydetect.com/</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The only configuration I have found to hide the proxy (and to get the video streaming) was the above one. If you have a better configuration, I would be curious to know it: all of the configurations I found on internet was failing (and I was not able to find something else that works).
</I>&gt;<i> Thanks :)
</I>
 &quot;forwarded_for transparent&quot; (rather than delete. A tool can test for a
proxy deleting XFF).

Plus TPROXY. But that is another complex feature almost as tricky as
ssl_bump for some OS. So get one sorted out before mixing the other in.

Each time you bump a TLS certificate though, you will expose the proxy
via it too. Which can be tested for if the origin gets desperate to
prevent HTTP working properly (proxy support is a non-optional part of
the standards).

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005082.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
	<LI>Next message (by thread): <A HREF="005088.html">[squid-users] How to have squid as safe as (e.g.) firefox?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5086">[ date ]</a>
              <a href="thread.html#5086">[ thread ]</a>
              <a href="subject.html#5086">[ subject ]</a>
              <a href="author.html#5086">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
