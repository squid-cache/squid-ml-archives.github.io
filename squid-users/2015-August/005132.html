<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Lots of &quot;Vary object loop!&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Lots%20of%20%22Vary%20object%20loop%21%22&In-Reply-To=%3C55D9AB13.2000702%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005122.html">
   <LINK REL="Next"  HREF="005187.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Lots of &quot;Vary object loop!&quot;</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Lots%20of%20%22Vary%20object%20loop%21%22&In-Reply-To=%3C55D9AB13.2000702%40treenet.co.nz%3E"
       TITLE="[squid-users] Lots of &quot;Vary object loop!&quot;">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Aug 23 11:14:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005122.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="005187.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5132">[ date ]</a>
              <a href="thread.html#5132">[ thread ]</a>
              <a href="subject.html#5132">[ subject ]</a>
              <a href="author.html#5132">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/08/2015 4:20 a.m., Sebastian Goicochea wrote:
&gt;<i> Hello everyone, I'm having a strange problem:
</I>&gt;<i> 
</I>&gt;<i> Several servers, same hardware, using same version of squid (3.5.4)
</I>&gt;<i> compiled using the same configure options, same configuration files. But
</I>&gt;<i> in two of them I get LOTS of these Vary object loop! lines in cache.log
</I>&gt;<i> 
</I>&gt;<i> 2015/08/21 13:07:52 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt,
</I>&gt;<i> '<A HREF="http://resources.mlstatic.com/frontend/vip-fend-webserver/assets/bundles/photoswipe-6301b943e5586fe729e5d6480120a893.js">http://resources.mlstatic.com/frontend/vip-fend-webserver/assets/bundles/photoswipe-6301b943e5586fe729e5d6480120a893.js</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip&quot;'
</I>&gt;<i> 2015/08/21 13:07:52 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/08/21 13:07:52 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt, '<A HREF="http://www.google.com/afs/ads/i/iframe.html">http://www.google.com/afs/ads/i/iframe.html</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,%20deflate&quot;'
</I>&gt;<i> 2015/08/21 13:07:52 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/08/21 13:08:01 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt,
</I>&gt;<i> '<A HREF="http://minicuotas.ribeiro.com.ar/images/products/large/035039335000.jpg">http://minicuotas.ribeiro.com.ar/images/products/large/035039335000.jpg</A>' 'accept-encoding=&quot;gzip,%20deflate&quot;'
</I>&gt;<i> 
</I>&gt;<i> 2015/08/21 13:08:01 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 
</I>&gt;<i> I've read what I could find on forums but could not solve it. Is this
</I>&gt;<i> something to worry about?
</I>
The short answer:

Yes and no. Squid is signalling that it is completely unable to perform
its caching duty for these URLs. The proxying duty continues with only
high latency visible to the client.

It is up to you whether that latency cost is urgent or not. It is
certainy high enough importance that you need to be told each time (no
rate limiting) when you have asked to receive important notices.


&gt;<i> If that is not the case, how can I disable the
</I>&gt;<i> excessive logging?
</I>
You can reduce your logging level to show only critical problems,
instead of showing all details rated 'important'.

  debug_options ALL,0

NOTE: important (ALL,1) includes a lot of things like this that do
really need to be fixed to get better service out of either your proxy
or the underlying network. But can be put on your todo list if you dont
have time right now.


&gt;<i> Which is the condition that generates this?
</I>

In long;


The &quot;whats happening&quot; is:

Your cache contains an object which was delivered by the server along
with headers stating that behind the URL is a large set of porssible
responses. *all* requests for that URL use a certain set of headers
(listed in Vary) to determine which binary-level object is applicable
(or not) on a per-client / per-reqeust basis.
 In order to cache the object Squid has to follow that same selection
criteria *exactly*.

Most common example is gzip vs non-gzip encoded copies of things. Which
you can see those messages relate to.

Squid stores this information in a &quot;Vary object&quot; associated with only
the URL. That vary object is used to perform a secondary cache index
lookup to see if the partiular variant needed is stored.

The expectation is that there would be 3+ objects stored for this URL; a
gzip data object, various non-gzip data objects, and a metadata object
(&quot;Vary object&quot;) telling Squid that it needs to look at the
accept-encoding header to find which of the those data objects to send
the client.


The messages themselves mean:

&quot;Oops. Not a Vary match on second attempt&quot;

 - that the Vary object saying look at headers X+Y+X is pointing at
itself or another Vary metadata object saying look at some other
headers. A URL cannot have two different Vary header values
simultaneously (Vary is a single list &quot;value&quot;).
Something really weird is going on in your cache. Squid should handle
this by abandoning the cache lookups and go to the origin for fresh copies.

You could be causing it by using url-rewrite or store-id helpers wrongly
to pass requests for a URL to servers which produce different responses.
So that is well worth looking into.

IMPORTANT: It is mandatory that any re-writing only be done to
'collapse' URLs that are *actually* producing identical objects and
producing them in (outwardly) identical ways. This Vary looping is just
the tip of an iceberg of truly horrible failures that occur &quot;silently&quot;
with re-writing.



There is another similar message that can be mixed in the long list:

&quot;Oops. Not a Vary object on second attempt,&quot; (note the 1-word difference)
 - this is almost but not quite so bad, and is usually seen with broken
origin servers. All you can do about the problem itself then is fire off
bug reports to people and hope it gets fixed by the sysadmin in charge.


Both situations are very bad for HTTP performance, and bad for churning
your cache as well. But Squid can cope easily enough by just fetching a
new object and dropping what is in the cache. That &quot;Vary object loop!&quot;
message is telling you Squid is doing exactly that.


A quick test with the tool at redbot.org shows that the
resources.mlstatic.com server is utterly borked. Not even sending
correct ETag ids for the objects its outputting. Thats a sign to me that
the admin is trying to be smart with headers, and getting it very badly
wrong.

minicuotas.ribeiro.com.ar is also a Nginx server. But only showing the
signs of normal default nginx brokenness
(&lt;<A HREF="http://trac.nginx.org/nginx/ticket/118">http://trac.nginx.org/nginx/ticket/118</A>&gt;).

The only thing you can do about that nginx bug is add pressure to get it
fixed, or cut away all the Accept-Encoding headers on all requests sent
to those servers. (request_header_access Accept-Encoding deny ...) Squid
is already doing everything it reasonably can to correct the traffic
output to your clients.


The google related messages ... they are usually pretty good at this
type of thing and my tests do show their server to be working correctly.
 So that points me back at suspecting your config does something bad
with url-rewriter or store-id helpers.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005122.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="005187.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5132">[ date ]</a>
              <a href="thread.html#5132">[ thread ]</a>
              <a href="subject.html#5132">[ subject ]</a>
              <a href="author.html#5132">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
