<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FATAL: Unable to open HTTPS Socket
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20Unable%20to%20open%20HTTPS%20Socket&In-Reply-To=%3C55DD5046.5000101%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005170.html">
   <LINK REL="Next"  HREF="005183.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FATAL: Unable to open HTTPS Socket</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20Unable%20to%20open%20HTTPS%20Socket&In-Reply-To=%3C55DD5046.5000101%40treenet.co.nz%3E"
       TITLE="[squid-users] FATAL: Unable to open HTTPS Socket">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 26 05:36:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005170.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
        <LI>Next message (by thread): <A HREF="005183.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5182">[ date ]</a>
              <a href="thread.html#5182">[ thread ]</a>
              <a href="subject.html#5182">[ subject ]</a>
              <a href="author.html#5182">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/08/2015 6:51 a.m., Oliver Webb wrote:
&gt;<i> TLDR Skip to ----------
</I>&gt;<i> 
</I>&gt;<i> I have squid 3.5.7 installed on linux with the following configure options:
</I>&gt;<i> 
</I>&gt;<i>  '--build=arm-linux-gnueabihf' '--prefix=/usr' '--localstatedir=/var' '--libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-default-user=proxy' '--with-logdir=/var/log' '--with-pidfile=/var/run/squid.pid' '--enable-ssl' '--with-openssl' '--enable-ssl-crtd' '--enable-delay-pools' '--enable-external-acl-helpers=session' 'build_alias=arm-linux-gnueabihf'
</I>&gt;<i> 
</I>&gt;<i> I have the following ports assigned in squid.conf:
</I>&gt;<i> 
</I>&gt;<i> http_port 3129
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/myCA.pem
</I>&gt;<i> 
</I>&gt;<i> I also have IPTables redirecting port 443 traffic to port 3130 and port 80 traffic to 3128
</I>&gt;<i> 
</I>&gt;<i> For port 80 HTTP traffic the proxy works fine pages load except blocked ones which the proxy successfully replaces which blocked message
</I>&gt;<i> 
</I>&gt;<i> Port 443 HTTPS traffic is successfully bumped by squid and the certificate is replaced with the dynamically generated one.
</I>&gt;<i> ----------
</I>&gt;<i> HOWEVER
</I>&gt;<i> The page squid serves over the browser-squid tunnel is the ERR_DNS_FAIL error page with the %H hostname template code evaluated to 'http' (without quotes)
</I>&gt;<i> 
</I>
That means one or more of these is most likely:

A) the SNI value sent by the client was &quot;http&quot;.
 - that is invalid TLS protocol

B) the Host header in the HTTP message was &quot;Host: http:443&quot; or &quot;Host:
<A HREF="http://blah">http://blah</A>&quot;
 - both are invalid FQDN

C) the reverse-DNS for the IP address Squid is dealing with says &quot;http&quot;
 - that is an invalid DNS record


Maybe be more I've overlooked right now.


&gt;<i> Also in the cache.log the following message appears after every HTTPS request
</I>&gt;<i> FATAL: Unable to open HTTPS Socket
</I>

For (B) and some of (A), try adding &quot;debug_options 11,2 83,5&quot; to your
config file and see what the messages are doing in Squid.
 If there are no HTTP messages, then the issue is in the TLS or DNS layers.

For the rest of (A), you will likely need to use packet captures to see
what is happening on the connections both in and out of Squid
(from-client and to-server). The TLS/SSL library command line test tools
may also be useful there to track the TLS protocol details Squis is not
showing well yet.


For (C) try resolving the domain name &quot;http&quot; from the command line of
your Squid machine.

If you configured dns_nameservers directive in squid.conf repeat that
test using each of the listed servers.

If the machine normal lookup works but the Squid NS fail, you may need
to add dns_defnames and dns_appenddomain directives to your squid.conf
with details that match what /etc/resolv.conf tells the machine to do.


PS. The best setup IMHO, is to remove the dns_* directives entirely and
let Squid use the normal /etc/resolv.conf settings.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005170.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
	<LI>Next message (by thread): <A HREF="005183.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5182">[ date ]</a>
              <a href="thread.html#5182">[ thread ]</a>
              <a href="subject.html#5182">[ subject ]</a>
              <a href="author.html#5182">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
