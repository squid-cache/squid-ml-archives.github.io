<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FATAL: Unable to open HTTPS Socket
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20Unable%20to%20open%20HTTPS%20Socket&In-Reply-To=%3C55DD877F.7010105%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005182.html">
   <LINK REL="Next"  HREF="005184.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FATAL: Unable to open HTTPS Socket</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20Unable%20to%20open%20HTTPS%20Socket&In-Reply-To=%3C55DD877F.7010105%40gmail.com%3E"
       TITLE="[squid-users] FATAL: Unable to open HTTPS Socket">yvoinov at gmail.com
       </A><BR>
    <I>Wed Aug 26 09:31:43 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005182.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
        <LI>Next message (by thread): <A HREF="005184.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5183">[ date ]</a>
              <a href="thread.html#5183">[ thread ]</a>
              <a href="subject.html#5183">[ subject ]</a>
              <a href="author.html#5183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
Amos,

this issue looks like very similar to bug 4188, isn't it?

WBR, Yuri

26.08.15 11:36, Amos Jeffries &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> On 26/08/2015 6:51 a.m., Oliver Webb wrote:
</I>&gt;&gt;<i> TLDR Skip to ----------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have squid 3.5.7 installed on linux with the following configure
</I>options:
&gt;&gt;<i>
</I>&gt;&gt;<i>  '--build=arm-linux-gnueabihf' '--prefix=/usr' '--localstatedir=/var'
</I>'--libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid'
'--sysconfdir=/etc/squid' '--with-default-user=proxy'
'--with-logdir=/var/log' '--with-pidfile=/var/run/squid.pid'
'--enable-ssl' '--with-openssl' '--enable-ssl-crtd'
'--enable-delay-pools' '--enable-external-acl-helpers=session'
'build_alias=arm-linux-gnueabihf'
&gt;&gt;<i>
</I>&gt;&gt;<i> I have the following ports assigned in squid.conf:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3129
</I>&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>dynamic_cert_mem_cache_size=4MB cert=/etc/squid/myCA.pem
&gt;&gt;<i>
</I>&gt;&gt;<i> I also have IPTables redirecting port 443 traffic to port 3130 and
</I>port 80 traffic to 3128
&gt;&gt;<i>
</I>&gt;&gt;<i> For port 80 HTTP traffic the proxy works fine pages load except
</I>blocked ones which the proxy successfully replaces which blocked message
&gt;&gt;<i>
</I>&gt;&gt;<i> Port 443 HTTPS traffic is successfully bumped by squid and the
</I>certificate is replaced with the dynamically generated one.
&gt;&gt;<i> ----------
</I>&gt;&gt;<i> HOWEVER
</I>&gt;&gt;<i> The page squid serves over the browser-squid tunnel is the
</I>ERR_DNS_FAIL error page with the %H hostname template code evaluated to
'http' (without quotes)
&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That means one or more of these is most likely:
</I>&gt;<i>
</I>&gt;<i> A) the SNI value sent by the client was &quot;http&quot;.
</I>&gt;<i>  - that is invalid TLS protocol
</I>&gt;<i>
</I>&gt;<i> B) the Host header in the HTTP message was &quot;Host: http:443&quot; or &quot;Host:
</I>&gt;<i> <A HREF="http://blah">http://blah</A>&quot;
</I>&gt;<i>  - both are invalid FQDN
</I>&gt;<i>
</I>&gt;<i> C) the reverse-DNS for the IP address Squid is dealing with says &quot;http&quot;
</I>&gt;<i>  - that is an invalid DNS record
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Maybe be more I've overlooked right now.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Also in the cache.log the following message appears after every HTTPS
</I>request
&gt;&gt;<i> FATAL: Unable to open HTTPS Socket
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For (B) and some of (A), try adding &quot;debug_options 11,2 83,5&quot; to your
</I>&gt;<i> config file and see what the messages are doing in Squid.
</I>&gt;<i>  If there are no HTTP messages, then the issue is in the TLS or DNS
</I>layers.
&gt;<i>
</I>&gt;<i> For the rest of (A), you will likely need to use packet captures to see
</I>&gt;<i> what is happening on the connections both in and out of Squid
</I>&gt;<i> (from-client and to-server). The TLS/SSL library command line test tools
</I>&gt;<i> may also be useful there to track the TLS protocol details Squis is not
</I>&gt;<i> showing well yet.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For (C) try resolving the domain name &quot;http&quot; from the command line of
</I>&gt;<i> your Squid machine.
</I>&gt;<i>
</I>&gt;<i> If you configured dns_nameservers directive in squid.conf repeat that
</I>&gt;<i> test using each of the listed servers.
</I>&gt;<i>
</I>&gt;<i> If the machine normal lookup works but the Squid NS fail, you may need
</I>&gt;<i> to add dns_defnames and dns_appenddomain directives to your squid.conf
</I>&gt;<i> with details that match what /etc/resolv.conf tells the machine to do.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> PS. The best setup IMHO, is to remove the dns_* directives entirely and
</I>&gt;<i> let Squid use the normal /etc/resolv.conf settings.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJV3Yd/AAoJENNXIZxhPexGGd8H/1NfOxLblRGsy9qCaPY2yM1J
WnF2f5smag9uk+BW08OTz+Px+GePMl6lvdauUXp5NFj4YDNh1q94/tG7sKF0zyOG
qt3OafVSdbLuUooE80RjMRPTxaEM2ibgcEj7lAvsDdsQVOFlBJeaysyvsgi+jql5
zijJXcGFfy2y38nhSQAlt8WTgDwLEBxVT77twbSp64l3GMsknugF6X6z97Brwffg
IA01dKhUrXZl3ElJokp62XTMs+luBzopwuK77exEvxJSgn1chK6/F6V1GlDaxZYt
YL3LGiV57TToluMKxmPkmp9UjCTc+kMU23k8lSzOAYp7KXOhgDXJ0fdWafWhtSg=
=JXK6
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005182.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
	<LI>Next message (by thread): <A HREF="005184.html">[squid-users] FATAL: Unable to open HTTPS Socket
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5183">[ date ]</a>
              <a href="thread.html#5183">[ thread ]</a>
              <a href="subject.html#5183">[ subject ]</a>
              <a href="author.html#5183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
