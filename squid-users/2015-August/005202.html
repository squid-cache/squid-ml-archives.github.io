<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] peek all step with bump instance of proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20all%20step%20with%20bump%20instance%20of%20proxy&In-Reply-To=%3CCAOoFbVfiUV6oL_woB0WTSfdr_DnXobpmr6k4drs_opEMgOMUpQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005279.html">
   <LINK REL="Next"  HREF="005221.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] peek all step with bump instance of proxy</H1>
    <B>john jacob</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20all%20step%20with%20bump%20instance%20of%20proxy&In-Reply-To=%3CCAOoFbVfiUV6oL_woB0WTSfdr_DnXobpmr6k4drs_opEMgOMUpQ%40mail.gmail.com%3E"
       TITLE="[squid-users] peek all step with bump instance of proxy">john.kj1984 at gmail.com
       </A><BR>
    <I>Thu Aug 27 10:50:59 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005279.html">[squid-users] High-Availability in Squid
</A></li>
        <LI>Next message (by thread): <A HREF="005221.html">[squid-users] peek all step with bump instance of proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5202">[ date ]</a>
              <a href="thread.html#5202">[ thread ]</a>
              <a href="subject.html#5202">[ subject ]</a>
              <a href="author.html#5202">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

I am trying to configure a squid filtering instance which serves both proxy
and intercepted (transparent) connections. Filtering is accomplished by a
Request eCAP adapter which have something like

if(IsDenied() &amp;&amp; RequestMethod==&quot;CONNECT&quot;)
{
                          // Gives TAG_NONE/403 in the access log
 hostx-&gt;blockVirgin();
 return;
}

I also have a requirement to bump a particular domain and peek other https
connections for intercepted mode. So there are 3 possible
outcomes/filtering decision for any https connections hitting this server.
They are

1) Bump and allow the access
2) Non bumped and allowed access
3) Non bumped and denied access, by the code given above in eCAP adapter

My squid (tried with v3.5.6 and v3.5.7-20150823-r13895, same outcome)
config looks like below
.
.
.
#  TAG: ssl_bump
ssl_bump server-first &lt;ip of the domain to be bumped&gt;
ssl_bump peek all
ssl_bump splice all
.
.
.
http_port &lt;proxy ip&gt;:&lt;port&gt; ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=&lt;path&gt;


https_port &lt;intercept/transparent ip&gt;:&lt;port&gt; intercept ssl-bump
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=&lt;path&gt;

Things are fine with the intercepted connections (for all the 3 scenarios).
But with the proxy connections I am encountering some peculiar behavior
with scenario 3 (ie when a non bumped https CONNECT is denied by eCAP).
Instead of terminating the connection, it is logged as TAG_NONE/200 in the
access log and getting bumped (a dynamic certificate is generated) and then
getting terminated. The behavior disappears and works if I comment the
&quot;peek all&quot; line.

I am not sure if this is a bug or an expected behavior.

Of course the proxy bumped connection works fine if I selectively peek for
intercepted connections (ssl_bump peek &lt;if only in intercepted mode&gt;), but
in this case I am getting duplicate entries in the access log file (ie 2
CONNECT log messages for each https CONNECT) for intercepted mode https
connections.The same goes for other ACL combinations like the below
resulting in duplicated log messages

ssl_bump server-first &lt;ip of the domain to be bumped&gt;
ssl_bump splice &lt;only if the request hit the proxy ip:port and not the
intercept/transparent ip :port&gt;
ssl_bump peek all
ssl_bump splice all

Regards,
John
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150827/0dc19653/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150827/0dc19653/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005279.html">[squid-users] High-Availability in Squid
</A></li>
	<LI>Next message (by thread): <A HREF="005221.html">[squid-users] peek all step with bump instance of proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5202">[ date ]</a>
              <a href="thread.html#5202">[ thread ]</a>
              <a href="subject.html#5202">[ subject ]</a>
              <a href="author.html#5202">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
