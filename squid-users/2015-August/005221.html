<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] peek all step with bump instance of proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20all%20step%20with%20bump%20instance%20of%20proxy&In-Reply-To=%3C55DFA22A.4040603%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005202.html">
   <LINK REL="Next"  HREF="005222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] peek all step with bump instance of proxy</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20all%20step%20with%20bump%20instance%20of%20proxy&In-Reply-To=%3C55DFA22A.4040603%40measurement-factory.com%3E"
       TITLE="[squid-users] peek all step with bump instance of proxy">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Aug 27 23:50:02 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005202.html">[squid-users] peek all step with bump instance of proxy
</A></li>
        <LI>Next message (by thread): <A HREF="005222.html">[squid-users] peek all step with bump instance of proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5221">[ date ]</a>
              <a href="thread.html#5221">[ thread ]</a>
              <a href="subject.html#5221">[ subject ]</a>
              <a href="author.html#5221">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/27/2015 04:50 AM, john jacob wrote:

&gt;<i> with the proxy connections I am encountering some
</I>&gt;<i> peculiar behavior with scenario 3 (ie when a non bumped https CONNECT is
</I>&gt;<i> denied by eCAP). Instead of terminating the connection, it is logged as
</I>&gt;<i> TAG_NONE/200 in the access log and getting bumped (a dynamic certificate
</I>&gt;<i> is generated) and then getting terminated. The behavior disappears and
</I>&gt;<i> works if I comment the &quot;peek all&quot; line.
</I>&gt;<i> 
</I>&gt;<i> I am not sure if this is a bug or an expected behavior.
</I>
Most of the stuff you are describing matches my expectations, but there
is not enough information in a couple of cases:

* &quot;getting bumped and then getting terminated&quot;. Terminated without
serving an error page to the bumped client? Is there a request after
CONNECT? Is the client happy about the bumped connection? How many
CONNECT requests does your eCAP adapter see (and deny) in this case?

* &quot;works if I comment the 'peek all' line&quot;. Works how? I would expect
Squid to bump and then serve an error page to the user on a bumped
connection. How many CONNECT requests does your eCAP adapter see (and
deny) in this case?

Here is some background so that you can debug this further:

Denying a CONNECT request implies serving an error page to the user.
However, the user will not see the error page if Squid sends it as a
response to the CONNECT request (due to lazy browsers security policies;
nothing to do with Squid). The only way to show that error page to the
user is to bump the client connection and then serve the error page over
that bumped connection in response to the first bumped request.

If your eCAP adapter denies CONNECT during an SslBump step, Squid should
bump the client connection (200 OK) and serve an error page to the user
in response to the first request on that bumped connection, if any
(TAG_NONE/403?).

You can find more information about this behaviour at
<A HREF="http://bazaar.launchpad.net/~squid/squid/trunk/revision/13759">http://bazaar.launchpad.net/~squid/squid/trunk/revision/13759</A>
but some of that old info is probably out of date by now.



&gt;<i> Of course the proxy bumped connection works fine if I selectively peek
</I>&gt;<i> for intercepted connections (ssl_bump peek &lt;if only in intercepted
</I>&gt;<i> mode&gt;), but in this case I am getting duplicate entries in the access
</I>&gt;<i> log file (ie 2 CONNECT log messages for each https CONNECT) for
</I>&gt;<i> intercepted mode https connections.
</I>
This is expected if you peek at step1. The second CONNECT should have
SNI information (but it often does not -- it is complicated and there
are bugs/missing features in that area of the code). If you do not need
SNI, you can make all decisions during the first CONNECT.


&gt;<i> The same goes for other ACL
</I>&gt;<i> combinations like the below resulting in duplicated log messages
</I>&gt;<i> 
</I>&gt;<i> ssl_bump server-first &lt;ip of the domain to be bumped&gt;
</I>&gt;<i> ssl_bump splice &lt;only if the request hit the proxy ip:port and not the
</I>&gt;<i> intercept/transparent ip :port&gt;
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>
In general, it is a bad idea to combine legacy (server-first) and modern
(peek/stare/splice/bump/terminate) rules. If at all possible, use modern
rules.

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005202.html">[squid-users] peek all step with bump instance of proxy
</A></li>
	<LI>Next message (by thread): <A HREF="005222.html">[squid-users] peek all step with bump instance of proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5221">[ date ]</a>
              <a href="thread.html#5221">[ thread ]</a>
              <a href="subject.html#5221">[ subject ]</a>
              <a href="author.html#5221">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
