<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] peek all step with bump instance of proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20all%20step%20with%20bump%20instance%20of%20proxy&In-Reply-To=%3C55DFBACD.3060507%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005221.html">
   <LINK REL="Next"  HREF="005206.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] peek all step with bump instance of proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20all%20step%20with%20bump%20instance%20of%20proxy&In-Reply-To=%3C55DFBACD.3060507%40treenet.co.nz%3E"
       TITLE="[squid-users] peek all step with bump instance of proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 28 01:35:09 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005221.html">[squid-users] peek all step with bump instance of proxy
</A></li>
        <LI>Next message (by thread): <A HREF="005206.html">[squid-users] completely transparent Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5222">[ date ]</a>
              <a href="thread.html#5222">[ thread ]</a>
              <a href="subject.html#5222">[ subject ]</a>
              <a href="author.html#5222">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/08/2015 10:50 p.m., john jacob wrote:
&gt;<i> Hi All,
</I>&gt;<i> 
</I>&gt;<i> I am trying to configure a squid filtering instance which serves both proxy
</I>&gt;<i> and intercepted (transparent) connections. Filtering is accomplished by a
</I>&gt;<i> Request eCAP adapter which have something like
</I>&gt;<i> 
</I>&gt;<i> if(IsDenied() &amp;&amp; RequestMethod==&quot;CONNECT&quot;)
</I>&gt;<i> {
</I>&gt;<i>                           // Gives TAG_NONE/403 in the access log
</I>&gt;<i>  hostx-&gt;blockVirgin();
</I>&gt;<i>  return;
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> I also have a requirement to bump a particular domain and peek other https
</I>&gt;<i> connections for intercepted mode. So there are 3 possible
</I>&gt;<i> outcomes/filtering decision for any https connections hitting this server.
</I>&gt;<i> They are
</I>&gt;<i> 
</I>&gt;<i> 1) Bump and allow the access
</I>&gt;<i> 2) Non bumped and allowed access
</I>&gt;<i> 3) Non bumped and denied access, by the code given above in eCAP adapter
</I>&gt;<i> 
</I>&gt;<i> My squid (tried with v3.5.6 and v3.5.7-20150823-r13895, same outcome)
</I>&gt;<i> config looks like below
</I>&gt;<i> .
</I>&gt;<i> .
</I>&gt;<i> .
</I>&gt;<i> #  TAG: ssl_bump
</I>&gt;<i> ssl_bump server-first &lt;ip of the domain to be bumped&gt;
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> .
</I>
Dont use those three options together. The &quot;server-first&quot; option is a
backward compatibility option only.

The &quot;bump&quot; action is usualy best to use in its place. This config looks
like a case where that is true.

&gt;<i> .
</I>&gt;<i> .
</I>&gt;<i> http_port &lt;proxy ip&gt;:&lt;port&gt; ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=&lt;path&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> https_port &lt;intercept/transparent ip&gt;:&lt;port&gt; intercept ssl-bump
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=&lt;path&gt;
</I>&gt;<i> 
</I>&gt;<i> Things are fine with the intercepted connections (for all the 3 scenarios).
</I>&gt;<i> But with the proxy connections I am encountering some peculiar behavior
</I>&gt;<i> with scenario 3 (ie when a non bumped https CONNECT is denied by eCAP).
</I>&gt;<i> Instead of terminating the connection, it is logged as TAG_NONE/200 in the
</I>&gt;<i> access log and getting bumped (a dynamic certificate is generated) and then
</I>&gt;<i> getting terminated. The behavior disappears and works if I comment the
</I>&gt;<i> &quot;peek all&quot; line.
</I>&gt;<i> 
</I>&gt;<i> I am not sure if this is a bug or an expected behavior.
</I>
Certain very popular browsers refuse to show the user any error messages
output by a proxy in response to a CONNECT message. Just a bland
connection failed message of their own.

To get around that we have a nasty hack that delays emitting error pages
until after the bumping has been done. I think that is what you are
seeing happen. There may well be bugs in the hack itself, but the
behaviours you describe all seem like logical side effects given what it
does.
 - delays the 403 output -&gt; logs 200 for the 'CONNECT', then
 - bumping starts and does peek, then
 - splice starts, and detects 403 to be sent back.
 - but thats impossible in splice, so terminate.

Theres also a good possibility Squid is sending the 403 as plain-text
instead of terminating or delivering TLS handshake data. But the
client/browser simply not showing it to you because well, browsers.


&gt;<i> 
</I>&gt;<i> Of course the proxy bumped connection works fine if I selectively peek for
</I>&gt;<i> intercepted connections (ssl_bump peek &lt;if only in intercepted mode&gt;), but
</I>&gt;<i> in this case I am getting duplicate entries in the access log file (ie 2
</I>&gt;<i> CONNECT log messages for each https CONNECT) for intercepted mode https
</I>&gt;<i> connections.The same goes for other ACL combinations like the below
</I>&gt;<i> resulting in duplicated log messages
</I>&gt;<i> 
</I>&gt;<i> ssl_bump server-first &lt;ip of the domain to be bumped&gt;
</I>&gt;<i> ssl_bump splice &lt;only if the request hit the proxy ip:port and not the
</I>&gt;<i> intercept/transparent ip :port&gt;
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> John
</I>

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005221.html">[squid-users] peek all step with bump instance of proxy
</A></li>
	<LI>Next message (by thread): <A HREF="005206.html">[squid-users] completely transparent Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5222">[ date ]</a>
              <a href="thread.html#5222">[ thread ]</a>
              <a href="subject.html#5222">[ subject ]</a>
              <a href="author.html#5222">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
