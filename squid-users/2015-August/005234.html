<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] %un format code doesn't work for external ssl_bump	ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%25un%20format%20code%20doesn%27t%20work%20for%20external%20ssl_bump%0A%09ACLs&In-Reply-To=%3C55E0898A.2050704%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005269.html">
   <LINK REL="Next"  HREF="005237.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] %un format code doesn't work for external ssl_bump	ACLs</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%25un%20format%20code%20doesn%27t%20work%20for%20external%20ssl_bump%0A%09ACLs&In-Reply-To=%3C55E0898A.2050704%40opendium.com%3E"
       TITLE="[squid-users] %un format code doesn't work for external ssl_bump	ACLs">steve at opendium.com
       </A><BR>
    <I>Fri Aug 28 16:17:14 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005269.html">[squid-users] logfileHandleWrite: daemon:/var/logs/access.log: error writing ((32) Broken pipe)
</A></li>
        <LI>Next message (by thread): <A HREF="005237.html">[squid-users] squid tproxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5234">[ date ]</a>
              <a href="thread.html#5234">[ thread ]</a>
              <a href="subject.html#5234">[ subject ]</a>
              <a href="author.html#5234">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Squid 3.5.7

I'm using an external ACL to decide whether to bump traffic during SSL 
bump step 2.  The external ACL needs to know the user's username for 
requests that have authenticated, but not all requests are authenticated 
so I can't use %LOGIN and I'm therefore using %un instead.  However, %un 
is never being filled in with a user name.


The relevant parts of the config are:

http_access allow proxy_auth
http_access deny all
external_acl_type sslpeek children-max=10 concurrency=100 ttl=0 
negative_ttl=0 %SRC %un %URI %ssl::&gt;sni %&gt;ha{User-Agent} 
/usr/sbin/check_bump.sh
acl sslpeek external sslpeek
acl ssl_bump_step_1 at_step SslBump1
acl ssl_bump_step_2 at_step SslBump2
acl ssl_bump_step_3 at_step SslBump3
ssl_bump peek ssl_bump_step_1 #icap_says_peek
ssl_bump bump ssl_bump_step_2 sslpeek
ssl_bump splice all
sslproxy_cert_error allow all


The debug log shows that the request is successfully authenticated:

Acl.cc(138) matches: checking proxy_auth
UserData.cc(22) match: user is steve, case_insensitive is 0
UserData.cc(28) match: aclMatchUser: user REQUIRED and auth-info present.
Acl.cc(340) cacheMatchAcl: ACL::cacheMatchAcl: miss for 'proxy_auth'. 
Adding result 1
Acl.cc(158) matches: checked: proxy_auth = 1

But then later in the log I see:

external_acl.cc(1416) Start: fg lookup in 'sslpeek' for 
'2a00:1940:1:8:468a:5bff:fe9a:cd7f - www.hsbc.co.uk:443 www.hsbc.co.uk 
Mozilla/5.0%20(X11;%20Fedora;%20Linux%20x86_64;%20rv:39.0)%20Gecko/20100101%20Firefox/39.0'


The user name given to the external ACL is &quot;-&quot; even though the request 
has been authenticated.  Setting a-&gt;require_auth in 
parse_externalAclHelper() makes it work, but obviously just makes %un 
behave like %LOGIN, so isn't a solution.

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: steve.vcf
Type: text/x-vcard
Size: 283 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150828/e425f1bf/attachment.vcf">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150828/e425f1bf/attachment.vcf</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005269.html">[squid-users] logfileHandleWrite: daemon:/var/logs/access.log: error writing ((32) Broken pipe)
</A></li>
	<LI>Next message (by thread): <A HREF="005237.html">[squid-users] squid tproxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5234">[ date ]</a>
              <a href="thread.html#5234">[ thread ]</a>
              <a href="subject.html#5234">[ subject ]</a>
              <a href="author.html#5234">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
