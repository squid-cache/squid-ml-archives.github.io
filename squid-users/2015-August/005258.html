<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid tproxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20tproxy&In-Reply-To=%3C55E253E1.4080009%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005237.html">
   <LINK REL="Next"  HREF="005240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid tproxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20tproxy&In-Reply-To=%3C55E253E1.4080009%40treenet.co.nz%3E"
       TITLE="[squid-users] squid tproxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Aug 30 00:52:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005237.html">[squid-users] squid tproxy
</A></li>
        <LI>Next message (by thread): <A HREF="005240.html">[squid-users] You can use squid on site like facebook or youtube?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5258">[ date ]</a>
              <a href="thread.html#5258">[ thread ]</a>
              <a href="subject.html#5258">[ subject ]</a>
              <a href="author.html#5258">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/08/2015 5:27 a.m., Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [reposting a trimmed-down message]
</I>&gt;<i> 
</I>
&gt;<i> My goal is to allow lan users to access a greater number of sites if
</I>they explicitly configure the squid proxy server in their browsers and
authenticate. If they don't then traffic to port 80 and 443 will be
transparently redirected to a squid proxy server by the corporate
firewall (in my case, firewall and squid are on the same machine).
&gt;<i> 
</I>&gt;<i> Since I noticed that I cannot REQUIRE proxy_auth and create an
</I>additional http_port for tproxy without authentication, I merely created
two instances of squid.

Yes you cannot require authn from an ACL test that gets checked on
intercepted traffic.

Jumping to the conclusion that you needed two proxies was extreme.

This would do it:

 http_port 3128
 http_port 3129 tproxy

 acl login proxy_auth REQUIRED
 acl explicit myportname 3128
 acl interceted myportname 3129

 http_access deny explicit !login
 http_access deny intercepted !localnet

Your regular rules then follow.

But if there is anything like a group check of external ACL with %LOGIN
place the 'explicit' ACL as the first one on the line, like the login
above. You will then have to figure out what (if anything) to do with
the intercepted traffic to check the same thing(s).


&gt;<i> 
</I>&gt;<i> The first instance requires authentication and listens on port 3128.
</I>All works fine when setting up the proxy address and port 3128 (or via
wpad.dat) on the client.
&gt;<i> 
</I>&gt;<i> The second instance does not require authentication and listens on
</I>port 3129 in tproxy mode and on port 3130 in forward proxy mode.
&gt;<i> 
</I>&gt;<i> The firewall on the same machine as squid (iptables) redirects port
</I>&gt;<i> 80
</I>to 3129
&gt;<i> 
</I>&gt;<i> I tried connecting from a Firefox client browser (lan IP addr.
</I>10.215.144.48) without proxy manually configured to internet host
89.16.167.134:80.
&gt;<i> 
</I>&gt;<i> The second squid proxy instance handles the connection but fails
</I>&gt;<i> with
</I>a connection timeout (see log below).

&gt;<i> squid.tproxy.conf (of second instance):
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;<i> acl Safe_ports port 901 # SWAT
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> include /etc/squid/squid.custom.rules.tproxy
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> coredump_dir /var/cache/squid
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;<i> pid_filename /run/squid.tproxy.pid
</I>&gt;<i> cache_dir ufs /var/cache/squid.tproxy 100 16 256
</I>&gt;<i> 
</I>&gt;<i> squid.custom.rules.tproxy:
</I>&gt;<i> 
</I>&gt;<i> access_log daemon:/var/log/squid/access.tproxy.log squid
</I>&gt;<i> cache_log /var/log/squid/cache.tproxy.log
</I>&gt;<i> http_access allow all
</I>&gt;<i> email_err_data on
</I>&gt;<i> error_directory /usr/share/squid/errors/HMAN
</I>&gt;<i> debug_options rotate=1 ALL,5
</I>&gt;<i> append_domain .mydomain.org
</I>&gt;<i> http_port 3130
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> squid 3.5.6
</I>&gt;<i> kernel 4.1.4
</I>&gt;<i> 
</I>&gt;<i> CONFIG_NETFILTER_XT_TARGET_TPROXY=m
</I>&gt;<i> CONFIG_NETFILTER_XT_MATCH_SOCKET=m
</I>&gt;<i> CONFIG_NF_CONNTRACK=m
</I>&gt;<i> 
</I>&gt;<i> lsmod shows xt_TPROXY, nf_conntrack, xt_socket
</I>&gt;<i> 
</I>&gt;<i> Here's the log (connecting from client browser at 10.215.144.48 to internet host at 89.16.167.134):
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://pastebin.com/W2e8csZT">http://pastebin.com/W2e8csZT</A>
</I>&gt;<i> 
</I>&gt;<i> What is causing the timeout?
</I>
TCP SYN+ACK packet never gets back to Squid on the server connection.

&gt;<i> 
</I>&gt;<i> Is there something wrong with my squid configuration or should I look elsewhere?
</I>&gt;<i> 
</I>
The Squid operation seems to be perfectly fine.


The above SYN+ACK packet disappearance is a common sign that you have
triangular routing going on. Where the server response gets sent
straight to the client not to Squid.

You dont mention what routing or iptables configuration you have. It
could be there on the same machine, or it could be any of the network
routers elsewhere the traffic is going over.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005237.html">[squid-users] squid tproxy
</A></li>
	<LI>Next message (by thread): <A HREF="005240.html">[squid-users] You can use squid on site like facebook or youtube?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5258">[ date ]</a>
              <a href="thread.html#5258">[ thread ]</a>
              <a href="subject.html#5258">[ subject ]</a>
              <a href="author.html#5258">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
