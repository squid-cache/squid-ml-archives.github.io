<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 2 way SSL on a non standard SSL Port
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202%20way%20SSL%20on%20a%20non%20standard%20SSL%20Port&In-Reply-To=%3CCAMxDymc-0ntnAqUfJXjdbGYjn80AN1L14dRLA%3DfKmYWWKp7Fhw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="008066.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 2 way SSL on a non standard SSL Port</H1>
    <B>Bart Spedden</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%202%20way%20SSL%20on%20a%20non%20standard%20SSL%20Port&In-Reply-To=%3CCAMxDymc-0ntnAqUfJXjdbGYjn80AN1L14dRLA%3DfKmYWWKp7Fhw%40mail.gmail.com%3E"
       TITLE="[squid-users] 2 way SSL on a non standard SSL Port">bart.spedden at 3sharecorp.com
       </A><BR>
    <I>Tue Dec  1 00:01:44 UTC 2015</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="008066.html">[squid-users] 2 way SSL on a non standard SSL Port
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8064">[ date ]</a>
              <a href="thread.html#8064">[ thread ]</a>
              <a href="subject.html#8064">[ subject ]</a>
              <a href="author.html#8064">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In the cache.log I have found the following:

CONNECT tv1var.merchantlink-lab.com:8184 HTTP/1.1^M

User-Agent: Java/1.8.0_05^M

Host: tv1var.merchantlink-lab.com:8184^M

Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2^M

Proxy-Connection: keep-alive^M

^M


----------

2015/11/30 17:18:47.517 kid1| 85,2| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT tv1var.merchantlink-lab.com:8184
is ALLOWED; last ACL checked: localnet

2015/11/30 17:18:47.517 kid1| 85,2| client_side_request.cc(717)
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW

2015/11/30 17:18:47.517 kid1| 85,2| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT tv1var.merchantlink-lab.com:8184
is ALLOWED; last ACL checked: localnet

2015/11/30 17:18:47.517 kid1| 44,2| peer_select.cc(258) peerSelectDnsPaths:
Find IP destination for: tv1var.merchantlink-lab.com:8184' via
tv1var.merchantlink-lab.com

2015/11/30 17:18:47.533 kid1| 44,2| peer_select.cc(280) peerSelectDnsPaths:
Found sources for 'tv1var.merchantlink-lab.com:8184'

2015/11/30 17:18:47.533 kid1| 44,2| peer_select.cc(281) peerSelectDnsPaths:
  always_direct = DENIED

2015/11/30 17:18:47.533 kid1| 44,2| peer_select.cc(282)
peerSelectDnsPaths:    never_direct = DENIED

2015/11/30 17:18:47.533 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=
104.153.8.184:8184 flags=1

2015/11/30 17:18:47.533 kid1| 44,2| peer_select.cc(295)
peerSelectDnsPaths:        timedout = 0

2015/11/30 17:18:47.534 kid1| 4,2| errorpage.cc(1262) BuildContent: No
existing error page language negotiated for ERR_CONNECT_FAIL. Using default
error file.

2015/11/30 17:18:47.534 kid1| 33,2| client_side.cc(815) swanSong: local=
10.1.0.57:3128 remote=192.168.55.103:56395 flags=1

2015/11/30 17:18:47.689 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New
connection on FD 11

2015/11/30 17:18:47.689 kid1| 5,2| TcpAcceptor.cc(295) acceptNext:
connection on local=[::]:3128 remote=[::] FD 11 flags=9

2015/11/30 17:18:47.695 kid1| 11,2| client_side.cc(2345) parseHttpRequest:
HTTP Client local=10.1.0.57:3128 remote=192.168.55.103:56396 FD 10 flags=1

2015/11/30 17:18:47.695 kid1| 11,2| client_side.cc(2346) parseHttpRequest:
HTTP Client REQUEST:

versus

a successful call to google:

User-Agent: Java/1.8.0_05^M

Host: www.google.com^M

Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2^M

Proxy-Connection: keep-alive^M

^M


----------

2015/11/30 17:18:47.849 kid1| 85,2| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT www.google.com:443 is ALLOWED;
last ACL checked: localnet

2015/11/30 17:18:47.849 kid1| 85,2| client_side_request.cc(717)
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW

2015/11/30 17:18:47.849 kid1| 85,2| client_side_request.cc(741)
clientAccessCheckDone: The request CONNECT www.google.com:443 is ALLOWED;
last ACL checked: localnet

2015/11/30 17:18:47.849 kid1| 44,2| peer_select.cc(258) peerSelectDnsPaths:
Find IP destination for: www.google.com:443' via www.google.com

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(280) peerSelectDnsPaths:
Found sources for 'www.google.com:443'

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(281) peerSelectDnsPaths:
  always_direct = DENIED

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(282)
peerSelectDnsPaths:    never_direct = DENIED

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=[::]
remote=[2607:f8b0:400d:c06::63]:443 flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=74.125.22.99:443
flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=74.125.22.105:443
flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=74.125.22.106:443
flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=74.125.22.103:443
flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=74.125.22.104:443
flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(286)
peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=74.125.22.147:443
flags=1

2015/11/30 17:18:47.853 kid1| 44,2| peer_select.cc(295)
peerSelectDnsPaths:        timedout = 0

2015/11/30 17:18:48.008 kid1| 33,2| client_side.cc(815) swanSong: local=
10.1.0.57:3128 remote=192.168.55.103:56396 flags=1

2015/11/30 17:18:48.196 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New
connection on FD 11

2015/11/30 17:18:48.196 kid1| 5,2| TcpAcceptor.cc(295) acceptNext:
connection on local=[::]:3128 remote=[::] FD 11 flags=9

2015/11/30 17:18:48.196 kid1| 11,2| client_side.cc(2345) parseHttpRequest:
HTTP Client local=10.1.0.57:3128 remote=10.1.0.43:42281 FD 10 flags=1

2015/11/30 17:18:48.196 kid1| 11,2| client_side.cc(2346) parseHttpRequest:
HTTP Client REQUEST:




On Mon, Nov 30, 2015 at 4:37 PM, Bart Spedden &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bart.spedden at 3sharecorp.com</A>&gt;
wrote:

&gt;<i> Good idea Anthony.
</I>&gt;<i>
</I>&gt;<i> Here's what I found.
</I>&gt;<i>
</I>&gt;<i> On the squid server when I use the following command to monitor a call to
</I>&gt;<i> <A HREF="https://www.google.com">https://www.google.com</A>
</I>&gt;<i>
</I>&gt;<i> tcpdump -i eth0 -vv 'port 443'
</I>&gt;<i>
</I>&gt;<i> I get the following:
</I>&gt;<i>
</I>&gt;<i> 17:32:56.373772 IP (tos 0x0, ttl 64, id 33502, offset 0, flags [DF], proto
</I>&gt;<i> TCP (6), length 60)
</I>&gt;<i>
</I>&gt;<i>     d6uxpci.lq.com.46591 &gt; qh-in-f104.1e100.net.https: Flags [S], cksum
</I>&gt;<i> 0x62f0 (correct), seq 3198653455, win 14600, options [mss 1460,sackOK,TS
</I>&gt;<i> val 530978513 ecr 0,nop,wscale 7], length 0
</I>&gt;<i>
</I>&gt;<i> 17:32:56.390214 IP (tos 0x0, ttl 42, id 42485, offset 0, flags [none],
</I>&gt;<i> proto TCP (6), length 60)
</I>&gt;<i>
</I>&gt;<i>     qh-in-f104.1e100.net.https &gt; d6uxpci.lq.com.46591: Flags [S.], cksum
</I>&gt;<i> 0x40d0 (correct), seq 558417168, ack 3198653456, win 42540, options [mss
</I>&gt;<i> 1380,nop,nop,TS val 953915655 ecr 530978513,nop,wscale 7], length 0
</I>&gt;<i>
</I>&gt;<i> 17:32:56.390423 IP (tos 0x0, ttl 64, id 33503, offset 0, flags [DF], proto
</I>&gt;<i> TCP (6), length 52)
</I>&gt;<i>
</I>&gt;<i>     d6uxpci.lq.com.46591 &gt; qh-in-f104.1e100.net.https: Flags [.], cksum
</I>&gt;<i> 0x11f5 (correct), seq 1, ack 1, win 115, options [nop,nop,TS val 530978529
</I>&gt;<i> ecr 953915655], length 0
</I>&gt;<i>
</I>&gt;<i> 17:32:56.605977 IP (tos 0x0, ttl 64, id 33504, offset 0, flags [DF], proto
</I>&gt;<i> TCP (6), length 329)
</I>&gt;<i>
</I>&gt;<i>     d6uxpci.lq.com.46591 &gt; qh-in-f104.1e100.net.https: Flags [P.], cksum
</I>&gt;<i> 0x6c5a (incorrect -&gt; 0xc57a), seq 1:278, ack 1, win 115, options
</I>&gt;<i> [nop,nop,TS val 530978745 ecr 953915655], length 277
</I>&gt;<i>
</I>&gt;<i> 17:32:56.622191 IP (tos 0x0, ttl 42, id 42578, offset 0, flags [none],
</I>&gt;<i> proto TCP (6), length 52)
</I>&gt;<i>
</I>&gt;<i>     qh-in-f104.1e100.net.https &gt; d6uxpci.lq.com.46591: Flags [.], cksum
</I>&gt;<i> 0x0e3e (correct), seq 1, ack 278, win 341, options [nop,nop,TS val
</I>&gt;<i> 953915887 ecr 530978745], length 0
</I>&gt;<i>
</I>&gt;<i> but when I monitor on the non-stand https port (8184) that I'm trying to
</I>&gt;<i> connect to I do not see any traffic at all.  So this leads me to believe
</I>&gt;<i> that squid is not actually trying to make the call on the client's behalf.
</I>&gt;<i>
</I>&gt;<i> So I'm feeling a bit lost.
</I>&gt;<i>
</I>&gt;<i> I've upgraded to 3.5.11.
</I>&gt;<i>
</I>&gt;<i> The only change I made to the default /etc/squid/squid.conf is to add the
</I>&gt;<i> two non stand https ports that I need to connect to via:
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443 8184 8185
</I>&gt;<i>
</I>&gt;<i> Is there anyway to get more logging out of squid?  I tried adding
</I>&gt;<i> debug_option ALL to the squid.conf but didn't see any more logging.
</I>&gt;<i>
</I>&gt;<i> On Mon, Nov 30, 2015 at 10:59 AM, Antony Stone &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Antony.Stone at squid.open.source.it</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On Monday 30 November 2015 at 18:53:54, Bart Spedden wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; I can successfully connect as long as I don't use squid for either 1
</I>&gt;&gt;<i> way or
</I>&gt;&gt;<i> &gt; 2 way TLS connections. I've also successfully connect via curl. So, I
</I>&gt;&gt;<i> feel
</I>&gt;&gt;<i> &gt; like the site's certs are working well. I could be totally off base here
</I>&gt;&gt;<i> &gt; but my interpretation of the the 503 (service unavailable) is that
</I>&gt;&gt;<i> squid is
</I>&gt;&gt;<i> &gt; timing out on tls handshake? But what is weird is that when using squid
</I>&gt;&gt;<i> I
</I>&gt;&gt;<i> &gt; can successfully connect to google using https. So, that is what makes
</I>&gt;&gt;<i> me
</I>&gt;&gt;<i> &gt; wonder if it has something to do with the non-standard https port?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If it's a timeout, you should be able to see this with a standard
</I>&gt;&gt;<i> wireshark /
</I>&gt;&gt;<i> tcpdump packet capture (no SSL inspection necessary) on your
</I>&gt;&gt;<i> external-facing
</I>&gt;&gt;<i> router (or anywhere else which is a common path both when going direct
</I>&gt;&gt;<i> from
</I>&gt;&gt;<i> the client, and via Squid).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Comparing the two (even though you can't decode the content of the
</I>&gt;&gt;<i> packets)
</I>&gt;&gt;<i> may well give a clue as to what's going on differently between the two
</I>&gt;&gt;<i> types of
</I>&gt;&gt;<i> connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Antony.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Users don't know what they want until they see what they get.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                                                    Please reply to the
</I>&gt;&gt;<i> list;
</I>&gt;&gt;<i>                                                          please *don't*
</I>&gt;&gt;<i> CC me.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Bart Spedden  |  Senior Developer
</I>&gt;<i> +1.720.210.7041  |
</I>&gt;<i> *<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bart.spedden at 3sharecorp.com</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bart.spedden at 3sharecorp.com</A>&gt;*
</I>&gt;<i> 3 | S H A R E  |  Adobe Digital Marketing Experts  |  An Adobe&#174;  Business
</I>&gt;<i> Plus Level Solution PartnerConsulting  |  Training  |  Remote Operations
</I>&gt;<i> Management
</I>&gt;<i> &lt;<A HREF="http://www.3sharecorp.com/en/services/rom.html">http://www.3sharecorp.com/en/services/rom.html</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://www.3sharecorp.com/en/services/rom.html">http://www.3sharecorp.com/en/services/rom.html</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://www.3sharecorp.com/en/services/rom.html">http://www.3sharecorp.com/en/services/rom.html</A>&gt;
</I>&gt;<i>
</I>


-- 
Bart Spedden  |  Senior Developer
+1.720.210.7041  |
*<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bart.spedden at 3sharecorp.com</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bart.spedden at 3sharecorp.com</A>&gt;*
3 | S H A R E  |  Adobe Digital Marketing Experts  |  An Adobe&#174;  Business
Plus Level Solution PartnerConsulting  |  Training  |  Remote Operations
Management
&lt;<A HREF="http://www.3sharecorp.com/en/services/rom.html">http://www.3sharecorp.com/en/services/rom.html</A>&gt;
&lt;<A HREF="http://www.3sharecorp.com/en/services/rom.html">http://www.3sharecorp.com/en/services/rom.html</A>&gt;
&lt;<A HREF="http://www.3sharecorp.com/en/services/rom.html">http://www.3sharecorp.com/en/services/rom.html</A>&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151130/75013a9d/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151130/75013a9d/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: rom-email-sig4_600x100.png
Type: image/png
Size: 16361 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151130/75013a9d/attachment.png">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151130/75013a9d/attachment.png</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="008066.html">[squid-users] 2 way SSL on a non standard SSL Port
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8064">[ date ]</a>
              <a href="thread.html#8064">[ thread ]</a>
              <a href="subject.html#8064">[ subject ]</a>
              <a href="author.html#8064">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
