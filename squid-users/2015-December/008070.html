<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Time-Based Download Restrictions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time-Based%20Download%20Restrictions&In-Reply-To=%3C565D7346.3050403%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008071.html">
   <LINK REL="Next"  HREF="008072.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Time-Based Download Restrictions</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time-Based%20Download%20Restrictions&In-Reply-To=%3C565D7346.3050403%40treenet.co.nz%3E"
       TITLE="[squid-users] Time-Based Download Restrictions">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Dec  1 10:15:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008071.html">[squid-users] How to use the different Store ID with same url and different proxy port ?
</A></li>
        <LI>Next message (by thread): <A HREF="008072.html">[squid-users] 32bit (i386) squid 3.5 cache dir size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8070">[ date ]</a>
              <a href="thread.html#8070">[ thread ]</a>
              <a href="subject.html#8070">[ subject ]</a>
              <a href="author.html#8070">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/12/2015 3:56 a.m., Edmonds Namasenda wrote:
&gt;<i> Greetings.
</I>&gt;<i> 
</I>&gt;<i> I want to deny access to certain downloads (in str-med.txt) during &quot;WorkHrs&quot;
</I>&gt;<i> This is failing miserably as this is not achieved.
</I>&gt;<i> 
</I>&gt;<i> Please look through my files (squid.conf and str-med.txt) below for
</I>&gt;<i> pointers to rectify this. Thanks in advance
</I>
Apart from being placed above the access controls on CONNECT (it should
be below). The config looks like it should work and block all HTTP
downloads for URLs that look like filename downloads.

I suspect that you are probably confusing HTTPS and HTTP though. HTTPS
does not have a URL path exposed for the ACL to work with. So these
controls will have no effect on HTTPS traffic.

Or perhapse you are confusing URL paths for file paths. While they do
look alike sometimes, the overlap is purely historical design
coincidence. There is not necessarily any correlation in reality.


&gt;<i> 
</I>&gt;<i> ### Start squid.conf ###
</I>&gt;<i> acl office-net src 10.10.2.0/24
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl WorkHrs time MTWHF 08:29-12:59
</I>&gt;<i> acl WorkHrs time MTWHFA 14:00-16:59
</I>&gt;<i> 
</I>&gt;<i> ## Wrong Files and URLS
</I>&gt;<i> acl malice dstdomain -i &quot;/etc/squid/malware.acl&quot;
</I>&gt;<i> acl porn dstdomain -i &quot;/etc/squid/xxx.acl&quot;
</I>&gt;<i> acl ads dstdomain -i &quot;/etc/squid/ads.acl&quot;
</I>&gt;<i> acl proxies dstdomain -i &quot;/etc/squid/proxies.acl&quot;
</I>&gt;<i> 
</I>&gt;<i> acl nostr urlpath_regex -i &quot;/etc/squid/str-med.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny nostr WorkHrs
</I>&gt;<i> http_reply_access deny nostr WorkHrs
</I>
If the &quot;nostr WorkHrs&quot; check matches anything it would do so on
http_access, the reply version is not useful.

&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny ads
</I>&gt;<i> http_access deny porn
</I>&gt;<i> http_access deny malice
</I>&gt;<i> http_access deny proxies
</I>

The ACLs ads, porn  malice, and proxies are all dstdomain. You should be
able to load all their entries into one AC name and just test once,
instead of checking each requests domain x4 times.
combine them into one ACL name.

Also, all your custom ACLs should be placed after the &quot;deny CONNECT
!SSL_ports&quot; line.

&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access allow office-net all
</I>&gt;<i> 
</I>&gt;<i> # Allow localhost always proxy functionality
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> error_directory /usr/share/squid/errors/en
</I>&gt;<i> 
</I>&gt;<i> icp_access allow office-net
</I>&gt;<i> icp_access deny all
</I>&gt;<i> 
</I>&gt;<i> htcp_access allow office-net
</I>&gt;<i> htcp_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 10.10.2.10:3128 intercept
</I>&gt;<i> http_port 127.0.0.1:3127
</I>&gt;<i> 
</I>&gt;<i> hierarchy_stoplist cgi-bin ?
</I>&gt;<i> 
</I>
You don't have peers, so the above is not useful. You can remove it.

&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> acl youtube dstdomain .youtube.com
</I>&gt;<i> cache allow youtube
</I>
The above may not be doing what you think it does...

With ACL processing the implicit default action is the inverse of the
previous action. So what the above does is tell Squid to cache
youtube.com objects, *but nothing else*.

If that is intentional it is best to say so with an explicit &quot;cache deny
all&quot; line at the end.

If you want youtube.com objects to be cached, a) the above does not
work, and b) you dont have to specify &quot;cache allow&quot; lines. The default
action by Squid is to cache everything that is cacheable.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008071.html">[squid-users] How to use the different Store ID with same url and different proxy port ?
</A></li>
	<LI>Next message (by thread): <A HREF="008072.html">[squid-users] 32bit (i386) squid 3.5 cache dir size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8070">[ date ]</a>
              <a href="thread.html#8070">[ thread ]</a>
              <a href="subject.html#8070">[ subject ]</a>
              <a href="author.html#8070">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
