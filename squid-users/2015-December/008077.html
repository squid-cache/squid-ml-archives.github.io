<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.4.8 ssl-bump resolve ip in access.log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.4.8%20ssl-bump%20resolve%20ip%20in%20access.log&In-Reply-To=%3CE5B6AD485ECDEC469A7AA6CFF504EF660979BAA5%40EXCH1.admin.rouen.archi.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008075.html">
   <LINK REL="Next"  HREF="008079.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.4.8 ssl-bump resolve ip in access.log</H1>
    <B>LANGLOIS Nicolas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.4.8%20ssl-bump%20resolve%20ip%20in%20access.log&In-Reply-To=%3CE5B6AD485ECDEC469A7AA6CFF504EF660979BAA5%40EXCH1.admin.rouen.archi.fr%3E"
       TITLE="[squid-users] squid 3.4.8 ssl-bump resolve ip in access.log">nicolas.langlois at rouen.archi.fr
       </A><BR>
    <I>Tue Dec  1 15:01:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008075.html">[squid-users] squid 3.4.8 ssl-bump resolve ip in access.log
</A></li>
        <LI>Next message (by thread): <A HREF="008079.html">[squid-users] missing icap respmod request when the web object is found in the cache?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8077">[ date ]</a>
              <a href="thread.html#8077">[ thread ]</a>
              <a href="subject.html#8077">[ subject ]</a>
              <a href="author.html#8077">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos for the quick reply,  
I 'm making lot of mistake around  ssl with squid, i 'm following your advice and try to setup with with last squid 3.5 version using tproxy  will let you know . 

Have a good day 

Nicolas

-----Message d'origine-----
De&#160;: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] De la part de Amos Jeffries
Envoy&#233;&#160;: mardi 1 d&#233;cembre 2015 13:18
&#192;&#160;: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Objet&#160;: Re: [squid-users] squid 3.4.8 ssl-bump resolve ip in access.log

On 2/12/2015 12:40 a.m., LANGLOIS Nicolas wrote:
&gt;<i> Hi,  i'm trying to set up squid 3.4.8 on debian , i want a full transparent proxy, no conf on client side .
</I>
That is not what &quot;fully transparent&quot; means.

The best form of transparent proxy is when clients are auto-configured with explicit-proxy settings.


Also be aware that the Debian versions which are shipping Squid-3.4.8 have some mystery issue in their kernels that nobody has yet been able to track down that prevents the TPROXY feature from operating properly.
You will have to stick with NAT or upgrade to one of the Debian versions shipping Squid-3.5, their kernels seem to work better.


&gt;<i> it's working actually but i 'm ask to report websites access but for https actually i just get  this kind of line in my access.log :
</I>&gt;<i> &lt; TCP_MISS/200 288 CONNECT 64.233.184.106:443 - 
</I>&gt;<i> ORIGINAL_DST/64.233.184.106 &lt;
</I>&gt;<i> 
</I>&gt;<i> Is there a way to have dns resolution  and log the website visited  for https ?
</I>
What for? all it does is reduce accuracy of the log.
You can end up with situations where the log says:
 &quot;CONNECT 64.233.184.106:443 - ORIGINAL_DST/example.com&quot;

But when log analysis runs example.com has moved its IP, or just DNS has cycled on to another one of the set. So analysis then reports the client requested URL &quot;64.233.184.106:443&quot; when connecting to a server whose IP is now 192.0.2.1. Which is plain wrong.


&gt;<i> 
</I>&gt;<i> Here is a part of my squid.conf :
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.1.1:3128 ssl-bump generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.pem
</I>&gt;<i> http_port 192.168.1.1:3129 intercept
</I>&gt;<i> https_port 192.168.1.1:3130 intercept ssl-bump  
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>&gt;<i> cert=/etc/squid3/ssl_cert/squid.pem
</I>&gt;<i> 
</I>&gt;<i> ssl_bump none all
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> always_direct allow all
</I>
So basically; Intercept TLS (supposed to be secure). Ignore all possible errors, malicious attacks, diversions or hijacking that might be done by anyone else on the way to the real server. BUT tell the client everything is safe to send or fetch that sensitive data they needed TLS for?

You are SO lucky you started that &quot;ssl_bump none all&quot; actually means dont perform SSL-bump interception. It is preventing a world of FAIL from landing on your head.

The other three lines should be erased immediately.

&gt;<i> 
</I>&gt;<i> or is there a magical solution for transparent proxy  with no client-side (certs or proxy conf) config working actually with https ?
</I>
Firstly, Be aware that SSL-Bump is involved in an arms race. If you are doing bumping always use the latest Squid. The 3.4 series is outdated by a year. Things have already moved on well past its capabilities.


Secondly, after upgrade to Squid-3.5 use &quot;splice all&quot; where you have placed &quot;none all&quot; right now and what you request will 'just work'. You can then peek/stare at unencrypted the SNI and cert details to log where clients are going and/or block certain servers being contacted.

The assumption with SSL-Bump is that you are doing so in order to actually bump at least some of the traffic. There is very little point in diverting port 443 to Squid only to do nothing at all with it. All that does is slow the already heavyweight HTTPS protocol down. It is the bumping action that requires the client setup.

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008075.html">[squid-users] squid 3.4.8 ssl-bump resolve ip in access.log
</A></li>
	<LI>Next message (by thread): <A HREF="008079.html">[squid-users] missing icap respmod request when the web object is found in the cache?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8077">[ date ]</a>
              <a href="thread.html#8077">[ thread ]</a>
              <a href="subject.html#8077">[ subject ]</a>
              <a href="author.html#8077">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
