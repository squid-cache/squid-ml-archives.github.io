<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] setting up cache peering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20setting%20up%20cache%20peering&In-Reply-To=%3C565F1AD3.3060601%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008090.html">
   <LINK REL="Next"  HREF="008109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] setting up cache peering</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20setting%20up%20cache%20peering&In-Reply-To=%3C565F1AD3.3060601%40treenet.co.nz%3E"
       TITLE="[squid-users] setting up cache peering">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  2 16:22:43 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008090.html">[squid-users] setting up cache peering
</A></li>
        <LI>Next message (by thread): <A HREF="008109.html">[squid-users] setting up cache peering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8101">[ date ]</a>
              <a href="thread.html#8101">[ thread ]</a>
              <a href="subject.html#8101">[ subject ]</a>
              <a href="author.html#8101">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/12/2015 6:50 p.m., Alex Samad wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> I recently moved to squid-3.5.11-1.el6.x86_64 on centos 6.7.
</I>&gt;<i> 
</I>&gt;<i> from the centos 3.1 i think ?
</I>&gt;<i> 
</I>&gt;<i> This what I had originall
</I>&gt;<i> #cache_peer gsdmz1.xy.com sibling 3128 3130 proxy-only
</I>&gt;<i> #cache_peer alcdmz1.xy.com sibling 3128 3130 proxy-only
</I>&gt;<i> 
</I>&gt;<i> I had a shared config between the 2 server gsdmz1 and alcdmz1. I would
</I>&gt;<i> uncomment 1 or the other depending.
</I>&gt;<i> 
</I>&gt;<i> during my upgrade I coped the gsdmz1 squid config over to alcdmz1 but
</I>&gt;<i> forgot to uncomment the
</I>&gt;<i> cache_peer alcdmz1.xy.com sibling 3128 3130 proxy-only
</I>&gt;<i> 
</I>&gt;<i> so alcdmz1 was talking to itself at times.
</I>&gt;<i> 
</I>&gt;<i> using this as my test
</I>&gt;<i> wget -d   <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;<i> -O /dev/null
</I>&gt;<i> 
</I>&gt;<i> and setting http_proxy to either alc or gsdmz1 I would get a 504 error.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> wget -d  <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;<i> -O /dev/null
</I>&gt;<i> Setting --output-document (outputdocument) to /dev/null
</I>&gt;<i> DEBUG output created by Wget 1.12 on linux-gnu.
</I>&gt;<i> 
</I>&gt;<i> --2015-12-02 16:35:34--
</I>&gt;<i> <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;<i> Resolving alcdmz1... 10.3.2.111
</I>&gt;<i> Caching alcdmz1 =&gt; 10.3.2.111
</I>&gt;<i> Connecting to alcdmz1|10.3.2.111|:3128... connected.
</I>&gt;<i> Created socket 4.
</I>&gt;<i> Releasing 0x0000000001ea5db0 (new refcount 1).
</I>&gt;<i> 
</I>&gt;<i> ---request begin---
</I>&gt;<i> GET <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;<i> HTTP/1.0
</I>&gt;<i> User-Agent: Wget/1.12 (linux-gnu)
</I>&gt;<i> Accept: */*
</I>&gt;<i> Host: www.smh.com.au
</I>&gt;<i> 
</I>&gt;<i> ---request end---
</I>&gt;<i> Proxy request sent, awaiting response...
</I>&gt;<i> ---response begin---
</I>&gt;<i> HTTP/1.1 504 Gateway Timeout
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Wed, 02 Dec 2015 05:35:34 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 4063
</I>&gt;<i> X-Squid-Error: ERR_ONLY_IF_CACHED_MISS 0
</I>&gt;<i> Vary: Accept-Language
</I>&gt;<i> Content-Language: en
</I>&gt;<i> X-Cache: MISS from gsdmz1
</I>&gt;<i> X-Cache-Lookup: MISS from gsdmz1:3128
</I>&gt;<i> X-Cache: MISS from alcdmz1
</I>&gt;<i> X-Cache-Lookup: MISS from alcdmz1:3128
</I>&gt;<i> Via: 1.1 gsdmz1 (squid), 1.1 alcdmz1 (squid)
</I>&gt;<i> Connection: close
</I>&gt;<i> 
</I>&gt;<i> ---response end---
</I>&gt;<i> 504 Gateway Timeout
</I>&gt;<i> Closed fd 4
</I>&gt;<i> 2015-12-02 16:35:34 ERROR 504: Gateway Timeout.
</I>&gt;<i> 
</I>
*timeout* is terribly bad. Turn the Via header back on. Its sole purpose
is to let the peers reject messages that are looping like that one.

&gt;<i> 
</I>&gt;<i> I changed the line to be
</I>&gt;<i> cache_peer gsdmz1.xy.com sibling 3128 3130 proxy-only standby=50
</I>&gt;<i> on the alcdmz1 box
</I>&gt;<i> and
</I>&gt;<i> cache_peer alcdmz1.xy.com sibling 3128 3130 proxy-only standby=50
</I>&gt;<i> on the gsdmz1 box
</I>&gt;<i> 
</I>&gt;<i> but this still gave me 504 errors ?
</I>
Notice how the difference in configurations is that you added
standby=50. It should not be having any effect that we know of, but does
mean that connections are pre-opened to the sibling and thus have a much
lower latency than any normal TCP connection. If your Squid is searching
for fastest-route using the netdb latency tables that could be the
opposite of what you need.

&gt;<i> I tried to force a new version through both proxies by using wget with
</I>&gt;<i> no-cache option.  But that didn't help.
</I>
Sending &quot;no-cache&quot; from the client makes it worse, since that prevents
HIT from happening on either peer.

When combined with &quot;cache_peer ... proxy-only&quot; configuration it prevents
any traffic that goes through a peer from being cached.

&gt;<i> 
</I>&gt;<i> So what went wrong, how can I flush out the stale 504.
</I>
It is not cached. There is nothing to flush (except perhapse the standby
connections, see above).

&gt;<i> What is the best way to setup the 2 proxies to talk to each other
</I>&gt;<i> before going out to the internet.
</I>
That depends on the proxies, version, and what you want them to do.

&gt;<i> 
</I>&gt;<i> the proxies run on a pacemaker cluster. I have 2 vip's setup as the
</I>&gt;<i> proxy addresses, in normal conditions these address are setup 1 on
</I>&gt;<i> each server. whilst working on a server I can move the vip and not
</I>&gt;<i> affect any one.
</I>
What you have appears to be almost correct. Since you are dealing with
3.1 vs 3.5, you need to keep in mind the differences in behaviour
between HTTP/1.0 (3.1) and HTTP/1.1 (3.5).

One of the side effects is that the default peer query messaging is ICP
which does not work at all well with HTTP/1.1 Vary caching. HTCP was
designed to avoid those problems, but needs turning on explcicitly.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> But I would like to take benefit of each others cache, whats the best
</I>&gt;<i> setup for cache_peer in this setup.
</I>&gt;<i> 
</I>&gt;<i> Neither server is closer to the internet.
</I>&gt;<i> 
</I>

I suggest you:

1) add the &quot;htcp&quot; option to the cache_peer lines. So the peer selection
can use the full HTTP/1.1 headers to decide if the peer cached object is
actually usable.

2) Remove the &quot;via off&quot; from your config file.

3) remove the standby= parameter from cache_peer until you have at least
got the original setup working.


There might be other things involved, but we cant know that without the
details about those things existence or absence from your config.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008090.html">[squid-users] setting up cache peering
</A></li>
	<LI>Next message (by thread): <A HREF="008109.html">[squid-users] setting up cache peering
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8101">[ date ]</a>
              <a href="thread.html#8101">[ thread ]</a>
              <a href="subject.html#8101">[ subject ]</a>
              <a href="author.html#8101">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
