<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] setting up cache peering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20setting%20up%20cache%20peering&In-Reply-To=%3CCAJ%2BQ1PXk84C%2BCjULsicq_9XP3OQnm2qfWSOM8JR%3DUCCHHostAQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008101.html">
   <LINK REL="Next"  HREF="008091.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] setting up cache peering</H1>
    <B>Alex Samad</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20setting%20up%20cache%20peering&In-Reply-To=%3CCAJ%2BQ1PXk84C%2BCjULsicq_9XP3OQnm2qfWSOM8JR%3DUCCHHostAQ%40mail.gmail.com%3E"
       TITLE="[squid-users] setting up cache peering">alex at samad.com.au
       </A><BR>
    <I>Wed Dec  2 20:20:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008101.html">[squid-users] setting up cache peering
</A></li>
        <LI>Next message (by thread): <A HREF="008091.html">[squid-users] mail upload problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8109">[ date ]</a>
              <a href="thread.html#8109">[ thread ]</a>
              <a href="subject.html#8109">[ subject ]</a>
              <a href="author.html#8109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

Thanks I will do when I get back to 3.5. Had to roll back because of
my issues with 3.5 and reverse proxy and outlook.

Are these suggestions still valid with 3.1 ?

Thanks

On 3 December 2015 at 03:22, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 2/12/2015 6:50 p.m., Alex Samad wrote:
</I>&gt;&gt;<i> Hi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I recently moved to squid-3.5.11-1.el6.x86_64 on centos 6.7.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from the centos 3.1 i think ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This what I had originall
</I>&gt;&gt;<i> #cache_peer gsdmz1.xy.com sibling 3128 3130 proxy-only
</I>&gt;&gt;<i> #cache_peer alcdmz1.xy.com sibling 3128 3130 proxy-only
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I had a shared config between the 2 server gsdmz1 and alcdmz1. I would
</I>&gt;&gt;<i> uncomment 1 or the other depending.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> during my upgrade I coped the gsdmz1 squid config over to alcdmz1 but
</I>&gt;&gt;<i> forgot to uncomment the
</I>&gt;&gt;<i> cache_peer alcdmz1.xy.com sibling 3128 3130 proxy-only
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> so alcdmz1 was talking to itself at times.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using this as my test
</I>&gt;&gt;<i> wget -d   <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;&gt;<i> -O /dev/null
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and setting http_proxy to either alc or gsdmz1 I would get a 504 error.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> wget -d  <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;&gt;<i> -O /dev/null
</I>&gt;&gt;<i> Setting --output-document (outputdocument) to /dev/null
</I>&gt;&gt;<i> DEBUG output created by Wget 1.12 on linux-gnu.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --2015-12-02 16:35:34--
</I>&gt;&gt;<i> <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;&gt;<i> Resolving alcdmz1... 10.3.2.111
</I>&gt;&gt;<i> Caching alcdmz1 =&gt; 10.3.2.111
</I>&gt;&gt;<i> Connecting to alcdmz1|10.3.2.111|:3128... connected.
</I>&gt;&gt;<i> Created socket 4.
</I>&gt;&gt;<i> Releasing 0x0000000001ea5db0 (new refcount 1).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---request begin---
</I>&gt;&gt;<i> GET <A HREF="http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html">http://www.smh.com.au/business/markets-live/markets-live-investors-take-stock-20151201-gld1lu.html</A>
</I>&gt;&gt;<i> HTTP/1.0
</I>&gt;&gt;<i> User-Agent: Wget/1.12 (linux-gnu)
</I>&gt;&gt;<i> Accept: */*
</I>&gt;&gt;<i> Host: www.smh.com.au
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---request end---
</I>&gt;&gt;<i> Proxy request sent, awaiting response...
</I>&gt;&gt;<i> ---response begin---
</I>&gt;&gt;<i> HTTP/1.1 504 Gateway Timeout
</I>&gt;&gt;<i> Server: squid
</I>&gt;&gt;<i> Mime-Version: 1.0
</I>&gt;&gt;<i> Date: Wed, 02 Dec 2015 05:35:34 GMT
</I>&gt;&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;&gt;<i> Content-Length: 4063
</I>&gt;&gt;<i> X-Squid-Error: ERR_ONLY_IF_CACHED_MISS 0
</I>&gt;&gt;<i> Vary: Accept-Language
</I>&gt;&gt;<i> Content-Language: en
</I>&gt;&gt;<i> X-Cache: MISS from gsdmz1
</I>&gt;&gt;<i> X-Cache-Lookup: MISS from gsdmz1:3128
</I>&gt;&gt;<i> X-Cache: MISS from alcdmz1
</I>&gt;&gt;<i> X-Cache-Lookup: MISS from alcdmz1:3128
</I>&gt;&gt;<i> Via: 1.1 gsdmz1 (squid), 1.1 alcdmz1 (squid)
</I>&gt;&gt;<i> Connection: close
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---response end---
</I>&gt;&gt;<i> 504 Gateway Timeout
</I>&gt;&gt;<i> Closed fd 4
</I>&gt;&gt;<i> 2015-12-02 16:35:34 ERROR 504: Gateway Timeout.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *timeout* is terribly bad. Turn the Via header back on. Its sole purpose
</I>&gt;<i> is to let the peers reject messages that are looping like that one.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I changed the line to be
</I>&gt;&gt;<i> cache_peer gsdmz1.xy.com sibling 3128 3130 proxy-only standby=50
</I>&gt;&gt;<i> on the alcdmz1 box
</I>&gt;&gt;<i> and
</I>&gt;&gt;<i> cache_peer alcdmz1.xy.com sibling 3128 3130 proxy-only standby=50
</I>&gt;&gt;<i> on the gsdmz1 box
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but this still gave me 504 errors ?
</I>&gt;<i>
</I>&gt;<i> Notice how the difference in configurations is that you added
</I>&gt;<i> standby=50. It should not be having any effect that we know of, but does
</I>&gt;<i> mean that connections are pre-opened to the sibling and thus have a much
</I>&gt;<i> lower latency than any normal TCP connection. If your Squid is searching
</I>&gt;<i> for fastest-route using the netdb latency tables that could be the
</I>&gt;<i> opposite of what you need.
</I>&gt;<i>
</I>&gt;&gt;<i> I tried to force a new version through both proxies by using wget with
</I>&gt;&gt;<i> no-cache option.  But that didn't help.
</I>&gt;<i>
</I>&gt;<i> Sending &quot;no-cache&quot; from the client makes it worse, since that prevents
</I>&gt;<i> HIT from happening on either peer.
</I>&gt;<i>
</I>&gt;<i> When combined with &quot;cache_peer ... proxy-only&quot; configuration it prevents
</I>&gt;<i> any traffic that goes through a peer from being cached.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So what went wrong, how can I flush out the stale 504.
</I>&gt;<i>
</I>&gt;<i> It is not cached. There is nothing to flush (except perhapse the standby
</I>&gt;<i> connections, see above).
</I>&gt;<i>
</I>&gt;&gt;<i> What is the best way to setup the 2 proxies to talk to each other
</I>&gt;&gt;<i> before going out to the internet.
</I>&gt;<i>
</I>&gt;<i> That depends on the proxies, version, and what you want them to do.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> the proxies run on a pacemaker cluster. I have 2 vip's setup as the
</I>&gt;&gt;<i> proxy addresses, in normal conditions these address are setup 1 on
</I>&gt;&gt;<i> each server. whilst working on a server I can move the vip and not
</I>&gt;&gt;<i> affect any one.
</I>&gt;<i>
</I>&gt;<i> What you have appears to be almost correct. Since you are dealing with
</I>&gt;<i> 3.1 vs 3.5, you need to keep in mind the differences in behaviour
</I>&gt;<i> between HTTP/1.0 (3.1) and HTTP/1.1 (3.5).
</I>&gt;<i>
</I>&gt;<i> One of the side effects is that the default peer query messaging is ICP
</I>&gt;<i> which does not work at all well with HTTP/1.1 Vary caching. HTCP was
</I>&gt;<i> designed to avoid those problems, but needs turning on explcicitly.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I would like to take benefit of each others cache, whats the best
</I>&gt;&gt;<i> setup for cache_peer in this setup.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Neither server is closer to the internet.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I suggest you:
</I>&gt;<i>
</I>&gt;<i> 1) add the &quot;htcp&quot; option to the cache_peer lines. So the peer selection
</I>&gt;<i> can use the full HTTP/1.1 headers to decide if the peer cached object is
</I>&gt;<i> actually usable.
</I>&gt;<i>
</I>&gt;<i> 2) Remove the &quot;via off&quot; from your config file.
</I>&gt;<i>
</I>&gt;<i> 3) remove the standby= parameter from cache_peer until you have at least
</I>&gt;<i> got the original setup working.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There might be other things involved, but we cant know that without the
</I>&gt;<i> details about those things existence or absence from your config.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008101.html">[squid-users] setting up cache peering
</A></li>
	<LI>Next message (by thread): <A HREF="008091.html">[squid-users] mail upload problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8109">[ date ]</a>
              <a href="thread.html#8109">[ thread ]</a>
              <a href="subject.html#8109">[ subject ]</a>
              <a href="author.html#8109">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
