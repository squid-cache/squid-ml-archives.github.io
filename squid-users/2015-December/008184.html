<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ntlm_auth defaulting to succeed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ntlm_auth%20defaulting%20to%20succeed&In-Reply-To=%3C5664C6C5.3080907%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008182.html">
   <LINK REL="Next"  HREF="008111.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ntlm_auth defaulting to succeed</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ntlm_auth%20defaulting%20to%20succeed&In-Reply-To=%3C5664C6C5.3080907%40treenet.co.nz%3E"
       TITLE="[squid-users] ntlm_auth defaulting to succeed">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Dec  6 23:37:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008182.html">[squid-users] ntlm_auth defaulting to succeed
</A></li>
        <LI>Next message (by thread): <A HREF="008111.html">[squid-users] Windows Uninstall to Update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8184">[ date ]</a>
              <a href="thread.html#8184">[ thread ]</a>
              <a href="subject.html#8184">[ subject ]</a>
              <a href="author.html#8184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/12/2015 9:54 a.m., Noel Kelly wrote:
&gt;<i> Thanks for this Francesco.  I have been experimenting with the various
</I>&gt;<i> authenticators without much success.
</I>&gt;<i> 
</I>&gt;<i> I have compiled squid-3.5.11 from source and ntlm_fake_auth doesn't
</I>&gt;<i> appear to work.  I have scoured the docs and the forums but I can't find
</I>&gt;<i> anyone saying it doesn't work.
</I>
It works if your clients accept a downgrade attack to NTLMv1.


&gt;<i> 
</I>&gt;<i> I have it set up like this in my squid.conf:
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/local/squid/libexec/ntlm_fake_auth -d -v -S
</I>&gt;<i> 
</I>&gt;<i> but I just get denied access whilst sending ADS 2008R2 domain
</I>&gt;<i> authentication via Firefox:
</I>&gt;<i> 
</I>&gt;<i> ==&gt; /usr/local/squid/var/logs/access.log &lt;==
</I>&gt;<i> 1449434911.652      0 192.168.5.35 TCP_DENIED/407 4473 GET
</I>&gt;<i> <A HREF="http://www.bbc.co.uk/">http://www.bbc.co.uk/</A> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> ==&gt; /usr/local/squid/var/logs/cache.log &lt;==
</I>&gt;<i> ntlm_fake_auth.cc(163): pid=30933 :Got 'YR' from Squid with data:
</I>&gt;<i> [0000]   4E 54 4C 4D 53 53 50 00   01 00 00 00 07 82 08 A2 NTLMSSP.
</I>&gt;<i> ........
</I>&gt;<i> [0010]   00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00 ........
</I>&gt;<i> ........
</I>&gt;<i> [0020]   06 01 B1 1D 00 00 00 0F   00 00 ........ ..
</I>&gt;<i> ntlm_fake_auth.cc(185): pid=30933 :sending 'TT' to squid with data:
</I>&gt;<i> [0000]   4E 54 4C 4D 53 53 50 00   02 00 00 00 09 00 09 00 NTLMSSP.
</I>&gt;<i> ........
</I>&gt;<i> [0010]   AE AA AA AA 07 82 08 A2   E4 9D FA 04 45 14 D1 A5 ........
</I>&gt;<i> ....E...
</I>&gt;<i> [0020]   00 00 00 00 00 00 3A 00   57 4F 52 4B 47 52 4F 55 ........
</I>&gt;<i> WORKGROU
</I>&gt;<i> [0030]   50                                                  P
</I>&gt;<i> 
</I>
That shows the first 407 out of the NTLM handshake being prepared by the
helper. Where is the second?


&gt;<i> ==&gt; /usr/local/squid/var/logs/access.log &lt;==
</I>&gt;<i> 1449434911.660      0 192.168.5.35 TCP_DENIED/407 4640 GET
</I>&gt;<i> <A HREF="http://www.bbc.co.uk/">http://www.bbc.co.uk/</A> - HIER_NONE/- text/html
</I>&gt;<i> 1449434911.706      0 192.168.5.35 TCP_IMS_HIT/304 249 GET
</I>&gt;<i> <A HREF="http://tex.uk.plc:8080/squid-internal-static/icons/SN.png">http://tex.uk.plc:8080/squid-internal-static/icons/SN.png</A> - HIER_NONE/-
</I>&gt;<i> image/png
</I>&gt;<i> 1449434913.266      0 192.168.5.35 TCP_DENIED/407 4473 GET
</I>&gt;<i> <A HREF="http://www.bbc.co.uk/">http://www.bbc.co.uk/</A> - HIER_NONE/- text/html
</I>
Either the client is not working correctly, or there are some missing
log lines earlier from the client. Note that NTLM auth may take many
seconds.

NTLM requires two 407 messages to perform its handshake. That cache.log
section is showing only the first step where the type-1 token (YR) is
being processed and type-2 (TT) generated for delivery to the UA.

The access.log is showing what appears to be only the final step, where
Squid is rejecting type-3 (KK) token and the UA is displaying the
auth-required error page message to the user.
 If that UA is displaying errors based on the TT token, then it is flat
out broken.

&gt;<i> 
</I>&gt;<i> I have tried ntlm_fake_auth.pl.in and ntlm_smb_lm_auth without success
</I>&gt;<i> too.
</I>

SMB LM helper requires a NTLM downgrade attack all the way to plain-text
LM auth so Squids' simple helper can decrypt on the fly. It is
thankfully getting kind of rare to encounter software which supports LM.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008182.html">[squid-users] ntlm_auth defaulting to succeed
</A></li>
	<LI>Next message (by thread): <A HREF="008111.html">[squid-users] Windows Uninstall to Update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8184">[ date ]</a>
              <a href="thread.html#8184">[ thread ]</a>
              <a href="subject.html#8184">[ subject ]</a>
              <a href="author.html#8184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
