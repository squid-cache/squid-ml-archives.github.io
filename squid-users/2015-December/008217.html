<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Slow Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Slow%20Squid&In-Reply-To=%3C56678A47.8000600%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008215.html">
   <LINK REL="Next"  HREF="008222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Slow Squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Slow%20Squid&In-Reply-To=%3C56678A47.8000600%40treenet.co.nz%3E"
       TITLE="[squid-users] Slow Squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  9 01:56:23 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008215.html">[squid-users] Slow Squid
</A></li>
        <LI>Next message (by thread): <A HREF="008222.html">[squid-users] Slow Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8217">[ date ]</a>
              <a href="thread.html#8217">[ thread ]</a>
              <a href="subject.html#8217">[ subject ]</a>
              <a href="author.html#8217">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/12/2015 1:50 p.m., Patrick Flaherty wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> My Squid Server is much slower to go through than direct access to the
</I>&gt;<i> internet. I would expect it to be slower but not dramatically slower. Any
</I>&gt;<i> tips to speed it up? It's only used to access 8 whitelisted domains. I am
</I>&gt;<i> not using the disk based cache as it's only 8 sites total we hit. See my
</I>&gt;<i> squid config below and please offer any suggestions.
</I>&gt;<i> 
</I>

What Squid version are you using?
 And what are the values for &quot;slower&quot; ?


&gt;<i> 
</I>&gt;<i> # acl and http_access to (&quot;whitelist.txt&quot;)
</I>&gt;<i> 
</I>&gt;<i> acl whitelist dstdomain  &quot;c:/squid/etc/squid/whitelist.txt&quot;
</I>
[ I'm not sure if this following applies to the Cygwin builds. It may
not, but since the FD limit is actually coming from the Windows kernel
itself it might anyway. ]

On Windows the proxy faces an absolute OS limit of 2048 FD that are
available per-process group.

Since each transaction/request uses 2-3 FD that means Squid on Windows
can service no more than ~1,000 RPS regardless of CPU capacity. Keeping
in mind modern browsers open 6 connections to a proxy, that means
160-200 concurrent visitors.

By comparison non-Windows proxies can reach ~20,000 RPS with up to 10K
concurrent visitors. So &quot;slow&quot; is par for the course on Windows (if you
have a lot of users).


&gt;<i> 
</I>&gt;<i> http_access        allow     whitelist
</I>&gt;<i> 
</I>
At this point, anybody from anywhere (the whole Internet) who can access
the proxy is allowed to fetch anythign from the whitelisted
servers/domains through it. No other limits on those servers.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # network source of proxy traffic
</I>&gt;<i> 
</I>&gt;<i> acl localnet  src        all
</I>&gt;<i> 
</I>
So you are defining the entire Internet as being your LAN.

All the security controls, both those configured in your squid.conf
*and* any default built-in Squid settings that restrict access to the
LAN will now be wide open to any external visitor.


&gt;<i> 
</I>&gt;<i> # acl directives for ports and protocols
</I>&gt;<i> 
</I>&gt;<i> acl http      proto      http
</I>&gt;<i> 
</I>&gt;<i> acl https     proto      https
</I>&gt;<i> 
</I>&gt;<i> acl port_80   port       80
</I>&gt;<i> 
</I>&gt;<i> acl sslports  port       443
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT   method     CONNECT
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # localhost proxy access
</I>&gt;<i> 
</I>&gt;<i> acl localhost src 127.0.0.1/32
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>
You now have unlimited access to any of the whitelisted domains (from
earlier) *or* to anywhere at all when coming from localhost.

Note that this is *extending* the built-in definition of localhost ACL
(if you have a current Squid) which already includes the entire 127/8
and ::1 network ranges.


&gt;<i> 
</I>&gt;<i> # rules allowing proxy access
</I>&gt;<i> 
</I>&gt;<i> http_access allow http    port_80  whitelist localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow https   sslports whitelist localnet
</I>&gt;<i> 
</I>
These ACLs do nothing but waste CPU. All requests for whitelist domains
are permitted earlier without the protocol and port restrictions.


&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # dns servers (Change dns_nameservers to client dns servers for consistency
</I>&gt;<i> and better performance)
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 172.16.50.1 172.16.50.9
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # cache web pages directory
</I>&gt;<i> 
</I>&gt;<i> #cache_dir ufs C:/Squid/var/cache/squid 100 16 256
</I>&gt;<i> 
</I>&gt;<i> cache_mem 64 MB
</I>&gt;<i> 
</I>
There are two implications from this 64MB of RAM cache.

Firstly, memory cache is the primary source of traffic acceleration for
Squid. Having only a small amount limits how much acceleration Squid can
do when the proxy is under load.


If the machine the proxy is running on is an embeded device or minimal
VM so limited that it can only spare 64MB of RAM for caching. Then it is
likely that the available CPU is also constrained and that prpcessor
limit may be the direct cause of the proxy being slow.


&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # log file roll weekly
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 7
</I>&gt;<i> 
</I>
NP: most systems default to daily for this AFAIK. If the logs get very
big then the filesystem can cause slowdown appending to them. I'm not
sure if that is relevant for your case, but worth checking.


&gt;<i> 
</I>&gt;<i> # access log rules
</I>&gt;<i> 
</I>&gt;<i> logformat squid %tl %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt
</I>&gt;<i> 
</I>
Do not redefine a built-in log format. Either use the built-in
definition, or make your custom one have a different name.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008215.html">[squid-users] Slow Squid
</A></li>
	<LI>Next message (by thread): <A HREF="008222.html">[squid-users] Slow Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8217">[ date ]</a>
              <a href="thread.html#8217">[ thread ]</a>
              <a href="subject.html#8217">[ subject ]</a>
              <a href="author.html#8217">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
