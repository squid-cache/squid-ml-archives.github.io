<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Authentication pop-ups. Questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Authentication%20pop-ups.%20Questions&In-Reply-To=%3C5668A374.9030307%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008219.html">
   <LINK REL="Next"  HREF="008220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Authentication pop-ups. Questions</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Authentication%20pop-ups.%20Questions&In-Reply-To=%3C5668A374.9030307%40treenet.co.nz%3E"
       TITLE="[squid-users] Authentication pop-ups. Questions">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  9 21:56:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008219.html">[squid-users] Authentication pop-ups. Questions
</A></li>
        <LI>Next message (by thread): <A HREF="008220.html">[squid-users] issue with video
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8225">[ date ]</a>
              <a href="thread.html#8225">[ thread ]</a>
              <a href="subject.html#8225">[ subject ]</a>
              <a href="author.html#8225">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/12/2015 3:25 a.m., Ver&#243;nica Ovando wrote:
&gt;<i> Hi. I have Squid 3.5 running over Debian 8.
</I>&gt;<i> 
</I>&gt;<i> I am using AD authentication. This is part of my squid.conf:
</I>&gt;<i> 
</I>&gt;<i> #auth_param ntlm program /usr/local/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=DOMAIN.com
</I>&gt;<i> auth_param ntlm program /usr/local/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 30
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/local/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 5
</I>&gt;<i> auth_param basic realm Servidor proxy-cache de mi Dominio
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> 
</I>&gt;<i> external_acl_type AD_Grupos ttl=10 children=10 %LOGIN
</I>&gt;<i> /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i> 
</I>&gt;<i> acl AD_Standard external Grupos_AD Standard
</I>&gt;<i> acl AD_Exceptuados external Grupos_AD Exceptuados
</I>&gt;<i> acl AD_Bloqueados external Grupos_AD Bloqueados
</I>&gt;<i> 
</I>&gt;<i> acl face url_regex -i &quot;/etc/squid3/facebook&quot;
</I>&gt;<i> acl gob url_regex -i &quot;/etc/squid3/gubernamentales&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access allow AD_Standard
</I>&gt;<i> http_access allow AD_Exceptuados face
</I>&gt;<i> http_access allow AD_Exceptuados gob
</I>&gt;<i> http_access deny AD_Bloqueados
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When  a users that belongs to AD_Bloqueados is asked for the AD user and
</I>&gt;<i> password (of course he/she needs one that belongs to AD_Standard or
</I>&gt;<i> AD_Exceptuados). 
</I>
The first login check is for &quot;AD_Standard&quot;. Users initial login is
checked for that group membership ... then a 407 *re-login* is requested
if they are part of AD_Bloqueados.

All users are logged in, just to check the group. So &quot;deny all&quot; at the
end never actually happens unless the user is part of some 5th or 6th
group (for example &quot;Administrators&quot; or &quot;Domain Servers&quot;).

When you are authenticating based on *group* instead of the
user/password things get really weird.


&gt;<i> When I try to use one of those users I cannot
</I>&gt;<i> authenticate correctly. the popup appears many times until I cancel it.
</I>&gt;<i> But sometimes it works. I use all the browsers to do the tests (IE,
</I>&gt;<i> Mozilla and the latest Chrome). With Chrome I get good results, but as I
</I>&gt;<i> said, it works sometimes.
</I>&gt;<i> 
</I>&gt;<i> Because sometimes I login with users not in the domain and I need to
</I>&gt;<i> access to internet, I cannot use the 'all' directive in the end of the
</I>&gt;<i> line of 'http_access deny AD_Bloqueados.'
</I>
Which means that whenever that group AD_Bloqueados matches the user will
have to *re-login*. Popups etc are expected in such events, because the
browser has what it thinks are fine credentials to use. But has just
been informed that its known set of credentials were invalid. They
almost all panic at that point and do a popup.

Note that the browser does not get told *why* the rejection (it might be
a random attacker, so that info is privileged). Just that the
credentials are not usable.

&gt;<i> 
</I>&gt;<i> I will appreciate a lot any help you can give me.
</I>

I highly recommend that you do it like this:

 acl auth proxy_auth REQUIRED
 http_access deny !auth
 http_access allow AD_Standard
 http_access allow face AD_Exceptuados
 http_access allow gob AD_Exceptuados
 http_access deny all

Why:
* that !auth will ensure that users are only authenticated once and the
407 request lookup cycles all happen predictably at that first line
instead of interleaved within the group checks.

* the line ordering change of face/gob ACLs will greatly reduce the time
and CPU spent on helper lookups for non-face and non-gob traffic. (up to
50% reduction in proxy caused latency).

Note that you dont even need to check group AD_Bloqueados. The &quot;deny
all&quot; at the end rejects that groups access along with all other
undefined groups.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008219.html">[squid-users] Authentication pop-ups. Questions
</A></li>
	<LI>Next message (by thread): <A HREF="008220.html">[squid-users] issue with video
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8225">[ date ]</a>
              <a href="thread.html#8225">[ thread ]</a>
              <a href="subject.html#8225">[ subject ]</a>
              <a href="author.html#8225">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
