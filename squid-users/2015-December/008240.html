<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] delay_pools from 3.1 to 3.4, media content
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20delay_pools%20from%203.1%20to%203.4%2C%20media%20content&In-Reply-To=%3C56695BD6.8000306%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008235.html">
   <LINK REL="Next"  HREF="008238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] delay_pools from 3.1 to 3.4, media content</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20delay_pools%20from%203.1%20to%203.4%2C%20media%20content&In-Reply-To=%3C56695BD6.8000306%40treenet.co.nz%3E"
       TITLE="[squid-users] delay_pools from 3.1 to 3.4, media content">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 10 11:02:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008235.html">[squid-users] delay_pools from 3.1 to 3.4, media content
</A></li>
        <LI>Next message (by thread): <A HREF="008238.html">[squid-users] delay syntax, speed and network
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8240">[ date ]</a>
              <a href="thread.html#8240">[ thread ]</a>
              <a href="subject.html#8240">[ subject ]</a>
              <a href="author.html#8240">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/12/2015 11:21 p.m., <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Massimo.Sala at asl.bergamo.it</A> wrote:
&gt;<i> Massimo :
</I>&gt;&gt;&gt;<i> acl acl_flussi_media rep_mime_type -i ^audio/
</I>&gt;&gt;&gt;<i> acl acl_flussi_media rep_mime_type -i ^video/
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 2015/12/03 12:38:45 kid1| WARNING: acl_flussi_media ACL is used in 
</I>&gt;&gt;&gt;<i> context without an HTTP response. Assuming mismatch.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos :
</I>&gt;&gt;<i> It means that *reply* header do not work when using *request* to decide
</I>&gt;&gt;<i> what delay pool the transaction will use.
</I>&gt;<i> 
</I>&gt;&gt;<i> It has never worked. The older Squid just did not tell you about the
</I>&gt;&gt;<i> config problem.
</I>&gt;<i> 
</I>&gt;&gt;<i> If you want traffic to be re-assigned to pools when the reply happens
</I>&gt;&gt;<i> you need to upgrade to at least the Squid-4.0.3 (beta) release.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos, many thanks for your answer.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> An example of ACLs to catch media content, e.g. :
</I>&gt;<i> 
</I>&gt;<i>         acl acl_sites_media dstdomain .ask.fm .facebook.com .fbcdn.net 
</I>&gt;<i> .googlevideo.com .youtube.com
</I>&gt;<i>         acl acl_types_media urlpath_regex -i \.asf$ \.avi$ \.flv$ \.mkv$ 
</I>&gt;<i> \.mov$ \.mp3$ \.mp4$ \.mpeg$ \.mpg$ \.qt$ \.swf$ \.vob$ \.wmv$
</I>&gt;<i> 
</I>
Both of those match against parts of the request message URL. Which is
fine for delay_access.

Be aware that neither of those matches the real content type.

Your config used to have a rep_mime_type ACL trying to check reply
header value. Which is the correct way to match mime / content type. It
just happens to be data only available after the reply has started
happening.

  acl acl_flussi_media rep_mime_type -i ^audio/
  acl acl_flussi_media rep_mime_type -i ^video/


&gt;<i> 
</I>&gt;<i> 1) To apply the two ACLs to the same pool, which is the correct syntax ?
</I>&gt;<i> 
</I>&gt;<i>         delay_access 1 allow acl_sites_media
</I>&gt;<i>         delay_access 1 allow acl_types_media
</I>&gt;<i> 
</I>&gt;<i> or
</I>&gt;<i> 
</I>&gt;<i>         delay_access 1 allow acl_sites_media acl_types_media
</I>&gt;<i> 
</I>
Both and neither. &quot;correct&quot; depends on what your local administrative
policy is.


&gt;<i> 
</I>&gt;<i> 2)  Can you please add all of these stuff to the official docs ?
</I>
Where exactly did you look in the documentation? We dont have anything
provided by the Squid Project mentioning how to use delay pools for mime
content delaying. Specifically because it has not been possible to do
until very recently.


&lt;<A HREF="http://www.squid-cache.org/Doc/config/delay_access/">http://www.squid-cache.org/Doc/config/delay_access/</A>&gt;
 &quot;This is used to determine which delay pool a request falls into.&quot;

 Note the use of *request*.

&lt;<A HREF="http://ww.squid-cache.org/Doc/config/acl/">http://ww.squid-cache.org/Doc/config/acl/</A>&gt;
&quot;
	acl aclname rep_mime_type [-i] mime-type ...
	  # regex match against the mime type of the reply received by
	  # squid. Can be used to detect file download or some
	  # types HTTP tunneling requests. [fast]
	  # NOTE: This has no effect in http_access rules. It only has
	  # effect in rules that affect the reply data stream such as
	  # http_reply_access.
&quot;

Note the repeated used of *reply*. And the extra notice about usage only
with reply related rules (unlike delay_access).

It should be obvious at least from the second that the first is not
somewhere it will be useful.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008235.html">[squid-users] delay_pools from 3.1 to 3.4, media content
</A></li>
	<LI>Next message (by thread): <A HREF="008238.html">[squid-users] delay syntax, speed and network
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8240">[ date ]</a>
              <a href="thread.html#8240">[ thread ]</a>
              <a href="subject.html#8240">[ subject ]</a>
              <a href="author.html#8240">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
