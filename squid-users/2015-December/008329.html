<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] file descriptors leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C566FFCA0.8010901%40brazcubas.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008335.html">
   <LINK REL="Next"  HREF="008330.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] file descriptors leak</H1>
    <B>Andr&#233; Janna</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C566FFCA0.8010901%40brazcubas.br%3E"
       TITLE="[squid-users] file descriptors leak">andre61 at brazcubas.br
       </A><BR>
    <I>Tue Dec 15 11:42:24 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008335.html">[squid-users] Reverse proxy: session expired in 15 minutes
</A></li>
        <LI>Next message (by thread): <A HREF="008330.html">[squid-users] squid 3.5.12 and ecap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8329">[ date ]</a>
              <a href="thread.html#8329">[ thread ]</a>
              <a href="subject.html#8329">[ subject ]</a>
              <a href="author.html#8329">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Em 28/11/2015 22:46, Andr&#233; Janna escreveu:
&gt;<i> I took another network trace this time both at Squid and Windows 
</I>&gt;<i> client ends.
</I>&gt;<i>
</I>&gt;<i> cache.log:
</I>&gt;<i> 2015/11/27 11:30:55.610 kid1| SECURITY ALERT: Host header forgery 
</I>&gt;<i> detected on local=177.43.198.106:443 remote=192.168.64.4:61802 FD 5465 
</I>&gt;<i> flags=33 (local IP does not match any domain IP)
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i> network trace at Squid side
</I>&gt;<i>
</I>&gt;<i> client connects
</I>&gt;<i> 11:30:55.604870 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [S], 
</I>&gt;<i> seq 1701554341, win 8192, options [mss 1460,nop,wscale 
</I>&gt;<i> 8,nop,nop,sackOK], length 0
</I>&gt;<i> 11:30:55.604992 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags 
</I>&gt;<i> [S.], seq 3125704417, ack 1701554342, win 29200, options [mss 
</I>&gt;<i> 1460,nop,nop,sackOK,nop,wscale 7], length 0
</I>&gt;<i> 11:30:55.605766 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> ack 1, win 256, length 0
</I>&gt;<i>
</I>&gt;<i> client sends SSL hello
</I>&gt;<i> 11:30:55.606242 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags 
</I>&gt;<i> [P.], seq 1:198, ack 1, win 256, length 197
</I>&gt;<i> 11:30:55.606306 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, length 0
</I>&gt;<i>
</I>&gt;<i> client OS sends TCP keep-alive packets
</I>&gt;<i> 11:31:05.607191 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 197:198, ack 1, win 256, length 1
</I>&gt;<i> 11:31:05.607231 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, options [nop,nop,sack 1 {197:198}], length 0
</I>&gt;<i> 11:31:15.608966 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 197:198, ack 1, win 256, length 1
</I>&gt;<i> 11:31:15.609005 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, options [nop,nop,sack 1 {197:198}], length 0
</I>&gt;<i> 11:31:25.614527 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 197:198, ack 1, win 256, length 1
</I>&gt;<i> 11:31:25.614589 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, options [nop,nop,sack 1 {197:198}], length 0
</I>&gt;<i>
</I>&gt;<i> client sends FIN
</I>&gt;<i> 11:31:29.384280 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags 
</I>&gt;<i> [F.], seq 198, ack 1, win 256, length 0
</I>&gt;<i> 11:31:29.421787 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, length 0
</I>&gt;<i>
</I>&gt;<i> client OS sends TCP keep-alive packets
</I>&gt;<i> 11:31:39.417426 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 198:199, ack 1, win 256, length 1
</I>&gt;<i> 11:31:39.417489 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, options [nop,nop,sack 1 {198:199}], length 0
</I>&gt;<i> 11:31:49.425366 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 198:199, ack 1, win 256, length 1
</I>&gt;<i> 11:31:49.425443 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, options [nop,nop,sack 1 {198:199}], length 0
</I>&gt;<i> 11:31:59.426153 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 198:199, ack 1, win 256, length 1
</I>&gt;<i> 11:31:59.426233 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, options [nop,nop,sack 1 {198:199}], length 0
</I>&gt;<i> .... it continues this way until I powered off Windows client after 
</I>&gt;<i> three hours ...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i> network trace at Windows client side
</I>&gt;<i>
</I>&gt;<i> client connects
</I>&gt;<i> 11:30:34.894242 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [S], 
</I>&gt;<i> seq 1701554341, win 8192, options [mss 1460,nop,wscale 
</I>&gt;<i> 8,nop,nop,sackOK], length 0
</I>&gt;<i> 11:30:34.898234 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags 
</I>&gt;<i> [S.], seq 3125704417, ack 1701554342, win 29200, options [mss 
</I>&gt;<i> 1460,nop,nop,sackOK,nop,wscale 7], length 0
</I>&gt;<i> 11:30:34.898298 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> ack 1, win 256, length 0
</I>&gt;<i>
</I>&gt;<i> client sends SSL hello
</I>&gt;<i> 11:30:34.898712 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags 
</I>&gt;<i> [P.], seq 1:198, ack 1, win 256, length 197
</I>&gt;<i> 11:30:34.899479 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, length 0
</I>&gt;<i>
</I>&gt;<i> client OS sends TCP keep-alive packets
</I>&gt;<i> 11:30:44.899271 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 197:198, ack 1, win 256, length 1
</I>&gt;<i> 11:30:44.899986 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, options [nop,nop,sack 1 {197:198}], length 0
</I>&gt;<i> 11:30:54.900495 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 197:198, ack 1, win 256, length 1
</I>&gt;<i> 11:30:54.901323 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, options [nop,nop,sack 1 {197:198}], length 0
</I>&gt;<i> 11:31:04.905731 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 197:198, ack 1, win 256, length 1
</I>&gt;<i> 11:31:04.906560 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 198, win 237, options [nop,nop,sack 1 {197:198}], length 0
</I>&gt;<i>
</I>&gt;<i> client sends FIN
</I>&gt;<i> 11:31:08.675299 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags 
</I>&gt;<i> [F.], seq 198, ack 1, win 256, length 0
</I>&gt;<i> 11:31:08.713746 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, length 0
</I>&gt;<i>
</I>&gt;<i> client OS sends TCP keep-alive packets
</I>&gt;<i> 11:31:18.708086 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 198:199, ack 1, win 256, length 1
</I>&gt;<i> 11:31:18.708917 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, options [nop,nop,sack 1 {198:199}], length 0
</I>&gt;<i> 11:31:28.715600 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 198:199, ack 1, win 256, length 1
</I>&gt;<i> 11:31:28.716516 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, options [nop,nop,sack 1 {198:199}], length 0
</I>&gt;<i> 11:31:38.714887 IP 192.168.64.4.61802 &gt; 177.43.198.106.443: Flags [.], 
</I>&gt;<i> seq 198:199, ack 1, win 256, length 1
</I>&gt;<i> 11:31:38.716911 IP 177.43.198.106.443 &gt; 192.168.64.4.61802: Flags [.], 
</I>&gt;<i> ack 199, win 237, options [nop,nop,sack 1 {198:199}], length 0
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So after less then one minute after connection Windows client sent a 
</I>&gt;<i> FIN and Linux server acknowledged.
</I>&gt;<i> Windows netstat showed that connection changed to FIN_WAIT_2 state 
</I>&gt;<i> while Linux netstat showed that connection at Squid endpoint changed 
</I>&gt;<i> to CLOSE_WAIT state.
</I>&gt;<i>   # date; netstat -tno | grep 192.168.64.4
</I>&gt;<i>   Fri Nov 27 11:32:13 BRST 2015
</I>&gt;<i>   tcp6       1      0 172.16.10.22:3126 192.168.64.4:61802      
</I>&gt;<i> CLOSE_WAIT  off (0.00/0/0)
</I>&gt;<i>
</I>&gt;<i> According to 
</I>&gt;<i> <A HREF="http://www.tcpipguide.com/free/t_TCPConnectionTermination-2.htm">http://www.tcpipguide.com/free/t_TCPConnectionTermination-2.htm</A> in 
</I>&gt;<i> this state the server IP stack is waiting for Squid to be ready to 
</I>&gt;<i> close the connection.
</I>&gt;<i>
</I>&gt;<i> After 3 hours from initial connection netstat state on client was 
</I>&gt;<i> still FIN_WAIT_2 and on server was still CLOSE_WAIT.
</I>&gt;<i> So I powered off Windows laptop and waited 3 hours more but nothing 
</I>&gt;<i> changed, connection remained in CLOSE_WAIT state and Squid didn't 
</I>&gt;<i> release the file descriptor.
</I>&gt;<i>   Fri Nov 27 18:22:25 BRST 2015
</I>&gt;<i>   squid      2708           proxy 5465u     IPv6 620209      
</I>&gt;<i> 0t0        TCP 172.16.10.22:3126-&gt;192.168.64.4:61802 (CLOSE_WAIT)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Andr&#233;
</I>

I installed Squid 3.5.12 on another machine and got the same problem as 
before.
Squid keeps using file descriptors for connections that have been in 
CLOSE_WAIT state for hours.
My guess is that Squid doesn't release the file descriptor when 
intercepts an https connection that triggers &quot;local IP does not match 
any domain IP&quot; warning in cache.log.


Regards,
Andr&#233;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008335.html">[squid-users] Reverse proxy: session expired in 15 minutes
</A></li>
	<LI>Next message (by thread): <A HREF="008330.html">[squid-users] squid 3.5.12 and ecap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8329">[ date ]</a>
              <a href="thread.html#8329">[ thread ]</a>
              <a href="subject.html#8329">[ subject ]</a>
              <a href="author.html#8329">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
