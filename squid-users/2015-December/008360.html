<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid: forward to another squid server with authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%3A%20forward%20to%20another%20squid%20server%20with%0A%20authentication&In-Reply-To=%3C5670D153.501%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008359.html">
   <LINK REL="Next"  HREF="008372.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid: forward to another squid server with authentication</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%3A%20forward%20to%20another%20squid%20server%20with%0A%20authentication&In-Reply-To=%3C5670D153.501%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid: forward to another squid server with authentication">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 16 02:49:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008359.html">[squid-users] Squid: forward to another squid server with	authentication
</A></li>
        <LI>Next message (by thread): <A HREF="008372.html">[squid-users] [MASSMAIL] Squid: forward to another squid server with authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8360">[ date ]</a>
              <a href="thread.html#8360">[ thread ]</a>
              <a href="subject.html#8360">[ subject ]</a>
              <a href="author.html#8360">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/12/2015 1:03 p.m., Amaury Viera Hern&#225;ndez wrote:
&gt;<i> Hello everyone. This is a more detailed explanation about my
</I>&gt;<i> trouble:
</I>&gt;<i> 
</I>
The more detailed explanation makes it clear that you are not going to
be able to use the login=PASSTHRU workaround for getting NTLM to work.
Clients that are intercepted simply *cannot* authenticate to a proxy. So
there is nothing to pass through.

That leaves you with Negotiate or Basic authentication credentials
explicitly added by your proxy.


Be aware that doing what you intend will make you and your student
account personaly responsible for *all* traffic that goes through your
proxy to the upstream. If anyone else manages to hook into your wifi AP,
they will essentially have free access and you pay the costs.


&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> I'm using ubuntu 15.10 with squid3 (3.3.8)
</I>&gt;<i> 
</I>&gt;<i> I have this configuration in squid.conf (This is very functional for
</I>&gt;<i> local domain(without proxy authentications, against the local
</I>&gt;<i> domains, for example: intranet.uci.cu, but for internet domains I
</I>&gt;<i> need to authenticate(cache_peer my proxy with the proxy of my
</I>&gt;<i> university)) )
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl localdst dstdomain
</I>&gt;<i> acl mi_red src 10.42.0.0/24
</I>&gt;<i> http_access allow mi_red
</I>
So anyone connecting from 10.42.0.0/24 is allowed through this proxy.
With absolutely zero protections. That is bad.

At the very least move the &quot;allow mi_red&quot; line down ...

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>
... to here.

&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 10.42.0.1:3128 transparent
</I>
3128 is the registered Squid port for foward/explicit-proxy
communications. It should remain in squid.conf but without the
&quot;transparent&quot; mode flag.

You should probably also set this port to be &quot;127.0.0.1:3128&quot; for yoru
situation.

You should pick another port number randomly for the intercept and use
that for &quot;intercept&quot; mode traffic. There are also additional parts to
the firewall script, which I will cover below.

Also, notice that NAT port is &quot;intercept&quot; not &quot;transparent&quot;.

Please run &quot;squid -k parse&quot; and fix any warnings it produces about other
things. I'm only mentioing the big ones which that old version  might
not be able to mention.

&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> cache_mem 512 MB
</I>&gt;<i> cache_dir ufs /var/spool/squid3 2048 16 256
</I>&gt;<i> cache_effective_user proxy
</I>&gt;<i> cache_effective_group proxy
</I>&gt;<i> half_closed_clients off
</I>&gt;<i> maximum_object_size 1024 KB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> memory_pools off
</I>&gt;<i> error_directory /usr/share/squid3/errors/es/
</I>&gt;<i> access_log /var/log/squid3/access.log squid
</I>
This ...

&gt;<i> cache_peer 10.0.0.1 parent 8080 0 no-query default no-digest login=avhernandez:MyPass
</I>&gt;<i> never_direct allow all
</I>
... is correct for sending Basic auth credentials to the upstream. That
may work, but is not very secure.

Your Squid should also be capable of the login=NEGOTIATE method of
authentication. If that works with the upstream proxy (it may or may
not) then it is better to use than Basic.

First do the firewall fixes below before experimenting with these
changes though.


&gt;<i> 
</I>&gt;<i> I'm using this firewall script
</I>&gt;<i> 
</I>
Best practice is to use the iptables-restore tool when scripting
firewall actions. Otherwise there are gaps in timing between the -F
flush command and rule setup during which any active traffic can slip
past your intended rules and have long-lasting effects on the connection
states.
IIRC it was setup the firewall manually with your rules, and use the
restore tool to save a config snapshot for fast loading by the script.


&gt;<i> #!/bin/sh
</I>&gt;<i> # IP del servidor SQUID
</I>&gt;<i> SQUID_SERVER=&quot;10.42.0.1&quot;
</I>&gt;<i> # Interface conectada a Internet
</I>&gt;<i> INTERNET=&quot;enp4s0&quot;
</I>&gt;<i> # Interface interna
</I>&gt;<i> LAN_IN=&quot;wlp2s0&quot;
</I>&gt;<i> # Puerto Squid
</I>&gt;<i> SQUID_PORT=&quot;3128&quot;
</I>
Change that to whatever you use in squid.conf for the intercept port.

&gt;<i> 
</I>&gt;<i> # Limpia las reglas anteriores
</I>&gt;<i> iptables -F
</I>&gt;<i> iptables -X
</I>&gt;<i> iptables -t nat -F
</I>&gt;<i> iptables -t nat -X
</I>&gt;<i> iptables -t mangle -F
</I>&gt;<i> iptables -t mangle -X
</I>&gt;<i> # Carga los modulos IPTABLES para NAT e IP con soporte conntrack
</I>&gt;<i> modprobe ip_conntrack
</I>&gt;<i> modprobe ip_conntrack_ftp
</I>&gt;<i> echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</I>&gt;<i> # Politica de filtro por defecto
</I>&gt;<i> iptables -P INPUT DROP
</I>&gt;<i> iptables -P OUTPUT ACCEPT
</I>&gt;<i> # Acceso ilimitado a loop back
</I>&gt;<i> iptables -A INPUT -i lo -j ACCEPT
</I>&gt;<i> iptables -A OUTPUT -o lo -j ACCEPT
</I>
ICMP is a mandatory protocol, and needs to be allowed as well.
- When bad traffic is rejected by your machine it is ICMP packets that
do the rejection.
- When something is not quite working right it is ICMP error messages
which allow software like Squid to automatically repair or workaround
the damage. And to help you debug what is going on if manual attention
is needed.


&gt;<i> # Permite UDP, DNS y FTP pasivo
</I>&gt;<i> iptables -A INPUT -i $INTERNET -m state --state ESTABLISHED,RELATED -j ACCEPT
</I>
The comment about &quot;UDP, DNS y FTP pasivo&quot; is does not match the rule it
is documenting.

The rule is allowing aready established connections from remote /
Internet clients to the servers running on your machine to fast-track
through the firewall.

That is normal and okay as a rule. The issue I am highlighting here is
that the comment is bad and may be making you think wrong.

You also need this rule to apply to all traffic, on all interfaces
(including &quot;lo&quot;). So remove the -i parameter.


This...

&gt;<i> # Establece el servidor como router para la red
</I>&gt;<i> iptables --table nat --append POSTROUTING --out-interface $INTERNET -j MASQUERADE
</I>&gt;<i> iptables --append FORWARD --in-interface $LAN_IN -j ACCEPT
</I>
... No. Remove.

There is a better MASQUERADE rule in the wiki page referenced below.

If you need to allow any traffic forwarding straight through your
machine. Do so only and specifically for individual ports or protocols.
You are not running a carrier network here.

For example; this is where you set DNS queries to be allowed:
 -t FORWARD -p udp --dport 53 -j ACCEPT
 -t FORWARD -p tcp --dport 53 -j ACCEPT

Given the phone involvement you may also want to look into whether it
wants VoIP ports. And email POP/IMAP/SMTP/Submit ports may also be
needed - be extra careful about random hijackers sending Spam on those
ones though.


&gt;<i> # acceso ilimiato a la LAN
</I>&gt;<i> iptables -A INPUT -i $LAN_IN -j ACCEPT
</I>
That above one lets unconditionally all remote devices that can connect
to your wifi interface use any service on your machine. Which is bad.
Especially since you also unconditionally allow access through the proxy
in squid.conf.

If you need any rules on INPUT at all, you should make them specific to
the services you want to be available publicly. But remember that these
rules are for accessing services running directly on your machine - not
relevant when connecting to upstream or Internet servers.


Both INPUT and FORWARD are the main firewall protections against traffic
being sent into your machines software, or trying to forward through it
to other machines. Be very careful what you ACCEPT in those table rules.


&gt;<i> iptables -A OUTPUT -o $LAN_IN -j ACCEPT
</I>
This...

&gt;<i> # Redirige las peticiones de la red interna hacia el proxy
</I>&gt;<i> iptables -t nat -A PREROUTING -i $LAN_IN -p tcp --dport 80 -j DNAT --to $SQUID_SERVER:$SQUID_PORT
</I>&gt;<i> # Redirige la entrada al proxy
</I>&gt;<i> iptables -t nat -A PREROUTING -i $INTERNET -p tcp --dport 80 -j REDIRECT --to-port $SQUID_PORT
</I>
... No. Remove.

For Squid use the rules on this wiki page (in the same order as shown),
instead of both sets above which I marked as &quot;No. Remove&quot;.

&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>&gt;


PS. Also dont forget that IPv6 exists. Your firewall settings *need* to
also correctly setup IPv6 access (or denial) with ip6tables. Since you
are working with a phone it is even more likely that IPv6 will be needed
than on a generic LAN / wifi.
 They should generally match your IPv4 settings. But there are some
small differences.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008359.html">[squid-users] Squid: forward to another squid server with	authentication
</A></li>
	<LI>Next message (by thread): <A HREF="008372.html">[squid-users] [MASSMAIL] Squid: forward to another squid server with authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8360">[ date ]</a>
              <a href="thread.html#8360">[ thread ]</a>
              <a href="subject.html#8360">[ subject ]</a>
              <a href="author.html#8360">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
