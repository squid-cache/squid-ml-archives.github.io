<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.10 samba4 kerberos few questions (debain Jessie)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.10%20samba4%20kerberos%20few%20questions%0A%20%28debain%20Jessie%29&In-Reply-To=%3C567163AA.1000801%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008364.html">
   <LINK REL="Next"  HREF="008371.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.10 samba4 kerberos few questions (debain Jessie)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.10%20samba4%20kerberos%20few%20questions%0A%20%28debain%20Jessie%29&In-Reply-To=%3C567163AA.1000801%40treenet.co.nz%3E"
       TITLE="[squid-users] squid 3.5.10 samba4 kerberos few questions (debain Jessie)">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 16 13:14:18 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008364.html">[squid-users] squid 3.5.10 samba4 kerberos few questions (debain	Jessie)
</A></li>
        <LI>Next message (by thread): <A HREF="008371.html">[squid-users] squid authentication mechs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8368">[ date ]</a>
              <a href="thread.html#8368">[ thread ]</a>
              <a href="subject.html#8368">[ subject ]</a>
              <a href="author.html#8368">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/12/2015 11:48 p.m., L.P.H. van Belle wrote:
&gt;<i> Hai, 
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Im having the following running. 
</I>&gt;<i> 
</I>&gt;<i> Debian Jessie, squid 3.5.10 (recompiled from sid)  with icap and authorisation agains a samba 4 AD DC. 
</I>&gt;<i> 
</I>&gt;<i> I begin with, this works great !.. so now my questions and the conf part for this. 
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I am using the following authentications. 
</I>&gt;<i> 
</I>&gt;<i> First Kerberos:
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth -d \
</I>&gt;<i> 
</I>&gt;<i>     --kerberos /usr/lib/squid/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hostname.domain.tld at KERB.REALM</A> \
</I>&gt;<i> 
</I>&gt;<i>     --ntlm /usr/bin/ntlm_auth --helper-protocol=gss-spnego --domain=NTDOMAIN
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> And this works also
</I>&gt;<i> 
</I>&gt;<i> #auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth \
</I>&gt;<i> 
</I>&gt;<i> #    --kerberos /usr/lib/squid/negotiate_kerberos_auth -s GSS_C_NO_NAME -d \
</I>&gt;<i> 
</I>&gt;<i> #    --ntlm /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --domain= NTDOMAIN \
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I use as fallback  basic auth.
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ldap_auth -R \
</I>&gt;<i> 
</I>&gt;<i>     -b &quot;ou=SOMEOU,dc=internal,dc=domain.dc=tld&quot; \
</I>&gt;<i> 
</I>&gt;<i>     -D ldap-bind@ KERB.REALM  -W /etc/squid/private/ldap-bind \
</I>&gt;<i> 
</I>&gt;<i>     -f (|(userPrincipalName=%s)(sAMAccountName=%s)) \
</I>&gt;<i> 
</I>&gt;<i>     -h samba4-dc2.internal.domain.tld \
</I>&gt;<i> 
</I>&gt;<i>     -h samba4-dc1.internal.domain.tld
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I know the following: 
</I>&gt;<i> 
</I>&gt;<i> ## 1) Pure Kerberos. Passthrough auth for windows users with windows DOMAIN JOINED pc's.
</I>&gt;<i> 
</I>&gt;<i> ##    Fallback to Ldap for NON WINDOWS NON DOMAIN JOINED Devices.
</I>&gt;<i> 
</I>&gt;<i> ##    NO NTLM. AKA, a windows pc, NOT JOINED in the domain, with end up in always user popup for auth.
</I>&gt;<i> 
</I>&gt;<i> ##    Which will always fail because of NTLM TYPE 1 and TYPE 2, authorisations.
</I>&gt;<i> 
</I>&gt;<i> ## 2) NEGOTIATE AUTH, which will do all of above, but also authenticated Windows PC's Not domain Joined.
</I>&gt;<i> 
</I>
AFAIK #2 is incorrect. Negotiate still needs the *joined* part to be
true. They just do not have to have current connectivity to the DC
provided the secret-token part of credentials that comes from the DC is
still current on the client machine.


&gt;<i> 
</I>&gt;<i> When people access websites a see a lot of : TCP_DENIED/407 
</I>&gt;<i> 
</I>&gt;<i> Sometimes about 10-12 times the TCP_DENIED/407, even when the user already access the website and it authenticated. 
</I>&gt;<i> 
</I>&gt;<i> Is this because of pc&#8217;s auth, or user auth, or by design as i did read here : 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://www.squid-cache.org/mail-archive/squid-users/201310/0006.html">http://www.squid-cache.org/mail-archive/squid-users/201310/0006.html</A>
</I>

&gt;<i> 
</I>&gt;<i> acl AuthRequest http_status 407 
</I>&gt;<i> access_log ... !AuthRequest ...
</I>&gt;<i> 
</I>&gt;<i> is this the only solution to reduce the 407, or am i missing some setting here? 
</I>
It just hides them from the logging. They still happen.

Another workaround is suggested in that thread; to bypass and not
require authentication for some popular domains. That has the added
benefit of letting HTTP performance optimizations work - most HTTP
features actually have to be disabled in the presence of NTLM or Negotiate.

The solution is for clients to actually make use of the connection
persistence that NTLM and Negotiate *require* Squid to setup just to
perform those auth types. Tearing it all down after just one HTTP level
transaction is very wasteful.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008364.html">[squid-users] squid 3.5.10 samba4 kerberos few questions (debain	Jessie)
</A></li>
	<LI>Next message (by thread): <A HREF="008371.html">[squid-users] squid authentication mechs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8368">[ date ]</a>
              <a href="thread.html#8368">[ thread ]</a>
              <a href="subject.html#8368">[ subject ]</a>
              <a href="author.html#8368">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
