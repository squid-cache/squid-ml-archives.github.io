<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Time for cache synchronization between siblings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3CCALgKBSkFusG%3Dp4kgE60_uWe9qfxHrpFAj%2BcTUpQSMUw%2B6kMftA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008357.html">
   <LINK REL="Next"  HREF="008374.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Time for cache synchronization between siblings</H1>
    <B>Sreenath BH</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3CCALgKBSkFusG%3Dp4kgE60_uWe9qfxHrpFAj%2BcTUpQSMUw%2B6kMftA%40mail.gmail.com%3E"
       TITLE="[squid-users] Time for cache synchronization between siblings">bhsreenath at gmail.com
       </A><BR>
    <I>Wed Dec 16 14:10:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008357.html">[squid-users] Time for cache synchronization between siblings
</A></li>
        <LI>Next message (by thread): <A HREF="008374.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8369">[ date ]</a>
              <a href="thread.html#8369">[ thread ]</a>
              <a href="subject.html#8369">[ subject ]</a>
              <a href="author.html#8369">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for the tips. After disabling digest I believe performance improved.
However, I found that randomly requests were being routed to parent
even when siblings had the data cached.

&gt;<i>From access.log I found TIMEOUT_CARP. I assumed this meant HTCP timed
</I>out and squid was forced to go to fetch the data. So I increased
icp_query_timeout to 4000 milliseconds, and the hit rate increased
further.

But I still find that sometimes, even after getting a HIT response
from a sibling, squid, for some reason still decides to go to the
parent for requested object.

Are there any other reasons why squid will decide to go to parent servers?

And another question: When the hash key is computed for storing cache
objects, does Squid use the hostname(or IP address) also as part of
URL, or just the part that appears after the hostname/IP:port numbers?

For example: if ip address is squid servers is 10.135.85.2 and
10.135.85.3, and a request made to 1st server would have had the IP
address as part of the URL. However, next time same request is made to
server2, a different IP address would be used. Does this affect cache
hit at the sibling server?

I think it should not, but is this the case?

We will have a load balancer that sends requests to each squid server,
and we want cache peering to work correctly in this case.

thanks,
Sreenath


On 12/16/15, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 16/12/2015 7:16 a.m., Sreenath BH wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a setup with three squid peers (siblings in squid.conf) and
</I>&gt;&gt;<i> three upstream servers(peers with parent and originserver in
</I>&gt;&gt;<i> squid.conf).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am using htcp for the three squid siblings.
</I>&gt;&gt;<i> How much time does it take for one squid server to 'know' that another
</I>&gt;&gt;<i> peer has a particular object cached? I see digests exchanged between
</I>&gt;&gt;<i> the siblings, as logged in cache.log.
</I>&gt;<i>
</I>&gt;<i> When both HTCP an dDgests are active between siblings the maximum time
</I>&gt;<i> is however long it takes for the HTCP packet to reach the sibling, be
</I>&gt;<i> parsed, looked up in the cache and response to get back.
</I>&gt;<i>
</I>&gt;<i> Digests are used to short-circuit the ICP or HTCP process. If the digest
</I>&gt;<i> contains an entry for the URL the peer will be selected as a possible
</I>&gt;<i> destination server. Regardless of whether the object stored for that URL
</I>&gt;<i> is the same one the client is fetching.
</I>&gt;<i>
</I>&gt;<i> Digests are updated every digest_rebuild_period (default 1 hr). You can
</I>&gt;<i> disable digests with either &quot;digest_generation off&quot; or per-peer with the
</I>&gt;<i> cache_peer no-digest option.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have been able to make a request to one sibling and it resulted in a
</I>&gt;&gt;<i> sibling_hit.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How I do this test is this:
</I>&gt;&gt;<i> 1. bring up all siblings
</I>&gt;&gt;<i> 2. issue a request to one server (sibling 1)
</I>&gt;&gt;<i> 3. Make sure it is cached in sibling 1
</I>&gt;&gt;<i> 4. Wait for some time (I don't know how long to wait)
</I>&gt;<i>
</I>&gt;<i> Until the log of sibling1 contains a digest fetch from sibling2. A
</I>&gt;<i> restart of sibling2 will make that happen faster.
</I>&gt;<i>
</I>&gt;&gt;<i> 5. Make same request to another sibling, say sibling 2
</I>&gt;&gt;<i> 6. Check if it went to upstream server for the request or it was a sibling
</I>&gt;&gt;<i> hit.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My problem is that the sibling hits seem to be random. I am  not able
</I>&gt;&gt;<i> to figure out exactly
</I>&gt;&gt;<i> how log it takes for the cache information to propagate to all siblings.
</I>&gt;<i>
</I>&gt;<i> Digest is a old algorithm designed as an optimization of ICP, and
</I>&gt;<i> likewise is based on URL alone - which is great for HTTP/1.0 traffic. In
</I>&gt;<i> modern HTTP/1.1 traffic the Vary headers have a big part to play and
</I>&gt;<i> HTCP with full-header lookups works much better.
</I>&gt;<i>
</I>&gt;<i> I suggest trying with only HTCP (digests disabled) and see if your
</I>&gt;<i> performance improves at all. YMMV though.
</I>&gt;<i>
</I>&gt;<i> Be aware that there is no guarantee that any object is still in cache,
</I>&gt;<i> even with the more reliable HTCP on-demand lookups. Any object could be
</I>&gt;<i> dropped from sibling1 cache picoseconds after the &quot;i have it&quot; reply
</I>&gt;<i> started being formed for delivery to sibling2 (before it even hits the
</I>&gt;<i> wire on its way back).
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008357.html">[squid-users] Time for cache synchronization between siblings
</A></li>
	<LI>Next message (by thread): <A HREF="008374.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8369">[ date ]</a>
              <a href="thread.html#8369">[ thread ]</a>
              <a href="subject.html#8369">[ subject ]</a>
              <a href="author.html#8369">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
