<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [MASSMAIL] Squid: forward to another squid server with authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BMASSMAIL%5D%20Squid%3A%20forward%20to%20another%20squid%20server%0A%20with%20authentication&In-Reply-To=%3C5671AFAA.7080401%40uci.cu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008360.html">
   <LINK REL="Next"  HREF="008363.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [MASSMAIL] Squid: forward to another squid server with authentication</H1>
    <B>Amaury Viera Hern&#225;ndez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BMASSMAIL%5D%20Squid%3A%20forward%20to%20another%20squid%20server%0A%20with%20authentication&In-Reply-To=%3C5671AFAA.7080401%40uci.cu%3E"
       TITLE="[squid-users] [MASSMAIL] Squid: forward to another squid server with authentication">avhernandez at uci.cu
       </A><BR>
    <I>Wed Dec 16 18:38:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008360.html">[squid-users] Squid: forward to another squid server with authentication
</A></li>
        <LI>Next message (by thread): <A HREF="008363.html">[squid-users] Using cache_peer for transparent NTLM authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8372">[ date ]</a>
              <a href="thread.html#8372">[ thread ]</a>
              <a href="subject.html#8372">[ subject ]</a>
              <a href="author.html#8372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you. I will follow you instructions.

Amaury.
On 15/12/15 19:03, Amaury Viera Hern&#225;ndez wrote:
&gt;<i> Hello everyone. This is a more detailed explanation about my trouble:
</I>&gt;<i>
</I>&gt;<i> I have two network cards:
</I>&gt;<i>
</I>&gt;<i> a shared Wifi card(wlp2s0) : 10.42.0.1
</I>&gt;<i> a Network card with access to my LAN(enp4s0): 10.8.77.1
</I>&gt;<i>
</I>&gt;<i> In short, I am looking for a simple way to do the following (please give code samples if possible):
</I>&gt;<i>
</I>&gt;<i> Set up and start a transparent proxy server on my computer (wifi card, say that squid will listen at 10.42.0.1:3128) that can capture all web requests from my phone, once the http request from phone comes to this proxy, it will forward it to the university proxy (say address is 10.0.0.1:8080 with user and password authentication)
</I>&gt;<i>
</I>&gt;<i> Note: Is posible that one of the authentication methods of my proxy server will be ntlm
</I>&gt;<i>
</I>&gt;<i> Now, more details to fully explain my situation:
</I>&gt;<i>
</I>&gt;<i> In my university, authentication is needed to pass through a proxy so that we can connect to the internet. I normally enter my active directory username/password to authenticate when the pop up appears in the web browser
</I>&gt;<i>
</I>&gt;<i> Now, I want to connect my phone to my hared wifi(10.42.0.1) and using the network card with access to the lan(10.8.77.1), forward de http request of my phone to the proxy server in the university( 10.0.0.1:8080 with user and password authentication) because some application of my phone require a direct connection, without proxy and without proxy authentication. So, I am planning to set up a transparent proxy on my laptop to catch all requests from my phone. Of course, I don't need to use the proxy for local domains (uci.cu in this case)
</I>&gt;<i>
</I>&gt;<i> I'm using ubuntu 15.10 with squid3 (3.3.8)
</I>&gt;<i>
</I>&gt;<i> I have this configuration in squid.conf (This is very functional for local domain(without proxy authentications, against the local domains, for example: intranet.uci.cu, but for internet domains I need to authenticate(cache_peer my proxy with the proxy of my university)) )
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl localdst dstdomain
</I>&gt;<i> acl mi_red src 10.42.0.0/24
</I>&gt;<i> http_access allow mi_red
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 10.42.0.1:3128 transparent
</I>&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> cache_mem 512 MB
</I>&gt;<i> cache_dir ufs /var/spool/squid3 2048 16 256
</I>&gt;<i> cache_effective_user proxy
</I>&gt;<i> cache_effective_group proxy
</I>&gt;<i> half_closed_clients off
</I>&gt;<i> maximum_object_size 1024 KB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> memory_pools off
</I>&gt;<i> error_directory /usr/share/squid3/errors/es/
</I>&gt;<i> access_log /var/log/squid3/access.log squid
</I>&gt;<i> cache_peer 10.0.0.1 parent 8080 0 no-query default no-digest login=avhernandez:MyPass
</I>&gt;<i> never_direct allow all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'm using this firewall script
</I>&gt;<i>
</I>&gt;<i> #!/bin/sh
</I>&gt;<i> # IP del servidor SQUID
</I>&gt;<i> SQUID_SERVER=&quot;10.42.0.1&quot;
</I>&gt;<i> # Interface conectada a Internet
</I>&gt;<i> INTERNET=&quot;enp4s0&quot;
</I>&gt;<i> # Interface interna
</I>&gt;<i> LAN_IN=&quot;wlp2s0&quot;
</I>&gt;<i> # Puerto Squid
</I>&gt;<i> SQUID_PORT=&quot;3128&quot;
</I>&gt;<i>
</I>&gt;<i> # Limpia las reglas anteriores
</I>&gt;<i> iptables -F
</I>&gt;<i> iptables -X
</I>&gt;<i> iptables -t nat -F
</I>&gt;<i> iptables -t nat -X
</I>&gt;<i> iptables -t mangle -F
</I>&gt;<i> iptables -t mangle -X
</I>&gt;<i> # Carga los modulos IPTABLES para NAT e IP con soporte conntrack
</I>&gt;<i> modprobe ip_conntrack
</I>&gt;<i> modprobe ip_conntrack_ftp
</I>&gt;<i> echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</I>&gt;<i> # Politica de filtro por defecto
</I>&gt;<i> iptables -P INPUT DROP
</I>&gt;<i> iptables -P OUTPUT ACCEPT
</I>&gt;<i> # Acceso ilimitado a loop back
</I>&gt;<i> iptables -A INPUT -i lo -j ACCEPT
</I>&gt;<i> iptables -A OUTPUT -o lo -j ACCEPT
</I>&gt;<i> # Permite UDP, DNS y FTP pasivo
</I>&gt;<i> iptables -A INPUT -i $INTERNET -m state --state ESTABLISHED,RELATED -j ACCEPT
</I>&gt;<i> # Establece el servidor como router para la red
</I>&gt;<i> iptables --table nat --append POSTROUTING --out-interface $INTERNET -j MASQUERADE
</I>&gt;<i> iptables --append FORWARD --in-interface $LAN_IN -j ACCEPT
</I>&gt;<i> # acceso ilimiato a la LAN
</I>&gt;<i> iptables -A INPUT -i $LAN_IN -j ACCEPT
</I>&gt;<i> iptables -A OUTPUT -o $LAN_IN -j ACCEPT
</I>&gt;<i> # Redirige las peticiones de la red interna hacia el proxy
</I>&gt;<i> iptables -t nat -A PREROUTING -i $LAN_IN -p tcp --dport 80 -j DNAT --to $SQUID_SERVER:$SQUID_PORT
</I>&gt;<i> # Redirige la entrada al proxy
</I>&gt;<i> iptables -t nat -A PREROUTING -i $INTERNET -p tcp --dport 80 -j REDIRECT --to-port $SQUID_PORT
</I>&gt;<i>
</I>&gt;<i> Best regards. Amaury.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008360.html">[squid-users] Squid: forward to another squid server with authentication
</A></li>
	<LI>Next message (by thread): <A HREF="008363.html">[squid-users] Using cache_peer for transparent NTLM authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8372">[ date ]</a>
              <a href="thread.html#8372">[ thread ]</a>
              <a href="subject.html#8372">[ subject ]</a>
              <a href="author.html#8372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
