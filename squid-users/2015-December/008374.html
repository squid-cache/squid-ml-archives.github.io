<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Time for cache synchronization between siblings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3C5671CAF5.7010006%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008369.html">
   <LINK REL="Next"  HREF="008380.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Time for cache synchronization between siblings</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3C5671CAF5.7010006%40treenet.co.nz%3E"
       TITLE="[squid-users] Time for cache synchronization between siblings">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 16 20:35:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008369.html">[squid-users] Time for cache synchronization between siblings
</A></li>
        <LI>Next message (by thread): <A HREF="008380.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8374">[ date ]</a>
              <a href="thread.html#8374">[ thread ]</a>
              <a href="subject.html#8374">[ subject ]</a>
              <a href="author.html#8374">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/12/2015 3:10 a.m., Sreenath BH wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Thanks for the tips. After disabling digest I believe performance improved.
</I>&gt;<i> However, I found that randomly requests were being routed to parent
</I>&gt;<i> even when siblings had the data cached.
</I>&gt;<i> 
</I>&gt;<i> From access.log I found TIMEOUT_CARP. I assumed this meant HTCP timed
</I>&gt;<i> out and squid was forced to go to fetch the data. So I increased
</I>&gt;<i> icp_query_timeout to 4000 milliseconds, and the hit rate increased
</I>&gt;<i> further.
</I>&gt;<i> 
</I>&gt;<i> But I still find that sometimes, even after getting a HIT response
</I>&gt;<i> from a sibling, squid, for some reason still decides to go to the
</I>&gt;<i> parent for requested object.
</I>&gt;<i> 
</I>&gt;<i> Are there any other reasons why squid will decide to go to parent servers?
</I>
Just quirks of timing I think. Squid tracks response latency and prefers
the fastest source. If the parent is responding faster than the sibling
for man requests over a short period then Squid might switch to using
the parent as first choice for a


Some traffic is also classified as &quot;non-hierarchical&quot;. Meaning that it
makes no sense sending it to a sibling unless all parents are down.
Things such as CONNECT, OPTIONS, POST etc where the response is not
possible to be cached at the sibling.


&gt;<i> 
</I>&gt;<i> And another question: When the hash key is computed for storing cache
</I>&gt;<i> objects, does Squid use the hostname(or IP address) also as part of
</I>&gt;<i> URL, or just the part that appears after the hostname/IP:port numbers?
</I>
No. The primary Store ID/key is the absolute URL alone. Unless you are
using the Store-ID feature of Squid to change it to some other explicit
string value.

If the URL produces a reply object with Vary header, then the expansion
of the Vary header format is appended to the primary Store ID/key.

&gt;<i> 
</I>&gt;<i> For example: if ip address is squid servers is 10.135.85.2 and
</I>&gt;<i> 10.135.85.3, and a request made to 1st server would have had the IP
</I>&gt;<i> address as part of the URL. However, next time same request is made to
</I>&gt;<i> server2, a different IP address would be used. Does this affect cache
</I>&gt;<i> hit at the sibling server?
</I>&gt;<i> 
</I>&gt;<i> I think it should not, but is this the case?
</I>
Correct the Squid IP has nothing to do with the cache storage.

&gt;<i> 
</I>&gt;<i> We will have a load balancer that sends requests to each squid server,
</I>&gt;<i> and we want cache peering to work correctly in this case.
</I>
FYI; the digest and HTCP algorithms you are dealing with are already
load balancing algorithms. They are just designed for use in a flat
1-layer heirarchy.

If you intend to have a 2-layer heirarchy (frontend LB and backend
caches) I suggest you might want to look into Squid as the frontend LB
using CARP algorithm. The CARP algorithm ensures deterministic storage
locations for what URLs get sent to which caches. So there is no need
for siblings communication as they all get unique URLs.

 * &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster">http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster</A>&gt; has
details of how to split the frontend and backend config. The specific
example is for doing it using SMP workers within a single proxy
instance. But the split can even more easily be done across different
machines.

 * &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend">http://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend</A>&gt; has
some details on how to add iptables port splitting on top of CARP to get
ridiculously high performance out of a proxy heirarchy. The last numbers
I heard from these setups were pushing just under the Gbps mark.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008369.html">[squid-users] Time for cache synchronization between siblings
</A></li>
	<LI>Next message (by thread): <A HREF="008380.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8374">[ date ]</a>
              <a href="thread.html#8374">[ thread ]</a>
              <a href="subject.html#8374">[ subject ]</a>
              <a href="author.html#8374">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
