<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Time for cache synchronization between siblings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3CCALgKBSmUhrfK1Q%3DQ-R9QA3RGwJCtZVq3Wv5G2uDfP4oE0z%2BCbQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008374.html">
   <LINK REL="Next"  HREF="008383.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Time for cache synchronization between siblings</H1>
    <B>Sreenath BH</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3CCALgKBSmUhrfK1Q%3DQ-R9QA3RGwJCtZVq3Wv5G2uDfP4oE0z%2BCbQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Time for cache synchronization between siblings">bhsreenath at gmail.com
       </A><BR>
    <I>Thu Dec 17 12:21:28 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008374.html">[squid-users] Time for cache synchronization between siblings
</A></li>
        <LI>Next message (by thread): <A HREF="008383.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8380">[ date ]</a>
              <a href="thread.html#8380">[ thread ]</a>
              <a href="subject.html#8380">[ subject ]</a>
              <a href="author.html#8380">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for the detailed response. I really appreciate it.

Unfortunately the load balancer we use is not a squid load balancer
and for now I will have to use HTCP.

Please take a look at the following lines from access.log of one of
the three squid servers.
------------
1450351827.534      0 10.135.83.129 UDP_HIT/000 0 HTCP_TST
<A HREF="http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;">http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;</A>
- HIER_NONE/- -

1450351827.562     20 10.135.83.129 TCP_HIT/200 553852 GET
<A HREF="http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?">http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?</A>
- HIER_NONE/- video/mp2t

1450352028.731      0 10.135.83.128 UDP_MISS/000 0 HTCP_TST
<A HREF="http://10.135.83.128:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;">http://10.135.83.128:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;</A>
- HIER_NONE/- -
--------

The first line indicates a hit when queried by a peer. Note that the
IP address is 127.0.0.1.
It was a UDP HIT and it was followed by the actual request for the
cached object, which succeeded.

Now the third line indicates UDP query for same object, except that
URL has a different IP address, and the log says it was a MISS.

I don't know what I am doing wrong, but it consistently seems to treat
the IP address as part of the URL for purpose of HIT/MISS decision.

If all requests were made from a local client(say using curl running
locally on the machine) and using 127.0.0.1 as IP address, HTCP works
correctly.

Even without HTCP, just issuing same request from localhost and
another machine using a the externally visible IP address, squid does
not appear to use cached object. I am new to HTTP and think I must be
doing something wrong, but cant say what.

I wonder if ICP would have fared better since it uses just the URL.
Might that be a reason?

thanks,
Sreenath


On 12/17/15, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 17/12/2015 3:10 a.m., Sreenath BH wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for the tips. After disabling digest I believe performance
</I>&gt;&gt;<i> improved.
</I>&gt;&gt;<i> However, I found that randomly requests were being routed to parent
</I>&gt;&gt;<i> even when siblings had the data cached.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> From access.log I found TIMEOUT_CARP. I assumed this meant HTCP timed
</I>&gt;&gt;<i> out and squid was forced to go to fetch the data. So I increased
</I>&gt;&gt;<i> icp_query_timeout to 4000 milliseconds, and the hit rate increased
</I>&gt;&gt;<i> further.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I still find that sometimes, even after getting a HIT response
</I>&gt;&gt;<i> from a sibling, squid, for some reason still decides to go to the
</I>&gt;&gt;<i> parent for requested object.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Are there any other reasons why squid will decide to go to parent
</I>&gt;&gt;<i> servers?
</I>&gt;<i>
</I>&gt;<i> Just quirks of timing I think. Squid tracks response latency and prefers
</I>&gt;<i> the fastest source. If the parent is responding faster than the sibling
</I>&gt;<i> for man requests over a short period then Squid might switch to using
</I>&gt;<i> the parent as first choice for a
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Some traffic is also classified as &quot;non-hierarchical&quot;. Meaning that it
</I>&gt;<i> makes no sense sending it to a sibling unless all parents are down.
</I>&gt;<i> Things such as CONNECT, OPTIONS, POST etc where the response is not
</I>&gt;<i> possible to be cached at the sibling.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And another question: When the hash key is computed for storing cache
</I>&gt;&gt;<i> objects, does Squid use the hostname(or IP address) also as part of
</I>&gt;&gt;<i> URL, or just the part that appears after the hostname/IP:port numbers?
</I>&gt;<i>
</I>&gt;<i> No. The primary Store ID/key is the absolute URL alone. Unless you are
</I>&gt;<i> using the Store-ID feature of Squid to change it to some other explicit
</I>&gt;<i> string value.
</I>&gt;<i>
</I>&gt;<i> If the URL produces a reply object with Vary header, then the expansion
</I>&gt;<i> of the Vary header format is appended to the primary Store ID/key.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For example: if ip address is squid servers is 10.135.85.2 and
</I>&gt;&gt;<i> 10.135.85.3, and a request made to 1st server would have had the IP
</I>&gt;&gt;<i> address as part of the URL. However, next time same request is made to
</I>&gt;&gt;<i> server2, a different IP address would be used. Does this affect cache
</I>&gt;&gt;<i> hit at the sibling server?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think it should not, but is this the case?
</I>&gt;<i>
</I>&gt;<i> Correct the Squid IP has nothing to do with the cache storage.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We will have a load balancer that sends requests to each squid server,
</I>&gt;&gt;<i> and we want cache peering to work correctly in this case.
</I>&gt;<i>
</I>&gt;<i> FYI; the digest and HTCP algorithms you are dealing with are already
</I>&gt;<i> load balancing algorithms. They are just designed for use in a flat
</I>&gt;<i> 1-layer heirarchy.
</I>&gt;<i>
</I>&gt;<i> If you intend to have a 2-layer heirarchy (frontend LB and backend
</I>&gt;<i> caches) I suggest you might want to look into Squid as the frontend LB
</I>&gt;<i> using CARP algorithm. The CARP algorithm ensures deterministic storage
</I>&gt;<i> locations for what URLs get sent to which caches. So there is no need
</I>&gt;<i> for siblings communication as they all get unique URLs.
</I>&gt;<i>
</I>&gt;<i>  * &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster">http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster</A>&gt; has
</I>&gt;<i> details of how to split the frontend and backend config. The specific
</I>&gt;<i> example is for doing it using SMP workers within a single proxy
</I>&gt;<i> instance. But the split can even more easily be done across different
</I>&gt;<i> machines.
</I>&gt;<i>
</I>&gt;<i>  * &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend">http://wiki.squid-cache.org/ConfigExamples/ExtremeCarpFrontend</A>&gt; has
</I>&gt;<i> some details on how to add iptables port splitting on top of CARP to get
</I>&gt;<i> ridiculously high performance out of a proxy heirarchy. The last numbers
</I>&gt;<i> I heard from these setups were pushing just under the Gbps mark.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008374.html">[squid-users] Time for cache synchronization between siblings
</A></li>
	<LI>Next message (by thread): <A HREF="008383.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8380">[ date ]</a>
              <a href="thread.html#8380">[ thread ]</a>
              <a href="subject.html#8380">[ subject ]</a>
              <a href="author.html#8380">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
