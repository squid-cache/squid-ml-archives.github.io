<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Time for cache synchronization between siblings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3C567323D3.7030007%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008380.html">
   <LINK REL="Next"  HREF="008387.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Time for cache synchronization between siblings</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3C567323D3.7030007%40treenet.co.nz%3E"
       TITLE="[squid-users] Time for cache synchronization between siblings">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 17 21:06:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008380.html">[squid-users] Time for cache synchronization between siblings
</A></li>
        <LI>Next message (by thread): <A HREF="008387.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8383">[ date ]</a>
              <a href="thread.html#8383">[ thread ]</a>
              <a href="subject.html#8383">[ subject ]</a>
              <a href="author.html#8383">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/12/2015 1:21 a.m., Sreenath BH wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Thanks for the detailed response. I really appreciate it.
</I>&gt;<i> 
</I>&gt;<i> Unfortunately the load balancer we use is not a squid load balancer
</I>&gt;<i> and for now I will have to use HTCP.
</I>&gt;<i> 
</I>&gt;<i> Please take a look at the following lines from access.log of one of
</I>&gt;<i> the three squid servers.
</I>&gt;<i> ------------
</I>&gt;<i> 1450351827.534      0 10.135.83.129 UDP_HIT/000 0 HTCP_TST
</I>&gt;<i> <A HREF="http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;">http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;</A>
</I>&gt;<i> - HIER_NONE/- -
</I>&gt;<i> 
</I>&gt;<i> 1450351827.562     20 10.135.83.129 TCP_HIT/200 553852 GET
</I>&gt;<i> <A HREF="http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?">http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?</A>
</I>&gt;<i> - HIER_NONE/- video/mp2t
</I>&gt;<i> 
</I>&gt;<i> 1450352028.731      0 10.135.83.128 UDP_MISS/000 0 HTCP_TST
</I>&gt;<i> <A HREF="http://10.135.83.128:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;">http://10.135.83.128:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;</A>
</I>&gt;<i> - HIER_NONE/- -
</I>&gt;<i> --------
</I>&gt;<i> 
</I>&gt;<i> The first line indicates a hit when queried by a peer. Note that the
</I>&gt;<i> IP address is 127.0.0.1.
</I>&gt;<i> It was a UDP HIT and it was followed by the actual request for the
</I>&gt;<i> cached object, which succeeded.
</I>&gt;<i> 
</I>&gt;<i> Now the third line indicates UDP query for same object, except that
</I>&gt;<i> URL has a different IP address, and the log says it was a MISS.
</I>&gt;<i> 
</I>&gt;<i> I don't know what I am doing wrong, but it consistently seems to treat
</I>&gt;<i> the IP address as part of the URL for purpose of HIT/MISS decision.
</I>

Notice how the normal HTTP request (TCP_* line) is also using
&quot;127.0.0.1&quot; for origin server name.

This means the two HTCP requests really are for two very different URLs.
Completely different origin servers being contacted.


&gt;<i> 
</I>&gt;<i> If all requests were made from a local client(say using curl running
</I>&gt;<i> locally on the machine) and using 127.0.0.1 as IP address, HTCP works
</I>&gt;<i> correctly.
</I>
What is the output of &quot;squid -v&quot; ?

And beyond being a layer of caches behind a LB. What is the purpose of
this installation;
 reverse-proxy / CDN ?
 ISP forward/explicit proxy farm?
 Intranet gateway?
 some mix of the above?

and what is your full squid.conf ? (without comments and empty lines of
course).


What exactly are the clients (curl) requesting?
 from the Squid siblings directly? or through the LB?


&gt;<i> 
</I>&gt;<i> Even without HTCP, just issuing same request from localhost and
</I>&gt;<i> another machine using a the externally visible IP address, squid does
</I>&gt;<i> not appear to use cached object. I am new to HTTP and think I must be
</I>&gt;<i> doing something wrong, but cant say what.
</I>
Huh? Those log lines you posted above contradict. The first HTCP said
HIT and the TCP object fetch was served from the cache. The second said
MISS on the other URL, so no TCP fetch.

The sibling lookup and HTCP appears to be working perfectly correct.

&gt;<i> 
</I>&gt;<i> I wonder if ICP would have fared better since it uses just the URL.
</I>&gt;<i> Might that be a reason?
</I>
No. ICP always fares worse. It says UDP_HIT in a lot of cases where the
URL is same but the followup TCP fetch discovers HTTP mime headers
negotiating some variant object not in the sibling cache. So UDP_HIT
followed by TCP_MISS.
 That is almost the worst-case scenario: it causes a minimum of 2x proxy
processing latency delays on the whole transaction from the client
viewpoint. Unltimate worst-case is where a whole chain of parallel
siblings get relayed through due to UDP_MISS with N times the latency
multiplication.

At least with HTCP trying to fetch variants results in UDP_MISS. That is
the second-best *good* result.


That is all irrelevant to this case though. Since the raw-IP is part of
the URL, both of these siblings are working correctly.


Problem is why is the raw-IP with port 3128 part of the URL? It smells
like a miscnfiguration or bad design somewhere. The answers to my above
questions should help find the solution to that.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008380.html">[squid-users] Time for cache synchronization between siblings
</A></li>
	<LI>Next message (by thread): <A HREF="008387.html">[squid-users] Time for cache synchronization between siblings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8383">[ date ]</a>
              <a href="thread.html#8383">[ thread ]</a>
              <a href="subject.html#8383">[ subject ]</a>
              <a href="author.html#8383">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
