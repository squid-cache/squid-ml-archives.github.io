<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Time for cache synchronization between siblings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3CCALgKBSksKmLmxwXKDi5sMcZxj_OffiWs_VhBd%2BPEedaShfhAuA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008383.html">
   <LINK REL="Next"  HREF="008342.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Time for cache synchronization between siblings</H1>
    <B>Sreenath BH</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Time%20for%20cache%20synchronization%20between%20siblings&In-Reply-To=%3CCALgKBSksKmLmxwXKDi5sMcZxj_OffiWs_VhBd%2BPEedaShfhAuA%40mail.gmail.com%3E"
       TITLE="[squid-users] Time for cache synchronization between siblings">bhsreenath at gmail.com
       </A><BR>
    <I>Fri Dec 18 15:14:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008383.html">[squid-users] Time for cache synchronization between siblings
</A></li>
        <LI>Next message (by thread): <A HREF="008342.html">[squid-users] cant bump ssl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8387">[ date ]</a>
              <a href="thread.html#8387">[ thread ]</a>
              <a href="subject.html#8387">[ subject ]</a>
              <a href="author.html#8387">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

It was definitely ignorance of the tools on my part. I am using curl
for testing my setup.
I was using different URLs (different host/IP address as part of URL)
when issuing request to to Squid. That caused the problem I observed.

I read about Curl tool and found out that I can set Host header.
So when I set Host header to same value in all curl commands, cache
hits are happening as I was expecting it to. Access.log shows clearly
that the URLs are same.

So I can say that squid has solved our problem nicely.

A few words about our setup. Squid is used as a reverse caching proxy.

Our application serves video fragments. We use HLS (HTTP Live
streaming) where a given video is broken up into small fragments and
served on demand. Since transcoding to different formats and bit rates
is CPU intensive, we want to cache frequently accessed video
fragments.

Also, we use CARP to make sure that  requests for all fragments of a
given video file go to same backend webserver, because it would not
have do download the single large video file from backend server.

Thanks to this mailing list I have been able to successfully use squid.

rgds,
Sreenath


On 12/18/15, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 18/12/2015 1:21 a.m., Sreenath BH wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for the detailed response. I really appreciate it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Unfortunately the load balancer we use is not a squid load balancer
</I>&gt;&gt;<i> and for now I will have to use HTCP.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please take a look at the following lines from access.log of one of
</I>&gt;&gt;<i> the three squid servers.
</I>&gt;&gt;<i> ------------
</I>&gt;&gt;<i> 1450351827.534      0 10.135.83.129 UDP_HIT/000 0 HTCP_TST
</I>&gt;&gt;<i> <A HREF="http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;">http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;</A>
</I>&gt;&gt;<i> - HIER_NONE/- -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1450351827.562     20 10.135.83.129 TCP_HIT/200 553852 GET
</I>&gt;&gt;<i> <A HREF="http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?">http://127.0.0.1:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?</A>
</I>&gt;&gt;<i> - HIER_NONE/- video/mp2t
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1450352028.731      0 10.135.83.128 UDP_MISS/000 0 HTCP_TST
</I>&gt;&gt;<i> <A HREF="http://10.135.83.128:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;">http://10.135.83.128:3128/media/stream/video/NDo3ZDY1OTRjOS02NjM4LTQyNDMtOGMyNi0zYTc3YmI1MzI3ZjAubXA0?size=xs&amp;start=0.000&amp;end=5.930&amp;</A>
</I>&gt;&gt;<i> - HIER_NONE/- -
</I>&gt;&gt;<i> --------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The first line indicates a hit when queried by a peer. Note that the
</I>&gt;&gt;<i> IP address is 127.0.0.1.
</I>&gt;&gt;<i> It was a UDP HIT and it was followed by the actual request for the
</I>&gt;&gt;<i> cached object, which succeeded.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now the third line indicates UDP query for same object, except that
</I>&gt;&gt;<i> URL has a different IP address, and the log says it was a MISS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don't know what I am doing wrong, but it consistently seems to treat
</I>&gt;&gt;<i> the IP address as part of the URL for purpose of HIT/MISS decision.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Notice how the normal HTTP request (TCP_* line) is also using
</I>&gt;<i> &quot;127.0.0.1&quot; for origin server name.
</I>&gt;<i>
</I>&gt;<i> This means the two HTCP requests really are for two very different URLs.
</I>&gt;<i> Completely different origin servers being contacted.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If all requests were made from a local client(say using curl running
</I>&gt;&gt;<i> locally on the machine) and using 127.0.0.1 as IP address, HTCP works
</I>&gt;&gt;<i> correctly.
</I>&gt;<i>
</I>&gt;<i> What is the output of &quot;squid -v&quot; ?
</I>&gt;<i>
</I>&gt;<i> And beyond being a layer of caches behind a LB. What is the purpose of
</I>&gt;<i> this installation;
</I>&gt;<i>  reverse-proxy / CDN ?
</I>&gt;<i>  ISP forward/explicit proxy farm?
</I>&gt;<i>  Intranet gateway?
</I>&gt;<i>  some mix of the above?
</I>&gt;<i>
</I>&gt;<i> and what is your full squid.conf ? (without comments and empty lines of
</I>&gt;<i> course).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What exactly are the clients (curl) requesting?
</I>&gt;<i>  from the Squid siblings directly? or through the LB?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Even without HTCP, just issuing same request from localhost and
</I>&gt;&gt;<i> another machine using a the externally visible IP address, squid does
</I>&gt;&gt;<i> not appear to use cached object. I am new to HTTP and think I must be
</I>&gt;&gt;<i> doing something wrong, but cant say what.
</I>&gt;<i>
</I>&gt;<i> Huh? Those log lines you posted above contradict. The first HTCP said
</I>&gt;<i> HIT and the TCP object fetch was served from the cache. The second said
</I>&gt;<i> MISS on the other URL, so no TCP fetch.
</I>&gt;<i>
</I>&gt;<i> The sibling lookup and HTCP appears to be working perfectly correct.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I wonder if ICP would have fared better since it uses just the URL.
</I>&gt;&gt;<i> Might that be a reason?
</I>&gt;<i>
</I>&gt;<i> No. ICP always fares worse. It says UDP_HIT in a lot of cases where the
</I>&gt;<i> URL is same but the followup TCP fetch discovers HTTP mime headers
</I>&gt;<i> negotiating some variant object not in the sibling cache. So UDP_HIT
</I>&gt;<i> followed by TCP_MISS.
</I>&gt;<i>  That is almost the worst-case scenario: it causes a minimum of 2x proxy
</I>&gt;<i> processing latency delays on the whole transaction from the client
</I>&gt;<i> viewpoint. Unltimate worst-case is where a whole chain of parallel
</I>&gt;<i> siblings get relayed through due to UDP_MISS with N times the latency
</I>&gt;<i> multiplication.
</I>&gt;<i>
</I>&gt;<i> At least with HTCP trying to fetch variants results in UDP_MISS. That is
</I>&gt;<i> the second-best *good* result.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That is all irrelevant to this case though. Since the raw-IP is part of
</I>&gt;<i> the URL, both of these siblings are working correctly.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Problem is why is the raw-IP with port 3128 part of the URL? It smells
</I>&gt;<i> like a miscnfiguration or bad design somewhere. The answers to my above
</I>&gt;<i> questions should help find the solution to that.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008383.html">[squid-users] Time for cache synchronization between siblings
</A></li>
	<LI>Next message (by thread): <A HREF="008342.html">[squid-users] cant bump ssl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8387">[ date ]</a>
              <a href="thread.html#8387">[ thread ]</a>
              <a href="subject.html#8387">[ subject ]</a>
              <a href="author.html#8387">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
