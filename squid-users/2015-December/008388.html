<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSTP_DUPLEX_POST method
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSTP_DUPLEX_POST%20method&In-Reply-To=%3C56742AE6.6000809%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008377.html">
   <LINK REL="Next"  HREF="008327.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSTP_DUPLEX_POST method</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSTP_DUPLEX_POST%20method&In-Reply-To=%3C56742AE6.6000809%40treenet.co.nz%3E"
       TITLE="[squid-users] SSTP_DUPLEX_POST method">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec 18 15:48:54 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008377.html">[squid-users] SSTP_DUPLEX_POST method
</A></li>
        <LI>Next message (by thread): <A HREF="008327.html">[squid-users] squid url_rewrite_program for urls with parametes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8388">[ date ]</a>
              <a href="thread.html#8388">[ thread ]</a>
              <a href="subject.html#8388">[ subject ]</a>
              <a href="author.html#8388">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/12/2015 4:57 p.m., Wayne Gillan wrote:
&gt;<i> Yes SSTP is a type of SSL VPN. Why behind a reverse proxy? Well just like other SSL services I need to share port 443 with one public IP address.
</I>&gt;<i> 
</I>
Port 443 is not a generic SSL port. It is the registered port for HTTPS.
Any protocol using that port MUST be able to handle HTTP transformations


&gt;<i> I've run packet captures on the client, vpn server and squid. The request is getting through ok and the vpn server is sending a reply. But squid is not forwarding the reply to the client I believe. Here's some snippets of the squid log:
</I>&gt;<i> 
</I>&gt;<i> 2015/12/17 14:26:48.550| http.cc(762) processReplyHeader: HTTP Server REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200
</I>&gt;<i> Content-Length: 18446744073709551615
</I>&gt;<i> Server: Microsoft-HTTPAPI/2.0
</I>&gt;<i> Date: Thu, 17 Dec 2015 03:26:48 GMT
</I>&gt;<i> ----------
</I>&gt;<i> 2015/12/17 14:26:48.556| client_side.cc(1377) sendStartOfMessage: HTTP Client local=ip.of.squid:443 remote=1.2.3.4:44582 FD 9 flags=1
</I>&gt;<i> 2015/12/17 14:26:48.556| client_side.cc(1378) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Content-Length: 18446744073709551615
</I>&gt;<i> Server: Microsoft-HTTPAPI/2.0
</I>&gt;<i> Date: Thu, 17 Dec 2015 03:26:48 GMT
</I>&gt;<i> X-Cache: MISS from 
</I>&gt;<i> X-Cache-Lookup: MISS from :443
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> ----------
</I>
This is what Squid sent to the client.

&gt;<i> 2015/12/17 14:26:48.557| client_side_reply.cc(1114) storeNotOKTransferDone: storeNotOKTransferDone  out.size=240 expectedLength=-9223372036854775569
</I>
Note the very large negative number. That is a 64-bit wrap.

It is wrong for the application to be sending that value. It is claiming
that it has an object of size 18.4 Exabytes ready to send. What it
actually has is a non-HTTP tunnel, of *unknown* length.

Regardless, with 2^64 bytes of data object plus 240 bytes of headers
there is no way Squid can represent the message size. Let alone log it
properly if it ever completes. Squid should be detecting that and
producing a 5xx error.



&gt;<i> 2015/12/17 14:26:48.557| client_side.cc(1827) stopSending: sending error (local=ip.of.squid:443 remote=1.2.3.4:44582 FD 9 flags=1): STREAM_UNPLANNED_COMPLETE; old receiving error: none
</I>&gt;<i> 
</I>&gt;<i> 2015/12/17 14:26:48.673| Server.cc(362) sentRequestBody: sentRequestBody called
</I>&gt;<i> 2015/12/17 14:26:48.673| Server.cc(423) sendMoreRequestBody: will wait for more request body bytes or eof
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Seems like the large value of the Content-Length header field is causing issues. Squid waits for more data but the server never sends it because it's waiting for something from the client. 
</I>&gt;<i> 
</I>&gt;<i> Is there any way to make squid just pass traffic exactly as it comes in?
</I>
By the application using HTTP syntax properly. *Omitting* Content-Length
header on responses where there is no in-advance known object size.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008377.html">[squid-users] SSTP_DUPLEX_POST method
</A></li>
	<LI>Next message (by thread): <A HREF="008327.html">[squid-users] squid url_rewrite_program for urls with parametes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8388">[ date ]</a>
              <a href="thread.html#8388">[ thread ]</a>
              <a href="subject.html#8388">[ subject ]</a>
              <a href="author.html#8388">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
