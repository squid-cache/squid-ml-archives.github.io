<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] sslBump, squid in transparent mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%2C%20squid%20in%20transparent%20mode&In-Reply-To=%3C56818396.8080306%40norma.perm.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008491.html">
   <LINK REL="Next"  HREF="008493.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] sslBump, squid in transparent mode</H1>
    <B>Eugene M. Zheganin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%2C%20squid%20in%20transparent%20mode&In-Reply-To=%3C56818396.8080306%40norma.perm.ru%3E"
       TITLE="[squid-users] sslBump, squid in transparent mode">emz at norma.perm.ru
       </A><BR>
    <I>Mon Dec 28 18:46:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008491.html">[squid-users] Squid proxy whitelisting with HTTPS URL filtering
</A></li>
        <LI>Next message (by thread): <A HREF="008493.html">[squid-users] sslBump, squid in transparent mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8452">[ date ]</a>
              <a href="thread.html#8452">[ thread ]</a>
              <a href="subject.html#8452">[ subject ]</a>
              <a href="author.html#8452">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

I'm still trying to figure out why I get certificate generated for IP
address instead of hostname when the HTTPS traffic is intercepted bu
sllBump-enable squid. I'm using iptables to do this:

rdr on $iifs inet proto tcp from 192.168.0.0/16 to !&lt;rfc1918&gt; port 443
-&gt; 127.0.0.1 port 3131
rdr on vpn inet proto tcp from 192.168.0.0/16 to !&lt;rfc1918&gt; port 443 -&gt;
127.0.0.1 port 3131

and the port is configured as follows:

https_port 127.0.0.1:3131 intercept ssl-bump
cert=/usr/local/etc/squid/certs/squid.cert.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
dhparams=/usr/local/etc/squid/certs/dhparam.pem
https_port [::1]:3131 intercept ssl-bump
cert=/usr/local/etc/squid/certs/squid.cert.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
dhparams=/usr/local/etc/squid/certs/dhparam.pem

This way I'm getting a waring in browser (<A HREF="https://youtube.com">https://youtube.com</A> is opened
in the example below):

===Cut===
youtube.com uses an invalid security certificate.

The certificate is not trusted because the issuer certificate is unknown.
The server might not be sending the appropriate intermediate certificates.
An additional root certificate may need to be imported.
The certificate is only valid for 173.194.71.91

(Error code: sec_error_unknown_issuer)
===Cut===

And the tcpdump capture clearly shows that client browser did sent an SNI:

<A HREF="https://gyazo.com/c1ba348fb4ee56c6c30f3e22ff9877f8">https://gyazo.com/c1ba348fb4ee56c6c30f3e22ff9877f8</A>

I'll apreciate any help.

Thanks.
Eugene.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008491.html">[squid-users] Squid proxy whitelisting with HTTPS URL filtering
</A></li>
	<LI>Next message (by thread): <A HREF="008493.html">[squid-users] sslBump, squid in transparent mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8452">[ date ]</a>
              <a href="thread.html#8452">[ thread ]</a>
              <a href="subject.html#8452">[ subject ]</a>
              <a href="author.html#8452">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
