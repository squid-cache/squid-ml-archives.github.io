<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FW: [Samba]  Squid with NTLM auth behind netscaler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20%5BSamba%5D%20%20Squid%20with%20NTLM%20auth%20behind%20netscaler&In-Reply-To=%3Cvmime.56829bbf.20da.229b4e3222ab49e%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008502.html">
   <LINK REL="Next"  HREF="008470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FW: [Samba]  Squid with NTLM auth behind netscaler</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20%5BSamba%5D%20%20Squid%20with%20NTLM%20auth%20behind%20netscaler&In-Reply-To=%3Cvmime.56829bbf.20da.229b4e3222ab49e%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] FW: [Samba]  Squid with NTLM auth behind netscaler">belle at bazuin.nl
       </A><BR>
    <I>Tue Dec 29 14:42:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008502.html">[squid-users] squid3 / debian stable / please update to 3.4.14
</A></li>
        <LI>Next message (by thread): <A HREF="008470.html">[squid-users] squid reverse proxy and client certs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8465">[ date ]</a>
              <a href="thread.html#8465">[ thread ]</a>
              <a href="subject.html#8465">[ subject ]</a>
              <a href="author.html#8465">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai, 

&gt;<i> i read &quot;Do not use this method if you run winbindd or other samba 
</I>&gt;<i> services as samba will reset the machine password every x days and 
</I>&gt;<i> thereby makes the keytab invalid
</I>
Seems wrong to me. 

If you use samba 4. ( dont know if its the same for samba 3 ) 

Make sure you have this in smb.conf    

   dedicated keytab file = /etc/krb5.keytab
   kerberos method = secrets and keytab

   winbind refresh tickets = yes
   winbind offline logon = yes

refresh tickets refreshed the machine pass in the keytab. 
Offline logon is handy if you dc is down. 

Steps to follow

Install samba and join the domain. 
Check the SPNs of the hostname, if you missing things, add them. 
Remove /etc/krb5.keytab
Recreate it again ( now it has al the needed SPN's ) with : 
net ads keytab create -U administrator

restart samba. 

Now go configure squid. 


Greetz, 

Louis&gt; Louis
&gt;<i> 
</I>&gt;<i> &gt; -----Oorspronkelijk bericht-----
</I>&gt;<i> &gt; Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;<i> Namens
</I>&gt;<i> &gt; Fabio Bucci
</I>&gt;<i> &gt; Verzonden: dinsdag 29 december 2015 15:30
</I>&gt;<i> &gt; Aan: Amos Jeffries
</I>&gt;<i> &gt; CC: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; Onderwerp: Re: [squid-users] Squid with NTLM auth behind netscaler
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi Amos,
</I>&gt;<i> &gt; i'm trying to implement kerberos as you suggested me. But following
</I>&gt;<i> &gt; the guide i read &quot;Do not use this method if you run winbindd or other
</I>&gt;<i> &gt; samba services as samba will reset the machine password every x days
</I>&gt;<i> &gt; and thereby makes the keytab invalid !!&quot; and my system guy told me we
</I>&gt;<i> &gt; use winbindd method.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; How can i implement so?
</I>&gt;<i> &gt; Thanks
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2015-12-16 21:12 GMT+01:00 Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:
</I>&gt;<i> &gt; &gt; On 17/12/2015 5:34 a.m., Fabio Bucci wrote:
</I>&gt;<i> &gt; &gt;&gt; i'm planning to migrate to kerberos instead NTLM.....i got a question
</I>&gt;<i> &gt; for
</I>&gt;<i> &gt; &gt;&gt; you Amos: sometimes a client reports issue in navigation and
</I>&gt;<i> searching
</I>&gt;<i> &gt; into
</I>&gt;<i> &gt; &gt;&gt; log file i cannot see &quot;username&quot; and all the request are 407
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; In these cases is there a way to reset a user session or it's a
</I>&gt;<i> &gt; completely
</I>&gt;<i> &gt; &gt;&gt; client issue?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Usually it is the client stuck in a loop trying Negtiate/NTLM auth for
</I>&gt;<i> &gt; &gt; some reason. Some old Firefox, most Safari, and older IE can all get
</I>&gt;<i> &gt; &gt; stuck trying those credentials and ignoring the offers of Basic.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It might be possible to figure out some LmCompatibility settings
</I>&gt;<i> change
</I>&gt;<i> &gt; &gt; that makes the problem just go away (eg, forcing NTLM of all versions
</I>&gt;<i> to
</I>&gt;<i> &gt; &gt; disabled on the client).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Other than that Squid does have some workaround responses it can be
</I>&gt;<i> made
</I>&gt;<i> &gt; &gt; to send back that might help the client reach the right conclusion:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; a) list Basic auth first in the config. Any properly working client
</I>&gt;<i> will
</I>&gt;<i> &gt; &gt; re-sort the auth types by security level and do theKerberos anyway.
</I>&gt;<i> But
</I>&gt;<i> &gt; &gt; the broken ones (particularly IE7 and older) will have more chance of
</I>&gt;<i> &gt; &gt; using Basic.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; b) sending 407 response with no auth headers. Such as a deny 407
</I>&gt;<i> status
</I>&gt;<i> &gt; &gt; generated by external ACL deny, or a URL-redirector. These tell the
</I>&gt;<i> &gt; &gt; client that auth failed, but there is no acceptible fallback.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; c) sending Connection:close. Sometimes (mostly Firefox v20-v40) it is
</I>&gt;<i> &gt; &gt; the client prematurely attaching the credentials to the connection and
</I>&gt;<i> &gt; &gt; re-using them. That is supposed to have been fixed recently, but I've
</I>&gt;<i> &gt; &gt; not confirmed.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; d) sending 403 status response. To just flat-out block the client once
</I>&gt;<i> &gt; &gt; it enters the looping state. Hoping that later requests will start to
</I>&gt;<i> &gt; &gt; work again.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; HTH
</I>&gt;<i> &gt; &gt; Amos
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> To unsubscribe from this list go to the following URL and read the
</I>&gt;<i> instructions:  <A HREF="https://lists.samba.org/mailman/options/samba">https://lists.samba.org/mailman/options/samba</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008502.html">[squid-users] squid3 / debian stable / please update to 3.4.14
</A></li>
	<LI>Next message (by thread): <A HREF="008470.html">[squid-users] squid reverse proxy and client certs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8465">[ date ]</a>
              <a href="thread.html#8465">[ thread ]</a>
              <a href="subject.html#8465">[ subject ]</a>
              <a href="author.html#8465">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
