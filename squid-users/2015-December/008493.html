<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] sslBump, squid in transparent mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%2C%20squid%20in%20transparent%20mode&In-Reply-To=%3C896d6caeb93606377c5b7a96ef527f2b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008452.html">
   <LINK REL="Next"  HREF="008453.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] sslBump, squid in transparent mode</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%2C%20squid%20in%20transparent%20mode&In-Reply-To=%3C896d6caeb93606377c5b7a96ef527f2b%40treenet.co.nz%3E"
       TITLE="[squid-users] sslBump, squid in transparent mode">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 31 09:03:59 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008452.html">[squid-users] sslBump, squid in transparent mode
</A></li>
        <LI>Next message (by thread): <A HREF="008453.html">[squid-users] sslBump adventures in enterprise production environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8493">[ date ]</a>
              <a href="thread.html#8493">[ thread ]</a>
              <a href="subject.html#8493">[ subject ]</a>
              <a href="author.html#8493">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2015-12-29 07:46, Eugene M. Zheganin wrote:
&gt;<i> Hi.
</I>&gt;<i> 
</I>&gt;<i> I'm still trying to figure out why I get certificate generated for IP
</I>&gt;<i> address instead of hostname when the HTTPS traffic is intercepted bu
</I>&gt;<i> sllBump-enable squid. I'm using iptables to do this:
</I>&gt;<i> 
</I>&gt;<i> rdr on $iifs inet proto tcp from 192.168.0.0/16 to !&lt;rfc1918&gt; port 443
</I>&gt;<i> -&gt; 127.0.0.1 port 3131
</I>&gt;<i> rdr on vpn inet proto tcp from 192.168.0.0/16 to !&lt;rfc1918&gt; port 443 -&gt;
</I>&gt;<i> 127.0.0.1 port 3131
</I>&gt;<i> 
</I>&gt;<i> and the port is configured as follows:
</I>&gt;<i> 
</I>&gt;<i> https_port 127.0.0.1:3131 intercept ssl-bump
</I>&gt;<i> cert=/usr/local/etc/squid/certs/squid.cert.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> dhparams=/usr/local/etc/squid/certs/dhparam.pem
</I>&gt;<i> https_port [::1]:3131 intercept ssl-bump
</I>&gt;<i> cert=/usr/local/etc/squid/certs/squid.cert.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> dhparams=/usr/local/etc/squid/certs/dhparam.pem
</I>&gt;<i> 
</I>&gt;<i> This way I'm getting a waring in browser (<A HREF="https://youtube.com">https://youtube.com</A> is opened
</I>&gt;<i> in the example below):
</I>&gt;<i> 
</I>&gt;<i> ===Cut===
</I>&gt;<i> youtube.com uses an invalid security certificate.
</I>&gt;<i> 
</I>&gt;<i> The certificate is not trusted because the issuer certificate is 
</I>&gt;<i> unknown.
</I>&gt;<i> The server might not be sending the appropriate intermediate 
</I>&gt;<i> certificates.
</I>&gt;<i> An additional root certificate may need to be imported.
</I>&gt;<i> The certificate is only valid for 173.194.71.91
</I>&gt;<i> 
</I>&gt;<i> (Error code: sec_error_unknown_issuer)
</I>&gt;<i> ===Cut===
</I>&gt;<i> 
</I>&gt;<i> And the tcpdump capture clearly shows that client browser did sent an 
</I>&gt;<i> SNI:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://gyazo.com/c1ba348fb4ee56c6c30f3e22ff9877f8">https://gyazo.com/c1ba348fb4ee56c6c30f3e22ff9877f8</A>
</I>&gt;<i> 
</I>&gt;<i> I'll apreciate any help.
</I>
You have ssl_bump rules doing a peek as well?
SNI is not known until/unless after a peek action takes place at step 1.

If your Squid is so old it does not support peek, then it also does not 
support SNI.

If you are bumping, or splicing, or terminating at stage 1 of the 
ssl-bump process then peek is not happening and the SNI is not 
available.

If you are peeking at step1 and the peek is succeeding (not doing a 
splice failure recovery) then it is likely a bug.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008452.html">[squid-users] sslBump, squid in transparent mode
</A></li>
	<LI>Next message (by thread): <A HREF="008453.html">[squid-users] sslBump adventures in enterprise production environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8493">[ date ]</a>
              <a href="thread.html#8493">[ thread ]</a>
              <a href="subject.html#8493">[ subject ]</a>
              <a href="author.html#8493">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
