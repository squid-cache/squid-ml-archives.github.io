<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-bump%20certificate%20issues%20%28mostly%20on%20Chrome%2C%0A%20when%20accessing%20Google%20websites%29&In-Reply-To=%3C54D475AE.9070300%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001951.html">
   <LINK REL="Next"  HREF="001958.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-bump%20certificate%20issues%20%28mostly%20on%20Chrome%2C%0A%20when%20accessing%20Google%20websites%29&In-Reply-To=%3C54D475AE.9070300%40gmail.com%3E"
       TITLE="[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)">yvoinov at gmail.com
       </A><BR>
    <I>Fri Feb  6 08:05:02 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001951.html">[squid-users] SSL-bump certificate issues (mostly on Chrome,	when accessing Google websites)
</A></li>
        <LI>Next message (by thread): <A HREF="001958.html">[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1955">[ date ]</a>
              <a href="thread.html#1955">[ thread ]</a>
              <a href="subject.html#1955">[ subject ]</a>
              <a href="author.html#1955">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1
 
First. Where is you cache can found openssl public CA certs? To validate
connection from cache to server Squid must see root authority CA's.

I.e (from my configuration. Note: all google services bumped and works
perfectly):

https_port 3129 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt
key=/usr/local/squid/etc/rootCA.key capath=/etc/opt/csw/ssl/certs

Second. OpenSSL CA's bundle is not complete. You must add ALL
intermediate and absent root CA's and make c_rehash.

Third.
Where is

sslproxy_cert_error allow all

and

sslproxy_flags DONT_VERIFY_PEER

in your configuration? Yes, this is dangerous, but permit to suppress
errors on some sites.

And finally - you can't bypass ssl bump on 3.4.x using dstdomain ACL's.
Only IP-based DST acl's usable.

Regards,
Yuri.

06.02.2015 11:10, Luis Miguel Silva &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Dear all,
</I>&gt;<i>
</I>&gt;<i> I recently compiled squid-3.4.9 with ssl-bump support and, although it
</I>is working for the most part, I'm having some issues accessing some
websites.
&gt;<i>
</I>&gt;<i> The behavior is REALLY weird so I'm going to try and describe it the
</I>best I can:
&gt;<i> - If i access <A HREF="https://www.google.com/">https://www.google.com/</A> in Chrome, I could see that it
</I>was processing my certificate MOST of the times...
&gt;<i> *screenshot here*: <A HREF="http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg">http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg</A>
</I>&gt;<i> - some other times, it seemed to bypass my proxy altogether and I
</I>finally figured out it was because Chrome will try to access QUIC
enabled websites using that protocol, so it would bypass my firewall
redirect rules! I believe I now have solved this by blocking FORWARDING
traffic on port 443 udp...
&gt;<i> - the weird thing is that, if I then try and access <A HREF="https://gmail.com">https://gmail.com</A>
</I>&lt;<A HREF="https://gmail.com/">https://gmail.com/</A>&gt;, I get a certificate error:
&gt;<i> *screenshot here*: <A HREF="http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#1">http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#1</A>
</I>&gt;<i> - ...though, sometimes, I can access <A HREF="https://mail.gmail.com/">https://mail.gmail.com/</A> just fine
</I>(without any certificate errors), but stop being able to as soon as I
try to access <A HREF="https://gmail.com/">https://gmail.com/</A> and the browser complains about the
certificate.
&gt;<i> -- and, according to my tests, I can access it from firefox just fine
</I>MOST of the times:
&gt;<i> *screenshot here*: <A HREF="http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#2">http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#2</A>
</I>&gt;<i> -- though I have also seen situations where Firefox also complains
</I>about a certificate error when connecting to gmail.com &lt;<A HREF="http://gmail.com/">http://gmail.com/</A>&gt;
&gt;<i> - and, although I cannot reproduce it 100% of the times, sometimes,
</I>even though I have my iptables redirect rules ON, the browser still
seems to &quot;connect direct&quot; (or, at least, it shows it has the original
certificate)!
&gt;<i> -- like I said, at first, I was able to trace this back to QUIC in
</I>Chrome but...I'm currently blocking traffic on port 443 udp so I don't
know what's happening here (does it use different ports?!)
&gt;<i> 
</I>&gt;<i> So, here are *my questions*:
</I>&gt;<i> - why am I able to successfully ssl-bump <A HREF="https://www.google.com">https://www.google.com</A>
</I>&lt;<A HREF="https://www.google.com/">https://www.google.com/</A>&gt; but not <A HREF="https://gmail.com/">https://gmail.com/</A>
&gt;<i> - why does the Chrome freakout about gmail but not Firefox?
</I>&gt;<i> - Is there a way to fix it OR, at least, to bypass it? (I tried
</I>creating an ACL for this and allowing direct traffic but it didn't seem
to work...)
&gt;<i> -- can we make the connection go direct when ssl certificate errors
</I>are detected?
&gt;<i> - and has anyone else seen this problem where the browser seems to use
</I>the original certificate, even though I'm redirecting traffic to Squid?
&gt;<i>
</I>&gt;<i> Not sure if this is relevant, but here are some ssl errors I caught on
</I>my cache.log file:
&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/var/log/squid3# tail cache.log
</I>&gt;<i> 2015/02/05 21:47:52 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 30: Closed by client
&gt;<i> 2015/02/05 21:48:23 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 30: Closed by client
&gt;<i> 2015/02/05 21:48:36 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 96: error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1
alert unknown ca (1/0)
&gt;<i> 2015/02/05 21:48:54 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 105: Closed by client
&gt;<i> 2015/02/05 21:49:15 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 79: Broken pipe (32)
&gt;<i> 2015/02/05 21:49:15 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 54: Broken pipe (32)
&gt;<i> 2015/02/05 21:49:24 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 79: Closed by client
&gt;<i> 2015/02/05 21:49:55 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 26: Closed by client
&gt;<i> 2015/02/05 21:50:26 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 45: Closed by client
&gt;<i> 2015/02/05 21:50:56 kid1| clientNegotiateSSL: Error negotiating SSL
</I>connection on FD 68: Closed by client
&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/var/log/squid3#
</I>&gt;<i>
</I>&gt;<i> By the way, here's how I generated my certificate:
</I>&gt;<i> openssl req -new -newkey rsa:1024 -days 365 -nodes -x509 -keyout
</I>myCA.pem -out myCA.pem
&gt;<i> openssl x509 -in myCA.pem -outform DER -out certificate.der
</I>&gt;<i> (note: myCA.pem is the certificate that squid is using and
</I>certificate.der is the one I've been installing on the client computers)
&gt;<i>
</I>&gt;<i> And here's what my current squid.conf looks like:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/etc/squid3/ssl_cert# cat /etc/squid3/squid.conf
</I>&gt;<i> #Access Lists
</I>&gt;<i> acl home_network src 192.168.200.0/24 &lt;<A HREF="http://192.168.200.0/24">http://192.168.200.0/24</A>&gt;
</I>&gt;<i>
</I>&gt;<i> #Ports allowed through Squid
</I>&gt;<i> acl Safe_ports port 80 #http
</I>&gt;<i> acl Safe_ports port 443 #https
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL method CONNECT
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> #allow/deny
</I>&gt;<i> http_access allow home_network
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/myCA.pem
&gt;<i> acl broken_sites dstdomain .gmail.com &lt;<A HREF="http://gmail.com/">http://gmail.com/</A>&gt;
</I>&gt;<i> ssl_bump none localhost
</I>&gt;<i> ssl_bump none broken_sites
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i> sslcrtd_program /usr/lib/squid3/ssl_crtd -s
</I>/usr/share/squid3/var/lib/ssl_db -M 4MB
&gt;<i> sslcrtd_children 5
</I>&gt;<i>
</I>&gt;<i> #caching directory
</I>&gt;<i> cache_dir ufs /var/spool/squid3 1024 16 128
</I>&gt;<i> cache_mem 1024 MB
</I>&gt;<i>
</I>&gt;<i> #refresh patterns for caching static files
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 10080 90% 43200
</I>override-expire ignore-no-cache ignore-no-store ignore-private
&gt;<i> refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 43200
</I>90% 432000 override-expire ignore-no-cache ignore-no-store ignore-private
&gt;<i> refresh_pattern -i
</I>\.(deb|rpm|exe|zip|tar|tgz|ram|rar|bin|ppt|doc|tiff)$ 10080 90% 43200
override-expire ignore-no-cache ignore-no-store ignore-private
&gt;<i> refresh_pattern -i \.index.(html|htm)$ 0 40% 10080
</I>&gt;<i> refresh_pattern -i \.(html|htm|css|js)$ 1440 40% 40320
</I>&gt;<i> refresh_pattern . 0 40% 40320
</I>&gt;<i>
</I>&gt;<i> dns_nameservers 8.8.8.8
</I>&gt;<i>
</I>&gt;<i> #rewrite program
</I>&gt;<i> redirect_program /etc/squid3/filter.php
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/etc/squid3/ssl_cert#
</I>&gt;<i>
</I>&gt;<i> Thanks in advance,
</I>&gt;<i> Luis
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBAgAGBQJU1HWtAAoJENNXIZxhPexGiRcH/A2QfRyPsmM9LhKR6ZuqTfhR
AWyg8omvGOeKwo5W0Czb/Qqo4XhtIe+jcXxFqmrvL+zxmrl66tRXp0mBDmp1FMPW
kC93hIYn72NZiThPmchqOZ/4IuUNOyJT1ll/Uef7Kr/saIF0zXMh2lkoNR5HCvhN
0nb3dW0QSSivASYB3/0Mm0szCQqLSx/zgIbdCvmlX9H3VwWM/uE88Nfp+CAHygIO
t5vioJbCTPjyFqV2QkX//fuU1ePZC1VrTw5//nMjXfCbpXjLZtgz15ubDcCH3vZ1
beMYpGYbvHUk+hxrwjW394Q+pSAso79x5hwUO3PlZAsKUx/RdhzI91VVRRO9mfE=
=N+mL
-----END PGP SIGNATURE-----

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150206/9e643d8a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150206/9e643d8a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001951.html">[squid-users] SSL-bump certificate issues (mostly on Chrome,	when accessing Google websites)
</A></li>
	<LI>Next message (by thread): <A HREF="001958.html">[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1955">[ date ]</a>
              <a href="thread.html#1955">[ thread ]</a>
              <a href="subject.html#1955">[ subject ]</a>
              <a href="author.html#1955">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
