<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-bump%20certificate%20issues%20%28mostly%20on%20Chrome%2C%0A%20when%20accessing%20Google%20websites%29&In-Reply-To=%3C54D47C10.7020402%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001955.html">
   <LINK REL="Next"  HREF="001964.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-bump%20certificate%20issues%20%28mostly%20on%20Chrome%2C%0A%20when%20accessing%20Google%20websites%29&In-Reply-To=%3C54D47C10.7020402%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb  6 08:32:16 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001955.html">[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
</A></li>
        <LI>Next message (by thread): <A HREF="001964.html">[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1958">[ date ]</a>
              <a href="thread.html#1958">[ thread ]</a>
              <a href="subject.html#1958">[ subject ]</a>
              <a href="author.html#1958">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/02/2015 6:10 p.m., Luis Miguel Silva wrote:
&gt;<i> Dear all,
</I>&gt;<i> 
</I>&gt;<i> I recently compiled squid-3.4.9 with ssl-bump support and, although it is
</I>&gt;<i> working for the most part, I'm having some issues accessing some websites.
</I>&gt;<i> 
</I>&gt;<i> The behavior is REALLY weird so I'm going to try and describe it the best I
</I>&gt;<i> can:
</I>&gt;<i> - If i access <A HREF="https://www.google.com/">https://www.google.com/</A> in Chrome, I could see that it was
</I>&gt;<i> processing my certificate MOST of the times...
</I>&gt;<i> *screenshot here*: <A HREF="http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg">http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg</A>
</I>&gt;<i> - some other times, it seemed to bypass my proxy altogether and I finally
</I>&gt;<i> figured out it was because Chrome will try to access QUIC enabled websites
</I>&gt;<i> using that protocol, so it would bypass my firewall redirect rules! I
</I>&gt;<i> believe I now have solved this by blocking FORWARDING traffic on port 443
</I>&gt;<i> udp...
</I>
reply_header_access Alternate-Protocol deny all

This was added by default in 3.5. Your report now is the final straw for
me I'm backporting it to 3.4 now for adding in the next security release.

NOTE that this firewall bypass behaviour it seems does not qualify for a
CVE security rating because it is an intentional *designed* behaviour of
Chrome using a designed feature of HTTP.



&gt;<i> - the weird thing is that, if I then try and access <A HREF="https://gmail.com,">https://gmail.com,</A> I
</I>&gt;<i> get a certificate error:
</I>&gt;<i> *screenshot here*: <A HREF="http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#1">http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#1</A>
</I>
Because with HTTPS traffic to a proxy the proxy sets up the tunnel using
a) CONNECT request, or b) intercepted port 443 - in both cases
encryption handling happens before any server response message with QUIC
headers gets involved.


&gt;<i> - ...though, sometimes, I can access <A HREF="https://mail.gmail.com/">https://mail.gmail.com/</A> just fine
</I>&gt;<i> (without any certificate errors), but stop being able to as soon as I try
</I>&gt;<i> to access <A HREF="https://gmail.com/">https://gmail.com/</A> and the browser complains about the
</I>&gt;<i> certificate.
</I>
The google TLS certificate I've read were issued with the CN label
&quot;mail.google.com&quot; plus wildcard for other G* domains. This might be
related to that behaviour if the main CN is mimic'd but the wildcards not.


&gt;<i> -- and, according to my tests, I can access it from firefox just fine MOST
</I>&gt;<i> of the times:
</I>&gt;<i> *screenshot here*: <A HREF="http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#2">http://imgur.com/JsNiqDL,Ned5zAU,nJjRPtg#2</A>
</I>&gt;<i> -- though I have also seen situations where Firefox also complains about a
</I>&gt;<i> certificate error when connecting to gmail.com
</I>&gt;<i> - and, although I cannot reproduce it 100% of the times, sometimes, even
</I>&gt;<i> though I have my iptables redirect rules ON, the browser still seems to
</I>&gt;<i> &quot;connect direct&quot; (or, at least, it shows it has the original certificate)!
</I>&gt;<i> -- like I said, at first, I was able to trace this back to QUIC in Chrome
</I>&gt;<i> but...I'm currently blocking traffic on port 443 udp so I don't know what's
</I>&gt;<i> happening here (does it use different ports?!)
</I>
Very possible. Since the port is delivered in the Alternate-Protocol
header they can change it anytime. I've see both ports 80 and 443 in
use. Blocking the reply header is the way to be most sure of disabling.


&gt;<i> 
</I>&gt;<i> So, here are *my questions*:
</I>&gt;<i> - why am I able to successfully ssl-bump <A HREF="https://www.google.com">https://www.google.com</A> but not
</I>&gt;<i> <A HREF="https://gmail.com/">https://gmail.com/</A>
</I>&gt;<i> - why does the Chrome freakout about gmail but not Firefox?
</I>
Many reasons. I point at HSTS - which is a collection of certificate
management methods and protocol bits they use to perform things like
cert pinning, side channel verification, etc.

At the base of it TLS was designed from the ground up to be a security
protocol that prevented anybody from hijacking it (like SSL-bump does),
or at least shout loudly to the endpoints if someone does. Only terribly
bad mis-use or security flaws in the protocol allow things like SSL-Bump
to work in the first place. You all have just been lucky so far that so
the Trusted CA system is a big flaw and mis-use of the protocol is rampant.

Google and friends are fighting to fix those flaws. Whenever they
succeed at closing one flaw the hjacking using it &quot;stops working&quot;.


&gt;<i> - Is there a way to fix it OR, at least, to bypass it? (I tried creating an
</I>&gt;<i> ACL for this and allowing direct traffic but it didn't seem to work...)
</I>&gt;<i> -- can we make the connection go direct when ssl certificate errors are
</I>&gt;<i> detected?
</I>
Lets be clear; *you* are the brokenness here, *you* are the attacker.

 ... when SSL-Bump &quot;dont work&quot; it means the security *is* working.

What you are looking for is not a &quot;fix&quot;. It is another security flaw so
you can break their now-improved encryption again.

That should tell you what the answer is.


&gt;<i> - and has anyone else seen this problem where the browser seems to use the
</I>&gt;<i> original certificate, even though I'm redirecting traffic to Squid?
</I>&gt;<i> 
</I>&gt;<i> Not sure if this is relevant, but here are some ssl errors I caught on my
</I>&gt;<i> cache.log file:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/var/log/squid3# tail cache.log
</I>&gt;<i> 2015/02/05 21:47:52 kid1| clientNegotiateSSL: Error negotiating SSL
</I>&gt;<i> connection on FD 30: Closed by client
</I>&gt;<i> 2015/02/05 21:48:36 kid1| clientNegotiateSSL: Error negotiating SSL
</I>&gt;<i> connection on FD 96: error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1
</I>&gt;<i> alert unknown ca (1/0)
</I>
&gt;<i> By the way, here's how I generated my certificate:
</I>&gt;<i> openssl req -new -newkey rsa:1024 -days 365 -nodes -x509 -keyout myCA.pem
</I>&gt;<i> -out myCA.pem
</I>&gt;<i> openssl x509 -in myCA.pem -outform DER -out certificate.der
</I>&gt;<i> (note: myCA.pem is the certificate that squid is using and certificate.der
</I>&gt;<i> is the one I've been installing on the client computers)
</I>&gt;<i> 
</I>&gt;<i> And here's what my current squid.conf looks like:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/etc/squid3/ssl_cert# cat /etc/squid3/squid.conf
</I>&gt;<i> #Access Lists
</I>&gt;<i> acl home_network src 192.168.200.0/24
</I>&gt;<i> 
</I>&gt;<i> #Ports allowed through Squid
</I>&gt;<i> acl Safe_ports port 80 #http
</I>&gt;<i> acl Safe_ports port 443 #https
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL method CONNECT
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #allow/deny
</I>&gt;<i> http_access allow home_network
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
Them security controls are not doing much. Its for very good reaons that
we publish this particular order with a big notice about where to put
your access policy rules:

  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports

  ## PUT YOUR STUFF HERE
  http_access allow home_network

  http_access deny all

&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/myCA.pem
</I>&gt;<i> acl broken_sites dstdomain .gmail.com
</I>&gt;<i> ssl_bump none localhost
</I>&gt;<i> ssl_bump none broken_sites
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i> sslcrtd_program /usr/lib/squid3/ssl_crtd -s
</I>&gt;<i> /usr/share/squid3/var/lib/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> 
</I>&gt;<i> #caching directory
</I>&gt;<i> cache_dir ufs /var/spool/squid3 1024 16 128
</I>&gt;<i> cache_mem 1024 MB
</I>&gt;<i> 
</I>&gt;<i> #refresh patterns for caching static files
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 10080 90% 43200
</I>&gt;<i> override-expire ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 43200 90%
</I>&gt;<i> 432000 override-expire ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.(deb|rpm|exe|zip|tar|tgz|ram|rar|bin|ppt|doc|tiff)$
</I>&gt;<i> 10080 90% 43200 override-expire ignore-no-cache ignore-no-store
</I>&gt;<i> ignore-private
</I>&gt;<i> refresh_pattern -i \.index.(html|htm)$ 0 40% 10080
</I>&gt;<i> refresh_pattern -i \.(html|htm|css|js)$ 1440 40% 40320
</I>&gt;<i> refresh_pattern . 0 40% 40320
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 8.8.8.8
</I>&gt;<i> 
</I>&gt;<i> #rewrite program
</I>&gt;<i> redirect_program /etc/squid3/filter.php
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A>:/etc/squid3/ssl_cert#
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance,
</I>&gt;<i> Luis
</I>&gt;<i> 
</I>
HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001955.html">[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
</A></li>
	<LI>Next message (by thread): <A HREF="001964.html">[squid-users] SSL-bump certificate issues (mostly on Chrome, when accessing Google websites)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1958">[ date ]</a>
              <a href="thread.html#1958">[ thread ]</a>
              <a href="subject.html#1958">[ subject ]</a>
              <a href="author.html#1958">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
