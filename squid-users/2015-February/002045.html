<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.1 NTLM and LDAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.1%20NTLM%20and%20LDAP&In-Reply-To=%3C54DA6255.5070502%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002034.html">
   <LINK REL="Next"  HREF="002100.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.1 NTLM and LDAP</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.1%20NTLM%20and%20LDAP&In-Reply-To=%3C54DA6255.5070502%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.1 NTLM and LDAP">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Feb 10 19:56:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002034.html">[squid-users] Squid 3.5.1 NTLM and LDAP
</A></li>
        <LI>Next message (by thread): <A HREF="002100.html">[squid-users] Squid 3.5.1 NTLM and LDAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2045">[ date ]</a>
              <a href="thread.html#2045">[ thread ]</a>
              <a href="subject.html#2045">[ subject ]</a>
              <a href="author.html#2045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/02/2015 2:39 a.m., Rich549 wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> After running into plenty of issue with my Linux install of Squid 3.5.1 and
</I>&gt;<i> eventually solving those, my company has now got me to do some work for
</I>&gt;<i> another client that wants to use Squid. The issue with this one though is
</I>&gt;<i> that they will only use Windows, completely anti-Linux...
</I>&gt;<i> 
</I>
And yet they use Squid :-P lol.


&gt;<i> Anyway, I got a pre-compiled version of Squid 3.5.1 from here
</I>&gt;<i> <A HREF="http://squid.diladele.com/.">http://squid.diladele.com/.</A>  It has been compiled using Cygwin and works
</I>&gt;<i> perfectly in Server 2008 and above.  Until you want to use LDAP group
</I>&gt;<i> lookups.
</I>
Please keep in mind that these builds are semi-experimental at present.
Squid-3.x Cygwin builds have been available longer than others for
Windows, but the user base for Windows in total is not very big. It may
just be that nobody before you used or tested this particular helper setup.

&gt;<i> 
</I>&gt;<i> Now, I'm getting really confused, everything seemed to be a lot simpler in
</I>&gt;<i> Squid 2.7 for Windows (the only reason I'm not using this is because video
</I>&gt;<i> buffering is slow). 
</I>
Are you finding 3.5 any faster on Windows?

The major bottleneck that makes Squid people avoid Windows is that they
are capped with a permanent absolute limit of 2048 sockets. At 2 sockets
per client connection (client+server or client+disk) and 8 connections
per user browser (just 'cause they do) thats a capacity of roughly
120-240 users that can be going through the proxy at any one time.

&gt;<i> 
</I>&gt;<i> So...would someone mind having a look at my attached config and tell me
</I>&gt;<i> where I have gone wrong please?  My users only seem to be able to access
</I>&gt;<i> whitelisted sites, which leads me to believe that something is wrong with
</I>&gt;<i> the LDAP query for external_acl_type internet_domain_group.
</I>&gt;<i> 
</I>&gt;<i> A lot of the config is cannibalised from previous SquidNT 2.7 and Linux
</I>&gt;<i> Squid 3.5.1 configs.
</I>
Please note the message about &quot;SquidNT&quot; at the top of
&lt;<A HREF="http://wiki.squid-cache.org/KnowledgeBase/Windows">http://wiki.squid-cache.org/KnowledgeBase/Windows</A>&gt;



&gt;<i> http_port 3128
</I>
These ...

&gt;<i> acl QUERY urlpath_regex cgi-bin \?
</I>&gt;<i> cache deny ALL
</I>&gt;<i> acl apache rep_header Server ^Apache
</I>
... should not be needed at all in 3.5.

&gt;<i> cache_mem 1024 MB
</I>&gt;<i> #cache_dir ufs d:/squid/var/cache/squid/ 8000 16 256
</I>&gt;<i> access_log d:/squid/var/log/squid/access.log squid
</I>&gt;<i> cache_log d:/squid/var/cache/squid/cache.log
</I>
These...

&gt;<i> cache_store_log d:/squid/var/log/store.log
</I>&gt;<i> mime_table d:/Squid/etc/squid/mime.conf
</I>&gt;<i> pid_filename d:/squid/var/log/squid/squid.pid
</I>&gt;<i> unlinkd_program d:/squid/lib/squid/unlinkd.exe
</I>&gt;<i> logfile_daemon d:/Squid/lib/squid/log_file_daemon.exe
</I>&gt;<i> icon_directory d:/squid/usr/share/squid/icons
</I>
 ... to here should also not be necessary in 3.5.

&gt;<i> error_directory d:/squid/usr/share/squid/errors/en-uk
</I>&gt;<i> coredump_dir d:/squid/var/cache/squid/
</I>&gt;<i> dns_nameservers 172.30.12.9 172.31.12.10
</I>&gt;<i> 
</I>&gt;<i> ### New NTLM Authentication Method
</I>&gt;<i> auth_param ntlm program d:/Squid/lib/squid/ntlm_fake_auth
</I>&gt;<i> auth_param ntlm children 80
</I>&gt;<i> auth_param ntlm keep_alive off
</I>
Note that all this helper does is check that the NTLM protocol is
syntactically accurate.

&gt;<i> 
</I>&gt;<i> ### Helper Processes
</I>&gt;<i> external_acl_type internet_domain_group %LOGIN d:/Squid/lib/squid/ext_ldap_group_acl.exe \
</I>&gt;<i>    -b &quot;ou=Domain_Groups,dc=domain-uk,dc=com&quot; \
</I>&gt;<i>    -f %v=Internet_Users -h srvham09.domain-uk.com
</I>&gt;<i>
</I>
The documentation for -f option says that %u (not %v) will be replaced
with username and %g with group name.


&gt;<i> # ------------------------------------------------
</I>&gt;<i> # ----  Declare domains for individual access ----
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> # Blacklisted domains
</I>&gt;<i> acl BlacklistedSites dstdomain .yahoo.com .ebay.com .ebay.co.uk mail.google.com outlook.com hotmail.com hotmail.co.uk live.co.uk
</I>&gt;<i> 
</I>&gt;<i> # These domains will be reachable without authentication
</I>&gt;<i> acl OK_Unauthenticated dstdomain .domain-uk.com .stanford.edu
</I>&gt;<i> acl OK_Unauthenticated dstdomain .domainretail.local .everythingbedrooms.co.uk .canonical.com .sophos.com .ubuntu.com .oracle.com .bt.com
</I>&gt;<i> acl OK_Unauthenticated dstdomain .oanda.com .dell.com .launchpad.net
</I>&gt;<i> acl OK_Unauthenticated dstdomain .dashboards.my-tmac.co.uk
</I>&gt;<i> 
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> # ---  Map web access to AD groups via helpers ---
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> # Allow Members of Internet Users To Anywhere Not Explicitly Denied
</I>&gt;<i> acl InetAllow external internet_domain_group Internet_Users
</I>&gt;<i> 
</I>&gt;<i> # Allow Store Access
</I>&gt;<i> #acl StoresAllow external stores_domain_group Stores_Internet_Access
</I>&gt;<i> 
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> # ---------------  Misc settings -----------------
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # These domains wont be cached - every request will be pulled directly from the web
</I>&gt;<i> acl do_not_cache dstdomain domain-uk.com youtube.com
</I>&gt;<i> cache deny do_not_cache
</I>&gt;<i> 
</I>&gt;<i> # Append domain-uk.com to hostnames without a dot in them
</I>&gt;<i> append_domain .domain-uk.com 
</I>
The above will only have any effect if you also define:

 dns_defnames on

&lt;<A HREF="http://www.squid-cache.org/Doc/config/dns_defnames/">http://www.squid-cache.org/Doc/config/dns_defnames/</A>&gt;

If you need it fine, if not remove from the config.

&gt;<i> 
</I>&gt;<i> # Allow these static IPs access to everything without authentication
</I>&gt;<i> acl StaticIPWhitelist src 172.31.12.* ....
</I>&gt;<i> 
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> # ------ Permit/Deny access as appropriate -------
</I>&gt;<i> # ------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0     
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> shutdown_lifetime 10 seconds
</I>&gt;<i> acl SSL_ports port 443 563 21
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21  	# ftp
</I>&gt;<i> acl Safe_ports port 22		# sftp
</I>&gt;<i> acl Safe_ports port 443 563	# https, snews
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl Safe_ports port 4004	# Radii website download site uses this port
</I>&gt;<i> acl Safe_ports port 10000	# Webmin
</I>
Note that the above two ports are within the 1024-65535 range. No need
to configurethem in.

&gt;<i> acl Safe_ports port 900		# Swat
</I>&gt;<i> acl Safe_ports port 82		# Pacejet request - test site hosted on HTTP 82
</I>&gt;<i> acl Safe_ports port 81		# Image plus test server (hepplewhite)
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> #http_access deny BlacklistedSites StoresAllow
</I>
If the above were enabled any blacklisted site would get an auth popup
from the StoresAllow requiring %LOGIN. This may be part of your problem.
You need to sort out a policy logic order***.

&gt;<i> 
</I>&gt;<i> http_access allow OK_Unauthenticated
</I>&gt;<i> http_access allow StaticIPWhitelist
</I>&gt;<i> 
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> 
</I>&gt;<i> http_access allow InetAllow
</I>&gt;<i> #http_access allow StoresAllow
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
This block...
&gt;<i> acl ftp proto FTP
</I>&gt;<i> #http_access allow ftp
</I>&gt;<i> #http_access allow CONNECT Safe_ports
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i> icp_access allow all
</I>
.. to here can be erased in 3.5.

&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">otrs at hammonds-uk.com</A>
</I>&gt;<i> forwarded_for off
</I>


***

I recommend something like this:

  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports

  # whitelists that dont need authenticating first
  http_access allow OK_Unauthenticated
  http_access allow StaticIPWhitelist

  # followed by auth (a blacklist against un-authenticated people)
  acl auth proxy_auth REQUIRED
  http_access deny !auth

  # blacklists applied even if they login
  http_access deny BlacklistedSites StoresAllow

  # then where authenticated users can go
  http_access allow localhost manager
  http_access allow InetAllow
  http_access allow StoresAllow
  http_access deny all



After the above changes, if you are still having issues please try
testing the group helper manually from the command line. The input it is
expecting a username followed by one space then the group name being
tested. It should return OK (user in group) ERR (user not in group) or
BH (internal error).

NOTE you are not using the -S helper option so the username part is
actually the full DOMAIN\user syntax from NTLM.

If it turns out to be not working you can also try with the -d option to
get a debug trace about what the helper is doing.


Differences since 2.7 that may be affecting the helper:
* LDAP version bumped from v2 to v3
* LDAP over TLS support added - it may or may not need using

Most importantly: Windows 7+ all use Kerberos auth by default and
Windows8+ have NTLM actually removed from the OS - it may actually be
the NTLM auth check which is failing.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002034.html">[squid-users] Squid 3.5.1 NTLM and LDAP
</A></li>
	<LI>Next message (by thread): <A HREF="002100.html">[squid-users] Squid 3.5.1 NTLM and LDAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2045">[ date ]</a>
              <a href="thread.html#2045">[ thread ]</a>
              <a href="subject.html#2045">[ subject ]</a>
              <a href="author.html#2045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
