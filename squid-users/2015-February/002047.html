<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid access list based on sql database  ,	is it possible ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20access%20list%20based%20on%20sql%20database%20%20%2C%0A%09is%20it%20possible%20%3F&In-Reply-To=%3C000b01d045c3%2470490fc0%2450db2f40%24%40netstream.ps%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002044.html">
   <LINK REL="Next"  HREF="002050.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid access list based on sql database  ,	is it possible ?</H1>
    <B>Ahmad</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20access%20list%20based%20on%20sql%20database%20%20%2C%0A%09is%20it%20possible%20%3F&In-Reply-To=%3C000b01d045c3%2470490fc0%2450db2f40%24%40netstream.ps%3E"
       TITLE="[squid-users] squid access list based on sql database  ,	is it possible ?">ahmed.zaeem at netstream.ps
       </A><BR>
    <I>Wed Feb 11 06:24:48 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002044.html">[squid-users] squid access list based on sql database  , is it possible ?
</A></li>
        <LI>Next message (by thread): <A HREF="002050.html">[squid-users] squid access list based on sql database  , is it possible ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2047">[ date ]</a>
              <a href="thread.html#2047">[ thread ]</a>
              <a href="subject.html#2047">[ subject ]</a>
              <a href="author.html#2047">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you , can you  show me a directive with that as an example plz ?


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Yuri Voinov
Sent: Tuesday, February 10, 2015 11:48 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] squid access list based on sql database , is it possible ?

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

basic_db_auth helper is included in Squid distribution.

#!/usr/bin/perl

use strict;
use Pod::Usage;
use Getopt::Long;

=pod

=head1 NAME

 basic_db_auth - Database auth helper for Squid

=head1 SYNOPSIS

 basic_db_auth [options]

=head1 DESCRIPTOIN

This program verifies username &amp; password to a database

=head1 OPTIONS

=over 12

=item B&lt;--debug&gt;

Write debug info to stderr.

=item B&lt;--dsn&gt;

Database DSN. Default &quot;DBI:mysql:database=squid&quot;

=item B&lt;--user&gt;

Database User

=item B&lt;--password&gt;

Database password

=item B&lt;--table&gt;

Database table. Default &quot;passwd&quot;.

=item B&lt;--usercol&gt;

Username column. Default &quot;user&quot;.

=item B&lt;--passwdcol&gt;

Password column. Default &quot;password&quot;.

=item B&lt;--cond&gt;

Condition, defaults to enabled=1. Specify 1 or &quot;&quot; for no condition If you use --joomla flag, this condition will be changed to block=0

=item B&lt;--plaintext&gt;

Database contains plain-text passwords

=item B&lt;--md5&gt;

Database contains unsalted md5 passwords

=item B&lt;--salt&gt;

Selects the correct salt to evaluate passwords

=item B&lt;--persist&gt;

Keep a persistent database connection open between queries.

=item B&lt;--joomla&gt;

Tells helper that user database is Joomla DB.  So their unusual salt hashing is understood.

=back

=head1 AUTHOR

This program was written by
I&lt;Henrik Nordstrom &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henrik at henriknordstrom.net</A>&gt;&gt; and I&lt;Luis Daniel Lucio Quiroz &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dlucio at okay.com.mx</A>&gt;&gt;

This manual was written by I&lt;Henrik Nordstrom &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henrik at henriknordstrom.net</A>&gt;&gt;

=head1 COPYRIGHT

 * Copyright (C) 1996-2015 The Squid Software Foundation and contributors
 *
 * Squid software is distributed under GPLv2+ license and includes
 * contributions from numerous individuals and organizations.
 * Please see the COPYING and CONTRIBUTORS files for details.

Copyright (C) 2007 Henrik Nordstrom &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henrik at henriknordstrom.net</A>&gt; Copyright (C) 2010 Luis Daniel Lucio Quiroz &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dlucio at okay.com.mx</A>&gt; (Joomla support) This program is free software. You may redistribute copies of it under the terms of the GNU General Public License version 2, or (at youropinion) any later version.

=head1 QUESTIONS

Questions on the usage of this program can be sent to the I&lt;Squid Users mailing list &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt;&gt;

=head1 REPORTING BUGS

Bug reports need to be made in English.
See <A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting">http://wiki.squid-cache.org/SquidFaq/BugReporting</A> for details of what you need to include with your bug report.

Report bugs or bug fixes using <A HREF="http://bugs.squid-cache.org/">http://bugs.squid-cache.org/</A>

Report serious security bugs to I&lt;Squid Bugs &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-bugs at squid-cache.org</A>&gt;&gt;

Report ideas for new improvements to the I&lt;Squid Developers mailing list &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-dev at squid-cache.org</A>&gt;&gt;

=head1 SEE ALSO

squid (8), GPL (7),

The Squid FAQ wiki <A HREF="http://wiki.squid-cache.org/SquidFaq">http://wiki.squid-cache.org/SquidFaq</A>

The Squid Configuration Manual <A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A>

=cut

use DBI;
use Digest::MD5 qw(md5 md5_hex md5_base64);

my $dsn = &quot;DBI:mysql:database=squid&quot;;
my $db_user = undef;
my $db_passwd = undef;
my $db_table = &quot;passwd&quot;;
my $db_usercol = &quot;user&quot;;
my $db_passwdcol = &quot;password&quot;;
my $db_cond = &quot;enabled = 1&quot;;
my $plaintext = 0;
my $md5 = 0;
my $persist = 0;
my $isjoomla = 0;
my $debug = 0;
my $hashsalt = undef;

GetOptions(
	'dsn=s' =&gt; \$dsn,
	'user=s' =&gt; \$db_user,
	'password=s' =&gt; \$db_passwd,
	'table=s' =&gt; \$db_table,
	'usercol=s' =&gt; \$db_usercol,
	'passwdcol=s' =&gt; \$db_passwdcol,
	'cond=s' =&gt; \$db_cond,
	'plaintext' =&gt; \$plaintext,
	'md5' =&gt; \$md5,
	'persist' =&gt; \$persist,
	'joomla' =&gt; \$isjoomla,
	'debug' =&gt; \$debug,
	'salt=s' =&gt; \$hashsalt,
	);

my ($_dbh, $_sth);
$db_cond = &quot;block = 0&quot; if $isjoomla;

sub close_db()
{
    return if !defined($_dbh);
    undef $_sth;
    $_dbh-&gt;disconnect();
    undef $_dbh;
}

sub open_db()
{
    return $_sth if defined $_sth;
    $_dbh = DBI-&gt;connect($dsn, $db_user, $db_passwd);
    if (!defined $_dbh) {
    	warn (&quot;Could not connect to $dsn\n&quot;);
	my @driver_names = DBI-&gt;available_drivers();
	my $msg = &quot;DSN drivers apparently installed, available:\n&quot;;
	foreach my $dn (@driver_names) {
		$msg .= &quot;\t$dn&quot;;
	}
	warn($msg.&quot;\n&quot;);
	return undef;
    }
    my $sql_query;
    $sql_query = &quot;SELECT $db_passwdcol FROM $db_table WHERE $db_usercol = ?&quot; . ($db_cond ne &quot;&quot; ? &quot; AND $db_cond&quot; : &quot;&quot;);
    $_sth = $_dbh-&gt;prepare($sql_query) || die;
    return $_sth;
}

sub check_password($$)
{
    my ($password, $key) = @_;

    if ($isjoomla){
        my $salt;
        my $key2;
        ($key2,$salt) = split (/:/, $key);
        return 1 if md5_hex($password.$salt).':'.$salt eq $key;
    }
    else{
        return 1 if defined $hashsalt &amp;&amp; crypt($password, $hashsalt) eq $key;
        return 1 if crypt($password, $key) eq $key;
        return 1 if $md5 &amp;&amp; md5_hex($password) eq $key;
        return 1 if $plaintext &amp;&amp; $password eq $key;
    }

    return 0;
}

sub query_db($) {
    my ($user) = @_;
    my ($sth) = open_db() || return undef;
    if (!$sth-&gt;execute($user)) {
	close_db();
	open_db() || return undef;
	$sth-&gt;execute($user) || return undef;;
    }
    return $sth;
}
my $status;

$|=1;
while (&lt;&gt;) {
    my ($user, $password) = split;
    $status = &quot;ERR&quot;;
    $user =~ s/%(..)/pack(&quot;H*&quot;, $1)/ge;
    $password =~ s/%(..)/pack(&quot;H*&quot;, $1)/ge;

    $status = &quot;ERR database error&quot;;
    my $sth = query_db($user) || next;
    $status = &quot;ERR unknown login&quot;;
    my $row = $sth-&gt;fetchrow_arrayref() || next;
    $status = &quot;ERR login failure&quot;;
    next if (!check_password($password, @$row[0]));
    $status = &quot;OK&quot;;
} continue {
    close_db() if (!$persist);
    print $status . &quot;\n&quot;;
}


11.02.15 11:41, Ahmad &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi ,
</I>&gt;<i> 
</I>&gt;<i> I need to do an access list that get info mysql database.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Can squid get info of accesslist from external db coloum ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cheers
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________ squid-users mailing 
</I>&gt;<i> list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQEbBAEBAgAGBQJU2mCEAAoJENNXIZxhPexGD5kH92xXaGjspM5QtJk2kSAUthvj
wS+NwY07A0tpSgONNB8Wi5SyweAQm3RnU9UvNcrV7Nyj8LUIdeuV3WiLafcn6bv8
fBf7+aUOVbVwkUJXe6XXPfKI4wWBtkKkKXy53s/L1F3u5aFvSMEzCFcLv4pMJSzl
zszPFHGjr+ShVZofd/ex8gXK+l1PW7YAG3b+oOwDuwmr8hHCUc4dJlNjYqbNj84+
mPhiwYz40OyRglLDIgxto1p5EVHx2eRRKjk01htsZisclOh5eISF6ds+bm1bOjqw
q4C9eXSB2ehg3sDZ90rhCuYdJXgnYI+ZQ29EsNMh6wRTZ29QPUjXjjqw8raUmQ==
=Ogyq
-----END PGP SIGNATURE-----
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002044.html">[squid-users] squid access list based on sql database  , is it possible ?
</A></li>
	<LI>Next message (by thread): <A HREF="002050.html">[squid-users] squid access list based on sql database  , is it possible ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2047">[ date ]</a>
              <a href="thread.html#2047">[ thread ]</a>
              <a href="subject.html#2047">[ subject ]</a>
              <a href="author.html#2047">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
