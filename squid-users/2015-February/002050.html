<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid access list based on sql database  , is it possible ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20access%20list%20based%20on%20sql%20database%20%20%2C%0A%20is%20it%20possible%20%3F&In-Reply-To=%3C54DA6B1C.5080501%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002047.html">
   <LINK REL="Next"  HREF="002085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid access list based on sql database  , is it possible ?</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20access%20list%20based%20on%20sql%20database%20%20%2C%0A%20is%20it%20possible%20%3F&In-Reply-To=%3C54DA6B1C.5080501%40gmail.com%3E"
       TITLE="[squid-users] squid access list based on sql database  , is it possible ?">yvoinov at gmail.com
       </A><BR>
    <I>Tue Feb 10 20:33:32 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002047.html">[squid-users] squid access list based on sql database  ,	is it possible ?
</A></li>
        <LI>Next message (by thread): <A HREF="002085.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2050">[ date ]</a>
              <a href="thread.html#2050">[ thread ]</a>
              <a href="subject.html#2050">[ subject ]</a>
              <a href="author.html#2050">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

I don't use database with ACL's. But I can make the assumption that it
is necessary to dig in the direction of the database adapter Perl.

11.02.15 12:24, Ahmad &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Thank you , can you  show me a directive with that as an example
</I>&gt;<i> plz ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message----- From: squid-users
</I>&gt;<i> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of
</I>&gt;<i> Yuri Voinov Sent: Tuesday, February 10, 2015 11:48 AM To:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> Subject: Re: [squid-users] squid
</I>&gt;<i> access list based on sql database , is it possible ?
</I>&gt;<i> 
</I>&gt;<i> basic_db_auth helper is included in Squid distribution.
</I>&gt;<i> 
</I>&gt;<i> #!/usr/bin/perl
</I>&gt;<i> 
</I>&gt;<i> use strict; use Pod::Usage; use Getopt::Long;
</I>&gt;<i> 
</I>&gt;<i> =pod
</I>&gt;<i> 
</I>&gt;<i> =head1 NAME
</I>&gt;<i> 
</I>&gt;<i> basic_db_auth - Database auth helper for Squid
</I>&gt;<i> 
</I>&gt;<i> =head1 SYNOPSIS
</I>&gt;<i> 
</I>&gt;<i> basic_db_auth [options]
</I>&gt;<i> 
</I>&gt;<i> =head1 DESCRIPTOIN
</I>&gt;<i> 
</I>&gt;<i> This program verifies username &amp; password to a database
</I>&gt;<i> 
</I>&gt;<i> =head1 OPTIONS
</I>&gt;<i> 
</I>&gt;<i> =over 12
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--debug&gt;
</I>&gt;<i> 
</I>&gt;<i> Write debug info to stderr.
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--dsn&gt;
</I>&gt;<i> 
</I>&gt;<i> Database DSN. Default &quot;DBI:mysql:database=squid&quot;
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--user&gt;
</I>&gt;<i> 
</I>&gt;<i> Database User
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--password&gt;
</I>&gt;<i> 
</I>&gt;<i> Database password
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--table&gt;
</I>&gt;<i> 
</I>&gt;<i> Database table. Default &quot;passwd&quot;.
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--usercol&gt;
</I>&gt;<i> 
</I>&gt;<i> Username column. Default &quot;user&quot;.
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--passwdcol&gt;
</I>&gt;<i> 
</I>&gt;<i> Password column. Default &quot;password&quot;.
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--cond&gt;
</I>&gt;<i> 
</I>&gt;<i> Condition, defaults to enabled=1. Specify 1 or &quot;&quot; for no condition
</I>&gt;<i> If you use --joomla flag, this condition will be changed to
</I>&gt;<i> block=0
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--plaintext&gt;
</I>&gt;<i> 
</I>&gt;<i> Database contains plain-text passwords
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--md5&gt;
</I>&gt;<i> 
</I>&gt;<i> Database contains unsalted md5 passwords
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--salt&gt;
</I>&gt;<i> 
</I>&gt;<i> Selects the correct salt to evaluate passwords
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--persist&gt;
</I>&gt;<i> 
</I>&gt;<i> Keep a persistent database connection open between queries.
</I>&gt;<i> 
</I>&gt;<i> =item B&lt;--joomla&gt;
</I>&gt;<i> 
</I>&gt;<i> Tells helper that user database is Joomla DB.  So their unusual
</I>&gt;<i> salt hashing is understood.
</I>&gt;<i> 
</I>&gt;<i> =back
</I>&gt;<i> 
</I>&gt;<i> =head1 AUTHOR
</I>&gt;<i> 
</I>&gt;<i> This program was written by I&lt;Henrik Nordstrom
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henrik at henriknordstrom.net</A>&gt;&gt; and I&lt;Luis Daniel Lucio Quiroz
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dlucio at okay.com.mx</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i> This manual was written by I&lt;Henrik Nordstrom
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henrik at henriknordstrom.net</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i> =head1 COPYRIGHT
</I>&gt;<i> 
</I>&gt;<i> * Copyright (C) 1996-2015 The Squid Software Foundation and
</I>&gt;<i> contributors * * Squid software is distributed under GPLv2+ license
</I>&gt;<i> and includes * contributions from numerous individuals and
</I>&gt;<i> organizations. * Please see the COPYING and CONTRIBUTORS files for
</I>&gt;<i> details.
</I>&gt;<i> 
</I>&gt;<i> Copyright (C) 2007 Henrik Nordstrom &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henrik at henriknordstrom.net</A>&gt;
</I>&gt;<i> Copyright (C) 2010 Luis Daniel Lucio Quiroz &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dlucio at okay.com.mx</A>&gt;
</I>&gt;<i> (Joomla support) This program is free software. You may
</I>&gt;<i> redistribute copies of it under the terms of the GNU General Public
</I>&gt;<i> License version 2, or (at youropinion) any later version.
</I>&gt;<i> 
</I>&gt;<i> =head1 QUESTIONS
</I>&gt;<i> 
</I>&gt;<i> Questions on the usage of this program can be sent to the I&lt;Squid
</I>&gt;<i> Users mailing list &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i> =head1 REPORTING BUGS
</I>&gt;<i> 
</I>&gt;<i> Bug reports need to be made in English. See
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting">http://wiki.squid-cache.org/SquidFaq/BugReporting</A> for details of
</I>&gt;<i> what you need to include with your bug report.
</I>&gt;<i> 
</I>&gt;<i> Report bugs or bug fixes using <A HREF="http://bugs.squid-cache.org/">http://bugs.squid-cache.org/</A>
</I>&gt;<i> 
</I>&gt;<i> Report serious security bugs to I&lt;Squid Bugs
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-bugs at squid-cache.org</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i> Report ideas for new improvements to the I&lt;Squid Developers mailing
</I>&gt;<i> list &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-dev at squid-cache.org</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i> =head1 SEE ALSO
</I>&gt;<i> 
</I>&gt;<i> squid (8), GPL (7),
</I>&gt;<i> 
</I>&gt;<i> The Squid FAQ wiki <A HREF="http://wiki.squid-cache.org/SquidFaq">http://wiki.squid-cache.org/SquidFaq</A>
</I>&gt;<i> 
</I>&gt;<i> The Squid Configuration Manual
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A>
</I>&gt;<i> 
</I>&gt;<i> =cut
</I>&gt;<i> 
</I>&gt;<i> use DBI; use Digest::MD5 qw(md5 md5_hex md5_base64);
</I>&gt;<i> 
</I>&gt;<i> my $dsn = &quot;DBI:mysql:database=squid&quot;; my $db_user = undef; my
</I>&gt;<i> $db_passwd = undef; my $db_table = &quot;passwd&quot;; my $db_usercol =
</I>&gt;<i> &quot;user&quot;; my $db_passwdcol = &quot;password&quot;; my $db_cond = &quot;enabled =
</I>&gt;<i> 1&quot;; my $plaintext = 0; my $md5 = 0; my $persist = 0; my $isjoomla =
</I>&gt;<i> 0; my $debug = 0; my $hashsalt = undef;
</I>&gt;<i> 
</I>&gt;<i> GetOptions( 'dsn=s' =&gt; \$dsn, 'user=s' =&gt; \$db_user, 'password=s'
</I>&gt;<i> =&gt; \$db_passwd, 'table=s' =&gt; \$db_table, 'usercol=s' =&gt;
</I>&gt;<i> \$db_usercol, 'passwdcol=s' =&gt; \$db_passwdcol, 'cond=s' =&gt;
</I>&gt;<i> \$db_cond, 'plaintext' =&gt; \$plaintext, 'md5' =&gt; \$md5, 'persist' =&gt;
</I>&gt;<i> \$persist, 'joomla' =&gt; \$isjoomla, 'debug' =&gt; \$debug, 'salt=s' =&gt;
</I>&gt;<i> \$hashsalt, );
</I>&gt;<i> 
</I>&gt;<i> my ($_dbh, $_sth); $db_cond = &quot;block = 0&quot; if $isjoomla;
</I>&gt;<i> 
</I>&gt;<i> sub close_db() { return if !defined($_dbh); undef $_sth; 
</I>&gt;<i> $_dbh-&gt;disconnect(); undef $_dbh; }
</I>&gt;<i> 
</I>&gt;<i> sub open_db() { return $_sth if defined $_sth; $_dbh =
</I>&gt;<i> DBI-&gt;connect($dsn, $db_user, $db_passwd); if (!defined $_dbh) { 
</I>&gt;<i> warn (&quot;Could not connect to $dsn\n&quot;); my @driver_names =
</I>&gt;<i> DBI-&gt;available_drivers(); my $msg = &quot;DSN drivers apparently
</I>&gt;<i> installed, available:\n&quot;; foreach my $dn (@driver_names) { $msg .=
</I>&gt;<i> &quot;\t$dn&quot;; } warn($msg.&quot;\n&quot;); return undef; } my $sql_query; 
</I>&gt;<i> $sql_query = &quot;SELECT $db_passwdcol FROM $db_table WHERE $db_usercol
</I>&gt;<i> = ?&quot; . ($db_cond ne &quot;&quot; ? &quot; AND $db_cond&quot; : &quot;&quot;); $_sth =
</I>&gt;<i> $_dbh-&gt;prepare($sql_query) || die; return $_sth; }
</I>&gt;<i> 
</I>&gt;<i> sub check_password($$) { my ($password, $key) = @_;
</I>&gt;<i> 
</I>&gt;<i> if ($isjoomla){ my $salt; my $key2; ($key2,$salt) = split (/:/,
</I>&gt;<i> $key); return 1 if md5_hex($password.$salt).':'.$salt eq $key; } 
</I>&gt;<i> else{ return 1 if defined $hashsalt &amp;&amp; crypt($password, $hashsalt)
</I>&gt;<i> eq $key; return 1 if crypt($password, $key) eq $key; return 1 if
</I>&gt;<i> $md5 &amp;&amp; md5_hex($password) eq $key; return 1 if $plaintext &amp;&amp;
</I>&gt;<i> $password eq $key; }
</I>&gt;<i> 
</I>&gt;<i> return 0; }
</I>&gt;<i> 
</I>&gt;<i> sub query_db($) { my ($user) = @_; my ($sth) = open_db() || return
</I>&gt;<i> undef; if (!$sth-&gt;execute($user)) { close_db(); open_db() || return
</I>&gt;<i> undef; $sth-&gt;execute($user) || return undef;; } return $sth; } my
</I>&gt;<i> $status;
</I>&gt;<i> 
</I>&gt;<i> $|=1; while (&lt;&gt;) { my ($user, $password) = split; $status = &quot;ERR&quot;; 
</I>&gt;<i> $user =~ s/%(..)/pack(&quot;H*&quot;, $1)/ge; $password =~ s/%(..)/pack(&quot;H*&quot;,
</I>&gt;<i> $1)/ge;
</I>&gt;<i> 
</I>&gt;<i> $status = &quot;ERR database error&quot;; my $sth = query_db($user) || next; 
</I>&gt;<i> $status = &quot;ERR unknown login&quot;; my $row = $sth-&gt;fetchrow_arrayref()
</I>&gt;<i> || next; $status = &quot;ERR login failure&quot;; next if
</I>&gt;<i> (!check_password($password, @$row[0])); $status = &quot;OK&quot;; } continue
</I>&gt;<i> { close_db() if (!$persist); print $status . &quot;\n&quot;; }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 11.02.15 11:41, Ahmad &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> Hi ,
</I>&gt;<i> 
</I>&gt;&gt;<i> I need to do an access list that get info mysql database.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Can squid get info of accesslist from external db coloum ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> cheers
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________ squid-users
</I>&gt;&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________ squid-users mailing
</I>&gt;<i> list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQEcBAEBAgAGBQJU2mscAAoJENNXIZxhPexGduIIAK3qmZ+zjTgGxv6nhfQ3TsJp
pi5ed8H9vWTZFlC7HewHYWEImaoPc0Slzr+R6fJfEYvPLXKaJtYHbEDuTNjEUCI/
et72oe/YexYWJb52ztU7CsacW1TeUdcTGRsXIIOmAFmgDJEPX+dP8oqDHS4/pIzM
Agn+1dk3X4E7XA7zEEH4rQSZ3T5mMKSTZfqDThoYOFCNdvA0Mw3Qz9r7IhRkpG2+
9hkDa8ou5C5ezWhd5K73bdBBaKhpe23JN2pAaYDvWSIYHwQYyWBo+VGrlWtm7E7V
de6UMQ1G1VWNdA0dbGtUx8DOvwfu47TFaqLCPW8rcDS0IzYbtFes5gpmiXTM3k4=
=fPlO
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002047.html">[squid-users] squid access list based on sql database  ,	is it possible ?
</A></li>
	<LI>Next message (by thread): <A HREF="002085.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2050">[ date ]</a>
              <a href="thread.html#2050">[ thread ]</a>
              <a href="subject.html#2050">[ subject ]</a>
              <a href="author.html#2050">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
