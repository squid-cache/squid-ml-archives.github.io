<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Memory Leak with certain FTP requests?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Memory%20Leak%20with%20certain%20FTP%20requests%3F&In-Reply-To=%3C54DB2A99.4000009%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002085.html">
   <LINK REL="Next"  HREF="002096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Memory Leak with certain FTP requests?</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Memory%20Leak%20with%20certain%20FTP%20requests%3F&In-Reply-To=%3C54DB2A99.4000009%40gmail.com%3E"
       TITLE="[squid-users] Squid Memory Leak with certain FTP requests?">yvoinov at gmail.com
       </A><BR>
    <I>Wed Feb 11 10:10:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002085.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
        <LI>Next message (by thread): <A HREF="002096.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2087">[ date ]</a>
              <a href="thread.html#2087">[ thread ]</a>
              <a href="subject.html#2087">[ subject ]</a>
              <a href="author.html#2087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Squid first saves object in memory. Then swapout object to cache. As usual:

# MEMORY CACHE OPTIONS
# 
-----------------------------------------------------------------------------

#  TAG: cache_mem    (bytes)
#    NOTE: THIS PARAMETER DOES NOT SPECIFY THE MAXIMUM PROCESS SIZE.
#    IT ONLY PLACES A LIMIT ON HOW MUCH ADDITIONAL MEMORY SQUID WILL
#    USE AS A MEMORY CACHE OF OBJECTS. SQUID USES MEMORY FOR OTHER
#    THINGS AS WELL. SEE THE SQUID FAQ SECTION 8 FOR DETAILS.
#
#    'cache_mem' specifies the ideal amount of memory to be used
#    for:
#        * In-Transit objects
#        * Hot Objects
#        * Negative-Cached objects
#
#    Data for these objects are stored in 4 KB blocks.  This
#    parameter specifies the ideal upper limit on the total size of
#    4 KB blocks allocated.  In-Transit objects take the highest
#    priority.
#
#    In-transit objects have priority over the others.  When
#    additional space is needed for incoming data, negative-cached
#    and hot objects will be released.  In other words, the
#    negative-cached and hot objects will fill up any unused space
#    not needed for in-transit objects.
#
#    If circumstances require, this limit will be exceeded.
#    Specifically, if your incoming request rate requires more than
#    'cache_mem' of memory to hold in-transit objects, Squid will
#    exceed this limit to satisfy the new requests.  When the load
#    decreases, blocks will be freed until the high-water mark is
#    reached.  Thereafter, blocks will be used to store hot
#    objects.
#
#    If shared memory caching is enabled, Squid does not use the shared
#    cache space for in-transit objects, but they still consume as much
#    local memory as they need. For more details about the shared memory
#    cache, see memory_cache_shared.
#Default:
# cache_mem 256 MB

#  TAG: maximum_object_size_in_memory    (bytes)
#    Objects greater than this size will not be attempted to kept in
#    the memory cache. This should be set high enough to keep objects
#    accessed frequently in memory to improve performance whilst low
#    enough to keep larger objects from hoarding cache_mem.
#Default:
# maximum_object_size_in_memory 512 KB

#  TAG: memory_cache_shared    on|off
#    Controls whether the memory cache is shared among SMP workers.
#
#    The shared memory cache is meant to occupy cache_mem bytes and replace
#    the non-shared memory cache, although some entities may still be
#    cached locally by workers for now (e.g., internal and in-transit
#    objects may be served from a local memory cache even if shared memory
#    caching is enabled).
#
#    By default, the memory cache is shared if and only if all of the
#    following conditions are satisfied: Squid runs in SMP mode with
#    multiple workers, cache_mem is positive, and Squid environment
#    supports required IPC primitives (e.g., POSIX shared memory segments
#    and GCC-style atomic operations).
#
#    To avoid blocking locks, shared memory uses opportunistic algorithms
#    that do not guarantee that every cachable entity that could have been
#    shared among SMP workers will actually be shared.
#
#    Currently, entities exceeding 32KB in size cannot be shared.
#Default:
# &quot;on&quot; where supported if doing memory caching with multiple SMP workers.

#  TAG: memory_cache_mode
#    Controls which objects to keep in the memory cache (cache_mem)
#
#    always    Keep most recently fetched objects in memory (default)
#
#    disk    Only disk cache hits are kept in memory, which means
#        an object must first be cached on disk and then hit
#        a second time before cached in memory.
#
#    network    Only objects fetched from network is kept in memory
#Default:
# Keep the most recently fetched objects in memory

This is no memory leaking, but normal cache behaviour. As documented.

You can play around with range_offset_limit and quick_abort_min parameters.

Or try to no cache this FTP with ACL.

Usually, when suggests memory leaking, this often OS issue. Not Squid.

11.02.15 16:02, Silamael &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> One of our customers does constantly mirroring of some FTP directories
</I>&gt;<i> and noticed a huge memory consumption of Squid. As far as I can see with
</I>&gt;<i> squidclient mgr:mem, the 2K buffers are constantly increasing if Squid
</I>&gt;<i> is processing FTP requests like wget <A HREF="ftp://some.server/pub/">ftp://some.server/pub/</A> or wget -m
</I>&gt;<i> <A HREF="ftp://...">ftp://...</A>
</I>&gt;<i> In my tests the first variant resulted in an increase of 29 kb per request.
</I>&gt;<i> If I directly request a certain file, the increase of the 2K buffers
</I>&gt;<i> seems not to happen.
</I>&gt;<i> I have reproduced this behaviour with both squid 3.2.13 and also 3.4.6
</I>&gt;<i> and 3.4.11.
</I>&gt;<i>
</I>&gt;<i> Greeting,
</I>&gt;<i> Matthias
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002085.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
	<LI>Next message (by thread): <A HREF="002096.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2087">[ date ]</a>
              <a href="thread.html#2087">[ thread ]</a>
              <a href="subject.html#2087">[ subject ]</a>
              <a href="author.html#2087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
