<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Receiving blank input in External ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Receiving%20blank%20input%20in%20External%20ACL&In-Reply-To=%3CCAMZauGqJ8F9PB%2BXBqB24rbWnrhFumiTX7ArX9RrCBE12bR7xFg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002235.html">
   <LINK REL="Next"  HREF="002111.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Receiving blank input in External ACL</H1>
    <B>Alberto Perez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Receiving%20blank%20input%20in%20External%20ACL&In-Reply-To=%3CCAMZauGqJ8F9PB%2BXBqB24rbWnrhFumiTX7ArX9RrCBE12bR7xFg%40mail.gmail.com%3E"
       TITLE="[squid-users] Receiving blank input in External ACL">alberto2perez at gmail.com
       </A><BR>
    <I>Wed Feb 11 15:43:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002235.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
        <LI>Next message (by thread): <A HREF="002111.html">[squid-users] Receiving blank input in External ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2109">[ date ]</a>
              <a href="thread.html#2109">[ thread ]</a>
              <a href="subject.html#2109">[ subject ]</a>
              <a href="author.html#2109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi to all  and thanks for the time given to read and reply these emails


I am having an strange issue with my external ACL, ocassionally im
getting blank inputs from squid to by proccessed by the external ACL,
for those cases I am returning ERR but squid is complainting showing
in cache.log errors like

2015/02/11 10:01:36| helperHandleRead: unexpected read from
session_active_def #Hlpr5, 4 bytes 'ERR
'

My question is, what should I return in those cases? its normal to
recieve those blanks? how to avoid them if possible?

Im worried about this detail because related to this events (only some
times) squid stop serving to client who fired the event, client has to
change IP to continue surfing.

Here is the definition of the external ACL, its supposed to receive IP

# Set up the normal session helper.
external_acl_type session_active_def concurrency=1 children-max=15
children-startup=12  ipv4 ttl=3 negative_ttl=1 %SRC
/etc/squid3/captive/sessionHelper.php

And here the code

#!/usr/bin/php
&lt;?php
error_reporting(0);
$meminstance = new Memcache();
$meminstance-&gt;pconnect('127.0.0.1', 11211);
ini_set(&quot;memory_limit&quot;,($memoryLimit=512).&quot;M&quot;);
while (!@feof(STDIN)) {
try{

	$line = trim(fgets(STDIN));
	if (!$line) { shell_exec(&quot;echo \&quot;SESSION - No client ip error: \&quot;
&quot;.$line.&quot; - &quot;.&quot; - $(date) &gt;&gt; /var/log/squid3/session.log&quot;);
fwrite(STDOUT, &quot;ERR\n&quot;); continue;}

	$line = explode(&quot; &quot;, $line);

	$clientip = count($line &gt; 1)?$line[1]:false; //1738

	if (!$clientip) { shell_exec(&quot;echo \&quot;SESSION - No client ip error: \&quot;
&quot;.$line.&quot; - &quot;.&quot; - $(date) &gt;&gt; /var/log/squid3/session.log&quot;);
fwrite(STDOUT, &quot;ERR\n&quot;); continue;}

	 $username = $meminstance-&gt;get($clientip);
	$hasInternet = $username?$meminstance-&gt;get(&quot;has_internet_$username&quot;):false;
	if ($username &amp;&amp; $hasInternet){
			// extend session
 			$meminstance-&gt;set($clientip, $username, 0,3600); // extend 10 min
			$meminstance-&gt;set(&quot;ip_&quot;.$username, $clientip, 0, 3600); // 10 min
			$meminstance-&gt;set(&quot;has_internet_&quot;.$username, true, 0, 3600); // 10 min
	                fwrite(STDOUT, &quot;OK user=$username\n&quot;);
	}else{
        	fwrite(STDOUT, &quot;ERR\n&quot;);
	}
}catch(Exception $e){
        	fwrite(STDOUT, &quot;BH\n&quot;);
}
}
exit;
?&gt;



Thanks to all

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002235.html">[squid-users] Squid Memory Leak with certain FTP requests?
</A></li>
	<LI>Next message (by thread): <A HREF="002111.html">[squid-users] Receiving blank input in External ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2109">[ date ]</a>
              <a href="thread.html#2109">[ thread ]</a>
              <a href="subject.html#2109">[ subject ]</a>
              <a href="author.html#2109">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
