<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20client_side.cc%3A1515%3A%0A%09%22connIsUsable%28http-%3EgetConn%28%29%29&In-Reply-To=%3CF7A152AC-CAF8-46F7-9EB3-0E32F2B1744C%40getbusi.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002344.html">
   <LINK REL="Next"  HREF="002346.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())</H1>
    <B>Dan Charlesworth</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20client_side.cc%3A1515%3A%0A%09%22connIsUsable%28http-%3EgetConn%28%29%29&In-Reply-To=%3CF7A152AC-CAF8-46F7-9EB3-0E32F2B1744C%40getbusi.com%3E"
       TITLE="[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())">dan at getbusi.com
       </A><BR>
    <I>Fri Feb 20 04:06:02 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002344.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
        <LI>Next message (by thread): <A HREF="002346.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2345">[ date ]</a>
              <a href="thread.html#2345">[ thread ]</a>
              <a href="subject.html#2345">[ subject ]</a>
              <a href="author.html#2345">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Eliezer &#8230;

We've only ever used `kill` as very last resort when the squid process wouldn&#8217;t respond to anything else.

Anyway, I think I missed what led you to think the crash is related to the reply_body_max_size rules' external ACL as opposed to the many others we define?

That would certainly narrow it down a lot further than before.

Cheers
Dan

&gt;<i> On 20 Feb 2015, at 2:57 pm, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hey Dan,
</I>&gt;<i> 
</I>&gt;<i> I am not the best at reading squid long debug output and it is needed in order to understand the path that the request is traveling between the ACLs and helper to determine if the issue is since the connection is unusable because of a helper or because of another reason.
</I>&gt;<i> 
</I>&gt;<i> And so from what you describe I assume that the needed helper\external ACL is a fake one so a python helper is out of the question for such a purpose.
</I>&gt;<i> The fact that it's crashing describes some kind of failure from the combination of something.
</I>&gt;<i> In order to test if the issue is because of the helper or something related to the existence of this specific helper for the reply body max try to disable this helper and use only the basic limit, while it will force you to not show a nice deny info page it will prevent the some of the issues from happening.
</I>&gt;<i> 
</I>&gt;<i> From stability point of view running all these kill -9 what so ever is a very wrong approach.
</I>&gt;<i> The crashes else then causing &quot;down time&quot; causing a much deeper issue.
</I>&gt;<i> Assuming that the users transactions are important these crashes are damaging in many cases even more then any &quot;down time&quot;.
</I>&gt;<i> I know that some admins do not agree with my approach but a stable service is one of the basic fundamentals for success and happiness!!
</I>&gt;<i> 
</I>&gt;<i> I must admit that there are cases which a kill -9 can help but it has it's price.
</I>&gt;<i> 
</I>&gt;<i> Just asking loudly from both CEO + SYSADMIN + CLIENTS + others:
</I>&gt;<i> What would you prefer?
</I>&gt;<i> - stability based a good product
</I>&gt;<i> - stability based on patches
</I>&gt;<i> - stability based on human resources recruitment's
</I>&gt;<i> - stability based on some unclosed known bugs
</I>&gt;<i> - stability based on 1k programmers work
</I>&gt;<i> - stability based on protocol compatibility
</I>&gt;<i> ....
</I>&gt;<i> 
</I>&gt;<i> And I must stop here with the list since the above list can become very long and which will prove that humans can look at the same picture and see many different things.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> * I am almost sure that you may use a &quot;fake&quot; acl that will match all requests instead of using an external_acl helper that will help you to &quot;select&quot; the 100MB limit.
</I>&gt;<i> 
</I>&gt;<i> On 20/02/2015 05:34, Dan Charlesworth wrote:
</I>&gt;&gt;<i> Installed v3.4.12 and almost went a whole day without this crash.
</I>&gt;&gt;<i> Ended up rearing its head during a spike in traffic after lunch. Seems
</I>&gt;&gt;<i> to be more prone to occurring when the HTTP requests per second
</I>&gt;&gt;<i> reaches about 100.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I have a script running that runs a squid reload whenever this crash
</I>&gt;&gt;<i> occurs and that seems to limit the impact (downtime) to a few
</I>&gt;&gt;<i> seconds&#8212;but occasionally Squid seems to get deadlocked by the crash
</I>&gt;&gt;<i> and needs to be killed (sometimes with -9) before it can be restarted.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> In lieu of being able to diagnose and fix this, does anyone have any
</I>&gt;&gt;<i> other creative ideas as to limiting its impact?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i> Dan
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 12 February 2015 at 09:51, Dan Charlesworth &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dan at getbusi.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> Hey Eliezer
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> With the response_size_100 ACL definition:
</I>&gt;&gt;&gt;<i> - 100 tells the external ACL the limit in MB
</I>&gt;&gt;&gt;<i> - 192.168.0.10 tells the external ACL the squid IP
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I think one or both of these is only needed to build the deny page. You can&#8217;t use deny_info with reply_body_max_size so we had to customise the ERR_TOO_BIG source to do a redirect to our own page.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The http_access allow line is because result caching cannot alter the EXT_LOG for fast ACLs as cache lookups include the EXT_LOG, so we need to check the result twice to alter the EXT_LOG and then have the result cached against the altered EXT_LOG.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Cheers
</I>&gt;&gt;&gt;<i> Dan
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On 11 Feb 2015, at 11:09 pm, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Hey Dan,
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> First I must admit that this squid.conf is quite complicated but kind of self explanatory.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I have tried to understand the next lines:
</I>&gt;&gt;&gt;&gt;<i> # File size (download) restrictions
</I>&gt;&gt;&gt;&gt;<i> acl response_size_100 external response_size_type 100 192.168.0.10
</I>&gt;&gt;&gt;&gt;<i> http_access allow response_size_100 response_size_100
</I>&gt;&gt;&gt;&gt;<i> reply_body_max_size 100 MB response_size_100
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> But I am unsure how it works with external_acl exactly.
</I>&gt;&gt;&gt;&gt;<i> If you wish to deny 100MB size files you should have only one rule for the reply body max size, what are the others for exactly?
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Eliezer
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> * I might missing some concepts some sorry in advance.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On 11/02/2015 00:30, Dan Charlesworth wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hi Eliezer
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Took a while to get this up&#8212;sorry about that. Here&#8217;s an example of a production config of ours (with some confidential stuff necessarily taken out/edited):
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://gist.github.com/djch/92cf44440b04afbd7917">https://gist.github.com/djch/92cf44440b04afbd7917</A>  &lt;<A HREF="https://gist.github.com/djch/92cf44440b04afbd7917">https://gist.github.com/djch/92cf44440b04afbd7917</A>&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Let me know if there&#8217;s any other info I can provide that might point towards the cause of this crash.
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> And thanks again for taking a look.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002344.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
	<LI>Next message (by thread): <A HREF="002346.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2345">[ date ]</a>
              <a href="thread.html#2345">[ thread ]</a>
              <a href="subject.html#2345">[ subject ]</a>
              <a href="author.html#2345">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
