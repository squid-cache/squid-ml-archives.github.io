<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Authentication Passthrough Failing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Authentication%20Passthrough%20Failing&In-Reply-To=%3C54EFC492.2040407%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002467.html">
   <LINK REL="Next"  HREF="002470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Authentication Passthrough Failing</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Authentication%20Passthrough%20Failing&In-Reply-To=%3C54EFC492.2040407%40treenet.co.nz%3E"
       TITLE="[squid-users] Authentication Passthrough Failing">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 27 01:12:50 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002467.html">[squid-users] Authentication Passthrough Failing
</A></li>
        <LI>Next message (by thread): <A HREF="002470.html">[squid-users] Different squid-3.5.2 compile error on OpenBSD 5.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2474">[ date ]</a>
              <a href="thread.html#2474">[ thread ]</a>
              <a href="subject.html#2474">[ subject ]</a>
              <a href="author.html#2474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/02/2015 7:38 a.m., Curtis.M wrote:
&gt;<i> Hi all, 
</I>&gt;<i> 
</I>&gt;<i> I have squid 2.7 setup on a Win2012R2 DC used for caching purposes. The main
</I>&gt;<i> use is for caching Apple iOS updates but is also starting to be used for
</I>&gt;<i> general web browsing. 
</I>&gt;<i> 
</I>&gt;<i> The issue I have is there is a web filtering system being used in this
</I>&gt;<i> environment that relies on AD usernames to filter web traffic. When clients
</I>&gt;<i> are configured with squid, they are essentially unfiltered. Reason being is
</I>&gt;<i> the box squid runs off is excluded from filtering and it seems all clients
</I>&gt;<i> using the configured proxy receive the same level of filtering as the host
</I>&gt;<i> squid is running from. 
</I>&gt;<i> 
</I>&gt;<i> I have already researched this and found that I may need to use Connection
</I>&gt;<i> Pinning but when the line &quot;connection-auth=on&quot; is added to the conf, squid
</I>&gt;<i> refuses to start. 
</I>&gt;<i> (Full error below) 
</I>&gt;<i> 
</I>&gt;<i> So my questions are: 
</I>&gt;<i>      Am I right in trying to use Connection Pinning to resolve this issue? 
</I>
No connection pinning is enabled by default anyway. Its about relaying
credentials so the client can (try to) login to a website foolishly
using NTLM and/or Negotiate authentication.

It doesn't work for remote Internet traffic, but if the service the
credentials are being delivered to is on the local LAN it usually (but
not always) works well enough. Provided Squid is the only proxy between
client and service.


&gt;<i>      Am I missing code needed from the conf I mentioned? 
</I>&gt;<i>       
</I>
I dont see any config related to Squid passing the HTTP traffic to this
web filtering system you mention. That would normally be done with
cache_peer. With that in place the upstream web filtering system does
the relevant auth and Squid pins connections to/from it which need to be
pinned.


&gt;<i> 
</I>&gt;<i> Thanks for reading and I hope you can help! 
</I>&gt;<i> 
</I>&gt;<i> Kind Regards, 
</I>&gt;<i> 
</I>&gt;<i> Curtis. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Squid.conf 
</I>&gt;<i> ----------------------------------------------------------------------------------------------------------------------- 
</I>&gt;<i> http_port 3128 connection-auth=on 
</I>
Problem #1:
 Squid-2.7 does not contain the connection-auth=X parameter.

That &quot;feature&quot; is on by default in 2.7 with an option to disable. So
there is nothing you need to do to allow it to work.


&gt;<i> 
</I>&gt;<i> acl all src all 
</I>&gt;<i> acl manager proto cache_object 
</I>&gt;<i> acl localhost src 127.0.0.1/32 
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 
</I>&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network 
</I>&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network 
</I>&gt;<i> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network 
</I>&gt;<i> acl SSL_ports port 443 
</I>&gt;<i> acl Safe_ports port 80	# http 
</I>&gt;<i> acl Safe_ports port 21	# ftp 
</I>&gt;<i> acl Safe_ports port 443	# https 
</I>&gt;<i> acl Safe_ports port 70	# gopher 
</I>&gt;<i> acl Safe_ports port 210	# wais 
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports 
</I>&gt;<i> acl Safe_ports port 280	# http-mgmt 
</I>&gt;<i> acl Safe_ports port 488	# gss-http 
</I>&gt;<i> acl Safe_ports port 591	# filemaker 
</I>&gt;<i> acl Safe_ports port 777	# multiling http 
</I>&gt;<i> acl CONNECT method CONNECT 
</I>&gt;<i> 
</I>&gt;<i> http_access allow manager localhost 
</I>&gt;<i> http_access deny manager 
</I>&gt;<i> http_access deny !Safe_ports 
</I>&gt;<i> http_access deny CONNECT !SSL_ports 
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet 
</I>&gt;<i> 
</I>&gt;<i> http_access deny all 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> icp_access allow localnet 
</I>&gt;<i> icp_access deny all 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> hierarchy_stoplist cgi-bin ? 
</I>&gt;<i> 
</I>&gt;<i> maximum_object_size 3072000000 bytes 
</I>&gt;<i> cache_dir aufs C:\squid\var\cache 256000 128 256 max-size=2048000000 
</I>&gt;<i> 
</I>&gt;<i> access_log c:/squid/var/logs/access.log squid 
</I>&gt;<i> 
</I>&gt;<i> Cache-Control: max-age=0, no-cache, no-store 
</I>&gt;<i> Pragma: no-cache 
</I>
Problem #2:
The above two lines are HTTP protocol message headers. Not squid.conf
directives. Did you miss out a commmet &quot;#&quot; prefix on the line?


&gt;<i> refresh_pattern -i appldnld\.apple\.com 129600 100% 129600 ignore-reload
</I>&gt;<i> ignore-no-store override-expire override-lastmod ignore-must-revalidate 
</I>&gt;<i> refresh_pattern -i phobos\.apple\.com 129600 100% 129600 ignore-reload
</I>&gt;<i> ignore-no-store override-expire override-lastmod ignore-must-revalidate 
</I>
Potential Problem #3:
 You are forcing Squid to ignore the HTTP/1.1 cache revalidation
features which need to be carefully handled by Squid when operating in
the presence of NTLM or Negotiate authentication.

What do you expect to happen when the 407 response is forced to be
cached and re-used with to all following requests for apple.com
downloads? eg. a HIT on a cached 407 is ... a 407 ... stored for 90 days
with no chance of alteration.



&gt;<i> refresh_pattern ^ftp:	1440	20%	10080 
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440 
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0 
</I>&gt;<i> refresh_pattern .	0	20%	4320 
</I>&gt;<i> 
</I>&gt;<i> acl shoutcast rep_header X-HTTP09-First-Line ^ICY.[0-9] 
</I>&gt;<i> upgrade_http0.9 deny shoutcast 
</I>&gt;<i> 
</I>&gt;<i> acl apache rep_header Server ^Apache 
</I>&gt;<i> broken_vary_encoding allow apache 
</I>&gt;<i> 
</I>&gt;<i> coredump_dir c:/squid/var/cache 
</I>&gt;<i> ----------------------------------------------------------------------------------------------------------------------- 
</I>&gt;<i> Full Error: 
</I>&gt;<i> FATAL: Bungled squid.conf line 1: http_port 3128 connection-auth=on 
</I>&gt;<i> Squid Cache (Version 2.7.STABLE8): Terminated abnormally.
</I>
That is from problem #1.


PS. Don't assume that its Squid being the problem. Even if connections
&quot;only&quot; have a problem when going through Squid.

Direct-to-origin server messages and proxy-relayed messages have
different format, different requirements, and different limitations. The
authentication mechanisms are also quite different in one critical way
(end-to-end vs hop-by-hop processing). In order to pass NTLM and
Negotiate authentication to the server through a proxy most of the
HTTP/1.1 features have to be understood and disabled by that proxy.
Squid-2.7 is HTTP/1.0 software with only a limited understanding of ~60%
of HTTP/1.1 features.

The modern Internet also has a mix of several other protocols (HTTP/2,
WebSockets, SPDY, QUIC) operating over what were once the HTTP-only
ports. Squid-2.7 is old enough that it only understands HTTP/1.0
properly and some of HTTP/1.1. Its quite possible that &quot;working&quot; origin
connections are not using anything even remotely resembling HTTP/1.0.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002467.html">[squid-users] Authentication Passthrough Failing
</A></li>
	<LI>Next message (by thread): <A HREF="002470.html">[squid-users] Different squid-3.5.2 compile error on OpenBSD 5.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2474">[ date ]</a>
              <a href="thread.html#2474">[ thread ]</a>
              <a href="subject.html#2474">[ subject ]</a>
              <a href="author.html#2474">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
