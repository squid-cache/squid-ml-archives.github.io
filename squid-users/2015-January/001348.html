<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Debugging slow access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20slow%20access&In-Reply-To=%3C54ABD1F4.1030803%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001350.html">
   <LINK REL="Next"  HREF="001351.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Debugging slow access</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20slow%20access&In-Reply-To=%3C54ABD1F4.1030803%40opendium.com%3E"
       TITLE="[squid-users] Debugging slow access">steve at opendium.com
       </A><BR>
    <I>Tue Jan  6 12:15:48 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001350.html">[squid-users] Debugging slow access
</A></li>
        <LI>Next message (by thread): <A HREF="001351.html">[squid-users] Debugging slow access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1348">[ date ]</a>
              <a href="thread.html#1348">[ thread ]</a>
              <a href="subject.html#1348">[ subject ]</a>
              <a href="author.html#1348">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05.01.15 18:15, Amos Jeffries wrote:

&gt;<i> Can you try making the constructor at the top of src/HelperReply.cc
</I>&gt;<i> look like this and see if it resolves the problem?
</I>&gt;<i>
</I>&gt;<i> HelperReply::HelperReply(char *buf, size_t len) :
</I>&gt;<i>          result(HelperReply::Unknown),
</I>&gt;<i>          notes(),
</I>&gt;<i>          whichServer(NULL)
</I>&gt;<i> {
</I>&gt;<i>      assert(notes.empty());
</I>&gt;<i>      parse(buf,len);
</I>&gt;<i> }
</I>
This didn't help I'm afraid.

Some further debugging so far today:
The notes in HelperReply are indeed empty when the token is added.

However, Auth::Negotiate::UserRequest::HandleReply() appends the reply 
notes to auth_user_request.  It fetches a cached user record from 
proxy_auth_username_cache and then calls absorb() to merge 
auth_user_request with the cached user record.  This ends up adding the 
new Negotiate token into the cached record.  This keeps happening for 
each new request and the cached user record gradually accumulates tokens.

As far as I can see, tokens are only ever read from the helper's reply 
notes, not the user's notes, so maybe the tokens never need to be 
appended to auth_user_request in the first place?

Alternatively, A-&gt;absorb(B) could be altered to remove any notes from A 
that have the same keys as B's notes, before using appendNewOnly() to 
merge them?

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001350.html">[squid-users] Debugging slow access
</A></li>
	<LI>Next message (by thread): <A HREF="001351.html">[squid-users] Debugging slow access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1348">[ date ]</a>
              <a href="thread.html#1348">[ thread ]</a>
              <a href="subject.html#1348">[ subject ]</a>
              <a href="author.html#1348">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
