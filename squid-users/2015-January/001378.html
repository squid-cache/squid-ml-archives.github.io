<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3C54AF2B06.6030505%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001377.html">
   <LINK REL="Next"  HREF="001428.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Memory%20Leak%20Squid%203.4.9%20on%20FreeBSD%2010.0%20x64&In-Reply-To=%3C54AF2B06.6030505%40treenet.co.nz%3E"
       TITLE="[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jan  9 01:12:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001377.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
        <LI>Next message (by thread): <A HREF="001428.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1378">[ date ]</a>
              <a href="thread.html#1378">[ thread ]</a>
              <a href="subject.html#1378">[ subject ]</a>
              <a href="author.html#1378">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 9/01/2015 8:10 a.m., Doug Sampson wrote:
&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I have the similar problem on FreeBSD 10.1-STABLE #1 r275861
</I>&gt;&gt;<i> with squid-3.4.10. I also applied MEMPOOLS=1 when starting squid.
</I>&gt;&gt;<i> I experience the process slowing down and unacceptable
</I>&gt;&gt;<i> performance.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Squid is configured to use kerberos and ntlm authentication and
</I>&gt;&gt;<i> lap group authentication. other settings:
</I>&gt;&gt;<i> 
</I>
~14 MB for Squid process memory.

&gt;&gt;<i> cache_replacement_policy heap LFUDA cache_mem 4096 MB
</I>
+ 4096 MB for RAM cache
+ 60 MB for RAM cache index

&gt;&gt;<i> maximum_object_size 32 MB cache_dir diskd /usr/local/squid/cache
</I>&gt;&gt;<i> 32768 32 256
</I>
+ 540 MB for disk cache index

+ (600 * 16 * 0.5) MB for each active client connection state.
  ==&gt; 4800 MB

  NP: modern web browsers open up to 8 parallel connections to load a
page (&quot;happy eyeballs&quot; makes that 16 TCP sockets) per client ==&gt; ~8 MB
per active client.

Grand total:
  =&gt; 9.5 GB of RAM just for Squid.

.. then there is whatever memory the helper programs, other software
on the server and operating system all need.


&gt;&gt;<i> 
</I>&gt;&gt;<i> I have seen the following errors in cache.log:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> FATAL: Received Segment Violation...dying. FATAL: Received Bus
</I>&gt;&gt;<i> Error...dying.
</I>
need a backtrace to tell what the &quot;Segment Violation&quot; is about.

&quot;Bus Error&quot; is your CPU or RAM futzing up. The OS or hardware is
broken. Quite possibly this is the result of runnign out of RAM and
swap space.

&gt;&gt;<i> 
</I>&gt;&gt;<i> after this the squid restarts. The system has 10GB of memory and
</I>&gt;&gt;<i> is working as internal cache for ~600 users.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Please point me in the right direction. I have no problem
</I>&gt;&gt;<i> running squid33-3.3.13 on FreeBSD 9.3-STABLE #0 r270210.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thank you very much.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> lk
</I>&gt;<i> 
</I>&gt;<i> Man, I empathize with you. Have you tried running Squid 3.4.x on
</I>&gt;<i> FreeBSD 9.3? Sometimes I wonder if it's FreeBSD 10.x that's causing
</I>&gt;<i> the issue...
</I>&gt;<i> 
</I>&gt;<i> I tried the shell variable MEMPOOLS=1 and that quickly made the
</I>&gt;<i> situation a lot worse. Swap space would get filled up very quickly
</I>&gt;<i> and the system would slow down quickly before crashing.
</I>&gt;<i> 
</I>
All MEMPOOLS=1 does is make Squid internally recycle the memory that
gets free'd. Re-using it for other objects of the same type that are
allocated right after its free'd. So new memory only gets allocated
once the recycling &quot;pool&quot; for an object type is empty, everything
allocated so far actively in use.

The main point of using MEMPOOLS=1 is a debugging aid to track down
leaks, by a) reduced OS allocator calls making frequent ones obvious,
and b) the mgr:mem report more clearly listing what objects are being
free'd (chunked pool contains recycled objects) and which are not
(pool always empty).



Steve Hill has come up with some patches that resolve memory issues
with the new 3.4 helper annotations feature when using Negotiate or
NTMLM auth helpers. For authenticated clients with long connection
times or high traffic volumes the state can accumulate up to quite
large amounts of memory. see the &quot;Debugging slow proxy&quot; thread of
earlier this week.

HTH
Amos

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUrysEAAoJELJo5wb/XPRjFFMH/RNhVzPWfFixDDarpHUFQMoE
6QLkaD5wwQfRp3xfBW/QfZ9vvu04zptFOvNr4766jGsh9RSGZdNZwgPc9pCADDrv
Xs0HCO1VDMxGoBjFfaS2XJ5DLX2zQdbYlZKb0yghxXSYzg0ZZEhmsKO8r1Exp8j7
KO95yP3z/8agmwXbU2sJ1esqRC7IfW2sF/DtU8cPTzUf0cKEyjGoCbVrNAN1qKUH
jLf1iw8sNr3xGwFG/WmQmKpYTsXInSp4GmwXgCSQ0T5DCLVDtWuvnXpobxR8iuSW
zIX/CDKTe58lfVP4EXdzJNBgiuEiVZaRccynbk2L8HRvJ8kt9Pk50P5tWXM5FMw=
=lv6G
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001377.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
	<LI>Next message (by thread): <A HREF="001428.html">[squid-users] Memory Leak Squid 3.4.9 on FreeBSD 10.0 x64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1378">[ date ]</a>
              <a href="thread.html#1378">[ thread ]</a>
              <a href="subject.html#1378">[ subject ]</a>
              <a href="author.html#1378">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
