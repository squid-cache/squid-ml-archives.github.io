<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issues with CMS Redirects and Squid as Reverse Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20CMS%20Redirects%20and%20Squid%20as%20Reverse%0A%20Proxy&In-Reply-To=%3C54C0798D.7070105%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001630.html">
   <LINK REL="Next"  HREF="001638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issues with CMS Redirects and Squid as Reverse Proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20CMS%20Redirects%20and%20Squid%20as%20Reverse%0A%20Proxy&In-Reply-To=%3C54C0798D.7070105%40treenet.co.nz%3E"
       TITLE="[squid-users] Issues with CMS Redirects and Squid as Reverse Proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 22 04:16:13 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001630.html">[squid-users] Issues with CMS Redirects and Squid as Reverse Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="001638.html">[squid-users] FATAL: The ssl_crtd helpers are crashing too rapidly,	need help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1632">[ date ]</a>
              <a href="thread.html#1632">[ thread ]</a>
              <a href="subject.html#1632">[ subject ]</a>
              <a href="author.html#1632">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 22/01/2015 10:41 a.m., John Gardner wrote:
&gt;<i> We have a Squid 3.4 server configured as a Reverse Proxy on Oracle 
</I>&gt;<i> Linux 6.  It is working correctly for most sites, those which are
</I>&gt;<i> HTTP all the way through to the peer, Those which are HTTPS all the
</I>&gt;<i> way through to the peer and those which have SSL offloaded at the
</I>&gt;<i> external interface on Squid.  We have however come across a problem
</I>&gt;<i> when using a proprietary Content Management System.  In this CMS,
</I>&gt;<i> you set each page to show how it should be served i.e. HTTP or
</I>&gt;<i> HTTPS.  If traffic comes into the CMS with HTTP and it's set for
</I>&gt;<i> HTTPS, the CMS tries to re-write/force the URL so that it comes
</I>&gt;<i> back with <A HREF="https://">https://</A> at the start.
</I>&gt;<i> 
</I>&gt;<i> The problem is that, this appears to come through Squid as an 
</I>&gt;<i> indefinite loop and the page fails.  When connecting a Browser 
</I>&gt;<i> directly to the CMS server, and using the same site and page
</I>&gt;<i> settings, it works, but when going through squid, it doesn't.  Now,
</I>&gt;<i> I'm willing to believe that the CMS is affecting the HTTP traffic
</I>&gt;<i> so that it is not strict and that Squid then fails as it it doesn't
</I>&gt;<i> know how to handle it, but I thought I would post here and see if
</I>&gt;<i> anyone could help.
</I>&gt;<i> 
</I>&gt;<i> Our config is the following (with obfuscation);
</I>&gt;<i> 
</I>&gt;<i> http_port 10.x.x.42:80 accel defaultsite=server_2.bl.co.uk 
</I>&gt;<i> https_port 10.x.x.42:443 accel
</I>&gt;<i> cert=/usr/newrprgate/CertAuth/www/s.crt 
</I>&gt;<i> key=/usr/newrprgate/CertAuth/www/southtynesidehomes_key.pem 
</I>&gt;<i> cipher=ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:RC4+RSA:+HIGH:+MEDIUM 
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3 defaultsite=server_2.bl.co.uk cache_peer
</I>&gt;<i> 10.x.x.202 parent 80 0 no-query originserver name=server_2_http 
</I>&gt;<i> cache_peer 10.x.x.202 parent 443 0 no-query originserver
</I>&gt;<i> login=PASS connection-auth=on ssl 
</I>&gt;<i> sslcert=/usr/newrprgate/CertAuth/www/peer_keys/www.pem
</I>&gt;<i> sslversion=1 sslflags=DONT_VERIFY_PEER front-end-https
</I>&gt;<i> name=server_2_https acl sites_server_2 dstdomain www.s.org.uk 
</I>&gt;<i> cache_peer_access server_2_http allow sites_server_2 
</I>&gt;<i> cache_peer_access server_2_https allow sites_server_2 
</I>&gt;<i> cache_peer_access server_2_http deny all cache_peer_access
</I>&gt;<i> server_2_https deny all
</I>
For a backend CMS like that you need to add protocol type to the peer
selection criteria:

 acl HTTPS proto HTTPS

 cache_peer_access server_2_http allow sites_server_2 !HTTPS
 cache_peer_access server_2_http deny all

 cache_peer_access server_2_https allow sites_server_2 HTTPS
 cache_peer_access server_2_https deny all


PS. It is long past time to seriously look at verifying the peer
connection traffic. All you need is to set sslcafile= (or sslcapath=
if there are multiple) with the peer CA cert and drop the sslversion=1
and sslflags=DONT_VERIFY_PEER parameters.


Amos
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2.0.22 (MingW32)

iQEcBAEBAgAGBQJUwHmNAAoJELJo5wb/XPRjUFEIAKHLNgt+nceH49NHYVGWFifJ
jXZPihncq76xquM9Qe2rUMnW7TqW1jxNmyrofScx0l1chlm2GX8xYcPh72E0cog8
p0XEBt/D0Q0ydaN5PDa5ouDY2gJVps2lTeLY5/nmciBZbzlMW5tzwiL0fAkyYVSf
MdP8tn2TM1sC8cdMHMZ6aIu79/h9RbqslFlOoqaNa1yrH4PefIp3Csoa28CnrZ2B
WHtQN4eI0zsYvGNEvOI2gWBlK3ygQCf9ks3T9Df3n6MBglldsu44CcA7/zDdXW+G
iSdUXSw17M0gZUTMN1jf77ehf8FGKxBtiqqU1FzO2Yswucuqz4RvxPP32J+ZcEI=
=lA68
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001630.html">[squid-users] Issues with CMS Redirects and Squid as Reverse Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="001638.html">[squid-users] FATAL: The ssl_crtd helpers are crashing too rapidly,	need help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1632">[ date ]</a>
              <a href="thread.html#1632">[ thread ]</a>
              <a href="subject.html#1632">[ subject ]</a>
              <a href="author.html#1632">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
