<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] tcp_outgoing_address and ICAP server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20and%20ICAP%20server&In-Reply-To=%3C54C40305.1090408%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001686.html">
   <LINK REL="Next"  HREF="001689.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] tcp_outgoing_address and ICAP server</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20and%20ICAP%20server&In-Reply-To=%3C54C40305.1090408%40urlfilterdb.com%3E"
       TITLE="[squid-users] tcp_outgoing_address and ICAP server">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Sat Jan 24 20:39:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001686.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
        <LI>Next message (by thread): <A HREF="001689.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1687">[ date ]</a>
              <a href="thread.html#1687">[ thread ]</a>
              <a href="subject.html#1687">[ subject ]</a>
              <a href="author.html#1687">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 01/24/2015 10:15 AM, Amos Jeffries wrote:
&gt;<i> On 22/01/2015 10:11 a.m., Marcus Kool wrote:
</I>&gt;&gt;<i> I am using Squid 3.4.9 and have an issue with tcp_outgoing_address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Squid server is connceted to the internet with multiple NICs and uses
</I>&gt;&gt;<i>     tcp_outgoing_address a.public.IP.address
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and also want to use an ICAP server on the same host using
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> icap_service  reqmod_urlfilterdb   reqmod_precache
</I>&gt;&gt;<i> <A HREF="icap://a.local.ip.address:1344/reqmod_icapd">icap://a.local.ip.address:1344/reqmod_icapd</A>  bypass=off  routing=on
</I>&gt;&gt;<i> on-overload=wait ipv6=off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It seems that Squid binds the connection to the ICAP server the same way
</I>&gt;&gt;<i> it binds
</I>&gt;&gt;<i> connections to webservers using the rule with tcp_outgoing_address
</I>&gt;&gt;<i> and that it not desired nor workable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl myicaphost dst a.local.ip.address
</I>&gt;&gt;<i> tcp_outgoing_address a.public.IP.address !myicaphost
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but Squid issues the following errors:
</I>&gt;&gt;<i> 2015/01/21 21:58:32 kid1| WARNING: myicaphost ACL is used in context
</I>&gt;&gt;<i> without an HTTP request. Assuming mismatch.
</I>&gt;&gt;<i> 2015/01/21 21:58:32 kid1| commBind: Cannot bind socket FD 10 to
</I>&gt;&gt;<i> XX.XX.XX.XX: (99) Cannot assign requested address
</I>&gt;&gt;<i> 2015/01/21 21:58:32 kid1| essential ICAP service is down after an
</I>&gt;&gt;<i> options fetch failure: <A HREF="icap://XX.XX.XX.XX:1344/reqmod_icapd">icap://XX.XX.XX.XX:1344/reqmod_icapd</A> [down,!opt]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So the question is how to send web traffic over a specific NIC and
</I>&gt;&gt;<i> traffic to the ICAP server over an other (default?) NIC ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Please try the attached patch against Squid-3.4. It should make your
</I>&gt;<i> config work.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>
Thank you for the patch.
It resolves 1 issue: there is no longer the warning
    WARNING: myicaphost ACL is used in context without an HTTP request. Assuming mismatch.

But the binding to the wrong NIC with the external IP still happens:

2015/01/24 17:19:48.027 kid1| Xaction.cc(133) openConnection: Adaptation::Icap::OptXact opens connection to 10.10.0.6:1344
2015/01/24 17:19:48.027 kid1| AsyncCall.cc(18) AsyncCall: The AsyncCall Adaptation::Icap::Xaction::noteCommConnected constructed, this=0x1d9d7e0 [call53]
2015/01/24 17:19:48.027 kid1| comm.cc(549) comm_openex: comm_openex: Attempt open socket for: a.public.IP.address
2015/01/24 17:19:48.027 kid1| comm.cc(590) comm_openex: comm_openex: Opened socket local=a.public.IP.address remote=[::] FD 10 flags=1 : family=2, type=1, protocol=6

The firewall and routing was changed to allow traffic from the external IP to
the internal IP so for us the urgency of the issue is low, but
the binding remains on the external IP despite the ACL saying not to do it.

Marcus



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001686.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
	<LI>Next message (by thread): <A HREF="001689.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1687">[ date ]</a>
              <a href="thread.html#1687">[ thread ]</a>
              <a href="subject.html#1687">[ subject ]</a>
              <a href="author.html#1687">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
