<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] tcp_outgoing_address and ICAP server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20and%20ICAP%20server&In-Reply-To=%3C54C512D8.3060705%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001697.html">
   <LINK REL="Next"  HREF="001699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] tcp_outgoing_address and ICAP server</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20and%20ICAP%20server&In-Reply-To=%3C54C512D8.3060705%40urlfilterdb.com%3E"
       TITLE="[squid-users] tcp_outgoing_address and ICAP server">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Sun Jan 25 15:59:20 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001697.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
        <LI>Next message (by thread): <A HREF="001699.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1698">[ date ]</a>
              <a href="thread.html#1698">[ thread ]</a>
              <a href="subject.html#1698">[ subject ]</a>
              <a href="author.html#1698">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 01/25/2015 01:12 PM, Amos Jeffries wrote:
&gt;<i> On 25/01/2015 11:43 p.m., Marcus Kool wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 01/24/2015 11:24 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 25/01/2015 9:39 a.m., Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 01/24/2015 10:15 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> On 22/01/2015 10:11 a.m., Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I am using Squid 3.4.9 and have an issue with tcp_outgoing_address.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The Squid server is connceted to the internet with multiple NICs and
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> uses
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>       tcp_outgoing_address a.public.IP.address
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> and also want to use an ICAP server on the same host using
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> icap_service  reqmod_urlfilterdb   reqmod_precache
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="icap://a.local.ip.address:1344/reqmod_icapd">icap://a.local.ip.address:1344/reqmod_icapd</A>  bypass=off  routing=on
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> on-overload=wait ipv6=off
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> It seems that Squid binds the connection to the ICAP server the
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> same way
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> it binds
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> connections to webservers using the rule with tcp_outgoing_address
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> and that it not desired nor workable.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I tried
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> acl myicaphost dst a.local.ip.address
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> tcp_outgoing_address a.public.IP.address !myicaphost
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> but Squid issues the following errors:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2015/01/21 21:58:32 kid1| WARNING: myicaphost ACL is used in context
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> without an HTTP request. Assuming mismatch.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2015/01/21 21:58:32 kid1| commBind: Cannot bind socket FD 10 to
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> XX.XX.XX.XX: (99) Cannot assign requested address
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2015/01/21 21:58:32 kid1| essential ICAP service is down after an
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> options fetch failure: <A HREF="icap://XX.XX.XX.XX:1344/reqmod_icapd">icap://XX.XX.XX.XX:1344/reqmod_icapd</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> [down,!opt]
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> So the question is how to send web traffic over a specific NIC and
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> traffic to the ICAP server over an other (default?) NIC ?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Please try the attached patch against Squid-3.4. It should make your
</I>&gt;&gt;&gt;&gt;&gt;<i> config work.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thank you for the patch.
</I>&gt;&gt;&gt;&gt;<i> It resolves 1 issue: there is no longer the warning
</I>&gt;&gt;&gt;&gt;<i>      WARNING: myicaphost ACL is used in context without an HTTP request.
</I>&gt;&gt;&gt;&gt;<i> Assuming mismatch.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> But the binding to the wrong NIC with the external IP still happens:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 2015/01/24 17:19:48.027 kid1| Xaction.cc(133) openConnection:
</I>&gt;&gt;&gt;&gt;<i> Adaptation::Icap::OptXact opens connection to 10.10.0.6:1344
</I>&gt;&gt;&gt;&gt;<i> 2015/01/24 17:19:48.027 kid1| AsyncCall.cc(18) AsyncCall: The AsyncCall
</I>&gt;&gt;&gt;&gt;<i> Adaptation::Icap::Xaction::noteCommConnected constructed, this=0x1d9d7e0
</I>&gt;&gt;&gt;&gt;<i> [call53]
</I>&gt;&gt;&gt;&gt;<i> 2015/01/24 17:19:48.027 kid1| comm.cc(549) comm_openex: comm_openex:
</I>&gt;&gt;&gt;&gt;<i> Attempt open socket for: a.public.IP.address
</I>&gt;&gt;&gt;&gt;<i> 2015/01/24 17:19:48.027 kid1| comm.cc(590) comm_openex: comm_openex:
</I>&gt;&gt;&gt;&gt;<i> Opened socket local=a.public.IP.address remote=[::] FD 10 flags=1 :
</I>&gt;&gt;&gt;&gt;<i> family=2, type=1, protocol=6
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The firewall and routing was changed to allow traffic from the external
</I>&gt;&gt;&gt;&gt;<i> IP to
</I>&gt;&gt;&gt;&gt;<i> the internal IP so for us the urgency of the issue is low, but
</I>&gt;&gt;&gt;&gt;<i> the binding remains on the external IP despite the ACL saying not to
</I>&gt;&gt;&gt;&gt;<i> do it.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Aha, conceptual problem.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> tcp_outgoing_address does not forbid things. There is no &quot;allow/deny&quot;
</I>&gt;&gt;&gt;<i> action, just a set-IP action. It either sets the IP or it leaves it
</I>&gt;&gt;&gt;<i> alone.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you agree that the binding should not take place if a socket
</I>&gt;&gt;<i> is created with a destination address 'myicaphost' ?  The myicaphost is
</I>&gt;&gt;<i> 10.10.0.6 and the comm debug output above shows that the socket *is* bound.
</I>&gt;<i>
</I>&gt;<i> I cant agree because I dont know why it was binding.
</I>


The debug trace starts with:
Xaction.cc(133) openConnection: *Adaptation::Icap::OptXact* opens connection to 10.10.0.6:1344
and then
comm.cc(549) comm_openex: comm_openex: Attempt open socket for: *a.public.IP.address*
comm.cc(590) comm_openex: comm_openex:Opened socket local=*a.public.IP.address* remote=[::] FD 10 flags=1 : family=2, type=1, protocol=6

so I think it is clear that the socket to the ICAP server on 10.10.0.6
is bound to the NIC with an external IP address (not obeying the ACL).

I do not understand your statement &quot;I dont know why it was binding&quot;.

 &gt; Squid only uses
 &gt; bind() if there is an explicit outgoing address required to be used.

Have you considered the possibility of a bug ?

&gt;&gt;&gt;<i> Your rule sets the IP when the dst is non-myicaphost. So what
</I>&gt;&gt;&gt;<i> tcp_outgoing_address rule or OS level routing rule matches when it *is*
</I>&gt;&gt;&gt;<i> myicaphost?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry, I don't know which routing decision is taken. All I know is that
</I>&gt;&gt;<i> the routing has been changed to make the connection to the ICAP server
</I>&gt;&gt;<i> work.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried to show with the comm debug output that the connection to the
</I>&gt;&gt;<i> ICAP server (10.10.0.6) is still bound.  I replaced the public IP address
</I>&gt;&gt;<i> with &quot;a.public.IP.address&quot;  (I do not want to show the real IP but
</I>&gt;&gt;<i> it is definitely a public IP address).
</I>&gt;<i>
</I>&gt;<i> That obfuscation is fine, as long as its clear which IP is which.
</I>&gt;<i>
</I>&gt;<i> Perhapse a new debug trace after applying the patch will help resolve
</I>&gt;<i> what the remaining problem is?
</I>
The debug trace that I posted was after applying the patch.

Marcus

&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001697.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
	<LI>Next message (by thread): <A HREF="001699.html">[squid-users] tcp_outgoing_address and ICAP server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1698">[ date ]</a>
              <a href="thread.html#1698">[ thread ]</a>
              <a href="subject.html#1698">[ subject ]</a>
              <a href="author.html#1698">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
