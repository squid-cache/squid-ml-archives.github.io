<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Webpages won't load or load slowly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Webpages%20won%27t%20load%20or%20load%20slowly&In-Reply-To=%3C54CA41F3.7000707%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001791.html">
   <LINK REL="Next"  HREF="001794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Webpages won't load or load slowly</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Webpages%20won%27t%20load%20or%20load%20slowly&In-Reply-To=%3C54CA41F3.7000707%40treenet.co.nz%3E"
       TITLE="[squid-users] Webpages won't load or load slowly">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 29 14:21:39 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="001791.html">[squid-users] Webpages won't load or load slowly
</A></li>
        <LI>Next message (by thread): <A HREF="001794.html">[squid-users] Webpages won't load or load slowly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1793">[ date ]</a>
              <a href="thread.html#1793">[ thread ]</a>
              <a href="subject.html#1793">[ subject ]</a>
              <a href="author.html#1793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/01/2015 2:49 a.m., Rich549 wrote:
&gt;<i> Yuri Voinov wrote
</I>&gt;&gt;<i> And your access rules looks skew:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny BlacklistedSites StoresAllow
</I>&gt;&gt;<i> http_access allow OK_Unauthenticated
</I>&gt;&gt;<i> http_access allow StaticIPWhitelist
</I>&gt;&gt;<i> http_access allow InetAllow
</I>&gt;&gt;<i> http_access allow StoresAllow
</I>&gt;&gt;<i>
</I>
NP: He has the above rules instead of a localnet acess permission.

The worst part though is that since the above does not deny invalid user
credentials the following two lines...

&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow ftp
</I>&gt;&gt;<i> http_access allow CONNECT Safe_ports
</I>
... effectively make the proxy an open relay for any type of abuse
anybody on the Internet wants to spew through it.


&gt;&gt;<i> http_access allow manager localhost
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>
The above basic security checks are shuffled down here almost to the
end, which makes them almost ineffective...

&gt;&gt;<i> http_access deny all
</I>
... then a deny all&quot; which makes the security checks not only
ineffective but do nothing that would not have happened anyway. ie useless.


&gt;&gt;<i> http_reply_access allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Where is allow rule for internal networks?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Something like:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> We can access all of our local sites ok, is this required?
</I>
I reckon its a close call as to whether I could as well, using your
proxy. Just hinges on whether a TCP connection can be made from outside
your network to your Squid listening port.


To avoid that risk, order your http_access rules like this:


 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

 http_access deny BlacklistedSites StoresAllow

 http_access allow OK_Unauthenticated
 http_access allow StaticIPWhitelist

 acl login proxy_auth REQUIRED
 http_access deny !login

 http_access allow InetAllow
 http_access allow StoresAllow

 http_access allow localhost manager
 http_access deny all


Notice particularly how I moved the basic security checks up top again,
and erased the &quot;allow ftp&quot; and &quot;allow CONNECT&quot; lines.

The extra auth check is to catch and reject invalid login attempts
quickly without involving the external ACL helpers. It also helps with
some external ACL bugs we see had in some of the older versions.


If you encounter problems with people making legitimate CONNECT requests
to services with ports other than 443, please fix that by just adding
the ports to SSL_Ports ACL instead of moving the CONNECT security rule
around.
 That way they are still controlled by your auth, whitelist, and
blacklist policies.


&gt;<i> Any ideas about my original problem too? Or would updating to the latest
</I>&gt;<i> version be the fix for that?
</I>
The current releases are faster, they also have fixed a bug in the
handling of CONNECT requests which is triggered by modern web protocols
like HTTP/2, SPDY, and Websockets. Any one of which those websites you
listed may be attempting to use and failing on a timeout before getting
through with HTTP/1.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="001791.html">[squid-users] Webpages won't load or load slowly
</A></li>
	<LI>Next message (by thread): <A HREF="001794.html">[squid-users] Webpages won't load or load slowly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1793">[ date ]</a>
              <a href="thread.html#1793">[ thread ]</a>
              <a href="subject.html#1793">[ subject ]</a>
              <a href="author.html#1793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
