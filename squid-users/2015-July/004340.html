<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TProxy and client_dst_passthru
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3C559528CD.5020600%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004339.html">
   <LINK REL="Next"  HREF="004341.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TProxy and client_dst_passthru</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3C559528CD.5020600%40treenet.co.nz%3E"
       TITLE="[squid-users] TProxy and client_dst_passthru">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul  2 12:04:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004339.html">[squid-users] TProxy and client_dst_passthru
</A></li>
        <LI>Next message (by thread): <A HREF="004341.html">[squid-users] TProxy and client_dst_passthru
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4340">[ date ]</a>
              <a href="thread.html#4340">[ thread ]</a>
              <a href="subject.html#4340">[ subject ]</a>
              <a href="author.html#4340">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/07/2015 11:05 p.m., Stakres wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> 216.58.220.36 != www.google.com ??? 
</I>&gt;<i> Have a look: <A HREF="http://www.ip-adress.com/whois/216.58.220.36,">http://www.ip-adress.com/whois/216.58.220.36,</A> this is google.
</I>

www.google.com did not resolve to 216.58.220.36 when Squid checked.
Otherwise caching would have been allowed and ORIGINAL_DST not necessary.

Although that said the response was a 206 which does not cache anyway.


&gt;<i> 
</I>&gt;<i> Depending the DNS server used, the IP can change, we know that especialy due
</I>&gt;<i> to BGP.
</I>
The Google IPs given also change every 60-90 seconds no matter what DNS
server is used. Which is why its very important to have your clients
using the same DNS resolvers as Squid. So the IPs found by the client
are cached in the DNS resolver when Squid goes to check.

&gt;<i> 
</I>&gt;<i> In the case the client is an ISP providing internet to smaller ISPs with
</I>&gt;<i> different DNS with their end users, here I understand that due to the
</I>&gt;<i> ORIGINAL_DST squid will check the headers and if the dns records do not
</I>&gt;<i> match so squid will not cache, even with a storeid engine, because too many
</I>&gt;<i> different DNS servers in the loop (users -&gt; small ISP -&gt; big ISP -&gt; squid -&gt;
</I>&gt;<i> internet), am I right ?
</I>
Very likely yes.

&gt;<i> 
</I>&gt;<i> So, the result is a very poor 9% saving where we could expect around 50%
</I>&gt;<i> saving. 
</I>
Unfortunately that is the price for preventing any client script from
replacing the in-cache content with arbitrary content. A very nasty
vulenerability.

You can get around it somewhat by having the ISP resolvers use each
other same as proxy chains do.

&gt;<i> 
</I>&gt;<i> Can you plan, for a next build, a workaround to accept the original dns
</I>&gt;<i> record from the headers and check dns if and only if the headers do not
</I>&gt;<i> contain any dns record ?
</I>
That is exactly what ORIGINAL_DST is.

The client DNS lookup results in an IP being used by the client. Squid
takes that IP from the TCP packet and relays the traffic there. It just
cannot be cached because Squid cannot know if the reconstructed URL is a
client lie or not.

Consider some malicious server at 192.168.0.2 responding with an
infected JPG to all requests. An infected server contains a script that
fetches the Google icon from 192.168.0.2 using Host:www.google.com.

Now cache that as <A HREF="http://www.google.com/...">http://www.google.com/...</A> and what happens?


&gt;<i> I understand Squid should provide some securities but here we should have
</I>&gt;<i> the possibility to ON/OFF these securities.
</I>&gt;<i> Or do we need to downgrade to Squid 2.7/3.0 ?
</I>
You will hit the above vulnerability in older versions. And there *is*
malware out there actively abusing it since other proxies still contain it.

&gt;<i> 
</I>&gt;<i> ISPs need to cache a lot, security is not their main issue.
</I>
Understood. You can divert all traffic to a single kitten picture. That
will have a 100% HIT rate.

Then again, you need reliability of service as much as caching. This
ORIGINAL_DST mechanism it there to guarantee reliability in the face of
that vulnerability.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004339.html">[squid-users] TProxy and client_dst_passthru
</A></li>
	<LI>Next message (by thread): <A HREF="004341.html">[squid-users] TProxy and client_dst_passthru
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4340">[ date ]</a>
              <a href="thread.html#4340">[ thread ]</a>
              <a href="subject.html#4340">[ subject ]</a>
              <a href="author.html#4340">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
