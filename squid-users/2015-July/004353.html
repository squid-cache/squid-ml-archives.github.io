<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] New to Squid, Foward proxy problems with domain blocks.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20New%20to%20Squid%2C%0A%20Foward%20proxy%20problems%20with%20domain%20blocks.&In-Reply-To=%3C5595644D.3080005%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004349.html">
   <LINK REL="Next"  HREF="004356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] New to Squid, Foward proxy problems with domain blocks.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20New%20to%20Squid%2C%0A%20Foward%20proxy%20problems%20with%20domain%20blocks.&In-Reply-To=%3C5595644D.3080005%40treenet.co.nz%3E"
       TITLE="[squid-users] New to Squid, Foward proxy problems with domain blocks.">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul  2 16:18:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004349.html">[squid-users] New to Squid,	Foward proxy problems with domain blocks.
</A></li>
        <LI>Next message (by thread): <A HREF="004356.html">[squid-users] Setting logfile_daemon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4353">[ date ]</a>
              <a href="thread.html#4353">[ thread ]</a>
              <a href="subject.html#4353">[ subject ]</a>
              <a href="author.html#4353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/07/2015 3:29 a.m., Augusto Gabanzo wrote:
&gt;<i> Hello, as the subject says im new. 
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Been reading a lot and some examples and i do have a weird problem where i
</I>&gt;<i> can't block some domains. First and foremost im using the squid proxy for
</I>&gt;<i> windows version 2.7.8 
</I>&gt;<i> 
</I>&gt;<i> as thats the only one for windows that works for me the 3.x versions always
</I>&gt;<i> deny requests from clients even with the default conf. I've been testing all
</I>&gt;<i> this in a production enviroment so ... help me!! please of i will get killed
</I>&gt;<i> soon :D.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> my conf for 2.7.8 is(I modifying one that comes with proxy 3-1):
</I>
Don't. 2.7 contains no built-in defaults where 3.x does. The .conf file
contents need to be very different.


&gt;<i> pid_filename c:/Squid/var/logs/squid.pid (this part here i dont know whats
</I>&gt;<i> its use as i cant find info about it on the net)
</I>
&lt;<A HREF="http://www.squid-cache.org/Doc/config/pid_filename/">http://www.squid-cache.org/Doc/config/pid_filename/</A>&gt;

The PID is used for sending signals to the Squid process/service.

&gt;<i> 
</I>&gt;<i> #Limit upload to 2M and download to 10M (trying to stop users from uploading
</I>&gt;<i> big files to email sites and fb and download big files  as i only have 6mbps
</I>&gt;<i> and 1mbps down/up bandwidth)
</I>&gt;<i> 
</I>&gt;<i> request_body_max_size 2048 KB
</I>&gt;<i> 
</I>&gt;<i> reply_body_max_size 10485760 deny localnet
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # compressed (i moddief this part as instead of 0 they had 10080 and instead
</I>&gt;<i> of 10080 they had 999999 those times are too big files could stay forever
</I>&gt;<i> fresh! inside the cache)
</I>
&quot;forever&quot; in HTTP is &quot;no more than 68 years&quot;. In 2.7 thats 1 year.

And no, these lines only affect objects with are completely lacking
Cache-Control values. Most traffic has such controls and Squid obeys them.

Also, each refresh_pattern line has to be matched against a request
individually. Repeating many lines causes a lot of work to be done for
each request. Better to combine the patterns manually.


&gt;<i> 
</I>&gt;<i> acl fullvideo src &quot;c:/squid/etc/ipfullvideo.sq&quot;  # here is a file with ips
</I>&gt;<i> allowed to see youtube and facebook videos , media streaming 
</I>&gt;<i> 
</I>&gt;<i> acl bad_url url_regex -i &quot;c:/squid/etc/bad-sites.sq&quot; # .facebook.com
</I>&gt;<i> .twitter.com rule to block those sites for users inside ipbloqueada
</I>
So why is it a slow regex and not a fast dstdomain ?

&gt;<i> 
</I>&gt;<i> acl ipbloqueada src 192.168.1.117/32 192.168.1.179/32 192.168.1.170/32
</I>&gt;<i> 192.168.1.15/32  # ips of 3 users that shouldnt be accessing fb and twitter.
</I>&gt;<i> 
</I>&gt;<i> acl bad_ext urlpath_regex -i &quot;c:/squid/etc/extensiones.sq&quot; # rule to block
</I>&gt;<i> some file extesions like .avi$, .mpg$ etc stop downloads from them even if
</I>&gt;<i> they are smaller than 10MB (this doesn't WORK!)
</I>&gt;<i> 
</I>
The regex syntax mentioned assumes the URL ends with the file extension.
That is fairly uncommon. Most of the download sites these days the ext
is some dynamic script like .php or .asp. Using the content-type and
content-disposition headers to deliver the filename details.


&gt;<i> 
</I>&gt;<i> http_access allow localnet                                         #let the
</I>&gt;<i> network use the proxy
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost                                       #let the
</I>&gt;<i> proxy server use itself ??( O_o i dont quite get this part.)
</I>

Lets other software on the Squid server us it. Yes that includes the
proxy looping traffic back at tself, but the Via header protects against
that begin a problem.


&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> http_access deny bad_url ipbloqueada               #here i want all the urls
</I>&gt;<i> in BAD_URL from the ips IPBLOQUEADA to be denied used to work ... when i
</I>&gt;<i> started but now it doesnt i will show a sample of the file at the end
</I>
If I'm reding that comment on the ipbloqueada definition you are
assuming that Facebook, Twitter etc are still using plaintext HTTP
through the proxy. They dont. These days they use TLS with SPDY or
HTTP/2 or QUIC or HTTPS.


&gt;<i> 
</I>&gt;<i> http_access deny bad_ext                                        #block
</I>&gt;<i> reading of files with those extensions.
</I>&gt;<i> 
</I>&gt;<i> deny_info TCP_RESET bad_ext                                #send a tcp_reset
</I>&gt;<i> so they dont know proxy blocked them
</I>&gt;<i> 
</I>&gt;<i> http_reply_access deny media !fullvideo           # here i try to deny
</I>&gt;<i> access to media to all but those inside fullvideo (doesnt quite work either
</I>&gt;<i> youtube loads and works :D) some other streaming are blocked well
</I>&gt;<i> 
</I>
YT is HTTPS not HTTP now.


&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> #always_direct allow all                                              # i
</I>&gt;<i> feel this part is to let squidguard work, i removed it cuz it blocked
</I>&gt;<i> youtube  and many other sites i bet that was because the ads.
</I>&gt;<i> 
</I>
always_direct has no effect unless cache_peer directive is used. In
which case it makes the cache_peer not be used for traffic.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004349.html">[squid-users] New to Squid,	Foward proxy problems with domain blocks.
</A></li>
	<LI>Next message (by thread): <A HREF="004356.html">[squid-users] Setting logfile_daemon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4353">[ date ]</a>
              <a href="thread.html#4353">[ thread ]</a>
              <a href="subject.html#4353">[ subject ]</a>
              <a href="author.html#4353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
