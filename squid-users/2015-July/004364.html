<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TProxy and client_dst_passthru
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3C5596A975.2060903%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004363.html">
   <LINK REL="Next"  HREF="004367.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TProxy and client_dst_passthru</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3C5596A975.2060903%40treenet.co.nz%3E"
       TITLE="[squid-users] TProxy and client_dst_passthru">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul  3 15:25:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004363.html">[squid-users] TProxy and client_dst_passthru
</A></li>
        <LI>Next message (by thread): <A HREF="004367.html">[squid-users] TProxy and client_dst_passthru
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4364">[ date ]</a>
              <a href="thread.html#4364">[ thread ]</a>
              <a href="subject.html#4364">[ subject ]</a>
              <a href="author.html#4364">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/07/2015 1:21 a.m., Stakres wrote:
&gt;<i> Amos,
</I>&gt;<i> You told the Squid will check the original dns from the headers, then it'll
</I>&gt;<i> do its own dns resolution to verify they both match.
</I>&gt;<i> So, if no match, Squid does the request to internet based on the dns it
</I>&gt;<i> found.
</I>&gt;<i> If I'm right, that the current way, correct ?
</I>
Depends on what you mean by &quot;it found&quot;.

ORIGINAL_DST comes from TCP packet headers, which cannot be forged
without the packets going astray. Squid trusts it when in doubt.

Squid own DNS lookup is for the HTTP Host header value. To compare
against the TCP value. Host can be trivially forged. So neither Host nor
the DNS resulting from it can be trusted when in doubt.

&gt;<i> 
</I>&gt;<i> What we could do is the same way but as Squid has downloaded the object
</I>&gt;<i> based on its dns records, it means the object is correct, the right one. So,
</I>&gt;<i> keep all details from Squid job and push the object to the cache (if
</I>&gt;<i> cacheable).
</I>
When there is doubt about what server is correct there is no &quot;right&quot;
object. Squid relays the request to the place the client would have
reached had the proxy not been intercepting the traffic (ORIGINAL_DST).
Then prevents the unreliable object being given to other clients (cached).


There does seem to be one bug in that Squid will not always HIT on
existing cache content for the requested URL. Any help finding and
fixing that.


&gt;<i> 
</I>&gt;<i> user request -&gt; squid checks the dns is ok (corrects it if needed) -&gt; squid
</I>&gt;<i> download the right object and cache.
</I>&gt;<i> user request -&gt; squid checks the dns is ok (corrects it if needed) -&gt; squid
</I>&gt;<i> pushs from its cache.
</I>&gt;<i> 
</I>&gt;<i> Again, if Squid requests the right object based on its dns requests, it'll
</I>&gt;<i> deliver to clients the good one.
</I>&gt;<i> So, we should not see ORIGINAL_DST anymore...
</I>
Thats the CVE-2009-0801 problem. Whenever the Host header DNS is used
the proxy and all other clients fetching the cached URL from it, are
subject to malicious alterations made to that header.
Thus its only near-trustworthy when the DNS results contain the TCP dst-IP.

We let the request through to the ORIGINAL_DST to reduce penalty on the
client. But caching without the trust is going a bit too far.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004363.html">[squid-users] TProxy and client_dst_passthru
</A></li>
	<LI>Next message (by thread): <A HREF="004367.html">[squid-users] TProxy and client_dst_passthru
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4364">[ date ]</a>
              <a href="thread.html#4364">[ thread ]</a>
              <a href="subject.html#4364">[ subject ]</a>
              <a href="author.html#4364">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
