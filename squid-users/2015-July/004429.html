<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] transparent proxy splice using dstdomain issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20proxy%20splice%20using%20dstdomain%20issue&In-Reply-To=%3C559D1C32.4010507%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004415.html">
   <LINK REL="Next"  HREF="004409.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] transparent proxy splice using dstdomain issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20proxy%20splice%20using%20dstdomain%20issue&In-Reply-To=%3C559D1C32.4010507%40treenet.co.nz%3E"
       TITLE="[squid-users] transparent proxy splice using dstdomain issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul  8 12:48:50 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004415.html">[squid-users] transparent proxy splice using dstdomain issue
</A></li>
        <LI>Next message (by thread): <A HREF="004409.html">[squid-users] how to use client_delay_access without a named ACL ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4429">[ date ]</a>
              <a href="thread.html#4429">[ thread ]</a>
              <a href="subject.html#4429">[ subject ]</a>
              <a href="author.html#4429">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/07/2015 1:54 a.m., S.Kirschner wrote:
&gt;<i> Amos Jeffries wrote
</I>&gt;&gt;<i> On 7/07/2015 11:45 p.m., S.Kirschner wrote:
</I>&gt;&gt;&gt;<i> I think the issues exist because the reverse lookup dont got the anwser
</I>&gt;&gt;&gt;<i> &quot;sparkasse.de&quot;, but why it does not use the hostname from the dns request
</I>&gt;&gt;&gt;<i> to
</I>&gt;&gt;&gt;<i> the dns-server ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Because Squid is not a DNS server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The HTTP message details including URL where dstdomain comes from are
</I>&gt;&gt;<i> encrypted at the time you are trying to use the dstdomain ACL.
</I>&gt;<i> 
</I>&gt;<i> Yes but, in pfsense a dns server is installed, so on these host a dns server
</I>&gt;<i> is running. Also i tried to use the google DNS 
</I>
Location of the DNS resolver has nothing to do with how Squid (or DNS)
operates.


&gt;<i> 
</I>&gt;<i> Here now the entries from the cache.log
</I>&gt;<i> 
</I>&gt;<i> With sparkasse.de in /etc/hosts
</I>&gt;<i> #2015/06/19 14:03:03.907 kid1| DomainData.cc(108) match: aclMatchDomainList:
</I>&gt;<i> checking '212.34.69.3'
</I>&gt;<i> #2015/06/19 14:03:03.907 kid1| DomainData.cc(113) match: aclMatchDomainList:
</I>&gt;<i> '212.34.69.3' NOT found
</I>&gt;<i> #2015/06/19 14:03:03.908 kid1| DomainData.cc(108) match: aclMatchDomainList:
</I>&gt;<i> checking 'sparkasse.de'
</I>&gt;<i> #2015/06/19 14:03:03.908 kid1| DomainData.cc(113) match: aclMatchDomainList:
</I>&gt;<i> 'sparkasse.de' found
</I>
These are the rDNS host name in your hosts file for that IP.

In DNS hosts file entries are authoritative and override any gobal
registrations.


&gt;<i> #2015/06/19 14:03:03.908 kid1| Acl.cc(158) matches: checked: bypass = 1
</I>&gt;<i> #2015/06/19 14:03:03.908 kid1| Acl.cc(158) matches: checked: (ssl_bump rule)
</I>&gt;<i> = 1
</I>&gt;<i> #2015/06/19 14:03:03.908 kid1| Acl.cc(158) matches: checked: (ssl_bump
</I>&gt;<i> rules) = 1
</I>&gt;<i> 
</I>&gt;<i> Without sparkasse.de in /etc/hosts
</I>&gt;<i> #2015/06/19 14:05:19.842 kid1| DomainData.cc(108) match: aclMatchDomainList:
</I>&gt;<i> checking '212.34.69.3'
</I>&gt;<i> #2015/06/19 14:05:19.842 kid1| DomainData.cc(113) match: aclMatchDomainList:
</I>&gt;<i> '212.34.69.3' NOT found
</I>&gt;<i> #2015/06/19 14:05:19.842 kid1| DomainData.cc(108) match: aclMatchDomainList:
</I>&gt;<i> checking 'rev-212.34.69.3.rev.izb.net'
</I>&gt;<i> #2015/06/19 14:05:19.842 kid1| DomainData.cc(113) match: aclMatchDomainList:
</I>&gt;<i> 'rev-212.34.69.3.rev.izb.net' NOT found
</I>
The real host name registered in global rDNS for that IP.

If I assume you configured Squid to use the pfsense DNS resolver. That
is the hostname it presents Squid with for that IP.

Note that domain name and host name are different concepts...
* one domain name DNS entry possibly points at multiple IPs, and
* multiple domain names can possibly point at one IP, but
* each IP rDNS points at exactly one host name.

So,
 212.34.69.3 is one of possibly many IPs for sparkasse.de.
 sparkasse.de is one of may names pointing at 212.34.69.3.


But, rev-212.34.69.3.rev.izb.net is the host name for 212.34.69.3.
 (which also means rev-212.34.69.3.rev.izb.net is the primary one of may
names pointing at 212.34.69.3).


Problem: since that IP has many domain names pointing at it. Which one
did the user lookup in *forward* DNS to get to that IP address?

 They could have as easily gone to <A HREF="https://rev-212.34.69.3.rev.izb.net/">https://rev-212.34.69.3.rev.izb.net/</A>
as to <A HREF="https://sparkasse.de/">https://sparkasse.de/</A> and the TCP connection would look identical
to Squid.


When dealing with HTTP (not encrypted) the answer is to look at the HTTP
message headers and see what they are requesting. dstdomain does that.

 BUT ... in HTTPS those headers are encrypted. And you are currently
deciding whether or not its appropriate to try and decrypt at all.

 Meaning the HTTP URL domain used by dstdomain is unavailable, and thus
dstdomain will not work properly.


&gt;<i> #2015/06/19 14:05:19.842 kid1| Acl.cc(158) matches: checked: bypass = 0
</I>&gt;<i> #2015/06/19 14:05:19.842 kid1| Acl.cc(158) matches: checked: (ssl_bump rule)
</I>&gt;<i> = 0
</I>&gt;<i> 
</I>
The proper solution for HTTPS is to use the correct ACL type
(&quot;ssl::server_name&quot;) designed for use in your situation. That uses the
non-encrypted TLS metadata, which provides the server hostname.


Despite popular myths TLS is not end-to-end (user-to-origin). It is
point-to-point (client-to-server) encryption, with maybe multiple hops
along the way.

The TLS server name metadata will only give you the hostname of the
server the client was contacting. With SNI it is usually (but no
guarantee) the domain name. When SNI is not available it's down to TLS
certificate SubjectName that could as easily be a TLS proxy or CDN
service in front of the real server(s) and in fact its usually states a
whole list of alternative names, and regex patterns!! of domain names,
which the cert might be used for.

The definitions for Site, Domain name, host name (note the space),
hostname, and X.509 SubjectName are different for good reasons. So are
the ACL definitions.

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004415.html">[squid-users] transparent proxy splice using dstdomain issue
</A></li>
	<LI>Next message (by thread): <A HREF="004409.html">[squid-users] how to use client_delay_access without a named ACL ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4429">[ date ]</a>
              <a href="thread.html#4429">[ thread ]</a>
              <a href="subject.html#4429">[ subject ]</a>
              <a href="author.html#4429">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
