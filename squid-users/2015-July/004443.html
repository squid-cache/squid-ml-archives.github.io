<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid + kerberos, all childrens are busy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20kerberos%2C%20all%20childrens%20are%20busy&In-Reply-To=%3C559E6C3E.5030004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004442.html">
   <LINK REL="Next"  HREF="004491.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid + kerberos, all childrens are busy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20kerberos%2C%20all%20childrens%20are%20busy&In-Reply-To=%3C559E6C3E.5030004%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid + kerberos, all childrens are busy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul  9 12:42:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004442.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
        <LI>Next message (by thread): <A HREF="004491.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4443">[ date ]</a>
              <a href="thread.html#4443">[ thread ]</a>
              <a href="subject.html#4443">[ subject ]</a>
              <a href="author.html#4443">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/07/2015 10:32 p.m., &#1044;&#1084;&#1080;&#1090;&#1088;&#1080;&#1081; &#1056;&#1091;&#1082;&#1072;&#1074;&#1094;&#1086;&#1074; wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> &#1063;&#1077;&#1090;&#1074;&#1077;&#1088;&#1075;,  9 &#1080;&#1102;&#1083;&#1103; 2015, 22:06 +12:00 &#1086;&#1090; Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 9/07/2015 9:54 p.m., &#1044;&#1084;&#1080;&#1090;&#1088;&#1080;&#1081; &#1056;&#1091;&#1082;&#1072;&#1074;&#1094;&#1086;&#1074; wrote:
</I>&gt;&gt;&gt;&gt;<i>  Hello, i have a problem here :) System - freebsd 10.1, squid 3.5.5 + kerberos (MIT), 50 users total.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Without any auth my squid works fine, system is not loaded. When i enable Kerberos auth internet slowly goes down and crushing after a while, at logs i see:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 2015/07/09 11:47:14 kid1| WARNING: All 60/60 negotiateauthenticator processes are busy. 
</I>&gt;&gt;&gt;&gt;<i> 2015/07/09 11:47:14 kid1| WARNING: 72 pending requests queued
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So 50 users / 60 helpers ... how many requests per second? and how
</I>&gt;&gt;&gt;<i> fast/slow is the helper responding?
</I>&gt;<i> Could you clarify how I can get value of requests per second and respond?
</I>
The cachemgr &quot;info&quot; report. From the cachemgr.cgi tool, or &quot;squidclient
mgr:info&quot; command line, or
<A HREF="http://$visible_hostname:3128/squid-internal-mgr/info">http://$visible_hostname:3128/squid-internal-mgr/info</A>

 Or calculated from a quick count of the access.log lines over a few mins.



&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If i put 100 childrens at config it won't help too.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Please define &quot;wont help&quot;.
</I>&gt;<i> It will take more time, but all 100 will be busy too.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Server shutting down in like 7 mins, i can't even restart squid(system endless trying to kill squid PID), can't even make kill -9, not working (but system load is very low)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Can you please help me to find out what is wrong? Is there any way to monitor what happens with negotiate_kerberos_auth  processes ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -d helper parameter should log to cache.log what its doing.
</I>&gt;&gt;<i>
</I>&gt;<i> Debugs show like 3-4 message per second like:
</I>&gt;<i> 
</I>&gt;<i> negotiate_kerberos_pac.cc(376): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: INFO: Got PAC data of lengh 624
</I>&gt;<i> negotiate_kerberos_pac.cc(180): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: INFO: Found 5 rids
</I>&gt;<i> negotiate_kerberos_pac.cc(188): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: Info: Got rid: 513
</I>&gt;<i> negotiate_kerberos_pac.cc(188): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: Info: Got rid: 3692
</I>&gt;<i> negotiate_kerberos_pac.cc(188): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: Info: Got rid: 4268
</I>&gt;<i> negotiate_kerberos_pac.cc(188): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: Info: Got rid: 4622
</I>&gt;<i> negotiate_kerberos_pac.cc(188): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: Info: Got rid: 4623
</I>&gt;<i> negotiate_kerberos_pac.cc(256): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: INFO: Got DomainLogonId S-1-5-21-1708537768-1580818891-2146958067
</I>&gt;<i> negotiate_kerberos_pac.cc(278): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: INFO: Found 1 ExtraSIDs
</I>&gt;<i> negotiate_kerberos_pac.cc(327): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: INFO: Got ExtraSid S-1-5-21-1708537768-1580818891-2146958067-4107
</I>&gt;<i> negotiate_kerberos_pac.cc(456): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: INFO: Read 620 of 624 bytes
</I>&gt;<i> negotiate_kerberos_auth.cc(778): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: DEBUG: Groups group=AQUAAAAAAAUVAAAAqDfWZcthOV7z+vd/AQIAAA== group=AQUAAAAAAAUVAAAAqDfWZcthOV7z+vd/bA4AAA== group=AQUAAAAAAAUVAAAAqDfWZcthOV7z+vd/rBAAAA== group=AQUAAAAAAAUVAAAAqDfWZcthOV7z+vd/DhIAAA== group=AQUAAAAAAAUVAAAAqDfWZcthOV7z+vd/DxIAAA== group=AQUAAAAAAAUVAAAAqDfWZcthOV7z+vd/CxAAAA==
</I>&gt;<i> negotiate_kerberos_auth.cc(783): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: DEBUG: AF oYGyMIGvoAMKAQChCwYJKoZIgvcSAQICooGaBIGXYIGUBgkqhkiG9xIBAgICAG+BhDCBgaADAgEFoQMCAQ+idTBzoAMCAReibARqY4fSYtg+X4HhiH8dFmWxdn3wxtoKKZzEfUjLYibMoy0XAAWgkSYVXgC7gxO7cgCkOofEqZQhi/GKa4NZqn2dQqOJU/3y4zkPqBP9Ialh//BL5ov03L5BqjgthrbYbrcxJTo57EJIdO8O1g== avialex
</I>&gt;<i> 
</I>&gt;<i> And errors like:
</I>&gt;<i> 2015/07/09 13:28:03 kid1| ERROR: Negotiate Authentication validating user. Result: {result=BH, notes={message: received type 1 NTLM token; }}
</I>&gt;<i> All my friends get the same error, but their squid is working fine.
</I>&gt;<i> 
</I>&gt;<i> Don't see anything else
</I>&gt;<i> 
</I>
Aha. So your users browsers are sending NTLM auth instead of Kerberos.
That is at least one part of the problem. NTLM handshake can take whole
seconds and places a lot of extra load on the helpers. To resolve these
the users software needs fixing to use Kerberos properly when Negotiate
is offered.

The other part is figuring out what amount of helpers is needed to meet
the load requirements. With NTLM it is usually several hundred.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004442.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
	<LI>Next message (by thread): <A HREF="004491.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4443">[ date ]</a>
              <a href="thread.html#4443">[ thread ]</a>
              <a href="subject.html#4443">[ subject ]</a>
              <a href="author.html#4443">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
