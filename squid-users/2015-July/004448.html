<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Difference%20between%20Squid%203.1%20%26%203.4%20regarding%0A%20HTTPS%20CONNECT%20handling&In-Reply-To=%3C559ED9E0.4030004%40perpetualmotion.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004444.html">
   <LINK REL="Next"  HREF="004481.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling</H1>
    <B>Andrew Wood</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Difference%20between%20Squid%203.1%20%26%203.4%20regarding%0A%20HTTPS%20CONNECT%20handling&In-Reply-To=%3C559ED9E0.4030004%40perpetualmotion.co.uk%3E"
       TITLE="[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling">andrew at perpetualmotion.co.uk
       </A><BR>
    <I>Thu Jul  9 20:30:24 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004444.html">[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS	CONNECT handling
</A></li>
        <LI>Next message (by thread): <A HREF="004481.html">[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4448">[ date ]</a>
              <a href="thread.html#4448">[ thread ]</a>
              <a href="subject.html#4448">[ subject ]</a>
              <a href="author.html#4448">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>OK heres the difference

http_port 192.168.10.254:3128 intercept
http_port 192.168.10.254:3129

I had to setup squid on a second port not in intercept mode and set the 
WPAD file to send HTTPS requests there.

Why will the intercept port accept HTTPS CONNECT requests in 3.1 but not 
3.4?

Regards
Andrew

On 09/07/15 14:05, Andrew Wood wrote:
&gt;<i> Ive had Squid 3.1 running on a Debian 7 server for a couple of years 
</I>&gt;<i> working in intercept mode for HTTP traffic and using WPAD to force 
</I>&gt;<i> HTTPS to be CONNECT tunneled through Squid and it works fine.
</I>&gt;<i>
</I>&gt;<i> Im now trying to set up a similar system for someone else using Squid 
</I>&gt;<i> 3.4 which is the version in Debian 8. Everything is configured 
</I>&gt;<i> identically between the two as I copied the iptables rule file and the 
</I>&gt;<i> squid.conf file over, the only thing changed was the IP address ranges 
</I>&gt;<i> for the LAN
</I>&gt;<i>
</I>&gt;<i> HTTP intercept is working OK but HTTPS connect requests are being 
</I>&gt;<i> refused. Despite the fact that the WPAD file had been updated with the 
</I>&gt;<i> new IP address and is being served correctly from lighttpd.
</I>&gt;<i>
</I>&gt;<i> I can only conclude therefore that there is some difference between 
</I>&gt;<i> Squid 3.1 and 3.4 which means it no longer likes my configuration.
</I>&gt;<i>
</I>&gt;<i> Below is the Squid.conf file
</I>&gt;<i>
</I>&gt;<i> VLAN1 is the staff LAN with IP addresses 192.168.10 and VLAN2 is the 
</I>&gt;<i> public Wifi LAN with IP addresses 192.168.100
</I>&gt;<i>
</I>&gt;<i> Is there anything here in the squid file which Im doing wrong?
</I>&gt;<i>
</I>&gt;<i> Many thanks
</I>&gt;<i>
</I>&gt;<i> #squid.conf:
</I>&gt;<i>
</I>&gt;<i> #set which port to accept clients on &amp; which interfaces to accept 
</I>&gt;<i> clients on
</I>&gt;<i> http_port 192.168.10.254:3128 intercept
</I>&gt;<i> http_port 192.168.100.254:3128 intercept
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #set delay pool to do bandwidth throttling on VLAN2
</I>&gt;<i> delay_pools 1
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 250000/500000 125000/500000
</I>&gt;<i>
</I>&gt;<i> #ORd
</I>&gt;<i> acl AllUsers src all
</I>&gt;<i> acl ToSentryBoxVL1 dstdom_regex ^192.168.10.254$
</I>&gt;<i> acl ToWPADServer dstdom_regex ^wpad.commsmuseum.local$
</I>&gt;<i> acl ToPublicWiFiGateway dstdom_regex ^192.168.100.254$
</I>&gt;<i> acl PublicWiFiLAN src 192.168.100.0/24
</I>&gt;<i> acl PrivateLAN src 192.168.10.0/24
</I>&gt;<i> acl DestinedForPrivateLAN dst 192.168.10.0/24
</I>&gt;<i> acl DestinedForPublicWiFiLAN dst 192.168.100.0/24
</I>&gt;<i> acl ProhibitedSitesDomains dstdomain 
</I>&gt;<i> &quot;/var/squidblacklist.org/domains.squid&quot;
</I>&gt;<i> acl IPAddressForHostname dstdom_regex ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$
</I>&gt;<i> acl SafePorts port 80 443
</I>&gt;<i> acl SSLPorts port 443
</I>&gt;<i>
</I>&gt;<i> #block users tunneling
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny CONNECT !SSLPorts
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #disable caching
</I>&gt;<i> cache deny all
</I>&gt;<i>
</I>&gt;<i> #add VLAN2 to delay pool 1
</I>&gt;<i> delay_access 1 allow PublicWiFiLAN
</I>&gt;<i>
</I>&gt;<i> #force traffic coming in on VLAN2 to go out on VLAN2
</I>&gt;<i> tcp_outgoing_address 192.168.100.254 PublicWiFiLAN
</I>&gt;<i> tcp_outgoing_address 192.168.10.254 PrivateLAN
</I>&gt;<i>
</I>&gt;<i> #block traffic between VLAN1 &amp; VLAN2
</I>&gt;<i> #iptables does this for everything EXCEPT stuff coming through Squid
</I>&gt;<i> #because iptables sees stuff coming out of squid as originating from 
</I>&gt;<i> the localhost
</I>&gt;<i> #hence iptables FORWARD rules dont apply
</I>&gt;<i> http_access deny PublicWiFiLAN DestinedForPrivateLAN
</I>&gt;<i> http_access deny PrivateLAN DestinedForPublicWiFiLAN
</I>&gt;<i>
</I>&gt;<i> #show splash screen to new users on public wifi to show t&amp;c etc
</I>&gt;<i> #pass session length as arg to perl script cache +ve &amp; -ve responses 
</I>&gt;<i> for 0 secs so
</I>&gt;<i> #perl script is always called. Script is responsible for deciding how 
</I>&gt;<i> long a session is valid for
</I>&gt;<i> #%SRC passes client ip on stdin
</I>&gt;<i> external_acl_type currentsessiontype ttl=60 negative_ttl=0 %SRC 
</I>&gt;<i> /var/publicwifisessions/checksession.pl
</I>&gt;<i> acl currentsession external currentsessiontype
</I>&gt;<i>
</I>&gt;<i> #will stop on first of these which matches so watch order!
</I>&gt;<i> http_access deny ProhibitedSitesDomains
</I>&gt;<i> http_access allow ToPublicWiFiGateway
</I>&gt;<i> http_access allow ToSentryBoxVL1
</I>&gt;<i> http_access allow ToWPADServer
</I>&gt;<i> http_access deny CONNECT PublicWiFiLAN !currentsession
</I>&gt;<i> http_access deny PublicWiFiLAN !currentsession
</I>&gt;<i> http_access deny IPAddressForHostname
</I>&gt;<i> http_access deny !SafePorts
</I>&gt;<i> http_access allow PrivateLAN
</I>&gt;<i> http_access allow PublicWiFiLAN
</I>&gt;<i> http_access deny AllUsers
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004444.html">[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS	CONNECT handling
</A></li>
	<LI>Next message (by thread): <A HREF="004481.html">[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4448">[ date ]</a>
              <a href="thread.html#4448">[ thread ]</a>
              <a href="subject.html#4448">[ subject ]</a>
              <a href="author.html#4448">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
