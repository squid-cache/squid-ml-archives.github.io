<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Difference%20between%20Squid%203.1%20%26%203.4%20regarding%0A%20HTTPS%20CONNECT%20handling&In-Reply-To=%3C55A1D5A0.4010801%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004448.html">
   <LINK REL="Next"  HREF="004445.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Difference%20between%20Squid%203.1%20%26%203.4%20regarding%0A%20HTTPS%20CONNECT%20handling&In-Reply-To=%3C55A1D5A0.4010801%40treenet.co.nz%3E"
       TITLE="[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jul 12 02:49:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004448.html">[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling
</A></li>
        <LI>Next message (by thread): <A HREF="004445.html">[squid-users] Squid 3.5.6 build switches seem to not work.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4481">[ date ]</a>
              <a href="thread.html#4481">[ thread ]</a>
              <a href="subject.html#4481">[ subject ]</a>
              <a href="author.html#4481">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/07/2015 8:30 a.m., Andrew Wood wrote:
&gt;<i> OK heres the difference
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.10.254:3128 intercept
</I>&gt;<i> http_port 192.168.10.254:3129
</I>
You should have port 3128 for the non-interept traffic.

&gt;<i> 
</I>&gt;<i> I had to setup squid on a second port not in intercept mode and set the
</I>&gt;<i> WPAD file to send HTTPS requests there.
</I>&gt;<i> 
</I>&gt;<i> Why will the intercept port accept HTTPS CONNECT requests in 3.1 but not
</I>&gt;<i> 3.4?
</I>
3.2+ enforce the requirement that NAT is performed on the same machine
as Squid runs.

Explicit proxy traffic (from WPAD), naturally does not have NAT records
so will fail that requirement check. Thus separate ports are needed for
each of the different HTTP traffic types.

Please also check your intercept rules match
&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt; (or
the equivalent DNAT example). Specifically the *mangle* table rule
preventing external connections directly to the intercept port is very
important to prevent certain attacks that happen nowdays.


PS. Some hints on optimizing your config are inline below...

&gt;<i> On 09/07/15 14:05, Andrew Wood wrote:
</I>&gt;&gt;<i> #squid.conf:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #set which port to accept clients on &amp; which interfaces to accept
</I>&gt;&gt;<i> clients on
</I>&gt;&gt;<i> http_port 192.168.10.254:3128 intercept
</I>&gt;&gt;<i> http_port 192.168.100.254:3128 intercept
</I>&gt;&gt;<i>
</I>
No need for two ports. Its up to you, but I would do this:
  http_port 3129 intercept
  http_port 3128

Also, note the number of the intercept port should be random. It must
only ever receive traffic for the NAT sub-system so everything you can
do to obfusctae and prevent external connections getting directly to it
is good.


&gt;&gt;<i>
</I>&gt;&gt;<i> #set delay pool to do bandwidth throttling on VLAN2
</I>&gt;&gt;<i> delay_pools 1
</I>&gt;&gt;<i> delay_class 1 2
</I>&gt;&gt;<i> delay_parameters 1 250000/500000 125000/500000
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #ORd
</I>&gt;&gt;<i> acl AllUsers src all
</I>
Just use the built-in &quot;all&quot; and remove this definition entirely.

The only reason to custom-define an 'all' ACL is to attach a custom
deny_info page to it. You are not doing that.


&gt;&gt;<i> acl ToSentryBoxVL1 dstdom_regex ^192.168.10.254$
</I>&gt;&gt;<i> acl ToWPADServer dstdom_regex ^wpad.commsmuseum.local$
</I>&gt;&gt;<i> acl ToPublicWiFiGateway dstdom_regex ^192.168.100.254$
</I>
The above ACL are all used sequentially to allow access. You can
simplify (and speed up Squid a bit) by merging those three into one ACL
with three patterns.

Also, there is no need to regex them. Just use raw-IP address in the
dstdomain ACL type.

NP: since you have multicast .local DNS in use, you may want to turn on
Squid 3.4s multicast DNS support:
  dns_multicast_local on
 &lt;<A HREF="http://www.squid-cache.org/Doc/config/dns_multicast_local/">http://www.squid-cache.org/Doc/config/dns_multicast_local/</A>&gt;


&gt;&gt;<i> acl PublicWiFiLAN src 192.168.100.0/24
</I>&gt;&gt;<i> acl PrivateLAN src 192.168.10.0/24
</I>&gt;&gt;<i> acl DestinedForPrivateLAN dst 192.168.10.0/24
</I>&gt;&gt;<i> acl DestinedForPublicWiFiLAN dst 192.168.100.0/24
</I>&gt;&gt;<i> acl ProhibitedSitesDomains dstdomain
</I>&gt;&gt;<i> &quot;/var/squidblacklist.org/domains.squid&quot;
</I>&gt;&gt;<i> acl IPAddressForHostname dstdom_regex ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$
</I>
raw-IP can also come in IPv6 syntax, and sometimes may have a port
listed. *Even in IPv4-only traffic*

This pattern is better:
^(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(\[([0-9af]+)?:([0-9af:]+)?:([0-9af]+)?\]))(:[0-9]+)?$



&gt;&gt;<i> acl SSLPorts port 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #block users tunneling
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> http_access deny CONNECT !SSLPorts
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #disable caching
</I>&gt;&gt;<i> cache deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #add VLAN2 to delay pool 1
</I>&gt;&gt;<i> delay_access 1 allow PublicWiFiLAN
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #force traffic coming in on VLAN2 to go out on VLAN2
</I>&gt;&gt;<i> tcp_outgoing_address 192.168.100.254 PublicWiFiLAN
</I>&gt;&gt;<i> tcp_outgoing_address 192.168.10.254 PrivateLAN
</I>&gt;&gt;<i>
</I>
Those do not force anything. The iptables outgoing MASQUERADE rule will
replace those addresses with whatever iptables is configured with and is
a far better way to do what you seem to want anyway.

Also note that Debian packages of Squid are IPv6-enabled. So link-local
IPv6 connections may also exist on outbound. If you dont already have
ip6tables rules setup to manage that traffic properly to/from the VPN
its getting urgent.

 And ...

&gt;&gt;<i> #block traffic between VLAN1 &amp; VLAN2
</I>&gt;&gt;<i> #iptables does this for everything EXCEPT stuff coming through Squid
</I>&gt;&gt;<i> #because iptables sees stuff coming out of squid as originating from
</I>&gt;&gt;<i> the localhost
</I>&gt;&gt;<i> #hence iptables FORWARD rules dont apply
</I>&gt;&gt;<i> http_access deny PublicWiFiLAN DestinedForPrivateLAN
</I>&gt;&gt;<i> http_access deny PrivateLAN DestinedForPublicWiFiLAN
</I>
... THESE are the rules that actually prevent traffic crossover between
the subnets by Squid.

&gt;&gt;<i>
</I>&gt;&gt;<i> #show splash screen to new users on public wifi to show t&amp;c etc
</I>&gt;&gt;<i> #pass session length as arg to perl script cache +ve &amp; -ve responses
</I>&gt;&gt;<i> for 0 secs so
</I>&gt;&gt;<i> #perl script is always called. Script is responsible for deciding how
</I>&gt;&gt;<i> long a session is valid for
</I>&gt;&gt;<i> #%SRC passes client ip on stdin
</I>&gt;&gt;<i> external_acl_type currentsessiontype ttl=60 negative_ttl=0 %SRC
</I>&gt;&gt;<i> /var/publicwifisessions/checksession.pl
</I>&gt;&gt;<i> acl currentsession external currentsessiontype
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #will stop on first of these which matches so watch order!
</I>&gt;&gt;<i> http_access deny ProhibitedSitesDomains
</I>
&gt;&gt;<i> http_access allow ToPublicWiFiGateway
</I>&gt;&gt;<i> http_access allow ToSentryBoxVL1
</I>&gt;&gt;<i> http_access allow ToWPADServer
</I>
See above about these ACLs.

&gt;&gt;<i> http_access deny CONNECT PublicWiFiLAN !currentsession
</I>&gt;&gt;<i> http_access deny PublicWiFiLAN !currentsession
</I>
The above two lines overlap each other. You can remove the one with
&quot;CONNECT&quot; in it.


&gt;&gt;<i> http_access deny IPAddressForHostname
</I>&gt;&gt;<i> http_access deny !SafePorts
</I>&gt;&gt;<i> http_access allow PrivateLAN
</I>&gt;&gt;<i> http_access allow PublicWiFiLAN
</I>&gt;&gt;<i> http_access deny AllUsers
</I>
See above about this &quot;deny all&quot; customization.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004448.html">[squid-users] Difference between Squid 3.1 &amp; 3.4 regarding HTTPS CONNECT handling
</A></li>
	<LI>Next message (by thread): <A HREF="004445.html">[squid-users] Squid 3.5.6 build switches seem to not work.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4481">[ date ]</a>
              <a href="thread.html#4481">[ thread ]</a>
              <a href="subject.html#4481">[ subject ]</a>
              <a href="author.html#4481">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
