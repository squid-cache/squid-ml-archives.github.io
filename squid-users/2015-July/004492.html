<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid + kerberos, all childrens are busy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20kerberos%2C%20all%20childrens%20are%20busy&In-Reply-To=%3C55A40A0F.3060100%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004491.html">
   <LINK REL="Next"  HREF="004503.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid + kerberos, all childrens are busy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20kerberos%2C%20all%20childrens%20are%20busy&In-Reply-To=%3C55A40A0F.3060100%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid + kerberos, all childrens are busy">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jul 13 18:57:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004491.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
        <LI>Next message (by thread): <A HREF="004503.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4492">[ date ]</a>
              <a href="thread.html#4492">[ thread ]</a>
              <a href="subject.html#4492">[ subject ]</a>
              <a href="author.html#4492">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/07/2015 5:54 a.m., &#1044;&#1084;&#1080;&#1090;&#1088;&#1080;&#1081; &#1056;&#1091;&#1082;&#1072;&#1074;&#1094;&#1086;&#1074; wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt; Hello, i have a problem here :) System - freebsd 10.1, squid 3.5.5 + kerberos (MIT), 50 users total.
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt; Without any auth my squid works fine, system is not loaded. When i enable Kerberos auth internet slowly goes down and crushing after a while, at logs i see:
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt; 2015/07/09 11:47:14 kid1| WARNING: All 60/60 negotiateauthenticator processes are busy.
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt; 2015/07/09 11:47:14 kid1| WARNING: 72 pending requests queued
</I>&gt;<i>     &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i>     &gt;&gt;&gt;&gt;
</I>&gt;<i>     &gt;&gt;&gt;&gt; So 50 users / 60 helpers ... how many requests per second? and how
</I>&gt;<i>     &gt;&gt;&gt;&gt; fast/slow is the helper responding?
</I>&gt;<i>     &gt;&gt; Could you clarify how I can get value of requests per second and respond?
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;The cachemgr &quot;info&quot; report. From the cachemgr.cgi tool, or &quot;squidclient
</I>&gt;<i>     &gt;mgr:info&quot; command line, or
</I>&gt;<i>     &gt;<A HREF="http://$visible_hostname:3128/squid-internal-mgr/info">http://$visible_hostname:3128/squid-internal-mgr/info</A>
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; Or calculated from a quick count of the access.log lines over a few mins.
</I>&gt;<i> 
</I>&gt;<i>     ~600 lines per minute,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt;&gt; Debugs show like 3-4 message per second like:
</I>&gt;<i>     &gt;&gt;
</I>&lt;snip&gt;
&gt;<i>     &gt;&gt; negotiate_kerberos_auth.cc(783): pid=1456 :2015/07/09 13:26:48| negotiate_kerberos_auth: DEBUG: AF oYGyMIGvoAMKAQChCwYJKoZIgvcSAQICooGaBIGXYIGUBgkqhkiG9xIBAgICAG+BhDCBgaADAgEFoQMCAQ+idTBzoAMCAReibARqY4fSYtg+X4HhiH8dFmWxdn3wxtoKKZzEfUjLYibMoy0XAAWgkSYVXgC7gxO7cgCkOofEqZQhi/GKa4NZqn2dQqOJU/3y4zkPqBP9Ialh//BL5ov03L5BqjgthrbYbrcxJTo57EJIdO8O1g== avialex
</I>&gt;<i>     &gt;&gt;
</I>&gt;<i>     &gt;&gt; And errors like:
</I>&gt;<i>     &gt;&gt; 2015/07/09 13:28:03 kid1| ERROR: Negotiate Authentication validating user. Result: {result=BH, notes={message: received type 1 NTLM token; }}
</I>&gt;<i>     &gt;&gt; All my friends get the same error, but their squid is working fine.
</I>&gt;<i>     &gt;&gt;
</I>

Okay, so the traffic arriving at Squid is ~10 req/sec, and the helpers
are processing only 4 req/sec successfully.

If we assume that also each client connection is attempting one NTLM
request before it gets to Kerberos (when it should be doing the
opposite). That allows for the helper rejecting 3-4 req/sec.

That makes a total of up to 8 req/sec being handled by the helpers.
Still leaving 2 req/sec building up in the queue.


I see two problems there.

Firstly, 3-4 req/sec seems to be a very slow response rate by the
helpers. If you can find some way to improve that enough to stop the
queue building up your problem should go away.
 - that might be done by increasing the startup= helpers count (and
maximum count)
 - that might be by improving the helper connectivity speed and access
to DNS and the backend AD system.


Secondly, that NTLM issue. The only fix for that is to get the client
devices configured to try the more secure Kerberos auth first (like they
should be doing anyway).
 - that may require disabling NTLM entirely for them.



&gt;<i>     &gt;&gt; Don't see anything else
</I>&gt;<i>     &gt;&gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;Aha. So your users browsers are sending NTLM auth instead of Kerberos.
</I>&gt;<i>     &gt;That is at least one part of the problem. NTLM handshake can take whole
</I>&gt;<i>     &gt;seconds and places a lot of extra load on the helpers. To resolve these
</I>&gt;<i>     &gt;the users software needs fixing to use Kerberos properly when Negotiate
</I>&gt;<i> 
</I>&gt;<i>     &gt;is offered.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;The other part is figuring out what amount of helpers is needed to meet
</I>&gt;<i>     &gt;the load requirements. With NTLM it is usually several hundred.
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When i'm using proxy alone, squid stars 33 childrens, don't recive any NTLM errors, but internet start to lag. So the problem not in the NTLM software. I tryed to start 300 children for my 60 users, but still have huge lags, even when half was free.
</I>&gt;<i> 
</I>
I suggest For 60 users doing 10req/sec I suggest configuring Squid with:
 auth_param negotiate children 500 startup=120 idle=10


So what do you think the lag is coming from then?

And how are you defining &quot;free&quot; in terms of helpers?

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004491.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
	<LI>Next message (by thread): <A HREF="004503.html">[squid-users] Squid + kerberos, all childrens are busy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4492">[ date ]</a>
              <a href="thread.html#4492">[ thread ]</a>
              <a href="subject.html#4492">[ subject ]</a>
              <a href="author.html#4492">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
