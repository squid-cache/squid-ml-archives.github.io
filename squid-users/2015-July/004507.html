<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent proxy before NAT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20proxy%20before%20NAT&In-Reply-To=%3C55A4C5F7.9010109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004502.html">
   <LINK REL="Next"  HREF="004499.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent proxy before NAT</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20proxy%20before%20NAT&In-Reply-To=%3C55A4C5F7.9010109%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent proxy before NAT">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 14 08:19:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004502.html">[squid-users] Transparent proxy before NAT
</A></li>
        <LI>Next message (by thread): <A HREF="004499.html">[squid-users] Is it possible to tunnelize http traffic?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4507">[ date ]</a>
              <a href="thread.html#4507">[ thread ]</a>
              <a href="subject.html#4507">[ subject ]</a>
              <a href="author.html#4507">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/07/2015 8:34 a.m., John Pearson wrote:
&gt;<i> Thanks Yuri for the response, I understand. I do have Shorewall configured
</I>&gt;<i> and I understand the security implications. My Router is also the Wireless
</I>&gt;<i> AP, so I want to try out this setup without having to buy another Wireless
</I>&gt;<i> AP.
</I>&gt;<i> 
</I>&gt;<i> I don't mind it being complex, do you have any suggestions on getting
</I>&gt;<i> Internet &lt;---&gt; Squid &lt;---&gt; Router (NAT) working ?
</I>&gt;<i> 
</I>
You wont ever get that happening. The NAT intercept step between clients
and Squid must happen on the Squid device directly so Squid has access
to the kernel NAT mappings. This is not optional.


The best way if you are able to do it is to turn the Router into a plain
AP point. And the Squid device into router + NAT device.

Its easy enough to setup the Squid device with outgoing NAT rules same
as the router would have used. You can even do DHCP there as well if you
like.



The alternative is to go with the Squid device wired into the router so
traffic flow is:
 clients -&gt; Router (no NAT!) -&gt; Squid -&gt; Router (NAT) -&gt; Internet

&quot;Router&quot; can be one device if you have sufficient control over the
ebtables and iptables rules to split the pre-Squid and post-Squid packet
flows

But that has two big problems when only one router device is used:

 1) Most consumer grade wifi+modem+router devices and even some
commercial grade ones dont support the level of iptables config needed.

 2) With one router device the router&lt;-&gt;Squid NIC cards bandwidth
capacity is halved, since all traffic travels over it twice. Likewise
the router CPU cyces for networking are halved.


In both configs setup the clients with the Squid device static IP as
their gateway as Yuri said. The router just happens to be the path they
use to reach the Squid gateway device.

The first config Squid uses Internet uplink directly as its gateway, and
performs NAT MASQUERADE for outgoing traffic.

The second config the Squid device uses the Router as its gateway (same
as the clients would normally have done). Packets go to the Internet via
there.


Amos



&gt;<i> Thanks!
</I>&gt;<i> 
</I>&gt;<i> On Mon, Jul 13, 2015 at 1:33 PM, John Pearson &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">johnpearson555 at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Thanks Yuri for the response, I understand. I do have Shorewall configured
</I>&gt;&gt;<i> and I understand the security implications. My Router is also the Wireless
</I>&gt;&gt;<i> AP, so I want to try out this setup without having to buy another Wireless
</I>&gt;&gt;<i> AP.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don't mind it being complex, do you have any suggestions on getting
</I>&gt;&gt;<i> Internet &lt;---&gt; Squid &lt;---&gt; Router (NAT) working ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Jul 13, 2015 at 1:26 PM, Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;<i> Ah,
</I>&gt;<i> 
</I>&gt;<i> forgot about:
</I>&gt;<i> 
</I>&gt;<i> Your squid in scheme I wrote will have static gray IP. And this IP must
</I>&gt;<i> be excluded from DHCP pool on router.
</I>&gt;<i> 
</I>&gt;<i> 14.07.15 2:15, John Pearson &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hi Everyone,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> My setup is: Internet &lt;--&gt; Squid-eth0 &lt;--&gt; Squid-eth1 &lt;--&gt; Router &lt;--&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> Devices
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Currently the Router is doing NAT and DHCP for the devices connected to
</I>&gt;<i> it.
</I>&gt;&gt;&gt;&gt;&gt;<i> Squid is in transparent mode. I set up a bridge ( br0). I set up the
</I>&gt;&gt;&gt;&gt;&gt;<i> ebtables and iptables. It works but I want to figure out a way without
</I>&gt;&gt;&gt;&gt;&gt;<i> having to configure Squid server or Router with hardcoded addresses.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have it working with either setup:
</I>&gt;&gt;&gt;&gt;&gt;<i> 1. Remove the bridge ( br0) and setup the Squid server eth1 as a static
</I>&gt;<i> IP
</I>&gt;&gt;&gt;&gt;&gt;<i> address and set Squid server IP address as gateway in Router settings.
</I>&gt;&gt;&gt;&gt;&gt;<i> 2. Since Squid server is in bridge mode, I can hard code IP address in a
</I>&gt;&gt;&gt;&gt;&gt;<i> Squid ACL as all traffic appears to come this IP address from the
</I>&gt;<i> router.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I want a way to do this without any setup, basically to take a Squid box
</I>&gt;&gt;&gt;&gt;&gt;<i> and place it before a Router. Is there a way to do this ?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> A few ideas that might be wrong:
</I>&gt;&gt;&gt;&gt;&gt;<i> 1. In bridge mode, http_access allow CURRENTIPADDRESS  (
</I>&gt;<i> CURRENTIPADDRESS
</I>&gt;&gt;&gt;&gt;&gt;<i> is the dynamic IP address provided the ISP ) Is there a way to obtain
</I>&gt;<i> this
</I>&gt;&gt;&gt;&gt;&gt;<i> in the squid.conf file ?
</I>&gt;&gt;&gt;&gt;&gt;<i> 2. Setup a DHCP server alongside Squid server and have Squid(DHCP) &lt;--&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> Router(DHCP, NAT) and have same dhcp address given to the Router in
</I>&gt;&gt;&gt;&gt;&gt;<i> squid.conf as http_access allow localnet
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Thanks in advance!
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004502.html">[squid-users] Transparent proxy before NAT
</A></li>
	<LI>Next message (by thread): <A HREF="004499.html">[squid-users] Is it possible to tunnelize http traffic?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4507">[ date ]</a>
              <a href="thread.html#4507">[ thread ]</a>
              <a href="subject.html#4507">[ subject ]</a>
              <a href="author.html#4507">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
