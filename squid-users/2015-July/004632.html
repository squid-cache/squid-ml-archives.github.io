<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Redirects error for only some Citrix sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Redirects%20error%20for%20only%20some%20Citrix%20sites&In-Reply-To=%3C55ABCA4C.1040704%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004617.html">
   <LINK REL="Next"  HREF="004633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Redirects error for only some Citrix sites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Redirects%20error%20for%20only%20some%20Citrix%20sites&In-Reply-To=%3C55ABCA4C.1040704%40treenet.co.nz%3E"
       TITLE="[squid-users] Redirects error for only some Citrix sites">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jul 19 16:03:24 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004617.html">[squid-users] Redirects error for only some Citrix sites
</A></li>
        <LI>Next message (by thread): <A HREF="004633.html">[squid-users] Redirects error for only some Citrix sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4632">[ date ]</a>
              <a href="thread.html#4632">[ thread ]</a>
              <a href="subject.html#4632">[ subject ]</a>
              <a href="author.html#4632">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/07/2015 1:42 a.m., Laz C. Peterson wrote:
&gt;<i> Hello all,
</I>&gt;<i> 
</I>&gt;<i> Very weird issue here.  This happens to only select Citrix support articles.  (For example, <A HREF="http://support.citrix.com/article/CTX122972">http://support.citrix.com/article/CTX122972</A> &lt;<A HREF="http://support.citrix.com/article/CTX122972">http://support.citrix.com/article/CTX122972</A>&gt; when searching Google for &#8220;citrix netscaler expired password&#8221; which is the top link in my results, or also searching for the same article directly on Citrix support site.)
</I>&gt;<i> 
</I>&gt;<i> This is a new install of Squid 3 on Ubuntu 14.04.2 (from Ubuntu repository).  When clicking the Google link, I get &#8220;too many redirects&#8221; error, saying that possibly the page refers to another page that is then redirected back to the original page.
</I>&gt;<i> 
</I>&gt;<i> I tried debugging but did not find much useful information.  Has anyone else seen behavior like this?
</I>&gt;<i> 
</I>
The problem is the client fething URL X, gets a 30x redirect message
instructing it to contacts URL X instead (X being same URL X it *was*
fetching).

Usually that is a miconfiguration on the origin server itself. Fixable
only by the origin site authors. But there are also a few ways Squid can
play a part:

1) The 30x response pointing to itself (wrongly) really was generated by
the server and also explicitly stated that it should be cached [or you
configured Squid to force-cache].

Squid obeyed, and now you keep getting these loops. That will continue
until the cached content expires or is purged.


2) You are using Store-ID/Store-URL feature of Squid and did not check
that the URLs being merged were identical output. One of them produces a
302 redirect to X, which got cached. So now fetches for any URL in the
merged set (including the X itself) gets the cached 302 redirect back to X.
Again, that will continue until the cached content expires or is purged.


3) You are using a URL redirector that is generating the 302 response
loop. Usually redirectors with badly written (overly inclusive) regex
patterns causing similar behaviour to (2).


4) You are using a URL re-writer that is taking client request URL Y and
(wrongly) re-writing it to X. Squid fetches X from the backend server,
which replies with a redirect to Y (because Y != X). ... and loop.


5) You could be directing traffic using a cache_peer on port 80
regardless of <A HREF="http://">http://</A> or <A HREF="https://">https://</A> scheme received from the clients. If
the receiving peer/server emits a 302 for all traffic arriving on its
port 80 to a <A HREF="https://">https://</A> URL this sort of loop happens. Its a slightly more
complicated form of (4), using a cache_peer equivalent of URL re-writer.
 The best fix for that is at the server. RFC 7230 section 5.5 has an
algorithm for what compliant servers should be doing. Squids job is to
relay the request and URL unchanged.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004617.html">[squid-users] Redirects error for only some Citrix sites
</A></li>
	<LI>Next message (by thread): <A HREF="004633.html">[squid-users] Redirects error for only some Citrix sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4632">[ date ]</a>
              <a href="thread.html#4632">[ thread ]</a>
              <a href="subject.html#4632">[ subject ]</a>
              <a href="author.html#4632">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
