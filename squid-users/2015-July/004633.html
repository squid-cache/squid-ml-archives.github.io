<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Redirects error for only some Citrix sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Redirects%20error%20for%20only%20some%20Citrix%20sites&In-Reply-To=%3CF032BC13-1B70-4388-AFC2-22314C75C1FD%40paravis.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004632.html">
   <LINK REL="Next"  HREF="004618.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Redirects error for only some Citrix sites</H1>
    <B>Laz C. Peterson</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Redirects%20error%20for%20only%20some%20Citrix%20sites&In-Reply-To=%3CF032BC13-1B70-4388-AFC2-22314C75C1FD%40paravis.net%3E"
       TITLE="[squid-users] Redirects error for only some Citrix sites">laz at paravis.net
       </A><BR>
    <I>Sun Jul 19 16:22:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004632.html">[squid-users] Redirects error for only some Citrix sites
</A></li>
        <LI>Next message (by thread): <A HREF="004618.html">[squid-users] FATAL: xcalloc: Unable to allocate 18446744073527142243 blocks of 1 bytes!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4633">[ date ]</a>
              <a href="thread.html#4633">[ thread ]</a>
              <a href="subject.html#4633">[ subject ]</a>
              <a href="author.html#4633">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Wow thank you Amos for that information.

I must read, research, digest, read and then attempt to figure out what the problem is. :-)

Will be in touch if there are any further issues.  Thank you.

~ Laz Peterson
Paravis, LLC

&gt;<i> On Jul 19, 2015, at 9:03 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 18/07/2015 1:42 a.m., Laz C. Peterson wrote:
</I>&gt;&gt;<i> Hello all,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Very weird issue here.  This happens to only select Citrix support articles.  (For example, <A HREF="http://support.citrix.com/article/CTX122972">http://support.citrix.com/article/CTX122972</A> &lt;<A HREF="http://support.citrix.com/article/CTX122972">http://support.citrix.com/article/CTX122972</A>&gt; when searching Google for &#8220;citrix netscaler expired password&#8221; which is the top link in my results, or also searching for the same article directly on Citrix support site.)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> This is a new install of Squid 3 on Ubuntu 14.04.2 (from Ubuntu repository).  When clicking the Google link, I get &#8220;too many redirects&#8221; error, saying that possibly the page refers to another page that is then redirected back to the original page.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I tried debugging but did not find much useful information.  Has anyone else seen behavior like this?
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The problem is the client fething URL X, gets a 30x redirect message
</I>&gt;<i> instructing it to contacts URL X instead (X being same URL X it *was*
</I>&gt;<i> fetching).
</I>&gt;<i> 
</I>&gt;<i> Usually that is a miconfiguration on the origin server itself. Fixable
</I>&gt;<i> only by the origin site authors. But there are also a few ways Squid can
</I>&gt;<i> play a part:
</I>&gt;<i> 
</I>&gt;<i> 1) The 30x response pointing to itself (wrongly) really was generated by
</I>&gt;<i> the server and also explicitly stated that it should be cached [or you
</I>&gt;<i> configured Squid to force-cache].
</I>&gt;<i> 
</I>&gt;<i> Squid obeyed, and now you keep getting these loops. That will continue
</I>&gt;<i> until the cached content expires or is purged.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2) You are using Store-ID/Store-URL feature of Squid and did not check
</I>&gt;<i> that the URLs being merged were identical output. One of them produces a
</I>&gt;<i> 302 redirect to X, which got cached. So now fetches for any URL in the
</I>&gt;<i> merged set (including the X itself) gets the cached 302 redirect back to X.
</I>&gt;<i> Again, that will continue until the cached content expires or is purged.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 3) You are using a URL redirector that is generating the 302 response
</I>&gt;<i> loop. Usually redirectors with badly written (overly inclusive) regex
</I>&gt;<i> patterns causing similar behaviour to (2).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 4) You are using a URL re-writer that is taking client request URL Y and
</I>&gt;<i> (wrongly) re-writing it to X. Squid fetches X from the backend server,
</I>&gt;<i> which replies with a redirect to Y (because Y != X). ... and loop.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 5) You could be directing traffic using a cache_peer on port 80
</I>&gt;<i> regardless of <A HREF="http://">http://</A> or <A HREF="https://">https://</A> scheme received from the clients. If
</I>&gt;<i> the receiving peer/server emits a 302 for all traffic arriving on its
</I>&gt;<i> port 80 to a <A HREF="https://">https://</A> URL this sort of loop happens. Its a slightly more
</I>&gt;<i> complicated form of (4), using a cache_peer equivalent of URL re-writer.
</I>&gt;<i> The best fix for that is at the server. RFC 7230 section 5.5 has an
</I>&gt;<i> algorithm for what compliant servers should be doing. Squids job is to
</I>&gt;<i> relay the request and URL unchanged.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150719/d5de18b7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150719/d5de18b7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004632.html">[squid-users] Redirects error for only some Citrix sites
</A></li>
	<LI>Next message (by thread): <A HREF="004618.html">[squid-users] FATAL: xcalloc: Unable to allocate 18446744073527142243 blocks of 1 bytes!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4633">[ date ]</a>
              <a href="thread.html#4633">[ thread ]</a>
              <a href="subject.html#4633">[ subject ]</a>
              <a href="author.html#4633">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
