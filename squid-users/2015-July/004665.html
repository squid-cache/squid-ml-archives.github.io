<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid3: 100 % CPU load during object caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3C55AE3025.4010206%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004660.html">
   <LINK REL="Next"  HREF="004673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid3: 100 % CPU load during object caching</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3C55AE3025.4010206%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid3: 100 % CPU load during object caching">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 21 11:42:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004660.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
        <LI>Next message (by thread): <A HREF="004673.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4665">[ date ]</a>
              <a href="thread.html#4665">[ thread ]</a>
              <a href="subject.html#4665">[ subject ]</a>
              <a href="author.html#4665">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/07/2015 7:59 p.m., Jens Offenbach wrote:
&gt;<i> I am running Squid3 3.3.8 on Ubuntu 14.04. Squid3 has been installed from the Ubuntu package repository. In my scenario, Squid has to cache big files &gt;= 1 GB. At the moment, I am getting very bad transfer rates lower that 1 MB/sec. I have checked the connectivity using iperf3. It gives my a bandwith of 853 Mbits/sec between the nodes.
</I>&gt;<i> 
</I>&gt;<i> I have tried to investigate the problem and recognized that when there is no cache hit for a requested object, the Squid process reaches shortly after startup 100 % of one CPU core. The download rate drops down to 1 MB/sec. When I have a cache hit, I only get 30 MB/sec in my download.
</I>&gt;<i> 
</I>&gt;<i> Is there someting wrong with my config? I have already used Squid 3.3.14. I get the same result. Unfortunately, I was not able to build Squid 3.5.5 and 3.5.6.
</I>&gt;<i> 
</I>
Squid-3 is better able to cope with large objects than Squid-2 was. But
there are still significant problems.


Firstly, you only have space in memory for 4x 1GB objects. Total. if you
are dealing with such large objects at any regular frequency, you need
at least a much larger cache_mem setting.


Secondly, consider that Squid-3.3 places *all* active transactions into
cache_mem. 4GB of memory cache can store ~4 million x 1KB transactions,
or only 4 x 1GB transactions.

 If you have a cache full of small objects happily sitting in memory.
Then a requests for a 1GB object comes in, a hugh number of those small
objects need to be pushed out of memory cache onto disk, the memory
reallocated for use by the big one, and possibly 1GB object loaded from
disk into memory cache.

Then consider that GB sized object sitting in cache as it gets near to
being the oldest in memory. The next request is probably a puny little
0-1KB object, Squid may have to repeat all the GB size shufflings to and
from disk just to make memory space for that KB.

As you can imagine any one part of that process takes a lot of work and
time with a big object involved as compared to only small objects being
involved. The whole set of actions can be excruciatingly painful if the
proxy is busy.


Thirdly, you also only have 88GB of disk cache total. Neither that nor
the memory cache is sufficient to be trying to cache GB sized objects.
The tradeoff is whether one GB size object is going to get enough HITs
often enough to be worth not caching the million or so smaller objects
that could be taking its place. For most uses the tradeoff only makes
sense with high traffic on the large objects and/or TB of disk space.


My rule-of-thumb advice for caching is to keep it so that you can store
at least a few thousand maximum-sized objects at once in the allocated size.

So 4GB memory cache reasonable for 1MB size objects, 80GB disk cache is
reasonable for ~100MB sized objects.

That keeps almost all web page traffic able to be in memory, bigger but
popular media/video objects on disk. And the big things like Windows
Service Packs or whole DVD downloads get slower network fetches as
needed. If those latter are actually a problem for you get a bigger disk
cache, you *will* need it.


And a free audit for your config...


&gt;<i> Here is my squid.conf:
</I>&gt;<i> # ACCESS CONTROLS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   acl intranet    src 139.2.0.0/16
</I>&gt;<i>   acl intranet    src 193.96.112.0/21
</I>&gt;<i>   acl intranet    src 192.109.216.0/24
</I>&gt;<i>   acl intranet    src 100.1.4.0/22
</I>&gt;<i>   acl localnet    src 10.0.0.0/8
</I>&gt;<i>   acl localnet    src 172.16.0.0/12
</I>&gt;<i>   acl localnet    src 192.168.0.0/16
</I>&gt;<i>   acl localnet    src fc00::/7
</I>&gt;<i>   acl localnet    src fe80::/10
</I>&gt;<i>   acl to_intranet dst 139.2.0.0/16
</I>&gt;<i>   acl to_intranet dst 193.96.112.0/21
</I>&gt;<i>   acl to_intranet dst 192.109.216.0/24
</I>&gt;<i>   acl to_intranet dst 100.1.4.0/22
</I>&gt;<i>   acl to_localnet dst 10.0.0.0/8
</I>&gt;<i>   acl to_localnet dst 172.16.0.0/12
</I>&gt;<i>   acl to_localnet dst 192.168.0.0/16
</I>&gt;<i>   acl to_localnet dst fc00::/7
</I>&gt;<i>   acl to_localnet dst fe80::/10
</I>
The intended purpose behind the localnet and to_localnet ACLs is that
they are matching your intranet / LAN  / local network ranges.

The ones we distribute are just common standard ranges. You can simplify
your config by adding the intranet ranges to localnet and dropping all
the 'intranet' ACLs.

... BUT ...


&gt;<i>   http_access allow manager localhost
</I>&gt;<i>   http_access deny  manager
</I>&gt;<i>   http_access allow localnet
</I>&gt;<i>   http_access allow localhost
</I>&gt;<i>   http_access deny all
</I>
... noting how the intranet ACLs are not used to permit access through
the proxy. Maybe just dropping them entirely is better. If this is a
working proxy they are not being used.


&gt;<i> 
</I>&gt;<i> # NETWORK OPTIONS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   http_port 0.0.0.0:3128
</I>&gt;<i> 
</I>&gt;<i> # OPTIONS WHICH AFFECT THE NEIGHBOR SELECTION ALGORITHM
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   cache_peer proxy.mycompany.de parent 8080 0 no-query no-digest
</I>&gt;<i> 
</I>&gt;<i> # MEMORY CACHE OPTIONS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size_in_memory 1 GB
</I>&gt;<i>   memory_replacement_policy heap LFUDA
</I>&gt;<i>   cache_mem 4 GB
</I>&gt;<i> 
</I>&gt;<i> # DISK CACHE OPTIONS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size 10 GB
</I>&gt;<i>   cache_replacement_policy heap GDSF
</I>&gt;<i>   cache_dir aufs /var/cache/squid3 88894 16 256 max-size=10737418240
</I>&gt;<i> 
</I>&gt;<i> # LOGFILE OPTIONS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   access_log daemon:/var/log/squid3/access.log squid
</I>&gt;<i>   cache_store_log daemon:/var/log/squid3/store.log
</I>&gt;<i> 
</I>&gt;<i> # OPTIONS FOR TROUBLESHOOTING
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   cache_log /var/log/squid3/cache.log
</I>&gt;<i>   coredump_dir /var/log/squid3
</I>&gt;<i> 
</I>&gt;<i> # OPTIONS FOR TUNING THE CACHE
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   cache allow localnet
</I>&gt;<i>   cache allow localhost
</I>&gt;<i>   cache allow intranet
</I>&gt;<i>   cache deny  all
</I>
I think that does not do what you think.

The only traffic allowed to use this proxy (by http_access) is localnet
or localhost traffic.

Only traffic fetched by localnet or localhost cane be cached.
THerefore, all traffic allowed to go through this proxy can be cached.


You can simplify and speed up Squid a bit by removing the &quot;cache ...&quot;
ACLs entirely form your config. The default is &quot;allow all&quot;



&gt;<i>   refresh_pattern ^ftp:              1440    20%    10080
</I>&gt;<i>   refresh_pattern ^gopher:           1440     0%     1440
</I>&gt;<i>   refresh_pattern -i (/cgi-bin/|\?)     0     0%        0
</I>&gt;<i>   refresh_pattern .                     0    20%     4320
</I>&gt;<i> 
</I>&gt;<i> # HTTP OPTIONS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   via off
</I>&gt;<i> 
</I>&gt;<i> # ADMINISTRATIVE PARAMETERS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   cache_effective_user proxy
</I>&gt;<i>   cache_effective_group proxy
</I>&gt;<i> 
</I>
The above should all be unnecessary for 99.99% of Squid instalalations.
In which case you would explicitly not have added the proxy user to
unnecessary system groups anyway.


&gt;<i> # ICP OPTIONS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   icp_port 0
</I>&gt;<i> 
</I>&gt;<i> # OPTIONS INFLUENCING REQUEST FORWARDING 
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   nonhierarchical_direct on
</I>&gt;<i>   prefer_direct off
</I>&gt;<i>   always_direct allow to_localnet
</I>&gt;<i>   always_direct allow to_localhost
</I>&gt;<i>   always_direct allow to_intranet
</I>&gt;<i>   never_direct  allow all
</I>&gt;<i> 
</I>&gt;<i> # MISCELLANEOUS
</I>&gt;<i> # ----------------------------------------------------------------------------
</I>&gt;<i>   memory_pools off
</I>&gt;<i>   forwarded_for off
</I>
&lt;<A HREF="http://www.squid-cache.org/Versions/v3/3.3/cfgman/forwarded_for.html">http://www.squid-cache.org/Versions/v3/3.3/cfgman/forwarded_for.html</A>&gt;

Most Squid installations (and tuorials for very old Squid) using
&quot;forwarded_for off&quot; actually wanted to perform the action of &quot;truncate&quot;.
Remainign few cases wanted &quot;delete&quot;.

Ironicaly, revealing your clients LAN IPs is the *desirable* behaviour.
Since the purpose of XFF header is to allow sites like Wikipedia to
block individual malicious clients, without casting your entire network
into a traffic black hole. And client software with an interest in
privacy can alter the details it presents for the proxy to use in that
header - obfuscating their existance better than aggregating the proxy
traffic ready for trackers to use.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004660.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
	<LI>Next message (by thread): <A HREF="004673.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4665">[ date ]</a>
              <a href="thread.html#4665">[ thread ]</a>
              <a href="subject.html#4665">[ subject ]</a>
              <a href="author.html#4665">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
