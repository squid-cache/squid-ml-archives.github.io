<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid3: 100 % CPU load during object caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3C55AFE814.3020504%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004686.html">
   <LINK REL="Next"  HREF="004688.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid3: 100 % CPU load during object caching</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3C55AFE814.3020504%40ngtech.co.il%3E"
       TITLE="[squid-users] Squid3: 100 % CPU load during object caching">eliezer at ngtech.co.il
       </A><BR>
    <I>Wed Jul 22 18:59:32 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004686.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
        <LI>Next message (by thread): <A HREF="004688.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4687">[ date ]</a>
              <a href="thread.html#4687">[ thread ]</a>
              <a href="subject.html#4687">[ subject ]</a>
              <a href="author.html#4687">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Jens,

I have tested the issue with LARGE ROCK and not AUFS or UFS.
Using squid or not my connection to the server is about 2.5 MBps (20Mbps).
Squid is sitting on an intel atom with SSD drive and on a HIT case the 
download speed is more then doubled to 4.5 MBps(36Mbps).
I have not tried it with AUFS yet.

My testing machine is an ARCH linux with self compiled squid with the 
replacement of diskd to rock from the compilation options of arch linux.

You can take a look at the HIT log at:
<A HREF="http://paste.ngtech.co.il/pnhkglgsu">http://paste.ngtech.co.il/pnhkglgsu</A>

Eliezer

On 22/07/2015 21:07, Jens Offenbach wrote:
&gt;<i> I will send you my current settings tomorrow. I have used AUFS as caching format, but I have also tested UFS. The format seems to have no influence on the issue.
</I>&gt;<i>
</I>&gt;<i> I have tested the 1 GB Ubuntu 15.04 image (ubuntu-15.04-desktop-amd64.iso). This is the link <A HREF="http://releases.ubuntu.com/15.04/ubuntu-15.04-desktop-amd64.iso.">http://releases.ubuntu.com/15.04/ubuntu-15.04-desktop-amd64.iso.</A>
</I>&gt;<i>
</I>&gt;<i> If you want to stress caching more with large files. You can use one of those:
</I>&gt;<i> <A HREF="https://surfer.nmr.mgh.harvard.edu/fswiki/Download">https://surfer.nmr.mgh.harvard.edu/fswiki/Download</A>
</I>&gt;<i>
</I>&gt;<i> But I think the Centos 7 ISO are large enough, In my test scenario, I have put all files on an internal web server with gives them in stable 120 MB/sec. So the problem does not come from a slow network connection. I have checked network connectivity with Iperf3 (&gt;= 900 MBit/sec) and made a direct wget without Squid. The file gets downloaded in high speed. Adding Squid in the communication flow which caches the file on the first request and the issue occurrs. After some minutes, the download rate drops to 500 KByte/sec and stays on this level together with 100 % CPU load. The download rate corresponds with the disk IO. The file gets written with 500 KByte/sec.
</I>&gt;<i>
</I>&gt;<i> Thank you very much!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Gesendet: Mittwoch, 22. Juli 2015 um 18:28 Uhr
</I>&gt;<i> Von: &quot;Eliezer Croitoru&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Betreff: Re: [squid-users] Squid3: 100 % CPU load during object caching
</I>&gt;<i> Can you share the relevant squid.conf settings? Just to reproduce..
</I>&gt;<i>
</I>&gt;<i> I have a dedicated testing server here which I can test the issue on.
</I>&gt;<i> 8GB archive which might be an ISO and can be cached on AUFS\UFS and
</I>&gt;<i> LARGE ROCK cache types.
</I>&gt;<i>
</I>&gt;<i> I am pretty sure that the maximum cache object size is one thing to
</I>&gt;<i> change and waht more?
</I>&gt;<i>
</I>&gt;<i>  From What I understand it should not be different for 2GB cached
</I>&gt;<i> archive and to 8 GB cached archive.
</I>&gt;<i> I have a local copy of centos 7 ISO which should be a test worthy object.
</I>&gt;<i> Anything more you can add to the test subject?
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> On 22/07/2015 16:24, Jens Offenbach wrote:
</I>&gt;&gt;<i> I checked the bug you have mentioned and I think I am confronted with the same
</I>&gt;&gt;<i> issue. I was able to build and test Squid 3.5.6 on Ubuntu 14.04.2 x84_64. I
</I>&gt;&gt;<i> observed the same behavior. I have tested an 8 GB archive file and I get 100 %
</I>&gt;&gt;<i> CPU usage and a download rate of nearly 500 KB/sec when the object gets cached.
</I>&gt;&gt;<i> I have attached strace to the running process, but I killed it after 30 minutes.
</I>&gt;&gt;<i> The whole takes hours, although we have a 1-GBit ethernet:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Process 4091 attached
</I>&gt;&gt;<i> Process 4091 detached
</I>&gt;&gt;<i> % time seconds usecs/call calls errors syscall
</I>&gt;&gt;<i> ------ ----------- ----------- --------- --------- ----------------
</I>&gt;&gt;<i> 78.83 2.622879 1 1823951 write
</I>&gt;&gt;<i> 12.29 0.408748 2 228029 2 read
</I>&gt;&gt;<i> 6.18 0.205663 0 912431 1 epoll_wait
</I>&gt;&gt;<i> 2.58 0.085921 0 456020 epoll_ctl
</I>&gt;&gt;<i> 0.09 0.002919 0 6168 brk
</I>&gt;&gt;<i> 0.02 0.000623 2 356 openat
</I>&gt;&gt;<i> 0.01 0.000286 0 712 getdents
</I>&gt;&gt;<i> 0.00 0.000071 1 91 getrusage
</I>&gt;&gt;<i> 0.00 0.000038 0 362 close
</I>&gt;&gt;<i> 0.00 0.000003 2 2 sendto
</I>&gt;&gt;<i> 0.00 0.000001 0 3 1 recvfrom
</I>&gt;&gt;<i> 0.00 0.000000 0 2 open
</I>&gt;&gt;<i> 0.00 0.000000 0 3 stat
</I>&gt;&gt;<i> 0.00 0.000000 0 1 1 rt_sigreturn
</I>&gt;&gt;<i> 0.00 0.000000 0 1 kill
</I>&gt;&gt;<i> 0.00 0.000000 0 4 fcntl
</I>&gt;&gt;<i> 0.00 0.000000 0 2 2 unlink
</I>&gt;&gt;<i> 0.00 0.000000 0 1 getppid
</I>&gt;&gt;<i> ------ ----------- ----------- --------- --------- ----------------
</I>&gt;&gt;<i> 100.00 3.327152 3428139 7 total
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can I do anything that helps to get ride of this problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Gesendet: Dienstag, 21. Juli 2015 um 17:37 Uhr
</I>&gt;&gt;<i> Von: &quot;Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;<i> An: &quot;Jens Offenbach&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">wolle5050 at gmx.de</A>&gt;, &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&quot;
</I>&gt;&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> Betreff: Re: Aw: Re: [squid-users] Squid3: 100 % CPU load during object caching
</I>&gt;&gt;<i> On 22/07/2015 12:31 a.m., Jens Offenbach wrote:
</I>&gt;&gt;&gt;<i> Thank you very much for your detailed explainations. We want to use Squid in
</I>&gt;&gt;&gt;<i> order to accelerate our automated software setup processes via Puppet. Actually
</I>&gt;&gt;&gt;<i> Squid will host only a very short amount of large objects (10-20). Its purpose
</I>&gt;&gt;&gt;<i> is not to cache web traffic or little objects.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ah, Squid does not &quot;host&quot;, it caches. The difference may seem trivial at
</I>&gt;&gt;<i> first glance but it is the critical factor between whether a proxy or a
</I>&gt;&gt;<i> local web server is the best tool for the job.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  From my own experiences with Puppet, yes Squid is the right tool. But
</I>&gt;&gt;<i> only because the Puppet server was using relatively slow python code to
</I>&gt;&gt;<i> generate objects and not doing server-side caching on its own. If that
</I>&gt;&gt;<i> situation has changed in recent years then Squids usefulness will also
</I>&gt;&gt;<i> have changed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The hit-ratio for all the hosted
</I>&gt;&gt;&gt;<i> objects will be very high, because most of our VMs require the same software
</I>&gt;&gt;<i> stack.
</I>&gt;&gt;&gt;<i> I will update mit config regarding to your comments! Thanks a lot!
</I>&gt;&gt;&gt;<i> But actually I have still no idea, why the download rates are so unsatisfying.
</I>&gt;&gt;&gt;<i> We are sill in the test phase. We have only one client that requests a large
</I>&gt;&gt;&gt;<i> object from Squid and the transfer rates are lower than 1 MB/sec during cache
</I>&gt;&gt;&gt;<i> build-up without any form of concurrency. Have vou got an idea what could be the
</I>&gt;&gt;&gt;<i> source of the problem here? Why causes the Squid process 100 % CPU usage.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did not see any config causing the known 100% CPU bugs to be
</I>&gt;&gt;<i> encountered in your case (eg. HTTPS going through delay pools guarantees
</I>&gt;&gt;<i> 100% CPU). Which leads me to think its probably related to memory
</I>&gt;&gt;<i> shuffling. (&lt;<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3189">http://bugs.squid-cache.org/show_bug.cgi?id=3189</A>
</I>&gt;&gt;<i> &lt;<A HREF="https://3c.gmx.net/mail/client/dereferrer?redirectUrl=http%3A%2F%2Fbugs.squid-cache.org%2Fshow_bug.cgi%3Fid%3D3189[https://3c.gmx.net/mail/client/dereferrer?redirectUrl=http%3A%2F%2Fbugs.squid-cache.org%2Fshow_bug.cgi%3Fid%3D3189">https://3c.gmx.net/mail/client/dereferrer?redirectUrl=http%3A%2F%2Fbugs.squid-cache.org%2Fshow_bug.cgi%3Fid%3D3189[https://3c.gmx.net/mail/client/dereferrer?redirectUrl=http%3A%2F%2Fbugs.squid-cache.org%2Fshow_bug.cgi%3Fid%3D3189</A>]&gt;&gt;
</I>&gt;&gt;<i> appears
</I>&gt;&gt;<i> to be the same and still unidentified)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As for speed, if the CPU is maxed out by one particular action Squid
</I>&gt;&gt;<i> wont have time for much other work. So things go slow.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On the other hand Squid is also optimized for relatively high traffic
</I>&gt;&gt;<i> usage. For very small client counts (such as under-10) it is effectively
</I>&gt;&gt;<i> running in idle mode 99% of the time. The I/O event loop starts pausing
</I>&gt;&gt;<i> for 10ms blocks waiting to see if some more useful amount of work can be
</I>&gt;&gt;<i> done at the end of the wait. That can lead to apparent network slowdown
</I>&gt;&gt;<i> as TCP gets up to 10ms delay per packet. But that should not be visible
</I>&gt;&gt;<i> in CPU numbers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That said, 1 client can still max out Squid CPU and/or NIC throughput
</I>&gt;&gt;<i> capacity on a single request if its pushing/pulling packets fast enough.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you can attach the strace tool to Squid when its consuming the CPU
</I>&gt;&gt;<i> there might be some better hints about where to look.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users[http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users[http://lists.squid-cache.org/listinfo/squid-users</A>]
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users[http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users[http://lists.squid-cache.org/listinfo/squid-users</A>]
</I>&gt;<i>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004686.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
	<LI>Next message (by thread): <A HREF="004688.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4687">[ date ]</a>
              <a href="thread.html#4687">[ thread ]</a>
              <a href="subject.html#4687">[ subject ]</a>
              <a href="author.html#4687">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
