<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid3: 100 % CPU load during object caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3Ctrinity-5129c212-ce17-4826-9825-e17a171cebdf-1437632328442%403capp-gmx-bs71%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004688.html">
   <LINK REL="Next"  HREF="004690.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid3: 100 % CPU load during object caching</H1>
    <B>Jens Offenbach</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3Ctrinity-5129c212-ce17-4826-9825-e17a171cebdf-1437632328442%403capp-gmx-bs71%3E"
       TITLE="[squid-users] Squid3: 100 % CPU load during object caching">wolle5050 at gmx.de
       </A><BR>
    <I>Thu Jul 23 06:18:48 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004688.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
        <LI>Next message (by thread): <A HREF="004690.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4689">[ date ]</a>
              <a href="thread.html#4689">[ thread ]</a>
              <a href="subject.html#4689">[ subject ]</a>
              <a href="author.html#4689">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have not tested rock yet, but I will give it a try and will report the results as soon as possible.

I have tested Squid 3.5.6 in three different virtualized environments (VMware vSphere, OpenStack Icehouse, OpenStack Kilo).

For clarification:
The 100 % CPU usage and the low download speed occurs only when there is NO cache hit and when the object is added to disk cache FOR THE FIRST TIME. When the object is in the cache, the download speed and the CPU usage of Squid (3.3.8 and 3.5.6) is optimal. I have tested it with an Ubuntu ISO image (&gt;= 1 GB).

This is my current squid.config.

# ACCESS CONTROLS
# -----------------------------------------------------------------------------
  acl localnet    src 139.2.0.0/16
  acl localnet    src 193.96.112.0/21
  acl localnet    src 192.109.216.0/24
  acl localnet    src 100.1.4.0/22
  acl localnet    src 10.0.0.0/8
  acl localnet    src 172.16.0.0/12
  acl localnet    src 192.168.0.0/16
  http_access allow manager localhost
  http_access deny  manager
  http_access allow localnet
  http_access allow localhost
  http_access deny all

# NETWORK OPTIONS
# -----------------------------------------------------------------------------
  http_port 0.0.0.0:3128

# MEMORY CACHE OPTIONS
# -----------------------------------------------------------------------------
  maximum_object_size_in_memory 128 MB
  memory_replacement_policy heap LFUDA
  cache_mem 4 GB

# DISK CACHE OPTIONS
# -----------------------------------------------------------------------------
  maximum_object_size 10 GB
  cache_replacement_policy heap GDSF
  cache_dir aufs /var/cache/squid3 88894 16 256 max-size=10737418240

# LOGFILE OPTIONS
# -----------------------------------------------------------------------------
  access_log daemon:/var/log/squid3/access.log squid
  cache_store_log daemon:/var/log/squid3/store.log

# OPTIONS FOR TROUBLESHOOTING
# -----------------------------------------------------------------------------
  cache_log /var/log/squid3/cache.log
  coredump_dir /var/log/squid3
  
# OPTIONS FOR TUNING THE CACHE
# -----------------------------------------------------------------------------
  cache allow all
  
# OPTIONS INFLUENCING REQUEST FORWARDING 
# -----------------------------------------------------------------------------
  always_direct allow all

# MISCELLANEOUS
# -----------------------------------------------------------------------------
  memory_pools off


Thank you very much for your help! It is good to know that you will take care of my problem.

Regards,
Jens
&#160;

Gesendet:&#160;Mittwoch, 22. Juli 2015 um 21:47 Uhr
Von:&#160;&quot;Eliezer Croitoru&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
An:&#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Cc:&#160;&quot;Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
Betreff:&#160;Re: [squid-users] Squid3: 100 % CPU load during object caching
On 22/07/2015 21:59, Eliezer Croitoru wrote:
&gt;<i> Hey Jens,
</I>&gt;<i>
</I>&gt;<i> I have tested the issue with LARGE ROCK and not AUFS or UFS.
</I>&gt;<i> Using squid or not my connection to the server is about 2.5 MBps (20Mbps).
</I>&gt;<i> Squid is sitting on an intel atom with SSD drive and on a HIT case the
</I>&gt;<i> download speed is more then doubled to 4.5 MBps(36Mbps).
</I>&gt;<i> I have not tried it with AUFS yet.
</I>

And I must admit that AUFS beats rock cache with speed.
I have tried rock with basic &quot;cache_dir rock /var/spool/squid 8000&quot; vs
&quot;cache_dir aufs /var/spool/squid 8000 16 256&quot; and the aufs cache HIT
results more then doubles 3 the speed rock gave with default settings.

So about 15MBps which is 120Mbps.
I do not seem to feel what Jens feels but the 100% CPU might be because
of spinning disk hangs while reading the file from disk.

Amos, I remember that there were some suggestions how to tune large rock.
Any hints?
I can test it and make it a suggestion for big files.

Eliezer
&#160;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004688.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
	<LI>Next message (by thread): <A HREF="004690.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4689">[ date ]</a>
              <a href="thread.html#4689">[ thread ]</a>
              <a href="subject.html#4689">[ subject ]</a>
              <a href="author.html#4689">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
