<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid3: 100 % CPU load during object caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3C55B1F76D.3040800%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004725.html">
   <LINK REL="Next"  HREF="004742.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid3: 100 % CPU load during object caching</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid3%3A%20100%20%25%20CPU%20load%20during%20object%20caching&In-Reply-To=%3C55B1F76D.3040800%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid3: 100 % CPU load during object caching">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 24 08:29:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004725.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
        <LI>Next message (by thread): <A HREF="004742.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4728">[ date ]</a>
              <a href="thread.html#4728">[ thread ]</a>
              <a href="subject.html#4728">[ subject ]</a>
              <a href="author.html#4728">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/07/2015 7:49 p.m., Jens Offenbach wrote:
&gt;<i> I have found something out... Hopefully, it helps to reproduce and solve the issue. 
</I>&gt;<i> 
</I>&gt;<i> I got it working with a good download rate, but very high CPU usage on Squid 3.3.8 and Squid 3.5.6. There seems to be problem with large files that get cached on disk in combination with memory caching. When I use these settings, memory usage of Squid grows step-by-step with 100% CPU usage and 500 KB/sec download rate:
</I>&gt;<i> 
</I>&gt;<i> # MEMORY CACHE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size_in_memory 1 GB
</I>&gt;<i>   memory_replacement_policy heap LFUDA
</I>&gt;<i>   cache_mem 4 GB
</I>&gt;<i> 
</I>&gt;<i> # DISK CACHE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size 10 GB
</I>&gt;<i>   cache_replacement_policy heap GDSF
</I>&gt;<i>   cache_dir aufs /var/cache/squid3 25600 16 256
</I>&gt;<i> 
</I>&gt;<i> I decided to turn off memory caching completely and used the following settings:
</I>&gt;<i> 
</I>&gt;<i> # MEMORY CACHE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size_in_memory 0 GB
</I>&gt;<i>   memory_replacement_policy heap LFUDA
</I>&gt;<i>   cache_mem 0 GB
</I>&gt;<i> 
</I>&gt;<i> # DISK CACHE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size 10 GB
</I>&gt;<i>   cache_replacement_policy heap GDSF
</I>&gt;<i>   cache_dir aufs /var/cache/squid3 25600 16 256
</I>&gt;<i> 
</I>&gt;<i> Now, I get stable and high download rates even on a cache miss.
</I>&gt;<i> 
</I>
Damn. That gives me ~90% confidence its the mem_node walking as new 4KB
chunks of memory are appended to the memory copy of the object.


I would expect to see a reduced effect in 3.5 that kicks in around
maximum_object_size_in_memory. Since the memory copies are now split
into cache_mem objects, vs transients (disk cache only, or totally
non-cacheable). With the transients getting their unnecessary in-memory
sections pruned away regularly.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004725.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
	<LI>Next message (by thread): <A HREF="004742.html">[squid-users] Squid3: 100 % CPU load during object caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4728">[ date ]</a>
              <a href="thread.html#4728">[ thread ]</a>
              <a href="subject.html#4728">[ subject ]</a>
              <a href="author.html#4728">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
