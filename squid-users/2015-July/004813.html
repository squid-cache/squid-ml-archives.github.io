<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Investigating squid crash.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Investigating%20squid%20crash.&In-Reply-To=%3CCAJfE2f7ZZ-Pb51uDKV-2A3h_8K%2BiYVy28hnhp-pt6fOjGnrAOA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004808.html">
   <LINK REL="Next"  HREF="004801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Investigating squid crash.</H1>
    <B>The_Spider</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Investigating%20squid%20crash.&In-Reply-To=%3CCAJfE2f7ZZ-Pb51uDKV-2A3h_8K%2BiYVy28hnhp-pt6fOjGnrAOA%40mail.gmail.com%3E"
       TITLE="[squid-users] Investigating squid crash.">spider at smoothnet.org
       </A><BR>
    <I>Mon Jul 27 16:39:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004808.html">[squid-users] Investigating squid crash.
</A></li>
        <LI>Next message (by thread): <A HREF="004801.html">[squid-users] Investigating squid crash.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4813">[ date ]</a>
              <a href="thread.html#4813">[ thread ]</a>
              <a href="subject.html#4813">[ subject ]</a>
              <a href="author.html#4813">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The version numbering you have identified seems to coincide with my issues
as well. I moved to the newer versions of squid for the newer enhanced ssl
bumping features but ran into this issue. I was hoping my stacktrace would
finally allow the squid developers to identify and resolve the issue. What
your describing is an improper shutdown procedure. I&#8217;m using a custom
written system script to handle my squid process, and that may very well be
the issue. But I have also experienced the random crash issue on
configurations where no cache was configured.


*** Begin /etc/systemd/system/squid.service ***

[Unit]

Description=Squid caching proxy

After=syslog.target network.target nss-lookup.target


[Service]

Type=forking

EnvironmentFile=/etc/sysconfig/squid

ExecStart=/usr/sbin/squid $SQUID_OPTS -f $SQUID_CONF

ExecReload=/usr/sbin/squid $SQUID_OPTS -k reconfigure -f $SQUID_CONF

ExecStop=/usr/sbin/squid $SQUID_OPTS -k shutdown -f $SQUID_CONF

PIDFile=/var/run/squid.pid


[Install]

WantedBy=multi-user.target

*** End /etc/systemd/system/squid.service ***



*From:* squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] *On
Behalf Of *Stanford Prescott
*Sent:* Monday, July 27, 2015 9:44 AM
*To:* Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
*Cc:* squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
*Subject:* Re: [squid-users] Investigating squid crash.



The developers of Smoothwall Express v3.1 have been trying to address this
issue for a few days now. We have had users complaining of this same issue
with Squid 3.5.5 and 3.5.6. It didn't seem to happen with prior versions.
We (or at least our lead developer Neal Murphy) thinks it is related to
shutting down Squid with a single SIGTERM followed by a SIGKILL a few
seconds later (or just using squid -k shutdown) is causing squid to close
and exit before the swap.state file is written and saved. This causes a
corrupted swap.state file to exist when squid is restarted. When Squid
crashes, rebuilding the swap.state anew seems to fix the problem and Squid
can restart.

So, to fix the crashing problem, for us at least, seems to involve
redesigning the shutdown and restarting of squid. Neal has come up with a
process and scripts that seem to fix the issue, at least for low loads on
squid that typically are what our users use. Neal has run some tests on
higher loads and it seems to work as well for those environments as well,
but we are continuing to test. Here is a link to the discussion in the
Smoothwall community forums if anyone is interested.

<A HREF="http://community.smoothwall.org/forum/viewtopic.php?p=340353#p340353">http://community.smoothwall.org/forum/viewtopic.php?p=340353#p340353</A>



On Sun, Jul 26, 2015 at 3:53 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

On 26/07/2015 5:09 p.m., The_Spider wrote:
&gt;<i> To anyone willing to assist.
</I>&gt;<i>
</I>&gt;<i> My Squid continues to crash for some un-known reason only giving
</I>&gt;<i> 'FATAL: Received Segment Violation...dying.' I have attached a copy of
</I>&gt;<i> the cache log with the crash occurring and output debugging.
</I>&gt;<i>
</I>&gt;<i> Aparently I'm not the first to experience this, but I have yet to find
</I>&gt;<i> any documentation on how to resolve this issue. This is not unique to
</I>&gt;<i> one single machine, it happens on a few different boxes with similar
</I>&gt;<i> configuration, I have not been able to identify what configuration
</I>&gt;<i> parameter has been causing the issue.
</I>&gt;<i>
</I>
Please follow the steps for obtaining a traceback as outlined at
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#crashes_and_core_dumps">http://wiki.squid-cache.org/SquidFaq/BugReporting#crashes_and_core_dumps</A>&gt;

For SEGFAULT errors that is the only easy way to identify what the
problem is. Trial-and-error can take a very, very long time.


As for the config. You certainly have a thing for regex. Most if not all
of the dstdom_regex patterns would be far better written as dstdomain ACLs.

Although note that neither dstdomain nor dstdom_regex work properly in
the ssl_bump directive lines. Use &quot;ssl::server_name&quot; ACL for those checks.



&gt;<i> I will attempt to provide any information possible to help resolve
</I>&gt;<i> this issue. Hopefully this is a good start.
</I>&gt;<i>
</I>&gt;<i> cache.log = <A HREF="http://filebin.ca/29vS8jkEfskt/cache.log">http://filebin.ca/29vS8jkEfskt/cache.log</A>
</I>&gt;<i>
</I>&gt;<i> squid -v:
</I>&gt;<i> Squid Cache: Version 3.5.6-20150725-r13869
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--prefix=/usr' '--exec-prefix=/usr'
</I>&gt;<i> '--includedir=/usr/include' '--datadir=/usr/share'
</I>&gt;<i> '--libdir=/usr/lib64' '--libexecdir=/usr/lib64/squid'
</I>&gt;<i> '--localstatedir=/var' '--sysconfdir=/etc/squid'
</I>&gt;<i> '--sharedstatedir=/var/lib' '--with-logdir=/var/log/squid'
</I>&gt;<i> '--with-pidfile=/var/run/squid.pid' '--with-default-user=squid'
</I>&gt;<i> '--enable-silent-rules' '--enable-dependency-tracking'
</I>&gt;<i> '--with-openssl' '--enable-icmp' '--enable-delay-pools'
</I>&gt;<i> '--enable-useragent-log'
</I>
--enable-useragent-log no longer exists.

&gt;<i> '--enable-esi'
</I>&gt;<i> '--enable-follow-x-forwarded-for' '--enable-auth'
</I>&gt;<i> --enable-ltdl-convenience
</I>&gt;<i>
</I>&gt;<i> cat /etc/redhat-release
</I>&gt;<i> CentOS Linux release 7.1.1503 (Core)
</I>&gt;<i>
</I>
Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150727/fbfbdbef/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150727/fbfbdbef/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004808.html">[squid-users] Investigating squid crash.
</A></li>
	<LI>Next message (by thread): <A HREF="004801.html">[squid-users] Investigating squid crash.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4813">[ date ]</a>
              <a href="thread.html#4813">[ thread ]</a>
              <a href="subject.html#4813">[ subject ]</a>
              <a href="author.html#4813">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
