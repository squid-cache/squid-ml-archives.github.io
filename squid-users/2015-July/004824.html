<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Possible bug in 3.5.5 or a store change from 2.7?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20bug%20in%203.5.5%20or%20a%20store%20change%20from%202.7%3F&In-Reply-To=%3CCAEaSS0aBfNq8upzz39O-PJt0kCyNsxGhFqGi%2Bsu_ybdZ1GLnFA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004842.html">
   <LINK REL="Next"  HREF="004827.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Possible bug in 3.5.5 or a store change from 2.7?</H1>
    <B>Tory M Blue</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20bug%20in%203.5.5%20or%20a%20store%20change%20from%202.7%3F&In-Reply-To=%3CCAEaSS0aBfNq8upzz39O-PJt0kCyNsxGhFqGi%2Bsu_ybdZ1GLnFA%40mail.gmail.com%3E"
       TITLE="[squid-users] Possible bug in 3.5.5 or a store change from 2.7?">tmblue at gmail.com
       </A><BR>
    <I>Tue Jul 28 17:53:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004842.html">[squid-users] please help me test ext_ldap_group_acl from command line
</A></li>
        <LI>Next message (by thread): <A HREF="004827.html">[squid-users] Possible bug in 3.5.5 or a store change from 2.7?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4824">[ date ]</a>
              <a href="thread.html#4824">[ thread ]</a>
              <a href="subject.html#4824">[ subject ]</a>
              <a href="author.html#4824">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>squid-3.5.5-1.el6.x86_64

CentOS 6.6

 This looks like a bug in Squid v3 or a difference from 2.7.  Our monitor
couldn't be simpler.  It requests the SAME URL twice (identical in every
way, same hostname too), and expects the 2nd response to contain the
X-Squid hit header.  If it does not, then Squid has some sort of race
condition going on its code.

 I just reproduced this by hand, using an HTTP sniffer tool.  I requested
the same URL twice, with about a 0.25 second delay between fetches, and the
2nd attempt was ALSO A MISS.  Then I waited 1 second and tried a 3rd time,
and it was FINALLY a hit.

Squid v3 seems to have changed the way it stores objects.  Maybe it is
doing some sort of &quot;asynchronous&quot; background store now, so if you send in
sequential requests without a delay between, it may not actually have
finished storing it yet, so it doesn't report a &quot;hit&quot;.  Meaning, the first
&quot;miss&quot; response may have fired off a thread to store the object, and not
doing it in the main thread anymore like in v2, if you get my meaning.

For the Squid dev team, here are the headers we are sending back from the
origin App VIP:


Accept-Ranges: none

Access-Control-Allow-Origin: *

*Cache-Control: max-age=300*

Connection: close

Content-Length: 403

Content-Type: image/jpeg

Date: Tue, 28 Jul 2015 17:25:36 GMT

Expires: Tue, 28 Jul 2015 17:30:36 GMT

Last-Modified: Mon, 11 Jun 2012 04:25:18 GMT

Server: Apache/2.2.26 (Unix)


This should very much be cached right away and it's a simple tiny image.


One thing we also notice is this only occurs doing load, meaning when we
have production load traffic this fails, but if there is no other
connections to the box, no other queries, this does not fail. Is it
possible that squid is ejecting this that fast or is there another
possibility here? Not sure what other data I can provide but will if asked.


Thanks

Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150728/e311d9de/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150728/e311d9de/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004842.html">[squid-users] please help me test ext_ldap_group_acl from command line
</A></li>
	<LI>Next message (by thread): <A HREF="004827.html">[squid-users] Possible bug in 3.5.5 or a store change from 2.7?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4824">[ date ]</a>
              <a href="thread.html#4824">[ thread ]</a>
              <a href="subject.html#4824">[ subject ]</a>
              <a href="author.html#4824">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
