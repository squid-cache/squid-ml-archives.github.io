<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Possible bug in 3.5.5 or a store change from 2.7?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20bug%20in%203.5.5%20or%20a%20store%20change%20from%202.7%3F&In-Reply-To=%3C55B8233D.1060906%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004831.html">
   <LINK REL="Next"  HREF="004839.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Possible bug in 3.5.5 or a store change from 2.7?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20bug%20in%203.5.5%20or%20a%20store%20change%20from%202.7%3F&In-Reply-To=%3C55B8233D.1060906%40treenet.co.nz%3E"
       TITLE="[squid-users] Possible bug in 3.5.5 or a store change from 2.7?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 29 00:50:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004831.html">[squid-users] Possible bug in 3.5.5 or a store change from 2.7?
</A></li>
        <LI>Next message (by thread): <A HREF="004839.html">[squid-users] Possible bug in 3.5.5 or a store change from 2.7?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4833">[ date ]</a>
              <a href="thread.html#4833">[ thread ]</a>
              <a href="subject.html#4833">[ subject ]</a>
              <a href="author.html#4833">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/07/2015 10:43 a.m., Tory M Blue wrote:
&gt;<i> On Tue, Jul 28, 2015 at 12:54 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 29/07/2015 5:53 a.m., Tory M Blue wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  I just reproduced this by hand, using an HTTP sniffer tool.  I requested
</I>&gt;&gt;&gt;<i> the same URL twice, with about a 0.25 second delay between fetches, and
</I>&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i> 2nd attempt was ALSO A MISS.  Then I waited 1 second and tried a 3rd
</I>&gt;&gt;<i> time,
</I>&gt;&gt;&gt;<i> and it was FINALLY a hit.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Had the first request finished being delivered to your testing tool
</I>&gt;&gt;<i> before the second request was sent?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Yes our testing is completely sequential meaning the connection has to
</I>&gt;<i> complete before we launch another, even by hand.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid v3 seems to have changed the way it stores objects.  Maybe it is
</I>&gt;&gt;&gt;<i> doing some sort of &quot;asynchronous&quot; background store now, so if you send in
</I>&gt;&gt;&gt;<i> sequential requests without a delay between, it may not actually have
</I>&gt;&gt;&gt;<i> finished storing it yet, so it doesn't report a &quot;hit&quot;.  Meaning, the
</I>&gt;&gt;<i> first
</I>&gt;&gt;&gt;<i> &quot;miss&quot; response may have fired off a thread to store the object, and not
</I>&gt;&gt;&gt;<i> doing it in the main thread anymore like in v2, if you get my meaning.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid-3 in-transit objects are not listed as existing in cache_mem
</I>&gt;&gt;<i> storage until they have completely (and successfully) finished their
</I>&gt;&gt;<i> first use.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can configure &quot;collapsed_forwarding on&quot; to enable the Squid-2.7
</I>&gt;&gt;<i> behaviour. Treating the in-transit objects list as if it were another
</I>&gt;&gt;<i> cache area.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The document cite this is quite a bit different and not something I want
</I>&gt;<i> to embark upon.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Timing between *completion* of the first request and starting of the
</I>&gt;&gt;<i> second is the critical. If the first request has not finished, theres no
</I>&gt;&gt;<i> hope of a HIT.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also size of memory cache relative to the churn currently going on also
</I>&gt;&gt;<i> matters. If you wait too long between the test requests it will be
</I>&gt;&gt;<i> pushed out and get a MISS again anyway. But I dont think that is a
</I>&gt;&gt;<i> factor with 250ms being your timing.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Again completely synchronous, something is not happening as it should under
</I>&gt;<i> a busy condition, we tested this as far out as 5 seconds and still got a
</I>&gt;<i> miss.  We have added &quot;5&quot; retries to our monitor, but I do think something
</I>&gt;<i> is  a miss (no pun intended).  Single client hitting a single server in a
</I>&gt;<i> synchronous manner, should allow for a pretty quick cache hit, but it's
</I>&gt;<i> not.
</I>&gt;<i> 
</I>&gt;<i> my high/low water marks are so
</I>&gt;<i> 
</I>&gt;<i> cache_swap_high 90
</I>&gt;<i> 
</I>&gt;<i> cache_swap_low 80
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My space available is so
</I>&gt;<i> 
</I>&gt;<i> Filesystem            Size  Used Avail Use% Mounted on
</I>&gt;<i> 
</I>&gt;<i> /dev/ram0              17G   14G  2.3G  86% /cache01
</I>&gt;<i> 
</I>&gt;<i> Any other data I could grab from the stats that would help. I do believe
</I>&gt;<i> something is not quite right but we have ways to get around it for now,
</I>&gt;<i> 
</I>
That depends on how busy. A debug trace at level ALL,7 would be best.
But the amount of date logged can be a problem if Squid is running
several hundred or thousand req/sec.

That can be resolved somewhat by turning the logging on dynamically with
&quot;squid -k debug&quot; shortly before and after a test is run.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004831.html">[squid-users] Possible bug in 3.5.5 or a store change from 2.7?
</A></li>
	<LI>Next message (by thread): <A HREF="004839.html">[squid-users] Possible bug in 3.5.5 or a store change from 2.7?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4833">[ date ]</a>
              <a href="thread.html#4833">[ thread ]</a>
              <a href="subject.html#4833">[ subject ]</a>
              <a href="author.html#4833">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
