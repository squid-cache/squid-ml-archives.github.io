<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] dns failover failing with 3.4.7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20dns%20failover%20failing%20with%203.4.7&In-Reply-To=%3C55BAA7B2.9020802%40afo.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004864.html">
   <LINK REL="Next"  HREF="004868.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] dns failover failing with 3.4.7</H1>
    <B>Mike</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20dns%20failover%20failing%20with%203.4.7&In-Reply-To=%3C55BAA7B2.9020802%40afo.net%3E"
       TITLE="[squid-users] dns failover failing with 3.4.7">mcsnv96 at afo.net
       </A><BR>
    <I>Thu Jul 30 22:39:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004864.html">[squid-users] dns failover failing with 3.4.7
</A></li>
        <LI>Next message (by thread): <A HREF="004868.html">[squid-users] dns failover failing with 3.4.7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4866">[ date ]</a>
              <a href="thread.html#4866">[ thread ]</a>
              <a href="subject.html#4866">[ subject ]</a>
              <a href="author.html#4866">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/30/2015 16:30 PM, Amos Jeffries wrote:
&gt;<i> On 31/07/2015 3:48 a.m., Mike wrote:
</I>&gt;&gt;<i> On 7/27/2015 17:25 PM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 28/07/2015 8:38 a.m., Mike wrote:
</I>&gt;&gt;&gt;&gt;<i> Running into an issue, using the squid.conf entry
</I>&gt;&gt;&gt;&gt;<i> dns_nameservers 72.x.x.x 72.x.y.y
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> These are different servers (under our control) for the purpose of
</I>&gt;&gt;&gt;&gt;<i> filtering than listed in resolv.conf (which are out of our control, used
</I>&gt;&gt;&gt;&gt;<i> for server IP routing by upstream host).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The problem we found like this weekend is if the primary listed dns
</I>&gt;&gt;&gt;&gt;<i> server is unavailable, squid fails to use the secondary listed server.
</I>&gt;&gt;&gt;&gt;<i> Instead it displays the &quot;unable to connect&quot; type messages with all
</I>&gt;&gt;&gt;&gt;<i> websites.
</I>&gt;&gt;&gt;<i> Details please. How do you know the secondary is not even being tried?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What is Squid getting back from the primary when its &quot;down&quot; ?
</I>&gt;&gt;&gt;<i>    or just dns_timeout being hit?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Add this to squid.conf to get a cache.log trace of the DNS activity:
</I>&gt;&gt;&gt;<i>     debug_options 78,6
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If it was using the secondary server listed, connections to almost all
</I>&gt;&gt;<i> websites would not be failing to load if primary was down. For the test
</I>&gt;&gt;<i> we temporarily took the primary DNS server offline (per the example
</I>&gt;&gt;<i> above 72.x.x.x), and no websites would load unless it was in the squid
</I>&gt;&gt;<i> cache, but any elements that required additional data failed to load
</I>&gt;&gt;<i> causing formatting issues with the displayed website. If we swap the
</I>&gt;&gt;<i> setting to the &quot;secondary&quot; with the first IP (per the example above) as
</I>&gt;&gt;<i> dns_nameservers 72.x.y.y 72.x.x.x
</I>&gt;&gt;<i> and it works the same way, take the &quot;.y.y&quot; down and it refuses to use
</I>&gt;&gt;<i> the secondary listed IP &quot;.x.x&quot; for DNS, instead displays the website
</I>&gt;&gt;<i> could not be displayed error in the browsers. We even tried another test
</I>&gt;&gt;<i> (per the example above) dns_nameservers 72.x.x.x 8.8.8.8 then let it run
</I>&gt;&gt;<i> for an hour or so. Then we took down the primary which means it should
</I>&gt;&gt;<i> use the secondary google IP of 8.8.8.8, but it doesn't, goes right back
</I>&gt;&gt;<i> to the &quot;website could not be displayed&quot; error in the browsers.
</I>&gt;&gt;<i> I was wonder if this might be a bug. This is happening on multiple
</I>&gt;&gt;<i> servers, one has squid 3.4.7, another has 3.4.6 and problem occurs on both.
</I>&gt;&gt;<i>
</I>&gt;<i> Thank you exactly the kind of answer I was looking for question #1.
</I>&gt;<i> (Evidence that the problem is what you think it is before digging for a
</I>&gt;<i> cause).
</I>&gt;<i>
</I>&gt;<i> Kind of answers Q2 a &quot;nothing&quot;, implying that Q3 is &quot;yes&quot; dns_timeout is
</I>&gt;<i> happening.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   Is your dns_timeout (default 30 sec *total* DNS lookup timeout) larger
</I>&gt;<i> than your dns_retransmit_interval (default 5 sec per-query timeout) setting?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>We do not have a dns_timeout or retransmit entry in the squid.conf, only 
using the dns_nameservers entry allowing the default timeout timeframes 
since so few websites should take much longer than that to load, and if 
they are, it is a misspelled URL, a foreign server (which so few of our 
customers use), or likely having issues anyways.

I suspect this may be a bug with squid 3.4.x since this issue happened 
on 2 different squid servers, one is 3.4.6, another is 3.4.7. Yet on the 
backups to each, one has 3.5.1 and other has 3.5.6 (I updated it today), 
and they are not affected by this, both of these squid v3.5.x servers 
properly see the primary is not reachable and uses the secondary DNS IP.

Thanks Amos,


Mike


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004864.html">[squid-users] dns failover failing with 3.4.7
</A></li>
	<LI>Next message (by thread): <A HREF="004868.html">[squid-users] dns failover failing with 3.4.7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4866">[ date ]</a>
              <a href="thread.html#4866">[ thread ]</a>
              <a href="subject.html#4866">[ subject ]</a>
              <a href="author.html#4866">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
