<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid centos and osq_lock
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20centos%20and%20osq_lock&In-Reply-To=%3CCAAg-RYsvPKLeMP31evCGshROxNF1VEsNUK2OJMJLEgfrzV-krw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004867.html">
   <LINK REL="Next"  HREF="004877.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid centos and osq_lock</H1>
    <B>Josip Makarevic</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20centos%20and%20osq_lock&In-Reply-To=%3CCAAg-RYsvPKLeMP31evCGshROxNF1VEsNUK2OJMJLEgfrzV-krw%40mail.gmail.com%3E"
       TITLE="[squid-users] squid centos and osq_lock">jmakarevic at gmail.com
       </A><BR>
    <I>Fri Jul 31 06:52:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004867.html">[squid-users] squid centos and osq_lock
</A></li>
        <LI>Next message (by thread): <A HREF="004877.html">[squid-users] squid centos and osq_lock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4870">[ date ]</a>
              <a href="thread.html#4870">[ thread ]</a>
              <a href="subject.html#4870">[ subject ]</a>
              <a href="author.html#4870">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

 cache_mem 0
 cache deny all

already there.
Regarding number of nic ports we have 4 10G eth cards 2 in each bonding
interface.

Well, entire config would be way too long but here is the static part:
via off
cpu_affinity_map process_numbers=1 cores=2
forwarded_for delete
visible_hostname squid1
pid_filename /var/run/squid1.pid
icp_port 0
htcp_port 0
icp_access deny all
htcp_access deny all
snmp_port 0
snmp_access deny all
dns_nameservers x.x.x.x
cache_mem 0
cache deny all
pipeline_prefetch on
memory_pools off
maximum_object_size 16 KB
maximum_object_size_in_memory 16 KB
ipcache_size 0
cache_store_log none
half_closed_clients off
include /etc/squid/rules
access_log /var/log/squid/squid1-access.log
cache_log /var/log/squid/squid1-cache.log
coredump_dir /var/spool/squid/squid1
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

acl port0 myport 30000
http_access allow testhost
tcp_outgoing_address x.x.x.x port0

include is there for basic ACL - safe ports and so on - to minimize config
file footprint since it's static and same for every worker.

and so on 44 more times in this config file

Do you know of any good article hot to tune kernel locking or have any idea
why is it happening?
I cannot find any good info on it and all I've found are bits and peaces of
kernel source code.


Tnx.
J.

2015-07-31 0:42 GMT+02:00 Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:

&gt;<i> On 31/07/2015 8:05 a.m., Josip Makarevic wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have a problem with squid setup (squid version 3.5.6, built from
</I>&gt;<i> source,
</I>&gt;<i> &gt; centos 6.6)
</I>&gt;<i> &gt; I've tried 2 options:
</I>&gt;<i> &gt; 1. SMP
</I>&gt;<i> &gt; 2. NON-SMP
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've decided to stick with custom build non-smp version and the thing is:
</I>&gt;<i> &gt; - i don't need cache - any kind of it
</I>&gt;<i>
</I>&gt;<i>  cache_mem 0
</I>&gt;<i>  cache deny all
</I>&gt;<i>
</I>&gt;<i> That is it. All other caches used by Squid *are* mandatory for good
</I>&gt;<i> performance. And are only used anyway when the component that needs them
</I>&gt;<i> is actively used.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; - I have DNS cache just for that
</I>&gt;<i> &gt; - squid has to listen on 1024 ports on 23 instances.
</I>&gt;<i> &gt; each instance listens on set of ports and each port has different
</I>&gt;<i> outgoing
</I>&gt;<i> &gt; ip address.
</I>&gt;<i>
</I>&gt;<i> And how many NIC do you have that spread over?
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The thing is this:
</I>&gt;<i> &gt; It's alll good until we hit it with more than 150mbits then...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; (output from perf top)
</I>&gt;<i> &gt;  84.57%  [kernel]                  [k] osq_lock
</I>&gt;<i> &gt;   4.62%  [kernel]                  [k] mutex_spin_on_owner
</I>&gt;<i> &gt;   1.41%  [kernel]                  [k] memcpy
</I>&gt;<i> &gt;   0.79%  [kernel]                  [k] inet_dump_ifaddr
</I>&gt;<i> &gt;   0.62%  [kernel]                  [k] memset
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  21:53:39 up 7 days, 10:38,  1 user,  load average: 24.01, 23.84, 23.33
</I>&gt;<i> &gt; (yes, we have 24 cores)
</I>&gt;<i> &gt; Same behavior is with SMP and NON-SMP setup (SMP setup is all in one file
</I>&gt;<i> &gt; with workers 23 option but then I have to use rock cache)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; so, my question is....what...how to optimize this.....whatever....I'm
</I>&gt;<i> stuck
</I>&gt;<i> &gt; for days, I've tried many sysctl options but none of them works.
</I>&gt;<i> &gt; Any help, info, something else?
</I>&gt;<i>
</I>&gt;<i> None of those are Squid functionality. If you want help optimizing your
</I>&gt;<i> config and are willing to post it to the list I am happy to do a quick
</I>&gt;<i> audit and point out any problem areas for you.
</I>&gt;<i>
</I>&gt;<i> But tuning the internal locking code of the kernel is way off topic.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150731/5daf07cf/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150731/5daf07cf/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004867.html">[squid-users] squid centos and osq_lock
</A></li>
	<LI>Next message (by thread): <A HREF="004877.html">[squid-users] squid centos and osq_lock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4870">[ date ]</a>
              <a href="thread.html#4870">[ thread ]</a>
              <a href="subject.html#4870">[ subject ]</a>
              <a href="author.html#4870">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
