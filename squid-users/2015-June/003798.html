<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl-bump deep dive (intercept last post and final thoughts)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28intercept%20last%20post%20and%20final%0A%20thoughts%29&In-Reply-To=%3C1433123214.3738.2.camel%40JamesiMac%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003796.html">
   <LINK REL="Next"  HREF="003799.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl-bump deep dive (intercept last post and final thoughts)</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28intercept%20last%20post%20and%20final%0A%20thoughts%29&In-Reply-To=%3C1433123214.3738.2.camel%40JamesiMac%3E"
       TITLE="[squid-users] Ssl-bump deep dive (intercept last post and final thoughts)">jlay at slave-tothe-box.net
       </A><BR>
    <I>Mon Jun  1 01:46:54 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003796.html">[squid-users] Ssl-bump deep dive (intercept last post and final thoughts)
</A></li>
        <LI>Next message (by thread): <A HREF="003799.html">[squid-users] ssl_bump and SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3798">[ date ]</a>
              <a href="thread.html#3798">[ thread ]</a>
              <a href="subject.html#3798">[ subject ]</a>
              <a href="author.html#3798">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2015-06-01 at 13:00 +1200, Amos Jeffries wrote:

&gt;<i> On 1/06/2015 11:56 a.m., James Lay wrote:
</I>&gt;<i> &gt; So this has been REALLY good!  The tl;dr:  ssl-bumping is pretty easy
</I>&gt;<i> &gt; even with intercept, ssl-bumping with access control is a little more
</I>&gt;<i> &gt; difficult...jump to the config to skip the chit chat.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; My goal has always been to a content filter based on url regex.  This
</I>&gt;<i> &gt; works just fine for http traffic, but is much more difficult for https
</I>&gt;<i> &gt; traffic just for the case of you may or may not know the host you're
</I>&gt;<i> &gt; going to, depending on the site/app.  I'll be real honest here....I'm
</I>&gt;<i> &gt; only doing this to protect/filter the traffic of two kids, on laptops,
</I>&gt;<i> &gt; iPhone, and Android phone, so it's a mixed bag of content and, since
</I>&gt;<i> &gt; it's just the two of them in a home environment, I get to play around
</I>&gt;<i> &gt; and see what works and what doesn't.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Below is a close as I can get transparent intercept ssl-bump with
</I>&gt;<i> &gt; content filtering with using a list of domains/urls with both http and
</I>&gt;<i> &gt; https.  I still have to use a list of broken sites, which are large
</I>&gt;<i> &gt; netblocks (17.0.0.0/8..Apple anyone?) because some of these I just can't
</I>&gt;<i> &gt; seem to get host/domain information during the ssl handshake.  As I
</I>&gt;<i> &gt; discovered after attempting to put this into &quot;production&quot;, I have not
</I>&gt;<i> &gt; been able to emulate using wget or curl an https session that doesn't
</I>&gt;<i> &gt; have any SNI information, so that threw me for a loop.  TextNow is a
</I>&gt;<i> &gt; great example (I'm including a packet capture of this in this post).
</I>&gt;<i> &gt; There's no host information in the client hello....there's no host
</I>&gt;<i> &gt; information in the server hello.....buried deep in the certificate ONLY
</I>&gt;<i> &gt; is the &quot;commonName=.*textnow.me&quot;...that's it.  This dashed my hopes of
</I>&gt;<i> &gt; using an url_regex for access control with all https sessions.  I have
</I>&gt;<i> &gt; &quot;%ssl::&gt;cert_subject&quot; in my logging, and I never did see this log in any
</I>&gt;<i> &gt; of my tests...and I tested a BUNCH of different peek/stare/splice/bump
</I>&gt;<i> &gt; cominations..so I don't think squid is actually seeing this from the
</I>&gt;<i> &gt; certificate.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Another challenge is getting http url_regex filtering to work with https
</I>&gt;<i> &gt; filtering.  My method of filtering means not having an &quot;http_access
</I>&gt;<i> &gt; allow localnet&quot;, which directly conflicted with also trying to filter
</I>&gt;<i> &gt; https.  The solution was to add an acl for port 443, then http_access to
</I>&gt;<i> &gt; just allow it, as our filtering was going to happen for https further
</I>&gt;<i> &gt; down.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I know there's a fair amount of people who just want to plop in some
</I>&gt;<i> &gt; config files, run a few commands, and be up and running.  The below
</I>&gt;<i> &gt; configuration has two additional files it references, http_url.txt,
</I>&gt;<i> &gt; which is an a list of domains/urls (\.apple\.com for example), and the
</I>&gt;<i> &gt; aptly named broken, which is a IP list (17.0.0.0/8).  The broken list
</I>&gt;<i> &gt; should be (semi) trusted and are sites that we just can't get SNI or
</I>&gt;<i> &gt; hostname information from.  If you've created a single cert/key pair
</I>&gt;<i> &gt; from the Squid documentation, you won't need the key= line in your
</I>&gt;<i> &gt; https_port directive.  If you've followed along in my posts, you already
</I>&gt;<i> &gt; have the configure line from my previous posts.  Change the
</I>&gt;<i> &gt; commands/config to fir where your squid config and ssl_db are.  So after
</I>&gt;<i> &gt; configuring, make sure you:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; sudo /opt/libexec/ssl_crtd -c -s /opt/var/ssl_db
</I>&gt;<i> &gt; sudo chown -R nobody /opt/var/ssl_db/
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; As I believe in a lot of logging, and actually looking at said logging,
</I>&gt;<i> &gt; below is what you can expect to see in your logs (mine logs to syslog,
</I>&gt;<i> &gt; again, change this if you log to a different file):
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Allowed http to .apple.com in http_url.txt:
</I>&gt;<i> &gt; May 31 17:03:48 gateway (squid-1): 192.168.1.100 - -
</I>&gt;<i> &gt; [31/May/2015:17:03:48 -0600] &quot;GET
</I>&gt;<i> &gt; <A HREF="http://init.ess.apple.com/WebObjects/VCInit.woa/wa/getBag?">http://init.ess.apple.com/WebObjects/VCInit.woa/wa/getBag?</A> HTTP/1.1&quot; - -
</I>&gt;<i> &gt; 200 5243 TCP_MISS:ORIGINAL_DST -
</I>&gt;<i> &gt; Denied http to symcb.com not in http_url.txt
</I>&gt;<i> &gt; May 31 17:03:48 gateway (squid-1): 192.168.1.100 - -
</I>&gt;<i> &gt; [31/May/2015:17:03:48 -0600] &quot;GET <A HREF="http://sd.symcb.com/sd.crt">http://sd.symcb.com/sd.crt</A> HTTP/1.1&quot; -
</I>&gt;<i> &gt; - 403 3618 TCP_DENIED:HIER_NONE -
</I>&gt;<i> &gt; Spliced https IP in broken.txt (google block 216.58.192.0/19)
</I>&gt;<i> &gt; May 31 17:04:34 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i> &gt; [31/May/2015:17:04:34 -0600] &quot;CONNECT 216.58.216.138:443 HTTP/1.1&quot; - -
</I>&gt;<i> &gt; 200 568 TCP_TUNNEL:ORIGINAL_DST peek
</I>&gt;<i> &gt; Spliced https IP in broken.txt that we got SNI or bumped site in
</I>&gt;<i> &gt; http_url.txt look exactly the same
</I>&gt;<i> &gt; May 31 17:09:45 gateway (squid-1): 192.168.1.100 - -
</I>&gt;<i> &gt; [31/May/2015:17:09:45 -0600] &quot;CONNECT 23.222.157.21:443 HTTP/1.1&quot;
</I>&gt;<i> &gt; init.itunes.apple.com - 200 30314 TCP_TUNNEL:ORIGINAL_DST peek
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The only drag with the configuration is you won't see when an https
</I>&gt;<i> &gt; session is terminated when the IP/url is not in the broken.txt, or the
</I>&gt;<i> &gt; http_url.txt:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; [17:20:53 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at analysis</A>:~$] wget -d
</I>&gt;<i> &gt; --ca-certificate=/etc/ssl/certs/sslsplit.crt <A HREF="https://www.yahoo.com">https://www.yahoo.com</A>
</I>&gt;<i> &gt; Setting --ca-certificate (cacertificate) to /etc/ssl/certs/sslsplit.crt
</I>&gt;<i> &gt; DEBUG output created by Wget 1.16.1 on linux-gnu.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; URI encoding = &#8216;UTF-8&#8217;
</I>&gt;<i> &gt; --2015-05-31 17:20:59--  <A HREF="https://www.yahoo.com/">https://www.yahoo.com/</A>
</I>&gt;<i> &gt; Resolving www.yahoo.com (www.yahoo.com)... 206.190.36.45,
</I>&gt;<i> &gt; 206.190.36.105, 2001:4998:c:a06::2:4008
</I>&gt;<i> &gt; Caching www.yahoo.com =&gt; 206.190.36.45 206.190.36.105
</I>&gt;<i> &gt; 2001:4998:c:a06::2:4008
</I>&gt;<i> &gt; Connecting to www.yahoo.com (www.yahoo.com)|206.190.36.45|:443...
</I>&gt;<i> &gt; connected.
</I>&gt;<i> &gt; Created socket 3.
</I>&gt;<i> &gt; Releasing 0x00007fdf67eecdd0 (new refcount 1).
</I>&gt;<i> &gt; Initiating SSL handshake.
</I>&gt;<i> &gt; SSL handshake failed.
</I>&gt;<i> &gt; Closed fd 3
</I>&gt;<i> &gt; Unable to establish SSL connection.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; May 31 17:20:59 gateway (squid-1): 192.168.1.6 - - [31/May/2015:17:20:59
</I>&gt;<i> &gt; -0600] &quot;CONNECT 206.190.36.45:443 HTTP/1.1&quot; www.yahoo.com - 200 0
</I>&gt;<i> &gt; TAG_NONE:ORIGINAL_DST peek 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Full config below:
</I>&gt;<i> &gt; ####################################
</I>&gt;<i> &gt; acl localnet src 192.168.1.0/24
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl SSL_ports port 443
</I>&gt;<i> &gt; acl Safe_ports port 80
</I>&gt;<i> &gt; acl Safe_ports port 443
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl CONNECT method CONNECT
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl allowed_http_sites url_regex &quot;/opt/etc/squid/http_url.txt&quot;
</I>&gt;<i> &gt; acl allow_https port 443
</I>&gt;<i> 
</I>&gt;<i> Note how SSL_ports and allow_https ACL definitions are identical apart
</I>&gt;<i> from the name.
</I>&gt;<i> 
</I>&gt;<i> You can replace all uses of &quot;allow_https&quot; ACL in the rest of your config
</I>&gt;<i> with &quot;SSL_Ports&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; acl broken dst &quot;/opt/etc/squid/broken.txt&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_access deny !Safe_ports
</I>&gt;<i> &gt; http_access deny CONNECT !SSL_Ports
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_access allow allow_https
</I>&gt;<i> &gt; http_access allow allowed_http_sites
</I>&gt;<i> &gt; http_access deny !allowed_http_sites
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> 
</I>&gt;<i> Two deny lines in a row are redundant when one is &quot;deny all&quot;.
</I>&gt;<i> 
</I>&gt;<i> You can drop the &quot;deny !allowed_http_sites&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ssl_bump peek step1 broken
</I>&gt;<i> &gt; ssl_bump peek step2 broken
</I>&gt;<i> &gt; ssl_bump splice broken
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt; ssl_bump peek step2 all
</I>&gt;<i> 
</I>&gt;<i> The above lines are logically the same as:
</I>&gt;<i> 
</I>&gt;<i>  ssl_bump splice step3 broken
</I>&gt;<i>  ssl_bump peek all
</I>&gt;<i> 
</I>&gt;<i> &gt; acl allowed_https_sites ssl::server_name_regex
</I>&gt;<i> &gt; &quot;/opt/etc/squid/http_url.txt&quot;
</I>&gt;<i> &gt; ssl_bump bump allowed_https_sites
</I>&gt;<i> &gt; ssl_bump terminate !allowed_https_sites
</I>&gt;<i> 
</I>&gt;<i> If you used reject instead of terminate on this rule, you should get the
</I>&gt;<i> log entries you mentioned wanting when connections are terminated.
</I>&gt;<i> 
</I>&gt;<i> The not logging of &quot;terminate&quot; connectisno is a bug. Please report to
</I>&gt;<i> bugzilla so we dont forget it.
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; sslproxy_cert_error allow all
</I>&gt;<i> &gt; sslproxy_capath /etc/ssl/certs
</I>&gt;<i> &gt; sslproxy_flags DONT_VERIFY_PEER 
</I>&gt;<i> 
</I>&gt;<i> The point of TLS is to verify the other endpoint of the connection is
</I>&gt;<i> actually who they claim to be. The above config settings are a) not
</I>&gt;<i> bothering to even check the claim, and b) silently ignoring whatever
</I>&gt;<i> result the security check produces.
</I>&gt;<i> 
</I>&gt;<i> * DONT_VERIFY_PEER is a debugging option. Not for use in &quot;production&quot;
</I>&gt;<i> systems. It should not even be used in any real operational testing,
</I>&gt;<i> only to see if the peer verification failures was the source of an issue.
</I>&gt;<i> 
</I>&gt;<i> * sslproxy_cert_error allow all - is pure evil. The directive was only
</I>&gt;<i> added so networks could continue to work during transition periods when
</I>&gt;<i> a major vulnerability like CRIME/ BREECH / POODLE were discovered and
</I>&gt;<i> their library started erroring out on bad bevahiour, but the remote
</I>&gt;<i> sites were being laggards.
</I>&gt;<i>  Theres a limited number of errors which are safe to ignore, and an even
</I>&gt;<i> smaller sub-set of those which are actually needed on any given network.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; sslproxy_options ALL
</I>&gt;<i> 
</I>&gt;<i> &quot;ALL&quot; enables a lot of old features and hacks in OpenSSL (export grade
</I>&gt;<i> ciphers and plaintext passwords, woohoo!) that are increasingly found to
</I>&gt;<i> cause security vulenrabilities.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; sslcrtd_program /opt/libexec/ssl_crtd -s /opt/var/ssl_db -M 4MB
</I>&gt;<i> &gt; sslcrtd_children 5
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port 3128 intercept
</I>&gt;<i> &gt; https_port 3129 intercept ssl-bump
</I>&gt;<i> &gt; cert=/opt/etc/squid/certs/sslsplit_ca_cert.pem
</I>&gt;<i> &gt; cafile=/opt/etc/squid/certs/sslsplit_ca_cert.pem
</I>&gt;<i> &gt; key=/opt/etc/squid/certs/sslsplit_ca_key.pem
</I>&gt;<i> &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; sslflags=NO_SESSION_REUSE
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; logformat mine %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %ssl::&gt;sni %
</I>&gt;<i> &gt; ssl::&gt;cert_subject %&gt;Hs %&lt;st %Ss:%Sh %ssl::bump_mode 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; access_log syslog:daemon.info mine
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; refresh_pattern -i (cgi-bin|\?)	0	0%	0
</I>&gt;<i> &gt; refresh_pattern .		0	20%	4320
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; coredump_dir /opt/var
</I>&gt;<i> &gt; ##############################
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Thanks all for being patient while I continued to post my learning and
</I>&gt;<i> &gt; all my mistakes.  If there's anything that I've missed, or if there's
</I>&gt;<i> &gt; another method for trying to accomplish what I've tried to do I'm all
</I>&gt;<i> &gt; eyes.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; James
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; P.S. Things I'd love to see in Squid some day:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl's being AND'd (http_access allow allowed_sites AND localnet)
</I>&gt;<i> 
</I>&gt;<i> That aready exists. The AND is implicit in the order of the ACL checks,
</I>&gt;<i> so the &quot;AND &quot; is redundant waste of space in the config file.
</I>&gt;<i> 
</I>&gt;<i> eg, your above &quot;allowed_sites AND localnet&quot; rule is configured:
</I>&gt;<i>   http_access allow allowed_sites localnet
</I>&gt;<i> 
</I>&gt;<i> This is why I keep pointing out how useless rules like &quot;ssl_bump peek
</I>&gt;<i> step1 all&quot; are. So you want to peek when &quot;step1&quot;, just peek based on
</I>&gt;<i> step1, no need to check if true == true.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Full on separate http_access, https_access directives
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> I consider this every now and again. But HTTPS is not actually a real
</I>&gt;<i> thing. It is a TLS connection delivering regular HTTP messages. By the
</I>&gt;<i> time the messages are inside Squid they dont have that TLS part any more
</I>&gt;<i> than clear text HTTP has TCP headers.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> That said, if you want to go fancy you can use the &quot;allof&quot; ACL type.
</I>&gt;<i> This ACL type lets you write an entire sub-tree of logical ACL tests and
</I>&gt;<i> give it a name. Its not quite the same though.
</I>&gt;<i> 
</I>&gt;<i>  acl HTTP proto HTTP
</I>&gt;<i>  acl HTTPS proto HTTPS
</I>&gt;<i> 
</I>&gt;<i>  acl sites dstdomain ...
</I>&gt;<i> 
</I>&gt;<i>  acl sites2 dstdomain ...
</I>&gt;<i>  acl site2paths urlpath_regex ...
</I>&gt;<i> 
</I>&gt;<i>  acl 443 port 443
</I>&gt;<i> 
</I>&gt;<i>  acl plain allof CONNECT 443
</I>&gt;<i>  acl plain allof sites
</I>&gt;<i>  acl plain allof sites2 site2paths
</I>&gt;<i>  acl plain allof localnet
</I>&gt;<i> 
</I>&gt;<i>  acl decrypted allof sites
</I>&gt;<i>  acl decrypted allof sites2 site2paths
</I>&gt;<i>  acl decrypted allof localnet
</I>&gt;<i> 
</I>&gt;<i>  http_access allow HTTP plain
</I>&gt;<i>  http_access allow HTTPS decrypted
</I>&gt;<i>  http_access deny all
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

Awesome, awesome, and more awesome.  Amos that you SO much for the
information...I'll make the optimizations and changes and test...I won't
bug the list with this anymore unless requested however.  I will
absolutely file the bug report on terminate.

James
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150531/84035226/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150531/84035226/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003796.html">[squid-users] Ssl-bump deep dive (intercept last post and final thoughts)
</A></li>
	<LI>Next message (by thread): <A HREF="003799.html">[squid-users] ssl_bump and SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3798">[ date ]</a>
              <a href="thread.html#3798">[ thread ]</a>
              <a href="subject.html#3798">[ subject ]</a>
              <a href="author.html#3798">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
