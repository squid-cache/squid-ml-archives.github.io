<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Squid Proxy Server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Squid%20Proxy%20Server&In-Reply-To=%3C556DAD83.2030006%40vsen.dk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003814.html">
   <LINK REL="Next"  HREF="003820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Squid Proxy Server</H1>
    <B>Klavs Klavsen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Squid%20Proxy%20Server&In-Reply-To=%3C556DAD83.2030006%40vsen.dk%3E"
       TITLE="[squid-users] Transparent Squid Proxy Server">kl at vsen.dk
       </A><BR>
    <I>Tue Jun  2 13:20:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003814.html">[squid-users] Transparent Squid Proxy Server
</A></li>
        <LI>Next message (by thread): <A HREF="003820.html">[squid-users] Transparent Squid Proxy Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3815">[ date ]</a>
              <a href="thread.html#3815">[ thread ]</a>
              <a href="subject.html#3815">[ subject ]</a>
              <a href="author.html#3815">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have this in my squid server for it to work:
*mangle
:<i>PREROUTING ACCEPT [190:618576]
</I>:<i>INPUT ACCEPT [190:618576]
</I>:<i>FORWARD ACCEPT [0:0]
</I>:<i>OUTPUT ACCEPT [163:41506]
</I>:<i>POSTROUTING ACCEPT [166:42334]
</I>-A PREROUTING -d $myip/32 -p tcp -m multiport --dports 3129 -m comment 
--comment &quot;002 drop squid direct traffic http - we only allow captured 
traffic&quot; -j DROP
-A PREROUTING -d $myip/32 -p tcp -m multiport --dports 3130 -m comment 
--comment &quot;002 drop squid direct traffic https - we only allow captured 
traffic&quot; -j DROP
COMMIT
# Completed on Wed Apr  1 10:28:22 2015
# Generated by iptables-save v1.4.21 on Wed Apr  1 10:28:22 2015
*nat
:<i>PREROUTING ACCEPT [1:36]
</I>:<i>INPUT ACCEPT [0:0]
</I>:<i>OUTPUT ACCEPT [30:2079]
</I>:<i>POSTROUTING ACCEPT [30:2079]
</I>-A PREROUTING -s $myip/32 -p tcp -m multiport --dports 80 -m comment 
--comment &quot;000 allow squid http - so its traffic does not get captured&quot; 
-j ACCEPT
-A PREROUTING -s $myip/32 -p tcp -m multiport --dports 443 -m comment 
--comment &quot;000 allow squid https - so its traffic does not get captured&quot; 
-j ACCEPT
-A PREROUTING -p tcp -m multiport --dports 80 -m comment --comment &quot;001 
capture http to squid&quot; -j DNAT --to-destination $myip:3129
-A PREROUTING -p tcp -m multiport --dports 443 -m comment --comment &quot;001 
capture https to squid&quot; -j DNAT --to-destination $myip:3130
COMMIT
# Completed on Wed Apr  1 10:28:22 2015
# Generated by iptables-save v1.4.21 on Wed Apr  1 10:28:22 2015
*filter
:<i>INPUT ACCEPT [0:0]
</I>:<i>FORWARD ACCEPT [0:0]
</I>:<i>OUTPUT ACCEPT [1:184]
</I>-A INPUT -p tcp -m multiport --ports 3129 -m comment --comment &quot;000 
allow squid http intercept&quot; -j ACCEPT
-A INPUT -p tcp -m multiport --ports 3130 -m comment --comment &quot;000 
allow squid https intercept&quot; -j ACCEPT
-A INPUT -p tcp -m multiport --ports 3128 -m comment --comment &quot;000 
allow squid proxy&quot; -j ACCEPT

and squid conf (mind you - squid 3.4)
ssl_bump                       server-first all
sslproxy_flags                 DONT_VERIFY_PEER
sslcrtd_children               8 startup=1 idle=1
sslcrtd_program                /usr/lib64/squid/ssl_crtd -s 
/etc/ssl/certs/cache/ -M 4MB
https_port                     3130 intercept ssl-bump 
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
key=/etc/squid/ca.private cert=/etc/squid/ca.cert
shutdown_lifetime              3
always_direct                  allow all
sslproxy_cert_error            allow all
http_port                      3129 intercept

Reet Vyas wrote on 06/02/2015 02:31 PM:
&gt;<i> I am trying to configure transparent squid proxy on ubuntu 14.04 Server
</I>&gt;<i> and squid 3.3 version I am using
</I>&gt;<i>
</I>&gt;<i> My Lan and Wan settings
</I>&gt;<i>
</I>&gt;<i> eth0      Link encap:Ethernet  HWaddr 00:1e:67:cf:59:74
</I>&gt;<i>            inet addr:116.72.*.*  Bcast:116.72.155.255  Mask:255.255.252.0
</I>&gt;<i>            inet6 addr: fe80::21e:67ff:fecf:5974/64 Scope:Link
</I>&gt;<i>            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</I>&gt;<i>            RX packets:238950 errors:0 dropped:0 overruns:0 frame:0
</I>&gt;<i>            TX packets:236104 errors:0 dropped:0 overruns:0 carrier:0
</I>&gt;<i>            collisions:0 txqueuelen:1000
</I>&gt;<i>            RX bytes:22219047 (22.2 MB)  TX bytes:17390502 (17.3 MB)
</I>&gt;<i>            Interrupt:16 Memory:d0a00000-d0a20000
</I>&gt;<i>
</I>&gt;<i> eth1      Link encap:Ethernet  HWaddr 00:1e:67:cf:59:75
</I>&gt;<i>            inet addr:192.168.0.200  Bcast:192.168.0.255  Mask:255.255.255.0
</I>&gt;<i>            inet6 addr: fe80::21e:67ff:fecf:5975/64 Scope:Link
</I>&gt;<i>            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</I>&gt;<i>            RX packets:96965 errors:0 dropped:0 overruns:0 frame:0
</I>&gt;<i>            TX packets:11785 errors:0 dropped:0 overruns:0 carrier:0
</I>&gt;<i>            collisions:0 txqueuelen:1000
</I>&gt;<i>            RX bytes:10764615 (10.7 MB)  TX bytes:7151763 (7.1 MB)
</I>&gt;<i>            Interrupt:17 Memory:d0900000-d0920000
</I>&gt;<i>
</I>&gt;<i> my squid.conf file
</I>&gt;<i>
</I>&gt;<i> acl mynet src 116.72.152.37 192.168.0.0/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt;    #
</I>&gt;<i> RFC1918 possible internal network
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80        # http
</I>&gt;<i> acl Safe_ports port 21        # ftp
</I>&gt;<i> acl Safe_ports port 443        # https
</I>&gt;<i> acl Safe_ports port 70        # gopher
</I>&gt;<i> acl Safe_ports port 210        # wais
</I>&gt;<i> acl Safe_ports port 1025-65535    # unregistered ports
</I>&gt;<i> acl Safe_ports port 280        # http-mgmt
</I>&gt;<i> acl Safe_ports port 488        # gss-http
</I>&gt;<i> acl Safe_ports port 591        # filemaker
</I>&gt;<i> acl Safe_ports port 777        # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow mynet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow all
</I>&gt;<i> http_port 3128
</I>&gt;<i> cache_dir ufs /usr/local/cache 10000 16 256
</I>&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;<i> refresh_pattern ^ftp:        1440    20%    10080
</I>&gt;<i> refresh_pattern ^gopher:    1440    0%    1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 3600       90%     43200
</I>&gt;<i> refresh_pattern .        0    20%    4320
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> but when I use 192.168.0.200 in my client machine as gateway ...
</I>&gt;<i> internet is not working and I cant see logs in access.log
</I>&gt;<i>
</I>&gt;<i> But when I use this IP in my browser it is working and showing logs but
</I>&gt;<i> with my tplink router  gateway i.e 192.168.0.1.
</I>&gt;<i>
</I>&gt;<i> IPTable rules :
</I>&gt;<i> num  target     prot opt source               destination
</I>&gt;<i> 1    DNAT       tcp  --  anywhere             anywhere             tcp
</I>&gt;<i> dpt:http to:192.168.0.200:3128 &lt;<A HREF="http://192.168.0.200:3128">http://192.168.0.200:3128</A>&gt;
</I>&gt;<i> 2    REDIRECT   tcp  --  anywhere             anywhere             tcp
</I>&gt;<i> dpt:http redir ports 3128
</I>&gt;<i>
</I>&gt;<i> Chain INPUT (policy ACCEPT)
</I>&gt;<i> num  target     prot opt source               destination
</I>&gt;<i>
</I>&gt;<i> Chain OUTPUT (policy ACCEPT)
</I>&gt;<i> num  target     prot opt source               destination
</I>&gt;<i>
</I>&gt;<i> Chain POSTROUTING (policy ACCEPT)
</I>&gt;<i> num  target     prot opt source               destination
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Please tell me what I am missing in IPtables and squid3 configuration .
</I>&gt;<i> I tried both transparent as well as intercept option but I think I have
</I>&gt;<i> issue with iptables or may be configuration issue.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Regards,
Klavs Klavsen, GSEC - <A HREF="https://lists.squid-cache.org/listinfo/squid-users">kl at vsen.dk</A> - <A HREF="http://www.vsen.dk">http://www.vsen.dk</A> - Tlf. 61281200

&quot;Those who do not understand Unix are condemned to reinvent it, poorly.&quot;
   --Henry Spencer


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003814.html">[squid-users] Transparent Squid Proxy Server
</A></li>
	<LI>Next message (by thread): <A HREF="003820.html">[squid-users] Transparent Squid Proxy Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3815">[ date ]</a>
              <a href="thread.html#3815">[ thread ]</a>
              <a href="subject.html#3815">[ subject ]</a>
              <a href="author.html#3815">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
