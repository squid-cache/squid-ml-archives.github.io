<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Squid Proxy Server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Squid%20Proxy%20Server&In-Reply-To=%3C556DBF13.4070000%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003815.html">
   <LINK REL="Next"  HREF="003821.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Squid Proxy Server</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Squid%20Proxy%20Server&In-Reply-To=%3C556DBF13.4070000%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent Squid Proxy Server">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun  2 14:34:59 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003815.html">[squid-users] Transparent Squid Proxy Server
</A></li>
        <LI>Next message (by thread): <A HREF="003821.html">[squid-users] Transparent Squid Proxy Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3820">[ date ]</a>
              <a href="thread.html#3820">[ thread ]</a>
              <a href="subject.html#3820">[ subject ]</a>
              <a href="author.html#3820">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/06/2015 1:20 a.m., Klavs Klavsen wrote:
&gt;<i> I have this in my squid server for it to work:
</I>
The key words there are ... *in my Squid server*

Reet did it on the router. Which was the first mistake.

The router needs routing rules (not NAT) to deliver the clients packets
to Squid machine where the interception happens like below.

The second mistake was http_port configuration. Squid requires two
http_port lines. Port 3128 for regular proxy traffic, and another random
port for interception (our how-tos use 3129).


&gt;<i> *mangle
</I>&gt;<i> :PREROUTING ACCEPT [190:618576]
</I>&gt;<i> :INPUT ACCEPT [190:618576]
</I>&gt;<i> :FORWARD ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [163:41506]
</I>&gt;<i> :POSTROUTING ACCEPT [166:42334]
</I>&gt;<i> -A PREROUTING -d $myip/32 -p tcp -m multiport --dports 3129 -m comment
</I>&gt;<i> --comment &quot;002 drop squid direct traffic http - we only allow captured
</I>&gt;<i> traffic&quot; -j DROP
</I>&gt;<i> -A PREROUTING -d $myip/32 -p tcp -m multiport --dports 3130 -m comment
</I>&gt;<i> --comment &quot;002 drop squid direct traffic https - we only allow captured
</I>&gt;<i> traffic&quot; -j DROP
</I>&gt;<i> COMMIT
</I>

NOTE to Klavs:
  loading the &quot;multiport&quot; kernel module seems overkill for a single-port
match.

&gt;<i> # Completed on Wed Apr  1 10:28:22 2015
</I>&gt;<i> # Generated by iptables-save v1.4.21 on Wed Apr  1 10:28:22 2015
</I>&gt;<i> *nat
</I>&gt;<i> :PREROUTING ACCEPT [1:36]
</I>&gt;<i> :INPUT ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [30:2079]
</I>&gt;<i> :POSTROUTING ACCEPT [30:2079]
</I>&gt;<i> -A PREROUTING -s $myip/32 -p tcp -m multiport --dports 80 -m comment
</I>&gt;<i> --comment &quot;000 allow squid http - so its traffic does not get captured&quot;
</I>&gt;<i> -j ACCEPT
</I>&gt;<i> -A PREROUTING -s $myip/32 -p tcp -m multiport --dports 443 -m comment
</I>&gt;<i> --comment &quot;000 allow squid https - so its traffic does not get captured&quot;
</I>&gt;<i> -j ACCEPT
</I>&gt;<i> -A PREROUTING -p tcp -m multiport --dports 80 -m comment --comment &quot;001
</I>&gt;<i> capture http to squid&quot; -j DNAT --to-destination $myip:3129
</I>&gt;<i> -A PREROUTING -p tcp -m multiport --dports 443 -m comment --comment &quot;001
</I>&gt;<i> capture https to squid&quot; -j DNAT --to-destination $myip:3130
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Wed Apr  1 10:28:22 2015
</I>&gt;<i> # Generated by iptables-save v1.4.21 on Wed Apr  1 10:28:22 2015
</I>&gt;<i> *filter
</I>&gt;<i> :INPUT ACCEPT [0:0]
</I>&gt;<i> :FORWARD ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [1:184]
</I>&gt;<i> -A INPUT -p tcp -m multiport --ports 3129 -m comment --comment &quot;000
</I>&gt;<i> allow squid http intercept&quot; -j ACCEPT
</I>&gt;<i> -A INPUT -p tcp -m multiport --ports 3130 -m comment --comment &quot;000
</I>&gt;<i> allow squid https intercept&quot; -j ACCEPT
</I>&gt;<i> -A INPUT -p tcp -m multiport --ports 3128 -m comment --comment &quot;000
</I>&gt;<i> allow squid proxy&quot; -j ACCEPT
</I>&gt;<i> 
</I>&gt;<i> and squid conf (mind you - squid 3.4)
</I>&gt;<i> ssl_bump                       server-first all
</I>&gt;<i> sslproxy_flags                 DONT_VERIFY_PEER
</I>&gt;<i> sslcrtd_children               8 startup=1 idle=1
</I>&gt;<i> sslcrtd_program                /usr/lib64/squid/ssl_crtd -s
</I>&gt;<i> /etc/ssl/certs/cache/ -M 4MB
</I>&gt;<i> https_port                     3130 intercept ssl-bump
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> key=/etc/squid/ca.private cert=/etc/squid/ca.cert
</I>&gt;<i> shutdown_lifetime              3
</I>&gt;<i> always_direct                  allow all
</I>&gt;<i> sslproxy_cert_error            allow all
</I>&gt;<i> http_port                      3129 intercept
</I>&gt;<i> 
</I>
FYI: DONT_VERIFY_PEER, &quot;always_direct allow all&quot;, and
&quot;slproxy_cert_error allow all&quot; have not been good ideas since 3.2.
dont-verify actually inhibits the Mimic functions which give
server-first bumping most of its usefulness.



&gt;<i> Reet Vyas wrote on 06/02/2015 02:31 PM:
</I>&gt;&gt;<i> I am trying to configure transparent squid proxy on ubuntu 14.04 Server
</I>&gt;&gt;<i> and squid 3.3 version I am using
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My Lan and Wan settings
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> eth0      Link encap:Ethernet  HWaddr 00:1e:67:cf:59:74
</I>&gt;&gt;<i>            inet addr:116.72.*.*  Bcast:116.72.155.255  Mask:255.255.252.0
</I>&gt;&gt;<i>            inet6 addr: fe80::21e:67ff:fecf:5974/64 Scope:Link
</I>&gt;&gt;<i>            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</I>&gt;&gt;<i>            RX packets:238950 errors:0 dropped:0 overruns:0 frame:0
</I>&gt;&gt;<i>            TX packets:236104 errors:0 dropped:0 overruns:0 carrier:0
</I>&gt;&gt;<i>            collisions:0 txqueuelen:1000
</I>&gt;&gt;<i>            RX bytes:22219047 (22.2 MB)  TX bytes:17390502 (17.3 MB)
</I>&gt;&gt;<i>            Interrupt:16 Memory:d0a00000-d0a20000
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> eth1      Link encap:Ethernet  HWaddr 00:1e:67:cf:59:75
</I>&gt;&gt;<i>            inet addr:192.168.0.200  Bcast:192.168.0.255 
</I>&gt;&gt;<i> Mask:255.255.255.0
</I>&gt;&gt;<i>            inet6 addr: fe80::21e:67ff:fecf:5975/64 Scope:Link
</I>&gt;&gt;<i>            UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</I>&gt;&gt;<i>            RX packets:96965 errors:0 dropped:0 overruns:0 frame:0
</I>&gt;&gt;<i>            TX packets:11785 errors:0 dropped:0 overruns:0 carrier:0
</I>&gt;&gt;<i>            collisions:0 txqueuelen:1000
</I>&gt;&gt;<i>            RX bytes:10764615 (10.7 MB)  TX bytes:7151763 (7.1 MB)
</I>&gt;&gt;<i>            Interrupt:17 Memory:d0900000-d0920000
</I>

Er, thems not settings. Thems traffic statistics.

Not that it matters, but give these a try:
 ip addr show
 ip -4 route show
 ip -6 route show


&gt;&gt;<i>
</I>&gt;&gt;<i> my squid.conf file
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl mynet src 116.72.152.37 192.168.0.0/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt;    #
</I>&gt;&gt;<i> RFC1918 possible internal network
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80        # http
</I>&gt;&gt;<i> acl Safe_ports port 21        # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443        # https
</I>&gt;&gt;<i> acl Safe_ports port 70        # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210        # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535    # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280        # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488        # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591        # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777        # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access allow mynet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> http_access allow all
</I>&gt;&gt;<i> http_port 3128
</I>
One listening port setup to receive explicit proxy traffic (ie from a
maually configured browser).

... missing an intercept port.


&gt;&gt;<i> cache_dir ufs /usr/local/cache 10000 16 256
</I>&gt;&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;&gt;<i> refresh_pattern ^ftp:        1440    20%    10080
</I>&gt;&gt;<i> refresh_pattern ^gopher:    1440    0%    1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0
</I>&gt;&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 3600       90%     43200
</I>&gt;&gt;<i> refresh_pattern .        0    20%    4320
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but when I use 192.168.0.200 in my client machine as gateway ...
</I>&gt;&gt;<i> internet is not working and I cant see logs in access.log
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But when I use this IP in my browser it is working and showing logs but
</I>&gt;&gt;<i> with my tplink router  gateway i.e 192.168.0.1.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IPTable rules :
</I>&gt;&gt;<i> num  target     prot opt source               destination
</I>&gt;&gt;<i> 1    DNAT       tcp  --  anywhere             anywhere             tcp
</I>&gt;&gt;<i> dpt:http to:192.168.0.200:3128 &lt;<A HREF="http://192.168.0.200:3128">http://192.168.0.200:3128</A>&gt;
</I>&gt;&gt;<i> 2    REDIRECT   tcp  --  anywhere             anywhere             tcp
</I>&gt;&gt;<i> dpt:http redir ports 3128
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain INPUT (policy ACCEPT)
</I>&gt;&gt;<i> num  target     prot opt source               destination
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain OUTPUT (policy ACCEPT)
</I>&gt;&gt;<i> num  target     prot opt source               destination
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain POSTROUTING (policy ACCEPT)
</I>&gt;&gt;<i> num  target     prot opt source               destination
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please tell me what I am missing in IPtables and squid3 configuration .
</I>&gt;&gt;<i> I tried both transparent as well as intercept option but I think I have
</I>&gt;&gt;<i> issue with iptables or may be configuration issue.
</I>&gt;&gt;<i>
</I>

see the wiki page(s):

One of these two configs on the router:
 &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>&gt;


This one on the Squid box:
 &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003815.html">[squid-users] Transparent Squid Proxy Server
</A></li>
	<LI>Next message (by thread): <A HREF="003821.html">[squid-users] Transparent Squid Proxy Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3820">[ date ]</a>
              <a href="thread.html#3820">[ thread ]</a>
              <a href="subject.html#3820">[ subject ]</a>
              <a href="author.html#3820">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
