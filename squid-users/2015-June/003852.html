<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_crtd breaks after short time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_crtd%20breaks%20after%20short%20time&In-Reply-To=%3C55703588.2060009%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003845.html">
   <LINK REL="Next"  HREF="003858.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_crtd breaks after short time</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_crtd%20breaks%20after%20short%20time&In-Reply-To=%3C55703588.2060009%40treenet.co.nz%3E"
       TITLE="[squid-users] ssl_crtd breaks after short time">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun  4 11:24:56 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003845.html">[squid-users] ssl_crtd breaks after short time
</A></li>
        <LI>Next message (by thread): <A HREF="003858.html">[squid-users] ssl_crtd breaks after short time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3852">[ date ]</a>
              <a href="thread.html#3852">[ thread ]</a>
              <a href="subject.html#3852">[ subject ]</a>
              <a href="author.html#3852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/06/2015 7:55 p.m., Klavs Klavsen wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> I tried taking the config from James.. but I have the exact same issue
</I>&gt;<i> as described below :(
</I>&gt;<i> 
</I>&gt;<i> After adding the extra logging from James config - I get this in
</I>&gt;<i> access_log:
</I>&gt;<i> 1433404085.331      0 10.47.171.244 TCP_DENIED/200 0 CONNECT
</I>&gt;<i> 216.58.209.106:443 - HIER_NONE/- -
</I>&gt;<i> 
</I>&gt;<i> which makes it seem as if squid does NOT see the url I'm trying to
</I>&gt;<i> access :(
</I>
That log line is generated *before* TLS bumping is started. All Squid is
working with at that point is the TCP SYN packet details.

The DENIED makes sense because all your http_access allow rules require
&quot;<A HREF="scheme://...">scheme://...</A>&quot; absolute-URI syntax which never exists in CONNECT, even
if a domain name known. HTTP CONNECT requests *always* contains
authority-URI syntax URLs (IP:port or hostname:port).

The 200 is odd. It implies that Squid spliced or bumped the connection
despite the denial. Though its probably just a default value sliping in
wrongly from somewhere.


&gt;<i> 
</I>&gt;<i> Remember all this worked with 3.4.12 :(
</I>
No, the code does not even exist in those older &quot;working&quot; versions.


Squid 3.1, 3.2 bumping:
 fetch the ClientHello and bump

Squid 3.3, 3.4 bumping:
 fetch the ClientHello and maybe bump, or ...
 fetch the ServerHello and bump with mimic certs.

Squid 3.5 bumping:
 fetch TCP details (fake a CONNECT IP:port request), check if pass-thru,
or ...
 fetch TLS ClientHello, check what to do and do it, or ...
 fetch TLS ServerHello, check what to do and do it.


What you are seeing in access.log is that new first step.


&gt;<i> 
</I>&gt;<i> My config as it is now:
</I>&gt;<i> acl localhost src 127.0.0.1/32 ::1
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #only contains one ip range - which I'm not accessing
</I>&gt;<i> #I don't quite understand what the purpose of this &quot;broken&quot; thing
</I>&gt;<i> # is and what it does :(
</I>
AFAIK it lists IPs of servers where TLS is being used properly so
bumping does not work, or TLS used so badly that they break when bumped.
Its hard to tell automatically, but if Squid can identify such by itself
it will just splice. This is to catch the other cases.

 Its your choice whether you allow them to try and bump based on server
cert details at step3, or to outright reject.

The way its used here those servers will always be spliced even if SNI
and/or cert domain are found. The breakage might be a cipher choice for
example.


&gt;<i> acl broken dst &quot;/etc/squid/broken.txt&quot;
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 broken
</I>&gt;<i> ssl_bump peek step2 broken
</I>&gt;<i> ssl_bump splice broken
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # user-defined ACLs
</I>&gt;<i> acl okweb-urls url_regex ^<A HREF="http://www.youtube.com/">http://www.youtube.com/</A>
</I>&gt;<i> ^<A HREF="http://vimeo.com/api/oembed.json$">http://vimeo.com/api/oembed.json$</A>
</I>&gt;<i> ^<A HREF="https://www.google.com/accounts/ClientLogin$">https://www.google.com/accounts/ClientLogin$</A>
</I>&gt;<i> ^<A HREF="https://www.googleapis.com/analytics/">https://www.googleapis.com/analytics/</A>
</I>&gt;<i> acl testurls url_regex ^<A HREF="http://www.dr.dk/$">http://www.dr.dk/$</A> ^<A HREF="https://www.google.dk/$">https://www.google.dk/$</A>
</I>&gt;<i> acl testbox src 10.xx.138.168
</I>&gt;<i> acl testsrv1 src 10.xx.130.50
</I>&gt;<i> 
</I>&gt;<i> http_access allow testurls testbox
</I>&gt;<i> http_access allow testurls testsrv1
</I>&gt;<i> http_access allow okweb-urls testsrv1
</I>

Where is the rules that will allow the CONNECT raw-IP:port request
through to start bumping? the url_regex ACLs do not match for them.

I suggest:
 acl bumpedPorts myportname 3129
 acl bumpedPorts myportname 3130
 http_access allow CONNECT bumpedPorts


&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> coredump_dir                   /var/spool/squid
</I>&gt;<i> maximum_object_size_in_memory  512 KB
</I>&gt;<i> maximum_object_size            4096 KB
</I>&gt;<i> ignore_expect_100              off
</I>&gt;<i> cache_mgr                      root
</I>&gt;<i> client_persistent_connections  on
</I>&gt;<i> server_persistent_connections  on
</I>&gt;<i> access_log                     /var/log/squid/access.log squid
</I>&gt;<i> 
</I>&gt;<i> # user-defined configuration settings from config_hash
</I>&gt;<i> ssl_bump                       server-first all
</I>&gt;<i> sslcrtd_children               8 startup=1 idle=1
</I>&gt;<i> sslcrtd_program                /usr/lib64/squid/ssl_crtd -s
</I>&gt;<i> /etc/ssl/certs/cache/ -M 4MB
</I>&gt;<i> https_port                     3130 intercept ssl-bump
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/etc/squid/ca.cert cafile=/etc/squid/ca.cert
</I>&gt;<i> key=/etc/squid/ca.private sslflags=NO_SESSION_REUSE
</I>&gt;<i> http_port                      3129 intercept
</I>&gt;<i> 
</I>&gt;<i> logformat mine %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %ssl::&gt;sni
</I>&gt;<i> %ssl::&gt;cert_subject %&gt;Hs %&lt;st %Ss:%Sh %ssl::bump_mode
</I>&gt;<i> 
</I>&gt;<i> access_log syslog:daemon.info mine
</I>&gt;<i> 
</I>
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003845.html">[squid-users] ssl_crtd breaks after short time
</A></li>
	<LI>Next message (by thread): <A HREF="003858.html">[squid-users] ssl_crtd breaks after short time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3852">[ date ]</a>
              <a href="thread.html#3852">[ thread ]</a>
              <a href="subject.html#3852">[ subject ]</a>
              <a href="author.html#3852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
