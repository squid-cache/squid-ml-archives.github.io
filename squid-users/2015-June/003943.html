<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High-availability and load-balancing between N squid servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High-availability%20and%20load-balancing%20between%20N%0A%20squid%20servers&In-Reply-To=%3C5576079B.1030203%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003941.html">
   <LINK REL="Next"  HREF="003948.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High-availability and load-balancing between N squid servers</H1>
    <B>Brendan Kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High-availability%20and%20load-balancing%20between%20N%0A%20squid%20servers&In-Reply-To=%3C5576079B.1030203%40gmail.com%3E"
       TITLE="[squid-users] High-availability and load-balancing between N squid servers">bpk678 at gmail.com
       </A><BR>
    <I>Mon Jun  8 21:22:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003941.html">[squid-users] High-availability and load-balancing between N squid	servers
</A></li>
        <LI>Next message (by thread): <A HREF="003948.html">[squid-users] High-availability and load-balancing between N squid servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3943">[ date ]</a>
              <a href="thread.html#3943">[ thread ]</a>
              <a href="subject.html#3943">[ subject ]</a>
              <a href="author.html#3943">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/08/2015 04:23 PM, Rafael Akchurin wrote:
&gt;<i> Hello all,
</I>&gt;<i>
</I>&gt;<i> What is the recommended approach to perform load balancing and high availability between N squid servers?
</I>&gt;<i> I have the following list of requirements to fullfil:
</I>&gt;<i>
</I>&gt;<i> 1) Manage N squid servers that share cache (as far as i understand is done using cache_peer). Desirable.
</I>&gt;<i> 2) Availability: if any of the N servers fails the clients are redirected to the rest N-1. Prefferable.
</I>&gt;<i> 3) Scalability: The load is distributed (round-roubin or some other algorithm) between N servers, if a new server is added (N + 1) new clients will be able to use it reducing the load on the rest N. Prefferable.
</I>&gt;<i> 4) I need to be able to identify client IP addresses on the squid side and/or perform Squid authentication. The client IP and User Name are later to be passed to the ICAP server to scan the HTTP(S) request/response contents using icap_send_client_ip and icap_send_client_username. Very important requirement.
</I>&gt;<i> 5) I need to support both HTTP and HTTPS connections with support of selective SSL Bump. I.e. for some web sites I do not want to look inside SSL so that original site's certificates are used for encryption. Very important requirement too.
</I>&gt;<i>
</I>&gt;<i> I know that strictly for HTTP I could use HAProxy with Forward-For or something similar, but the 5th requirement is very important and I could not find a way to handle SSL with HAProxy properly.
</I>&gt;<i>
</I>&gt;<i> The only idea that comes to my mind is to use some form of round-robin load balancing on the level of DNS, but it has its own drawbacks (should be able to check availability of my N servers + not real balancing, more like distribution).
</I>&gt;<i> Any help/thoughts are appreciated.
</I>&gt;<i>
</I>&gt;<i> Thank you!
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i> Diladele B.V.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>1 - you are likely going to want to create a config for peers:
acl peers src 192.168.1.1/32
acl peers src 192.168.1.2/32
...
http_access allow peers
...
cache_peer 192.168.1.1 sibling 3128 4827 htcp=no-clr
cache_peer 192.168.1.2 sibling 3128 4827 htcp=no-clr
...

remember to make sure all peers are properly represented

2 - use a load balancing device or software, and this is part-and-parcel 
to that functionality

3 - load balancers give you several options.  i use &quot;least connections&quot; 
which is a bit more intelligent that straight round-robin.

4 - depending on how you setup your load balancer, you might be able to 
get the client IP without playing games.  if you cant see the client IP 
as the source of the connection, you will have to work with the 
&quot;X-Forwarded-For&quot; header, like so:
...
follow_x_forwarded_for allow svc_chk
follow_x_forwarded_for deny all
...*
*acl_uses_indirect_client on*
*...*
*log_uses_indirect_client on*
*...

Also, your auth methods may have nuances that need to be accounted for 
(Kerberos and load balancing requires some extra steps).

  5 - HAProxy will work for HTTP and HTTPS.  remember, your clients 
arent talking to HAProxy for HTTP proxying.  the port you load balance 
on with HAProxy is not the HTTP proxy process.  All HAProxy has to do is 
hand the connection off to Squid which will handle the HTTP or HTTPS or 
HTTPS-with-SSL-Bump, independent of anything HAProxy sees or cares about.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150608/001004b4/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150608/001004b4/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003941.html">[squid-users] High-availability and load-balancing between N squid	servers
</A></li>
	<LI>Next message (by thread): <A HREF="003948.html">[squid-users] High-availability and load-balancing between N squid servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3943">[ date ]</a>
              <a href="thread.html#3943">[ thread ]</a>
              <a href="subject.html#3943">[ subject ]</a>
              <a href="author.html#3943">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
