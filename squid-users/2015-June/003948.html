<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High-availability and load-balancing between N squid servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High-availability%20and%20load-balancing%20between%20N%0A%20squid%20servers&In-Reply-To=%3C55761FED.4030900%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003943.html">
   <LINK REL="Next"  HREF="003952.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High-availability and load-balancing between N squid servers</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High-availability%20and%20load-balancing%20between%20N%0A%20squid%20servers&In-Reply-To=%3C55761FED.4030900%40treenet.co.nz%3E"
       TITLE="[squid-users] High-availability and load-balancing between N squid servers">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jun  8 23:06:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003943.html">[squid-users] High-availability and load-balancing between N squid servers
</A></li>
        <LI>Next message (by thread): <A HREF="003952.html">[squid-users] High-availability and load-balancing between N squid servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3948">[ date ]</a>
              <a href="thread.html#3948">[ thread ]</a>
              <a href="subject.html#3948">[ subject ]</a>
              <a href="author.html#3948">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/06/2015 9:22 a.m., Brendan Kearney wrote:
&gt;<i> On 06/08/2015 04:23 PM, Rafael Akchurin wrote:
</I>&gt;&gt;<i> Hello all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What is the recommended approach to perform load balancing and high
</I>&gt;&gt;<i> availability between N squid servers?
</I>&gt;&gt;<i> I have the following list of requirements to fullfil:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) Manage N squid servers that share cache (as far as i understand is
</I>&gt;&gt;<i> done using cache_peer). Desirable.
</I>&gt;&gt;<i> 2) Availability: if any of the N servers fails the clients are
</I>&gt;&gt;<i> redirected to the rest N-1. Prefferable.
</I>&gt;&gt;<i> 3) Scalability: The load is distributed (round-roubin or some other
</I>&gt;&gt;<i> algorithm) between N servers, if a new server is added (N + 1) new
</I>&gt;&gt;<i> clients will be able to use it reducing the load on the rest N.
</I>&gt;&gt;<i> Prefferable.
</I>&gt;&gt;<i> 4) I need to be able to identify client IP addresses on the squid side
</I>&gt;&gt;<i> and/or perform Squid authentication. The client IP and User Name are
</I>&gt;&gt;<i> later to be passed to the ICAP server to scan the HTTP(S)
</I>&gt;&gt;<i> request/response contents using icap_send_client_ip and
</I>&gt;&gt;<i> icap_send_client_username. Very important requirement.
</I>&gt;&gt;<i> 5) I need to support both HTTP and HTTPS connections with support of
</I>&gt;&gt;<i> selective SSL Bump. I.e. for some web sites I do not want to look
</I>&gt;&gt;<i> inside SSL so that original site's certificates are used for
</I>&gt;&gt;<i> encryption. Very important requirement too.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know that strictly for HTTP I could use HAProxy with Forward-For or
</I>&gt;&gt;<i> something similar, but the 5th requirement is very important and I
</I>&gt;&gt;<i> could not find a way to handle SSL with HAProxy properly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The only idea that comes to my mind is to use some form of round-robin
</I>&gt;&gt;<i> load balancing on the level of DNS, but it has its own drawbacks
</I>&gt;&gt;<i> (should be able to check availability of my N servers + not real
</I>&gt;&gt;<i> balancing, more like distribution).
</I>&gt;&gt;<i> Any help/thoughts are appreciated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best regards,
</I>&gt;&gt;<i> Rafael Akchurin
</I>&gt;&gt;<i> Diladele B.V.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 1 - you are likely going to want to create a config for peers:
</I>&gt;<i> acl peers src 192.168.1.1/32
</I>&gt;<i> acl peers src 192.168.1.2/32
</I>&gt;<i> ...
</I>&gt;<i> http_access allow peers
</I>&gt;<i> ...
</I>&gt;<i> cache_peer 192.168.1.1 sibling 3128 4827 htcp=no-clr
</I>&gt;<i> cache_peer 192.168.1.2 sibling 3128 4827 htcp=no-clr
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> remember to make sure all peers are properly represented
</I>&gt;<i> 
</I>&gt;<i> 2 - use a load balancing device or software, and this is part-and-parcel
</I>&gt;<i> to that functionality
</I>&gt;<i> 
</I>&gt;<i> 3 - load balancers give you several options.  i use &quot;least connections&quot;
</I>&gt;<i> which is a bit more intelligent that straight round-robin.
</I>&gt;<i> 
</I>&gt;<i> 4 - depending on how you setup your load balancer, you might be able to
</I>&gt;<i> get the client IP without playing games.  if you cant see the client IP
</I>&gt;<i> as the source of the connection, you will have to work with the
</I>&gt;<i> &quot;X-Forwarded-For&quot; header, like so:
</I>&gt;<i> ...
</I>&gt;<i> follow_x_forwarded_for allow svc_chk
</I>&gt;<i> follow_x_forwarded_for deny all
</I>&gt;<i> ...*
</I>&gt;<i> *acl_uses_indirect_client on*
</I>&gt;<i> *...*
</I>&gt;<i> *log_uses_indirect_client on*
</I>&gt;<i> *...
</I>&gt;<i> 
</I>&gt;<i> Also, your auth methods may have nuances that need to be accounted for
</I>&gt;<i> (Kerberos and load balancing requires some extra steps).
</I>&gt;<i> 
</I>&gt;<i>  5 - HAProxy will work for HTTP and HTTPS.  remember, your clients arent
</I>&gt;<i> talking to HAProxy for HTTP proxying.  the port you load balance on with
</I>&gt;<i> HAProxy is not the HTTP proxy process.  All HAProxy has to do is hand
</I>&gt;<i> the connection off to Squid which will handle the HTTP or HTTPS or
</I>&gt;<i> HTTPS-with-SSL-Bump, independent of anything HAProxy sees or cares about.
</I>
There seems to be a bit of a myth going around about how HAProxy does
load balancing.

HAProxy is an HTTP layer proxy. Just like Squid.

They both do the same things to received TCP connections. But HAProxy
supports less HTTP features, so its somewhat simpler processing is also
a bit faster when you want it to be a semi-dumb load balancer.


We are somewhat recently added basic support for the PROXY protocol to
Squid. So HAProxy can relay port 80 connections to Squid-3.5+ without
processing them fully. However Squid does not yet support that on
https_port, which means the TLS connections still wont have client IP
details passed through.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003943.html">[squid-users] High-availability and load-balancing between N squid servers
</A></li>
	<LI>Next message (by thread): <A HREF="003952.html">[squid-users] High-availability and load-balancing between N squid servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3948">[ date ]</a>
              <a href="thread.html#3948">[ thread ]</a>
              <a href="subject.html#3948">[ subject ]</a>
              <a href="author.html#3948">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
