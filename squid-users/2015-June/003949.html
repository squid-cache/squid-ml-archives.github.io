<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid cache_peer in tproxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20cache_peer%20in%20tproxy&In-Reply-To=%3C557626A8.9060806%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003946.html">
   <LINK REL="Next"  HREF="003928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid cache_peer in tproxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20cache_peer%20in%20tproxy&In-Reply-To=%3C557626A8.9060806%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid cache_peer in tproxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jun  8 23:35:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003946.html">[squid-users] Squid cache_peer in tproxy
</A></li>
        <LI>Next message (by thread): <A HREF="003928.html">[squid-users] Squid doesn't write logs via rsyslog
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3949">[ date ]</a>
              <a href="thread.html#3949">[ thread ]</a>
              <a href="subject.html#3949">[ subject ]</a>
              <a href="author.html#3949">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/06/2015 10:32 a.m., Stakres wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Ok, it does confirm our tests.
</I>&gt;<i> 
</I>&gt;<i> Is there a way to do this:
</I>&gt;<i> users -&gt; squid1 tproxy -&gt; squid2/squid3 tproxy -&gt; internet (seeing the user
</I>&gt;<i> ips) ?
</I>&gt;<i> or is it impossible ?
</I>

Only by intercepting the squid1 port 80 outgoing connections. cache_peer
cannot do that.


&gt;<i> 
</I>&gt;<i> in the wiki, there is an option &quot;no-tproxy&quot; in the cache_peer, it would be
</I>&gt;<i> nice to have a &quot;keep-tproxy&quot; 
</I>
I think you misunderstand how TPROXY works. It is part of the *TCP
connection* state. There are different TCP connections inbound and
outbound from each Squid.

Software X opens a TPROXY listening port, TCP connections delivered
there are remembered by the kernel. When software X opens outgoing
connections and tells the kernel they were received via the TPROXY port
the kernel then allows software X to bind() the src/dst IPs on those
outgoing TCP connections to any of the IPs it has on the open
connections to the TPROXY listening port.

Now...

* the *dst-IP* on a cache_peer connection is the peer proxy IP. Always,
otherwise it would not arrive at the peer.

* Squid interceptors will ensure that any port 80/443 outgoing TCP
connection is going to the same server TPROXY tells it the client was
going to (ORIGINAL_DST). **


Therefore if squid1 has a cache_peer pointing at a TPROXY kernel rule on
squid2/squid3 the outbound connections from squid2/squid3 will be
guaranteed to be sent back to themselves. Repeat until either
squid2/squid3 notices the loop, or the server TCP sockets are all gone,
or server runs out of memory, or the TCP networking stack collapses.
Whichever occurs first and none of it nice.


** due to CVE-2009-0801. The rather innocent vuln text description is
the tip of an iceberg of problems worthy of sinking the titanic.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003946.html">[squid-users] Squid cache_peer in tproxy
</A></li>
	<LI>Next message (by thread): <A HREF="003928.html">[squid-users] Squid doesn't write logs via rsyslog
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3949">[ date ]</a>
              <a href="thread.html#3949">[ thread ]</a>
              <a href="subject.html#3949">[ subject ]</a>
              <a href="author.html#3949">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
