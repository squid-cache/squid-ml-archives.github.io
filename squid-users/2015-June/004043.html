<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] grab hostnames via SNI to use it for parent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20grab%20hostnames%20via%20SNI%20to%20use%20it%20for%20parent%20proxy&In-Reply-To=%3Cb219dbaabdd86781a431a13ff7f65b10%40zise.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003884.html">
   <LINK REL="Next"  HREF="003880.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] grab hostnames via SNI to use it for parent proxy</H1>
    <B>Atman Sense</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20grab%20hostnames%20via%20SNI%20to%20use%20it%20for%20parent%20proxy&In-Reply-To=%3Cb219dbaabdd86781a431a13ff7f65b10%40zise.de%3E"
       TITLE="[squid-users] grab hostnames via SNI to use it for parent proxy">atman.sense at zise.de
       </A><BR>
    <I>Fri Jun 12 21:04:39 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003884.html">[squid-users] grab hostnames via SNI to use it for parent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003880.html">[squid-users] How to stop &quot; ICP is disabled! Cannot send ICP	request to peer.&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4043">[ date ]</a>
              <a href="thread.html#4043">[ thread ]</a>
              <a href="subject.html#4043">[ subject ]</a>
              <a href="author.html#4043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am 2015-06-05 00:22, schrieb Amos Jeffries:
&gt;<i> 
</I>&gt;<i> You can block by SNI in the ssl_bump checks without having bumped the
</I>&gt;<i> connection.
</I>&gt;<i> 
</I>&gt;<i> Like so:
</I>&gt;<i> 
</I>&gt;<i>  # get the public TLS metadata (includes SNI)
</I>&gt;<i>  ssl_bump peek all
</I>&gt;<i> 
</I>&gt;<i>  # block based on SNI matching (or server cert matching)
</I>&gt;<i>  acl blocked ssl::server_name .example.com
</I>&gt;<i>  ssl_bump terminate blocked
</I>&gt;<i> 
</I>&gt;<i>  # tunnel (no decrypting) for everything else
</I>&gt;<i>  ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Note that you do have to allow the &quot;CONNECT raw-IP:443 ...&quot; requests
</I>&gt;<i> through http_access to the bumping logics.
</I>&gt;<i> 
</I>
that's nice. Thanks for that.

It would be nice if I could handle the blocklist on privoxy centrally 
(my users want to disable the blocks occasionally and can do that 
through a privoxy web interface). I tried to find out when squid is 
sending &quot;CONNECT IP:PORT&quot; to the parent proxy in hope to manipulate it 
to &quot;CONNECT HOSTNAME:PORT&quot;. And I found it in tunnel.cc:1052 
(mb.Printf(&quot;CONNECT %s HTTP/1.1\r\n&quot;, tunnelState-&gt;url);). After some 
investigating with gdb, I found the SNI hostname in this context in 
tunnelState-&gt;http-&gt;getConn()-&gt;serverBump()-&gt;clientSni.c_str(). Currently 
I'm testing with this patch:

--- src/tunnel.cc   2015-05-01 13:27:20.000000000 +0200
+++ src/tunnel.cc   2015-06-07 14:10:37.098895939 +0200
@@ -1049,7 +1049,13 @@
      flags.proxying = tunnelState-&gt;request-&gt;flags.proxying;
      MemBuf mb;
      mb.init();
-    mb.Printf(&quot;CONNECT %s HTTP/1.1\r\n&quot;, tunnelState-&gt;url);
+    //use SNI hostname if it exists
+    if 
(strlen(tunnelState-&gt;http-&gt;getConn()-&gt;serverBump()-&gt;clientSni.c_str()) &gt; 
1) {
+        mb.Printf(&quot;CONNECT %s:%hu HTTP/1.1\r\n&quot;, 
tunnelState-&gt;http-&gt;getConn()-&gt;serverBump()-&gt;clientSni.c_str(), 
tunnelState-&gt;request-&gt;port);
+    } else {
+        mb.Printf(&quot;CONNECT %s HTTP/1.1\r\n&quot;, tunnelState-&gt;url);
+    }
+
      
HttpStateData::httpBuildRequestHeader(tunnelState-&gt;request.getRaw(),
                                            NULL,         /* StoreEntry 
*/
                                            tunnelState-&gt;al,          /* 
AccessLogEntry */

This works quite well, but when privoxy blocks a &quot;CONNECT&quot; request, 
squid doesn't understand it and the client connection is keeped open 
until the client times out:
     HttpMsg.cc(176) parse: HttpMsg::parse success (275 bytes) near 
'HTTP/1.1 403 Request blocked by Privoxy'
     tunnel.cc(459) logicError: local=xxx:42093 remote=xxx:8118 FD 17 
flags=1 closing on error: unsupported CONNECT response status code
A look in tunnel.cc reveals, that it only accept HTTP 200. Thats ok, but 
it would be nice to disconnect both client and parent proxy to avoid 
timeouts. Do you have an idea how to disconnect the client immediately 
after non HTTP 200 responses?


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003884.html">[squid-users] grab hostnames via SNI to use it for parent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003880.html">[squid-users] How to stop &quot; ICP is disabled! Cannot send ICP	request to peer.&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4043">[ date ]</a>
              <a href="thread.html#4043">[ thread ]</a>
              <a href="subject.html#4043">[ subject ]</a>
              <a href="author.html#4043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
