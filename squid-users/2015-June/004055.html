<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20no%20fallback%20to%20ipv4%20if%20ipv6%20remote%20address%20is%0A%09non-functional&In-Reply-To=%3C557DCC4A.50102%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004054.html">
   <LINK REL="Next"  HREF="004064.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20no%20fallback%20to%20ipv4%20if%20ipv6%20remote%20address%20is%0A%09non-functional&In-Reply-To=%3C557DCC4A.50102%40treenet.co.nz%3E"
       TITLE="[squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Jun 14 18:47:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004054.html">[squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional
</A></li>
        <LI>Next message (by thread): <A HREF="004064.html">[squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4055">[ date ]</a>
              <a href="thread.html#4055">[ thread ]</a>
              <a href="subject.html#4055">[ subject ]</a>
              <a href="author.html#4055">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/06/2015 2:42 a.m., Brian J. Murrell wrote:
&gt;<i> On Sat, 2015-06-13 at 21:49 +1200, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 12/06/2015 11:48 p.m., Brian J. Murrell wrote:
</I>&gt;&gt;&gt;<i> On Fri, 2015-06-12 at 10:13 +1200, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> see &lt;<A HREF="http://readlist.com/lists/squid-cache.org/squid-users/11/58405.html">http://readlist.com/lists/squid-cache.org/squid-users/11/58405.html</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Of course, I did see the rest of the messages in the thread.  I'm not
</I>&gt;&gt;&gt;<i> sure what I'm supposed to be seeing in that particular message though
</I>&gt;&gt;&gt;<i> other than 3.4.3 worked for the person reporting that.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So maybe I have a different problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On the side of &quot;probably&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> - You speak of a 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> If I assume it got as far as trying to connect it looks like it took
</I>&gt;&gt;<i> 10sec waiting for some response.
</I>&gt;<i> 
</I>&gt;<i> Indeed.  That's what it looks like to me.
</I>&gt;<i> 
</I>&gt;&gt;<i> So,
</I>&gt;&gt;<i> * can all of the DNS servers in your /etc/resolv.conf return results for
</I>&gt;&gt;<i> irc.bcwireless.net?
</I>&gt;<i> 
</I>&gt;<i> Yes.  There is only one DNS server in my resolv.conf and that's the one
</I>&gt;<i> that runs on the same host as squid:
</I>&gt;<i> 
</I>&gt;<i> $  dig irc.bcwireless.net any
</I>&gt;<i> 
</I>&gt;<i> ; &lt;&lt;&gt;&gt; DiG 9.8.1-P1 &lt;&lt;&gt;&gt; irc.bcwireless.net any
</I>&gt;<i> ;; global options: +cmd
</I>&gt;<i> ;; Got answer:
</I>&gt;<i> ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52707
</I>&gt;<i> ;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 2, ADDITIONAL: 0
</I>&gt;<i> 
</I>&gt;<i> ;; QUESTION SECTION:
</I>&gt;<i> ;irc.bcwireless.net.            IN      ANY
</I>&gt;<i> 
</I>&gt;<i> ;; ANSWER SECTION:
</I>&gt;<i> irc.bcwireless.net.     300     IN      AAAA    fcaa:8ef7:51b9:8f04:58f1:7364:e16e:fe2f
</I>&gt;<i> irc.bcwireless.net.     300     IN      A       198.27.79.54
</I>&gt;<i> 
</I>&gt;<i> ;; AUTHORITY SECTION:
</I>&gt;<i> bcwireless.net.         162451  IN      NS      kim.ns.cloudflare.com.
</I>&gt;<i> bcwireless.net.         162451  IN      NS      kip.ns.cloudflare.com.
</I>&gt;<i> 
</I>&gt;<i> ;; Query time: 52 msec
</I>&gt;<i> ;; SERVER: 127.0.0.1#53(127.0.0.1)
</I>&gt;<i> ;; WHEN: Sun Jun 14 10:39:21 2015
</I>&gt;<i> ;; MSG SIZE  rcvd: 133
</I>&gt;<i> 
</I>&gt;&gt;<i> Probably these:
</I>&gt;&gt;<i>   debug_options ALL,1 11,2 44,2 5,5 17,5
</I>&gt;<i> 
</I>&gt;<i> I sent you a private e-mail with the log since it's long and as much as
</I>&gt;<i> I think I might have sanitized it, I don't want to unnecessarily leak
</I>&gt;<i> sensitive info.
</I>
Sure. Thank you.


1)
I have confirmed my suspicion that your IPv6 routing is a bit broken.

The IPv6 address is in a private IP range fc00::/7. Which is the IPv6
equivalent of RFC1918 10.0.0.0/8 or 182.168.0.0/16. When your Squid
contacts it nothing at all happens within 10 seconds.

What should be happening is that when Squid tries to contact a network
range which is not your own LAN fd31:aeb1:48df::/48 sub-net. The routing
system in your Squid machine responds with a &quot;network unavailable&quot;
within nanoseconds. This signal which is not appearing is what Squid
depends on to to do the failover.

 Are you blocking ICMP? if so remove that. ICMP is not optional even in
IPv4.

 Do you have an entry in the routing table for fc00::/7 or /8 ? in
particular one larger than the fd31::/16 network your machines are
talking on. If so, narrow it down to only your actual LAN range.


2)
Squid should still be attemoting the IPv4 address though. Instead its
just responding with an error and closing.doing failover though, but the
CONNECT handling is for some reason seems to be generating an error page
and deliverign it to teh celint iinstead of trying the IPv4.


I also see you have Squid-3.4.3. Can you try an upgrade to 3.5.5 ? there
have been some deep code stability fixes in this area since your version.

If the problem persists after that upgrade. Please redo with 26,5 in the
debug list.

Also, check your proxy connect_timeout is shorter than forward_timeout.
The connect timout affects these individual connections, forward_timeout
needs to allow mulitiple (25?) of them for failover to have a chance in
lost packet situations like this.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004054.html">[squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional
</A></li>
	<LI>Next message (by thread): <A HREF="004064.html">[squid-users] no fallback to ipv4 if ipv6 remote address is	non-functional
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4055">[ date ]</a>
              <a href="thread.html#4055">[ thread ]</a>
              <a href="subject.html#4055">[ subject ]</a>
              <a href="author.html#4055">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
