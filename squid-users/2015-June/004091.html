<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] split horizon dns proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20split%20horizon%20dns%20proxy&In-Reply-To=%3C55822B55.4010101%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004088.html">
   <LINK REL="Next"  HREF="004094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] split horizon dns proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20split%20horizon%20dns%20proxy&In-Reply-To=%3C55822B55.4010101%40treenet.co.nz%3E"
       TITLE="[squid-users] split horizon dns proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun 18 02:22:13 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004088.html">[squid-users] split horizon dns proxy
</A></li>
        <LI>Next message (by thread): <A HREF="004094.html">[squid-users] Squid 3.5.5 automatically reload itself in 2h rhythm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4091">[ date ]</a>
              <a href="thread.html#4091">[ thread ]</a>
              <a href="subject.html#4091">[ subject ]</a>
              <a href="author.html#4091">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/06/2015 9:23 a.m., Jeff Scarborough wrote:
&gt;<i> I am currently using Squid 3.1 that comes packages in RHEL 6.  I have this
</I>&gt;<i> line in my config:
</I>&gt;<i>   http_port 80 intercept
</I>&gt;<i> 
</I>&gt;<i> I have a split horizon dns.  This means if you lookup any address for my
</I>&gt;<i> domain from the internet you get the address of the squid proxy server.
</I>&gt;<i> However if you lookup the same name from my proxy server you get an
</I>&gt;<i> internal RFC1918 IP address for the specific name.
</I>&gt;<i> 
</I>&gt;<i> Using squid 3.1 this works great.  A user tries to connect to a URL and by
</I>&gt;<i> DNS resolution is sent to the proxy server, the proxy server then does a
</I>&gt;<i> DNS lookup of the name in the URL and gets the actual address and sends the
</I>&gt;<i> request to the correct place.
</I>
Sigh. Dont do that.

&gt;<i> 
</I>&gt;<i> When I try and upgrade to anything beyond 3.2 this breaks.  I am finding
</I>&gt;<i> references that intercept as of Squid 3.2 NAT is required. Reference from
</I>&gt;<i> an email post in 2013:
</I>&gt;<i> 
</I>&gt;<i> In Squid since 3.2 if
</I>&gt;<i> the original TCP details are not found in the NAT records some
</I>&gt;<i> restrictions are placed on what happens with the request and response.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My question is, is there anyway back to the old behavior?
</I>
No.

&gt;<i>  What are the restrictions mentioned?
</I>
CVE-2009-0801
 Remote attacker able to inject into proxy cache arbitrary content for
arbitrary URLs. This is then delivered by the corrupted proxy to any
client fetching that URL with full assurance that it is the original
content.

The restrictions placed on Squid are:

a) NAT errors are no longer silently ignored.

b) The IP address of the server being contacted by the client is used as
origin unstead of DNS lookup.

&gt;<i> 
</I>&gt;<i> You may ask why I am not using the accel mode as this is quite obviously a
</I>&gt;<i> reverse proxy.
</I>
Indeed.

&gt;<i>  The reason is I could not get accel to work with the RTSP
</I>&gt;<i> server we are using.  I suspect because the Content-length returned by the
</I>&gt;<i> RTSP server is invalid as it is unknown since it is streaming video and the
</I>&gt;<i> length of the content is not known until a user stops the playback.
</I>
RTSP != HTTP. Squid-3.1 and older are corrupting the RTSP traffic
messages as they travel through the proxy, by injecting HTTP mandatory
header values. The RTSP software may be ignoring that or coping with it
somehow.

Squid-3.2 and later will take such unknown-length content and
Transfer-Encode it. Which will screw with RTSP in a different way.

RFC 2326 section 4.4 &quot;Note that RTSP does not (at present) support the
HTTP/1.1 &quot;chunked&quot; transfer coding(see [H3.6]) and requires the presence
of the Content-Length header field.&quot;


We used to see this with ICY protocol (abuses port 80) where strange
popping sounds would be injected into the radio stream by a proxy. That
was actually the chunked encoding headers every few KB counting and
checksum'ing the payload data.

&gt;<i> 
</I>&gt;<i> When I configure the proxy using accel I can get normal text pages back as
</I>&gt;<i> expected but the video fails with TCP_MISS_ABORTED this happens on all
</I>&gt;<i> version of squid.
</I>
If intercept works but accel doesn't in 3.1 and older I suspect that had
more to do with squid listening on port 80. RTSP uses port 554 and
reverse proxies by default preserve the port information.

&gt;<i> 
</I>&gt;<i> The reason I am trying to upgrade Squid is to be able to do all of this
</I>&gt;<i> using HTTPS.
</I>&gt;<i> 
</I>
Now thats just jumping from the hotplate into the fire. The security
protections addded in 3.2 for plain-text messages are a tame sub-set of
the restrictions on TLS connections.


There is no hope but to convert this to an actual reverse-proxy, an
actual intercept proxy, and either way to stop RTSP going through it.
Squid supports natively HTTP/1.x, HTTPS, ICY/SHOUTcast, and FTP - all
other protocols must be transfered via HTTP CONNECT tunnels.


PS. if you want to sponsor RTSP support being added to Squid I/we are
open to it.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004088.html">[squid-users] split horizon dns proxy
</A></li>
	<LI>Next message (by thread): <A HREF="004094.html">[squid-users] Squid 3.5.5 automatically reload itself in 2h rhythm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4091">[ date ]</a>
              <a href="thread.html#4091">[ thread ]</a>
              <a href="subject.html#4091">[ subject ]</a>
              <a href="author.html#4091">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
