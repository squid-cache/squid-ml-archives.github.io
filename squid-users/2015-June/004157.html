<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid to ask for, but not require, authentication.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20to%20ask%20for%2C%20but%20not%20require%2C%20authentication.&In-Reply-To=%3C5587F7E2.6080607%40crowie.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004142.html">
   <LINK REL="Next"  HREF="004158.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid to ask for, but not require, authentication.</H1>
    <B>Graham</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20to%20ask%20for%2C%20but%20not%20require%2C%20authentication.&In-Reply-To=%3C5587F7E2.6080607%40crowie.net%3E"
       TITLE="[squid-users] Squid to ask for, but not require, authentication.">gcsquid-users at crowie.net
       </A><BR>
    <I>Mon Jun 22 11:56:18 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004142.html">[squid-users] Squid to ask for, but not require, authentication.
</A></li>
        <LI>Next message (by thread): <A HREF="004158.html">[squid-users] How can I change the location of the kerberos cache	file?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4157">[ date ]</a>
              <a href="thread.html#4157">[ thread ]</a>
              <a href="subject.html#4157">[ subject ]</a>
              <a href="author.html#4157">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the reply.

I monitored the data between dansguardian and squid and there is 
basically nothing there. Dansguardian seems to only pass on the URL in 
its default config - and strips out everything else, including the 
User-Agent header.

I had a read and found that I can turn on the X-Forwarded-For headers in 
DansGuardian with the following two lines
forwardedfor = on
usexforwardedfor = on

I was then able to see the client's IP in the TCP stream between 
DansGuardian and Squid.

Then, in squid.conf, I added the following two lines (I suspect that the 
second one is not needed)
follow_x_forwarded_for allow localhost
acl_uses_indirect_client on

And then all ACL queries used the original client address, rather than 
the DansGuardian proxy address. This made all my rules work (and has 
enabled a few other things, such as logging in Squid that tells me the 
client's IP address correctly).

So, all is working now. Thank you for pointing me at the HTTP headers, 
it was exactly where I needed to look.


Thanks

GC



On 21/06/2015 10:35 PM, Amos Jeffries wrote:
&gt;<i> On 22/06/2015 12:24 a.m., Graham wrote:
</I>&gt;&gt;<i> I am looking for a way to configure Squid to ask for (and check)
</I>&gt;&gt;<i> authentication using LDAP, but to proceed if there is no auth
</I>&gt;&gt;<i> information provided.
</I>&gt;<i> Not possible. The process of asking for auth sends a reply to the client
</I>&gt;<i> request. Once that happens there is nothing further possible.
</I>&gt;<i>
</I>&gt;<i> You can check for auth and continue if its missing, but when doing so
</I>&gt;<i> cannot ask the client to send any credentials. A secure client will not
</I>&gt;<i> send credentials unless asked...
</I>&gt;<i>
</I>&gt;&gt;<i> I have been using DansGuardian for a while with Squid authenticating and
</I>&gt;&gt;<i> then getting DansGuardian to filter based on the username that Squid has
</I>&gt;&gt;<i> authenticated. The browsers talk directly to DansGuardian, which talks
</I>&gt;&gt;<i> to Squid, which does the work over the 'net.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am now trying to add an android device - which has some apps that
</I>&gt;&gt;<i> don't ask the user for a login/password (although they do talk to the
</I>&gt;&gt;<i> proxy) and therefore they fail to connect with a 407 error. I have
</I>&gt;&gt;<i> modified DansGuardian to allow just this one IP to work without
</I>&gt;&gt;<i> authentication, but Squid requires the auth and denies the requests. If
</I>&gt;&gt;<i> I make Squid more permissive (remove the auth config) then DansGuardian
</I>&gt;&gt;<i> works with that IP address, but will then block all other IP addresses
</I>&gt;&gt;<i> as Squid hasn't authenticated anyone. Note that I can't do IP
</I>&gt;&gt;<i> authentication from Squid because all requests come from the
</I>&gt;&gt;<i> DansGuardian IP (which happens to be localhost) and it can't tell which
</I>&gt;&gt;<i> ones to authenticate and which to allow.
</I>&gt;<i> You should be able to use something like the User-Agent header
</I>&gt;<i> (&quot;browser&quot; regex ACL type) to bypass the auth requirement on a
</I>&gt;<i> per-request basis. This has to be done for many Java applications, for
</I>&gt;<i> example.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004142.html">[squid-users] Squid to ask for, but not require, authentication.
</A></li>
	<LI>Next message (by thread): <A HREF="004158.html">[squid-users] How can I change the location of the kerberos cache	file?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4157">[ date ]</a>
              <a href="thread.html#4157">[ thread ]</a>
              <a href="subject.html#4157">[ subject ]</a>
              <a href="author.html#4157">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
