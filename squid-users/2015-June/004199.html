<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions Regarding Transparent Proxy, HTTPS,	and ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20Regarding%20Transparent%20Proxy%2C%20HTTPS%2C%0A%09and%20ssl_bump&In-Reply-To=%3CCAM3U7EzTXwvDOTWv7z8OXS25M_m9AGYQj4jTp-Np5pS6%2BXcpZg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004197.html">
   <LINK REL="Next"  HREF="004200.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions Regarding Transparent Proxy, HTTPS,	and ssl_bump</H1>
    <B>Tom Mowbray</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20Regarding%20Transparent%20Proxy%2C%20HTTPS%2C%0A%09and%20ssl_bump&In-Reply-To=%3CCAM3U7EzTXwvDOTWv7z8OXS25M_m9AGYQj4jTp-Np5pS6%2BXcpZg%40mail.gmail.com%3E"
       TITLE="[squid-users] Questions Regarding Transparent Proxy, HTTPS,	and ssl_bump">tmowbray at dalabs.com
       </A><BR>
    <I>Wed Jun 24 17:27:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004197.html">[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="004200.html">[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4199">[ date ]</a>
              <a href="thread.html#4199">[ thread ]</a>
              <a href="subject.html#4199">[ subject ]</a>
              <a href="author.html#4199">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the response.  Our understanding was that by using the &quot;peek and
splice&quot; options, we could transparently filter https traffic using the SNI
at the very least (though perhaps the issue lies with our external ACL?),
without having to decrypt the SSL session or use MITM cert.  Our results in
testing, however, have been less than promising.


---------------------------------
Tom Mowbray
*<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tmowbray at dalabs.com</A>* &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tmowbray at dalabs.com</A>&gt;
*703-829-6694*

On Wed, Jun 24, 2015 at 12:41 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 25/06/2015 3:41 a.m., Tom Mowbray wrote:
</I>&gt;<i> &gt; Squid 3.5.5
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I seem to have some confusion about how acl lists are processed in
</I>&gt;<i> &gt; squid.conf regarding the handling of SSL (HTTPS) traffic, attempting to
</I>&gt;<i> use
</I>&gt;<i> &gt; ssl_bump directives with transparent proxy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Based on available documentation, I believe my squid.conf is correct,
</I>&gt;<i> &gt; however it never seems to actually behave as expected.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I define the SSL port, as usual:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl SSL_ports port 443
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But here's where my confusion lies... Many state to place the following
</I>&gt;<i> &gt; line above the ssl_bump configuration lines:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow SSL_ports
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However when I do this, it appears to simply stop processing any other
</I>&gt;<i> &gt; rules and allows ALL https traffic through the proxy (which is actually
</I>&gt;<i> how
</I>&gt;<i> &gt; I'd expect a standard ACL list to operate, but then how do I actually
</I>&gt;<i> &gt; filter the traffic though our content-based ACL lists?).  If I put the
</I>&gt;<i> &gt; above line below the ssl_bump configuration options in my squid.conf,
</I>&gt;<i> then
</I>&gt;<i> &gt; it appears to BUMP all, even though I've told the config to SPLICE all
</I>&gt;<i> &gt; https traffic, which doesn't work for our deployment.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So, does squid actually continue to process the https traffic using the
</I>&gt;<i> &gt; ssl_bump rules if the &quot;http_access allow SSL_ports&quot; line is placed above
</I>&gt;<i> it
</I>&gt;<i> &gt; in the configuration?
</I>&gt;<i>
</I>&gt;<i> The order for these only matter for lines of the same directive name.
</I>&gt;<i> The http_access set get tested on the initial CONNECT request, then the
</I>&gt;<i> ssl_bump on each of the bumping steps, then if bumping decrypts the
</I>&gt;<i> http_access is run on the decrypted request(s).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I should note that we've been able to get filtering to work correctly
</I>&gt;<i> when
</I>&gt;<i> &gt; using our configuration in NON-transparent mode, however our goal is get
</I>&gt;<i> &gt; this functionality working as a transparent proxy.  We're unable to load
</I>&gt;<i> &gt; our self-signed cert onto client machines that will be accessing the
</I>&gt;<i> proxy,
</I>&gt;<i> &gt; so using the &quot;bump&quot; or man-in-the-middle style https filtering isn't a
</I>&gt;<i> &gt; viable option for us.
</I>&gt;<i>
</I>&gt;<i> Then don't bother with any of this. You wont get transparent HTTPS
</I>&gt;<i> interception working without that MITM certificate install you already
</I>&gt;<i> ruled out.
</I>&gt;<i>
</I>&gt;<i> Just use &quot;ssl_bump none all&quot; and Squid will relay the intercepted TCP
</I>&gt;<i> connections to the server they were destined for. Or better yet get rid
</I>&gt;<i> of the Squid step and let the traffic out on port 443 without slowing it
</I>&gt;<i> down for useless proxying.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150624/9ea652d2/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150624/9ea652d2/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004197.html">[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="004200.html">[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4199">[ date ]</a>
              <a href="thread.html#4199">[ thread ]</a>
              <a href="subject.html#4199">[ subject ]</a>
              <a href="author.html#4199">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
