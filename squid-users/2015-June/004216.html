<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20Regarding%20Transparent%20Proxy%2C%20HTTPS%2C%0A%20and%20ssl_bump&In-Reply-To=%3C558BF117.5070105%40vsen.dk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004215.html">
   <LINK REL="Next"  HREF="004203.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump</H1>
    <B>Klavs Klavsen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20Regarding%20Transparent%20Proxy%2C%20HTTPS%2C%0A%20and%20ssl_bump&In-Reply-To=%3C558BF117.5070105%40vsen.dk%3E"
       TITLE="[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump">kl at vsen.dk
       </A><BR>
    <I>Thu Jun 25 12:16:23 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004215.html">[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="004203.html">[squid-users] Logging of 'indirect' requests,	e.g. involving NAT or VPN
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4216">[ date ]</a>
              <a href="thread.html#4216">[ thread ]</a>
              <a href="subject.html#4216">[ subject ]</a>
              <a href="author.html#4216">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Tom,

How did you succeed in filtering https traffic? using http_access.. or 
the way James did it, using domainname only ?

Tom Mowbray wrote on 06/25/2015 02:06 PM:
&gt;<i> James,
</I>&gt;<i>
</I>&gt;<i> Thank for for your help.  Now that I have a better understanding of how
</I>&gt;<i> the https traffic is handled, I've been able to get things working as
</I>&gt;<i> intended.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ---------------------------------
</I>&gt;<i> Tom Mowbray
</I>&gt;<i> /<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tmowbray at dalabs.com</A>/ &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tmowbray at dalabs.com</A>&gt;
</I>&gt;<i> /703-829-6694/
</I>&gt;<i>
</I>&gt;<i> On Wed, Jun 24, 2015 at 2:05 PM, James Lay &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at slave-tothe-box.net</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at slave-tothe-box.net</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     On 2015-06-24 11:46 AM, Tom Mowbray wrote:
</I>&gt;<i>
</I>&gt;<i>         James,
</I>&gt;<i>
</I>&gt;<i>         Yes, as a matter of fact I have read through those exact posts and
</I>&gt;<i>         modeled my config very similarly.  What I have found is that,
</I>&gt;<i>         however,
</I>&gt;<i>         when the line &quot;http_access allow SSL_ports&quot; is placed above the
</I>&gt;<i>         ssl_bump stuff and other acl's (as you have it), it seems to simply
</I>&gt;<i>         allow ALL https without doing any filtering whatsoever.
</I>&gt;<i>
</I>&gt;<i>         Thanks for the response.
</I>&gt;<i>
</I>&gt;<i>         ---------------------------------Tom Mowbray
</I>&gt;<i>         <A HREF="https://lists.squid-cache.org/listinfo/squid-users">_tmowbray at dalabs.com_</A>
</I>&gt;<i>         _703-829-6694 &lt;tel:703-829-6694&gt;_
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         On Wed, Jun 24, 2015 at 1:31 PM, James Lay
</I>&gt;<i>         &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at slave-tothe-box.net</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at slave-tothe-box.net</A>&gt;&gt;
</I>&gt;<i>         wrote:
</I>&gt;<i>
</I>&gt;<i>             On 2015-06-24 09:41 AM, Tom Mowbray wrote:
</I>&gt;<i>
</I>&gt;<i>                 Squid 3.5.5
</I>&gt;<i>
</I>&gt;<i>                 I seem to have some confusion about how acl lists are
</I>&gt;<i>                 processed
</I>&gt;<i>                 in
</I>&gt;<i>                 squid.conf regarding the handling of SSL (HTTPS) traffic,
</I>&gt;<i>                 attempting
</I>&gt;<i>                 to use ssl_bump directives with transparent proxy.
</I>&gt;<i>
</I>&gt;<i>                 Based on available documentation, I believe my squid.conf is
</I>&gt;<i>                 correct,
</I>&gt;<i>                 however it never seems to actually behave as expected.
</I>&gt;<i>
</I>&gt;<i>                 I define the SSL port, as usual:
</I>&gt;<i>
</I>&gt;<i>                 acl SSL_ports port 443
</I>&gt;<i>
</I>&gt;<i>                 But here's where my confusion lies... Many state to
</I>&gt;<i>                 place the
</I>&gt;<i>                 following line above the ssl_bump configuration lines:
</I>&gt;<i>
</I>&gt;<i>                 http_access allow SSL_ports
</I>&gt;<i>
</I>&gt;<i>                 However when I do this, it appears to simply stop
</I>&gt;<i>                 processing any
</I>&gt;<i>                 other
</I>&gt;<i>                 rules and allows ALL https traffic through the proxy
</I>&gt;<i>                 (which is
</I>&gt;<i>                 actually how I'd expect a standard ACL list to operate,
</I>&gt;<i>                 but then
</I>&gt;<i>                 how
</I>&gt;<i>                 do I actually filter the traffic though our
</I>&gt;<i>                 content-based ACL
</I>&gt;<i>                 lists?).
</I>&gt;<i>                 If I put the above line below the ssl_bump configuration
</I>&gt;<i>                 options
</I>&gt;<i>                 in
</I>&gt;<i>                 my squid.conf, then it appears to BUMP all, even though
</I>&gt;<i>                 I've told
</I>&gt;<i>                 the
</I>&gt;<i>                 config to SPLICE all https traffic, which doesn't work
</I>&gt;<i>                 for our
</I>&gt;<i>                 deployment.
</I>&gt;<i>
</I>&gt;<i>                 So, does squid actually continue to process the https
</I>&gt;<i>                 traffic
</I>&gt;<i>                 using
</I>&gt;<i>                 the ssl_bump rules if the &quot;http_access allow SSL_ports&quot;
</I>&gt;<i>                 line is
</I>&gt;<i>                 placed
</I>&gt;<i>                 above it in the configuration?
</I>&gt;<i>
</I>&gt;<i>                 I should note that we've been able to get filtering to work
</I>&gt;<i>                 correctly
</I>&gt;<i>                 when using our configuration in NON-transparent mode,
</I>&gt;<i>                 however our
</I>&gt;<i>                 goal
</I>&gt;<i>                 is get this functionality working as a transparent
</I>&gt;<i>                 proxy. We're
</I>&gt;<i>                 unable to load our self-signed cert onto client machines
</I>&gt;<i>                 that
</I>&gt;<i>                 will be
</I>&gt;<i>                 accessing the proxy, so using the &quot;bump&quot; or
</I>&gt;<i>                 man-in-the-middle
</I>&gt;<i>                 style
</I>&gt;<i>                 https filtering isn't a viable option for us.
</I>&gt;<i>
</I>&gt;<i>                 Any help or advice is appreciated!
</I>&gt;<i>
</I>&gt;<i>                 Thanks,
</I>&gt;<i>
</I>&gt;<i>                 Tom
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>             Tom,
</I>&gt;<i>
</I>&gt;<i>             You kinda have to change the way you think about filtering
</I>&gt;<i>             when it
</I>&gt;<i>             comes to Squid 3.5.5 and SSL(TLS). Normal http traffic is
</I>&gt;<i>             easy....here's where we're trying to go and here's a list of
</I>&gt;<i>             place
</I>&gt;<i>             we're alloed to go...simple.
</I>&gt;<i>
</I>&gt;<i>             Not so with SSL(TLS). Squid can't filter, since Squid may or may
</I>&gt;<i>             not know where we're going...and that's the issue..it's
</I>&gt;<i>             where those
</I>&gt;<i>             ssl_bump atStep ACL's come in. Some sites when you connect
</I>&gt;<i>             to them
</I>&gt;<i>             are easy-ish..when you connect your device sends a &quot;Server Name
</I>&gt;<i>             Information&quot; (SNI) that says where you're going. Other sites
</I>&gt;<i>             don't
</I>&gt;<i>             have any information until you complete the SSL handshake
</I>&gt;<i>             (how can
</I>&gt;<i>             you filter a site name, until squid KNOWS the site or at least
</I>&gt;<i>             domain name?).
</I>&gt;<i>
</I>&gt;<i>             If you're still wanting to go through with transparent
</I>&gt;<i>             (intercept)
</I>&gt;<i>             proxy with SSL, search through the list for my SSL Deep dive
</I>&gt;<i>             posts...that config is working for me so far (granted, not in an
</I>&gt;<i>             enterprise environment). However, as Amos said,....if you choose
</I>&gt;<i>             not to install the cert on the client machines, you are
</I>&gt;<i>             either a)
</I>&gt;<i>             going to be out of luck on LOT'S of websites because they
</I>&gt;<i>             will fail
</I>&gt;<i>             the SSL handshake, or b) teaching your users to ignore the
</I>&gt;<i>             security
</I>&gt;<i>             warnings of their browser's....neither of which is a good thing.
</I>&gt;<i>
</I>&gt;<i>             Hope that helps.
</I>&gt;<i>
</I>&gt;<i>             James
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Tom,
</I>&gt;<i>
</I>&gt;<i>     You are right...that absolutely will allow all SSL initially...the
</I>&gt;<i>     filtering is down lower in the config here:
</I>&gt;<i>
</I>&gt;<i>     With single list of regex sites/domains like \.google\.com...peek,
</I>&gt;<i>     splice, no bump...I'm currently using this config section.
</I>&gt;<i>     ############################################################################
</I>&gt;<i>     ssl_bump peek step1 all
</I>&gt;<i>     ssl_bump peek step2 all
</I>&gt;<i>     acl allowed_https_sites ssl::server_name_regex
</I>&gt;<i>     &quot;/opt/etc/squid/http_url.txt&quot;
</I>&gt;<i>     ssl_bump splice step3 allowed_https_sites
</I>&gt;<i>     ssl_bump terminate all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     With broken acl list of networks list 208.85.40.0/21
</I>&gt;<i>     &lt;<A HREF="http://208.85.40.0/21">http://208.85.40.0/21</A>&gt;
</I>&gt;<i>     ###########################################################################
</I>&gt;<i>     ssl_bump peek step1 broken
</I>&gt;<i>     ssl_bump peek step2 broken
</I>&gt;<i>     ssl_bump splice broken
</I>&gt;<i>     ssl_bump peek step1 all
</I>&gt;<i>     ssl_bump peek step2 all
</I>&gt;<i>     acl allowed_https_sites ssl::server_name_regex
</I>&gt;<i>     &quot;/opt/etc/squid/http_url.txt&quot;
</I>&gt;<i>     ssl_bump bump allowed_https_sites
</I>&gt;<i>     ssl_bump terminate all
</I>&gt;<i>
</I>&gt;<i>     In both configs above, the SNI and server names are checked, bounced
</I>&gt;<i>     off the http_url.txt list, and if the site/domain is NOT in the list
</I>&gt;<i>     the ssl session is terminated.  The big drag is, you won't be able
</I>&gt;<i>     to see that in the squid logs.  I have a bug open ( I don't remember
</I>&gt;<i>     the number :( ) to show this in the logs...so far in my setup I only
</I>&gt;<i>     see the first peek, nothing after that.  You can test the above
</I>&gt;<i>     setups with:
</I>&gt;<i>
</I>&gt;<i>     openssl s_client -connect x.x.x.x:443
</I>&gt;<i>
</I>&gt;<i>     The above will test with no SNI...these look like the below in the logs:
</I>&gt;<i>     Jun 24 11:35:08 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i>     [24/Jun/2015:11:35:08 -0600] &quot;CONNECT 31.13.76.101:443
</I>&gt;<i>     &lt;<A HREF="http://31.13.76.101:443">http://31.13.76.101:443</A>&gt; HTTP/1.1&quot; - - 200 0 TAG_NONE:ORIGINAL_DST peek
</I>&gt;<i>
</I>&gt;<i>     wget -d --ca-certificate=&lt;your.cert.file)
</I>&gt;<i>
</I>&gt;<i>     The above WILL send an SNI...which you should see in your logs as:
</I>&gt;<i>     Jun 24 12:01:44 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i>     [24/Jun/2015:12:01:44 -0600] &quot;CONNECT 172.230.156.79:443
</I>&gt;<i>     &lt;<A HREF="http://172.230.156.79:443">http://172.230.156.79:443</A>&gt; HTTP/1.1&quot; device-api.urbanairship.com
</I>&gt;<i>     &lt;<A HREF="http://device-api.urbanairship.com">http://device-api.urbanairship.com</A>&gt; - 200 0 TAG_NONE:ORIGINAL_DST peek
</I>&gt;<i>
</I>&gt;<i>     Hope that helps.
</I>&gt;<i>
</I>&gt;<i>     James
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Regards,
Klavs Klavsen, GSEC - <A HREF="https://lists.squid-cache.org/listinfo/squid-users">kl at vsen.dk</A> - <A HREF="http://www.vsen.dk">http://www.vsen.dk</A> - Tlf. 61281200

&quot;Those who do not understand Unix are condemned to reinvent it, poorly.&quot;
   --Henry Spencer


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004215.html">[squid-users] Questions Regarding Transparent Proxy, HTTPS, and ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="004203.html">[squid-users] Logging of 'indirect' requests,	e.g. involving NAT or VPN
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4216">[ date ]</a>
              <a href="thread.html#4216">[ thread ]</a>
              <a href="subject.html#4216">[ subject ]</a>
              <a href="author.html#4216">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
