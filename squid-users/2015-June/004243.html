<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Mikrotik and Squid Transparent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mikrotik%20and%20Squid%20Transparent&In-Reply-To=%3C558E439F.4090800%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004242.html">
   <LINK REL="Next"  HREF="004245.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Mikrotik and Squid Transparent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mikrotik%20and%20Squid%20Transparent&In-Reply-To=%3C558E439F.4090800%40treenet.co.nz%3E"
       TITLE="[squid-users] Mikrotik and Squid Transparent">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jun 27 06:33:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004242.html">[squid-users] Mikrotik and Squid Transparent
</A></li>
        <LI>Next message (by thread): <A HREF="004245.html">[squid-users] Mikrotik and Squid Transparent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4243">[ date ]</a>
              <a href="thread.html#4243">[ thread ]</a>
              <a href="subject.html#4243">[ subject ]</a>
              <a href="author.html#4243">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/06/2015 10:02 a.m., Alex Samad wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> Sorry missing something here.
</I>&gt;<i> 
</I>&gt;<i> I thought this was a mikrotek rtr , presumably acting as a default
</I>&gt;<i> gateway for the local lan to the internet.
</I>&gt;<i> it has a DNAT rule to capture all internet traffic that is port 80
</I>&gt;<i> (and presumably at some point in time port 443) and it DNATS it to the
</I>&gt;<i> SQUID box.
</I>&gt;<i> 
</I>&gt;<i> and there needs to be a special rule on the DGW to allow squid access
</I>&gt;<i> out to the internet with out resending it back to the squid and
</I>&gt;<i> creating a loop.
</I>&gt;<i> 
</I>&gt;<i> from memory thats how I used to do this. unless the DGW is large
</I>&gt;<i> enough to run squid, then DNAT to the local box and onto squid.
</I>
Yes, a lot of people used to do it that way. The problem was
CVE-2009-0801 vulnerability allowed attackers script to send any request
to Squid claiming an arbitrary server Host: header and get that content
both delivered back as if it was to some other domain the client thought
it was connecting to and injected into Squid cache for other clients to
be affected by in the same way.

That is no longer permitted since Squid-3.2. The DNAT can only happen
once, and that must be on the Squid machine so Squid can lookup the NAT
tables and unmangle the original dst-IP.

You need to use routing rules on the Mikrotik (or tunnel sometimes works
too) to deliver the original client generated packet to the Squid
machine without NAT changing the dst-IP:port details (SNAT is fine, but
will cause lies about client IP in the access.log).

&gt;<i> 
</I>&gt;<i> Why would there be a DoS for SQUID on another box, the only resources
</I>&gt;<i> I can think of is the NAT table, maybe conntrack
</I>
Like I said earlier &quot;The dst-IP:port on the TCP packets entering the
Squid machine is where Squid will send the outgoing server requests.&quot;

If you block forwarding loops the outbound requests from Squid get an
error page *always* because the outboudn traffic is going from Squid to
be served by Squid (forwarding loop).

If you disable the Via header forwarding loop protection Squid will just
loop until all TCP port numbers on the machine are consumed sending new
&quot;outbound&quot; connections that loop back Squid. Then no network connections
will be available to Squid or any other software. The RAM associated
with each connection may also be too much and cause the OS to
force-shutdown Squid.

So you get to pick between a DoS or a very nasty DoS.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004242.html">[squid-users] Mikrotik and Squid Transparent
</A></li>
	<LI>Next message (by thread): <A HREF="004245.html">[squid-users] Mikrotik and Squid Transparent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4243">[ date ]</a>
              <a href="thread.html#4243">[ thread ]</a>
              <a href="subject.html#4243">[ subject ]</a>
              <a href="author.html#4243">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
