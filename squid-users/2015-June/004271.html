<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] tcp_outgoing_address binds to wrong interface
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20binds%20to%20wrong%20interface&In-Reply-To=%3CCAKOb%3DYaQyG_hDPR7K0F8Mu3nX7LPM8Gifrc7NC%2ByYy3RHN_PKg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004300.html">
   <LINK REL="Next"  HREF="004273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] tcp_outgoing_address binds to wrong interface</H1>
    <B>Nick Rogers</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20binds%20to%20wrong%20interface&In-Reply-To=%3CCAKOb%3DYaQyG_hDPR7K0F8Mu3nX7LPM8Gifrc7NC%2ByYy3RHN_PKg%40mail.gmail.com%3E"
       TITLE="[squid-users] tcp_outgoing_address binds to wrong interface">ncrogers at gmail.com
       </A><BR>
    <I>Mon Jun 29 20:54:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004300.html">[squid-users] sslbump and caching of generated cert
</A></li>
        <LI>Next message (by thread): <A HREF="004273.html">[squid-users] tcp_outgoing_address binds to wrong interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4271">[ date ]</a>
              <a href="thread.html#4271">[ thread ]</a>
              <a href="subject.html#4271">[ subject ]</a>
              <a href="author.html#4271">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I am experiencing an issue with squid 3.5.5 and FreeBSD 10.1 where
tcp_outgoing_address correctly rewrites the source address of outgoing
packets, but fails to bind the socket to the correct interface. I've been
using this kind of setup/configuration for quite some time (since the squid
2.7 days), so I believe something between squid 3.3 and squid 3.5 has
broken this behavior, or it is a problem with FreeBSD 10.x that I do not
understand. FWIW squid 3.3.3 on FreeBSD 9.x behaves correctly with the same
config.

I've been able to replicate this on a non-production VM with a simple
config. For example, I have two WAN interfaces: WAN1 (em0/192.168.92.246)
and WAN2 (em1/10.8.8.10), and a LAN interface (em2/192.168.5.1/24). My
default route points to the gateway for WAN1/em0. I have configured a
tcp_outgoing_address for a single host on the LAN (192.168.5.2) to use
outgoing address 10.8.8.10 (WAN2/em1). HTTP request packets from squid end
up going out em0 (the default route interface) with an ip of 10.8.8.10. The
source IP is correct but the packets egress the wrong interface, so they
are obviously dropped by the upstream router on that incorrect interface.

The following is my test squid.conf and some basic network config. While I
normally use squid as a transparent proxy in conjunction with the PF
firewall and routing enabled, for the purposes of replicating the issue in
my VM test environment I have disabled PF, routing, and connected directly
to squid via my browser's proxy config. Attempts to load webpages time out
unless I remove use of the tcp_outgoing_address directive.

# begin test squid.conf

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

http_access allow localhost manager
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access allow all

acl wan2 src 192.168.5.2
tcp_outgoing_address 10.8.8.10 wan2

follow_x_forwarded_for allow localhost
acl_uses_indirect_client on
log_uses_indirect_client on

http_port 3129

cache_replacement_policy heap LFUDA
maximum_object_size 768 MB
cache_dir aufs /squid/cache 2048 32 512

access_log      daemon:/squid/logs/access.log squid
cache_log       /squid/logs/cache.log
cache_store_log none

logfile_rotate 0

pid_filename /var/run/squid.pid

# end test squid.conf

em0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
options=9b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM&gt;
ether 00:0c:29:a3:33:93
inet 192.168.92.246 netmask 0xffffff00 broadcast 192.168.92.255
nd6 options=9&lt;PERFORMNUD,IFDISABLED&gt;
media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
status: active

em1: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
options=9b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM&gt;
ether 00:0c:29:a3:33:7f
inet 10.8.8.10 netmask 0xffffff00 broadcast 10.8.8.255
inet 10.8.8.11 netmask 0xffffff00 broadcast 10.8.8.255
inet 10.8.8.12 netmask 0xffffff00 broadcast 10.8.8.255
inet 10.8.8.13 netmask 0xffffff00 broadcast 10.8.8.255
inet 10.8.8.14 netmask 0xffffff00 broadcast 10.8.8.255
nd6 options=9&lt;PERFORMNUD,IFDISABLED&gt;
media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
status: active

root# netstat -rn | grep default

default            192.168.92.2       UGS         em0

I am hoping someone can shed some light on whether or not this may be a
squid bug or something going on with FreeBSD. Thank you.

-Nick
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150629/1ec9c37a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150629/1ec9c37a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004300.html">[squid-users] sslbump and caching of generated cert
</A></li>
	<LI>Next message (by thread): <A HREF="004273.html">[squid-users] tcp_outgoing_address binds to wrong interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4271">[ date ]</a>
              <a href="thread.html#4271">[ thread ]</a>
              <a href="subject.html#4271">[ subject ]</a>
              <a href="author.html#4271">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
