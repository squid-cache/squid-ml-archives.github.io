<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP_MISS/504 in cache_peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS/504%20in%20cache_peer&In-Reply-To=%3C559272F5.1080102%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004294.html">
   <LINK REL="Next"  HREF="004270.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP_MISS/504 in cache_peer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS/504%20in%20cache_peer&In-Reply-To=%3C559272F5.1080102%40treenet.co.nz%3E"
       TITLE="[squid-users] TCP_MISS/504 in cache_peer">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 30 10:44:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004294.html">[squid-users] TCP_MISS/504 in cache_peer
</A></li>
        <LI>Next message (by thread): <A HREF="004270.html">[squid-users] sslbump and caching of generated cert
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4295">[ date ]</a>
              <a href="thread.html#4295">[ thread ]</a>
              <a href="subject.html#4295">[ subject ]</a>
              <a href="author.html#4295">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/06/2015 9:42 p.m., Stakres wrote:
&gt;<i> Amos,
</I>&gt;<i> Yes, similar case here on the 4223.
</I>&gt;<i> By reading the case 4223, we can see that part &quot;Non-cacheable objects should
</I>&gt;<i> never be added to the digest.&quot; from you.
</I>&gt;<i> In my squid, there is no restriction, ICP is fully open, squid server
</I>&gt;<i> (3.5.5) are compiled with the digest option, so all is done to allow
</I>&gt;<i> ICP/digest connection and exchange.
</I>&gt;<i> So, why the servers think they got the objects, especially when they are not
</I>&gt;<i> cacheable and not cached ?
</I>
They have *an* object cached for the URL. But not the one the client is
requesting from that same URL. Or its got some revalidation requirements
attached. Thats what Chudy found. As a result the sibling is unable to
supply its cached object as the answer.

&gt;<i> 
</I>&gt;<i> To me, it seems the servers think they have the object but they don't, so
</I>&gt;<i> they reply with a 404 translated by a 504 to the squid client because
</I>&gt;<i> sibling archi.
</I>&gt;<i> I could understand it could be a bug but the squid client should see the 504
</I>&gt;<i> and should request the object from internet, no ?
</I>
For example;
 the client wants object no more than 60 seconds old with unique label
&quot;ETag:blahblah&quot;. But the sibling has a 90 second old object labeled
&quot;ETag:oops&quot;.

It would have to contact the origin to get a new copy, which is
forbidden by the sibling relationship Cache-Control:only-if-cached criteria.


It's a common problem when using ICP or cache digests which consider
only the URL to identify objects. HTCP was created to resolve that
problem by considering the whole HTTP header when testing the peer for
objects. Though I'm not sure myself if it would resolve the
only-if-cached issue.


&gt;<i> 
</I>&gt;<i> At the moment, i use a &quot;retry_on_error on&quot; as a workaround but not sure it's
</I>&gt;<i> fixing all 504.
</I>&gt;<i> 
</I>
Strange if that is working.

The reforwarding happens on 502 and 504 status without any special
configuration. That directive just adds 403, 500, 501 and 503 to the
list of status that can be retried.


&gt;<i> Then, having a dedicated cable between squid servers is not a realistic
</I>&gt;<i> solution, my ISP will not see that as a serious solution 
</I>&gt;<i> 
</I>&gt;<i> Last point, &quot;no-tproxy rule on parent type cache_peer&quot;, it does not work, we
</I>&gt;<i> tried that.
</I>&gt;<i> We applied that option 1 month ago and the internet sees the squid ip, not
</I>&gt;<i> the original ip address, so maybe another bug here... 
</I>
Nod. Without the dedicated link between proxies and TPROXY the parent
(or sibling) wont be aware of what IP the original client was using.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004294.html">[squid-users] TCP_MISS/504 in cache_peer
</A></li>
	<LI>Next message (by thread): <A HREF="004270.html">[squid-users] sslbump and caching of generated cert
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4295">[ date ]</a>
              <a href="thread.html#4295">[ thread ]</a>
              <a href="subject.html#4295">[ subject ]</a>
              <a href="author.html#4295">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
