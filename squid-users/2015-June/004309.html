<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl for redirect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20for%20redirect&In-Reply-To=%3C5593186B.5050705%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004308.html">
   <LINK REL="Next"  HREF="004238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl for redirect</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20for%20redirect&In-Reply-To=%3C5593186B.5050705%40urlfilterdb.com%3E"
       TITLE="[squid-users] acl for redirect">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Tue Jun 30 22:30:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="004308.html">[squid-users] acl for redirect
</A></li>
        <LI>Next message (by thread): <A HREF="004238.html">[squid-users] acl for redirect - re Fred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4309">[ date ]</a>
              <a href="thread.html#4309">[ thread ]</a>
              <a href="subject.html#4309">[ subject ]</a>
              <a href="author.html#4309">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I suggest to read this:
<A HREF="https://support.google.com/websearch/answer/186669">https://support.google.com/websearch/answer/186669</A>

and look at option 3 of section 'Keep SafeSearch turned on for your network'

Marcus


On 06/30/2015 05:48 PM, Mike wrote:
&gt;<i> Scratch that (my previous email to this list), google disabled their insecure sites when used as part of a redirect. We as individual users can use that url directly in the browser (
</I>&gt;<i> <A HREF="http://www.google.com/webhp?nord=1">http://www.google.com/webhp?nord=1</A> ) but any google page load starts with secure page causing that redirect to fail... The newer 3.1.2 e2guardian SSL MITM requires options (like a der certificate
</I>&gt;<i> file) that cannot be used with thousands of existing users on our system, so squid may be our only option.
</I>&gt;<i>
</I>&gt;<i> Another issue right now is google is using a &quot;VPN-style&quot; internal redirect on their server, so e2guardian (shown in log) sees <A HREF="https://www.google.com:443">https://www.google.com:443</A>  CONNECT, passes along TCP_TUNNEL/200
</I>&gt;<i> www.google.com:443 to squid (shown in squid log), and after that it is directly between google and the browser, not allowing e2guardian nor squid to see further urls from google (such as search terms)
</I>&gt;<i> for the rest of that specific session. Can click news, maps, images, videos, and NONE of these are passed along to the proxy.
</I>&gt;<i>
</I>&gt;<i> So my original question still stands, how to set an acl for google urls that references a file with blocked terms/words/phrases, and denies it if those terms are found (like a black list)?
</I>&gt;<i>
</I>&gt;<i> Another option I thought of is since the meta content in the code including title is passed along, so is there a way to have it can the header or title content as part of the acl &quot;content scan&quot; process?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i> Mike
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 6/26/2015 13:29 PM, Mike wrote:
</I>&gt;&gt;<i> Nevermind... I found another fix within e2guardian:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> etc/e2guardian/lists/urlregexplist
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Added this entry:
</I>&gt;&gt;<i> # Disable Google SSL Search
</I>&gt;&gt;<i> # allows e2g to filter searches properly
</I>&gt;&gt;<i> &quot;^<A HREF="https://www.google.[a-z">https://www.google.[a-z</A>]{2,6}(.*)&quot;-&gt;&quot;<A HREF="http://www.google.com/webhp?nord=1">http://www.google.com/webhp?nord=1</A>&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This means whenever google.com or www.google.com is typed in the address bar, it loads the insecure page and allows e2guardian to properly filter whatever search terms they type in. This does break
</I>&gt;&gt;<i> other aspects such as google toolbars, using the search bar at upper right of many browsers with google as the set search engine, and other ways, but that is an issue we can live with.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 26/06/2015 2:36 a.m., Mike wrote:
</I>&gt;&gt;&gt;<i> Amos, thanks for info.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The primary settings being used in squid.conf:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 8080
</I>&gt;&gt;&gt;<i> # this port is what will be used for SSL Proxy on client browser
</I>&gt;&gt;&gt;<i> http_port 8081 intercept
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> https_port 8082 intercept ssl-bump connection-auth=off
</I>&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=16MB
</I>&gt;&gt;&gt;<i> cert=/etc/squid/ssl/squid.pem key=/etc/squid/ssl/squid.key
</I>&gt;&gt;&gt;<i> cipher=ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:DHE-RSA-CAMELLIA128-SHA:AES128-SHA:RC4-SHA:HIGH:!aNULL:!MD5:!ADH
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid_ssl_db -M 16MB
</I>&gt;&gt;&gt;<i> sslcrtd_children 50 startup=5 idle=1
</I>&gt;&gt;&gt;<i> ssl_bump server-first all
</I>&gt;&gt;&gt;<i> ssl_bump none localhost
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Then e2guardian uses 10101 for the browsers, and uses 8080 for
</I>&gt;&gt;&gt;<i> connecting to squid on the same server.
</I>&gt;&gt;<i> Doesn;t matter. Due to TLS security requirements Squid ensures the TLS
</I>&gt;&gt;<i> connection in re-encrypted on outgoing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am doubtful eth nord works anymore since Googles own documentation for
</I>&gt;&gt;<i> schools states that one must install a MITM proxy that does the traffic
</I>&gt;&gt;<i> filtering - e2guardian is not one of those. IMO you should convert your
</I>&gt;&gt;<i> e2guardian config into Squid ACL rules that can be applied to the bumped
</I>&gt;&gt;<i> traffic without <A HREF="forcinghttp://">forcinghttp://</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But if nord does work, so should the deny_info in Squid. Something like
</I>&gt;&gt;<i> this probably:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl google dstdomain .google.com
</I>&gt;&gt;<i>   deny_info 301:<A HREF="http://%H%R?nord=1">http://%H%R?nord=1</A>  google
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl GwithQuery urlpath_regex ?
</I>&gt;&gt;<i>   deny_info 301:<A HREF="http://%H%R&amp;nord=1">http://%H%R&amp;nord=1</A>  GwithQuery
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access deny google Gquery
</I>&gt;&gt;<i>   http_access deny google
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="004308.html">[squid-users] acl for redirect
</A></li>
	<LI>Next message (by thread): <A HREF="004238.html">[squid-users] acl for redirect - re Fred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4309">[ date ]</a>
              <a href="thread.html#4309">[ thread ]</a>
              <a href="subject.html#4309">[ subject ]</a>
              <a href="author.html#4309">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
