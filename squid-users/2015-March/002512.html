<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] question about encrypted connection between https client and Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20question%20about%20encrypted%20connection%20between%20https%0A%20client%20and%20Squid&In-Reply-To=%3C54F357B2.3040809%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002511.html">
   <LINK REL="Next"  HREF="002513.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] question about encrypted connection between https client and Squid</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20question%20about%20encrypted%20connection%20between%20https%0A%20client%20and%20Squid&In-Reply-To=%3C54F357B2.3040809%40gmail.com%3E"
       TITLE="[squid-users] question about encrypted connection between https client and Squid">yvoinov at gmail.com
       </A><BR>
    <I>Sun Mar  1 18:17:22 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002511.html">[squid-users] question about encrypted connection between https client and Squid
</A></li>
        <LI>Next message (by thread): <A HREF="002513.html">[squid-users] question about encrypted connection between https	client and Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2512">[ date ]</a>
              <a href="thread.html#2512">[ thread ]</a>
              <a href="subject.html#2512">[ subject ]</a>
              <a href="author.html#2512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1



02.03.15 0:07, Julianne Bielski &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> That's good to know.
</I>&gt;<i> 
</I>&gt;<i> With a transparent interception SSL-bump enabled Squid, I suppose I
</I>&gt;<i> do not have to explicitly configure anything in my https client,
</I>&gt;<i> and that Squid must listen on the port my client is trying to 
</I>&gt;<i> connect to (443) and that my squid.conf file must look something
</I>&gt;<i> like this:
</I>&gt;<i> 
</I>&gt;<i> http_port 443 ssl-bump
</I>&gt;<i> cert=/usr/local/squid3/etc/site_priv+pub.pem
</I>http_port 3128 intercept
https_port 3129 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt
key=/usr/local/squid/etc/rootCA.key

443-&gt;3129 port mappind does with NAT.

&gt;<i> 
</I>&gt;<i> where cert points to the location of a certificate designed to look
</I>&gt;<i> like the certificate of the actual destination server (my reverse
</I>&gt;<i> proxy).
</I>With config snippet above. No, cert must be self-signed and different
from reverse proxy.

&gt;<i> 
</I>&gt;<i> In this case there is no http and no HTTP CONNECT required?
</I>Normally you never use CONNECT method over HTTP ports. This is
prohibited by squid basic security requirements.

This is must be in squid.conf:

# Deny requests to unsafe ports
http_access deny !Safe_ports
# Deny CONNECT to other than SSL ports
http_access deny CONNECT !SSL_ports

due to security reasons.

In general, ever non-HTTPS enabled squid can forward CONNECT over 443
to server (in forwarding mode).

To do that in transparent mode it must be configured with https_port
intercept keywords.

To know more about explicit bump look at this:

<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit">http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit</A>

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> From:	Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; To:	Julianne
</I>&gt;<i> Bielski/Raleigh/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">IBM at IBMUS</A> Cc:	<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>,
</I>&gt;<i> squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; Date:
</I>&gt;<i> 03/01/2015 12:52 PM Subject:	Re: [squid-users] question about
</I>&gt;<i> encrypted connection between https client and Squid
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 01.03.15 23:45, Julianne Bielski &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> Normally my infrastructure looks like:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> client  -- HTTP CONNECT (not encrypted)  ---&gt; proxy client
</I>&gt;&gt;<i> ------ TCP tunnel ---&gt; proxy --- TCP tunnel ---&gt; reverse proxy
</I>&gt;&gt;<i> client --- HTTPS application payload ---------------&gt; reverse
</I>&gt;&gt;<i> proxy
</I>&gt;<i> 
</I>&gt;&gt;<i> Now I need it to look like:
</I>&gt;<i> 
</I>&gt;&gt;<i> client -------- HTTPS application payload ----&gt; proxy  ----
</I>&gt;&gt;<i> HTTPS application payload  ----&gt; reverse proxy
</I>&gt;<i> 
</I>&gt;<i> No problem. This will work - and with only one encryption on every 
</I>&gt;<i> stage. Proxy can pass both - CONNECT with tunneling to reverse
</I>&gt;<i> proxy, or bumped HTTPS connection.
</I>&gt;<i> 
</I>&gt;<i> In my installation this scheme is works with most Web-sites uses 
</I>&gt;<i> reverse proxies. I use transparent interception SSL-bump enabled
</I>&gt;<i> Squid.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> From:		 Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; To: 
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> Date:		 03/01/2015 12:26 PM 
</I>&gt;&gt;<i> Subject:		 Re: [squid-users] question about encrypted connection 
</I>&gt;&gt;<i> between https client and Squid Sent by:		 &quot;squid-users&quot; 
</I>&gt;&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 01.03.15 23:18, Julianne Bielski &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I have an https client (not a browser) that normally connects
</I>&gt;&gt;&gt;<i> to a reverse proxy. When it needs to go through a forward
</I>&gt;&gt;&gt;<i> proxy, it requests a CONNECT tunnel. I now have a requirement
</I>&gt;&gt;&gt;<i> to also be able to encrypt the connection between my client and
</I>&gt;&gt;&gt;<i> the forward proxy, and I think this is possible using Squid and
</I>&gt;&gt;&gt;<i> the https_port directive (??)
</I>&gt;&gt;<i> Yep.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> My question is, will my https client now have to decrypt
</I>&gt;&gt;&gt;<i> twice? Once for the connection with the forward proxy and once
</I>&gt;&gt;&gt;<i> for the connection with the reverse proxy?
</I>&gt;<i> 
</I>&gt;&gt;<i> Re-encryption will performs only in case SSL-bumped connections.
</I>&gt;<i> 
</I>&gt;&gt;<i> But now I still can't imagine your infrastructure and how it
</I>&gt;&gt;<i> must work.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Also, must my https client still send a CONNECT message to 
</I>&gt;&gt;&gt;<i> Squid, or does it just connect to Squid's https_port at the
</I>&gt;&gt;&gt;<i> TCP level, perform the SSL handshake, and then open a TCP
</I>&gt;&gt;&gt;<i> connection to the reverse proxy?
</I>&gt;<i> 
</I>&gt;&gt;<i> Still want to take a look on your infrastructure scheme.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> J. Bielski
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> _______________________________________________ squid-users 
</I>&gt;&gt;&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________ squid-users
</I>&gt;&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQEcBAEBAgAGBQJU81eyAAoJENNXIZxhPexGO58IALLAtQZtg95Dh+82MaccSCho
cVq2Bt5sOTdnDMB/fbYlor5aNrFPvANWoNg8mrsOqssg5S4CXR2RcyNzj97LrHUI
SI3cnpk52xQXZZg88DMl303sijHp/vSH6qFtLKdWKCP/kcNqGOo9J9VYrKlnD8xL
Q7p8xwf/x9jA3u3OyOknp7PokB3NLv9A8+G30unkgZw0JUGdF6to8meS9oH8neRH
mF46EkzXcx5AdITLDHpY6ktRR1+H0rNZ2xnFBE3ESUot2dokf9ohoDS2jDrrRieR
d/CwqpBoy7Ukb1TWJYD67+aezBFUerS7m7j0+AWs/fQaLUKQUHyoOf9AKPWolkI=
=gp1a
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002511.html">[squid-users] question about encrypted connection between https client and Squid
</A></li>
	<LI>Next message (by thread): <A HREF="002513.html">[squid-users] question about encrypted connection between https	client and Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2512">[ date ]</a>
              <a href="thread.html#2512">[ thread ]</a>
              <a href="subject.html#2512">[ subject ]</a>
              <a href="author.html#2512">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
