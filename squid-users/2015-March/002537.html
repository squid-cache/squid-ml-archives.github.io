<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Unable to get TPROXY working with squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20get%20TPROXY%20working%20with%20squid&In-Reply-To=%3CCAKL8bP4sR41wjAdm9T9XhUKwaJeTbOefuTj7Wfdfii9U%2BHXD4A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002536.html">
   <LINK REL="Next"  HREF="002541.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Unable to get TPROXY working with squid</H1>
    <B>Carvaka Guru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20get%20TPROXY%20working%20with%20squid&In-Reply-To=%3CCAKL8bP4sR41wjAdm9T9XhUKwaJeTbOefuTj7Wfdfii9U%2BHXD4A%40mail.gmail.com%3E"
       TITLE="[squid-users] Unable to get TPROXY working with squid">carvakaguru at gmail.com
       </A><BR>
    <I>Mon Mar  2 17:41:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002536.html">[squid-users] Different squid-3.5.2 compile error on OpenBSD 5.6
</A></li>
        <LI>Next message (by thread): <A HREF="002541.html">[squid-users] Unable to get TPROXY working with squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2537">[ date ]</a>
              <a href="thread.html#2537">[ thread ]</a>
              <a href="subject.html#2537">[ subject ]</a>
              <a href="author.html#2537">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Feb 26, 2015 at 8:30 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 27/02/2015 12:41 p.m., Carvaka Guru wrote:
</I>&gt;<i> &gt; I am building a simple linux firewall router with eth1 LAN port and eth0
</I>&gt;<i> &gt; WAN port. I have squid3 running on it that I have built with netfilter
</I>&gt;<i> &gt; enabled. The linux version running on the firewall is debian wheezy which
</I>&gt;<i> &gt; has iptables with TPROXY and socket support.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; By setting up the iptables to send traffic to squid3 using the original
</I>&gt;<i> nat
</I>&gt;<i> &gt; prerouting REDIRECT method everything works fine but I can't get the
</I>&gt;<i> TPROXY
</I>&gt;<i> &gt; method to work. I followed all the steps outlined in
</I>&gt;<i> &gt; <A HREF="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</A>
</I>&gt;<i>
</I>&gt;<i> Uhm... no. You ran a *completely* different command line.
</I>&gt;<i>
</I>&gt;<i>
</I>Errr ... I didn't mention what command line I ran, just that I tried to
follow the instructions from the link, so I don't understand why you would
say that I ran a completely different command line??


&gt;<i>
</I>&gt;<i> &gt; but no traffic gets to squid3.
</I>&gt;<i> &gt; In fact all HTTP traffic goes into some hole as soon as I issue the
</I>&gt;<i> &gt; following two routing commands -
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ip rule add fwmark 1 lookup 100
</I>&gt;<i> &gt; ip route add local 0.0.0.0/0 dev lo table 100
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Without these two commands the HTTP traffic goes through but never gets
</I>&gt;<i> &gt; routed to squid3.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think the &quot;ip route&quot; command is the culprit but I don't know why or how
</I>&gt;<i> &gt; to change it?
</I>&gt;<i>
</I>&gt;<i> That is explained in the &quot;/!\&quot; notes directly following the example
</I>&gt;<i> configuration you &quot;followed&quot;.
</I>&gt;<i>
</I>&gt;<i> It even has a whole section &quot;Some routing problems to be aware of&quot; just
</I>&gt;<i> to repeat the message about this problem and what to do about it.
</I>&gt;<i>
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/Tproxy4#Routing_configuration">http://wiki.squid-cache.org/Features/Tproxy4#Routing_configuration</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>I had already gone through these sections (which have very scarce info as
it is) and tried to understand the caveats but since you explicitly pointed
it out as something to look into, I thought I'd go through it again and try
a few more things but nothing really panned out.

I admit that I am a noob to this so I am probably missing something
elemental but one thing I am certain of is that I need to change the &quot;ip
route add local&quot; command to something that will work for my setup. Not sure
what that would be because I tried various combinations of parameters for
this command and the result is the same, i.e. I lose web-connectivity as
soon as I issue the command.

Perhaps someone will humor me and explain what the &quot;ip route add local&quot;
command is exactly suppose to achieve in the context of TPROXY then perhaps
I may be able to morph it to fit my setup.


&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150302/4dcc78fa/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150302/4dcc78fa/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002536.html">[squid-users] Different squid-3.5.2 compile error on OpenBSD 5.6
</A></li>
	<LI>Next message (by thread): <A HREF="002541.html">[squid-users] Unable to get TPROXY working with squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2537">[ date ]</a>
              <a href="thread.html#2537">[ thread ]</a>
              <a href="subject.html#2537">[ subject ]</a>
              <a href="author.html#2537">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
