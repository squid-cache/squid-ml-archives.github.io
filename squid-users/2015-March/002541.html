<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Unable to get TPROXY working with squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20get%20TPROXY%20working%20with%20squid&In-Reply-To=%3C54F52A05.1010806%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002537.html">
   <LINK REL="Next"  HREF="002540.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Unable to get TPROXY working with squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20get%20TPROXY%20working%20with%20squid&In-Reply-To=%3C54F52A05.1010806%40treenet.co.nz%3E"
       TITLE="[squid-users] Unable to get TPROXY working with squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar  3 03:27:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002537.html">[squid-users] Unable to get TPROXY working with squid
</A></li>
        <LI>Next message (by thread): <A HREF="002540.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2541">[ date ]</a>
              <a href="thread.html#2541">[ thread ]</a>
              <a href="subject.html#2541">[ subject ]</a>
              <a href="author.html#2541">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/03/2015 6:41 a.m., Carvaka Guru wrote:
&gt;<i> On Thu, Feb 26, 2015 at 8:30 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 27/02/2015 12:41 p.m., Carvaka Guru wrote:
</I>&gt;&gt;&gt;<i> I am building a simple linux firewall router with eth1 LAN port and eth0
</I>&gt;&gt;&gt;<i> WAN port. I have squid3 running on it that I have built with netfilter
</I>&gt;&gt;&gt;<i> enabled. The linux version running on the firewall is debian wheezy which
</I>&gt;&gt;&gt;<i> has iptables with TPROXY and socket support.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> By setting up the iptables to send traffic to squid3 using the original
</I>&gt;&gt;<i> nat
</I>&gt;&gt;&gt;<i> prerouting REDIRECT method everything works fine but I can't get the
</I>&gt;&gt;<i> TPROXY
</I>&gt;&gt;&gt;<i> method to work. I followed all the steps outlined in
</I>&gt;&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Uhm... no. You ran a *completely* different command line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Errr ... I didn't mention what command line I ran, just that I tried to
</I>&gt;<i> follow the instructions from the link, so I don't understand why you would
</I>&gt;<i> say that I ran a completely different command line??
</I>

You said:
&quot;
as soon as I issue the following two routing commands -

 ip rule add fwmark 1 lookup 100
 ip route add local 0.0.0.0/0 dev lo table 100
&quot;

the tutorial uses two commands for IPv4 and IPv6 routing and indicates
an ethN interface.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> but no traffic gets to squid3.
</I>&gt;&gt;&gt;<i> In fact all HTTP traffic goes into some hole as soon as I issue the
</I>&gt;&gt;&gt;<i> following two routing commands -
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ip rule add fwmark 1 lookup 100
</I>&gt;&gt;&gt;<i> ip route add local 0.0.0.0/0 dev lo table 100
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Without these two commands the HTTP traffic goes through but never gets
</I>&gt;&gt;&gt;<i> routed to squid3.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think the &quot;ip route&quot; command is the culprit but I don't know why or how
</I>&gt;&gt;&gt;<i> to change it?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is explained in the &quot;/!\&quot; notes directly following the example
</I>&gt;&gt;<i> configuration you &quot;followed&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It even has a whole section &quot;Some routing problems to be aware of&quot; just
</I>&gt;&gt;<i> to repeat the message about this problem and what to do about it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/Tproxy4#Routing_configuration">http://wiki.squid-cache.org/Features/Tproxy4#Routing_configuration</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> I had already gone through these sections (which have very scarce info as
</I>&gt;<i> it is) and tried to understand the caveats but since you explicitly pointed
</I>&gt;<i> it out as something to look into, I thought I'd go through it again and try
</I>&gt;<i> a few more things but nothing really panned out.
</I>&gt;<i> 
</I>&gt;<i> I admit that I am a noob to this so I am probably missing something
</I>&gt;<i> elemental but one thing I am certain of is that I need to change the &quot;ip
</I>&gt;<i> route add local&quot; command to something that will work for my setup. Not sure
</I>&gt;<i> what that would be because I tried various combinations of parameters for
</I>&gt;<i> this command and the result is the same, i.e. I lose web-connectivity as
</I>&gt;<i> soon as I issue the command.
</I>&gt;<i> 
</I>&gt;<i> Perhaps someone will humor me and explain what the &quot;ip route add local&quot;
</I>&gt;<i> command is exactly suppose to achieve in the context of TPROXY then perhaps
</I>&gt;<i> I may be able to morph it to fit my setup.
</I>
It is the type of route being created. One for traffic within the local
machine as opposed to other types like unicast (Internet) multicast,
boradcast, or blackholes.

The tuneable parameters of those rules AFAIK are:
 the table ID number - which should be unique for the TPROXY usage, and
 the device name - which should be either &quot;lo&quot; or the eth* physical NIC
the traffic arrives on (not an alias) depending on your OS security
setup, and
 the IP-range you want captured - normally everything and the DIVERT
iptables chain takes care of exceptions.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002537.html">[squid-users] Unable to get TPROXY working with squid
</A></li>
	<LI>Next message (by thread): <A HREF="002540.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2541">[ date ]</a>
              <a href="thread.html#2541">[ thread ]</a>
              <a href="subject.html#2541">[ subject ]</a>
              <a href="author.html#2541">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
