<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help with Squid Proxy on AWS Nat Instance.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20Squid%20Proxy%20on%20AWS%20Nat%20Instance.&In-Reply-To=%3C1425389418404-4670170.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002952.html">
   <LINK REL="Next"  HREF="002545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help with Squid Proxy on AWS Nat Instance.</H1>
    <B>laxcat</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20Squid%20Proxy%20on%20AWS%20Nat%20Instance.&In-Reply-To=%3C1425389418404-4670170.post%40n4.nabble.com%3E"
       TITLE="[squid-users] Help with Squid Proxy on AWS Nat Instance.">travis.skeel at gmail.com
       </A><BR>
    <I>Tue Mar  3 13:30:18 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002952.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
        <LI>Next message (by thread): <A HREF="002545.html">[squid-users] Help with Squid Proxy on AWS Nat Instance.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2542">[ date ]</a>
              <a href="thread.html#2542">[ thread ]</a>
              <a href="subject.html#2542">[ subject ]</a>
              <a href="author.html#2542">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have squid installed on a NAT instance in AWS.  I installed squid using
yum.  The OS is amazon linux.  When squid is not running I am able to send
traffic through the nat box from private subnets but when I start squid I am
not.  

This is the default iptables rules:

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at box1</A> ~]# iptables -t nat --line-numbers -L
iptables -t nat --line-numbers -L
Chain PREROUTING (policy ACCEPT)
num  target     prot opt source               destination         

Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source               destination         
1    MASQUERADE  all  --  10.3.0.0/16          anywhere         


I start squid and add the below rule to iptables I get a squid error page:
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT
--to-port 3128

Error pages says:
ERROR
The requested URL could not be retrieved
The following error encountered while trying to retrieve the URL: /
Invalid URL

Current config I have tried a few different ones.

#
# Recommended minimum configuration:
#
acl manager proto cache_object
acl localhost src 127.0.0.1/32 ::1
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1

# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines

acl SSL_ports port 443
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl CONNECT method CONNECT

#
# Recommended minimum Access Permission configuration:
#
# Only allow cachemgr access from localhost
#http_access allow manager localhost
#http_access allow all
acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
http_access allow whitelist
http_access allow CONNECT whitelist
http_access deny !whitelist 

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on &quot;localhost&quot; is a local user
#http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 3128

# We recommend you to use at least the following line.
hierarchy_stoplist cgi-bin ?

# Uncomment and adjust the following to add a disk cache directory.
#cache_dir ufs /var/spool/squid 100 16 256

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

# Add any of your own refresh_pattern entries above these.
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320





--
View this message in context: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Help-with-Squid-Proxy-on-AWS-Nat-Instance-tp4670170.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Help-with-Squid-Proxy-on-AWS-Nat-Instance-tp4670170.html</A>
Sent from the Squid - Users mailing list archive at Nabble.com.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002952.html">[squid-users] assertion failed: client_side.cc:1515:	&quot;connIsUsable(http-&gt;getConn())
</A></li>
	<LI>Next message (by thread): <A HREF="002545.html">[squid-users] Help with Squid Proxy on AWS Nat Instance.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2542">[ date ]</a>
              <a href="thread.html#2542">[ thread ]</a>
              <a href="subject.html#2542">[ subject ]</a>
              <a href="author.html#2542">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
