<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TProxy and client_dst_passthru
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3C54F6D2AC.6050203%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002566.html">
   <LINK REL="Next"  HREF="002570.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TProxy and client_dst_passthru</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3C54F6D2AC.6050203%40treenet.co.nz%3E"
       TITLE="[squid-users] TProxy and client_dst_passthru">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar  4 09:38:52 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002566.html">[squid-users] TProxy and client_dst_passthru
</A></li>
        <LI>Next message (by thread): <A HREF="002570.html">[squid-users] Squid 3.5.2 Compile Error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2567">[ date ]</a>
              <a href="thread.html#2567">[ thread ]</a>
              <a href="subject.html#2567">[ subject ]</a>
              <a href="author.html#2567">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/03/2015 8:19 p.m., Stakres wrote:
&gt;<i> Hi Eliezer,
</I>&gt;<i> 
</I>&gt;<i> Well, we have done many tests with Squid (3.1 to 3.5.x), disabling
</I>&gt;<i> &quot;client_dst_passthru&quot; (off) will stop the DNS entry as explained in the
</I>&gt;<i> wiki, the option directly acts on the flag &quot;ORIGINAL_DST&quot;.
</I>
You literally have that backwards.

The cause is NAT/TPROXY.
The directive is acting on the NAT mangled dst-IP address (replace it?
yes/no).
The log flag is an effect telling you what was chosen (yes or no answer).


&gt;<i> As you know, ORIGINAL_DST switches the optimization off (ex: StoreID) then
</I>&gt;<i> it's not possible to cache the URL (ex: <A HREF="http://cdn2.example.com/mypic.png">http://cdn2.example.com/mypic.png</A>).
</I>&gt;<i> 
</I>&gt;<i> In no tproxy/NAT mode, the client_dst_passthru works perfectly by disabling
</I>&gt;<i> the DNS entry control, so optimization is done correctly.
</I>
WTF? no (and FWIW I wrote that pass-thru feature).

In &quot;no TPROXY/NAT mode&quot; the client *explicitly* requests Squid to fetch
a URL. Squid looks up DNS for the domain in that URL and contacts any
one of the IPs available.
 There is no client DNS lookup to do pass-thru for. The directive has no
effect whatsoever.


&gt;<i> But in tproxy/NAT, the client_dst_passthru has no effect, we see
</I>&gt;<i> ORIGINAL_DST in logs.
</I>
In TPROXY/NAT intercept mode, the client does the DNS lookup and selects
which IP to contact. The NAT/TPROXY diverts the traffic into Squid.
Squid grabs the original client dst-IP from the kernel records. Does a
second DNS lookup to see where the URL was supposed to be going
according to more reliable sources.

 *IF* (and only if) Squid can verify the IP the client selected actually
belongs to the domain in the URL does Squid check the pass-thru directive:
 ON (default) - Squid uses the IP the client was connecting to (logs
ORIGINAL_DST);
 OFF - Squid selects a (possibly new, or not) IP to be used as the
server (logs DIRECT).

 Otherwise, when that dst-IP validation fails, Squid uses the IP the
client was connecting to. The directive has no effect whatsoever.


&gt;<i> 
</I>&gt;<i> So, maybe I'm totaly wrong here the client_dst_passthru is not related to
</I>&gt;<i> the ORIGINAL_DST, or there is an explaination why the client_dst_passthru
</I>&gt;<i> does not act in tproxy/NAT...
</I>
client_dst_passthru is simply whether or not to use ORIGINAL_DST in the
cases where it is both available AND optional.
 There are other cases where it is mandatory to use, or is unavailable.


For users the key information is that:

Setting OFF enables HTTP routing optimizations and network error
recovery to take place, but severly confuses people/applications who
dont understand much about HTTP.


Setting ON reduces problems with broken web applications that (wrongly)
assume end-to-end connectivity within HTTP, or that (wrongly) assume all
connections to a given IP are going to end up at the same origin server.
Neither of those assumptions are true for HTTP whether it goes over port
80 or port 443 or a proxy.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002566.html">[squid-users] TProxy and client_dst_passthru
</A></li>
	<LI>Next message (by thread): <A HREF="002570.html">[squid-users] Squid 3.5.2 Compile Error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2567">[ date ]</a>
              <a href="thread.html#2567">[ thread ]</a>
              <a href="subject.html#2567">[ subject ]</a>
              <a href="author.html#2567">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
