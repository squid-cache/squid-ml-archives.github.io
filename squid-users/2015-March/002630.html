<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid intercept config
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20intercept%20config&In-Reply-To=%3C54FA7DED.9090902%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002629.html">
   <LINK REL="Next"  HREF="002632.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid intercept config</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20intercept%20config&In-Reply-To=%3C54FA7DED.9090902%40treenet.co.nz%3E"
       TITLE="[squid-users] squid intercept config">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Mar  7 04:26:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002629.html">[squid-users] Fwd: squid intercept config
</A></li>
        <LI>Next message (by thread): <A HREF="002632.html">[squid-users] squid intercept config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2630">[ date ]</a>
              <a href="thread.html#2630">[ thread ]</a>
              <a href="subject.html#2630">[ subject ]</a>
              <a href="author.html#2630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/03/2015 1:19 a.m., Monah Baki wrote:
&gt;<i> Hi all, can anyone verify if this is correct, need to make ure that users
</I>&gt;<i> will be able to access the internet via the squid.
</I>&gt;<i> 
</I>&gt;<i> Running FreeBSD with a single interface with Squid-3.5.2
</I>&gt;<i> 
</I>&gt;<i> Policy based routing on Cisco with the following:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> interface GigabitEthernet0/0/1.1
</I>&gt;<i> 
</I>&gt;<i> encapsulation dot1Q 1 native
</I>&gt;<i> 
</I>&gt;<i> ip address 10.0.0.9 255.255.255.0
</I>&gt;<i> 
</I>&gt;<i> no ip redirects
</I>&gt;<i> 
</I>&gt;<i> no ip unreachables
</I>&gt;<i> 
</I>&gt;<i> ip nat inside
</I>&gt;<i> 
</I>&gt;<i> standby 1 ip 10.0.0.10
</I>&gt;<i> 
</I>&gt;<i> standby 1 priority 120
</I>&gt;<i> 
</I>&gt;<i> standby 1 preempt
</I>&gt;<i> 
</I>&gt;<i> standby 1 name HSRP
</I>&gt;<i> 
</I>&gt;<i> ip policy route-map CFLOW
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ip access-list extended REDIRECT
</I>&gt;<i> 
</I>&gt;<i> deny   tcp host 10.0.0.24 any eq www
</I>&gt;<i> 
</I>&gt;<i> permit tcp host 10.0.0.23 any eq www
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> route-map CFLOW permit 10
</I>&gt;<i> 
</I>&gt;<i> match ip address REDIRECT
</I>&gt;<i> set ip next-hop 10.0.0.24
</I>&gt;<i> 
</I>&gt;<i> In my /etc/pf.conf
</I>&gt;<i> rdr pass inet proto tcp from 10.0.0.0/8 to any port 80 -&gt; 10.0.0.24 port
</I>&gt;<i> 3129
</I>&gt;<i> 
</I>&gt;<i> # block in
</I>&gt;<i> pass in log quick on bge0
</I>&gt;<i> pass out log quick on bge0
</I>&gt;<i> pass out keep state
</I>&gt;<i> 
</I>&gt;<i> and finally in my squid.conf:
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> And for testing purposes from the squid server:
</I>&gt;<i>  ./squidclient -h 10.0.0.24 -p 3128 <A HREF="http://www.freebsd.org/">http://www.freebsd.org/</A>
</I>&gt;<i> 
</I>&gt;<i> If I replace -p 3128 with -p 80, I get a access denied, and if I omit the
</I>&gt;<i> -p 3128 completely, I can access the websites.
</I>
If you omit the -p entirely squidclient assumes &quot;-p 3128&quot; (the proxy
default listening port), so it works exactly the same as if you had used
-p 3128 explicitly.

If you use -p 80 you also need to change the pther parameters so they
generate port-80 syntax message:
 - the -h with IP or hostname of the remote web server, and
 - the URL parameters being a relative URL, and
 - the -j parameter with Host: header domain name of the server
...
 eg.
 squidclient -h www.freebsd.org -j www.freebsd.org -p 80 /

NP: if your squidclient is too old to support -j, use this instead:
  -H 'Host: www.freebsd.org\n'

 ** this test should work from the squid box without having gone through
the proxy. Only from the client machine should it work *with* NAT
passing it through the proxy.



Using a proxy syntax message sent directly to the proxy receiving port,
or with the proxy as receiving IP on port 80 (NAT'ed to Squid) is a
guaranted forwarding loop failure.


That doesn't fix your clients issue, but hopefully makes it clear that
the above desribed test is broken enough to prevent you identifying when
the client issue is fixed if that happens on some change.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002629.html">[squid-users] Fwd: squid intercept config
</A></li>
	<LI>Next message (by thread): <A HREF="002632.html">[squid-users] squid intercept config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2630">[ date ]</a>
              <a href="thread.html#2630">[ thread ]</a>
              <a href="subject.html#2630">[ subject ]</a>
              <a href="author.html#2630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
