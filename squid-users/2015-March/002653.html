<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Whether%20squid%203.5.2%20can%20support%20rock%20at%20wccp%0A%20tproxy%20environment%20really%20%3F&In-Reply-To=%3C54FD958A.8000100%40yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002652.html">
   <LINK REL="Next"  HREF="002664.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ?</H1>
    <B>johnzeng</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Whether%20squid%203.5.2%20can%20support%20rock%20at%20wccp%0A%20tproxy%20environment%20really%20%3F&In-Reply-To=%3C54FD958A.8000100%40yahoo.com%3E"
       TITLE="[squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ?">johnzeng2013 at yahoo.com
       </A><BR>
    <I>Mon Mar  9 12:43:54 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002652.html">[squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ? ( there are same problem between smp model or single model )
</A></li>
        <LI>Next message (by thread): <A HREF="002664.html">[squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2653">[ date ]</a>
              <a href="thread.html#2653">[ thread ]</a>
              <a href="subject.html#2653">[ subject ]</a>
              <a href="author.html#2653">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Amos:

----------------------------------------------------------------------------------------------------------------------- 


For starters,
  WCCP is a network protocol Squid uses to inform remote routers that it
is active and what traffic it can receive.
  rock is a layout format for bits stored on a disk.
  ... they are *completely* unrelated.

-------------------------------------------------------------------------

Your meaning is running two different process for wccp redirection and Cache operation ?

first process is for wccp redirection

and other process is for Cache operation


  




&#20110; 2015&#24180;03&#26376;09&#26085; 13:01, Amos Jeffries &#20889;&#36947;:
&gt;<i> On 9/03/2015 4:38 p.m., johnzeng wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hello Dear All :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I face a problem recently , When i config wccp ( tproxy ) environment (
</I>&gt;&gt;<i> via using squid 3.5.2 ) ,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if i disable cache_dir rock part ,and it will be success for wccp(
</I>&gt;&gt;<i> tproxy) , and enable cache_dir aufs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #cache_dir rock /accerater/webcache3/storage/rock1 2646 min-size=4096
</I>&gt;&gt;<i> max-size=262144 max-swap-rate=250 swap-timeout=350
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but if i enable cache_dir rock part ,and it will be failure for wccp(
</I>&gt;&gt;<i> tproxy) and enable cache_dir aufs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_dir rock /accerater/webcache3/storage/rock1 2646 min-size=4096
</I>&gt;&gt;<i> max-size=262144 max-swap-rate=250 swap-timeout=350
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Whether some of my config is error , if possible , please give me some
</I>&gt;&gt;<i> advisement
</I>&gt;&gt;<i>
</I>&gt;<i> For starters,
</I>&gt;<i>   WCCP is a network protocol Squid uses to inform remote routers that it
</I>&gt;<i> is active and what traffic it can receive.
</I>&gt;<i>   rock is a layout format for bits stored on a disk.
</I>&gt;<i>   ... they are *completely* unrelated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> This is my config
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> thanks
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> coredump_dir /accerater/logs/webcache3/
</I>&gt;&gt;<i> unlinkd_program /accerater/webcache3/libexec/unlinkd
</I>&gt;&gt;<i> pid_filename /accerater/logs/webcache3/opmizer1/cache.pid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> workers 2
</I>&gt;&gt;<i> cpu_affinity_map process_numbers=1,2 cores=1,3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_dir rock /accerater/webcache3/storage/rock1 2646 min-size=4096
</I>&gt;&gt;<i> max-size=262144 max-swap-rate=250 swap-timeout=350
</I>&gt;&gt;<i> cache_dir rock /accerater/webcache3/storage/rock1 2646 min-size=4096
</I>&gt;&gt;<i> max-size=262144 max-swap-rate=250 swap-timeout=350
</I>&gt;<i> You are telling Squid to start two controllers to the database file
</I>&gt;<i> /accerater/webcache3/storage/rock1 from *each* worker. There is zero
</I>&gt;<i> benefit from this and the two controllers may enounter collisions as
</I>&gt;<i> they compete for acces to the disk without sharing atomic locks. That
</I>&gt;<i> leads to cache corruption.
</I>&gt;<i>
</I>&gt;<i> Remove one of those two lines.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> if ${process_number} = 1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_swap_state /accerater/logs/webcache3/opmizer1_swap_log1
</I>&gt;<i> Dont use cache_swap_state.
</I>&gt;<i>
</I>&gt;&gt;<i> access_log stdio:/accerater/logs/webcache3/opmizer1_access.log squid
</I>&gt;<i> Use this instead (mind the wrap):
</I>&gt;<i>
</I>&gt;<i> access_log
</I>&gt;<i> stdio:/accerater/logs/webcache/opmizer${process_number}_access.log squid
</I>&gt;<i>
</I>&gt;&gt;<i> cache_log /accerater/logs/webcache3/opmizer1_cache.log
</I>&gt;<i>
</I>&gt;<i> Use this instead:
</I>&gt;<i>
</I>&gt;<i> cache_log /accerater/logs/webcache3/opmizer${process_number}_cache.log
</I>&gt;<i>
</I>&gt;&gt;<i> cache_store_log stdio:/accerater/logs/webcache3/opmizer1_store.log
</I>&gt;<i> You should not need cache_store_log at all.
</I>&gt;<i>
</I>&gt;<i> Either remove it or use this instead (mind the wrap):
</I>&gt;<i>
</I>&gt;<i> cache_store_log
</I>&gt;<i> stdio:/accerater/logs/webcache3/opmizer${process_number}_store.log
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> url_rewrite_program /accerater/webcache3/media/mediatool/media2
</I>&gt;&gt;<i> store_id_program /accerater/webcache3/media/mediatool/media1
</I>&gt;<i> Why do you have different binary executable names for the two workers
</I>&gt;<i> helpers?
</I>&gt;<i>
</I>&gt;<i> If they are actually different, then the traffic will have different
</I>&gt;<i> things applied randomly depending on which worker happened to accept the
</I>&gt;<i> TCP connection. If they are the same, then you only need to define them
</I>&gt;<i> once and workers will start their own sets as needed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> unique_hostname fast_opmizer1
</I>&gt;&gt;<i> snmp_port 3401
</I>&gt;<i> Use this instead:
</I>&gt;<i>
</I>&gt;<i>   unique_hostname fast_opmizer${process_number}
</I>&gt;<i>   snmp_port 340${process_number}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All of the above details can move up out of the per-worker area.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> #cache_dir rock /accerater/webcache3/storage/rock1 2646 min-size=4096
</I>&gt;&gt;<i> max-size=262144 max-swap-rate=250 swap-timeout=350
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_dir aufs /accerater/webcache3/storage/aufs1/${process_number} 5200
</I>&gt;&gt;<i> 16 64 min-size=262145
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> else
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #endif
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if ${process_number} = 2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_swap_state /accerater/logs/webcache3/opmizer2_swap_log
</I>&gt;&gt;<i> access_log stdio:/accerater/logs/webcache3/opmizer2_access.log squid
</I>&gt;&gt;<i> cache_log /accerater/logs/webcache3/opmizer2_cache.log
</I>&gt;&gt;<i> cache_store_log stdio:/accerater/logs/webcache3/opmizer2_store.log
</I>&gt;&gt;<i> url_rewrite_program /accerater/webcache3/media/mediatool/media4
</I>&gt;&gt;<i> store_id_program /accerater/webcache3/media/mediatool/media3
</I>&gt;&gt;<i> unique_hostname fast_opmizer2
</I>&gt;&gt;<i> snmp_port 3402
</I>&gt;&gt;<i>
</I>&gt;<i> Same notes as for worker 1.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> #cache_dir rock /accerater/webcache3/storage/rock2 2646 min-size=4096
</I>&gt;&gt;<i> max-size=262144 max-swap-rate=250 swap-timeout=350
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_dir aufs /accerater/webcache3/storage/aufs1/${process_number} 5200
</I>&gt;&gt;<i> 16 64 min-size=262145
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> endif
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> endif
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 127.0.0.1:3220
</I>&gt;&gt;<i> http_port 3221 tproxy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> wccp_version 2
</I>&gt;&gt;<i> wccp2_router 192.168.2.1
</I>&gt;&gt;<i> wccp2_forwarding_method 1
</I>&gt;&gt;<i> wccp2_return_method 1
</I>&gt;&gt;<i> wccp2_assignment_method 1
</I>&gt;&gt;<i> wccp2_service dynamic 80
</I>&gt;&gt;<i> wccp2_service dynamic 90
</I>&gt;&gt;<i> wccp2_service_info 80 protocol=tcp flags=src_ip_hash priority=240 ports=80
</I>&gt;&gt;<i> wccp2_service_info 90 protocol=tcp flags=dst_ip_hash,ports_source
</I>&gt;&gt;<i> priority=240 ports=80
</I>&gt;<i> Both workers are telling the WCCP router in different packets that they
</I>&gt;<i> are available on the same IP:port. In theory that should work fine,
</I>&gt;<i> since the router is just getting twice as many updates as it needs to
</I>&gt;<i> keep the proxy registered. In practice some people are finding that
</I>&gt;<i> certain routers cant cope with the extra registration operations.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 192.168.2.2
</I>&gt;&gt;<i>
</I>&gt;<i> Be aware that TPROXY spoof the client outgong address. This line has no
</I>&gt;<i> effect on the TPROXY intercepted traffic. Only the traffic received on
</I>&gt;<i> port 3220 will be using this outgoing address.
</I>&gt;<i>   Your WCCP rules need to account for that by not depending on the packet
</I>&gt;<i> IP addresses.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002652.html">[squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ? ( there are same problem between smp model or single model )
</A></li>
	<LI>Next message (by thread): <A HREF="002664.html">[squid-users] Whether squid 3.5.2 can support rock at wccp tproxy environment really ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2653">[ date ]</a>
              <a href="thread.html#2653">[ thread ]</a>
              <a href="subject.html#2653">[ subject ]</a>
              <a href="author.html#2653">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
