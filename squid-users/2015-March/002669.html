<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C54FEF62D.2080403%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002667.html">
   <LINK REL="Next"  HREF="002670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C54FEF62D.2080403%40treenet.co.nz%3E"
       TITLE="[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 10 13:48:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002667.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
        <LI>Next message (by thread): <A HREF="002670.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2669">[ date ]</a>
              <a href="thread.html#2669">[ thread ]</a>
              <a href="subject.html#2669">[ subject ]</a>
              <a href="author.html#2669">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2015 2:19 a.m., Klavs Klavsen wrote:
&gt;<i> Amos Jeffries wrote on 03/10/2015 01:50 PM:
</I>&gt;&gt;<i> On 11/03/2015 1:29 a.m., Klavs Klavsen wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I just setup a squid trying to get it to work in intercept mode..
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I seem to hit some squid internal loop where it goes haywire internally
</I>&gt;&gt;&gt;<i> somehow?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You have explicitly configured Squid instructing it that traffic
</I>&gt;&gt;<i> arriving on port 3129 has been intercepted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You then sent Squid a port-80 syntax message with TCP packet destination
</I>&gt;&gt;<i> IP:port of 127.0.0.1:3129.
</I>&gt;&gt;<i>
</I>&gt;<i> port 80 syntax?
</I>&gt;<i> 
</I>&gt;&gt;<i> It is for this reason that all our interception tutorials state in bold
</I>&gt;&gt;<i> that its a very good idea to firewall the 3129 port such that no
</I>&gt;&gt;<i> software, even localhost may send traffic directly into it.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> ahh.. I was hoping to have a loadbalancer in front of squid (haproxy) -
</I>&gt;<i> to have failover, if squid server should fail..
</I>
In which case you would NOT be intercepting by Squid. The LB device
would be doing that. The haproxy would be configured to pass traffic to
Squid port 3128.

Though, what happens if the haproxy device fails? all you've done is
shift the bottleneck from Squid to both Squid and haproxy.

Squid has built in mechanisms for auto-restart if anything goes wrong.
Its sometimes hard to see that anything has happened at all from a
client perspective. The admin will just see some graph spikes in the
service records and (if they look) a log message.


&gt;<i> 
</I>&gt;<i> I'm trying to read and understand:
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Concepts_of_Interception_Caching">http://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Concepts_of_Interception_Caching</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> when nat'ing - doesn't squid just get the rewritten package (which would
</I>&gt;<i> have port 3129 in the tcp dest. port field?)
</I>
Squid gets a NAT-mangled TCP/IP SYN packet. It then uses the kernel to
undo that mangling in order to contact the original destination IP on
the outgoing connection from Squid.

If the incoming detail (after un-mangling) was Squid itself, things loop.

&gt;<i> 
</I>&gt;<i> ie. how can it discern a package send directly to port 3129 - with data
</I>&gt;<i> containing f.ex.:
</I>&gt;<i> GET / HTTP/1.1
</I>&gt;<i> Host: www.bt.dk
</I>&gt;<i> 
</I>&gt;<i> with one just sent directly to that port?
</I>
It can't. Which is why NAT existence is a bunch of security vulnerabilities.


Squid is using the Via header to detect if a request has already been
through this same proxy N times. Which is why Via is a mandatory header
in HTTP/1.1. But all that does is prevent the loop DoS'ing the entire
machine and all other services on it - the bad client has still DoS'ed
itself.

&gt;<i> 
</I>&gt;<i> I seem to be failing to understand wherein the difference lies :(
</I>&gt;<i> 
</I>&gt;<i> I can see that one can choose to use GRE encapsulation - but that is
</I>&gt;<i> stated to be optional..
</I>
GRE is just a tunnel that can be used to divert traffic to the Squid
machine for NAT to operate on. Usually used as part of WCCP routing
setups, but its just a tunnel.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002667.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
	<LI>Next message (by thread): <A HREF="002670.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2669">[ date ]</a>
              <a href="thread.html#2669">[ thread ]</a>
              <a href="subject.html#2669">[ subject ]</a>
              <a href="author.html#2669">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
