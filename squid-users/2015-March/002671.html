<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] peek/splice working with lynx but not with firefox or chrome
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek/splice%20working%20with%20lynx%20but%20not%20with%0A%20firefox%20or%20chrome&In-Reply-To=%3C54FEFAF7.70205%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002668.html">
   <LINK REL="Next"  HREF="002673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] peek/splice working with lynx but not with firefox or chrome</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek/splice%20working%20with%20lynx%20but%20not%20with%0A%20firefox%20or%20chrome&In-Reply-To=%3C54FEFAF7.70205%40treenet.co.nz%3E"
       TITLE="[squid-users] peek/splice working with lynx but not with firefox or chrome">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 10 14:08:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002668.html">[squid-users] peek/splice working with lynx but not with firefox or	chrome
</A></li>
        <LI>Next message (by thread): <A HREF="002673.html">[squid-users] peek/splice working with lynx but not with firefox or chrome
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2671">[ date ]</a>
              <a href="thread.html#2671">[ thread ]</a>
              <a href="subject.html#2671">[ subject ]</a>
              <a href="author.html#2671">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2015 2:46 a.m., Roel van Meer wrote:
&gt;<i> Hi list!
</I>&gt;<i> 
</I>&gt;<i> I'm trying to get peek/splice working with intercepted https
</I>&gt;<i> connections. The final goal is to accept or reject connections based on
</I>&gt;<i> the SNI info that we get from the first peek. So first, I would like to
</I>&gt;<i> be able to do peek/splice on all requests, and then later I can use an
</I>&gt;<i> external acl to block some of them.
</I>&gt;<i> 
</I>&gt;<i> I'm having trouble getting the first step to work. My peek/splice config
</I>&gt;<i> works when I use lynx as a browser, but not (well) with firefox or
</I>&gt;<i> chrome. The latter two sometimes return a result, but often don't. When
</I>&gt;<i> this happens I get diverse errors in the cache log like:
</I>&gt;<i> 
</I>&gt;<i>  Error negotiating SSL on FD 20: error:140770FC:SSL
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:unknown protocol (1/-1/0)
</I>&gt;<i>  Error negotiating SSL on FD 41: error:14094085:SSL
</I>&gt;<i> routines:SSL3_READ_BYTES:ccs received early (1/-1/0)
</I>&gt;<i>  Error negotiating SSL on FD 31: error:1407743E:SSL
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:tlsv1 alert inappropriate fallback (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> The relevant portions of squid.conf:
</I>&gt;<i> 
</I>&gt;<i>  https_port 192.168.13.1:3130 intercept ssl-bump options=ALL
</I>&gt;<i> cert=/etc/ssl/certs/server.pem
</I>
With &quot;options=ALL&quot; you have enabled all features in the OpenSSL library
including features which can cause the popular modern browsers to view
Squid as a dangerously insecure server.


&gt;<i> 
</I>&gt;<i>  acl step1 at_step SslBump1
</I>&gt;<i>  acl step2 at_step SslBump2
</I>&gt;<i>  acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i>  ssl_bump peek step1
</I>&gt;<i>  ssl_bump peek step2
</I>&gt;<i>  ssl_bump splice all
</I>&gt;<i> 
</I>
Theres nothing in the above which uses SNI. All that does is cause Squid
to expolicitly look at the TLS handshake that is going on. Then to
splice the two connections together a if it weren't there.


&gt;<i>  sslproxy_cert_error allow all
</I>&gt;<i>  sslproxy_flags DONT_VERIFY_PEER
</I>
Then you are explicily disabling the checks to ensure the connections
Squid uses to send the clients private data to servers are secure.


&gt;<i> 
</I>&gt;<i> I'm using squid 3.5.2 built with openssl 0.9.8zc on Slackware 13.1.
</I>&gt;<i> Traffic is redirected from port 443 top 3130 with iptables.
</I>

... and with an older version of OpenSSL missing many of the last few
years worth of TLS crypto features. IIRC the library releases are now up
to 1.1.* or something. Its best to keep that kind of thing operating the
latest versions.


It may sound silly but, do all those browsers even support SNI on your
OS with the crypto libraries they use?

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002668.html">[squid-users] peek/splice working with lynx but not with firefox or	chrome
</A></li>
	<LI>Next message (by thread): <A HREF="002673.html">[squid-users] peek/splice working with lynx but not with firefox or chrome
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2671">[ date ]</a>
              <a href="thread.html#2671">[ thread ]</a>
              <a href="subject.html#2671">[ subject ]</a>
              <a href="author.html#2671">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
