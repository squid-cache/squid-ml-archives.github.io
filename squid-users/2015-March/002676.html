<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] peek/splice working with lynx but not with firefox or chrome
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek/splice%20working%20with%20lynx%20but%20not%20with%0A%20firefox%20or%20chrome&In-Reply-To=%3C54FF0406.9000203%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002673.html">
   <LINK REL="Next"  HREF="002677.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] peek/splice working with lynx but not with firefox or chrome</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek/splice%20working%20with%20lynx%20but%20not%20with%0A%20firefox%20or%20chrome&In-Reply-To=%3C54FF0406.9000203%40treenet.co.nz%3E"
       TITLE="[squid-users] peek/splice working with lynx but not with firefox or chrome">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 10 14:47:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002673.html">[squid-users] peek/splice working with lynx but not with firefox or chrome
</A></li>
        <LI>Next message (by thread): <A HREF="002677.html">[squid-users] peek/splice working with lynx but not with firefox or chrome
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2676">[ date ]</a>
              <a href="thread.html#2676">[ thread ]</a>
              <a href="subject.html#2676">[ subject ]</a>
              <a href="author.html#2676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2015 3:28 a.m., Roel van Meer wrote:
&gt;<i> Amos Jeffries writes:
</I>&gt;<i> 
</I>&gt;&gt;<i> &gt; The relevant portions of squid.conf:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;  https_port 192.168.13.1:3130 intercept ssl-bump options=ALL
</I>&gt;&gt;<i> &gt; cert=/etc/ssl/certs/server.pem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> With &quot;options=ALL&quot; you have enabled all features in the OpenSSL library
</I>&gt;&gt;<i> including features which can cause the popular modern browsers to view
</I>&gt;&gt;<i> Squid as a dangerously insecure server.
</I>&gt;<i> 
</I>&gt;<i> I also tried it without options=ALL. The reason I enabled it was that
</I>&gt;<i> the documentation says:
</I>&gt;<i> 
</I>&gt;<i>  Enable various bug workarounds suggested as &quot;harmless&quot; by OpenSSL
</I>&gt;<i>  Be warned that this reduces SSL/TLS strength to some attacks.
</I>&gt;<i> 
</I>&gt;<i> This seemed useful to me.
</I>&gt;<i> 
</I>&gt;&gt;<i> &gt;  acl step1 at_step SslBump1
</I>&gt;&gt;<i> &gt;  acl step2 at_step SslBump2
</I>&gt;&gt;<i> &gt;  acl step3 at_step SslBump3
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;  ssl_bump peek step1
</I>&gt;&gt;<i> &gt;  ssl_bump peek step2
</I>&gt;&gt;<i> &gt;  ssl_bump splice all
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Theres nothing in the above which uses SNI. All that does is cause Squid
</I>&gt;&gt;<i> to expolicitly look at the TLS handshake that is going on. Then to
</I>&gt;&gt;<i> splice the two connections together a if it weren't there.
</I>&gt;<i> 
</I>&gt;<i> Yes, I know. I would use something like this for that:
</I>&gt;<i> 
</I>&gt;<i>  external_acl_type sg1t %URI %SRC %METHOD %ssl::&gt;sni /tmp/test.sh
</I>&gt;<i>  acl sg1 external sg1t
</I>&gt;<i>  ssl_bump terminate step3 sg1
</I>&gt;<i> 
</I>&gt;<i> which does work. In the test script, I can either allow or reject a
</I>&gt;<i> connection based on the SNI that is passed in (if one is).
</I>&gt;<i> I have no trouble there, only with the peek/splice stuff.
</I>
see Nathan Hoads thread just the other day about a setup same as yours
NOT working.

There are two patches that need applying. One already in the 3.5 series
snapshots to fix SNI on some traffic cases, one still in QA review for
adding an ACL &quot;server_name&quot; that can match SNI without the helper.

&gt;<i> 
</I>&gt;<i> I'm trying to get peek/splice to work on all intercepted https
</I>&gt;<i> connections. As soon as that works, I can do fancy stuff with SNI. But
</I>&gt;<i> when I enable peek/splice as in the config above, I can no longer
</I>&gt;<i> connect to https sites from Chrome and Firefox, so that is what I need
</I>&gt;<i> to solve first. Sorry if I was unclear.
</I>&gt;<i> 
</I>&gt;&gt;<i> &gt;  sslproxy_cert_error allow all
</I>&gt;&gt;<i> &gt;  sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then you are explicily disabling the checks to ensure the connections
</I>&gt;&gt;<i> Squid uses to send the clients private data to servers are secure.
</I>&gt;<i> 
</I>&gt;<i> Yes, I am, but since I'm only splicing the connection, the browser
</I>&gt;<i> itself should be able to get the original certificate sent by the
</I>&gt;<i> server, and handle it appropriately. Or am I mistaken there?
</I>
That is correct. But also they get it through the filter of your OpenSSL
version parsing and re-packing capabilities for the underlying TLS/SSL
protocol syntax.

Those errors hint at things like the SSLv2/SSLv3 syntax being offered
and rejected, ALPN being mangled, or some advanced timing-based feature
being screwed up by the peek operation.


&gt;<i> 
</I>&gt;&gt;<i> &gt; I'm using squid 3.5.2 built with openssl 0.9.8zc on Slackware 13.1.
</I>&gt;&gt;<i> &gt; Traffic is redirected from port 443 top 3130 with iptables.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ... and with an older version of OpenSSL missing many of the last few
</I>&gt;&gt;<i> years worth of TLS crypto features. IIRC the library releases are now up
</I>&gt;&gt;<i> to 1.1.* or something. Its best to keep that kind of thing operating the
</I>&gt;&gt;<i> latest versions.
</I>&gt;<i> 
</I>&gt;<i> I know it missing the latest features, but security patches are
</I>&gt;<i> backported. And I know it is old, but it's what I have to work with
</I>&gt;<i> now.Do you think it might be the cause of the problem I'm having with
</I>&gt;<i> peek/splice, or was it a general recommendation?
</I>
Its a potential source of problems. Chrome is very much on the front
line of the arms race attempting to stop things like SSL-Bump working.
Firefox implement their own crypto library which tracks the latest TLS
features at a similar speed of development.
OpenSSL will be perpetually behind both of them, but at least the latest
one(s) have better chances not to be advertising features they reject in
&quot;considered harmful&quot; grounds.

&gt;<i> 
</I>&gt;&gt;<i> It may sound silly but, do all those browsers even support SNI on your
</I>&gt;&gt;<i> OS with the crypto libraries they use?
</I>&gt;<i> 
</I>&gt;<i> Ah, I should have said, chrome and FF are on a Windows 7.
</I>
Oay. They should then.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002673.html">[squid-users] peek/splice working with lynx but not with firefox or chrome
</A></li>
	<LI>Next message (by thread): <A HREF="002677.html">[squid-users] peek/splice working with lynx but not with firefox or chrome
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2676">[ date ]</a>
              <a href="thread.html#2676">[ thread ]</a>
              <a href="subject.html#2676">[ subject ]</a>
              <a href="author.html#2676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
