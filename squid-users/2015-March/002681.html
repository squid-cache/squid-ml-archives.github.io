<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C54FF1FBF.6000605%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002678.html">
   <LINK REL="Next"  HREF="002715.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C54FF1FBF.6000605%40treenet.co.nz%3E"
       TITLE="[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 10 16:45:51 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002678.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
        <LI>Next message (by thread): <A HREF="002715.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2681">[ date ]</a>
              <a href="thread.html#2681">[ thread ]</a>
              <a href="subject.html#2681">[ subject ]</a>
              <a href="author.html#2681">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/2015 4:08 a.m., Klavs Klavsen wrote:
&gt;<i> hmm..
</I>&gt;<i> 
</I>&gt;<i> I've read the config examples..
</I>&gt;<i> 
</I>&gt;<i> I would very much like to understand how/why it works, if I've setup a
</I>&gt;<i> client to route package to squid (instead of trying to send directly)..
</I>
I suggest diagramming your network traffic flow, writing down the TCP
packet src/dst IP:port values on each connection.

&quot;Normal&quot; interception operation showing your loop:

1) curl thinks its talking to Internet server
    src ip-of-curl:*
    dst ip-of-bt.dk:80

2) NAT diverts the packet to haproxy
    src ip-of-curl:*
    dst ip-of-haproxy-machine:*

3) haproxy knows its talking to Squid
    src ip-of-haproxy-machine:*
    dst 10.43.18.165:3129

4) Squid machine reports un-mangled NAT is ...
    src ip-of-haproxy-machine:*
    dst 10.43.18.165:3129

5) Squid contacts dst-IP to fetch the HTTP request
    src 10.43.18.165:*
    dst 10.43.18.165:3129

6) repeat from 4 (but with src now 10.43.18.165:*) until
  a) machine runs out of memory,
  b) machine runs out of TCP sockets,
  c) machine runs out of disk space logging errors, or
  d) Squid notices Via header loop and rejects request.


A &quot;Normal&quot; connection directly to squid port:


1) curl thinks its talking to Internet server on 10.43.18.165:3129
    src ip-of-curl:*
    dst 10.43.18.165:3129

2) Squid machine reports un-mangled NAT is ...
    src ip-of-curl:*
    dst 10.43.18.165:3129

3) Squid contacts dst-IP to fetch the HTTP request
    src 10.43.18.165:*
    dst 10.43.18.165:3129

4) repeat from 2 (but with src now 10.43.18.165:*) until
  a) machine runs out of memory,
  b) machine runs out of TCP sockets,
  c) machine runs out of disk space logging errors, or
  d) Squid notices Via header loop and rejects request.



Confirm it against wireshark packet traces of what is coming *in* to the
Squid machine.

Squid undoes the NAT mangling done on the machine its running. Any NAT
changes prior to that is unknowable. NAT un-mangling can sometimes
appear to work in Squid if haproxy runs on the same machine BUT, some
NAT lookup requires correct TCP socket and some require particular
IP:port ordering so its unrelible.


The Squid access.log lines with ORIGINAL_DST show what client src-IP and
dst-IP Squid received after NAT un-mangling. Though you have to take
care to subtract the duration value from the line timestamp to get the
order right for loops.


&gt;<i> 
</I>&gt;<i> I'm trying to follow this on a test client (haven't gotten it working yet):
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>
</I>&gt;<i> (where squid is amongst the internal clients - actually on it's own vlan
</I>&gt;<i> - but it's not the default route)
</I>
If its on its own VLAN then its not &quot;among the clients&quot;.

&quot;among the clients&quot; means a bunch of machines all on the same LAN
subnet, one of which is the Squid proxy. They can talk directly to each
other without involving the router so you can hit the triangular routing
problem and have to account for it in your forwarding and/or NAT rules.

If you have Squid on a separate subnet or VLAN with all packets going
via the router, that is a DMZ subnet. The router sees all packets and
can adjusts them right, so triangular routing problem is avoided.


&gt;<i> 
</I>&gt;<i> meanwhile I tried pointing to the haproxy - which then forwards requests
</I>&gt;<i> in tcp mode, to squid server port 3129.
</I>&gt;<i> 
</I>&gt;<i> If I just send to haproxy directly, I get the loop and this in the
</I>&gt;<i> accesslog:
</I>&gt;<i> 1425998994.271      0 10.43.18.165 TCP_MISS_ABORTED/000 0 GET
</I>&gt;<i> <A HREF="http://www.bt.dk/">http://www.bt.dk/</A> - ORIGINAL_DST/10.43.18.165 -
</I>&gt;<i> 
</I>&gt;<i> when doing:
</I>&gt;<i> curl -H &quot;Host: www.bt.dk&quot; <A HREF="http://proxy-haproxy-ip/">http://proxy-haproxy-ip/</A>
</I>&gt;<i> 
</I>&gt;<i> 10.43.18.165 is the ip of squid server behind haproxy.
</I>

Methinks that haproxy is still sending to the Squid port configured with
&quot;intercept&quot; option.

A connection between two proxies is explicitly configured. Thus a normal
forward-proxy connection, no special port flags required.


The log line is also showing haproxy to be vulnerable to CVE-2009-0801.

If your Squid and haproxy are recent enough they could use the PROXY
protocol to exchange the original client connections TCP/IP details.
I've not tested it for this myself but that may also allow Squid with an
intercept port to both handle the traffic okay (PROXY protocol override
the NAT lookups), and protect against the CVE-2009-0801 vulnerability in
haproxy ('intercept' flags existence makes Squid do the security checks).


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002678.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
	<LI>Next message (by thread): <A HREF="002715.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2681">[ date ]</a>
              <a href="thread.html#2681">[ thread ]</a>
              <a href="subject.html#2681">[ subject ]</a>
              <a href="author.html#2681">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
