<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Reverse Proxy to Exchange 2010 OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Reverse%20Proxy%20to%20Exchange%202010%20OWA&In-Reply-To=%3Cb3dc7de79e30d3ee613464d80c3fc709%40dweimer.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002701.html">
   <LINK REL="Next"  HREF="002702.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Reverse Proxy to Exchange 2010 OWA</H1>
    <B>dweimer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Reverse%20Proxy%20to%20Exchange%202010%20OWA&In-Reply-To=%3Cb3dc7de79e30d3ee613464d80c3fc709%40dweimer.net%3E"
       TITLE="[squid-users] Squid Reverse Proxy to Exchange 2010 OWA">dweimer at dweimer.net
       </A><BR>
    <I>Wed Mar 11 19:59:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002701.html">[squid-users] Squid Reverse Proxy to Exchange 2010 OWA
</A></li>
        <LI>Next message (by thread): <A HREF="002702.html">[squid-users] Squid Reverse Proxy to Exchange 2010 OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2696">[ date ]</a>
              <a href="thread.html#2696">[ thread ]</a>
              <a href="subject.html#2696">[ subject ]</a>
              <a href="author.html#2696">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/11/2015 1:16 am, Alex Samad wrote:
&gt;<i> This is mine against 2008. haven't had any issues with attachments up 
</I>&gt;<i> to 10M
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cache_peer 127.0.0.1 parent 443 0 proxy-only no-query no-digest
</I>&gt;<i> originserver login=PASS ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> sslcert=/etc/httpd/conf.d/o.crt sslkey=/etc/httpd/conf.d/o.key
</I>&gt;<i> name=webServer
</I>&gt;<i> cache_peer 10.32.69.11 parent 443 0 proxy-only no-query no-digest
</I>&gt;<i> originserver login=PASS front-end-https=on ssl
</I>&gt;<i> sslflags=DONT_VERIFY_PEER sslcert=/etc/httpd/conf.d/o.crt
</I>&gt;<i> sslkey=/etc/httpd/conf.d/o.key name=exchangeServer
</I>&gt;<i> 
</I>&gt;<i> # List of acceptable URLs to send to the Exchange server
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/exchange
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/exchweb
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/public
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/owa
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/ecp
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/microsoft-server-activesync
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/rpc
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/rpcwithcert
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/exadmin
</I>&gt;<i> acl exch_url url_regex -i &lt;o&gt;/oab
</I>&gt;<i> 
</I>&gt;<i> # Send the Exchange URLs to the Exchange server
</I>&gt;<i> cache_peer_access exchangeServer allow exch_url
</I>&gt;<i> 
</I>&gt;<i> # Send everything else to the Apache
</I>&gt;<i> cache_peer_access webServer deny exch_url
</I>&gt;<i> 
</I>&gt;<i> # This is to protect Squid
</I>&gt;<i> never_direct allow exch_url
</I>&gt;<i> 
</I>&gt;<i> # Logging Configuration
</I>&gt;<i> redirect_rewrites_host_header off
</I>&gt;<i> cache_mem 32 MB
</I>&gt;<i> maximum_object_size_in_memory 128 KB
</I>&gt;<i> cache_log none
</I>&gt;<i> cache_store_log none
</I>&gt;<i> 
</I>&gt;<i> access_log /var/log/squid/office-access.log squid
</I>&gt;<i> #access_log none
</I>&gt;<i> cache_log /var/log/squid/office-cache.log
</I>&gt;<i> #cache_log none
</I>&gt;<i> pid_filename /var/run/squid-office.pid
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Set the hostname so that we can see Squid in the path (Optional)
</I>&gt;<i> visible_hostname &lt;o&gt;
</I>&gt;<i> deny_info TCP_RESET all
</I>&gt;<i> 
</I>&gt;<i> # ACL - required to allow
</I>&gt;<i> #acl all src ALL
</I>&gt;<i> 
</I>&gt;<i> # Allow everyone through, internal and external connections
</I>&gt;<i> http_access allow all
</I>&gt;<i> miss_access allow all
</I>&gt;<i> 
</I>&gt;<i> icp_port 0
</I>&gt;<i> snmp_port 0
</I>&gt;<i> 
</I>&gt;<i> via off
</I>&gt;<i> 
</I>&gt;<i> On 11 March 2015 at 15:42, dweimer &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dweimer at dweimer.net</A>&gt; wrote:
</I>&gt;&gt;<i> We have setup Squid as a reverse proxy to Exchange 2010 OWA server we
</I>&gt;&gt;<i> thought everything was working OK, but found out that any file 
</I>&gt;&gt;<i> attachments
</I>&gt;&gt;<i> over 2MB cause a timeout after 5 minutes. I remembered having this 
</I>&gt;&gt;<i> issue a
</I>&gt;&gt;<i> while back with HTTPS, and it just went away after some updates. Some
</I>&gt;&gt;<i> searching found other users posting messages to the Squid mailing list 
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> had this issue in particular with OWA. However I never found a fix on 
</I>&gt;&gt;<i> any of
</I>&gt;&gt;<i> the threads.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Squid is currently running 3.4.11, on FreeBSD 10.1-RELEASE-p5, This 
</I>&gt;&gt;<i> occurs
</I>&gt;&gt;<i> even when sending the file through the local network passing through 
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> reverse proxy. With the slowest link being a 1G.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Below is the relevant parts of the configuration, with some 
</I>&gt;&gt;<i> information
</I>&gt;&gt;<i> excluded for security
</I>&gt;&gt;<i> https_port 10.50.20.12:443 accel defaultsite=... \
</I>&gt;&gt;<i>  cert=... \
</I>&gt;&gt;<i>  key=... \
</I>&gt;&gt;<i>  options=NO_SSLv2:NO_TLSv1:CIPHER_SERVER_PREFERENCE \
</I>&gt;&gt;<i>  cipher=RC4:!MD5:!aNULL:!EDH
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> cache_peer ... parent 443 0 ssl no-query no-digest no-netdb-exchange
</I>&gt;&gt;<i> originserver name=owa2010_parent sslcapath=/usr/local/share/certs
</I>&gt;&gt;<i> sslflags=DONT_VERIFY_PEER login=PASSTHRU front-end-https=on
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> We also host sharepoint (certificate is a wildcard certificate) this 
</I>&gt;&gt;<i> way as
</I>&gt;&gt;<i> well, and I have just verified that it has the same problem. It is 
</I>&gt;&gt;<i> served by
</I>&gt;&gt;<i> the same https_port line, and a different cache_peer the only 
</I>&gt;&gt;<i> difference is
</I>&gt;&gt;<i> the IP and it doesn't have the front-end-https option set.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Does anyone have any ideas to check?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> is this possibly a cause
</I>&gt;&gt;<i> &lt;<A HREF="http://www.squid-cache.org/Doc/config/broken_posts/">http://www.squid-cache.org/Doc/config/broken_posts/</A>&gt;?
</I>&gt;&gt;<i> 
</I>
I don't believe OWA has anything to do with my problem, it appears to be 
related entirely to posting with HTTPS using the reverse proxy. I ran 
into this after the upgrade from squid 3.1 to 3.2 back on FreeBSD 
version 9.0 &amp; 9.1. I never did find the answer to the issue then, it 
finally just went away after the upgrade to squid 3.3. At the time the 
application I was using was using that was affected was running on 
Apache and PHP, that application is still run from this reverse proxy 
server as well but apparently unaffected by the problem now. It's 
current version uses an uploader process that uses java to chunk the 
files into smaller pieces during upload.

What appears to happen is that the client sends the entire file to the 
Squid Reverse Proxy server, but somehow at the end of the file Squid 
never receives an expected end of file from the client. The client 
believes that everything is sent and sits waiting until it times out.

Oddly enough when I put fiddler on my laptop to capture the HTTPS 
traffic in a decrypted method so that I could see more information into 
what was happening. It succeeds if the browser is talking to fiddler, 
which is talking to the reverse proxy which is talking to the end 
server. Why adding fiddler to this chain of options fixes it is well 
beyond my understanding.

I am working on setting up a more simplified VM with mimimal settings in 
that I can run debugging in to get a better logs to help with the issue 
the current system has to much traffic on it. Does anyone have any 
suggestions for which debugging level I should use for squid in order to 
attempt to get useful logs to troubleshoot this?

-- 
Thanks,
    Dean E. Weimer
    <A HREF="http://www.dweimer.net/">http://www.dweimer.net/</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002701.html">[squid-users] Squid Reverse Proxy to Exchange 2010 OWA
</A></li>
	<LI>Next message (by thread): <A HREF="002702.html">[squid-users] Squid Reverse Proxy to Exchange 2010 OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2696">[ date ]</a>
              <a href="thread.html#2696">[ thread ]</a>
              <a href="subject.html#2696">[ subject ]</a>
              <a href="author.html#2696">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
