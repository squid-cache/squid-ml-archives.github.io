<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C55014A98.8030705%40vsen.dk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002681.html">
   <LINK REL="Next"  HREF="002718.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?</H1>
    <B>Klavs Klavsen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C55014A98.8030705%40vsen.dk%3E"
       TITLE="[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?">kl at vsen.dk
       </A><BR>
    <I>Thu Mar 12 08:13:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002681.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
        <LI>Next message (by thread): <A HREF="002718.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2715">[ date ]</a>
              <a href="thread.html#2715">[ thread ]</a>
              <a href="subject.html#2715">[ subject ]</a>
              <a href="author.html#2715">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Thank you for the walkthrough..

Instead of having to play with tproxy on haproxy currently, I figured 
i'd try a simpler route..

The purpose of this setup, is to &quot;jump around&quot; a firewall issue with a 
sh#! firewall, which in order to filter http and https traffic 
appearently drops 5-15%.. and in 6 months noone has seem willing/able to 
fix it :(

I've put squid directly on the 10.43.18.181 (previously haproxy) ip - 
and changed to: http_port 80 intercept

I tried this on the client (being on other subnet):
iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to-destination 
10.43.18.181:80

and the traffic looped in exactly the same way :(


Amos Jeffries wrote on 03/10/2015 05:45 PM:
&gt;<i> On 11/03/2015 4:08 a.m., Klavs Klavsen wrote:
</I>&gt;&gt;<i> hmm..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've read the config examples..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would very much like to understand how/why it works, if I've setup a
</I>&gt;&gt;<i> client to route package to squid (instead of trying to send directly)..
</I>&gt;<i>
</I>&gt;<i> I suggest diagramming your network traffic flow, writing down the TCP
</I>&gt;<i> packet src/dst IP:port values on each connection.
</I>&gt;<i>
</I>&gt;<i> &quot;Normal&quot; interception operation showing your loop:
</I>&gt;<i>
</I>&gt;<i> 1) curl thinks its talking to Internet server
</I>&gt;<i>      src ip-of-curl:*
</I>&gt;<i>      dst ip-of-bt.dk:80
</I>&gt;<i>
</I>&gt;<i> 2) NAT diverts the packet to haproxy
</I>&gt;<i>      src ip-of-curl:*
</I>&gt;<i>      dst ip-of-haproxy-machine:*
</I>&gt;<i>
</I>&gt;<i> 3) haproxy knows its talking to Squid
</I>&gt;<i>      src ip-of-haproxy-machine:*
</I>&gt;<i>      dst 10.43.18.165:3129
</I>&gt;<i>
</I>&gt;<i> 4) Squid machine reports un-mangled NAT is ...
</I>&gt;<i>      src ip-of-haproxy-machine:*
</I>&gt;<i>      dst 10.43.18.165:3129
</I>&gt;<i>
</I>&gt;<i> 5) Squid contacts dst-IP to fetch the HTTP request
</I>&gt;<i>      src 10.43.18.165:*
</I>&gt;<i>      dst 10.43.18.165:3129
</I>&gt;<i>
</I>&gt;<i> 6) repeat from 4 (but with src now 10.43.18.165:*) until
</I>&gt;<i>    a) machine runs out of memory,
</I>&gt;<i>    b) machine runs out of TCP sockets,
</I>&gt;<i>    c) machine runs out of disk space logging errors, or
</I>&gt;<i>    d) Squid notices Via header loop and rejects request.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> A &quot;Normal&quot; connection directly to squid port:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 1) curl thinks its talking to Internet server on 10.43.18.165:3129
</I>&gt;<i>      src ip-of-curl:*
</I>&gt;<i>      dst 10.43.18.165:3129
</I>&gt;<i>
</I>&gt;<i> 2) Squid machine reports un-mangled NAT is ...
</I>&gt;<i>      src ip-of-curl:*
</I>&gt;<i>      dst 10.43.18.165:3129
</I>&gt;<i>
</I>&gt;<i> 3) Squid contacts dst-IP to fetch the HTTP request
</I>&gt;<i>      src 10.43.18.165:*
</I>&gt;<i>      dst 10.43.18.165:3129
</I>&gt;<i>
</I>&gt;<i> 4) repeat from 2 (but with src now 10.43.18.165:*) until
</I>&gt;<i>    a) machine runs out of memory,
</I>&gt;<i>    b) machine runs out of TCP sockets,
</I>&gt;<i>    c) machine runs out of disk space logging errors, or
</I>&gt;<i>    d) Squid notices Via header loop and rejects request.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Confirm it against wireshark packet traces of what is coming *in* to the
</I>&gt;<i> Squid machine.
</I>&gt;<i>
</I>&gt;<i> Squid undoes the NAT mangling done on the machine its running. Any NAT
</I>&gt;<i> changes prior to that is unknowable. NAT un-mangling can sometimes
</I>&gt;<i> appear to work in Squid if haproxy runs on the same machine BUT, some
</I>&gt;<i> NAT lookup requires correct TCP socket and some require particular
</I>&gt;<i> IP:port ordering so its unrelible.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Squid access.log lines with ORIGINAL_DST show what client src-IP and
</I>&gt;<i> dst-IP Squid received after NAT un-mangling. Though you have to take
</I>&gt;<i> care to subtract the duration value from the line timestamp to get the
</I>&gt;<i> order right for loops.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to follow this on a test client (haven't gotten it working yet):
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>
</I>&gt;&gt;<i> (where squid is amongst the internal clients - actually on it's own vlan
</I>&gt;&gt;<i> - but it's not the default route)
</I>&gt;<i>
</I>&gt;<i> If its on its own VLAN then its not &quot;among the clients&quot;.
</I>&gt;<i>
</I>&gt;<i> &quot;among the clients&quot; means a bunch of machines all on the same LAN
</I>&gt;<i> subnet, one of which is the Squid proxy. They can talk directly to each
</I>&gt;<i> other without involving the router so you can hit the triangular routing
</I>&gt;<i> problem and have to account for it in your forwarding and/or NAT rules.
</I>&gt;<i>
</I>&gt;<i> If you have Squid on a separate subnet or VLAN with all packets going
</I>&gt;<i> via the router, that is a DMZ subnet. The router sees all packets and
</I>&gt;<i> can adjusts them right, so triangular routing problem is avoided.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> meanwhile I tried pointing to the haproxy - which then forwards requests
</I>&gt;&gt;<i> in tcp mode, to squid server port 3129.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I just send to haproxy directly, I get the loop and this in the
</I>&gt;&gt;<i> accesslog:
</I>&gt;&gt;<i> 1425998994.271      0 10.43.18.165 TCP_MISS_ABORTED/000 0 GET
</I>&gt;&gt;<i> <A HREF="http://www.bt.dk/">http://www.bt.dk/</A> - ORIGINAL_DST/10.43.18.165 -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> when doing:
</I>&gt;&gt;<i> curl -H &quot;Host: www.bt.dk&quot; <A HREF="http://proxy-haproxy-ip/">http://proxy-haproxy-ip/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 10.43.18.165 is the ip of squid server behind haproxy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Methinks that haproxy is still sending to the Squid port configured with
</I>&gt;<i> &quot;intercept&quot; option.
</I>&gt;<i>
</I>&gt;<i> A connection between two proxies is explicitly configured. Thus a normal
</I>&gt;<i> forward-proxy connection, no special port flags required.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The log line is also showing haproxy to be vulnerable to CVE-2009-0801.
</I>&gt;<i>
</I>&gt;<i> If your Squid and haproxy are recent enough they could use the PROXY
</I>&gt;<i> protocol to exchange the original client connections TCP/IP details.
</I>&gt;<i> I've not tested it for this myself but that may also allow Squid with an
</I>&gt;<i> intercept port to both handle the traffic okay (PROXY protocol override
</I>&gt;<i> the NAT lookups), and protect against the CVE-2009-0801 vulnerability in
</I>&gt;<i> haproxy ('intercept' flags existence makes Squid do the security checks).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Regards,
Klavs Klavsen, GSEC - <A HREF="https://lists.squid-cache.org/listinfo/squid-users">kl at vsen.dk</A> - <A HREF="http://www.vsen.dk">http://www.vsen.dk</A> - Tlf. 61281200

&quot;Those who do not understand Unix are condemned to reinvent it, poorly.&quot;
   --Henry Spencer


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002681.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
	<LI>Next message (by thread): <A HREF="002718.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2715">[ date ]</a>
              <a href="thread.html#2715">[ thread ]</a>
              <a href="subject.html#2715">[ subject ]</a>
              <a href="author.html#2715">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
