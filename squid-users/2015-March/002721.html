<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] urlpath_regex
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20urlpath_regex&In-Reply-To=%3C55016928.4070900%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002716.html">
   <LINK REL="Next"  HREF="002722.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] urlpath_regex</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20urlpath_regex&In-Reply-To=%3C55016928.4070900%40treenet.co.nz%3E"
       TITLE="[squid-users] urlpath_regex">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Mar 12 10:23:36 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002716.html">[squid-users] urlpath_regex
</A></li>
        <LI>Next message (by thread): <A HREF="002722.html">[squid-users] urlpath_regex
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2721">[ date ]</a>
              <a href="thread.html#2721">[ thread ]</a>
              <a href="subject.html#2721">[ subject ]</a>
              <a href="author.html#2721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/03/2015 9:14 p.m., James Harper wrote:
&gt;<i> I have just noticed that urlpath_regex isn't doing what I want:
</I>&gt;<i> 
</I>&gt;<i> acl wuau_repo dstdomain .download.windowsupdate.com
</I>&gt;<i> acl wuau_path urlpath_regex -i \.psf$
</I>&gt;<i> acl dst_server dstdomain server
</I>&gt;<i> acl apt_cacher browser apt-cacher
</I>&gt;<i> 
</I>&gt;<i> cache deny dst_server
</I>&gt;<i> cache deny apt_cacher
</I>&gt;<i> cache deny wuau_repo
</I>&gt;<i> cache allow all
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_program /usr/local/squid/libexec/ext_apt_rewrite
</I>&gt;<i> url_rewrite_children 5 startup=0 idle=1 concurrency=0
</I>&gt;<i> url_rewrite_access deny apt_cacher
</I>&gt;<i> url_rewrite_access allow wuau_repo wuau_path
</I>&gt;<i> url_rewrite_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Basically I am using apt-cacher to cache windows updates (apt-cacher
</I>&gt;<i> appears to handle and cache partial requests nicely while squid
</I>&gt;<i> doesn't). The main static windows update content files appear to be
</I>&gt;<i> .psf. So basically, if the destination is windows update, and the path
</I>&gt;<i> ends in .psf, then rewrite the url to go to my apt-cacher server (called
</I>&gt;<i> server, conveniently). If the browser string is apt-cacher then don't
</I>&gt;<i> rewrite, to avoid loops. Also don't cache anything to do with these servers.
</I>
Three things;

* by re-writing you are generating an entirely new request with the
apt-cacher server URL as the destination. The HTTP message details about
what was originally requested and from where is *gone* when the traffic
leaves for the server. The solution for that is outlined at the end of
this mail.

* the .cab also contain &quot;static&quot; content for the updates installer files
and DLLs etc. particularly for the older Windows versions.

* if you leave Squid as being allowed to cache the content it will do so
for most of the visible page contents people see. And for a moderate
portion of the updates as well. Its just the range request fetches
inside archives that Squid wont cache without tuning.

&gt;<i> 
</I>&gt;<i> It works except for the wuau_path acl. The line:
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_access allow wuau_repo wuau_path
</I>&gt;<i> 
</I>&gt;<i> matches all paths on the wuau_repo access list, not just those ending in
</I>&gt;<i> .psf. I get hits for paths ending in .cab, and even worse, paths with a
</I>&gt;<i> ? in them.
</I>&gt;<i>
</I>&gt;<i> What am I doing wrong?
</I>
Strange. It should only be matching for URLs ending in &quot;.psf&quot;.

Be aware that regex is quite literaly only looking at the line ending
and does explicitly mean URLs such as these as well:

 <A HREF="http://download.windowsupdate.com/blah.cab?voodoo.psf">http://download.windowsupdate.com/blah.cab?voodoo.psf</A>
 <A HREF="http://download.windowsupdate.com/?BLAH.PSF">http://download.windowsupdate.com/?BLAH.PSF</A>

If you need it to match only the things that look (to humans) like
on-disk file names I recommend:

   -i \.psf(\?.*)?$


Did you build your Squid normally, or with a specific regex library?

Is there another config line adding to wuau_path somewhere in your
squid.conf?

Is Squid actually running with the squid.conf you think it is?
 (sounds silly, but mistakes happen)



Also, unrelated to this ... have you tried using cache_peer instead of
URL-rewriting ?

 cache_peer server parent 8080 0
 cache_peer_access server allow wuau_repo wuau_path
 cache_peer_access server deny all

I assuming its listening on port 8080. It may need the &quot;originserver&quot;
option as well.
apt-cacher should fetch from the Internet, not looping back through Squid.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002716.html">[squid-users] urlpath_regex
</A></li>
	<LI>Next message (by thread): <A HREF="002722.html">[squid-users] urlpath_regex
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2721">[ date ]</a>
              <a href="thread.html#2721">[ thread ]</a>
              <a href="subject.html#2721">[ subject ]</a>
              <a href="author.html#2721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
