<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C550171AB.9020601%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002718.html">
   <LINK REL="Next"  HREF="002725.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20%22internal%3F%22%20loop%20-%20with%20no%20firewall%20nat%0A%20going%20on..%3F&In-Reply-To=%3C550171AB.9020601%40treenet.co.nz%3E"
       TITLE="[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Mar 12 10:59:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002718.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
        <LI>Next message (by thread): <A HREF="002725.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2723">[ date ]</a>
              <a href="thread.html#2723">[ thread ]</a>
              <a href="subject.html#2723">[ subject ]</a>
              <a href="author.html#2723">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>If your intention here is to get around a broken firewall devices port
80/443 inspection then I expect you require two proxies anyway. The
traffic has to be on a different port entirely which is not being
mangled by the firewall.

One before and one after the firewall, with packets flowing over the
unusual port between them.

Otherwise the traffic will still be going through the firewall on port
80/443 regardless of the proxying.

The proxy closest to the clients should be doing the NAT intercept,
pasing traffic explicitly to the one outside, and the one outside being
a normal forward-proxy accepting traffic only from the internal one.




On 12/03/2015 10:11 p.m., Klavs Klavsen wrote:
&gt;<i> As i Understand intercept - that will only work (as you said) when NAT
</I>&gt;<i> is performed on the box that is to intercept (when I remove haproxy -
</I>&gt;<i> that means the squid box itself).
</I>&gt;<i> 
</I>&gt;<i> and I'm going to move the squid box to the same network as the
</I>&gt;<i> webservers - to be able to do it the routing way.
</I>&gt;<i> 
</I>&gt;<i> It seems this config should then be applicable &quot;When Squid is in a DMZ
</I>&gt;<i> between the router and Internet&quot; from
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>
</I>&gt;<i> 
</I>&gt;<i> But do I need to enable net.ipv4.ip_forward = 1 ?
</I>&gt;<i> But perhaps that is needed, for iptables/linux kernel to even evaluate
</I>&gt;<i> PREROUTING rules (which then dnat's the package into squid port 3129)?
</I>
Yes, in order to receive packets destined for machines other than itself
forwarding is required. Otherwise the TCP stack martian packet detection
kicks in and drops them as invalid.

&gt;<i> 
</I>&gt;<i> I'd like to only allow packages out of the box, when coming from squid
</I>&gt;<i> (in case of some config issue - I'd like the squid-server NOT to route
</I>&gt;<i> stuff, which didn't go through squid program).
</I>&gt;<i> 
</I>&gt;<i> and then I figured I'd could ensure that from happening, by adding:
</I>&gt;<i> iptables -t nat -A OUTPUT --match owner --uid-owner squid -p tcp --dport
</I>&gt;<i> 80 -j ACCEPT
</I>&gt;<i> iptables -t nat -A OUTPUT --match owner --uid-owner squid -p tcp --dport
</I>&gt;<i> 80 -j ACCEPT
</I>&gt;<i> 
</I>&gt;<i> and then ofcourse allow &quot;state RELATED,ESTABLISHED&quot; and traffic I
</I>&gt;<i> actually &quot;want&quot; and have default policy DROP.
</I>

I dont think the NAT table is the right place to be doing that.

You need the NAT table rules from here
&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>&gt;

The mangle PREROUTING rule protects against external abuse of the Squid
port.
The nat PREROUNTING rules are to get packets into Squid (or bypass).

The nat POSTROUTING to ensure that all packets bypassed or Squid outputs
all come back through this machine.

To prevent packets going through the machine without going through Squid
add rules in the fiter table FORWARD chain.

Here is the netfilter packet flow diagram:
&lt;<A HREF="http://inai.de/images/nf-packet-flow.svg">http://inai.de/images/nf-packet-flow.svg</A>&gt;
(Squid would be the &quot;local process&quot; at the top center.)


&gt;<i> 
</I>&gt;<i> Klavs Klavsen wrote on 03/12/2015 09:13 AM:
</I>&gt;&gt;<i> Hi Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for the walkthrough..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Instead of having to play with tproxy on haproxy currently, I figured
</I>&gt;&gt;<i> i'd try a simpler route..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The purpose of this setup, is to &quot;jump around&quot; a firewall issue with a
</I>&gt;&gt;<i> sh#! firewall, which in order to filter http and https traffic
</I>&gt;&gt;<i> appearently drops 5-15%.. and in 6 months noone has seem willing/able to
</I>&gt;&gt;<i> fix it :(
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've put squid directly on the 10.43.18.181 (previously haproxy) ip -
</I>&gt;&gt;<i> and changed to: http_port 80 intercept
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried this on the client (being on other subnet):
</I>&gt;&gt;<i> iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to-destination
</I>&gt;&gt;<i> 10.43.18.181:80
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and the traffic looped in exactly the same way :(
</I>
OUTPUT is catching all traffic leaving processes running on the Squid
machine, including from Squid itself.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002718.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
	<LI>Next message (by thread): <A HREF="002725.html">[squid-users] squid &quot;internal?&quot; loop - with no firewall nat going on..?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2723">[ date ]</a>
              <a href="thread.html#2723">[ thread ]</a>
              <a href="subject.html#2723">[ subject ]</a>
              <a href="author.html#2723">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
