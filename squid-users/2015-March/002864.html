<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Server-first SSL bump in Squid 3.5.x
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Server-first%20SSL%20bump%20in%20Squid%203.5.x&In-Reply-To=%3C1BFBB56B-8D79-417D-8B76-04F19C29EEC6%40getbusi.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002897.html">
   <LINK REL="Next"  HREF="002865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Server-first SSL bump in Squid 3.5.x</H1>
    <B>Dan Charlesworth</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Server-first%20SSL%20bump%20in%20Squid%203.5.x&In-Reply-To=%3C1BFBB56B-8D79-417D-8B76-04F19C29EEC6%40getbusi.com%3E"
       TITLE="[squid-users] Server-first SSL bump in Squid 3.5.x">dan at getbusi.com
       </A><BR>
    <I>Thu Mar 19 05:36:52 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002897.html">[squid-users] Squid 3.5.2 will only start if cache directory is empty
</A></li>
        <LI>Next message (by thread): <A HREF="002865.html">[squid-users] Server-first SSL bump in Squid 3.5.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2864">[ date ]</a>
              <a href="thread.html#2864">[ thread ]</a>
              <a href="subject.html#2864">[ subject ]</a>
              <a href="author.html#2864">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey y&#8217;all

Finally got 3.5.2 running. I was under the impression that using server-first SSL bump would still be compatible, despite all the Peek &amp; Splice changes, but apparently not. Hopefully someone can explain what might be going wrong here ...

Using the same SSL Bump config that we used for 3.4, we now seeing this happen:
19/Mar/2015-16:21:32     22 d4:f4:6f:71:90:e6 10.0.1.71 TCP_DENIED 200 0 CONNECT 94.31.29.230:443 - server-first - HIER_NONE/- - -

Instead of this:
19/Mar/2015-14:42:04    736 d4:f4:6f:71:90:e6 10.0.1.71 TCP_MISS 200 96913 GET <A HREF="https://code.jquery.com/jquery-1.11.0.min.js">https://code.jquery.com/jquery-1.11.0.min.js</A> - server-first Mozilla/5.0%20(iPhone;%20CPU%20iPhone%20OS%208_2%20like%20Mac%20OS%20X)%20AppleWebKit/600.1.4%20(KHTML,%20like%20Gecko)%20Mobile/12D508 ORIGINAL_DST/94.31.29.53 application/x-javascript -

This request happens in a little splash page which is designed to test if squid&#8217;s CA cert is installed on the client and redirect them to some instructions if it&#8217;s not. This definitely isn&#8217;t happening for all intercepted HTTPS requests, just this (particularly important) one and some others.

SSL Bump config:
ssl_bump none localhost
ssl_bump server-first all
sslproxy_cert_error deny all

sslcrtd_program /usr/bin/squid_ssl_crtd -s /path/to/squid/ssl_db -M 4MB
sslcrtd_children 32 startup=5 idle=1

DNAT intercepting port config:
https_port 3130 intercept name=3130 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/path/to/squid/proxy-cert.cer key=/path/to/squid/proxy-key.key

Thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150319/dd97a11f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150319/dd97a11f/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002897.html">[squid-users] Squid 3.5.2 will only start if cache directory is empty
</A></li>
	<LI>Next message (by thread): <A HREF="002865.html">[squid-users] Server-first SSL bump in Squid 3.5.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2864">[ date ]</a>
              <a href="thread.html#2864">[ thread ]</a>
              <a href="subject.html#2864">[ subject ]</a>
              <a href="author.html#2864">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
