<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid will not authenticate NTLM/Kerberos when behind	a haproxy load balancer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20will%20not%20authenticate%20NTLM/Kerberos%20when%20behind%0A%09a%20haproxy%20load%20balancer&In-Reply-To=%3CCAP6yRXhoaUsO55OFB0eiRZe2Vj25A6xdDrev_-TpEQ2rDRDGMQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002919.html">
   <LINK REL="Next"  HREF="002884.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid will not authenticate NTLM/Kerberos when behind	a haproxy load balancer</H1>
    <B>Samuel Anderson</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20will%20not%20authenticate%20NTLM/Kerberos%20when%20behind%0A%09a%20haproxy%20load%20balancer&In-Reply-To=%3CCAP6yRXhoaUsO55OFB0eiRZe2Vj25A6xdDrev_-TpEQ2rDRDGMQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid will not authenticate NTLM/Kerberos when behind	a haproxy load balancer">sam at idsdoc.com
       </A><BR>
    <I>Fri Mar 20 01:01:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002919.html">[squid-users] WARNING: 1 swapin MD5 mismatches and BUG 3279: HTTP reply without Date:
</A></li>
        <LI>Next message (by thread): <A HREF="002884.html">[squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2882">[ date ]</a>
              <a href="thread.html#2882">[ thread ]</a>
              <a href="subject.html#2882">[ subject ]</a>
              <a href="author.html#2882">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello All,

I have 2 squid servers that authenticate correctly when you point your
browser to either of them. I'm using a negotiate_wrapper. I set it up
following this (
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory">http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory</A>
)

I would like to set both servers behind a haproxy load balancer, however
when you try to utilize the haproxy load balancer, it will not authenticate
anymore. It just gives an error asking to authenticate.

Any ideas?

Thanks in advance.



##HAPROXY.CFG##

global
log /dev/log local0
log /dev/log local1 notice
chroot /var/lib/haproxy
user haproxy
group haproxy
daemon

defaults
log global
mode http
option httplog
option dontlognull
        contimeout 5000
        clitimeout 50000
        srvtimeout 50000

# reverse proxy-squid
listen  proxy 10.10.0.254:3128
mode http
        cookie  SERVERID insert indirect nocache
        balance roundrobin
        option httpclose
        option forwardfor header X-Client
        server  squid1 10.10.0.253:3128 check inter 2000 rise 2 fall 5
        server  squid2 10.10.0.252:3128 check inter 2000 rise 2 fall 5




##SQUID.CONF##


#Kerberos and NTLM authentication
auth_param negotiate program /usr/local/bin/negotiate_wrapper --ntlm
/usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp
--domain=****.LOCAL --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d
-s GSS_C_NO_NAME
auth_param negotiate children 30
auth_param negotiate keep_alive off

# LDAP authentication
auth_param basic program /usr/lib/squid3/basic_ldap_auth -R -b
&quot;DC=****,DC=local&quot; -D &quot;CN=SQUID,OU=Service Accounts,DC=****,DC=local&quot; -w
&quot;****&quot; -f sAMAccountName=%s -h 10.0.0.200,10.0.0.199,10.0.0.194,10.0.0.193
auth_param basic children 150
auth_param basic realm Please enter your Domain credentials to continue
auth_param basic credentialsttl 1 hour

# AD group membership commands
external_acl_type ldap_group ttl=60 children-startup=10 children-max=50
children-idle=2 %LOGIN /usr/lib/squid3/ext_ldap_group_acl -R -K -S -b
&quot;DC=****,DC=local&quot; -D &quot;CN=SQUID,OU=Service Accounts,DC=****,DC=local&quot; -w
&quot;****&quot; -f &quot;(&amp;(objectclass=person)
(sAMAccountname=%v)(memberof=CN=%a,OU=PROXY,ou=ALL
 Groups,DC=****,DC=local))&quot; -h
dc1.****.local,dc2.****.local,dc3.****.local,dc4.****.local

acl auth proxy_auth REQUIRED

acl REQGROUPS external ldap_group PROXY-HIGHLY-RESTRICTIVE
PROXY-MEDIUM-RESTRICTIVE PROXY-MINIMAL-RESTRICTIVE PROXY-UNRESTRICTED
PROXY-DEV PROXY-SALES

http_access deny !auth all
http_access deny !REQGROUPS all





-- 
Samuel Anderson  |  Information Technology Administrator  |  International
Document Services

IDS  |  11629 South 700 East, Suite 200  |  Draper, UT 84020-4607

-- 
CONFIDENTIALITY NOTICE:
This e-mail and any attachments are confidential. If you are not an 
intended recipient, please contact the sender to report the error and 
delete all copies of this message from your system.  Any unauthorized 
review, use, disclosure or distribution is prohibited.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150319/6cfe6b22/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150319/6cfe6b22/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002919.html">[squid-users] WARNING: 1 swapin MD5 mismatches and BUG 3279: HTTP reply without Date:
</A></li>
	<LI>Next message (by thread): <A HREF="002884.html">[squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2882">[ date ]</a>
              <a href="thread.html#2882">[ thread ]</a>
              <a href="subject.html#2882">[ subject ]</a>
              <a href="author.html#2882">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
