<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20will%20not%20authenticate%20NTLM/Kerberos%20when%0A%20behind%20a%20haproxy%20load%20balancer&In-Reply-To=%3C1426814857.2281.23.camel%40desktop.bpk2.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002882.html">
   <LINK REL="Next"  HREF="002885.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer</H1>
    <B>Brendan Kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20will%20not%20authenticate%20NTLM/Kerberos%20when%0A%20behind%20a%20haproxy%20load%20balancer&In-Reply-To=%3C1426814857.2281.23.camel%40desktop.bpk2.com%3E"
       TITLE="[squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer">bpk678 at gmail.com
       </A><BR>
    <I>Fri Mar 20 01:27:37 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002882.html">[squid-users] Squid will not authenticate NTLM/Kerberos when behind	a haproxy load balancer
</A></li>
        <LI>Next message (by thread): <A HREF="002885.html">[squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2884">[ date ]</a>
              <a href="thread.html#2884">[ thread ]</a>
              <a href="subject.html#2884">[ subject ]</a>
              <a href="author.html#2884">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2015-03-19 at 19:01 -0600, Samuel Anderson wrote:
&gt;<i> Hello All,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have 2 squid servers that authenticate correctly when you point your
</I>&gt;<i> browser to either of them. I'm using a negotiate_wrapper. I set it up
</I>&gt;<i> following this
</I>&gt;<i> (<A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory">http://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory</A>) 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I would like to set both servers behind a haproxy load balancer,
</I>&gt;<i> however when you try to utilize the haproxy load balancer, it will not
</I>&gt;<i> authenticate anymore. It just gives an error asking to authenticate.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any ideas?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ##HAPROXY.CFG##
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> global
</I>&gt;<i> log /dev/log local0
</I>&gt;<i> log /dev/log local1 notice
</I>&gt;<i> chroot /var/lib/haproxy
</I>&gt;<i> user haproxy
</I>&gt;<i> group haproxy
</I>&gt;<i> daemon
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> defaults
</I>&gt;<i> log global
</I>&gt;<i> mode http
</I>&gt;<i> option httplog
</I>&gt;<i> option dontlognull
</I>&gt;<i>         contimeout 5000
</I>&gt;<i>         clitimeout 50000
</I>&gt;<i>         srvtimeout 50000
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # reverse proxy-squid
</I>&gt;<i> listen  proxy 10.10.0.254:3128
</I>&gt;<i> mode http
</I>&gt;<i>         cookie  SERVERID insert indirect nocache
</I>&gt;<i>         balance roundrobin
</I>&gt;<i>         option httpclose
</I>&gt;<i>         option forwardfor header X-Client
</I>&gt;<i>         server  squid1 10.10.0.253:3128 check inter 2000 rise 2 fall 5
</I>&gt;<i>         server  squid2 10.10.0.252:3128 check inter 2000 rise 2 fall 5
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ##SQUID.CONF##
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #Kerberos and NTLM authentication
</I>&gt;<i> auth_param negotiate program /usr/local/bin/negotiate_wrapper
</I>&gt;<i> --ntlm /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=****.LOCAL
</I>&gt;<i> --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d -s GSS_C_NO_NAME
</I>&gt;<i> auth_param negotiate children 30
</I>&gt;<i> auth_param negotiate keep_alive off
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # LDAP authentication
</I>&gt;<i> auth_param basic program /usr/lib/squid3/basic_ldap_auth -R -b
</I>&gt;<i> &quot;DC=****,DC=local&quot; -D &quot;CN=SQUID,OU=Service Accounts,DC=****,DC=local&quot;
</I>&gt;<i> -w &quot;****&quot; -f sAMAccountName=%s -h
</I>&gt;<i> 10.0.0.200,10.0.0.199,10.0.0.194,10.0.0.193
</I>&gt;<i> auth_param basic children 150
</I>&gt;<i> auth_param basic realm Please enter your Domain credentials to
</I>&gt;<i> continue
</I>&gt;<i> auth_param basic credentialsttl 1 hour
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # AD group membership commands
</I>&gt;<i> external_acl_type ldap_group ttl=60 children-startup=10
</I>&gt;<i> children-max=50 children-idle=2 %
</I>&gt;<i> LOGIN /usr/lib/squid3/ext_ldap_group_acl -R -K -S -b
</I>&gt;<i> &quot;DC=****,DC=local&quot; -D &quot;CN=SQUID,OU=Service Accounts,DC=****,DC=local&quot;
</I>&gt;<i> -w &quot;****&quot; -f &quot;(&amp;(objectclass=person) (sAMAccountname=%v)(memberof=CN=%
</I>&gt;<i> a,OU=PROXY,ou=ALL  Groups,DC=****,DC=local))&quot; -h
</I>&gt;<i> dc1.****.local,dc2.****.local,dc3.****.local,dc4.****.local
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl REQGROUPS external ldap_group PROXY-HIGHLY-RESTRICTIVE
</I>&gt;<i> PROXY-MEDIUM-RESTRICTIVE PROXY-MINIMAL-RESTRICTIVE PROXY-UNRESTRICTED
</I>&gt;<i> PROXY-DEV PROXY-SALES
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access deny !auth all
</I>&gt;<i> http_access deny !REQGROUPS all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Samuel Anderson  |  Information Technology Administrator  |
</I>&gt;<i>  International Document Services
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> IDS  |  11629 South 700 East, Suite 200  |  Draper, UT 84020-4607
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> CONFIDENTIALITY NOTICE:
</I>&gt;<i> This e-mail and any attachments are confidential. If you are not an
</I>&gt;<i> intended recipient, please contact the sender to report the error and
</I>&gt;<i> delete all copies of this message from your system.  Any unauthorized
</I>&gt;<i> review, use, disclosure or distribution is prohibited.
</I>
how did you create and distribute the keytab for the proxies?  you must
create one keytab and put the same exact one on each of the proxies.
the KVNO numbers must match on every proxy.  run &quot;klist
-Kket /path/to/the.keytab&quot; on the proxies to check.

kerberos is heavily dependent on DNS.  the keytab should contain
PRIMARY/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">instance.domain.tld at REALM</A> where PRIMARY is HTTP,
instance.domain.tld is the FQDN of the 10.10.0.254 IP, not either or
both of the individual proxies, and REALM should be the Kerberos REALM.

did you export the environment variable for the keytab?  on fedora, i
put the following in /etc/sysconfig/squid:

KRB5_KTNAME=/etc/squid/squid.keytab
export KRB5_KTNAME

do you get a HTTP ticket from the directory?  from a command prompt,
what does &quot;klist tickets&quot; show?  you can also install the XP resource
kit and run kerbtray.exe to get that info.  win7 and newer may have it
built in.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002882.html">[squid-users] Squid will not authenticate NTLM/Kerberos when behind	a haproxy load balancer
</A></li>
	<LI>Next message (by thread): <A HREF="002885.html">[squid-users] Squid will not authenticate NTLM/Kerberos when behind a haproxy load balancer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2884">[ date ]</a>
              <a href="thread.html#2884">[ thread ]</a>
              <a href="subject.html#2884">[ subject ]</a>
              <a href="author.html#2884">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
