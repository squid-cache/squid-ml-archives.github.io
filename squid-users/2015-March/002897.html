<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.2 will only start if cache directory is empty
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.2%20will%20only%20start%20if%20cache%20directory%20is%0A%20empty&In-Reply-To=%3C550BB75F.5070104%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002862.html">
   <LINK REL="Next"  HREF="002864.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.2 will only start if cache directory is empty</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.2%20will%20only%20start%20if%20cache%20directory%20is%0A%20empty&In-Reply-To=%3C550BB75F.5070104%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.2 will only start if cache directory is empty">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 20 05:59:59 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002862.html">[squid-users] Squid 3.5.2 will only start if cache directory is empty
</A></li>
        <LI>Next message (by thread): <A HREF="002864.html">[squid-users] Server-first SSL bump in Squid 3.5.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2897">[ date ]</a>
              <a href="thread.html#2897">[ thread ]</a>
              <a href="subject.html#2897">[ subject ]</a>
              <a href="author.html#2897">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/03/2015 3:26 a.m., Stanford Prescott wrote:
&gt;<i> On Thu, Mar 19, 2015 at 12:11 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> On 19/03/2015 11:29 a.m., Stanford Prescott wrote:
</I>&gt;&gt;&gt;<i> I posted this message to the list a few days ago but haven't received any
</I>&gt;&gt;&gt;<i> responses yet. I am hoping someone might be able to provide some insight
</I>&gt;&gt;<i> on
</I>&gt;&gt;&gt;<i> what is going on.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have been trying to get Squid 3.5.2 to work with the Smoothwall Express
</I>&gt;&gt;&gt;<i> 3.1 Linux firewall distribution. Specifically, I have modified the Squid
</I>&gt;&gt;&gt;<i> version included with Smoothwall Express 3.1 to enable HTTPS caching. I
</I>&gt;&gt;&gt;<i> have had this working successfully up to Squid version 3.4.10. Now with
</I>&gt;&gt;&gt;<i> trying to upgrade to Squid 3.5.2 I am having problems that I didn't
</I>&gt;&gt;&gt;<i> encounter with prior versions of Squid.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The first issue I had, which is now resolved, was improper permissions of
</I>&gt;&gt;&gt;<i> the shm folder (in SWE found in /dev/shm). Changing the folder
</I>&gt;&gt;<i> permissions
</I>&gt;&gt;&gt;<i> to Squid user and group allowed Squid 3.5.2 to start. However, now it
</I>&gt;&gt;<i> will
</I>&gt;&gt;&gt;<i> only start with an empty cache directory.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ouch. /dev/shm is a folder for system shared-memory sockets to be
</I>&gt;&gt;<i> created by applications. It should be owned by root user and group, with
</I>&gt;&gt;<i> 777 permissions. Squid (or the OS kernel) should be able to create
</I>&gt;&gt;<i> &quot;files&quot; inside it, but it should not be owned by Squid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> When I encountered the &quot;Permission denied&quot; errors for shm_open it was
</I>&gt;<i> suggested by another user that I try changing /dev/shm to squid:root and
</I>&gt;<i> 775. When I made that change the permission denied error went away. I will
</I>&gt;<i> try your suggestion to go back to root:root and permissions of 777.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Once it starts with an empty
</I>&gt;&gt;&gt;<i> cache directory, it seems to function correctly as far as caching SSL
</I>&gt;&gt;&gt;<i> encrypted web pages. However, if Squid needs to be restarted for any
</I>&gt;&gt;&gt;<i> reason, it will not restart until the cache directory
</I>&gt;&gt;&gt;<i> (/var/spool/squid/cache) is emptied.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That HTTP data cache is unrelated to the SSL session cache. Its contents
</I>&gt;&gt;<i> should not matter.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> That's what I thought as well but still, squid will only start if I first
</I>&gt;<i> empty that cache directory. Perhaps the patch you suggest below will fix
</I>&gt;<i> this.
</I>
Maybe that is a separate side effect of the fast shutdown and crashing
issues. Please try just erasing the swap.state for the cache if it
happens again.


&gt;<i> 
</I>&gt;&gt;&gt;<i> *2015/03/14 00:29:47 kid1| helperOpenServers: Starting 5/5 'ssl_crtd'
</I>&gt;&gt;&gt;<i> processes*
</I>&gt;&gt;&gt;<i> *FATAL: Ipc::Mem::Segment::open failed to
</I>&gt;&gt;&gt;<i> shm_open(/squid-ssl_session_cache.shm): (2) No such file or directory*
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What is the &quot;squid-ssl_session_cache&quot;. Am I supposed to define that
</I>&gt;&gt;&gt;<i> somewhere in the
</I>&gt;&gt;&gt;<i> Squid configuration? Is that why I am getting that error message because
</I>&gt;&gt;<i> an
</I>&gt;&gt;&gt;<i> ssl_session_cache is not defined somewhere?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The .shm is the name of a shared memory socket &quot;file&quot; name. You have
</I>&gt;&gt;<i> sslproxy_session_cache_size defined with a size so the SSL session
</I>&gt;&gt;<i> ticket cache is used.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please try patching your Squid with
</I>&gt;&gt;<i> &lt;<A HREF="http://www.squid-cache.org/Versions/v4/changesets/squid-4-13984.patch">http://www.squid-cache.org/Versions/v4/changesets/squid-4-13984.patch</A>&gt;.
</I>&gt;&gt;<i> It should resolve many permissions issues Squid 3.5 workers are having
</I>&gt;&gt;<i> on startup.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will try that.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This is my squid.conf file with SSL caching using ssl-bump enabled.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *# A random port for forward-proxy port needed for SSL*
</I>&gt;&gt;&gt;<i> *http_port 8081*
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *http_port 192.168.100.1:800 &lt;<A HREF="http://192.168.100.1:800/">http://192.168.100.1:800/</A>&gt; intercept
</I>&gt;&gt;<i> ssl-bump
</I>&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;<i> cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem*
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *https_port 192.168.100.1:808 &lt;<A HREF="http://192.168.100.1:808/">http://192.168.100.1:808/</A>&gt; intercept
</I>&gt;&gt;&gt;<i> ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;<i> cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why two ports? one is usually sufficient.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Without the &quot;http_port 8081&quot; (or any other random port, it seemed) I would
</I>&gt;<i> get &quot;no forward-proxy port&quot; errors when trying to start squid with SSL
</I>&gt;<i> proxying enabled.
</I>&gt;<i> 
</I>
Ah sorry. I see my mailers fancy markup bold+italics blinded me to the
missing 's' on the first intercept port. That config was fine (and correct).

&gt;<i> 
</I>&gt;&gt;<i> These were &quot;carry-overs&quot; from the original squid.conf used by earlier
</I>&gt;&gt;<i> versions of Smoothwall. I will remove them.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *request_header_access Content-Type allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Date allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Host allow all*
</I>&gt;&gt;&gt;<i> *request_header_access If-Modified-Since allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Pragma allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Accept allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Accept-Charset allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Accept-Encoding allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Accept-Language allow all*
</I>&gt;&gt;&gt;<i> *request_header_access Connection allow all*
</I>&gt;&gt;&gt;<i> *request_header_access All allow all*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The above settings do nothing but waste CPU time. You can remove them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What you are instructing Squid to do is effectively &quot;allow certain
</I>&gt;&gt;<i> headers X, Y, Z, oh and every other header too&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> These options were suggested to me by a user who wished to be able to put
</I>&gt;<i> Squid in &quot;stealth mode&quot; meaning, for sites that won't accept connections
</I>&gt;<i> from a proxy to mask squid's headers with proxy settings to appear to the
</I>&gt;<i> sites as a non-proxied connection. When the user has a site that requires
</I>&gt;<i> this, the website url is placed as an acl before that block. Should I not
</I>&gt;<i> have those lines unless there is a website that requires them?
</I>&gt;<i> 
</I>
Thought so, its not doing what you were told it does. Replace that &quot;All&quot;
entry - which allows every header through explicitly, with:
   request_header_access Other deny all


But there are some more critical HTTP/1.1 headers you will also need to
add allows for to get traffic working properly:
  TE, Transfer-Encoding, Expect, Authorization, Proxy-Authorization,
If-Not-Modified, If-Unmodified-Since, If-Match, If-None-Match, ETag,
Via, Range, If-Range, Content-Encoding, Content-Disposition,

You can remove the Accept, Accept-Language, Accept-Charset headers. They
are optional and often used in browser footprinting.

The Pragma header can also probably go, its only used in requests by
some very old non-HTTP/1.1 software in place of the
Cache-Control:no-cache feature.


&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *shutdown_lifetime 3 seconds*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NOTE: very short shutdown time can corrupt the HTTP data cache as the
</I>&gt;&gt;<i> memory index does not have enough time to complete saving to disk.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Another carry-over from earlier versions of Squid. What would be a more
</I>&gt;<i> reasonable time frame for shutdown_lifetime?
</I>
We publish Squid with a default of 30sec. Altering from that depends on
how long the client connections tend to be through the proxy. I believe
these days you need it to be long enough to fully download a 1MB object.

Squid starts rejecting new requests as soon as shutdown is required,
then for the shutdown lifetime TTL its just waiting for the existing
transactions to complete. Most clients tend to finish any given download
within 20-30 seconds.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002862.html">[squid-users] Squid 3.5.2 will only start if cache directory is empty
</A></li>
	<LI>Next message (by thread): <A HREF="002864.html">[squid-users] Server-first SSL bump in Squid 3.5.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2897">[ date ]</a>
              <a href="thread.html#2897">[ thread ]</a>
              <a href="subject.html#2897">[ subject ]</a>
              <a href="author.html#2897">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
