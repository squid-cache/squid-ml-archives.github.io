<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] load balancing and site failover
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20load%20balancing%20and%20site%20failover&In-Reply-To=%3C55121755.8010905%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002931.html">
   <LINK REL="Next"  HREF="002951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] load balancing and site failover</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20load%20balancing%20and%20site%20failover&In-Reply-To=%3C55121755.8010905%40treenet.co.nz%3E"
       TITLE="[squid-users] load balancing and site failover">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar 25 02:03:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002931.html">[squid-users] load balancing and site failover
</A></li>
        <LI>Next message (by thread): <A HREF="002951.html">[squid-users] load balancing and site failover
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2942">[ date ]</a>
              <a href="thread.html#2942">[ thread ]</a>
              <a href="subject.html#2942">[ subject ]</a>
              <a href="author.html#2942">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/03/2015 9:55 a.m., brendan kearney wrote:
&gt;<i> Was not sure if bugzilla was used for mailing list issues.  If you would
</I>&gt;<i> like me to open one, I will but it looks like the list is working again.
</I>
Bugzilla is used, list bugs under the &quot;project services&quot; product.


As for your query...

&gt;<i> On Mar 24, 2015 2:25 PM, &quot;Brendan Kearney&quot; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On Tue, 2015-03-24 at 10:18 -0400, Brendan Kearney wrote:
</I>&gt;&gt;&gt;<i> while load balancing is not a requirement in a proxy environment, it
</I>&gt;&gt;&gt;<i> does afford a great deal of functionality, scaling and fault tolerance
</I>&gt;&gt;&gt;<i> in one.  several if not many on this list probably employ them for their
</I>&gt;&gt;&gt;<i> proxies and likely other technologies, but they are not all created
</I>&gt;&gt;&gt;<i> equal.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> i recently looked to see if a specific feature was in HAProxy.  i was
</I>&gt;&gt;&gt;<i> looking to see if HAProxy could reply to a new connection with a RST
</I>&gt;&gt;&gt;<i> packet if no pool member was available.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> the idea behind this is, if all of the proxies are not passing the
</I>&gt;&gt;&gt;<i> service check and are marked down by the load balancer, the reply of a
</I>&gt;&gt;&gt;<i> RST in the TCP handshake (i.e. SYN -&gt; RST, not SYN -&gt; SYN/ACK -&gt; ACK)
</I>&gt;&gt;&gt;<i> tells the browser to failover to the next proxy assigned by the PAC
</I>&gt;&gt;&gt;<i> file.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> where i work, we have this configuration working.  the load balancers
</I>&gt;&gt;&gt;<i> are configured with the option to send a reset when no proxy is
</I>&gt;&gt;&gt;<i> available in the pool.  the PAC file assigns all 4 of the proxy VIPs in
</I>&gt;&gt;&gt;<i> a specific order based on which proxy VIP is assigned as the primary.
</I>&gt;&gt;&gt;<i> In every case, if the primary VIP does not have an available pool
</I>&gt;&gt;&gt;<i> member, the browser fails over to the next in the list.  failover would
</I>&gt;&gt;&gt;<i> happen again, if the secondary VIP replies with a RST during the
</I>&gt;&gt;&gt;<i> connection establishing.  the process repeats until a TCP connection
</I>&gt;&gt;&gt;<i> establishes or all proxies assigned have been exhausted.  the browser
</I>&gt;&gt;&gt;<i> will use the proxy VIP that it successfully connects to, for the
</I>&gt;&gt;&gt;<i> duration of the session.  once the browser is closed and reopened, the
</I>&gt;&gt;&gt;<i> evaluation of the PAC file occurs again, and the process starts anew.
</I>&gt;&gt;&gt;<i> plug-ins such as Proxy Selector are the exception to this, and can be
</I>&gt;&gt;&gt;<i> used to reevaluate a PAC file by selecting it for use.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> we have used this configuration several times, when we found an ISP link
</I>&gt;&gt;&gt;<i> was flapping or some other issue more global in nature than just the
</I>&gt;&gt;&gt;<i> proxies was affecting our egress and internet access.  i can attest to
</I>&gt;&gt;&gt;<i> the solution as working and elegantly handling site wide failures.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> being that the solutions where i work are proprietary commercial
</I>&gt;&gt;&gt;<i> products, i wanted to find an open source product that does this.  i
</I>&gt;&gt;&gt;<i> have been a long time user of HAProxy, and have recommended it for
</I>&gt;&gt;&gt;<i> others here, but sadly they cannot perform this function.  per their
</I>&gt;&gt;&gt;<i> mailing list, they use the network stack of the OS for connection
</I>&gt;&gt;&gt;<i> establishment and cannot cause a RST to be sent to the client during a
</I>&gt;&gt;&gt;<i> TCP handshake if no pool member is available.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> they suggested an external helper that manipulates IPTables rules based
</I>&gt;&gt;&gt;<i> on a pool member being available.  they do not feel that a feature like
</I>&gt;&gt;&gt;<i> this belongs in a layer 4/7 reverse proxy application.
</I>
They are right. HTTP != TCP.

In particular TCP depends on routers having a full routing map of the
entire Internet (provided by BGP) and deciding the best upstream hop
based on that global info. Clients have one (and only one) upstream
router for each server they want to connect to.

In HTTP each proxy (aka router) performs independent upstream connection
attempts, failover, and verifies it worked before responding to the
client with a final response. Each proxy only has enough detail to check
its upstream(s). Each proxy can connect to any server (subject to ACLs).


&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> my search for a load balancer solution went through ipvsadm, balance and
</I>&gt;&gt;&gt;<i> haproxy before i selected haproxy.  haproxy was more feature rich than
</I>&gt;&gt;&gt;<i> balance, and easier to implement than ipvsadm.  do any other list
</I>&gt;&gt;&gt;<i> members have a need for such a feature from their load balancers?  do
</I>&gt;&gt;&gt;<i> any other list members have site failover solutions that have been
</I>&gt;&gt;&gt;<i> tested or used and would consider sharing their design and/or pain
</I>&gt;&gt;&gt;<i> points?  i am not looking for secret sauce or confidential info, but
</I>&gt;&gt;&gt;<i> more high level architecture decisions and such.
</I>

I havent tested it but this should do what you are asking:

 acl err http_status 500-505 408
 deny_info TCP_RESET err
 http_reply_access deny err

It replaces the response from Squid with a TCP RST packet.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002931.html">[squid-users] load balancing and site failover
</A></li>
	<LI>Next message (by thread): <A HREF="002951.html">[squid-users] load balancing and site failover
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2942">[ date ]</a>
              <a href="thread.html#2942">[ thread ]</a>
              <a href="subject.html#2942">[ subject ]</a>
              <a href="author.html#2942">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
