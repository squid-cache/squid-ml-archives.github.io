<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] load balancing and site failover
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20load%20balancing%20and%20site%20failover&In-Reply-To=%3C1427318767.24562.31.camel%40desktop.bpk2.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002942.html">
   <LINK REL="Next"  HREF="002955.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] load balancing and site failover</H1>
    <B>Brendan Kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20load%20balancing%20and%20site%20failover&In-Reply-To=%3C1427318767.24562.31.camel%40desktop.bpk2.com%3E"
       TITLE="[squid-users] load balancing and site failover">bpk678 at gmail.com
       </A><BR>
    <I>Wed Mar 25 21:26:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002942.html">[squid-users] load balancing and site failover
</A></li>
        <LI>Next message (by thread): <A HREF="002955.html">[squid-users] load balancing and site failover
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2951">[ date ]</a>
              <a href="thread.html#2951">[ thread ]</a>
              <a href="subject.html#2951">[ subject ]</a>
              <a href="author.html#2951">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 2015-03-25 at 15:03 +1300, Amos Jeffries wrote:
&gt;<i> On 25/03/2015 9:55 a.m., brendan kearney wrote:
</I>&gt;<i> &gt; Was not sure if bugzilla was used for mailing list issues.  If you would
</I>&gt;<i> &gt; like me to open one, I will but it looks like the list is working again.
</I>&gt;<i> 
</I>&gt;<i> Bugzilla is used, list bugs under the &quot;project services&quot; product.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> As for your query...
</I>&gt;<i> 
</I>&gt;<i> &gt; On Mar 24, 2015 2:25 PM, &quot;Brendan Kearney&quot; wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; On Tue, 2015-03-24 at 10:18 -0400, Brendan Kearney wrote:
</I>&gt;<i> &gt;&gt;&gt; while load balancing is not a requirement in a proxy environment, it
</I>&gt;<i> &gt;&gt;&gt; does afford a great deal of functionality, scaling and fault tolerance
</I>&gt;<i> &gt;&gt;&gt; in one.  several if not many on this list probably employ them for their
</I>&gt;<i> &gt;&gt;&gt; proxies and likely other technologies, but they are not all created
</I>&gt;<i> &gt;&gt;&gt; equal.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; i recently looked to see if a specific feature was in HAProxy.  i was
</I>&gt;<i> &gt;&gt;&gt; looking to see if HAProxy could reply to a new connection with a RST
</I>&gt;<i> &gt;&gt;&gt; packet if no pool member was available.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; the idea behind this is, if all of the proxies are not passing the
</I>&gt;<i> &gt;&gt;&gt; service check and are marked down by the load balancer, the reply of a
</I>&gt;<i> &gt;&gt;&gt; RST in the TCP handshake (i.e. SYN -&gt; RST, not SYN -&gt; SYN/ACK -&gt; ACK)
</I>&gt;<i> &gt;&gt;&gt; tells the browser to failover to the next proxy assigned by the PAC
</I>&gt;<i> &gt;&gt;&gt; file.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; where i work, we have this configuration working.  the load balancers
</I>&gt;<i> &gt;&gt;&gt; are configured with the option to send a reset when no proxy is
</I>&gt;<i> &gt;&gt;&gt; available in the pool.  the PAC file assigns all 4 of the proxy VIPs in
</I>&gt;<i> &gt;&gt;&gt; a specific order based on which proxy VIP is assigned as the primary.
</I>&gt;<i> &gt;&gt;&gt; In every case, if the primary VIP does not have an available pool
</I>&gt;<i> &gt;&gt;&gt; member, the browser fails over to the next in the list.  failover would
</I>&gt;<i> &gt;&gt;&gt; happen again, if the secondary VIP replies with a RST during the
</I>&gt;<i> &gt;&gt;&gt; connection establishing.  the process repeats until a TCP connection
</I>&gt;<i> &gt;&gt;&gt; establishes or all proxies assigned have been exhausted.  the browser
</I>&gt;<i> &gt;&gt;&gt; will use the proxy VIP that it successfully connects to, for the
</I>&gt;<i> &gt;&gt;&gt; duration of the session.  once the browser is closed and reopened, the
</I>&gt;<i> &gt;&gt;&gt; evaluation of the PAC file occurs again, and the process starts anew.
</I>&gt;<i> &gt;&gt;&gt; plug-ins such as Proxy Selector are the exception to this, and can be
</I>&gt;<i> &gt;&gt;&gt; used to reevaluate a PAC file by selecting it for use.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; we have used this configuration several times, when we found an ISP link
</I>&gt;<i> &gt;&gt;&gt; was flapping or some other issue more global in nature than just the
</I>&gt;<i> &gt;&gt;&gt; proxies was affecting our egress and internet access.  i can attest to
</I>&gt;<i> &gt;&gt;&gt; the solution as working and elegantly handling site wide failures.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; being that the solutions where i work are proprietary commercial
</I>&gt;<i> &gt;&gt;&gt; products, i wanted to find an open source product that does this.  i
</I>&gt;<i> &gt;&gt;&gt; have been a long time user of HAProxy, and have recommended it for
</I>&gt;<i> &gt;&gt;&gt; others here, but sadly they cannot perform this function.  per their
</I>&gt;<i> &gt;&gt;&gt; mailing list, they use the network stack of the OS for connection
</I>&gt;<i> &gt;&gt;&gt; establishment and cannot cause a RST to be sent to the client during a
</I>&gt;<i> &gt;&gt;&gt; TCP handshake if no pool member is available.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; they suggested an external helper that manipulates IPTables rules based
</I>&gt;<i> &gt;&gt;&gt; on a pool member being available.  they do not feel that a feature like
</I>&gt;<i> &gt;&gt;&gt; this belongs in a layer 4/7 reverse proxy application.
</I>&gt;<i> 
</I>&gt;<i> They are right. HTTP != TCP.
</I>i didnt confuse that detail.  it was unknown to me that HAProxy could
not tie layer 7 status to layer 3/4 actions.  the decisions they made
and how they architected the app is why they cannot do this, not that it
is technically impossible to do it.  i may be spoiled because i work
with equipment that can do this for me.
&gt;<i> 
</I>&gt;<i> In particular TCP depends on routers having a full routing map of the
</I>&gt;<i> entire Internet (provided by BGP) and deciding the best upstream hop
</I>&gt;<i> based on that global info. Clients have one (and only one) upstream
</I>&gt;<i> router for each server they want to connect to.
</I>i will contest this.  my router does not need a full BGP map to route
traffic locally on my LAN or remotely out its WAN interface.  hell, it
does not even run BGP, and i can still get to the intarwebs, no problem.
it too, only has one upstream router / default route.
&gt;<i> 
</I>&gt;<i> In HTTP each proxy (aka router) performs independent upstream connection
</I>&gt;<i> attempts, failover, and verifies it worked before responding to the
</I>&gt;<i> client with a final response. Each proxy only has enough detail to check
</I>&gt;<i> its upstream(s). Each proxy can connect to any server (subject to ACLs).
</I>how are you comparing a HTTP proxy (a layer 7 application) to a router
(a layer 3 device)?  routers route traffic and proxies proxy traffic.
very different functions.  routers dont look past a certain point in the
headers in order to make decisions on where to send the traffic.
proxies look all the way to the end of the headers and sometimes into
the payload, too.  proxies are more akin to a protocol specific
firewall.  proxies also dont send the incoming traffic out an interface.
they terminate the client session, and initiate a new session on behalf
of the client.  simply because the proxy can elect how to send a request
it is making on behalf of a client, does not make a proxy a router.  the
fact that one connection is terminated and a new one is initiated rules
out a proxy from being any kind of router, in my opinion.  even with SSL
or the CONNECT Method, the connection is still made by the proxy to the
remote server.  the client never makes a connection to the remote
server, therefore the traffic was not routed.  it was proxied.
&gt;<i> 
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; my search for a load balancer solution went through ipvsadm, balance and
</I>&gt;<i> &gt;&gt;&gt; haproxy before i selected haproxy.  haproxy was more feature rich than
</I>&gt;<i> &gt;&gt;&gt; balance, and easier to implement than ipvsadm.  do any other list
</I>&gt;<i> &gt;&gt;&gt; members have a need for such a feature from their load balancers?  do
</I>&gt;<i> &gt;&gt;&gt; any other list members have site failover solutions that have been
</I>&gt;<i> &gt;&gt;&gt; tested or used and would consider sharing their design and/or pain
</I>&gt;<i> &gt;&gt;&gt; points?  i am not looking for secret sauce or confidential info, but
</I>&gt;<i> &gt;&gt;&gt; more high level architecture decisions and such.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I havent tested it but this should do what you are asking:
</I>&gt;<i> 
</I>&gt;<i>  acl err http_status 500-505 408
</I>&gt;<i>  deny_info TCP_RESET err
</I>&gt;<i>  http_reply_access deny err
</I>&gt;<i> 
</I>&gt;<i> It replaces the response from Squid with a TCP RST packet.
</I>this is useful in the case that the proxy is alive and well, but cannot
get to the internet.  in my example, the ISP issue would seem to be
covered, though i am not sure how the actual implementation would go.
the client has a TCP session established with the load balancer, which
gets the full SYN -&gt; SYN/ACK -&gt; ACK treatement.  the load balancer would
get the SYN -&gt; RST from the proxy, and presumably sends the RST back to
the client.  While this does seem to hold up logically, the
implementation may have nuances that have to be dealt with.  Does the
RST in the middle of an established TCP session cause the browser to
failover to the next proxy assigned?  i would have to test that out.

now, what about the case where the proxies are not alive and well behind
the load balancer, and they are not able to reply with a RST?  This is
the scenario that i would want the load balancer to be able to manage.
this is where tying a layer 7 status to a layer 3/4 action on the load
balancer becomes relevant.  then, the ability for the load balancer to
do this negates the need to manage this in the proxy layer, and removes
any nuances that may be encountered with the implementation.
&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002942.html">[squid-users] load balancing and site failover
</A></li>
	<LI>Next message (by thread): <A HREF="002955.html">[squid-users] load balancing and site failover
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2951">[ date ]</a>
              <a href="thread.html#2951">[ thread ]</a>
              <a href="subject.html#2951">[ subject ]</a>
              <a href="author.html#2951">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
