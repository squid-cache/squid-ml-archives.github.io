<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump for specific dstdomain
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20for%20specific%20dstdomain&In-Reply-To=%3CCAOsHgtsG76%2BidOJWOQE%2BAfpStNePOgThRGyQfv-S5ptT2NbsJQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002752.html">
   <LINK REL="Next"  HREF="002743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump for specific dstdomain</H1>
    <B>Daniel Greenwald</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20for%20specific%20dstdomain&In-Reply-To=%3CCAOsHgtsG76%2BidOJWOQE%2BAfpStNePOgThRGyQfv-S5ptT2NbsJQ%40mail.gmail.com%3E"
       TITLE="[squid-users] ssl_bump for specific dstdomain">dig at digcorp.net
       </A><BR>
    <I>Fri Mar 27 15:34:00 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002752.html">[squid-users] ssl_bump for specific dstdomain
</A></li>
        <LI>Next message (by thread): <A HREF="002743.html">[squid-users] Reverse Proxy Funny Logging Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2962">[ date ]</a>
              <a href="thread.html#2962">[ thread ]</a>
              <a href="subject.html#2962">[ subject ]</a>
              <a href="author.html#2962">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>here is a python helper I wrote with help of previous posts. It takes
sni info from squid and returns OK if the domain is in
/etc/squid/domains_nobump.acl (I am not a coder..) Problem is it works
good for intercepted browser traffic but doesn't work when a user
tries to use an app on an eg android device. In my cache.log I get:
 error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca

It seems Squid doesn't send SNI info before the error shows up in
cache.log and the app barfs. I'm guessing the app is detecting the
SSLBump before squid is able to grab the SNI. Does this makes sense?
Any ideas to move this forward?


#!/usr/bin/python
import sys
import string
lines = [line.strip() for line in open('/etc/squid/domains_nobump.acl')]

while True:
    req = sys.stdin.readline()
    req = req.strip()
    if not req:
        break

    try:
        id, sni = req.split()
        sys.stderr.write('request %r\n' % req)
        sys.stderr.flush()
        for line in lines:
            if line.startswith('.'):
                if string.find(sni,line,len(sni)-len(line)) != -1 or
sni == line.lstrip('.'):  # bypass
                    sys.stdout.write('{} OK\n'.format(id))
                    sys.stdout.flush()
                    break
            else:
                if sni == line:
                    sys.stdout.write('{} OK\n'.format(id))
                    sys.stdout.flush()
                    break

        else:
            sys.stdout.write('{} ERR\n'.format(id))
            sys.stdout.flush()
    except:
        sys.stderr.write('SNICHECK INPUT: %r\n' % req)


squid.conf:

external_acl_type sni ttl=30 concurrency=60 children-max=3
children-startup=1 %ssl::&gt;sni /usr/lib64/squid/snicheck.py
acl sni_nobump external sni
ssl_bump splice sni_nobump
ssl_bump peek step1 all
ssl_bump bump step2 all
-----------
Daniel I Greenwald




On Fri, Mar 13, 2015 at 5:04 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 13/03/2015 6:39 p.m., Yuri Voinov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 13.03.15 2:37, Mukul Gandhi &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;<i> On Thu, Mar 12, 2015 at 11:04 AM, Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt;
</I>&gt;&gt;&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> You only have external helper (which is must wrote yourself) in
</I>&gt;&gt;&gt;<i> 3.4.x.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Are there any examples that I can look at to implemented this
</I>&gt;&gt;&gt;&gt;<i> external helper for doing selective ssl_bumps. And what would
</I>&gt;&gt;&gt;&gt;<i> this helper script do anyways? All we have is the destination IP
</I>&gt;&gt;&gt;&gt;<i> address which is not really going to give us the actual HTTP
</I>&gt;&gt;&gt;&gt;<i> hostname.
</I>&gt;&gt;<i> Yes and no. There is one third-party helper in list archives, written
</I>&gt;&gt;<i> on python. No one of this including in squid distribution.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Works with domains in ssl bump fully available at least 3.5.x
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Does the 3.5.x implementation decrypt the whole payload and then
</I>&gt;&gt;&gt;&gt;<i> do the ssl_bump? The &quot;peek&quot; option seems to imply that only the
</I>&gt;&gt;&gt;&gt;<i> HTTP headers are peeked at.
</I>&gt;&gt;<i> Of course. As by 3.4.x. The difference is only with mechanisms.
</I>&gt;<i>
</I>&gt;<i> And no at the same time. HTTP message headers inside the encryption are
</I>&gt;<i> encrypted and unavailable until after the decryption is decided (bumped).
</I>&gt;<i>
</I>&gt;<i> What gets peeked at is the TLS ClientHello and TLS ServerHello details.
</I>&gt;<i> SNI may become available by peeking when raw-IP was all that was in the
</I>&gt;<i> HTTP CONNECT message or intercepted TCP packets.
</I>&gt;<i>
</I>&gt;<i> You can then use those non-private TLS details to decide between reject,
</I>&gt;<i> splice (pass-thru) or bump (decrypt) for the encrypted HTTPS data.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I guess what I am asking is, is there any way we can do this
</I>&gt;&gt;&gt;&gt;<i> without actually decrypting the payload?
</I>&gt;&gt;<i> 3.5.x peek-and-splise functionality do bump splitted by stages.
</I>&gt;&gt;<i> Against 3.4.x, which is makes bump in one stage.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002752.html">[squid-users] ssl_bump for specific dstdomain
</A></li>
	<LI>Next message (by thread): <A HREF="002743.html">[squid-users] Reverse Proxy Funny Logging Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2962">[ date ]</a>
              <a href="thread.html#2962">[ thread ]</a>
              <a href="subject.html#2962">[ subject ]</a>
              <a href="author.html#2962">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
