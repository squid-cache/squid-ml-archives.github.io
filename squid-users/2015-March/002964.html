<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid behaviour with external_acl_type
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20behaviour%20with%20external_acl_type&In-Reply-To=%3C55192110.1080803%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002963.html">
   <LINK REL="Next"  HREF="002970.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid behaviour with external_acl_type</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20behaviour%20with%20external_acl_type&In-Reply-To=%3C55192110.1080803%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid behaviour with external_acl_type">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Mar 30 10:10:24 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="002963.html">[squid-users] Squid behaviour with external_acl_type
</A></li>
        <LI>Next message (by thread): <A HREF="002970.html">[squid-users] Squid 3.5.2 ssl_crtd kids causing abnormal	termination of startup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2964">[ date ]</a>
              <a href="thread.html#2964">[ thread ]</a>
              <a href="subject.html#2964">[ subject ]</a>
              <a href="author.html#2964">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/03/2015 4:55 a.m., Ashish Patil wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I am faced with a weird situation with an external acl that I have built.
</I>&gt;<i> 
</I>&gt;<i> The external acl gets the acl name and the IP information, does a lookup in
</I>&gt;<i> a MySQL table if that IP belongs to a group ( read: acl name ) and returns
</I>&gt;<i> an output.
</I>&gt;<i> 
</I>&gt;<i> The situation is as follows:
</I>&gt;<i>  On the first client request coming to the external helper, it performs as
</I>&gt;<i> expected, and the correct action is taken. Whereas from the second request
</I>&gt;<i> onwards, Squid just waits on the external acl, even though a response was
</I>&gt;<i> sent by the acl, and the same was received by Squid.
</I>&gt;<i> 
</I>&gt;<i> My acl's are as follows:
</I>&gt;<i> external_acl_type grpname ttl=10 children-startup=1 concurrency=1 %SRC %ACL
</I>&gt;<i> /usr/local/squid/libexec/grpname_helper
</I>&gt;<i> acl two external grpname
</I>&gt;<i> acl twoext urlpath_regex
</I>&gt;<i> &quot;/usr/local/squid/etc/custom/blacklisted-two-extensions&quot;
</I>&gt;<i> deny_info <A HREF="http://192.168.3.11/error.html">http://192.168.3.11/error.html</A> two
</I>&gt;<i> http_access deny twoext two
</I>&gt;<i> 
</I>
&gt;<i> 
</I>&gt;<i> To verify Squid was getting the responses from the external acl, I ran a
</I>&gt;<i> strace on the squid process. Below is the trimmed output:
</I>&gt;<i> 
</I>
&gt;<i> write(19, &quot;0 192.168.3.243 two\n&quot;, 20)  = 20
</I>&gt;<i> read(19, &quot;OK\n\0&quot;, 4095)                = 4
</I>

Problem #1:
 Squid is using concurrency channels. The helper is not sending the
channel-ID field in the reply. Try setting concurrency=0 on squid.conf
to fix that - or better, update the helper to use concurrency properly.


Problem #2:
 The helper is sending a '\0' octet after the \n.
 The \n delimits the first and second response. So the \0 is left in the
buffer until the seond response is being handled.

When the second lookup happens its response is &quot;\0OK&quot; not the &quot;OK&quot; you
were expecting. Same thing also happens with all following lookups on
this helper.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="002963.html">[squid-users] Squid behaviour with external_acl_type
</A></li>
	<LI>Next message (by thread): <A HREF="002970.html">[squid-users] Squid 3.5.2 ssl_crtd kids causing abnormal	termination of startup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2964">[ date ]</a>
              <a href="thread.html#2964">[ thread ]</a>
              <a href="subject.html#2964">[ subject ]</a>
              <a href="author.html#2964">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
