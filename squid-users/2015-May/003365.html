<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL why does this not work?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20why%20does%20this%20not%20work%3F&In-Reply-To=%3C5543A270.2010503%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003362.html">
   <LINK REL="Next"  HREF="003354.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL why does this not work?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20why%20does%20this%20not%20work%3F&In-Reply-To=%3C5543A270.2010503%40treenet.co.nz%3E"
       TITLE="[squid-users] ACL why does this not work?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May  1 15:57:36 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003362.html">[squid-users] ACL why does this not work?
</A></li>
        <LI>Next message (by thread): <A HREF="003354.html">[squid-users] FATAL: xcalloc: Unable to allocate 18446744073468065319 blocks of 1 bytes!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3365">[ date ]</a>
              <a href="thread.html#3365">[ thread ]</a>
              <a href="subject.html#3365">[ subject ]</a>
              <a href="author.html#3365">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/05/2015 1:33 a.m., Yan Seiner wrote:
&gt;<i> 
</I>&gt;<i> On 05/01/2015 01:25 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 1/05/2015 11:56 a.m., Yan Seiner wrote:
</I>&gt;&gt;&gt;<i> I am trying to prevent squid from proxying to an authorized subnet.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I want to write a set of acl rules that say that if a request does not
</I>&gt;&gt;&gt;<i> come from the authorized subnet then it should not be allowed to connect
</I>&gt;&gt;&gt;<i> to the authorized web server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl auth_net src 192.168.4.0/24
</I>&gt;&gt;&gt;<i> acl auth dst 192.168.4.1
</I>&gt;&gt;&gt;<i> http_access deny !auth_net auth
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> AFAICT something like the above should work but it doesn't.  squid
</I>&gt;&gt;&gt;<i> proxies requests from anywhere on the network to the authorized
</I>&gt;&gt;&gt;<i> webserver, getting right around the firewall.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any suggestions on how to make this work?
</I>&gt;&gt;<i> You either got the order wrong
</I>&gt;&gt;<i> (&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/OrderIsImportant">http://wiki.squid-cache.org/SquidFaq/OrderIsImportant</A>&gt;) or the DNS
</I>&gt;&gt;<i> results are not what you think they are.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We cant really say without knowing what your whole config is.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> Hi Amos:
</I>&gt;<i> 
</I>&gt;<i> Here's my config; it's pretty basic.
</I>&gt;<i> 
</I>&gt;<i> I have 4 subnets: dmz, auth, guest, and tenant.  Only the auth subnet
</I>&gt;<i> should be allowed access to the webserver on 192.168.4.1. The web server
</I>&gt;<i> does not listen on any of the other subnets.
</I>
Where the server listens is only relevant if the clients are talking
directly to it. When they go through the proxy its the proxy talking to
the server.

Still, what you have configured below does define the policy correctly.


Two things to do:

1) enable access.log and see what gets logged when you test it.

2) configure &quot;debug_options 28,3&quot; and see what shows up in cache.log
when you test it.

Some more notes below...

&gt;<i> 
</I>&gt;<i> cache_mem 3072 MB
</I>&gt;<i> 
</I>&gt;<i> acl dmz_net src 192.168.3.0/24
</I>&gt;<i> acl auth_net src 192.168.4.0/24
</I>&gt;<i> acl guest_net src 192.168.5.0/24
</I>&gt;<i> acl tenant_net src 192.168.6.0/24
</I>&gt;<i> 
</I>&gt;<i> acl dmz dst 192.168.3.1
</I>&gt;<i> acl auth dst 192.168.4.1
</I>&gt;<i> acl guest dst 192.168.5.1
</I>&gt;<i> acl tenant dst 192.168.6.1
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;<i> acl localnet src fc00::/7
</I>&gt;<i> acl localnet src fe80::/10
</I>&gt;<i> 
</I>&gt;<i> acl ssl_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl safe_ports port 80
</I>&gt;<i> acl safe_ports port 21
</I>&gt;<i> acl safe_ports port 443
</I>&gt;<i> acl safe_ports port 70
</I>&gt;<i> acl safe_ports port 210
</I>&gt;<i> acl safe_ports port 1025-65535
</I>&gt;<i> acl safe_ports port 280
</I>&gt;<i> acl safe_ports port 488
</I>&gt;<i> acl safe_ports port 591
</I>&gt;<i> acl safe_ports port 777
</I>&gt;<i> acl connect method connect
</I>
Ah, method names are case-sensitive.

At the very least that should be:
  acl connect method CONNECT

&gt;<i> 
</I>&gt;<i> http_access deny !auth_net auth
</I>&gt;<i> 
</I>&gt;<i> http_access deny !safe_ports
</I>&gt;<i> http_access deny connect !ssl_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;<i> 
</I>&gt;<i> access_log none
</I>&gt;<i> cache_log /dev/null
</I>
Dont do that. cache.log is where Squid publishes the critical failures
that your *really* need to be aware of.

&gt;<i> cache_store_log /dev/null
</I>
If you have a current Squid version, just erase the line. store.log is
not enabled by default since 3.1.

&gt;<i> logfile_rotate 0
</I>&gt;<i> 
</I>&gt;<i> logfile_daemon /dev/null
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003362.html">[squid-users] ACL why does this not work?
</A></li>
	<LI>Next message (by thread): <A HREF="003354.html">[squid-users] FATAL: xcalloc: Unable to allocate 18446744073468065319 blocks of 1 bytes!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3365">[ date ]</a>
              <a href="thread.html#3365">[ thread ]</a>
              <a href="subject.html#3365">[ subject ]</a>
              <a href="author.html#3365">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
