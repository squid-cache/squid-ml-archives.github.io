<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Youtube redirection loop?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Youtube%20redirection%20loop%3F&In-Reply-To=%3C1430777255139-4671103.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003425.html">
   <LINK REL="Next"  HREF="003464.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Youtube redirection loop?</H1>
    <B>HackXBack</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Youtube%20redirection%20loop%3F&In-Reply-To=%3C1430777255139-4671103.post%40n4.nabble.com%3E"
       TITLE="[squid-users] Youtube redirection loop?">hack.back at hotmail.com
       </A><BR>
    <I>Mon May  4 22:07:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003425.html">[squid-users] Youtube redirection loop?
</A></li>
        <LI>Next message (by thread): <A HREF="003464.html">[squid-users] Youtube redirection loop?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3444">[ date ]</a>
              <a href="thread.html#3444">[ thread ]</a>
              <a href="subject.html#3444">[ subject ]</a>
              <a href="author.html#3444">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Okay Sir,
this is the solution

1st: put this conf in your squid.conf

####for looping 302 on youtube
acl text-html rep_mime_type text/html
acl http302 http_status 302
store_miss deny text-html
store_miss deny http302
send_hit deny text-html
send_hit deny http302


2nd: use this patch:



--- src/client_side_request.cc  2014-03-09 06:40:56.000000000 -0300
+++ src/client_side_request.cc  2014-04-21 02:53:11.277155130 -0300
@@ -545,6 +545,16 @@
             }
             debugs(85, 3, HERE &lt;&lt; &quot;validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot;
non-match from Host: IP &quot; &lt;&lt; ia-&gt;in_addrs[i]);
         }
+ 
+        if (true) {
+            unsigned short port = clientConn-&gt;local.port();
+            debugs(85, 3, HERE &lt;&lt; &quot;[anti-forgery] Host-non-matched remote
IP (&quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot;) was replaced with the first Host resolved
IP (&quot; &lt;&lt; ia-&gt;in_addrs[0] &lt;&lt; &quot;:&quot; &lt;&lt; clientConn-&gt;local.port() &lt;&lt; &quot;)&quot;);
+            clientConn-&gt;local = ia-&gt;in_addrs[0];
+            clientConn-&gt;local.port(port);
+            http-&gt;request-&gt;flags.hostVerified = true;
+            http-&gt;doCallouts();
+            return;
+        }
     }
     debugs(85, 3, HERE &lt;&lt; &quot;FAIL: validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot;
possible from Host:&quot;);
     hostHeaderVerifyFailed(&quot;local IP&quot;, &quot;any domain IP&quot;);


--- src/Server.cc
+++ src/Server.cc
@@ -31,6 +31,7 @@
  */
 
 #include &quot;squid.h&quot;
+#include &quot;acl/FilledChecklist.h&quot;
 #include &quot;acl/Gadgets.h&quot;
 #include &quot;base/TextException.h&quot;
 #include &quot;comm/Connection.h&quot;
@@ -174,6 +175,8 @@
     // give entry the reply because haveParsedReplyHeaders() expects it
there
     entry-&gt;replaceHttpReply(theFinalReply, false); // but do not write yet
     haveParsedReplyHeaders(); // update the entry/reply (e.g., set
timestamps)
+    if (EBIT_TEST(entry-&gt;flags, ENTRY_CACHABLE) &amp;&amp; blockCaching())
+        entry-&gt;release();
     entry-&gt;startWriting(); // write the updated entry to store
 
     return theFinalReply;
@@ -533,6 +536,24 @@
     currentOffset = partial ? theFinalReply-&gt;content_range-&gt;spec.offset :
0;
 }
 
+/// whether to prevent caching of an otherwise cachable response
+bool
+ServerStateData::blockCaching()
+{
+    if (const Acl::Tree *acl = Config.accessList.storeMiss) {
+        // This relatively expensive check is not in
StoreEntry::checkCachable:
+        // That method lacks HttpRequest and may be called too many times.
+        ACLFilledChecklist ch(acl, originalRequest(), NULL);
+        ch.reply = const_cast&lt;HttpReply*&gt;(entry-&gt;getReply()); //
ACLFilledChecklist API bug
+        HTTPMSGLOCK(ch.reply);
+        if (ch.fastCheck() != ACCESS_ALLOWED) { // when in doubt, block
+            debugs(20, 3, &quot;store_miss prohibits caching&quot;);
+            return true;
+        }
+    }
+    return false;
+}
+
 HttpRequest *
 ServerStateData::originalRequest()
 {
--- src/Server.h
+++ src/Server.h
@@ -131,6 +131,8 @@
     /// Entry-dependent callbacks use this check to quit if the entry went
bad
     bool abortOnBadEntry(const char *abortReason);
 
+    bool blockCaching();
+
 #if USE_ADAPTATION
     void startAdaptation(const Adaptation::ServiceGroupPointer &amp;group,
HttpRequest *cause);
     void adaptVirginReplyBody(const char *buf, ssize_t len);
--- src/SquidConfig.h
+++ src/SquidConfig.h
@@ -375,6 +375,8 @@
         acl_access *AlwaysDirect;
         acl_access *ASlists;
         acl_access *noCache;
+        acl_access *sendHit;
+        acl_access *storeMiss;
         acl_access *stats_collection;
 #if SQUID_SNMP
 
--- src/cf.data.pre
+++ src/cf.data.pre
@@ -4843,18 +4843,97 @@
 NAME: cache no_cache
 TYPE: acl_access
 DEFAULT: none
-DEFAULT_DOC: Allow caching, unless rules exist in squid.conf.
+DEFAULT_DOC: By default, this directive is unused and has no effect.
 LOC: Config.accessList.noCache
 DOC_START
-	A list of ACL elements which, if matched and denied, cause the request to
-	not be satisfied from the cache and the reply to not be cached.
-	In other words, use this to force certain objects to never be cached.
-
-	You must use the words 'allow' or 'deny' to indicate whether items
-	matching the ACL should be allowed or denied into the cache.
+	Requests denied by this directive will not be served from the cache
+	and their responses will not be stored in the cache. This directive
+	has no effect on other transactions and on already cached responses.
 
 	This clause supports both fast and slow acl types.
 	See <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A> for details.
+
+	This and the two other similar caching directives listed below are
+	checked at different transaction processing stages, have different
+	access to response information, affect different cache operations,
+	and differ in slow ACLs support:
+
+	* cache: Checked before Squid makes a hit/miss determination.
+		No access to reply information!
+		Denies both serving a hit and storing a miss.
+		Supports both fast and slow ACLs.
+	* send_hit: Checked after a hit was detected.
+		Has access to reply (hit) information.
+		Denies serving a hit only.
+		Supports fast ACLs only.
+	* store_miss: Checked before storing a cachable miss.
+		Has access to reply (miss) information.
+		Denies storing a miss only.
+		Supports fast ACLs only.
+
+	If you are not sure which of the three directives to use, apply the
+	following decision logic:
+
+	* If your ACL(s) are of slow type _and_ need response info, redesign.
+	  Squid does not support that particular combination at this time.
+        Otherwise:
+	* If your directive ACL(s) are of slow type, use &quot;cache&quot;; and/or
+	* if your directive ACL(s) need no response info, use &quot;cache&quot;.
+        Otherwise:
+	* If you do not want the response cached, use store_miss; and/or
+	* if you do not want a hit on a cached response, use send_hit.
+DOC_END
+
+NAME: send_hit
+TYPE: acl_access
+DEFAULT: none
+DEFAULT_DOC: By default, this directive is unused and has no effect.
+LOC: Config.accessList.sendHit
+DOC_START
+	Responses denied by this directive will not be served from the cache
+	(but may still be cached, see store_miss). This directive has no
+	effect on the responses it allows and on the cached objects.
+
+	Please see the &quot;cache&quot; directive for a summary of differences among
+	store_miss, send_hit, and cache directives.
+
+	Unlike the &quot;cache&quot; directive, send_hit only supports fast acl
+	types.  See <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A> for details.
+
+	For example:
+
+		# apply custom Store ID mapping to some URLs
+		acl MapMe dstdomain .c.example.com
+		store_id_program ...
+		store_id_access allow MapMe
+
+		# but prevent caching of special responses
+		# such as 302 redirects that cause StoreID loops
+		acl Ordinary http_status 200-299
+		store_miss deny MapMe !Ordinary
+
+		# and do not serve any previously stored special responses
+		# from the cache (in case they were already cached before
+		# the above store_miss rule was in effect).
+		send_hit deny MapMe !Ordinary
+DOC_END
+
+NAME: store_miss
+TYPE: acl_access
+DEFAULT: none
+DEFAULT_DOC: By default, this directive is unused and has no effect.
+LOC: Config.accessList.storeMiss
+DOC_START
+	Responses denied by this directive will not be cached (but may still
+	be served from the cache, see send_hit). This directive has no
+	effect on the responses it allows and on the already cached responses.
+
+	Please see the &quot;cache&quot; directive for a summary of differences among
+	store_miss, send_hit, and cache directives. See the
+	send_hit directive for a usage example.
+
+	Unlike the &quot;cache&quot; directive, store_miss only supports fast acl
+	types.  See <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A> for details.
 DOC_END
 
 NAME: max_stale
--- src/client_side_reply.cc
+++ src/client_side_reply.cc
@@ -545,6 +545,11 @@
        ) {
         http-&gt;logType = LOG_TCP_NEGATIVE_HIT;
         sendMoreData(result);
+    } else if (blockedHit()) {
+        debugs(88, 5, &quot;send_hit forces a MISS&quot;);
+        http-&gt;logType = LOG_TCP_MISS;
+        processMiss();
+        return;
     } else if (!http-&gt;flags.internal &amp;&amp; refreshCheckHTTP(e, r)) {
         debugs(88, 5, &quot;clientCacheHit: in refreshCheck() block&quot;);
         /*
@@ -773,6 +778,30 @@
     }
 }
 
+/// whether squid.conf send_hit prevents us from serving this hit
+bool
+clientReplyContext::blockedHit() const
+{
+    if (!Config.accessList.sendHit)
+        return false; // hits are not blocked by default
+
+    if (http-&gt;flags.internal)
+        return false; // internal content &quot;hits&quot; cannot be blocked
+
+    if (const HttpReply *rep = http-&gt;storeEntry()-&gt;getReply()) {
+        std::auto_ptr&lt;ACLFilledChecklist&gt;
chl(clientAclChecklistCreate(Config.accessList.sendHit, http));
+        chl-&gt;reply = const_cast&lt;HttpReply*&gt;(rep); // ACLChecklist API bug
+        HTTPMSGLOCK(chl-&gt;reply);
+        return chl-&gt;fastCheck() != ACCESS_ALLOWED; // when in doubt, block
+    }
+
+    // This does not happen, I hope, because we are called from CacheHit,
which
+    // is called via a storeClientCopy() callback, and store should
initialize
+    // the reply before calling that callback.
+    debugs(88, 3, &quot;Missing reply!&quot;);
+    return false;
+}
+
 void
 clientReplyContext::purgeRequestFindObjectToPurge()
 {
--- src/client_side_reply.h
+++ src/client_side_reply.h
@@ -140,6 +140,7 @@
     void triggerInitialStoreRead();
     void sendClientOldEntry();
     void purgeAllCached();
+    bool blockedHit() const;
 
     void sendBodyTooLargeError();
     void sendPreconditionFailedError();




--
View this message in context: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Youtube-redirection-loop-tp4671084p4671103.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Youtube-redirection-loop-tp4671084p4671103.html</A>
Sent from the Squid - Users mailing list archive at Nabble.com.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003425.html">[squid-users] Youtube redirection loop?
</A></li>
	<LI>Next message (by thread): <A HREF="003464.html">[squid-users] Youtube redirection loop?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3444">[ date ]</a>
              <a href="thread.html#3444">[ thread ]</a>
              <a href="subject.html#3444">[ subject ]</a>
              <a href="author.html#3444">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
