<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.4%20Can%27t%20access%20Google%20or%20Yahoo%20SSL%20pages&In-Reply-To=%3C5549C0A6.50806%40cpalmer.me.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003424.html">
   <LINK REL="Next"  HREF="003492.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages</H1>
    <B>Chris Palmer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.4%20Can%27t%20access%20Google%20or%20Yahoo%20SSL%20pages&In-Reply-To=%3C5549C0A6.50806%40cpalmer.me.uk%3E"
       TITLE="[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages">chris9 at cpalmer.me.uk
       </A><BR>
    <I>Wed May  6 07:20:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003424.html">[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
</A></li>
        <LI>Next message (by thread): <A HREF="003492.html">[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3478">[ date ]</a>
              <a href="thread.html#3478">[ thread ]</a>
              <a href="subject.html#3478">[ subject ]</a>
              <a href="author.html#3478">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> &gt;&gt;&gt; There has been a change in behaviour in 3.5.4. It now really does
 &gt;&gt;&gt; prefer to contact a site using an ipv6 address rather than a v4. The
 &gt;&gt;&gt; network stack here doesn't permit v6 so the traffic to sites such as
 &gt;&gt;&gt; google was failing. Setting the following restored the previous
 &gt;&gt;&gt; behaviour:
 &gt;&gt;&gt;
 &gt;&gt;&gt; dns_v4_first on
 &gt;&gt;
 &gt;&gt; As far as I'm aware squid won't try to use ipv6 unless your server has a
 &gt;&gt; Global address, so that shouldn't be needed? Also, wouldn't squid simply
 &gt;&gt; treat that as a DNS name that resolves to a bunch of addresses, so as
 &gt;&gt; long as the IPv6 addresses fail to connect at all, it should have still
 &gt;&gt; ended up succeeding with ipv4 addresses?
 &gt;&gt;

The description of dns_v4_first (squid.conf.documented) says
  With the IPv6 Internet being as fast or faster than IPv4 Internet
  for most networks Squid prefers to contact websites over IPv6.

  This option reverses the order of preference to make Squid contact
  dual-stack websites over IPv4 first. Squid will still perform both
  IPv6 and IPv4 DNS lookups before connecting.

This does indicate specific treatment of IPv6 addresses.

 &gt;&gt; Finally, I'm running squid-3.5.4, don't have ipv6 (just like everyone
 &gt;&gt; else, I still do have the standard fe80:xxx ipv6 link local address) and
 &gt;&gt; google.com works just fine without &quot;dns_v4_first&quot; - which implies my
 &gt;&gt; statements above are correct
 &gt;&gt;
 &gt;&gt; ie this smells like you actually do have ipv6 enabled, but it's broken
 &gt;&gt; in some subtle way (like the pmtu issue Amos mentioned)
 &gt;&gt;
 &gt;
 &gt;
 &gt; The tunnel.cc code producing that read/write error is one of the bits
 &gt; still broken in regards to errno usage. So I dont entirely trust that
 &gt; &quot;endpoint not connected&quot; detail, it seems right but could be something
 &gt; subtly different.
 &gt;
 &gt; Ayways, to get the output at all the TCP SYN/ACK handshake has to have
 &gt; already setup the IPv6 connection with no errors. Then a (first? TLS?)
 &gt; read/write operation attempted on the IPv6 socket fails and does that
 &gt; log message
 &gt;
 &gt; There is supposed to be callback event protections preventing closed
 &gt; sockets being used for read/write (adding to suspicion about the log
 &gt; message), which is where I'm currently trying to figure out what state
 &gt; things could be in.
 &gt;
 &gt; Amos
 &gt;

I've done some more investigation. The problem is not SSL-related, but 
merely IPv6-related.
A network trace confirms that, in the failing IPv6 case, no traffic 
leaves the squid host. This is
expected, as there is no v6 routing. I had the default IPv6 link-local 
address on each interface,
but as an experiment removed all IPv6 addresses from all interfaces, and 
the problem is still the
same. Similarly a traceroute6 correctly reports no route.

In the &quot;configure&quot; help, there is an option to not build v6 support. The 
comment indicates that
squid probes the kernel to determine if it is v6-capable. The problem 
arises when the kernel is compiled
with v6 support, but v6 is not operational on any interface - no 
addresses, no routes etc.

With 3.5.3 I didn't &quot;see&quot; the default &quot;dns_first_v4 off&quot; actually doing 
anything. So for a destination host
that had a v4 address it would try to use those, and it worked. I don't 
know whether it never tried the
v6 address, or maybe it did, realised it had failed, and then 
successfully tried one of the other v4
addresses. With 3.5.4 it definitely goes for the v6 address and then 
fails hard (transport not connected)
without attempting to use any of the v4 addresses.

My hunch is that 3.5.4 has introduced a problem with error handling in 
the v6 code, causing it to fail and
never try any other addresses.

For the majority of installations that do not have v6 capability, I 
suspect that the default setting
of &quot;dns_first_v4 off&quot; is inefficient for sites with both v4 and v6 
addresses as it always tries the v6 addresses
and fails, then goes for the v4 ones that work?? If that is the case, a 
better default for v4
installations might be &quot;dns_first_v4 on&quot;. It would obviously fail on 
v6-only destinations but that is to
be expected.

There is a warning in the documentation about using dns_first_v4 though 
which I don't really understand.
I'd like to know what the implications are - and whether I would be 
better simply building squid
without v6 support at all.

Chris

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003424.html">[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
</A></li>
	<LI>Next message (by thread): <A HREF="003492.html">[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3478">[ date ]</a>
              <a href="thread.html#3478">[ thread ]</a>
              <a href="subject.html#3478">[ subject ]</a>
              <a href="author.html#3478">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
