<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.4%20Can%27t%20access%20Google%20or%20Yahoo%20SSL%20pages&In-Reply-To=%3C554A37B5.8020402%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003478.html">
   <LINK REL="Next"  HREF="003381.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.4%20Can%27t%20access%20Google%20or%20Yahoo%20SSL%20pages&In-Reply-To=%3C554A37B5.8020402%40treenet.co.nz%3E"
       TITLE="[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May  6 15:48:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003478.html">[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
</A></li>
        <LI>Next message (by thread): <A HREF="003381.html">[squid-users] Looking for a good tutorial for writing a custom eCap	filter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3492">[ date ]</a>
              <a href="thread.html#3492">[ thread ]</a>
              <a href="subject.html#3492">[ subject ]</a>
              <a href="author.html#3492">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/05/2015 7:20 p.m., Chris Palmer wrote:
&gt;&gt;&gt;&gt;<i> There has been a change in behaviour in 3.5.4. It now really does
</I>&gt;&gt;&gt;&gt;<i> prefer to contact a site using an ipv6 address rather than a v4. The
</I>&gt;&gt;&gt;&gt;<i> network stack here doesn't permit v6 so the traffic to sites such as
</I>&gt;&gt;&gt;&gt;<i> google was failing. Setting the following restored the previous
</I>&gt;&gt;&gt;&gt;<i> behaviour:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> dns_v4_first on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As far as I'm aware squid won't try to use ipv6 unless your server has a
</I>&gt;&gt;&gt;<i> Global address, so that shouldn't be needed? Also, wouldn't squid simply
</I>&gt;&gt;&gt;<i> treat that as a DNS name that resolves to a bunch of addresses, so as
</I>&gt;&gt;&gt;<i> long as the IPv6 addresses fail to connect at all, it should have still
</I>&gt;&gt;&gt;<i> ended up succeeding with ipv4 addresses?
</I>&gt;&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> The description of dns_v4_first (squid.conf.documented) says
</I>&gt;<i>  With the IPv6 Internet being as fast or faster than IPv4 Internet
</I>&gt;<i>  for most networks Squid prefers to contact websites over IPv6.
</I>&gt;<i> 
</I>&gt;<i>  This option reverses the order of preference to make Squid contact
</I>&gt;<i>  dual-stack websites over IPv4 first. Squid will still perform both
</I>&gt;<i>  IPv6 and IPv4 DNS lookups before connecting.
</I>&gt;<i> 
</I>&gt;<i> This does indicate specific treatment of IPv6 addresses.
</I>
Yes. RFC 6540:

&quot;
   o  IPv6 support must be equivalent or better in quality and
      functionality when compared to IPv4 support in a new or updated IP
      implementation.
&quot;

We do this in Squid by the default connection being to attempt to use
IPv6 addresses first, then IPv4.

On a machine properly supporting IPv6 - including the case where IPv6
addresses have not been assigned. There is no latency.

On a machine where IPv6 has been mangled or broken by attempts to
disable it (which is actually not possible in modern systems). Then by
default IPv4 suffers as much as IPv6.


&gt;<i> 
</I>&gt;&gt;&gt;<i> Finally, I'm running squid-3.5.4, don't have ipv6 (just like everyone
</I>&gt;&gt;&gt;<i> else, I still do have the standard fe80:xxx ipv6 link local address) and
</I>&gt;&gt;&gt;<i> google.com works just fine without &quot;dns_v4_first&quot; - which implies my
</I>&gt;&gt;&gt;<i> statements above are correct
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ie this smells like you actually do have ipv6 enabled, but it's broken
</I>&gt;&gt;&gt;<i> in some subtle way (like the pmtu issue Amos mentioned)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The tunnel.cc code producing that read/write error is one of the bits
</I>&gt;&gt;<i> still broken in regards to errno usage. So I dont entirely trust that
</I>&gt;&gt;<i> &quot;endpoint not connected&quot; detail, it seems right but could be something
</I>&gt;&gt;<i> subtly different.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ayways, to get the output at all the TCP SYN/ACK handshake has to have
</I>&gt;&gt;<i> already setup the IPv6 connection with no errors. Then a (first? TLS?)
</I>&gt;&gt;<i> read/write operation attempted on the IPv6 socket fails and does that
</I>&gt;&gt;<i> log message
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There is supposed to be callback event protections preventing closed
</I>&gt;&gt;<i> sockets being used for read/write (adding to suspicion about the log
</I>&gt;&gt;<i> message), which is where I'm currently trying to figure out what state
</I>&gt;&gt;<i> things could be in.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I've done some more investigation. The problem is not SSL-related, but
</I>&gt;<i> merely IPv6-related.
</I>&gt;<i> A network trace confirms that, in the failing IPv6 case, no traffic
</I>&gt;<i> leaves the squid host. This is
</I>&gt;<i> expected, as there is no v6 routing. I had the default IPv6 link-local
</I>&gt;<i> address on each interface,
</I>&gt;<i> but as an experiment removed all IPv6 addresses from all interfaces, and
</I>&gt;<i> the problem is still the
</I>&gt;<i> same. Similarly a traceroute6 correctly reports no route.
</I>&gt;<i> 
</I>&gt;<i> In the &quot;configure&quot; help, there is an option to not build v6 support. The
</I>&gt;<i> comment indicates that
</I>&gt;<i> squid probes the kernel to determine if it is v6-capable. The problem
</I>&gt;<i> arises when the kernel is compiled
</I>&gt;<i> with v6 support, but v6 is not operational on any interface - no
</I>&gt;<i> addresses, no routes etc.
</I>&gt;<i> 
</I>&gt;<i> With 3.5.3 I didn't &quot;see&quot; the default &quot;dns_first_v4 off&quot; actually doing
</I>&gt;<i> anything. So for a destination host
</I>&gt;<i> that had a v4 address it would try to use those, and it worked. I don't
</I>&gt;<i> know whether it never tried the
</I>&gt;<i> v6 address, or maybe it did, realised it had failed, and then
</I>&gt;<i> successfully tried one of the other v4
</I>&gt;<i> addresses. With 3.5.4 it definitely goes for the v6 address and then
</I>&gt;<i> fails hard (transport not connected)
</I>&gt;<i> without attempting to use any of the v4 addresses.
</I>&gt;<i> 
</I>&gt;<i> My hunch is that 3.5.4 has introduced a problem with error handling in
</I>&gt;<i> the v6 code, causing it to fail and
</I>&gt;<i> never try any other addresses.
</I>&gt;<i> 
</I>&gt;<i> For the majority of installations that do not have v6 capability, I
</I>&gt;<i> suspect that the default setting
</I>&gt;<i> of &quot;dns_first_v4 off&quot; is inefficient for sites with both v4 and v6
</I>&gt;<i> addresses as it always tries the v6 addresses
</I>&gt;<i> and fails, then goes for the v4 ones that work?? If that is the case, a
</I>&gt;<i> better default for v4
</I>&gt;<i> installations might be &quot;dns_first_v4 on&quot;. It would obviously fail on
</I>&gt;<i> v6-only destinations but that is to
</I>&gt;<i> be expected.
</I>
On a properly configured machine the inefficiency is measured in
nanoseconds or less. Its one syscall per IP that fails.
This also helps meet the RFC 6540 criteria, since the inefficiency is
added as prefix to IPv4 connections usage (enhancing IPv6 relative
performance).

&gt;<i> 
</I>&gt;<i> There is a warning in the documentation about using dns_first_v4 though
</I>&gt;<i> which I don't really understand.
</I>
This bug itself is a good example about what the warning is about.

If you run Squid with &quot;dns_v4_first on&quot;, or if it was the default this
fairy major bug would not have been found for a long time. The same
thing applies for regular routing problems, and IPv6 connectivity
issues, etc, etc. all of them are hidden away out of sight but still
very much existing when dns_v4_first is used.

They *will* come up to bite you later on. Its best to lets you know
where the problems are so they can be solved quickly.



&gt;<i> I'd like to know what the implications are - and whether I would be
</I>&gt;<i> better simply building squid
</I>&gt;<i> without v6 support at all.
</I>
I think the bug was introduced by the fix to bug 4234. If you can assist
by building and running Squid with that bug patch reversed it would help.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003478.html">[squid-users] 3.5.4 Can't access Google or Yahoo SSL pages
</A></li>
	<LI>Next message (by thread): <A HREF="003381.html">[squid-users] Looking for a good tutorial for writing a custom eCap	filter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3492">[ date ]</a>
              <a href="thread.html#3492">[ thread ]</a>
              <a href="subject.html#3492">[ subject ]</a>
              <a href="author.html#3492">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
