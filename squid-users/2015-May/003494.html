<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 3.5.4 need more help with peek and splice and	external helper
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.4%20need%20more%20help%20with%20peek%20and%20splice%20and%0A%09external%20helper&In-Reply-To=%3CCANLNtGRgGiBSWbuYAA14t6%3DSV%2BKxh-pvghdq5fgTCyb30DJaPg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003493.html">
   <LINK REL="Next"  HREF="003495.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 3.5.4 need more help with peek and splice and	external helper</H1>
    <B>Stanford Prescott</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.4%20need%20more%20help%20with%20peek%20and%20splice%20and%0A%09external%20helper&In-Reply-To=%3CCANLNtGRgGiBSWbuYAA14t6%3DSV%2BKxh-pvghdq5fgTCyb30DJaPg%40mail.gmail.com%3E"
       TITLE="[squid-users] 3.5.4 need more help with peek and splice and	external helper">stan.prescott at gmail.com
       </A><BR>
    <I>Wed May  6 22:58:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003493.html">[squid-users] Any Greasyspoon iCAP users out there?
</A></li>
        <LI>Next message (by thread): <A HREF="003495.html">[squid-users] 3.5.4 need more help with peek and splice and external helper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3494">[ date ]</a>
              <a href="thread.html#3494">[ thread ]</a>
              <a href="subject.html#3494">[ subject ]</a>
              <a href="author.html#3494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have still been trying to get peek and splice to work. Specifically I
want to allow the admins of our firewall distro to enter websites that they
do not want to bump on the squid UI page. I have been fiddling with info
that Amos and Nathan have provided me but with no success so far. Here is a
snippet of squid.conf with most of the pertinent SSL configuration.

*http_access allow localhostgreen*
*http_access allow CONNECT localhostgreen*

*# http_port and https_port*
*#----------------------------------------------------------------------------*

*http_port 192.168.100.1:800 &lt;<A HREF="http://192.168.100.1:800">http://192.168.100.1:800</A>&gt; intercept*
*https_port 192.168.100.1:808 &lt;<A HREF="http://192.168.100.1:808">http://192.168.100.1:808</A>&gt; intercept ssl-bump
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem*

*http_port 127.0.0.1:800 &lt;<A HREF="http://127.0.0.1:800">http://127.0.0.1:800</A>&gt; intercept*

*sslproxy_cert_error allow all*
*sslproxy_flags DONT_VERIFY_PEER*
*sslproxy_session_cache_size 4 MB*

*ssl_bump none localhostgreen*

*external_acl_type sni ttl=30 concurrency=60 children-max=3
children-startup=1 %ssl::&gt;sni /var/smoothwall/mods/proxy/libexec/bumphelper*

*acl sni_exclusions external sni*
*acl tcp_level at_step SslBump1*
*acl client_hello_peeked at_step SslBump2*

*ssl_bump none localhostgreen*

*ssl_bump peek tcp_level all*
*ssl_bump splice client_hello_peeked sni_exclusions*
*ssl_bump bump all*

*sslcrtd_program /var/smoothwall/mods/proxy/libexec/ssl_crtd -s
/var/smoothwall/mods/proxy/lib/ssl_db -M 4MB*
*sslcrtd_children 5*


These were provided by Nathan to try. He also provided an example helper
script in python to try, but our distro doesn't grok python so I tried to
get it translated to perl and this what I came up with.

*#!/usr/bin/perl*

*# run loop until an empty read, which indicates the process should shut
down.*

*while (&lt;STDIN&gt;)*
*{*
*  my ($concurrency_id, $sni) = split;*

*  if ($sni eq 'wellsfargo.com &lt;<A HREF="http://wellsfargo.com">http://wellsfargo.com</A>&gt;')*
*  {*
*     print &quot;$concurreny_id OK\n&quot;;*
*  }*
*  else*
*  {*
*     print &quot;$concurreny_id ERR\n&quot;;*
*  }*
*}*


When I start Squid with this configuration, the helper script &quot;bumphelper&quot;
gets loaded as a process along with squid and ssl_crtd. When I try to
browse any SSL websites there is no connection and it times out. HTTP
browsing is fine. When I remove those peek and splice related lines and add
&quot;ssl_bump server-first all&quot; back to squid conf then bumping of SSL sites is
successful.

I suspect my &quot;bumphelper&quot; script is not doing what I intend it to do.

Suggestions very welcome.

Stan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150506/b7738ccb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150506/b7738ccb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003493.html">[squid-users] Any Greasyspoon iCAP users out there?
</A></li>
	<LI>Next message (by thread): <A HREF="003495.html">[squid-users] 3.5.4 need more help with peek and splice and external helper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3494">[ date ]</a>
              <a href="thread.html#3494">[ thread ]</a>
              <a href="subject.html#3494">[ subject ]</a>
              <a href="author.html#3494">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
