<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users]  Client IP spoofing via squid proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%20Client%20IP%20spoofing%20via%20squid%20proxy&In-Reply-To=%3CHKXPR03MB200C8616441D69FD31CE6C6A1DF0%40HKXPR03MB200.apcprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003475.html">
   <LINK REL="Next"  HREF="003502.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users]  Client IP spoofing via squid proxy</H1>
    <B>Ambadas Hibare</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%20Client%20IP%20spoofing%20via%20squid%20proxy&In-Reply-To=%3CHKXPR03MB200C8616441D69FD31CE6C6A1DF0%40HKXPR03MB200.apcprd03.prod.outlook.com%3E"
       TITLE="[squid-users]  Client IP spoofing via squid proxy">ambadasvh at teledna.com
       </A><BR>
    <I>Thu May  7 04:59:16 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003475.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003502.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3499">[ date ]</a>
              <a href="thread.html#3499">[ thread ]</a>
              <a href="subject.html#3499">[ subject ]</a>
              <a href="author.html#3499">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for replying.

I did a full transparent tproxy setup for squid proxy on linux(RHEL 6) machine as below:

Version: squid-3.5.1
configure options:  '--enable-follow-x-forwarded-for' '--enable-linux-netfilter' --enable-ltdl-convenience

squid.conf:
http_port 3128
http_port 3129 tproxy

Linux Kernel Configuration:
NF_CONNTRACK=m
NETFILTER_TPROXY=m
NETFILTER_XT_MATCH_SOCKET=m
NETFILTER_XT_TARGET_TPROXY=m

Routing configuration:
ip -f inet rule add fwmark 1 lookup 100
ip -f inet route add local default dev eth1 table 100 ip -f inet6 rule add fwmark 1 lookup 100 ip -f inet6 route add local default dev eth1 table 100

echo 1 &gt; /proc/sys/net/ipv4/ip_forward
echo 0 &gt; /proc/sys/net/ipv4/conf/default/rp_filter
echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter
echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter

iptables Configuration:
iptables -t mangle -N DIVERT
iptables -t mangle -A DIVERT -j MARK --set-mark 1 iptables -t mangle -A DIVERT -j ACCEPT iptables  -t mangle -A PREROUTING -p tcp -m socket -j DIVERT iptables  -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129

The below machines are on local LAN setup Client IP: 172.16.5.110 Client's gateway: 10.0.0.102 DNS Server IP: 172.16.1.7 (same for both client &amp; squid machine) Web server IP: 216.58.196.110 (google.com)

Squid Machine has 2 eth interfaces,
eth1 (facing client): 10.0.0.102
eth0 (connecting to web): 172.16.5.102 

While browsing, the client is getting connection timeout. After analyzing the squid side traces, i found that client is doing DNS (for google.com) &amp; connecting to that DNS IP on 80 port. Squid is able to intercept the request on 3129 port, doing DNS and trying to connect to google.com (using spoofed client IP) but is getting RST packet.
Can you you please tell me what is missing here?

Please find the attached trace.


Regards,
Ambadas


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: 05 May 2015 20:30
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Client IP spoofing via squid proxy

On 6/05/2015 2:25 a.m., Ambadas Hibare wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I trying to spoof client IP via squid proxy by following  squid's
</I>&gt;<i> TPROXY4 wiki page: <A HREF="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</A>
</I>&gt;<i> 
</I>&gt;<i> But I want to know whether squid can spoof client IP when we send 
</I>&gt;<i> proxy format HTTP request from Mozilla (ie configuring proxy &amp; port in 
</I>&gt;<i> mozilla). Can squid proxy behave transparently towards only the web 
</I>&gt;<i> server &amp; not the client?
</I>
No. It can be both ways, or just towards the client.


&gt;<i> 
</I>&gt;<i> I've tried sending proxy format HTTP request from client to squid box 
</I>&gt;<i> (on 3129  tproxy port), but I am getting Header forgery error Also its 
</I>&gt;<i> trying to connect to itself instead of web server. I am trying to 
</I>&gt;<i> understand why squid is trying to match host header's DNS with the 
</I>&gt;<i> destination IP instead of connecting to host header's DNS (like normal 
</I>&gt;<i> proxy behaviour on port 3128).
</I>&gt;<i> 
</I>
To prevent CVE-2009-0801 happening.

You must not send regular forward-proxy traffic to a tproxy or intercept port. Forwarding loops are guaranteed if you do.

Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Squid102_20150505.pcap
Type: application/octet-stream
Size: 19394 bytes
Desc: Squid102_20150505.pcap
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150507/187a6057/attachment.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150507/187a6057/attachment.obj</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003475.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003502.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3499">[ date ]</a>
              <a href="thread.html#3499">[ thread ]</a>
              <a href="subject.html#3499">[ subject ]</a>
              <a href="author.html#3499">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
