<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Client IP spoofing via squid proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20IP%20spoofing%20via%20squid%20proxy&In-Reply-To=%3C554AF967.5090406%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003499.html">
   <LINK REL="Next"  HREF="003503.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Client IP spoofing via squid proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20IP%20spoofing%20via%20squid%20proxy&In-Reply-To=%3C554AF967.5090406%40treenet.co.nz%3E"
       TITLE="[squid-users] Client IP spoofing via squid proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May  7 05:34:31 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003499.html">[squid-users]  Client IP spoofing via squid proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003503.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3502">[ date ]</a>
              <a href="thread.html#3502">[ thread ]</a>
              <a href="subject.html#3502">[ subject ]</a>
              <a href="author.html#3502">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/05/2015 4:59 p.m., Ambadas Hibare wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Thanks for replying.
</I>&gt;<i> 
</I>&gt;<i> I did a full transparent tproxy setup for squid proxy on linux(RHEL 6) machine as below:
</I>&gt;<i> 
</I>&gt;<i> Version: squid-3.5.1
</I>&gt;<i> configure options:  '--enable-follow-x-forwarded-for' '--enable-linux-netfilter' --enable-ltdl-convenience
</I>&gt;<i> 
</I>&gt;<i> squid.conf:
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> 
</I>&gt;<i> Linux Kernel Configuration:
</I>&gt;<i> NF_CONNTRACK=m
</I>&gt;<i> NETFILTER_TPROXY=m
</I>&gt;<i> NETFILTER_XT_MATCH_SOCKET=m
</I>&gt;<i> NETFILTER_XT_TARGET_TPROXY=m
</I>&gt;<i> 
</I>&gt;<i> Routing configuration:
</I>&gt;<i> ip -f inet rule add fwmark 1 lookup 100
</I>&gt;<i> ip -f inet route add local default dev eth1 table 100 ip -f inet6 rule add fwmark 1 lookup 100 ip -f inet6 route add local default dev eth1 table 100
</I>&gt;<i> 
</I>&gt;<i> echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</I>&gt;<i> echo 0 &gt; /proc/sys/net/ipv4/conf/default/rp_filter
</I>&gt;<i> echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter
</I>&gt;<i> echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter
</I>&gt;<i> 
</I>&gt;<i> iptables Configuration:
</I>&gt;<i> iptables -t mangle -N DIVERT
</I>&gt;<i> iptables -t mangle -A DIVERT -j MARK --set-mark 1 iptables -t mangle -A DIVERT -j ACCEPT iptables  -t mangle -A PREROUTING -p tcp -m socket -j DIVERT iptables  -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129
</I>&gt;<i> 
</I>&gt;<i> The below machines are on local LAN setup Client IP: 172.16.5.110 Client's gateway: 10.0.0.102 DNS Server IP: 172.16.1.7 (same for both client &amp; squid machine) Web server IP: 216.58.196.110 (google.com)
</I>&gt;<i> 
</I>&gt;<i> Squid Machine has 2 eth interfaces,
</I>&gt;<i> eth1 (facing client): 10.0.0.102
</I>&gt;<i> eth0 (connecting to web): 172.16.5.102 
</I>&gt;<i> 
</I>
And MAC addresses please? TPROXY mixes up all the IPs.


&gt;<i> While browsing, the client is getting connection timeout. After analyzing the squid side traces, i found that client is doing DNS (for google.com) &amp; connecting to that DNS IP on 80 port. Squid is able to intercept the request on 3129 port, doing DNS and trying to connect to google.com (using spoofed client IP) but is getting RST packet.
</I>&gt;<i> Can you you please tell me what is missing here?
</I>
Your &quot;ip route&quot; rules use eth1, but your rp_filter settings only change
eth0. Also your iptables rules do not distinguish by ethN.

So its possible that rp_filter is still affecting traffic on eth1 trying
to be TPROXY'd.

Also its possible the eth0 traffic being TPROXY'd is not finding a
usable route table entry.

Your trace shows the MAC address *:c4 contacting Squid (MAC address
*:e4) and delivering an HTTP request. Squid (*:e4) then contacts the
remote server be sending a TCP SYN packet ... which the MAC address *:c4
rejects.


Some possibilities about what is actually going on:

1) Squid SYN packet gets to server. The server SYN ACK gets routed to
client, which rejects with RST. The RST gets routed to Squid.

2) Squid SYN packet hits rp_filter protection which RST. (If *:c4 is a
NIC on the Squid box).

3) Squid SYN packet sent out wrong ethN interface (towards client) and
the router that way rejects the SYN with RST, since it knows routing bak
to Squid is invalid.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003499.html">[squid-users]  Client IP spoofing via squid proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003503.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3502">[ date ]</a>
              <a href="thread.html#3502">[ thread ]</a>
              <a href="subject.html#3502">[ subject ]</a>
              <a href="author.html#3502">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
