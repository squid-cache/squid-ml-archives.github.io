<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.3%20can%27t%20get%20peek%20and%20splice%20to%20not%20bump%0A%20certain%20sites&In-Reply-To=%3CCANLNtGRkYdZETi8zdKnJBDtowNn_v2pJ8fF4up%2Bc69sHX8RFuA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003497.html">
   <LINK REL="Next"  HREF="003500.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites</H1>
    <B>Stanford Prescott</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.3%20can%27t%20get%20peek%20and%20splice%20to%20not%20bump%0A%20certain%20sites&In-Reply-To=%3CCANLNtGRkYdZETi8zdKnJBDtowNn_v2pJ8fF4up%2Bc69sHX8RFuA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites">stan.prescott at gmail.com
       </A><BR>
    <I>Thu May  7 17:40:20 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003497.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
        <LI>Next message (by thread): <A HREF="003500.html">[squid-users] Best malware/phishing/virus list ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3509">[ date ]</a>
              <a href="thread.html#3509">[ thread ]</a>
              <a href="subject.html#3509">[ subject ]</a>
              <a href="author.html#3509">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've tried using the new server_name acl you provided an example of and
Jason's suggestions for getting the external acl and bumphelper script
working but It only results in everything still being bumped. The website
I'm trying to use as a test for non-bumping, wellsfargo.com, still gets
bumped along with everything else.

Could it be an issue with using the website domain name and the scripts are
not recognizing the website's SNI info as a match to not be bumped?

On Wed, May 6, 2015 at 9:24 PM, Stanford Prescott &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">stan.prescott at gmail.com</A>&gt;
wrote:

&gt;<i> Jason helped me a lot although I am still having trouble getting that
</I>&gt;<i> helper working. It got to the point that only the website I didn't want
</I>&gt;<i> bumped was getting bumped because I had my logic switched in the helper
</I>&gt;<i> script to nothing getting bumped at all. Jason pointed out that I appear to
</I>&gt;<i> be using transparent intercept proxy and that I shouldn't do that until I
</I>&gt;<i> have everything worked out with the regular proxy since bumping is
</I>&gt;<i> difficult to do with transparent proxy.
</I>&gt;<i>
</I>&gt;<i> I have been using transparent proxy (intercept) with the https_port
</I>&gt;<i> declaration with great success so far as seen here
</I>&gt;<i>
</I>&gt;<i> *http_port 192.168.100.1:800 &lt;<A HREF="http://192.168.100.1:800">http://192.168.100.1:800</A>&gt; intercept*
</I>&gt;<i> *https_port 192.168.100.1:808 &lt;<A HREF="http://192.168.100.1:808">http://192.168.100.1:808</A>&gt; intercept
</I>&gt;<i> ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For peek and splice should I not be using intercept?
</I>&gt;<i>
</I>&gt;<i> I will give your suggestions a try and get back to you.
</I>&gt;<i>
</I>&gt;<i> Also, I apologize for inadvertently not including our correspondence in
</I>&gt;<i> the squid-users list. I was just clicking the reply button not realizing it
</I>&gt;<i> wasn't a &quot;reply all&quot;. I think I've got it figured out how to include the
</I>&gt;<i> list in replies.
</I>&gt;<i>
</I>&gt;<i> Thanks Nathan.
</I>&gt;<i>
</I>&gt;<i> Stan
</I>&gt;<i>
</I>&gt;<i> On Wed, May 6, 2015 at 8:15 PM, Nathan Hoad &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nathan at getoffmalawn.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Stan,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yep, I think the server_name acl in 3.5.4 should provide what you want
</I>&gt;&gt;<i> without the need for an external acl now. I haven't used it as the
</I>&gt;&gt;<i> external acl fits my usecase. I imagine doing something like this
</I>&gt;&gt;<i> should work for server_name though...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl sni_exclusions ssl::server_name wellsfargo.com
</I>&gt;&gt;<i> acl tcp_level at_step SslBump1
</I>&gt;&gt;<i> acl client_hello_peeked at_step SslBump2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek tcp_level all
</I>&gt;&gt;<i> ssl_bump splice client_hello_peeked sni_exclusions
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hopefully your other issue with your perl helper hanging has been
</I>&gt;&gt;<i> resolved by Jason's recommendation! Though if this does what you want,
</I>&gt;&gt;<i> you may not need the helper.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, please try to keep messages to the mailing list - this is all
</I>&gt;&gt;<i> information that will help others :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Nathan.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 5 May 2015 at 13:20, Stanford Prescott &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">stan.prescott at gmail.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Hi Nathan. I have decided to try to go ahead and try to get peek and
</I>&gt;&gt;<i> splice
</I>&gt;&gt;<i> &gt; working for Squid on the Smoothwall Express firewall distro since we
</I>&gt;&gt;<i> will
</I>&gt;&gt;<i> &gt; not be able to migrate to Squid 4.x when it debuts. You previously
</I>&gt;&gt;<i> kindly
</I>&gt;&gt;<i> &gt; offered an example of a squid.conf setup for me to try to get it
</I>&gt;&gt;<i> working.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; external_acl_type sni ttl=30 concurrency=X children-max=Y
</I>&gt;&gt;<i> &gt; children-startup=Z %ssl::&gt;sni /path/to/your/helper
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; acl sni_exclusions external sni
</I>&gt;&gt;<i> &gt; acl tcp_level at_step SslBump1
</I>&gt;&gt;<i> &gt; acl client_hello_peeked at_step SslBump2
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump peek tcp_level all
</I>&gt;&gt;<i> &gt; ssl_bump splice client_hello_peeked sni_exclusions
</I>&gt;&gt;<i> &gt; ssl_bump bump all
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Amos says he has back ported a server_name acl with the 3.5.4 release.
</I>&gt;&gt;<i> Does
</I>&gt;&gt;<i> &gt; this now mean that the &quot;external_acl_type&quot; is no longer needed for this
</I>&gt;&gt;<i> sort
</I>&gt;&gt;<i> &gt; of function? Specifically, I want to be able to allow my users to enter
</I>&gt;&gt;<i> &gt; websites that they do not want bumped, like banking websites. I wasn't
</I>&gt;&gt;<i> able
</I>&gt;&gt;<i> &gt; to get the squid.conf and helper script example you provided to work
</I>&gt;&gt;<i> for me.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Does the new server_name acl change how this can be done? Would you be
</I>&gt;&gt;<i> able
</I>&gt;&gt;<i> &gt; to provide a new example for me to try based on this new acl in squid
</I>&gt;&gt;<i> 3.5.4?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Any help is greatly appreciated.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Stan
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On Sun, Apr 12, 2015 at 7:25 PM, Nathan Hoad &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nathan at getoffmalawn.com</A>&gt;
</I>&gt;&gt;<i> &gt; wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Hi Stan,
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; For peek and splice, you need to decide based on the SNI name, not the
</I>&gt;&gt;<i> &gt;&gt; domain name, which for 3.5 means you need to use an external ACL
</I>&gt;&gt;<i> &gt;&gt; helper that processes %ssl::&gt;sni. For 4.0 there will be a server_name
</I>&gt;&gt;<i> &gt;&gt; ACL you can use instead.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; On top of that, you also need to make sure this external ACL helper
</I>&gt;&gt;<i> &gt;&gt; runs at the correct &quot;bump step&quot;, with the at_step ACL, e.g...
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; external_acl_type sni ttl=30 concurrency=X children-max=Y
</I>&gt;&gt;<i> &gt;&gt; children-startup=Z %ssl::&gt;sni /path/to/your/helper
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; acl sni_exclusions external sni
</I>&gt;&gt;<i> &gt;&gt; acl tcp_level at_step SslBump1
</I>&gt;&gt;<i> &gt;&gt; acl client_hello_peeked at_step SslBump2
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; ssl_bump peek tcp_level all
</I>&gt;&gt;<i> &gt;&gt; ssl_bump splice client_hello_peeked sni_exclusions
</I>&gt;&gt;<i> &gt;&gt; ssl_bump bump all
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Hope that helps,
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Nathan.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; On 13 April 2015 at 04:12, Stanford Prescott &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">stan.prescott at gmail.com</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; wrote:
</I>&gt;&gt;<i> &gt;&gt; &gt; I would like to give my users the ability to &quot;not bump&quot; certain
</I>&gt;&gt;<i> sites. I
</I>&gt;&gt;<i> &gt;&gt; &gt; tried to use the examples given on the SSLPeekandSplice wiki page but
</I>&gt;&gt;<i> &gt;&gt; &gt; can't
</I>&gt;&gt;<i> &gt;&gt; &gt; get it to work.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; This is a snippet of my squid.conf file.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; https_port 192.168.10.1:808 intercept ssl-bump
</I>&gt;&gt;<i> &gt;&gt; &gt; generate-host-certificates=on
</I>&gt;&gt;<i> &gt;&gt; &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt;&gt; &gt; cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; http_port 192.168.20.1:800 intercept
</I>&gt;&gt;<i> &gt;&gt; &gt; https_port 192.168.20.1:808 intercept ssl-bump
</I>&gt;&gt;<i> &gt;&gt; &gt; generate-host-certificates=on
</I>&gt;&gt;<i> &gt;&gt; &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt;&gt; &gt; cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; http_port 127.0.0.1:800 intercept
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; sslproxy_cert_error allow all
</I>&gt;&gt;<i> &gt;&gt; &gt; sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;<i> &gt;&gt; &gt; sslproxy_session_cache_size 4 MB
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; acl serverIsBank dstdomain wellsfargo.com
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; ssl_bump server-first all
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; ssl_bump none localhostgreen
</I>&gt;&gt;<i> &gt;&gt; &gt; ssl_bump none localhostpurple
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; ssl_bump splice serverIsBank
</I>&gt;&gt;<i> &gt;&gt; &gt; ssl_bump peek all
</I>&gt;&gt;<i> &gt;&gt; &gt; ssl_bump bump all
</I>&gt;&gt;<i> &gt;&gt; &gt; sslcrtd_program /var/smoothwall/mods/proxy/libexec/ssl_crtd -s
</I>&gt;&gt;<i> &gt;&gt; &gt; /var/smoothwall/mods/proxy/lib/ssl_db -M 4MB
</I>&gt;&gt;<i> &gt;&gt; &gt; sslcrtd_children 5
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; When I start squid I don't get any error messages and all pages, http
</I>&gt;&gt;<i> &gt;&gt; &gt; and
</I>&gt;&gt;<i> &gt;&gt; &gt; https, load properly. The problem is, using the example above, the
</I>&gt;&gt;<i> &gt;&gt; &gt; <A HREF="https://www.wellsfargo.com">https://www.wellsfargo.com</A> website is still getting bumped,
</I>&gt;&gt;<i> evidenced by
</I>&gt;&gt;<i> &gt;&gt; &gt; the
</I>&gt;&gt;<i> &gt;&gt; &gt; appearance of the ssl website in the web proxy access logs. When I
</I>&gt;&gt;<i> don't
</I>&gt;&gt;<i> &gt;&gt; &gt; have ssl_bump enabled then no https websites appear in the access
</I>&gt;&gt;<i> logs,
</I>&gt;&gt;<i> &gt;&gt; &gt; as
</I>&gt;&gt;<i> &gt;&gt; &gt; it should be. But, enabling ssl_bump and peek and splice, web sites
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> &gt;&gt; &gt; I
</I>&gt;&gt;<i> &gt;&gt; &gt; am trying not to bump still seem to be getting bumped.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Any suggestions on how to properly &quot;not bump&quot; certain websites.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Thanks,
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Stan
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; _______________________________________________
</I>&gt;&gt;<i> &gt;&gt; &gt; squid-users mailing list
</I>&gt;&gt;<i> &gt;&gt; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt;&gt; &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150507/92906310/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150507/92906310/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003497.html">[squid-users] squid 3.5.3 can't get peek and splice to not bump certain sites
</A></li>
	<LI>Next message (by thread): <A HREF="003500.html">[squid-users] Best malware/phishing/virus list ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3509">[ date ]</a>
              <a href="thread.html#3509">[ thread ]</a>
              <a href="subject.html#3509">[ subject ]</a>
              <a href="author.html#3509">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
