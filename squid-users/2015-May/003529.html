<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Client IP spoofing via squid proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20IP%20spoofing%20via%20squid%20proxy&In-Reply-To=%3CHKNPR03MB19328B5DD73DB75C44EA197A1DE0%40HKNPR03MB193.apcprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003506.html">
   <LINK REL="Next"  HREF="003530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Client IP spoofing via squid proxy</H1>
    <B>Ambadas Hibare</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20IP%20spoofing%20via%20squid%20proxy&In-Reply-To=%3CHKNPR03MB19328B5DD73DB75C44EA197A1DE0%40HKNPR03MB193.apcprd03.prod.outlook.com%3E"
       TITLE="[squid-users] Client IP spoofing via squid proxy">ambadasvh at teledna.com
       </A><BR>
    <I>Fri May  8 13:56:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003506.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003530.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3529">[ date ]</a>
              <a href="thread.html#3529">[ thread ]</a>
              <a href="subject.html#3529">[ subject ]</a>
              <a href="author.html#3529">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

It's happening as you said:

the packets doing this:
 client -----&gt; Squid -SYN-&gt; server
 client &lt;-------------ACK-- server
 client -RST-&gt; Squid 

There's a firewall in between squid &amp; web server which is directly sending SYN-ACK to client instead of squid.

But in my requirement, the clients are configured with IP &amp; Port. Is there any possible way/approach by which I can make client IP hide towards web server?

Any help appreciated


Regards,
Ambadas


-----Original Message-----
From: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>] 
Sent: 07 May 2015 18:08
To: Ambadas Hibare; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Client IP spoofing via squid proxy

On 7/05/2015 6:09 p.m., Ambadas Hibare wrote:
&gt;<i> HI,
</I>&gt;<i> 
</I>&gt;<i> Client IP: 172.16.5.110
</I>&gt;<i> Client Mac: 00:23:7D:E8:AC:C4
</I>&gt;<i> 
</I>&gt;<i> Squid Box:
</I>&gt;<i> 
</I>&gt;<i> eth0 IP: 172.16.5.102
</I>&gt;<i> eth0 Mac: 18:A9:05:3C:12:E4
</I>&gt;<i> 
</I>&gt;<i> eth1 IP: 10.0.0.102
</I>&gt;<i> eth1 Mac: 18:A9:05:3C:12:E6
</I>&gt;<i> 
</I>&gt;&gt;<i> &quot;Your &quot;ip route&quot; rules use eth1, but your rp_filter settings only change eth0. Also your iptables rules do not distinguish by ethN.&quot;
</I>&gt;<i> 
</I>&gt;<i> Yes. Should that setting be applied on both eths' or only the one facing the client?
</I>
The one facing the *server* at minimum. Doing it on both wont hurt for experimenting. But when this is working try setting the client-facing NIC off again.


&gt;<i> Also want to know if it's possible to do tproxy setup with just one eth at squid box?
</I>
Of course. You just have to configure the packet routing explicitly on the router the Squid box is connected to as well as the Squid box itself. To prevent server responses (SYN ACK etc) being sent to the client when they should go to Squid.

&gt;<i> 
</I>
&gt;&gt;<i> &quot;Your trace shows the MAC address *:c4 contacting Squid (MAC address
</I>*:e4) and delivering an HTTP request. Squid (*:e4) then contacts the remote server be sending &gt; a TCP SYN packet ... which the MAC address
*:c4 rejects.&quot;
&gt;<i> 
</I>&gt;<i> In trace it shows squid (*:e4) (packet# 83) is contacting the web
</I>server (google.com) via client IP (172.16.5.110). So it's getting spoofed!? But not able to understand why client is sending RST to google (packet# 84) just after that &amp; response


Because one of the SYN (from Squid) or SYN-ACK packet (reply from
server) is arriving at the client when it should have been delivered elsewhere.


the packets doing this:
 client -----&gt; Squid -SYN-&gt; server
 client &lt;-------------ACK-- server
 client -RST-&gt; Squid

or this:
 client -----&gt; Squid -SYN-\
 client &lt;-----------------/
 client -RST-&gt; Squid


&gt;<i> PS. The default gateway for client is squid box IP (eth1). 
</I>
The part routing traffic from client&lt;-&gt;Squid is working. The part Squid&lt;-&gt;server is going wrong.

Amos
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003506.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003530.html">[squid-users] Client IP spoofing via squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3529">[ date ]</a>
              <a href="thread.html#3529">[ thread ]</a>
              <a href="subject.html#3529">[ subject ]</a>
              <a href="author.html#3529">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
