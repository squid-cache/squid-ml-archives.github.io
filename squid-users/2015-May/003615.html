<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5: internal-static icons on ftp:// requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%3A%20internal-static%20icons%20on%20ftp%3A//%20requests&In-Reply-To=%3C20150519062917.GA51255%40bali%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003681.html">
   <LINK REL="Next"  HREF="003617.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5: internal-static icons on ftp:// requests</H1>
    <B>Andre Albsmeier</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%3A%20internal-static%20icons%20on%20ftp%3A//%20requests&In-Reply-To=%3C20150519062917.GA51255%40bali%3E"
       TITLE="[squid-users] Squid 3.5: internal-static icons on ftp:// requests">Andre.Albsmeier at siemens.com
       </A><BR>
    <I>Tue May 19 06:29:17 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003681.html">[squid-users] Squid 3.3 to 3.5 url_rewrite_program changes
</A></li>
        <LI>Next message (by thread): <A HREF="003617.html">[squid-users] Squid 3.5: internal-static icons on ftp://	requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3615">[ date ]</a>
              <a href="thread.html#3615">[ thread ]</a>
              <a href="subject.html#3615">[ subject ]</a>
              <a href="author.html#3615">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>When browsing e.g.

<A HREF="ftp://ftp.mozilla.org/pub/thunderbird/releases/31.5.0/win32/en-GB/">ftp://ftp.mozilla.org/pub/thunderbird/releases/31.5.0/win32/en-GB/</A>

I miss the internally generated icons and receive an error message
in the logs:

2015/05/17 20:03:44 kid1| internalStart: unknown request:
GET /squid-internal-static/icons/silk/arrow_up.png HTTP/1.1
Host: ftp.mozilla.org
User-Agent: Mozilla/5.0 (X11; FreeBSD i386; rv:31.0) Gecko/20100101 Firefox/31.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: de-de,de;q=0.8,en-gb;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
DNT: 1
Connection: keep-alive


The corresponding request for getting the icon is

 <A HREF="ftp://ftp.mozilla.org/squid-internal-static/icons/silk/application.png">ftp://ftp.mozilla.org/squid-internal-static/icons/silk/application.png</A>

and this fails. If I (manually) convert the request into a http request

 <A HREF="http://ftp.mozilla.org/squid-internal-static/icons/silk/application.png">http://ftp.mozilla.org/squid-internal-static/icons/silk/application.png</A>

the icon gets loaded (this works as global_internal_static is set to on).
Shouldn't all internal-static request be http instead of ftp? I have now
patched my squid so it enforces http for internal stuff with this patch:

--- src/client_side.cc.ORI	2015-03-28 11:58:05.000000000 +0100
+++ src/client_side.cc	2015-05-18 19:38:20.982160000 +0200
@@ -2683,16 +2683,18 @@
                    ':' &lt;&lt; request-&gt;port);
             http-&gt;flags.internal = true;
         } else if (Config.onoff.global_internal_static &amp;&amp; internalStaticCheck(request-&gt;urlpath.termedBuf())) {
             debugs(33, 2, &quot;internal URL found: &quot; &lt;&lt; request-&gt;url.getScheme() &lt;&lt; &quot;://&quot; &lt;&lt; request-&gt;GetHost() &lt;&lt;
                    ':' &lt;&lt; request-&gt;port &lt;&lt; &quot; (global_internal_static on)&quot;);
             request-&gt;SetHost(internalHostname());
             request-&gt;port = getMyPort();
             http-&gt;flags.internal = true;
+request-&gt;url.setScheme( AnyP::PROTO_HTTP );
+debugs(33, 2, &quot;NEW internal URL: &quot; &lt;&lt; request-&gt;url.getScheme() &lt;&lt; &quot;://&quot; &lt;&lt; request-&gt;GetHost() &lt;&lt; ':' &lt;&lt; request-&gt;port &lt;&lt; &quot; (global_internal_static on)&quot;);
         } else
             debugs(33, 2, &quot;internal URL found: &quot; &lt;&lt; request-&gt;url.getScheme() &lt;&lt; &quot;://&quot; &lt;&lt; request-&gt;GetHost() &lt;&lt;
                    ':' &lt;&lt; request-&gt;port &lt;&lt; &quot; (not this proxy)&quot;);
     }
 
     if (http-&gt;flags.internal)
         request-&gt;login[0] = '\0';
 

and now the icons on <A HREF="ftp://ftp.mozilla.org/">ftp://ftp.mozilla.org/</A> appear but I wonder if it
is really needed to patch squid for that... ;-).

Thanks,

	-Andre

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003681.html">[squid-users] Squid 3.3 to 3.5 url_rewrite_program changes
</A></li>
	<LI>Next message (by thread): <A HREF="003617.html">[squid-users] Squid 3.5: internal-static icons on ftp://	requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3615">[ date ]</a>
              <a href="thread.html#3615">[ thread ]</a>
              <a href="subject.html#3615">[ subject ]</a>
              <a href="author.html#3615">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
