<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy chain question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20chain%20question&In-Reply-To=%3C555EA006.7080105%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003674.html">
   <LINK REL="Next"  HREF="003697.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy chain question</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20chain%20question&In-Reply-To=%3C555EA006.7080105%40treenet.co.nz%3E"
       TITLE="[squid-users] Proxy chain question">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 22 03:18:30 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003674.html">[squid-users] Proxy chain question
</A></li>
        <LI>Next message (by thread): <A HREF="003697.html">[squid-users] Proxy chain question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3679">[ date ]</a>
              <a href="thread.html#3679">[ thread ]</a>
              <a href="subject.html#3679">[ subject ]</a>
              <a href="author.html#3679">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/05/2015 4:58 a.m., Lucas van Braam van Vloten wrote:
&gt;<i> Hello list,
</I>&gt;<i> 
</I>&gt;<i> In my network I have a Microsoft TMG proxy server for http(s) access to
</I>&gt;<i> internet.
</I>&gt;<i> This TMG server also serves as a reverse proxy to channel incoming
</I>&gt;<i> traffic to a Squid reverse proxy in the internal network (yes, two
</I>&gt;<i> reverse proxies in a line)
</I>
Any particular reason? It may prevent Squid being able to do what you want.

&gt;<i> 
</I>&gt;<i> This Squid server is currently configured as a reverse proxy to allow
</I>&gt;<i> traffic from internet to a number of webservices that run on an internal
</I>&gt;<i> server.
</I>&gt;<i> 
</I>&gt;<i> Now I want to add a function to the squid server, in addition to the
</I>&gt;<i> existing function. It should serve as a proxy to allow a client on the
</I>&gt;<i> internal network to access a web servoce on internet.
</I>&gt;<i> So, put simply, the traffic goes like this:
</I>&gt;<i> Internal client -&gt; Squid Proxy -&gt; TMG proxy -&gt; internet webservice
</I>
&gt;<i>From that diagram I'm a little doubtful that reverse-proxy is the right
</I>way to do it here. Proxy at the client end of the connectivity are
usually forward- or interceptor- proxy.


&gt;<i> 
</I>&gt;<i> The reason to use this configuration is because the internet webservice
</I>&gt;<i> requires a client certificate for authentication, and TMG is not able to
</I>&gt;<i> handle this.
</I>
Squid will not be able to handle this either unless it is directly
connecting to that service without the TMG in the way.

Because TLS is point-to-point security protocol, any proxy agent in the
middle must terminate the clients TLS and start its own server
connection for the next hop. Squid does not (yet) support sending
CONNECT over a peer proxy to bypass the TMG.

So in your current setup Squid sending the client cert will be sending
it to to authenticate with the *TMG* - not the web service.


&gt;<i> So now I am trying to configure this on my Squid server. I wish to make
</I>&gt;<i> my configuration as restrictive as possible. But I am new to the Squid
</I>&gt;<i> configuration, and I could use some help.
</I>&gt;<i> 
</I>&gt;<i> So basically, I want the following:
</I>&gt;<i> 1. The client makes a http connection to my Squid proxy
</I>&gt;<i> 2. The Squid proxy initiates the client certificate authenticated
</I>&gt;<i> connection to the internet webservice
</I>&gt;<i> 3. The connection from the Squid proxy to Internet uses the TMG proxy.
</I>&gt;<i> 
</I>&gt;<i> I do not wish to use any form of caching on my Squid server.
</I>&gt;<i> 
</I>&gt;<i> I considered using a configuration similar to my reverse proxy
</I>&gt;<i> configuration, using the following structure:
</I>&gt;<i> (this configuration works)
</I>&gt;<i> 
</I>&gt;<i> =====================
</I>&gt;<i> 
</I>&gt;<i> # Designate a port and SSL config for this specific webservice
</I>&gt;<i> # Local server IP is 192.168.0.1, traffic comes in through the TMG
</I>&gt;<i> https_port 192.168.0.1:1443 accel
</I>&gt;<i> defaultsite=webservice.exposed.address.com vhost &lt;SSL stuff&gt;
</I>&gt;<i> 
</I>&gt;<i> # enforce use of https
</I>&gt;<i> acl webapp_SITES dstdomain webservice.exposed.address.com
</I>&gt;<i> http_access deny HTTP webapp_SITES
</I>&gt;<i> http_access allow webapp_SITES
</I>&gt;<i> 
</I>&gt;<i> # Configure the reverse proxy for clients that connect to the external
</I>&gt;<i> (exposed) address
</I>&gt;<i> acl webapp_URL url_regex ^<A HREF="https://webservice.exposed.address.com">https://webservice.exposed.address.com</A>
</I>&gt;<i> cache_peer internal.server.lan parent 8080 0 no-query no-digest
</I>&gt;<i> originserver login=PASS name=webservice_APP
</I>&gt;<i> cache_peer_access webservice_APP allow webapp_URL
</I>&gt;<i> cache_peer_access webservice_APP deny all
</I>&gt;<i> 
</I>&gt;<i> =====================
</I>&gt;<i> 
</I>&gt;<i> So if I use this for my new purpose, I assume that the cache_peer would
</I>&gt;<i> be the internet webservice address, and I could use the sslcert option
</I>&gt;<i> to make it use the client certificate. Something like this:
</I>&gt;<i> 
</I>&gt;<i> =====================
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.0.1:8080 accel defaultsite=squid.server.lan vhost
</I>&gt;<i> acl webapp_URL url_regex ^<A HREF="http://squid.server.lan">http://squid.server.lan</A>
</I>&gt;<i> cache_peer webservice.somewhere.on.internet.com parent 8443 0 no-query
</I>&gt;<i> no-digest originserver sslkey=/path/to/ssl/key name=webservice_APP
</I>&gt;<i> cache_peer_access webservice_APP allow webapp_URL
</I>&gt;<i> cache_peer_access webservice_APP deny all
</I>&gt;<i> 
</I>&gt;<i> =====================
</I>
That is the correct way to do it outbound from Squid. But the catch as
mentioned above is where the TLS link gets terminated (the TMG or the
web service).

Since the TMG is a reverse-proxy the DNS records for the cache_peer
domain name points at the TMG instead of the Internet service. You have
to have the cache_peer directly going to the server which uses/requires
the client certificate. Which means using IP or if available the
services own host name to avoid the TMG.

Which cycles back to that first question I had at the top about why the
TMG exists at all. You may or may not be able to do this without a full
topology redesign.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003674.html">[squid-users] Proxy chain question
</A></li>
	<LI>Next message (by thread): <A HREF="003697.html">[squid-users] Proxy chain question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3679">[ date ]</a>
              <a href="thread.html#3679">[ thread ]</a>
              <a href="subject.html#3679">[ subject ]</a>
              <a href="author.html#3679">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
