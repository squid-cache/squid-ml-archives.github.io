<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid with proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20proxy&In-Reply-To=%3C555F1255.5000702%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003694.html">
   <LINK REL="Next"  HREF="003698.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid with proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20proxy&In-Reply-To=%3C555F1255.5000702%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid with proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 22 11:26:13 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003694.html">[squid-users] Zyxel USG20 and Squid 3.3
</A></li>
        <LI>Next message (by thread): <A HREF="003698.html">[squid-users] Squid with proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3690">[ date ]</a>
              <a href="thread.html#3690">[ thread ]</a>
              <a href="subject.html#3690">[ subject ]</a>
              <a href="author.html#3690">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/05/2015 10:35 p.m., Silvio Siefke wrote:
&gt;<i> On Fri, 22 May 2015 15:39:19 +1200 Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I dont know why you should have to. ziproxy should be perfectly
</I>&gt;&gt;<i> capable of contacting Internet services to respond to the requests
</I>&gt;&gt;<i> sent from Squid.
</I>&gt;<i> 
</I>&gt;<i> Yes it works but im not sure is right, when NextProxy in ziproxy.conf
</I>&gt;<i> is not set. When saw the log all work, but in all tutorials which read
</I>&gt;<i> they say ziproxy.conf need set NextProxy=&quot;127.0.0.1&quot; for &quot;routing&quot; back
</I>&gt;<i> to squid. But so it work all without NextProxy. What is now correct?
</I>&gt;<i> 
</I>
Without NextProxy is correct if ziproxy is on the &quot;outside&quot; of Squid.
Like so:

 client -&gt; Squid -&gt; ziproxy -&gt; Internet


If you set ziproxy to pass *requests* to Squid, the traffic will enter a
loop:
  client -&gt; Squid -&gt; ziproxy -&gt; Squid -&gt; ziproxy -&gt; ...

Via header would have protected against that loop by aborting the
traffic. But you disabled via. So the only thing preventing your setup
DoS'ing itself by consuming all available TCP ports on the mahine is
that login popup. Ouch.

&gt;<i> 
</I>&gt;&gt;<i> I am not quite understanding what you are talking about auth for. So
</I>&gt;&gt;<i> can't answer that question. Hopefully the above answer is enough to
</I>&gt;&gt;<i> solve your problem though.
</I>&gt;<i> 
</I>&gt;<i> Squid use auth for connecting with it, when i has activated NextProxy in
</I>&gt;<i> ziproxy.conf then Browser ask and ask for login stuff. When not activated
</I>&gt;<i> NextProxy in ziproxy.conf then one time come login window and after login
</I>&gt;<i> all work. But what is now right, set NextProxy or not. But self when set 
</I>&gt;<i> NextProxy in ziproxy.conf then squid can not ask for login to ziproxy,  cause
</I>&gt;<i> localhost has free traffic or not?
</I>
In your squid.conf all traffic requires authenticating. Nothing is
allowed through without it. Although anything from localhost is allowed
to send wrong credentials and get through :-( .


Your rules:
&gt;<i> 
</I>&gt;<i> # http access
</I>&gt;<i> http_access allow checkpw all
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny ads
</I>&gt;<i> http_access deny all
</I>
- &quot;deny ads&quot; is not useful like this, anything getting to that check
will also be blocked by the &quot;deny all&quot; which follows it and is a faster
check.

- also missing the basic HTTP abuse and DoS security protections.

To let localhost I would write them like this:

 # basic security potections.
 # To let special ports through; check carefully its not abuse
 # then adjust Safe_ports and SSL_ports appropriately
 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_Ports

 # To use the deny ads ACL it would go here in the ordering,
 # before the allow rules.
 http_access deny ads

 # localhost does not require authentication
 http_access allow localhost

 # manager access only permitted from localhost
 http_access deny !localhost manager

 # anyone with a valid auth credentials is allowed
 http_access allow checkpw

 http_access deny all


You will need to re-add the CONNECT, Safe_ports and SSL_Ports ACL
definitions from the default config.


You dont really need to exempt localhost from authentication. But that
is your choice.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003694.html">[squid-users] Zyxel USG20 and Squid 3.3
</A></li>
	<LI>Next message (by thread): <A HREF="003698.html">[squid-users] Squid with proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3690">[ date ]</a>
              <a href="thread.html#3690">[ thread ]</a>
              <a href="subject.html#3690">[ subject ]</a>
              <a href="author.html#3690">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
