<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl-bump deep dive (properly creating certs)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28properly%20creating%20certs%29&In-Reply-To=%3C1432501589.3706.1.camel%40JamesiMac%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003715.html">
   <LINK REL="Next"  HREF="003723.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl-bump deep dive (properly creating certs)</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28properly%20creating%20certs%29&In-Reply-To=%3C1432501589.3706.1.camel%40JamesiMac%3E"
       TITLE="[squid-users] Ssl-bump deep dive (properly creating certs)">jlay at slave-tothe-box.net
       </A><BR>
    <I>Sun May 24 21:06:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003715.html">[squid-users] Ssl-bump deep dive (properly creating certs)
</A></li>
        <LI>Next message (by thread): <A HREF="003723.html">[squid-users] Ssl-bump deep dive (properly creating certs)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3716">[ date ]</a>
              <a href="thread.html#3716">[ thread ]</a>
              <a href="subject.html#3716">[ subject ]</a>
              <a href="author.html#3716">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2015-05-25 at 08:48 +1200, Jason Haar wrote:
&gt;<i> On 25/05/15 04:25, James Lay wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; My first question is about properly creating the certs.  Looking at:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit">http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; this mentions using crtd, but as I understand it, crtd isn't
</I>&gt;<i> &gt; supported when using transparent proxies.  So, with no crtd, as I
</I>&gt;<i> &gt; understand it this is what I'll need:
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I don't know where you got that from, but that's not true. I think you
</I>&gt;<i> are confusing the issue that when squid is used as a transparent HTTPS
</I>&gt;<i> proxy, it lacks the &quot;easy&quot; hostname details that a formal (ie
</I>&gt;<i> non-transparent) proxy has. ie when a browser asks for a secure
</I>&gt;<i> website via a formal proxy, it sends
</I>&gt;<i> 
</I>&gt;<i> CONNECT github.com:443 HTTP/1.1
</I>&gt;<i> 
</I>&gt;<i> So squid knows *in advance* the server is called &quot;github.com&quot;. So it
</I>&gt;<i> connects to github.com, downloads the public key and then uses crtd to
</I>&gt;<i> create a clone of it - identical except that it's signed by your
</I>&gt;<i> self-created Squid CA instead of Verisign/whatever
</I>&gt;<i> 
</I>&gt;<i> Compare that with transparent proxy mode, where all that squid knows
</I>&gt;<i> is that a browser has had it's outbound tcp port 443 traffic to
</I>&gt;<i> 192.30.252.128 redirected onto it, so it doesn't know that is
</I>&gt;<i> github.com. If you are using squid-3.4 or less, that's all there is to
</I>&gt;<i> it - there's no way to figure out the cert name in a guaranteed
</I>&gt;<i> fashion (there are hacks, but my own experience is that they can only
</I>&gt;<i> work up to 95% of the time - and break for some of the largest sites).
</I>&gt;<i> With squid-3.5 there is &quot;peek&quot; - which means squid can let the initial
</I>&gt;<i> few packets through (ie act like &quot;splice&quot;) - which is enough to see
</I>&gt;<i> the client send the SNI request to the https server and get the reply.
</I>&gt;<i> So &quot;peek&quot; allows squid to learn about the true server name of the
</I>&gt;<i> https server. At that point *I think* squid creates a forged cert,
</I>&gt;<i> then creates a new connection to the server, then links together the
</I>&gt;<i> existing client tcp channel with the new proxy-&gt;server tcp channel and
</I>&gt;<i> carries on intercepting (I think that's the outcome - there would have
</I>&gt;<i> to be some extra smoke-n-mirrors in there to make that happen)
</I>&gt;<i> 
</I>&gt;<i> In pseudo-code, it looks like this
</I>&gt;<i> 
</I>&gt;<i> if http_port and &quot;CONNECT (.*) HTTP&quot; then sni_name=$1
</I>&gt;<i> else if https_port and &quot;peek&quot; then sni_name=find_sni($ipaddress)
</I>&gt;<i> else if https_port then sni_name=$ipaddress
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When all is said and done, transparent HTTPS intercept is the very
</I>&gt;<i> last thing you should be working on. You need to gets squid working
</I>&gt;<i> 100% as a formal proxy - and only then start looking at making that
</I>&gt;<i> work in transparent mode. And you *definitely* want ssl_crtd. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Cheers
</I>&gt;<i> 
</I>&gt;<i> Jason Haar
</I>&gt;<i> Corporate Information Security Manager, Trimble Navigation Ltd.
</I>&gt;<i> Phone: +1 408 481 8171
</I>&gt;<i> PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

Thanks for the great response Jason...I appreciate it.  I think maybe I
misread this:

<A HREF="http://wiki.squid-cache.org/Features/DynamicSslCert">http://wiki.squid-cache.org/Features/DynamicSslCert</A>

&quot;While SslBump itself works fine in transparent redirection environments
(e.g. those using WCCP or iptables), dynamic certificate generation does
not: To generate the certificate dynamically, Squid must know the server
domain name. That information is not available at the time the HTTPS
client TCP connection is intercepted and bumped. Currently, you cannot
use dynamic certificate generation for transparent connections until
bump-server-first is supported.&quot;

Is this no longer accurate with now that peek/splice has been
implemented?

Thank you.

James
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150524/30f22ebb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150524/30f22ebb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003715.html">[squid-users] Ssl-bump deep dive (properly creating certs)
</A></li>
	<LI>Next message (by thread): <A HREF="003723.html">[squid-users] Ssl-bump deep dive (properly creating certs)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3716">[ date ]</a>
              <a href="thread.html#3716">[ thread ]</a>
              <a href="subject.html#3716">[ subject ]</a>
              <a href="author.html#3716">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
