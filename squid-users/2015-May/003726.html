<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [PATCH] SSL: Add suport for EECDH and disable	client-initiated renegotiation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20SSL%3A%20Add%20suport%20for%20EECDH%20and%20disable%0A%09client-initiated%20renegotiation&In-Reply-To=%3C556307C6.3070300%40ufscar.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003741.html">
   <LINK REL="Next"  HREF="003727.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [PATCH] SSL: Add suport for EECDH and disable	client-initiated renegotiation</H1>
    <B>Paulo Matias</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20SSL%3A%20Add%20suport%20for%20EECDH%20and%20disable%0A%09client-initiated%20renegotiation&In-Reply-To=%3C556307C6.3070300%40ufscar.br%3E"
       TITLE="[squid-users] [PATCH] SSL: Add suport for EECDH and disable	client-initiated renegotiation">matias at ufscar.br
       </A><BR>
    <I>Mon May 25 11:30:14 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003741.html">[squid-users] Alternative ways of tracking users on unauthenticated proxy
</A></li>
        <LI>Next message (by thread): <A HREF="003727.html">[squid-users] [PATCH] SSL: Add suport for EECDH and disable client-initiated renegotiation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3726">[ date ]</a>
              <a href="thread.html#3726">[ thread ]</a>
              <a href="subject.html#3726">[ subject ]</a>
              <a href="author.html#3726">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Sorry for getting this sent to squid-users instead of the adequate
mailing list for patches (squid-dev). We have tried to send the
patch to squid-dev without a subscription (as recommended in
<A HREF="http://www.squid-cache.org/Support/mailing-lists.html#squid-dev">http://www.squid-cache.org/Support/mailing-lists.html#squid-dev</A>),
but perhaps the message did not get to the list administrator.

This patch implements two different changes in SSL support:

* Adds support for Ephemeral Elliptic Curve Diffie-Hellman (EECDH)
  key exchange, which allows for forward secrecy with better
  performance than traditional ephemeral DH.

* Disables client-initiated renegotiation, mitigating a DoS attack
  which might be possible with some versions of the OpenSSL library.
  We have been warned about this when testing our service with
  the Qualys SSL Test (<A HREF="https://www.ssllabs.com/ssltest">https://www.ssllabs.com/ssltest</A>) back when
  it was running in a Debian wheezy system.
  Further information is available at:
  <A HREF="https://community.qualys.com/blogs/securitylabs/2011/10/31/tls-renegotiation-and-denial-of-service-attacks">https://community.qualys.com/blogs/securitylabs/2011/10/31/tls-renegotiation-and-denial-of-service-attacks</A>
  Our solution is similar to the one adopted in pureftpd:
  <A HREF="https://github.com/jedisct1/pure-ftpd/blob/549e94aaa093a48622efd6d91fdfb3a4236c13f4/src/tls.c#L106">https://github.com/jedisct1/pure-ftpd/blob/549e94aaa093a48622efd6d91fdfb3a4236c13f4/src/tls.c#L106</A>

We have been running Squid 3.4.8 in production with a backported
patch for two months. So far, we have no complaints from the users
(60 to 100 users per day) and the server is running stably.

We would be very happy if we could get this integrated into
Squid's source code, so please provide us feedback with any
suggestions.

Our https_port directive also follows, to serve as an example
configuration:

https_port 3443
  cert=/etc/ssl/private/proxy.crt
  key=/etc/ssl/private/proxy.key
  options=NO_SSLv3,
          No_Compression,
          SINGLE_DH_USE,
          SINGLE_ECDH_USE,
          CIPHER_SERVER_PREFERENCE
  dhparams=/etc/ssl/dhparam/dh2048.pem
  eecdhcurve=prime256v1
  cipher=ECDHE-ECDSA-CHACHA20-POLY1305:
         ECDHE-RSA-CHACHA20-POLY1305:
         DHE-RSA-CHACHA20-POLY1305:
         EECDH+ECDSA+AESGCM:
         EECDH+aRSA+AESGCM:
         EDH+aRSA+AESGCM:
         EECDH+ECDSA+SHA384:
         EECDH+aRSA+SHA384:
         EDH+aRSA+SHA384:
         EECDH+ECDSA+SHA256:
         EECDH+aRSA+SHA256:
         EDH+aRSA+SHA256:
         EECDH:EDH+aRSA:
         !RC4:!aNULL:!eNULL:!LOW:!3DES:
         !MD5:!EXP:!PSK:!SRP:!DSS

Best regards,
Paulo Matias


-------------- next part --------------
=== modified file 'doc/release-notes/release-4.sgml'
--- doc/release-notes/release-4.sgml	2015-03-28 11:12:46 +0000
+++ doc/release-notes/release-4.sgml	2015-05-20 12:28:18 +0000
@@ -133,6 +133,8 @@
 	&lt;tag&gt;https_port&lt;/tag&gt;
 	&lt;p&gt;All &lt;em&gt;version=&lt;/em&gt; &lt;em&gt;option=&lt;/em&gt; values for SSLv2
 	   configuration or disabling have been removed.
+	&lt;p&gt;New parameter &lt;em&gt;eecdhcurve&lt;/em&gt; for specifying an
+	   elliptic curve for ephemeral ECDH key exchange.
 	&lt;p&gt;Manual squid.conf update may be required on upgrade.
 
 	&lt;tag&gt;sslcrtd_children&lt;/tag&gt;

=== modified file 'src/anyp/PortCfg.cc'
--- src/anyp/PortCfg.cc	2015-01-14 17:10:20 +0000
+++ src/anyp/PortCfg.cc	2015-05-19 14:46:04 +0000
@@ -53,6 +53,7 @@
     capath(NULL),
     crlfile(NULL),
     dhfile(NULL),
+    eecdhcurve(NULL),
     sslflags(NULL),
     sslContextSessionId(NULL),
     generateHostCertificates(false),
@@ -94,6 +95,7 @@
     safe_free(capath);
     safe_free(crlfile);
     safe_free(dhfile);
+    safe_free(eecdhcurve);
     safe_free(sslflags);
     safe_free(sslContextSessionId);
 #endif
@@ -139,6 +141,8 @@
         b-&gt;crlfile = xstrdup(crlfile);
     if (dhfile)
         b-&gt;dhfile = xstrdup(dhfile);
+    if (eecdhcurve)
+        b-&gt;eecdhcurve = xstrdup(eecdhcurve);
     if (sslflags)
         b-&gt;sslflags = xstrdup(sslflags);
     if (sslContextSessionId)

=== modified file 'src/anyp/PortCfg.h'
--- src/anyp/PortCfg.h	2015-01-13 07:25:36 +0000
+++ src/anyp/PortCfg.h	2015-05-19 14:46:04 +0000
@@ -78,6 +78,7 @@
     char *capath;
     char *crlfile;
     char *dhfile;
+    char *eecdhcurve;
     char *sslflags;
     char *sslContextSessionId; ///&lt; &quot;session id context&quot; for staticSslContext
     bool generateHostCertificates; ///&lt; dynamically make host cert for sslBump

=== modified file 'src/cache_cf.cc'
--- src/cache_cf.cc	2015-05-15 12:50:09 +0000
+++ src/cache_cf.cc	2015-05-19 14:46:04 +0000
@@ -3606,6 +3606,9 @@
     } else if (strncmp(token, &quot;dhparams=&quot;, 9) == 0) {
         safe_free(s-&gt;dhfile);
         s-&gt;dhfile = xstrdup(token + 9);
+    } else if (strncmp(token, &quot;eecdhcurve=&quot;, 11) == 0) {
+        safe_free(s-&gt;eecdhcurve);
+        s-&gt;eecdhcurve = xstrdup(token + 11);
     } else if (strncmp(token, &quot;sslflags=&quot;, 9) == 0) {
         safe_free(s-&gt;sslflags);
         s-&gt;sslflags = xstrdup(token + 9);
@@ -3829,6 +3832,9 @@
     if (s-&gt;dhfile)
         storeAppendPrintf(e, &quot; dhparams=%s&quot;, s-&gt;dhfile);
 
+    if (s-&gt;eecdhcurve)
+        storeAppendPrintf(e, &quot; eecdhcurve=%s&quot;, s-&gt;eecdhcurve);
+
     if (s-&gt;sslflags)
         storeAppendPrintf(e, &quot; sslflags=%s&quot;, s-&gt;sslflags);
 

=== modified file 'src/cf.data.pre'
--- src/cf.data.pre	2015-05-15 12:50:09 +0000
+++ src/cf.data.pre	2015-05-20 12:23:53 +0000
@@ -2122,6 +2122,11 @@
 				      Always create a new key when using
 				      temporary/ephemeral DH key exchanges
 
+			    SINGLE_ECDH_USE
+				      Enable ephemeral ECDH key exchange.
+				      The adopted curve should be specified
+				      using the eecdhcurve option.
+
 			    SSL_OP_NO_TICKET
 				      Disable use of RFC5077 session tickets.
 				      Some servers may have problems
@@ -2153,6 +2158,9 @@
 	   dhparams=	File containing DH parameters for temporary/ephemeral
 			DH key exchanges.
 
+	   eecdhcurve=	Elliptic Curve used for ephemeral ECDH. Supported curves
+			can be listed using &quot;openssl ecparam -list_curves&quot;.
+
 	   sslflags=	Various flags modifying the use of SSL:
 			    DELAYED_AUTH
 				Don't request client certificates

=== modified file 'src/ssl/support.cc'
--- src/ssl/support.cc	2015-05-08 11:18:30 +0000
+++ src/ssl/support.cc	2015-05-19 14:50:44 +0000
@@ -472,6 +472,11 @@
         &quot;NO_TICKET&quot;, SSL_OP_NO_TICKET
     },
 #endif
+#if SSL_OP_SINGLE_ECDH_USE
+    {
+        &quot;SINGLE_ECDH_USE&quot;, SSL_OP_SINGLE_ECDH_USE
+    },
+#endif
     {
         &quot;&quot;, 0
     },
@@ -824,11 +829,46 @@
 }
 
 static bool
+configureSslEECDH(SSL_CTX *sslContext, const char *curve)
+{
+    bool ok = true;
+#if OPENSSL_VERSION_NUMBER &gt;= 0x0090800fL
+#ifndef OPENSSL_NO_ECDH
+    int nid = OBJ_sn2nid(curve);
+    if (!nid)
+        return false;
+
+    EC_KEY *ecdh = EC_KEY_new_by_curve_name(nid);
+    if (ecdh == NULL)
+        return false;
+
+    ok = SSL_CTX_set_tmp_ecdh(sslContext, ecdh) != 0;
+    EC_KEY_free(ecdh);
+#endif
+#endif
+    return ok;
+}
+
+static void
+ssl_info_cb(const SSL *ssl, int where, int ret)
+{
+    (void)ret;
+#ifdef SSL3_FLAGS_NO_RENEGOTIATE_CIPHERS
+    if ((where &amp; SSL_CB_HANDSHAKE_DONE) != 0) {
+        // disable renegotiation (CVE-2009-3555)
+        ssl-&gt;s3-&gt;flags |= SSL3_FLAGS_NO_RENEGOTIATE_CIPHERS;
+    }
+#endif
+}
+
+static bool
 configureSslContext(SSL_CTX *sslContext, AnyP::PortCfg &amp;port)
 {
     int ssl_error;
     SSL_CTX_set_options(sslContext, port.sslOptions);
 
+    SSL_CTX_set_info_callback(sslContext, ssl_info_cb);
+
     if (port.sslContextSessionId)
         SSL_CTX_set_session_id_context(sslContext, (const unsigned char *)port.sslContextSessionId, strlen(port.sslContextSessionId));
 
@@ -855,6 +895,15 @@
     debugs(83, 9, &quot;Setting RSA key generation callback.&quot;);
     SSL_CTX_set_tmp_rsa_callback(sslContext, ssl_temp_rsa_cb);
 
+    if (port.eecdhcurve) {
+        debugs(83, 9, &quot;Setting Ephemeral ECDH curve to &quot; &lt;&lt; port.eecdhcurve &lt;&lt; &quot;.&quot;);
+
+        if (!configureSslEECDH(sslContext, port.eecdhcurve)) {
+            ssl_error = ERR_get_error();
+            debugs(83, DBG_IMPORTANT, &quot;WARNING: Unable to configure Ephemeral ECDH: &quot; &lt;&lt; ERR_error_string(ssl_error, NULL));
+        }
+    }
+
     debugs(83, 9, &quot;Setting CA certificate locations.&quot;);
 
     const char *cafile = port.cafile ? port.cafile : port.clientca;
@@ -1155,6 +1204,8 @@
 
     SSL_CTX_set_options(sslContext, Ssl::parse_options(options));
 
+    SSL_CTX_set_info_callback(sslContext, ssl_info_cb);
+
     if (*cipher) {
         debugs(83, 5, &quot;Using chiper suite &quot; &lt;&lt; cipher &lt;&lt; &quot;.&quot;);
 




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003741.html">[squid-users] Alternative ways of tracking users on unauthenticated proxy
</A></li>
	<LI>Next message (by thread): <A HREF="003727.html">[squid-users] [PATCH] SSL: Add suport for EECDH and disable client-initiated renegotiation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3726">[ date ]</a>
              <a href="thread.html#3726">[ thread ]</a>
              <a href="subject.html#3726">[ subject ]</a>
              <a href="author.html#3726">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
