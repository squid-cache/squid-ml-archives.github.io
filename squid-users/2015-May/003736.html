<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl-bump deep dive (self-signed certs in chain)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28self-signed%20certs%20in%20chain%29&In-Reply-To=%3C556424C1.5000200%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003731.html">
   <LINK REL="Next"  HREF="003760.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl-bump deep dive (self-signed certs in chain)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28self-signed%20certs%20in%20chain%29&In-Reply-To=%3C556424C1.5000200%40treenet.co.nz%3E"
       TITLE="[squid-users] Ssl-bump deep dive (self-signed certs in chain)">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May 26 07:46:09 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003731.html">[squid-users] Ssl-bump deep dive (self-signed certs in chain)
</A></li>
        <LI>Next message (by thread): <A HREF="003760.html">[squid-users] Ssl-bump deep dive (self-signed certs in chain)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3736">[ date ]</a>
              <a href="thread.html#3736">[ thread ]</a>
              <a href="subject.html#3736">[ subject ]</a>
              <a href="author.html#3736">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/05/2015 4:26 a.m., James Lay wrote:
&gt;<i> So following advice and instructions on this page:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/DynamicSslCert">http://wiki.squid-cache.org/Features/DynamicSslCert</A>
</I>&gt;<i> 
</I>&gt;<i> I have set up my lab with explicit proxy by exporting http_proxy and
</I>&gt;<i> https_proxy.  After creating the self-signed root CA certificate above
</I>&gt;<i> and creating the .der file for the client, here are my results:
</I>&gt;<i> 
</I>&gt;<i> From the squid side:
</I>&gt;<i> 2015/05/25 10:02:20.161| Using certificate
</I>&gt;<i> in /opt/etc/squid/certs/SquidCA.pem
</I>&gt;<i> 2015/05/25 10:02:20.170| support.cc(1743) readSslX509CertificatesChain:
</I>&gt;<i> Certificate is self-signed, will not be chained
</I>&gt;<i> I get the below when I don't specify a CA with curl, otherwise when I do
</I>&gt;<i> I get no error:
</I>&gt;<i> 2015/05/25 09:21:02.229| Error negotiating SSL connection on FD 12:
</I>&gt;<i> error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
</I>
If that error is displayed by Squid about the clients connection. Then I
believe it means the client is attempting to perform TLS authentication
to Squid using the CA you installed there. Which is not possible as the
CA is supposed to make the client trust Squid generated certs, not the
other way around.


&gt;<i> 
</I>&gt;<i> And from the client side:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at kali</A>:~/test# curl -v <A HREF="https://mail.slave-tothe-box.net">https://mail.slave-tothe-box.net</A>
</I>&gt;<i> * About to connect() to proxy 192.168.1.9 port 3129 (#0)
</I>&gt;<i> *   Trying 192.168.1.9...
</I>&gt;<i> * connected
</I>&gt;<i> * Connected to 192.168.1.9 (192.168.1.9) port 3129 (#0)
</I>&gt;<i> * Establish HTTP proxy tunnel to mail.slave-tothe-box.net:443
</I>&gt;&gt;<i> CONNECT mail.slave-tothe-box.net:443 HTTP/1.1
</I>&gt;&gt;<i> Host: mail.slave-tothe-box.net:443
</I>&gt;&gt;<i> User-Agent: curl/7.26.0
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> * Easy mode waiting response from proxy CONNECT
</I>&gt;<i> &lt; HTTP/1.1 200 Connection established
</I>&gt;<i> &lt; 
</I>&gt;<i> * Proxy replied OK to CONNECT request
</I>&gt;<i> * successfully set certificate verify locations:
</I>&gt;<i> *   CAfile: none
</I>&gt;<i>   CApath: /etc/ssl/certs
</I>&gt;<i> * SSLv3, TLS handshake, Client hello (1):
</I>&gt;<i> * SSLv3, TLS handshake, Server hello (2):
</I>&gt;<i> * SSLv3, TLS handshake, CERT (11):
</I>&gt;<i> * SSLv3, TLS alert, Server hello (2):
</I>&gt;<i> * SSL certificate problem: self signed certificate in certificate chain
</I>&gt;<i> * Closing connection #0
</I>&gt;<i> 
</I>&gt;<i> And testing with specifying the .der file:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at kali</A>:~/test# curl --cacert /etc/ssl/certs/SquidCA.der -v
</I>&gt;<i> <A HREF="https://mail.slave-tothe-box.net">https://mail.slave-tothe-box.net</A>
</I>&gt;<i> * About to connect() to proxy 192.168.1.9 port 3129 (#0)
</I>&gt;<i> *   Trying 192.168.1.9...
</I>&gt;<i> * connected
</I>&gt;<i> * Connected to 192.168.1.9 (192.168.1.9) port 3129 (#0)
</I>&gt;<i> * Establish HTTP proxy tunnel to mail.slave-tothe-box.net:443
</I>&gt;&gt;<i> CONNECT mail.slave-tothe-box.net:443 HTTP/1.1
</I>&gt;&gt;<i> Host: mail.slave-tothe-box.net:443
</I>&gt;&gt;<i> User-Agent: curl/7.26.0
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> * Easy mode waiting response from proxy CONNECT
</I>&gt;<i> &lt; HTTP/1.1 200 Connection established
</I>&gt;<i> &lt; 
</I>&gt;<i> * Proxy replied OK to CONNECT request
</I>&gt;<i> * error setting certificate verify locations:
</I>&gt;<i>   CAfile: /etc/ssl/certs/SquidCA.der
</I>&gt;<i>   CApath: /etc/ssl/certs
</I>&gt;<i> 
</I>&gt;<i> * Closing connection #0
</I>&gt;<i> curl: (77) error setting certificate verify locations:
</I>&gt;<i>   CAfile: /etc/ssl/certs/SquidCA.der
</I>&gt;<i>   CApath: /etc/ssl/certs
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I can confirm that the server is using a bona-fide certificate issued
</I>&gt;<i> from StartSSL and works, so at this point I'm open to suggestions.
</I>&gt;<i> Thank you.
</I>
curl is complaining that the CA chain for the Squid-generted cert has a
self-signed CA. This is expected and desired behaviour if the
self-signed CA was sent by Squid.

The errors only occur when the self-signed CA is not sent by Squid, but
using the one installed on the client.


For that I believe you need to configure Squid to sign/generate using
the intermediate certificate. The self-signed root CA not configured in
Squid at all.

Like so:

A)
 client Trust DB installed with self-signed root CA

 squid.conf cert= configured with intermediary CA certificate

 squid.conf cafile= configured with any other intermediary CA
certificates (in order back to root CA, but excluding it).

 Squid generates per-connection certificate

OR:

B)
 client Trust DB installed with self-signed root CA

 squid.conf cert= configured with self-signed root CA

 Squid generates per-connection certificate


Note that in (B) there is no intermediary certificate at all, and Squid
does not emit any CA chain to the client.

It works exactly the same way as the globally trusted CA do. But they
are contractually obliged to refuse giving out intermediary CA for
anyones use, or loose their status as trusted CA.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003731.html">[squid-users] Ssl-bump deep dive (self-signed certs in chain)
</A></li>
	<LI>Next message (by thread): <A HREF="003760.html">[squid-users] Ssl-bump deep dive (self-signed certs in chain)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3736">[ date ]</a>
              <a href="thread.html#3736">[ thread ]</a>
              <a href="subject.html#3736">[ subject ]</a>
              <a href="author.html#3736">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
