<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid, Gmail.com and HSTS.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%20Gmail.com%20and%20HSTS.&In-Reply-To=%3C412364730.1389182.1432743337627.JavaMail.zimbra%402keys.ca%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003772.html">
   <LINK REL="Next"  HREF="003748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid, Gmail.com and HSTS.</H1>
    <B>Michael Monette</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%20Gmail.com%20and%20HSTS.&In-Reply-To=%3C412364730.1389182.1432743337627.JavaMail.zimbra%402keys.ca%3E"
       TITLE="[squid-users] Squid, Gmail.com and HSTS.">mmonette at 2keys.ca
       </A><BR>
    <I>Wed May 27 16:15:37 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003772.html">[squid-users] ipf transparent enabled,	but squid says not supported
</A></li>
        <LI>Next message (by thread): <A HREF="003748.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3747">[ date ]</a>
              <a href="thread.html#3747">[ thread ]</a>
              <a href="subject.html#3747">[ subject ]</a>
              <a href="author.html#3747">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Has anyone been able to configure Squid in a way so that if you type <A HREF="https://gmail.com">https://gmail.com</A> in your browser, you are NOT presented with the &quot;OMG HSTS I refuse to load anything&quot; page? When I go to <A HREF="https://gmail.com,">https://gmail.com,</A> I get an invalid certificate because the cert is for mail.google.com, issued by my CA. If I go to <A HREF="https://mail.google.com,">https://mail.google.com,</A> the cert is beautifully green. Why can't squid detect that gmail.com is redirecting my browser to mail.google.com and generate the cert accordingly?

Even configuring an acl for gmail.com doesn't work. It seems like even though I am punching <A HREF="https://gmail.com">https://gmail.com</A> in my browser, Squid detects it as though I am typing &quot;<A HREF="https://mail.google.com">https://mail.google.com</A>&quot; in my browser and is ignoring any ACLs I have setup specifically for &quot;gmail.com&quot;.

I can't be the only one with this issue?



I've also attempted to do:

acl bl1 gmail.com moz.com
always_direct allow bl1 &lt;- from what I understand this bypasses squid and tells my browser to get the cert right from the site. Maybe I am wrong.

But certificates still come from Squid, so I don't see any effect from that line.

Here's my config, lots of garbage in there since I have been trying everything i can think of to get this working. I want to add that for my acl called BL1, the only one that works is moz.com . They are part of the same ACL line, so if one works, they should all work. Except they do not.

Thanks in advance.

cat /etc/squid/squid.conf

~~

debug_options ALL,9

acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl CONNECT method CONNECT


http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports

http_access allow localhost manager
http_access deny manager

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump bump step2 all
ssl_bump bump step3 all

acl bl1 dstdomain gmail.com mail.google.com accounts.google.com moz.com
#acl bl1 url_regex -i ^http(s)?://gmail.com
#acl bl2 url_regex -i ^http(s)?://([a-zA-Z]+).gmail.com.*
#acl bl3 url_regex -i ^http(s)?://moz.com.*
#acl bl4 url_regex -i moz.com
deny_info <A HREF="http://ask.com">http://ask.com</A> bl1 # I was testing redirecting stuff, but since the acl is not even picked up, this stuff is useless.
http_reply_access deny bl1 # useless
#http_access deny bl1 
#http_access deny bl1 CONNECT

http_access allow localnet
http_access allow localhost

http_access allow all

http_port 3128 accel vhost allow-direct

#https_port 3129 transparent ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.pem options=NO_SSLv3
https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.pem options=NO_SSLv3

sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER

sslproxy_options NO_SSLv2
sslproxy_options NO_SSLv3

sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

#cache_dir ufs /var/spool/squid 100 16 256
coredump_dir /var/spool/squid

refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320


Mike

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003772.html">[squid-users] ipf transparent enabled,	but squid says not supported
</A></li>
	<LI>Next message (by thread): <A HREF="003748.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3747">[ date ]</a>
              <a href="thread.html#3747">[ thread ]</a>
              <a href="subject.html#3747">[ subject ]</a>
              <a href="author.html#3747">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
