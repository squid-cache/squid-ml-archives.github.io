<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid, Gmail.com and HSTS.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%20Gmail.com%20and%20HSTS.&In-Reply-To=%3CA9B12740-03C3-4477-B978-820452FF528B%402keys.ca%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003747.html">
   <LINK REL="Next"  HREF="003749.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid, Gmail.com and HSTS.</H1>
    <B>Michael Monette</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%20Gmail.com%20and%20HSTS.&In-Reply-To=%3CA9B12740-03C3-4477-B978-820452FF528B%402keys.ca%3E"
       TITLE="[squid-users] Squid, Gmail.com and HSTS.">mmonette at 2keys.ca
       </A><BR>
    <I>Wed May 27 16:23:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003747.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
        <LI>Next message (by thread): <A HREF="003749.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3748">[ date ]</a>
              <a href="thread.html#3748">[ thread ]</a>
              <a href="subject.html#3748">[ subject ]</a>
              <a href="author.html#3748">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I just thought of something else. First of all I'm new to squid and I am not aware of 10% of the things its capable of yet so I will ask. 

Is squid capable of adding custom SNIs? Like could I have it so gmail.com is added to the certificate as a subject alternate name EVEN though the original certificate doesn't contain it? If such a thing is possible I would love to know the term for it so I can do some searches. 

Appreciate it!

On May 27, 2015 12:15:37 PM EDT, Michael Monette &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mmonette at 2keys.ca</A>&gt; wrote:
&gt;<i>Has anyone been able to configure Squid in a way so that if you type
</I>&gt;<i><A HREF="https://gmail.com">https://gmail.com</A> in your browser, you are NOT presented with the &quot;OMG
</I>&gt;<i>HSTS I refuse to load anything&quot; page? When I go to <A HREF="https://gmail.com,">https://gmail.com,</A> I
</I>&gt;<i>get an invalid certificate because the cert is for mail.google.com,
</I>&gt;<i>issued by my CA. If I go to <A HREF="https://mail.google.com,">https://mail.google.com,</A> the cert is
</I>&gt;<i>beautifully green. Why can't squid detect that gmail.com is redirecting
</I>&gt;<i>my browser to mail.google.com and generate the cert accordingly?
</I>&gt;<i>
</I>&gt;<i>Even configuring an acl for gmail.com doesn't work. It seems like even
</I>&gt;<i>though I am punching <A HREF="https://gmail.com">https://gmail.com</A> in my browser, Squid detects it
</I>&gt;<i>as though I am typing &quot;<A HREF="https://mail.google.com">https://mail.google.com</A>&quot; in my browser and is
</I>&gt;<i>ignoring any ACLs I have setup specifically for &quot;gmail.com&quot;.
</I>&gt;<i>
</I>&gt;<i>I can't be the only one with this issue?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I've also attempted to do:
</I>&gt;<i>
</I>&gt;<i>acl bl1 gmail.com moz.com
</I>&gt;<i>always_direct allow bl1 &lt;- from what I understand this bypasses squid
</I>&gt;<i>and tells my browser to get the cert right from the site. Maybe I am
</I>&gt;<i>wrong.
</I>&gt;<i>
</I>&gt;<i>But certificates still come from Squid, so I don't see any effect from
</I>&gt;<i>that line.
</I>&gt;<i>
</I>&gt;<i>Here's my config, lots of garbage in there since I have been trying
</I>&gt;<i>everything i can think of to get this working. I want to add that for
</I>&gt;<i>my acl called BL1, the only one that works is moz.com . They are part
</I>&gt;<i>of the same ACL line, so if one works, they should all work. Except
</I>&gt;<i>they do not.
</I>&gt;<i>
</I>&gt;<i>Thanks in advance.
</I>&gt;<i>
</I>&gt;<i>cat /etc/squid/squid.conf
</I>&gt;<i>
</I>&gt;<i>~~
</I>&gt;<i>
</I>&gt;<i>debug_options ALL,9
</I>&gt;<i>
</I>&gt;<i>acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;<i>acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;<i>acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
</I>&gt;<i>acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i>acl localnet src fe80::/10      # RFC 4291 link-local (directly
</I>&gt;<i>plugged) machines
</I>&gt;<i>
</I>&gt;<i>acl SSL_ports port 443
</I>&gt;<i>acl Safe_ports port 80		# http
</I>&gt;<i>acl Safe_ports port 21		# ftp
</I>&gt;<i>acl Safe_ports port 443		# https
</I>&gt;<i>acl Safe_ports port 70		# gopher
</I>&gt;<i>acl Safe_ports port 210		# wais
</I>&gt;<i>acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i>acl Safe_ports port 280		# http-mgmt
</I>&gt;<i>acl Safe_ports port 488		# gss-http
</I>&gt;<i>acl Safe_ports port 591		# filemaker
</I>&gt;<i>acl Safe_ports port 777		# multiling http
</I>&gt;<i>acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i>http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i>http_access allow localhost manager
</I>&gt;<i>http_access deny manager
</I>&gt;<i>
</I>&gt;<i>acl step1 at_step SslBump1
</I>&gt;<i>acl step2 at_step SslBump2
</I>&gt;<i>acl step3 at_step SslBump3
</I>&gt;<i>
</I>&gt;<i>ssl_bump peek step1 all
</I>&gt;<i>ssl_bump bump step2 all
</I>&gt;<i>ssl_bump bump step3 all
</I>&gt;<i>
</I>&gt;<i>acl bl1 dstdomain gmail.com mail.google.com accounts.google.com moz.com
</I>&gt;<i>#acl bl1 url_regex -i ^http(s)?://gmail.com
</I>&gt;<i>#acl bl2 url_regex -i ^http(s)?://([a-zA-Z]+).gmail.com.*
</I>&gt;<i>#acl bl3 url_regex -i ^http(s)?://moz.com.*
</I>&gt;<i>#acl bl4 url_regex -i moz.com
</I>&gt;<i>deny_info <A HREF="http://ask.com">http://ask.com</A> bl1 # I was testing redirecting stuff, but
</I>&gt;<i>since the acl is not even picked up, this stuff is useless.
</I>&gt;<i>http_reply_access deny bl1 # useless
</I>&gt;<i>#http_access deny bl1 
</I>&gt;<i>#http_access deny bl1 CONNECT
</I>&gt;<i>
</I>&gt;<i>http_access allow localnet
</I>&gt;<i>http_access allow localhost
</I>&gt;<i>
</I>&gt;<i>http_access allow all
</I>&gt;<i>
</I>&gt;<i>http_port 3128 accel vhost allow-direct
</I>&gt;<i>
</I>&gt;<i>#https_port 3129 transparent ssl-bump generate-host-certificates=on
</I>&gt;<i>dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem
</I>&gt;<i>key=/etc/squid/ssl_cert/myca.pem options=NO_SSLv3
</I>&gt;<i>https_port 3129 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i>dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem
</I>&gt;<i>key=/etc/squid/ssl_cert/myca.pem options=NO_SSLv3
</I>&gt;<i>
</I>&gt;<i>sslproxy_cert_error allow all
</I>&gt;<i>sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i>
</I>&gt;<i>sslproxy_options NO_SSLv2
</I>&gt;<i>sslproxy_options NO_SSLv3
</I>&gt;<i>
</I>&gt;<i>sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i>sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i>
</I>&gt;<i>#cache_dir ufs /var/spool/squid 100 16 256
</I>&gt;<i>coredump_dir /var/spool/squid
</I>&gt;<i>
</I>&gt;<i>refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i>refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i>refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i>refresh_pattern .		0	20%	4320
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Mike
</I>&gt;<i>_______________________________________________
</I>&gt;<i>squid-users mailing list
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i><A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
Sent from my Android device with K-9 Mail. Please excuse my brevity.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150527/92b9fa63/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150527/92b9fa63/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003747.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
	<LI>Next message (by thread): <A HREF="003749.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3748">[ date ]</a>
              <a href="thread.html#3748">[ thread ]</a>
              <a href="subject.html#3748">[ subject ]</a>
              <a href="author.html#3748">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
