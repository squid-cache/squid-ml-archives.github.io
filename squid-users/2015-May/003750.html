<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid, Gmail.com and HSTS.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%20Gmail.com%20and%20HSTS.&In-Reply-To=%3C1178914605.1395397.1432751610933.JavaMail.zimbra%402keys.ca%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003749.html">
   <LINK REL="Next"  HREF="003756.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid, Gmail.com and HSTS.</H1>
    <B>Michael Monette</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%2C%20Gmail.com%20and%20HSTS.&In-Reply-To=%3C1178914605.1395397.1432751610933.JavaMail.zimbra%402keys.ca%3E"
       TITLE="[squid-users] Squid, Gmail.com and HSTS.">mmonette at 2keys.ca
       </A><BR>
    <I>Wed May 27 18:33:30 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003749.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
        <LI>Next message (by thread): <A HREF="003756.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3750">[ date ]</a>
              <a href="thread.html#3750">[ thread ]</a>
              <a href="subject.html#3750">[ subject ]</a>
              <a href="author.html#3750">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yeah I don't know what I am doing wrong but I don't have these ACL types..Or I am somehow not copy &amp; pasting properly:

FATAL: Invalid ACL type 'ssl::server_name'
FATAL: Bungled /etc/squid/squid.conf line 54: acl nobumpsites ssl::server_name .google.com
Squid Cache (Version 3.5.4): Terminated abnormally.
CPU Usage: 0.005 seconds = 0.003 user + 0.002 sys
Maximum Resident Size: 24096 KB
Page faults with physical i/o: 0
Squid restarted
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ottt-corp-paz-squid-1</A> squid-3.5.4]# squid -v
Squid Cache: Version 3.5.4
Service Name: squid
configure options:  '--prefix=/usr' '--includedir=/usr/include' '--datadir=/usr/share' '--bindir=/usr/sbin' '--libexecdir=/usr/lib/squid' '--localstatedir=/var' '--sysconfdir=/etc/squid' '--with-included-ltdl' --enable-ltdl-convenience


There are also issues with &quot;at_step&quot; now:

2015/05/27 14:32:17| FATAL: Invalid ACL type 'at_step'
FATAL: Bungled /etc/squid/squid.conf line 52: acl step1 at_step SslBump1
Squid Cache (Version 3.5.4): Terminated abnormally.
CPU Usage: 0.005 seconds = 0.003 user + 0.002 sys
Maximum Resident Size: 24080 KB
Page faults with physical i/o: 0

Did I miss something when compiling? I just followed what was on the Squid wiki.

I am all out of ideas..

Thanks, 

Mike


----- Original Message -----
From: &quot;Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
To: &quot;squid-users&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Sent: Wednesday, May 27, 2015 1:20:33 PM
Subject: Re: [squid-users] Squid, Gmail.com and HSTS.

On 28/05/2015 4:15 a.m., Michael Monette wrote:
&gt;<i> Has anyone been able to configure Squid in a way so that if you type
</I><A HREF="https://gmail.com">https://gmail.com</A> in your browser, you are NOT presented with the &quot;OMG
HSTS I refuse to load anything&quot; page? When I go to <A HREF="https://gmail.com,">https://gmail.com,</A> I
get an invalid certificate because the cert is for mail.google.com,
issued by my CA. If I go to <A HREF="https://mail.google.com,">https://mail.google.com,</A> the cert is
beautifully green. Why can't squid detect that gmail.com is redirecting
my browser to mail.google.com and generate the cert accordingly?

That is *actually* what their server certificate contains. Ironic isn't
it that their own certs do not comply with the restrictions they require
of all others.

Squid actually does obey HSTS requirements for secure handling of the
reqeust. Its just the browser is incapable of detecting that, notices
the custom CA and assumes the worst.

&gt;<i> 
</I>&gt;<i> Even configuring an acl for gmail.com doesn't work. It seems like
</I>&gt;<i> even
</I>though I am punching <A HREF="https://gmail.com">https://gmail.com</A> in my browser, Squid detects it
as though I am typing &quot;<A HREF="https://mail.google.com">https://mail.google.com</A>&quot; in my browser and is
ignoring any ACLs I have setup specifically for &quot;gmail.com&quot;.
&gt;<i> 
</I>&gt;<i> I can't be the only one with this issue?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I've also attempted to do:
</I>&gt;<i> 
</I>&gt;<i> acl bl1 gmail.com moz.com
</I>&gt;<i> always_direct allow bl1 &lt;- from what I understand this bypasses squid and tells my browser to get the cert right from the site. Maybe I am wrong.
</I>&gt;<i> 
</I>
You are. squid.conf has nothing to do with your browser.

That line tells Squid not to use any cache_peer connections when serving
a request that matches ACL &quot;bl1&quot;.

In the very first implementation way, way back in 3.1 decrypted requests
could leak out over insecure cache_peer. So people were advised to use
&quot;always_direct allow all&quot; to force it to work correctly. That bug was
fixed long ago but the config still persists in the web.


&gt;<i> But certificates still come from Squid, so I don't see any effect from that line.
</I>&gt;<i> 
</I>&gt;<i> Here's my config, lots of garbage in there since I have been trying everything i can think of to get this working. I want to add that for my acl called BL1, the only one that works is moz.com . They are part of the same ACL line, so if one works, they should all work. Except they do not.
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance.
</I>&gt;<i> 
</I>&gt;<i> cat /etc/squid/squid.conf
</I>&gt;<i> 
</I>&gt;<i> ~~
</I>&gt;<i> 
</I>&gt;<i> debug_options ALL,9
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump bump step2 all
</I>&gt;<i> ssl_bump bump step3 all
</I>
&quot;all&quot; at the end of ACL lines has no meaning unless there is an
authentication ACL that would otherwise be on the end and you dont want
to trigger auth popups.


&gt;<i> 
</I>&gt;<i> acl bl1 dstdomain gmail.com mail.google.com accounts.google.com moz.com
</I>&gt;<i> #acl bl1 url_regex -i ^http(s)?://gmail.com
</I>&gt;<i> #acl bl2 url_regex -i ^http(s)?://([a-zA-Z]+).gmail.com.*
</I>&gt;<i> #acl bl3 url_regex -i ^http(s)?://moz.com.*
</I>&gt;<i> #acl bl4 url_regex -i moz.com
</I>&gt;<i> deny_info <A HREF="http://ask.com">http://ask.com</A> bl1 # I was testing redirecting stuff, but since the acl is not even picked up, this stuff is useless.
</I>&gt;<i> http_reply_access deny bl1 # useless
</I>
Yes, why bother testing for request *URL* domain and blocking on the
*reply*.


&gt;<i> #http_access deny bl1 
</I>&gt;<i> #http_access deny bl1 CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 accel vhost allow-direct
</I>&gt;<i> 
</I>&gt;<i> #https_port 3129 transparent ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.pem options=NO_SSLv3
</I>&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem key=/etc/squid/ssl_cert/myca.pem options=NO_SSLv3
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>&gt;<i> sslproxy_options NO_SSLv2
</I>&gt;<i> sslproxy_options NO_SSLv3
</I>
NOTE: Only the latest sslproxy_options line has any effect. So the
NO_SSLv2 line is not obeyed.

Use this instead:
  sslproxy_options NO_SSLv2,NO_SSLv3

Although that said. SSLv2 support was dropped earlier so the latest
releases will



Anyhow, back to your ACL problem. Be aware that the SNI and cert fields
are not the HTTP request URL.

* Ensure you are using the latest Squid, today that is a 3.5.4 snapshot
(and in ~48hrs will be 3.5.5).

* Use the &quot;ssl::server_name&quot; ACL type if you need to block using SNI or
server certificate SubjectName.

What Squid does for intercepted port 443 traffic is generate a fake
CONNECT request using the *IP:port* of the server from TCP. http_access
is checked for that. You can block if ou wish or pass it through,
ssl_bump may decide not to bump and it can safely be passed through
peers, or acted on directly to tunnel the intercepted bytes to the server.

If you do SSL-bump with peeking at client and/or server cert the
ssl_server_name ACL matches the data found there about the server
name/alias.

After the decryption SSL-bump process has been completed will you start
to get the HTTP requests that were encrypted as HTTPS. The https_access
etc are all run normally on those since they are just regular HTTP
traffic but for <A HREF="https://">https://</A> URLs.

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003749.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
	<LI>Next message (by thread): <A HREF="003756.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3750">[ date ]</a>
              <a href="thread.html#3750">[ thread ]</a>
              <a href="subject.html#3750">[ subject ]</a>
              <a href="author.html#3750">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
