<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ipf transparent enabled,	but squid says not supported
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ipf%20transparent%20enabled%2C%0A%09but%20squid%20says%20not%20supported&In-Reply-To=%3C55687D1C.8070409%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003746.html">
   <LINK REL="Next"  HREF="003747.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ipf transparent enabled,	but squid says not supported</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ipf%20transparent%20enabled%2C%0A%09but%20squid%20says%20not%20supported&In-Reply-To=%3C55687D1C.8070409%40borrill.org.uk%3E"
       TITLE="[squid-users] ipf transparent enabled,	but squid says not supported">squid at borrill.org.uk
       </A><BR>
    <I>Fri May 29 14:52:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003746.html">[squid-users] ipf transparent enabled, but squid says not supported
</A></li>
        <LI>Next message (by thread): <A HREF="003747.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3772">[ date ]</a>
              <a href="thread.html#3772">[ thread ]</a>
              <a href="subject.html#3772">[ subject ]</a>
              <a href="author.html#3772">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/05/2015 16:52, James Lay wrote:
&gt;<i> On 2015-05-27 09:45 AM, Stephen Borrill wrote:
</I>&gt;&gt;<i> I have:
</I>&gt;&gt;<i> Squid Cache: Version 3.5.4
</I>&gt;&gt;<i> Service Name: squid
</I>&gt;&gt;<i> configure options:  '--sysconfdir=/usr/pkg/etc/squid'
</I>&gt;&gt;<i> '--localstatedir=/var/squid' '--datarootdir=/usr/pkg/share/squid'
</I>&gt;&gt;<i> '--disable-strict-error-checking' '--enable-auth'
</I>&gt;&gt;<i> '--enable-cachemgr-hostname=localhost' '--enable-delay-pools'
</I>&gt;&gt;<i> '--enable-icap-client' '--enable-icmp' '--enable-poll'
</I>&gt;&gt;<i> '--enable-removal-policies=lru,heap'
</I>&gt;&gt;<i> '--enable-storeio=ufs diskd' '--with-aio' '--with-default-user=squid'
</I>&gt;&gt;<i> '--with-pidfile=/var/run/squid.pid' '--disable-arch-native'
</I>&gt;&gt;<i> '--enable-ipf-transparent' '--enable-arp-acl' '--enable-carp'
</I>&gt;&gt;<i> '--disable-ipv6' '--without-mit-krb5' '--without-heimdal-krb5'
</I>&gt;&gt;<i> '--disable-snmp' '--enable-ssl' '--with-openssl=/usr/pkg'
</I>&gt;&gt;<i> '--enable-auth-basic=NCSA getpwnam PAM' '--enable-auth-digest=file'
</I>&gt;&gt;<i> '--disable-auth-negotiate' '--enable-auth-ntlm=fake smb_lm'
</I>&gt;&gt;<i> '--enable-external-acl-helpers=file_userip unix_group'
</I>&gt;&gt;<i> '--prefix=/usr/pkg' '--build=i486--netbsdelf'
</I>&gt;&gt;<i> '--host=i486--netbsdelf' '--mandir=/usr/pkg/man'
</I>&gt;&gt;<i> 'build_alias=i486--netbsdelf' 'host_alias=i486--netbsdelf'
</I>&gt;&gt;<i> 'CC=cc' 'CFLAGS=-O2 -I/usr/include -I/usr/pkg/include'
</I>&gt;&gt;<i> 'LDFLAGS=-L/usr/lib -Wl,-R/usr/lib -L/usr/pkg/lib -Wl,-R/usr/pkg/lib'
</I>&gt;&gt;<i> 'LIBS=' 'CPPFLAGS=-I/usr/include -I/usr/pkg/include'
</I>&gt;&gt;<i> 'CXX=c++' 'CXXFLAGS=-O2 -I/usr/include -I/usr/pkg/include'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> squid.conf contains:
</I>&gt;&gt;<i> http_port 127.0.0.1:8006 intercept name=port_8006
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yet I see the following ev:
</I>&gt;&gt;<i> 2015/05/27 16:02:46 kid1| WARNING: transparent proxying not supported
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Same config works with earlier version of squid (3.4 and earlier).
</I>&gt;&gt;<i> What's changed?
</I>&gt;<i>
</I>&gt;<i> Look through your config.log...I experienced a similar thing and, upon
</I>&gt;<i> running my ./configure line and watching it I saw I was missing a library.
</I>
This is down to two faults in configure:

1) If USE_SOLARIS_IPFILTER_MINOR_T_HACK is not needed, then configure 
still defines it, but with no value (i.e. confdefs.h has #define 
USE_SOLARIS_IPFILTER_MINOR_T_HACK ). All tests that use #if 
USE_SOLARIS_IPFILTER_MINOR_T_HACK will then fail.

My fix was to add squid_cv_broken_ipfilter_minor_t=0 as follows (note 
the message about netinet/ headers is also highly misleading):

         { $as_echo &quot;$as_me:${as_lineno-$LINENO}: result: unable to make 
IPFilter work with netinet/ headers&quot; &gt;&amp;5
$as_echo &quot;unable to make IPFilter work with netinet/ headers&quot; &gt;&amp;6; }
----&gt;&gt;        squid_cv_broken_ipfilter_minor_t=0

2) The tests for IPF headers no longer include net/if.h. Fix is to add:
#if HAVE_NET_IF_H
#include &lt;net/if.h&gt;
#endif

Patch to configure is:
@@ -38708,7 +38708,7 @@

          { $as_echo &quot;$as_me:${as_lineno-$LINENO}: result: unable to 
make IPFilter work with netinet/ headers&quot; &gt;&amp;5
  $as_echo &quot;unable to make IPFilter work with netinet/ headers&quot; &gt;&amp;6; }
-
+       squid_cv_broken_ipfilter_minor_t=0
  fi
  rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext

@@ -38751,6 +38751,9 @@
  #if HAVE_SYS_IOCCOM_H
  #include &lt;sys/ioccom.h&gt;
  #endif
+#if HAVE_NET_IF_H
+#include &lt;net/if.h&gt;
+#endif
  #if USE_SOLARIS_IPFILTER_MINOR_T_HACK
  #undef minor_t
  #endif

-- 
Stephen


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003746.html">[squid-users] ipf transparent enabled, but squid says not supported
</A></li>
	<LI>Next message (by thread): <A HREF="003747.html">[squid-users] Squid, Gmail.com and HSTS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3772">[ date ]</a>
              <a href="thread.html#3772">[ thread ]</a>
              <a href="subject.html#3772">[ subject ]</a>
              <a href="author.html#3772">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
