<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl-bump deep dive (sni and access control) some	success
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28sni%20and%20access%20control%29%20some%0A%09success&In-Reply-To=%3C1432998979.3683.28.camel%40JamesiMac%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003781.html">
   <LINK REL="Next"  HREF="003783.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl-bump deep dive (sni and access control) some	success</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-bump%20deep%20dive%20%28sni%20and%20access%20control%29%20some%0A%09success&In-Reply-To=%3C1432998979.3683.28.camel%40JamesiMac%3E"
       TITLE="[squid-users] Ssl-bump deep dive (sni and access control) some	success">jlay at slave-tothe-box.net
       </A><BR>
    <I>Sat May 30 15:16:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003781.html">[squid-users] Squid authetication with Google Apps
</A></li>
        <LI>Next message (by thread): <A HREF="003783.html">[squid-users] Conditional question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3782">[ date ]</a>
              <a href="thread.html#3782">[ thread ]</a>
              <a href="subject.html#3782">[ subject ]</a>
              <a href="author.html#3782">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Config first:

####################################################
acl localnet src 192.168.1.0/24

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

acl CONNECT method CONNECT

acl step1 at_step SslBump1
acl step2 at_step SslBump2

ssl_bump peek step1 all
#https_server_names.txt has \.google\.com, \.yahoo\.com, \.msn\.com
acl allowed_https_sites ssl::server_name_regex
&quot;/opt/etc/squid/https_server_names.txt&quot;

http_access allow all

ssl_bump bump allowed_https_sites
ssl_bump terminate !allowed_https_sites

sslproxy_cert_error allow all
sslproxy_capath /etc/ssl/certs
sslproxy_flags DONT_VERIFY_PEER 
sslproxy_options ALL

sslcrtd_program /opt/libexec/ssl_crtd -s /opt/var/ssl_db -M 4MB
sslcrtd_children 5

http_port 3128 intercept
https_port 3129 intercept ssl-bump
cert=/opt/etc/squid/certs/sslsplit_ca_cert.pem
cafile=/opt/etc/squid/certs/sslsplit_ca_cert.pem
key=/opt/etc/squid/certs/sslsplit_ca_key.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
sslflags=NO_SESSION_REUSE

logformat mine %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %ssl::&gt;sni %&gt;Hs
%&lt;st %Ss:%Sh %ssl::bump_mode 

access_log syslog:daemon.info mine

refresh_pattern -i (cgi-bin|\?)	0	0%	0
refresh_pattern .		0	20%	4320

coredump_dir /opt/var
####################################################


so the above works to bump and filter out (the order of these lines
absolutely seemed to matter) if the site you go to isn't in the
allowed_https_sites acl.  The sticking point is the http_access....the
above will filter https based on the allowed_https_server_names.txt, but
completely allows ALL http, so this isn't complete yet.  Below is going
to a site in the allowed_https_sites acl:

[08:59:44 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at powerbook</A>:~/test$ wget
--ca-certificate=/etc/ssl/certs/sslsplit_ca_cert.pem -d
<A HREF="https://www.msn.com">https://www.msn.com</A>
DEBUG output created by Wget 1.16 on linux-gnu.

URI encoding = &#8216;UTF-8&#8217;
--2015-05-30 08:59:57--  <A HREF="https://www.msn.com/">https://www.msn.com/</A>
Certificates loaded: 173
Resolving www.msn.com (www.msn.com)... 204.79.197.203
Caching www.msn.com =&gt; 204.79.197.203
Connecting to www.msn.com (www.msn.com)|204.79.197.203|:443...
connected.
Created socket 4.
Releasing 0x10503f98 (new refcount 1).

---request begin---
GET / HTTP/1.1
User-Agent: Wget/1.16 (linux-gnu)
Accept: */*
Host: www.msn.com
Connection: Keep-Alive

---request end---
HTTP request sent, awaiting response... 
---response begin---
HTTP/1.1 200 OK
&lt;snip&gt;

May 30 08:59:57 analysis squid: 192.168.1.73 - - [30/May/2015:08:59:57
-0600] &quot;CONNECT 204.79.197.203:443 HTTP/1.1&quot; www.msn.com 200 0
TAG_NONE:ORIGINAL_DST peek
May 30 08:59:58 analysis squid: 192.168.1.73 - - [30/May/2015:08:59:58
-0600] &quot;GET <A HREF="https://www.msn.com/">https://www.msn.com/</A> HTTP/1.1&quot; www.msn.com 200 38288
TCP_MISS:ORIGINAL_DST bump

Going to a site not in the allowed_https_sites acl:

[09:02:12 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at powerbook</A>:~/test$ wget
--ca-certificate=/etc/ssl/certs/sslsplit_ca_cert.pem -d
<A HREF="https://www.weather.com">https://www.weather.com</A>
DEBUG output created by Wget 1.16 on linux-gnu.

URI encoding = &#8216;UTF-8&#8217;
--2015-05-30 09:04:57--  <A HREF="https://www.weather.com/">https://www.weather.com/</A>
Certificates loaded: 173
Resolving www.weather.com (www.weather.com)... 96.17.8.161, 96.17.8.138,
96.17.8.178, ...
Caching www.weather.com =&gt; 96.17.8.161 96.17.8.138 96.17.8.178
96.17.8.171
Connecting to www.weather.com (www.weather.com)|96.17.8.161|:443...
connected.
Created socket 4.
Releasing 0x1098c108 (new refcount 1).
GnuTLS: The TLS connection was non-properly terminated.
Closed fd 4
Unable to establish SSL connection.

May 30 09:04:57 analysis squid: 192.168.1.73 - - [30/May/2015:09:04:57
-0600] &quot;CONNECT 96.17.8.161:443 HTTP/1.1&quot; www.weather.com 200 0
TAG_NONE:HIER_NONE peek

However, changing http_access to http_access allow allowed_https_sites I
get:

[08:59:58 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at powerbook</A>:~/test$ wget
--ca-certificate=/etc/ssl/certs/sslsplit_ca_cert.pem -d
<A HREF="https://www.msn.com">https://www.msn.com</A>
DEBUG output created by Wget 1.16 on linux-gnu.

URI encoding = &#8216;UTF-8&#8217;
--2015-05-30 09:02:12--  <A HREF="https://www.msn.com/">https://www.msn.com/</A>
Certificates loaded: 173
Resolving www.msn.com (www.msn.com)... 204.79.197.203
Caching www.msn.com =&gt; 204.79.197.203
Connecting to www.msn.com (www.msn.com)|204.79.197.203|:443...
connected.
Created socket 4.
Releasing 0x10515f98 (new refcount 1).
The certificate's owner does not match hostname &#8216;www.msn.com&#8217;

May 30 09:02:12 analysis squid: 192.168.1.73 - - [30/May/2015:09:02:12
-0600] &quot;CONNECT 204.79.197.203:443 HTTP/1.1&quot; - 200 0
TCP_DENIED:HIER_NONE peek

Notice that peek did not get the SNI name per my %ssl::&gt;sni in my
logging statement.  So as of now I have been unable to figure out how to
use access control with both http and https.  I can do one or the other,
but not both so far.  Of interest, redirects from http to https do not
appear to work

[08:37:39 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at powerbook</A>:~/test$ wget www.yahoo.com
--2015-05-30 08:37:44--  <A HREF="http://www.yahoo.com/">http://www.yahoo.com/</A>
Resolving www.yahoo.com (www.yahoo.com)... 206.190.36.45,
206.190.36.105, 2001:4998:c:a06::2:4008
Connecting to www.yahoo.com (www.yahoo.com)|206.190.36.45|:80...
connected.
HTTP request sent, awaiting response... 301 Moved Permanently
Location: <A HREF="https://www.yahoo.com/">https://www.yahoo.com/</A> [following]
--2015-05-30 08:37:44--  <A HREF="https://www.yahoo.com/">https://www.yahoo.com/</A>
Connecting to www.yahoo.com (www.yahoo.com)|206.190.36.45|:443...
connected.
ERROR: The certificate of &#8216;www.yahoo.com&#8217; is not trusted.
ERROR: The certificate of &#8216;www.yahoo.com&#8217; hasn't got a known issuer.

May 30 08:37:44 analysis squid: 192.168.1.73 - - [30/May/2015:08:37:44
-0600] &quot;GET <A HREF="http://www.yahoo.com/">http://www.yahoo.com/</A> HTTP/1.1&quot; - 301 1812
TCP_MISS:ORIGINAL_DST -
May 30 08:37:45 analysis squid: 192.168.1.73 - - [30/May/2015:08:37:45
-0600] &quot;CONNECT 206.190.36.45:443 HTTP/1.1&quot; www.yahoo.com 200 0
TAG_NONE:ORIGINAL_DST peek

Whereas direct does:

[08:37:45 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at powerbook</A>:~/test$ wget
--ca-certificate=/etc/ssl/certs/sslsplit_ca_cert.pem -d
<A HREF="https://www.yahoo.com">https://www.yahoo.com</A>
DEBUG output created by Wget 1.16 on linux-gnu.

URI encoding = &#8216;UTF-8&#8217;
--2015-05-30 08:38:27--  <A HREF="https://www.yahoo.com/">https://www.yahoo.com/</A>
Certificates loaded: 173
Resolving www.yahoo.com (www.yahoo.com)... 206.190.36.105,
206.190.36.45, 2001:4998:c:a06::2:4008
Caching www.yahoo.com =&gt; 206.190.36.105 206.190.36.45
2001:4998:c:a06::2:4008
Connecting to www.yahoo.com (www.yahoo.com)|206.190.36.105|:443...
connected.
Created socket 4.
Releasing 0x107800d8 (new refcount 1).

---request begin---
GET / HTTP/1.1
User-Agent: Wget/1.16 (linux-gnu)
Accept: */*
Host: www.yahoo.com
Connection: Keep-Alive

&lt;snip&gt;

---response end---
200 OK
cdm: 1cdm: 1cdm: 1Registered socket 4 for persistent reuse.
URI content encoding = &#8216;utf-8&#8217;
Length: unspecified [text/html]
Saving to: &#8216;index.html&#8217;

May 30 08:38:27 analysis squid: 192.168.1.73 - - [30/May/2015:08:38:27
-0600] &quot;CONNECT 206.190.36.105:443 HTTP/1.1&quot; www.yahoo.com 200 0
TAG_NONE:ORIGINAL_DST peek
May 30 08:38:28 analysis squid: 192.168.1.73 - - [30/May/2015:08:38:28
-0600] &quot;GET <A HREF="https://www.yahoo.com/">https://www.yahoo.com/</A> HTTP/1.1&quot; www.yahoo.com 200 325776
TCP_MISS:ORIGINAL_DST bump

I'm getting close...Amos if you're out there maybe you can shed some
light on the above.  Been at this for 5 hours now..happy Saturday!

James
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150530/5d188703/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150530/5d188703/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003781.html">[squid-users] Squid authetication with Google Apps
</A></li>
	<LI>Next message (by thread): <A HREF="003783.html">[squid-users] Conditional question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3782">[ date ]</a>
              <a href="thread.html#3782">[ thread ]</a>
              <a href="subject.html#3782">[ subject ]</a>
              <a href="author.html#3782">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
