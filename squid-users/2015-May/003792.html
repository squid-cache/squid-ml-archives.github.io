<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Conditional question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Conditional%20question&In-Reply-To=%3C556B9F7D.30006%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003788.html">
   <LINK REL="Next"  HREF="003837.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Conditional question</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Conditional%20question&In-Reply-To=%3C556B9F7D.30006%40treenet.co.nz%3E"
       TITLE="[squid-users] Conditional question">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun May 31 23:55:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="003788.html">[squid-users] Conditional question
</A></li>
        <LI>Next message (by thread): <A HREF="003837.html">[squid-users] Fwd: TOS squid-3.5.0.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3792">[ date ]</a>
              <a href="thread.html#3792">[ thread ]</a>
              <a href="subject.html#3792">[ subject ]</a>
              <a href="author.html#3792">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/05/2015 10:24 a.m., James Lay wrote:
&gt;<i> On Sun, 2015-05-31 at 08:45 +1200, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 31/05/2015 4:48 a.m., James Lay wrote:
</I>&gt;&gt;&gt;<i> Per the docs:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #  Conditional configuration
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> #       If-statements can be used to make configuration directives
</I>&gt;&gt;&gt;<i> #       depend on conditions:
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> #           if &lt;CONDITION&gt;
</I>&gt;&gt;&gt;<i> #               ... regular configuration directives ...
</I>&gt;&gt;&gt;<i> #           [else
</I>&gt;&gt;&gt;<i> #               ... regular configuration directives ...]
</I>&gt;&gt;&gt;<i> #           endif
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> #       The else part is optional. The keywords &quot;if&quot;, &quot;else&quot;, and
</I>&gt;&gt;&gt;<i> &quot;endif&quot;
</I>&gt;&gt;&gt;<i> #       must be typed on their own lines, as if they were regular
</I>&gt;&gt;&gt;<i> #       configuration directives.
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> #       NOTE: An else-if condition is not supported.
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> #       These individual conditions types are supported:
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> #           true
</I>&gt;&gt;&gt;<i> #               Always evaluates to true.
</I>&gt;&gt;&gt;<i> #           false
</I>&gt;&gt;&gt;<i> #               Always evaluates to false.
</I>&gt;&gt;&gt;<i> #           &lt;integer&gt; = &lt;integer&gt;
</I>&gt;&gt;&gt;<i> #               Equality comparison of two integer numbers.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Anyone have any examples, documentation, heck ANYTHING that can show how
</I>&gt;&gt;&gt;<i> this works?  I can't seem to find a thing besides the above.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Those are for process controls (SMP, named services, etc).
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  My goal is
</I>&gt;&gt;&gt;<i> something like the below:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> if port = 80
</I>&gt;&gt;&gt;<i>     http_access deny all
</I>&gt;&gt;&gt;<i> else
</I>&gt;&gt;&gt;<i>     http_access allow all
</I>&gt;&gt;&gt;<i> endif
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But nothing I'm trying as the condition expression is working.  Thank
</I>&gt;&gt;&gt;<i> you.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The default Squid configuration should &quot;just work&quot;...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access deny !Safe_ports
</I>&gt;&gt;<i>   http_access deny CONNECT !SSL_Ports
</I>&gt;&gt;<i>   ...
</I>&gt;&gt;<i>   # this one permits the CONNECT *:443 requests to get bumped
</I>&gt;&gt;<i>   http_access allow localnet
</I>&gt;&gt;<i>   ..
</I>&gt;&gt;<i>   http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are using any other access controls on your client traffic you
</I>&gt;&gt;<i> need to keep in mind that Squid is dealing with &quot;CONNECT raw-IP:443 ...&quot;
</I>&gt;&gt;<i> requests in http_access / adapted_http_access / url_rewrite_access /
</I>&gt;&gt;<i> adaptation_access / ssl_bump prior to bumping them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hi again Amos,
</I>&gt;<i> 
</I>&gt;<i> So...my method of access control might be weird.  I have a regex list of
</I>&gt;<i> sites that work fine via http (say \.acer\.com).  So, I allow access to
</I>&gt;<i> this list via:
</I>&gt;<i> 
</I>&gt;<i> acl allowed_http_sites url_regex &quot;/opt/etc/squid/http_url.txt
</I>&gt;<i> http_access allow allowed_http_sites
</I>&gt;<i> http_access deny !allowed_http_sites
</I>
By using url_regex to match domain names you are preventing any chance
for Squid to perfom reverse-DNS lookup on the raw-IP CONNECT requests
and see if the rDNS site name matches an entry in your list.

If you made that ACL a dstdomain (which is the right type to be matching
domains with) you would see this rDNS behaviour and only have to add
domain entries for sites where the rDNS is different from the popular
domain names.

&gt;<i> 
</I>&gt;<i> This works well for allowing access to the list of sites....the lack of
</I>&gt;<i> http_access allow localnet makes this happen.  With the above however,
</I>&gt;<i> ssl_bumping stops working as I get:
</I>&gt;<i> 
</I>&gt;<i> [16:18:22 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jlay at powerbook</A>:~/test$ wget
</I>&gt;<i> --ca-certificate=/etc/ssl/certs/sslsplit_ca_cert.pem -d
</I>&gt;<i> <A HREF="https://www.msn.com">https://www.msn.com</A>
</I>&gt;<i> DEBUG output created by Wget 1.16 on linux-gnu.
</I>&gt;<i> 
</I>&gt;<i> URI encoding = &#8216;UTF-8&#8217;
</I>&gt;<i> --2015-05-30 16:19:46--  <A HREF="https://www.msn.com/">https://www.msn.com/</A>
</I>&gt;<i> Certificates loaded: 173
</I>&gt;<i> Resolving www.msn.com (www.msn.com)... 204.79.197.203
</I>&gt;<i> Caching www.msn.com =&gt; 204.79.197.203
</I>&gt;<i> Connecting to www.msn.com (www.msn.com)|204.79.197.203|:443...
</I>&gt;<i> connected.
</I>&gt;<i> Created socket 4.
</I>&gt;<i> Releasing 0x10c3ef98 (new refcount 1).
</I>&gt;<i> The certificate's owner does not match hostname &#8216;www.msn.com&#8217;
</I>&gt;<i> 
</I>&gt;<i> May 30 16:19:46 analysis squid: 192.168.1.73 - - [30/May/2015:16:19:46
</I>&gt;<i> -0600] &quot;CONNECT 204.79.197.203:443 HTTP/1.1&quot; - 200 0
</I>&gt;<i> TCP_DENIED:HIER_NONE peek
</I>&gt;<i> 
</I>&gt;<i> Adding http_access alllow localnet makes ssl_bumping work correctly, but
</I>&gt;<i> then the http_access deny !allowed_http_sites does not work.  I'm having
</I>&gt;<i> a hard time getting both http and https filtering to play well together
</I>&gt;<i> with one instance of squid.  I'd like to try and just go with one, but
</I>&gt;<i> if I have to I'll go with two.  Anyway thanks again for looking...I hope
</I>&gt;<i> I'm explaining this well.
</I>
The above mentioned solution, OR as you found allowing all port 443
traffic through to at least the bumping stage will do it.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="003788.html">[squid-users] Conditional question
</A></li>
	<LI>Next message (by thread): <A HREF="003837.html">[squid-users] Fwd: TOS squid-3.5.0.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3792">[ date ]</a>
              <a href="thread.html#3792">[ thread ]</a>
              <a href="subject.html#3792">[ subject ]</a>
              <a href="author.html#3792">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
