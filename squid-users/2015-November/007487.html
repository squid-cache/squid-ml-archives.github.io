<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid with SMP, CARP and a forwarding loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20SMP%2C%20CARP%20and%20a%20forwarding%20loop&In-Reply-To=%3C10757_1446419792_56369D50_10757_31_1_OF67B07B19.ADA40B82-ONCC257EF0.007F9349-CC257EF0.007FDB28%40solnet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007486.html">
   <LINK REL="Next"  HREF="007489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid with SMP, CARP and a forwarding loop</H1>
    <B>Mike.Hodgkinson at solnet.co.nz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20SMP%2C%20CARP%20and%20a%20forwarding%20loop&In-Reply-To=%3C10757_1446419792_56369D50_10757_31_1_OF67B07B19.ADA40B82-ONCC257EF0.007F9349-CC257EF0.007FDB28%40solnet.co.nz%3E"
       TITLE="[squid-users] Squid with SMP, CARP and a forwarding loop">Mike.Hodgkinson at solnet.co.nz
       </A><BR>
    <I>Sun Nov  1 23:16:31 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007486.html">[squid-users] Squid with SMP, CARP and a forwarding loop
</A></li>
        <LI>Next message (by thread): <A HREF="007489.html">[squid-users] Negotiateauthenticator processes are busy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7487">[ date ]</a>
              <a href="thread.html#7487">[ thread ]</a>
              <a href="subject.html#7487">[ subject ]</a>
              <a href="author.html#7487">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Also noticed the typo in my backend config 
http_port 127.0.01:400${process_number}
should have been
http_port 127.0.0.1:400${process_number}

However this change did not help with getting cached results, still goes 
direct.

Mike Hodgkinson
Internal Support Engineer

Mobile  +64 21 754 339
Phone  +64 4 462 5064
Email   <A HREF="https://lists.squid-cache.org/listinfo/squid-users">mike.hodgkinson at solnet.co.nz</A>

Solnet Solutions Limited
Level 12, Solnet House
70 The Terrace, Wellington 6011
PO Box 397, Wellington 6140

www.solnet.co.nz  




From:   <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Mike.Hodgkinson at solnet.co.nz</A>
To:     Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;, 
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Date:   02/11/2015 10:57 a.m.
Subject:        Re: [squid-users] Squid with SMP, CARP and a forwarding 
loop
Sent by:        &quot;squid-users&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt;



Thank you Amos, I was pretty brain drained by the time I posted so please 
excuse my pasting slip up. 

I tried adding  no-netdb-exchange and no-digest to the cache_peer lines, 
the first one eliminated the forward loop warnings but I am still 
experiencing the first request coming from the cache and then subsequent 
requests going direct. Also I did disable the tproxy port. 

I now suspect some sort of logic bug in the code as is shows in the cache 
logs carp.cc is not called a second time before peer_select.cc on the 
second attempt. Unfortunately my programming skills are poor and have 
limited time to look at this issue. 

For now to work-around this behaviour I will use the never_direct 
directive, but if you would like to investigate further I have provided 
level 2 and 3 debug cache logs that you could look at. 
<A HREF="https://droplet-wlg.solnetsolutions.co.nz/public.php?service=files&amp;t=8a3b73eff46a9cf1a91829c0b9d0016a">https://droplet-wlg.solnetsolutions.co.nz/public.php?service=files&amp;t=8a3b73eff46a9cf1a91829c0b9d0016a</A> 


Cheers 

Mike Hodgkinson 
Internal Support Engineer 

Mobile  +64 21 754 339 
Phone  +64 4 462 5064 
Email   <A HREF="https://lists.squid-cache.org/listinfo/squid-users">mike.hodgkinson at solnet.co.nz</A> 

Solnet Solutions Limited
Level 12, Solnet House 
70 The Terrace, Wellington 6011
PO Box 397, Wellington 6140 

www.solnet.co.nz   




From:        Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; 
To:         
Date:        30/10/2015 11:03 p.m. 
Subject:        Re: [squid-users] Squid with SMP, CARP and a forwarding 
loop 
Sent by:        &quot;squid-users&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; 



On 30/10/2015 1:45 p.m., Mike.Hodgkinson wrote:
&gt;<i> I have been attempting to setup a squid forward proxy with one frontend 
</I>&gt;<i> and two backends as per configuration example 
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster">http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster</A>
</I>&gt;<i> 
</I>&gt;<i> My issue is that only the first attempt comes from the cache and then 
</I>&gt;<i> additional requests are downloaded direct by the frontend instead of 
</I>from 
&gt;<i> the backend caches. I suspect it is due to a detected forwarding loop 
</I>&gt;<i> which shows up in the logs:
</I>&gt;<i> 
</I>&gt;<i> 2015/10/30 13:07:49.239 kid1| 44,3| peer_select.cc(137) peerSelect: 
</I>&gt;<i> e:=XIWV/0x7f7bfee2e730*2 <A HREF="http://127.0.0.1:40">http://127.0.0.1:40</A>
</I>&gt;<i> 02/squid-internal-dynamic/netdb
</I>&gt;<i> 2015/10/30 13:07:49.239 kid1| 20,3| store.cc(466) lock: peerSelect 
</I>locked 
&gt;<i> key 64AAA11C8DEF57153B10BA2C9D2F3D60 e:=XIWV/0x7f7bfee2e730*3
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,3| peer_select.cc(441) peerSelectFoo: 
</I>GET 
&gt;<i> 127.0.0.1
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,3| peer_select.cc(468) peerSelectFoo: 
</I>&gt;<i> peerSelectFoo: direct = DIRECT_YES (forwarding loop detected)
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,3| peer_select.cc(477) peerSelectFoo: 
</I>&gt;<i> peerSelectFoo: direct = DIRECT_YES
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,2| peer_select.cc(258) 
</I>&gt;<i> peerSelectDnsPaths: Find IP destination for: 
</I>&gt;<i> <A HREF="http://127.0.0.1:4002/squid-internal-dynamic/netdb">http://127.0.0.1:4002/squid-internal-dynamic/netdb</A>' via 127.0.0.1
</I>&gt;<i> 
</I>&gt;<i> I can force the backend caches to be used successfully with this option 
</I>&gt;<i> &quot;never_direct allow all&quot; however I would like to resolve the underlying 
</I>&gt;<i> issue.
</I>
The above is an internal Squid request from the fontend to its backends.
This one specifically is going direct due to a hack in the code.

You can avoid it by adding &quot;no-netdb-exchange&quot; to the cache_peer lines.
I'm not sure if that will affect the CARP selection since these requests
are one of the types feeding into the peer up/down/overloaded
monitoring. With &quot;no-query&quot; also in use you will be left with the client
HTTP traffic being the only source of that data which carp depends on.

Or using that &quot;never_direct allow all&quot; will override that code hack.

&gt;<i> 
</I>&gt;<i> I have no iptables configured on this server and have made sure the 
</I>&gt;<i> environment variable http_proxy is not set. Also I have tested this on 
</I>&gt;<i> Squid 3.4.8 and 3.5.10 on Debian.
</I>
Since you have no iptables rules configured the traffic arriving in port
3129 will be completely borked.

Either, remove that port 3129 line from the frontend config and use port
3128 for testing until you are ready to setup TPROXY properly;

Or, setup the TPROXY iptables and routing rules and test the proxy
exactly as the clients would be using it.


&gt;<i> 
</I>&gt;<i> My config is below:
</I>&gt;<i> #/etc/squid/squid.conf#
</I>&gt;<i> debug_options = ALL,3
</I>&gt;<i> cachemgr_passwd ******
</I>
NOTE: if that was your actual password you now need to change it.

&gt;<i> acl localnet src 10.1.0.0/16
</I>&gt;<i> acl localnet src 10.2.0.0/16
</I>&gt;<i> acl localnet src 192.168.0.0/23
</I>&gt;<i> acl localnet src fe80::/10
</I>&gt;<i> acl squid_servers src 10.1.209.0/24
</I>
See below...

&lt;snip&gt;
&gt;<i> #/etc/squid/squid-frontend.conf#
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow squid_servers
</I>
With squid_servers IP range being entirely within &quot;localnet&quot; this
&quot;http_access allow squid_servers&quot; line is not doing anything.
You can simplify by removing it.


&gt;<i> htcp_access allow squid_servers
</I>&gt;<i> htcp_access deny all
</I>&gt;<i> cache_peer 127.0.0.1 parent 4002 0 carp login=PASS name=backend-kid2 
</I>&gt;<i> no-query
</I>&gt;<i> cache_peer 127.0.0.1 parent 4003 0 carp login=PASS name=backend-kid3 
</I>&gt;<i> no-query
</I>&gt;<i> prefer_direct off
</I>&gt;<i> nonhierarchical_direct off
</I>&gt;<i> memory_replacement_policy heap LRU
</I>&gt;<i> cache_mem 2048 MB
</I>&gt;<i> access_log /var/log/squid3/frontend.access.log
</I>&gt;<i> cache_log /var/log/squid3/frontend.cache.log
</I>&gt;<i> visible_hostname frontend.cloud.solnet.nz
</I>&gt;<i> 
</I>&gt;<i> #/etc/squid/squid-backend.conf#
</I>&gt;<i> http_port 127.0.01:400${process_number}
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> cache_mem 5 MB
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> maximum_object_size 1 GB
</I>&gt;<i> cache_dir rock /cache/rock 20480 max-size=32768
</I>&gt;<i> cache_dir aufs /cache/${process_number} 20480 128 128 min-size=32769
</I>&gt;<i> visible_hostname backend${process_number}.cloud.solnet.nz
</I>&gt;<i> access_log /var/log/squid3/backend${process_number}.access.log
</I>&gt;<i> cache_log /var/log/squid3/backend${process_number}.cache.log
</I>&gt;<i> 
</I>&gt;<i> I did have visible_hostname set to backend.cloud.solnet.nz but that did 
</I>&gt;<i> not help either.
</I>
Nod. All that did previously was prevent forwarding loops between the
backends in case something unusually nasty happened in the
routing/iptabels layers. What you have now is okay and slightly better
for diagnosing the issues.


Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

Attention: This email may contain information intended for the sole use of 
the original recipient. Please respect this when sharing or disclosing 
this email's contents with any third party. If you believe you have 
received this email in error, please delete it and notify the sender or 
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">postmaster at solnetsolutions.co.nz</A> as soon as possible. The content of this 
email does not necessarily reflect the views of Solnet Solutions Ltd. 
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


Attention:
This email may contain information intended for the sole use of
the original recipient. Please respect this when sharing or
disclosing this email's contents with any third party. If you
believe you have received this email in error, please delete it
and notify the sender or <A HREF="https://lists.squid-cache.org/listinfo/squid-users">postmaster at solnetsolutions.co.nz</A> as
soon as possible. The content of this email does not necessarily
reflect the views of Solnet Solutions Ltd.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151102/570f845d/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151102/570f845d/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007486.html">[squid-users] Squid with SMP, CARP and a forwarding loop
</A></li>
	<LI>Next message (by thread): <A HREF="007489.html">[squid-users] Negotiateauthenticator processes are busy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7487">[ date ]</a>
              <a href="thread.html#7487">[ thread ]</a>
              <a href="subject.html#7487">[ subject ]</a>
              <a href="author.html#7487">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
