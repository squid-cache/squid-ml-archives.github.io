<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl-Bump and revoked server certificates
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-Bump%20and%20revoked%20server%20certificates&In-Reply-To=%3C2F3AADF230295040BDC74C6F96094F3D0224A7FF%40SRVEXAFA.verwaltung.afa-ag.loc%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007579.html">
   <LINK REL="Next"  HREF="007501.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl-Bump and revoked server certificates</H1>
    <B>Sebastian Kirschner</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-Bump%20and%20revoked%20server%20certificates&In-Reply-To=%3C2F3AADF230295040BDC74C6F96094F3D0224A7FF%40SRVEXAFA.verwaltung.afa-ag.loc%3E"
       TITLE="[squid-users] Ssl-Bump and revoked server certificates">s.kirschner at afa-finanz.de
       </A><BR>
    <I>Tue Nov  3 14:09:39 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007579.html">[squid-users] Squit with NTLM and Kerberos auth =&gt; a error
</A></li>
        <LI>Next message (by thread): <A HREF="007501.html">[squid-users] TCP_REFRESH_MODIFIED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7500">[ date ]</a>
              <a href="thread.html#7500">[ thread ]</a>
              <a href="subject.html#7500">[ subject ]</a>
              <a href="author.html#7500">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
regarding my missing programming skills it is hard for me to understand the code.

Regardless of that I have a suggestion that could be added to the code, hope it would work.
These should add a &quot;variable&quot; SNI , these should be &quot;called&quot; from cert_validate_message.h/.cc and appended as new line between host and proto_version to the external validator.

The code between the ** ** is my suggestions.

&lt;PeerConnector.cc (279-286)&gt;
	if (Ssl::TheConfig.ssl_crt_validator) {
        Ssl::CertValidationRequest validationRequest;
        // WARNING: Currently we do not use any locking for any of the
        // members of the Ssl::CertValidationRequest class. In this code the
        // Ssl::CertValidationRequest object used only to pass data to
        // Ssl::CertValidationHelper::submit method.
        validationRequest.ssl = ssl;
        validationRequest.domainName = request-&gt;GetHost();
**		validationRequest.SNI = sniServer;	**
&lt;/PeerConnector.cc&gt;

&lt;cert_validate_message.h (27-32)&gt;
	public:
		SSL *ssl;
		CertErrors *errors; ///&lt; The list of errors detected
		std::string domainName; ///&lt; The server name
**		std::string SNI;		///&lt; The server name from SNI **
		CertValidationRequest() : ssl(NULL), errors(NULL) {}
	};
&lt;/cert_validate_message.h&gt;

&lt;cert_validate_message.cc (21-26)&gt;
	    body.clear();
		body += Ssl::CertValidationMsg::param_host + &quot;=&quot; + vcert.domainName;
		STACK_OF(X509) *peerCerts = static_cast&lt;STACK_OF(X509) *&gt;(SSL_get_ex_data(vcert.ssl, ssl_ex_index_ssl_cert_chain));
		
**		body += &quot;\n&quot; +  Ssl::CertValidationMsg::param_SNI + &quot;=&quot; + vcert.SNI 		**
		
		if (const char *sslVersion = SSL_get_version(vcert.ssl))
			body += &quot;\n&quot; +  Ssl::CertValidationMsg::param_proto_version + &quot;=&quot; + sslVersion;
&lt;/cert_validate_message.cc &gt;

Best Regards
Sebastian

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007579.html">[squid-users] Squit with NTLM and Kerberos auth =&gt; a error
</A></li>
	<LI>Next message (by thread): <A HREF="007501.html">[squid-users] TCP_REFRESH_MODIFIED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7500">[ date ]</a>
              <a href="thread.html#7500">[ thread ]</a>
              <a href="subject.html#7500">[ subject ]</a>
              <a href="author.html#7500">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
