<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20cache_peer%20problem%3A%20Handshake%20fail%0A%20after%20Client%20Hello.&In-Reply-To=%3C563B6295.1050400%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007566.html">
   <LINK REL="Next"  HREF="007606.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20cache_peer%20problem%3A%20Handshake%20fail%0A%20after%20Client%20Hello.&In-Reply-To=%3C563B6295.1050400%40treenet.co.nz%3E"
       TITLE="[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov  5 14:07:17 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007566.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
        <LI>Next message (by thread): <A HREF="007606.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7569">[ date ]</a>
              <a href="thread.html#7569">[ thread ]</a>
              <a href="subject.html#7569">[ subject ]</a>
              <a href="author.html#7569">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/11/2015 12:30 a.m., maple wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> So, if I understand it right, it's impossible to do ssl-bump even I use the
</I>&gt;<i> proxychains to chain the squid with my parent proxy without using
</I>&gt;<i> cache_peer(because I'm confirmed that ssl-bump+cache_peer must not work in
</I>&gt;<i> squid), am I right?
</I>&gt;<i> 
</I>
No that is not what I said. There are multiple (twelve!) different types
of input traffic involved; a querter of them work in Suqid-3.5, half of
them work in Squid-4, and half still do not work yet.

You need to be using the latest 3.5 release (3.5.11) for bumping to work
properly. And upgrade frequently. TLS interception is an arms race
situation where things change almost monthly or even weekly.


&gt;<i> I just wonder how admin900710 make things work by using squid+proxychains
</I>&gt;<i> since he/she look like claim did it if I understand right.
</I>&gt;<i> 
</I>
Start with &quot;What does proxychains deliver to Squid?&quot; that is key to
understanding what needs to be done, and what can be done.


&gt;<i> about your second answer, sorry, I'm not sure I understand it. so I describe
</I>&gt;<i> my environment here again:
</I>&gt;<i> 
</I>&gt;<i> client &lt;---https---&gt; gateway with iptables + squid &lt;---proxychains---&gt; proxy
</I>&gt;<i> mapping port &lt;---ssh tunnel---&gt; http proxy + me &lt;--http/https--&gt; internet
</I>&gt;<i> 
</I>&gt;<i> as you see, client and gateway are all located in internal network, there is
</I>&gt;<i> no NAT device to make int-net to reach http proxy outside, so I setup ssh
</I>&gt;<i> reverse tunnel to map http proxy to int-net(it did like NAT to do port
</I>&gt;<i> mapping, but all traffic built on ssh tunnel).
</I>
Two questions:
 are you the sysadmin for that network?
 and why is there a full separation like that?


The first Squid should be configured with a cache_peer. Using an IP:port
that will go through the ssh tunnel to the remote proxy, and also using
the &quot;ssl&quot; option.

To use proxychains in there, it needs to take the TLS connections from
first squid and just deliver them to second squid without wrapping in a
HTTP CONNECT message.


Since the first Squid now knows the peer is using a secure connection
the first Squid should be okay with sending HTTP requests over the
encrypted link to the peer.


The second proxy should have a https_port to receive the traffic. No
special mode flags are needed here. It is just a proxy receiving
requests that happen to contain <A HREF="https://">https://</A> URLs.



&gt;<i> 
</I>&gt;<i> I can use proxychains to to chain tools like yum/apt or other command line
</I>&gt;<i> tool in int-net with my http proxy, but I need to run automatic script or
</I>&gt;<i> install some complex system in my int-net which sometimes require proxy,
</I>&gt;<i> sometimes not, it's hard to do proxy setting in client side, so transparent
</I>&gt;<i> proxy seems suitable way, so squid is introduced, but it must handle
</I>&gt;<i> https(ssl-bump) and use parent http proxy, how to do it in same time? squid
</I>&gt;<i> apparently not support it, so i want to let squid just play transparent
</I>&gt;<i> proxy role with ssl-bump, and use proxychains to connect it to upstream
</I>&gt;<i> 
</I>&gt;<i> I tried several ways to integrate them, but looks squid just not forward it
</I>&gt;<i> traffic to upstream proxy which proxychains designate, so as I ask above, is
</I>&gt;<i> it possible to let squid forward traffic to other proxy by using 
</I>&gt;<i> proxychains?
</I>&gt;<i> 
</I>
Squid cannot take encrypted traffic and generate a CONNECT to send to
another proxy *over plain-text TCP*.

However, if that other proxy is receiving TLS connections (https_port)
then Squid can deliver secured content there without needing any fancy
CONNECT wrappings.

It is only plain-HTTP proxies which have problems.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007566.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
	<LI>Next message (by thread): <A HREF="007606.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7569">[ date ]</a>
              <a href="thread.html#7569">[ thread ]</a>
              <a href="subject.html#7569">[ subject ]</a>
              <a href="author.html#7569">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
