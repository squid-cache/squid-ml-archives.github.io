<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid: Small packets and low performance between squid and icap
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%3A%20Small%20packets%20and%20low%20performance%20between%0A%20squid%20and%20icap&In-Reply-To=%3CCAMFQPn__moPY3kVvk%3DkF4jETb9j5R7UUR7PEyvsPHvGmgGfrvQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007571.html">
   <LINK REL="Next"  HREF="007554.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid: Small packets and low performance between squid and icap</H1>
    <B>Prashanth Prabhu</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%3A%20Small%20packets%20and%20low%20performance%20between%0A%20squid%20and%20icap&In-Reply-To=%3CCAMFQPn__moPY3kVvk%3DkF4jETb9j5R7UUR7PEyvsPHvGmgGfrvQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid: Small packets and low performance between squid and icap">prashanth.prabhu at gmail.com
       </A><BR>
    <I>Thu Nov  5 19:56:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007571.html">[squid-users] Squid: Small packets and low performance between squid and icap
</A></li>
        <LI>Next message (by thread): <A HREF="007554.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7577">[ date ]</a>
              <a href="thread.html#7577">[ thread ]</a>
              <a href="subject.html#7577">[ subject ]</a>
              <a href="author.html#7577">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

&gt;&gt;<i> I failed to mention that I am on 3.5.1. And, readSomeData() is already &quot;fixed&quot;:
</I>&gt;<i>
</I>&gt;<i> Bug 4353 exists because the initial fix for 4206 was not enough to fully
</I>&gt;<i> remove the behaviour. Sometimes yes, sometimes no.
</I>&gt;<i>
</I>&gt;<i> Only the nasty hack of allocating buffers twice and throwing one away
</I>&gt;<i> unused seems to work fully so far. That is the patch in 4353.
</I>

To be clear, the code in 3.5.1 is already using the
in.maybeMakeSpaceAvailable() call, therefore the patch for 4353 is
useless for me.

It appears that sometime during 3.5.3 the code was modified to use the
following check instead and that is being backed out with 4353.
----
     if (Config.maxRequestBufferSize - in.buf.length() &lt; 2)
----

I thought that perhaps the first patch from 4206 would help, but a
quick test has shown that it doesn't.

Are there any documents on how buffer management is done in Squid? I
am seeing small buffers being used to read from the client-side
connection and I don't quite understand why. Why not read as much as
possible, within the bounds of the space available in the &quot;bodypipe&quot;,
so we maximize the reads?


Regards.
Prashanth

On 5 November 2015 at 07:14, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 5/11/2015 10:41 p.m., Prashanth Prabhu wrote:
</I>&gt;&gt;<i> Hello Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for the quick response.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I failed to mention that I am on 3.5.1. And, readSomeData() is already &quot;fixed&quot;:
</I>&gt;<i>
</I>&gt;<i> Bug 4353 exists because the initial fix for 4206 was not enough to fully
</I>&gt;<i> remove the behaviour. Sometimes yes, sometimes no.
</I>&gt;<i>
</I>&gt;<i> Only the nasty hack of allocating buffers twice and throwing one away
</I>&gt;<i> unused seems to work fully so far. That is the patch in 4353.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> void
</I>&gt;&gt;<i> ConnStateData::readSomeData()
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i>     if (reading())
</I>&gt;&gt;<i>         return;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     debugs(33, 4, HERE &lt;&lt; clientConnection &lt;&lt; &quot;: reading request...&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     if (!in.maybeMakeSpaceAvailable())
</I>&gt;&gt;<i>         return;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     typedef CommCbMemFunT&lt;ConnStateData, CommIoCbParams&gt; Dialer;
</I>&gt;&gt;<i>     reader = JobCallback(33, 5, Dialer, this, ConnStateData::clientReadRequest);
</I>&gt;&gt;<i>     Comm::Read(clientConnection, reader);
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am planning to try the &quot;patch client_side.cc to call
</I>&gt;&gt;<i> maybeMakeSpaceAvailable()&quot; from #4206. Anything else, I should try?
</I>&gt;<i>
</I>&gt;<i> The patch from 4353.
</I>&gt;<i>
</I>&gt;<i> And also upgrading to 3.5.11 unless that was a typo in the version
</I>&gt;<i> number *.1 above.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007571.html">[squid-users] Squid: Small packets and low performance between squid and icap
</A></li>
	<LI>Next message (by thread): <A HREF="007554.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7577">[ date ]</a>
              <a href="thread.html#7577">[ thread ]</a>
              <a href="subject.html#7577">[ subject ]</a>
              <a href="author.html#7577">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
