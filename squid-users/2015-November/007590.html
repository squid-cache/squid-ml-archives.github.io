<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid/NTLM Auth
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid/NTLM%20Auth&In-Reply-To=%3C2f4a903a41324313a9f146ace070053b%40de35s02aexc02.ucc.merckgroup.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007588.html">
   <LINK REL="Next"  HREF="007591.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid/NTLM Auth</H1>
    <B>Keith White</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid/NTLM%20Auth&In-Reply-To=%3C2f4a903a41324313a9f146ace070053b%40de35s02aexc02.ucc.merckgroup.com%3E"
       TITLE="[squid-users] Squid/NTLM Auth">keith.white at emdmillipore.com
       </A><BR>
    <I>Fri Nov  6 19:41:02 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007588.html">[squid-users] Squid3 Authentication Ldap AD
</A></li>
        <LI>Next message (by thread): <A HREF="007591.html">[squid-users] Squid/NTLM Auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7590">[ date ]</a>
              <a href="thread.html#7590">[ thread ]</a>
              <a href="subject.html#7590">[ subject ]</a>
              <a href="author.html#7590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I ran a couple of packet captures and I seen the 407 from the proxy back to the client and the corresponding NTLMSSP_AUTH from the client back to the proxy with my DOMAIN\USER. After this is some Kerberos traffic and then the 407 pops up again.

Thanks,

Keith



-----Original Message-----
From: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>]
Sent: Monday, October 26, 2015 4:24 PM
To: Keith White &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">keith.white at emdmillipore.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid/NTLM Auth

On 24/10/2015 1:44 a.m., Keith White wrote:
&gt;<i> I changed around the DNS servers and still no luck.  This also popped
</I>&gt;<i> up in the log
</I>&gt;<i>
</I>&gt;<i> Acl.cc(70) AuthenticateAcl: returning 2 sending credentials to helper.
</I>&gt;<i> 2015/10/23 05:41:35.259 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> AuthorizedUsers = -1 async
</I>&gt;<i> 2015/10/23 05:41:35.259 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> http_access#3 = -1 async
</I>&gt;<i> 2015/10/23 05:41:35.259 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> http_access = -1 async
</I>&gt;<i> 2015/10/23 05:41:35.259 kid1| ERROR: NTLM Authentication validating
</I>&gt;<i> user. Result: {result=BH, notes={message: NT_STATUS_UNSUCCESSFUL
</I>&gt;<i> NT_STATUS_UNSUCCESSFUL; }}
</I>&gt;<i> 2015/10/23 05:41:35.260 kid1| 29,5| UserRequest.cc(73) valid: Validated. Auth::UserRequest '0x12c1f10'.
</I>&gt;<i>
</I>
IIRC that BH response happens when the helper gets a type-3 token without having been part of the handshake dance that led up to it. The helpers are stateful and the same one needs to be part of the whole handshake.

That can happen if the connection is closed for some reasons after the
type-2 token is sent, and the client is brokenly continuing on a new connection (Firefox is known to do that, others might too).

The connection is allowed to close after the initial 407 challenge. Some clients are broken and require that to happen - which is where the &quot;auth_param ntlm keep_alive off&quot; setting helps.

But not once the type-2 token is sent on the second 407. Squid should be enforcing a persistent TCP connection from then onwards.

The nextstep is to look at either the HTTP messages or the TCP packet level to find out what (if anything) is closing the connection between the type-2 and type-3 token messages thats probably your problem.

Amos



This message and any attachment are confidential and may be privileged or otherwise protected from disclosure. If you are not the intended recipient, you must not copy this message or attachment or disclose the contents to any other person. If you have received this transmission in error, please notify the sender immediately and delete the message and any attachment from your system. Merck KGaA, Darmstadt, Germany and any of its subsidiaries do not accept liability for any omissions or errors in this message which may arise as a result of E-Mail-transmission or for damages resulting from any unauthorized changes of the content of this message and any attachment thereto. Merck KGaA, Darmstadt, Germany and any of its subsidiaries do not guarantee that this message is free of viruses and does not accept liability for any damages caused by any virus transmitted therewith.



Click <A HREF="http://www.merckgroup.com/disclaimer">http://www.merckgroup.com/disclaimer</A> to access the German, French, Spanish and Portuguese versions of this disclaimer.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007588.html">[squid-users] Squid3 Authentication Ldap AD
</A></li>
	<LI>Next message (by thread): <A HREF="007591.html">[squid-users] Squid/NTLM Auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7590">[ date ]</a>
              <a href="thread.html#7590">[ thread ]</a>
              <a href="subject.html#7590">[ subject ]</a>
              <a href="author.html#7590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
