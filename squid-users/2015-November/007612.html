<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent HTTPS Squid proxy with upstream parent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPS%20Squid%20proxy%20with%20upstream%20parent&In-Reply-To=%3C563FE0F1.4050601%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007610.html">
   <LINK REL="Next"  HREF="007924.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent HTTPS Squid proxy with upstream parent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPS%20Squid%20proxy%20with%20upstream%20parent&In-Reply-To=%3C563FE0F1.4050601%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent HTTPS Squid proxy with upstream parent">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Nov  8 23:55:29 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007610.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
        <LI>Next message (by thread): <A HREF="007924.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7612">[ date ]</a>
              <a href="thread.html#7612">[ thread ]</a>
              <a href="subject.html#7612">[ subject ]</a>
              <a href="author.html#7612">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/11/2015 11:55 a.m., Michael Ludvig wrote:
&gt;<i> Hi Amos
</I>&gt;<i> 
</I>&gt;<i> thanks for your reply.
</I>&gt;<i> 
</I>&gt;<i> On 08/11/15 03:27, Amos Jeffries wrote:
</I>&gt;&gt;<i> You are taking secured traffic. Removing the decryption. Then ...
</I>&gt;<i> 
</I>&gt;<i> Yes. Then ... I expected it would make a CONNECT to the upstream proxy
</I>&gt;<i> that would in turn do HTTPS to the target.
</I>&gt;<i> 
</I>&gt;<i> I'm happy with the certificate mismatch.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I get a crash message in cache.log:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2015/11/05 01:07:11 kid1| assertion failed: PeerConnector.cc:116:
</I>&gt;&gt;&gt;<i> &quot;peer-&gt;use_ssl&quot;
</I>&gt;&gt;<i> Attempting to connect and send encryption to a non-encryted peer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Using a current version of Squid should fix that assertion and just not
</I>&gt;&gt;<i> let the peer be used. Your Squid is a whole 2 months old. In the arms
</I>&gt;&gt;<i> race that is SSL-Bump a few months is a long time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid still will not generate new CONNECT to non-encrypted peers though.
</I>&gt;&gt;<i> So you will need to TLS enable the cache_peer link.
</I>&gt;<i> 
</I>&gt;<i> If my proxy talks TLS with the upstream one - will that do the trick? I
</I>&gt;<i> can upgrade to the latest Squid if that should fix the problem.
</I>&gt;<i> 
</I>&gt;<i> However I'm a bit confused with the protocols / certificates involved..
</I>&gt;<i> 
</I>&gt;<i> [client] -&gt; HTTPS -&gt; [my_proxy] -&gt; SSL -&gt; [upstream_proxy] -&gt; HTTPS -&gt;
</I>&gt;<i> [target]
</I>&gt;<i> 
</I>&gt;<i> What protocol is used between [my_proxy] and [upstream_proxy]? It's not
</I>&gt;<i> CONNECT, is it?
</I>
Correct, it is not.

&gt;<i> Is it TLS connection with something like &quot;GET
</I>&gt;<i> <A HREF="https://example.com/">https://example.com/</A> HTTP/1..&quot; passing through?
</I>&gt;<i> 
</I>
Yes.

&gt;<i> Does that also mean the upstream one will have to ssl_bump the
</I>&gt;<i> connection again and re-encrypt with yet another certificate to be able
</I>&gt;<i> to read the target URL?
</I>
No and yes.

No - the upstream proxy is an explicit-/forward- proxy, just receiving
messages over TLS.

Yes - the outbound connection from the peer to the server will use
different TLS connection, thus different certificates.

This type of multiple-hop proxying is one where server-first style of
bumping and certificate minmicing is difficult at best and not possible
in current Squid versions. So whoever is managing the upstream proxy
needs to make sure that it only connects to servers that are properly
secured and verified.


&gt;<i> And also - can I pass non-SSL traffic between my
</I>&gt;<i> proxy and the upstream as well?
</I>
You can. Either over the same TLS link between the proxies, or over a
second cache_peer link.

&gt;<i> 
</I>&gt;<i> Can you provide some config hints for both proxies please? The
</I>&gt;<i> SSL-related bits only as that's the unclear part.
</I>
my_proxy:
 cache_peer example.com 3129 0 ssl

upstream_proxy:
 https_port 3129 cert=/path/to/cert


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007610.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
	<LI>Next message (by thread): <A HREF="007924.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7612">[ date ]</a>
              <a href="thread.html#7612">[ thread ]</a>
              <a href="subject.html#7612">[ subject ]</a>
              <a href="author.html#7612">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
