<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20cache_peer%20problem%3A%20Handshake%20fail%0A%20after%20Client%20Hello.&In-Reply-To=%3C5640C90A.8040404%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007617.html">
   <LINK REL="Next"  HREF="007555.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20cache_peer%20problem%3A%20Handshake%20fail%0A%20after%20Client%20Hello.&In-Reply-To=%3C5640C90A.8040404%40treenet.co.nz%3E"
       TITLE="[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Nov  9 16:25:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007617.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
        <LI>Next message (by thread): <A HREF="007555.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7625">[ date ]</a>
              <a href="thread.html#7625">[ thread ]</a>
              <a href="subject.html#7625">[ subject ]</a>
              <a href="author.html#7625">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/11/2015 10:43 p.m., maple wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> thanks for confirmation, but I'm not sure if my upstream proxy support
</I>&gt;<i> TLS/SSL in that way as you said, but we can use it to proxy both http and
</I>&gt;<i> https request, does it mean it support TLS/SSL?
</I>&gt;<i> 
</I>&gt;<i> To be honest, I'm not familiar with principle of http/https proxy at all,
</I>&gt;<i> for solving this problem, I read some  post about them, http proxy is pretty
</I>&gt;<i> straight-forward, but for https proxy, I'm really confused with its
</I>&gt;<i> explanation from various posts. if possible, could you help to answer my
</I>&gt;<i> some basic questions about it? thanks in advance.
</I>
The principles are outlined in
&lt;<A HREF="http://tools.ietf.org/html/rfc7230#section-2.3">http://tools.ietf.org/html/rfc7230#section-2.3</A>&gt;

Proxying is very simple. The proxy receives the connection interprets
the message, and relays it to an upstream server believed to be able to
handle it.

The 'S' in HTTPS adds only one extra requirement to that. Which is that
the message only be sent over secure connections (&quot;S&quot; / &quot;Secured&quot;). So
an upstream server which is receiving messages over TLS or SSL is able
to handle those messages, but one receiving over TCP cannot since TCP is
not a secure protocol.


&gt;<i> 
</I>&gt;<i> 1 let's talk scenario about explicitly using https proxy on client side in
</I>&gt;<i> first: it's said that client connects to the proxy and makes a CONNECT
</I>&gt;<i> request to setup TCP tunnel between client and server, the https proxy
</I>&gt;<i> blindly forwards data in both directions without knowing anything about the
</I>&gt;<i> contents.
</I>
No. CONNECT is just a HTTP message.

The purpose of CONNECT is to setup a blind tunnel through a proxy. It is
frequently used to tunnel TLS protocol connections over a proxy.

Notice how I avoid &quot;HTTPS&quot; when describing that. TLS can transfer other
protocols than HTTP (aka HTTPS), and CONNECT can setup a tunnel for
other protocols than TLS.

What you are describing above is a just a regular HTTP proxy, relaying
data in a tunnel. It has zero interaction with the security, HTTPS or
anything involved with them beyond the plain-text CONNECT message itself.


&gt;<i> The negotiation of the SSL connection happens over this tunnel,
</I>&gt;<i> and the subsequent flow of requests and responses are completely opaque to
</I>&gt;<i> the proxy.
</I>
Yes. TLS and TCP are just types of connection.

&gt;<i> 
</I>&gt;<i> it's easy to understand, but it seems there is no need for proxy to hack
</I>&gt;<i> https, so why some Man-In-The-Middle proxy like squid make great effort to
</I>&gt;<i> intercept these https traffic? what kind of user case will use this
</I>&gt;<i> intercept function?
</I>
Good question. The answer is that not all software supports HTTP
proxies, and some network admin are too lazy to setup auto-configuration
properly on their networks.

When the client both supports and is configured to use an HTTP proxy,
the above is pretty much exactly how it goes for HTTPS.
The best practice guideline for designing the network setup is
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/ConfiguringBrowsers#Recommended_network_configuration">http://wiki.squid-cache.org/SquidFaq/ConfiguringBrowsers#Recommended_network_configuration</A>&gt;.
Note how interception is almost a last-resort measure.

But when the client is trying to use port 443 the traffic there is not
going to or through the proxy (or not supposed to be). So there is no
CONNECT request wrapper around it for a proxy to handle...


&gt;<i> 
</I>&gt;<i> 2 for transparent mode, as I understand(please correct me if I'm not right),
</I>&gt;<i> it's because that destination hostname/IP is omitted in the CONNECT request,
</I>
There is *no* CONNECT request from the client. What you can see logged
in current Squid is a fake/synthetic one created by Squid based on the
plain-text TCP layer packet details _underneath_ the TLS protocol layer.

We do this so that we only need one set of processing logics inside
Squid and can treat the intercepted connection as if the client had sent
a CONNECT. Either decrypting the TLS inside the tunnel, or relaying it
to to an upstream peer if it is not decrypted.

&gt;<i> so the routing mechanism that has performed the redirection keeps track of
</I>&gt;<i> the original destination, transparent proxy will fetch the original
</I>&gt;<i> destination from routing mechanism,  then perform the same process as
</I>&gt;<i> explicitly using proxy above. 
</I>
Part of that process is determining if the client is atually sending TLS
and decrypting it...

&gt;<i> 
</I>&gt;<i> so for case in my scenario, it seems there is also no reason to use
</I>&gt;<i> intercept way for hack https with transparent mode. why not squid just act
</I>&gt;<i> as forwarder to setup tunnel for https communication between server and
</I>&gt;<i> client? what's it for to make big effort to intercept and create fake
</I>&gt;<i> certificate?
</I>
The process of decrypting the TLS layer inside the CONNECT involves
stripping away the CONNECT (fake or not). Then performing TLS operations
with one or other end of the connection.


If you want just a forwarder that takes port 443 traffic and relays it
as-is through an upstream proxy you can do so by opting *not* to do the
decrypt stages of SSL-Bump. Like so:
 ssl_bump splice all

(You still need the interception part to actually receive the TCP
packets though).


It is only when you want to do things like filter the <A HREF="https://">https://</A> URL the
client is requesting, detailed logging, caching or content adaptation
that you need to to decrypt and loose the ability to relay to insecure
servers.

Also, that ability is only lost because the code doing server
connections lacks ability to generate CONNECT messages yet (only the
code doing TCP intercept can do that right now). It is a missing feature
that gets a lot of complaints, but so far nobody has been willing to do
the work or sponsor it. The hobbyists amoung us are inching slowly
towards it, but not fast.
 (personally I'm working on getting GnuTLS support added so the OS
people can legally distribute Squid with TLS enabled by default and the
need for re-CONNECT disappears. &quot;two birds with one stone&quot; as the saying
goes.)

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007617.html">[squid-users] ssl_bump with cache_peer problem: Handshake fail after Client Hello.
</A></li>
	<LI>Next message (by thread): <A HREF="007555.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7625">[ date ]</a>
              <a href="thread.html#7625">[ thread ]</a>
              <a href="subject.html#7625">[ subject ]</a>
              <a href="author.html#7625">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
