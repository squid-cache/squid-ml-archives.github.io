<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Subject: Re: authentication of every GET request from part of URL?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Subject%3A%20Re%3A%20authentication%20of%20every%20GET%20request%0A%20from%20part%20of%20URL%3F&In-Reply-To=%3CCALgKBSkUH9JUSB5-ZetZitnUYhW0Keik3QQj2rk-wsjC%3DmM%2BBg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007607.html">
   <LINK REL="Next"  HREF="007628.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Subject: Re: authentication of every GET request from part of URL?</H1>
    <B>Sreenath BH</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Subject%3A%20Re%3A%20authentication%20of%20every%20GET%20request%0A%20from%20part%20of%20URL%3F&In-Reply-To=%3CCALgKBSkUH9JUSB5-ZetZitnUYhW0Keik3QQj2rk-wsjC%3DmM%2BBg%40mail.gmail.com%3E"
       TITLE="[squid-users] Subject: Re: authentication of every GET request from part of URL?">bhsreenath at gmail.com
       </A><BR>
    <I>Mon Nov  9 17:12:08 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007607.html">[squid-users] Subject: Re: authentication of every GET request from part of URL?
</A></li>
        <LI>Next message (by thread): <A HREF="007628.html">[squid-users] Subject: Re: authentication of every GET request from part of URL?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7627">[ date ]</a>
              <a href="thread.html#7627">[ thread ]</a>
              <a href="subject.html#7627">[ subject ]</a>
              <a href="author.html#7627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

thanks for your detailed asnwers.

Here are more details.
1. If the URL does not have any token, we would like to send an error
message back to the browser/client, without doing a cache lookup, or
going to backend apache server.

2. If the token is invalid (that is we can't find it in a database),
that means we can not serve
data. In this case we would like to send back a HTTP error (something
like a  401 or 404, along with a more descriptive message)

3. If the token is valid(found), remove the token from the URL, and
use remaining part of URL as the key to look in Squid cache.

4. If found return that data, along with proper HTTP status code.
5. If cache lookup fails(not cached), send HTTP request to back-end
apache server (removing the token), get returned result, store in
cache, and return to client/browser.

I read about ACL helper programs, and it appears I can do arbitrary
validations in it, so should work.
Is it correct to assume that the external ACL code runs before url rewriting?,

Does the URL rewriter run before a cache lookup?

thanks,
Sreenath

On 11/8/15, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 11/08/2015 06:34 AM, Sreenath BH wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Is there a way for me to invoke some custom code for every request
</I>&gt;&gt;<i> that Squid receives?
</I>&gt;<i>
</I>&gt;<i> Yes, there are several interfaces, including a built-in ACL, an external
</I>&gt;<i> ACL helper, a URL rewriter, an eCAP/ICAP service. Roughly speaking, the
</I>&gt;<i> former ones are easier to use and the latter ones are more powerful.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> That script would do the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Extract part of the URL(the token) and look up in a database to see
</I>&gt;&gt;<i> if it is valid.
</I>&gt;&gt;<i>     If valid, proceed to lookup cached object, other wise go to
</I>&gt;&gt;<i> back-end fetch, etc.
</I>&gt;&gt;<i> 2. If the token is not found in database, return with an error, so
</I>&gt;&gt;<i> that Squid can send back a not found type (some HTTP error) of
</I>&gt;&gt;<i> response.
</I>&gt;<i>
</I>&gt;<i> If the above are your requirements, avoid the word &quot;authentication&quot;
</I>&gt;<i> might help. It confuses people into thinking you want something far more
</I>&gt;<i> complex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The validation in step #1 can be done by an external ACL. However, you
</I>&gt;<i> probably forgot to mention that the found token should be removed from
</I>&gt;<i> the URL. To edit the URL, you need to use a URL rewriter or an eCAP/ICAP
</I>&gt;<i> service.
</I>&gt;<i>
</I>&gt;<i> Everything else can be done by built-in ACLs unless you need to serve
</I>&gt;<i> very custom error messages. In the latter case, you will need an eCAP or
</I>&gt;<i> ICAP service.
</I>&gt;<i>
</I>&gt;<i> However, if &quot;go to back-end fetch&quot; means loading response from some
</I>&gt;<i> storage external to Squid without using HTTP, then you need an eCAP or
</I>&gt;<i> ICAP service to do that fetching.
</I>&gt;<i>
</I>&gt;<i> I recommend that you clarify these parts of your specs:
</I>&gt;<i>
</I>&gt;<i> What do you want to do when the token is not found in the URL?
</I>&gt;<i>
</I>&gt;<i> What do you want to do when an invalid token is found in the URL?
</I>&gt;<i>
</I>&gt;<i> Will sending a response using a simple template filled with some basic
</I>&gt;<i> request details suffice when a valid token is not found in the database?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> On 7/11/2015 1:33 a.m., Sreenath BH wrote:
</I>&gt;&gt;&gt;<i> Hi
</I>&gt;&gt;&gt;<i> I am very new to Squid, and think have a strange requirement.
</I>&gt;&gt;&gt;<i> We want to serve cached content only if the client has been
</I>&gt;&gt;&gt;<i> authenticated before.
</I>&gt;&gt;&gt;<i> Since we don't expect the client software to send any information in
</I>&gt;&gt;&gt;<i> headers, we embed a token in the URL that we present to the user.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Um, you know how sending username and password in plain-text Basic auth
</I>&gt;&gt;<i> headers is supposed to be the worst form of security around?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It's not quite. Sending credentials in the URL is worse. Even if its
</I>&gt;&gt;<i> just an encoded token.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why are you avoiding actual HTTP authentication?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why be so actively hostile to every other cache in existence?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So when the client s/w uses this URL, we want to extract the token
</I>&gt;&gt;&gt;<i> from URL and do a small database query to ensure that the token is
</I>&gt;&gt;&gt;<i> valid.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This is in accelerator mode.
</I>&gt;&gt;&gt;<i> Is it possible to use something similar to basic_fake_auth and put my
</I>&gt;&gt;&gt;<i> code there that does some database query?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The &quot;basic_..._auth&quot; parts of that helpers name mean that it performs
</I>&gt;&gt;<i> HTTP Basic authentication.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The &quot;fake&quot; part means that it does not perform any kind of validation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All of the text above has been describing how you want to perform
</I>&gt;&gt;<i> actions which are the direct opposite of everything basic_fake_auth does.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If the query fails, we don't return the cached content?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What do you want to be delivered instead?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007607.html">[squid-users] Subject: Re: authentication of every GET request from part of URL?
</A></li>
	<LI>Next message (by thread): <A HREF="007628.html">[squid-users] Subject: Re: authentication of every GET request from part of URL?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7627">[ date ]</a>
              <a href="thread.html#7627">[ thread ]</a>
              <a href="subject.html#7627">[ subject ]</a>
              <a href="author.html#7627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
