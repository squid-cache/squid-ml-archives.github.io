<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL bumping without faked server certificates
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bumping%20without%20faked%20server%20certificates&In-Reply-To=%3C1447164305.2718.390.camel%40bettermarks.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007659.html">
   <LINK REL="Next"  HREF="007635.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL bumping without faked server certificates</H1>
    <B>Stefan Kutzke</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bumping%20without%20faked%20server%20certificates&In-Reply-To=%3C1447164305.2718.390.camel%40bettermarks.com%3E"
       TITLE="[squid-users] SSL bumping without faked server certificates">stefan.kutzke at bettermarks.com
       </A><BR>
    <I>Tue Nov 10 14:05:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007659.html">[squid-users] cache peer problem with Https only !!
</A></li>
        <LI>Next message (by thread): <A HREF="007635.html">[squid-users] SSL bumping without faked server certificates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7634">[ date ]</a>
              <a href="thread.html#7634">[ thread ]</a>
              <a href="subject.html#7634">[ subject ]</a>
              <a href="author.html#7634">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I needed to setup Squid as a transparent proxy with SSL bumping for only one single https website.
The goal was to bump https connections to this website with its offical signed SSL certificate.

As an illustration:

Website/hostname: <A HREF="https://abc.mydomain.com">https://abc.mydomain.com</A>
DNS: abc.mydomain.com A 1.2.3.4
Official wildcard certificate: CN = *.mydomain.com (server.crt, server.key)

I used Squid 3.4.10 from CentOS repository and configured iptables DNAT rules for intercepting.

Squid config:
https_port &lt;squid-ip&gt;:3443 intercept ssl-bump cert=&lt;server.crt&gt; key=&lt;server.key&gt;
acl MYSITE dst 1.2.3.4
ssl_bump server-first MYSITE
ssl_bump none all

Everything worked perfectly. All traffic to <A HREF="https://abc.mydomain.com">https://abc.mydomain.com</A> was bumped for caching purposes,
all traffic to other https websites was simply tunneled. Squid did not need to generate faked server certificates
and clients were left untouched (no proxy settings, no self-signed CA).

Now some parts of the website are delivered by Amazon CloudFront. CloudFront has the SSL certificate installed
(same official signed certificate as mentiod above).

Additional website/hostname: <A HREF="https://xyz.mydomain.com">https://xyz.mydomain.com</A>
DNS: xyz.mydomain.com CNAME &lt;distribution&gt;.cloudfront.net
Official wildcard certificate: CN = *.mydomain.com (server.crt, server.key)

I cannot simply extend my ACL with all destination IPs used by CloudFront, because these are shared IPs and
CloudFront needs to know which domain/hostname is asked to provide the correct certificate. Usually a client
uses the SNI extension of TLS to transmit the required domain/hostname.

I have heard of the new &quot;SSL Peek and Splice&quot; feature in Squid 3.5 but don't get it working (Squid 3.5.9).

My assumption is that I have to use in Squid's config:
https_port &lt;squid-ip&gt;:3443 intercept ssl-bump cert=&lt;server.crt&gt; key=&lt;server.key&gt;
acl MYSITE ssl:server_name .mydomain.com
ssl_bump bump MYSITE
ssl_bump splice all

This results in tunneling all https traffic, nothing will be bumped and cached. I'm a little bit confused about the
documentation:

Under the headline &quot;Processing steps&quot;:
Step 2:

  1.  Get TLS clientHello info, including SNI where available.

Under the headline &quot;Actions&quot;:
peek/stare Receive client SNI (step1), ...

Is it possible to achieve my goal with Squid in transparent mode?
In other words: Is there a way to bump https connections to destinations with shared IPs?

Best,
Stefan

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151110/c4ba2ed8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151110/c4ba2ed8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007659.html">[squid-users] cache peer problem with Https only !!
</A></li>
	<LI>Next message (by thread): <A HREF="007635.html">[squid-users] SSL bumping without faked server certificates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7634">[ date ]</a>
              <a href="thread.html#7634">[ thread ]</a>
              <a href="subject.html#7634">[ subject ]</a>
              <a href="author.html#7634">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
