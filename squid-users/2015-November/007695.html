<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl bump and url_rewrite_program (like squidguard)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl%20bump%20and%20url_rewrite_program%20%28like%20squidguard%29&In-Reply-To=%3C564460B3.4050309%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007693.html">
   <LINK REL="Next"  HREF="007698.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl bump and url_rewrite_program (like squidguard)</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl%20bump%20and%20url_rewrite_program%20%28like%20squidguard%29&In-Reply-To=%3C564460B3.4050309%40urlfilterdb.com%3E"
       TITLE="[squid-users] ssl bump and url_rewrite_program (like squidguard)">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Thu Nov 12 09:49:39 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007693.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
        <LI>Next message (by thread): <A HREF="007698.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7695">[ date ]</a>
              <a href="thread.html#7695">[ thread ]</a>
              <a href="subject.html#7695">[ subject ]</a>
              <a href="author.html#7695">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 11/12/2015 07:03 AM, Edouard Gaulu&#233; wrote:
&gt;<i> Hi Marcus, Amos and maybe others,
</I>&gt;<i>
</I>&gt;<i> Here were I am. I've looked in the log. Let me describe what I observe. It's maybe linked with some other posts I've read.
</I>&gt;<i>
</I>&gt;<i> Imagine I try to connect to <A HREF="http://ad.doubleclick.net/ad.jpg.">http://ad.doubleclick.net/ad.jpg.</A> I observe the request in wireshark. It goes to the squid process: there is no SSL involved so no bump. Squidguard sends its redirect to
</I>&gt;<i> squid and Squid sends to the browser :
</I>&gt;<i> HTTP/1.1 302 Found
</I>&gt;<i> Server: squid/3.5.10
</I>&gt;<i> Date: Wed, 11 Nov 2015 22:49:44 GMT
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Location: <A HREF="https://proxyweb.xxx.xxx/cgi-bin/squidGuard-simple.cgi?clientaddr=xxx&amp;clientgroup=low-ip&amp;targetgroup=adv&amp;url=http://ad.doubleclick.net/ad.jpg">https://proxyweb.xxx.xxx/cgi-bin/squidGuard-simple.cgi?clientaddr=xxx&amp;clientgroup=low-ip&amp;targetgroup=adv&amp;url=http://ad.doubleclick.net/ad.jpg</A>
</I>&gt;<i> X-Cache: MISS from squid
</I>&gt;<i> X-Cache-Lookup: MISS from squid:3128
</I>&gt;<i> Via: 1.1 squid (squid/3.5.10)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i> The browser next sends a request to proxyweb: everything is fine.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now let's add some SSL stuff and connect to <A HREF="https://ad.doubleclick.net/ad.jpg.">https://ad.doubleclick.net/ad.jpg.</A> I observe the request in wireshark. It goes to the squid process with SSL. Squidguard sends its redirect to squid and
</I>&gt;<i> Squid sends to the browser :
</I>&gt;<i> HTTP/1.1 302 Found
</I>&gt;<i> Server: squid/3.5.10
</I>&gt;<i> Date: Wed, 11 Nov 2015 22:49:44 GMT
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Location: <A HREF="https://proxyweb.xxx.xxx/cgi-bin/squidGuard-simple.cgi?clientaddr=xxx&amp;clientgroup=low-ip&amp;targetgroup=adv&amp;url=http://ad.doubleclick.net/ad.jpg">https://proxyweb.xxx.xxx/cgi-bin/squidGuard-simple.cgi?clientaddr=xxx&amp;clientgroup=low-ip&amp;targetgroup=adv&amp;url=http://ad.doubleclick.net/ad.jpg</A>
</I>&gt;<i> X-Cache: MISS from squid
</I>&gt;<i>
</I>&gt;<i> The browser next tries to send a direct request to <A HREF="https://ad.doubleclick.net">https://ad.doubleclick.net</A> that is never ending as this machine hasn't got the right to go on the Internet.
</I>
This is the strange part!  Why would the browser connect to ad.doubleclick.net if SG redirected the request to proxyweb.xxx.xxx ?
I think you need to increase debug levels of Squid and show the fragments of cache.log where Squid receives the redirection from SG and what happens next.

&gt;<i> Why is the REDIRECT not the same with and without SSL? It looks it disturbs the navigator (at least Mozilla and IE).
</I>
SSL is a protocol designed not to be tampered with.  The SSL protocol has no support for redirection so any redirection by Squid or an other proxy is an attempt to break the SSL protocol.
Redirection with HTTP is simple because the HTTP protocol has a built-in mechanism for redirection that proxies can use.

Marcus

&gt;<i> I can also provide squid logs, but tell me what because I've got a lot...
</I>&gt;<i>
</I>&gt;<i> Regards, EG
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Le 05/11/2015 14:01, Marcus Kool a &#233;crit :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 11/04/2015 08:55 PM, Edouard Gaulu&#233; wrote:
</I>&gt;&gt;&gt;<i> Hi Marcus,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Well that just an URL rewriter program. You can just test it from the command line :
</I>&gt;&gt;&gt;<i> echo &quot;URL&quot; | /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Before I understood it was possible to precise the redirect code I got that:
</I>&gt;&gt;&gt;<i> #&gt; echo
</I>&gt;&gt;&gt;<i> &quot;<A HREF="https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?">https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> - - GET&quot;|/usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>&gt;&gt;&gt;<i> #&gt; OK
</I>&gt;&gt;&gt;<i> rewrite-url=&quot;<A HREF="https://proxyweb.XXXXX.XXXXX/cgi-bin/squidGuard-simple.cgi?clientaddr=-pipo&amp;clientname=&amp;clientuser=&amp;clientgroup=default&amp;targetgroup=unknown&amp;url=https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?">https://proxyweb.XXXXX.XXXXX/cgi-bin/squidGuard-simple.cgi?clientaddr=-pipo&amp;clientname=&amp;clientuser=&amp;clientgroup=default&amp;targetgroup=unknown&amp;url=https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?</A>&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After a little change in the squidguard.conf, I get:
</I>&gt;&gt;&gt;<i> #&gt; OK status=302
</I>&gt;&gt;&gt;<i> url=&quot;<A HREF="https://proxyweb.echoppe.lan/cgi-bin/squidGuard-simple.cgi?clientaddr=-pipo&amp;clientname=&amp;clientuser=&amp;clientgroup=default&amp;targetgroup=unknown&amp;url=https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?">https://proxyweb.echoppe.lan/cgi-bin/squidGuard-simple.cgi?clientaddr=-pipo&amp;clientname=&amp;clientuser=&amp;clientgroup=default&amp;targetgroup=unknown&amp;url=https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?</A>&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This looks fine, so now you need to look at Squid and set the debug options to find out what it is doing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Note that squidGuard does not percent-escape the URL parameter as it should (see RFC 3986).
</I>&gt;&gt;<i> This is, however, most likely not the cause of the issue that you are seeing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Marcus
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It's not so better handled by my browser saying &quot;can't connect to <A HREF="https://ad.doubleclick.net">https://ad.doubleclick.net</A>&quot; message. But, I don't get the squid message anymore regarding http/https.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It may be that rewrite_rule_program come after peek and splice stuff leading squid to an unpredictable situation. Is there a way to play on order things happen in squid?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Regards, EG
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Le 04/11/2015 14:10, Marcus Kool a &#233;crit :
</I>&gt;&gt;&gt;&gt;<i> You need to know what squidGuard actually sends to Squid.
</I>&gt;&gt;&gt;&gt;<i> squidGuard does not have a debug option for this, so you have to set
</I>&gt;&gt;&gt;&gt;<i>    debug_options ALL,1 61,9
</I>&gt;&gt;&gt;&gt;<i> in squid.conf to see what Squid receives.
</I>&gt;&gt;&gt;&gt;<i> I bet that what Squid receives, is what it complains about:
</I>&gt;&gt;&gt;&gt;<i> the URL starts with '<A HREF="https://http">https://http</A>'
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Marcus
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 11/04/2015 10:55 AM, Edouard Gaulu&#233; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Le 04/11/2015 11:00, Amos Jeffries a &#233;crit :
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On 4/11/2015 12:48 p.m., Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> I suspect that the problem is that you redirect a HTTPS-based URL to an
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> HTTP URL and Squid does not like that.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Marcus
</I>&gt;&gt;&gt;&gt;&gt;<i> To give it a try in that direction I now redirect to an https server. And I get :
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The following error was encountered while trying to retrieve the URL: <A HREF="https://https/*">https://https/*</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>     *Unable to determine IP address from host name &quot;https&quot;*
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The DNS server returned:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>     Name Error: The domain name does not exist.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Moreover this would leads sometimes to HTTP-based URL to an HTTPS URL and I don't know how much squid likes it either.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> No it is apparently the fact that the domain name being redirected to is
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> &quot;http&quot;.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> As in:&quot;<A HREF="http://http/something">http://http/something</A>&quot;
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I can assure my rewrite_url looks like &quot;<A HREF="https://proxyweb.xxxxx.xxxxx/var1=xxxx&amp;...">https://proxyweb.xxxxx.xxxxx/var1=xxxx&amp;...</A>&quot;.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> And this confirm ssl_bump parse this result and get the left part before the &quot;:&quot;. To play with, I have also redirect to &quot;proxyweb.xxxxx.xxxxx:443/var1=xxxx&amp;...&quot; (ie. I removed the &quot;<A HREF="https://">https://</A>&quot; and
</I>&gt;&gt;&gt;&gt;&gt;<i> add a
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;:443&quot;) to force the parsing. Then I don't get this message anymore, but Mozilla gets crazy waiting for the ad.doubleclick.net certificate and getting the proxyweb.xxxxx.xxxxx one. And of course it
</I>&gt;&gt;&gt;&gt;&gt;<i> breaks my SG configuration and can't be production solution.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Which brings up the question of why you are using SG to block adverts?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> squid.conf:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>   acl ads dstdomain .doubleclick.net
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>   http_access deny ads
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I don't use SG to specificaly block adverts, I use it to block 90 % of the web. Here it's just an example with ads but it could be with so much other things...
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I just want to try make SG and ssl_bump live together.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Is this possible to have a rule like &quot;if it has been rewrite then don't try to ssl_bump&quot;?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Regards, EG
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007693.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
	<LI>Next message (by thread): <A HREF="007698.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7695">[ date ]</a>
              <a href="thread.html#7695">[ thread ]</a>
              <a href="subject.html#7695">[ subject ]</a>
              <a href="author.html#7695">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
