<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] sslBump and intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%20and%20intercept&In-Reply-To=%3C5644805F.4020706%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007694.html">
   <LINK REL="Next"  HREF="007703.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] sslBump and intercept</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%20and%20intercept&In-Reply-To=%3C5644805F.4020706%40opendium.com%3E"
       TITLE="[squid-users] sslBump and intercept">steve at opendium.com
       </A><BR>
    <I>Thu Nov 12 12:04:47 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007694.html">[squid-users] sslBump and intercept
</A></li>
        <LI>Next message (by thread): <A HREF="007703.html">[squid-users] sslBump and intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7699">[ date ]</a>
              <a href="thread.html#7699">[ thread ]</a>
              <a href="subject.html#7699">[ subject ]</a>
              <a href="author.html#7699">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/11/15 09:04, Eugene M. Zheganin wrote:

&gt;<i> I decided to intercept the HTTPS traffic on my production squids from
</I>&gt;<i> proxy-unware clients to be able to tell them there's a proxy and they
</I>&gt;<i> should configure one.
</I>&gt;<i> So I'm doing it like (the process of forwarding using FreeBSD pf is not
</I>&gt;<i> shown here):
</I>&gt;<i>
</I>&gt;<i> ===Cut===
</I>&gt;<i> acl unauthorized proxy_auth stringthatwillnevermatch
</I>&gt;<i> acl step1 at_step sslBump1
</I>&gt;<i>
</I>&gt;<i> https_port 127.0.0.1:3131 intercept ssl-bump
</I>&gt;<i> cert=/usr/local/etc/squid/certs/squid.cert.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> dhparams=/usr/local/etc/squid/certs/dhparam.pem
</I>&gt;<i> https_port [::1]:3131 intercept ssl-bump
</I>&gt;<i> cert=/usr/local/etc/squid/certs/squid.cert.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> dhparams=/usr/local/etc/squid/certs/dhparam.pem
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump unauthorized
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> ===Cut===
</I>&gt;<i>
</I>&gt;<i> Almost everything works, except that squid for some reason is generating
</I>&gt;<i> certificates in this case for IP addresses, not names, so the browser
</I>&gt;<i> shows a warning abount certificate being valid only for IP, and not name.
</I>
proxy_auth won't work on intercepted traffic and will therefore always 
return false, so as far as I can see you're always going to peek and 
then splice.  i.e. you're never going to bump, so squid should never be 
generating a forged certificate.

You say that Squid _is_ generating a forged certificate, so something 
else is going on to cause it to do that.  My first guess is that Squid 
is generating some kind of error page due to some http_access rules 
which you haven't listed, and is therefore bumping.

Two possibilities spring to mind for the certificate being for the IP 
address rather than for the name:
1. The browser isn't bothering to include an SNI in the SSL handshake 
(use wireshark to confirm).  In this case, Squid has no way to know what 
name to stick in the cert, so will just use the IP instead.
2. The bumping is happening in step 1 instead of step 2 for some reason. 
  See:  <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4327">http://bugs.squid-cache.org/show_bug.cgi?id=4327</A>

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: steve.vcf
Type: text/x-vcard
Size: 283 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151112/8aebf216/attachment.vcf">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151112/8aebf216/attachment.vcf</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007694.html">[squid-users] sslBump and intercept
</A></li>
	<LI>Next message (by thread): <A HREF="007703.html">[squid-users] sslBump and intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7699">[ date ]</a>
              <a href="thread.html#7699">[ thread ]</a>
              <a href="subject.html#7699">[ subject ]</a>
              <a href="author.html#7699">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
