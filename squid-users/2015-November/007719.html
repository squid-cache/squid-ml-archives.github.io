<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot;	directive
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%22bumping%22%20traffic%20despite%20using%20%22splice%22%0A%09directive&In-Reply-To=%3CCAM3U7EykW41xdM6UWSw91jTEDuVUzz2z%3DCWzJ0KN9gzTvDW0ww%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007717.html">
   <LINK REL="Next"  HREF="007720.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot;	directive</H1>
    <B>Tom Mowbray</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%22bumping%22%20traffic%20despite%20using%20%22splice%22%0A%09directive&In-Reply-To=%3CCAM3U7EykW41xdM6UWSw91jTEDuVUzz2z%3DCWzJ0KN9gzTvDW0ww%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot;	directive">tmowbray at dalabs.com
       </A><BR>
    <I>Thu Nov 12 19:48:08 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007717.html">[squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot; directive
</A></li>
        <LI>Next message (by thread): <A HREF="007720.html">[squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot;	directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7719">[ date ]</a>
              <a href="thread.html#7719">[ thread ]</a>
              <a href="subject.html#7719">[ subject ]</a>
              <a href="author.html#7719">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your response.  I don't see anything strange in the access log,
just the initial CONNECT request, but nothing follows because of the error
at the client.  We have squid set to &quot;deny all&quot; on certificate error.

While your suggestions would surely solve the problem, they don't work for
our deployment, as we only want to allow certain sites, so splicing all
will not suffice.  What is strange is that there are no &quot;stare&quot; or &quot;bump&quot;
rules present, yet that appears to be what is happening.

I'll continue to monitor logs and see if I can provide any additional info.

For what it's worth, this is Squid 3.5.11 running on Debian.


---------------------------------
Tom Mowbray
*<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tmowbray at dalabs.com</A>* &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tmowbray at dalabs.com</A>&gt;



*703-829-6694[image: <A HREF="http://www.dalabs.com">http://www.dalabs.com</A>] &lt;<A HREF="http://www.dalabs.com">http://www.dalabs.com</A>&gt;*

On Thu, Nov 12, 2015 at 2:12 PM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 11/12/2015 11:31 AM, Tom Mowbray wrote:
</I>&gt;<i> &gt; We're seeing some strange behavior where certain sites, especially those
</I>&gt;<i> &gt; hosted by Google, including youtube.com &lt;<A HREF="http://youtube.com">http://youtube.com</A>&gt;, where the
</I>&gt;<i> &gt; HTTPS traffic is being &quot;bumped&quot; and users are getting certificate errors
</I>&gt;<i> &gt; with our self-signed certificate and CA appearing in the certificate
</I>&gt;<i> &gt; details.
</I>&gt;<i>
</I>&gt;<i> Can you tell what Squid is sending on some of those bumped connections?
</I>&gt;<i> Could it be an error message? What does access.log say?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; What is strange is that we have the squid.conf set to either &quot;splice&quot; or
</I>&gt;<i> &gt; &quot;terminate&quot; all HTTPS traffic.  There is NO traffic that is supposed to
</I>&gt;<i> &gt; be bumped at all (because we are not able to load our CA cert on all
</I>&gt;<i> &gt; client machines).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here is the significant portion of our squid.conf:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl sslallow ssl::server_name &quot;/path/to/file&quot;
</I>&gt;<i> &gt; ssl_bump peek all
</I>&gt;<i> &gt; ssl_bump splice sslallow
</I>&gt;<i> &gt; ssl_bump terminate all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Most of the sites in acl sslallow work as expected...but some sites come
</I>&gt;<i> &gt; back with a certificate error as described above, suggesting that they
</I>&gt;<i> &gt; were &quot;bumped&quot; using our mimicked certificate.  This behavior also isn't
</I>&gt;<i> &gt; 100% reproducible...sometimes it works as expected, though it usually
</I>&gt;<i> &gt; does not.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Do you tell Squid to splice on all SSL validation errors and when seeing
</I>&gt;<i> non-SSL traffic on expecting-SSL connections? If yes, then this is most
</I>&gt;<i> likely a Squid bug. Otherwise, perhaps Squid is trying to inform users
</I>&gt;<i> of an error? Triage is needed to understand why Squid is bumping.
</I>&gt;<i>
</I>&gt;<i> There is also a possibly related bug 4321, but it should not affect
</I>&gt;<i> steps 2 and 3 where you terminate connections:
</I>&gt;<i> <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4321">http://bugs.squid-cache.org/show_bug.cgi?id=4321</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Another note:  Seems to happen mainly on mobile browsers and on Chrome
</I>&gt;<i> &gt; browser running on Google Chromebooks.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there something I'm missing?  Is there a way to ensure that NO sites
</I>&gt;<i> &gt; are being bumped at all?
</I>&gt;<i>
</I>&gt;<i> Yes, there are (or should be) three ways:
</I>&gt;<i>
</I>&gt;<i> 1. Do not use SslBump at all.
</I>&gt;<i>
</I>&gt;<i> 2. Use &quot;ssl_bump splice all&quot; rule and no other ssl_bump rule.
</I>&gt;<i>
</I>&gt;<i> 3. Do not use any &quot;ssl_bump bump&quot; and &quot;ssl_bump stare&quot; rules while
</I>&gt;<i> allowing all SSL errors and non-SSL traffic.
</I>&gt;<i>
</I>&gt;<i> #1 is known to work. Others may or may not work, depending on your Squid
</I>&gt;<i> version, yet-unknown Squid bugs, and other specifics.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;  (For our deployment, we'd rather terminate
</I>&gt;<i> &gt; than bump if splicing isn't possible).
</I>&gt;<i>
</I>&gt;<i> Your ssl_bump rules reflect your intent. However, when you use &quot;ssl_bump
</I>&gt;<i> peek all&quot;, Squid has to validate SSL clients and servers (to various
</I>&gt;<i> degrees). Other Squid directives tell Squid what to do when that
</I>&gt;<i> validation fails. The ones I remember are on_unsupported_protocol and
</I>&gt;<i> sslproxy_cert_error. Do you configure those directives to ignore all
</I>&gt;<i> errors (and, hence, let users deal with them, including abusing them for
</I>&gt;<i> tunnelling anything through your Squid)?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151112/5f6099ff/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151112/5f6099ff/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007717.html">[squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot; directive
</A></li>
	<LI>Next message (by thread): <A HREF="007720.html">[squid-users] Squid &quot;bumping&quot; traffic despite using &quot;splice&quot;	directive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7719">[ date ]</a>
              <a href="thread.html#7719">[ thread ]</a>
              <a href="subject.html#7719">[ subject ]</a>
              <a href="author.html#7719">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
