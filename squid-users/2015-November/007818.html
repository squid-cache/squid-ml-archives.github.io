<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] sslBump adventures in enterprise production environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%20adventures%20in%20enterprise%20production%0A%20environment&In-Reply-To=%3C564A1C7C.10405%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007795.html">
   <LINK REL="Next"  HREF="007736.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] sslBump adventures in enterprise production environment</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslBump%20adventures%20in%20enterprise%20production%0A%20environment&In-Reply-To=%3C564A1C7C.10405%40measurement-factory.com%3E"
       TITLE="[squid-users] sslBump adventures in enterprise production environment">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Nov 16 18:12:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007795.html">[squid-users] sslBump adventures in enterprise production environment
</A></li>
        <LI>Next message (by thread): <A HREF="007736.html">[squid-users] on_unsupported_protocol doesn't work for bumped https	connecttions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7818">[ date ]</a>
              <a href="thread.html#7818">[ thread ]</a>
              <a href="subject.html#7818">[ subject ]</a>
              <a href="author.html#7818">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/15/2015 11:13 PM, Eugene M. Zheganin wrote:
&gt;<i> On 16.11.2015 00:39, Alex Rousskov wrote:
</I>&gt;&gt;<i>     Squid currently supports two kinds of CONNECT tunnels:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. A regular opaque tunnel, as intended by HTTP specifications.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. An inspected tunnel containing SSL/TLS-encrypted HTTP traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Opaque tunnels are the default. Optional SslBump-related features allow
</I>&gt;&gt;<i> the admin to designate admin-selected CONNECT tunnels for HTTPS
</I>&gt;&gt;<i> inspections (of various depth). This distinction explains why and when
</I>&gt;&gt;<i> Squid expects &quot;HTTPS inside&quot;.
</I>

&gt;<i> Seems like the lack of understanding is my main problem. I read
</I>&gt;<i> Peek/Splice article in wiki on an on, but I just cannot catch it:
</I>&gt;<i> 
</I>&gt;<i> - are the sslBump directives evaluated in order and does the order
</I>&gt;<i> matter (I assume it does) ?
</I>
Yes and yes. This is described in squid.conf.documented IIRC.


&gt;<i> - (the most difficult thing to understand) I just cannot understand the
</I>&gt;<i> &quot;step1&quot; approach. I can understand splice/bump thing - it's like we
</I>&gt;<i> splice or we bump. I cannot understand other stepX-related actions, what
</I>&gt;<i> they do and when do I need'em (and when I do not).
</I>
The wiki describes what each step and each action does. I understand
that those descriptions may not be sufficient. Better documentation is
welcomed, and you are encouraged to ask specific questions to provide
that &quot;better documentation&quot; to yourself and others. You are in a better
position to improve documentation than I am!


&gt;<i> - I cannot understand what is the relation between http_access and
</I>&gt;<i> sslBump, and I assume there is one.
</I>
This is poorly documented indeed. For some additional info, see Squid
bug 4340 summary: <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4340">http://bugs.squid-cache.org/show_bug.cgi?id=4340</A>


&gt;<i> When I first discovered sslBump I
</I>&gt;<i> thought I will be able to block HTTP objects inside HTTPS session - like
</I>&gt;<i> pictures, or particular scripts, or particular MIME types, and it seems
</I>&gt;<i> like I was able to do that, 
</I>
Sure, you can block messages inside a bumped inspected tunnel. Once the
tunnel is bumped (not spliced!), it works almost like a regular HTTP
message stream (but there are exceptions like authentication and peer
selection).

Most difficulties are related to blocking tunnelling attempts
themselves. In other words, blocking CONNECT messages (at various
bumping stages before the tunnel is bumped).


&gt;<i> For example this number of directives is straightforward:
</I>&gt;<i> 
</I>&gt;<i> ===Cut===
</I>&gt;<i> acl foo dst 192.168.0.1
</I>&gt;<i> acl bar dst 192.168.0.2
</I>&gt;<i> 
</I>&gt;<i> sslBump bump foo
</I>&gt;<i> sslBump splice bar
</I>&gt;<i> ===Cut===
</I>&gt;<i> 
</I>&gt;<i> It's one dst we bump and the other we splice.
</I>
The above configuration is not as &quot;straightforward&quot; as you might think:

* If you are dealing with real CONNECT requests (not intercepted
tunnels), a real CONNECT request may be for a host name and Squid will
need to look up the IP address. This may affect dst matching.

* You did not tell Squid what to do when neither dst matches. There were
bugs in this area. The latest Squids should splice (but if you add more
ssl_bump rules, they may affect the default action). IIRC, this is
described in squid.conf.documented.

* Bumping (even at step1) requires SSL/TLS validations of various kinds.
Those validations may lead to errors.

* Bumping at step1 may be subject to the following Squid bug:
  <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4327">http://bugs.squid-cache.org/show_bug.cgi?id=4327</A>


&gt;<i> Can you describe a situation when I need to peek or stare?
</I>
You need to peek or stare if you need SSL/TLS handshake information to
make a final bump/splice/terminate/block decision. For example,

* Your ACLs need host names, not IP addresses. Even in a forwarding
environment (i.e., real CONNECT requests), host names may not be
available without peeking or staring (or reverse DNS lookups, but those
are rarely reliable).

* Your ACLs need origin server certificate details.

* You do not want to splice connections to origin servers that have
revoked SSL certificates.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007795.html">[squid-users] sslBump adventures in enterprise production environment
</A></li>
	<LI>Next message (by thread): <A HREF="007736.html">[squid-users] on_unsupported_protocol doesn't work for bumped https	connecttions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7818">[ date ]</a>
              <a href="thread.html#7818">[ thread ]</a>
              <a href="subject.html#7818">[ subject ]</a>
              <a href="author.html#7818">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
