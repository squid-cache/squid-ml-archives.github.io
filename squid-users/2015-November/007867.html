<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] on_unsupported_protocol doesn't work for bumped https connecttions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20on_unsupported_protocol%20doesn%27t%20work%20for%20bumped%0A%20https%20connecttions&In-Reply-To=%3C564C9F67.7080904%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007861.html">
   <LINK REL="Next"  HREF="007738.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] on_unsupported_protocol doesn't work for bumped https connecttions</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20on_unsupported_protocol%20doesn%27t%20work%20for%20bumped%0A%20https%20connecttions&In-Reply-To=%3C564C9F67.7080904%40measurement-factory.com%3E"
       TITLE="[squid-users] on_unsupported_protocol doesn't work for bumped https connecttions">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 18 15:55:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007861.html">[squid-users] on_unsupported_protocol doesn't work for bumped https connecttions
</A></li>
        <LI>Next message (by thread): <A HREF="007738.html">[squid-users] strange behavior with systemd
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7867">[ date ]</a>
              <a href="thread.html#7867">[ thread ]</a>
              <a href="subject.html#7867">[ subject ]</a>
              <a href="author.html#7867">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/18/2015 12:53 AM, Tarik Demirci wrote:

&gt;<i> I did more detailed tests for this case. Constructing a tcp-in-https
</I>&gt;<i> connection results with error ERR_PROTOCOL_UNKNOWN in spite of
</I>&gt;<i> &quot;on_unsupported_protocol tunnel all&quot; conf directive. Is this a Squid
</I>&gt;<i> bug? Doc for on_unsupported_protocol says it works for bumped tunnels
</I>&gt;<i> but I can't confirm this in any way.
</I>&gt;<i> 
</I>&gt;<i> I debugged the code and it fails in a check in clientTunnelOnError
</I>&gt;<i> function. By the time Squid understands it's not http inside https,
</I>&gt;<i> conn-&gt;nrequests value is 2. So conn-&gt;nrequests &lt;= 1 check fails.
</I>

This is a development topic. Consider moving this thread to squid-dev.

AFAICT, the intended goal of the nrequests check is to prevent switching
to tunnel mode after the tunnel has already been proven to carry a
&quot;supported&quot; protocol (i.e., HTTPS or HTTP).

I do not think that nrequests check is correct: The nrequests member is
incremented on every request, so it may be very large if a browser
switches to a tunnel after sending many regular requests:

  GET
  GET
  GET
  CONNECT

I also suspect the check is difficult to get right because fake CONNECTs
on intercepted connections and real CONNECTs on forwarded connections
might be counted differently. I did not verify that, but it may explain
why you are hitting this bug -- the code may have been tested with
intercepted connections only and just &quot;assumed&quot; to work for CONNECT
tunnels as well.

I recommend replacing nrequests check with a check based on a new
tooLateToTunnel boolean data member. That member can be initialized to
false and set to true after receiving valid HTTP request headers inside
an inspected connection (at least).


Thank you,

Alex.


&gt;<i> Here how I did the test:
</I>&gt;<i> - Install stunnel to both 'Netcat Server' and 'Client'.
</I>&gt;<i> - Add Issuer CA of the stunnel certificate to trusted authorities of
</I>&gt;<i> 'Squid Box'.
</I>&gt;<i> - Open a tcp connection with netcat through stunnel.
</I>&gt;<i> 
</I>&gt;<i> This results with familiar ERR_PROTOCOL_UNKNOWN.
</I>&gt;<i> 
</I>&gt;<i> Note: I'm confident that https setup is correct because redirecting
</I>&gt;<i> traffic to nginx instead of netcat results with a successfull
</I>&gt;<i> connection.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007861.html">[squid-users] on_unsupported_protocol doesn't work for bumped https connecttions
</A></li>
	<LI>Next message (by thread): <A HREF="007738.html">[squid-users] strange behavior with systemd
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7867">[ date ]</a>
              <a href="thread.html#7867">[ thread ]</a>
              <a href="subject.html#7867">[ subject ]</a>
              <a href="author.html#7867">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
