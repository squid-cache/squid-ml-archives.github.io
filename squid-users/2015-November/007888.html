<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help! Squid Host header rewriting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%21%20Squid%20Host%20header%20rewriting&In-Reply-To=%3C564E6E0B.7000605%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007884.html">
   <LINK REL="Next"  HREF="007881.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help! Squid Host header rewriting</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%21%20Squid%20Host%20header%20rewriting&In-Reply-To=%3C564E6E0B.7000605%40treenet.co.nz%3E"
       TITLE="[squid-users] Help! Squid Host header rewriting">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Nov 20 00:49:15 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007884.html">[squid-users] Help! Squid Host header rewriting
</A></li>
        <LI>Next message (by thread): <A HREF="007881.html">[squid-users] tcp_miss_aborted/000, requester sends RST packet to squid immediately
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7888">[ date ]</a>
              <a href="thread.html#7888">[ thread ]</a>
              <a href="subject.html#7888">[ subject ]</a>
              <a href="author.html#7888">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/11/2015 3:29 a.m., LauranceKuo wrote:
&gt;<i> Thanks for the quick response.
</I>&gt;<i> 
</I>&gt;<i> I quoted the link to show my problem. Below is the detail.
</I>&gt;<i> 
</I>&gt;<i> First, the version of Squid I am using is 3.5.4.
</I>&gt;<i> 
</I>&gt;<i> And, this is the http request from client to Squid:
</I>&gt;<i> /GET
</I>&gt;<i> <A HREF="http://122.228.56.30/snsvideodownload?filekey=30270201010420301e0201660402534804100d9d070ab465cfc2259e39ffd4a63cad020303f7550400&amp;bizid=1023&amp;hy=SH&amp;fileparam=302f0201010428302602044c9650540204564dcc5b02024eea02031e867502030f42400204b01ba80a0204f75de2650400">http://122.228.56.30/snsvideodownload?filekey=30270201010420301e0201660402534804100d9d070ab465cfc2259e39ffd4a63cad020303f7550400&amp;bizid=1023&amp;hy=SH&amp;fileparam=302f0201010428302602044c9650540204564dcc5b02024eea02031e867502030f42400204b01ba80a0204f75de2650400</A>
</I>&gt;<i> HTTP/1.1
</I>&gt;<i> Host: vweixinf.tc.qq.com
</I>&gt;<i> .../
</I>&gt;<i> 
</I>&gt;<i> and, this is the http request from Squid to server:
</I>&gt;<i> /GET
</I>&gt;<i> /snsvideodownload?filekey=30270201010420301e0201660402534804100d9d070ab465cfc2259e39ffd4a63cad020303f7550400&amp;bizid=1023&amp;hy=SH&amp;fileparam=302f0201010428302602044c9650540204564dcc5b02024eea02031e867502030f42400204b01ba80a0204f75de2650400
</I>&gt;<i> HTTP/1.1
</I>&gt;<i> Host: 122.228.56.30
</I>&gt;<i> .../
</I>&gt;<i> 
</I>&gt;<i> and the server responses with:
</I>&gt;<i> /HTTP/1.1 404 Not Found/
</I>&gt;<i> 
</I>&gt;<i> And the client is WeChat, which is a very popular APP in China. I can't tell
</I>&gt;<i> them to correct this.
</I>
You can ask. Like any software they have incentive to fix it and get
their software working in more networks.

PS. Squid is also popular software. China is only one of many countries
whose HTTP traffic is relayed wholly by Squid. And the HTTP in/out of
China is surprisingly small compared to the countries population size.


But you first need to be sure it is their software and not something
else on the delivery path between QQ and Squid.

This type of raw-IP in URL with textual Host header can be the output of
other proxy/router/loadbalancer software or devices doing traffic
interception and wrongly using that type of output message as their
broken attempt at fixing CVE-2009-0801.


&gt;<i> So is there a way to keep this http request the same?
</I>
Not without breaking the Internet.

These are the mandatory (&quot;MUST&quot;) requirements placed on Squid :

RFC 7230 (HTTP/1.1)
&quot;
   If the target URI includes an authority component, then a
   client MUST send a field-value for Host that is identical to that
   authority component, ...
&quot;

NOTE: The 'authority component' in the URI is the raw-IP part
(122.228.56.30). On the outgoing connection Squid is the client /
sender. QQ or whatever is sending that message to Squid is violating
this mandatory requirement in its own role as client.

&quot;
   When a proxy receives a request with an absolute-form of
   request-target, the proxy MUST ignore the received Host header field
   (if any) and instead replace it with the host information of the
   request-target.  A proxy that forwards such a request MUST generate a
   new Host field-value based on the received request-target rather than
   forward the received Host field-value.

   Since the Host header field acts as an application-level routing
   mechanism, it is a frequent target for malware seeking to poison a
   shared cache or redirect a request to an unintended server.  An
   interception proxy is particularly vulnerable if it relies on the
   Host field-value for redirecting requests to internal servers, or for
   use as a cache key in a shared cache, without first verifying that
   the intercepted connection is targeting a valid IP address for that
   host.

   A server MUST respond with a 400 (Bad Request) status code to any
   HTTP/1.1 request message that lacks a Host header field and to any
   request message that contains more than one Host header field or a
   Host header field with an invalid field-value.
&quot;


There are a lot of apps that do similar odd things to what you are
seeing, but in the opposite direction, like put raw-IP or unusual port
numbers in the Host header. They would all break in the same sort of way
you are seeing here, and there are more of them in wider use than QQ.
Then there are all the apps that use Host like &quot;localhost&quot; or &quot;Home&quot;
(grumble).

Then that security vulnerability I referenced in the original thread way
back, and all the malware trying to use it. One of the things behind
that specification warning. The Host header is completely open to
control by third-party attackers. I refer here not to the client or the
app they are using but to anyone writing embedded adverts or web pages
it is displaying.
The danger is amazingly big for such a simple thing - amongst the side
effects are problems such as bypassing all your network firewall
protections (including the proxies own access controls), or causing your
cache to store infected malware and deliver it to every client on your
network (turning your proxy into a zombie infection source).


&gt;<i> Or, the only way is to revise the source code?
</I>
Please don't. The reasons behind this behaviour are very important to
protect against.

If you do, then you also need to ensure that the traffic through the
altered proxy is never cached. By your proxy or by anyone receiving its
responses.

You would do better investigating what ports (if any) QQ tries to use
for its own custom protocol and letting those through the firewall. Or
tryig to find and fix the source of the original broken HTTP message.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007884.html">[squid-users] Help! Squid Host header rewriting
</A></li>
	<LI>Next message (by thread): <A HREF="007881.html">[squid-users] tcp_miss_aborted/000, requester sends RST packet to squid immediately
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7888">[ date ]</a>
              <a href="thread.html#7888">[ thread ]</a>
              <a href="subject.html#7888">[ subject ]</a>
              <a href="author.html#7888">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
