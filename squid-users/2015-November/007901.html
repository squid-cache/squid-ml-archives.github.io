<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] file descriptors leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C20151122011022.Horde.yNO89VXlhLk9DdWU9nfO8LK%40webmail.brazcubas.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007918.html">
   <LINK REL="Next"  HREF="007902.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] file descriptors leak</H1>
    <B>Andr&#233; Janna</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C20151122011022.Horde.yNO89VXlhLk9DdWU9nfO8LK%40webmail.brazcubas.br%3E"
       TITLE="[squid-users] file descriptors leak">andre61 at brazcubas.br
       </A><BR>
    <I>Sun Nov 22 03:10:22 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007918.html">[squid-users] squid intercept mode fo http &amp; https
</A></li>
        <LI>Next message (by thread): <A HREF="007902.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7901">[ date ]</a>
              <a href="thread.html#7901">[ thread ]</a>
              <a href="subject.html#7901">[ subject ]</a>
              <a href="author.html#7901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm running Squid 3.5.10 on Debian Jessie and after some hours of execution
it runs out of file descriptors.
Squid is listening on port 3125, 3126 and 3127.
Port 3126 is used for intercepting, via iptables redirect, https
connections mostly from mobile devices like smartphones. On this port is
active ssl-bump but I'm not decrypting https traffic, only &quot;peek&quot; to get
https server host name.
Port 3125 is used for intercepting http connections of the same mobile
devices whose https traffic is intercepted on port 3126.
Port 3127 is used for clients configured to use a proxy.
Leaked file descriptors are all related to connection on port 3126 (https
intercept ssl-bump).
A sample output of lsof command gives:

&#160;&#160; &#160;squid&#160;&#160;&#160;&#160; 32490&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; proxy&#160;&#160; 12u&#160;&#160;&#160;&#160;
IPv6&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4065613&#160;&#160;&#160;&#160;&#160;&#160; 0t0&#160;&#160;&#160;&#160;&#160;&#160;&#160; TCP
172.16.10.22:3126-&gt;192.168.93.113:55815 (CLOSE_WAIT)
&#160;&#160; &#160;squid&#160;&#160;&#160;&#160; 32490&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; proxy&#160;&#160; 14u&#160;&#160;&#160;&#160;
IPv6&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4097822&#160;&#160;&#160;&#160;&#160;&#160; 0t0&#160;&#160;&#160;&#160;&#160;&#160;&#160; TCP
172.16.10.22:3126-&gt;192.168.90.207:52288 (ESTABLISHED)
&#160;&#160; &#160;...

where 172.16.10.22 is an IP address of my Squid installation and
192.168.x.x are mobile devices.
Is seems that this condition is triggered by &quot;local IP does not match any
domain IP&quot; error logged by Squid in cache.log, but I'm not sure if all
stuck connections are caused by this kind of error.
For the 2 connections of the sample above the related cache.log errors are:

&#160;&#160; &#160;2015/11/21 12:57:51.229 kid1| SECURITY ALERT: Host header forgery
detected on local=23.0.163.57:443 remote=192.168.93.113:55815 FD 12
flags=33 (local IP does not match any domain IP)
&#160;&#160; &#160;2015/11/21 13:59:44.230 kid1| SECURITY ALERT: Host header forgery
detected on local=198.144.127.162:443 remote=192.168.90.207:52288 FD 14
flags=33 (local IP does not match any domain IP)

&quot;lsof&quot; sample output was taken more that 10 hours after Squid logged these
errors and it shows that Squid is still holding connections open, using a
lot of file descriptors.

Regards,
&#160;&#160; &#160;Andr&#233;

--- my squid.conf ---
acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160; # RFC1918 possible internal network
acl localnet src 172.16.0.0/12&#160; # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl SSL_ports port 443
acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http
acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp
acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https
acl CONNECT method CONNECT
acl squid-internal-static url_regex
^<A HREF="http://nat-academico:3127/squid-internal-static/">http://nat-academico:3127/squid-internal-static/</A>
acl e2guardian localport 3127
follow_x_forwarded_for allow localhost
http_access allow squid-internal-static
http_access allow localhost manager
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny to_localhost
http_access allow localhost
http_access allow localnet e2guardian
include /etc/squid/transparent-blacklist.conf
include /etc/squid/transparent-whitelist.conf
http_access allow transparent-whitelist-http
http_access deny transparent-blacklist-http
http_access allow localnet
http_access deny all
http_port 3127
http_port 3125 intercept
https_port 3126 cert=/etc/ssl/certs/nat-academico.crt
key=/etc/ssl/private/services.key intercept ssl-bump
acl step1 at_step SslBump1
ssl_bump peek step1 all
ssl_bump splice transparent-whitelist-https
ssl_bump terminate transparent-blacklist-https
cache_dir ufs /var/spool/squid 10000 16 256
coredump_dir /var/spool/squid
refresh_pattern ^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 10080
refresh_pattern ^gopher:&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 1440
refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0
refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160;
4320
dns_v4_first on
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151122/e7d15635/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151122/e7d15635/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007918.html">[squid-users] squid intercept mode fo http &amp; https
</A></li>
	<LI>Next message (by thread): <A HREF="007902.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7901">[ date ]</a>
              <a href="thread.html#7901">[ thread ]</a>
              <a href="subject.html#7901">[ subject ]</a>
              <a href="author.html#7901">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
