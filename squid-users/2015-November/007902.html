<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] file descriptors leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C56515624.109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007901.html">
   <LINK REL="Next"  HREF="007904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] file descriptors leak</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C56515624.109%40treenet.co.nz%3E"
       TITLE="[squid-users] file descriptors leak">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Nov 22 05:44:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007901.html">[squid-users] file descriptors leak
</A></li>
        <LI>Next message (by thread): <A HREF="007904.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7902">[ date ]</a>
              <a href="thread.html#7902">[ thread ]</a>
              <a href="subject.html#7902">[ subject ]</a>
              <a href="author.html#7902">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/11/2015 4:10 p.m., Andr&#233; Janna wrote:
&gt;<i> I'm running Squid 3.5.10 on Debian Jessie and after some hours of execution
</I>&gt;<i> it runs out of file descriptors.
</I>&gt;<i> Squid is listening on port 3125, 3126 and 3127.
</I>&gt;<i> Port 3126 is used for intercepting, via iptables redirect, https
</I>&gt;<i> connections mostly from mobile devices like smartphones. On this port is
</I>&gt;<i> active ssl-bump but I'm not decrypting https traffic, only &quot;peek&quot; to get
</I>&gt;<i> https server host name.
</I>&gt;<i> Port 3125 is used for intercepting http connections of the same mobile
</I>&gt;<i> devices whose https traffic is intercepted on port 3126.
</I>&gt;<i> Port 3127 is used for clients configured to use a proxy.
</I>&gt;<i> Leaked file descriptors are all related to connection on port 3126 (https
</I>&gt;<i> intercept ssl-bump).
</I>&gt;<i> A sample output of lsof command gives:
</I>&gt;<i> 
</I>&gt;<i>     squid     32490            proxy   12u    
</I>&gt;<i> IPv6            4065613       0t0        TCP
</I>&gt;<i> 172.16.10.22:3126-&gt;192.168.93.113:55815 (CLOSE_WAIT)
</I>&gt;<i>     squid     32490            proxy   14u    
</I>&gt;<i> IPv6            4097822       0t0        TCP
</I>&gt;<i> 172.16.10.22:3126-&gt;192.168.90.207:52288 (ESTABLISHED)
</I>&gt;<i>     ...
</I>&gt;<i> 
</I>&gt;<i> where 172.16.10.22 is an IP address of my Squid installation and
</I>&gt;<i> 192.168.x.x are mobile devices.
</I>&gt;<i> Is seems that this condition is triggered by &quot;local IP does not match any
</I>&gt;<i> domain IP&quot; error logged by Squid in cache.log, but I'm not sure if all
</I>&gt;<i> stuck connections are caused by this kind of error.
</I>&gt;<i> For the 2 connections of the sample above the related cache.log errors are:
</I>&gt;<i> 
</I>&gt;<i>     2015/11/21 12:57:51.229 kid1| SECURITY ALERT: Host header forgery
</I>&gt;<i> detected on local=23.0.163.57:443 remote=192.168.93.113:55815 FD 12
</I>&gt;<i> flags=33 (local IP does not match any domain IP)
</I>&gt;<i>     2015/11/21 13:59:44.230 kid1| SECURITY ALERT: Host header forgery
</I>&gt;<i> detected on local=198.144.127.162:443 remote=192.168.90.207:52288 FD 14
</I>&gt;<i> flags=33 (local IP does not match any domain IP)
</I>&gt;<i> 
</I>&gt;<i> &quot;lsof&quot; sample output was taken more that 10 hours after Squid logged these
</I>&gt;<i> errors and it shows that Squid is still holding connections open, using a
</I>&gt;<i> lot of file descriptors.
</I>
In HTTP connections stay open and get used for many requests.

You are however assuming that the connection actually contains HTTP.
There is no guarantee of that without bumping the decrypt and parsing
the content inside. There are a number of non-HTTP/1.1 protocols that
use port 443 to bypass proxy and firewall security.

CONNECT requests with tunnels can be particularly long lived, mobiles
and their applications stay active for weeks on end with few outward
signs of what is happening inside the encrypted tunnel. The only way to
be sure the connection is finished with is when one of the client or
server remote endpoints closes it.

* The port 55815 connection _was_ closed sometimes within 15 mintes of
the lsof being run.

* The port 52288 connection is still being used.

Given the timespan between those messages and the lsof, it is also
possible they were closed and reopened in between. If you have a lot of
ports in active use, then re-use of closed ones becomes more likely.
Though I suspect it is just persistence doing what it is designed to do.
You will need a more detailed trace of the entire time period to know.


PS. don't confuse file descriptors with ports. There as an absolute
maximum of 64K ports per IP on each device. But sockets FD can reach
millions, if you run out of FD just configure more to be allowed.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007901.html">[squid-users] file descriptors leak
</A></li>
	<LI>Next message (by thread): <A HREF="007904.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7902">[ date ]</a>
              <a href="thread.html#7902">[ thread ]</a>
              <a href="subject.html#7902">[ subject ]</a>
              <a href="author.html#7902">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
