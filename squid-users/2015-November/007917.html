<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] file descriptors leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C56535EE1.6040809%40brazcubas.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007912.html">
   <LINK REL="Next"  HREF="007923.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] file descriptors leak</H1>
    <B>Andr&#233; Janna</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C56535EE1.6040809%40brazcubas.br%3E"
       TITLE="[squid-users] file descriptors leak">andre61 at brazcubas.br
       </A><BR>
    <I>Mon Nov 23 18:45:53 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007912.html">[squid-users] file descriptors leak
</A></li>
        <LI>Next message (by thread): <A HREF="007923.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7917">[ date ]</a>
              <a href="thread.html#7917">[ thread ]</a>
              <a href="subject.html#7917">[ subject ]</a>
              <a href="author.html#7917">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Assin Em 22/11/2015 16:25, Eliezer Croitoru escreveu:
&gt;<i> Hey Andre,
</I>&gt;<i>
</I>&gt;<i> There are couple things to the picture.
</I>&gt;<i> It's not only squid that is the &quot;blame&quot;.
</I>&gt;<i> It depends on what your OS tcp stack settings are.
</I>&gt;<i> To verify couple things you can try to use the netstat tool.
</I>&gt;<i> run the command &quot;netstat -nto&quot; to see what is the timers status.
</I>&gt;<i> You can then see how long will a new connection stay in the 
</I>&gt;<i> established state.
</I>&gt;<i> It might be the squid settings but if the client is not there it could 
</I>&gt;<i> be because of some tcp tunable kernel settings.
</I>
Hi Eliezer and Amos,
my kernel is a regular Debian Jessie kernel using the following tcp values.
     tcp_keepalive_time: 7200
     tcp_keepalive_intvl: 25
     tcp_keepalive_probes: 9
     tcp_retries1: 3
     tcp_retries2: 15
     tcp_fin_timeout: 60
So in my understanding the longest timeout is set to 2 hours and a few 
minutes for keepalive connections.

Today I monitored file descriptors 23 and 24 on my box during 5 hours 
and lsof always showed:
     squid      6574           proxy   23u     IPv6 5320944      
0t0        TCP 172.16.10.22:3126-&gt;192.168.90.35:34571 (CLOSE_WAIT)
     squid      6574           proxy   24u     IPv6 5327276      
0t0        TCP 172.16.10.22:3126-&gt;192.168.89.236:49435 (ESTABLISHED)
while netstat always showed:
     tcp6       1      0 172.16.10.22:3126 192.168.90.35:34571     
CLOSE_WAIT  6574/(squid-1)   off (0.00/0/0)
     tcp6       0      0 172.16.10.22:3126 192.168.89.236:49435    
ESTABLISHED 6574/(squid-1)   off (0.00/0/0)

The &quot;off&quot; flag in netstat output tells that for these sockets keepalive 
and retransmission timers are disabled.
Right now netstat shows 15,568 connections on squid port 3126 and only 
107 have timer set to a value other than &quot;off&quot;.

I read that connections that are in CLOSE_WAIT state don't have any tcp 
timeout, it's Squid that must close the socket.

  About the connections in ESTABLISHED state, I monitored the connection 
to mobile device 192.168.89.236 using &quot;tcpdump -i eth2 -n host 
192.168.89.236&quot; during 2 hours and a half.
Tcpdump didn't record any packet and netstat is still displaying:
     tcp6       1      0 172.16.10.22:3126 192.168.90.35:34571     
CLOSE_WAIT  6574/(squid-1)   off (0.00/0/0)
     tcp6       0      0 172.16.10.22:3126 192.168.89.236:49435    
ESTABLISHED 6574/(squid-1)   off (0.00/0/0)

So unfortunately I still don't understand why Squid or the kernel don't 
close these sockets.


Regards,
   Andr&#233;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007912.html">[squid-users] file descriptors leak
</A></li>
	<LI>Next message (by thread): <A HREF="007923.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7917">[ date ]</a>
              <a href="thread.html#7917">[ thread ]</a>
              <a href="subject.html#7917">[ subject ]</a>
              <a href="author.html#7917">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
