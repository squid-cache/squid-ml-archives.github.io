<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] file descriptors leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C5653D182.70009%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007917.html">
   <LINK REL="Next"  HREF="007968.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] file descriptors leak</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C5653D182.70009%40treenet.co.nz%3E"
       TITLE="[squid-users] file descriptors leak">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 24 02:54:58 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007917.html">[squid-users] file descriptors leak
</A></li>
        <LI>Next message (by thread): <A HREF="007968.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7923">[ date ]</a>
              <a href="thread.html#7923">[ thread ]</a>
              <a href="subject.html#7923">[ subject ]</a>
              <a href="author.html#7923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/11/2015 7:45 a.m., Andr&#233; Janna wrote:
&gt;<i> 
</I>&gt;<i> Assin Em 22/11/2015 16:25, Eliezer Croitoru escreveu:
</I>&gt;&gt;<i> Hey Andre,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are couple things to the picture.
</I>&gt;&gt;<i> It's not only squid that is the &quot;blame&quot;.
</I>&gt;&gt;<i> It depends on what your OS tcp stack settings are.
</I>&gt;&gt;<i> To verify couple things you can try to use the netstat tool.
</I>&gt;&gt;<i> run the command &quot;netstat -nto&quot; to see what is the timers status.
</I>&gt;&gt;<i> You can then see how long will a new connection stay in the
</I>&gt;&gt;<i> established state.
</I>&gt;&gt;<i> It might be the squid settings but if the client is not there it could
</I>&gt;&gt;<i> be because of some tcp tunable kernel settings.
</I>&gt;<i> 
</I>&gt;<i> Hi Eliezer and Amos,
</I>&gt;<i> my kernel is a regular Debian Jessie kernel using the following tcp values.
</I>&gt;<i>     tcp_keepalive_time: 7200
</I>&gt;<i>     tcp_keepalive_intvl: 25
</I>&gt;<i>     tcp_keepalive_probes: 9
</I>&gt;<i>     tcp_retries1: 3
</I>&gt;<i>     tcp_retries2: 15
</I>&gt;<i>     tcp_fin_timeout: 60
</I>&gt;<i> So in my understanding the longest timeout is set to 2 hours and a few
</I>&gt;<i> minutes for keepalive connections.
</I>
Okay. It is not always your kernel Squid machine. I've seen one mobile
network where the Ethernet&lt;-&gt;radio modem was interpreting the radio
being alive as TCP keep-alive needing to stay alive. So just having the
phones connected to the network would keep everything active.

IIRC the only fix for that scenario is reducing Squid's client_lifetime
value.


FYI: unless you have a specific need for 3.5 you should be fine with the
3.4 squid3 package that is available for Jesse from Debian backports.
The alternative is going the other way and upgrading right to the latest
3.5 snapshot (and/or 4.0 snapshot) to see if it is one of the CONNECT or
TLS issues we have fixed recently.

&gt;<i> 
</I>&gt;<i> Today I monitored file descriptors 23 and 24 on my box during 5 hours
</I>&gt;<i> and lsof always showed:
</I>&gt;<i>     squid      6574           proxy   23u     IPv6 5320944     
</I>&gt;<i> 0t0        TCP 172.16.10.22:3126-&gt;192.168.90.35:34571 (CLOSE_WAIT)
</I>&gt;<i>     squid      6574           proxy   24u     IPv6 5327276     
</I>&gt;<i> 0t0        TCP 172.16.10.22:3126-&gt;192.168.89.236:49435 (ESTABLISHED)
</I>&gt;<i> while netstat always showed:
</I>&gt;<i>     tcp6       1      0 172.16.10.22:3126 192.168.90.35:34571    
</I>&gt;<i> CLOSE_WAIT  6574/(squid-1)   off (0.00/0/0)
</I>&gt;<i>     tcp6       0      0 172.16.10.22:3126 192.168.89.236:49435   
</I>&gt;<i> ESTABLISHED 6574/(squid-1)   off (0.00/0/0)
</I>&gt;<i> 
</I>&gt;<i> The &quot;off&quot; flag in netstat output tells that for these sockets keepalive
</I>&gt;<i> and retransmission timers are disabled.
</I>
Oooh. That should mean 30sec timout and then RST. Not even a whole
minute of idle time.

&gt;<i> Right now netstat shows 15,568 connections on squid port 3126 and only
</I>&gt;<i> 107 have timer set to a value other than &quot;off&quot;.
</I>&gt;<i> 
</I>&gt;<i> I read that connections that are in CLOSE_WAIT state don't have any tcp
</I>&gt;<i> timeout, it's Squid that must close the socket.
</I>
Squid closes the socket/FD as soon as it received the FIN or RST that
began the CLOSE_WAIT state. Unless it was Squid closing that began it.

&gt;<i> 
</I>&gt;<i>  About the connections in ESTABLISHED state, I monitored the connection
</I>&gt;<i> to mobile device 192.168.89.236 using &quot;tcpdump -i eth2 -n host
</I>&gt;<i> 192.168.89.236&quot; during 2 hours and a half.
</I>&gt;<i> Tcpdump didn't record any packet and netstat is still displaying:
</I>&gt;<i>     tcp6       1      0 172.16.10.22:3126 192.168.90.35:34571    
</I>&gt;<i> CLOSE_WAIT  6574/(squid-1)   off (0.00/0/0)
</I>&gt;<i>     tcp6       0      0 172.16.10.22:3126 192.168.89.236:49435   
</I>&gt;<i> ESTABLISHED 6574/(squid-1)   off (0.00/0/0)
</I>&gt;<i> 
</I>&gt;<i> So unfortunately I still don't understand why Squid or the kernel don't
</I>&gt;<i> close these sockets.
</I>
Neither. So it is time to move away from lsof and start using packet
capture to get a full-body packet trace to find out what exact packets
are happening on at least one affected TCP connection.

If possible identifying one of these connections from its SYN onwards
would be great, but if not then a 20min period of activity on an
existing one might still how more hints.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007917.html">[squid-users] file descriptors leak
</A></li>
	<LI>Next message (by thread): <A HREF="007968.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7923">[ date ]</a>
              <a href="thread.html#7923">[ thread ]</a>
              <a href="subject.html#7923">[ subject ]</a>
              <a href="author.html#7923">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
