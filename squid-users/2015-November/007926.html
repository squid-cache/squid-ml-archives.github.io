<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent HTTPS Squid proxy with upstream parent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPS%20Squid%20proxy%20with%20upstream%20parent&In-Reply-To=%3C5653F4EF.8080007%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007924.html">
   <LINK REL="Next"  HREF="007955.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent HTTPS Squid proxy with upstream parent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPS%20Squid%20proxy%20with%20upstream%20parent&In-Reply-To=%3C5653F4EF.8080007%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent HTTPS Squid proxy with upstream parent">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 24 05:26:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007924.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
        <LI>Next message (by thread): <A HREF="007955.html">[squid-users] [SOLVED] Transparent HTTPS Squid proxy with upstream parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7926">[ date ]</a>
              <a href="thread.html#7926">[ thread ]</a>
              <a href="subject.html#7926">[ subject ]</a>
              <a href="author.html#7926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/11/2015 5:49 p.m., Michael Ludvig wrote:
&gt;<i> Hi Amos
</I>&gt;<i> 
</I>&gt;<i> On 09/11/15 12:55, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 9/11/2015 11:55 a.m., Michael Ludvig wrote:
</I>&gt;&gt;&gt;<i> [client] -&gt; HTTPS -&gt; [my_proxy] -&gt; SSL -&gt; [upstream_proxy] -&gt; HTTPS -&gt;
</I>&gt;&gt;&gt;<i> [target]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can you provide some config hints for both proxies please? The
</I>&gt;&gt;&gt;<i> SSL-related bits only as that's the unclear part.
</I>&gt;&gt;<i> my_proxy:
</I>&gt;&gt;<i>   cache_peer example.com 3129 0 ssl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> upstream_proxy:
</I>&gt;&gt;<i>   https_port 3129 cert=/path/to/cert
</I>&gt;<i> 
</I>&gt;<i> This works well when the [client] has $https_proxy set to point to
</I>&gt;<i> [my_proxy] - it then talks SSL to [upstream_proxy] and things work nicely.
</I>&gt;<i> 
</I>
That is for what you documented:
  [client] -&gt; HTTPS -&gt; [my_proxy]


&gt;<i> However with transparent proxy / sslbump on [my_proxy] I keep getting:
</I>&gt;<i> 
</I>
That is two separate and entirely different traffic types:

A) [client] -&gt; HTTP--(NAT)--&gt; [my_proxy]

B) [client] -&gt; TLS--(NAT)--&gt; [my_proxy]


(A) requires &quot;http_port ... intercept ssl-bump cert=/path/to/cert&quot;

(B) requires &quot;https_port ... intercept ssl-bump cert=/path/to/cert&quot;

above is the minimum configuration. The generate-* etc settings you
mention below are useful as well.

&gt;<i>     Failed to establish a secure connection to 10.205.28.183 (=this is
</I>&gt;<i> [upstream_proxy])
</I>&gt;<i>     The system returned:
</I>&gt;<i>     [No Error] (TLS code: SQUID_X509_V_ERR_DOMAIN_MISMATCH)
</I>&gt;<i>     Certificate does not match domainname: /C=NZ/O=Example
</I>&gt;<i> CA/CN=parent.example.com
</I>&gt;<i> 
</I>&gt;<i> On [my_proxy] I've got:
</I>&gt;<i> https_port 8443 intercept ssl-bump generate-host-certificates=on \
</I>&gt;<i>     dynamic_cert_mem_cache_size=4MB cert=/etc/squid/intermediate.pem
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>
This is bumping with only the client details known. In order to
impersonate the server you also need to fetch the server details (peek
or stare at step2), then bump at step3.

Aymeric also recently found a bug in the SNI details being sent to
peers. The very latest 3.5 snapshot may be needed as well as the step2
config change.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007924.html">[squid-users] Transparent HTTPS Squid proxy with upstream parent
</A></li>
	<LI>Next message (by thread): <A HREF="007955.html">[squid-users] [SOLVED] Transparent HTTPS Squid proxy with upstream parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7926">[ date ]</a>
              <a href="thread.html#7926">[ thread ]</a>
              <a href="subject.html#7926">[ subject ]</a>
              <a href="author.html#7926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
