<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems with NTLM authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20NTLM%20authentication&In-Reply-To=%3C5654F798.6070503%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007950.html">
   <LINK REL="Next"  HREF="008026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems with NTLM authentication</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20NTLM%20authentication&In-Reply-To=%3C5654F798.6070503%40treenet.co.nz%3E"
       TITLE="[squid-users] Problems with NTLM authentication">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 24 23:49:44 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007950.html">[squid-users] Problems with NTLM authentication
</A></li>
        <LI>Next message (by thread): <A HREF="008026.html">[squid-users] Problems with NTLM authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7959">[ date ]</a>
              <a href="thread.html#7959">[ thread ]</a>
              <a href="subject.html#7959">[ subject ]</a>
              <a href="author.html#7959">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/11/2015 4:44 a.m., Brendan Kearney wrote:
&gt;<i> On 11/24/2015 10:08 AM, Ver&#243;nica Ovando wrote:
</I>&gt;&gt;<i> My Squid Version:  Squid 3.4.8
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OS Version:  Debian 8
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have installed Squid on a server using Debian 8 and seem to have the
</I>&gt;&gt;<i> basics operating, at least when I start the squid service, I have am
</I>&gt;&gt;<i> no longer getting any error messages.  At this time, the goal is to
</I>&gt;&gt;<i> authenticate users from Active Directory and log the user and the
</I>&gt;&gt;<i> websites they are accessing.
</I>
Please ensure you run &quot;squid3 -k parse&quot; to check if there is anything
minor still potentially being a problem. I doubt it will help with the
current issue, but you may find some things to make it work more smoothly.

&gt;&gt;<i>
</I>&gt;&gt;<i> I followed the official guide
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm.">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm.</A> I
</I>&gt;&gt;<i> verified that samba is properly configured, as the guide suggest, with
</I>&gt;&gt;<i> the basic helper in this way:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # /usr/local/bin/ntlm_auth --helper-protocol=squid-2.5-basic
</I>&gt;&gt;<i> domain\user pass
</I>&gt;&gt;<i> OK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is a part of my squid.conf where I defined my ACLs for the groups
</I>&gt;&gt;<i> in AD:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ========================================================================================================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> auth_param ntlm program /usr/local/bin/ntlm_auth
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=DOMAIN.com
</I>&gt;&gt;<i> auth_param ntlm children 30
</I>
Try also using:
  auth_param ntlm keepalive off

&gt;&gt;<i>
</I>&gt;&gt;<i> auth_param basic program /usr/local/bin/ntlm_auth
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;&gt;<i> auth_param basic children 5
</I>&gt;&gt;<i> auth_param basic realm Servidor proxy-cache de mi Dominio
</I>&gt;&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> external_acl_type AD_Grupos ttl=10 children=10 %LOGIN
</I>&gt;&gt;<i> /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl AD_Standard external Grupos_AD Standard
</I>&gt;&gt;<i> acl AD_Exceptuados external Grupos_AD Exceptuados
</I>&gt;&gt;<i> acl AD_Bloqueados external Grupos_AD Bloqueados
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl face url_regex -i &quot;/etc/squid3/facebook&quot;
</I>&gt;&gt;<i> acl gob url_regex -i &quot;/etc/squid3/gubernamentales&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow AD_Standard
</I>&gt;&gt;<i> http_access allow AD_Exceptuados !face !gob
</I>&gt;&gt;<i> http_access deny AD_Bloqueados
</I>&gt;&gt;<i> ========================================================================================================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tested using only the basic scheme (I commented the lines out for
</I>&gt;&gt;<i> NTLM auth) and every time I open the browser it asks me my user and
</I>&gt;&gt;<i> pass. And it works well because I can see in the access.log my
</I>&gt;&gt;<i> username and all the access policies defined are correctly applied.
</I>&gt;&gt;<i>
</I>
Good.

&gt;&gt;<i> But if I use NTLM auth, the browser still shows me the pop-up (it must
</I>&gt;&gt;<i> no be shown) and if I enter my user and pass it still asks me for them
</I>&gt;&gt;<i> until I cancel it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My access.log, in that case, shows a TCP_DENIED/407 as expected.
</I>
It should show one with Basic, and two with NTLM. Always.

The popup and 407 are different things.

* The 407 means the client is behaving and not broadcasting credentials
everywhere. Also Squid is now informing it that they do need to be sent
on this connection, using the Basic or NTLM schema.

* The popup means the browser was unable to find credentials to answer
the 407 with. If some were sent earlier the proxy rejected them.

 ... that includes the proxy rejecting via &quot;deny AD_Bloqueados&quot;. Users
in group Bloqueados may be prompted for a popup until they enter
somebody elses credentials, who is not in that group.
Add &quot; all&quot; to the right hand end of the &quot;deny AD_Bloqueados&quot; line to
prevent that.


&gt;&gt;<i>
</I>&gt;&gt;<i> What could be the problem? It suppose that both Kerberos and NTLM
</I>&gt;&gt;<i> protocols work together, I mean that can live together in the same
</I>&gt;&gt;<i> environment and Kerberos is used by default.
</I>
You have not configued your Squid to offer Kerberos. Therefore it is not
an option the client can choose, and not part of the equation.

If the client is new enough software with no NTLM support. eg most MS
software written since Vista / ~2008. Then lack of Kerberos may be the
problem. In which case it should use the Basic.

If the client is pre-empting the initial 407, by sending Kerberos
credentials. Broken.

FYI: Basic authentication is ironically more secure than NTLM these
days. Even the &quot;secure&quot; NTLMv2 extensions can now be decrypted given a
few hours. At least with Basic the software handling it assumes
insecurity and does necessary paranoid things to protect the credentials
- most NTLM software does not.


&gt;&gt;<i> How can I check that NTLM
</I>&gt;&gt;<i> is really working? Could it be a squid problem in the conf? Or maybe
</I>&gt;&gt;<i> AD is not allowing NTLM traffic?
</I>
NTLM does not work. It was designed broken. (sorry, joke. But not far
from the truth).

&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry for my English. Thanks in advance.
</I>&gt;&gt;<i>
</I>
&gt;<i> make sure Internet Explorer is set to use Integrated Windows
</I>&gt;<i> Authentication (IWA).  Tools --&gt; Internet Options --&gt; Advanced --&gt;
</I>&gt;<i> Security --&gt; Enable Integrated Windows Authentication.
</I>
And be aware that sometimes random software on the machine will do
automated HTTP requests to the proxy using the machines own AD account
credentials. Not a &quot;user&quot; account.

Also use a line that does authentication explicity before checking the
group access. NTLM badly violates HTTP requirements and some of the
older Squid bugs can result in problems when external ACL %LOGIN is the
trigger behind authentication happening.

What I mean is using:

 acl login proxy_auth REQUIRED
 http_access deny !login

 http_access allow AD_Standard
 http_access allow AD_Exceptuados !face !gob
 http_access deny AD_Bloqueados all

Even if it is not strictly necessary, it will clarify exactly what point
authentication happens and eliminates those bug side effects from being
a worry.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007950.html">[squid-users] Problems with NTLM authentication
</A></li>
	<LI>Next message (by thread): <A HREF="008026.html">[squid-users] Problems with NTLM authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7959">[ date ]</a>
              <a href="thread.html#7959">[ thread ]</a>
              <a href="subject.html#7959">[ subject ]</a>
              <a href="author.html#7959">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
