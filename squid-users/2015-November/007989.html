<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] file descriptors leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C565788A1.4010501%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007988.html">
   <LINK REL="Next"  HREF="008016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] file descriptors leak</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20file%20descriptors%20leak&In-Reply-To=%3C565788A1.4010501%40treenet.co.nz%3E"
       TITLE="[squid-users] file descriptors leak">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov 26 22:33:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007988.html">[squid-users] file descriptors leak
</A></li>
        <LI>Next message (by thread): <A HREF="008016.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7989">[ date ]</a>
              <a href="thread.html#7989">[ thread ]</a>
              <a href="subject.html#7989">[ subject ]</a>
              <a href="author.html#7989">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/11/2015 7:36 a.m., Andr&#233; Janna wrote:
&gt;<i> 
</I>&gt;<i> Assinatura
</I>&gt;<i> Em 24/11/2015 00:54, Amos Jeffries escreveu:
</I>&gt;&gt;<i> FYI: unless you have a specific need for 3.5 you should be fine with
</I>&gt;&gt;<i> the 3.4 squid3 package that is available for Jesse from Debian
</I>&gt;&gt;<i> backports. The alternative is going the other way and upgrading right
</I>&gt;&gt;<i> to the latest 3.5 snapshot (and/or 4.0 snapshot) to see if it is one
</I>&gt;&gt;<i> of the CONNECT or TLS issues we have fixed recently. 
</I>&gt;<i> I'm using version 3.5 because 3.4 doesn't have ssl::server_name acl.
</I>&gt;<i> Debian package is not built with openssl because of licensing issues so
</I>&gt;<i> I rebuilt Debian testing 3.5 source package on Debian Jessie.
</I>&gt;<i> This Squid installation is in production now and cannot be easily
</I>&gt;<i> migrated. But I'll perform another installation for testing in the near
</I>&gt;<i> future.
</I>&gt;<i> 
</I>&gt;&gt;<i> Neither. So it is time to move away from lsof and start using packet
</I>&gt;&gt;<i> capture to get a full-body packet trace to find out what exact packets
</I>&gt;&gt;<i> are happening on at least one affected TCP connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If possible identifying one of these connections from its SYN onwards
</I>&gt;&gt;<i> would be great, but if not then a 20min period of activity on an
</I>&gt;&gt;<i> existing one might still how more hints.
</I>&gt;&gt;<i>
</I>&gt;<i> I did a test using a Windows laptop client with IP address 192.168.64.4,
</I>&gt;<i> connected via wifi.
</I>&gt;<i> I browsed a few https sites until triggering Squid &quot;local IP does not
</I>&gt;<i> match any domain IP&quot; error.
</I>&gt;<i> This error appeared when I was trying to open Yahoo home page. Browser
</I>&gt;<i> redirected to <A HREF="https://br.yahoo.com/?p=us">https://br.yahoo.com/?p=us</A> but page remained blank.
</I>&gt;<i> Please note that this error appears randomly: opening the same site in
</I>&gt;<i> another browser tab succeeded.
</I>&gt;<i> 
</I>&gt;<i> cache.log:
</I>&gt;<i> 2015/11/26 13:54:45.471 kid1| SECURITY ALERT: Host header forgery
</I>&gt;<i> detected on local=206.190.56.191:443 remote=192.168.64.4:58887 FD 17244
</I>&gt;<i> flags=33 (local IP does not match any domain IP)
</I>&gt;<i> 
</I>&gt;<i> After a couple of minutes this connection disappeared from Windows
</I>&gt;<i> netstat command output. Afterward I powered off Windows laptop.
</I>&gt;<i> 
</I>&gt;<i> Tcpdump on Squid box:
</I>&gt;<i> 13:54:45.410907 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [S],
</I>&gt;<i> seq 1831867, win 8192, options [mss 1460,nop,wscale 8,nop,nop,sackOK],
</I>&gt;<i> length 0
</I>&gt;<i> 13:54:45.411000 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [S.],
</I>&gt;<i> seq 3695298276, ack 1831868, win 29200, options [mss
</I>&gt;<i> 1460,nop,nop,sackOK,nop,wscale 7], length 0
</I>

client 192.168.64.4:58887 connects.

&gt;<i> 13:54:45.411630 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> ack 1, win 256, length 0
</I>&gt;<i> 13:54:45.412490 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [P.],
</I>&gt;<i> seq 1:185, ack 1, win 256, length 184
</I>&gt;<i> 13:54:45.412573 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, length 0
</I>
client sends 184 bytes of data.

&gt;<i> 13:54:55.439709 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:54:55.439761 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>&gt;<i> 13:55:05.439965 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:55:05.440022 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>&gt;<i> 13:55:15.445667 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:55:15.445737 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>&gt;<i> 13:55:25.447281 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:55:25.447351 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>&gt;<i> 13:55:35.494936 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:55:35.495005 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>&gt;<i> 13:55:45.491694 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:55:45.491761 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>&gt;<i> 13:55:55.492158 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [.],
</I>&gt;<i> seq 184:185, ack 1, win 256, length 1
</I>&gt;<i> 13:55:55.492208 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 185, win 237, options [nop,nop,sack 1 {184:185}], length 0
</I>
client sends 1 byte of data - in 7x packets.

The recipient sends an ACK each and every time, but the client just
keeps repeating itself.

&gt;<i> 14:01:58.242748 IP 192.168.64.4.58887 &gt; 206.190.56.191.443: Flags [F.],
</I>&gt;<i> seq 185, ack 1, win 256, length 0
</I>&gt;<i> 14:01:58.279916 IP 206.190.56.191.443 &gt; 192.168.64.4.58887: Flags [.],
</I>&gt;<i> ack 186, win 237, length 0
</I>
... until the client changes and sends a FIN.

&gt;<i> 
</I>&gt;<i> Netstat output on Squid box:
</I>&gt;<i> # date; netstat -tno | grep 192.168.64.4
</I>&gt;<i> Thu Nov 26 13:59:40 BRST 2015
</I>&gt;<i> tcp6       1      0 172.16.10.22:3126       192.168.64.4:58887
</I>&gt;<i> CLOSE_WAIT  off (0.00/0/0)
</I>&gt;<i> 
</I>&gt;<i> And after 2 hours and a half netstat output is still the same:
</I>&gt;<i> # date; netstat -tno | grep 192.168.64.4
</I>&gt;<i> Thu Nov 26 16:32:37 BRST 2015
</I>&gt;<i> tcp6       1      0 172.16.10.22:3126       192.168.64.4:58887
</I>&gt;<i> CLOSE_WAIT  off (0.00/0/0)
</I>&gt;<i> 
</I>&gt;<i> Squid is still using the file descriptor.
</I>&gt;<i> # date; lsof -n | grep 192.168.64.4
</I>&gt;<i> Thu Nov 26 16:33:10 BRST 2015
</I>&gt;<i> squid     29137            proxy *244u     IPv6 13127035      0t0       
</I>&gt;<i> TCP 172.16.10.22:3126-&gt;192.168.64.4:58887 (CLOSE_WAIT)
</I>&gt;<i> 
</I>

So, the first place to look is not Squid I think. But why at least 6 of
those ACK packets did not make it back to the client. That needs
resolving first to esure that the TCP level is operating correctly.

Only then if the problem remains looking at Squid, the use of port 443
indicates it is the crypto process is possibly waiting for something and
not closing the port on a 0-byte read(2) operation.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007988.html">[squid-users] file descriptors leak
</A></li>
	<LI>Next message (by thread): <A HREF="008016.html">[squid-users] file descriptors leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7989">[ date ]</a>
              <a href="thread.html#7989">[ thread ]</a>
              <a href="subject.html#7989">[ subject ]</a>
              <a href="author.html#7989">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
