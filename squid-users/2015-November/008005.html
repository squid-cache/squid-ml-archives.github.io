<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid memory leak on ubuntu 14.04
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20memory%20leak%20on%20ubuntu%2014.04&In-Reply-To=%3C5658838F.7050707%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008004.html">
   <LINK REL="Next"  HREF="008025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid memory leak on ubuntu 14.04</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20memory%20leak%20on%20ubuntu%2014.04&In-Reply-To=%3C5658838F.7050707%40urlfilterdb.com%3E"
       TITLE="[squid-users] Squid memory leak on ubuntu 14.04">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Fri Nov 27 16:23:43 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008004.html">[squid-users] Squid memory leak on ubuntu 14.04
</A></li>
        <LI>Next message (by thread): <A HREF="008025.html">[squid-users] Squid memory leak on ubuntu 14.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8005">[ date ]</a>
              <a href="thread.html#8005">[ thread ]</a>
              <a href="subject.html#8005">[ subject ]</a>
              <a href="author.html#8005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I do not have the detail of Ubuntu 14.04 but most likely 12.04 and 14.04 have a different version of malloc (see &quot;man malloc&quot;) which allocates gigabytes of virtual memory.
Most likely you see in top that the resident memory is what you expect that Squid uses (comparable as on 12.04) and the virtual memory is high.
This is the new &quot;normal&quot; behavior of malloc.

Marcus


On 11/27/2015 01:41 PM, &#39118;&#22768; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> We had installed squid 3.3.8 on ubuntu 12.04, when we upgrade the OS from ubuntu 12.04 to 14.04, we found the memory usage abnormal, eat up all memory.
</I>&gt;<i>
</I>&gt;<i> After we investigation:
</I>&gt;<i>
</I>&gt;<i> We use 4 servers for comparision:
</I>&gt;<i>
</I>&gt;<i> 3.3.8 on ubuntu 12.04
</I>&gt;<i> 3.5.11 on ubuntu 12.04
</I>&gt;<i>
</I>&gt;<i> 3.3.8 on ubuntu 14.04
</I>&gt;<i> 3.5.11 on ubuntu 14.04
</I>&gt;<i>
</I>&gt;<i> all squid on ubuntu 12.04 works normal, all squid on ubuntu 14.04 memory usage always keep going up, never goes down. But when I check the system info, can not find where the memory was used. If we
</I>&gt;<i> restart the squid service, the memory comes back.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Can you give me any hints ?
</I>&gt;<i>
</I>&gt;<i> Below is the info on abnormal server:
</I>&gt;<i>
</I>&gt;<i> *lsb_release -a*
</I>&gt;<i> No LSB modules are available.
</I>&gt;<i> Distributor ID:Ubuntu
</I>&gt;<i> Description:Ubuntu 14.04.3 LTS
</I>&gt;<i> Release:14.04
</I>&gt;<i> Codename:trusty
</I>&gt;<i>
</I>&gt;<i> *free -m*
</I>&gt;<i>               total       used       free     shared    buffers     cached
</I>&gt;<i> Mem:          7480       6405       1074          0        222        668
</I>&gt;<i> -/+ buffers/cache:       5513       1966
</I>&gt;<i> Swap:            0          0          0
</I>&gt;<i>
</I>&gt;<i> *cat /proc/meminfo*
</I>&gt;<i> MemTotal:        7659544 kB
</I>&gt;<i> MemFree:         1107944 kB
</I>&gt;<i> Buffers:          228352 kB
</I>&gt;<i> Cached:           685076 kB
</I>&gt;<i> SwapCached:            0 kB
</I>&gt;<i> Active:          1373880 kB
</I>&gt;<i> Inactive:         199260 kB
</I>&gt;<i> Active(anon):     663652 kB
</I>&gt;<i> Inactive(anon):      316 kB
</I>&gt;<i> Active(file):     710228 kB
</I>&gt;<i> Inactive(file):   198944 kB
</I>&gt;<i> Unevictable:        5300 kB
</I>&gt;<i> Mlocked:            5300 kB
</I>&gt;<i> SwapTotal:             0 kB
</I>&gt;<i> SwapFree:              0 kB
</I>&gt;<i> Dirty:               128 kB
</I>&gt;<i> Writeback:             0 kB
</I>&gt;<i> AnonPages:        665056 kB
</I>&gt;<i> Mapped:            21012 kB
</I>&gt;<i> Shmem:               712 kB
</I>&gt;<i> Slab:             332904 kB
</I>&gt;<i> SReclaimable:      77376 kB
</I>&gt;<i> SUnreclaim:       255528 kB
</I>&gt;<i> KernelStack:        1368 kB
</I>&gt;<i> PageTables:         5068 kB
</I>&gt;<i> NFS_Unstable:          0 kB
</I>&gt;<i> Bounce:                0 kB
</I>&gt;<i> WritebackTmp:          0 kB
</I>&gt;<i> CommitLimit:     3829772 kB
</I>&gt;<i> Committed_AS:     864212 kB
</I>&gt;<i> VmallocTotal:   34359738367 kB
</I>&gt;<i> VmallocUsed:       22316 kB
</I>&gt;<i> VmallocChunk:   34359708548 kB
</I>&gt;<i> HardwareCorrupted:     0 kB
</I>&gt;<i> AnonHugePages:    587776 kB
</I>&gt;<i> HugePages_Total:       0
</I>&gt;<i> HugePages_Free:        0
</I>&gt;<i> HugePages_Rsvd:        0
</I>&gt;<i> HugePages_Surp:        0
</I>&gt;<i> Hugepagesize:       2048 kB
</I>&gt;<i> DirectMap4k:       51200 kB
</I>&gt;<i> DirectMap2M:     7944192 kB
</I>&gt;<i>
</I>&gt;<i> *cat /proc/net/sockstat*
</I>&gt;<i> sockets: used 7086
</I>&gt;<i> TCP: inuse 7173 orphan 354 tw 1995 alloc 7224 mem 455543
</I>&gt;<i> UDP: inuse 9 mem 4
</I>&gt;<i> UDPLITE: inuse 0
</I>&gt;<i> RAW: inuse 1
</I>&gt;<i> FRAG: inuse 0 memory 0
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *netstat -na | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'*
</I>&gt;<i> LAST_ACK 39
</I>&gt;<i> LISTEN 5
</I>&gt;<i> SYN_RECV 7
</I>&gt;<i> CLOSE_WAIT 51
</I>&gt;<i> ESTABLISHED 6004
</I>&gt;<i> FIN_WAIT1 314
</I>&gt;<i> FIN_WAIT2 54
</I>&gt;<i> SYN_SENT 3
</I>&gt;<i> TIME_WAIT 1687
</I>&gt;<i>
</I>&gt;<i> *slabtop -s c*
</I>&gt;<i>   Active / Total Objects (% used)    : 602429 / 841775 (71.6%)
</I>&gt;<i>   Active / Total Slabs (% used)      : 28101 / 28101 (100.0%)
</I>&gt;<i>   Active / Total Caches (% used)     : 64 / 97 (66.0%)
</I>&gt;<i>   Active / Total Size (% used)       : 282169.82K / 328114.05K (86.0%)
</I>&gt;<i>   Minimum / Average / Maximum Object : 0.01K / 0.39K / 8.00K
</I>&gt;<i>
</I>&gt;<i>    OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME
</I>&gt;<i>   37136  37003  99%    4.00K   4642        8    148544K kmalloc-4096
</I>&gt;<i> 335283 173366  51%    0.10K   8597       39     34388K buffer_head
</I>&gt;<i> 104768  94358  90%    0.25K   3274       32     26192K kmalloc-256
</I>&gt;<i>    9776   7033  71%    2.00K    611       16     19552K kmalloc-2048
</I>&gt;<i>    9810   6588  67%    1.75K    545       18     17440K TCP
</I>&gt;<i>   13959  13959 100%    0.96K    423       33     13536K ext4_inode_cache
</I>&gt;<i>   55083  52199  94%    0.19K   2623       21     10492K dentry
</I>&gt;<i>   13856   8621  62%    0.50K    433       32      6928K kmalloc-512
</I>&gt;<i>   52064  49778  95%    0.12K   1627       32      6508K kmalloc-128
</I>&gt;<i>    9650   6515  67%    0.62K    386       25      6176K sock_inode_cache
</I>&gt;<i>   18798   8329  44%    0.30K    723       26      5784K nf_conntrack_ffffffff81cdab80
</I>&gt;<i>   27825  16442  59%    0.19K   1325       21      5300K kmalloc-192
</I>&gt;<i>    9240   5902  63%    0.55K    330       28      5280K radix_tree_node
</I>&gt;<i>    7952   7952 100%    0.57K    284       28      4544K inode_cache
</I>&gt;<i>    2880   1874  65%    1.00K     90       32      2880K kmalloc-1024
</I>&gt;<i>   16992  16992 100%    0.11K    472       36      1888K sysfs_dir_cache
</I>&gt;<i>    2875   2875 100%    0.63K    115       25      1840K proc_inode_cache
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *squid3 -v*
</I>&gt;<i> Squid Cache: Version 3.5.11
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=${prefix}/include' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' '--sysconfdir=/etc'
</I>&gt;<i> '--localstatedir=/var' '--libexecdir=${prefix}/lib/squid3' '--srcdir=.' '--disable-maintainer-mode' '--disable-dependency-tracking' '--disable-silent-rules' '--datadir=/usr/share/squid3'
</I>&gt;<i> '--sysconfdir=/etc/squid3' '--mandir=/usr/share/man' '--enable-inline' '--with-aufs-threads=8' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap' '--enable-delay-pools'
</I>&gt;<i> '--enable-cache-digests' '--enable-underscores' '--enable-follow-x-forwarded-for' '--enable-auth-basic=NCSA' '--enable-auth-digest=file' '--enable-htcp' '--enable-url-rewrite-helpers=fake'
</I>&gt;<i> '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--disable-auth-negotiate' '--disable-auth-ntlm' '--disable-ecap' '--disable-external-acl-helpers' '--disable-icap-client'
</I>&gt;<i> '--disable-ipv6' '--disable-translation' '--with-swapdir=/var/spool/squid3' '--with-logdir=/var/log/squid3' '--with-pidfile=/var/run/squid3.pid' '--with-filedescriptors=100000' '--with-large-files'
</I>&gt;<i> '--with-default-user=proxy' '--enable-linux-netfilter' 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -Wall'
</I>&gt;<i> 'LDFLAGS=-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security'
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008004.html">[squid-users] Squid memory leak on ubuntu 14.04
</A></li>
	<LI>Next message (by thread): <A HREF="008025.html">[squid-users] Squid memory leak on ubuntu 14.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8005">[ date ]</a>
              <a href="thread.html#8005">[ thread ]</a>
              <a href="subject.html#8005">[ subject ]</a>
              <a href="author.html#8005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
