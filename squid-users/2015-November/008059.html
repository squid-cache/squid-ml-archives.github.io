<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info / url_rewrite_program
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20/%20url_rewrite_program&In-Reply-To=%3C565CBF82.6050707%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008058.html">
   <LINK REL="Next"  HREF="008054.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info / url_rewrite_program</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20/%20url_rewrite_program&In-Reply-To=%3C565CBF82.6050707%40ngtech.co.il%3E"
       TITLE="[squid-users] deny_info / url_rewrite_program">eliezer at ngtech.co.il
       </A><BR>
    <I>Mon Nov 30 21:28:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008058.html">[squid-users] deny_info / url_rewrite_program
</A></li>
        <LI>Next message (by thread): <A HREF="008054.html">[squid-users] Looking for ideas on how to use squid in order to protect against a DOS\DDOS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8059">[ date ]</a>
              <a href="thread.html#8059">[ thread ]</a>
              <a href="subject.html#8059">[ subject ]</a>
              <a href="author.html#8059">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Did you tested your helper in normal command line?
It seems that your helper does something wrong.
Before you run to try and make squid understand your helper make sure 
you understand what it actually does for you.

I am unsure if you don't understand what STDIN\OUT\ERR means or do you 
actually understand what the perl script does.
In any case you must first understand your goals before programming 
anything else.

Eliezer

* I did gave you a way to test your helpers in the IRC channel, try to 
use them. if you need couple examples for url_rewrite it is very easy to 
produce.

On 30/11/2015 23:10, Jens Kallup wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> next, the output, followed by the config snippet, the perl script is fixed,
</I>&gt;<i> but don't work - squid shows only Error - Access Denied ...
</I>&gt;<i>
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Process Roles: worker
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| With 65536 file descriptors available
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Initializing IP Cache...
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| DNS Socket created at [::], FD 6
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| DNS Socket created at 0.0.0.0, FD 8
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Adding nameserver fd00::c225:6ff:fe71:2b
</I>&gt;<i> from /etc/resolv.conf
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| helperOpenServers: Starting 0/20
</I>&gt;<i> 'rewrite.pl' processes
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| helperOpenServers: No 'rewrite.pl'
</I>&gt;<i> processes needed.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| helperOpenServers: Starting 1/5
</I>&gt;<i> 'basic_ncsa_auth' processes
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| helperOpenServers: Starting 0/1 'block.sh'
</I>&gt;<i> processes
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| helperOpenServers: No 'block.sh' processes
</I>&gt;<i> needed.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Logfile: opening log
</I>&gt;<i> /sap/squid/log/access.log
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| WARNING: log name now starts with a module
</I>&gt;<i> name. Use 'stdio:/sap/squid/log/access.log'
</I>
Squid tells you that you have wrong configuration line. ^^^

&gt;<i> 2015/11/30 22:00:14.168 kid1| Unlinkd pipe opened on FD 15
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Store logging disabled
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Swap maxSize 65536 + 8192 KB, estimated
</I>&gt;<i> 5671 objects
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Target number of buckets: 283
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Using 8192 Store buckets
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Max Mem  size: 8192 KB
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Max Swap size: 65536 KB
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Rebuilding storage in /sap/var/spool/squid
</I>&gt;<i> (dirty log)
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Using Least Load store dir selection
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Set Current Directory to /sap/var/spool/squid
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Finished loading MIME types and icons.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| HTCP Disabled.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Squid plugin modules loaded: 0
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Adaptation support is off.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Accepting HTTP Socket connections at
</I>&gt;<i> local=[::]:3128 remote=[::] FD 18 flags=9
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Done reading /sap/var/spool/squid swaplog
</I>&gt;<i> (3346 entries)
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Finished rebuilding storage from disk.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|      2983 Entries scanned
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|         0 Invalid entries.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|         0 With invalid flags.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|      2971 Objects loaded.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|         0 Objects expired.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|         0 Objects cancelled.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|         0 Duplicate URLs purged.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|        12 Swapfile clashes avoided.
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|   Took 0.06 seconds (52517.15 objects/sec).
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1| Beginning Validation Procedure
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|   Completed Validation Procedure
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|   Validated 2971 Entries
</I>&gt;<i> 2015/11/30 22:00:14.168 kid1|   store_swap_size = 63388.00 KB
</I>&gt;<i> 2015/11/30 22:00:15 kid1| storeLateRelease: released 0 objects
</I>&gt;<i> 2015/11/30 22:00:20 kid1| ALE missing adapted HttpRequest object
</I>&gt;<i> 2015/11/30 22:00:20 kid1| ALE missing URL
</I>&gt;<i> 2015/11/30 22:00:20 kid1| Starting new blocker helpers...
</I>&gt;<i> 2015/11/30 22:00:20 kid1| helperOpenServers: Starting 1/1 'block.sh'
</I>&gt;<i> processes
</I>
Your helper was started


&gt;<i> 2015/11/30 22:00:23 kid1| ALE missing adapted HttpRequest object
</I>&gt;<i> 2015/11/30 22:00:23 kid1| ALE missing URL
</I>
Your helper did something wrong.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # squid config:
</I>&gt;<i> auth_param basic program /usr/local/squid/libexec/basic_ncsa_auth
</I>&gt;<i> /sap/squid/passwd
</I>&gt;<i> auth_param basic utf8 on
</I>&gt;<i> auth_param basic children 5 startup=1 idle=1 concurrency=0
</I>&gt;<i> auth_param basic realm Bitte geben Sie Ihren Benutzernamen und Ihr
</I>&gt;<i> Passwort zur Internet-Authentifizierung ein!
</I>&gt;<i> auth_param basic credentialsttl 60 minutes
</I>&gt;<i> auth_param basic casesensitive on
</I>&gt;<i>
</I>&gt;<i> external_acl_type blocker concurrency=100 ttl=60 negative_ttl=0
</I>&gt;<i> children-max=1 %LOGIN %DST /sap/squid/block.sh
</I>&gt;<i> acl mysql_blocker external blocker
</I>&gt;<i>
</I>&gt;<i> url_rewrite_program /sap/squid/rewrite.pl  # inserted \__ these 2 lines
</I>&gt;<i> have no effect, always, the same behavour
</I>&gt;<i> url_rewrite_access deny mysql_blocker      # inserted /
</I>&gt;<i>
</I>&gt;<i> #deny_info <A HREF="http://www.freenet.de">http://www.freenet.de</A> blocker
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #ther script:
</I>&gt;<i> #!/usr/bin/perl -l
</I>&gt;<i>
</I>&gt;<i> #use strict;
</I>&gt;<i> use warnings;
</I>&gt;<i> use IO::Handle;
</I>&gt;<i> use URI::Escape;
</I>&gt;<i> use DBI;
</I>&gt;<i> use 5.010;
</I>&gt;<i>
</I>&gt;<i> $|=1;                   # don't buffer stdout
</I>&gt;<i>
</I>&gt;<i> while (&lt;&gt;) {            # read line from STDIN (squid input)
</I>&gt;<i>      my ($url, $ip, $slash, $fqdn, $user, $method) = split;
</I>&gt;<i>
</I>&gt;<i>      $url = uri_unescape($url);
</I>&gt;<i>      $nxt = uri_unescape(&quot;web.de&quot;); # web.de is definitive blocked
</I>&gt;<i>
</I>&gt;<i>      if ($url eq $nxt) {
</I>&gt;<i>          my $output = &quot;OK status=301 url=\&quot;<A HREF="http://www.freenet.de\">http://www.freenet.de\</A>&quot;\n&quot;;
</I>&gt;<i>          print STDOUT $output;
</I>&gt;<i>      }
</I>&gt;<i>      else {
</I>&gt;<i>          print STDOUT &quot;OK\n&quot;;
</I>&gt;<i>      }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008058.html">[squid-users] deny_info / url_rewrite_program
</A></li>
	<LI>Next message (by thread): <A HREF="008054.html">[squid-users] Looking for ideas on how to use squid in order to protect against a DOS\DDOS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8059">[ date ]</a>
              <a href="thread.html#8059">[ thread ]</a>
              <a href="subject.html#8059">[ subject ]</a>
              <a href="author.html#8059">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
