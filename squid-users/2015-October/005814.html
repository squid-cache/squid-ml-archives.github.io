<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid ignores crlfile options
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ignores%20crlfile%20options&In-Reply-To=%3C2F3AADF230295040BDC74C6F96094F3D02225EFB%40SRVEXAFA.verwaltung.afa-ag.loc%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005796.html">
   <LINK REL="Next"  HREF="005820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid ignores crlfile options</H1>
    <B>Sebastian Kirschner</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ignores%20crlfile%20options&In-Reply-To=%3C2F3AADF230295040BDC74C6F96094F3D02225EFB%40SRVEXAFA.verwaltung.afa-ag.loc%3E"
       TITLE="[squid-users] Squid ignores crlfile options">s.kirschner at afa-finanz.de
       </A><BR>
    <I>Fri Oct  2 11:11:31 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005796.html">[squid-users] Squid ignores crlfile options
</A></li>
        <LI>Next message (by thread): <A HREF="005820.html">[squid-users] Squid ignores crlfile options
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5814">[ date ]</a>
              <a href="thread.html#5814">[ thread ]</a>
              <a href="subject.html#5814">[ subject ]</a>
              <a href="author.html#5814">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos for the reply ,

I will trim the config with your recommendations but a few questions exists on my side.

&quot; If you mean it to be used to verify the *server* certificates then you need to configure sslproxy_crlfile instead.&quot;

	I guess that was what im looking for :-) , 
	but I couldn&#8217;t find something about that configuration directives on the squid doc configuration site and my squid ignores the options
	because its unrecognized.

&quot;&gt; request_body_max_size 0 KB

Seriously? POST and PUT are forbidden to send data anywhere?&quot;

	Should the value be ignored because it&#8217;s a zero ?
	Here the part of the Squid configuration document 
		&quot;If you set this parameter to a zero (the default), there will be no limit imposed.&quot;

&quot; build-info requires a string. Whoever provided this package needs to fix that.&quot;
	I was the builder :-) , could you give me a hint about that ?

Mit freundlichen Gr&#252;&#223;en / Best Regards

Sebastian 

Message: 4
Date: Fri, 2 Oct 2015 02:51:56 +1300
From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid ignores crlfile options
Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">560D3A7C.2020408 at treenet.co.nz</A>&gt;
Content-Type: text/plain; charset=utf-8

On 1/10/2015 11:54 p.m., Sebastian Kirschner wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> I&#180;m using squid (3.5.9) as transparent https proxy with build options (see below) and config (see below , I removed some uninteresting things from the config like caching).
</I>&gt;<i> 
</I>&gt;<i> To get the system more secure I would like to add crl checking (at the moment static , later maybe dynamic if it's possible with my skills :-) ) and ocsp (later) .
</I>&gt;<i> I&#180;m using the site <A HREF="https://revoked.grc.com/">https://revoked.grc.com/</A> to test my config.
</I>&gt;<i> To do it I downloaded the certificate from the site , checked if a CRL URI is available and downloaded the crl.
</I>&gt;<i> Converted the format of the crl from DER to pem and inserted it my squid.conf  &quot;crlfile=/tmp/crl/glob.pem sslflags=VERIFY_CRL&quot;.
</I>&gt;<i> 
</I>&gt;<i> I tested the &quot;crl.pem&quot; with openssl and the site <A HREF="https://revoked.grc.com/">https://revoked.grc.com/</A>  is revoked in the crl.
</I>&gt;<i> 
</I>&gt;<i> But why squid seems to ignore the crlfile option / file ? 
</I>
Because it is only relevant on http(s)_port when there is TLS client certificate authentication being verified. You do not have that configured.


&gt;<i> Also I tested to use the crl in DER format but it still wouldn&#8217;t work , even didn&#8217;t saw an error in the log when the file isn&#8217;t available.
</I>
It is not even loaded unless the clientca= is configured. Which turns on client cert authentication.


If you mean it to be used to verify the *server* certificates then you need to configure sslproxy_crlfile instead.


&gt;<i> #config
</I>&gt;<i> http_port local.ip.adress:3128 ssl-bump generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB 
</I>&gt;<i> cert=/usr/pbi/squid-amd64/local/etc/squid/serverkey.pem 
</I>&gt;<i> capath=/usr/pbi/squid-amd64/local/share/certs/ 
</I>&gt;<i> crlfile=/tmp/crl/glob.pem sslflags=VERIFY_CRL
</I>&gt;<i> 
</I>&gt;<i> http_port 127.0.0.1:3128 intercept ssl-bump 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=10MB 
</I>&gt;<i> cert=/usr/pbi/squid-amd64/local/etc/squid/serverkey.pem 
</I>&gt;<i> capath=/usr/pbi/squid-amd64/local/share/certs/ 
</I>&gt;<i> crlfile=/tmp/crl/glob.pem sslflags=VERIFY_CRL
</I>&gt;<i> 
</I>&gt;<i> https_port 127.0.0.1:3129 intercept ssl-bump 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=10MB 
</I>&gt;<i> cert=/usr/pbi/squid-amd64/local/etc/squid/serverkey.pem 
</I>&gt;<i> capath=/usr/pbi/squid-amd64/local/share/certs/ 
</I>&gt;<i> crlfile=/tmp/crl/glob.pem sslflags=VERIFY_CRL
</I>&gt;<i> 
</I>&gt;<i> icp_port 0
</I>
This is a default, remove the icp_port line.

&gt;<i> dns_v4_first on
</I>&gt;<i> pid_filename /var/run/squid/squid.pid
</I>
This is a default, remove the pid_filename line.

&gt;<i> cache_effective_user proxy
</I>&gt;<i> cache_effective_group proxy
</I>
Check your build options (squid -v), your proxy is built to use the account 'squid'. It is usually a good idea to stick with the


&gt;<i> error_default_language de-de
</I>&gt;<i> icon_directory /usr/pbi/squid-amd64/local/etc/squid/icons
</I>&gt;<i> visible_hostname pfsense
</I>
visible_hostname needs to be FQDN and publicly resolvable. It is the DNS hostname people use to access your proxy for thise icons you configured (amongst other things).

&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at pfsense-onesty.loc</A>
</I>&gt;<i> access_log /var/squid/logs/access.log
</I>&gt;<i> cache_log /var/squid/logs/cache.log
</I>&gt;<i> cache_store_log none
</I>
This is a default, remove the cache_store_log line.

&gt;<i> netdb_filename /var/squid/logs/netdb.state pinger_enable on 
</I>&gt;<i> pinger_program /usr/pbi/squid-amd64/local/libexec/squid/pinger
</I>
This is probably a default too, if so remove the pinger lines. It will run unless disabled.

&gt;<i> sslcrtd_program /usr/pbi/squid-amd64/local/libexec/squid/ssl_crtd -s 
</I>&gt;<i> /var/squid/lib/ssl_db -M 4MB -b 2048 sslcrtd_children 5
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 7
</I>&gt;<i> debug_options rotate=7
</I>&gt;<i> shutdown_lifetime 3 seconds
</I>&gt;<i> acl localnet src  local.network.range
</I>&gt;<i> forwarded_for on
</I>
This is a default, remove the forwarded_for line.

&gt;<i> uri_whitespace strip
</I>&gt;<i> 
</I>&gt;<i> acl dynamic urlpath_regex cgi-bin ?
</I>&gt;<i> cache deny dynamic
</I>
Remove the above if you want to actually cache much content. Squid has been okay with caching this stuff since 2.7.

&gt;<i> 
</I>&gt;<i> acl allsrc src all
</I>
Don't. Really. &quot;all&quot; is a built-in ACL, just use it.

&gt;<i> acl safeports port 21 70 80 210 280 443 488 563 591 631 777 901  3128 
</I>&gt;<i> 3127 1025-65535 acl sslports port 443 563
</I>&gt;<i> 
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl connect method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl HTTP proto HTTP
</I>&gt;<i> acl HTTPS proto HTTPS
</I>&gt;<i> acl allowed_subnets src local.network.range
</I>
You defined localnet to that already. Meaning you can replace all uses of &quot;allowed_subnets&quot; with &quot;localnet&quot;.

&gt;<i> acl whitelist dstdom_regex -i '/var/squid/acl/whitelist.acl'
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>
Best practice is now to move all the above http_access lines with their slow and DoS-vulnerable ACL processing down below the CONNECT line following...

&gt;<i> http_access deny !safeports
</I>&gt;<i> http_access deny CONNECT !sslports
</I>&gt;<i> 
</I>&gt;<i> request_body_max_size 0 KB
</I>
Seriously? POST and PUT are forbidden to send data anywhere?

&gt;<i> delay_pools 1
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 -1/-1 -1/-1
</I>&gt;<i> delay_initial_bucket_level 100
</I>&gt;<i> delay_access 1 allow allsrc
</I>
Hmm. A delay pool that does not do anything, and every byte of traffic is processed through it.
Completely useless waste of CPU cycles and memory. Remove all of the above lines.

&gt;<i> 
</I>&gt;<i> always_direct allow whitelist
</I>
You don't use cache_peer. The above line is useless. Remove it.

&gt;<i> ssl_bump none whitelist
</I>
Do not mix deprecated bumping modes with non-deprecated.
Use &quot;splice&quot; instead of &quot;none&quot; in the above rule...

Then notice that dstdom_regex ACL will not work in ssl_bump. So you may as well remove the line entirely.

Your peek/splice rules below with &quot;bypass&quot; ACL seem to be doing what you intended this to do.



&gt;<i> # Package Integration
</I>&gt;<i> url_rewrite_program /usr/pbi/squidguard-amd64/bin/squidGuard -c 
</I>&gt;<i> /usr/pbi/squidguard-amd64/etc/squidGuard/squidGuard.conf
</I>&gt;<i> url_rewrite_bypass off
</I>&gt;<i> url_rewrite_children 16 startup=8 idle=4 concurrency=0
</I>&gt;<i> 
</I>&gt;<i> # Custom options before auth
</I>&gt;<i> #debug_options all,1 20,0 36,0 41,0 47,0 79,0 90,0 92,0 debug_options 
</I>&gt;<i> 83,6
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>
Note that step2 and step3 are not being used. You can remove those lines.

&gt;<i> 
</I>&gt;<i> acl bypass ssl::server_name .google.de .sparkasse.de .postbank.de acl 
</I>&gt;<i> wupdate ssl::server_name .windowsupdate.com .microsoft.com
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump peek bypass wupdate
</I>&gt;<i> ssl_bump splice bypass wupdate
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow wupdate
</I>
Note that ssl::server_name probably won't work in this sslproxy_* rules.

&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> 
</I>&gt;<i> # Always allow access to whitelist domains http_access allow whitelist 
</I>&gt;<i> # Setup allowed acls # Allow local network(s) on interface(s) 
</I>&gt;<i> http_access allow allowed_subnets http_access allow localnet
</I>
Note that localnet == allowed_subnets, so the allowed_subnets line can be removed.

&gt;<i> # Default block all to be sure
</I>&gt;<i> http_access deny allsrc
</I>
Really s/allsrc/all/

&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #build options
</I>&gt;<i> configure options: '--with-default-user=squid'
</I>'--bindir=/usr/pbi/squid-amd64/local/sbin'
'--sbindir=/usr/pbi/squid-amd64/local/sbin'
'--datadir=/usr/pbi/squid-amd64/local/etc/squid'
'--libexecdir=/usr/pbi/squid-amd64/local/libexec/squid'
'--localstatedir=/var'
'--sysconfdir=/usr/pbi/squid-amd64/local/etc/squid'
'--with-logdir=/var/squid/logs'
'--with-pidfile=/var/run/squid/squid.pid'
&gt;<i> '--with-swapdir=/var/squid/cache' '--without-gnutls' '--enable-auth'
</I>&gt;<i> '--enable-build-info'
</I>&lt;snip&gt;


build-info requires a string. Whoever provided this package needs to fix that.


Amos
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005796.html">[squid-users] Squid ignores crlfile options
</A></li>
	<LI>Next message (by thread): <A HREF="005820.html">[squid-users] Squid ignores crlfile options
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5814">[ date ]</a>
              <a href="thread.html#5814">[ thread ]</a>
              <a href="subject.html#5814">[ subject ]</a>
              <a href="author.html#5814">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
