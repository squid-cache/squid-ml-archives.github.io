<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Host header forgery detected after upgrade from 3.5.8	to 3.5.9
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Host%20header%20forgery%20detected%20after%20upgrade%20from%203.5.8%0A%09to%203.5.9&In-Reply-To=%3Ccone.1444132533.283107.14341.1000%40bollix%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005841.html">
   <LINK REL="Next"  HREF="005902.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Host header forgery detected after upgrade from 3.5.8	to 3.5.9</H1>
    <B>Roel van Meer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Host%20header%20forgery%20detected%20after%20upgrade%20from%203.5.8%0A%09to%203.5.9&In-Reply-To=%3Ccone.1444132533.283107.14341.1000%40bollix%3E"
       TITLE="[squid-users] Host header forgery detected after upgrade from 3.5.8	to 3.5.9">roel at 1afa.com
       </A><BR>
    <I>Tue Oct  6 11:55:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005841.html">[squid-users] Possible Bug in squid? [Fwd: Re: [openssl-users] Problem checking certificate with OCSP]
</A></li>
        <LI>Next message (by thread): <A HREF="005902.html">[squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5846">[ date ]</a>
              <a href="thread.html#5846">[ thread ]</a>
              <a href="subject.html#5846">[ subject ]</a>
              <a href="author.html#5846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,

I have a Squid setup on a linux box with transparent interception of both  
http and https traffic. Everything worked fine with Squid 3.5.6. After  
upgrading to version 3.5.10, I get many warnings about host header forgery:

  SECURITY ALERT: Host header forgery detected on local=104.46.50.125:443 remote=192.168.9.126:52588 FD 22 flags=33 (local IP does not match any domain IP)
  SECURITY ALERT: By user agent:
  SECURITY ALERT: on URL: nexus.officeapps.live.com:443

These warnings all seem to occur for https web sites that use multiple DNS  
records. The warnings coincide with the fact that the clients are unable to  
get the requested page.

I've read the wiki page <A HREF="http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>
and I can assert that:
- we do NAT on the same box that is running Squid
- both squid and the clients use the same DNS server

I've also tested 3.5.9, and this version also showed these warnings.
Version 3.5.7 worked fine, and 3.5.8 did too.

So, one of the changes in 3.5.9 caused this behaviour.

Can anyone shed some more light on this? Is this a problem in my setup that  
surfaced with 3.5.9, or is it a problem in Squid?

Thanks a lot for any help,

Roel


My (abbreviated) config:

http_port 192.168.9.1:3128 ssl-bump cert=/etc/ssl/certs/server.pem
http_port 192.168.9.1:3129 intercept
https_port 192.168.9.1:3130 intercept ssl-bump cert=/etc/ssl/certs/server.pem
icp_port 0

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

acl port-direct myportname 192.168.9.1:3128
ssl_bump none port-direct
acl port-trans_https myportname 192.168.9.1:3130
external_acl_type sni children-max=3 children-startup=1 %URI %SRC %METHOD %ssl::&gt;sni /usr/bin/squidGuard-aclsni
acl checksni external sni

ssl_bump peek port-trans_https step1
ssl_bump terminate port-trans_https step2 checksni
ssl_bump splice port-trans_https all

sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005841.html">[squid-users] Possible Bug in squid? [Fwd: Re: [openssl-users] Problem checking certificate with OCSP]
</A></li>
	<LI>Next message (by thread): <A HREF="005902.html">[squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5846">[ date ]</a>
              <a href="thread.html#5846">[ thread ]</a>
              <a href="subject.html#5846">[ subject ]</a>
              <a href="author.html#5846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
