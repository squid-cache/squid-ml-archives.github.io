<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ICAP and HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20and%20HTTPS&In-Reply-To=%3C5613FD71.3040006%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005852.html">
   <LINK REL="Next"  HREF="005855.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ICAP and HTTPS</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20and%20HTTPS&In-Reply-To=%3C5613FD71.3040006%40ngtech.co.il%3E"
       TITLE="[squid-users] ICAP and HTTPS">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Oct  6 16:57:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005852.html">[squid-users] ICAP and HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="005855.html">[squid-users] ICAP and HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5854">[ date ]</a>
              <a href="thread.html#5854">[ thread ]</a>
              <a href="subject.html#5854">[ subject ]</a>
              <a href="author.html#5854">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Paul,

 From what I have seen until now I believe that the ICAP service 
response is for a CONNECT request.
 From security reasons browsers are not allowing or rather then not 
implanting support for a direct HTTP response to a CONNECT(tunnel) requests.
This is why you see this reaction from the browsers.
using peek and splice would not change the behavior of the browsers and 
client and there for it will not change anything for this specific scenario.

However you can implement the inspection on the https level and not the 
CONNECT level which would work.
If somehow you will find the right way to pass or to not pass CONNECT 
requests to the ICAP service you might get to a situation which the 
CONNECT by itself is allowed(and not inspected by the ICAP service) and 
peek+splice would bump the connection and then the adaption(ICAP) 
service will analyze the wrapped http level inside the CONNECT request.
This way the browser will receive the ICAP service response on the http 
level and will show to the client the block page.

I know it is possible and Diladele solution does that already so there 
is some light for you.

The issue is that I have not implemented it yet and there for cannot 
give you instructions on how to implement it.

Eliezer

On 06/10/2015 19:14, Paul Carew wrote:
&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> Just a quick question regarding SSL bump and ICAP.
</I>&gt;<i>
</I>&gt;<i> I have integrated Squid 3.5.9 with a commercial product that provides
</I>&gt;<i> an ICAP service. It works fine for HTTP.
</I>&gt;<i>
</I>&gt;<i> Upon recieving an ICAP query for a blocked HTTP site the following
</I>&gt;<i> ICAP response is returned.
</I>&gt;<i>
</I>&gt;<i> ICAP/1.0 200 OK
</I>&gt;<i> ISTAG: &quot;PRODUCTNAME&quot;
</I>&gt;<i> Attribute: Blocked Sites
</I>&gt;<i> Encapsulated: res-hdr=0, null-body=148
</I>&gt;<i>
</I>&gt;<i> HTTP/1.0 302 Moved
</I>&gt;<i> Location: <A HREF="http://192.168.0.10/block?session=12345678">http://192.168.0.10/block?session=12345678</A>
</I>&gt;<i> Pragma: no-cache
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i>
</I>&gt;<i> and the block page is correctly displayed in the users browser
</I>&gt;<i>
</I>&gt;<i> However, when accessing a blocked site over HTTPS the following ICAP
</I>&gt;<i> response is received:
</I>&gt;<i>
</I>&gt;<i> ICAP/1.0 200 OK
</I>&gt;<i> ISTAG: &quot;PRODUCTNAME&quot;
</I>&gt;<i> Attribute: Blocked Sites
</I>&gt;<i> Encapsulated: res-hdr=0, null-body=533
</I>&gt;<i>
</I>&gt;<i> HTTP/1.0 403 Blocked
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i> Pragma: no-cache
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i> Location: <A HREF="http://192.168.0.10/block?session=12345678">http://192.168.0.10/block?session=12345678</A>
</I>&gt;<i>
</I>&gt;<i> &lt;html&gt;
</I>&gt;<i>    &lt;head&gt;
</I>&gt;<i>      &lt;meta http-equiv=&quot;refresh&quot;
</I>&gt;<i> content=&quot;0;url=<A HREF="http://192.168.0.10/block?session=12345678">http://192.168.0.10/block?session=12345678</A>&quot;&gt;
</I>&gt;<i>      &lt;title&gt;Blocked&lt;/title&gt;
</I>&gt;<i>    &lt;/head&gt;
</I>&gt;<i>    &lt;body&gt;
</I>&gt;<i>      &lt;h4&gt;You have been blocked.&lt;/h4&gt;
</I>&gt;<i>      &lt;p&gt;Click &lt;a
</I>&gt;<i> href=&quot;<A HREF="http://192.168.0.10/block?session=12345678">http://192.168.0.10/block?session=12345678</A>&quot;&gt;here&lt;/a&gt; for
</I>&gt;<i> details&lt;/p&gt;
</I>&gt;<i>    &lt;/body&gt;
</I>&gt;<i> &lt;/html&gt;
</I>&gt;<i>
</I>&gt;<i> Chrome and IE just error upon receiving this response. In the case of
</I>&gt;<i> Chrome I get an ERR_TUNNEL_CONNECTION_FAILED error. I could be wrong
</I>&gt;<i> but I would imagine this error is by design, as Chrome will only
</I>&gt;<i> respond to a proxy authentication request or SSL handshake in response
</I>&gt;<i> to a HTTP CONNECT?
</I>&gt;<i>
</I>&gt;<i> If that's correct, I was wondering if there is a way to get this to
</I>&gt;<i> work, with peek and splice possibly or any alternative method?
</I>&gt;<i>
</I>&gt;<i> Thank you
</I>&gt;<i>
</I>&gt;<i> Paul
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005852.html">[squid-users] ICAP and HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="005855.html">[squid-users] ICAP and HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5854">[ date ]</a>
              <a href="thread.html#5854">[ thread ]</a>
              <a href="subject.html#5854">[ subject ]</a>
              <a href="author.html#5854">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
