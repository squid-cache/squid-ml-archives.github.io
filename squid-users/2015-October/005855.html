<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ICAP and HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20and%20HTTPS&In-Reply-To=%3C5613FF47.9080609%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005854.html">
   <LINK REL="Next"  HREF="005859.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ICAP and HTTPS</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20and%20HTTPS&In-Reply-To=%3C5613FF47.9080609%40measurement-factory.com%3E"
       TITLE="[squid-users] ICAP and HTTPS">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Oct  6 17:05:11 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005854.html">[squid-users] ICAP and HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="005859.html">[squid-users] ICAP and HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5855">[ date ]</a>
              <a href="thread.html#5855">[ thread ]</a>
              <a href="subject.html#5855">[ subject ]</a>
              <a href="author.html#5855">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/06/2015 10:14 AM, Paul Carew wrote:

&gt;<i> when accessing a blocked site over HTTPS the following ICAP
</I>&gt;<i> response is received:
</I>&gt;<i> 
</I>&gt;<i> ICAP/1.0 200 OK
</I>&gt;<i> ISTAG: &quot;PRODUCTNAME&quot;
</I>&gt;<i> Attribute: Blocked Sites
</I>&gt;<i> Encapsulated: res-hdr=0, null-body=533
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.0 403 Blocked
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i> Pragma: no-cache
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i> Location: <A HREF="http://192.168.0.10/block?session=12345678">http://192.168.0.10/block?session=12345678</A>
</I>&gt;<i> 
</I>&gt;<i> &lt;html&gt;
</I>...
&gt;<i> &lt;/html&gt;
</I>

&gt;<i> Chrome and IE just error upon receiving this response. In the case of
</I>&gt;<i> Chrome I get an ERR_TUNNEL_CONNECTION_FAILED error. I could be wrong
</I>&gt;<i> but I would imagine this error is by design, as Chrome will only
</I>&gt;<i> respond to a proxy authentication request or SSL handshake in response
</I>&gt;<i> to a HTTP CONNECT?
</I>
Yes, this is by [&quot;lazy&quot;] browsers design (not specific to Chrome or IE).


&gt;<i> If that's correct, I was wondering if there is a way to get this to
</I>&gt;<i> work, with peek and splice possibly or any alternative method?
</I>
Yes, you have a few options:

1. Do not block CONNECT. Block the HTTP request after CONNECT instead.
This does not require Squid modifications, but may require ICAP service
modifications, including keeping state between HTTP requests.


2. If you do not care about the actual error message displayed to the
user OR are OK with using [customizable] Squid error messages instead of
the ICAP-generated error messages, then you may:

2a. Teach Squid to treat certain ICAP responses as an instruction to
&quot;block the virgin HTTP message&quot;. Squid eCAP client already supports that
(see 2d below). Squid ICAP client needs more work, including a decision
on how to define those &quot;certain responses&quot; in the ICAP context (should
probably be done via a new ACL-driven squid.conf directive).

2b. Teach the ICAP service to allow the CONNECT request but add an
extension HTTP header to it. Use adapted_http_access to block the
adapted CONNECT request.

2c. Teach Squid to use non-standard ICAP response headers as transaction
annotations (eCAP can do that already). Use adapted_http_access to block
the CONNECT transaction with your &quot;blocking&quot; annotations.

2d. Switch from ICAP to eCAP and use the existing
libecap::host::Xaction::blockVirgin() API. This option does not require
Squid development.


3. If you must use ICAP-generated error messages and cannot use option
#1 above, then you can do either #2a or #2d _and_ also teach Squid to
save and serve the custom error message returned by the adaptation
service. This option requires [very] difficult Squid development work
(in addition to easier development work required by #2a), but it is
possible.


All of the above options require bumping the connection. There is no
other way to serve an error message to the user (because of the browsers
design).

In the above text, &quot;teach X to do Y&quot; means &quot;modify X code to
[optionally] do Y&quot;, including finding somebody who can perform those
source code modifications for you if needed.

I believe the above options are reasonable/valid, but I have not tested
any of them with a recent stock Squid. YMMV.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005854.html">[squid-users] ICAP and HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="005859.html">[squid-users] ICAP and HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5855">[ date ]</a>
              <a href="thread.html#5855">[ thread ]</a>
              <a href="subject.html#5855">[ subject ]</a>
              <a href="author.html#5855">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
