<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ICAP and HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20and%20HTTPS&In-Reply-To=%3C56146C3D.5050200%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005860.html">
   <LINK REL="Next"  HREF="005866.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ICAP and HTTPS</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20and%20HTTPS&In-Reply-To=%3C56146C3D.5050200%40urlfilterdb.com%3E"
       TITLE="[squid-users] ICAP and HTTPS">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Wed Oct  7 00:50:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005860.html">[squid-users] ICAP and HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="005866.html">[squid-users] ICAP and HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5863">[ date ]</a>
              <a href="thread.html#5863">[ thread ]</a>
              <a href="subject.html#5863">[ subject ]</a>
              <a href="author.html#5863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 10/06/2015 06:05 PM, Rafael Akchurin wrote:
&gt;<i> Hello Paul, Eliezer, Alex,
</I>&gt;<i>
</I>&gt;<i> We (diladele ICAP) have an open bug /feature requests for this:
</I>&gt;<i> 	<A HREF="https://github.com/ra-at-diladele-com/qlproxy_external/issues/731">https://github.com/ra-at-diladele-com/qlproxy_external/issues/731</A>
</I>&gt;<i> 	<A HREF="https://github.com/ra-at-diladele-com/qlproxy_external/issues/726">https://github.com/ra-at-diladele-com/qlproxy_external/issues/726</A>
</I>&gt;<i>
</I>&gt;<i> As Alex described most probably we will do the 2b approach - although the work has not started yet.
</I>&gt;<i> Hope to be able to have something by the end of this year!
</I>
The 2b) option a.k.a &quot;simply always allow the CONNECT www.example.com and
later block GET <A HREF="https://www.example.com/index.html">https://www.example.com/index.html</A>&quot; _only_ works for
correctly SSL-bumped sites and does not work sites that do not use SSL+HTTP.

For Skype, SSH tunnels and other protocols that also use CONNECT
the ICAP server must block the CONNECT (if configured to do so).
There are even sites that use SSL+other protocol, so bumping such site may
initially seem OK since the SSL handshake was done without problems,
but since it is not followed by an HTTP protocol request, the ICAP server
will never see a followup HTTP GET/POST and hence will never be able to
block the site after it allowed the CONNECT.
So if the site must be blocked, the ICAP server must already decide what
to do when it receives a CONNECT request:
a) guess that the CONNECT is for SSL+HTTP, pass the CONNECT and wait for the followup GET/POST to be blocked, or
b) guess that the CONNECT is for a site that does not use SSL+HTTP and block the CONNECT.

Because of the above, I had a discussion a long time ago with the Squid developers
to extend Squid to send the (non-HTTP) content to the ICAP server in case
that the CONNECT tunnel does not have SSL+HTTP, but the implementation effort
was considered to be too much at that time.
If, however, this feature is implemented, the ICAP server no longer has to guess
and can always pass the CONNECT and decide later, knowing that it will either
receive an HTTP request or the non-HTTP content.

Best regards,
Marcus


&gt;<i> P.S. The <A HREF="http://docs.diladele.com/faq/squid/cannot_connect_to_site_using_https.html">http://docs.diladele.com/faq/squid/cannot_connect_to_site_using_https.html</A> describes why the blocked message is not shown in simple words.
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i> Diladele B.V.
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Paul Carew
</I>&gt;<i> Sent: Tuesday, October 6, 2015 10:21 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] ICAP and HTTPS
</I>&gt;<i>
</I>&gt;<i> Thanks Alex, Dieter &amp; Eliezer
</I>&gt;<i>
</I>&gt;<i> I've been trying to prevent the CONNECT request being processed by ICAP and the following configuration in Squid 3.5.9 alongside a standard SSL peek and splice config appears to work:
</I>&gt;<i>
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> adaptation_access service_req deny CONNECT adaptation_access service_req allow all
</I>&gt;<i>
</I>&gt;<i> Although I haven't tested this thoroughly yet, it appears to allow the initial tunnel creation but allow filtering of subsequent requests within those tunnels. Although I guess this will only work for bumped connections.
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> Paul
</I>&gt;<i>
</I>&gt;<i> On 6 October 2015 at 18:05, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 10/06/2015 10:14 AM, Paul Carew wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> when accessing a blocked site over HTTPS the following ICAP response
</I>&gt;&gt;&gt;<i> is received:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ICAP/1.0 200 OK
</I>&gt;&gt;&gt;<i> ISTAG: &quot;PRODUCTNAME&quot;
</I>&gt;&gt;&gt;<i> Attribute: Blocked Sites
</I>&gt;&gt;&gt;<i> Encapsulated: res-hdr=0, null-body=533
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> HTTP/1.0 403 Blocked
</I>&gt;&gt;&gt;<i> Content-Type: text/html
</I>&gt;&gt;&gt;<i> Pragma: no-cache
</I>&gt;&gt;&gt;<i> Cache-Control: no-cache
</I>&gt;&gt;&gt;<i> Location: <A HREF="http://192.168.0.10/block?session=12345678">http://192.168.0.10/block?session=12345678</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &lt;html&gt;
</I>&gt;&gt;<i> ...
</I>&gt;&gt;&gt;<i> &lt;/html&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Chrome and IE just error upon receiving this response. In the case of
</I>&gt;&gt;&gt;<i> Chrome I get an ERR_TUNNEL_CONNECTION_FAILED error. I could be wrong
</I>&gt;&gt;&gt;<i> but I would imagine this error is by design, as Chrome will only
</I>&gt;&gt;&gt;<i> respond to a proxy authentication request or SSL handshake in
</I>&gt;&gt;&gt;<i> response to a HTTP CONNECT?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, this is by [&quot;lazy&quot;] browsers design (not specific to Chrome or IE).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If that's correct, I was wondering if there is a way to get this to
</I>&gt;&gt;&gt;<i> work, with peek and splice possibly or any alternative method?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, you have a few options:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Do not block CONNECT. Block the HTTP request after CONNECT instead.
</I>&gt;&gt;<i> This does not require Squid modifications, but may require ICAP
</I>&gt;&gt;<i> service modifications, including keeping state between HTTP requests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. If you do not care about the actual error message displayed to the
</I>&gt;&gt;<i> user OR are OK with using [customizable] Squid error messages instead
</I>&gt;&gt;<i> of the ICAP-generated error messages, then you may:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2a. Teach Squid to treat certain ICAP responses as an instruction to
</I>&gt;&gt;<i> &quot;block the virgin HTTP message&quot;. Squid eCAP client already supports
</I>&gt;&gt;<i> that (see 2d below). Squid ICAP client needs more work, including a
</I>&gt;&gt;<i> decision on how to define those &quot;certain responses&quot; in the ICAP
</I>&gt;&gt;<i> context (should probably be done via a new ACL-driven squid.conf directive).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2b. Teach the ICAP service to allow the CONNECT request but add an
</I>&gt;&gt;<i> extension HTTP header to it. Use adapted_http_access to block the
</I>&gt;&gt;<i> adapted CONNECT request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2c. Teach Squid to use non-standard ICAP response headers as
</I>&gt;&gt;<i> transaction annotations (eCAP can do that already). Use
</I>&gt;&gt;<i> adapted_http_access to block the CONNECT transaction with your &quot;blocking&quot; annotations.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2d. Switch from ICAP to eCAP and use the existing
</I>&gt;&gt;<i> libecap::host::Xaction::blockVirgin() API. This option does not
</I>&gt;&gt;<i> require Squid development.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3. If you must use ICAP-generated error messages and cannot use option
</I>&gt;&gt;<i> #1 above, then you can do either #2a or #2d _and_ also teach Squid to
</I>&gt;&gt;<i> save and serve the custom error message returned by the adaptation
</I>&gt;&gt;<i> service. This option requires [very] difficult Squid development work
</I>&gt;&gt;<i> (in addition to easier development work required by #2a), but it is
</I>&gt;&gt;<i> possible.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All of the above options require bumping the connection. There is no
</I>&gt;&gt;<i> other way to serve an error message to the user (because of the
</I>&gt;&gt;<i> browsers design).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In the above text, &quot;teach X to do Y&quot; means &quot;modify X code to
</I>&gt;&gt;<i> [optionally] do Y&quot;, including finding somebody who can perform those
</I>&gt;&gt;<i> source code modifications for you if needed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe the above options are reasonable/valid, but I have not
</I>&gt;&gt;<i> tested any of them with a recent stock Squid. YMMV.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005860.html">[squid-users] ICAP and HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="005866.html">[squid-users] ICAP and HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5863">[ date ]</a>
              <a href="thread.html#5863">[ thread ]</a>
              <a href="subject.html#5863">[ subject ]</a>
              <a href="author.html#5863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
