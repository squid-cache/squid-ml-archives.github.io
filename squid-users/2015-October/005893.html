<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] help with acl order and deny_info pages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C20151007164041.5b6257cb%40efreet.kappastar.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005889.html">
   <LINK REL="Next"  HREF="005896.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] help with acl order and deny_info pages</H1>
    <B>Marko Cupa&#263;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C20151007164041.5b6257cb%40efreet.kappastar.com%3E"
       TITLE="[squid-users] help with acl order and deny_info pages">marko.cupac at mimar.rs
       </A><BR>
    <I>Wed Oct  7 14:40:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005889.html">[squid-users] Error on negotiating SSL connection
</A></li>
        <LI>Next message (by thread): <A HREF="005896.html">[squid-users] squid 3.1 ldap authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5893">[ date ]</a>
              <a href="thread.html#5893">[ thread ]</a>
              <a href="subject.html#5893">[ subject ]</a>
              <a href="author.html#5893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 24 Sep 2015 23:02:35 +1200
Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 24/09/2015 7:30 p.m., Marko Cupa&#263; wrote:
</I>&gt;<i> &gt; On Sun, 20 Sep 2015 21:43:26 +1200
</I>&gt;<i> &gt; Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; On 17/09/2015 7:24 p.m., Marko Cupa&#263; wrote:
</I>&gt;<i> &gt;&gt;&gt; On Thu, 17 Sep 2015 03:00:56 +1200
</I>&gt;<i> &gt;&gt;&gt; Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; On 17/09/2015 12:37 a.m., Marko Cupa&#263; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; I'm trying to setup squid in a way that it authenticates users
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; via kerberos and grants different levels of web access
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; according to ldap query of MS AD groups.After some trials and
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; errors I have found acl order which apparently does not trigger
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; reauthentication (auth dialogues in browsers although I don't
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; even provide basic auth).
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; What makes you think browser dialog box has anything to do with
</I>&gt;<i> &gt;&gt;&gt;&gt; Basic auth? All it means is that the browser does not know what
</I>&gt;<i> &gt;&gt;&gt;&gt; credentials will work. The ones tried (if any) have been rejected
</I>&gt;<i> &gt;&gt;&gt;&gt; with a challenge response (401/407) for valid ones. It may be the
</I>&gt;<i> &gt;&gt;&gt;&gt; browser password manager.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; If you are using only Kerberos auth then users enter their
</I>&gt;<i> &gt;&gt;&gt;&gt; Kerberos username and password into the dialog to allow the
</I>&gt;<i> &gt;&gt;&gt;&gt; browser to fetch the Kerberos token (or keytab entry) it needs
</I>&gt;<i> &gt;&gt;&gt;&gt; to send to Squid.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Here's relevant part:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny !Safe_ports
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access allow localhost manager
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny manager
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny to_localhost
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny !auth all
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_reply_access allow !basic_mimetypes basic_users
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access allow !advanced_domains !advanced_extensions
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; advanced_users http_access allow expert_users all
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access allow localhost
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny all
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; I'd like to know which acl triggered the ban, so I've created
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; custom error page:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; error_directory /usr/local/etc/squid/myerrors
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; The problem is that my custom error page does not trigger when I
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; expect it to (member of basic_users accessing URL with extension
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; listed in basic_extensions) - ERR_ACCESS_DENIED is triggered
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; instead. I guess this is because of last matching rule which is
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; http_access deny all.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Perhapse.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; But, basic_extensions is never the last listed ACL in a denial
</I>&gt;<i> &gt;&gt;&gt;&gt; rule. There is never a deny action associated with the ACL. That
</I>&gt;<i> &gt;&gt;&gt;&gt; is why the deny_info response template is not being used.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Is there another way how I can order acls so that I don't
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; trigger reauthentication while triggering deny_info?
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Not without the ACL definition details.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Amos
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Hi Amos,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; thank you for looking into this. Here's complete squid.conf (I
</I>&gt;<i> &gt;&gt;&gt; changed just private details such as domain, DN, password etc. in
</I>&gt;<i> &gt;&gt;&gt; external_acl_type).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &lt;snip'ing bits of config not relevant to the answer&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; auth_param negotiate
</I>&gt;<i> &gt;&gt;&gt; program /usr/local/libexec/squid/negotiate_kerberos_auth \ -r -s
</I>&gt;<i> &gt;&gt;&gt; GSS_C_NO_NAME
</I>&gt;<i> &gt;&gt; &lt;snip&gt;
</I>&gt;<i> &gt;&gt;&gt; # ldap query for group membership
</I>&gt;<i> &gt;&gt;&gt; external_acl_type adgroups ttl=60 children-startup=2
</I>&gt;<i> &gt;&gt;&gt; children-max=10 %LOGIN
</I>&gt;<i> &gt;&gt;&gt; \ /usr/local/libexec/squid/ext_ldap_group_acl -R \
</I>&gt;<i> &gt;&gt; &lt;snip&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; These ACLs...
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; # map ldap groups to squid acls
</I>&gt;<i> &gt;&gt;&gt; acl basic_users external adgroups squid_basic
</I>&gt;<i> &gt;&gt;&gt; acl advanced_users external adgroups squid_advanced
</I>&gt;<i> &gt;&gt;&gt; acl expert_users external adgroups squid_expert
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ... to here ...
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &lt;snip&gt;
</I>&gt;<i> &gt;&gt;&gt; # require proxy authentication
</I>&gt;<i> &gt;&gt;&gt; acl auth proxy_auth REQUIRED
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ... and the &quot;auth&quot; one will all trigger 407 challenges *if* they
</I>&gt;<i> &gt;&gt; are the last ACL on the line. Or if there are no credentials of
</I>&gt;<i> &gt;&gt; any kind given in the request.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; # custom error pages
</I>&gt;<i> &gt;&gt;&gt; deny_info ERR_BASIC_DOMAIN basic_domains
</I>&gt;<i> &gt;&gt;&gt; deny_info ERR_ADVANCED_DOMAIN advanced_domains
</I>&gt;<i> &gt;&gt;&gt; deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;<i> &gt;&gt;&gt; deny_info ERR_ADVANCED_EXTENSION advanced_extensions
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &lt;snip&gt;
</I>&gt;<i> &gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt;&gt;&gt; http_access deny !auth all
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Problem #1:
</I>&gt;<i> &gt;&gt;  Any client with halfway decent security will not simply broadcast
</I>&gt;<i> &gt;&gt; credentials on their first request of a new TCP connection, but
</I>&gt;<i> &gt;&gt; will wait for a 407 challenge to indicate both their need and the
</I>&gt;<i> &gt;&gt; type of credentials to send.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The &quot;all&quot; on this line will prevent that 407 happening. Instead it
</I>&gt;<i> &gt;&gt; will simply produce a plain 403 ERR_ACCESS_DENIED for any request
</I>&gt;<i> &gt;&gt; lacking (Kerberos) credentials.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; NP: you can test whether this is your problem with a custom error
</I>&gt;<i> &gt;&gt; page:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  acl test1 src all
</I>&gt;<i> &gt;&gt;  deny_info 499:ERR_ACCESS_DENIED test1
</I>&gt;<i> &gt;&gt;  http_access deny !auth test1
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Your access.log should show the 499 status when its line matches.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;<i> &gt;&gt;&gt; http_access allow !advanced_domains !advanced_extensions
</I>&gt;<i> &gt;&gt;&gt; advanced_users
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Basically okay. These will trigger 407 *if* (and only if) the
</I>&gt;<i> &gt;&gt; client sent Negotiate/Kerberos credentials AND does not have group
</I>&gt;<i> &gt;&gt; permission to access the URL being requested.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Be aware this will probably produce the popups allowing users to
</I>&gt;<i> &gt;&gt; change their credentials to those of another user account with the
</I>&gt;<i> &gt;&gt; right group access. That may or may not be what you want.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I usually find that *these* lines are the ones people most want
</I>&gt;<i> &gt;&gt; not to popup. You have complex ACL tests so the order can be
</I>&gt;<i> &gt;&gt; shuffled to this:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;   http_access allow !basic_domains basic_users !basic_extensions
</I>&gt;<i> &gt;&gt;   http_access allow !advanced_domains
</I>&gt;<i> &gt;&gt; advanced_users !advanced_extensions
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Which prevents the popups from group checking.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If you still want to retain the helper load reduction from having
</I>&gt;<i> &gt;&gt; the extension test first, then append &quot; all&quot; to each of those lines
</I>&gt;<i> &gt;&gt; instead of shuffling.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access allow expert_users all
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt;&gt;&gt; http_access allow localhost
</I>&gt;<i> &gt;&gt;&gt; http_access deny all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Problem 2:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Requests which somehow happen to get past the &quot;deny !auth all&quot; rule
</I>&gt;<i> &gt;&gt; but not have a domain listed in your *_domains ACLs or _do_ match
</I>&gt;<i> &gt;&gt; the paired *_extensions ACLs - will get denied by this final rule.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; NP: you can test that like the earlier test, but use a different
</I>&gt;<i> &gt;&gt; ACL name and 49x status code.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Amos,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'm grateful for your help, but I'm even more confused now. I
</I>&gt;<i> &gt; changed http_access rules according to your advices, tried
</I>&gt;<i> &gt; different combinations, but I still can't achieve intended
</I>&gt;<i> &gt; behaviour. Perhaps I could try to better explain my goals, as maybe
</I>&gt;<i> &gt; there is a better way to solve what I'm trying to achieve.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I want to have 4 levels of web access:
</I>&gt;<i> &gt; expert access - if user is part of expert_users ad group
</I>&gt;<i> &gt; advanced access - if user is part of advanced_users AD group
</I>&gt;<i> &gt; basic access - if user is part of basic_users AD group
</I>&gt;<i> &gt; no access - if user is not part of any AD groups
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> Okay. Your ACLs are defined right for that.
</I>&gt;<i> 
</I>&gt;<i>  acl basic_users external adgroups squid_basic
</I>&gt;<i>  acl advanced_users external adgroups squid_advanced
</I>&gt;<i>  acl expert_users external adgroups squid_expert
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Here's the difference in web access for groups:
</I>&gt;<i> &gt; expert access - allow all
</I>&gt;<i> &gt; advanced access - allow except some extensions and domains
</I>&gt;<i> &gt; basic access - allow except some more extensions and domains
</I>&gt;<i> &gt; no access - allow nothing
</I>&gt;<i> 
</I>&gt;<i> Which is:
</I>&gt;<i> 
</I>&gt;<i>   # authentication required for any access at all
</I>&gt;<i>   http_access deny !auth
</I>&gt;<i> 
</I>&gt;<i>   # expert access - allow all
</I>&gt;<i>   http_access allow expert_users all
</I>&gt;<i> 
</I>&gt;<i>   # advanced access - allow except some extensions and domains
</I>&gt;<i>   http_access deny some_domains
</I>&gt;<i>   http_access deny some_extensions
</I>&gt;<i>   http_access allow advanced_users all
</I>&gt;<i> 
</I>&gt;<i>   # basic access - allow except some more extensions and domains
</I>&gt;<i>   http_access deny more_domains
</I>&gt;<i>   http_access deny more_extensions
</I>&gt;<i>   http_access allow basic_users all
</I>&gt;<i> 
</I>&gt;<i>   # no access - allow nothing
</I>&gt;<i>   http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> What you need to add to this is deny_info for each of the &quot;deny&quot; lines
</I>&gt;<i> ACL. You can have two templates one for domains and one for
</I>&gt;<i> extensions. Re-use the ext template for both of the some_extensions
</I>&gt;<i> and more_extensions. Ditto for the domains template.
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; When a user is redirected to error page, there should be enough info
</I>&gt;<i> &gt; about error:
</I>&gt;<i> &gt; - user as seen by squid (or no user if not authenticated)
</I>&gt;<i> &gt; - group as seen by squid (or no group)
</I>&gt;<i> &gt; - acl that triggered the ban (not the last deny rule)
</I>&gt;<i> 
</I>&gt;<i> This is not possible. It is always the combination of multiple ACLs
</I>&gt;<i> matching and non-matching that leads to a denial.
</I>&gt;<i> 
</I>&gt;<i> The closest you can get is the above config with one ACL per line/rule
</I>&gt;<i> and a deny_info for each of the ones used on deny lines.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The codes that can be used in the error pages are detailed at
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/CustomErrors">http://wiki.squid-cache.org/Features/CustomErrors</A>&gt;
</I>&gt;<i> specifically the %a code can be used to expand the user name. But the
</I>&gt;<i> group and ACL name details are not passed and would have to be
</I>&gt;<i> inferred by which template is being used.
</I>
Hi,

sorry it took me so long to test this. I confirm the ruleset you suggest
accomplishes my goals.

Regards,
-- 
Before enlightenment - chop wood, draw water.
After  enlightenment - chop wood, draw water.

Marko Cupa&#263;
<A HREF="https://www.mimar.rs/">https://www.mimar.rs/</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005889.html">[squid-users] Error on negotiating SSL connection
</A></li>
	<LI>Next message (by thread): <A HREF="005896.html">[squid-users] squid 3.1 ldap authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5893">[ date ]</a>
              <a href="thread.html#5893">[ thread ]</a>
              <a href="subject.html#5893">[ subject ]</a>
              <a href="author.html#5893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
