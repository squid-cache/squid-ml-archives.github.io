<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl-Bump and revoked server certificates
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-Bump%20and%20revoked%20server%20certificates&In-Reply-To=%3C561530DA.8070808%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005892.html">
   <LINK REL="Next"  HREF="005895.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl-Bump and revoked server certificates</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl-Bump%20and%20revoked%20server%20certificates&In-Reply-To=%3C561530DA.8070808%40treenet.co.nz%3E"
       TITLE="[squid-users] Ssl-Bump and revoked server certificates">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct  7 14:48:58 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005892.html">[squid-users] Ssl-Bump and revoked server certificates
</A></li>
        <LI>Next message (by thread): <A HREF="005895.html">[squid-users] Ssl-Bump and revoked server certificates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5894">[ date ]</a>
              <a href="thread.html#5894">[ thread ]</a>
              <a href="subject.html#5894">[ subject ]</a>
              <a href="author.html#5894">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/10/2015 3:17 a.m., Walter H. wrote:
&gt;<i> On 07.10.2015 11:05, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 7/10/2015 4:27 a.m., Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 10/06/2015 01:27 AM, Jason Haar wrote:
</I>&gt;&gt;&gt;&gt;<i> Good catch - I don't think squid does CRL/OCSP checks
</I>&gt;&gt;&gt;&gt;<i> But this is a bug in squid - this means untrustworthy certs become
</I>&gt;&gt;&gt;&gt;<i> trusted again - not a good look
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> IIRC, Squid relies on OpenSSL to perform CRL checks. OpenSSL is
</I>&gt;&gt;&gt;<i> difficult to configure to do CRL checks. If my recollection is correct,
</I>&gt;&gt;&gt;<i> then this is not exactly a Squid bug but more like a missing convenience
</I>&gt;&gt;&gt;<i> feature.
</I>&gt;&gt;<i> Exactly. All thats missing is the squid.conf directive in Squid-3.x.
</I>&gt;&gt;<i> That has been added in Squid-4.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid does not know about OCSP. Another missing feature.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> One may perform all those checks using a custom certificate validator
</I>&gt;&gt;&gt;<i> helper, of course.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> what about these two directives in squid.conf?
</I>&gt;<i> 
</I>&gt;<i> sslcrtvalidator_program and sslcrtvalidator_children
</I>&gt;<i> 
</I>
They are the configuration of that custom helper Alex mentioned. The one
bundled with Squid does not do those checks either AFAIK. But should be
easily modifiable if you know Perl.


&gt;<i> or
</I>&gt;<i> 
</I>&gt;<i> sslcrtvalidator_program cache=8192 ttl=240 /usr/lib64/squid/cert_valid.pl
</I>&gt;<i> sslcrtvalidator_children 12 startup=5 idle=1 concurrency=1
</I>&gt;<i> 
</I>&gt;<i> can I have a working sample of valid_cert.pl that results
</I>&gt;<i> in an &quot;access denied&quot; or any other error page of squid?
</I>
An ERR result from the helper should result in the invalid certificate
handling happening in Squid. Whether that results in a particular error
page (or not) depends on several things I'm not completely certain about.


&gt;<i> (it may bring this on any page that is ssl_bumped,
</I>&gt;<i> so I know the interface, because this here:
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/SslServerCertValidator">http://wiki.squid-cache.org/Features/SslServerCertValidator</A>
</I>&gt;<i> is wrong;
</I>

Ah. I see the concurrency channel is not documented, but is being sent.
What Squid version are you using?

&gt;<i> 
</I>&gt;<i> instead of
</I>&gt;<i> /usr/lib64/squid/cert_valid.pl
</I>&gt;<i> I used a bash-script with this content
</I>&gt;<i> 
</I>&gt;<i> #!/bin/bash
</I>&gt;<i> 
</I>&gt;<i> myprog 2&gt;&gt;/tmp/pre.log |/usr/lib64/squid/cert_valid.pl
</I>&gt;<i> 
</I>&gt;<i> and the C source of myprog:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #include&lt;fcntl.h&gt;
</I>&gt;<i> #include&lt;stdio.h&gt;
</I>&gt;<i> int main( int argc, char* argv[ ] )
</I>&gt;<i> {
</I>&gt;<i>         static char szBuf[ 260 ];
</I>&gt;<i>         int nLen;
</I>&gt;<i>         while( ( nLen = read( 0, (void*) szBuf, 256 ) )&gt;  0 )
</I>&gt;<i>         {
</I>&gt;<i>                 write( 1, (void*) szBuf, nLen );
</I>&gt;<i>                 write( 2, (void*) szBuf, nLen );
</I>&gt;<i>         }
</I>&gt;<i>         return 0;
</I>&gt;<i> }
</I>
This helper is broken. The protocol here or even other helpers, has
never been to dump the input back to Squid.
Input and output &quot;lines&quot; have different syntax and contents.

&gt;<i> 
</I>&gt;<i> so I got the ident content as stdout and stderr and there I catched e.g.
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i> &lt;CATCH CONTENT&gt;
</I>&gt;<i> 0 cert_validate 3373 host=revoked.grc.com
</I>&gt;<i> cert_0=-----BEGIN CERTIFICATE-----
</I>&lt;snip&gt;
&gt;<i> -----END CERTIFICATE-----
</I>&gt;<i> &lt;/CATCH CONTENT&gt;
</I>&gt;<i> 
</I>&gt;<i> with this I could programme a correct certificate validator using OpenSSL,
</I>&gt;<i> but I MUST have a little bit more precise knowledge about the correct
</I>&gt;<i> interface;
</I>&gt;<i> 
</I>&gt;<i> can someone please explain how the 3373 of the CATCH CONTENT above is
</I>&gt;<i> calculated?
</I>
Documented in the wiki:
&quot;Total size of the following request bytes taken by the key=pair
parameters.&quot;

That is the byte size of the &quot;host=...END CERTIFICATE-----&quot; key-pair
part of the message.


&gt;<i> 
</I>&gt;<i> and how the following could deal in connection with this certificate
</I>&gt;<i> validator
</I>&gt;<i> 
</I>&gt;<i> acl certHasExpired ssl_error X509_V_ERR_CERT_HAS_EXPIRED
</I>&gt;<i> acl certNotValid ssl_error X509_V_ERR_CERT_NOT_YET_VALID
</I>&gt;<i> acl certRevoked ssl_error X509_V_ERR_CERT_REVOKED
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error deny certRevoked
</I>&gt;<i> sslproxy_cert_error deny certHasExpired
</I>&gt;<i> sslproxy_cert_error deny certNotValid
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> 
</I>&gt;<i> the generic fake sample /usr/lib64/squid/cert_valid.pl
</I>&gt;<i> 
</I>&gt;<i> returns always &quot;0 OK 0 \1&quot;
</I>&gt;<i> what does \1 mean here?
</I>
The first '0' is concurrency channel ID. It is just an echo of the
channel-ID received on the request.

The other fields are as documented in the wiki. In this example there
are no key-pair values being sent back to Squid. Thus the &quot;0&quot; in the
size field.

\1 is the binary code (0x01) for end of line/message this helper
requires. We cannot use \n like other helpers since several \n are part
of the cert PEM format.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005892.html">[squid-users] Ssl-Bump and revoked server certificates
</A></li>
	<LI>Next message (by thread): <A HREF="005895.html">[squid-users] Ssl-Bump and revoked server certificates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5894">[ date ]</a>
              <a href="thread.html#5894">[ thread ]</a>
              <a href="subject.html#5894">[ subject ]</a>
              <a href="author.html#5894">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
