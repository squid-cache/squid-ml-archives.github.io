<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Host%20header%20forgery%20detected%20after%20upgrade%20from%0A%093.5.8%20to%203.5.9&In-Reply-To=%3C36E284E8-B0ED-42CB-894D-18FE0EB7A288%40getbusi.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005846.html">
   <LINK REL="Next"  HREF="005903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9</H1>
    <B>Dan Charlesworth</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Host%20header%20forgery%20detected%20after%20upgrade%20from%0A%093.5.8%20to%203.5.9&In-Reply-To=%3C36E284E8-B0ED-42CB-894D-18FE0EB7A288%40getbusi.com%3E"
       TITLE="[squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9">dan at getbusi.com
       </A><BR>
    <I>Thu Oct  8 05:41:08 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005846.html">[squid-users] Host header forgery detected after upgrade from 3.5.8	to 3.5.9
</A></li>
        <LI>Next message (by thread): <A HREF="005903.html">[squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5902">[ date ]</a>
              <a href="thread.html#5902">[ thread ]</a>
              <a href="subject.html#5902">[ subject ]</a>
              <a href="author.html#5902">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Same here&#8212;I've been meaning to ask the list about this too. I&#8217;m still on 3.5.9, by the way.

&gt;<i> On 6 Oct 2015, at 10:55 PM, Roel van Meer &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">roel at 1afa.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi everyone,
</I>&gt;<i> 
</I>&gt;<i> I have a Squid setup on a linux box with transparent interception of both http and https traffic. Everything worked fine with Squid 3.5.6. After upgrading to version 3.5.10, I get many warnings about host header forgery:
</I>&gt;<i> 
</I>&gt;<i> SECURITY ALERT: Host header forgery detected on local=104.46.50.125:443 remote=192.168.9.126:52588 FD 22 flags=33 (local IP does not match any domain IP)
</I>&gt;<i> SECURITY ALERT: By user agent:
</I>&gt;<i> SECURITY ALERT: on URL: nexus.officeapps.live.com:443
</I>&gt;<i> 
</I>&gt;<i> These warnings all seem to occur for https web sites that use multiple DNS records. The warnings coincide with the fact that the clients are unable to get the requested page.
</I>&gt;<i> 
</I>&gt;<i> I've read the wiki page <A HREF="http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>
</I>&gt;<i> and I can assert that:
</I>&gt;<i> - we do NAT on the same box that is running Squid
</I>&gt;<i> - both squid and the clients use the same DNS server
</I>&gt;<i> 
</I>&gt;<i> I've also tested 3.5.9, and this version also showed these warnings.
</I>&gt;<i> Version 3.5.7 worked fine, and 3.5.8 did too.
</I>&gt;<i> 
</I>&gt;<i> So, one of the changes in 3.5.9 caused this behaviour.
</I>&gt;<i> 
</I>&gt;<i> Can anyone shed some more light on this? Is this a problem in my setup that surfaced with 3.5.9, or is it a problem in Squid?
</I>&gt;<i> 
</I>&gt;<i> Thanks a lot for any help,
</I>&gt;<i> 
</I>&gt;<i> Roel
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My (abbreviated) config:
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.9.1:3128 ssl-bump cert=/etc/ssl/certs/server.pem
</I>&gt;<i> http_port 192.168.9.1:3129 intercept
</I>&gt;<i> https_port 192.168.9.1:3130 intercept ssl-bump cert=/etc/ssl/certs/server.pem
</I>&gt;<i> icp_port 0
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> acl port-direct myportname 192.168.9.1:3128
</I>&gt;<i> ssl_bump none port-direct
</I>&gt;<i> acl port-trans_https myportname 192.168.9.1:3130
</I>&gt;<i> external_acl_type sni children-max=3 children-startup=1 %URI %SRC %METHOD %ssl::&gt;sni /usr/bin/squidGuard-aclsni
</I>&gt;<i> acl checksni external sni
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek port-trans_https step1
</I>&gt;<i> ssl_bump terminate port-trans_https step2 checksni
</I>&gt;<i> ssl_bump splice port-trans_https all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005846.html">[squid-users] Host header forgery detected after upgrade from 3.5.8	to 3.5.9
</A></li>
	<LI>Next message (by thread): <A HREF="005903.html">[squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5902">[ date ]</a>
              <a href="thread.html#5902">[ thread ]</a>
              <a href="subject.html#5902">[ subject ]</a>
              <a href="author.html#5902">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
