<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Host%20header%20forgery%20detected%20after%20upgrade%20from%0A%203.5.8%20to%203.5.9&In-Reply-To=%3C56162DCF.9090304%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005902.html">
   <LINK REL="Next"  HREF="005904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Host%20header%20forgery%20detected%20after%20upgrade%20from%0A%203.5.8%20to%203.5.9&In-Reply-To=%3C56162DCF.9090304%40treenet.co.nz%3E"
       TITLE="[squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct  8 08:48:15 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005902.html">[squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9
</A></li>
        <LI>Next message (by thread): <A HREF="005904.html">[squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5903">[ date ]</a>
              <a href="thread.html#5903">[ thread ]</a>
              <a href="subject.html#5903">[ subject ]</a>
              <a href="author.html#5903">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/10/2015 6:41 p.m., Dan Charlesworth wrote:
&gt;<i> Same here&#8212;I've been meaning to ask the list about this too. I&#8217;m still on 3.5.9, by the way.
</I>&gt;<i> 
</I>&gt;&gt;<i> On 6 Oct 2015, at 10:55 PM, Roel van Meer wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi everyone,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a Squid setup on a linux box with transparent interception of both http and https traffic. Everything worked fine with Squid 3.5.6. After upgrading to version 3.5.10, I get many warnings about host header forgery:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SECURITY ALERT: Host header forgery detected on local=104.46.50.125:443 remote=192.168.9.126:52588 FD 22 flags=33 (local IP does not match any domain IP)
</I>&gt;&gt;<i> SECURITY ALERT: By user agent:
</I>&gt;&gt;<i> SECURITY ALERT: on URL: nexus.officeapps.live.com:443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These warnings all seem to occur for https web sites that use multiple DNS records. The warnings coincide with the fact that the clients are unable to get the requested page.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've read the wiki page <A HREF="http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>
</I>&gt;&gt;<i> and I can assert that:
</I>&gt;&gt;<i> - we do NAT on the same box that is running Squid
</I>&gt;&gt;<i> - both squid and the clients use the same DNS server
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've also tested 3.5.9, and this version also showed these warnings.
</I>&gt;&gt;<i> Version 3.5.7 worked fine, and 3.5.8 did too.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, one of the changes in 3.5.9 caused this behaviour.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can anyone shed some more light on this? Is this a problem in my setup that surfaced with 3.5.9, or is it a problem in Squid?
</I>
I suspect this is coming from the CONNECT requests Squid generates now
using the SNI value for the Host: header and authority instead of
raw-IP. That is supported by the absence of user-agent details in the
alert. With just raw-IP the host validation is not able to be done. Now
it is.

If so these new warnings are just exposing cases of SNI abuse. In other
words it is catching the TLS version of CVE-2009-0801.


I see that the Office 365 is hosted by Akamai. Which is one of the CDN
already known to do DNS tricks that lead to Host header problems.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005902.html">[squid-users] Host header forgery detected after upgrade from	3.5.8 to 3.5.9
</A></li>
	<LI>Next message (by thread): <A HREF="005904.html">[squid-users] Host header forgery detected after upgrade from 3.5.8 to 3.5.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5903">[ date ]</a>
              <a href="thread.html#5903">[ thread ]</a>
              <a href="subject.html#5903">[ subject ]</a>
              <a href="author.html#5903">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
