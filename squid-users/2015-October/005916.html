<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.1 ldap authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.1%20ldap%20authentication&In-Reply-To=%3C5618A4A4.9000000%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005901.html">
   <LINK REL="Next"  HREF="005898.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.1 ldap authentication</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.1%20ldap%20authentication&In-Reply-To=%3C5618A4A4.9000000%40treenet.co.nz%3E"
       TITLE="[squid-users] squid 3.1 ldap authentication">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Oct 10 05:39:48 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005901.html">[squid-users] squid 3.1 ldap authentication
</A></li>
        <LI>Next message (by thread): <A HREF="005898.html">[squid-users] 3.5.9 error, typo?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5916">[ date ]</a>
              <a href="thread.html#5916">[ thread ]</a>
              <a href="subject.html#5916">[ subject ]</a>
              <a href="author.html#5916">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/10/2015 8:16 a.m., nando mendonca wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Below is my squid.conf configuration. I can login and browse any site
</I>&gt;<i> entering my ldap username. This is working fine.
</I>&gt;<i> 
</I>&gt;<i> Below i would like to use squid_ldap_group -R to allow certain ldap groups
</I>&gt;<i> to browse only certain sites. Below &quot;admins&quot; and &quot;sales&quot; are two ldap
</I>&gt;<i> groups, can i allow the &quot;admins&quot; group to browse a couple of sites and deny
</I>&gt;<i> all others, and also have the &quot;sales&quot; group browse different sites and deny
</I>&gt;<i> all other ldap groups access?
</I>&gt;<i> 
</I>&gt;<i> When i run 'squid -k parse', i'm not seeing any configuration errors.
</I>
Then your Squid is a bit outdated. Please consider an upgrade.
The current Squid will at least complain about the manager and localhost
ACL definitions being built-in.


&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32 ::1
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> acl localnet src 192.168.30.0/24    # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.20.0/24
</I>&gt;<i> #acl localnet src 172.16.0.0/12 # RFC1918 possible internal network
</I>&gt;<i> #acl localnet src 192.168.0.0/16        # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl Safe_ports port 8080
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> auth_param basic program /usr/lib64/squid/squid_ldap_auth -b
</I>&gt;<i> &quot;dc=test,dc=corp,dc=domain,dc=com&quot; -f &quot;uid=%s&quot; test.corp.domain.com
</I>&gt;<i> auth_param basic children 5
</I>&gt;<i> #auth_param basic realm Web-Proxy
</I>&gt;<i> auth_param basic credentialsttl 30 minutes
</I>&gt;<i> acl ldap-auth proxy_auth REQUIRED
</I>&gt;<i> http_access allow ldap-auth
</I>
The problem you have is that you are allowing access to anyone who is
authenticated. End of story. No other permissions required. The
remainder of your access control config does nothing.

You ned to do this instead:

 http_access deny !ldap-auth


&gt;<i> 
</I>&gt;<i> #http_access deny all
</I>&gt;<i> visible_hostname proxy-server-01
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ## Block access to Google ##
</I>&gt;<i> #external_acl_type ldap_group %LOGIN /usr/lib64/squid/squid_ldap_group -R
</I>&gt;<i> -b &quot;dc=test,dc=corp,dc=domain,dc=com&quot; -D
</I>&gt;<i> &quot;ou=Groups,dc=test,dc=corp,dc=domain,dc=com&quot; -f &quot;(&amp;(objectclass=person)
</I>&gt;<i> (sAMAccountName=%v) (memberof=cn=%a,
</I>&gt;<i> ou=Groups,dc=test,dc=corp,dc=domain,dc=com))&quot; -h test.corp.domain.com
</I>&gt;<i> 
</I>&gt;<i> #acl admin external ldap_group admin
</I>&gt;<i> #acl sales external ldap_group sales
</I>&gt;<i> 
</I>&gt;<i> #acl rule1 url_regex -i &quot;/etc/squid/blacklists/admin/domains&quot;
</I>&gt;<i> #acl rule2 url_regex -i &quot;/etc/squid/blacklists/sales/domains&quot;
</I>&gt;<i> 
</I>&gt;<i> #http_access allow admin rule1
</I>&gt;<i> #http_access allow sales rule2
</I>&gt;<i> #http_access deny all
</I>&gt;<i> 
</I>
One you are using &quot;deny !ldap-auth&quot; for the auth check these group rules
will have a chance of doing something.


However, all of the above http_access lines should be placed below the
line which says &quot;INSERT YOUR OWN RULE(S) HERE&quot;

&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>
Current best practice is to place these manager rules below the &quot;CONNECT
!SSL_Ports&quot; line.


&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>
Notice what the line above says. And how your authentication rules are
all up top well above the default rules that protect your system against
DoS and protocol abuse attacks.


&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>
Once you have authentication going you may want to remove these.


&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> #http_access deny all
</I>&gt;<i> 
</I>
Re-enable that &quot;deny all&quot; rule as the last http_access line.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005901.html">[squid-users] squid 3.1 ldap authentication
</A></li>
	<LI>Next message (by thread): <A HREF="005898.html">[squid-users] 3.5.9 error, typo?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5916">[ date ]</a>
              <a href="thread.html#5916">[ thread ]</a>
              <a href="subject.html#5916">[ subject ]</a>
              <a href="author.html#5916">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
