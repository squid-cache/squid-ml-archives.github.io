<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TPROXY and IPv6 issues CentOS 7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20and%20IPv6%20issues%20CentOS%207&In-Reply-To=%3C561DC9E6.80907%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005945.html">
   <LINK REL="Next"  HREF="006028.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TPROXY and IPv6 issues CentOS 7</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20and%20IPv6%20issues%20CentOS%207&In-Reply-To=%3C561DC9E6.80907%40treenet.co.nz%3E"
       TITLE="[squid-users] TPROXY and IPv6 issues CentOS 7">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 14 03:20:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005945.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
        <LI>Next message (by thread): <A HREF="006028.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5958">[ date ]</a>
              <a href="thread.html#5958">[ thread ]</a>
              <a href="subject.html#5958">[ subject ]</a>
              <a href="author.html#5958">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/10/2015 7:07 a.m., James White wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I operate a squid box which has two http_port setups:
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 TPROXY
</I>&gt;<i> 
</I>&gt;<i> I have implemented TPROXY to replace my NAT setup on a CentOS 7 Squid
</I>&gt;<i> 3.3 box. Currently the IPv4 connectivity is working great, the IPv6
</I>&gt;<i> connectivity is broken when going through TPROXY. All IPv6 connections
</I>&gt;<i> timeout and from tests it appears there is a broken IPv6 setup. Using
</I>&gt;<i> test-ipv6.com I get a broken/misconfiguration warning. IPv6
</I>&gt;<i> connections handled by the standard 3128 setup work OK, direct IPv6
</I>&gt;<i> connections outside of the proxy are also OK, TPROXY IPv6 is not
</I>&gt;<i> working properly.
</I>&gt;<i> 
</I>&gt;<i> I have looked at several TPROXY resources and cannot see where I have
</I>&gt;<i> gone wrong or what might be causing the issue. I am using my DD-WRT
</I>&gt;<i> routing with policy routing to pass the traffic to the Squid box which
</I>&gt;<i> then uses further policy routing to push the traffic to the TPROXY
</I>&gt;<i> binding on port 3129.
</I>&gt;<i> 
</I>&gt;<i> DD-WRT firewall/routing rules:
</I>&gt;<i> 
</I>&gt;<i> PROXY_IPV6=&quot;2001:470:xxxx:xx::x&quot;
</I>&gt;<i> CLIENTIFACE=&quot;br0&quot;
</I>&gt;<i> FWMARK=3
</I>&gt;<i> 
</I>&gt;<i> ip6tables -t mangle -A PREROUTING -i $CLIENTIFACE -s $PROXY_IPV6 -p tcp
</I>&gt;<i> --dport 80 -j ACCEPT
</I>&gt;<i> ip6tables -t mangle -A PREROUTING -i $CLIENTIFACE -p tcp --dport 80 -j
</I>&gt;<i> MARK --set-mark $FWMARK
</I>&gt;<i> ip6tables -t mangle -A PREROUTING -m mark --mark $FWMARK -j ACCEPT
</I>&gt;<i> ip6tables -t filter -A FORWARD -i $CLIENTIFACE -o $CLIENTIFACE -p tcp
</I>&gt;<i> --dport 80 -j ACCEPT
</I>&gt;<i> 
</I>&gt;<i> ip -f inet6 rule add fwmark $FWMARK table 2
</I>&gt;<i> ip -f inet6 route add default via $PROXY_IPV6 dev $CLIENTIFACE table 2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Squid box firewall and routing rules:
</I>&gt;<i> 
</I>&gt;<i> ip -f inet6 rule add fwmark 1 lookup 100
</I>&gt;<i> ip -f inet6 route add local default dev eno1 table 100
</I>&gt;<i> 
</I>&gt;<i> ip6tables -t mangle -F
</I>&gt;<i> ip6tables -t mangle -X
</I>&gt;<i> ip6tables -t mangle -N DIVERT
</I>&gt;<i> 
</I>&gt;<i> ip6tables -t mangle -A DIVERT -j MARK --set-mark 1
</I>&gt;<i> ip6tables -t mangle -A DIVERT -j ACCEPT
</I>&gt;<i> ip6tables -t mangle -A PREROUTING -p tcp -m socket -j DIVERT
</I>&gt;<i> ip6tables -t mangle -A PREROUTING -p tcp -m tcp --dport 80 -j TPROXY
</I>&gt;<i> --tproxy-mark 0x1/0x1 --on-port 3129
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The following sysctl values are set:
</I>&gt;<i> 
</I>&gt;<i> net.ipv4.ip_forward = 1
</I>&gt;<i> net.ipv4.conf.default.rp_filter = 0
</I>&gt;<i> net.ipv4.conf.all.rp_filter = 0
</I>&gt;<i> net.ipv4.conf.eno1.rp_filter = 0
</I>&gt;<i> 
</I>
Double-check the meaning of 0 in those rules. The rp_filter value
meanings changed just prior to 3.x kernels, and no longer do what most
online tutorials say.


&gt;<i> I have defined specific IPv4 and IPv6 addresses for the Squid traffic
</I>&gt;<i> to go over, I had to exclude these with PREROUTING RULES as this broke
</I>&gt;<i> connectivity on LAN clients which use the standard http_port setup of
</I>&gt;<i> 3128. IPv6 connectivity for these clients is OK.
</I>
Pause.

How is traffic to --dport 3128 matching &quot;-p tcp -m tcp --dport 80&quot; ?

It seems to me that would be part of yoru problem. Unless you mean that
these rules had to go on the router. In which case, yes you do need to
prevent Squid outbound traffic being looped back to it a second time.

&gt;<i> 
</I>&gt;<i> iptables -t mangle -I PREROUTING -p tcp --dport 80 -s 192.168.x.x -j
</I>&gt;<i> ACCEPT
</I>&gt;<i> ip6tables -t mangle -I PREROUTING -p tcp --dport 80 -s
</I>&gt;<i> 2001:470:xxxx:xx::x -j ACCEPT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I don't know if I need additional values for any ipv6 config value.
</I>&gt;<i> Nothing is mentioned in the TPROXY Squid wiki article.
</I>
Given the likelihood of so called &quot;privacy addressing&quot; in IPv6 you may
need to make the v6 bypasses use /64 subnets instead of single IP's

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any ideas on what I could be missing?
</I>&gt;<i> 
</I>
When debugging make sure &quot;via on&quot; directive exists in squid.conf. That
will highlight looping errors that you may have from misconfiguration
TPROXY.


Also, make sure that ICMP and path-MTU etc are working. Particularly
from the Squid machine to the Internet.

If you haven't already been through the list and double/triple-checked,
the troubleshooting section of
&lt;<A HREF="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</A>&gt; may have the answer.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005945.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
	<LI>Next message (by thread): <A HREF="006028.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5958">[ date ]</a>
              <a href="thread.html#5958">[ thread ]</a>
              <a href="subject.html#5958">[ subject ]</a>
              <a href="author.html#5958">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
