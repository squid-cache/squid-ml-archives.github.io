<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Safari 9 vs. SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Safari%209%20vs.%20SSL%20Bump&In-Reply-To=%3C56203F88.5000905%40trimble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005977.html">
   <LINK REL="Next"  HREF="005990.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Safari 9 vs. SSL Bump</H1>
    <B>Jason Haar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Safari%209%20vs.%20SSL%20Bump&In-Reply-To=%3C56203F88.5000905%40trimble.com%3E"
       TITLE="[squid-users] Safari 9 vs. SSL Bump">Jason_Haar at trimble.com
       </A><BR>
    <I>Fri Oct 16 00:06:32 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005977.html">[squid-users] Safari 9 vs. SSL Bump
</A></li>
        <LI>Next message (by thread): <A HREF="005990.html">[squid-users] Safari 9 vs. SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5989">[ date ]</a>
              <a href="thread.html#5989">[ thread ]</a>
              <a href="subject.html#5989">[ subject ]</a>
              <a href="author.html#5989">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just a data point, but I've just got up Safari on Yosemite connecting
through squid-3.5.10 to <A HREF="https://wikipedia.org/">https://wikipedia.org/</A> with full bump-ing with
no problems.

Same with twitter.com and github.com. Click on the padlock shows the
server cert chaining to my squidCA cert (which is trusted of course)

ie this can't have anything to do with Elliptic Curves or pinning

Jason

 On 15/10/15 12:19, Alex Rousskov wrote:
&gt;<i> On 10/14/2015 05:00 PM, Dan Charlesworth wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I feel like if server-first is working there must be *some*
</I>&gt;&gt;<i> combination of peek/stare/bump that&#8217;ll work too&#8212;it can&#8217;t be that
</I>&gt;&gt;<i> &#8220;forward secrecy&#8221; cipher stuff.
</I>&gt;<i>
</I>&gt;<i> While that feeling is natural, you should resist it. Newer SslBump
</I>&gt;<i> actions do not simply dissect the old ones into smaller steps. The old
</I>&gt;<i> actions (e.g., server-first) do not do some of the things that the new
</I>&gt;<i> actions do (e.g., peek extracts and sends SNI but server-first does
</I>&gt;<i> not). Doing more sometimes leads to more problems, especially in
</I>&gt;<i> experiment-driven features such as SslBump. Besides different cipher
</I>&gt;<i> negotiation patterns, you may be hitting a bug that server-first code
</I>&gt;<i> path lacks, for example.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I really don&#8217;t want our customers to have to use server-first if they
</I>&gt;&gt;<i> decide to employ bumping, so if any of you smart people have any
</I>&gt;&gt;<i> other suggestions, please send them through.
</I>&gt;<i>
</I>&gt;<i> I second Amos' implied suggestion to try the latest Squid 4.0 as the
</I>&gt;<i> next step. This does not mean you have to _deploy_ Squid 4.0:
</I>&gt;<i>
</I>&gt;<i> * If Squid 4.0 does not work in your tests, we will not need to suspect
</I>&gt;<i> newer ciphers and may get more information from newer logs. We will also
</I>&gt;<i> be slightly more motivated to fix or improve something.
</I>&gt;<i>
</I>&gt;<i> * If Squid 4.0 works, we will know more about your problem and may
</I>&gt;<i> suggest some other solutions if you have to run an older Squid.
</I>&gt;<i>
</I>&gt;<i> In either case, do collect &quot;debug_options ALL,9&quot; cache logs for an
</I>&gt;<i> isolated test case.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Please note that I am not volunteering to examine your logs, and there
</I>&gt;<i> is no guarantee that this next step will lead to a solution, but it is
</I>&gt;<i> relatively easy to make that step.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> On 15 Oct 2015, at 1:34 AM, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 10/13/2015 09:08 PM, Dan Charlesworth wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> But in reality ssl_bump peek step1 &amp; ssl_bump bump step3 is actually
</I>&gt;&gt;&gt;&gt;<i> splicing everything, it seems.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This may not be related to your specific problem, but I want to clarify
</I>&gt;&gt;&gt;<i> the above.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  ssl_bump peek step1
</I>&gt;&gt;&gt;<i>  ssl_bump bump step3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> A recent Squid mis-configured using the above sketch should indeed
</I>&gt;&gt;&gt;<i> splice everything. When Squid reaches bumping step2, no ssl_bump rule
</I>&gt;&gt;&gt;<i> matches, so Squid uses the previous step rule to decide what to do.
</I>&gt;&gt;&gt;<i> Since peeking implies splicing, Squid splices at step2 and never gets to
</I>&gt;&gt;&gt;<i> step3.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It is possible that, in his &quot;bump at step3&quot; recommendation below, Amos
</I>&gt;&gt;&gt;<i> was talking about this kind of configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  ssl_bump stare all
</I>&gt;&gt;&gt;<i>  ssl_bump bump all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Bugs notwithstanding, the above results in bumping at step3.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 14 Oct 2015, at 1:51 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 14/10/2015 1:13 p.m., Dan Charlesworth wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Throwing this out to the list in case anyone else might be trying to get SSL Bump to work with the latest version of Safari.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Every other browser on OS X (and iOS) is happy with bumping for pretty much all HTTPS sites, so long as the proxy&#8217;s CA is trusted. 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> However Safari throws generic &#8220;secure connection couldn&#8217;t be established&#8221; errors for many popular HTTPS sites in including:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> - wikipedia.org
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> - mail.google.com
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> - twitter.com
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> - github.com
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> But quite a number of others work, such as youtube.com.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> This error gets logged to the system whenever it occurs:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> com.apple.WebKit.Networking: NSURLSession/NSURLConnection HTTP load failed (kCFStreamErrorDomainSSL, -9802)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Apparently this is related to Apple&#8217;s new &#8220;App Transport Security&#8221; protections, in particular, the fact that &#8220;the server doesn&#8217;t support forward secrecy&#8221;. Even though it doesn&#8217;t seem to be affecting mobile Safari on iOS 9 at all.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> It&#8217;s also notable that Safari seems perfectly happy with legacy server-first SSL bumping. 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I&#8217;m using Squid 3.5.10 and this is my current config: <A HREF="https://gist.github.com/djch/9b883580c6ee84f31cd1">https://gist.github.com/djch/9b883580c6ee84f31cd1</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Anyone have any idea what I can try?
</I>&gt;&gt;&gt;&gt;&gt;<i> You can try bump at step3 (roughly equivalent to server-first) instead
</I>&gt;&gt;&gt;&gt;&gt;<i> of step2 (aka client-first).
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

-- 
Cheers

Jason Haar
Corporate Information Security Manager, Trimble Navigation Ltd.
Phone: +1 408 481 8171
PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005977.html">[squid-users] Safari 9 vs. SSL Bump
</A></li>
	<LI>Next message (by thread): <A HREF="005990.html">[squid-users] Safari 9 vs. SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5989">[ date ]</a>
              <a href="thread.html#5989">[ thread ]</a>
              <a href="subject.html#5989">[ subject ]</a>
              <a href="author.html#5989">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
