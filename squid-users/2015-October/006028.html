<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TPROXY and IPv6 issues CentOS 7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20and%20IPv6%20issues%20CentOS%207&In-Reply-To=%3C562215B1.7040105%40jmwhite.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005958.html">
   <LINK REL="Next"  HREF="006172.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TPROXY and IPv6 issues CentOS 7</H1>
    <B>James White</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20and%20IPv6%20issues%20CentOS%207&In-Reply-To=%3C562215B1.7040105%40jmwhite.co.uk%3E"
       TITLE="[squid-users] TPROXY and IPv6 issues CentOS 7">james at jmwhite.co.uk
       </A><BR>
    <I>Sat Oct 17 09:32:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005958.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
        <LI>Next message (by thread): <A HREF="006172.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6028">[ date ]</a>
              <a href="thread.html#6028">[ thread ]</a>
              <a href="subject.html#6028">[ subject ]</a>
              <a href="author.html#6028">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi Amos,

Thanks for your reply.

I've tried setting the rp_filter values to 1 and 2 and there is no
difference in behaviour.

Traffic isn't being tagged on dport 3128 directly. What I meant was I
needed to exclude the configured outgoing IPv6 address at the DD-WRT
router level with a PREROUTING rule, otherwise there was a loop and
traffic would be messed up.

Enabling the via header temporarily, I checked to see what was being
passed. According to my tests, the IPv6 address of my proxy was the
value, so the traffic is making it to the Squid box, but no IPv6
requests are logged in the access.log from any TPROXY clients and all
IPv6 requests from TPROXY clients are timing out e.g. ipv6.google.com

I'm pretty confident the problem lies on my Squid server at this
point, I can't see any issues with the policy routing on my DD-WRT route
r.

MTU is configured correctly and the Squid box can ping and traceroute
IPv6 addresses.

I'm really at a loss of what the issue is. I've read the TPROXY wiki
article many times and there is nothing obvious to me that identifies
my issue. I've looked for other resources for TPROXY and IPv6 and
can't find anything else either.

Thanks,

James

On 14/10/2015 04:20, Amos Jeffries wrote:
&gt;<i> On 14/10/2015 7:07 a.m., James White wrote:
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I operate a squid box which has two http_port setups:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 3128 http_port 3129 TPROXY
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I have implemented TPROXY to replace my NAT setup on a CentOS 7 
</I>&gt;&gt;<i> Squid 3.3 box. Currently the IPv4 connectivity is working great, 
</I>&gt;&gt;<i> the IPv6 connectivity is broken when going through TPROXY. All 
</I>&gt;&gt;<i> IPv6 connections timeout and from tests it appears there is a 
</I>&gt;&gt;<i> broken IPv6 setup. Using test-ipv6.com I get a 
</I>&gt;&gt;<i> broken/misconfiguration warning. IPv6 connections handled by the 
</I>&gt;&gt;<i> standard 3128 setup work OK, direct IPv6 connections outside of 
</I>&gt;&gt;<i> the proxy are also OK, TPROXY IPv6 is not working properly.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I have looked at several TPROXY resources and cannot see where I 
</I>&gt;&gt;<i> have gone wrong or what might be causing the issue. I am using
</I>&gt;&gt;<i> my DD-WRT routing with policy routing to pass the traffic to the 
</I>&gt;&gt;<i> Squid box which then uses further policy routing to push the 
</I>&gt;&gt;<i> traffic to the TPROXY binding on port 3129.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> DD-WRT firewall/routing rules:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> PROXY_IPV6=&quot;2001:470:xxxx:xx::x&quot; CLIENTIFACE=&quot;br0&quot; FWMARK=3
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ip6tables -t mangle -A PREROUTING -i $CLIENTIFACE -s $PROXY_IPV6 
</I>&gt;&gt;<i> -p tcp --dport 80 -j ACCEPT ip6tables -t mangle -A PREROUTING -i 
</I>&gt;&gt;<i> $CLIENTIFACE -p tcp --dport 80 -j MARK --set-mark $FWMARK 
</I>&gt;&gt;<i> ip6tables -t mangle -A PREROUTING -m mark --mark $FWMARK -j 
</I>&gt;&gt;<i> ACCEPT ip6tables -t filter -A FORWARD -i $CLIENTIFACE -o 
</I>&gt;&gt;<i> $CLIENTIFACE -p tcp --dport 80 -j ACCEPT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ip -f inet6 rule add fwmark $FWMARK table 2 ip -f inet6 route
</I>&gt;&gt;<i> add default via $PROXY_IPV6 dev $CLIENTIFACE table 2
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Squid box firewall and routing rules:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ip -f inet6 rule add fwmark 1 lookup 100 ip -f inet6 route add 
</I>&gt;&gt;<i> local default dev eno1 table 100
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ip6tables -t mangle -F ip6tables -t mangle -X ip6tables -t
</I>&gt;&gt;<i> mangle -N DIVERT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ip6tables -t mangle -A DIVERT -j MARK --set-mark 1 ip6tables -t 
</I>&gt;&gt;<i> mangle -A DIVERT -j ACCEPT ip6tables -t mangle -A PREROUTING -p 
</I>&gt;&gt;<i> tcp -m socket -j DIVERT ip6tables -t mangle -A PREROUTING -p tcp 
</I>&gt;&gt;<i> -m tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The following sysctl values are set:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> net.ipv4.ip_forward = 1 net.ipv4.conf.default.rp_filter = 0 
</I>&gt;&gt;<i> net.ipv4.conf.all.rp_filter = 0 net.ipv4.conf.eno1.rp_filter = 0
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Double-check the meaning of 0 in those rules. The rp_filter value 
</I>&gt;<i> meanings changed just prior to 3.x kernels, and no longer do what 
</I>&gt;<i> most online tutorials say.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I have defined specific IPv4 and IPv6 addresses for the Squid 
</I>&gt;&gt;<i> traffic to go over, I had to exclude these with PREROUTING RULES 
</I>&gt;&gt;<i> as this broke connectivity on LAN clients which use the standard 
</I>&gt;&gt;<i> http_port setup of 3128. IPv6 connectivity for these clients is 
</I>&gt;&gt;<i> OK.
</I>&gt;<i> 
</I>&gt;<i> Pause.
</I>&gt;<i> 
</I>&gt;<i> How is traffic to --dport 3128 matching &quot;-p tcp -m tcp --dport 80&quot; 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> It seems to me that would be part of yoru problem. Unless you mean 
</I>&gt;<i> that these rules had to go on the router. In which case, yes you
</I>&gt;<i> do need to prevent Squid outbound traffic being looped back to it
</I>&gt;<i> a second time.
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> iptables -t mangle -I PREROUTING -p tcp --dport 80 -s
</I>&gt;&gt;<i> 192.168.x.x -j ACCEPT ip6tables -t mangle -I PREROUTING -p tcp
</I>&gt;&gt;<i> --dport 80 -s 2001:470:xxxx:xx::x -j ACCEPT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I don't know if I need additional values for any ipv6 config 
</I>&gt;&gt;<i> value. Nothing is mentioned in the TPROXY Squid wiki article.
</I>&gt;<i> 
</I>&gt;<i> Given the likelihood of so called &quot;privacy addressing&quot; in IPv6 you 
</I>&gt;<i> may need to make the v6 bypasses use /64 subnets instead of single 
</I>&gt;<i> IP's
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Any ideas on what I could be missing?
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When debugging make sure &quot;via on&quot; directive exists in squid.conf. 
</I>&gt;<i> That will highlight looping errors that you may have from 
</I>&gt;<i> misconfiguration TPROXY.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Also, make sure that ICMP and path-MTU etc are working. 
</I>&gt;<i> Particularly from the Squid machine to the Internet.
</I>&gt;<i> 
</I>&gt;<i> If you haven't already been through the list and 
</I>&gt;<i> double/triple-checked, the troubleshooting section of 
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</A>&gt; may have the 
</I>&gt;<i> answer.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________ squid-users
</I>&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.13 (MingW32)

iQIcBAEBAgAGBQJWIhWxAAoJELyyWoQM+xyOZ+kP/2M6iCiUywtljXpk/kma5sZv
50oWIMtTXwGbRoT3SN356DZU0sjwRcMJOWyGXP5Vk0UwQ2oPkv0fC3cbBiO9PmFB
KfNJtOsEuAyshmnEusvENXONIG46kfH2Mj39CjxAgT6zkyOho+PfleDJYqOPvN4d
mbgCq/dcBvi7rteFBancuSj6u/wtwBL0mB2Y7Bju/+s77Dbe1FzWLdrh8UXxspId
rooTHIMytaGQ01D9kanpQO3W1MhQdbF6GL2+Op+pajmxLR+SmnpHwRWgRfrhyvFx
LZeAHiGcvwj/jwskXGhwDU/ApztB5gAlelnSxBliAZZ9/U2EkHhlv1F53G4/sx3E
VR8n+dugKiPKd7BPmWrl+RLTKdvAb6VyRkm5PjnTbdHyYIYsmLQZ9QYEI7g8yDRl
30ApqXiF0qCpmc5kO5LH063lafmeablKXO5Dsl4MBjqT2kz29Z3J237uWZRZ+dWa
vY+O/fUzgYs+GD91fHm3ZqzAcKGh8NCsvZvScDqCumJelJaw8jRDTY/6ca/5GmTQ
NckeTyURLPBl8kzLaIA37CnR4Kg50YJEpXyhaTuR6mLIJJ8Q+TIM3e70A5/ZzWK4
4ZiCX+Q5TNRr+m6PPhP6q95TT7KA/C3a6pg8lZ8jUKh0zAi+PhF0O78Ru5RxT8/y
epebG79N1xP7ZbXzr7ff
=e1Mw
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005958.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
	<LI>Next message (by thread): <A HREF="006172.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6028">[ date ]</a>
              <a href="thread.html#6028">[ thread ]</a>
              <a href="subject.html#6028">[ subject ]</a>
              <a href="author.html#6028">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
