<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] NTLM Authentication Failing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20NTLM%20Authentication%20Failing&In-Reply-To=%3C5625CBC9.5070406%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006054.html">
   <LINK REL="Next"  HREF="006079.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] NTLM Authentication Failing</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20NTLM%20Authentication%20Failing&In-Reply-To=%3C5625CBC9.5070406%40treenet.co.nz%3E"
       TITLE="[squid-users] NTLM Authentication Failing">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct 20 05:06:17 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006054.html">[squid-users] NTLM Authentication Failing
</A></li>
        <LI>Next message (by thread): <A HREF="006079.html">[squid-users] NTLM Authentication Failing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6056">[ date ]</a>
              <a href="thread.html#6056">[ thread ]</a>
              <a href="subject.html#6056">[ subject ]</a>
              <a href="author.html#6056">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/10/2015 4:04 p.m., Ilias Clifton wrote:
&gt;<i> Hi All,
</I>&gt;<i> I've been following the guide at this location for Active Directory integration
</I>&gt;<i> <A HREF="http://wiki.bitbinary.com/index.php/Active_Directory_Integrated_Squid_Proxy">http://wiki.bitbinary.com/index.php/Active_Directory_Integrated_Squid_Proxy</A>
</I>&gt;<i> 
</I>&gt;<i> First, some versions for sanity..
</I>&gt;<i> Ubuntu : 14.04.3 LTS
</I>&gt;<i> Squid  : 3.3.8 (from ubuntu repositories)
</I>&gt;<i> Samba  : 4.1.6-Ubuntu
</I>&gt;<i> DC     : Windows Server 2012 R2
</I>&gt;<i> 
</I>&gt;<i> I am currently testing the authentication, negotiate kerberos and basic ldap are 
</I>&gt;<i> both working correctly. However ntlm is not and I don't seem to making any 
</I>&gt;<i> progress on debugging further.
</I>

There are several problems involved here.

1) NTLM is a proprietary protocol deprecated by its corporate creator in
2006 and officially has not been part of any MS products created after
that year.

With some trouble it can be enabled. But now, 9 years later, it is off
by default almost everywhere, or literally not existing in the new
products code.


2) NTLM has *never* worked properly over HTTP, particularly in the
presence of proxies.

Most of HTTP performance and optimization features have to be actively
disabled the instant NTLM auth is identified as happening.


3) off-domain clients have *never* been able to authenticate with NTLM
protocol.

Previously Squid helpers were performing a MITM downgrade attack on the
client software to cause it to use LanManager auth over &quot;NTLM&quot; tokens
then decrypting the user:pass credentials in real time and using the
Basic auth login to AD to authenticate. (sounds nasty? it is). LanMan
protocols are even more deprecated (since 1996) and non-existent in
modern MS software than NTLM.

 - NTLMv1 can still be MITM'd but takes longer. I think the older Samba
helpers maybe do that. But no guarantees.
 - NTLMv2 and v2 with security extensions are not able to be MITM'd.

So they wont work through Squid unless the client is &quot;on-domain&quot;.


4) support for NTLM sub-protocol inside the &quot;Negotiate&quot; auth scheme is a
relatively new feature and still not working quite right.

Partially because of the above problems and deprecated nature of NTLM
meaning it is a low priority to fix. Partially because NTLM is also not
matching the behaviour requirements of Negotiate protocol itself.


5) The cache_effective_user or cache_effective_group directives are not
compatible with WinBind helpers.

see
&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm?highlight=%28winbindd_priv%29#SMBD_and_Machine_Trust_Accounts">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm?highlight=%28winbindd_priv%29#SMBD_and_Machine_Trust_Accounts</A>&gt;
for details on what to do there.


6) if you self-compiled Samba or Winbind tools on Ubuntu systems there
may also be a /var/lib/samba/winbindd_privileged directory created by
the winbind and ntlm_auth tools with root ownership. The group of that
folder needs to be changed to match the
/var/run/samba/winbindd_privileged location.


Your version of Squid has big problems with (4) and some with (2), and
your DC server version has big problems with (1) and (3).


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006054.html">[squid-users] NTLM Authentication Failing
</A></li>
	<LI>Next message (by thread): <A HREF="006079.html">[squid-users] NTLM Authentication Failing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6056">[ date ]</a>
              <a href="thread.html#6056">[ thread ]</a>
              <a href="subject.html#6056">[ subject ]</a>
              <a href="author.html#6056">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
