<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.10 SSL Bump whitelist domains issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.10%20SSL%20Bump%20whitelist%20domains%20issue&In-Reply-To=%3C56289E33.8080003%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006094.html">
   <LINK REL="Next"  HREF="006092.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.10 SSL Bump whitelist domains issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.10%20SSL%20Bump%20whitelist%20domains%20issue&In-Reply-To=%3C56289E33.8080003%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.10 SSL Bump whitelist domains issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct 22 08:28:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006094.html">[squid-users] Squid 3.5.10 SSL Bump whitelist domains issue
</A></li>
        <LI>Next message (by thread): <A HREF="006092.html">[squid-users] Remote Desktop Gateway thru Squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6119">[ date ]</a>
              <a href="thread.html#6119">[ thread ]</a>
              <a href="subject.html#6119">[ subject ]</a>
              <a href="author.html#6119">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/10/2015 7:31 a.m., luizcasey wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hello, So what I am trying to accomplish here is to basically have a
</I>&gt;<i> whitelist of domains that is allowed via http/https.
</I>
What you have actually configured is a whitelist with MUCH narrower
criteria than that.


&gt;<i> If the UID is
</I>&gt;<i> squid,apache, or root then basically you will bypass squid and anything
</I>&gt;<i> is allowed.
</I>
Ok. That is iptables/ip6tables. Not Squid related.

&gt;<i> This was working well on 3.4.2 however once I moved to
</I>&gt;<i> 3.5.10 it no longer works properly. I also noticed that there are &#8220;new&#8221;
</I>&gt;<i> features peek,slice etc which is probably my issue since I was not using
</I>&gt;<i> it. I have tried several combination and have only gotten it to work for
</I>&gt;<i> http traffic. All https traffic is currently being blocked by the
</I>&gt;<i> configuration. Below are my configurations. I don&#8217;t need to &quot;inspect&quot;
</I>&gt;<i> any of the traffic just want to have a whitelist of allowed domains if
</I>&gt;<i> you are not UID squid,apache, or root via http/https. Any help would be
</I>&gt;<i> appreciated !!
</I>
I'm not sure how you define &quot;inspect&quot; exactly. But the config implies
that your Squid actually does need to do TLS inspection.


&gt;<i> ##### IPTABLES
</I>&gt;<i> $iptables -L -t nat
</I>&gt;<i> Chain PREROUTING (policy ACCEPT)
</I>&gt;<i> target     prot opt source               destination
</I>&gt;<i> 
</I>&gt;<i> Chain POSTROUTING (policy ACCEPT)
</I>&gt;<i> target     prot opt source               destination
</I>&gt;<i> 
</I>&gt;<i> Chain OUTPUT (policy ACCEPT)
</I>&gt;<i> target     prot opt source               destination
</I>&gt;<i> natoutlogaccept  tcp  --  anywhere             anywhere            multiport dports http,https owner UID match squid
</I>&gt;<i> natoutlogaccept  tcp  --  anywhere             anywhere            multiport dports http,https owner UID match apache
</I>&gt;<i> natoutlogaccept  tcp  --  anywhere             anywhere            multiport dports http,https owner UID match root
</I>&gt;<i> REDIRECT   tcp  --  anywhere             anywhere            tcp dpt:http redir ports 3401
</I>
Note that 3401 is the SNMP protocol port.

&gt;<i> REDIRECT   tcp  --  anywhere             anywhere            tcp dpt:https redir ports 4827
</I>&gt;<i> 
</I>&gt;<i> Chain natoutlogaccept (3 references)
</I>&gt;<i> target     prot opt source               destination
</I>&gt;<i> LOG        all  --  anywhere             anywhere            LOG level debug prefix `nat out iptables accept '
</I>&gt;<i> ACCEPT     all  --  anywhere             anywhere
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ##### Squid.conf
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Like Yuri said the above line(s) are bad. Very bad.
They are instructing Squid not to verify the TLS to upstream servers are
secure. That allows any MITM upstream to be done on them without any
type of warning or alerts. Not only that but Squid will relay valid TLS
security to the clients, so they believe everything is just fine when in
fact they could be badly hijacked.


&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /home/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 50
</I>&gt;<i> 
</I>&gt;<i> https_port 4827 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/certs/squid.aarp.org.crt key=/etc/squid/certs/squid.key
</I>&gt;<i> # HTTPS forward port
</I>&gt;<i> https_port 127.0.0.1:6887 cert=/etc/squid/certs/squid.crt key=/etc/squid/certs/squid.key
</I>&gt;<i> 
</I>&gt;<i> http_port 3401 transparent
</I>&gt;<i> # HTTP forward port
</I>&gt;<i> http_port 127.0.0.1:6886
</I>&gt;<i> 
</I>&gt;<i> logformat squid %tl.%03tu %6tr %&gt;a %Ss/%03Hs %&lt;st %rm %ru %[un %Sh/%&lt;a %mt
</I>&gt;<i> access_log /var/log/squid/access.log squid
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
The always_direct hack from Squid-3.1 bumping is no longer useful.

&gt;<i> cache deny all
</I>&gt;<i> cache_dir ufs /home/squid/cache 100 16 256
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> acl nobumpSites ssl::server_name &quot;/etc/squid/allowed_domains/allowed_domains&quot;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice nobumpSites
</I>&gt;<i> ssl_bump bump
</I>&gt;<i> 
</I>&gt;<i> acl http proto http
</I>&gt;<i> acl https proto https
</I>&gt;<i> 
</I>&gt;<i> acl port_80 port 80
</I>&gt;<i> acl port_443 port 443
</I>&gt;<i> 
</I>&gt;<i> http_access allow http port_80 nobumpSites
</I>&gt;<i> http_access allow https port_443 nobumpSites
</I>
I think the problem here is that you are requiring the &quot;<A HREF="http://">http://</A>&quot; and
&quot;<A HREF="https://">https://</A>&quot; scheme be part of the URLs.

Your description of the whitelist did not mention any such criteria.

Squid-3.5 uses CONNECT requests (where the URL has *no* scheme segment)
to represent the initial TCP SYN connection happening before the HTTPS
stream starts. Your whitelist rules here will reject those because they
lack the <A HREF="https://">https://</A> scheme portion. And thus reject all HTTPS traffic.


&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> ##### allowed_domains
</I>&gt;<i> .cnn.com &lt;<A HREF="http://cnn.com/">http://cnn.com/</A>&gt;
</I>&gt;<i> .google.com &lt;<A HREF="http://google.com/">http://google.com/</A>&gt;
</I>&gt;<i> .facebook.com &lt;<A HREF="http://facebook.com/">http://facebook.com/</A>&gt;
</I>&gt;<i> &#8230;.etc 
</I>&gt;<i> 
</I>&gt;<i> #### squid log
</I>&gt;<i> TAG_NONE/403 350 HEAD <A HREF="https://www.facebook.com/">https://www.facebook.com/</A> &lt;<A HREF="https://www.facebook.com/">https://www.facebook.com/</A>&gt; - HIER_NONE/- text/html
</I>&gt;<i> TCP_MISS/200 593 GET <A HREF="http://www.cnn.com/">http://www.cnn.com/</A> &lt;<A HREF="http://www.cnn.com/">http://www.cnn.com/</A>&gt;
</I>
I'm not sure why you are displaying these log lines. Everything appears
to be fine for them.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006094.html">[squid-users] Squid 3.5.10 SSL Bump whitelist domains issue
</A></li>
	<LI>Next message (by thread): <A HREF="006092.html">[squid-users] Remote Desktop Gateway thru Squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6119">[ date ]</a>
              <a href="thread.html#6119">[ thread ]</a>
              <a href="subject.html#6119">[ subject ]</a>
              <a href="author.html#6119">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
