<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.10 SSL Bump whitelist domains
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.10%20SSL%20Bump%20whitelist%20domains&In-Reply-To=%3C5628F920.6090702%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006146.html">
   <LINK REL="Next"  HREF="006127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.10 SSL Bump whitelist domains</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.10%20SSL%20Bump%20whitelist%20domains&In-Reply-To=%3C5628F920.6090702%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.10 SSL Bump whitelist domains">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct 22 14:56:32 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006146.html">[squid-users] Squid 3.5.10 SSL Bump whitelist domains
</A></li>
        <LI>Next message (by thread): <A HREF="006127.html">[squid-users] nonce_garbage_interval problem?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6148">[ date ]</a>
              <a href="thread.html#6148">[ thread ]</a>
              <a href="subject.html#6148">[ subject ]</a>
              <a href="author.html#6148">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/10/2015 3:01 a.m., <A HREF="https://lists.squid-cache.org/listinfo/squid-users">luizcasey at gmail.com</A> wrote:
&gt;<i> Here is the config I am currently using based on your suggestion earlier. However it does not start. I have also added some questions to each for verification purposes to make sure I am understanding what is actually going on.
</I>&gt;<i> 
</I>&gt;<i> https_port 4827 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/certs/squid.crt key=/etc/squid/certs/squid.key
</I>&gt;<i> http_port 3401 intercept
</I>&gt;<i> 
</I>&gt;<i> logformat squid %tl.%03tu %6tr %&gt;a %Ss/%03Hs %&lt;st %rm %ru %[un %Sh/%&lt;a %mt
</I>&gt;<i> access_log /var/log/squid/access.log squid
</I>&gt;<i> 
</I>&gt;<i> cache deny all &lt; &#8212; No caching.
</I>
Prevent things being stored in Squid's cache is what that does, yes.

&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1 &lt;&#8212; What is this doing ??
</I>
Creating an ACL which will only match during SSL-Bump operations at step 1.

&gt;<i> acl whitelist_ssl ssl::server_name &quot;/etc/squid/git_allowed_domains/allowed_domains&#8221; &lt;&#8212; Create whitelist for SSL 
</I>
Sort of yes, sort of no.

This is creating an ACL which will match if some domain name(s) are used
in CONNECT authority-URI (at SSL-Bump step 1 or 2), TLS SNI values (at
SSL-Bump step 2), or X.509 certificate SubjectAltName field (at SSL-Bump
step 3).


&gt;<i> 
</I>&gt;<i> ssl_bump peek step1   &lt;&#8212; Try to find server_name ?
</I>
Try to find client handshake details. One of those is the SNI which is
often the best available datum on what domain the client is trying to
connect to.

This will always match at step 1. So peek is aways done to find SNI,
NPN, ALPN etc.


&gt;<i> ssl_bump splice whitelist_ssl &lt;&#8212; Ignore whitlist_ssl domains and let it through
</I>
At step 2 attempt to match the whitelist ACL against the details we have
for server domain names. SNI if known, otherwise the CONNECT requests
authority-URI.

At step 3 (because this is checked at both step 2 and 3). Attempt to
match the whitelist ACL against the X.509 certificate SubjectAltName
details.


&gt;<i> ssl_bump bump net_bump &lt;&#8212; ??? This I don&#8217;t get since there is no net_bump acl ? Should this just be all ?
</I>&gt;<i> ssl_bump splice all &lt;&#8212; Splice everything else that couldn&#8217;t be bumped ??
</I>&gt;<i> 
</I>
What is supposed to happen if the whitelist does not match ?
Take your policy requirement and make Squid do it.



&gt;<i> acl http proto http  &lt;&#8212; Allow http photo
</I>
No. Create an ACL which matches when URL scheme is &quot;<A HREF="http://">http://</A>&quot;


&gt;<i> acl whitelist dstdomain &quot;/etc/squid/git_allowed_domains/allowed_domains&#8221; &lt;&#8212; Create whitelist for http
</I>
Yes.


&gt;<i> 
</I>&gt;<i> acl https proto https  &lt;&#8212; Allow https 
</I>
No. Create an ACL which matches when URL scheme is &quot;<A HREF="https://">https://</A>&quot;


&gt;<i> acl port_80 port 80  &lt;&#8212; Allow port 80. Is this redundant ??
</I>
No. Create an ACL which matches when URL port is 80.


&gt;<i> acl port_443 port 443 &lt; &#8212; Allow port 443. Is this redundant ??
</I>
No. Create an ACL which matches when URL port is 443.


&gt;<i> 
</I>&gt;<i> http_access allow http port_80 whitelist    &lt;&#8212; Allow whitelisted domains on port 80 
</I>
No. Allows requests where there is a URL scheme <A HREF="http://">http://</A> AND going to
port 80 AND on the whitelist.

&gt;<i> http_access allow https port_443 whitelist_ssl &lt;&#8212; Allow whitelisted domains on 443
</I>&gt;<i> 
</I>
No. Allows requests where there is a URL scheme <A HREF="https://">https://</A> AND going to
port 443 AND on the whitelist.

NP: HTTPS requests arrive as CONNECT mesage to URL with no scheme, and
going to port 443. May be a hostname not on the whitelist. For
intercepted traffic this request message will always have a raw-IP
instead of a hostname or domain name.


&gt;<i> http_access deny al &lt;&#8212; Deny all 
</I>
No. deny whatever &quot;al&quot; matches.

Then the default action of allowing everything else.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #######LOGS
</I>&gt;<i> 
</I>&gt;<i> 2015/10/22 09:41:10| Processing: access_log /var/log/squid/access.log squid
</I>&gt;<i> 2015/10/22 09:41:10| Processing: cache deny all
</I>&gt;<i> 2015/10/22 09:41:10| Processing: acl step1 at_step SslBump1
</I>&gt;<i> 2015/10/22 09:41:10| Processing: acl whitelist_ssl ssl::server_name &quot;/etc/squid/git_allowed_domains/allowed_domains&quot;
</I>&gt;<i> 2015/10/22 09:41:10| Processing: ssl_bump peek step1
</I>&gt;<i> 2015/10/22 09:41:10| Processing: ssl_bump splice whitelist_ssl
</I>&gt;<i> 2015/10/22 09:41:10| Processing: ssl_bump bump net_bump     &lt;&#8212;&#8212;&#8212; I assume again this is because no all for net_bump.
</I>
Don't assume. Squid tells you what is wrong:

&gt;<i> 2015/10/22 09:41:10| ACL not found: net_bump
</I>&gt;<i> FATAL: Bungled /etc/squid/squid.conf line 22: ssl_bump bump net_bump
</I>
... and what is being done about it:

&gt;<i> Squid Cache (Version 3.5.10): Terminated abnormally.
</I>&gt;<i> CPU Usage: 0.012 seconds = 0.003 user + 0.009 sys
</I>&gt;<i> Maximum Resident Size: 26208 KB
</I>&gt;<i> Page faults with physical i/o: 0
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If I change &quot;ssl_bump bump net_bump&quot; to &quot;ssl_bump bump all&#8221; It starts up but it still fails to allow any https through even those on the whitelist_ssl file but allows http to those domains. Not sure what I am doing wrong here.
</I>&gt;<i> 
</I>
That is because the traffic is mostly intercepted and those
fake/synthetic CONNECT requests have &quot;CONNECT IP:port HTTP/1.1&quot;.

raw-IPs are not in your whitelist. Your http_access rules do not permit
non-whitelisted URI to be serviced. Thus they are rejected before
bumping even starts to find out what the SNI/domain the client was
trying to connect to was.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006146.html">[squid-users] Squid 3.5.10 SSL Bump whitelist domains
</A></li>
	<LI>Next message (by thread): <A HREF="006127.html">[squid-users] nonce_garbage_interval problem?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6148">[ date ]</a>
              <a href="thread.html#6148">[ thread ]</a>
              <a href="subject.html#6148">[ subject ]</a>
              <a href="author.html#6148">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
