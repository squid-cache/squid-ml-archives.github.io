<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid/NTLM Auth
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid/NTLM%20Auth&In-Reply-To=%3C054a6128124f48768fbd9e2e0c088bbf%40de36s02aexc02.ucc.merckgroup.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006120.html">
   <LINK REL="Next"  HREF="006153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid/NTLM Auth</H1>
    <B>Keith White</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid/NTLM%20Auth&In-Reply-To=%3C054a6128124f48768fbd9e2e0c088bbf%40de36s02aexc02.ucc.merckgroup.com%3E"
       TITLE="[squid-users] Squid/NTLM Auth">keith.white at emdmillipore.com
       </A><BR>
    <I>Thu Oct 22 15:25:08 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006120.html">[squid-users] Squid/NTLM Auth
</A></li>
        <LI>Next message (by thread): <A HREF="006153.html">[squid-users] Squid/NTLM Auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6149">[ date ]</a>
              <a href="thread.html#6149">[ thread ]</a>
              <a href="subject.html#6149">[ subject ]</a>
              <a href="author.html#6149">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I was able to confirm that ntlm_auth worked for the squid user.  We currently use BlueCoat proxies so IE is definitely configured to use integrated authentication. No cache_effective* in the config.  I will enable debugging and see what is happening as well as enable Kerberos.

Thanks,

Keith

-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: Thursday, October 22, 2015 4:53 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid/NTLM Auth

On 22/10/2015 8:21 a.m., Keith White wrote:
&gt;<i>
</I>&gt;<i> I have squid running on Centos 7 and am trying to setup AD
</I>&gt;<i> authentication. I have samba/winbindd installed and the system was
</I>&gt;<i> added to the domain with authconfig. I have tested authentication with
</I>&gt;<i> auth_ntlm and that works. I have also tested group membership with
</I>&gt;<i> auth_ntlm and that works as well. When attempting to access squid with
</I>&gt;<i> either IE or Firefox I am presented with the authentication dialog box.
</I>

If you have cache_effective_user or cache_effective_group directives in your config file remove them. They break the Winbind helpers group permissions.


Were your successful tests made using the Squid low-privileged user account ?
 If no, then your test results are not relevant. Re-test as the Squid user. Which will need membership of the winbindd_priv group.

What Windows version are the IE and Firefox being run on?
If it is newer than Windows 2000, then you should be moving to Negotiate/Kerberos authentication instead of NTLM.

Does the client machine have Windows Integrated Authentication enabled?
and is it on-domain?
 Off-domain machines have no chance of NTLM working. Disable their integrated authentication settings.
Note that without the integrated auth Firefox has no access to NTLM credentials and MSIE has a tendency to use the machine credentials instead of the users.



&gt;<i> Manually entering credentials does not work. What debugging can I
</I>&gt;<i> enable to see what is going on? Squid is built with the following
</I>
&lt;<A HREF="http://wiki.squid-cache.org/KnowledgeBase/DebugSections">http://wiki.squid-cache.org/KnowledgeBase/DebugSections</A>&gt;

At least these:
  debug_options ALL,0 11,2 28,5 29,5


&gt;<i>
</I>&gt;<i> Squid Cache: Version 3.5.9-20150917-r13917 Service Name: squid
</I>&gt;<i> configure options:  '--prefix=/usr' '--includedir=/usr/include' '--datadir=/usr/share' '--bindir=/usr/sbin' '--libexecdir=/usr/lib/squid' '--localstatedir=/varsquid' '--sysconfdir=/etc/squid' '--enable-auth' '--enable-auth-ntlm' '--enable-external-acl-helpers' '--enable-auth-negotiate' '--enable-auth-basic' '--enable-auth-digest'
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> relevant section from squid.conf
</I>&gt;<i>
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 5
</I>&gt;<i> auth_param ntlm keep_alive on
</I>&gt;<i> auth_param basic program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-basic auth_param basic children 5
</I>&gt;<i> auth_param basic realm Squid proxy-caching web server auth_param basic
</I>&gt;<i> credentialsttl 2 hours
</I>
You should list Basic as first choice since it is the more secure of those two protocols.

Sounds like a joke, but it is true NTLM is less secure these days than Basic auth. Namely because clients that accept NTLM can be auto-downgraded by attackers to using LanMan protocols that broadcast the username and password just like Basic - BUT most network software treats Basic auth as the insecure one and do a lot more to protect its weak credentials.


&gt;<i>
</I>&gt;<i> acl AuthorizedUsers proxy_auth REQUIRED http_access allow localnet
</I>&gt;<i> http_access allow AuthorizedUsers http_access allow localhost
</I>
The above implies that the authenticated users will be outside the LAN (localnet). The 'L' in NTLM is &quot;LAN&quot; and old 1980-1990's style flat LAN networks are where it was designed for use. It does *not* work properly over Internet connections or even in many of todays complex LAN environments.

You need Negotiate/Kerberos auth for Internet clients to even have half a chance of authenticating securely. Then you also need to get the whole on/off domain thing sorted out and working.


PS. you will probably need a few hundred helpers for NTLM. It is an
*extremely* inefficient protocol. I've not seen even a home network operate with less than 50, usual minimum is 100.

Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


This message and any attachment are confidential and may be privileged or otherwise protected from disclosure. If you are not the intended recipient, you must not copy this message or attachment or disclose the contents to any other person. If you have received this transmission in error, please notify the sender immediately and delete the message and any attachment from your system. Merck KGaA, Darmstadt, Germany and any of its subsidiaries do not accept liability for any omissions or errors in this message which may arise as a result of E-Mail-transmission or for damages resulting from any unauthorized changes of the content of this message and any attachment thereto. Merck KGaA, Darmstadt, Germany and any of its subsidiaries do not guarantee that this message is free of viruses and does not accept liability for any damages caused by any virus transmitted therewith.



Click <A HREF="http://www.merckgroup.com/disclaimer">http://www.merckgroup.com/disclaimer</A> to access the German, French, Spanish and Portuguese versions of this disclaimer.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006120.html">[squid-users] Squid/NTLM Auth
</A></li>
	<LI>Next message (by thread): <A HREF="006153.html">[squid-users] Squid/NTLM Auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6149">[ date ]</a>
              <a href="thread.html#6149">[ thread ]</a>
              <a href="subject.html#6149">[ subject ]</a>
              <a href="author.html#6149">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
