<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to inspect client certificate in ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20inspect%20client%20certificate%20in%20ssl_bump&In-Reply-To=%3C005901d10d14%2423d0d290%246b7277b0%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007370.html">
   <LINK REL="Next"  HREF="006157.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to inspect client certificate in ssl_bump</H1>
    <B>Leon</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20inspect%20client%20certificate%20in%20ssl_bump&In-Reply-To=%3C005901d10d14%2423d0d290%246b7277b0%24%40gmail.com%3E"
       TITLE="[squid-users] How to inspect client certificate in ssl_bump">wangxuzong at gmail.com
       </A><BR>
    <I>Thu Oct 22 21:53:51 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007370.html">[squid-users] R:  Squid 100% CPU and possible attack
</A></li>
        <LI>Next message (by thread): <A HREF="006157.html">[squid-users] How to inspect client certificate in ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6156">[ date ]</a>
              <a href="thread.html#6156">[ thread ]</a>
              <a href="subject.html#6156">[ subject ]</a>
              <a href="author.html#6156">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm using Squid 3.5. What I'm going to do is setting up a forward proxy that
inspect TLS handshake between client and server then allow the connection
only when following two requirements are met:

    1. The server address must be in our whitelist, and the server must
provide a correct server certificate during TLS handshake
    2. The client must provide a client certificate during TLS handshake.
And the certificate's subject must be in our whitelist

I've set up the ssl_bump according to this page:
<A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice.">http://wiki.squid-cache.org/Features/SslPeekAndSplice.</A> I don't need to do
any bump. I only need to peek then either splice or terminate.

My question is - how to inspect the client certificate? And how to configure
an acl for that?

The document is confusing. It explains the peek action as:
peek    step1, step2    Receive SNI and client certificate (step1), or
server certificate (step2) while preserving the possibility of splicing the
connection. Peeking at the server certificate usually precludes future
bumping of the connection (see Limitations).

But client certificate is not sent at step1 during TLS handshake. Client
certificate is sent after server certificate is received and the sever also
send a &quot;Certificate Request&quot; message. So I guess I need an additional step
(step4)? Is there already someone working on this or I need to create by
myself?

Any suggestion is highly appreciated!

Thanks!
Leon

My Squid configuration is:

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
acl whitelist_server ssl::server_name &quot;/etc/squid/whitelist_server.txt&quot;

http_port 3128 ssl-bump \
  cert=/etc/ssl/ca-cert.pem \
  generate-host-certificates=off dynamic_cert_mem_cache_size=4MB

ssl_bump  peek  step1  all                 
ssl_bump  peek  step2  all    
ssl_bump  splice  step3  whitelist_server  
ssl_bump  terminate  step3  !whitelist_server
ssl_bump  terminate  all                   




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007370.html">[squid-users] R:  Squid 100% CPU and possible attack
</A></li>
	<LI>Next message (by thread): <A HREF="006157.html">[squid-users] How to inspect client certificate in ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6156">[ date ]</a>
              <a href="thread.html#6156">[ thread ]</a>
              <a href="subject.html#6156">[ subject ]</a>
              <a href="author.html#6156">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
