<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid/NTLM Auth
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid/NTLM%20Auth&In-Reply-To=%3Cbfcd8d9a15ee4f86b84f404016bd7186%40de36s02aexc02.ucc.merckgroup.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006161.html">
   <LINK REL="Next"  HREF="006170.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid/NTLM Auth</H1>
    <B>Keith White</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid/NTLM%20Auth&In-Reply-To=%3Cbfcd8d9a15ee4f86b84f404016bd7186%40de36s02aexc02.ucc.merckgroup.com%3E"
       TITLE="[squid-users] Squid/NTLM Auth">keith.white at emdmillipore.com
       </A><BR>
    <I>Fri Oct 23 12:18:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006161.html">[squid-users] Squid/NTLM Auth
</A></li>
        <LI>Next message (by thread): <A HREF="006170.html">[squid-users] Squid/NTLM Auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6169">[ date ]</a>
              <a href="thread.html#6169">[ thread ]</a>
              <a href="subject.html#6169">[ subject ]</a>
              <a href="author.html#6169">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I reran the test and checked the tokens and I can see the type 1 and type 2 tokens but no type 3 tokens.  I ran a packet capture and I think I may have found the issue.  Our Windows servers are specifically configured to not resolve external DNS names.  To get around that I configured specific DNS servers in Squid.  These servers are not AD DNS servers and it appears when Squid is trying to authenticate, it is using these servers and not the DNS servers in /etc/resolv.conf (these point to Windows). I am going to play around with the DNS servers to see if the behavior changes.

Thanks,

Keith

-----Original Message-----
From: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>]
Sent: Thursday, October 22, 2015 11:32 PM
To: Keith White &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">keith.white at emdmillipore.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid/NTLM Auth

On 23/10/2015 8:33 a.m., Keith White wrote:
&gt;<i> Added the debug options and grabbed the following after the 407 message was returned to the client.  Is there anything specific I should be looking for?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Keith
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2015/10/22 12:24:50.573 kid1| Starting new ntlmauthenticator helpers...
</I>&gt;<i> 2015/10/22 12:24:50.574 kid1| 28,4| Acl.cc(70) AuthenticateAcl: returning 2 sending credentials to helper.
</I>&gt;<i> 2015/10/22 12:24:50.574 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> AuthorizedUsers = -1 async
</I>&gt;<i> 2015/10/22 12:24:50.574 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> http_access#3 = -1 async
</I>&gt;<i> 2015/10/22 12:24:50.574 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> http_access = -1 async
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 29,4| UserRequest.cc(303) HandleReply:
</I>&gt;<i> Need to challenge the client with a server token: 'TlRMTVNTUAAC
</I>&gt;<i> AAAACAAIADgAAAAFgomiDULzTzz40XwAAAAAAAAAAIoAigBAAAAABgEAAAAAAA9EAE4ATg
</I>&gt;<i> BBAAIACABEAE4ATgBBAAEAFABVAFMAUwBFADEAWAAwADAAMQA0AAQAIgBuAGEA
</I>&gt;<i> LgBtAGUAcgBjAGsAZwByAG8AdQBwAC4AYwBvAG0AAwA4AHUAcwBzAGUAMQB4ADAAMAAxADQALgBuAGEALgBtAGUAcgBjAGsAZwByAG8AdQBwAC4AYwBvAG0AAAAAAA=='
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 29,5| UserRequest.cc(73) valid: Validated. Auth::UserRequest '0xfb5870'.
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,5| InnerNode.cc(94) resumeMatchingAt:
</I>&gt;<i> checking http_access at 2
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,5| Checklist.cc(400) bannedAction:
</I>&gt;<i> Action 'ALLOWED/0is not banned
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,5| InnerNode.cc(94) resumeMatchingAt:
</I>&gt;<i> checking http_access#3 at 0
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,5| Acl.cc(138) matches: checking
</I>&gt;<i> AuthorizedUsers
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 29,5| UserRequest.cc(73) valid: Validated. Auth::UserRequest '0xfb5870'.
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 29,5| UserRequest.cc(73) valid: Validated. Auth::UserRequest '0xfb5870'.
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 29,2| UserRequest.cc(194) authenticate:
</I>&gt;<i> need to challenge client 'TlRMTVNTUAACAAAACAAIADgAAAAFgomiDULz
</I>&gt;<i> Tzz40XwAAAAAAAAAAIoAigBAAAAABgEAAAAAAA9EAE4ATgBBAAIACABEAE4ATgBBAAEAFA
</I>&gt;<i> BVAFMAUwBFADEAWAAwADAAMQA0AAQAIgBuAGEALgBtAGUAcgBjAGsAZwByAG8A
</I>&gt;<i> dQBwAC4AYwBvAG0AAwA4AHUAcwBzAGUAMQB4ADAAMAAxADQALgBuAGEALgBtAGUAcgBjAGsAZwByAG8AdQBwAC4AYwBvAG0AAAAAAA=='!
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 29,5| UserRequest.cc(73) valid: Validated. Auth::UserRequest '0xfb5870'.
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,4| Acl.cc(76) AuthenticateAcl: returning 3 sending authentication challenge.
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,3| Checklist.cc(63) markFinished:
</I>&gt;<i> 0x13d56f8 answer AUTH_REQUIRED for AuthenticateAcl exception
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,3| Acl.cc(158) matches: checked:
</I>&gt;<i> AuthorizedUsers = -1
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,3| InnerNode.cc(97) resumeMatchingAt:
</I>&gt;<i> checked: http_access#3 = -1
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,3| InnerNode.cc(97) resumeMatchingAt:
</I>&gt;<i> checked: http_access = -1
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,3| Checklist.cc(163) checkCallback:
</I>&gt;<i> ACLChecklist::checkCallback: 0x13d56f8 answer=AUTH_REQUIRED
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,4| FilledChecklist.cc(66)
</I>&gt;<i> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc19f8a3d0
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,4| Checklist.cc(197) ~ACLChecklist:
</I>&gt;<i> ACLChecklist::~ACLChecklist: destroyed 0x7ffc19f8a3d0
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,4| FilledChecklist.cc(66)
</I>&gt;<i> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc19f8a3d0
</I>&gt;<i> 2015/10/22 12:24:50.618 kid1| 28,4| Checklist.cc(197) ~ACLChecklist:
</I>&gt;<i> ACLChecklist::~ACLChecklist: destroyed 0x7ffc19f8a3d0
</I>&gt;<i> 2015/10/22 12:24:50.619 kid1| 29,5| UserRequest.cc(73) valid: Validated. Auth::UserRequest '0xfb5870'.
</I>&gt;<i> 2015/10/22 12:24:50.619 kid1| 11,2| client_side.cc(1391)
</I>&gt;<i> sendStartOfMessage: HTTP Client local=10.31.78.10:3128
</I>&gt;<i> remote=10.1.4.1:5917
</I>&gt;<i> 6 FD 11 flags=1
</I>&gt;<i> 2015/10/22 12:24:50.619 kid1| 11,2| client_side.cc(1392) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i>
</I>
That is the type-2 tokens happening. There should be an initial client request and 407, then repeat client request with type-1 tokens leading up to this.

The details of that reply message you elided at the end should match the challenge token, and contain Connection:keep-alive.

Then there is the followup client re-request with type-3 tokens. And the servers final reply should accept that type-3 token. Ideally it should also use Connection:keep-alive.

If either of those two latter transactions contains Connection:close from either endpoint NTLM breaks.


You can drop the tokens into
&lt;<A HREF="http://treenet.co.nz/projects/squid/ntlm_token.php">http://treenet.co.nz/projects/squid/ntlm_token.php</A>&gt; to see what type they are.

Amos



This message and any attachment are confidential and may be privileged or otherwise protected from disclosure. If you are not the intended recipient, you must not copy this message or attachment or disclose the contents to any other person. If you have received this transmission in error, please notify the sender immediately and delete the message and any attachment from your system. Merck KGaA, Darmstadt, Germany and any of its subsidiaries do not accept liability for any omissions or errors in this message which may arise as a result of E-Mail-transmission or for damages resulting from any unauthorized changes of the content of this message and any attachment thereto. Merck KGaA, Darmstadt, Germany and any of its subsidiaries do not guarantee that this message is free of viruses and does not accept liability for any damages caused by any virus transmitted therewith.



Click <A HREF="http://www.merckgroup.com/disclaimer">http://www.merckgroup.com/disclaimer</A> to access the German, French, Spanish and Portuguese versions of this disclaimer.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006161.html">[squid-users] Squid/NTLM Auth
</A></li>
	<LI>Next message (by thread): <A HREF="006170.html">[squid-users] Squid/NTLM Auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6169">[ date ]</a>
              <a href="thread.html#6169">[ thread ]</a>
              <a href="subject.html#6169">[ subject ]</a>
              <a href="author.html#6169">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
