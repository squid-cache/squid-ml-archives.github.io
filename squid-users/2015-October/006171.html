<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to inspect client certificate in ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20inspect%20client%20certificate%20in%20ssl_bump&In-Reply-To=%3C562A471D.5050600%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006157.html">
   <LINK REL="Next"  HREF="006173.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to inspect client certificate in ssl_bump</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20inspect%20client%20certificate%20in%20ssl_bump&In-Reply-To=%3C562A471D.5050600%40measurement-factory.com%3E"
       TITLE="[squid-users] How to inspect client certificate in ssl_bump">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Oct 23 14:41:33 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006157.html">[squid-users] How to inspect client certificate in ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="006173.html">[squid-users] [Squid 4.x]: Truncated accounts when there is spaces	in usernames
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6171">[ date ]</a>
              <a href="thread.html#6171">[ thread ]</a>
              <a href="subject.html#6171">[ subject ]</a>
              <a href="author.html#6171">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/22/2015 05:59 PM, Leon wrote:

&gt;<i> In regard to the document, I suggest to change the description of
</I>&gt;<i> peek action to &quot;Receive SNI in Client Hello message (step1), or
</I>&gt;<i> server certificate (step2) ...&quot;.
</I>
I see what you mean now. Done.


Thank you,

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>] 
</I>&gt;<i> Sent: Thursday, October 22, 2015 3:41 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Leon &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">wangxuzong at gmail.com</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] How to inspect client certificate in ssl_bump
</I>&gt;<i> 
</I>&gt;<i> On 10/22/2015 03:53 PM, Leon wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm using Squid 3.5. What I'm going to do is setting up a forward 
</I>&gt;&gt;<i> proxy that inspect TLS handshake between client and server then allow 
</I>&gt;&gt;<i> the connection only when following two requirements are met:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     1. The server address must be in our whitelist, and the server 
</I>&gt;&gt;<i> must provide a correct server certificate during TLS handshake
</I>&gt;&gt;<i>     2. The client must provide a client certificate during TLS handshake.
</I>&gt;&gt;<i> And the certificate's subject must be in our whitelist
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've set up the ssl_bump according to this page:
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice.">http://wiki.squid-cache.org/Features/SslPeekAndSplice.</A> I don't need to 
</I>&gt;&gt;<i> do any bump. I only need to peek then either splice or terminate.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My question is - how to inspect the client certificate? And how to 
</I>&gt;&gt;<i> configure an acl for that?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Current SslBump code does not support client certificate inspection.
</I>&gt;<i> Squid does not know anything about a bumped client certificate.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The document is confusing. It explains the peek action as:
</I>&gt;&gt;<i> peek    step1, step2    Receive SNI and client certificate (step1), or
</I>&gt;&gt;<i> server certificate (step2) while preserving the possibility of 
</I>&gt;&gt;<i> splicing the connection. Peeking at the server certificate usually 
</I>&gt;&gt;<i> precludes future bumping of the connection (see Limitations).
</I>&gt;<i> 
</I>&gt;&gt;<i> But client certificate is not sent at step1 during TLS handshake. 
</I>&gt;&gt;<i> Client certificate is sent after server certificate is received and 
</I>&gt;&gt;<i> the sever also send a &quot;Certificate Request&quot; message.
</I>&gt;<i> 
</I>&gt;<i> That is correct. What do you find confusing about the current description? Please suggest improvements or edit the current text.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> So I guess I need an additional step (step4)?
</I>&gt;<i> 
</I>&gt;<i> Yes, although client certificate inspection should most likely be done during step3 and/or step4, with the current &quot;final&quot; step3 increased to
</I>&gt;<i> step4 or step5.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Is there already someone working on this or I need to create by 
</I>&gt;&gt;<i> myself?
</I>&gt;<i> 
</I>&gt;<i> I am not aware of anybody working on the client certificate inspection in SslBump. Please note that correctly handling client certificates during SslBump requires serious development work and that work needs to be done in the unstable SslBump code (e.g., we are currently rewriting handshake parsing code to make it safe and robust).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006157.html">[squid-users] How to inspect client certificate in ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="006173.html">[squid-users] [Squid 4.x]: Truncated accounts when there is spaces	in usernames
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6171">[ date ]</a>
              <a href="thread.html#6171">[ thread ]</a>
              <a href="subject.html#6171">[ subject ]</a>
              <a href="author.html#6171">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
