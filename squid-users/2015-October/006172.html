<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TPROXY and IPv6 issues CentOS 7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20and%20IPv6%20issues%20CentOS%207&In-Reply-To=%3C562A9264.8090100%40jmwhite.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006028.html">
   <LINK REL="Next"  HREF="006176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TPROXY and IPv6 issues CentOS 7</H1>
    <B>James White</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20and%20IPv6%20issues%20CentOS%207&In-Reply-To=%3C562A9264.8090100%40jmwhite.co.uk%3E"
       TITLE="[squid-users] TPROXY and IPv6 issues CentOS 7">james at jmwhite.co.uk
       </A><BR>
    <I>Fri Oct 23 20:02:44 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006028.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
        <LI>Next message (by thread): <A HREF="006176.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6172">[ date ]</a>
              <a href="thread.html#6172">[ thread ]</a>
              <a href="subject.html#6172">[ subject ]</a>
              <a href="author.html#6172">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

I'm literally stumped at this point. The fact TPROXY is working for
IPv4 indicates that I have the necessary setup in place for TPROXY to
at least work, but IPv6 not working is a mystery. Like I said the
Squid box is fully IPv6 capable and clients connecting via 3128 have a
working IPv6 setup.

I maybe should of mentioned that the server Squid is running on is a
HP Microserver Gen8 it does have multiple NICs, but only eno1 is in
use, eno2 is disabled. I'm pretty sure there is some form of routing
issue at the Squid box, but I've read every bit of information about
TPROXY with IPv6 and I cannot see where I have done something wrong.
Reading many articles on the subject they all hint at the same routing
and ip6tables rules that I am using currently.

I've tried using the loopback interface and eno1 (main LAN interface)
and they both yield the same results for IPv6 connectivity.

I hope someone can chime in with some additional
troubleshooting/debugging steps, because I literally have no idea now!

James

On 17/10/2015 10:32, James White wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Thanks for your reply.
</I>&gt;<i> 
</I>&gt;<i> I've tried setting the rp_filter values to 1 and 2 and there is no 
</I>&gt;<i> difference in behaviour.
</I>&gt;<i> 
</I>&gt;<i> Traffic isn't being tagged on dport 3128 directly. What I meant was
</I>&gt;<i> I needed to exclude the configured outgoing IPv6 address at the
</I>&gt;<i> DD-WRT router level with a PREROUTING rule, otherwise there was a
</I>&gt;<i> loop and traffic would be messed up.
</I>&gt;<i> 
</I>&gt;<i> Enabling the via header temporarily, I checked to see what was
</I>&gt;<i> being passed. According to my tests, the IPv6 address of my proxy
</I>&gt;<i> was the value, so the traffic is making it to the Squid box, but no
</I>&gt;<i> IPv6 requests are logged in the access.log from any TPROXY clients
</I>&gt;<i> and all IPv6 requests from TPROXY clients are timing out e.g.
</I>&gt;<i> ipv6.google.com
</I>&gt;<i> 
</I>&gt;<i> I'm pretty confident the problem lies on my Squid server at this 
</I>&gt;<i> point, I can't see any issues with the policy routing on my DD-WRT
</I>&gt;<i> route r.
</I>&gt;<i> 
</I>&gt;<i> MTU is configured correctly and the Squid box can ping and
</I>&gt;<i> traceroute IPv6 addresses.
</I>&gt;<i> 
</I>&gt;<i> I'm really at a loss of what the issue is. I've read the TPROXY
</I>&gt;<i> wiki article many times and there is nothing obvious to me that
</I>&gt;<i> identifies my issue. I've looked for other resources for TPROXY and
</I>&gt;<i> IPv6 and can't find anything else either.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> James
</I>&gt;<i> 
</I>&gt;<i> On 14/10/2015 04:20, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 14/10/2015 7:07 a.m., James White wrote:
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I operate a squid box which has two http_port setups:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> http_port 3128 http_port 3129 TPROXY
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I have implemented TPROXY to replace my NAT setup on a CentOS 7
</I>&gt;&gt;&gt;<i>  Squid 3.3 box. Currently the IPv4 connectivity is working
</I>&gt;&gt;&gt;<i> great, the IPv6 connectivity is broken when going through
</I>&gt;&gt;&gt;<i> TPROXY. All IPv6 connections timeout and from tests it appears
</I>&gt;&gt;&gt;<i> there is a broken IPv6 setup. Using test-ipv6.com I get a 
</I>&gt;&gt;&gt;<i> broken/misconfiguration warning. IPv6 connections handled by
</I>&gt;&gt;&gt;<i> the standard 3128 setup work OK, direct IPv6 connections
</I>&gt;&gt;&gt;<i> outside of the proxy are also OK, TPROXY IPv6 is not working
</I>&gt;&gt;&gt;<i> properly.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I have looked at several TPROXY resources and cannot see where
</I>&gt;&gt;&gt;<i> I have gone wrong or what might be causing the issue. I am
</I>&gt;&gt;&gt;<i> using my DD-WRT routing with policy routing to pass the traffic
</I>&gt;&gt;&gt;<i> to the Squid box which then uses further policy routing to push
</I>&gt;&gt;&gt;<i> the traffic to the TPROXY binding on port 3129.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> DD-WRT firewall/routing rules:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> PROXY_IPV6=&quot;2001:470:xxxx:xx::x&quot; CLIENTIFACE=&quot;br0&quot; FWMARK=3
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ip6tables -t mangle -A PREROUTING -i $CLIENTIFACE -s
</I>&gt;&gt;&gt;<i> $PROXY_IPV6 -p tcp --dport 80 -j ACCEPT ip6tables -t mangle -A
</I>&gt;&gt;&gt;<i> PREROUTING -i $CLIENTIFACE -p tcp --dport 80 -j MARK --set-mark
</I>&gt;&gt;&gt;<i> $FWMARK ip6tables -t mangle -A PREROUTING -m mark --mark
</I>&gt;&gt;&gt;<i> $FWMARK -j ACCEPT ip6tables -t filter -A FORWARD -i
</I>&gt;&gt;&gt;<i> $CLIENTIFACE -o $CLIENTIFACE -p tcp --dport 80 -j ACCEPT
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ip -f inet6 rule add fwmark $FWMARK table 2 ip -f inet6 route 
</I>&gt;&gt;&gt;<i> add default via $PROXY_IPV6 dev $CLIENTIFACE table 2
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Squid box firewall and routing rules:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ip -f inet6 rule add fwmark 1 lookup 100 ip -f inet6 route add
</I>&gt;&gt;&gt;<i>  local default dev eno1 table 100
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ip6tables -t mangle -F ip6tables -t mangle -X ip6tables -t 
</I>&gt;&gt;&gt;<i> mangle -N DIVERT
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ip6tables -t mangle -A DIVERT -j MARK --set-mark 1 ip6tables -t
</I>&gt;&gt;&gt;<i>  mangle -A DIVERT -j ACCEPT ip6tables -t mangle -A PREROUTING
</I>&gt;&gt;&gt;<i> -p tcp -m socket -j DIVERT ip6tables -t mangle -A PREROUTING -p
</I>&gt;&gt;&gt;<i> tcp -m tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port
</I>&gt;&gt;&gt;<i> 3129
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The following sysctl values are set:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> net.ipv4.ip_forward = 1 net.ipv4.conf.default.rp_filter = 0 
</I>&gt;&gt;&gt;<i> net.ipv4.conf.all.rp_filter = 0 net.ipv4.conf.eno1.rp_filter =
</I>&gt;&gt;&gt;<i> 0
</I>&gt;&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Double-check the meaning of 0 in those rules. The rp_filter value
</I>&gt;&gt;<i>  meanings changed just prior to 3.x kernels, and no longer do
</I>&gt;&gt;<i> what most online tutorials say.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I have defined specific IPv4 and IPv6 addresses for the Squid 
</I>&gt;&gt;&gt;<i> traffic to go over, I had to exclude these with PREROUTING
</I>&gt;&gt;&gt;<i> RULES as this broke connectivity on LAN clients which use the
</I>&gt;&gt;&gt;<i> standard http_port setup of 3128. IPv6 connectivity for these
</I>&gt;&gt;&gt;<i> clients is OK.
</I>&gt;<i> 
</I>&gt;&gt;<i> Pause.
</I>&gt;<i> 
</I>&gt;&gt;<i> How is traffic to --dport 3128 matching &quot;-p tcp -m tcp --dport
</I>&gt;&gt;<i> 80&quot; ?
</I>&gt;<i> 
</I>&gt;&gt;<i> It seems to me that would be part of yoru problem. Unless you
</I>&gt;&gt;<i> mean that these rules had to go on the router. In which case, yes
</I>&gt;&gt;<i> you do need to prevent Squid outbound traffic being looped back
</I>&gt;&gt;<i> to it a second time.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> iptables -t mangle -I PREROUTING -p tcp --dport 80 -s 
</I>&gt;&gt;&gt;<i> 192.168.x.x -j ACCEPT ip6tables -t mangle -I PREROUTING -p tcp 
</I>&gt;&gt;&gt;<i> --dport 80 -s 2001:470:xxxx:xx::x -j ACCEPT
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I don't know if I need additional values for any ipv6 config 
</I>&gt;&gt;&gt;<i> value. Nothing is mentioned in the TPROXY Squid wiki article.
</I>&gt;<i> 
</I>&gt;&gt;<i> Given the likelihood of so called &quot;privacy addressing&quot; in IPv6
</I>&gt;&gt;<i> you may need to make the v6 bypasses use /64 subnets instead of
</I>&gt;&gt;<i> single IP's
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Any ideas on what I could be missing?
</I>&gt;&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> When debugging make sure &quot;via on&quot; directive exists in squid.conf.
</I>&gt;&gt;<i>  That will highlight looping errors that you may have from 
</I>&gt;&gt;<i> misconfiguration TPROXY.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Also, make sure that ICMP and path-MTU etc are working. 
</I>&gt;&gt;<i> Particularly from the Squid machine to the Internet.
</I>&gt;<i> 
</I>&gt;&gt;<i> If you haven't already been through the list and 
</I>&gt;&gt;<i> double/triple-checked, the troubleshooting section of 
</I>&gt;&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/Tproxy4">http://wiki.squid-cache.org/Features/Tproxy4</A>&gt; may have the 
</I>&gt;&gt;<i> answer.
</I>&gt;<i> 
</I>&gt;&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________ squid-users 
</I>&gt;&gt;<i> mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2

iQIcBAEBCAAGBQJWKpJkAAoJELyyWoQM+xyOV7AP/RCkWyRMYV3vXsooTJxLdD5k
iuR3PCXgK7g1pZzZoF+bT7fAa8SN9S0LWL20eELmsq2ucnHj9A5aWm/NVXrpFIlt
Dqh0rbSKMrnUzOJ8b0jQi4K04v4eyOETy6yrHgEW3+S/ex3jWo0d0lQOqjvfxbJN
zaqqQsQz/+hJgGiyIIIcXZQ75wbKuawyjExa8oGVZ+Qj+ZddpA7+5pZsNY1kZyX9
n4Q+1l5ofbXjgMB0D/Z9NnYOV56t3fqesWMp8/ba1z0Igg9Zni2PNHznSu6uxpmR
sAIV0VjDBHnHUGEwy7olkXogl5o7RkiOQoF63iLMiCmZOQDnfS5P/i3tVBJfpoYM
4dhdAqyU48IbdciCf2Pva8hRwJCGH9qmID7m0tJ3O/nIkH+W2ppbLGrnaapjOGfX
v1alJ3t8arRHG8C0bc9/RT8NcAptt0spqNneUJrosrAzAMl7GuT00im/lMNZZxRO
HU6RuilbsEQtxnDkgb9tmQXoMThzfAXCLF44qSUd80DC6gaMKY/DWwzvfB3XD9gP
YkXhinN/l2XjNl4SE3GTnhIp9aedC+LH1QlA7gP756XWmccptD9uANeVDl+hcK0U
JdOyp7C7Yzs4wavYCrIY9dgFesa8ej8EHL5+XbntvxYAXReUP9j/03N52CJQiE3M
RAl6ntPuTxo71WFRrujF
=AkCg
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006028.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
	<LI>Next message (by thread): <A HREF="006176.html">[squid-users] TPROXY and IPv6 issues CentOS 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6172">[ date ]</a>
              <a href="thread.html#6172">[ thread ]</a>
              <a href="subject.html#6172">[ subject ]</a>
              <a href="author.html#6172">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
