<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Access regulation with multiple outgoing IPs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Access%20regulation%20with%20multiple%20outgoing%20IPs&In-Reply-To=%3C562CBAF1.7080101%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006181.html">
   <LINK REL="Next"  HREF="006187.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Access regulation with multiple outgoing IPs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Access%20regulation%20with%20multiple%20outgoing%20IPs&In-Reply-To=%3C562CBAF1.7080101%40treenet.co.nz%3E"
       TITLE="[squid-users] Access regulation with multiple outgoing IPs">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Oct 25 11:20:17 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="006181.html">[squid-users] Access regulation with multiple outgoing IPs
</A></li>
        <LI>Next message (by thread): <A HREF="006187.html">[squid-users] Access regulation with multiple outgoing IPs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6185">[ date ]</a>
              <a href="thread.html#6185">[ thread ]</a>
              <a href="subject.html#6185">[ subject ]</a>
              <a href="author.html#6185">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/10/2015 3:49 a.m., rudi wrote:
&gt;<i> Hey guys, 
</I>&gt;<i> 
</I>&gt;<i> im trying to setup squid for windows. I have different IPs on my server and
</I>&gt;<i> i want to assign them to VMs:
</I>&gt;<i> VM1 --&gt; Outgoing IP1
</I>&gt;<i> VM2 --&gt; Outgoing IP2
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> So far this is working! But now i want to deny all other IPs to avoid false
</I>&gt;<i> access. So all VMs have the same incoming IP (i think) but the outgoing IP
</I>&gt;<i> changes by port. 
</I>&gt;<i> 
</I>&gt;<i> Can you help me to set up the access regulation and deny all unwanted
</I>&gt;<i> adresses?
</I>
Correctly updating the localnet ACL definition to contain the LAN ranges
should be enough. The default configuration settings then take care of
permitting only those LAN clients to use the proxy.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 5.189.xxx.xx1:3129 name=3129
</I>&gt;<i> http_port 5.189.xxx.xx2:3130 name=3130
</I>&gt;<i> 
</I>&gt;<i> #VM1
</I>&gt;<i> acl vm3129 myportname 3129 src 213.xxx.xxx.83/24 
</I>
You seem not to know how Squid ACLs work. This may help:
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&gt;

Hint: you dont have a port named &quot;src&quot; or &quot;213.xxx.xxx.83/24&quot; in your
config file.


&gt;<i> tcp_outgoing_address 5.189.xxx.xx1 vm3129
</I>&gt;<i> http_access allow vm3129
</I>&gt;<i> 
</I>&gt;<i> #VM2
</I>&gt;<i> acl vm3130 myportname 3130 src 213.xxx.xxx.83/24
</I>&gt;<i> tcp_outgoing_address 5.189.xxx.xx2 bot3130
</I>&gt;<i> http_access allow vm3130
</I>&gt;<i> 
</I>

The above http_access control rules are permitting anything that arrives
in the http_ports to use the proxy. No restrictions.

Update the localnet ACL to match your LAN ranges, and remove these
&quot;http_access allow vm*&quot; lines.


&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>
So, no restrictions on what protocols clients can send through the proxy.

The above rule is designed to prevent clients using your proxy as a
relay for Spam, or other types of cross-protocol attacks. Removing it is
*very very dangerous*.

If the SSL_Ports is not permissing some needed protocol to use CONNECT
tunnels, just add that protocols server port(s) to the SSL_ports list.
Do not turn off the proxy security completely.

&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>
Like it says. Your rules should be at this point. Especially anything
involving http_access.

&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> #http_access allow all
</I>
Don't just comment that highly dangerous line out. Erase it to avoid
temptation to make an Open Relay / Open Proxy.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="006181.html">[squid-users] Access regulation with multiple outgoing IPs
</A></li>
	<LI>Next message (by thread): <A HREF="006187.html">[squid-users] Access regulation with multiple outgoing IPs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6185">[ date ]</a>
              <a href="thread.html#6185">[ thread ]</a>
              <a href="subject.html#6185">[ subject ]</a>
              <a href="author.html#6185">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
