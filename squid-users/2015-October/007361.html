<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Inconsistent accessing of the cache, craigslist.org images, wacky stuff.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Inconsistent%20accessing%20of%20the%20cache%2C%0A%20craigslist.org%20images%2C%20wacky%20stuff.&In-Reply-To=%3C563049D5.2080109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007358.html">
   <LINK REL="Next"  HREF="007372.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Inconsistent accessing of the cache, craigslist.org images, wacky stuff.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Inconsistent%20accessing%20of%20the%20cache%2C%0A%20craigslist.org%20images%2C%20wacky%20stuff.&In-Reply-To=%3C563049D5.2080109%40treenet.co.nz%3E"
       TITLE="[squid-users] Inconsistent accessing of the cache, craigslist.org images, wacky stuff.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 28 04:06:45 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007358.html">[squid-users] Inconsistent accessing of the cache,	craigslist.org images, wacky stuff.
</A></li>
        <LI>Next message (by thread): <A HREF="007372.html">[squid-users] Inconsistent accessing of the cache,	craigslist.org images, wacky stuff.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7361">[ date ]</a>
              <a href="thread.html#7361">[ thread ]</a>
              <a href="subject.html#7361">[ subject ]</a>
              <a href="author.html#7361">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/10/2015 2:05 p.m., Jester Purtteman wrote:
&gt;<i> So, here is the problem:  I want to cache the images on craigslist.  The
</I>&gt;<i> headers all look thoroughly cacheable, some browsers (I'm glairing at you
</I>&gt;<i> Chrome) send with this thing that requests that they not be cachable,
</I>
&quot;this thing&quot; being what exactly?

I am aware of several nasty things Chrome sends that interfere with
optimal HTTP use. But nothing that directly prohibits caching like you
describe.


&gt;<i> but
</I>&gt;<i> craigslist replies anyway and says &quot;sure thing! Cache that sucker!&quot; and
</I>&gt;<i> firefox doesn't even do that.  An example of URL:
</I>&gt;<i> <A HREF="http://images.craigslist.org/00o0o_3fcu92TR5jB_600x450.jpg">http://images.craigslist.org/00o0o_3fcu92TR5jB_600x450.jpg</A>
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> The request headers look like:
</I>&gt;<i> 
</I>&gt;<i> Host: images.craigslist.org
</I>&gt;<i> 
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:41.0) Gecko/20100101
</I>&gt;<i> Firefox/41.0
</I>&gt;<i> 
</I>&gt;<i> Accept: image/png,image/*;q=0.8,*/*;q=0.5
</I>&gt;<i> 
</I>&gt;<i> Accept-Language: en-US,en;q=0.5
</I>&gt;<i> 
</I>&gt;<i> Accept-Encoding: gzip, deflate
</I>&gt;<i> 
</I>&gt;<i> Referer: <A HREF="http://seattle.craigslist.org/oly/hvo/5288435732.html">http://seattle.craigslist.org/oly/hvo/5288435732.html</A>
</I>&gt;<i> 
</I>&gt;<i> Cookie: cl_tocmode=sss%3Agrid; cl_b=hlJExhZ55RGzNupTXAYJOAIcZ80;
</I>&gt;<i> cl_def_lang=en; cl_def_hp=seattle
</I>&gt;<i> 
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> The response headers are:
</I>&gt;<i> 
</I>&gt;<i> Cache-Control: public, max-age=2592000  &lt;-- doesn't that say &quot;keep that a
</I>&gt;<i> very long time&quot;?
</I>&gt;<i> 
</I>
Not exactly. It says only that you are *allowed* to store it for 30
days. Does not say you have to.

Your refresh_pattern rules will use that as the 'max' limit along with
the below Date+Last-Modified header values when determining whether the
response can be cached, and for how long.


&gt;<i> Content-Length: 49811
</I>&gt;<i> 
</I>&gt;<i> Content-Type: image/jpeg
</I>&gt;<i> 
</I>&gt;<i> Date: Tue, 27 Oct 2015 23:04:14 GMT
</I>&gt;<i> 
</I>&gt;<i> Last-Modified: Tue, 27 Oct 2015 23:04:14 GMT
</I>&gt;<i> 
</I>&gt;<i> Server: craigslist/0
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Access log says:
</I>&gt;<i> 1445989120.714    265 192.168.2.56 TCP_MISS/200 50162 GET
</I>&gt;<i> <A HREF="http://images.craigslist.org/00Y0Y_kMkjOhL1Lim_600x450.jpg">http://images.craigslist.org/00Y0Y_kMkjOhL1Lim_600x450.jpg</A> -
</I>&gt;<i> ORIGINAL_DST/208.82.236.227 image/jpeg
</I>&gt;<i> 
</I>
This is intercepted traffic.

I've run some tests on that domain and it is another one presenting only
1 single IP address on DNS results, but rotating through a whole set in
the background depending on from where it gets queried. As a result
different machines get different results.


What we found just the other day was that domains doing this have big
problems when queried through Google DNS servers. Due to the way Google
DNS servers are spread around the world and load balancing their traffic
these sites can return different IPs on each and very lookup.

The final outcome of all that is when Squid tries to verify the
intercepted traffic was actually going where the client intended, it
cannot confirm the ORIGINAL_DST server IP is one belonging to the Host
header domain.


The solution is to setup a DNS resolver in your network and use that
instead of the Google DNS. You may have to divert clients DNS queries to
it if they try to go to Google DNS still. The result will be much more
cacheable traffic and probably faster DNS as well.


&gt;<i> 
</I>&gt;<i> And Store Log says:
</I>&gt;<i> 1445989120.714 RELEASE -1 FFFFFFFF 27C2B2CEC9ACCA05A31E80479E5F0E9C   ?
</I>&gt;<i> ?         ?         ? ?/? ?/? ? ?
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I started out with a configuration from here:
</I>&gt;<i> <A HREF="http://wiki.sebeka.k12.mn.us/web_services:squid_update_cache">http://wiki.sebeka.k12.mn.us/web_services:squid_update_cache</A> but have made a
</I>&gt;<i> lot of tweaks to it.  In fact, I've dropped all the updates, all the
</I>&gt;<i> rewrite, store id, and a lot of other stuff.  I've set cache allow all
</I>&gt;<i> (which, I suspect I can simply leave blank, but I don't know)  I've cut it
</I>&gt;<i> down quite a bit, the one I am testing right now for example looks like
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> My squid.conf (which has been hacked mercilously trying stuff, admittedly)
</I>&gt;<i> looks like this:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> &lt;BEGIN SQUID.CONF &gt;
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> 
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i>  
</I>
You are missing the default security http_access lines. They should be
re-instated even on intercepted traffic.

 acl SSL_Ports port 443

 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_Ports



&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> 
</I>
Okay, assuming you have the proper iptables/ip6tables TPROXY rules setup
to accompany it.


&gt;<i> 
</I>&gt;<i> cache_dir aufs /var/spool/squid/ 40000 32 256
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> 
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 8.8.8.8 8.8.4.4
</I>&gt;<i> 
</I>
See above.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> cache allow all
</I>
Not useful. That is the default action when &quot;cache&quot; directive is
nomitted entirely.

&gt;<i> 
</I>&gt;<i> maximum_object_size 8000 MB
</I>&gt;<i> 
</I>&gt;<i> range_offset_limit 8000 MB
</I>&gt;<i> 
</I>&gt;<i> quick_abort_min 512 KB
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> cache_store_log /var/log/squid/store.log
</I>&gt;<i> 
</I>&gt;<i> access_log daemon:/var/log/squid/access.log squid
</I>&gt;<i> 
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> max_open_disk_fds 8000
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> vary_ignore_expire on
</I>&gt;<i> 
</I>
The above should not be doing anything in current Squid which are
HTTP/1.1 compliant. It is just a directive we have forgotten to remove.

&gt;<i> request_entities on
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i .*\.(gif|png|jpg|jpeg|ico|webp)$ 10080 100% 43200
</I>&gt;<i> ignore-no-store ignore-private ignore-reload store-stale
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i .*\.index.(html|htm)$ 2880 40% 10080
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i .*\.(html|htm|css|js)$ 120 40% 1440
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern . 0 40% 40320
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> cache_mgr &lt;my address&gt;
</I>&gt;<i> 
</I>&gt;<i> cache_effective_user proxy
</I>&gt;<i> 
</I>&gt;<i> cache_effective_group proxy
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> &lt;END SQUID.CONF&gt;
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> There is a good deal of hacking that has gone into this configuration, and I
</I>&gt;<i> accept that this will eventually be gutted and replaced with something less,
</I>&gt;<i> broken.
</I>
It is surprisingly good for all that :-)


&gt;<i>  Where I am pulling my hair out is trying to figure out why things
</I>&gt;<i> are cached and then not cached.  That top refresh line (the one looking for
</I>&gt;<i> jpg, gifs etc) has taken many forms, and I am getting inconsistent results.
</I>&gt;<i> The above image will cache just fine, a couple times, but if I go back,
</I>&gt;<i> clear the cache on the browser, close out, restart and reload, it releases
</I>&gt;<i> the link and never again shall it cache.  What is worse, it appears to get
</I>&gt;<i> getting worse over time until it isn't really picking up much of anything.
</I>&gt;<i> What starts out as a few missed entries piles up into a huge list of cache
</I>&gt;<i> misses over time.
</I>&gt;<i> 
</I>
What Squid version is this? 0.1% seems to be extremely low. Even for a
proxy having those Google DNS problems.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Right now, I am running somewhere in the 0.1% hits rate, and I can only
</I>&gt;<i> assume I have buckled something in all the compile and re-compiles, and
</I>&gt;<i> reconfigurations.  What started out as &quot;gee, I wonder if I can cache
</I>&gt;<i> updates&quot; has turned into quite the rabbit hole!
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> So, big question, what debug level do I use to see this thing making
</I>&gt;<i> decisions on whether to cache, and any tips anyone has about this would be
</I>&gt;<i> appreciated.  Thank you!
</I>
debug_options 85,3 22,3


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007358.html">[squid-users] Inconsistent accessing of the cache,	craigslist.org images, wacky stuff.
</A></li>
	<LI>Next message (by thread): <A HREF="007372.html">[squid-users] Inconsistent accessing of the cache,	craigslist.org images, wacky stuff.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7361">[ date ]</a>
              <a href="thread.html#7361">[ thread ]</a>
              <a href="subject.html#7361">[ subject ]</a>
              <a href="author.html#7361">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
