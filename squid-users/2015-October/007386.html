<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3C56315D53.7010505%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007385.html">
   <LINK REL="Next"  HREF="007387.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3C56315D53.7010505%40ngtech.co.il%3E"
       TITLE="[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks">eliezer at ngtech.co.il
       </A><BR>
    <I>Wed Oct 28 23:42:11 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007385.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
        <LI>Next message (by thread): <A HREF="007387.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7386">[ date ]</a>
              <a href="thread.html#7386">[ thread ]</a>
              <a href="subject.html#7386">[ subject ]</a>
              <a href="author.html#7386">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

I got it all wrong.
You cannot run TCP health test on an intercept port..
An intercept port is expected to not receive Direct TCP connections.
What you see is because squid tries to find information on INTERCEPTED 
connection which the case it is not.
If you want to run a health test on the port you should do it with a trick.
You can try to send a TCP connection to an ip of the squid but on 
another port such as 13333 and on the squid iptables add a special rules 
that will redirect any traffic to port 13333 to port 3128.
I do still recommend you to add an addition http_port for local usage 
and statistics availability.

Since you do want to verify that the proxy is running it is not 
mandatory to monitor the 3128 port and you can use another port of the 
proxy which is not an intercept port.
It is expected that the two ports would be always available at the same 
time and each can reflect the status of the service.

Let me know how it works.

Eliezer

On 29/10/2015 01:33, John Smith wrote:
 &gt; Hi Eliezer,
 &gt;
 &gt; I've tried adding a non-intercept line to my squid.conf but it didn't 
seem
 &gt; to make a difference.
 &gt;
 &gt; I've tailed the cache log and run tcpdump on port 3128 on the machine at
 &gt; the same time to confirm that aws load balancer health checks are what's
 &gt; causing the getsockopt(SO_ORIGINAL_DST) to appear in the logs.  An 
AWS load
 &gt; balancer sends tcp packets regularly (configurable, typically several 
times
 &gt; a minute from each of several IP addresses) to each host in the load
 &gt; balancer to ensure that the squid service is up and running.  The squid
 &gt; service sees these random tcp packets, doesn't know what to do with them,
 &gt; and logs the getsockopt(SO_ORIGINAL_DST) error.
 &gt;
 &gt; I assume other load balancers do something similar to monitor whether the
 &gt; service is running on an instance.
 &gt; Perhaps the real question is 'how do you put squid behind a load balancer
 &gt; that performs tcp health checks without filling the logs?&quot;
 &gt;
 &gt; Thanks,
 &gt; John
 &gt;
 &gt; On Wed, Oct 28, 2015 at 4:06 PM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
 &gt; wrote:
 &gt;
 &gt;&gt; Hey John,
 &gt;&gt;
 &gt;&gt; I am pretty sure it is something in the AWS Linux kernel.
 &gt;&gt;
 &gt;&gt; In any case you should have some http_port without intercept in the 
config.
 &gt;&gt; As an example add &quot;http_port 127.0.0.1:13333&quot; but I am not sure how it
 &gt;&gt; was on squid 3.1.10, I know it is mandatory since for 3.4.
 &gt;&gt;
 &gt;&gt; If you can test the same settings on an Ubuntu 14.04 server and not AWS
 &gt;&gt; Linux it would help much to make sure it's either an AWS Linux specific
 &gt;&gt; issue or something else.
 &gt;&gt;
 &gt;&gt; All The Bests,
 &gt;&gt; Eliezer
 &gt;&gt;
 &gt;&gt;
 &gt;&gt; On 29/10/2015 00:51, John Smith wrote:
 &gt;&gt;
 &gt;&gt;&gt; hi,
 &gt;&gt;&gt;
 &gt;&gt;&gt; I have a working(?) squid 3.10 proxy configuration.
 &gt;&gt;&gt; squid-3.1.10-29.18.amzn1.x86_64 on AWS Linux behind an AWS elastic load
 &gt;&gt;&gt; balancer.
 &gt;&gt;&gt;
 &gt;&gt;&gt; My problem is that it appears every single AWS elastic load balancer
 &gt;&gt;&gt; healthcheck triggers a line like this in cache.log:
 &gt;&gt;&gt; 2015/10/28 22:35:10| IpIntercept.cc(137) NetfilterInterception:  NF
 &gt;&gt;&gt; getsockopt(SO_ORIGINAL_DST) failed on FD 14: (92) Protocol not 
available
 &gt;&gt;&gt;
 &gt;&gt;&gt; I have determined that if I removed the 'intercept' option from our
 &gt;&gt;&gt; http_port 3128, we no longer get the warning messages in cache.log, but
 &gt;&gt;&gt; squid also no longer functions as we want it to...
 &gt;&gt;&gt;
 &gt;&gt;&gt; How do we resolve this?'
 &gt;&gt;&gt; Thanks!
 &gt;&gt;&gt;
 &gt;&gt;&gt; My squid.conf:
 &gt;&gt;&gt;
 &gt;&gt;&gt; #
 &gt;&gt;&gt; # Recommended minimum configuration:
 &gt;&gt;&gt; #
 &gt;&gt;&gt; acl manager proto cache_object
 &gt;&gt;&gt; acl localhost src 127.0.0.1/32 ::1
 &gt;&gt;&gt; acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Example rule allowing access from your local networks.
 &gt;&gt;&gt; # Adapt to list your (internal) IP networks from where browsing
 &gt;&gt;&gt; # should be allowed
 &gt;&gt;&gt; acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
 &gt;&gt;&gt; acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
 &gt;&gt;&gt; acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
 &gt;&gt;&gt; acl localnet src fc00::/7       # RFC 4193 local private network range
 &gt;&gt;&gt; acl localnet src fe80::/10      # RFC 4291 link-local (directly 
plugged)
 &gt;&gt;&gt; machines
 &gt;&gt;&gt;
 &gt;&gt;&gt; acl httpacl port 80
 &gt;&gt;&gt; acl SSL_ports port 443
 &gt;&gt;&gt; acl Safe_ports port 80          # http
 &gt;&gt;&gt; acl Safe_ports port 21          # ftp
 &gt;&gt;&gt; acl Safe_ports port 443         # https
 &gt;&gt;&gt; acl Safe_ports port 70          # gopher
 &gt;&gt;&gt; acl Safe_ports port 210         # wais
 &gt;&gt;&gt; acl Safe_ports port 1025-65535  # unregistered ports
 &gt;&gt;&gt; acl Safe_ports port 280         # http-mgmt
 &gt;&gt;&gt; acl Safe_ports port 488         # gss-http
 &gt;&gt;&gt; acl Safe_ports port 591         # filemaker
 &gt;&gt;&gt; acl Safe_ports port 777         # multiling http
 &gt;&gt;&gt; acl CONNECT method CONNECT
 &gt;&gt;&gt;
 &gt;&gt;&gt; #
 &gt;&gt;&gt; # Recommended minimum Access Permission configuration:
 &gt;&gt;&gt; #
 &gt;&gt;&gt; # Only allow cachemgr access from localhost
 &gt;&gt;&gt; http_access allow manager localhost
 &gt;&gt;&gt; http_access deny manager
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Deny requests to certain unsafe ports
 &gt;&gt;&gt; http_access deny !Safe_ports
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Deny CONNECT to other than secure SSL ports
 &gt;&gt;&gt; http_access deny CONNECT !SSL_ports
 &gt;&gt;&gt;
 &gt;&gt;&gt; # We strongly recommend the following be uncommented to protect 
innocent
 &gt;&gt;&gt; # web applications running on the proxy server who think the only
 &gt;&gt;&gt; # one who can access services on &quot;localhost&quot; is a local user
 &gt;&gt;&gt; #http_access deny to_localhost
 &gt;&gt;&gt;
 &gt;&gt;&gt; #
 &gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
 &gt;&gt;&gt; #
 &gt;&gt;&gt;
 &gt;&gt;&gt; negative_ttl 3600 seconds
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Example rule allowing access from your local networks.
 &gt;&gt;&gt; # Adapt localnet in the ACL section to list your (internal) IP networks
 &gt;&gt;&gt; # from where browsing should be allowed
 &gt;&gt;&gt; http_access allow localnet
 &gt;&gt;&gt; http_access allow localhost
 &gt;&gt;&gt;
 &gt;&gt;&gt; # And finally deny all other access to this proxy
 &gt;&gt;&gt; http_access deny all
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Squid normally listens to port 3128
 &gt;&gt;&gt;
 &gt;&gt;&gt; http_port 3128 intercept
 &gt;&gt;&gt;
 &gt;&gt;&gt; # We recommend you to use at least the following line.
 &gt;&gt;&gt; hierarchy_stoplist cgi-bin ?
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Uncomment and adjust the following to add a disk cache directory.
 &gt;&gt;&gt; cache_dir ufs /squid1 30720 16 256
 &gt;&gt;&gt; cache_dir ufs /squid2 30720 16 256
 &gt;&gt;&gt; cache_mem 10 GB
 &gt;&gt;&gt; access_log /logs/squid/access.log
 &gt;&gt;&gt; cache_log /logs/squid/cache.log
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Leave coredumps in the first cache dir
 &gt;&gt;&gt; coredump_dir /var/spool/squid
 &gt;&gt;&gt;
 &gt;&gt;&gt; visible_hostname l1
 &gt;&gt;&gt;
 &gt;&gt;&gt; # Add any of your own refresh_pattern entries above these.
 &gt;&gt;&gt; refresh_pattern -i \.(html|htm|css|js)$ 1440 40% 259200
 &gt;&gt;&gt; refresh_pattern -i \.(gif|png|jpg|jpeg|ico|otf|woff|eot|ttf|svg)$ 10080
 &gt;&gt;&gt; 90%
 &gt;&gt;&gt; 259200 override-expire ignore-no-cache ignore-no-store ignore-private
 &gt;&gt;&gt; refresh_pattern ^ftp:   1440  20% 10080
 &gt;&gt;&gt; refresh_pattern ^gopher:  1440  0%  1440
 &gt;&gt;&gt; refresh_pattern -i (/cgi-bin/|\?) 0 0%  0
 &gt;&gt;&gt; refresh_pattern .   0 20% 4320
 &gt;&gt;&gt;
 &gt;&gt;&gt; cache_peer l2proxy  parent 80 0 no-query no-digest name=http_peer
 &gt;&gt;&gt; cache_peer_access http_peer allow httpacl
 &gt;&gt;&gt; cache_peer l2proxy parent 3129 0 no-query no-digest name=https_peer
 &gt;&gt;&gt; cache_peer_access https_peer deny httpacl
 &gt;&gt;&gt; never_direct allow all
 &gt;&gt;&gt;
 &gt;&gt;&gt;
 &gt;&gt;&gt;
 &gt;&gt;&gt; _______________________________________________
 &gt;&gt;&gt; squid-users mailing list
 &gt;&gt;&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 &gt;&gt;&gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
 &gt;&gt;&gt;
 &gt;&gt;&gt;
 &gt;&gt; _______________________________________________
 &gt;&gt; squid-users mailing list
 &gt;&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 &gt;&gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
 &gt;&gt;
 &gt;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007385.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
	<LI>Next message (by thread): <A HREF="007387.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7386">[ date ]</a>
              <a href="thread.html#7386">[ thread ]</a>
              <a href="subject.html#7386">[ subject ]</a>
              <a href="author.html#7386">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
