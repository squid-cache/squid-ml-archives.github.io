<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3CCAEKmLn-vZrZqQD6-exwDe066-P8iL-Hhv2Z-WvR5rDr-GRiX1g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007395.html">
   <LINK REL="Next"  HREF="007417.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks</H1>
    <B>John Smith</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3CCAEKmLn-vZrZqQD6-exwDe066-P8iL-Hhv2Z-WvR5rDr-GRiX1g%40mail.gmail.com%3E"
       TITLE="[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks">burnncrashnow at gmail.com
       </A><BR>
    <I>Thu Oct 29 14:08:36 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007395.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
        <LI>Next message (by thread): <A HREF="007417.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7409">[ date ]</a>
              <a href="thread.html#7409">[ thread ]</a>
              <a href="subject.html#7409">[ subject ]</a>
              <a href="author.html#7409">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos and Eliezer,

My complete squid.conf is in the first post.  The 'interesting' parts are
here:

acl httpacl port 80
acl SSL_ports port 443

http_port 3128 intercept

cache_peer l2proxy  parent 80 0 no-query no-digest name=http_peer
cache_peer_access http_peer allow httpacl
cache_peer l2proxy parent 3129 0 no-query no-digest name=https_peer
cache_peer_access https_peer deny httpacl
never_direct allow all

We have 2 layers of proxies for business reasons.
The proxies in question are the first layer, they redirect all traffic to a
second layer of proxies - l2proxy above
http traffic goes out port 80, https traffic goes out port 3129, toward the
second layer of proxies.
I assume the 'intercept' is what allows / forces the incoming traffic from
3128 to go on to the 2nd layer of proxies.
When I remove 'intercept', the second layer of proxies never get called as
we need them to be.

We don't need squid to do NAT, but we do need it to forward to the second
layer of proxies.
Things are now working as expected, I'm just trying to reduce the noise in
the logs and would clearly welcome any suggestions for improvements.

Thanks again,
John


On Wed, Oct 28, 2015 at 10:00 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 29/10/2015 1:28 p.m., Eliezer Croitoru wrote:
</I>&gt;<i> &gt; Why are you using an intercept port?
</I>&gt;<i> &gt; IF you don't need it you dont't.
</I>&gt;<i> &gt; Every time any direct conneciton is done to the proxy port 3128 it will
</I>&gt;<i> &gt; show this line since the connection is a regular TCP one while the
</I>&gt;<i> &gt; &quot;intercept&quot; directive instructs squid to fetch information which exists
</I>&gt;<i> &gt; only on NATTED\REDIRECT traffic.
</I>&gt;<i> &gt; Pretty simple and straight forward and this is the way squid works..
</I>&gt;<i> &gt; You should verify if you need a http_port 1111 or http_port 1111 accel
</I>&gt;<i> &gt; or http_port 1111 intercept.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I will be glad to help you in about 20 hours.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Eliezer
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 29/10/2015 02:06, John Smith wrote:
</I>&gt;<i> &gt;&gt; Hi Eliezer,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I've added a single line to my squid.conf:
</I>&gt;<i> &gt;&gt; http_port 3130
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; And I've modified my AWS ELB healthcheck to monitor port 3130 instead of
</I>&gt;<i> &gt;&gt; 3128.
</I>&gt;<i> &gt;&gt; Now my instances are still in the ELB, and the proxy still works as
</I>&gt;<i> &gt;&gt; expected, AND the amount of garbage errors in the cache.log has been
</I>&gt;<i> &gt;&gt; significantly reduced.
</I>&gt;<i>
</I>&gt;<i> They are not garbage. They are telling you very clearly that the message
</I>&gt;<i> being received did not go through the kernel NAT system so all the TCP
</I>&gt;<i> protocol NAT related stuff is not working properly.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Unfortunately I'm seeing a single a single line in cache.log every time
</I>&gt;<i> I
</I>&gt;<i> &gt;&gt; hit the proxy on port 3128:
</I>&gt;<i> &gt;&gt; 2015/10/28 23:53:32| IpIntercept.cc(137) NetfilterInterception:  NF
</I>&gt;<i> &gt;&gt; getsockopt(SO_ORIGINAL_DST) failed on FD 61: (92) Protocol not available
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  From other posts, it appears this warning message related to NAT.
</I>&gt;<i> &gt;&gt; I'm not
</I>&gt;<i> &gt;&gt; doing NAT on the squid proxies, the load balancer takes care of that.
</I>&gt;<i>
</I>&gt;<i> Exactly. You told Squid it had to do NAT with the &quot;intercept&quot; option.
</I>&gt;<i> When it tried to do as you instructed ... boom.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Any ideas how to remove the rest of the noise from my logs?
</I>&gt;<i>
</I>&gt;<i> Start with removing the &quot;intercept&quot;. It is clearly the wrong thing to
</I>&gt;<i> have. Then move on to whatever problem appears next.
</I>&gt;<i>
</I>&gt;<i> If you let us know what this ELB+Squid pair is supposed to be doing,
</I>&gt;<i> and/or share your squid.conf we can perhapse suggest what else you need
</I>&gt;<i> to do for other problems.
</I>&gt;<i>
</I>&gt;<i> AMos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151029/4578b6f3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151029/4578b6f3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007395.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
	<LI>Next message (by thread): <A HREF="007417.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7409">[ date ]</a>
              <a href="thread.html#7409">[ thread ]</a>
              <a href="subject.html#7409">[ subject ]</a>
              <a href="author.html#7409">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
