<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3CCAEpx-0WTGFORAwq6q_dhB-OOSaY%2Ba1mbkFNrRcr01WoDqRC0ZQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007426.html">
   <LINK REL="Next"  HREF="007431.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks</H1>
    <B>Chico Venancio</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3CCAEpx-0WTGFORAwq6q_dhB-OOSaY%2Ba1mbkFNrRcr01WoDqRC0ZQ%40mail.gmail.com%3E"
       TITLE="[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks">chicocvenancio at gmail.com
       </A><BR>
    <I>Thu Oct 29 20:02:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007426.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
        <LI>Next message (by thread): <A HREF="007431.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7429">[ date ]</a>
              <a href="thread.html#7429">[ thread ]</a>
              <a href="subject.html#7429">[ subject ]</a>
              <a href="author.html#7429">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>John,

The fact that intercept is changing that seems to be a very specific bug.
You should remove it and find the 'correct' way to make it work.

Chico Venancio
CEO e Diretor de Cria&#231;&#227;o
VM TECH - (98) 9 8800 2743

2015-10-29 16:39 GMT-03:00 John Smith &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">burnncrashnow at gmail.com</A>&gt;:

&gt;<i> Hi Eliezer,
</I>&gt;<i>
</I>&gt;<i> It is entirely possible that haproxy is a better solution than squid for
</I>&gt;<i> what we are doing.
</I>&gt;<i> I have never used either solution, and inherited this 'working' squid
</I>&gt;<i> configuration with the task of cleaning things up and stabilizing it.
</I>&gt;<i> Regarding your question of 'How do the first layer of proxies send their
</I>&gt;<i> request to the second layer of proxies?', all I can tell you is that all
</I>&gt;<i> the work is done in the squid.conf, and I've posted the entire contents
</I>&gt;<i> with a few replacements for security reasons.
</I>&gt;<i> As I've said, I've removed the word 'intercept' several times and the
</I>&gt;<i> requests to secondary proxies no longer work.
</I>&gt;<i> I just confirmed this behaviour again.
</I>&gt;<i> If this is as 'quiet' as I can make the logs then it is what it is.
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Oct 29, 2015 at 8:35 AM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hey John,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You are 100% doing something wrong!
</I>&gt;&gt;<i> From your description and squid.conf there is still something unclear to
</I>&gt;&gt;<i> me.
</I>&gt;&gt;<i> How do the first layer of proxies send their request to the second layer
</I>&gt;&gt;<i> of proxies?
</I>&gt;&gt;<i> If it uses a routing method it's one thing and if it's just splicing the
</I>&gt;&gt;<i> traffic to the 3128 port it's another.
</I>&gt;&gt;<i> Also it will be different if the first layer of proxies know that they
</I>&gt;&gt;<i> are talking to a proxy server or they just balance around the connections.
</I>&gt;&gt;<i> Sorry to tell you what you might already know that you are missing couple
</I>&gt;&gt;<i> fundamentals on how things actually work in order to make it work as it is
</I>&gt;&gt;<i> suppose to.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In any case I think your scenario doesn't require you to use intercept
</I>&gt;&gt;<i> and you should remove it.
</I>&gt;&gt;<i> The fact that it &quot;works&quot; for you this way is probably a result of a very
</I>&gt;&gt;<i> special scenario from the squid proxy point of view.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not know what you are balancing there an I do like squid but if you
</I>&gt;&gt;<i> need to just splice the connections from the LB to the second layer of
</I>&gt;&gt;<i> proxies, why do you actually need squid? what do you benefit from squid in
</I>&gt;&gt;<i> this picture? just load balance to the proxy directly.
</I>&gt;&gt;<i> If you do have an issue when you do not have the intercept flag you
</I>&gt;&gt;<i> should start there and start with the access.log to understand what you
</I>&gt;&gt;<i> need... and don't play with it.
</I>&gt;&gt;<i> *If you don't do NAT\REDIRECT on the proxy machine you don't need
</I>&gt;&gt;<i> intercept*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> By the way, have you tried haproxy instead of squid? I think it will
</I>&gt;&gt;<i> might be better suited for this specific issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All The Bests,
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 29/10/2015 16:08, John Smith wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Amos and Eliezer,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My complete squid.conf is in the first post.  The 'interesting' parts are
</I>&gt;&gt;&gt;<i> here:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl httpacl port 80
</I>&gt;&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer l2proxy  parent 80 0 no-query no-digest name=http_peer
</I>&gt;&gt;&gt;<i> cache_peer_access http_peer allow httpacl
</I>&gt;&gt;&gt;<i> cache_peer l2proxy parent 3129 0 no-query no-digest name=https_peer
</I>&gt;&gt;&gt;<i> cache_peer_access https_peer deny httpacl
</I>&gt;&gt;&gt;<i> never_direct allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We have 2 layers of proxies for business reasons.
</I>&gt;&gt;&gt;<i> The proxies in question are the first layer, they redirect all traffic
</I>&gt;&gt;&gt;<i> to a
</I>&gt;&gt;&gt;<i> second layer of proxies - l2proxy above
</I>&gt;&gt;&gt;<i> http traffic goes out port 80, https traffic goes out port 3129, toward
</I>&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i> second layer of proxies.
</I>&gt;&gt;&gt;<i> I assume the 'intercept' is what allows / forces the incoming traffic
</I>&gt;&gt;&gt;<i> from
</I>&gt;&gt;&gt;<i> 3128 to go on to the 2nd layer of proxies.
</I>&gt;&gt;&gt;<i> When I remove 'intercept', the second layer of proxies never get called
</I>&gt;&gt;&gt;<i> as
</I>&gt;&gt;&gt;<i> we need them to be.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We don't need squid to do NAT, but we do need it to forward to the second
</I>&gt;&gt;&gt;<i> layer of proxies.
</I>&gt;&gt;&gt;<i> Things are now working as expected, I'm just trying to reduce the noise
</I>&gt;&gt;&gt;<i> in
</I>&gt;&gt;&gt;<i> the logs and would clearly welcome any suggestions for improvements.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks again,
</I>&gt;&gt;&gt;<i> John
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Wed, Oct 28, 2015 at 10:00 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;&gt;<i> wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 29/10/2015 1:28 p.m., Eliezer Croitoru wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Why are you using an intercept port?
</I>&gt;&gt;&gt;&gt;&gt;<i> IF you don't need it you dont't.
</I>&gt;&gt;&gt;&gt;&gt;<i> Every time any direct conneciton is done to the proxy port 3128 it will
</I>&gt;&gt;&gt;&gt;&gt;<i> show this line since the connection is a regular TCP one while the
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;intercept&quot; directive instructs squid to fetch information which exists
</I>&gt;&gt;&gt;&gt;&gt;<i> only on NATTED\REDIRECT traffic.
</I>&gt;&gt;&gt;&gt;&gt;<i> Pretty simple and straight forward and this is the way squid works..
</I>&gt;&gt;&gt;&gt;&gt;<i> You should verify if you need a http_port 1111 or http_port 1111 accel
</I>&gt;&gt;&gt;&gt;&gt;<i> or http_port 1111 intercept.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I will be glad to help you in about 20 hours.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Eliezer
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 29/10/2015 02:06, John Smith wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Hi Eliezer,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I've added a single line to my squid.conf:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> http_port 3130
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> And I've modified my AWS ELB healthcheck to monitor port 3130 instead
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> of
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 3128.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Now my instances are still in the ELB, and the proxy still works as
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> expected, AND the amount of garbage errors in the cache.log has been
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> significantly reduced.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> They are not garbage. They are telling you very clearly that the message
</I>&gt;&gt;&gt;&gt;<i> being received did not go through the kernel NAT system so all the TCP
</I>&gt;&gt;&gt;&gt;<i> protocol NAT related stuff is not working properly.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Unfortunately I'm seeing a single a single line in cache.log every
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> time
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> hit the proxy on port 3128:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2015/10/28 23:53:32| IpIntercept.cc(137) NetfilterInterception:  NF
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> getsockopt(SO_ORIGINAL_DST) failed on FD 61: (92) Protocol not
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> available
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>   From other posts, it appears this warning message related to NAT.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I'm not
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> doing NAT on the squid proxies, the load balancer takes care of that.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Exactly. You told Squid it had to do NAT with the &quot;intercept&quot; option.
</I>&gt;&gt;&gt;&gt;<i> When it tried to do as you instructed ... boom.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Any ideas how to remove the rest of the noise from my logs?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Start with removing the &quot;intercept&quot;. It is clearly the wrong thing to
</I>&gt;&gt;&gt;&gt;<i> have. Then move on to whatever problem appears next.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If you let us know what this ELB+Squid pair is supposed to be doing,
</I>&gt;&gt;&gt;&gt;<i> and/or share your squid.conf we can perhapse suggest what else you need
</I>&gt;&gt;&gt;&gt;<i> to do for other problems.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> AMos
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151029/97e0f575/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151029/97e0f575/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007426.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
	<LI>Next message (by thread): <A HREF="007431.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7429">[ date ]</a>
              <a href="thread.html#7429">[ thread ]</a>
              <a href="subject.html#7429">[ subject ]</a>
              <a href="author.html#7429">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
