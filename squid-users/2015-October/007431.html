<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3C56327F40.9060508%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007429.html">
   <LINK REL="Next"  HREF="007435.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3C56327F40.9060508%40treenet.co.nz%3E"
       TITLE="[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct 29 20:19:12 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007429.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
        <LI>Next message (by thread): <A HREF="007435.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7431">[ date ]</a>
              <a href="thread.html#7431">[ thread ]</a>
              <a href="subject.html#7431">[ subject ]</a>
              <a href="author.html#7431">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/10/2015 8:39 a.m., John Smith wrote:
&gt;<i> Hi Eliezer,
</I>&gt;<i> 
</I>&gt;<i> It is entirely possible that haproxy is a better solution than squid for
</I>&gt;<i> what we are doing.
</I>&gt;<i> I have never used either solution, and inherited this 'working' squid
</I>&gt;<i> configuration with the task of cleaning things up and stabilizing it.
</I>&gt;<i> Regarding your question of 'How do the first layer of proxies send their
</I>&gt;<i> request to the second layer of proxies?', all I can tell you is that all
</I>&gt;<i> the work is done in the squid.conf, and I've posted the entire contents
</I>&gt;<i> with a few replacements for security reasons.
</I>
The LB is the first layer.
Squid is the second layer.
The cache_peer Squid is relaying on to are a third.


The hierarchy is thus:

  clients --(?1?)--&gt; LB --(?2?)--&gt; Squid --(HTTP)--&gt; peer(s)

The &quot;?1?&quot; and &quot;?2&quot; parts are what we need to figure out.

How are the clients messages getting to the LB?

a) is it published in DNS as the host of some domain and clients making
requests directly from it that need to be serviced by the proxies you
are wrangling with?

b) are the clients outboung traffic being intercepted/diverted in their
travels to some other server and sent through the LB instead?


How is the load blancer then relying the TCP connections and HTTP
messages inside them to Squid?

A) Is it using NAT to change both dst-IP and dst-port on the TCP packets?

B) Is it terminating the TCP connection from clients, opening one  to
Squid and relaying the HTTP inside based on URL hostnames etc. ?

C) Is it opening a L2 tunnel and relaying the TCP packets to the Squid
machine ?



&gt;<i> As I've said, I've removed the word 'intercept' several times and the
</I>&gt;<i> requests to secondary proxies no longer work.
</I>&gt;<i> I just confirmed this behaviour again.
</I>&gt;<i> If this is as 'quiet' as I can make the logs then it is what it is.
</I>

&quot;getsockopt(SO_ORIGINAL_DST) failed ...: (92) Protocol not available&quot;

Should never happen in a working proxy. Ever.

It can appear because a) the NAT tables in the Squid machine kernel are
overflowing, or b) the external network is configured in a broken way.
Both are really bad scenarios. Your are having the (b) problem.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007429.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
	<LI>Next message (by thread): <A HREF="007435.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7431">[ date ]</a>
              <a href="thread.html#7431">[ thread ]</a>
              <a href="subject.html#7431">[ subject ]</a>
              <a href="author.html#7431">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
