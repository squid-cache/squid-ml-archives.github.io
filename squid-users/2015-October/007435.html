<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3CCAEKmLn-QJi3QwhwOjF1q1%2By0XYet_eaDAZKErX%3DVVF52LGrpTg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007431.html">
   <LINK REL="Next"  HREF="007441.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks</H1>
    <B>John Smith</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22NF%20getsockopt%28SO_ORIGINAL_DST%29%22%20filling%0A%20cache.log%20due%20to%20AWS%20ELB%20healthchecks&In-Reply-To=%3CCAEKmLn-QJi3QwhwOjF1q1%2By0XYet_eaDAZKErX%3DVVF52LGrpTg%40mail.gmail.com%3E"
       TITLE="[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks">burnncrashnow at gmail.com
       </A><BR>
    <I>Thu Oct 29 20:51:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007431.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
        <LI>Next message (by thread): <A HREF="007441.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7435">[ date ]</a>
              <a href="thread.html#7435">[ thread ]</a>
              <a href="subject.html#7435">[ subject ]</a>
              <a href="author.html#7435">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The outbound traffic from the L1proxy instance in question connects to a
public IP / DNS name of an ELB in another AWS region.
We need to send some traffic to a different AWS region, thus the mess below:

AWS instances (clients) -&gt;
AWS internal ELB for L1 proxies -&gt; AWS L1 proxy instances -&gt;
a different AWS internal ELB for  L1 proxy cluster -&gt; a different AWS L1
proxy instance (this is where we have the problem is with 'intercept or
transparent) -&gt;
*One AWS region above, a different AWS region below*
AWS external (publicly addressable) ELB for L2 proxies in a different AWS
region -&gt; AWS L2 proxy instances -&gt; the Internet

These AWS instances have both internal IPs and public IPs, and they don't
really know about their own public IPs.  That may be part or all of the
confusion.

AWS ELBs are published as DNS names, they have multiple IPs, and we are
using DNS to connect to them.

I'm not exactly certain how the ELB functions, at least I don't know enough
to answer your question.
The healthcheck and listeners are are TCP, not HTTP.


On Thu, Oct 29, 2015 at 1:19 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 30/10/2015 8:39 a.m., John Smith wrote:
</I>&gt;<i> &gt; Hi Eliezer,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It is entirely possible that haproxy is a better solution than squid for
</I>&gt;<i> &gt; what we are doing.
</I>&gt;<i> &gt; I have never used either solution, and inherited this 'working' squid
</I>&gt;<i> &gt; configuration with the task of cleaning things up and stabilizing it.
</I>&gt;<i> &gt; Regarding your question of 'How do the first layer of proxies send their
</I>&gt;<i> &gt; request to the second layer of proxies?', all I can tell you is that all
</I>&gt;<i> &gt; the work is done in the squid.conf, and I've posted the entire contents
</I>&gt;<i> &gt; with a few replacements for security reasons.
</I>&gt;<i>
</I>&gt;<i> The LB is the first layer.
</I>&gt;<i> Squid is the second layer.
</I>&gt;<i> The cache_peer Squid is relaying on to are a third.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The hierarchy is thus:
</I>&gt;<i>
</I>&gt;<i>   clients --(?1?)--&gt; LB --(?2?)--&gt; Squid --(HTTP)--&gt; peer(s)
</I>&gt;<i>
</I>&gt;<i> The &quot;?1?&quot; and &quot;?2&quot; parts are what we need to figure out.
</I>&gt;<i>
</I>&gt;<i> How are the clients messages getting to the LB?
</I>&gt;<i>
</I>&gt;<i> a) is it published in DNS as the host of some domain and clients making
</I>&gt;<i> requests directly from it that need to be serviced by the proxies you
</I>&gt;<i> are wrangling with?
</I>&gt;<i>
</I>&gt;<i> b) are the clients outboung traffic being intercepted/diverted in their
</I>&gt;<i> travels to some other server and sent through the LB instead?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> How is the load blancer then relying the TCP connections and HTTP
</I>&gt;<i> messages inside them to Squid?
</I>&gt;<i>
</I>&gt;<i> A) Is it using NAT to change both dst-IP and dst-port on the TCP packets?
</I>&gt;<i>
</I>&gt;<i> B) Is it terminating the TCP connection from clients, opening one  to
</I>&gt;<i> Squid and relaying the HTTP inside based on URL hostnames etc. ?
</I>&gt;<i>
</I>&gt;<i> C) Is it opening a L2 tunnel and relaying the TCP packets to the Squid
</I>&gt;<i> machine ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; As I've said, I've removed the word 'intercept' several times and the
</I>&gt;<i> &gt; requests to secondary proxies no longer work.
</I>&gt;<i> &gt; I just confirmed this behaviour again.
</I>&gt;<i> &gt; If this is as 'quiet' as I can make the logs then it is what it is.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &quot;getsockopt(SO_ORIGINAL_DST) failed ...: (92) Protocol not available&quot;
</I>&gt;<i>
</I>&gt;<i> Should never happen in a working proxy. Ever.
</I>&gt;<i>
</I>&gt;<i> It can appear because a) the NAT tables in the Squid machine kernel are
</I>&gt;<i> overflowing, or b) the external network is configured in a broken way.
</I>&gt;<i> Both are really bad scenarios. Your are having the (b) problem.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20151029/bf770501/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20151029/bf770501/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007431.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
	<LI>Next message (by thread): <A HREF="007441.html">[squid-users] &quot;NF getsockopt(SO_ORIGINAL_DST)&quot; filling cache.log due to AWS ELB healthchecks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7435">[ date ]</a>
              <a href="thread.html#7435">[ thread ]</a>
              <a href="subject.html#7435">[ subject ]</a>
              <a href="author.html#7435">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
