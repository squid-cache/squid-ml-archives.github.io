<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Strange Interaction between Squid and Facebook
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20Interaction%20between%20Squid%20and%20Facebook&In-Reply-To=%3C5632876A.20300%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007434.html">
   <LINK REL="Next"  HREF="007439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Strange Interaction between Squid and Facebook</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20Interaction%20between%20Squid%20and%20Facebook&In-Reply-To=%3C5632876A.20300%40ngtech.co.il%3E"
       TITLE="[squid-users] Strange Interaction between Squid and Facebook">eliezer at ngtech.co.il
       </A><BR>
    <I>Thu Oct 29 20:54:02 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007434.html">[squid-users] Strange Interaction between Squid and Facebook
</A></li>
        <LI>Next message (by thread): <A HREF="007439.html">[squid-users] Strange Interaction between Squid and Facebook
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7436">[ date ]</a>
              <a href="thread.html#7436">[ thread ]</a>
              <a href="subject.html#7436">[ subject ]</a>
              <a href="author.html#7436">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Patrick,

Choosing CentOS 7.1 is a great choice.
First thing is to let you know I am packaging squid RPMs for CentOS 7 
and since the next version of squid(3.5.11) will be out in a few days it 
will be published later next month.

About the issue itself.
Couple questions?
Are you running\using ssl-bump or not?
When a client request is being aborted what do you see in the squid 
access.log?
 From what I know facebook works in HTTPS and an abort can be mainly 
because of a network issue or application level issue.
Since I am working with squid 3.5.10 and I do not have this issue with 
ssl-bump ON or OFF it is unclear what is causing the issue.

I couldn't understand how you ran the tests.
I do understand that you have two proxies and one is peering to the 
other, right?

Thanks,
Eliezer

On 29/10/2015 21:44, Patrick Blair - Peapod wrote:
&gt;<i> Hi All,
</I>&gt;<i>
</I>&gt;<i> I apologize for the length of this post, but I'm really at my wits' end and
</I>&gt;<i> am completely out of ideas as to how I might fix this or why this is
</I>&gt;<i> happening.
</I>&gt;<i>
</I>&gt;<i> Background and Architecture:
</I>&gt;<i> We are using Squid as our user internet access proxy, it is performing
</I>&gt;<i> authentication via LDAP if a site other than what is on the allowed list of
</I>&gt;<i> domains is accessed. We are running the proxy at our secondary datacenter
</I>&gt;<i> and routing all user internet traffic out through the links on that end, so
</I>&gt;<i> that user traffic does not &quot;conflict&quot; with our main website traffic at our
</I>&gt;<i> primary datacenter, as we don't yet have separate circuits for each type of
</I>&gt;<i> traffic. We have hundreds of users accessing the proxy on a daily basis.
</I>&gt;<i> We were running squid 3.3.12 on Solaris 10 11/06 SPARC, with a fairly basic
</I>&gt;<i> configuration, I can provide it if necessary, but everything was working
</I>&gt;<i> &quot;fine&quot; as far as we were able to tell (no complaints from the users). The
</I>&gt;<i> only problem was that the physical hardware is very old and needed to be
</I>&gt;<i> retired, as well as being a box we couldn't easily add more resources to.
</I>&gt;<i>
</I>&gt;<i> So I set up a new proxy, running Centos 7.1 x86_64 on a VM (in VMware ESXi)
</I>&gt;<i> with the latest Squid release (3.5.10) built from source, with a
</I>&gt;<i> configuration along the lines of
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster.">http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster.</A> We moved to a VM
</I>&gt;<i> so we would have greater flexibility and be able to add more resources
</I>&gt;<i> easily if the server became stressed.
</I>&gt;<i> It worked very well in our testing, and there were no real issues that we
</I>&gt;<i> were able to see, so we rolled it out to replace the old proxy.
</I>&gt;<i>
</I>&gt;<i> Since then, everything has been working fine, apart from one site,
</I>&gt;<i> Facebook, not loading correctly. It varies based on the particular browser
</I>&gt;<i> accessing it, but some/most of the style sheets or content don't appear to
</I>&gt;<i> load correctly, resulting in a very mangled look. Running the developer
</I>&gt;<i> tools for each respective browser give us information that the connections
</I>&gt;<i> to the stylesheets or content are aborted. Most of this content is hosted
</I>&gt;<i> on fbcdn.net, which we've made sure is on our allowed domains list.
</I>&gt;<i> What is interesting is that the first object (or multiple ones) is
</I>&gt;<i> retrieved successfully through the proxy, but subsequent ones are denied.
</I>&gt;<i> Again, this appears to vary depending on browser/os combinations, with
</I>&gt;<i> Chrome on OSX and IE (on Windows) seeming to work the best.
</I>&gt;<i>
</I>&gt;<i> We are NOT running a Tproxy or any other sort of intercepting proxy, all
</I>&gt;<i> the clients are explicitly aware of the proxy's existence through a .pac
</I>&gt;<i> configuration file pushed out through Group Policy.
</I>&gt;<i>
</I>&gt;<i> I've tried disabling ssl_bump (which shouldn't be enabled anyway) for the
</I>&gt;<i> facebook domains, setting cache deny for those domains, and setting always
</I>&gt;<i> direct for those domains, none of which has had any effect.
</I>&gt;<i>
</I>&gt;<i> I've also tried reverting to a more &quot;simple&quot; config, even the exact config
</I>&gt;<i> that we were using on the &quot;old&quot; Squid that was working on Solaris, but that
</I>&gt;<i> too fails. I've also changed from using Squid 3.5.10 to the version
</I>&gt;<i> packaged by CentOS (squid-3.3.8-12.el7_0.x86_64), tried this with both
</I>&gt;<i> configurations to no avail.
</I>&gt;<i>
</I>&gt;<i> The only thing that has worked is setting up a &quot;test&quot; squid at our primary
</I>&gt;<i> datacenter, same configurations, but this one does work. We've checked and
</I>&gt;<i> verified that there are no custom routes or any other network
</I>&gt;<i> configurations that vary between the servers, only IP addresses. Both are
</I>&gt;<i> on unrestricted vlans that allow direct access to the internet. We are
</I>&gt;<i> checking with our networking team to see if there is any custom routing
</I>&gt;<i> that is in place on their end, but it's very doubtful that is the case.
</I>&gt;<i>
</I>&gt;<i> I believe I've covered everything here, I can provide any other information
</I>&gt;<i> or configurations if necessary (I didn't provide those here because of the
</I>&gt;<i> length already). If anyone out there has encountered this issue, I would
</I>&gt;<i> GREATLY appreciate any information or troubleshooting assistance you could
</I>&gt;<i> provide.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best Regards,
</I>&gt;<i>
</I>&gt;<i> Pat Blair
</I>&gt;<i> Sr. Unix Administrator
</I>&gt;<i> Peapod, LLC
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">pblair at peapod.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007434.html">[squid-users] Strange Interaction between Squid and Facebook
</A></li>
	<LI>Next message (by thread): <A HREF="007439.html">[squid-users] Strange Interaction between Squid and Facebook
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7436">[ date ]</a>
              <a href="thread.html#7436">[ thread ]</a>
              <a href="subject.html#7436">[ subject ]</a>
              <a href="author.html#7436">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
