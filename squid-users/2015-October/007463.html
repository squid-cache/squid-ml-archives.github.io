<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid with SMP, CARP and a forwarding loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20SMP%2C%20CARP%20and%20a%20forwarding%20loop&In-Reply-To=%3C5633401B.8080009%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007452.html">
   <LINK REL="Next"  HREF="007465.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid with SMP, CARP and a forwarding loop</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20SMP%2C%20CARP%20and%20a%20forwarding%20loop&In-Reply-To=%3C5633401B.8080009%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid with SMP, CARP and a forwarding loop">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct 30 10:02:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="007452.html">[squid-users] Squid with SMP, CARP and a forwarding loop
</A></li>
        <LI>Next message (by thread): <A HREF="007465.html">[squid-users] Can't find file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7463">[ date ]</a>
              <a href="thread.html#7463">[ thread ]</a>
              <a href="subject.html#7463">[ subject ]</a>
              <a href="author.html#7463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/10/2015 1:45 p.m., Mike.Hodgkinson wrote:
&gt;<i> I have been attempting to setup a squid forward proxy with one frontend 
</I>&gt;<i> and two backends as per configuration example 
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster">http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster</A>
</I>&gt;<i> 
</I>&gt;<i> My issue is that only the first attempt comes from the cache and then 
</I>&gt;<i> additional requests are downloaded direct by the frontend instead of from 
</I>&gt;<i> the backend caches. I suspect it is due to a detected forwarding loop 
</I>&gt;<i> which shows up in the logs:
</I>&gt;<i> 
</I>&gt;<i> 2015/10/30 13:07:49.239 kid1| 44,3| peer_select.cc(137) peerSelect: 
</I>&gt;<i> e:=XIWV/0x7f7bfee2e730*2 <A HREF="http://127.0.0.1:40">http://127.0.0.1:40</A>
</I>&gt;<i> 02/squid-internal-dynamic/netdb
</I>&gt;<i> 2015/10/30 13:07:49.239 kid1| 20,3| store.cc(466) lock: peerSelect locked 
</I>&gt;<i> key 64AAA11C8DEF57153B10BA2C9D2F3D60 e:=XIWV/0x7f7bfee2e730*3
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,3| peer_select.cc(441) peerSelectFoo: GET 
</I>&gt;<i> 127.0.0.1
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,3| peer_select.cc(468) peerSelectFoo: 
</I>&gt;<i> peerSelectFoo: direct = DIRECT_YES (forwarding loop detected)
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,3| peer_select.cc(477) peerSelectFoo: 
</I>&gt;<i> peerSelectFoo: direct = DIRECT_YES
</I>&gt;<i> 2015/10/30 13:07:49.240 kid1| 44,2| peer_select.cc(258) 
</I>&gt;<i> peerSelectDnsPaths: Find IP destination for: 
</I>&gt;<i> <A HREF="http://127.0.0.1:4002/squid-internal-dynamic/netdb">http://127.0.0.1:4002/squid-internal-dynamic/netdb</A>' via 127.0.0.1
</I>&gt;<i> 
</I>&gt;<i> I can force the backend caches to be used successfully with this option 
</I>&gt;<i> &quot;never_direct allow all&quot; however I would like to resolve the underlying 
</I>&gt;<i> issue.
</I>
The above is an internal Squid request from the fontend to its backends.
This one specifically is going direct due to a hack in the code.

You can avoid it by adding &quot;no-netdb-exchange&quot; to the cache_peer lines.
I'm not sure if that will affect the CARP selection since these requests
are one of the types feeding into the peer up/down/overloaded
monitoring. With &quot;no-query&quot; also in use you will be left with the client
HTTP traffic being the only source of that data which carp depends on.

Or using that &quot;never_direct allow all&quot; will override that code hack.

&gt;<i> 
</I>&gt;<i> I have no iptables configured on this server and have made sure the 
</I>&gt;<i> environment variable http_proxy is not set. Also I have tested this on 
</I>&gt;<i> Squid 3.4.8 and 3.5.10 on Debian.
</I>
Since you have no iptables rules configured the traffic arriving in port
3129 will be completely borked.

Either, remove that port 3129 line from the frontend config and use port
3128 for testing until you are ready to setup TPROXY properly;

Or, setup the TPROXY iptables and routing rules and test the proxy
exactly as the clients would be using it.


&gt;<i> 
</I>&gt;<i> My config is below:
</I>&gt;<i> #/etc/squid/squid.conf#
</I>&gt;<i> debug_options = ALL,3
</I>&gt;<i> cachemgr_passwd ******
</I>
NOTE: if that was your actual password you now need to change it.

&gt;<i> acl localnet src 10.1.0.0/16
</I>&gt;<i> acl localnet src 10.2.0.0/16
</I>&gt;<i> acl localnet src 192.168.0.0/23
</I>&gt;<i> acl localnet src fe80::/10
</I>&gt;<i> acl squid_servers src 10.1.209.0/24
</I>
 See below...

&lt;snip&gt;
&gt;<i> #/etc/squid/squid-frontend.conf#
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow squid_servers
</I>
With squid_servers IP range being entirely within &quot;localnet&quot; this
&quot;http_access allow squid_servers&quot; line is not doing anything.
You can simplify by removing it.


&gt;<i> htcp_access allow squid_servers
</I>&gt;<i> htcp_access deny all
</I>&gt;<i> cache_peer 127.0.0.1 parent 4002 0 carp login=PASS name=backend-kid2 
</I>&gt;<i> no-query
</I>&gt;<i> cache_peer 127.0.0.1 parent 4003 0 carp login=PASS name=backend-kid3 
</I>&gt;<i> no-query
</I>&gt;<i> prefer_direct off
</I>&gt;<i> nonhierarchical_direct off
</I>&gt;<i> memory_replacement_policy heap LRU
</I>&gt;<i> cache_mem 2048 MB
</I>&gt;<i> access_log /var/log/squid3/frontend.access.log
</I>&gt;<i> cache_log /var/log/squid3/frontend.cache.log
</I>&gt;<i> visible_hostname frontend.cloud.solnet.nz
</I>&gt;<i> 
</I>&gt;<i> #/etc/squid/squid-backend.conf#
</I>&gt;<i> http_port 127.0.01:400${process_number}
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> cache_mem 5 MB
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> maximum_object_size 1 GB
</I>&gt;<i> cache_dir rock /cache/rock 20480 max-size=32768
</I>&gt;<i> cache_dir aufs /cache/${process_number} 20480 128 128 min-size=32769
</I>&gt;<i> visible_hostname backend${process_number}.cloud.solnet.nz
</I>&gt;<i> access_log /var/log/squid3/backend${process_number}.access.log
</I>&gt;<i> cache_log /var/log/squid3/backend${process_number}.cache.log
</I>&gt;<i> 
</I>&gt;<i> I did have visible_hostname set to backend.cloud.solnet.nz but that did 
</I>&gt;<i> not help either.
</I>
Nod. All that did previously was prevent forwarding loops between the
backends in case something unusually nasty happened in the
routing/iptabels layers. What you have now is okay and slightly better
for diagnosing the issues.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="007452.html">[squid-users] Squid with SMP, CARP and a forwarding loop
</A></li>
	<LI>Next message (by thread): <A HREF="007465.html">[squid-users] Can't find file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7463">[ date ]</a>
              <a href="thread.html#7463">[ thread ]</a>
              <a href="subject.html#7463">[ subject ]</a>
              <a href="author.html#7463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
