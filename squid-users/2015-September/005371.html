<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Lots of &quot;Vary object loop!&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Lots%20of%20%22Vary%20object%20loop%21%22&In-Reply-To=%3CCA%2BY8hcP4QpYWa71WDZeKJChxvEMEct3fVf1SZvUgHvg5qcud-A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005369.html">
   <LINK REL="Next"  HREF="005390.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Lots of &quot;Vary object loop!&quot;</H1>
    <B>Kinkie</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Lots%20of%20%22Vary%20object%20loop%21%22&In-Reply-To=%3CCA%2BY8hcP4QpYWa71WDZeKJChxvEMEct3fVf1SZvUgHvg5qcud-A%40mail.gmail.com%3E"
       TITLE="[squid-users] Lots of &quot;Vary object loop!&quot;">gkinkie at gmail.com
       </A><BR>
    <I>Thu Sep  3 16:37:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005369.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="005390.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5371">[ date ]</a>
              <a href="thread.html#5371">[ thread ]</a>
              <a href="subject.html#5371">[ subject ]</a>
              <a href="author.html#5371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
   do you think you could manage to capture the headers of the
response triggering that error?
I've been looking that up, but couldn't reprduce it.

The good news is, it's mostly harmless: worst case scenario it will
cause a slow cache miss.

Thanks

On Thu, Sep 3, 2015 at 5:20 PM, Sebasti&#225;n Goicochea
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sebag at vianetcon.com.ar</A>&gt; wrote:
&gt;<i> Amos, I spent a couple of days doing some test with the info you gave me:
</I>&gt;<i>
</I>&gt;<i> Retested emptying the cache several times, disabled the rewriter, different
</I>&gt;<i> config files .. all I could think of
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Downloaded fresh 3.5.8 tar.gz (just in case it was some 3.5.4 thing) and
</I>&gt;<i> compiled it using this configure options:
</I>&gt;<i>
</I>&gt;<i> Squid Cache: Version 3.5.8
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--prefix=/usr/local' '--datadir=/usr/local/share'
</I>&gt;<i> '--bindir=/usr/local/sbin' '--libexecdir=/usr/local/lib/squid'
</I>&gt;<i> '--localstatedir=/var' '--sysconfdir=/etc/squid3' '--enable-delay-pools'
</I>&gt;<i> '--enable-ssl' '--enable-ssl-crtd' '--enable-linux-netfilter' '--enable-eui'
</I>&gt;<i> '--enable-snmp' '--enable-gnuregex' '--enable-ltdl-convenience'
</I>&gt;<i> '--enable-removal-policies=lru heap' '--enable-http-violations'
</I>&gt;<i> '--with-openssl' '--with-filedescriptors=24321' '--enable-poll'
</I>&gt;<i> '--enable-epoll' '--enable-storeio=ufs,aufs,diskd,rock' '--disable-ipv6'
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And the problem appeared again, I am suspicious that the problem is in the
</I>&gt;<i> configuration, I even removed all my refresh patterns, but:
</I>&gt;<i>
</I>&gt;<i> 2015/09/02 15:03:42 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt, '<A HREF="http://assets.pinterest.com/js/pinit.js">http://assets.pinterest.com/js/pinit.js</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,%20deflate&quot;'
</I>&gt;<i> 2015/09/02 15:03:42 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/09/02 15:03:43 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt, '<A HREF="http://static.cmptch.com/v/lib/str.html">http://static.cmptch.com/v/lib/str.html</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,%20deflate,%20sdch&quot;'
</I>&gt;<i> 2015/09/02 15:03:43 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/09/02 15:03:43 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt,
</I>&gt;<i> '<A HREF="http://pstatic.bestpriceninja.com/nwp/v0_0_773/release/Shared/Extra/IFrameStoreReciever.js">http://pstatic.bestpriceninja.com/nwp/v0_0_773/release/Shared/Extra/IFrameStoreReciever.js</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,%20deflate,%20sdch&quot;'
</I>&gt;<i> 2015/09/02 15:03:43 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/09/02 15:03:59 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt, '<A HREF="http://static.xvideos.com/v2/css/xv-video-styles.css?v=7">http://static.xvideos.com/v2/css/xv-video-styles.css?v=7</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,deflate&quot;'
</I>&gt;<i> 2015/09/02 15:03:59 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/09/02 15:03:59 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt, '<A HREF="http://s7.addthis.com/js/250/addthis_widget.js">http://s7.addthis.com/js/250/addthis_widget.js</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,deflate&quot;'
</I>&gt;<i> 2015/09/02 15:03:59 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Later on I tested it with this short config file and the problem persisted:
</I>&gt;<i>
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>&gt;<i> acl all src all
</I>&gt;<i> acl localhost src 127.0.0.1/32
</I>&gt;<i> acl localnet src 127.0.0.0/8
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl snmppublic snmp_community public
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access allow all
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> cache_mem 1024 MB
</I>&gt;<i> maximum_object_size_in_memory 64 KB
</I>&gt;<i> memory_cache_mode always
</I>&gt;<i> maximum_object_size 150000 KB
</I>&gt;<i> minimum_object_size 100 bytes
</I>&gt;<i> collapsed_forwarding on
</I>&gt;<i> logfile_rotate 5
</I>&gt;<i> mime_table /etc/squid3/mime.conf
</I>&gt;<i> debug_options ALL,1
</I>&gt;<i> store_id_access deny all
</I>&gt;<i> store_id_bypass on
</I>&gt;<i> refresh_pattern ^ftp:                    1440    20%    10080
</I>&gt;<i> refresh_pattern ^gopher:                1440    0%    1440
</I>&gt;<i> refresh_pattern ^http:\/\/movies\.apple\.com           86400   20%     86400
</I>&gt;<i> override-expire override-lastmod ignore-no-cache ignore-private
</I>&gt;<i> ignore-reload
</I>&gt;<i> refresh_pattern -i \.flv$                   10080   90%     999999
</I>&gt;<i> ignore-no-cache override-expire ignore-private
</I>&gt;<i> refresh_pattern -i \.mov$                   10080   90%     999999
</I>&gt;<i> ignore-no-cache override-expire ignore-private
</I>&gt;<i> refresh_pattern windowsupdate.com/.*\.(cab|exe) 4320 100% 43200
</I>&gt;<i> reload-into-ims
</I>&gt;<i> refresh_pattern download.microsoft.com/.*\.(cab|exe) 4320 100% 43200
</I>&gt;<i> reload-into-ims
</I>&gt;<i> refresh_pattern -i \.(deb|rpm|exe|zip|tar|tgz|ram|rar|bin|ppt|doc|pdf|tiff)$
</I>&gt;<i> 10080 90% 43200 override-expire ignore-no-cache ignore-private
</I>&gt;<i> refresh_pattern -i (/cgi-bin/)             0    0%    0
</I>&gt;<i> refresh_pattern .                    0    20%    4320
</I>&gt;<i> quick_abort_min 0 KB
</I>&gt;<i> quick_abort_max 0 KB
</I>&gt;<i> quick_abort_pct 100
</I>&gt;<i> range_offset_limit 0
</I>&gt;<i> negative_ttl 1 minute
</I>&gt;<i> negative_dns_ttl 1 minute
</I>&gt;<i> read_ahead_gap 128 KB
</I>&gt;<i> request_header_max_size 100 KB
</I>&gt;<i> reply_header_max_size 100 KB
</I>&gt;<i> via off
</I>&gt;<i> acl apache rep_header Server ^Apache
</I>&gt;<i> half_closed_clients off
</I>&gt;<i> cache_mgr webmaster
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> snmp_access allow snmppublic localhost
</I>&gt;<i> snmp_access deny all
</I>&gt;<i> snmp_incoming_address 127.0.0.1
</I>&gt;<i> error_directory /etc/squid3/errors/English
</I>&gt;<i> max_filedescriptors 65535
</I>&gt;<i> ipcache_size 1024
</I>&gt;<i> forwarded_for off
</I>&gt;<i> log_icp_queries off
</I>&gt;<i> icp_access allow localnet
</I>&gt;<i> icp_access deny all
</I>&gt;<i> htcp_access allow localnet
</I>&gt;<i> htcp_access deny all
</I>&gt;<i> digest_rebuild_period 15 minutes
</I>&gt;<i> digest_rewrite_period 15 minutes
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> max_open_disk_fds 150
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> memory_pools off
</I>&gt;<i> http_port 9001
</I>&gt;<i> http_port 901 tproxy
</I>&gt;<i> if ${process_number} = 1
</I>&gt;<i> access_log stdio:/var/log/squid/1/access.log squid
</I>&gt;<i> cache_log /var/log/squid/1/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> cache_swap_state /var/log/squid/1/%s.swap.state
</I>&gt;<i> else
</I>&gt;<i>  access_log none
</I>&gt;<i>  cache_log /dev/null
</I>&gt;<i> endif
</I>&gt;<i> pid_filename /var/run/squid1.pid
</I>&gt;<i> visible_hostname localhost
</I>&gt;<i> snmp_port 1611
</I>&gt;<i> icp_port 3131
</I>&gt;<i> htcp_port 4828
</I>&gt;<i> cachemgr_passwd admin thisisnotmyrealpassword
</I>&gt;<i> memory_cache_shared  off
</I>&gt;<i> cache_dir rock  /cache1/rock1 256  min-size=100 max-size=3000
</I>&gt;<i> cache_dir rock  /cache1/rock2 2000  min-size=3000 max-size=20000
</I>&gt;<i> cache_dir diskd /cache1/diskd2 60000 16 256 min-size=20000  max-size=200000
</I>&gt;<i> cache_dir diskd /cache2/2 100000 16 256 min-size=200000  max-size=1048576
</I>&gt;<i> cache_dir diskd /cache2/1 680000 16 256 min-size=1048576
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Any ideas what could be wrong?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Sebastian
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> El 26/08/15 a las 17:15, Amos Jeffries escribi&#243;:
</I>&gt;<i>
</I>&gt;<i> On 27/08/2015 7:53 a.m., Sebasti&#225;n Goicochea wrote:
</I>&gt;<i>
</I>&gt;<i> After I sent you my previous email, I continued investigating the
</I>&gt;<i> subject .. I made a change in the source code as follows:
</I>&gt;<i>
</I>&gt;<i> File: /src/http.cc
</I>&gt;<i>
</I>&gt;<i> HttpStateData::haveParsedReplyHeaders()
</I>&gt;<i> {
</I>&gt;<i>     .
</I>&gt;<i>     .
</I>&gt;<i> ##### THIS IS NEW STUFF ###########
</I>&gt;<i>     if (rep-&gt;header.has(HDR_VARY)) {
</I>&gt;<i>     rep-&gt;header.delById(HDR_VARY);
</I>&gt;<i>     debugs(11,3, &quot;Vary detected. Hack Cleaning it up&quot;);
</I>&gt;<i>     }
</I>&gt;<i> ##### END OF NEW STUFF ###########
</I>&gt;<i>
</I>&gt;<i> #if X_ACCELERATOR_VARY
</I>&gt;<i>     if (rep-&gt;header.has(HDR_X_ACCELERATOR_VARY)) {
</I>&gt;<i>     rep-&gt;header.delById(HDR_X_ACCELERATOR_VARY);
</I>&gt;<i>     debugs(11,3, &quot;HDR_X_ACCELERATOR_VARY Vary detected. Hack Cleaning it
</I>&gt;<i> up&quot;);
</I>&gt;<i>     }
</I>&gt;<i> #endif
</I>&gt;<i>     .
</I>&gt;<i>     .
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Deleting Vary from the header at this point gives me hits in every
</I>&gt;<i> object I test (that previously didn't hit) .. web browser never receives
</I>&gt;<i> the Vary in the response header.
</I>&gt;<i> Now I read your answer and you say that this is a critical validity
</I>&gt;<i> check and that worries me. Taking away the vary altogether at this point
</I>&gt;<i> could lead to the problems that you described? If that is the case .. I
</I>&gt;<i> have to investigate other alternatives.
</I>&gt;<i>
</I>&gt;<i> I'll have to look into that function when I'm back at the code later to
</I>&gt;<i> confirm this. But IIRC that function is acting directly on a freshly
</I>&gt;<i> received reply message. You are not removing the validity check, you are
</I>&gt;<i> removing Squids ability to see that it is a Vary object at all. So it is
</I>&gt;<i> never even cached as one.
</I>&gt;<i>
</I>&gt;<i> The side effect of that is that clients asking for non-gzip can get the
</I>&gt;<i> cached gzip copy, etc. but at least its the same URL. So the security
</I>&gt;<i> risks are gone. But the user experience is not always good either way.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


-- 
    Francesco

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005369.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="005390.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5371">[ date ]</a>
              <a href="thread.html#5371">[ thread ]</a>
              <a href="subject.html#5371">[ subject ]</a>
              <a href="author.html#5371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
