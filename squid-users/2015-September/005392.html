<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Safesearch: blocking Google images error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Safesearch%3A%20blocking%20Google%20images%20error&In-Reply-To=%3C55E9EC7E.5000607%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005391.html">
   <LINK REL="Next"  HREF="005396.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Safesearch: blocking Google images error</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Safesearch%3A%20blocking%20Google%20images%20error&In-Reply-To=%3C55E9EC7E.5000607%40treenet.co.nz%3E"
       TITLE="[squid-users] Safesearch: blocking Google images error">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep  4 19:09:50 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005391.html">[squid-users] Safesearch: blocking Google images error
</A></li>
        <LI>Next message (by thread): <A HREF="005396.html">[squid-users] Safesearch: blocking Google images error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5392">[ date ]</a>
              <a href="thread.html#5392">[ thread ]</a>
              <a href="subject.html#5392">[ subject ]</a>
              <a href="author.html#5392">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/09/2015 5:48 a.m., Stanford Prescott wrote:
&gt;<i> I have tried to enable safe searching with Squid 3.5.7 using ssl-bump
</I>&gt;<i> splice but when I enable it, browsing to <A HREF="https://google.com">https://google.com</A> generates a
</I>&gt;<i> Squid error page saying there is no valid certificate. Browsing to all
</I>&gt;<i> other https sites loads the pages correctly and all other SSL-bump sites
</I>&gt;<i> get bumped and displayed correctly.
</I>&gt;<i> 
</I>&gt;<i> Has anyone had any luck getting this to work? Here is the relevant
</I>&gt;<i> squid.conf entries
</I>&gt;<i> 
</I>
Please use 3.5.8. The ssl_bump behaviour got some more important fixes
recently.


&gt;<i> 
</I>&gt;<i> acl s1_tls_connect at_step SslBump1
</I>&gt;<i> acl s2_tls_client_hello at_step SslBump2
</I>&gt;<i> acl s3_tls_server_hello at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> acl tls_server_name_is_ip ssl::server_name_regex \
</I>&gt;<i> ^[0-9]+.[0-9]+.[0-9]+.[0-9]+n
</I>
You have a letter 'n' on the end there is that intentional?

&gt;<i> 
</I>&gt;<i> acl google ssl::server_name .google.com
</I>&gt;<i> ssl_bump peek s1_tls_connect all
</I>&gt;<i> 
</I>&gt;<i> acl nobumpSites ssl::server_name .wellsfargo.com
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice s2_tls_client_hello nobumpSites
</I>&gt;<i> ssl_bump splice s2_tls_client_hello google
</I>&gt;<i> 
</I>&gt;<i> ssl_bump stare s2_tls_client_hello all
</I>&gt;<i>
</I>&gt;<i> ssl_bump bump s3_tls_server_hello all
</I>&gt;<i> 
</I>&gt;<i> cache_peer forcesafesearch.google.com parent 443 0 \
</I>&gt;<i> ssl name=GS originserver \
</I>&gt;<i> no-query no-netdb-exchange no-digest
</I>&gt;<i> 
</I>&gt;<i> acl search dstdomain .google.com
</I>&gt;<i> cache_peer_access GS allow search
</I>&gt;<i> cache_peer_access GS deny all
</I>
I think the fake-CONNECT Squid creates still has only raw-IP:port
details. And with splicing you dont have the decrypt to setup dstdomain
URL details.

For dstdomain you need to match what shows up in access.log as the URI
of these requests.

Does the &quot;google&quot; ACL work in cache_peer_access to use the SNI?


&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow tls_server_name_is_ip
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
The flag DONT_VERIFY_PEER tells Squid not to even bother checking any
security on the outgoing server connection when going DIRECT (not to the
cache_peer). Making the sslproxy_cert_error rules useless.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005391.html">[squid-users] Safesearch: blocking Google images error
</A></li>
	<LI>Next message (by thread): <A HREF="005396.html">[squid-users] Safesearch: blocking Google images error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5392">[ date ]</a>
              <a href="thread.html#5392">[ thread ]</a>
              <a href="subject.html#5392">[ subject ]</a>
              <a href="author.html#5392">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
