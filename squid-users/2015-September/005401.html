<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Muitple ISP client hashing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Muitple%20ISP%20client%20hashing&In-Reply-To=%3C55EAA3C1.4010003%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005400.html">
   <LINK REL="Next"  HREF="005403.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Muitple ISP client hashing</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Muitple%20ISP%20client%20hashing&In-Reply-To=%3C55EAA3C1.4010003%40treenet.co.nz%3E"
       TITLE="[squid-users] Muitple ISP client hashing">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Sep  5 08:11:45 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005400.html">[squid-users] Muitple ISP client hashing
</A></li>
        <LI>Next message (by thread): <A HREF="005403.html">[squid-users] [squid-announce] Squid 3.5.8 is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5401">[ date ]</a>
              <a href="thread.html#5401">[ thread ]</a>
              <a href="subject.html#5401">[ subject ]</a>
              <a href="author.html#5401">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/09/2015 2:20 p.m., Lee Brown wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have multiple ISP's configured, working really nicely, snippet from
</I>&gt;<i> config:
</I>&gt;<i> 
</I>&gt;<i> acl service_RLO src 10.1.10.175/32
</I>&gt;<i> acl service_RLG src 10.1.10.0/24
</I>&gt;<i> acl service_RLG src 10.1.200.0/24
</I>&gt;<i> acl service_Guest src 10.1.3.0/24
</I>&gt;<i> [cut]
</I>&gt;<i> tcp_outgoing_address 10.1.248.1 service_RLO
</I>&gt;<i> tcp_outgoing_address 10.1.248.2 service_RLG
</I>&gt;<i> tcp_outgoing_address 10.1.248.4 service_Pst
</I>&gt;<i> tcp_outgoing_address 10.1.248.5 service_Library
</I>&gt;<i> tcp_outgoing_address 10.1.248.6 service_DP
</I>&gt;<i> tcp_outgoing_address 10.1.248.3 service_Guest
</I>&gt;<i> 
</I>&gt;<i> I would like to add a new ISP and round-robin the src mapping to
</I>&gt;<i> tcp_outgoing_address, such that, for example in the above service_RLG, I am
</I>&gt;<i> looking to say, semantically:
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 10.1.248.2, 10.1.248.9 service_RLG
</I>&gt;<i> 
</I>&gt;<i> Where the first IP matching service_RLG maps to 10.1.248.2, the next,
</I>&gt;<i> different IP matching service_RLG maps to 10.1.248.9, etc.
</I>&gt;<i> 
</I>&gt;<i> I am not trying to split a single client over two ISP's, that can't work.
</I>
It can. HTTP messaging is stateless.

Any problems which occur are purely at the application layer outside of
HTTP.


&gt;<i> 
</I>&gt;<i> I cannot see that this is possible with Squid (3.1.10), which BTW is in
</I>&gt;<i> transparent proxy mode.
</I>
Please avoid the two-word term &quot;transparent proxy&quot;. In relation to Squid
it has many very different meansing.

Is that a capital T and P as in TPROXY ?

Or a phrase missing its key words line &quot;transparent NAT interception
proxy&quot; ?

Or do you mean WPAD transparency ? or authentication single-sign on
transparency ? or one of those people who use the term to describe
reverse-proxy, privacy proxies, ... the term is overloaded into a mess.

&gt;<i> 
</I>&gt;<i> I can't load balance the traffic out of Squid, for the above reason.
</I>
That is only true for TPROXY. Where Squid disables tcp_outgoing_address
and even your above config wont work.

With NAT interception (which I think you meant) there is no transparency
in your 3.1.

The very latest Squid _multiplex_ messages out whatever server
connections are free at the time and match both dst-IP and src-IP
requirements setup by the client inbound connection and
tcp_outgoing_address. Using ORIGINAL_DST to make it _appear_ more
transparent.


What you can't do is LB traffic volumes via round-robin. For the simple
fact that HTTP messages vary in size. So round-robin selection is
guaranteed to produce *im*balance.


&gt;<i> 
</I>&gt;<i> I suppose I could hash the src ip to deliver traffic to two different ports
</I>&gt;<i> in Squid, then use the port as the basis for the tcp_outgoing.  I feel this
</I>&gt;<i> is sub-optimal though as two users may end up on a single ISP with the
</I>&gt;<i> other ISP idle.
</I>

The &quot;random&quot; ACL type shines out as preferred method of LB via src-IP
mangling. There is imbalance, but it is not a certainty, relatively
short lived when it does occur, and is minor relative to the imbalances
coming from message sizes.


Or maybe you could just have one IP that Squid sets and use the proper
OS level LB feature to perform SNAT when that IP is used by Squid to
setup a new connection. It is far better able to deal with balancing
byte-wise than Squid.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005400.html">[squid-users] Muitple ISP client hashing
</A></li>
	<LI>Next message (by thread): <A HREF="005403.html">[squid-users] [squid-announce] Squid 3.5.8 is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5401">[ date ]</a>
              <a href="thread.html#5401">[ thread ]</a>
              <a href="subject.html#5401">[ subject ]</a>
              <a href="author.html#5401">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
