<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] problem with ntlm_smb_lm_auth helper
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20with%20ntlm_smb_lm_auth%20helper&In-Reply-To=%3C55ED6597.3060404%40cadoles.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005431.html">
   <LINK REL="Next"  HREF="005433.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] problem with ntlm_smb_lm_auth helper</H1>
    <B>Emmanuel Garette</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20with%20ntlm_smb_lm_auth%20helper&In-Reply-To=%3C55ED6597.3060404%40cadoles.com%3E"
       TITLE="[squid-users] problem with ntlm_smb_lm_auth helper">egarette at cadoles.com
       </A><BR>
    <I>Mon Sep  7 10:23:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005431.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
        <LI>Next message (by thread): <A HREF="005433.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5432">[ date ]</a>
              <a href="thread.html#5432">[ thread ]</a>
              <a href="subject.html#5432">[ subject ]</a>
              <a href="author.html#5432">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Le 07/09/2015 12:00, Amos Jeffries a &#233;crit :
&gt;<i> On 7/09/2015 8:01 p.m., Emmanuel Garette wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I manage to migrate my squid version from 3.1.19 to 3.3.8 (version
</I>&gt;&gt;<i> included in ubuntu LTS) and I'm using the helper ntlm_smb_lm_auth helper.
</I>&gt;<i> Please make an effort not to use this helper. It is well worth avoidng
</I>&gt;<i> if you can. Your network is in fact far *more secure* using plain old
</I>&gt;<i> Basic auth than using SMB LM auth.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I cannot authentifiate any user with this version of the helper.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've two problem:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * in file lib/ntlmauth/ntlmauth.cc, this line is not working:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     /* Authenticating against the NT response doesn't seem to work... */
</I>&gt;&gt;<i>     tmp = ntlm_fetch_string(&amp;(auth-&gt;hdr), auth_length, &amp;auth-&gt;lmresponse, auth-&gt;flags);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The function ntlm_fetch_string check if password contains only ASCII
</I>&gt;&gt;<i> character. In my test, password contains no ASCII character at all.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In file lib/ntlmauth/ntlmauth.cc, if I remove &quot;return rv;&quot; here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                 fprintf(stderr, &quot;ntlmssp: bad ascii: %04x\n&quot;, *sc);
</I>&gt;&gt;<i>                 return rv;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  all works fine.
</I>&gt;<i> That is bad. Doing so tells Squid that your invalid NTLM token is valid.
</I>&gt;<i>
</I>&gt;<i> It contains flags explicitly stating that the strings inside are ASCII.
</I>&gt;<i> Then contains non-ASCII strings. In no way is that a valid token. The
</I>&gt;<i> helper should be rejecting these.
</I>&gt;<i>
</I>&gt;<i> This helper does accept non-ASCII strings. As long as the flag in the
</I>&gt;<i> token is properly indicating UNICODE / non-ASCII support.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> * in file lib/ntlmauth/ntlmauth.cc, the test is not correct:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     /* Authenticating against the NT response doesn't seem to work... */
</I>&gt;&gt;<i>     tmp = ntlm_fetch_string(&amp;(auth-&gt;hdr), auth_length, &amp;auth-&gt;lmresponse, auth-&gt;flags);
</I>&gt;&gt;<i>     if (tmp.str == NULL || tmp.l == 0) {
</I>&gt;&gt;<i>         fprintf(stderr, &quot;No auth at all. Returning no-auth\n&quot;);
</I>&gt;&gt;<i>         ntlm_errno = NTLM_ERR_LOGON;
</I>&gt;&gt;<i>         return NULL;
</I>&gt;&gt;<i>     }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Value of tmp.l is -1 for me (the first character is not an ASCII
</I>&gt;&gt;<i> character). The test should be &quot;tmp.l &lt; 1&quot;.
</I>&gt;<i>
</I>&gt;<i> That tells me something may have made the code of your helper different
</I>&gt;<i> from the code we distribute.
</I>&gt;<i>
</I>&gt;<i> &quot;rv.l = 0&quot; is set explicitly by ntlm_fetch_string() before running the
</I>&gt;<i> ASCII/UNICODE validation scans. It is only -1 before the rv.str has been
</I>&gt;<i> set.
</I>&gt;<i>
</I>&gt;<i> In the (tmp.str == NULL || tmp.l == 0) check the (tmp.str == NULL) part
</I>&gt;<i> is true whenever tmp.l is -1.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I'm not sure (not try with this version) but those problems seems to be
</I>&gt;&gt;<i> in trunk version
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would like to know if I am wrong or if there is a better solution for
</I>&gt;&gt;<i> than remove return's line.
</I>&gt;<i>
</I>&gt;<i> Would you mind mailing me a copy of the HTTP headers containing the NTLM
</I>&gt;<i> tokens that are breaking for you? Private reply to this is fine, since
</I>&gt;<i> they contain plain-text passwords and I need the full exact tokens (type
</I>&gt;<i> 1, 2, and 3 if you can) as found in the HTTP message.
</I>I've a testing domain without real user/password, so there is nothing
private.

Here is the information send by my browser:

YR TlRMTVNTUAABAAAAB4IIogAAAAAAAAAAAAAAAAAAAAAFASgKAAAADw==
KK
TlRMTVNTUAADAAAAGAAYAF0AAAAYABgAdQAAAAkACQBIAAAABQAFAFEAAAAHAAcAVgAAAAAAAACNAAAABoIAAgUBKAoAAAAPRE9NUEVEQUdPQURNSU5FT0xFLVhQ+zKZ3FrzAN36j1+mF8qXJevSL3r8fNqp3RhnW7JTHptQ/X9aEDyJXow6haCsPLhN

Here is some trace when i remove the &quot;return&quot; line:

# /usr/lib/squid3/ntlm_smb_lm_auth -d dompedago/scribe
ntlm_smb_lm_auth.cc(384): pid=5278 :Adding domain-controller
dompedago/scribe
ntlm_smb_lm_auth.cc(640): pid=5278 :options processed OK
YR TlRMTVNTUAABAAAAB4IIogAAAAAAAAAAAAAAAAAAAAAFASgKAAAADw==
ntlm_smb_lm_auth.cc(482): pid=5278 :managing request
ntlm_smb_lm_auth.cc(488): pid=5278 :ntlm authenticator. Got 'YR
TlRMTVNTUAABAAAAB4IIogAAAAAAAAAAAAAAAAAAAAAFASgKAAAADw==' from Squid
ntlm_smb_lm_auth.cc(438): pid=5278 :obtain_challenge: selecting
DOMPEDAGO\SCRIBE (attempt #1)
ntlm_smb_lm_auth.cc(450): pid=5278 :attempting challenge retrieval
ntlm_smb_lm_auth.cc(154): pid=5278 :Connecting to server SCRIBE domain
DOMPEDAGO
ntlm_smb_lm_auth.cc(452): pid=5278 :make_challenge retuned 0x7f3dad1e63c0
ntlm_smb_lm_auth.cc(454): pid=5278 :Got it
ntlm_smb_lm_auth.cc(623): pid=5278 :sending 'TT
TlRMTVNTUAACAAAACQAJACgAAACCgkEAxzeor2goxxIAAAAAAAAAAERPTVBFREFHTw==' to
squid
TT TlRMTVNTUAACAAAACQAJACgAAACCgkEAxzeor2goxxIAAAAAAAAAAERPTVBFREFHTw==
KK
TlRMTVNTUAADAAAAGAAYAF0AAAAYABgAdQAAAAkACQBIAAAABQAFAFEAAAAHAAcAVgAAAAAAAACNAAAABoIAAgUBKAoAAAAPRE9NUEVEQUdPQURNSU5FT0xFLVhQ+zKZ3FrzAN36j1+mF8qXJevSL3r8fNqp3RhnW7JTHptQ/X9aEDyJXow6haCsPLhN
ntlm_smb_lm_auth.cc(482): pid=5278 :managing request
ntlm_smb_lm_auth.cc(488): pid=5278 :ntlm authenticator. Got 'KK
TlRMTVNTUAADAAAAGAAYAF0AAAAYABgAdQAAAAkACQBIAAAABQAFAFEAAAAHAAcAVgAAAAAAAACNAAAABoIAAgUBKAoAAAAPRE9NUEVEQUdPQURNSU5FT0xFLVhQ+zKZ3FrzAN36j1+mF8qXJevSL3r8fNqp3RhnW7JTHptQ/X9aEDyJXow6haCsPLhN'
from Squid
ntlmssp: bad ascii: fffffffb
ntlmssp: bad ascii: ffffff99
ntlmssp: bad ascii: ffffffdc
ntlmssp: bad ascii: fffffff3
ntlmssp: bad ascii: 0000
ntlmssp: bad ascii: ffffffdd
ntlmssp: bad ascii: fffffffa
ntlmssp: bad ascii: ffffff8f
ntlmssp: bad ascii: ffffffa6
ntlmssp: bad ascii: 0017
ntlmssp: bad ascii: ffffffca
ntlmssp: bad ascii: ffffff97
ntlmssp: bad ascii: ffffffeb
ntlmssp: bad ascii: ffffffd2
ntlmssp: bad ascii: fffffffc
ntlmssp: bad ascii: ffffffda
ntlmssp: bad ascii: ffffffa9
ntlmssp: bad ascii: ffffffdd
ntlm_smb_lm_auth.cc(277): pid=5278 :Empty LM pass detection: user:
'ADMIN', ours:'(E&#65533;
                                                                                    
&#65533;p&#65533;&#65533;&#65533;&#65533;&#65533;(jw&#65533;B&#65533;&#65533;&#65533;&#65533;&#65533;.Q&#65533;7&#65533;&#65533;h(&#65533;', his: '&#65533;2&#65533;&#65533;Z&#65533;' (length: 24)
ntlmssp: bad ascii: ffffffdd
ntlmssp: bad ascii: 0018
ntlmssp: bad ascii: ffffffb2
ntlmssp: bad ascii: 001e
ntlmssp: bad ascii: ffffff9b
ntlmssp: bad ascii: fffffffd
ntlmssp: bad ascii: 007f
ntlmssp: bad ascii: 0010
ntlmssp: bad ascii: ffffff89
ntlmssp: bad ascii: ffffff8c
ntlmssp: bad ascii: ffffff85
ntlmssp: bad ascii: ffffffa0
ntlmssp: bad ascii: ffffffac
ntlmssp: bad ascii: ffffffb8
ntlmssp: bad ascii: 0000
ntlm_smb_lm_auth.cc(288): pid=5278 :Empty NT pass detection: user:
'ADMIN', ours:'&#65533;&#65533;&#65533;&#65533;&#65533;a&#65533;&#65533;&#65533;
&#65533;A
                                                                                             
&#65533;&#65533;2&#65533;&#65533;', his: '&#65533;g[&#65533;S
&#65533;P&#65533;Z&lt;&#65533;^&#65533;:&#65533;&#65533;&#65533;&lt;&#65533;M' (length: 24)
ntlm_smb_lm_auth.cc(299): pid=5278 :checking domain: 'DOMPEDAGO', user:
'ADMIN', pass='&#65533;2&#65533;&#65533;Z&#65533;'

Regards,
&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005431.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
	<LI>Next message (by thread): <A HREF="005433.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5432">[ date ]</a>
              <a href="thread.html#5432">[ thread ]</a>
              <a href="subject.html#5432">[ subject ]</a>
              <a href="author.html#5432">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
