<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] problem with ntlm_smb_lm_auth helper
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20with%20ntlm_smb_lm_auth%20helper&In-Reply-To=%3C55ED7CA1.8030800%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005432.html">
   <LINK REL="Next"  HREF="005434.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] problem with ntlm_smb_lm_auth helper</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20with%20ntlm_smb_lm_auth%20helper&In-Reply-To=%3C55ED7CA1.8030800%40treenet.co.nz%3E"
       TITLE="[squid-users] problem with ntlm_smb_lm_auth helper">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep  7 12:01:37 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005432.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
        <LI>Next message (by thread): <A HREF="005434.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5433">[ date ]</a>
              <a href="thread.html#5433">[ thread ]</a>
              <a href="subject.html#5433">[ subject ]</a>
              <a href="author.html#5433">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/09/2015 10:23 p.m., Emmanuel Garette wrote:
&gt;<i>
</I>&gt;<i> ntlmssp: bad ascii: fffffffb
</I>&gt;<i> ntlmssp: bad ascii: ffffff99
</I>&gt;<i> ntlmssp: bad ascii: ffffffdc
</I>&gt;<i> ntlmssp: bad ascii: fffffff3
</I>&gt;<i> ntlmssp: bad ascii: 0000
</I>&gt;<i> ntlmssp: bad ascii: ffffffdd
</I>&gt;<i> ntlmssp: bad ascii: fffffffa
</I>&gt;<i> ntlmssp: bad ascii: ffffff8f
</I>&gt;<i> ntlmssp: bad ascii: ffffffa6
</I>&gt;<i> ntlmssp: bad ascii: 0017
</I>&gt;<i> ntlmssp: bad ascii: ffffffca
</I>&gt;<i> ntlmssp: bad ascii: ffffff97
</I>&gt;<i> ntlmssp: bad ascii: ffffffeb
</I>&gt;<i> ntlmssp: bad ascii: ffffffd2
</I>&gt;<i> ntlmssp: bad ascii: fffffffc
</I>&gt;<i> ntlmssp: bad ascii: ffffffda
</I>&gt;<i> ntlmssp: bad ascii: ffffffa9
</I>&gt;<i> ntlmssp: bad ascii: ffffffdd
</I>&gt;<i> ntlm_smb_lm_auth.cc(277): pid=5278 :Empty LM pass detection: user:
</I>&gt;<i> 'ADMIN', ours:'(E&#65533;
</I>&gt;<i>                                                                                     
</I>&gt;<i> &#65533;p&#65533;&#65533;&#65533;&#65533;&#65533;(jw&#65533;B&#65533;&#65533;&#65533;&#65533;&#65533;.Q&#65533;7&#65533;&#65533;h(&#65533;', his: '&#65533;2&#65533;&#65533;Z&#65533;' (length: 24)
</I>&gt;<i> ntlmssp: bad ascii: ffffffdd
</I>&gt;<i> ntlmssp: bad ascii: 0018
</I>&gt;<i> ntlmssp: bad ascii: ffffffb2
</I>&gt;<i> ntlmssp: bad ascii: 001e
</I>&gt;<i> ntlmssp: bad ascii: ffffff9b
</I>&gt;<i> ntlmssp: bad ascii: fffffffd
</I>&gt;<i> ntlmssp: bad ascii: 007f
</I>&gt;<i> ntlmssp: bad ascii: 0010
</I>&gt;<i> ntlmssp: bad ascii: ffffff89
</I>&gt;<i> ntlmssp: bad ascii: ffffff8c
</I>&gt;<i> ntlmssp: bad ascii: ffffff85
</I>&gt;<i> ntlmssp: bad ascii: ffffffa0
</I>&gt;<i> ntlmssp: bad ascii: ffffffac
</I>&gt;<i> ntlmssp: bad ascii: ffffffb8
</I>&gt;<i> ntlmssp: bad ascii: 0000
</I>&gt;<i> ntlm_smb_lm_auth.cc(288): pid=5278 :Empty NT pass detection: user:
</I>&gt;<i> 'ADMIN', ours:'&#65533;&#65533;&#65533;&#65533;&#65533;a&#65533;&#65533;&#65533;
</I>&#65533;A
&gt;<i>                                                                                              
</I>&gt;<i> &#65533;&#65533;2&#65533;&#65533;', his: '&#65533;g[&#65533;S
</I>&#65533;P&#65533;Z&lt;&#65533;^&#65533;:&#65533;&#65533;&#65533;&lt;&#65533;M' (length: 24)
&gt;<i> ntlm_smb_lm_auth.cc(299): pid=5278 :checking domain: 'DOMPEDAGO', user:
</I>&gt;<i> 'ADMIN', pass='&#65533;2&#65533;&#65533;Z&#65533;'
</I>&gt;<i> 
</I>
Ah! fetch_string should not even have been used at all on these encoded
blobs. They are not strings. That appears to be the problem.

Please try the attached patch.
(It should apply on squid-3.3 with patch -p0 ).

Amos
-------------- next part --------------
=== modified file 'helpers/ntlm_auth/smb_lm/ntlm_smb_lm_auth.cc'
--- helpers/ntlm_auth/smb_lm/ntlm_smb_lm_auth.cc	2012-11-24 03:52:54 +0000
+++ helpers/ntlm_auth/smb_lm/ntlm_smb_lm_auth.cc	2015-09-07 11:46:55 +0000
@@ -239,80 +239,100 @@
     memcpy(domain, tmp.str, tmp.l);
     user = domain + tmp.l;
     *user = '\0';
     ++user;
 
     /*      debug(&quot;fetching user name\n&quot;); */
     tmp = ntlm_fetch_string(&amp;(auth-&gt;hdr), auth_length, &amp;auth-&gt;user, auth-&gt;flags);
     if (tmp.str == NULL || tmp.l == 0) {
         debug(&quot;No username supplied. Returning no-auth\n&quot;);
         ntlm_errno = NTLM_ERR_LOGON;
         return NULL;
     }
     if (tmp.l &gt; MAX_USERNAME_LEN) {
         debug(&quot;Username string exceeds %d bytes, rejecting\n&quot;, MAX_USERNAME_LEN);
         ntlm_errno = NTLM_ERR_LOGON;
         return NULL;
     }
     memcpy(user, tmp.str, tmp.l);
     *(user + tmp.l) = '\0';
 
-    /* Authenticating against the NT response doesn't seem to work... */
-    tmp = ntlm_fetch_string(&amp;(auth-&gt;hdr), auth_length, &amp;auth-&gt;lmresponse, auth-&gt;flags);
-    if (tmp.str == NULL || tmp.l == 0) {
-        fprintf(stderr, &quot;No auth at all. Returning no-auth\n&quot;);
-        ntlm_errno = NTLM_ERR_LOGON;
-        return NULL;
+    // grab the *response blobs. these are fixed length 24 bytes of binary
+    const ntlmhdr *packet = &amp;(auth-&gt;hdr);
+    {
+        const strhdr * str = &amp;auth-&gt;lmresponse;
+
+        int16_t len = le16toh(str-&gt;len);
+        int32_t offset = le32toh(str-&gt;offset);
+
+        if (len != ENCODED_PASS_LEN || offset + len &gt; auth_length || offset == 0) {
+            debug(&quot;LM response: insane data (pkt-sz: %d, fetch len: %d, offset: %d)\n&quot;, auth_length, len, offset);
+            ntlm_errno = NTLM_ERR_LOGON;
+            return NULL;
+        }
+        tmp.str = (char *)packet + offset;
+        tmp.l = len;
     }
     if (tmp.l &gt; MAX_PASSWD_LEN) {
         debug(&quot;Password string exceeds %d bytes, rejecting\n&quot;, MAX_PASSWD_LEN);
         ntlm_errno = NTLM_ERR_LOGON;
         return NULL;
     }
 
+    /* Authenticating against the NT response doesn't seem to work... in SMB LM helper. */
     memcpy(pass, tmp.str, tmp.l);
     pass[min(MAX_PASSWD_LEN,tmp.l)] = '\0';
 
 #if 1
     debug(&quot;Empty LM pass detection: user: '%s', ours:'%s', his: '%s' (length: %d)\n&quot;,
           user,lmencoded_empty_pass,tmp.str,tmp.l);
     if (memcmp(tmp.str,lmencoded_empty_pass,ENCODED_PASS_LEN)==0) {
         fprintf(stderr,&quot;Empty LM password supplied for user %s\\%s. &quot;
                 &quot;No-auth\n&quot;,domain,user);
         ntlm_errno=NTLM_ERR_LOGON;
         return NULL;
     }
 
-    tmp = ntlm_fetch_string(&amp;(auth-&gt;hdr), auth_length, &amp;auth-&gt;ntresponse, auth-&gt;flags);
-    if (tmp.str != NULL &amp;&amp; tmp.l != 0) {
+    /* still fetch the NT response and check validity against empty password */
+    {
+        const strhdr * str = &amp;auth-&gt;ntresponse;
+        int16_t len = le16toh(str-&gt;len);
+        int32_t offset = le32toh(str-&gt;offset);
+
+        if (len != ENCODED_PASS_LEN || offset + len &gt; auth_length || offset == 0) {
+            debug(&quot;NT response: insane data (pkt-sz: %d, fetch len: %d, offset: %d)\n&quot;, auth_length, len, offset);
+            ntlm_errno = NTLM_ERR_LOGON;
+            return NULL;
+        }
+        tmp.str = (char *)packet + offset;
+        tmp.l = len;
+
         debug(&quot;Empty NT pass detection: user: '%s', ours:'%s', his: '%s' (length: %d)\n&quot;,
               user,ntencoded_empty_pass,tmp.str,tmp.l);
         if (memcmp(tmp.str,lmencoded_empty_pass,ENCODED_PASS_LEN)==0) {
             fprintf(stderr,&quot;ERROR: Empty NT password supplied for user %s\\%s. No-auth\n&quot;, domain, user);
             ntlm_errno = NTLM_ERR_LOGON;
             return NULL;
         }
     }
 #endif
 
-    /* TODO: check against empty password!!!!! */
-
     debug(&quot;checking domain: '%s', user: '%s', pass='%s'\n&quot;, domain, user, pass);
 
     rv = SMB_Logon_Server(handle, user, pass, domain, 1);
     debug(&quot;Login attempt had result %d\n&quot;, rv);
 
     if (rv != NTLM_ERR_NONE) {	/* failed */
         ntlm_errno = rv;
         return NULL;
     }
     *(user - 1) = '\\';		/* hack. Performing, but ugly. */
 
     debug(&quot;credentials: %s\n&quot;, credentials);
     return credentials;
 }
 
 extern &quot;C&quot; void timeout_during_auth(int signum);
 
 static char got_timeout = 0;
 /** signal handler to be invoked when the authentication operation
  * times out */

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005432.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
	<LI>Next message (by thread): <A HREF="005434.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5433">[ date ]</a>
              <a href="thread.html#5433">[ thread ]</a>
              <a href="subject.html#5433">[ subject ]</a>
              <a href="author.html#5433">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
