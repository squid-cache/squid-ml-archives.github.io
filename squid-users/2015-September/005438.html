<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Building squid | Best Practices?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Building%20squid%20%7C%20Best%20Practices%3F&In-Reply-To=%3CCAP6bC064q6w8BTvWT0Y67wrYJS5M2gt%3DoNt_rPy7C5F2w4W_pg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005574.html">
   <LINK REL="Next"  HREF="005439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Building squid | Best Practices?</H1>
    <B>Howard Waterfall</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Building%20squid%20%7C%20Best%20Practices%3F&In-Reply-To=%3CCAP6bC064q6w8BTvWT0Y67wrYJS5M2gt%3DoNt_rPy7C5F2w4W_pg%40mail.gmail.com%3E"
       TITLE="[squid-users] Building squid | Best Practices?">hwaterfall at gmail.com
       </A><BR>
    <I>Mon Sep  7 18:32:49 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005574.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
        <LI>Next message (by thread): <A HREF="005439.html">[squid-users] Building squid | Best Practices?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5438">[ date ]</a>
              <a href="thread.html#5438">[ thread ]</a>
              <a href="subject.html#5438">[ subject ]</a>
              <a href="author.html#5438">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Rafael / Amos -
I got my system up and running yesterday. Thanks so much for the help. I
couldn't get some of the suggestions that Amos made to work, but they did
after running some of the commands on Rafael's wiki, so a real team effort!

After getting it up and running, I found that mac address filtering was not
working. On closer inspection I found that I was running v3.3.8. I guess
that&#8217;s the version my new Ubuntu install (14.04.03 LTS) uses with:

sudo apt-get install squid


I decided to try and build the latest version of squid from source and I
ran into some more problems I cannot solve, so some follow up questions

1) Earlier in the thread, Amos suggested I run:

apt-get build-dep squid


to install the packages needed to build squid. That&#8217;s just the dependencies
though right; I still need the squid source code? Sorry if that seems
obvious, just want to make sure I&#8217;m not missing something.

2) I downloaded squid-3.5.8.tar.xz. I captured the configure options from
my current v3.3.8 squid install using:

squid3 -v


but it led to errors when building v3.5.8, for example:

'--enable-auth-basic=DB,fake,getpwnam,LDAP,MSNT,MSNT-multi-domain,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'.



I suppose it&#8217;s not surprising given it&#8217;s such an old version, so I went
through them all and used the ones I thought made most sense for me. I got
it to build. Here&#8217;s the squid3 -v output from my v3.5.8 build:

Squid Cache: Version 3.5.8
Service Name: squid
configure options:  '--prefix=/mysquid' '--enable-arp-acl'
'--localstatedir=/var' '--libexecdir=/lib/squid3' '--datadir=/share/squid3'
'--sysconfdir=/etc/squid3' '--with-default-user=proxy'
'--with-logdir=/var/log/squid3' '--with-pidfile=/var/run/squid3.pid'
'--build=arm-linux-gnueabihf' '--includedir=/include' '--mandir=/share/man'
'--infodir=/share/info' '--srcdir=.' '--enable-basic-auth-helpers=DB'
'build_alias=arm-linux-gnueabihf'


Here are the problems:

a) I had to change the owner of /var/log/squid3 from root to proxy:

sudo chown proxy /var/log/squid3


Not a big deal I guess, but why can&#8217;t make install take care of the
permissions?

b) It doesn&#8217;t start as a service and there&#8217;s no squid file in:

/etc/init.d/


so I cannot make the DAEMON= and CONFIG= variables point at my custom
/mysquid/sbin/squid and /etc/squid3/squid.conf (I&#8217;ll change the
--sysconfdir config parameter to /mysquid/etc/squid3 in a future build)

c) There&#8217;s no error when I run:

/mysquid/sbin/squid -k parse


but when I run:

/mysquid/sbin/squid -NCd1


I get:

FATAL: Ipc::Mem::Segment::create failed to
shm_open(/squid-cf__metadata.shm): (13) Permission denied


It didn&#8217;t help to make the owner of the &quot;squid-cf*&quot; files to
cache_effective_user as suggested in an online post:

*-rw------- 1 proxy mysquid   8 Sep  7 09:31
/dev/shm/squid-cf__metadata.shm*

*-rw------- 1 proxy mysquid 8216 Sep  7 09:31 /dev/shm/squid-cf__queues.shm*

*-rw------- 1 proxy mysquid   44 Sep  7 09:31
/dev/shm/squid-cf__readers.shm*


d) The configuration file:

/etc/squid3/squid.conf


is a lot different! For example I cannot find:

cache_effective_user


Can you point me to the updated documentation for configuring squid?

Thanks,
Deiter



On Sun, Aug 30, 2015 at 12:15 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 31/08/2015 5:27 a.m., Howard Waterfall wrote:
</I>&gt;<i> &gt; Thanks again, this is valuable information!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As you may have guessed, I'm asking about the user that should do builds
</I>&gt;<i> to
</I>&gt;<i> &gt; ensure that the build outputs are created with the appropriate
</I>&gt;<i> permissions
</I>&gt;<i> &gt; - I get a little concerned about security. It sounds like you are
</I>&gt;<i> &gt; suggesting that I simply create a directory for my custom builds:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I assign the --prefix option to the folder I create, so my build output
</I>&gt;<i> &gt; goes there, and then I make sure the permissions for that folder (and
</I>&gt;<i> it's
</I>&gt;<i> &gt; sub-directories) are set for the user defined by *cache_effective_user*
</I>&gt;<i> (and
</I>&gt;<i> &gt; the user defined by the ./configure option --*with-default-user*). Could
</I>&gt;<i> &gt; you confirm?
</I>&gt;<i>
</I>&gt;<i> Ah, no.
</I>&gt;<i>
</I>&gt;<i> You set ownership of the /proxy folder to whoever amongst the local
</I>&gt;<i> machine user accounts you want to have the ability to build and alter
</I>&gt;<i> the custom Squid binaries etc. Pretty much Admin powers over Squid.
</I>&gt;<i>
</I>&gt;<i> The make process should install the sub-folders with correct permissions
</I>&gt;<i> for the users that will be involved at run-time.
</I>&gt;<i>
</I>&gt;<i> Running the init script / squid as root will take care of the rest.
</I>&gt;<i>
</I>&gt;<i> [ &quot;the rest&quot; being:
</I>&gt;<i>
</I>&gt;<i> The init script runs as root and starts the 'master process' with root
</I>&gt;<i> privileges. That process creates the run-time files and logs etc with
</I>&gt;<i> correct permissions for the effective-user account to access.
</I>&gt;<i>
</I>&gt;<i> The effective-user account is the low-privilege one named in
</I>&gt;<i> --with-default-user and can read/exec the things it needs but not write
</I>&gt;<i> outside the few things the master has explicitly given it ownership of
</I>&gt;<i> (ie those run-time PID file, logs).
</I>&gt;<i>
</I>&gt;<i> ]
</I>&gt;<i>
</I>&gt;<i> PS.
</I>&gt;<i>  You do not need to work with both --with-default-user and
</I>&gt;<i> cache_effective_user. All the ./configure option does is set the
</I>&gt;<i> built-in cache_effective_user default value.
</I>&gt;<i>
</I>&gt;<i> The intention was that you use the ./configure option and omit the
</I>&gt;<i> squid.conf option.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> NP: if you find that /proxy/var/run or /proxy/var/run/squid is missing
</I>&gt;<i> (sometimes it is). Then create those with 777 permission and owner/group
</I>&gt;<i> of the Admin account.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Finally (I hope), I've re-installed Ubuntu (various reasons, not just
</I>&gt;<i> squid
</I>&gt;<i> &gt; issues) and I successfully installed squid using:
</I>&gt;<i> &gt; *sudo apt-get install squid3*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Squid wasn't found the first time:
</I>&gt;<i> &gt; *E: Unable to locate package squid3*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I had to run this first:
</I>&gt;<i> &gt; *sudo apt-get update*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However, when I try *apt-get build-dep squid,* I get:
</I>&gt;<i> &gt; *You must put some 'source' uris in your sources.list*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I can't seem to get over this problem. I've un-commented every line in
</I>&gt;<i> &gt; */etc/apt/sources.list* that starts with deb-src.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Could you suggest a repository that I can add to */etc/apt/sources.list*?
</I>&gt;<i>
</I>&gt;<i> It should be exactly the same as your normal &quot;deb&quot; sources.list line.
</I>&gt;<i> But with &quot;deb-src&quot; at the front. Usually the single line directly
</I>&gt;<i> underneath what you had uncommented before.
</I>&gt;<i>
</I>&gt;<i> Mine looks like this:
</I>&gt;<i>
</I>&gt;<i>   deb <A HREF="http://ftp.debian.org/debian">http://ftp.debian.org/debian</A> unstable main contrib
</I>&gt;<i>   deb-src <A HREF="http://ftp.debian.org/debian">http://ftp.debian.org/debian</A> unstable main contrib
</I>&gt;<i>
</I>&gt;<i> Where I have &quot;unstable&quot; you would have the Ubuntu 14.04 version name
</I>&gt;<i> (trusty?). And different server of course.
</I>&gt;<i>
</I>&gt;<i> Sorry for the vagueness there. I dont work directly with Ubuntu anymore.
</I>&gt;<i>
</I>&gt;<i> The Ubuntu guys did a weird transition from squid3 to squid package
</I>&gt;<i> names and insisted on doing it well before the Squid-3 code could handle
</I>&gt;<i> the 2.7 upgrades. So things are a bit funky IMHO.
</I>&gt;<i>
</I>&gt;<i> Anyhow, the source package name I think is still &quot;squid3&quot; which should
</I>&gt;<i> build the binary packages &quot;squid&quot; and &quot;squid-common&quot;
</I>&gt;<i>  (then:  dpkg --install squid-common_*.deb squid_*.deb ).
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150907/faa88cee/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150907/faa88cee/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005574.html">[squid-users] problem with ntlm_smb_lm_auth helper
</A></li>
	<LI>Next message (by thread): <A HREF="005439.html">[squid-users] Building squid | Best Practices?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5438">[ date ]</a>
              <a href="thread.html#5438">[ thread ]</a>
              <a href="subject.html#5438">[ subject ]</a>
              <a href="author.html#5438">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
