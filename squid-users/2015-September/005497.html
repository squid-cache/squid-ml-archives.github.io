<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Possible memory leak?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20memory%20leak%3F&In-Reply-To=%3C55F2F994.3050904%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005494.html">
   <LINK REL="Next"  HREF="005499.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Possible memory leak?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20memory%20leak%3F&In-Reply-To=%3C55F2F994.3050904%40treenet.co.nz%3E"
       TITLE="[squid-users] Possible memory leak?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 11 15:56:04 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005494.html">[squid-users] Possible memory leak?
</A></li>
        <LI>Next message (by thread): <A HREF="005499.html">[squid-users] high volume of 'missing files' in	cache....TCP_SWAPFAIL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5497">[ date ]</a>
              <a href="thread.html#5497">[ thread ]</a>
              <a href="subject.html#5497">[ subject ]</a>
              <a href="author.html#5497">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/09/2015 1:48 a.m., Alfredo Rezinovsky wrote:
&gt;<i> I'm using squid with a custom icap service. (Which code I plan to free)
</I>&gt;<i> 
</I>&gt;<i> http_port 3129 tproxy disable-pmtu-discovery=always
</I>&gt;<i> 
</I>
You are missing the default port (3128) for management access.


&gt;<i> collapsed_forwarding on
</I>&gt;<i> 
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> max_filedescriptors 8192
</I>&gt;<i> connect_retries 10
</I>&gt;<i> retry_on_error on
</I>&gt;<i> client_request_buffer_max_size 10250 KB
</I>&gt;<i> request_header_max_size 10240 KB
</I>
REALLY bad idea.

These limits require 20 GB of RAM to be available for active client
connections. The latest Squid dont allocate that much of course, but you
have alowed it so the RAM is required to be avaialable for the clients
when they discover that.
 Note that the expanded limits in latest Squid can still only hold 2 MB
or less of data anyway.

These buffers are capped at 64KB by default because message *headers*
size should be only a few KB. Accepting big headers is a DoS vulnerability.

Also, message body/payload are streamed, not restricted by the buffer
sizes. So there is no need for large limits.

&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow all
</I>
You have an open proxy. Anyone who can open a TCP connection to it can
abuse it.

Please re-instate the default security rules for CONNECT, Safe_ports and
SSL_ports:

 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

which should be above the manager lines.

&gt;<i> 
</I>&gt;<i> maximum_object_size 800 MB
</I>&gt;<i> maximum_object_size_in_memory 32 KB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> #Server has 16Gb RAM
</I>&gt;<i> cache_mem 738 MB
</I>&gt;<i> 
</I>&gt;<i> cache_dir aufs /cache/sdb 228138269 16 256 min-size=1 max-size=838860800
</I>&gt;<i> 
</I>
This cache_dir configuration needs approximately 3.2 TB of RAM on the
machine just to store the cache index.

Squid can store 2^25-1 objects safely in each cache_dir. To fully use
228 TB the objects must be of minimum size 6.8 MB each.

cache_dir aufs /cache/sdb 228138269 16 256 \
min-size=7130317 max-size=838860800

Which will only need a few GB to store the index.

And you will then need to store the under 8 MB objects either in a rock
cache or memory:

maximum_object_size_in_memory 8 MB



&gt;<i> buffered_logs off
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_persistent_connections on
</I>&gt;<i> icap_preview_enable off
</I>&gt;<i> 
</I>&gt;<i> icap_206_enable off
</I>&gt;<i> 
</I>&gt;<i> icap_service service_reqmod  reqmod_precache  <A HREF="icap://127.0.0.1:50020/request">icap://127.0.0.1:50020/request</A>
</I>&gt;<i>  bypass=0 max-conn=100 ipv6=off
</I>&gt;<i> icap_service service_respmod respmod_precache <A HREF="icap://">icap://</A>
</I>&gt;<i> 127.0.0.1:50020/response bypass=0 max-conn=100 ipv6=off
</I>&gt;<i> 
</I>&gt;<i> acl html Content-Type -i html
</I>&gt;<i> adaptation_access service_respmod allow html
</I>&gt;<i> respmod_rep_header
</I>&gt;<i> adaptation_access service_reqmod allow all
</I>

NP: its pretty rare for people to be uploading HTML pages. I suspect
this service may not be doing what you expect. But thats just a guess.

&gt;<i> 
</I>&gt;<i> # DEFAULT REFRESH PATTERNS
</I>
NP: You are missing the <A HREF="ftp://">ftp://</A> and <A HREF="gopher://">gopher://</A> patterns. They are usually
good to store for more than the default 72hrs.

&gt;<i> refresh_pattern -i (/cgi-bin/|?)    0    0%        0
</I>
This pattern is wrong. Should be:
  (/cgi-bin/|\?)

&gt;<i> refresh_pattern .                    0   20%     4320
</I>&gt;<i> 
</I>&gt;<i> acl queries url_regex -i <A HREF="http://.*\?.*">http://.*\?.*</A>
</I>&gt;<i> acl queries url_regex -i <A HREF="http://.*/cgi-bin/.*">http://.*/cgi-bin/.*</A>
</I>&gt;<i> 
</I>&gt;<i> cache deny queries
</I>&gt;<i> cache allow all
</I>
NP: This &quot;queries&quot; stuff is obsolete. The refresh_pattern handles
correct caching requirements in the current Squid versions.

&gt;<i> 
</I>&gt;<i> client_persistent_connections on
</I>&gt;<i> server_persistent_connections on
</I>&gt;<i> 
</I>&gt;<i> debug_options ALL,0
</I>&gt;<i> 
</I>&gt;<i> I see the (squid-1) process RAM use slowly increasing. It's never going
</I>&gt;<i> down. Ultil squid cannot allocate more memory and crashes.
</I>&gt;<i> 
</I>&gt;<i> Could be the icap client functionality ?
</I>
Unlikely.

Your config says the machine has 16 GB of RAM, but the config settings
for buffering client connections and caching will use up to 3.3 TB of
RAM when your Squid reaches full operational use.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005494.html">[squid-users] Possible memory leak?
</A></li>
	<LI>Next message (by thread): <A HREF="005499.html">[squid-users] high volume of 'missing files' in	cache....TCP_SWAPFAIL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5497">[ date ]</a>
              <a href="thread.html#5497">[ thread ]</a>
              <a href="subject.html#5497">[ subject ]</a>
              <a href="author.html#5497">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
