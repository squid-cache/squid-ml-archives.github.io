<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Lots of &quot;Vary object loop!&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Lots%20of%20%22Vary%20object%20loop%21%22&In-Reply-To=%3C55F7F4E1.4060603%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005508.html">
   <LINK REL="Next"  HREF="005513.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Lots of &quot;Vary object loop!&quot;</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Lots%20of%20%22Vary%20object%20loop%21%22&In-Reply-To=%3C55F7F4E1.4060603%40treenet.co.nz%3E"
       TITLE="[squid-users] Lots of &quot;Vary object loop!&quot;">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 15 10:37:21 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005508.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="005513.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5512">[ date ]</a>
              <a href="thread.html#5512">[ thread ]</a>
              <a href="subject.html#5512">[ subject ]</a>
              <a href="author.html#5512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/09/2015 9:16 a.m., Sebasti&#225;n Goicochea wrote:
&gt;<i> I could finally isolate the problem, it only happens if you are using
</I>&gt;<i> collapsed_forwarding.
</I>&gt;<i> 
</I>&gt;<i> If you want, you can use this script to replicate it:
</I>&gt;<i> 
</I>&gt;<i> #!/bin/bash
</I>&gt;<i> H='--header'
</I>&gt;<i> 
</I>&gt;<i> echo &quot;With Firefox&quot;
</I>&gt;<i> wget -d  \
</I>&gt;<i> $H='Accept:
</I>&gt;<i> text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' \
</I>&gt;<i> $H='Accept-Encoding: gzip, deflate' \
</I>&gt;<i> $H='Accept-Language: en-us,en;q=0.5' \
</I>&gt;<i> $H='Cache-Control: max-age=0' \
</I>&gt;<i> $H='Connection: keep-alive' \
</I>&gt;<i> -U 'Mozilla/5.0 (Windows NT 5.1; rv:10.0.2) Gecko/20100101
</I>&gt;<i> Firefox/10.0.2' \
</I>&gt;<i> -O /dev/null \
</I>&gt;<i>  $1
</I>&gt;<i> 
</I>&gt;<i> echo &quot;With Chrome&quot;
</I>&gt;<i> wget -d  \
</I>&gt;<i> $H='Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'\
</I>&gt;<i> 
</I>&gt;<i> $H='Accept-Charset:ISO-8859-1,utf-8;q=0.7,*;q=0.3'\
</I>&gt;<i> $H='Accept-Encoding:gzip,deflate,sdch'\
</I>&gt;<i> $H='Accept-Language:es-ES,es;q=0.8'\
</I>&gt;<i> $H='Cache-Control:no-cache'\
</I>&gt;<i> $H='Connection:keep-alive'\
</I>&gt;<i> $H='Pragma:no-cache'\
</I>&gt;<i> -U 'User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.32
</I>&gt;<i> (KHTML, like Gecko) Chrome/27.0.1425.0 Safari/537.32 SUSE/27.0.1425.0'\
</I>&gt;<i> -O /dev/null \
</I>&gt;<i>  $1
</I>&gt;<i> # End of script
</I>&gt;<i> 
</I>&gt;<i> script usage: ./wgets.sh
</I>&gt;<i> <A HREF="http://www.clarin.com/external-images/GranDTUnificada_5729dd7a1487678526c23516a5083661.jpg">http://www.clarin.com/external-images/GranDTUnificada_5729dd7a1487678526c23516a5083661.jpg</A>
</I>&gt;<i> 
</I>
That script is not doing what you think it is.

The requests are being made in series with the first one finishing
before the second starts. Your access.log timing confirms that with a
whole 18ms between the two requests.

So I dont think this script is actually triggering the collapsed
forwarding behaviour. Or it should not be if it is.


Also, look closely for the &quot;\r\n&quot; between headers.

[User-Agent: Wget/1.12
&gt;<i> (linux-gnu)\r\nAccept:
</I>&gt;<i> text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8--header=Accept-Charset:ISO-8859-1,utf-8;q=0.7,*;q=0.3--header=Accept-Encoding:gzip,deflate,sdch--header=Accept-Language:es-ES,es;q=0.8--header=Cache-Control:no-cache--header=Connection:keep-alive--header=Pragma:no-cache-U\r\nHost:
</I>&gt;<i> www.clarin.com\r\nConnection: Keep-Alive\r\n]
</I>

&gt;<i> cache.log output:
</I>&gt;<i> 2015/09/14 14:05:01 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/09/14 14:05:27 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt,
</I>&gt;<i> '<A HREF="http://www.clarin.com/external-images/GranDTUnificada_5729dd7a1487678526c23516a5083661.jpg">http://www.clarin.com/external-images/GranDTUnificada_5729dd7a1487678526c23516a5083661.jpg</A>'
</I>&gt;<i> 'accept-encoding=&quot;gzip,%20deflate&quot;,
</I>&gt;<i> user-agent=&quot;Mozilla%2F5.0%20(Windows%20NT%205.1%3B%20rv%3A10.0.2)%20Gecko%2F20100101%20Firefox%2F10.0.2&quot;'
</I>&gt;<i> 
</I>&gt;<i> 2015/09/14 14:05:27 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 2015/09/14 14:05:27 kid1| varyEvaluateMatch: Oops. Not a Vary match on
</I>&gt;<i> second attempt,
</I>&gt;<i> '<A HREF="http://www.clarin.com/external-images/GranDTUnificada_5729dd7a1487678526c23516a5083661.jpg">http://www.clarin.com/external-images/GranDTUnificada_5729dd7a1487678526c23516a5083661.jpg</A>'
</I>&gt;<i> 'accept-encoding, user-agent=&quot;Wget%2F1.12%20(linux-gnu)&quot;'
</I>&gt;<i> 2015/09/14 14:05:27 kid1| clientProcessHit: Vary object loop!
</I>&gt;<i> 
</I>
&gt;<i> 
</I>&gt;<i> What do you think? Is this the expected behaviour?
</I>&gt;<i> 
</I>
There is something slightly odd. I'm not sure if its wrong exactly, but
definitely odd.


Its not clear if the cache.log output is from the first or second
request. I assume (big IF) that above cache.log is the first one finding
some prior Firefox entry, then the second one finding the first ones entry.

Its very weird that the second one gets &quot;Not a Vary match&quot;. The lookups
should have been the same regardless of your script breakage.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005508.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="005513.html">[squid-users] Lots of &quot;Vary object loop!&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5512">[ date ]</a>
              <a href="thread.html#5512">[ thread ]</a>
              <a href="subject.html#5512">[ subject ]</a>
              <a href="author.html#5512">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
