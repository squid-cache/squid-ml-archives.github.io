<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid fails to pass on HEAD requests to parent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20fails%20to%20pass%20on%20HEAD%20requests%20to%20parent&In-Reply-To=%3CCAC-dDpA2L_gYqMaNrWG9Lm4Vx0_%2B9tOcK5vsa4HQrqwO40C_yA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005606.html">
   <LINK REL="Next"  HREF="005515.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid fails to pass on HEAD requests to parent</H1>
    <B>Martin Dietze</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20fails%20to%20pass%20on%20HEAD%20requests%20to%20parent&In-Reply-To=%3CCAC-dDpA2L_gYqMaNrWG9Lm4Vx0_%2B9tOcK5vsa4HQrqwO40C_yA%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid fails to pass on HEAD requests to parent">mdietze at gmail.com
       </A><BR>
    <I>Tue Sep 15 15:18:03 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005606.html">[squid-users] Database dilema
</A></li>
        <LI>Next message (by thread): <A HREF="005515.html">[squid-users] Squid fails to pass on HEAD requests to parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5514">[ date ]</a>
              <a href="thread.html#5514">[ thread ]</a>
              <a href="subject.html#5514">[ subject ]</a>
              <a href="author.html#5514">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In our network we are behind a proxy that I don't have access to. In order
to speed up deployments and development I am trying to set up a caching
squid proxy for yum and maven repositories.
Naturally, this proxy needs to be configured to use our company's global
proxy as parent.

I have successfully set it up to the point where it works when e.g.
downloading files using wget. However when using it with an actual maven
build, the build hangs when trying to download pom or jar files.

After having increased the log level I found out that my squid does not use
the parent proxy in such cases, and tries to connect to the internet which
is not possible since we can only connect through the global proxy.
A closer look at the logs revealed that maven issued HEAD instead of GET
requests in my case. I could hence reproduce the problem without maven
using this command line:

curl -I
&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>

In this example we would normally get a 404 (maven tries out a configured
list of servers to find a particular resource), however the same problem
applies with existing resources.

To me it seems like my squid does not understand it needs to use the global
proxy for HEAD requests as well as for GET. But I could not find any
reference to this particular problem anywhere in the web.

I've appended all information that seems relevant below. Now I would really
like to know: what am I doing wrong?

Cheers,

Martin

*Appendix: system information, log messages and configuration.*

I am using squid 3.1.23 on an Oracle Linux 6.7 system (an RHEL6 variant). I
have reproduced the same problem on an Oracle Linux 7.1 system with squid
3.5.3 with basically the same configuration.

Here's a snippet of what I find in the log after such an unsuccessful
request:

2015/09/15 12:29:06.364| peerSelectFoo: 'HEAD repo.springsource.org'
&gt;<i> 2015/09/15 12:29:06.364| peerSelectFoo: direct = DIRECT_MAYBE
</I>&gt;<i> 2015/09/15 12:29:06.364| peerSelectIcpPing:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>&gt;<i> 2015/09/15 12:29:06.364| peerAddFwdServer: adding DIRECT DIRECT
</I>&gt;<i> 2015/09/15 12:29:06.364| peerSelectCallback:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>&gt;<i> 2015/09/15 12:29:06.364| cbdataReferenceValid: 0x7fa2dbf5f3c8
</I>&gt;<i> 2015/09/15 12:29:06.364| cbdataUnlock: 0x7fa2dbf5f3c8=1
</I>&gt;<i> 2015/09/15 12:29:06.364| fwdStartComplete:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>&gt;<i> 2015/09/15 12:29:06.364| fwdConnectStart:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>&gt;<i> 2015/09/15 12:29:06.364| PconnPool::key(repo.springsource.org,80,(no
</I>&gt;<i> domain),[::]is {repo.springsource.org:80}
</I>

In contrast, when I issue the above command without '-I', I get a different
log output:

2015/09/15 12:32:54.348| peerSelectFoo: 'GET repo.springsource.org'
&gt;<i> 2015/09/15 12:32:54.348| peerSelectFoo: direct = DIRECT_MAYBE
</I>&gt;<i> 2015/09/15 12:32:54.348| peerDigestLookup: peer proxy.local.lan
</I>&gt;<i> 2015/09/15 12:32:54.348| peerDigestLookup: gone!
</I>&gt;<i> 2015/09/15 12:32:54.348| neighborsDigestSelect: choices: 0 (0)
</I>&gt;<i> 2015/09/15 12:32:54.348| peerNoteDigestLookup: peer &lt;none&gt;, lookup:
</I>&gt;<i> LOOKUP_NONE
</I>&gt;<i> 2015/09/15 12:32:54.348| peerSelectIcpPing:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>&gt;<i> 2015/09/15 12:32:54.348| neighborsCount: 0
</I>&gt;<i> 2015/09/15 12:32:54.348| peerSelectIcpPing: counted 0 neighbors
</I>&gt;<i> 2015/09/15 12:32:54.348| peerGetSomeParent: GET repo.springsource.org
</I>&gt;<i> 2015/09/15 12:32:54.348| neighbors.cc(339) getRoundRobinParent: returning
</I>&gt;<i> NULL
</I>&gt;<i> 2015/09/15 12:32:54.348| getWeightedRoundRobinParent: returning NULL
</I>&gt;<i> 2015/09/15 12:32:54.348| neighborUp: UP (no-query): proxy.local.lan (
</I>&gt;<i> 172.16.8.250:3130)
</I>&gt;<i> 2015/09/15 12:32:54.348| neighborUp: UP (no-query): proxy.local.lan (
</I>&gt;<i> 172.16.8.250:3130)
</I>&gt;<i> 2015/09/15 12:32:54.348| getFirstUpParent: returning proxy.local.lan
</I>&gt;<i> 2015/09/15 12:32:54.348| peerSelect: FIRST_UP_PARENT/proxy.local.lan
</I>&gt;<i> 2015/09/15 12:32:54.348| peerAddFwdServer: adding
</I>&gt;<i> proxy.local.lan FIRST_UP_PARENT
</I>&gt;<i> 2015/09/15 12:32:54.348| cbdataLock: 0x7fa2dbca0d58=1
</I>&gt;<i> 2015/09/15 12:32:54.348| peerAddFwdServer: adding DIRECT DIRECT
</I>&gt;<i> 2015/09/15 12:32:54.348| peerSelectCallback:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>&gt;<i> 2015/09/15 12:32:54.348| cbdataReferenceValid: 0x7fa2dbf5f3c8
</I>&gt;<i> 2015/09/15 12:32:54.348| cbdataUnlock: 0x7fa2dbf5f3c8=1
</I>&gt;<i> 2015/09/15 12:32:54.348| fwdStartComplete:
</I>&gt;<i> <A HREF="http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom">http://repo.springsource.org/snapshot/org/springframework/boot/spring-boot-starter-parent/1.2.2.RELEASE/spring-boot-starter-parent-1.2.2.RELEASE.pom</A>
</I>

As we see, in the second example the parent proxy is used, while in the
first it is not (and hence trying to connect repo.springsource.org fails).

Here is what I changed to the default configuration:

#acl localnet src 172.16.0.0/12 # RFC1918 possible internal network
&gt;<i> #acl localnet src 192.168.0.0/16        # RFC1918 possible internal
</I>&gt;<i> network
</I>&gt;<i> [...]
</I>
cache_dir ufs /var/cache/squid 1000 16 256
&gt;<i>
</I>[...]

cache_mem 64 MB
&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_store_log /var/log/squid/store.log
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> emulate_httpd_log on
</I>&gt;<i> debug_options ALL,10
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> cache_peer proxy.dermalog.hh parent 3128 3130 no-query no-digest
</I>&gt;<i> no-netdb-exchange
</I>&gt;<i> prefer_direct off
</I>





-- 
---------- <A HREF="https://lists.squid-cache.org/listinfo/squid-users">MDietze at gmail.com</A> --/-- <A HREF="https://lists.squid-cache.org/listinfo/squid-users">martin at the-little-red-haired-girl.org</A>
----
------------- / <A HREF="http://herbert.the-little-red-haired-girl.org">http://herbert.the-little-red-haired-girl.org</A> /
-------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20150915/ea915047/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20150915/ea915047/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005606.html">[squid-users] Database dilema
</A></li>
	<LI>Next message (by thread): <A HREF="005515.html">[squid-users] Squid fails to pass on HEAD requests to parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5514">[ date ]</a>
              <a href="thread.html#5514">[ thread ]</a>
              <a href="subject.html#5514">[ subject ]</a>
              <a href="author.html#5514">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
