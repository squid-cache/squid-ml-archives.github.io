<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] kinda confused about Peek and Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kinda%20confused%20about%20Peek%20and%20Splice&In-Reply-To=%3C55FAD9A5.7040309%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005566.html">
   <LINK REL="Next"  HREF="005593.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] kinda confused about Peek and Splice</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kinda%20confused%20about%20Peek%20and%20Splice&In-Reply-To=%3C55FAD9A5.7040309%40measurement-factory.com%3E"
       TITLE="[squid-users] kinda confused about Peek and Splice">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 17 15:17:57 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005566.html">[squid-users] kinda confused about Peek and Splice
</A></li>
        <LI>Next message (by thread): <A HREF="005593.html">[squid-users] kinda confused about Peek and Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5576">[ date ]</a>
              <a href="thread.html#5576">[ thread ]</a>
              <a href="subject.html#5576">[ subject ]</a>
              <a href="author.html#5576">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/17/2015 04:00 AM, Marek Serafin wrote:
&gt;<i> Hello, I'm kinda confused about the &quot;Peek and Splice&quot; technique
</I>&gt;<i> introduced in Squid 3.5.x.
</I>&gt;<i> ----------------------
</I>&gt;<i> My goal is to allow CONNECT-method ONLY to certain web-pages (mainly
</I>&gt;<i> banks, payment systems). The rest of https-sites should be allways bumped.
</I>&gt;<i> ---------------------
</I>&gt;<i> And this can be easily achieved even in squid 3.3 (I'm talking about
</I>&gt;<i> situation where browser is totally aware of using proxy server -- not
</I>&gt;<i> transparent mode).
</I>&gt;<i> 
</I>&gt;<i> But when Squid allows CONNECT method - it allows any kind of TCP tunnel
</I>&gt;<i> (e.g. OpenVPN over TCP or ssh tunnel).
</I>&gt;<i> 
</I>&gt;<i> So, my real question is - if it's possible - using the new technique
</I>&gt;<i> (Peek and Splice) to allow Splice method - but ONLY to real HTTPS Sites
</I>&gt;<i>  - not a ssh or VPN service?
</I>
The short answer to your question is &quot;when splicing, it is only possible
to check whether the service is using SSL&quot;. Here are the details:

* Peeking or staring at step1 results in Squid parsing the client SSL
Hello. This does not guarantee that the client is an HTTPS client, but
it virtually guarantees that it is an SSL client.

* Peeking or staring at step2 results in Squid validating the server
certificate. This does not guarantee that the server is an HTTPS server,
but it virtually guarantees that it is an SSL server.

* Beyond step2, you have to bump to check that the SSL client and the
SSL server are going to talk HTTP after CONNECT and SSL handshake. There
is and will be no way around that. Staring allows you to bump if that is
what you want.

... where &quot;X at stepN&quot; means &quot;action X matched at SslBump step #N&quot;.


However, your question seems to contradict your goal of splicing
connections to &quot;certain&quot; known servers and only to those servers: If you
know that example.com is a trusted bank, do you really need to check
that nobody is creating an ssh connection to that bank? If not, then
validating &quot;bank&quot; traffic beyond SSL handshake becomes irrelevant. You
simply trust the &quot;bank&quot; not to provide any &quot;bad&quot; services.


&gt;<i> (I'm still talking about the situation where browsers are aware of
</I>&gt;<i> proxying)
</I>
Browser awareness does not really matter as far as non-HTTP detection is
concerned.


&gt;<i> I was thinking that it can be done by peeking in step 2 (peeing the
</I>&gt;<i> server certificate) BUT there is a limitation: peeking at the server
</I>&gt;<i> certificate usually precludes future bumping. So when we're peeking at
</I>&gt;<i> step 2 we can only splice later (or terminate) - which is not what I
</I>&gt;<i> wanted to achieve.
</I>
You do not need to bump to validate the server certificate (and, hence,
confirm that it is a known-to-you &quot;bank&quot;). If you want to bump, you can
stare instead of peeking.


&gt;<i> what is the main advantage of &quot;Peek and
</I>&gt;<i> Splice&quot; comparing to old method (remember: browsers are aware of proxying).
</I>&gt;<i> I can see advantage in transparent mode  - obtaining domain name by SNI.
</I>&gt;<i> But in &quot;normal mode&quot; squid knows the domain-name because of the connect
</I>&gt;<i> request?
</I>
In some cases, the CONNECT request contains an IP address instead of a
domain name.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005566.html">[squid-users] kinda confused about Peek and Splice
</A></li>
	<LI>Next message (by thread): <A HREF="005593.html">[squid-users] kinda confused about Peek and Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5576">[ date ]</a>
              <a href="thread.html#5576">[ thread ]</a>
              <a href="subject.html#5576">[ subject ]</a>
              <a href="author.html#5576">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
