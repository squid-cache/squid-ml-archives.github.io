<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] kinda confused about Peek and Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kinda%20confused%20about%20Peek%20and%20Splice&In-Reply-To=%3C55FDE552.9040406%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005596.html">
   <LINK REL="Next"  HREF="005579.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] kinda confused about Peek and Splice</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kinda%20confused%20about%20Peek%20and%20Splice&In-Reply-To=%3C55FDE552.9040406%40measurement-factory.com%3E"
       TITLE="[squid-users] kinda confused about Peek and Splice">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Sep 19 22:44:34 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005596.html">[squid-users] kinda confused about Peek and Splice
</A></li>
        <LI>Next message (by thread): <A HREF="005579.html">[squid-users] squid 3.5.7 for Windows (from Diladele) and kerberos	auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5598">[ date ]</a>
              <a href="thread.html#5598">[ thread ]</a>
              <a href="subject.html#5598">[ subject ]</a>
              <a href="author.html#5598">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/19/2015 10:19 AM, Marek Serafin wrote:
&gt;&gt;&gt;<i> acl nobumpSites ssl::server_name &quot;/etc/squid3/allowed_SSL_sites.txt&quot;
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump splice step2 nobumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>
&gt;&gt;<i> I do not see the reason for the &quot;step2&quot; ACL in the above. Do you?
</I>
&gt;<i> it should be either &quot;ssl_bump splice nobumpSites&quot;
</I>
Yes, that version makes sense to me if you want to splice based on
client-provided info such as SNI (and not based on any server-provided
info).


&gt;<i> or peek at step 2 and
</I>&gt;<i> splice it at step 3, right?  (depending on how deep we want to check) e.g:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 nobumpSites
</I>&gt;<i> ssl_bump splice step3 nobumpSites
</I>&gt;<i> ssl_bump bump all
</I>

Writing &quot;all&quot; after any other ACL should not be needed. It only wastes
CPU cycles (Squid currently does not optimize this case).

In recent Squids, writing &quot;step2&quot; in &quot;peek step2&quot; _after_ &quot;peek step1&quot;
is not needed: &quot;peek step1&quot; will always match during step1 so the second
peek rule will not get executed during step1. No &quot;peek&quot; rule can match
during step3. Thus, the second peek rule will be automatically
restricted to step2.

If you combine the above, you get:

  ssl_bump peek step1
  ssl_bump peek nobumpSites
  ssl_bump splice step3 nobumpSites
  ssl_bump bump all

The above can be simplified further because if the transaction does not
match nobumpSites at step2, then the last rule will match and the
transaction will be bumped. Thus, only nobumpSites transactions will get
to step3 and we can remove the nobumpSites restriction from that step
(besides, it would be too late to bump at step3 anyway):

  ssl_bump peek step1
  ssl_bump peek nobumpSites
  ssl_bump splice step3
  ssl_bump bump all

Furthermore, _if_ you do not need the side-effects (e.g., server
certificate validation) of getting to step3 for nobumpSites, then you
may splice during step2:

  ssl_bump peek step1
  ssl_bump splice nobumpSites
  ssl_bump bump all

which is actually the same as the other configuration you have considered!..


&gt;<i> I got it! I was thinking all the time that action taken at step 1 and
</I>&gt;<i> step 2 (peeking or staring) is common to all connections. That's why I
</I>&gt;<i> considered peeking at step 2 as useless because if server_name will not
</I>&gt;<i> match the whitelist (majority of webpages) it would be impossible to
</I>&gt;<i> bump the connection. And that are separate rules!!! like this:
</I>&gt;<i> 
</I>&gt;<i> ## peeking at first step is mostly/always good idea (to get the SNI)
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i> # we want to check deeply what we're gonna splice
</I>&gt;<i> ssl_bump peek step2 nobumpSites
</I>&gt;<i> ssl_bump splice step3 nobumpSites
</I>&gt;<i> 
</I>&gt;<i> ### we're bumping the rest. Fake cert will be generated
</I>&gt;<i> ### based on server's cert (that's why we want to bump at step 3)
</I>&gt;<i> ssl_bump stare step2 all
</I>&gt;<i> ssl_bump bump step3 all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Does it make some sense?
</I>
Yes, but it can be simplified using reasoning similar to the one I
provided above.


Cheers,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005596.html">[squid-users] kinda confused about Peek and Splice
</A></li>
	<LI>Next message (by thread): <A HREF="005579.html">[squid-users] squid 3.5.7 for Windows (from Diladele) and kerberos	auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5598">[ date ]</a>
              <a href="thread.html#5598">[ thread ]</a>
              <a href="subject.html#5598">[ subject ]</a>
              <a href="author.html#5598">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
