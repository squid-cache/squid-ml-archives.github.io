<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] help with acl order and deny_info pages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C55FE7FBE.2070905%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005564.html">
   <LINK REL="Next"  HREF="005674.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] help with acl order and deny_info pages</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C55FE7FBE.2070905%40treenet.co.nz%3E"
       TITLE="[squid-users] help with acl order and deny_info pages">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Sep 20 09:43:26 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005564.html">[squid-users] help with acl order and deny_info pages
</A></li>
        <LI>Next message (by thread): <A HREF="005674.html">[squid-users] help with acl order and deny_info pages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5603">[ date ]</a>
              <a href="thread.html#5603">[ thread ]</a>
              <a href="subject.html#5603">[ subject ]</a>
              <a href="author.html#5603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/09/2015 7:24 p.m., Marko Cupa&#263; wrote:
&gt;<i> On Thu, 17 Sep 2015 03:00:56 +1200
</I>&gt;<i> Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 17/09/2015 12:37 a.m., Marko Cupa&#263; wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm trying to setup squid in a way that it authenticates users via
</I>&gt;&gt;&gt;<i> kerberos and grants different levels of web access according to ldap
</I>&gt;&gt;&gt;<i> query of MS AD groups.After some trials and errors I have found acl
</I>&gt;&gt;&gt;<i> order which apparently does not trigger reauthentication (auth
</I>&gt;&gt;&gt;<i> dialogues in browsers although I don't even provide basic auth).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What makes you think browser dialog box has anything to do with Basic
</I>&gt;&gt;<i> auth? All it means is that the browser does not know what credentials
</I>&gt;&gt;<i> will work. The ones tried (if any) have been rejected with a challenge
</I>&gt;&gt;<i> response (401/407) for valid ones. It may be the browser password
</I>&gt;&gt;<i> manager.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are using only Kerberos auth then users enter their Kerberos
</I>&gt;&gt;<i> username and password into the dialog to allow the browser to fetch
</I>&gt;&gt;<i> the Kerberos token (or keytab entry) it needs to send to Squid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's relevant part:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;<i> http_access deny !auth all
</I>&gt;&gt;&gt;<i> http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;&gt;&gt;<i> http_reply_access allow !basic_mimetypes basic_users
</I>&gt;&gt;&gt;<i> http_access allow !advanced_domains !advanced_extensions
</I>&gt;&gt;&gt;<i> advanced_users http_access allow expert_users all
</I>&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'd like to know which acl triggered the ban, so I've created custom
</I>&gt;&gt;&gt;<i> error page:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> error_directory /usr/local/etc/squid/myerrors
</I>&gt;&gt;&gt;<i> deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The problem is that my custom error page does not trigger when I
</I>&gt;&gt;&gt;<i> expect it to (member of basic_users accessing URL with extension
</I>&gt;&gt;&gt;<i> listed in basic_extensions) - ERR_ACCESS_DENIED is triggered
</I>&gt;&gt;&gt;<i> instead. I guess this is because of last matching rule which is
</I>&gt;&gt;&gt;<i> http_access deny all.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Perhapse.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But, basic_extensions is never the last listed ACL in a denial rule.
</I>&gt;&gt;<i> There is never a deny action associated with the ACL. That is why the
</I>&gt;&gt;<i> deny_info response template is not being used.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is there another way how I can order acls so that I don't trigger
</I>&gt;&gt;&gt;<i> reauthentication while triggering deny_info?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not without the ACL definition details.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> thank you for looking into this. Here's complete squid.conf (I changed
</I>&gt;<i> just private details such as domain, DN, password etc. in
</I>&gt;<i> external_acl_type).
</I>&gt;<i> 
</I>
&lt;snip'ing bits of config not relevant to the answer&gt;

&gt;<i> auth_param negotiate program /usr/local/libexec/squid/negotiate_kerberos_auth \
</I>&gt;<i> 	-r -s GSS_C_NO_NAME
</I>&lt;snip&gt;
&gt;<i> # ldap query for group membership
</I>&gt;<i> external_acl_type adgroups ttl=60 children-startup=2 children-max=10 %LOGIN \
</I>&gt;<i> 	/usr/local/libexec/squid/ext_ldap_group_acl -R \
</I>&lt;snip&gt;


These ACLs...

&gt;<i> # map ldap groups to squid acls
</I>&gt;<i> acl basic_users external adgroups squid_basic
</I>&gt;<i> acl advanced_users external adgroups squid_advanced
</I>&gt;<i> acl expert_users external adgroups squid_expert
</I>
... to here ...


&lt;snip&gt;
&gt;<i> # require proxy authentication
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>
... and the &quot;auth&quot; one will all trigger 407 challenges *if* they are the
last ACL on the line. Or if there are no credentials of any kind given
in the request.


&gt;<i> 
</I>&gt;<i> # custom error pages
</I>&gt;<i> deny_info ERR_BASIC_DOMAIN basic_domains
</I>&gt;<i> deny_info ERR_ADVANCED_DOMAIN advanced_domains
</I>&gt;<i> deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;<i> deny_info ERR_ADVANCED_EXTENSION advanced_extensions
</I>&gt;<i> 
</I>&lt;snip&gt;
&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> http_access deny !auth all
</I>
Problem #1:
 Any client with halfway decent security will not simply broadcast
credentials on their first request of a new TCP connection, but will
wait for a 407 challenge to indicate both their need and the type of
credentials to send.

The &quot;all&quot; on this line will prevent that 407 happening. Instead it will
simply produce a plain 403 ERR_ACCESS_DENIED for any request lacking
(Kerberos) credentials.

NP: you can test whether this is your problem with a custom error page:

 acl test1 src all
 deny_info 499:ERR_ACCESS_DENIED test1
 http_access deny !auth test1

Your access.log should show the 499 status when its line matches.


&gt;<i> http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;<i> http_access allow !advanced_domains !advanced_extensions advanced_users
</I>
Basically okay. These will trigger 407 *if* (and only if) the client
sent Negotiate/Kerberos credentials AND does not have group permission
to access the URL being requested.

Be aware this will probably produce the popups allowing users to change
their credentials to those of another user account with the right group
access. That may or may not be what you want.


I usually find that *these* lines are the ones people most want not to
popup. You have complex ACL tests so the order can be shuffled to this:

  http_access allow !basic_domains basic_users !basic_extensions
  http_access allow !advanced_domains advanced_users !advanced_extensions

Which prevents the popups from group checking.

If you still want to retain the helper load reduction from having the
extension test first, then append &quot; all&quot; to each of those lines instead
of shuffling.


&gt;<i> http_access allow expert_users all
</I>

&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
Problem 2:

Requests which somehow happen to get past the &quot;deny !auth all&quot; rule but
not have a domain listed in your *_domains ACLs or _do_ match the paired
*_extensions ACLs - will get denied by this final rule.

NP: you can test that like the earlier test, but use a different ACL
name and 49x status code.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005564.html">[squid-users] help with acl order and deny_info pages
</A></li>
	<LI>Next message (by thread): <A HREF="005674.html">[squid-users] help with acl order and deny_info pages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5603">[ date ]</a>
              <a href="thread.html#5603">[ thread ]</a>
              <a href="subject.html#5603">[ subject ]</a>
              <a href="author.html#5603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
