<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] help with acl order and deny_info pages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C20150924093000.03146a3d%40efreet.kappastar.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005603.html">
   <LINK REL="Next"  HREF="005675.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] help with acl order and deny_info pages</H1>
    <B>Marko Cupa&#263;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C20150924093000.03146a3d%40efreet.kappastar.com%3E"
       TITLE="[squid-users] help with acl order and deny_info pages">marko.cupac at mimar.rs
       </A><BR>
    <I>Thu Sep 24 07:30:00 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005603.html">[squid-users] help with acl order and deny_info pages
</A></li>
        <LI>Next message (by thread): <A HREF="005675.html">[squid-users] help with acl order and deny_info pages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5674">[ date ]</a>
              <a href="thread.html#5674">[ thread ]</a>
              <a href="subject.html#5674">[ subject ]</a>
              <a href="author.html#5674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 20 Sep 2015 21:43:26 +1200
Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 17/09/2015 7:24 p.m., Marko Cupa&#263; wrote:
</I>&gt;<i> &gt; On Thu, 17 Sep 2015 03:00:56 +1200
</I>&gt;<i> &gt; Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; On 17/09/2015 12:37 a.m., Marko Cupa&#263; wrote:
</I>&gt;<i> &gt;&gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I'm trying to setup squid in a way that it authenticates users via
</I>&gt;<i> &gt;&gt;&gt; kerberos and grants different levels of web access according to
</I>&gt;<i> &gt;&gt;&gt; ldap query of MS AD groups.After some trials and errors I have
</I>&gt;<i> &gt;&gt;&gt; found acl order which apparently does not trigger
</I>&gt;<i> &gt;&gt;&gt; reauthentication (auth dialogues in browsers although I don't
</I>&gt;<i> &gt;&gt;&gt; even provide basic auth).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; What makes you think browser dialog box has anything to do with
</I>&gt;<i> &gt;&gt; Basic auth? All it means is that the browser does not know what
</I>&gt;<i> &gt;&gt; credentials will work. The ones tried (if any) have been rejected
</I>&gt;<i> &gt;&gt; with a challenge response (401/407) for valid ones. It may be the
</I>&gt;<i> &gt;&gt; browser password manager.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If you are using only Kerberos auth then users enter their Kerberos
</I>&gt;<i> &gt;&gt; username and password into the dialog to allow the browser to fetch
</I>&gt;<i> &gt;&gt; the Kerberos token (or keytab entry) it needs to send to Squid.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Here's relevant part:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access deny !Safe_ports
</I>&gt;<i> &gt;&gt;&gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i> &gt;&gt;&gt; http_access allow localhost manager
</I>&gt;<i> &gt;&gt;&gt; http_access deny manager
</I>&gt;<i> &gt;&gt;&gt; http_access deny to_localhost
</I>&gt;<i> &gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt;&gt;&gt; http_access deny !auth all
</I>&gt;<i> &gt;&gt;&gt; http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;<i> &gt;&gt;&gt; http_reply_access allow !basic_mimetypes basic_users
</I>&gt;<i> &gt;&gt;&gt; http_access allow !advanced_domains !advanced_extensions
</I>&gt;<i> &gt;&gt;&gt; advanced_users http_access allow expert_users all
</I>&gt;<i> &gt;&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt;&gt;&gt; http_access allow localhost
</I>&gt;<i> &gt;&gt;&gt; http_access deny all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I'd like to know which acl triggered the ban, so I've created
</I>&gt;<i> &gt;&gt;&gt; custom error page:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; error_directory /usr/local/etc/squid/myerrors
</I>&gt;<i> &gt;&gt;&gt; deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; The problem is that my custom error page does not trigger when I
</I>&gt;<i> &gt;&gt;&gt; expect it to (member of basic_users accessing URL with extension
</I>&gt;<i> &gt;&gt;&gt; listed in basic_extensions) - ERR_ACCESS_DENIED is triggered
</I>&gt;<i> &gt;&gt;&gt; instead. I guess this is because of last matching rule which is
</I>&gt;<i> &gt;&gt;&gt; http_access deny all.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Perhapse.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; But, basic_extensions is never the last listed ACL in a denial
</I>&gt;<i> &gt;&gt; rule. There is never a deny action associated with the ACL. That
</I>&gt;<i> &gt;&gt; is why the deny_info response template is not being used.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Is there another way how I can order acls so that I don't trigger
</I>&gt;<i> &gt;&gt;&gt; reauthentication while triggering deny_info?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Not without the ACL definition details.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Amos
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Hi Amos,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; thank you for looking into this. Here's complete squid.conf (I
</I>&gt;<i> &gt; changed just private details such as domain, DN, password etc. in
</I>&gt;<i> &gt; external_acl_type).
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> &lt;snip'ing bits of config not relevant to the answer&gt;
</I>&gt;<i> 
</I>&gt;<i> &gt; auth_param negotiate
</I>&gt;<i> &gt; program /usr/local/libexec/squid/negotiate_kerberos_auth \ -r -s
</I>&gt;<i> &gt; GSS_C_NO_NAME
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt; # ldap query for group membership
</I>&gt;<i> &gt; external_acl_type adgroups ttl=60 children-startup=2
</I>&gt;<i> &gt; children-max=10 %LOGIN
</I>&gt;<i> &gt; \ /usr/local/libexec/squid/ext_ldap_group_acl -R \
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> These ACLs...
</I>&gt;<i> 
</I>&gt;<i> &gt; # map ldap groups to squid acls
</I>&gt;<i> &gt; acl basic_users external adgroups squid_basic
</I>&gt;<i> &gt; acl advanced_users external adgroups squid_advanced
</I>&gt;<i> &gt; acl expert_users external adgroups squid_expert
</I>&gt;<i> 
</I>&gt;<i> ... to here ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt; # require proxy authentication
</I>&gt;<i> &gt; acl auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> ... and the &quot;auth&quot; one will all trigger 407 challenges *if* they are
</I>&gt;<i> the last ACL on the line. Or if there are no credentials of any kind
</I>&gt;<i> given in the request.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; # custom error pages
</I>&gt;<i> &gt; deny_info ERR_BASIC_DOMAIN basic_domains
</I>&gt;<i> &gt; deny_info ERR_ADVANCED_DOMAIN advanced_domains
</I>&gt;<i> &gt; deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;<i> &gt; deny_info ERR_ADVANCED_EXTENSION advanced_extensions
</I>&gt;<i> &gt; 
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt; http_access deny !auth all
</I>&gt;<i> 
</I>&gt;<i> Problem #1:
</I>&gt;<i>  Any client with halfway decent security will not simply broadcast
</I>&gt;<i> credentials on their first request of a new TCP connection, but will
</I>&gt;<i> wait for a 407 challenge to indicate both their need and the type of
</I>&gt;<i> credentials to send.
</I>&gt;<i> 
</I>&gt;<i> The &quot;all&quot; on this line will prevent that 407 happening. Instead it
</I>&gt;<i> will simply produce a plain 403 ERR_ACCESS_DENIED for any request
</I>&gt;<i> lacking (Kerberos) credentials.
</I>&gt;<i> 
</I>&gt;<i> NP: you can test whether this is your problem with a custom error
</I>&gt;<i> page:
</I>&gt;<i> 
</I>&gt;<i>  acl test1 src all
</I>&gt;<i>  deny_info 499:ERR_ACCESS_DENIED test1
</I>&gt;<i>  http_access deny !auth test1
</I>&gt;<i> 
</I>&gt;<i> Your access.log should show the 499 status when its line matches.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;<i> &gt; http_access allow !advanced_domains !advanced_extensions
</I>&gt;<i> &gt; advanced_users
</I>&gt;<i> 
</I>&gt;<i> Basically okay. These will trigger 407 *if* (and only if) the client
</I>&gt;<i> sent Negotiate/Kerberos credentials AND does not have group permission
</I>&gt;<i> to access the URL being requested.
</I>&gt;<i> 
</I>&gt;<i> Be aware this will probably produce the popups allowing users to
</I>&gt;<i> change their credentials to those of another user account with the
</I>&gt;<i> right group access. That may or may not be what you want.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I usually find that *these* lines are the ones people most want not to
</I>&gt;<i> popup. You have complex ACL tests so the order can be shuffled to
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i>   http_access allow !basic_domains basic_users !basic_extensions
</I>&gt;<i>   http_access allow !advanced_domains
</I>&gt;<i> advanced_users !advanced_extensions
</I>&gt;<i> 
</I>&gt;<i> Which prevents the popups from group checking.
</I>&gt;<i> 
</I>&gt;<i> If you still want to retain the helper load reduction from having the
</I>&gt;<i> extension test first, then append &quot; all&quot; to each of those lines
</I>&gt;<i> instead of shuffling.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; http_access allow expert_users all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> &gt; http_access allow localhost
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> Problem 2:
</I>&gt;<i> 
</I>&gt;<i> Requests which somehow happen to get past the &quot;deny !auth all&quot; rule
</I>&gt;<i> but not have a domain listed in your *_domains ACLs or _do_ match the
</I>&gt;<i> paired *_extensions ACLs - will get denied by this final rule.
</I>&gt;<i> 
</I>&gt;<i> NP: you can test that like the earlier test, but use a different ACL
</I>&gt;<i> name and 49x status code.
</I>
Amos,

I'm grateful for your help, but I'm even more confused now. I
changed http_access rules according to your advices, tried
different combinations, but I still can't achieve intended
behaviour. Perhaps I could try to better explain my goals, as maybe
there is a better way to solve what I'm trying to achieve.

I want to have 4 levels of web access:
expert access - if user is part of expert_users ad group
advanced access - if user is part of advanced_users AD group
basic access - if user is part of basic_users AD group
no access - if user is not part of any AD groups

Here's the difference in web access for groups:
expert access - allow all
advanced access - allow except some extensions and domains
basic access - allow except some more extensions and domains
no access - allow nothing

When a user is redirected to error page, there should be enough info
about error:
- user as seen by squid (or no user if not authenticated)
- group as seen by squid (or no group)
- acl that triggered the ban (not the last deny rule)

I'd really appreciate exact snippet of squid.conf which accomplishes
that, if possible.

Thank you in advance,
-- 
Before enlightenment - chop wood, draw water.
After  enlightenment - chop wood, draw water.

Marko Cupa&#263;
<A HREF="https://www.mimar.rs/">https://www.mimar.rs/</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005603.html">[squid-users] help with acl order and deny_info pages
</A></li>
	<LI>Next message (by thread): <A HREF="005675.html">[squid-users] help with acl order and deny_info pages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5674">[ date ]</a>
              <a href="thread.html#5674">[ thread ]</a>
              <a href="subject.html#5674">[ subject ]</a>
              <a href="author.html#5674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
