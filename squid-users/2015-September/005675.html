<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] help with acl order and deny_info pages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C5603D84B.1030803%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005674.html">
   <LINK REL="Next"  HREF="005541.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] help with acl order and deny_info pages</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20help%20with%20acl%20order%20and%20deny_info%20pages&In-Reply-To=%3C5603D84B.1030803%40treenet.co.nz%3E"
       TITLE="[squid-users] help with acl order and deny_info pages">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep 24 11:02:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005674.html">[squid-users] help with acl order and deny_info pages
</A></li>
        <LI>Next message (by thread): <A HREF="005541.html">[squid-users] after changed from 3.4.13 to 3.5.8 sslbump doesn't work for the site https://banking.postbank.de/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5675">[ date ]</a>
              <a href="thread.html#5675">[ thread ]</a>
              <a href="subject.html#5675">[ subject ]</a>
              <a href="author.html#5675">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/09/2015 7:30 p.m., Marko Cupa&#263; wrote:
&gt;<i> On Sun, 20 Sep 2015 21:43:26 +1200
</I>&gt;<i> Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 17/09/2015 7:24 p.m., Marko Cupa&#263; wrote:
</I>&gt;&gt;&gt;<i> On Thu, 17 Sep 2015 03:00:56 +1200
</I>&gt;&gt;&gt;<i> Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 17/09/2015 12:37 a.m., Marko Cupa&#263; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I'm trying to setup squid in a way that it authenticates users via
</I>&gt;&gt;&gt;&gt;&gt;<i> kerberos and grants different levels of web access according to
</I>&gt;&gt;&gt;&gt;&gt;<i> ldap query of MS AD groups.After some trials and errors I have
</I>&gt;&gt;&gt;&gt;&gt;<i> found acl order which apparently does not trigger
</I>&gt;&gt;&gt;&gt;&gt;<i> reauthentication (auth dialogues in browsers although I don't
</I>&gt;&gt;&gt;&gt;&gt;<i> even provide basic auth).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> What makes you think browser dialog box has anything to do with
</I>&gt;&gt;&gt;&gt;<i> Basic auth? All it means is that the browser does not know what
</I>&gt;&gt;&gt;&gt;<i> credentials will work. The ones tried (if any) have been rejected
</I>&gt;&gt;&gt;&gt;<i> with a challenge response (401/407) for valid ones. It may be the
</I>&gt;&gt;&gt;&gt;<i> browser password manager.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If you are using only Kerberos auth then users enter their Kerberos
</I>&gt;&gt;&gt;&gt;<i> username and password into the dialog to allow the browser to fetch
</I>&gt;&gt;&gt;&gt;<i> the Kerberos token (or keytab entry) it needs to send to Squid.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here's relevant part:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny !auth all
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;&gt;&gt;&gt;&gt;<i> http_reply_access allow !basic_mimetypes basic_users
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow !advanced_domains !advanced_extensions
</I>&gt;&gt;&gt;&gt;&gt;<i> advanced_users http_access allow expert_users all
</I>&gt;&gt;&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I'd like to know which acl triggered the ban, so I've created
</I>&gt;&gt;&gt;&gt;&gt;<i> custom error page:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> error_directory /usr/local/etc/squid/myerrors
</I>&gt;&gt;&gt;&gt;&gt;<i> deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The problem is that my custom error page does not trigger when I
</I>&gt;&gt;&gt;&gt;&gt;<i> expect it to (member of basic_users accessing URL with extension
</I>&gt;&gt;&gt;&gt;&gt;<i> listed in basic_extensions) - ERR_ACCESS_DENIED is triggered
</I>&gt;&gt;&gt;&gt;&gt;<i> instead. I guess this is because of last matching rule which is
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny all.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Perhapse.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> But, basic_extensions is never the last listed ACL in a denial
</I>&gt;&gt;&gt;&gt;<i> rule. There is never a deny action associated with the ACL. That
</I>&gt;&gt;&gt;&gt;<i> is why the deny_info response template is not being used.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Is there another way how I can order acls so that I don't trigger
</I>&gt;&gt;&gt;&gt;&gt;<i> reauthentication while triggering deny_info?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Not without the ACL definition details.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Amos,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> thank you for looking into this. Here's complete squid.conf (I
</I>&gt;&gt;&gt;<i> changed just private details such as domain, DN, password etc. in
</I>&gt;&gt;&gt;<i> external_acl_type).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;snip'ing bits of config not relevant to the answer&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> auth_param negotiate
</I>&gt;&gt;&gt;<i> program /usr/local/libexec/squid/negotiate_kerberos_auth \ -r -s
</I>&gt;&gt;&gt;<i> GSS_C_NO_NAME
</I>&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;&gt;<i> # ldap query for group membership
</I>&gt;&gt;&gt;<i> external_acl_type adgroups ttl=60 children-startup=2
</I>&gt;&gt;&gt;<i> children-max=10 %LOGIN
</I>&gt;&gt;&gt;<i> \ /usr/local/libexec/squid/ext_ldap_group_acl -R \
</I>&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These ACLs...
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # map ldap groups to squid acls
</I>&gt;&gt;&gt;<i> acl basic_users external adgroups squid_basic
</I>&gt;&gt;&gt;<i> acl advanced_users external adgroups squid_advanced
</I>&gt;&gt;&gt;<i> acl expert_users external adgroups squid_expert
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ... to here ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;&gt;<i> # require proxy authentication
</I>&gt;&gt;&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ... and the &quot;auth&quot; one will all trigger 407 challenges *if* they are
</I>&gt;&gt;<i> the last ACL on the line. Or if there are no credentials of any kind
</I>&gt;&gt;<i> given in the request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # custom error pages
</I>&gt;&gt;&gt;<i> deny_info ERR_BASIC_DOMAIN basic_domains
</I>&gt;&gt;&gt;<i> deny_info ERR_ADVANCED_DOMAIN advanced_domains
</I>&gt;&gt;&gt;<i> deny_info ERR_BASIC_EXTENSION basic_extensions
</I>&gt;&gt;&gt;<i> deny_info ERR_ADVANCED_EXTENSION advanced_extensions
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;<i> http_access deny !auth all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Problem #1:
</I>&gt;&gt;<i>  Any client with halfway decent security will not simply broadcast
</I>&gt;&gt;<i> credentials on their first request of a new TCP connection, but will
</I>&gt;&gt;<i> wait for a 407 challenge to indicate both their need and the type of
</I>&gt;&gt;<i> credentials to send.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The &quot;all&quot; on this line will prevent that 407 happening. Instead it
</I>&gt;&gt;<i> will simply produce a plain 403 ERR_ACCESS_DENIED for any request
</I>&gt;&gt;<i> lacking (Kerberos) credentials.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: you can test whether this is your problem with a custom error
</I>&gt;&gt;<i> page:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  acl test1 src all
</I>&gt;&gt;<i>  deny_info 499:ERR_ACCESS_DENIED test1
</I>&gt;&gt;<i>  http_access deny !auth test1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Your access.log should show the 499 status when its line matches.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow !basic_domains !basic_extensions basic_users
</I>&gt;&gt;&gt;<i> http_access allow !advanced_domains !advanced_extensions
</I>&gt;&gt;&gt;<i> advanced_users
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Basically okay. These will trigger 407 *if* (and only if) the client
</I>&gt;&gt;<i> sent Negotiate/Kerberos credentials AND does not have group permission
</I>&gt;&gt;<i> to access the URL being requested.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Be aware this will probably produce the popups allowing users to
</I>&gt;&gt;<i> change their credentials to those of another user account with the
</I>&gt;&gt;<i> right group access. That may or may not be what you want.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I usually find that *these* lines are the ones people most want not to
</I>&gt;&gt;<i> popup. You have complex ACL tests so the order can be shuffled to
</I>&gt;&gt;<i> this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access allow !basic_domains basic_users !basic_extensions
</I>&gt;&gt;<i>   http_access allow !advanced_domains
</I>&gt;&gt;<i> advanced_users !advanced_extensions
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Which prevents the popups from group checking.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you still want to retain the helper load reduction from having the
</I>&gt;&gt;<i> extension test first, then append &quot; all&quot; to each of those lines
</I>&gt;&gt;<i> instead of shuffling.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow expert_users all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Problem 2:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Requests which somehow happen to get past the &quot;deny !auth all&quot; rule
</I>&gt;&gt;<i> but not have a domain listed in your *_domains ACLs or _do_ match the
</I>&gt;&gt;<i> paired *_extensions ACLs - will get denied by this final rule.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: you can test that like the earlier test, but use a different ACL
</I>&gt;&gt;<i> name and 49x status code.
</I>&gt;<i> 
</I>&gt;<i> Amos,
</I>&gt;<i> 
</I>&gt;<i> I'm grateful for your help, but I'm even more confused now. I
</I>&gt;<i> changed http_access rules according to your advices, tried
</I>&gt;<i> different combinations, but I still can't achieve intended
</I>&gt;<i> behaviour. Perhaps I could try to better explain my goals, as maybe
</I>&gt;<i> there is a better way to solve what I'm trying to achieve.
</I>&gt;<i> 
</I>&gt;<i> I want to have 4 levels of web access:
</I>&gt;<i> expert access - if user is part of expert_users ad group
</I>&gt;<i> advanced access - if user is part of advanced_users AD group
</I>&gt;<i> basic access - if user is part of basic_users AD group
</I>&gt;<i> no access - if user is not part of any AD groups
</I>&gt;<i> 
</I>
Okay. Your ACLs are defined right for that.

 acl basic_users external adgroups squid_basic
 acl advanced_users external adgroups squid_advanced
 acl expert_users external adgroups squid_expert


&gt;<i> Here's the difference in web access for groups:
</I>&gt;<i> expert access - allow all
</I>&gt;<i> advanced access - allow except some extensions and domains
</I>&gt;<i> basic access - allow except some more extensions and domains
</I>&gt;<i> no access - allow nothing
</I>
Which is:

  # authentication required for any access at all
  http_access deny !auth

  # expert access - allow all
  http_access allow expert_users all

  # advanced access - allow except some extensions and domains
  http_access deny some_domains
  http_access deny some_extensions
  http_access allow advanced_users all

  # basic access - allow except some more extensions and domains
  http_access deny more_domains
  http_access deny more_extensions
  http_access allow basic_users all

  # no access - allow nothing
  http_access deny all


What you need to add to this is deny_info for each of the &quot;deny&quot; lines
ACL. You can have two templates one for domains and one for extensions.
Re-use the ext template for both of the some_extensions and
more_extensions. Ditto for the domains template.

&gt;<i> 
</I>&gt;<i> When a user is redirected to error page, there should be enough info
</I>&gt;<i> about error:
</I>&gt;<i> - user as seen by squid (or no user if not authenticated)
</I>&gt;<i> - group as seen by squid (or no group)
</I>&gt;<i> - acl that triggered the ban (not the last deny rule)
</I>
This is not possible. It is always the combination of multiple ACLs
matching and non-matching that leads to a denial.

The closest you can get is the above config with one ACL per line/rule
and a deny_info for each of the ones used on deny lines.


The codes that can be used in the error pages are detailed at
&lt;<A HREF="http://wiki.squid-cache.org/Features/CustomErrors">http://wiki.squid-cache.org/Features/CustomErrors</A>&gt;
specifically the %a code can be used to expand the user name. But the
group and ACL name details are not passed and would have to be inferred
by which template is being used.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005674.html">[squid-users] help with acl order and deny_info pages
</A></li>
	<LI>Next message (by thread): <A HREF="005541.html">[squid-users] after changed from 3.4.13 to 3.5.8 sslbump doesn't work for the site https://banking.postbank.de/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5675">[ date ]</a>
              <a href="thread.html#5675">[ thread ]</a>
              <a href="subject.html#5675">[ subject ]</a>
              <a href="author.html#5675">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
