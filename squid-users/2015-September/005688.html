<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid with SMP registeration time out when i use	10K opened sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20SMP%20registeration%20time%20out%20when%20i%20use%0A%0910K%20opened%20sessions&In-Reply-To=%3C001c01d0f705%2416f6e200%2444e4a600%24%40netstream.ps%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005683.html">
   <LINK REL="Next"  HREF="005690.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid with SMP registeration time out when i use	10K opened sessions</H1>
    <B>Ahmad Alzaeem</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20SMP%20registeration%20time%20out%20when%20i%20use%0A%0910K%20opened%20sessions&In-Reply-To=%3C001c01d0f705%2416f6e200%2444e4a600%24%40netstream.ps%3E"
       TITLE="[squid-users] squid with SMP registeration time out when i use	10K opened sessions">ahmed.zaeem at netstream.ps
       </A><BR>
    <I>Thu Sep 24 20:10:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005683.html">[squid-users] squid with SMP registeration time out when i use 10K opened sessions
</A></li>
        <LI>Next message (by thread): <A HREF="005690.html">[squid-users] squid with SMP registeration time out when i use 10K opened sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5688">[ date ]</a>
              <a href="thread.html#5688">[ thread ]</a>
              <a href="subject.html#5688">[ subject ]</a>
              <a href="author.html#5688">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi alex

Thanks for answering me

As I told you

If I use 2k ips with 2 worker , squid works ok If I use 10kbports without SMP , squid is ok

With 10K  + 2 workers , we have reg timeout

I have already added that key  u mentioned below which is :

net.local.dgram.recvspace = 1262144
But I have
When I do sysctl -p
I have 

error: &quot;net.local.dgram.recvspace&quot; is an unknown key



any other tricks I can change with squid ???

I can use ur version 3.3.11 to increase timeout and handle more listening ports.

But I have other idea

What about I do &quot;if else&quot; option

Like if process # 1 , I give it ports 3K If process # 2 , I give it 3 K And so on ....will that success ??

Awaiting ur reply about the patch and how using it

Many thankx

-----Original Message-----
From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
Sent: Thursday, September 24, 2015 7:10 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Cc: Ahmad Alzaeem
Subject: Re: [squid-users] squid with SMP registeration time out when i use 10K opened sessions

On 09/24/2015 08:54 AM, Ahmad Alzaeem wrote:

&gt;<i> If I run it with no SMP 10000 listenting ports  , it works ok and 
</I>&gt;<i> problem
</I>&gt;<i> 
</I>&gt;<i> If I run squid with 10000  listening port with 2 workers &#232;kid timeout 
</I>&gt;<i> registeration
</I>
&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29995
</I>&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29996
</I>&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29997
</I>&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29998
</I>&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29999
</I>&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:30000
</I>...
&gt;<i> FATAL: kid2 registration timed out
</I>
&gt;<i> do we need to increase timeout ?? since it take long time to load the 
</I>&gt;<i> the ips.
</I>

The existing SMP http_port sharing algorithm needs lots of UDS buffer space to share lots of ports. You may be able to get your configuration working by allocating lots of UDS buffer space (sysctl net.local.dgram.recvspace and such), but it may turn out to be impossible for 10K ports. If there is not enough UDS buffer space, increasing timeout will not help.


The attached patch for Squid v3.3.11 changes the port sharing algorithm to minimize memory usage (at the expense of registration time). Please see the patch preamble for technical details. The patch worked with 3K ports (24 workers * 128 http_ports each); the registration lasted less than 5 seconds.

I do not recall whether we have tested the patch with 10K ports -- you may need to increase the hard-coded kid registration timeout to handle 10K ports with a patched Squid.

Sorry, I do not have a patch for other Squid versions at this time.


HTH,

Alex.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005683.html">[squid-users] squid with SMP registeration time out when i use 10K opened sessions
</A></li>
	<LI>Next message (by thread): <A HREF="005690.html">[squid-users] squid with SMP registeration time out when i use 10K opened sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5688">[ date ]</a>
              <a href="thread.html#5688">[ thread ]</a>
              <a href="subject.html#5688">[ subject ]</a>
              <a href="author.html#5688">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
