<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid with SMP registeration time out when i use 10K opened sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20SMP%20registeration%20time%20out%20when%20i%20use%0A%2010K%20opened%20sessions&In-Reply-To=%3C56045C7B.2040504%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005688.html">
   <LINK REL="Next"  HREF="005691.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid with SMP registeration time out when i use 10K opened sessions</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20SMP%20registeration%20time%20out%20when%20i%20use%0A%2010K%20opened%20sessions&In-Reply-To=%3C56045C7B.2040504%40measurement-factory.com%3E"
       TITLE="[squid-users] squid with SMP registeration time out when i use 10K opened sessions">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 24 20:26:35 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005688.html">[squid-users] squid with SMP registeration time out when i use	10K opened sessions
</A></li>
        <LI>Next message (by thread): <A HREF="005691.html">[squid-users] squid with SMP registeration time out when i use 10K opened sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5690">[ date ]</a>
              <a href="thread.html#5690">[ thread ]</a>
              <a href="subject.html#5690">[ subject ]</a>
              <a href="author.html#5690">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/24/2015 02:10 PM, Ahmad Alzaeem wrote:

&gt;<i> If I use 2k ips with 2 worker , squid works ok If I use 10kbports without SMP , squid is ok
</I>&gt;<i> With 10K  + 2 workers , we have reg timeout
</I>
The bigger (workers * ports) product is, the more likely you are to run
out of the UDS buffer space because unpatched Squid workers request
sharing of all http_ports at once.


&gt;<i> error: &quot;net.local.dgram.recvspace&quot; is an unknown key
</I>
Sorry, I do not know what that option is called in your environment.


&gt;<i> if process # 1 , I give it ports 3K If process # 2 , I give it 3
</I>&gt;<i> K And so on ....will that success ??
</I>
I am not sure, but I suspect that you will get different workers
listening on different ports, without sharing. It is not a configuration
SMP Squid was designed for, and workers will still send UDS requests to
share their ports (a worker does not know whether other workers are
using its port). It does not hurt to try.

Alex.



&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;<i> Sent: Thursday, September 24, 2015 7:10 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Ahmad Alzaeem
</I>&gt;<i> Subject: Re: [squid-users] squid with SMP registeration time out when i use 10K opened sessions
</I>&gt;<i> 
</I>&gt;<i> On 09/24/2015 08:54 AM, Ahmad Alzaeem wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> If I run it with no SMP 10000 listenting ports  , it works ok and 
</I>&gt;&gt;<i> problem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I run squid with 10000  listening port with 2 workers &#232;kid timeout 
</I>&gt;&gt;<i> registeration
</I>&gt;<i> 
</I>&gt;&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29995
</I>&gt;&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29996
</I>&gt;&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29997
</I>&gt;&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29998
</I>&gt;&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:29999
</I>&gt;&gt;<i> 2015/09/24 14:51:25 kid2| Closing HTTP port [::]:30000
</I>&gt;<i> ...
</I>&gt;&gt;<i> FATAL: kid2 registration timed out
</I>&gt;<i> 
</I>&gt;&gt;<i> do we need to increase timeout ?? since it take long time to load the 
</I>&gt;&gt;<i> the ips.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The existing SMP http_port sharing algorithm needs lots of UDS buffer space to share lots of ports. You may be able to get your configuration working by allocating lots of UDS buffer space (sysctl net.local.dgram.recvspace and such), but it may turn out to be impossible for 10K ports. If there is not enough UDS buffer space, increasing timeout will not help.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The attached patch for Squid v3.3.11 changes the port sharing algorithm to minimize memory usage (at the expense of registration time). Please see the patch preamble for technical details. The patch worked with 3K ports (24 workers * 128 http_ports each); the registration lasted less than 5 seconds.
</I>&gt;<i> 
</I>&gt;<i> I do not recall whether we have tested the patch with 10K ports -- you may need to increase the hard-coded kid registration timeout to handle 10K ports with a patched Squid.
</I>&gt;<i> 
</I>&gt;<i> Sorry, I do not have a patch for other Squid versions at this time.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005688.html">[squid-users] squid with SMP registeration time out when i use	10K opened sessions
</A></li>
	<LI>Next message (by thread): <A HREF="005691.html">[squid-users] squid with SMP registeration time out when i use 10K opened sessions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5690">[ date ]</a>
              <a href="thread.html#5690">[ thread ]</a>
              <a href="subject.html#5690">[ subject ]</a>
              <a href="author.html#5690">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
