<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to avoid Squid disclosing the origin server IP when there is an error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20avoid%20Squid%20disclosing%20the%20origin%20server%0A%20IP%20when%20there%20is%20an%20error&In-Reply-To=%3C5607618A.4060307%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005715.html">
   <LINK REL="Next"  HREF="005719.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to avoid Squid disclosing the origin server IP when there is an error</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20avoid%20Squid%20disclosing%20the%20origin%20server%0A%20IP%20when%20there%20is%20an%20error&In-Reply-To=%3C5607618A.4060307%40treenet.co.nz%3E"
       TITLE="[squid-users] How to avoid Squid disclosing the origin server IP when there is an error">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Sep 27 03:24:58 UTC 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005715.html">[squid-users] How to avoid Squid disclosing the origin server IP when there is an error
</A></li>
        <LI>Next message (by thread): <A HREF="005719.html">[squid-users] How to avoid Squid disclosing the origin server IP when there is an error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5716">[ date ]</a>
              <a href="thread.html#5716">[ thread ]</a>
              <a href="subject.html#5716">[ subject ]</a>
              <a href="author.html#5716">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/09/2015 2:09 p.m., Xen wrote:
&gt;<i> On Sun, 27 Sep 2015, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 26/09/2015 11:48 p.m., Manuel wrote:
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> When Squid -even as a reverse proxy (which is my concern)- can not
</I>&gt;&gt;&gt;<i> retrieve the requested URL, it dicloses the IP address of the server
</I>&gt;&gt;&gt;<i> trying to contact with. Is there any way to hide that IP address to
</I>&gt;&gt;&gt;<i> the public for security reasons?
</I>&gt;<i> 
</I>&gt;&gt;<i> This is not a security problem.
</I>&gt;<i> 
</I>&gt;<i> Actually it is an issue of security. Exposure is directly related to
</I>&gt;<i> attacker interest. If you give out information for free you lower the
</I>&gt;<i> amount of work any person needs to do, which means you may become a more
</I>&gt;<i> likely target than some other equivalent system. Staying low and
</I>&gt;<i> avoiding attention is a perfect measure as long as you complement it
</I>&gt;<i> with actual &quot;access control&quot; security.
</I>&gt;<i> 
</I>
The server IPs are published in DNS. You had better remove those records
since they are far more easily attacked than 127.0.0.1.

I think you missed the point of my reply entirely. The security problem
is the existence of the underlying error, not the message about it.


&gt;&gt;<i> 1) security by obscurity does not work.
</I>&gt;<i> 
</I>&gt;<i> Seriously, that is just dogma being repeated over and over by people who
</I>&gt;<i> just heard it one time and accepted it as their own truth, without
</I>&gt;<i> really thinking it over. Security by obscurity works very well,
</I>

This tells me you dont have much actual experience with security, or not
low-level enough. Real experience with attacks and working on 0-day
tools is better than even just &quot;thinking it over&quot;. Thats what I based my
statement on. Though I do adopt the industry phrase to get the idea
across clearly.


&gt;<i> the
</I>&gt;<i> error is believing that it can *replace* the other type of security. It
</I>&gt;<i> is not a replacement, it is a complement. It is not either/or, it is
</I>&gt;<i> both/and. Even if you are the strongest fighter in the world, you don't
</I>&gt;<i> go into town square and yell &quot;attack me!&quot; because there might just be
</I>&gt;<i> that bullet pointed for your head. Exposure is a really problematic
</I>&gt;<i> thing, and I have used &quot;obscurity&quot; to my advantage for instance in
</I>&gt;<i> trying to get rid of people who were trying to physically target me. In
</I>&gt;<i> the real world, obscurity is used constantly and ignoring it means
</I>&gt;<i> certain death.
</I>
Not for sane security. For privacy. The two are different, though
complimentary.

To take your analogy; walking into the town square keeping your mouth
closed dressed in a cape and mask while someone is firing a machine gun
all over the place will see you just as dead.
 They won't know who you are, but you'll still be dead.


&gt;<i> 
</I>&gt;&gt;<i> 2) &quot;127.0.0.1&quot; does not leak any information other than a CDN proxy is
</I>&gt;&gt;<i> being used. The existence of the error page itself and several other
</I>&gt;&gt;<i> mandatory details in the HTTP protocol provides the exact same
</I>&gt;&gt;<i> information.
</I>&gt;<i> 
</I>&gt;<i> I don't know about the http thing, but in a sense telling your
</I>&gt;<i> user/attacker that the real website is hosted on the same machine is
</I>&gt;<i> information that can be used.
</I>&gt;<i> 
</I>
But it does *not* tell that. HTTP is multi-hop. All the error message
states is that 127.0.0.1 *somewhere* is unavailable. Good luck defining
&quot;somewhere&quot;.

All it tells with certaintly is that there is at least one proxy
operating. Attackers have zero information about whether that server is
the origin server or just another proxy. They also dont have any info
from that page about how many proxies down the chain the error was
generated.
Either way if erver X was the target they have to get to server X
through the proxy they are already contacting and/or profiling, and
cannot do so due to it being down and unavailable.

It could as easily be one of these scenarios:

 CDN ISP node proxy -&gt; CDN shard proxy -&gt; ESI filter (127.0.0.1) -&gt; origin

 CDN ISP node LB -&gt; CDN node cache (127.0.0.1) -&gt; CDN shard proxy -&gt; origin

 CDN ISP node LB -&gt; CDN node cache (127.0.0.1) -&gt; CDN shard proxy -&gt; ESI
filter (127.0.0.1) -&gt; origin

 ISP interception LB proxy -&gt; ISP farm proxy (127.0.0.1) -&gt; CDN -&gt; origin

Good luck if its the third one. Which is actually quite popular with all
the major CDN.

&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> Obscurity relates to the amount of effort required to crack a system. It
</I>
In a system relying on obscurity the effort required is near zero.
System profiling takes under 10 HTTP messages and attack scan to find
the obscured vulnerability takes however many needed to scan through
CVE/0-day the attacker or their tools knows about for that combo of
software.


&gt;<i> is just a usage thing. If your product has bad documentation, many users
</I>&gt;<i> will give up trying to use a certain feature. If the documentation is
</I>&gt;<i> good and rapidly accessible, more users will use the feature because it
</I>&gt;<i> costs them less time/energy/money to find out how to use it, which means
</I>&gt;<i> getting to use it is cheaper to them. Most of what a user does in a
</I>&gt;<i> computer (and in real life) is a cost/benefit calculation.
</I>
And what does published documentation have to do with proxy A failing to
connect to some upstream server? This thread is not about documentation,
its about whether or not some admin has secured their CDN proxy.

&gt;<i> 
</I>&gt;<i> The same applies to attacking a system. If the cost becomes too high for
</I>&gt;<i> the benefit that can be gained, people will just leave a system alone.
</I>&gt;<i> 
</I>&gt;<i> It is important.
</I>&gt;<i> 
</I>
Now that is dogma. Probably true most of the time, but still experience
(and a bit of thinking) uncovers cases where it is false.

So here is a small calculation for you.
* The majority of proxy installations will never encounter this error
message.
* When it does happen there is no indication whether the unavailable
server is an endpoint, or just another relay.
* When it is not happening attacker cannot be certain whether this or
some other server is being contacted.
* When they do encounter it, it means the potentially attacked server is
not able to be further attacked.

It is a negative statement about availability with the property that
when its *not* happening one still cannot be certain about up/down
status on the particular server application.

* If the attacker did manage to trigger this event they have no certinty
about whether it was their action or a combination of their action and
some other parallel traffic they are unaware of.

How does that strike you for height on the bar?

The one attack where this is useful is a DoS attack, where it is a sign
that DoS is happening, but since ther is clearly a proxy involved the
Dos success/fail state is still uncertain. Proxies have this ability to
limit DoS to particular clients and/or present different variants of
response to different requests. So the attack request may be getting
this error while regular traffic does not even notice.

&gt;<i> 
</I>&gt;&gt;<i> 3) If 127.0.0.1 interface on your server is accessible from a remote
</I>&gt;&gt;<i> machine; then you have much, much worse security problems that need
</I>&gt;&gt;<i> fixing.
</I>&gt;<i> 
</I>&gt;<i> It's not really about that, I believe. Of course if you want to
</I>&gt;<i> protect/hide your webserver you must ensure that it only answers to
</I>&gt;<i> 127.0.0.1 itself (the CDN) (or proxy, whatever) but all the same giving
</I>&gt;<i> out 127.0.0.1 reveales information about your network topology.
</I>
This is slightly incorrect. Protecting the server requires protecting
it, not hiding. Proxy offers a higher bar to DoS attacks, and added
complexity of software HTTP interptetations and ACLs that need to be
broken or bypassed before any attack is successful.

You still have to place the protections in both proxy and server to gain
those proxy benefits. At which point the server location starts to mean
almost nothing in terms of protection.

Having the server on the same host as the proxy adds the localhost
hardware protections. That is all. Then exposes it to side effects of
CPU consumption attacks made against the proxy which would not be an
issue if it were separate.

That high CPU consumption is just one normal peak traffic case for a
proxy. So it can occur almost on demand if an attacker chooses. Squid is
designed to continue operating under those conditions. Servers and in
particular &quot;application layer&quot; stuff is much more fragile.

&gt;<i> 
</I>&gt;&gt;<i> This is a privacy related thing.
</I>&gt;<i> 
</I>&gt;&gt;<i> I say thing specifically because &quot;problem&quot; and &quot;issue&quot; would imply
</I>&gt;&gt;<i> actually being a problem. There is zero privacy loss from server IPs
</I>&gt;&gt;<i> being known. It is required to inform the client to prevent it repeating
</I>&gt;&gt;<i> this query via other routes which intersect or terminate at the same
</I>&gt;&gt;<i> broken server IP.
</I>&gt;<i> 
</I>&gt;<i> Then it is not a privacy thing. But if supposedly the real web server
</I>&gt;<i> would actually be accessible, then it would allow the client
</I>&gt;<i> specifically to repeat the query via a direct route to the webserver
</I>&gt;<i> (provided it was not 127.0.0.1, or the client would translate that into
</I>&gt;<i> the IP for the advertised/published webserver address. But perhaps I
</I>&gt;<i> know nothing about http in this case and I just don't know what you mean
</I>&gt;<i> ;-). It seems like advertising some address does not prevent anything.
</I>&gt;<i> 
</I>
I mean it is mandatory for each proxy along the chain to send headers
detailing the hosts and protocols the message has passed over. One
ambiguous detail in a rarely occuring error message is the hard way to
get any info which is spewed forth on every request. And on diagnostic
requests is presented &quot;on a silver platter&quot; as the saying goes.


&gt;&gt;<i> Example of the error message I am referring to:
</I>&gt;&gt;<i> &quot;The requested URL could not be retrieved
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> While trying to retrieve the URL: <A HREF="http://www.domainame.com/">http://www.domainame.com/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The following error was encountered:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Connection to 127.0.0.1 Failed
</I>&gt;<i> 
</I>&gt;<i> Aye, it is prettier as well if this information is not shown/leaked.
</I>
Then dont use that error template. Eliezer pointed out how. When it does
occur it presents the minimum of vital debugging information necessary
to resolve the outage.

This error message is specifically designed to reveal those two details
of URL and which server was down. Such that it can be identified and
fixed. So this does not qualify as a vulnerability leak.

In reverse-proxy cases the end user receiving it is perhapse not the
best target, the log would be better. Patches making the distinction are
welcome.

&gt;<i> 
</I>&gt;<i> I usually have no need, for instance, for detailed database connection
</I>&gt;<i> failure reports. It is ugly and exposes a lot of internals to your user.
</I>&gt;<i> A common user will also be thinking &quot;what is this shit?&quot;. It is not
</I>&gt;<i> tailored for the presentation that was created for the website proper.
</I>&gt;<i> If anything, an error message like that would need to get a message page
</I>&gt;<i> that is in line with the semantics/display/appearance of the page/site
</I>&gt;<i> itself. Just to be consistent and keep the encapsulation intact.
</I>
This is what errorpage.css config file is for. Reverse-proxy
installations should use it to brand their proxy generated responses.

&gt;<i> 
</I>&gt;<i> It's just common design principle. You don't want to scare the user
</I>&gt;<i> either with weird stuff. These pages (not this one, I guess) even often
</I>&gt;<i> invite the user to start sending email to the system administrator, when
</I>&gt;<i> most often the problem is always temporary and a reload 5 minutes later
</I>&gt;<i> solves the problem. And it is incomprehensible to most.
</I>&gt;<i> 
</I>&gt;<i> Anyway. Just something I have thought about quite a bit. And something I
</I>&gt;<i> have used to my advantage in terms of being or remaining in a position
</I>&gt;<i> of plausible deniability in the context of being forced, more or less,
</I>&gt;<i> to reveal secrets, as well.
</I>
:<i>-) and welcome. If you would like to help improve the error messages,
</I>patches to update the templates are welcome.

But be aware that proxies have a very wide set of use-cases to cater
for, so eliminating details is not always the best choice. The case in
point being that the detials being a worry to some now are critical for
ISP installations to report, but not reverse-proxy. We ride the fine
line between relevance and leaks.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005715.html">[squid-users] How to avoid Squid disclosing the origin server IP when there is an error
</A></li>
	<LI>Next message (by thread): <A HREF="005719.html">[squid-users] How to avoid Squid disclosing the origin server IP when there is an error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5716">[ date ]</a>
              <a href="thread.html#5716">[ thread ]</a>
              <a href="subject.html#5716">[ subject ]</a>
              <a href="author.html#5716">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
