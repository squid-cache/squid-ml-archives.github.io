<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Query about login=pass
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Query%20about%20login%3Dpass&In-Reply-To=%3C56FEBD78.30004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009966.html">
   <LINK REL="Next"  HREF="009979.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Query about login=pass</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Query%20about%20login%3Dpass&In-Reply-To=%3C56FEBD78.30004%40treenet.co.nz%3E"
       TITLE="[squid-users] Query about login=pass">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Apr  1 18:27:04 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009966.html">[squid-users] Query about login=pass
</A></li>
        <LI>Next message (by thread): <A HREF="009979.html">[squid-users] Query about login=pass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9969">[ date ]</a>
              <a href="thread.html#9969">[ thread ]</a>
              <a href="subject.html#9969">[ subject ]</a>
              <a href="author.html#9969">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/04/2016 1:40 a.m., Sreenath BH wrote:
&gt;<i> Hi All,
</I>&gt;<i> 
</I>&gt;<i> We have a setup with two squid servers lets say, squid1 and squid2.
</I>&gt;<i> Requests land at Squid1 and it sends the request to squid2. Squid2
</I>&gt;<i> uses X-User-ID and Authorization headers for authenticating the user,
</I>&gt;<i> and on success, fetches data from another webserver and returns the
</I>&gt;<i> data. If authentication fails, it returns a 401 response.
</I>&gt;<i> 
</I>&gt;<i> What we have observed is that for some reason, squid does not send the
</I>&gt;<i> Authorization header to the upstream squid server. However, X-User-ID
</I>&gt;<i> header is always sent to upstre.
</I>
X-User-ID is a custom header. It would appear that it is not listed in
the Connection: header, so that makes it an end-to-end feature to be
delivered all the way to the origin server.
 This is why Squid passes it onward.



&gt;<i> 
</I>&gt;<i> 10.135.81.100 is squid2.
</I>&gt;<i> 
</I>&gt;<i> Here is configuration of squid1, where we see the problem.
</I>&gt;<i> ------------------
</I>&gt;<i> acl    test_upload   urlpath_regex   ^/upload
</I>&gt;<i> acl    test_nms       urlpath_regex   ^/nms
</I>&gt;<i> acl    trash_misc    urlpath_regex   ^/trash
</I>&gt;<i> 
</I>&gt;<i> http_port 80 accel defaultsite=sitgateway.qiodrive.com vhost
</I>&gt;<i> https_port 443 cert=/etc/squid3/certificates/test.crt
</I>&gt;<i> key=/etc/squid3/certificates/qiodrivekey.key
</I>&gt;<i> cafile=/etc/squid3/certificates/gd_bundle-g2-g1.crt accel
</I>
You have configured your Squid to be a reverse-proxy. So that it acts as
if it were an origin server and *consumes* the WWW-Auth headers (rather
than the usual Proxy-Auth headers).



&gt;<i> cache_peer 10.135.81.100 parent 80 0 no-query login=PASS originserver name=name1
</I>&gt;<i> cache_peer_access name1 allow test_upload
</I>&gt;<i> cache_peer_access name1 deny all
</I>&gt;<i> 
</I>&gt;<i> cache_peer 10.135.81.100 parent 80 0 no-query login=PASS originserver name=name2
</I>&gt;<i> cache_peer_access name2 allow test_nms
</I>&gt;<i> cache_peer_access name2 deny all
</I>

login=PASS will attempt to login with Basic auth credentials to the
peer. If, and only if, Squid has some Basic auth credentials to send.


&gt;<i> 
</I>&gt;<i> cache_peer 10.135.81.100 parent 80 0 no-query originserver name=name3
</I>&gt;<i> cache_peer_access name3 allow trash_misc
</I>&gt;<i> cache_peer_access name3 deny all
</I>&gt;<i> ----------------
</I>&gt;<i> 
</I>&gt;<i> As can be seen above, we have associated different names  (name1,
</I>&gt;<i> name2 and name3) for the same Squid2 server, all listening at same
</I>&gt;<i> port also. Is this a correct way of doing it? I ran squid -parse on
</I>&gt;<i> the squid.conf file and it did not report any problem.
</I>&gt;<i> 
</I>&gt;<i> 1. Squid1 listens on both 80 and SSL port. If request comes on SSL
</I>&gt;<i> port, will it send Authorization token to Squid that is not SSL squid?
</I>
The two details are not related. So there is not any yes/no answer to that.
 For any message, *if* that message is allowed to be sent to the
particular peer, then the headers allowed to be sent to that peer will
be sent.


&gt;<i> 
</I>&gt;<i> 2. In the source code of squid (http.c) I see following lines in the function:
</I>&gt;<i> 
</I>
&gt;<i> void
</I>&gt;<i> copyOneHeaderFromClientsideRequestToUpstreamRequest(const
</I>&gt;<i> HttpHeaderEntry *e, const String strConnection, const HttpRequest *
</I>&gt;<i> request, HttpHeader * hdr_out, const int we_do_ranges, const
</I>&gt;<i> HttpStateFlags &amp;flags)
</I>&gt;<i> 
</I>
This function happens long after the auth header is consumed and/or
re-constructed by Squid. It is only relevant to whatever auth headers
Squid has decided to send upstream have been added back into the request.

&gt;<i> 
</I>&gt;<i> I don't understand what might prevent squid from sending the
</I>&gt;<i> Authorization header.
</I>

What login=PASS does is tell Squid to use the Basic authentication
credentials it has - either from the Basic authentication helper it is
using to perform auth, or the external ACL helper, or the original
client request (in that order) to login to the upstream peer.

This can be prevented by several things:
 * the upstream peer not requesting login.
 * no Basic auth credentials being known. eg, if you are not using Basic
auth to the client.
 * ICAP/eCAP adaptation stripping away the credentials

To pass on any non-Basic auth credentials use login=PASSTHRU instead of
login=PASS.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009966.html">[squid-users] Query about login=pass
</A></li>
	<LI>Next message (by thread): <A HREF="009979.html">[squid-users] Query about login=pass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9969">[ date ]</a>
              <a href="thread.html#9969">[ thread ]</a>
              <a href="subject.html#9969">[ subject ]</a>
              <a href="author.html#9969">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
