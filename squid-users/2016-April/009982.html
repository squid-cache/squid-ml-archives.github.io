<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] filtering http(s) sites, transparently
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3C5701F4B0.8060001%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009981.html">
   <LINK REL="Next"  HREF="010002.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] filtering http(s) sites, transparently</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3C5701F4B0.8060001%40treenet.co.nz%3E"
       TITLE="[squid-users] filtering http(s) sites, transparently">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Apr  4 04:59:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009981.html">[squid-users] filtering http(s) sites, transparently
</A></li>
        <LI>Next message (by thread): <A HREF="010002.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9982">[ date ]</a>
              <a href="thread.html#9982">[ thread ]</a>
              <a href="subject.html#9982">[ subject ]</a>
              <a href="author.html#9982">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/04/2016 4:18 p.m., Jok Thuau wrote:
&gt;<i> I'm attempting to build a transparent proxy (policy based routing on
</I>&gt;<i> firewall to squid proxy) with the following behavior:
</I>&gt;<i> 
</I>&gt;<i> 1) proxies http traffic for a given set of domains, provide an message
</I>&gt;<i> otherwise such &quot;domain not allowed&quot; or similar
</I>&gt;<i> 2) proxies https traffic for a given set of domains (ideally, splicing
</I>&gt;<i> those, so as not to break HSTS, if enabled), otherwise provide an error
</I>&gt;<i> message (bumping and providing &quot;domain not allowed&quot;)
</I>&gt;<i> 
</I>&gt;<i> I'm attempting this with a 3.5.15 compiled with icap (not yet used) and
</I>&gt;<i> ssl-bumping.
</I>&gt;<i> 
</I>&gt;<i> Part 1 seems easy enough (and is well documented)...
</I>&gt;<i> 
</I>&gt;<i> acl whitelist dstdomain .domain1.tld
</I>&gt;<i> acl whitelist dstdomain .domain2.tld
</I>&gt;<i> 
</I>&gt;<i> acl http_ok all-of whitelist !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow http_ok
</I>&gt;<i> http_access deny all
</I>
This is denying the HTTPS traffic CONNECT requests (synthesized by
Squid), since they only have IP address no domain name.


&gt;<i> 
</I>&gt;<i> Moving onto Part 2 (the peek and splice setup) appears to be the topic of a
</I>&gt;<i> few discussions out there...
</I>&gt;<i> 
</I>&gt;<i> acl sni_whitelist ssl::server_name .domain1.tld
</I>&gt;<i> acl sni_whitelist ssl::server_name .domain2.tld
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>
You have omitted the definition of step1 ACL.

&gt;<i> ssl_bump splice sni_whitelist
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> It appears however that when combining the two, the generated
</I>&gt;<i> certificate(s), instead of mimic'ing the original server's certificate
</I>&gt;<i> comes out with the CN=&lt;IP&gt; where &lt;IP&gt; is the ip used by the &quot;connect&quot; part
</I>&gt;<i> of the connection. In addition, it appears that only the first entry ever
</I>&gt;<i> matches (at this point, i've tried so many combinations, i'm no longer
</I>&gt;<i> certain of anything).
</I>
You have omitted the http(s)_port configuration details, and the step1
ACL. So its not possible to say if you have the cert generation settings
wrong, or if the peeking step is matching wrong, or something else.

&gt;<i> 
</I>&gt;<i> If i remove *all* the http_access lines, then the behavior appears correct
</I>&gt;<i> (from a &quot;splicing/bumping&quot; standpoint).
</I>&gt;<i> 
</I>
Strange. Squid without any http_access lines should be denying traffic 100%.

&gt;<i> Can anyone confirm that this is indeed possible to achieve?
</I>&gt;<i> 
</I>&gt;<i> I believe, based on experimentation that any http_access i have, because of
</I>&gt;<i> the &quot;deny all&quot; cause the bumping to &quot;short circuit&quot; and effectively send an
</I>&gt;<i> early &quot;access denied&quot; based on the only information it has (the ip address
</I>&gt;<i> from the &quot;connect&quot;, rather than the SNI that would come later).
</I>&gt;<i> 
</I>&gt;<i> Would a setup where &quot;deny http+!whitelist&quot; so have the allow be the default
</I>&gt;<i> allow for the bumping to work and get to step2 and match the sni* acls
</I>&gt;<i> somehow? (with a &quot;deny step2 !sni_whitelist&quot;).
</I>&gt;<i> 
</I>&gt;<i> Is 3.5.15 capable of doing this? If this requires some feature/effort, what
</I>&gt;<i> would be the procedure to sponsor that work?
</I>
It is not possible to answer any of those questsions properly without
full config details. You have omitted a lot.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009981.html">[squid-users] filtering http(s) sites, transparently
</A></li>
	<LI>Next message (by thread): <A HREF="010002.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9982">[ date ]</a>
              <a href="thread.html#9982">[ thread ]</a>
              <a href="subject.html#9982">[ subject ]</a>
              <a href="author.html#9982">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
