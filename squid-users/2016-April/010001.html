<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Can Squid send the response time information to icap?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Can%20Squid%20send%20the%20response%20time%20information%20to%0A%20icap%3F&In-Reply-To=%3C57028DD1.4050307%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009998.html">
   <LINK REL="Next"  HREF="009999.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Can Squid send the response time information to icap?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Can%20Squid%20send%20the%20response%20time%20information%20to%0A%20icap%3F&In-Reply-To=%3C57028DD1.4050307%40measurement-factory.com%3E"
       TITLE="[squid-users] Can Squid send the response time information to icap?">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Apr  4 15:52:49 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009998.html">[squid-users] Can Squid send the response time information to icap?
</A></li>
        <LI>Next message (by thread): <A HREF="009999.html">[squid-users] squid 3.5 vs 4.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10001">[ date ]</a>
              <a href="thread.html#10001">[ thread ]</a>
              <a href="subject.html#10001">[ subject ]</a>
              <a href="author.html#10001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/04/2016 08:52 AM, Giray Simsek wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Can Squid send the response time information to icap by passing a header
</I>&gt;<i> and a value pair to icap?
</I>
Yes, Squid can do that via adaptation_meta, but true &quot;response time&quot; may
not be the information you actually want.

  <A HREF="http://www.squid-cache.org/Doc/config/adaptation_meta/">http://www.squid-cache.org/Doc/config/adaptation_meta/</A>


&gt;<i> I am trying to get the duration for the http responses within the icap
</I>&gt;<i> module. That is, the time it takes to get the response from the external
</I>&gt;<i> web server after the initial http get request is sent. 
</I>&gt;<i> 
</I>&gt;<i> I am hoping there is a way to pass this information from squid to c-icap.
</I>&gt;<i> 
</I>&gt;<i> I see that it is possible to log this information in squid using the
</I>&gt;<i> format code:
</I>&gt;<i> 
</I>&gt;<i>  tr Response time (milliseconds)
</I>
You might be assuming (incorrectly) that the ICAP transaction starts
when the HTTP transaction with the origin server ends. In reality, the
two transactions may overlap. They usually do overlap for large
responses. Thus, the response time is often not yet known at the ICAP
transaction start time.

Furthermore, %tr includes Squid-to-client delivery delays so it is
especially inappropriate at pre-cache RESPMOD time. Use %&lt;pt or %&lt;tt to
solve that part of the problem:

&gt;<i> [http::]&lt;pt     Peer response time in milliseconds. The timer starts
</I>&gt;<i>                 when the last request byte is sent to the next hop
</I>&gt;<i>                 and stops when the last response byte is received.
</I>&gt;<i> [http::]&lt;tt     Total [peering] time in milliseconds. The timer 
</I>&gt;<i>                 starts with the first connect request (or write I/O)
</I>&gt;<i>                 sent to the first selected peer. The timer stops
</I>&gt;<i>                 with the last I/O with the last peer.
</I>


I have not checked whether %tr or %&lt;tt logs &quot;response time so far&quot; if
used for yet-unfinished transactions. If it does, then you may use it
(but you would be relying on undocumented/not-guaranteed behavior!).

You might be better off with using a combination of %ts.%03tu and %tS
(instead of %&lt;tt). The difference between %ts.%03tu and %tS values may
be a better approximation for what you want:

&gt;<i> tS      Approximate master transaction start time in 
</I>&gt;<i>         &lt;full seconds since epoch&gt;.&lt;fractional seconds&gt; format.
</I>&gt;<i>         Currently, Squid considers the master transaction
</I>&gt;<i>         started when a complete HTTP request header initiating
</I>&gt;<i>         the transaction is received from the client. This is
</I>&gt;<i>         the same value that Squid uses to calculate transaction
</I>&gt;<i>         response time when logging %tr to access.log. Currently,
</I>&gt;<i>         Squid uses millisecond resolution for %tS values,
</I>&gt;<i>         similar to the default access.log &quot;current time&quot; field
</I>&gt;<i>         (%ts.%03tu).
</I>
Ideally, you need a new logformat codes with Squid-to-origin request
start time (to pair with the already supported %&lt;pt and %&lt;tt). Please
consider adding those codes to Squid:

<A HREF="http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009998.html">[squid-users] Can Squid send the response time information to icap?
</A></li>
	<LI>Next message (by thread): <A HREF="009999.html">[squid-users] squid 3.5 vs 4.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10001">[ date ]</a>
              <a href="thread.html#10001">[ thread ]</a>
              <a href="subject.html#10001">[ subject ]</a>
              <a href="author.html#10001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
