<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] filtering http(s) sites, transparently
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3CCADSSinOuefuE%2Bauum5UcFiOkt6mxTxs1sD_2MMMmpU6WT67jFg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009982.html">
   <LINK REL="Next"  HREF="010011.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] filtering http(s) sites, transparently</H1>
    <B>Jok Thuau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3CCADSSinOuefuE%2Bauum5UcFiOkt6mxTxs1sD_2MMMmpU6WT67jFg%40mail.gmail.com%3E"
       TITLE="[squid-users] filtering http(s) sites, transparently">jok at spikes.com
       </A><BR>
    <I>Mon Apr  4 16:49:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009982.html">[squid-users] filtering http(s) sites, transparently
</A></li>
        <LI>Next message (by thread): <A HREF="010011.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10002">[ date ]</a>
              <a href="thread.html#10002">[ thread ]</a>
              <a href="subject.html#10002">[ subject ]</a>
              <a href="author.html#10002">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, Apr 3, 2016 at 9:59 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 4/04/2016 4:18 p.m., Jok Thuau wrote:
</I>&gt;<i> &gt; I'm attempting to build a transparent proxy (policy based routing on
</I>&gt;<i> &gt; firewall to squid proxy) with the following behavior:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1) proxies http traffic for a given set of domains, provide an message
</I>&gt;<i> &gt; otherwise such &quot;domain not allowed&quot; or similar
</I>&gt;<i> &gt; 2) proxies https traffic for a given set of domains (ideally, splicing
</I>&gt;<i> &gt; those, so as not to break HSTS, if enabled), otherwise provide an error
</I>&gt;<i> &gt; message (bumping and providing &quot;domain not allowed&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm attempting this with a 3.5.15 compiled with icap (not yet used) and
</I>&gt;<i> &gt; ssl-bumping.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Part 1 seems easy enough (and is well documented)...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl whitelist dstdomain .domain1.tld
</I>&gt;<i> &gt; acl whitelist dstdomain .domain2.tld
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl http_ok all-of whitelist !SSL_ports
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow http_ok
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i>
</I>&gt;<i> This is denying the HTTPS traffic CONNECT requests (synthesized by
</I>&gt;<i> Squid), since they only have IP address no domain name.
</I>&gt;<i>
</I>
yes, this is where I started with just http.


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Moving onto Part 2 (the peek and splice setup) appears to be the topic
</I>&gt;<i> of a
</I>&gt;<i> &gt; few discussions out there...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl sni_whitelist ssl::server_name .domain1.tld
</I>&gt;<i> &gt; acl sni_whitelist ssl::server_name .domain2.tld
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i>
</I>&gt;<i> You have omitted the definition of step1 ACL.
</I>&gt;<i>
</I>&gt;<i>
</I>the definition of &quot;step1&quot; is the same as the one on the wiki (See full
config below)


&gt;<i> &gt; ssl_bump splice sni_whitelist
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It appears however that when combining the two, the generated
</I>&gt;<i> &gt; certificate(s), instead of mimic'ing the original server's certificate
</I>&gt;<i> &gt; comes out with the CN=&lt;IP&gt; where &lt;IP&gt; is the ip used by the &quot;connect&quot;
</I>&gt;<i> part
</I>&gt;<i> &gt; of the connection. In addition, it appears that only the first entry ever
</I>&gt;<i> &gt; matches (at this point, i've tried so many combinations, i'm no longer
</I>&gt;<i> &gt; certain of anything).
</I>&gt;<i>
</I>&gt;<i> You have omitted the http(s)_port configuration details, and the step1
</I>&gt;<i> ACL. So its not possible to say if you have the cert generation settings
</I>&gt;<i> wrong, or if the peeking step is matching wrong, or something else.
</I>&gt;<i>
</I>&gt;<i>
</I>That's included in the config below.


&gt;<i> &gt;
</I>&gt;<i> &gt; If i remove *all* the http_access lines, then the behavior appears
</I>&gt;<i> correct
</I>&gt;<i> &gt; (from a &quot;splicing/bumping&quot; standpoint).
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Strange. Squid without any http_access lines should be denying traffic
</I>&gt;<i> 100%.
</I>&gt;<i>
</I>&gt;<i>
</I>I do not see this behavior. Traffic appears to be allowed, and bumped
(though with the wrong certificate, depending on the config, as explained
before).


&gt;<i> &gt; Can anyone confirm that this is indeed possible to achieve?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I believe, based on experimentation that any http_access i have, because
</I>&gt;<i> of
</I>&gt;<i> &gt; the &quot;deny all&quot; cause the bumping to &quot;short circuit&quot; and effectively send
</I>&gt;<i> an
</I>&gt;<i> &gt; early &quot;access denied&quot; based on the only information it has (the ip
</I>&gt;<i> address
</I>&gt;<i> &gt; from the &quot;connect&quot;, rather than the SNI that would come later).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Would a setup where &quot;deny http+!whitelist&quot; so have the allow be the
</I>&gt;<i> default
</I>&gt;<i> &gt; allow for the bumping to work and get to step2 and match the sni* acls
</I>&gt;<i> &gt; somehow? (with a &quot;deny step2 !sni_whitelist&quot;).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is 3.5.15 capable of doing this? If this requires some feature/effort,
</I>&gt;<i> what
</I>&gt;<i> &gt; would be the procedure to sponsor that work?
</I>&gt;<i>
</I>&gt;<i> It is not possible to answer any of those questsions properly without
</I>&gt;<i> full config details. You have omitted a lot.
</I>&gt;<i>
</I>
my apologies for trying to show only the relevant parts. Find below the
current config.
It appears to be bumping everything rather than splicing any of the config
(which may be due to the limitations documented on the wiki)

acl Safe_ports port 80 # http
acl Safe_ports port 443 # https
acl SSL_ports port 443
acl CONNECT method CONNECT
http_port 3129 intercept
https_port 8443 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=64MB \
    cert=/etc/squid/ssl/proxy.pem \
    key=/etc/squid/ssl/proxy.key \
    cafile=/etc/squid/ssl/proxy.pem
always_direct allow all
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
acl SniBypass ssl::server_name_regex \.slashdot\.org
acl SniBypass ssl::server_name_regex \.fsdn\.com
acl http_bypass dstdomain .slashdot.org
acl http_bypass dstdomain .fsdn.com
acl https_bypass all-of CONNECT SniBypass
acl http_ok all-of http_bypass Safe_ports
ssl_bump peek step1
ssl_bump splice SniBypass step2
ssl_bump bump all
sslproxy_cert_sign_hash sha256
sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE
always_direct allow all
sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1
http_access allow http_ok
http_access allow CONNECT
no_cache allow all
cache deny all
shutdown_lifetime 3 seconds
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160404/3de40961/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160404/3de40961/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009982.html">[squid-users] filtering http(s) sites, transparently
</A></li>
	<LI>Next message (by thread): <A HREF="010011.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10002">[ date ]</a>
              <a href="thread.html#10002">[ thread ]</a>
              <a href="subject.html#10002">[ subject ]</a>
              <a href="author.html#10002">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
