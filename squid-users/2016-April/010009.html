<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem to configure squid for HTTPS website (HSTS or others certificate problems)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20to%20configure%20squid%20for%20HTTPS%20website%0A%20%28HSTS%20or%20others%20certificate%20problems%29&In-Reply-To=%3C57030462.3080802%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009987.html">
   <LINK REL="Next"  HREF="009998.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem to configure squid for HTTPS website (HSTS or others certificate problems)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20to%20configure%20squid%20for%20HTTPS%20website%0A%20%28HSTS%20or%20others%20certificate%20problems%29&In-Reply-To=%3C57030462.3080802%40treenet.co.nz%3E"
       TITLE="[squid-users] Problem to configure squid for HTTPS website (HSTS or others certificate problems)">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Apr  5 00:18:42 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009987.html">[squid-users] Problem to configure squid for HTTPS website (HSTS or others certificate problems)
</A></li>
        <LI>Next message (by thread): <A HREF="009998.html">[squid-users] Can Squid send the response time information to icap?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10009">[ date ]</a>
              <a href="thread.html#10009">[ thread ]</a>
              <a href="subject.html#10009">[ subject ]</a>
              <a href="author.html#10009">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/04/2016 9:25 p.m., Raph Ghost wrote:
&gt;<i> Hi users :)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> What I want to do: I have a dedicated server and I want to make it as a transparent adblocker through a VPN. So I have installed and configured OpenVPN and route my traffic from the VPN tun into the squid proxy.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> What is the problem: Websites based on http work great but those based on httpS doesn't work at all.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have already tried two squid configurations and look for that problem in the user mail list history but I can't find any workaround that works.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My compilation options (squid 3.5.15 -with-openssl is enabled):
</I>&gt;<i> 
</I>
Please upgrade to 3.5.16.


&gt;<i> '--with-openssl=/etc/ssl' '--enable-ssl-crtd'
</I>
 /etc is a location for config files. I somehow doubt that you have
installed the openssl binaries in there.

If you installed libssl-dev package correctly then you don't need the
&quot;=/path&quot; piece to be specified at all. Squid build script will find
OpenSSL in its normal place.


&gt;<i> My iptable conf (port 22: my ssh server/ input port 443: my OpenVPN server):
</I>&gt;<i> 
</I>&gt;<i> -P INPUT DROP
</I>&gt;<i> -P FORWARD DROP
</I>&gt;<i> -P OUTPUT DROP
</I>&gt;<i> -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A INPUT -i lo -j ACCEPT
</I>&gt;<i> -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
</I>&gt;<i> -A INPUT -p tcp -m tcp --dport 53 -j ACCEPT
</I>&gt;<i> -A INPUT -p udp -m udp --dport 53 -j ACCEPT
</I>&gt;<i> -A INPUT -i eth0 -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
</I>&gt;<i> -A INPUT -i tun0 -j ACCEPT
</I>&gt;<i> -A FORWARD -i tun0 -j ACCEPT
</I>&gt;<i> -A FORWARD -o tun0 -j ACCEPT
</I>&gt;<i> -A FORWARD -i tun0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A FORWARD -i eth0 -o tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A OUTPUT -o lo -j ACCEPT
</I>&gt;<i> -A OUTPUT -p tcp -m tcp --dport 22 -j ACCEPT
</I>&gt;<i> -A OUTPUT -p tcp -m tcp --dport 53 -j ACCEPT
</I>&gt;<i> -A OUTPUT -p udp -m udp --dport 53 -j ACCEPT
</I>&gt;<i> -A OUTPUT -p tcp -m tcp --dport 80 -j ACCEPT
</I>&gt;<i> -A OUTPUT -p udp -m udp --dport 123 -j ACCEPT
</I>&gt;<i> -A OUTPUT -o tun0 -j ACCEPT
</I>&gt;<i> -A OUTPUT -p icmp -j ACCEPT
</I>&gt;<i> 
</I>&gt;<i> My iptable conf (nat table):
</I>&gt;<i> -P PREROUTING ACCEPT
</I>&gt;<i> -P INPUT ACCEPT
</I>&gt;<i> -P OUTPUT ACCEPT
</I>&gt;<i> -P POSTROUTING ACCEPT
</I>&gt;<i> -A PREROUTING -s 10.8.0.0/24 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3129
</I>&gt;<i> -A PREROUTING -s 10.8.0.0/24 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3130
</I>&gt;<i> -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
</I>&gt;<i> 
</I>&gt;<i> This iptables configuration works great to route vpn input trafic into squid.
</I>&gt;<i> 
</I>&lt;snip&gt;

&gt;<i> 2nd conf I have tried (based on many tutorials and the official squid wiki especially to configure Ssl Bump/Peek and Slice function):
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&lt;snip&gt;

&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
always_direct is not relevant since 3.1. Remove.

&gt;<i> sslproxy_cert_error allow all
</I>
By instructing Squid to ignore all errors, you are hiding all cert
related errors. Remove the above line to see if there is some error
being encountered that is leading to your problem.

&gt;<i> sslproxy_cafile /etc/ssl/certs/ca-certificates.crt
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 10.8.0.1:3128
</I>&gt;<i> http_port 10.8.0.1:3129 transparent
</I>
&quot;transparent&quot; is obsolete. Use &quot;intercept&quot; instead.

&gt;<i> https_port 10.8.0.1:3130 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=6MB cert=/etc/squid/ssl_cert/myCA.pem
</I>
... 6MB here and the 4MB on the helper. Those numbers need to be the
same IIRC.

&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump stare step2
</I>&gt;<i> ssl_bump bump step3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> #cache_dir ufs /var/spool/squid 100 16 256
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Unfortunately none of these conf work.
</I>&gt;<i> 
</I>&gt;<i> With the first conf:
</I>&gt;<i> If i try to connect to <A HREF="https://openclassrooms.com/">https://openclassrooms.com/</A> for example I get a warning about that the certificate is not trust. I can overpass this warning (by clicking on &quot;continue on this website (dangerous)&quot;) but after few seconds I get an error generated by squid:
</I>&gt;<i> &quot;L'erreur suivante s'est produite en essayant d'acc&#233;der &#224; l'URL : <A HREF="https://openclassrooms.com/">https://openclassrooms.com/</A>
</I>&gt;<i> La connexion 190.93.240.239 a &#233;chou&#233;e.
</I>&gt;<i> Le syst&#232;me a retourn&#233; : (110) Connection timed out   &lt; ----- Important line
</I>&gt;<i> L'h&#244;te distant ou le r&#233;seau sont peut-&#234;tre d&#233;faillant. Veuillez renouveler votre requ&#234;te.
</I>&gt;<i> Votre administrateur proxy est webmaster.&quot;
</I>&gt;<i> 
</I>&gt;<i> In access.log I get:
</I>&gt;<i> 1459756883.952     42 10.8.0.6 TCP_MISS/200 565 GET <A HREF="http://www.google-analytics.com/__utm.gif?">http://www.google-analytics.com/__utm.gif?</A> - ORIGINAL_DST/216.58.214.78 image/gif
</I>&gt;<i> 1459756885.636     14 10.8.0.6 TCP_MISS/204 262 GET <A HREF="http://www.gstatic.com/generate_204">http://www.gstatic.com/generate_204</A> - ORIGINAL_DST/216.58.214.67 -
</I>&gt;<i> 1459756890.842     17 10.8.0.6 TCP_MISS/302 505 GET <A HREF="http://openclassrooms.com/">http://openclassrooms.com/</A> - ORIGINAL_DST/190.93.240.239 -
</I>&gt;<i> 1459756891.129     14 10.8.0.6 TCP_MISS/204 262 GET <A HREF="http://www.gstatic.com/generate_204">http://www.gstatic.com/generate_204</A> - ORIGINAL_DST/216.58.214.67 -
</I>&gt;<i> 1459756961.902  60814 10.8.0.6 TCP_MISS/503 4850 GET <A HREF="https://openclassrooms.com/">https://openclassrooms.com/</A> - ORIGINAL_DST/190.93.240.239 text/html
</I>&gt;<i> 
</I>&gt;<i> In cache.log there is nothing especial.
</I>&gt;<i> 
</I>&gt;<i> When I try to connect to <A HREF="https://www.google.fr">https://www.google.fr</A> I get a warning (from my browser, here Chrome) but I can't overpass it (due to HSTS technologie).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> With the second conf (which is supposed to dynamically generate certificate from the original certificate to overpass HSTS - at least this I did think but it doesn't work):
</I>
When TLS is used properly/securely it cannot be bumped.

When visiting Google sites using Chrome (Google software) they employ
certificate pinning (aka hard-coded their official certificate(s) into
the browser), which prevents bumping from working.

HSTS is a different feature, which does not actually do any security
improvement to TLS itself. So can still be bumped - unless other TLS
usage prevents the bumping.


&gt;<i> Both of google or openclassroom websites generate the same result:
</I>&gt;<i> On browser I get a ERR_TIMED_OUT.
</I>&gt;<i> 
</I>&gt;<i> In access.log:
</I>&gt;<i> 1459755020.622  59785 10.8.0.6 TAG_NONE/200 0 CONNECT 46.228.47.114:443 - ORIGINAL_DST/46.228.47.114 -
</I>&gt;<i> 1459755043.645  60448 10.8.0.6 TAG_NONE/200 0 CONNECT 46.228.47.115:443 - ORIGINAL_DST/46.228.47.115 -
</I>&gt;<i> 1459755045.000  60058 10.8.0.6 TAG_NONE/200 0 CONNECT 216.58.211.106:443 - ORIGINAL_DST/216.58.211.106 -
</I>&gt;<i> 
</I>&gt;<i> In store.log I get SOMETIMES (rarely) this:
</I>&gt;<i> 2016/04/01 11:43:05| Pinger exiting.
</I>&gt;<i> 2016/04/01 11:46:02 kid1| Error negotiating SSL connection on FD 27: Closed by client
</I>&gt;<i> 2016/04/01 11:46:09 kid1| Error negotiating SSL connection on FD 36: Closed by client
</I>&gt;<i> 2016/04/01 11:46:16 kid1| Error negotiating SSL connection on FD 30: Closed by client
</I>&gt;<i> 2016/04/01 11:46:23 kid1| Error negotiating SSL connection on FD 38: error:14076102:SSL routines:SSL23_GET_CLIENT_HELLO:unsupported protocol (1/-1)
</I>
Meaning that non-HTTPS is being sent over port 443. Sadly that is very
common these days. You will need the on_unsupported_protocol feature of
Squid-4 to get around that.

Squid-4 is also able to handle certain types of TLS hello message that
Squid-3 will report the above message for.

&gt;<i> 
</I>&gt;<i> Whatever configuration that I used I have import certificate into my browser correctly.
</I>&gt;<i> 
</I>
&quot;I get a warning about that the certificate is not trust&quot; indicates that
it has *not* been imported correctly into the trusted certs.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009987.html">[squid-users] Problem to configure squid for HTTPS website (HSTS or others certificate problems)
</A></li>
	<LI>Next message (by thread): <A HREF="009998.html">[squid-users] Can Squid send the response time information to icap?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10009">[ date ]</a>
              <a href="thread.html#10009">[ thread ]</a>
              <a href="subject.html#10009">[ subject ]</a>
              <a href="author.html#10009">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
