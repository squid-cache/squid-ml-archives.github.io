<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] filtering http(s) sites, transparently
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3C57031390.8020604%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010002.html">
   <LINK REL="Next"  HREF="010020.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] filtering http(s) sites, transparently</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3C57031390.8020604%40treenet.co.nz%3E"
       TITLE="[squid-users] filtering http(s) sites, transparently">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Apr  5 01:23:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010002.html">[squid-users] filtering http(s) sites, transparently
</A></li>
        <LI>Next message (by thread): <A HREF="010020.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10011">[ date ]</a>
              <a href="thread.html#10011">[ thread ]</a>
              <a href="subject.html#10011">[ subject ]</a>
              <a href="author.html#10011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/04/2016 4:49 a.m., Jok Thuau wrote:
&gt;<i> On Sun, Apr 3, 2016 at 9:59 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 4/04/2016 4:18 p.m., Jok Thuau wrote:
</I>&gt;&gt;&gt;<i> I'm attempting to build a transparent proxy (policy based routing on
</I>&gt;&gt;&gt;<i> firewall to squid proxy) with the following behavior:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1) proxies http traffic for a given set of domains, provide an message
</I>&gt;&gt;&gt;<i> otherwise such &quot;domain not allowed&quot; or similar
</I>&gt;&gt;&gt;<i> 2) proxies https traffic for a given set of domains (ideally, splicing
</I>&gt;&gt;&gt;<i> those, so as not to break HSTS, if enabled), otherwise provide an error
</I>&gt;&gt;&gt;<i> message (bumping and providing &quot;domain not allowed&quot;)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm attempting this with a 3.5.15 compiled with icap (not yet used) and
</I>&gt;&gt;&gt;<i> ssl-bumping.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Part 1 seems easy enough (and is well documented)...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl whitelist dstdomain .domain1.tld
</I>&gt;&gt;&gt;<i> acl whitelist dstdomain .domain2.tld
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl http_ok all-of whitelist !SSL_ports
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow http_ok
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is denying the HTTPS traffic CONNECT requests (synthesized by
</I>&gt;&gt;<i> Squid), since they only have IP address no domain name.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> yes, this is where I started with just http.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Moving onto Part 2 (the peek and splice setup) appears to be the topic
</I>&gt;&gt;<i> of a
</I>&gt;&gt;&gt;<i> few discussions out there...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl sni_whitelist ssl::server_name .domain1.tld
</I>&gt;&gt;&gt;<i> acl sni_whitelist ssl::server_name .domain2.tld
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You have omitted the definition of step1 ACL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> the definition of &quot;step1&quot; is the same as the one on the wiki (See full
</I>&gt;<i> config below)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> ssl_bump splice sni_whitelist
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It appears however that when combining the two, the generated
</I>&gt;&gt;&gt;<i> certificate(s), instead of mimic'ing the original server's certificate
</I>&gt;&gt;&gt;<i> comes out with the CN=&lt;IP&gt; where &lt;IP&gt; is the ip used by the &quot;connect&quot;
</I>&gt;&gt;<i> part
</I>&gt;&gt;&gt;<i> of the connection. In addition, it appears that only the first entry ever
</I>&gt;&gt;&gt;<i> matches (at this point, i've tried so many combinations, i'm no longer
</I>&gt;&gt;&gt;<i> certain of anything).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You have omitted the http(s)_port configuration details, and the step1
</I>&gt;&gt;<i> ACL. So its not possible to say if you have the cert generation settings
</I>&gt;&gt;<i> wrong, or if the peeking step is matching wrong, or something else.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> That's included in the config below.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If i remove *all* the http_access lines, then the behavior appears
</I>&gt;&gt;<i> correct
</I>&gt;&gt;&gt;<i> (from a &quot;splicing/bumping&quot; standpoint).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Strange. Squid without any http_access lines should be denying traffic
</I>&gt;&gt;<i> 100%.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> I do not see this behavior. Traffic appears to be allowed, and bumped
</I>&gt;<i> (though with the wrong certificate, depending on the config, as explained
</I>&gt;<i> before).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Can anyone confirm that this is indeed possible to achieve?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I believe, based on experimentation that any http_access i have, because
</I>&gt;&gt;<i> of
</I>&gt;&gt;&gt;<i> the &quot;deny all&quot; cause the bumping to &quot;short circuit&quot; and effectively send
</I>&gt;&gt;<i> an
</I>&gt;&gt;&gt;<i> early &quot;access denied&quot; based on the only information it has (the ip
</I>&gt;&gt;<i> address
</I>&gt;&gt;&gt;<i> from the &quot;connect&quot;, rather than the SNI that would come later).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Would a setup where &quot;deny http+!whitelist&quot; so have the allow be the
</I>&gt;&gt;<i> default
</I>&gt;&gt;&gt;<i> allow for the bumping to work and get to step2 and match the sni* acls
</I>&gt;&gt;&gt;<i> somehow? (with a &quot;deny step2 !sni_whitelist&quot;).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is 3.5.15 capable of doing this? If this requires some feature/effort,
</I>&gt;&gt;<i> what
</I>&gt;&gt;&gt;<i> would be the procedure to sponsor that work?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It is not possible to answer any of those questsions properly without
</I>&gt;&gt;<i> full config details. You have omitted a lot.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> my apologies for trying to show only the relevant parts. Find below the
</I>&gt;<i> current config.
</I>&gt;<i> It appears to be bumping everything rather than splicing any of the config
</I>&gt;<i> (which may be due to the limitations documented on the wiki)
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> https_port 8443 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=64MB \
</I>&gt;<i>     cert=/etc/squid/ssl/proxy.pem \
</I>&gt;<i>     key=/etc/squid/ssl/proxy.key \
</I>&gt;<i>     cafile=/etc/squid/ssl/proxy.pem
</I>&gt;<i> always_direct allow all
</I>
always_direct has not been necessary with SSL-Bump sice 3.1 series. You
should remove it.

&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> acl SniBypass ssl::server_name_regex \.slashdot\.org
</I>&gt;<i> acl SniBypass ssl::server_name_regex \.fsdn\.com
</I>&gt;<i> acl http_bypass dstdomain .slashdot.org
</I>&gt;<i> acl http_bypass dstdomain .fsdn.com
</I>&gt;<i> acl https_bypass all-of CONNECT SniBypass
</I>
This https_bypass ACL definition is a bit weird. It requires a single
message to match both TLS and HTTP properties simultaneously.

As you might imagine it is difficult for a TLS messages to match HTTP
properties, and vice versa. So it wont ever match.

Note: SNI is *not* equivalent to Host or URL domain name. They can
contain very different values. The only thing they have in common is
that they both are supposed to point at the IP of the server being
contacted.


&gt;<i> acl http_ok all-of http_bypass Safe_ports
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice SniBypass step2
</I>
This splice will work if (and only if) the client sends TLS SNI values
to Squid. It will ignore the server cert details.

For clients which do not send SNI or for all connections where the SNI
does not match your ACL the bump rule below will do client-first bumping
(without the server cert).

&gt;<i> ssl_bump bump all
</I>
I suggets you try these ssl_bump rules instead:

 ssl_bump splice SniBypass
 ssl_bump peek step1
 ssl_bump stare step2
 ssl_bump bump all

&gt;<i> sslproxy_cert_sign_hash sha256
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE
</I>&gt;<i> always_direct allow all
</I>
repeated useless line.

&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> http_access allow http_ok
</I>&gt;<i> http_access allow CONNECT
</I>
 ... implicit &quot;deny all&quot; for everything which is not a CONNECT message
or matching http_bypass.

Okay. That sort of matches your policy. Except that you are missing the
security defaults. Those lines are carefully tuned for the specific
behaviour to protect against security attacks:

 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

.. and should be above your custom rules.

&gt;<i> no_cache allow all
</I>&gt;<i> cache deny all
</I>
&quot;no_cache&quot; is an old confusing name for &quot;cache&quot; directive. So what you
have there is actually:

 cache allow all
 cache deny all

... pick one.


&gt;<i> shutdown_lifetime 3 seconds
</I>&gt;<i> 
</I>
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010002.html">[squid-users] filtering http(s) sites, transparently
</A></li>
	<LI>Next message (by thread): <A HREF="010020.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10011">[ date ]</a>
              <a href="thread.html#10011">[ thread ]</a>
              <a href="subject.html#10011">[ subject ]</a>
              <a href="author.html#10011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
