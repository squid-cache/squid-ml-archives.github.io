<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Kerberos authentication only working with 1 domain	server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20authentication%20only%20working%20with%201%20domain%0A%09server&In-Reply-To=%3Cb4b1da51a97d924d6188ad24c7066d3c%40webmail.die-britsies.co.za%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010050.html">
   <LINK REL="Next"  HREF="010018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Kerberos authentication only working with 1 domain	server</H1>
    <B>Drikus Brits</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20authentication%20only%20working%20with%201%20domain%0A%09server&In-Reply-To=%3Cb4b1da51a97d924d6188ad24c7066d3c%40webmail.die-britsies.co.za%3E"
       TITLE="[squid-users] Kerberos authentication only working with 1 domain	server">drikus at geocastsp.co.za
       </A><BR>
    <I>Tue Apr  5 13:50:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010050.html">[squid-users] select parent proxy based on ACL
</A></li>
        <LI>Next message (by thread): <A HREF="010018.html">[squid-users] Kerberos authentication only working with 1 domain server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10017">[ date ]</a>
              <a href="thread.html#10017">[ thread ]</a>
              <a href="subject.html#10017">[ subject ]</a>
              <a href="author.html#10017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> 

Hi Experts, 

After much struggling it seems i've reached some point of success but
yet still not. I've checked a multitude of websites for help before
coming here, but didn't get anything valuable yet. My problem as follows
:<i> 
</I>
I have 1x win2008R2 server that works with kerberos authentication, but
none of the other PC's in the network wants to work, the others all come
up with a login challenge/ 

My Configs : 

/etc/krb5.conf 

&lt;snip&gt;
 #cat /etc/krb5.conf
 [logging]

 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log [1]

 [libdefaults]
 default_realm = DOMAIN.CO.ZA
 dns_lookup_kdc = yes
 dns_lookup_realm = yes
 ticket_lifetime = 24h
 default_keytab_name = /etc/squid/PROXY.keytab

 #; for Windows 2008 with AES
 default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc
des-cbc-md5
 default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc
des-cbc-md5
 permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc
des-cbc-md5

 [realms]

 DOMAIN.CO.ZA = {
 kdc = mw-ad.domain.co.za
 admin_server = mw-ad.domain.co.za
 default_domain = domain.co.za
 }

 [domain_realm]

 .domain.co.za = DOMAIN.CO.ZA
 domain.co.za = DOMAIN.CO.ZA

 [login]
 krb4_convert = true
 krb4_get_tickets = false
&lt;/snip&gt; 

my /etc/squid/squid.conf 

 &lt;snip&gt;
 #auth_param negotiate program /usr/local/bin/negotiate_wrapper -d
--ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=gss-spnego
--domain=DOMAIN --kerberos /usr/lib/squid3/negotiate_kerberos_auth -d -i
###WORKING - half/half
 auth_param negotiate program /usr/lib/squid3/negotiate_wrapper_auth -d
--ntlm /usr/bin/ntlm_auth --diagnostics
--helper-protocol=squid-2.5-ntlmssp --domain=DOMAIN.CO.ZA --kerberos
/usr/lib/squid3/negotiate_kerberos_auth -d -s GSS_C_NO_NAME
 #auth_param negotiate program /usr/lib/squid3/negotiate_kerberos_auth
-d -s GSS_C_NO_NAME

 auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
--helper-protocol=gss-spnego --domain=DOMAIN.CO.ZA
 auth_param ntlm children 10
 auth_param ntlm keep_alive off

 auth_param basic program /usr/lib/squid3/basic_ldap_auth -b
&quot;DC=domain,DC=co,DC=za&quot; -f sAMAccountName=%s -D &quot;CN=Folder
Authentication,CN=Users,DC=domain,DC=co,DC=za&quot; -w <A HREF="https://lists.squid-cache.org/listinfo/squid-users">P at 55w0rd</A> -H
<A HREF="ldap://MW-AD.domain.co.za">ldap://MW-AD.domain.co.za</A> -R
 auth_param basic realm Web-Proxy
 auth_param basic credentialsttl 1 minute

 acl proxy-auth proxy_auth REQUIRED

 http_access allow proxy-auth
 &lt;/snip&gt; 

When the Win2008R2 connectes is get the following in
/var/log/squid3/cache.log 

 &lt;snip&gt; 

 2016/04/05 12:26:46| negotiate_wrapper: Got 'YR
YIIHDwYGKwYBBQUCoIIHAzCCBv+gMDAuBgkqhkiC9xIBAgIGCSq&lt;truncated&gt;DVzSeCUH4ntF1lHc='
from squid (length: 2419).
 2016/04/05 12:26:46| negotiate_wrapper: Decode
'YIIHDwYGKwYBBQUCoIIHAzCCBv+gMDAuBg&lt;truncated&gt;UnIKhxWxh52aDVzSeCUH4ntF1lHc='
(decoded length: 1811).
 2016/04/05 12:26:46| negotiate_wrapper: received Kerberos token
 negotiate_kerberos_auth.cc(315): pid=8218 :2016/04/05 12:26:46|
negotiate_kerberos_auth: DEBUG: Got 'YR
YIIHDwYGKwYBBQUCoIIHAzCCBv+gMDAuB&lt;truncated&gt;JDp51PN7RjUnIKhxWxh52aDVzSeCUH4ntF1lHc='
from squid (length: 2419).
 negotiate_kerberos_auth.cc(378): pid=8218 :2016/04/05 12:26:46|
negotiate_kerberos_auth: DEBUG: Decode
'YIIHDwYGKwYBBQUCoIIHAzCCBv+gMDAuBgkqhkiC9xI&lt;truncated&gt;51PN7RjUnIKhxWxh52aDVzSeCUH4ntF1lHc='
(decoded length: 1811).
 2016/04/05 12:26:46| negotiate_wrapper: Return 'AF
oYG2MIGzoAMKAQChCwYJ&lt;truncated&gt;ZuxzWyWJhUSZttUH70Vw595AsuKtUWvtGjGC7vGmD5Ugufw=
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Administrator at DOMAIN.CO.ZA</A> 

 &lt;/snip&gt; 

But when other PC's connect of which another win2008R2 or win10 or win7
i get : 

 &lt;snip&gt; 

 negotiate_kerberos_auth.cc(315): pid=9389 :2016/04/05 12:33:47|
negotiate_kerberos_auth: DEBUG: Got 'YR
YIIHDwYGKwYBBQUCoII&lt;truncated&gt;+BnGBajMprtChSPMuUX9nnZfT+cJk=' from squid
(length: 2419).
 negotiate_kerberos_auth.cc(378): pid=9389 :2016/04/05 12:33:47|
negotiate_kerberos_auth: DEBUG: Decode
'YIIHDwYGKwYBBQUCoIIHAzCCBv&lt;truncated&gt;MprtChSPMuUX9nnZfT+cJk=' (decoded
length: 1811).
 negotiate_kerberos_auth.cc(200): pid=9389 :2016/04/05 12:33:47|
negotiate_kerberos_auth: ERROR: gss_accept_sec_context() failed:
Unspecified GSS failure. Minor code may provide more information.
 2016/04/05 12:33:47| ERROR: Negotiate Authentication validating user.
Error returned 'BH gss_accept_sec_context() failed: Unspecified GSS
failure. Minor code may provide more information. ' 

 &lt;/snip&gt; 

My kinit -V -kt /etc/squid3/PROXY.keytab , of which i'm sure if not
supposed to say that :). I've had others that had Successfully
authenticated to Kerberos V5 as well, but then the working win2008r2
doesn't work -- see below.. 

 &lt;snip&gt; 

 # kinit -V -kt /etc/squid3/PROXY.keytab
 Using default cache: /tmp/krb5cc_0
 Using principal: host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
 Using keytab: /etc/squid3/PROXY.keytab
 kinit: Preauthentication failed while getting initial credentials 

 &lt;/snip&gt; 

working with &quot;authenticated with kerberos but no srv or pc working 

 &lt;snip&gt; 

 msktutil -c -b &quot;CN=COMPUTERS&quot; -s HTTP/mw-sqproxy-test -s
HTTP/mw-sqproxy-test.domain.co.za -h mw-sqproxy-test.domain.co.za -k
/etc/squid3/PROXY.keytab --computer-name MWSQPROXYTEST --upn
HOST/mw-sqproxy-test.domain.co.za --server mw-ad.domain.co.za --verbose
--enctypes 28 

 &lt;/snip&gt; 

my working klist entries 

 &lt;snip&gt; 

 klist -ekt /etc/squid3/PROXY.keytab 

 Keytab name: FILE:/etc/squid3/PROXY.keytab
 KVNO Timestamp Principal
 ---- -------------------
------------------------------------------------------
 2 04/04/2016 11:43:43 MW-SQPROXY-TEST$@DOMAIN.CO.ZA (arcfour-hmac)
 2 04/04/2016 11:43:43 MW-SQPROXY-TEST$@DOMAIN.CO.ZA
(aes128-cts-hmac-sha1-96)
 2 04/04/2016 11:43:43 MW-SQPROXY-TEST$@DOMAIN.CO.ZA
(aes256-cts-hmac-sha1-96)
 2 05/04/2016 09:50:05 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 2 05/04/2016 09:50:05 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 2 05/04/2016 09:50:05 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 2 05/04/2016 09:43:05 HOST/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 2 05/04/2016 09:43:05 HOST/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 2 05/04/2016 09:43:05 HOST/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 2 05/04/2016 09:43:06 HOST/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(arcfour-hmac)
 2 05/04/2016 09:43:06 HOST/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 2 05/04/2016 09:43:06 HOST/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 2 05/04/2016 09:50:06 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(arcfour-hmac)
 2 05/04/2016 09:50:06 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 2 05/04/2016 09:50:06 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 2 05/04/2016 09:50:05 MWSQPROXYTEST$@DOMAIN.CO.ZA (arcfour-hmac)
 2 05/04/2016 09:50:05 MWSQPROXYTEST$@DOMAIN.CO.ZA
(aes128-cts-hmac-sha1-96)
 2 05/04/2016 09:50:05 MWSQPROXYTEST$@DOMAIN.CO.ZA
(aes256-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 MWSQPROXYTEST$@DOMAIN.CO.ZA (arcfour-hmac)
 3 05/04/2016 10:15:33 MWSQPROXYTEST$@DOMAIN.CO.ZA
(aes128-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 MWSQPROXYTEST$@DOMAIN.CO.ZA
(aes256-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(arcfour-hmac)
 3 05/04/2016 10:15:33 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 4 04/04/2016 16:29:08 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 4 04/04/2016 16:29:09 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 4 04/04/2016 16:29:09 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 3 05/04/2016 10:15:33 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(arcfour-hmac)
 3 05/04/2016 10:15:33 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 3 05/04/2016 10:15:33 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test.domain.co.za at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 5 04/04/2016 19:19:28 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 5 04/04/2016 19:19:28 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 5 04/04/2016 19:19:28 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 6 04/04/2016 19:22:47 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 6 04/04/2016 19:22:47 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 6 04/04/2016 19:22:47 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96)
 7 04/04/2016 20:40:09 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A> (arcfour-hmac)
 7 04/04/2016 20:40:09 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes128-cts-hmac-sha1-96)
 7 04/04/2016 20:40:09 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mw-sqproxy-test at DOMAIN.CO.ZA</A>
(aes256-cts-hmac-sha1-96) 

 &lt;/snip&gt; 

I'm using the fqdn in IE to authenticate with kerberos, if i change it
to IP it only tries NTLM, which i'm assuming is correct or not? 

I've investigated the PC's and all of them have properly joined the
domain. 

I've checked and i'm getting kvno 3 values from a working win2008r2 as
well as kvno 3 values from other pc's but yet, they have a popup asking
auth details. 
-- 

Drikus Brits 

 

Links:
------
[1] FILE:/var/log/kadmind.log
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160405/a9af4fbb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160405/a9af4fbb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010050.html">[squid-users] select parent proxy based on ACL
</A></li>
	<LI>Next message (by thread): <A HREF="010018.html">[squid-users] Kerberos authentication only working with 1 domain server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10017">[ date ]</a>
              <a href="thread.html#10017">[ thread ]</a>
              <a href="subject.html#10017">[ subject ]</a>
              <a href="author.html#10017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
