<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External ACL Lookup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20ACL%20Lookup&In-Reply-To=%3C57050436.9070908%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010025.html">
   <LINK REL="Next"  HREF="010070.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External ACL Lookup</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20ACL%20Lookup&In-Reply-To=%3C57050436.9070908%40treenet.co.nz%3E"
       TITLE="[squid-users] External ACL Lookup">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr  6 12:42:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010025.html">[squid-users] External ACL Lookup
</A></li>
        <LI>Next message (by thread): <A HREF="010070.html">[squid-users] External ACL Lookup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10039">[ date ]</a>
              <a href="thread.html#10039">[ thread ]</a>
              <a href="subject.html#10039">[ subject ]</a>
              <a href="author.html#10039">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/04/2016 9:16 a.m., Craddock, Tommy wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> Trying to use an external ACL helper to do a lookup of my user in a group in a Windows AD.  I can test from the command line:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /usr/lib64/squid/squid_ldap_group -R -K -S -b &quot;dc=example,dc=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Squid at example.com</A> -W /etc/squid/password -f &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=cn=%g,ou=Some Group,dc=EXAMPLE,dc=COM))&quot; -h dc01.example.com
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access
</I>&gt;<i> OK
</I>&gt;<i> 
</I>
I'm always a little suspicious about whitespace in the LDAP parameters.
Such as you have for &quot;ou=Some Group&quot; in the -f filter.

It does depend on how new vs old your Squid is whether that will be
treated as two parameters or one passed to the helper by Squid. The
commmad line test will always pass it as one parameter.

If you can rework your ou= parameter to avoid the whitespace it might
work better (just a maybe, but you do have Squid 3.1).

&gt;<i> 
</I>&gt;<i> In the cache.log w/debug set to ALL,3:
</I>&gt;<i> 
</I>&gt;<i> 2016/04/05 16:54:39.768| aclMatchExternal: memberof user not authenticated (0)
</I>&gt;<i> GETTING KERB TOKEN.....
</I>&gt;<i> ...
</I>&gt;<i> 2016/04/05 16:54:39.780| authenticateAuthUserAddIp: user '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A>' has been seen at a new IP address (172.23.5.193:56059)
</I>&gt;<i> 2016/04/05 16:54:39.780| aclMatchExternal: memberof(&quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access&quot;) = lookup needed
</I>&gt;<i> 2016/04/05 16:54:39.780| aclMatchExternal: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access&quot;: entry=@0, age=0
</I>&gt;<i> 2016/04/05 16:54:39.780| aclMatchExternal: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access&quot;: queueing a call.
</I>&gt;<i> 2016/04/05 16:54:39.780| aclMatchExternal: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access&quot;: return -1.
</I>&gt;<i> 2016/04/05 16:54:39.780| externalAclLookup: lookup in 'memberof' for '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access'
</I>&gt;<i> 2016/04/05 16:54:39.784| externalAclHandleReply: reply=&quot;ERR&quot;
</I>&gt;<i> 2016/04/05 16:54:39.785| external_acl_cache_add: Adding '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> Full.Access' = 0
</I>&gt;<i> 2016/04/05 16:54:39.785| aclMatchExternal: memberof = 0
</I>&gt;<i> 
</I>&gt;<i> In the file referenced in the ACLs:
</I>&gt;<i> 
</I>&gt;<i> acl RestrictedAccess    external memberof &quot;/etc/squid/restricted_access.txt&quot;
</I>&gt;<i> acl FullAccess          external memberof &quot;/etc/squid/full_access.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> it has:
</I>&gt;<i> 
</I>&gt;<i> cat /etc/squid/full_access.txt
</I>&gt;<i> Full.Access
</I>&gt;<i> 
</I>&gt;<i> cat /etc/squid/restricted_access.txt
</I>&gt;<i> Restricted.Access
</I>&gt;<i> 
</I>
Speaking of white spaces. The only reason for using files there is when
the group name contains a whitespace character. TO avoid a squid.conf
parser bug (Sorry). If those dots are in fact dots and not spaces, then
you dont need the extra files.


&gt;<i> Im not sure why the logs show my user is getting ERR as the response to group checking, when I run it from the command line, I get an OK.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Info about my setup:
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at clwslprox01p</A> squid]# squid -v
</I>&gt;<i> Squid Cache: Version 3.1.23
</I>&gt;<i> configure options:  '--build=x86_64-redhat-linux-gnu' '--host=x86_64-redhat-linux-gnu' '--target=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr' '--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin' '--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include' '--libdir=/usr/lib64' '--libexecdir=/usr/libexec' '--sharedstatedir=/var/lib' '--mandir=/usr/share/man' '--infodir=/usr/share/info' '--enable-internal-dns' '--disable-strict-error-checking' '--exec_prefix=/usr' '--libexecdir=/usr/lib64/squid' '--localstatedir=/var' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-logdir=$(localstatedir)/log/squid' '--with-pidfile=$(localstatedir)/run/squid.pid' '--disable-dependency-tracking' '--enable-arp-acl' '--enable-follow-x-forwarded-for' '--enable-auth=basic,digest,ntlm,negotiate' '--enable-basic-auth-helpers=LDAP,MSNT,NCSA,PAM,SMB,YP,getpwnam,multi-domain-NTLM,SASL,DB,POP3,squid_radius_auth' '--enable-ntlm-auth-helpers=smb_lm,no_check,fake
</I>auth' '--enable-digest-auth-helpers=password,ldap,eDirectory' '--enable-negotiate-auth-helpers=squid_kerb_auth' '--enable-external-acl-helpers=ip_user,ldap_group,session,unix_group,wbinfo_group' '--enable-cache-digests' '--enable-cachemgr-hostname=localhost' '--enable-delay-pools' '--enable-epoll' '--enable-icap-client' '--enable-ident-lookups' '--enable-linux-netfilter' '--enable-referer-log' '--enable-removal-policies=heap,lru' '--enable-snmp' '--enable-ssl' '--enable-storeio=aufs,diskd,ufs' '--enable-useragent-log' '--enable-wccpv2' '--enable-esi' '--enable-http-violations' '--with-aio' '--with-default-user=squid' '--with-filedescriptors=16384' '--with-dl' '--with-openssl' '--with-pthreads' 'build_alias=x86_64-redhat-linux-gnu' 'host_alias=x86_64-redhat-linux-gnu' 'target_alias=x86_64-redhat-linux-gnu' 'CFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic -fpie' 'LDFLAGS=-pie' 'CXXFLAGS=-O2 -g -pipe -Wall -W
p,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic -fpie' --with-squid=/builddir/build/BUILD/squid-3.1.23
&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at clwslprox01p</A> squid]# cat /etc/redhat-release
</I>&gt;<i> Red Hat Enterprise Linux Server release 6.7 (Santiago)
</I>&gt;<i> 
</I>&gt;<i> Using negotiate w/NTLM and Kerberos to do user auth, and trying to use external helpers to do group lookups to a Windows AD.  Windows AD is 2008 and 2012 in my env.
</I>&gt;<i> 
</I>&gt;<i> Squid.conf:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ### cache manager
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">pclan at example.com</A>
</I>&gt;<i> 
</I>&gt;<i> #Define the cache_peer to be used
</I>&gt;<i> # cache_peer proxy1.ap.webscanningservice.com parent 3128 0000 default no-query no-digest
</I>&gt;<i> # cache_peer proxy1.eu.webscanningservice.com parent 3128 0000 default no-query no-digest
</I>&gt;<i>   cache_peer proxy1.us.webscanningservice.com parent 3128 0000 default no-query no-digest
</I>&gt;<i> # cache_peer proxy1.hk.webscanningservice.com parent 3128 0000 default no-query no-digest
</I>&gt;<i> # cache_peer proxy1.eu.webscanningservice.com parent 3128 0000 default no-query no-digest
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ### negotiate kerberos and ntlm authentication
</I>&gt;<i> auth_param negotiate program /usr/local/bin/negotiate_wrapper -d --ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=EXAMPLE.COM --require-membership-of=EXAMPLE\\Full.Access -kerberos /usr/lib64/squid/squid_kerb_auth -d -s GSS_C_NO_NAME
</I>&gt;<i> auth_param negotiate children 10
</I>&gt;<i> auth_param negotiate keep_alive off
</I>&gt;<i> 
</I>&gt;<i> ### pure ntlm authentication
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --require-membership-of=EXAMPLE\\Full.Access
</I>&gt;<i> auth_param ntlm children 30
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> ### provide basic authentication via ldap for clients not authenticated via kerberos/ntlm
</I>&gt;<i> auth_param basic program /usr/lib64/squid/squid_ldap_auth -R -b &quot;dc=example,dc=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Squid at EXAMPLE.COM</A> -W /etc/squid/password -f sAMAccountName=%s -h DC01.EXAMPLE.COM
</I>&gt;<i> auth_param basic children 10
</I>&gt;<i> auth_param basic realm Internet Proxy
</I>&gt;<i> auth_param basic credentialsttl 1 minute
</I>&gt;<i> 
</I>

Your NTLM and Negotiate authenticators have a parameter requiring
membership of the Ful.Access group as part of the auth process.

That means you should be able to use the auth type to tell what group
they are a member of.


&gt;<i> ### ldap authorisation
</I>&gt;<i> external_acl_type memberof %LOGIN /usr/lib64/squid/squid_ldap_group -R -K -S -b &quot;dc=example,dc=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Squid at EXAMPLE.COM</A> -W /etc/squid/.ldappass.txt -f &quot;(&amp;(objectclass=person)(sAMAccountName=$)(memberof=cn=%g,ou=Some Group,dc=EXAMPLE,dc=COM))&quot; -h DC01.EXAMPLE.COM
</I>&gt;<i> 
</I>&gt;<i> ### acl for proxy auth and ldap authorizations
</I>&gt;<i> acl our_networks src  172.16.0.0/12 10.0.0.0/8 192.170.0.0/24
</I>&gt;<i> acl INTERNAL dst 172.16.0.0/12 10.0.0.0/8
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> acl HEAD method HEAD
</I>&gt;<i> acl RestrictedAccess    external memberof &quot;/etc/squid/restricted_access.txt&quot;
</I>&gt;<i> acl FullAccess          external memberof &quot;/etc/squid/full_access.txt&quot;
</I>&gt;<i> acl Approved_Domains dstdomain &quot;/etc/squid/acls/approved.txt&quot;
</I>&gt;<i> acl WindowsUpdate dstdomain -i &quot;/etc/squid/acls/windowsupdates.txt&quot;
</I>&gt;<i> acl local-servers dstdomain &quot;/etc/squid/acls/localservers.txt&quot;
</I>&gt;<i> acl RestrictedHost src &quot;/etc/squid/acls/restrictedhost_ip.txt&quot;
</I>&gt;<i> acl bypass_auth src &quot;/etc/squid/acls/bypass_auth_src_ip.txt&quot;
</I>&gt;<i> acl bypass_auth-external dstdomain &quot;/etc/squid/acls/bypass_auth_dst_domain.txt&quot;
</I>&gt;<i> acl blocksites dstdomain &quot;/etc/squid/acls/block_sites.txt&quot;
</I>&gt;<i> acl DIRECT src &quot;/etc/squid/acls/direct_src_ip.txt&quot;
</I>&gt;<i> acl DIRECT-external dstdomain &quot;/etc/squid/acls/direct_dst_domains.txt&quot;
</I>&gt;<i> acl Smartconnect dstdomain ned.webscanningservice.com
</I>&gt;<i> acl Java browser Java/[0-9]
</I>&gt;<i> acl JavaSites dstdomain .gotomeeting.com
</I>&gt;<i> always_direct allow INTERNAL
</I>&gt;<i> always_direct allow local-servers
</I>&gt;<i> cache deny INTERNAL
</I>&gt;<i> cache deny local-servers
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ### squid defaults
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32 ::1
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
</I>&gt;<i> acl SSL_ports port 443 563 33808
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443 563     # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> #allow custom ports
</I>&gt;<i> acl goto_meeting dst 216.115.208.0/20 216.219.112.0/20 66.151.158.0/24 66.151.150.160/27 66.151.115.128/26 64.74.80.0/24 202.173.24.0/21 67.217.64.0/19 78.108.112.0/20 68.64.0.0/19 206.183.100.0/22
</I>&gt;<i> acl Safe_ports port 8200        # gotomeeting
</I>&gt;<i> acl Safe_ports port 31303 33808 # TD Merchant
</I>&gt;<i> acl Safe_ports port 8443        # Symantec SEP Manager
</I>&gt;<i> acl Safe_ports port 8014               # Symantec SEPM Client
</I>&gt;<i> acl SSL_ports port 9443         # pingdevfed
</I>&gt;<i> acl SSL_ports port 9444         # pingdevfed
</I>&gt;<i> acl SSL_ports port 5443         # pingdev
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> #http_access deny !memberof
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow HEAD
</I>&gt;<i> http_access deny !our_networks
</I>&gt;<i> http_access allow Smartconnect
</I>&gt;<i> http_access deny blocksites all
</I>&gt;<i> http_access allow Approved_Domains
</I>&gt;<i> http_access deny RestrictedHost all
</I>&gt;<i> http_access allow FullAccess auth
</I>
NP: FullAccess and auth ACLs require authentication to take place.

What is the point of the Java and WindowsUpdate and bypass_auth ACLs
being tested *after* auth has already been required of the client?

Surely the bypasses should be first and the auth related things after.

&gt;<i> http_access allow Java
</I>&gt;<i> http_access allow WindowsUpdate
</I>&gt;<i> http_access allow bypass_auth
</I>&gt;<i> http_access allow bypass_auth-external
</I>&gt;<i> http_access allow goto_meeting
</I>&gt;<i> http_access allow our_networks all
</I>&gt;<i> http_access allow Java our_networks JavaSites
</I>&gt;<i> http_access allow auth
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
Generally the best pattern to use when designing http_access sequences
is this:

+ allow &lt;things that bypass auth&gt;
+ &quot;deny !auth&quot;
+ allow &lt;things that require auth&gt;
+ &quot;deny all&quot;



Amos



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010025.html">[squid-users] External ACL Lookup
</A></li>
	<LI>Next message (by thread): <A HREF="010070.html">[squid-users] External ACL Lookup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10039">[ date ]</a>
              <a href="thread.html#10039">[ thread ]</a>
              <a href="subject.html#10039">[ subject ]</a>
              <a href="author.html#10039">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
