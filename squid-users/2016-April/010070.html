<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External ACL Lookup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20ACL%20Lookup&In-Reply-To=%3CCA86A9283AA07E478F6B0629521FFEE734D05D%40CLWSEXCMBX02.na.bicworld.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010039.html">
   <LINK REL="Next"  HREF="010026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External ACL Lookup</H1>
    <B>Craddock, Tommy</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20ACL%20Lookup&In-Reply-To=%3CCA86A9283AA07E478F6B0629521FFEE734D05D%40CLWSEXCMBX02.na.bicworld.com%3E"
       TITLE="[squid-users] External ACL Lookup">Tommy.Craddock at bicgraphic.com
       </A><BR>
    <I>Thu Apr  7 14:47:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010039.html">[squid-users] External ACL Lookup
</A></li>
        <LI>Next message (by thread): <A HREF="010026.html">[squid-users] Sending intermediate certificate with SSL-Bumped Certificate. (V3.5.1516-3-2-r14000)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10070">[ date ]</a>
              <a href="thread.html#10070">[ thread ]</a>
              <a href="subject.html#10070">[ subject ]</a>
              <a href="author.html#10070">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>My replies are interspersed below, in between lines of

_______________________________________________________________________________________________________________________________________


On 6/04/2016 9:16 a.m., Craddock, Tommy wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> Trying to use an external ACL helper to do a lookup of my user in a group in a Windows AD.  I can test from the command line:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /usr/lib64/squid/squid_ldap_group -R -K -S -b &quot;dc=example,dc=com&quot; -D 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Squid at example.com</A> -W /etc/squid/password -f 
</I>&gt;<i> &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=cn=%g,ou=Some 
</I>&gt;<i> Group,dc=EXAMPLE,dc=COM))&quot; -h dc01.example.com <A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at EXAMPLE.COM</A> 
</I>&gt;<i> Full.Access OK
</I>&gt;<i> 
</I>
I'm always a little suspicious about whitespace in the LDAP parameters.
Such as you have for &quot;ou=Some Group&quot; in the -f filter.

It does depend on how new vs old your Squid is whether that will be treated as two parameters or one passed to the helper by Squid. The commmad line test will always pass it as one parameter.

If you can rework your ou= parameter to avoid the whitespace it might work better (just a maybe, but you do have Squid 3.1).

_______________________________________________________________________________________________________________________________________________
MY REPLY:


Amos, I moved my group into a different OU, called Some.OU, and it still gives me the same result in the cache.log:


In squid.conf:

external_acl_type memberof %LOGIN /usr/lib64/squid/squid_ldap_group -R -K -S -b &quot;dc=example,dc=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Squid at example.com</A> -W /etc/squid/password -f &quot;(&amp;(objectclass=person)(sAMAccountName=$)(memberof=cn=%g,ou=Some.OU,dc=example,dc=com))&quot; -h dc01.example.com


In cache.log:

2016/04/07 09:26:55.123| aclMatchExternal: memberof(&quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at example.com</A> Full.Access&quot;) = lookup needed
2016/04/07 09:26:55.123| aclMatchExternal: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at example.com</A> Full.Access&quot;: entry=@0, age=0
2016/04/07 09:26:55.123| aclMatchExternal: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at example.com</A> Full.Access&quot;: queueing a call.
2016/04/07 09:26:55.123| aclMatchExternal: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at example.com</A> Full.Access&quot;: return -1.
2016/04/07 09:26:55.123| externalAclLookup: lookup in 'memberof' for '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at example.com</A> Full.Access'
2016/04/07 09:26:55.128| externalAclHandleReply: reply=&quot;ERR&quot;
2016/04/07 09:26:55.128| external_acl_cache_add: Adding '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tcraddock at example.com</A> Full.Access' = 0
2016/04/07 09:26:55.128| aclMatchExternal: memberof = 0

__________________________________________________________________________________________________________________________________________________________________
&gt;<i> 
</I>&gt;<i> In the file referenced in the ACLs:
</I>&gt;<i> 
</I>&gt;<i> acl RestrictedAccess    external memberof &quot;/etc/squid/restricted_access.txt&quot;
</I>&gt;<i> acl FullAccess          external memberof &quot;/etc/squid/full_access.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> it has:
</I>&gt;<i> 
</I>&gt;<i> cat /etc/squid/full_access.txt
</I>&gt;<i> Full.Access
</I>&gt;<i> 
</I>&gt;<i> cat /etc/squid/restricted_access.txt
</I>&gt;<i> Restricted.Access
</I>&gt;<i> 
</I>
Speaking of white spaces. The only reason for using files there is when the group name contains a whitespace character. TO avoid a squid.conf parser bug (Sorry). If those dots are in fact dots and not spaces, then you dont need the extra files.


______________________________________________________________________________________________________________________________________
MY REPLY:

Understood, changed this to:

acl RestrictedAccess    external memberof Restricted.Access
acl FullAccess external memberof Full.Access

_______________________________________________________________________________________________________________________________________
&gt;<i> 
</I>&gt;<i> ### provide basic authentication via ldap for clients not 
</I>&gt;<i> authenticated via kerberos/ntlm auth_param basic program 
</I>&gt;<i> /usr/lib64/squid/squid_ldap_auth -R -b &quot;dc=example,dc=com&quot; -D 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Squid at EXAMPLE.COM</A> -W /etc/squid/password -f sAMAccountName=%s -h 
</I>&gt;<i> DC01.EXAMPLE.COM auth_param basic children 10 auth_param basic realm 
</I>&gt;<i> Internet Proxy auth_param basic credentialsttl 1 minute
</I>&gt;<i> 
</I>

Your NTLM and Negotiate authenticators have a parameter requiring membership of the Ful.Access group as part of the auth process.

That means you should be able to use the auth type to tell what group they are a member of.


_______________________________________________________________________________________________________________________________________

How?  Ive tried to find out how to use that in a ACL but I haven&#8217;t been able to find an example. Plus, since Im using negotiate with NTLM and Kerberos, if the client uses Kerberos, does the NTLM group membership parameter even get used?
_______________________________________________________________________________________________________________________________________
&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> #http_access deny !memberof
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow HEAD
</I>&gt;<i> http_access deny !our_networks
</I>&gt;<i> http_access allow Smartconnect
</I>&gt;<i> http_access deny blocksites all
</I>&gt;<i> http_access allow Approved_Domains
</I>&gt;<i> http_access deny RestrictedHost all
</I>&gt;<i> http_access allow FullAccess auth
</I>
NP: FullAccess and auth ACLs require authentication to take place.

What is the point of the Java and WindowsUpdate and bypass_auth ACLs being tested *after* auth has already been required of the client?

Surely the bypasses should be first and the auth related things after.

&gt;<i> http_access allow Java
</I>&gt;<i> http_access allow WindowsUpdate
</I>&gt;<i> http_access allow bypass_auth
</I>&gt;<i> http_access allow bypass_auth-external http_access allow goto_meeting 
</I>&gt;<i> http_access allow our_networks all http_access allow Java our_networks 
</I>&gt;<i> JavaSites http_access allow auth http_access deny !auth http_access 
</I>&gt;<i> deny all
</I>&gt;<i> 
</I>
Generally the best pattern to use when designing http_access sequences is this:

+ allow &lt;things that bypass auth&gt;
+ &quot;deny !auth&quot;
+ allow &lt;things that require auth&gt;
+ &quot;deny all&quot;



Amos
_______________________________________________________________________________________________________________________________________

How does this look?

http_access deny !our_networks
http_access allow manager localhost
http_access allow HEAD
http_access allow Smartconnect
http_access allow Java
http_access allow WindowsUpdate
http_access allow bypass_auth
http_access allow bypass_auth-external
http_access allow Approved_Domains
http_access allow goto_meeting
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny blocksites
http_access deny RestrictedHost
http_access deny !auth
http_access allow FullAccess auth
http_access allow auth
http_access deny all

_______________________________________________________________________________________________________________________________________

Thanks!


Tommy Craddock









______________________________________________________________________
This email has been scanned by the Symantec Email Security.cloud service.
For more information please visit <A HREF="http://www.symanteccloud.com">http://www.symanteccloud.com</A>
______________________________________________________________________
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010039.html">[squid-users] External ACL Lookup
</A></li>
	<LI>Next message (by thread): <A HREF="010026.html">[squid-users] Sending intermediate certificate with SSL-Bumped Certificate. (V3.5.1516-3-2-r14000)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10070">[ date ]</a>
              <a href="thread.html#10070">[ thread ]</a>
              <a href="subject.html#10070">[ subject ]</a>
              <a href="author.html#10070">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
