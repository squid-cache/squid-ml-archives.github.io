<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Logging of https
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logging%20of%20https&In-Reply-To=%3Ce825fc3535053d282235d6f1ccef6b22%40localhost%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010064.html">
   <LINK REL="Next"  HREF="010074.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Logging of https</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logging%20of%20https&In-Reply-To=%3Ce825fc3535053d282235d6f1ccef6b22%40localhost%3E"
       TITLE="[squid-users] Logging of https">jlay at slave-tothe-box.net
       </A><BR>
    <I>Thu Apr  7 15:34:22 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010064.html">[squid-users] Logging of https
</A></li>
        <LI>Next message (by thread): <A HREF="010074.html">[squid-users] Logging of https
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10072">[ date ]</a>
              <a href="thread.html#10072">[ thread ]</a>
              <a href="subject.html#10072">[ subject ]</a>
              <a href="author.html#10072">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>That's correct....peek/stare don't require a cert on the client end.  
Just keep in mind you won't get a full URL in the logs with https 
sites...just the host/ip:

Apr  7 09:30:31 gateway (squid-1): 192.168.1.106 - - 
[07/Apr/2016:09:30:31 -0600] &quot;CONNECT 216.58.193.78:443 HTTP/1.1&quot; 
safebrowsing.google.com - 200 871538 TCP_TUNNEL:ORIGINAL_DST

James

On 2016-04-07 07:11, Markey, Bruce wrote:
&gt;<i> Ok thanks for that.  I think I have a slightly better understanding of
</I>&gt;<i> what is going on.    That being said this is what I've come up with.
</I>&gt;<i> 
</I>&gt;<i> No caching.  All sites allowed, peeking at all.
</I>&gt;<i> 
</I>&gt;<i> I'm hoping this config will simply give me the logging that I'm
</I>&gt;<i> looking for and nothing else.  And from that link you sent I don't
</I>&gt;<i> have to install the client side cert?
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i>   1 #Access Lists
</I>&gt;<i>   2 acl internal src 192.168.200.0/21
</I>&gt;<i>   3 acl wireless src 192.168.100.0/23
</I>&gt;<i>   4
</I>&gt;<i>   5 #Ports allowed through Squid
</I>&gt;<i>   6 acl Safe_ports port 80
</I>&gt;<i>   7 acl Safe_ports port 443
</I>&gt;<i>   8 acl SSL_ports port 443
</I>&gt;<i>   9 acl CONNECT method CONNECT
</I>&gt;<i>  10
</I>&gt;<i>  11 #allow/deny
</I>&gt;<i>  12 http_access allow internal
</I>&gt;<i>  13 http_access allow wireless
</I>&gt;<i>  14 http_access deny !Safe_ports
</I>&gt;<i>  15 http_access deny CONNECT !SSL_ports
</I>&gt;<i>  16 http_access deny all
</I>&gt;<i>  17
</I>&gt;<i>  18 #Bumping
</I>&gt;<i>  19 acl step1 at_step SslBump1
</I>&gt;<i>  20 acl step2 at_step SslBump2
</I>&gt;<i>  21 acl step3 at_step SslBump3
</I>&gt;<i>  22
</I>&gt;<i>  23 ssl_bump peek all
</I>&gt;<i>  24 ssl_bump splice all
</I>&gt;<i>  25
</I>&gt;<i>  26 sslproxy_capath /etc/ssl/certs
</I>&gt;<i>  27
</I>&gt;<i>  28 sslcrtd_program /usr/lib/squid3/ssl_crtd -s /opt/var/ssl_db -M 6MB
</I>&gt;<i>  29 sslcrtd_children 5
</I>&gt;<i>  30
</I>&gt;<i>  31 #certs
</I>&gt;<i>  32 cert=/etc/squid3/certs/squid.pem
</I>&gt;<i>  33 cafile=/etc/squid3/certs/squid.pem
</I>&gt;<i>  34 key=/etc/squid3/certs/squid.pem generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=6MB sslflags=NO_SESSION_REUSE
</I>&gt;<i>  35
</I>&gt;<i>  36 logformat mine %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %ssl::&gt;sni
</I>&gt;<i> %ssl::&gt;cert_subject %&gt;Hs %&lt;st %Ss:%Sh
</I>&gt;<i>  37
</I>&gt;<i>  38 access_log syslog:daemon.info mine
</I>&gt;<i>  39
</I>&gt;<i>  40 #intercept
</I>&gt;<i>  41 http_port 3128 intercept
</I>&gt;<i>  42 https_port 3129 intercept ssl-bump
</I>&gt;<i>  43
</I>&gt;<i>  44 #nameservers
</I>&gt;<i>  45 dns_nameservers 192.168.201.1 8.8.8.8
</I>&gt;<i>  46
</I>&gt;<i>  47 #WCCPv2 items
</I>&gt;<i>  48 wccp_version 2
</I>&gt;<i>  49 wccp2_router 192.168.200.73
</I>&gt;<i>  50 wccp2_forwarding_method gre
</I>&gt;<i>  51 wccp2_return_method gre
</I>&gt;<i>  52 wccp2_service standard 0 password=LNP1
</I>&gt;<i>  53 wccp2_service dynamic 70 password=LNP1
</I>&gt;<i>  54 wccp2_service_info 70 protocol=tcp flags=dst_ip_hash priority=240 
</I>&gt;<i> ports=443
</I>&gt;<i>  55
</I>&gt;<i> 
</I>&gt;<i> Bruce Markey | Network Security Analyst
</I>&gt;<i> STEINMAN COMMUNICATIONS
</I>&gt;<i> 717.291.8758&#160;(o) |&#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bmarkey at steinmancommunications.com</A>
</I>&gt;<i> 8 West King St | PO Box 1328, Lancaster, PA 17608-1328
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;<i> On Behalf Of James Lay
</I>&gt;<i> Sent: Thursday, March 24, 2016 4:14 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Logging of https
</I>&gt;<i> 
</I>&gt;<i> On 2016-03-24 13:41, Markey, Bruce wrote:
</I>&gt;&gt;<i> I'm hoping this is a simple question, I've gotten/seen differing
</I>&gt;&gt;<i> answers and I'd just like a final answer.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> With squid setup as a transparent proxy via wccp will there be any log
</I>&gt;&gt;<i> entries for https sites, even just the ip?  Just the initial get
</I>&gt;&gt;<i> request is what I'd expect.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ( I have no interest in breaking https, I'd simply like to get any
</I>&gt;&gt;<i> data I can without having to go down that road)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If yes then what needs to be done to make that happen. Currently
</I>&gt;&gt;<i> everything is working on the http side perfectly.  Oh the https side
</I>&gt;&gt;<i> as soon as I enable wccp redirection of 443 to squid it breaks https.
</I>&gt;&gt;<i>  ( I'll add here that I've read all the peek and splice info and I
</I>&gt;&gt;<i> don't really understand it.)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> BRUCE MARKEY | Network Security Analyst
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> STEINMAN COMMUNICATIONS
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 717.291.8758 (o) | <A HREF="https://lists.squid-cache.org/listinfo/squid-users">bmarkey at steinmancommunications.com</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 8 West King St | PO Box 1328, Lancaster, PA 17608-1328
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Read this:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://thread.gmane.org/gmane.comp.web.squid.general/114384/focus=114389">http://thread.gmane.org/gmane.comp.web.squid.general/114384/focus=114389</A>
</I>&gt;<i> 
</I>&gt;<i> Sample messages:
</I>&gt;<i> 
</I>&gt;<i> allowed https:
</I>&gt;<i> Mar 24 14:02:11 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i> [24/Mar/2016:14:02:11 -0600] &quot;CONNECT 209.59.180.48:443 HTTP/1.1&quot; - -
</I>&gt;<i> 200 5511 TCP_TUNNEL:ORIGINAL_DST
</I>&gt;<i> 
</I>&gt;<i> note the size, 5511, and the TCP_TUNNEL, this has no SNI
</I>&gt;<i> 
</I>&gt;<i> denied https:
</I>&gt;<i> Mar 24 13:36:01 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i> [24/Mar/2016:13:36:01 -0600] &quot;CONNECT 54.171.35.38:443 HTTP/1.1&quot; - - 
</I>&gt;<i> 200
</I>&gt;<i> 0 TAG_NONE:ORIGINAL_DST
</I>&gt;<i> 
</I>&gt;<i> note the size, 0, and the TAG_NONE, and this also has no SNI
</I>&gt;<i> 
</I>&gt;<i> Mar 24 13:36:01 gateway (squid-1): 192.168.1.101 - -
</I>&gt;<i> [24/Mar/2016:13:36:01 -0600] &quot;CONNECT 54.171.177.121:443 HTTP/1.1&quot;
</I>&gt;<i> track.appsflyer.com - 200 0 TAG_NONE:ORIGINAL_DST
</I>&gt;<i> 
</I>&gt;<i> again, size, and TAG_NONE, but we saw SNI for this one.
</I>&gt;<i> 
</I>&gt;<i> the above are the output when using the config info in the link.  Hope
</I>&gt;<i> that helps.
</I>&gt;<i> 
</I>&gt;<i> James
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010064.html">[squid-users] Logging of https
</A></li>
	<LI>Next message (by thread): <A HREF="010074.html">[squid-users] Logging of https
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10072">[ date ]</a>
              <a href="thread.html#10072">[ thread ]</a>
              <a href="subject.html#10072">[ subject ]</a>
              <a href="author.html#10072">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
