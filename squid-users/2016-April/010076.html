<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.16 and vary loop objects (bug ?)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.16%20and%20vary%20loop%20objects%20%28bug%20%3F%29&In-Reply-To=%3C57069F68.6010000%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010071.html">
   <LINK REL="Next"  HREF="010046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.16 and vary loop objects (bug ?)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.16%20and%20vary%20loop%20objects%20%28bug%20%3F%29&In-Reply-To=%3C57069F68.6010000%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.16 and vary loop objects (bug ?)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr  7 17:56:56 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010071.html">[squid-users] Squid 3.5.16 and vary loop objects (bug ?)
</A></li>
        <LI>Next message (by thread): <A HREF="010046.html">[squid-users] Squid 3.5.16 and vary loop objects (bug ?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10076">[ date ]</a>
              <a href="thread.html#10076">[ thread ]</a>
              <a href="subject.html#10076">[ subject ]</a>
              <a href="author.html#10076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/04/2016 2:39 a.m., joe wrote:
&gt;<i> some of my post you miss reading or
</I>&gt;<i> wen i ask for water  and i get water  same size same glas  but i was offered
</I>&gt;<i> somthing else i was refuse that
</I>
In terms of the protocol, you cant refuse exactly. It is what was
responded with. The server/provider 'owns' the resource and is the
control authority about what should be provided to any request.


&gt;<i> and my friend ask for the same he should get same glas of water same size
</I>&gt;<i> so what i was trying to enplane is
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> i ask  for gzip  the the md5 vary calculate with string
</I>
Asking for gzip would be sending the header exact and full value of:
  Accept-Ecoding: gzip\r\n

... not the below multiple list of values:

&gt;<i> accept-encoding=&quot;gzip,%20deflate,%20sdch&quot; 
</I>&gt;<i> so the gzip dose not have %20  on front of it so we can use only that and
</I>
%20 is a space character when URL-encoded for adding to the URL hash key.

The client sending a request with that header value(s) is asking for
gzip OR deflate OR sdch encoding (in that order of preference). The
server decides whether one of those can be produced. And identity
encoding (unencoded) is guaranteed to always be acceptible.


&gt;<i> filter out those ,%20deflate,%20sdch
</I>&gt;<i> it will be string accept-encoding=&quot;gzip&quot; use  that in md5 calc only
</I>&gt;<i> if other browser has in vary string accept-encoding=&quot;gzip,%20deflate&quot; 
</I>&gt;<i> without examle  %20sdch
</I>&gt;<i> md5 calc use string accept-encoding=&quot;gzip,%20deflate&quot;
</I>&gt;<i> so we also filter out -- &gt; ,%20deflate
</I>&gt;<i> and keep only to use md5 with  string accept-encoding=&quot;gzip&quot;
</I>&gt;<i> 
</I>&gt;<i> since  gzip dose not have %20 on front of it
</I>
What if the sdch was the type that server actually wanted to produce?
If you are using Google Docs sdch objects actually *are* more often than
not what gets sent. Its a type of patch/diff format for collaborative
tools updating an object in bits and pieces.

&gt;<i> 
</I>&gt;<i> that will make a beter hit without any problem on all browser
</I>&gt;<i> 
</I>
*Maybe*. You are free to do so if you like. We cannot do it in the
general case though for Squid has to work according to proper HTTP
requirements in networks other than yours (and there are several others
also wanting this same thing have configured their proxies to do it).


&gt;<i> as i says and i test the link i provide before   
</I>&gt;<i> on firefox   first time after the cache ar empty  i get HIT  alwes just by
</I>&gt;<i> using firefox
</I>&gt;<i> until now perfect
</I>&gt;<i> 
</I>&gt;<i> but  wen i use chrome since it send and resive in very  string
</I>&gt;<i> accept-encoding=&quot;gzip,%20deflate,%20sdch&quot;
</I>&gt;<i> the cached file ar deleted and resolt  = MISS  then it re creat new file
</I>&gt;<i> with HIT alwes just by using chrome
</I>&gt;<i> 
</I>&gt;<i> if i return to firefox its  MISS  then file got purged from cache then its
</I>&gt;<i> HIT again
</I>
Two things:

1) MISS does not mean any content was thrown away. It just means what
was already in the cache was not able to be used.
  - it can happen because of a max-age=0 or no-cache from the client.
Chrome and other Google products seem to like sending those. Very
unfriendly to caches.
  - it can happen if Vary exists and the particular object this request
needs is not one of the current set of variants in the cache.

2) You can have the appearance of stuff being &quot;thrown away&quot; if the Vary
marker object used to store the pattern actually was thrown away for
some reason. Without it there is no way to reach the variant objects
which are still in cache.
 - A MISS is needed in order to re-fetch a response with Vary pattern to
create the marker, and bingo all the variants that pattern describes
which were still in the cache can be fetched as HITs again.
 - BUT, if the Vary pattern changed they stay 'lost'.

This #2 is a common problem seen with Apache servers which emit
different Vary patterns depending on which modules were run on the request.


&gt;<i> 
</I>&gt;<i> if other browser has  vary  with string
</I>&gt;<i> accept-encoding=&quot;%20gzip,deflate,%20sdch&quot;
</I>&gt;<i> watch this      deflate   has no ---&gt;&gt; %20 in front of it so md5 calc should
</I>&gt;<i> use only deflate   not encluding the one with  %20   string
</I>&gt;<i> this how i understand it   and i monitor those prossess i prove that is
</I>&gt;<i> waste
</I>
Whitespace normalization (or lack of it rather) does cause wastage. The
only reason that is not done is nobody did it yet. Patches fixing that
are welcome.

&gt;<i> 
</I>&gt;<i> so anoter example cause i dont know if im trying to explain it in right
</I>&gt;<i> manner 
</I>&gt;<i>  another browser get vary  string accept-encoding=&quot;%20gzip,%20deflate,sdch&quot;
</I>&gt;<i> as you see  sdch  its the one used  so we must use that filter out the rest 
</I>&gt;<i> 
</I>&gt;<i> variety with string confuse the correct match match lookup it it purge the
</I>&gt;<i> same file just becaus somthing in vary has extra string and its not used
</I>&gt;<i> 
</I>
A)
I know what you are trying to say. I'm trying to say why its not
necessarily such a great idea (for Squid). There are subtle things in
the protocol design that prevent it and/or would be broken by it.


B)
You are also focused on The Browser(s). Some of the smart guys in IETF
HTTP Working Group did some research a few months ago. Its a funny story
really:

* the Chrome guys did their research and found that almost all servers
responding to Chrome could be forced to send gzip. With all modern
browsers supporting gzip there are great bandwidth reduction benefits
waiting to be had. Therefore argued that gzip should be the one and only
output from server by default and middleware like Squid should
auto-encode to produce gzip only.

* the server guys did their own research and found that Browser traffic
was less than ~20% of HTTP total traffic (and declining as IoT
increases). Optimizing all networks for the Browsers causes big problems
for all that major portion of non-Browser traffic which consists of
tools using other encoding types (there are at least 8 now in active use
around the world, some of them much better than gzip).

 --&gt; Oops.

C)
Vary as a header is kind of set in stone. We can adjust a few things.
But its really depended on by too many pieces of old software.

There is another header called Key being designed by IETF right now. It
does a better job to describe the variant patterns in a more detailed
way. Such as to say that any Accept-Encoding header containing 'gzip'
could get this reply, or any Accept-Encoding header containing 'deflate'
gets another.

 That new header is just very experimental right now and I haven't had
much time to make Squid use it yet.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010071.html">[squid-users] Squid 3.5.16 and vary loop objects (bug ?)
</A></li>
	<LI>Next message (by thread): <A HREF="010046.html">[squid-users] Squid 3.5.16 and vary loop objects (bug ?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10076">[ date ]</a>
              <a href="thread.html#10076">[ thread ]</a>
              <a href="subject.html#10076">[ subject ]</a>
              <a href="author.html#10076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
