<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4: Cloudflare SSL connection problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%3A%20Cloudflare%20SSL%20connection%20problem&In-Reply-To=%3C570D40D6.5050502%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010140.html">
   <LINK REL="Next"  HREF="010142.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4: Cloudflare SSL connection problem</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%3A%20Cloudflare%20SSL%20connection%20problem&In-Reply-To=%3C570D40D6.5050502%40gmail.com%3E"
       TITLE="[squid-users] Squid 4: Cloudflare SSL connection problem">yvoinov at gmail.com
       </A><BR>
    <I>Tue Apr 12 18:39:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010140.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
        <LI>Next message (by thread): <A HREF="010142.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10141">[ date ]</a>
              <a href="thread.html#10141">[ thread ]</a>
              <a href="subject.html#10141">[ subject ]</a>
              <a href="author.html#10141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
My openssl test show the next Cloudflare cipher:

ECDHE-ECDSA-AES128-GCM-SHA256

So, result is:

root @ cthulhu /patch # openssl s_client -cipher
'ECDHE-ECDSA-AES128-GCM-SHA256' -connect www.cloudflare.com:443
CONNECTED(00000003)
depth=3 C = SE, O = AddTrust AB, OU = AddTrust External TTP Network, CN
= AddTrust External CA Root
verify return:1
depth=2 C = GB, ST = Greater Manchester, L = Salford, O = COMODO CA
Limited, CN = COMODO ECC Certification Authority
verify return:1
depth=1 C = GB, ST = Greater Manchester, L = Salford, O = COMODO CA
Limited, CN = COMODO ECC Extended Validation Secure Server CA
verify return:1
depth=0 serialNumber = 4710875, 1.3.6.1.4.1.311.60.2.1.3 = US,
1.3.6.1.4.1.311.60.2.1.2 = Delaware, businessCategory = Private
Organization, C = US, postalCode = 94107, ST = California, L = San
Francisco, street = &quot;655 Third Street, Suite 200&quot;, O = &quot;CloudFlare,
Inc.&quot;, OU = COMODO EV Multi-Domain SSL
verify return:1
- ---
Certificate chain
 0
s:/serialNumber=4710875/1.3.6.1.4.1.311.60.2.1.3=US/1.3.6.1.4.1.311.60.2.1.2=Delaware/businessCategory=Private
Organization/C=US/postalCode=94107/ST=California/L=San
Francisco/street=655 Third Street, Suite 200/O=CloudFlare,
Inc./OU=COMODO EV Multi-Domain SSL
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO
ECC Extended Validation Secure Server CA
 1 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO
ECC Extended Validation Secure Server CA
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO
ECC Certification Authority
 2 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO
ECC Certification Authority
   i:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust
External CA Root
- ---
Server certificate
- -----BEGIN CERTIFICATE-----
MIIFiTCCBS+gAwIBAgIQBmy2JcYivinKaUJSCKGtKDAKBggqhkjOPQQDAjCBkjEL
MAkGA1UEBhMCR0IxGzAZBgNVBAgTEkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4GA1UE
BxMHU2FsZm9yZDEaMBgGA1UEChMRQ09NT0RPIENBIExpbWl0ZWQxODA2BgNVBAMT
L0NPTU9ETyBFQ0MgRXh0ZW5kZWQgVmFsaWRhdGlvbiBTZWN1cmUgU2VydmVyIENB
MB4XDTE1MTIwMTAwMDAwMFoXDTE2MTEzMDIzNTk1OVowggERMRAwDgYDVQQFEwc0
NzEwODc1MRMwEQYLKwYBBAGCNzwCAQMTAlVTMRkwFwYLKwYBBAGCNzwCAQITCERl
bGF3YXJlMR0wGwYDVQQPExRQcml2YXRlIE9yZ2FuaXphdGlvbjELMAkGA1UEBhMC
VVMxDjAMBgNVBBETBTk0MTA3MRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQH
Ew1TYW4gRnJhbmNpc2NvMSQwIgYDVQQJExs2NTUgVGhpcmQgU3RyZWV0LCBTdWl0
ZSAyMDAxGTAXBgNVBAoTEENsb3VkRmxhcmUsIEluYy4xIzAhBgNVBAsTGkNPTU9E
TyBFViBNdWx0aS1Eb21haW4gU1NMMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE
mPbUxrSaUGUh0fWajjE6zyy35uwYkOwNOKll7E0jKcJvxJLR9IC2ySQduynfb2Mo
t5+rzrL5k3RWt7ZCMDsyWaOCAuMwggLfMB8GA1UdIwQYMBaAFNNOwxm6WFnRHGC3
YVNHO6d3j/iKMB0GA1UdDgQWBBT/eDUPVHJ3p6neXJv8NVND7rkLIDAOBgNVHQ8B
Af8EBAMCBYAwDAYDVR0TAQH/BAIwADAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYB
BQUHAwIwRgYDVR0gBD8wPTA7BgwrBgEEAbIxAQIBBQEwKzApBggrBgEFBQcCARYd
aHR0cHM6Ly9zZWN1cmUuY29tb2RvLmNvbS9DUFMwVgYDVR0fBE8wTTBLoEmgR4ZF
aHR0cDovL2NybC5jb21vZG9jYS5jb20vQ09NT0RPRUNDRXh0ZW5kZWRWYWxpZGF0
aW9uU2VjdXJlU2VydmVyQ0EuY3JsMIGHBggrBgEFBQcBAQR7MHkwUQYIKwYBBQUH
MAKGRWh0dHA6Ly9jcnQuY29tb2RvY2EuY29tL0NPTU9ET0VDQ0V4dGVuZGVkVmFs
aWRhdGlvblNlY3VyZVNlcnZlckNBLmNydDAkBggrBgEFBQcwAYYYaHR0cDovL29j
c3AuY29tb2RvY2EuY29tMC0GA1UdEQQmMCSCDmNsb3VkZmxhcmUuY29tghJ3d3cu
Y2xvdWRmbGFyZS5jb20wggEFBgorBgEEAdZ5AgQCBIH2BIHzAPEAdgBo9pj4H2SC
vjqM7rkoHUz8cVFdZ5PURNEKZ6y7T0/7xAAAAVFfF/KGAAAEAwBHMEUCIQCYn9hT
zH7HDl8ssKN1YWXtk09MEMbNCAgONEM33Orv6gIgH99BJXaehbgEQmEBW7372nPv
x3/hqhO9svDabmNm1vIAdwBWFAaaL9fC7NP14b1Esj7HRna5vJkRXMDvlJhV1onQ
3QAAAVFfF++7AAAEAwBIMEYCIQDlr9Q35uiX37IciNrb8I3lSIKAEB73zB0YMPVl
TSl/yQIhAMCcle0L3Gu11iud65NFRogfrOmk9mtuW3ruf5Mt63D5MAoGCCqGSM49
BAMCA0gAMEUCIQDuxJ4FoYrW0fnaNkRajRSwqKcXb8XpV1dYklpVVGxQOgIgRA96
apf7bQLXWdoGLBJg0M7sRB1Bv9Fh+MIzLKhn5lg=
- -----END CERTIFICATE-----
subject=/serialNumber=4710875/1.3.6.1.4.1.311.60.2.1.3=US/1.3.6.1.4.1.311.60.2.1.2=Delaware/businessCategory=Private
Organization/C=US/postalCode=94107/ST=California/L=San
Francisco/street=655 Third Street, Suite 200/O=CloudFlare,
Inc./OU=COMODO EV Multi-Domain SSL
issuer=/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA
Limited/CN=COMODO ECC Extended Validation Secure Server CA
- ---
No client certificate CA names sent
- ---
SSL handshake has read 3826 bytes and written 289 bytes
- ---
New, TLSv1/SSLv3, Cipher is ECDHE-ECDSA-AES128-GCM-SHA256
Server public key is 256 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-ECDSA-AES128-GCM-SHA256
    Session-ID:
46639E396A6540A888C8A9B1994C744D03810678A4F95951A5BBA293DD4BE284
    Session-ID-ctx:
    Master-Key:
26F7F58D4913230F3F93872E2E7390C7D762CDC3E46FC5AAA300866F316ED5A283A813DAFF738457C5B8F5E1340CC156
    Key-Arg   : None
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 64800 (seconds)
    TLS session ticket:
    0000 - 94 71 18 10 6e 8b 7b d3-b1 a7 d9 d7 65 8f a6 ea  
.q..n.{.....e...
    0010 - 45 fa 1b f8 c7 9b 94 a3-64 95 e7 15 c7 98 04 27  
E.......d......'
    0020 - 09 bf 36 7e db f3 ab 82-17 21 f4 2b 26 13 79 94  
..6~.....!.+&amp;.y.
    0030 - ce e7 30 7f c1 c2 3b 65-7e 76 28 46 d2 46 f3 8d  
..0...;e~v(F.F..
    0040 - 5a 54 2f 70 71 53 7a fd-fb 44 e0 df 4c 46 96 99  
ZT/pqSz..D..LF..
    0050 - e7 63 c9 93 eb 34 32 0a-b4 af 6a db c1 f0 5d 10  
.c...42...j...].
    0060 - 5e c3 af 9e 16 59 32 8c-b0 fb 8e cc 9a 48 8e 6a  
^....Y2......H.j
    0070 - 8d ee 85 5d d3 26 9d b1-96 32 ff 78 cb 93 3a ec  
...].&amp;...2.x..:.
    0080 - 9c 5c bd c5 6c 24 93 d6-ad 0a c3 4e 86 a2 e6 28  
.\..l$.....N...(
    0090 - 8c b1 a9 55 f0 01 6d ab-a2 44 52 b3 37 d6 9e 5a  
...U..m..DR.7..Z
    00a0 - 0c b8 1d 5b 6d 10 13 db-31 2b 4c 1a e4 46 36 84  
...[m...1+L..F6.

    Start Time: 1460486320
    Timeout   : 300 (sec)
    Verify return code: 0 (ok)
- ---

13.04.16 0:19, Eliezer Croitoru &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hey Yuri,
</I>&gt;<i>
</I>&gt;<i> I will try to test it with couple versions of 4.0.x.
</I>&gt;<i> But it's weird...
</I>&gt;<i> The reason it's weird is since some kind of trust or understand this test:
</I>&gt;<i>
</I><A HREF="https://www.ssllabs.com/ssltest/analyze.html?d=www.cloudflare.com&amp;s=198.41.214.162&amp;latest">https://www.ssllabs.com/ssltest/analyze.html?d=www.cloudflare.com&amp;s=198.41.214.162&amp;latest</A>
&gt;<i>
</I>&gt;<i> I am not an SSL expert in general but I can use openssl client to test
</I>and verify things.
&gt;<i> I have tested this scenario with openssl like this:
</I>&gt;<i> # openssl s_client -cipher 'ECDHE-ECDSA-AES256-SHA' -connect
</I>www.cloudflare.com:443
&gt;<i> CONNECTED(00000003)
</I>&gt;<i> 139990857013152:error:14077410:SSL
</I>routines:SSL23_GET_SERVER_HELLO:sslv3 alert handshake
failure:s23_clnt.c:744:
&gt;<i> ---
</I>&gt;<i> no peer certificate available
</I>&gt;<i> ---
</I>&gt;<i> No client certificate CA names sent
</I>&gt;<i> ---
</I>&gt;<i> SSL handshake has read 7 bytes and written 119 bytes
</I>&gt;<i> ---
</I>&gt;<i> New, (NONE), Cipher is (NONE)
</I>&gt;<i> Secure Renegotiation IS NOT supported
</I>&gt;<i> Compression: NONE
</I>&gt;<i> Expansion: NONE
</I>&gt;<i> ---
</I>&gt;<i>
</I>&gt;<i> And it seems that openssl does something which might be my fault but
</I>if squid 3.5.16 works fine with it and 4.0.8 it might be connected to
the connection between openssl library to the service and squid only
displays the issue in the nice html page.
&gt;<i> I do not know what service cloudflare uses and how it all works but if
</I>openssl states that there is an issue with what the service is either
sending or itself analyzing then the issue is in the openssl level
rather then squid.
&gt;<i>
</I>&gt;<i> I am sure that both cloudflare and openssl and squid users, admins and
</I>devs wants to resolve the issue.
&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> On 12/04/2016 18:29, Yuri Voinov wrote:
</I>&gt;&gt;<i>
</I>&gt;<i> UPDATE:
</I>&gt;<i>
</I>&gt;<i> Every failed connect produce the next sequence in access.log:
</I>&gt;<i>
</I>&gt;<i> 1460474791.631  15444 192.168.100.103 NONE_ABORTED/200 0 CONNECT
</I>198.41.215.162:443 - ORIGINAL_DST/198.41.215.162 -
&gt;<i> 1460474791.658      0 192.168.100.103 NONE/503 3951 GET
</I><A HREF="https://www.cloudflare.com/*">https://www.cloudflare.com/*</A> - HIER_NONE/- text/html
&gt;<i>
</I>&gt;<i> Note: 198.41.215.162 is current cloudflare.com IP.
</I>&gt;<i>
</I>&gt;<i> Also: NONE_ABORTED/200 is often occurs in access.log with another
</I>accessible sites.
&gt;<i>
</I>&gt;<i> 12.04.16 20:03, Yuri Voinov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; UPDATE:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; <A HREF="https://i1.someimage.com/b8w5dFz.png">https://i1.someimage.com/b8w5dFz.png</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; This is answer from Cloudflare support.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; But: 3.5.16 can deal with ECDSA TLS 1.2 but 4.0.8 not?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; 12.04.16 17:55, Yuri Voinov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; Does anybody faces this problem with 4.0.8:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; <A HREF="https://i1.someimage.com/3lD2cvV.png">https://i1.someimage.com/3lD2cvV.png</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; It accomplished this error in cache.log:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; 2016/04/12 17:39:38 kid1| Error negotiating SSL on FD
</I>&gt;<i>       54:
</I>&gt;<i>
</I>&gt;<i>       &gt; error:00000000:lib(0):func(0):reason(0) (5/0/0)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; and &quot;NONE/503&quot; in access.log.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; Without proxy works like sharm. 3.5.16 with the similar
</I>&gt;<i>       squid.conf
</I>&gt;<i>
</I>&gt;<i>       &gt; works like sharm.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; NB: Cloudflare support said, that they key feature for
</I>&gt;<i>       SSL is SNI and
</I>&gt;<i>
</I>&gt;<i>       &gt; ECDSA now. AFAIK, 4.0.8 is fully supports this features.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; Any advice will be helpful.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; Yes, I know this looks like DDoS protection on
</I>&gt;<i>       Cloudflare. But WTF?
</I>&gt;<i>
</I>&gt;<i>       &gt; Any workaround required. Half-Internet is hosted on
</I>&gt;<i>       Cloudflare.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>       &gt; &gt; WBR, Yuri
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJXDUDWAAoJENNXIZxhPexGKC8IAMyl3KxLSB89wgvI8THpMgAH
MKyv6PiSOk6IyXc3w0bbk/H6CpbJZZReOA7HWX8uUNy2zfzq/KGZsOUFpuC1WCR+
J7DbGDWjQbPm8BiYPLOtfziY/yvCiON7N0Iw9VTfu8JmjZ/1Dkn+PLMhphNWxZ0K
gCKukIl8/RQcy8VPSntVriKD43kEsSR854GbJq57DfUgZbBGmo7IKCRepHpijjyj
0GyVtwhI24rgMRasmoOIr6QK6x6+zom3RkusZCQs3u0U1vpqHI70R9eiPbORgiYS
mkX9CQtN6rOlZtDgtZ7ZFuSzO2TWSTRAYBXArdov4CsWjTP+YsxT9TJ5cLhKopk=
=IoWl
-----END PGP SIGNATURE-----

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160413/263ff375/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160413/263ff375/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160413/263ff375/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160413/263ff375/attachment.key</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010140.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
	<LI>Next message (by thread): <A HREF="010142.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10141">[ date ]</a>
              <a href="thread.html#10141">[ thread ]</a>
              <a href="subject.html#10141">[ subject ]</a>
              <a href="author.html#10141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
