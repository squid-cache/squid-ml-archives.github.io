<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Dynamic/CDN Content Caching Challenges
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Dynamic/CDN%20Content%20Caching%20Challenges&In-Reply-To=%3Cemf0252ebd-79a7-4524-8666-220414ca5ecf%40augere-1%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010162.html">
   <LINK REL="Next"  HREF="010159.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Dynamic/CDN Content Caching Challenges</H1>
    <B>Muhammad Faisal</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Dynamic/CDN%20Content%20Caching%20Challenges&In-Reply-To=%3Cemf0252ebd-79a7-4524-8666-220414ca5ecf%40augere-1%3E"
       TITLE="[squid-users] Dynamic/CDN Content Caching Challenges">faisalusuf at yahoo.com
       </A><BR>
    <I>Thu Apr 14 08:03:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010162.html">[squid-users] splash page + ubuntu 14.04 + squid 3.3.8
</A></li>
        <LI>Next message (by thread): <A HREF="010159.html">[squid-users] Dynamic/CDN Content Caching Challenges
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10155">[ date ]</a>
              <a href="thread.html#10155">[ thread ]</a>
              <a href="subject.html#10155">[ subject ]</a>
              <a href="author.html#10155">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
I'm trying to deal with dynamic content to be cached by Squid 3.5 (i 
tried many other version of squid e.g 2.7, 3.1, 3.4). By Dynamic I mean 
the URL for the actual content is always change this results in the 
wastage of Cache storage and low hit rate. As per my understanding I 
have two challenges atm:

1- Websites with dynamic URL for requested content (e.g filehippo, 
download.com etc etc)
2- Streaming web sites where the dynamic URL has 206 (partial content) 
tune.pk videos for e.g or windows updates (enabling range off set limit 
to -1 causes havoc on upstream to we kept it disable is there some way 
to control the behavior ?)

If someone has successfully configured the above scenario please help me 
out as i dont have programming background to deal with this complexity.

I tried using different store-ID helpers but no saving on upstream the 
content is still coming from origin. Below is the helper i have used:

My Setup Summary:
Centos 6.5
Tproxy
Single Ethernet
Squid v3.5.16 (yum installed from repo)

Squid Cache: Version 3.5.16
Service Name: squid
configure options:  '--build=x86_64-redhat-linux-gnu' 
'--host=x86_64-redhat-linux-gnu' '--target=x86_64-redhat-linux-gnu' 
'--program-prefix=' '--prefix=/usr' '--exec-prefix=/usr' 
'--bindir=/usr/bin' '--sbindir=/usr/sbin' '--sysconfdir=/etc' 
'--datadir=/usr/share' '--includedir=/usr/include' '--libdir=/usr/lib64' 
'--libexecdir=/usr/libexec' '--sharedstatedir=/var/lib' 
'--mandir=/usr/share/man' '--infodir=/usr/share/info' '--verbose' 
'--exec_prefix=/usr' '--libexecdir=/usr/lib64/squid' 
'--localstatedir=/var' '--datadir=/usr/share/squid' 
'--sysconfdir=/etc/squid' '--with-logdir=$(localstatedir)/log/squid' 
'--with-pidfile=$(localstatedir)/run/squid.pid' 
'--disable-dependency-tracking' '--enable-follow-x-forwarded-for' 
'--enable-auth' 
'--enable-auth-basic=DB,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB,getpwnam' 
'--enable-auth-ntlm=smb_lm,fake' '--enable-auth-digest=file,LDAP' 
'--enable-auth-negotiate=kerberos,wrapper' 
'--enable-external-acl-helpers=wbinfo_group,kerberos_ldap_group' 
'--enable-cache-digests' '--enable-cachemgr-hostname=localhost' 
'--enable-delay-pools' '--enable-epoll' '--enable-icap-client' 
'--enable-ident-lookups' '--enable-linux-netfilter' 
'--enable-removal-policies=heap,lru' '--enable-snmp' 
'--enable-storeio=aufs,diskd,ufs,rock' '--enable-wccpv2' '--enable-esi' 
'--enable-ssl-crtd' '--enable-icmp' '--with-aio' 
'--with-default-user=squid' '--with-filedescriptors=16384' '--with-dl' 
'--with-openssl' '--with-pthreads' '--with-included-ltdl' 
'--disable-arch-native' '--without-nettle' 
'build_alias=x86_64-redhat-linux-gnu' 
'host_alias=x86_64-redhat-linux-gnu' 
'target_alias=x86_64-redhat-linux-gnu' 'CFLAGS=-O2 -g -pipe -Wall 
-Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector 
--param=ssp-buffer-size=4 -m64 -mtune=generic' 'CXXFLAGS=-O2 -g -pipe 
-Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector 
--param=ssp-buffer-size=4 -m64 -mtune=generic -fPIC' 
'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig' 
--enable-ltdl-convenience

-----------------------------------------------
Store ID Helper
===============================================
#!/usr/bin/perl
# Improved\Converted StoreID helper based on perl and not on ruby
# this helper dosn't have my logic about youtube and other StoreID
# but it still do the trick in most cases and for my understanding.
# if you do want to understand the script logic rather then just
# use it try to look at: <A HREF="http://www1.ngtech.co.il/paste/1016/">http://www1.ngtech.co.il/paste/1016/</A>
# Eliezer Croitoru eliezer&lt;at&gt;ngtech.co.il

$|=1;
while (&lt;&gt;) {
         chomp;
         @X = split;
         if (@X[0] =~ m/^(exit|quit|x|q)/) {
                 print STDERR &quot;quiting helper quietly\n&quot;;
                 exit 0;
         }


if ($X[0] =~ 
m/^http\:\/\/.*(youtube|google).*(videoplayback|liveplay).*/){
         @itag = m/[&amp;?](itag=[0-9]*)/;
         @id = m/[&amp;?](id=[^\&amp;]*)/;
         @range = m/[&amp;?](range=[^\&amp;\s]*)/;
         @begin = m/[&amp;?](begin=[^\&amp;\s]*)/;
         @redirect = m/[&amp;?](redirect_counter=[^\&amp;]*)/;
         
$out=&quot;<A HREF="http://video-srv.youtube.com.squid.internal/@id&amp;@itag&amp;@range@begin@redirect">http://video-srv.youtube.com.squid.internal/@id&amp;@itag&amp;@range@begin@redirect</A>&quot;;

} elsif ($X[0] =~ 
m/^http\:\/\/.*(profile|photo|creative).*\.ak\.fbcdn\.net\/((h|)(profile|photos)-ak-)(snc|ash|prn)[0-9]?(.*)/) 
{
         $out=&quot;<A HREF="http://fbcdn.net.squid.internal/">http://fbcdn.net.squid.internal/</A>&quot; . $2  . &quot;fb&quot; .  $6  ;

} elsif ($X[0] =~ m/^http:\/\/i[1-4]\.ytimg\.com\/(.*)/) {
         $out=&quot;<A HREF="http://ytimg.com.squid.internal/">http://ytimg.com.squid.internal/</A>&quot; . $1 ;

} elsif ($X[0] =~ m/^http:\/\/.*\.dl\.sourceforge\.net\/(.*)/) {
           $out=&quot;<A HREF="http://dl.sourceforge.net.squid.internal/">http://dl.sourceforge.net.squid.internal/</A>&quot; . $1 ;

                 #Speedtest
} elsif ($X[0] =~ m/^http\:\/\/.*\/speedtest\/(.*\.(jpg|txt)).*/) {
         $out=&quot;<A HREF="http://speedtest.squid.internal/">http://speedtest.squid.internal/</A>&quot; . $1 ;

                 #BLOGSPOT
} elsif ($X[0] =~ m/^http:\/\/[1-4]\.bp\.(blogspot\.com.*)/) {
         $out=&quot;<A HREF="http://blog-cdn.">http://blog-cdn.</A>&quot; . $1  ;

                 #AVAST
} elsif ($X[0] =~ m/^http:\/\/download[0-9]{3}.(avast.com.*)/) {
           $out=&quot;<A HREF="http://avast-cdn.">http://avast-cdn.</A>&quot; . $1  ;

               #AVAST
} elsif ($X[0] =~ m/^http:\/\/[0-9]*\.[0-9]*\.[0-9]*\.[0-9]*\/(iavs.*)/) 
{
         $out=&quot;<A HREF="http://avast-cdn.avast.com/">http://avast-cdn.avast.com/</A>&quot; . $1  ;

         #KAV
} elsif ($X[0] =~ m/^http:\/\/dnl-[0-9]{2}.(geo.kaspersky.com.*)/) {
           $out=&quot;<A HREF="http://kav-cdn.">http://kav-cdn.</A>&quot; . $1  ;

                 #AVG
} elsif ($X[0] =~ m/^http:\/\/update.avg.com/) {
           $out=&quot;<A HREF="http://avg-cdn.">http://avg-cdn.</A>&quot; . $1  ;

                 #maps.google.com
} elsif ($X[0] =~ 
m/^http:\/\/(cbk|mt|khm|mlt|tbn)[0-9]?(.google\.co(m|\.uk|\.id).*)/) {
         $out=&quot;<A HREF="http://">http://</A>&quot; . $1  . $2 ;

                 #gstatic and/or wikimapia
} elsif ($X[0] =~ 
m/^http:\/\/([a-z])[0-9]?(\.gstatic\.com.*|\.wikimapia\.org.*)/) {
         $out=&quot;<A HREF="http://">http://</A>&quot; . $1  . $2 ;

                 #maps.google.com
} elsif ($X[0] =~ m/^http:\/\/(khm|mt)[0-9]?(.google.com.*)/) {
         $out=&quot;<A HREF="http://">http://</A>&quot; . $1  . $2 ;

                 #Google
} elsif ($X[0] =~ 
m/^http:\/\/www\.google-analytics\.com\/__utm\.gif\?.*/) {
         $out=&quot;<A HREF="http://www.google-analytics.com/__utm.gif\n">http://www.google-analytics.com/__utm.gif\n</A>&quot;;

} elsif ($X[0] =~ m/^http:\/\/(www\.ziddu\.com.*\.[^\/]{3,4})\/(.*?)/) {
         $out=&quot;<A HREF="http://">http://</A>&quot; . $1 ;

                 #cdn, varialble 1st path
} elsif (($X[0] =~ /filehippo/) &amp;&amp; 
(m/^http:\/\/(.*?)\.(.*?)\/(.*?)\/(.*)\.([a-z0-9]{3,4})(\?.*)?/)) {
         @y = ($1,$2,$4,$5);
         $y[0] =~ s/[a-z0-9]{2,5}/cdn./;
         $out=&quot;<A HREF="http://">http://</A>&quot; . $y[0] . $y[1] . &quot;/&quot; . $y[2] . &quot;.&quot; . $y[3] ;

                 #rapidshare
} elsif (($X[0] =~ /rapidshare/) &amp;&amp; 
(m/^http:\/\/(([A-Za-z]+[0-9-.]+)*?)([a-z]*\.[^\/]{3}\/[a-z]*\/[0-9]*)\/(.*?)\/([^\/\?\&amp;]{4,})$/)) 
{
         $out=&quot;<A HREF="http://cdn.">http://cdn.</A>&quot; . $3 . &quot;/squid.internal/&quot; . $5 ;

                 #for yimg.com video
} elsif ($X[0] =~ 
m/^http:\/\/(.*yimg.com)\/\/(.*)\/([^\/\?\&amp;]*\/[^\/\?\&amp;]*\.[^\/\?\&amp;]{3,4})(\?.*)?$/) 
{
         $out=&quot;<A HREF="http://cdn.yimg.com/">http://cdn.yimg.com/</A>&quot; . $3 ;

                 #for yimg.com doubled
} elsif ($X[0] =~ 
m/^http:\/\/(.*?)\.yimg\.com\/(.*?)\.yimg\.com\/(.*?)\?(.*)/) {
         $out=&quot;<A HREF="http://cdn.yimg.com/">http://cdn.yimg.com/</A>&quot;  . $3 ;

                 #for Filehippo files
} elsif ($X[0] =~ 
m/^https?:\/\/.*\.(filehippo\.com)\/.*\/(.*[\.exe|zip|cab|msi|mru|mri|bz2|gzip|tgz|rar|pdf])/) 
{
                 $out=&quot;<A HREF="http://filehippo.sqinternal/">http://filehippo.sqinternal/</A>&quot; . $1 . $2 ;


                 #for yimg.com with &amp;sig=
} elsif ($X[0] =~ m/^http:\/\/([^\.]*)\.yimg\.com\/(.*)/) {
         @y = ($1,$2);
         $y[0] =~ s/[a-z]+([0-9]+)?/cdn/;
         $y[1] =~ s/&amp;sig=.*//;
         $out=&quot;<A HREF="http://">http://</A>&quot; . $y[0] . &quot;.yimg.com/&quot;  . $y[1] ;

} else {
         $out=&quot;ERR&quot;;

}
if ( $out =~ m/^http\:\/\/.*/) {
  print &quot;OK store-id=$out\n&quot; ;
} else {
  print &quot;ERR\n&quot; ;
}
}
--
Regards,
Faisal.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160414/b3c5bcb2/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160414/b3c5bcb2/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010162.html">[squid-users] splash page + ubuntu 14.04 + squid 3.3.8
</A></li>
	<LI>Next message (by thread): <A HREF="010159.html">[squid-users] Dynamic/CDN Content Caching Challenges
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10155">[ date ]</a>
              <a href="thread.html#10155">[ thread ]</a>
              <a href="subject.html#10155">[ subject ]</a>
              <a href="author.html#10155">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
