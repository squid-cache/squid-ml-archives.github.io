<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High CPU usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU%20usage&In-Reply-To=%3C507d01d19762%2418a571e0%2449f055a0%24%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010178.html">
   <LINK REL="Next"  HREF="010201.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High CPU usage</H1>
    <B>David Touzeau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU%20usage&In-Reply-To=%3C507d01d19762%2418a571e0%2449f055a0%24%40articatech.com%3E"
       TITLE="[squid-users] High CPU usage">david at articatech.com
       </A><BR>
    <I>Fri Apr 15 21:59:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010178.html">[squid-users] High CPU usage
</A></li>
        <LI>Next message (by thread): <A HREF="010201.html">[squid-users] High CPU usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10184">[ date ]</a>
              <a href="thread.html#10184">[ thread ]</a>
              <a href="subject.html#10184">[ subject ]</a>
              <a href="author.html#10184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We have the same issue when upgrading to 3.5.16

3.5.16 -&gt; squid take 100% CPU
Back to 3.5.13 -&gt; 12% CPU

-----Message d'origine-----
De : squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] De la part de Amos Jeffries
Envoy&#233; : vendredi 15 avril 2016 13:23
&#192; : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Objet : Re: [squid-users] High CPU usage

On 15/04/2016 7:26 p.m., Mohammad Sadegh Nasiri wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> Does anyone knows why my squid cpu usage is 100%?
</I>&gt;<i> 
</I>
Before trying to answer you need to be aware that when/if it needs to Squid will push CPU, RAM, disk I/O etc right to the hardware limits.


Your first trace is telling the story about 1150 RPS happening. Very few transactions overlapping, so Squid spends most of its time pushing individual or small groups of responses very fast. This reaches 800 Mbps with Squid still spending a measurable chunk of its time (~30%) waiting for something to do.


Your second trace is telling of a proxy receiving almost as many client requests per second, but now juggling about 8,000 of them at a time.
Often 250 needing things to be done every cycle. Thats a lot of work, so Squid has slowed down to 600 Mbps and is now using all of the CPU it can get.

I think at some point between the traces something went a bit slower, or some clients did a big transaction making more overlap, or generally just pushed Squid up to a peak in its workoad that needed more CPU than was available.
Since CPU can only give 100% that thing took a short while to finish.
Resulting in some transaction overlap, which made those take more CPU to finish so Squid stays at 100% slightly longer, and round it goes in a feedback loop.


The numbers that I'm looking at for that are:

 client_http.requests = 	 1150 -&gt;  1124/sec

 client_http.kbytes_in = 	  841 -&gt;   773/sec
 client_http.kbytes_out = 	57428 -&gt; 44051/sec
 server.all.kbytes_in = 	43019 -&gt; 33436/sec
 server.all.kbytes_out =	  705 -&gt;   637/sec

  (adding these gives a ~800 Mbps -&gt; ~600 Mbps drop)

 select_loops = 	14571 -&gt;    69/sec
 select_fds = 		27229 -&gt; 17470/sec

 median_select_fds = 0.000000 -&gt; 253.007812

Significantly more FDs needing things to do each time Squid checks. So it checks fewer times per sec. Meaning more each time it checks, and so on.
 - the low select loops per sec is what I think is driving the service times to be longer. They are still under 1sec so not very noticable to clients.


Watch the median_select_fds to see if it is reducing. If so Squid is
(slowly) recovering after the peak event. Otherwise Squid is falling behind the workload.


Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010178.html">[squid-users] High CPU usage
</A></li>
	<LI>Next message (by thread): <A HREF="010201.html">[squid-users] High CPU usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10184">[ date ]</a>
              <a href="thread.html#10184">[ thread ]</a>
              <a href="subject.html#10184">[ subject ]</a>
              <a href="author.html#10184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
