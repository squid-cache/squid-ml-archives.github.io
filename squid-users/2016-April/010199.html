<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Browser circunvents acl's blocking https (intercept mode)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Browser%20circunvents%20acl%27s%20blocking%20https%0A%20%28intercept%20mode%29&In-Reply-To=%3C57135340.5080503%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010197.html">
   <LINK REL="Next"  HREF="010309.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Browser circunvents acl's blocking https (intercept mode)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Browser%20circunvents%20acl%27s%20blocking%20https%0A%20%28intercept%20mode%29&In-Reply-To=%3C57135340.5080503%40treenet.co.nz%3E"
       TITLE="[squid-users] Browser circunvents acl's blocking https (intercept mode)">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Apr 17 09:11:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010197.html">[squid-users] Browser circunvents acl's blocking https	(intercept mode)
</A></li>
        <LI>Next message (by thread): <A HREF="010309.html">[squid-users] Browser circunvents acl's blocking https	(intercept mode)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10199">[ date ]</a>
              <a href="thread.html#10199">[ thread ]</a>
              <a href="subject.html#10199">[ subject ]</a>
              <a href="author.html#10199">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/04/2016 1:53 p.m., Jok Thuau wrote:
&gt;<i> Blocking YouTube (appear to be on your list) is tricky, if the browser is chrome:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://en.m.wikipedia.org/wiki/QUIC">https://en.m.wikipedia.org/wiki/QUIC</A>
</I>&gt;<i> 
</I>&gt;<i> If you click on the 'green lock' and look at the connection you will see it's not using https (funnily enough, the ads there do!).
</I>&gt;<i> 
</I>&gt;<i> Look at the wiki for more info on how to block QUIC.
</I>&gt;<i> 
</I>&gt;&gt;<i> On Apr 16, 2016, at 4:10 PM, Sergio Belkin wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I cannot block some sites using squid 3.4.8,
</I>
Please upgrade to at least the latest Squid version for SSL-Bump
functionality.

SSL-Bump is part of an &quot;arms race&quot; going on in TLS and things are still
quite volatile. It is a lot of work just to keep up so we are not fixing
TLS/SSL bugs unless they are still present in the latest 3.5 or 4.x
releases, and debugging needs to be done using those releases.


&gt;<i> this the configuration. On Firefox, blocking works, browser says:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> `Error code: SSL_ERROR_RX_RECORD_TOO_LONG`
</I>&gt;&gt;<i>
</I>
What you are doing there is not so much &quot;blocking&quot; as completely
screwing up the TLS protocol traffic by injecting garbage into the
binary data stream. The browser is complaining about that. It is
possibly also accepting some of the garbage as TLS features being
negotiated - which is highly dangerous.


&gt;&gt;<i> But on Chromium Versi&#243;n 49.0.2623.108, browser is not affected by the blocking acl's, despite access_logs says:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ````
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;NONE error:invalid-request HTTP/0.0&quot; 400 4042 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;NONE error:invalid-request HTTP/0.0&quot; 400 4042 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot; %BA%5D%B71A%E2%90C%BD0:Ep%82%99%FE%88 HTTP/0.0&quot; 400 3638 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;NONE error:invalid-request HTTP/0.0&quot; 400 4042 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;NONE error:invalid-request HTTP/0.0&quot; 400 4042 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot; %11Tf%03%A4%83%F3%8C%EE HTTP/0.0&quot; 400 3614 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:17 -0300] &quot;NONE error:invalid-request HTTP/0.0&quot; 400 4042 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:23 -0300] &quot;CONNECT 172.217.29.14:443 HTTP/1.1&quot; 403 3443 &quot;-&quot; &quot;-&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 192.168.80.250 - - [16/Apr/2016:19:53:23 -0300] &quot;NONE error:invalid-request HTTP/0.0&quot; 400 4042 &quot;-&quot; &quot;-&quot; TAG_NONE:HIER_NONE
</I>&gt;&gt;<i> ````
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Debugging I've found this in cache.log:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ````
</I>&gt;&gt;<i> 2016/04/16 20:00:21.924 kid1| client_side.cc(864) swanSong: local=172.217.28.225:443 remote=192.168.80.250:55068 flags=33
</I>&gt;&gt;<i> 2016/04/16 20:00:21.925 kid1| Checklist.cc(62) preCheck: 0x7eff3754 checking fast ACLs
</I>&gt;&gt;<i> 2016/04/16 20:00:21.925 kid1| Acl.cc(157) matches: checking access_log daemon:/var/log/squid3/access.log
</I>&gt;&gt;<i> 2016/04/16 20:00:21.925 kid1| Acl.cc(157) matches: checking (access_log daemon:/var/log/squid3/access.log line)
</I>&gt;&gt;<i> 2016/04/16 20:00:21.925 kid1| Acl.cc(177) matches: checked: (access_log daemon:/var/log/squid3/access.log line) = 1
</I>&gt;&gt;<i> 2016/04/16 20:00:21.926 kid1| Acl.cc(177) matches: checked: access_log daemon:/var/log/squid3/access.log = 1
</I>&gt;&gt;<i> 2016/04/16 20:00:21.926 kid1| Checklist.cc(55) markFinished: 0x7eff3754 answer ALLOWED for match
</I>&gt;&gt;<i> ````
</I>
This only says that Squid is allowed to record the log messages to
access.log. Dont worry about that.


&gt;&gt;<i>
</I>&gt;&gt;<i> Please could you help? Am I missing something? Below, my configuration:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ````
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> acl tvsamsung src 192.168.80.160
</I>&gt;&gt;<i> acl sarmiento src 192.168.80.248
</I>&gt;&gt;<i> acl netbook src 192.168.80.245
</I>&gt;&gt;<i> acl dompermitidos dstdomain &quot;/etc/squid3/rules/whitelistdom&quot;
</I>&gt;&gt;<i> acl streaming dstdomain &quot;/etc/squid3/rules/streaming&quot;
</I>&gt;&gt;<i> acl test  dstdomain .debian.org
</I>&gt;&gt;<i> acl streamingips dst &quot;/etc/squid3/rules/streamingips&quot;
</I>&gt;&gt;<i> acl sergiocel src 192.168.80.249
</I>&gt;&gt;<i> acl tiempojuanse time SMTWHFA 10:00-13:00
</I>&gt;&gt;<i> acl tiempojuanse time SMTWHFA 16:00-22:00
</I>&gt;&gt;<i> acl yt dstdomain .youtube.com
</I>&gt;&gt;<i> acl facebook dstdomain .facebook.com
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> always_direct allow all
</I>
 always_direct is irrelevant. You are not using cache_peer.

&gt;&gt;<i> ssl_bump none all
</I>
&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
These disable all security TLS might have offered to outbound secure
<A HREF="https://">https://</A> requests made by the proxy to upstream servers.

It has no relevance or effect on the traffic relayed by &quot;ssl_bump none all&quot;.


&gt;&gt;<i> http_access allow  tvsamsung
</I>&gt;&gt;<i> http_access deny yt
</I>&gt;&gt;<i> http_access allow facebook
</I>&gt;&gt;<i> http_access deny  streaming
</I>&gt;&gt;<i> http_access deny  streamingips
</I>&gt;&gt;<i> http_access allow dompermitidos
</I>&gt;&gt;<i> http_access allow  sarmiento
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> http_port 3128
</I>&gt;&gt;<i> http_port 3127 intercept
</I>&gt;&gt;<i> https_port 8080 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/home/proxy/ssl_cert/example.com.cert key=/home/proxy/ssl_cert/example.com.private
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid3/ssl_crtd -s /var/spool/squid3_ssldb -M 4MB
</I>
Since you have configured &quot;ssl_bump none all&quot; Squid does not participate
in any of the HTTPS traffic it intercepts. Just blindly relays it to
upstream whenever your https_access permit the CONNECT message with
raw-IP to happen.

That means none of these cert generation details are relevant. Only the
cert= and key= parameters are used when Squid needs to send an error to
the client. Your version does not appear to be doing that correctly anyway.


Like Jok mentioned Chrome is probably using QUIC protocol or one of the
other non-HTTPS is uses. If you upgrade to latest 3.5 Squid does some
header pruning to prevent that where possible. And Squid 4.x has a
feature to handle non-HTTPS and non-TLS protocols happening on port 443.

Also, if the raw-IP on the CONNECT message happens not to have
reverse-DNS matching your dstdomain list entries it will go through the
proxy. That could open you to a lot of issues from your clients being
infected or hijacked by scripts.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010197.html">[squid-users] Browser circunvents acl's blocking https	(intercept mode)
</A></li>
	<LI>Next message (by thread): <A HREF="010309.html">[squid-users] Browser circunvents acl's blocking https	(intercept mode)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10199">[ date ]</a>
              <a href="thread.html#10199">[ thread ]</a>
              <a href="subject.html#10199">[ subject ]</a>
              <a href="author.html#10199">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
