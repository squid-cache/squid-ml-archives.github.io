<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4: Cloudflare SSL connection problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%3A%20Cloudflare%20SSL%20connection%20problem&In-Reply-To=%3C1867F539-757B-491A-A6CC-A297F8CFFF00%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010206.html">
   <LINK REL="Next"  HREF="010216.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4: Cloudflare SSL connection problem</H1>
    <B>Guy Helmer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%3A%20Cloudflare%20SSL%20connection%20problem&In-Reply-To=%3C1867F539-757B-491A-A6CC-A297F8CFFF00%40gmail.com%3E"
       TITLE="[squid-users] Squid 4: Cloudflare SSL connection problem">guy.helmer at gmail.com
       </A><BR>
    <I>Mon Apr 18 16:11:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010206.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
        <LI>Next message (by thread): <A HREF="010216.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10215">[ date ]</a>
              <a href="thread.html#10215">[ thread ]</a>
              <a href="subject.html#10215">[ subject ]</a>
              <a href="author.html#10215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Apr 17, 2016, at 5:50 AM, Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----BEGIN PGP SIGNED MESSAGE----- 
</I>&gt;<i> Hash: SHA256 
</I>&gt;<i>  
</I>&gt;<i> *NIX means UNIX. Solaris is AT&amp;T UNIX. Linux is not UNIX (C) Linus Torvalds. :) We are not speaking about all possible OS'es. I suggests the matter in SSL/TLS, not OS or hands or something similar.
</I>&gt;<i> 
</I>&gt;<i> The problem is in CF, I think. As a maximum in peek-n-splice.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Because of I've not changed my squid.conf over last year, but approx. in january 2016 CloudFlare stopped work via proxy, as said my field SA. AFAIK, CF change own security settings. Also, I suggests, mozilla .org also moved behind CF.
</I>&gt;<i> 
</I>&gt;<i> Ok, let's talk about squid.conf. SSL-related rows are here:
</I>&gt;<i> 
</I>&gt;<i> # SSL bump rules
</I>&gt;<i> acl DiscoverSNIHost at_step SslBump1
</I>&gt;<i> acl NoSSLIntercept ssl::server_name_regex -i &quot;/usr/local/squid/etc/url.nobump&quot;
</I>&gt;<i> acl NoSSLIntercept ssl::server_name_regex -i &quot;/usr/local/squid/etc/url.tor&quot;
</I>&gt;<i> ssl_bump peek DiscoverSNIHost
</I>&gt;<i> ssl_bump splice NoSSLIntercept
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> http_port 3126 intercept
</I>&gt;<i> https_port 3127 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt key=/usr/local/squid/etc/rootCA.key options=SINGLE_DH_USE,SINGLE_ECDH_USE tls-dh=prime256v1:/usr/local/squid/etc/dhparam.pem cipher=HIGH:MEDIUM:!aNULL:!eNULL:!RC4:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/rootCA.crt key=/usr/local/squid/etc/rootCA.key options=SINGLE_DH_USE,SINGLE_ECDH_USE tls-dh=prime256v1:/usr/local/squid/etc/dhparam.pem cipher=HIGH:MEDIUM:!aNULL:!eNULL:!RC4:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> tls_outgoing_options cafile=/usr/local/squid/etc/ca-bundle.crt options=SINGLE_DH_USE,SINGLE_ECDH_USE cipher=HIGH:MEDIUM:!aNULL:!eNULL:!RC4:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> sslproxy_foreign_intermediate_certs /usr/local/squid/etc/intermediate_ca.pem
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> I see no anomalies in this lines. Ciphersuite is very relaxed.
</I>&gt;<i> 
</I>&gt;<i> Also, if we discuss a bug - may be better to turn on debug to know, why 4.x got first NONE_ABORTED/200 during CONNECT phase and then NONE/503 during TLS negotiate?
</I>
Hi, Yuri,

If I understand correctly, the issue is between squid and the origin proxy. In case it would help, have you enabled ECDH sslproxy_options or sslproxy_cipher settings in this snippet that would enable Squid to use ECDH when talking to the origin servers?

Do you happen to have a packet capture between your squid server and a CloudFlare server that could help diagnose the TLS protocol&#8217;s problem?

Regards,
Guy



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010206.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
	<LI>Next message (by thread): <A HREF="010216.html">[squid-users] Squid 4: Cloudflare SSL connection problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10215">[ date ]</a>
              <a href="thread.html#10215">[ thread ]</a>
              <a href="subject.html#10215">[ subject ]</a>
              <a href="author.html#10215">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
