<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Routing Internally And/Or Externally?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Routing%20Internally%20And/Or%20Externally%3F&In-Reply-To=%3C5717A18B.8030503%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010245.html">
   <LINK REL="Next"  HREF="010235.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Routing Internally And/Or Externally?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Routing%20Internally%20And/Or%20Externally%3F&In-Reply-To=%3C5717A18B.8030503%40treenet.co.nz%3E"
       TITLE="[squid-users] Routing Internally And/Or Externally?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 20 15:34:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010245.html">[squid-users] Routing Internally And/Or Externally?
</A></li>
        <LI>Next message (by thread): <A HREF="010235.html">[squid-users] Never expire any object Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10248">[ date ]</a>
              <a href="thread.html#10248">[ thread ]</a>
              <a href="subject.html#10248">[ subject ]</a>
              <a href="author.html#10248">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/04/2016 2:12 a.m., nkingsquid wrote:
&gt;<i> Amos, I have changed the code around a bit to reflect what you guys have been
</I>&gt;<i> telling me.  The Netscaler is NATing.  Security before, after, and around
</I>&gt;<i> the device is substantial, I will tweak the coded to reflect that at a later
</I>&gt;<i> time, at the moment I am desperately looking for that 1 answer I mentioned
</I>&gt;<i> in the post above.
</I>&gt;<i> 
</I>&gt;<i> I did make a mistake originally saying that traffic that did NOT meet the
</I>&gt;<i> rules for internal sites goes back to the Netscaler, it will instead go to
</I>&gt;<i> another proxy (and various security measures) before it goes out to the
</I>&gt;<i> internet.
</I>&gt;<i> 
</I>&gt;<i> That's the code I am looking for.  redirect traffic to 2nd proxy if its not
</I>&gt;<i> trying to go to an internal resource.
</I>&gt;<i> 
</I>

Unfortunately no amount of security checks work in the presence of an
interception proxy. By definition the intercept itself is an attack that
has to be let through and there are major side effects of the secondary
things that become possible once it is through.

The security built into Squid itself to prevent CVE-2009-0801 and
related holes from bypassing everything else is also substantial and
forbids D-NAT being done externally to the machine Squid is running on.

Squid requires direct access to the kernel NAT table to de-obfuscate the
TCP traffic and validate that it is going to the place the client
intended it to. In the event of that validation failing Squid will act
transparently and ensure the packets continue where they were supposed
to if it were not there.

You need to:
* policy-route the traffic from the NetScaler to Squid,
* do the NAT on the Squid machine dirctly,
* use 'intercept' on the http_port receiving the NAT'ed traffic.

You can re-NAT the traffic outbound from Squid after it leaves Squid and
into your other proxy if you like, or &quot;never_direct allow all&quot;. That
other proxy will be responsible for its own version of the CVE
protections all over again.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010245.html">[squid-users] Routing Internally And/Or Externally?
</A></li>
	<LI>Next message (by thread): <A HREF="010235.html">[squid-users] Never expire any object Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10248">[ date ]</a>
              <a href="thread.html#10248">[ thread ]</a>
              <a href="subject.html#10248">[ subject ]</a>
              <a href="author.html#10248">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
