<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cert authority invalid failures.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cert%20authority%20invalid%20failures.&In-Reply-To=%3C5718CE94.7020004%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010252.html">
   <LINK REL="Next"  HREF="010273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cert authority invalid failures.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cert%20authority%20invalid%20failures.&In-Reply-To=%3C5718CE94.7020004%40treenet.co.nz%3E"
       TITLE="[squid-users] Cert authority invalid failures.">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr 21 12:59:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010252.html">[squid-users] Cert authority invalid failures.
</A></li>
        <LI>Next message (by thread): <A HREF="010273.html">[squid-users] Cert authority invalid failures.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10263">[ date ]</a>
              <a href="thread.html#10263">[ thread ]</a>
              <a href="subject.html#10263">[ subject ]</a>
              <a href="author.html#10263">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/04/2016 8:18 a.m., Markey, Bruce wrote:
&gt;<i> I'm curious as to why this is happening.
</I>&gt;<i> 
</I>&gt;<i> Proxy was implemented last week and since then I've been dealing with all the sites that don't work. Not a problem, knew it was going to happen. I'd like to understand why the following is happening.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 1.       User goes to <A HREF="https://www.whatever.com">https://www.whatever.com</A>
</I>&gt;<i> 
</I>&gt;<i> 2.       Browser, mostly chrome, gives the following error.   Connection not private. NET:ERR_CERT_AUTHORITY_INVALID
</I>&gt;<i> 
</I>
Typing that into search engine produces a thread explaining that it is
the browser message shown when HSTS is in effect on a website and the
server cert is not trusted by the browser.



&gt;<i> 3.       If you view the cert it shows the dynamic cert listed.
</I>&gt;<i> 
</I>&gt;<i> 4.       Click the &quot;Proceed to www.whatever.com&lt;<A HREF="http://www.whatever.com">http://www.whatever.com</A>&gt; (unsafe )
</I>&gt;<i> 
</I>&gt;<i> 5.       Now I get a squid error.  Requested url could not be retrieved.  Access denied while trying to retrieve <A HREF="https://">https://</A> some ip address/*
</I>&gt;<i> 
</I>
And that #5 explains why. It was actually not the web server producing
the cert. But Squid doing SSL-Bumping in order to show you the error page.



&gt;<i> Thing is I don't have an acl blocking that ip?   ( Small sub question here, is there a way to tell which acl blocks something? )
</I>&gt;<i> 
</I>
Something clearly is. But not what you expect, or you would not be here
asking about it.

&gt;<i> What I've had to do to get around this is add www.whatever.com&lt;<A HREF="http://www.whatever.com">http://www.whatever.com</A>&gt; to my broken_sites.acl.    Then add the ip to an allowed_ips.acl.
</I>&gt;<i> 
</I>&gt;<i> Then I http_access allow the ips list
</I>&gt;<i> 
</I>&gt;<i> And skip peeking at the broken site.
</I>&gt;<i> 
</I>&gt;<i> acl broken_sites ssl::server_name_regex &quot;/etc/squid3/acls/http_broken.txt&quot;
</I>&gt;<i> ssl_bump peek !broken_sites
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> I'm trying to understand why this is breaking and if I'm doing the right thing in fixing it.
</I>&gt;<i> 
</I>
Please provide your whole squid.conf (except empty or # comment lines).
We might need to see it all to find what the problem is.


&gt;<i> 
</I>&gt;<i> The second error I'm getting is:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The following error was encountered while trying to retrieve the URL: <A HREF="https://*.agentimediaservices.com/*&lt;https://%2A.agentimediaservices.com/*">https://*.agentimediaservices.com/*&lt;https://%2A.agentimediaservices.com/*</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> Failed to establish a secure connection to 63.240.52.151
</I>&gt;<i> 
</I>&gt;<i> The system returned:
</I>&gt;<i> 
</I>&gt;<i> (71) Protocol error (TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
</I>&gt;<i> 
</I>&gt;<i> SSL Certficate error: certificate issuer (CA) not known: /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Organization Validation Secure Server CA
</I>&gt;<i> Same question.  From what I've read this means that I don't have the correct root ca?  Is that correct?  If so is the fix to then go try to find the correct .crt and add it to the standard ca-cert store? ( I'm on debian so /usr/share/ca-certificates/Mozilla )
</I>&gt;<i> 
</I>&gt;<i> Again, is this correct as to what is going wrong and the correct fix?
</I>
Well, first step is to ensure your ca-certificates package is up to
date. That usually solves these.

But not always, especially if the CA has been caught doing bad things
and suddenly dropped. Or if they have begun issuing certs to clients
before being accepted by the Mozilla CA list people.

It could also be a problem with intermediary cert just being omitted by
the server. In that case adding it to your server-wide cert store or
configuring it to be loaded by Squid will be needed.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010252.html">[squid-users] Cert authority invalid failures.
</A></li>
	<LI>Next message (by thread): <A HREF="010273.html">[squid-users] Cert authority invalid failures.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10263">[ date ]</a>
              <a href="thread.html#10263">[ thread ]</a>
              <a href="subject.html#10263">[ subject ]</a>
              <a href="author.html#10263">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
