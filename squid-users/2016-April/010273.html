<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cert authority invalid failures.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cert%20authority%20invalid%20failures.&In-Reply-To=%3C2B77BF184EAC2F43BB9FC908954D8B12670559EE%40Ex5.lnpnews.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010263.html">
   <LINK REL="Next"  HREF="010275.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cert authority invalid failures.</H1>
    <B>Markey, Bruce</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cert%20authority%20invalid%20failures.&In-Reply-To=%3C2B77BF184EAC2F43BB9FC908954D8B12670559EE%40Ex5.lnpnews.com%3E"
       TITLE="[squid-users] Cert authority invalid failures.">bmarkey at steinmancommunications.com
       </A><BR>
    <I>Thu Apr 21 14:36:10 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010263.html">[squid-users] Cert authority invalid failures.
</A></li>
        <LI>Next message (by thread): <A HREF="010275.html">[squid-users] Cert authority invalid failures.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10273">[ date ]</a>
              <a href="thread.html#10273">[ thread ]</a>
              <a href="subject.html#10273">[ subject ]</a>
              <a href="author.html#10273">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>acl internal src 192.168.200.0/21
acl wireless src 192.168.100.0/23

acl Safe_ports port 80
acl Safe_ports port 443
acl SSL_ports port 443
acl CONNECT method CONNECT

acl allowed dstdomain -i &quot;/etc/squid3/acls/http_allowed.acl&quot;
acl prime dstdomain -i &quot;/etc/squid3/acls/squid-prime.acl&quot;
acl ips dst -n &quot;/etc/squid3/acls/broken_ips.acl&quot;
acl blocked dstdomain -i &quot;/etc/squid3/acls/http_blocked.acl&quot;

http_access allow allowed
http_access allow ips
http_access deny blocked
http_access deny prime

http_access allow internal
http_access allow wireless
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny all

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

acl broken_sites ssl::server_name_regex &quot;/etc/squid3/acls/http_broken.txt&quot;
ssl_bump peek !broken_sites
ssl_bump splice all

sslproxy_capath /etc/ssl/certs

sslcrtd_program /lib/squid3/ssl_crtd -s /etc/squid3/ssl_db -M 4MB
sslcrtd_children 32 startup=5 idle=1



http_port 3128 intercept
https_port 3129 intercept ssl-bump cert=/etc/squid3/certs/squid.pem cafile=/etc/squid3/certs/squid.pem key=/etc/squid3/certs/squid.pem  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB sslflags=NO_SESSION_REUSE

dns_nameservers 192.168.201.1 8.8.8.8

wccp_version 2
wccp2_router 192.168.200.73
wccp2_forwarding_method gre
wccp2_return_method gre
wccp2_service standard 0 password=xxxx
wccp2_service dynamic 70 password=xxxx
wccp2_service_info 70 protocol=tcp flags=dst_ip_hash priority=240 ports=443

I did update the ca bundle if that helps. 



Bruce Markey | Network Security Analyst
STEINMAN COMMUNICATIONS
717.291.8758&#160;(o) |&#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">bmarkey at steinmancommunications.com</A>
8 West King St | PO Box 1328, Lancaster, PA 17608-1328

-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: Thursday, April 21, 2016 8:59 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Cert authority invalid failures.

On 21/04/2016 8:18 a.m., Markey, Bruce wrote:
&gt;<i> I'm curious as to why this is happening.
</I>&gt;<i> 
</I>&gt;<i> Proxy was implemented last week and since then I've been dealing with all the sites that don't work. Not a problem, knew it was going to happen. I'd like to understand why the following is happening.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 1.       User goes to <A HREF="https://www.whatever.com">https://www.whatever.com</A>
</I>&gt;<i> 
</I>&gt;<i> 2.       Browser, mostly chrome, gives the following error.   Connection not private. NET:ERR_CERT_AUTHORITY_INVALID
</I>&gt;<i> 
</I>
Typing that into search engine produces a thread explaining that it is the browser message shown when HSTS is in effect on a website and the server cert is not trusted by the browser.



&gt;<i> 3.       If you view the cert it shows the dynamic cert listed.
</I>&gt;<i> 
</I>&gt;<i> 4.       Click the &quot;Proceed to www.whatever.com&lt;<A HREF="http://www.whatever.com">http://www.whatever.com</A>&gt; (unsafe )
</I>&gt;<i> 
</I>&gt;<i> 5.       Now I get a squid error.  Requested url could not be retrieved.  Access denied while trying to retrieve <A HREF="https://">https://</A> some ip address/*
</I>&gt;<i> 
</I>
And that #5 explains why. It was actually not the web server producing the cert. But Squid doing SSL-Bumping in order to show you the error page.



&gt;<i> Thing is I don't have an acl blocking that ip?   ( Small sub question here, is there a way to tell which acl blocks something? )
</I>&gt;<i> 
</I>
Something clearly is. But not what you expect, or you would not be here asking about it.

&gt;<i> What I've had to do to get around this is add www.whatever.com&lt;<A HREF="http://www.whatever.com">http://www.whatever.com</A>&gt; to my broken_sites.acl.    Then add the ip to an allowed_ips.acl.
</I>&gt;<i> 
</I>&gt;<i> Then I http_access allow the ips list
</I>&gt;<i> 
</I>&gt;<i> And skip peeking at the broken site.
</I>&gt;<i> 
</I>&gt;<i> acl broken_sites ssl::server_name_regex &quot;/etc/squid3/acls/http_broken.txt&quot;
</I>&gt;<i> ssl_bump peek !broken_sites
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> I'm trying to understand why this is breaking and if I'm doing the right thing in fixing it.
</I>&gt;<i> 
</I>
Please provide your whole squid.conf (except empty or # comment lines).
We might need to see it all to find what the problem is.


&gt;<i> 
</I>&gt;<i> The second error I'm getting is:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The following error was encountered while trying to retrieve the URL: 
</I>&gt;<i> <A HREF="https://*.agentimediaservices.com/*&lt;https://%2A.agentimediaservices.co">https://*.agentimediaservices.com/*&lt;https://%2A.agentimediaservices.co</A>
</I>&gt;<i> m/*&gt;
</I>&gt;<i> 
</I>&gt;<i> Failed to establish a secure connection to 63.240.52.151
</I>&gt;<i> 
</I>&gt;<i> The system returned:
</I>&gt;<i> 
</I>&gt;<i> (71) Protocol error (TLS code: 
</I>&gt;<i> X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
</I>&gt;<i> 
</I>&gt;<i> SSL Certficate error: certificate issuer (CA) not known: 
</I>&gt;<i> /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO 
</I>&gt;<i> RSA Organization Validation Secure Server CA Same question.  From what 
</I>&gt;<i> I've read this means that I don't have the correct root ca?  Is that 
</I>&gt;<i> correct?  If so is the fix to then go try to find the correct .crt and 
</I>&gt;<i> add it to the standard ca-cert store? ( I'm on debian so 
</I>&gt;<i> /usr/share/ca-certificates/Mozilla )
</I>&gt;<i> 
</I>&gt;<i> Again, is this correct as to what is going wrong and the correct fix?
</I>
Well, first step is to ensure your ca-certificates package is up to date. That usually solves these.

But not always, especially if the CA has been caught doing bad things and suddenly dropped. Or if they have begun issuing certs to clients before being accepted by the Mozilla CA list people.

It could also be a problem with intermediary cert just being omitted by the server. In that case adding it to your server-wide cert store or configuring it to be loaded by Squid will be needed.

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010263.html">[squid-users] Cert authority invalid failures.
</A></li>
	<LI>Next message (by thread): <A HREF="010275.html">[squid-users] Cert authority invalid failures.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10273">[ date ]</a>
              <a href="thread.html#10273">[ thread ]</a>
              <a href="subject.html#10273">[ subject ]</a>
              <a href="author.html#10273">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
