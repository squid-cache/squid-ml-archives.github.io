<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cert authority invalid failures.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cert%20authority%20invalid%20failures.&In-Reply-To=%3C57190E0B.3060902%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010273.html">
   <LINK REL="Next"  HREF="010257.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cert authority invalid failures.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cert%20authority%20invalid%20failures.&In-Reply-To=%3C57190E0B.3060902%40treenet.co.nz%3E"
       TITLE="[squid-users] Cert authority invalid failures.">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr 21 17:29:47 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010273.html">[squid-users] Cert authority invalid failures.
</A></li>
        <LI>Next message (by thread): <A HREF="010257.html">[squid-users] squid 2.7/lusca not work with web auth IIS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10275">[ date ]</a>
              <a href="thread.html#10275">[ thread ]</a>
              <a href="subject.html#10275">[ subject ]</a>
              <a href="author.html#10275">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/04/2016 2:36 a.m., Markey, Bruce wrote:
&gt;<i> acl internal src 192.168.200.0/21
</I>&gt;<i> acl wireless src 192.168.100.0/23
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl allowed dstdomain -i &quot;/etc/squid3/acls/http_allowed.acl&quot;
</I>&gt;<i> acl prime dstdomain -i &quot;/etc/squid3/acls/squid-prime.acl&quot;
</I>&gt;<i> acl ips dst -n &quot;/etc/squid3/acls/broken_ips.acl&quot;
</I>&gt;<i> acl blocked dstdomain -i &quot;/etc/squid3/acls/http_blocked.acl&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access allow allowed
</I>&gt;<i> http_access allow ips
</I>&gt;<i> http_access deny blocked
</I>&gt;<i> http_access deny prime
</I>
It would seem that it could only be these two ACLs blocked or prime
which are causing your denial.

Note that when dstdomain is passed a raw-IP the reverse-DNS will be
looked up and if that domain OR the raw-IP match an entry in the list it
will be a match.

Note2 that when a connection arrives at your &quot;intercept ssl-bump&quot; port
Squid will generate a CONNECT message using the raw-IP of that
connection and pass it through your http_access controls. The denial
could happen then.

Once the SNI is found by the peek another pass of the http_access
happens. Denial could happen then as well.
Then your splice kicks in.

&gt;<i> 
</I>&gt;<i> http_access allow internal
</I>&gt;<i> http_access allow wireless
</I>
Move these ...

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
... default security controls back up to the top of your config.

&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> acl broken_sites ssl::server_name_regex &quot;/etc/squid3/acls/http_broken.txt&quot;
</I>&gt;<i> ssl_bump peek !broken_sites
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /lib/squid3/ssl_crtd -s /etc/squid3/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 32 startup=5 idle=1
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3129 intercept ssl-bump cert=/etc/squid3/certs/squid.pem cafile=/etc/squid3/certs/squid.pem key=/etc/squid3/certs/squid.pem  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB sslflags=NO_SESSION_REUSE
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 192.168.201.1 8.8.8.8
</I>&gt;<i> 
</I>&gt;<i> wccp_version 2
</I>&gt;<i> wccp2_router 192.168.200.73
</I>&gt;<i> wccp2_forwarding_method gre
</I>&gt;<i> wccp2_return_method gre
</I>&gt;<i> wccp2_service standard 0 password=xxxx
</I>&gt;<i> wccp2_service dynamic 70 password=xxxx
</I>&gt;<i> wccp2_service_info 70 protocol=tcp flags=dst_ip_hash priority=240 ports=443
</I>&gt;<i> 
</I>&gt;<i> I did update the ca bundle if that helps. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Bruce Markey | Network Security Analyst
</I>&gt;<i> STEINMAN COMMUNICATIONS
</I>&gt;<i> 717.291.8758 (o) | <A HREF="https://lists.squid-cache.org/listinfo/squid-users">bmarkey at steinmancommunications.com</A>
</I>&gt;<i> 8 West King St | PO Box 1328, Lancaster, PA 17608-1328
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
</I>&gt;<i> Sent: Thursday, April 21, 2016 8:59 AM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Cert authority invalid failures.
</I>&gt;<i> 
</I>&gt;<i> On 21/04/2016 8:18 a.m., Markey, Bruce wrote:
</I>&gt;&gt;<i> I'm curious as to why this is happening.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Proxy was implemented last week and since then I've been dealing with all the sites that don't work. Not a problem, knew it was going to happen. I'd like to understand why the following is happening.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1.       User goes to <A HREF="https://www.whatever.com">https://www.whatever.com</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2.       Browser, mostly chrome, gives the following error.   Connection not private. NET:ERR_CERT_AUTHORITY_INVALID
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Typing that into search engine produces a thread explaining that it is the browser message shown when HSTS is in effect on a website and the server cert is not trusted by the browser.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 3.       If you view the cert it shows the dynamic cert listed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4.       Click the &quot;Proceed to www.whatever.com&lt;<A HREF="http://www.whatever.com">http://www.whatever.com</A>&gt; (unsafe )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 5.       Now I get a squid error.  Requested url could not be retrieved.  Access denied while trying to retrieve <A HREF="https://">https://</A> some ip address/*
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> And that #5 explains why. It was actually not the web server producing the cert. But Squid doing SSL-Bumping in order to show you the error page.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Thing is I don't have an acl blocking that ip?   ( Small sub question here, is there a way to tell which acl blocks something? )
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Something clearly is. But not what you expect, or you would not be here asking about it.
</I>&gt;<i> 
</I>&gt;&gt;<i> What I've had to do to get around this is add www.whatever.com&lt;<A HREF="http://www.whatever.com">http://www.whatever.com</A>&gt; to my broken_sites.acl.    Then add the ip to an allowed_ips.acl.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then I http_access allow the ips list
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And skip peeking at the broken site.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl broken_sites ssl::server_name_regex &quot;/etc/squid3/acls/http_broken.txt&quot;
</I>&gt;&gt;<i> ssl_bump peek !broken_sites
</I>&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to understand why this is breaking and if I'm doing the right thing in fixing it.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Please provide your whole squid.conf (except empty or # comment lines).
</I>&gt;<i> We might need to see it all to find what the problem is.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The second error I'm getting is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The following error was encountered while trying to retrieve the URL: 
</I>&gt;&gt;<i> <A HREF="https://*.agentimediaservices.com/*&lt;https://%2A.agentimediaservices.co">https://*.agentimediaservices.com/*&lt;https://%2A.agentimediaservices.co</A>
</I>&gt;&gt;<i> m/*&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Failed to establish a secure connection to 63.240.52.151
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The system returned:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (71) Protocol error (TLS code: 
</I>&gt;&gt;<i> X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SSL Certficate error: certificate issuer (CA) not known: 
</I>&gt;&gt;<i> /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO 
</I>&gt;&gt;<i> RSA Organization Validation Secure Server CA Same question.  From what 
</I>&gt;&gt;<i> I've read this means that I don't have the correct root ca?  Is that 
</I>&gt;&gt;<i> correct?  If so is the fix to then go try to find the correct .crt and 
</I>&gt;&gt;<i> add it to the standard ca-cert store? ( I'm on debian so 
</I>&gt;&gt;<i> /usr/share/ca-certificates/Mozilla )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Again, is this correct as to what is going wrong and the correct fix?
</I>&gt;<i> 
</I>&gt;<i> Well, first step is to ensure your ca-certificates package is up to date. That usually solves these.
</I>&gt;<i> 
</I>&gt;<i> But not always, especially if the CA has been caught doing bad things and suddenly dropped. Or if they have begun issuing certs to clients before being accepted by the Mozilla CA list people.
</I>&gt;<i> 
</I>&gt;<i> It could also be a problem with intermediary cert just being omitted by the server. In that case adding it to your server-wide cert store or configuring it to be loaded by Squid will be needed.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010273.html">[squid-users] Cert authority invalid failures.
</A></li>
	<LI>Next message (by thread): <A HREF="010257.html">[squid-users] squid 2.7/lusca not work with web auth IIS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10275">[ date ]</a>
              <a href="thread.html#10275">[ thread ]</a>
              <a href="subject.html#10275">[ subject ]</a>
              <a href="author.html#10275">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
