<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High CPU Usage with ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU%20Usage%20with%20ssl_bump&In-Reply-To=%3CCAAdA2WN9FGqQWGMUmzEKEbE%3DB%3DqJwuJYH7X4cf1N7v1cLmhDzQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010283.html">
   <LINK REL="Next"  HREF="010293.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High CPU Usage with ssl_bump</H1>
    <B>Odhiambo Washington</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU%20Usage%20with%20ssl_bump&In-Reply-To=%3CCAAdA2WN9FGqQWGMUmzEKEbE%3DB%3DqJwuJYH7X4cf1N7v1cLmhDzQ%40mail.gmail.com%3E"
       TITLE="[squid-users] High CPU Usage with ssl_bump">odhiambo at gmail.com
       </A><BR>
    <I>Thu Apr 21 21:26:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010283.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="010293.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10289">[ date ]</a>
              <a href="thread.html#10289">[ thread ]</a>
              <a href="subject.html#10289">[ subject ]</a>
              <a href="author.html#10289">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21 April 2016 at 23:14, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
wrote:

&gt;<i> On 04/21/2016 01:59 PM, Odhiambo Washington wrote:
</I>&gt;<i> &gt; On 21 April 2016 at 22:04, Amos Jeffries wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 22/04/2016 6:20 a.m., Odhiambo Washington wrote:
</I>&gt;<i> &gt;     &gt; I have now changed to *configurations suggested specifically for
</I>&gt;<i> your use
</I>&gt;<i> &gt;     &gt; case, on this email thread* :)
</I>&gt;<i>
</I>&gt;<i> &gt;     &gt; acl no_ssl_interception ssl::server_name
</I>&gt;<i> &gt;     &gt; &quot;/usr/local/etc/squid/ssl_bump_broken_sites.txt&quot;
</I>&gt;<i> &gt;     &gt; ssl_bump splice no_ssl_interception
</I>&gt;<i> &gt;     &gt; ssl_bump stare all
</I>&gt;<i> &gt;     &gt; ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     No the &quot;stare&quot; being done will prevent splice and you will see
</I>&gt;<i> breakage
</I>&gt;<i> &gt;     or unexpected things again.
</I>&gt;<i> &gt;     You have to replace 'stare' with 'peek' AND replace 'bump' with
</I>&gt;<i> &gt;     'splice'.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Like below???
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl no_ssl_interception ssl::server_name
</I>&gt;<i> &gt; &quot;/usr/local/etc/squid/ssl_bump_broken_sites.txt&quot;
</I>&gt;<i> &gt; ssl_bump splice no_ssl_interception
</I>&gt;<i> &gt; ssl_bump peek all
</I>&gt;<i> &gt; ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Logging aside, your latest random configuration is equivalent to
</I>&gt;<i>
</I>&gt;<i>   ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> which means you are better off not intercepting SSL at all, which brings
</I>&gt;<i> us back to the old question: What do you want Squid to do?
</I>&gt;<i>
</I>
If I could intercept SSL and do nothing EXCEPT subject the domains to time
ACLs, that'd be all. I do not need any bumping to be precise.
I just want the data passing through squid for me to determine who is
allowed to access it and at what time.

I do have time ACLs, which I use in conjunction with MAC ACLs and certain
domain, like facebook.com. Right now I rely on destdomain to identify the
domains.
With domains using SSL, I cannot use destdomain, right? Let me demonstrate
with config snippets from my squid.conf, perhaps that would explain it
better and maybe I will find a better easier way out that this ssl_bump
monster:-)

acl TIMEweekdaysALLDAY time MTWHF 09:00-17:00
acl TIMEafterhoursMORN time MTWHF 00:00-09:00
acl TIMElunch time MTWHF 12:00-13:59
acl TIMEafterhoursAFT time MTWHF 14:30-23:59
acl TIMEsatMORN time A 00:00-07:00
acl TIMEsatAFT time A 11:00-23:59
acl TIMEsatALLDAY time A 00:00-23:59
acl TIMEsundALLDAY time S 00:00-23:59

# Internet Access Regulation
# Some privileged staff - can browse unrestricted
acl privileged-staff arp &quot;/usr/local/etc/squid/privileged_mac_addresses.txt&quot;

# Sites staff waste all their time on - Social Networks, streaming sites, etc
acl TIMEWASTAGESITES dstdomain &quot;/usr/local/etc/squid/time_wastage_sites.txt&quot;

# TIMEWASTAGESITES
http_access allow TIMEWASTAGESITES privileged-staff
http_access allow TIMEWASTAGESITES TIMElunch
http_access allow TIMEWASTAGESITES TIMEafterhoursAFT
http_access allow TIMEWASTAGESITES TIMEafterhoursMORN
http_access allow TIMEWASTAGESITES TIMEsatALLDAY
http_access allow TIMEWASTAGESITES TIMEsundALLDAY
http_access deny  TIMEWASTAGESITES


Now, the above used to work until facebook.com, youtube.com, and
others switched to HTTPS. After that it wasn't possible for me to
control access to them.

So really, all I want is the ability to intercept SSL and subject it
to those time ACLs for a class of users. Nothing more.



&gt;<i> If you want Squid to not intrude except when terminating prohibited
</I>&gt;<i> traffic, then start with this sketch:
</I>&gt;<i>
</I>&gt;<i>   ssl_bump terminate prohibited_traffic
</I>&gt;<i>   ssl_bump peek all
</I>&gt;<i>   ssl_bump splice all
</I>&gt;<i>
</I>
Lemme see if I understand this. I have a problem wrapping my head around
'terminate' (as a terminology, maybe) and 'prohibited_traffic' (also as a
terminology).
So, are you saying that prohibited_traffic here is something like:

acl TIMEWASTAGE_SSL
ssl::server_name &quot;/usr/local/etc/squid/time_wastage_SSL_sites.txt&quot;

And in that file I have
.facebook.com
.youtube.com
...

Then I just apply my usual time ACLs..

http_access allow TIMEWASTAGESITES_SSL privileged_staff
http_access allow TIMEWASTAGESITES_SSL TIMElunch
http_access allow TIMEWASTAGESITES_SSL TIMEafterhoursAFT
http_access allow TIMEWASTAGESITES_SSL TIMEafterhoursMORN
http_access allow TIMEWASTAGESITES_SSL TIMEsatALLDAY
http_access allow TIMEWASTAGESITES_SSL TIMEsundALLDAY
http_access deny  TIMEWASTAGESITES_SSL

That is more like all I want - use *ssl::server_name* instead of *dstdomain.
* The sites are NOT prohibited per se, and 'terminate' kinda scares me. I
need to RTFM about this 'terminate' again and again until I can sing it:)



&gt;<i> If you want Squid to intrude (where possible) and block prohibited
</I>&gt;<i> traffic, then install your CA certificates on all user devices and start
</I>&gt;<i> with this sketch:
</I>&gt;<i>
</I>&gt;<i>   ssl_bump splice things_that_are_impossible_to_bump
</I>&gt;<i>   ssl_bump stare all
</I>&gt;<i>   ssl_bump bump all
</I>&gt;<i>   http_access deny prohibited_traffic
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>
I actually believe I do not need any mention of ssl_bump, but the confusion
for me arises out of TWO things:

1. In my firewall (FreeBSD PF), redirecting traffic destined to port 443
via squid wasn't an option prior to the intruduction of the SSL
interception, right?
2. In squid.conf, I did not yet figure out if I can use just


     https_port 13129 intercept

Instead of

    https_ports NNNN intercept ssl-bump ...... ....



I hope this time round I have explained myself well.

Thank you.

-- 
Best regards,
Odhiambo WASHINGTON,
Nairobi,KE
+254 7 3200 0004/+254 7 2274 3223
&quot;Oh, the cruft.&quot;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160422/e2ad236b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160422/e2ad236b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010283.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="010293.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10289">[ date ]</a>
              <a href="thread.html#10289">[ thread ]</a>
              <a href="subject.html#10289">[ subject ]</a>
              <a href="author.html#10289">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
