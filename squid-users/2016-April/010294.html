<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High CPU Usage with ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU%20Usage%20with%20ssl_bump&In-Reply-To=%3CCAAdA2WN53xFWcSy_HjmwOr7gftKdWSgHRoqYC6U3U3EkWHUSqg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010293.html">
   <LINK REL="Next"  HREF="010295.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High CPU Usage with ssl_bump</H1>
    <B>Odhiambo Washington</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20CPU%20Usage%20with%20ssl_bump&In-Reply-To=%3CCAAdA2WN53xFWcSy_HjmwOr7gftKdWSgHRoqYC6U3U3EkWHUSqg%40mail.gmail.com%3E"
       TITLE="[squid-users] High CPU Usage with ssl_bump">odhiambo at gmail.com
       </A><BR>
    <I>Fri Apr 22 08:23:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010293.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="010295.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10294">[ date ]</a>
              <a href="thread.html#10294">[ thread ]</a>
              <a href="subject.html#10294">[ subject ]</a>
              <a href="author.html#10294">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22 April 2016 at 02:16, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
wrote:

&gt;<i> On 04/21/2016 03:26 PM, Odhiambo Washington wrote:
</I>&gt;<i> &gt; On 21 April 2016 at 23:14, Alex Rousskov wrote:
</I>&gt;<i> &gt;     Logging aside, your latest random configuration is equivalent to
</I>&gt;<i> &gt;     [...] not intercepting SSL at all, which brings
</I>&gt;<i> &gt;     us back to the old question: What do you want Squid to do?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; If I could intercept SSL and do nothing EXCEPT subject the domains to
</I>&gt;<i> &gt; time ACLs, that'd be all.
</I>&gt;<i>
</I>&gt;<i> You are going back to the problem we have already discussed. Please slow
</I>&gt;<i> down and translate your description above into what should happen to
</I>&gt;<i> user connections that match your &quot;time ACLs&quot;.
</I>&gt;<i>
</I>

*slow down mode engaged*

You have given me these two templates:

(1)
If you want Squid to not intrude except when terminating prohibited traffic,
then start with this sketch:

  ssl_bump terminate prohibited_traffic
  ssl_bump peek all
  ssl_bump splice all

I would have preffered this option, first because it doesn't involve me
installing my CA on all user devices and secondly because of no intrusion.
However I cannot figure out how to deal with this when it comes to ACLs
because '*terminate*' isn't really what I think I want. What I want is as
follows:
(a) squid receives requiest from a particular host for facebook.com. Host
is identified by MAC Address or IP
(b) squid decides (based on ACLs) if host is allowed access to facebook.com
at this time, then allows it
(c) squid throws an error message if host is not allowed access at this
time.

If I could achieve the above, I will be fine. How to craft the configs is
my trouble. I keep fumbling.


(2)
If you want Squid to intrude (where possible) and block prohibited
traffic, then install your CA certificates on all user devices and start
with this sketch:

  ssl_bump splice things_that_are_impossible_to_bump
  ssl_bump stare all
  ssl_bump bump all
  http_access deny prohibited_traffic

Now here, the CA challenge abounds. We have a guest SSID on our WLAN and
this means I have to install the CAs even for guests or redo the network to
be able to accommodate guest users browsing without being subjected to our
internal policies.



&gt;<i>
</I>&gt;<i> * Does &quot;subject the domains to time ACLs&quot; mean &quot;immediately close
</I>&gt;<i> connections that match&quot; those ACLs?
</I>&gt;<i>
</I>
No.


&gt;<i>
</I>&gt;<i> * Or does it mean &quot;serve Squid error pages&quot; over connections that match
</I>&gt;<i> those ACLs?
</I>&gt;<i>
</I>
Yes.


&gt;<i>
</I>&gt;<i> Once you decide, apply one of the two templates provided (the two
</I>&gt;<i> templates correspond to which of the two questions you answer &quot;yes&quot;).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I just want the data passing through squid for me to determine who is
</I>&gt;<i> &gt; allowed to access it and at what time.
</I>&gt;<i>
</I>&gt;<i> Assume Squid has made that access determination you want to make, and
</I>&gt;<i> the user is not allowed. Now what: Close the connection? Or serve an
</I>&gt;<i> error page?
</I>&gt;<i>
</I>&gt;<i>
</I>Serve an error page.

.

&gt;<i>
</I>&gt;<i> &gt; I do have time ACLs, [...]
</I>&gt;<i>
</I>&gt;<i> The specifics of your ACLs are irrelevant at this stage. You can fix
</I>&gt;<i> them later once you get overall SslBump setup working the way you want.
</I>&gt;<i> You can assume that there is just one ACL called &quot;prohibited_traffic&quot; or
</I>&gt;<i> &quot;good_traffic&quot;. Now write the rules that determine what happens to
</I>&gt;<i> connections that match one of those two ACLs.
</I>&gt;<i>
</I>


&gt;<i>     If you want Squid to not intrude except when terminating prohibited
</I>&gt;<i> &gt;     traffic, then start with this sketch:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;       ssl_bump terminate prohibited_traffic
</I>&gt;<i> &gt;       ssl_bump peek all
</I>&gt;<i> &gt;       ssl_bump splice all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Lemme see if I understand this. I have a problem wrapping my head around
</I>&gt;<i> &gt; 'terminate' (as a terminology, maybe)
</I>&gt;<i>
</I>&gt;<i> &quot;terminate&quot; means &quot;close the SSL connection(s) immediately&quot;. No error
</I>&gt;<i> response is sent by Squid to the user. It does not get much simpler than
</I>&gt;<i> that! The browser will probably show some &quot;secure connection could not
</I>&gt;<i> be negotiated&quot; error to the user with no usable details [because Squid
</I>&gt;<i> sent nothing to the browser in this case].
</I>&gt;<i>
</I>&gt;<i>
</I>That is NOT what I want. I need squid to serve an error page that &quot;Access
is denied at this time..&quot;
I think it's usually something like &quot;access controls prohibit you from
access this page at this time...&quot;.


&gt;<i>
</I>&gt;<i> &gt; and 'prohibited_traffic' (also as a terminology).
</I>&gt;<i>
</I>&gt;<i> Just some ACL name. You will define that aggregate ACL later to match
</I>&gt;<i> any traffic you want to prohibit. It will contain a combination of time
</I>&gt;<i> and server name ACLs. Other details are not important until your SslBump
</I>&gt;<i> [and http_access rules] are correct.
</I>&gt;<i>
</I>
Okay.


&gt;<i>
</I>&gt;<i> If you do not know how to aggregate ACLs, look for &quot;any-of&quot; and &quot;all-of&quot;
</I>&gt;<i> in squid.conf.documented, but, again, ACL specifics are not important
</I>&gt;<i> right now. They will become important at stage three. Now you are
</I>&gt;<i> struggling with stage one: Deciding what to do with matching SSL
</I>&gt;<i> connections (close or serve error pages).
</I>&gt;<i>
</I>
Sure, I am really struggling to understand this. I would like to serve
error pages. A complete example of this would really help. I am thinking,
based on the two templates you gave and going with the one where squid
intrudes, that it could be like below, but to be honest I am not sure so
kindly correct me.


acl time_wastage_sites_ssl ssl::server_name .facebook.com .youtube.com
ssl_bump splice time_wastage_sites_ssl
ssl_bump stare all
ssl_bump bump all
http_access allow time_wastage_sites_ssl privileged-staff
http_access allow time_wastage_sites_ssl privileged-clients
http_access allow time_wastage_sites_ssl TIMElunch
http_access allow time_wastage_sites_ssl TIMEafterhoursAFT
http_access allow time_wastage_sites_ssl TIMEafterhoursMORN
http_access allow time_wastage_sites_ssl TIMEsatALLDAY
http_access allow time_wastage_sites_ssl TIMEsundALLDAY
http_access deny  time_wastage_sites_ssl



&gt;<i>
</I>&gt;<i> FWIW, my recommendation is to terminate/close and find other ways to
</I>&gt;<i> inform users about their policy violations.
</I>




-- 
Best regards,
Odhiambo WASHINGTON,
Nairobi,KE
+254 7 3200 0004/+254 7 2274 3223
&quot;Oh, the cruft.&quot;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160422/d4c5993e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160422/d4c5993e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010293.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="010295.html">[squid-users] High CPU Usage with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10294">[ date ]</a>
              <a href="thread.html#10294">[ thread ]</a>
              <a href="subject.html#10294">[ subject ]</a>
              <a href="author.html#10294">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
