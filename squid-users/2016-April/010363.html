<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Regex optimization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Regex%20optimization&In-Reply-To=%3C5720C63B.2040601%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010362.html">
   <LINK REL="Next"  HREF="010364.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Regex optimization</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Regex%20optimization&In-Reply-To=%3C5720C63B.2040601%40treenet.co.nz%3E"
       TITLE="[squid-users] Regex optimization">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 27 14:01:31 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010362.html">[squid-users] Regex optimization
</A></li>
        <LI>Next message (by thread): <A HREF="010364.html">[squid-users] Regex optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10363">[ date ]</a>
              <a href="thread.html#10363">[ thread ]</a>
              <a href="subject.html#10363">[ subject ]</a>
              <a href="author.html#10363">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/04/2016 11:32 p.m., Alfredo Rezinovsky wrote:
&gt;<i> I saw in debug log that when an ACL has many regexes each one is compared
</I>&gt;<i> sequentially.
</I>&gt;<i> 
</I>&gt;<i> If I have
</I>&gt;<i> 
</I>&gt;<i> www.facebook.com
</I>&gt;<i> facebook.com
</I>&gt;<i> www.google.com
</I>&gt;<i> google.com
</I>&gt;<i> 
</I>&gt;<i> If will be faster to check just ONE optimized regex like
</I>&gt;<i> (www\.)?(facebook|google).com than the previous three?
</I>&gt;<i> 
</I>&gt;<i> I'm really talking about optimizing about 3000 url regexes in one huge
</I>&gt;<i> regex because comparing each and every url to 3000 regexes is too slow.
</I>
As Yuri was trying to point out (I think) simply using one bigger regex
pattern is not always meaning faster.


&gt;<i> 
</I>&gt;<i> I know using
</I>&gt;<i> (www\.facebook\.com)|(facebook\.com)|(www\.google\.com)|(google\.com) with
</I>&gt;<i> PCRE will produce the same optimized result as
</I>&gt;<i> (www\.)?(facebook|google)\.com. Squid uses GnuRegex. Does GNURegex lib
</I>&gt;<i> optimizes this as well ?
</I>
If you actually pass GNURegex that *single* pattern. Yes, it will do
some optimization. Though I'm not sure how much exactly in comparison to
PCRE.

 * Also, while GNURegex is the built-in backup regex engine bundled with
Squid. It really is only a backup engine for systems like Windows which
dont provide a regex engine. The stdlib regex library is always used if
available. On some OS that stdlib engine is GNU, on others PCRE or
something even better.


What you see in the log is the fact that Squid is actually *not*
configured with a single compound &quot;optimized&quot; pattern. You are actually
using a file with ~3000 patterns in it ... so 3000 regex patterns to be
checked against the URL.

Whether Squid checks 3000 tests or some smaller number depends on what
Squid version you are using. The recent versions do some trivial pattern
aggregation and stripping away prefix/suffix &quot;.*&quot; garbage to help the
library optimize better. But as Yuri showed, bigger pattern is not
necessarily better *steps* for per-test speed. The gains are mostly in
reduced Squid code CPU time and RAM overheads.
Regex is still the slowest of the ACLs in terms of raw CPU consumed.


The biggest problem with using regex for domain name lists is that regex
is optimized for left-to-right comparisons. Domain name labels are built
right-to-left. dstdomain is optimized for right-to-left comparison with
an early-abort on mismatch and sub-domain wildcards - which gives it a
huge advantage in CPU cycles over regex.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010362.html">[squid-users] Regex optimization
</A></li>
	<LI>Next message (by thread): <A HREF="010364.html">[squid-users] Regex optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10363">[ date ]</a>
              <a href="thread.html#10363">[ thread ]</a>
              <a href="subject.html#10363">[ subject ]</a>
              <a href="author.html#10363">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
