<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSLBump just not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%20just%20not%20working&In-Reply-To=%3Cc9467f58-6dda-edc1-1698-8534a3c9b053%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011753.html">
   <LINK REL="Next"  HREF="011771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSLBump just not working</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%20just%20not%20working&In-Reply-To=%3Cc9467f58-6dda-edc1-1698-8534a3c9b053%40treenet.co.nz%3E"
       TITLE="[squid-users] SSLBump just not working">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug  3 03:53:15 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011753.html">[squid-users] SSLBump just not working
</A></li>
        <LI>Next message (by thread): <A HREF="011771.html">[squid-users] SSLBump just not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11762">[ date ]</a>
              <a href="thread.html#11762">[ thread ]</a>
              <a href="subject.html#11762">[ subject ]</a>
              <a href="author.html#11762">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/08/2016 1:30 p.m., JR Dalrymple wrote:
&gt;<i> I have a freshly installed Squid from source on a likewise freshly
</I>&gt;<i> installed OpenBSD system. Attempting to replace an aging stub Squid on
</I>&gt;<i> Linux with transparent with SSLBump. I think I have everything set up
</I>&gt;<i> pretty skookup, the symptom is it just isn't working. When I browse to an
</I>&gt;<i> https website I get presented my root cert, but not a dynamically created
</I>&gt;<i> cert underneath. It doesn't look like they're being created as the folder
</I>&gt;<i> hierarchy that's supposed to contain the dynamic certs remains empty. Note
</I>&gt;<i> that as of yet this is not in a transparent configuration - choosing to
</I>&gt;<i> crawl before I walk. Here is some perhaps useful info from the system:
</I>&gt;<i> 
</I>&lt;snip&gt;

&gt;<i> ...
</I>&gt;<i> 2016/08/01 16:54:54.370 kid1| 83,7| bio.cc(168) stateChanged: FD 12 now:
</I>&gt;<i> 0x20 SSLOK  (SSL negotiation finished successfully)
</I>&gt;<i> 2016/08/01 16:54:54.370 kid1| 83,7| bio.cc(168) stateChanged: FD 12 now:
</I>&gt;<i> 0x2002 SSLOK  (SSL negotiation finished successfully)
</I>&gt;<i> -----BEGIN SSL SESSION PARAMETERS-----
</I>&gt;<i> -----END SSL SESSION PARAMETERS-----
</I>&gt;<i> 2016/08/01 16:54:54.370 kid1| 83,2| client_side.cc(3809)
</I>&gt;<i> clientNegotiateSSL: clientNegotiateSSL: New session 0x38985389200 on FD 12 (
</I>&gt;<i> 172.22.19.48:65433)
</I>&gt;<i> 2016/08/01 16:54:54.370 kid1| 83,3| client_side.cc(3813)
</I>&gt;<i> clientNegotiateSSL: clientNegotiateSSL: FD 12 negotiated cipher AES128-SHA
</I>&gt;<i> 2016/08/01 16:54:54.371 kid1| 83,5| client_side.cc(3829)
</I>&gt;<i> clientNegotiateSSL: clientNegotiateSSL: FD 12 has no certificate.
</I>&gt;<i> 2016/08/01 16:54:54.426 kid1| 85,5| client_side_request.cc(1438)
</I>&gt;<i> sslBumpAccessCheck: cannot SslBump this request
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> # grep -v ^# /usr/local/squid/etc/squid.conf | grep -v ^[\s]*$
</I>
...
&gt;<i> ssl_bump bump all
</I>
ssl_bump gets processed in three stages.
#1 on client TCP connection,
#2 after TLS clientHello is received (using the config cert)
#3 after TLS serverHello is received (using a mimic cert)

As the cache.log indicates. The above casues 'bump' action to begin at
#1. The bump handshake is getting the clientHello details, so it can do
something but the Squid configured cert is used since there is no server
details available to generate anything from.

To do bumping with server certificate mimic you need the 'bump' action
to occur at #3.

Like:
 acl step1 at_step SslBump1
 acl step2 at_step SslBump2
 ssl_bump peek step1
 ssl_bump stare step2
 ssl_bump bump all

(or maybe stare and both non-3 steps. I'm not 100% certain there.).

...
&gt;<i> debug_options ALL,9
</I>&gt;<i> 
</I>

ALL,9 is only needed if you have to trace exact I/O bytes for debugging.
Almost all useful info about transaction processing is logged at levels
1-6 if you are just interested in what its doing.


&gt;<i> # ls -lR /usr/local/squid/var/lib/
</I>&gt;<i> total 4
</I>&gt;<i> drwxr-xr-x  3 squid  wheel  512 Jul 23 18:38 ssl_db
</I>&gt;<i> 
</I>&gt;<i> /usr/local/squid/var/lib/ssl_db:
</I>&gt;<i> total 8
</I>&gt;<i> drwxr-xr-x  2 squid  wheel  512 Jul 23 18:38 certs
</I>&gt;<i> -rw-r--r--  1 squid  wheel    0 Jul 23 18:38 index.txt
</I>&gt;<i> -rw-r--r--  1 squid  wheel    1 Jul 23 18:38 size
</I>&gt;<i> 
</I>
'r' permission for 'other' is usually not good, 640 permissions are
recommended even though these are fake certs in here. But YMMV.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011753.html">[squid-users] SSLBump just not working
</A></li>
	<LI>Next message (by thread): <A HREF="011771.html">[squid-users] SSLBump just not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11762">[ date ]</a>
              <a href="thread.html#11762">[ thread ]</a>
              <a href="subject.html#11762">[ subject ]</a>
              <a href="author.html#11762">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
