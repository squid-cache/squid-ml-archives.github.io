<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] different results every time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20different%20results%20every%20time&In-Reply-To=%3C80528f60-813e-b6c6-8042-cb86eb03a911%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011758.html">
   <LINK REL="Next"  HREF="011756.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] different results every time</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20different%20results%20every%20time&In-Reply-To=%3C80528f60-813e-b6c6-8042-cb86eb03a911%40treenet.co.nz%3E"
       TITLE="[squid-users] different results every time">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug  3 04:37:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011758.html">[squid-users] different results every time
</A></li>
        <LI>Next message (by thread): <A HREF="011756.html">[squid-users] Recommended Multi-CPU Configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11764">[ date ]</a>
              <a href="thread.html#11764">[ thread ]</a>
              <a href="subject.html#11764">[ subject ]</a>
              <a href="author.html#11764">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/08/2016 2:06 p.m., Sam M wrote:
&gt;<i> Reading through the documentation of Collapsed Forwarding feature I don't
</I>&gt;<i> know if this feature would help as the problem to what I'm feeling is the
</I>&gt;<i> squid eviction process and decision. It looks like squid is storing more
</I>&gt;<i> what is being set in the cache_dir and not evicting the least recently used
</I>&gt;<i> files at the right time because of the heavy request load.
</I>
A lot is going on. More on that below.

Also, there is no mistakes possible about the too-early eviction.
Because the &quot;right time&quot; is exactly when something else needs to use
that piece of cache space.  Under heavy traffic the time-based eviction
of data almost never happens, everything cycles out due to load pressure
far earlier thanit would naturalliy expire.  The rare pieces of data
that manage to reach their stale timeout are evicted *later* than that
staleness point.

&gt;<i> 
</I>&gt;<i> Does that make sense, or is there other explanation to the issue I'm having?
</I>
Yes. CF is for overlapping requests from the client. It is one of the
things that may be going on. But not by default.


&gt;<i> On Tue, Aug 2, 2016 at 9:51 PM, Sam M wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Hi Eliezer,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for your prompt reply. We are testing our squid configuration
</I>&gt;&gt;<i> before we use it. That said, all objects are 1 MB in size and in order to
</I>&gt;&gt;<i> test squid we queried a sequence of files multiple times in a manner that
</I>&gt;&gt;<i> theoretically at the end of the querying process we should get the same
</I>&gt;&gt;<i> number of hits from cache1, cache2, cache3, and cache4.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Structure of test network is: User (using a script) -&gt; cache1 -&gt; cache2 -&gt;
</I>&gt;&gt;<i> cache3 -&gt; cache4 -&gt; web server (stores the queried files).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm gonna try the Collapsed Forwarding feature and will post back if this
</I>&gt;&gt;<i> fixes the issue.
</I>&gt;&gt;<i>
</I>
&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *From:* Sam M
</I>&gt;&gt;&gt;<i> *Sent:* Tuesday, August 2, 2016 8:43 AM
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm querying lots of files through 4 cache servers connected through
</I>&gt;&gt;&gt;<i> parent hierarchy. I clean all the caches before I start and then I query
</I>&gt;&gt;&gt;<i> the files again in the same exact order. Weirdly, every time I check the
</I>&gt;&gt;&gt;<i> logs, I see a different cache served a file compared with the previous
</I>&gt;&gt;&gt;<i> test. The query process is done through a python script that uses wget
</I>&gt;&gt;&gt;<i> through a proxy to the cache, hence the query process is really fast.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Interestingly, if I put a delay of 1 second between each query, the
</I>&gt;&gt;&gt;<i> result will be stable and same every time I run the script.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Following a snippet from the config file after changing it too many times
</I>&gt;&gt;&gt;<i> to make it re-produce the same results yet, that didn't help:
</I>&gt;&gt;&gt;<i> cache_dir ufs /var/spool/squid 9 16 256
</I>&gt;&gt;&gt;<i> cache_mem 0 MB
</I>&gt;&gt;&gt;<i> memory_pools off
</I>&gt;&gt;&gt;<i> cache_swap_low 100
</I>&gt;&gt;&gt;<i> cache_swap_high 100
</I>&gt;&gt;&gt;<i> maximum_object_size_in_memory 0 KB
</I>&gt;&gt;&gt;<i> cache_replacement_policy lru
</I>&gt;&gt;&gt;<i> range_offset_limit 0
</I>&gt;&gt;&gt;<i> quick_abort_min 0 KB
</I>&gt;&gt;&gt;<i> quick_abort_max 0 KB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can someone shed some light on the issue and how to fix it please?
</I>&gt;&gt;&gt;<i>
</I>
TL;DR: Does not sound like a problem to me. That behaviour is how HTTP
works.


HTTP is stateless by design. Each request is evaluated at each proxy
independently.

The network itself is dynamic, in timing and known-state. When you are
dealing with things on the nanosecond scale details as low down as ARP
cache and maybe lower, affect the RTT and thus the timing data Squid
stores about its peers and reachable servers. The HTTP object cache is
just one amongst many type of caches having effects - both inside and
outside Squid.

At longer timescales. DNS results can be differently ordered, or
rotating per-lookup, or plain different (but 'static') content per
lookup source.

Even the server memory access speed plays a part. By delaying traffic
(or not) by some nanoseconds during the cache index lookup.

There is also the absolute UTC timestamp of the request reaching the
origin server versus the Expires/Cache-Control/Age/Date headers it
produces. Which are also affected by all sorts of things internal to the
origin itself. The delta values of these timestamps relative to the
cache abolute UTC timestamp on recieving the response - is dynamic and
the amount of that dynamic increases the smaller the timescale one looks
at (ie faster he traffic).

[probably more there I've missed].


All those little details affect in some ways the choice to determine any
given request destination or whether it is served from cache. And that
determination is made independently by each of the proxies in the
traffic chain at the timepoint where each separate request passes
through it.

So with 4x caches in your chain all these tiny details are compounded 4x
times on each request. Of course its going to fluctuate. Even in
isolated test traffic.


HTTP has a 1sec resolution on caching calculations for good reason. And
even that is not enough to average out the entire affect when you
compount the clock variance with multiple layers of proxy.

Unless you wait multiples of whole seconds between each test request you
will be guaranteed to see at least some variance in the HIT vs MISS
behaviour. Even waiting you might see variation between which particular
cache was a HIT.


PS. Squid is only about 90% compliant with the HTTP/1.1 requirements. So
there are some known bugs in the caching logics that your testing may
encounter as well. Though at least bugs are &quot;stable&quot; in their behaviour
for a given proxy build.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011758.html">[squid-users] different results every time
</A></li>
	<LI>Next message (by thread): <A HREF="011756.html">[squid-users] Recommended Multi-CPU Configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11764">[ date ]</a>
              <a href="thread.html#11764">[ thread ]</a>
              <a href="subject.html#11764">[ subject ]</a>
              <a href="author.html#11764">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
