<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSLBump just not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%20just%20not%20working&In-Reply-To=%3CCABs_asmxA5cbCH6gYbXxn%3DnqRG3PzxNKMe7rHdTovgdU0pgfPw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011771.html">
   <LINK REL="Next"  HREF="011801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSLBump just not working</H1>
    <B>JR Dalrymple</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%20just%20not%20working&In-Reply-To=%3CCABs_asmxA5cbCH6gYbXxn%3DnqRG3PzxNKMe7rHdTovgdU0pgfPw%40mail.gmail.com%3E"
       TITLE="[squid-users] SSLBump just not working">jr at jrssite.com
       </A><BR>
    <I>Thu Aug  4 02:45:56 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011771.html">[squid-users] SSLBump just not working
</A></li>
        <LI>Next message (by thread): <A HREF="011801.html">[squid-users] SSLBump just not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11783">[ date ]</a>
              <a href="thread.html#11783">[ thread ]</a>
              <a href="subject.html#11783">[ subject ]</a>
              <a href="author.html#11783">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Aug 3, 2016 at 9:14 AM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 08/02/2016 09:53 PM, Amos Jeffries wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; To do bumping with server certificate mimic you need the 'bump' action
</I>&gt;<i> &gt; to occur at #3.
</I>&gt;<i>
</I>
Thanks for the clarification. I probably read that 100 times in the
documentation but it didn't really sink in until today how that all works.
To be brutally honest the whole concept is still a bit lost on me, but I
can make sense that you have to perform the SNI CONNECT bits before you can
actually bump. My apologies for the earlier misunderstanding...


&gt;<i> &gt;
</I>&gt;<i> &gt; Like:
</I>&gt;<i> &gt;  acl step1 at_step SslBump1
</I>&gt;<i> &gt;  acl step2 at_step SslBump2
</I>&gt;<i> &gt;  ssl_bump peek step1
</I>&gt;<i> &gt;  ssl_bump stare step2
</I>&gt;<i> &gt;  ssl_bump bump all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; (or maybe stare and both non-3 steps. I'm not 100% certain there.).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes, all of the above can be polished and simplified to become just two
</I>&gt;<i> lines:
</I>&gt;<i>
</I>&gt;<i>   ssl_bump stare all
</I>&gt;<i>   ssl_bump bump all
</I>&gt;<i>
</I>
I'm still having issues I'm afraid - albeit different issues. My problem
now reads a lot like this guys issue:

<A HREF="https://www.mail-archive.com/misc@openbsd.org/msg144692.html">https://www.mail-archive.com/misc@openbsd.org/msg144692.html</A>

I did however perform the step he did to rectify his issue and it's not
having any effect for me I'm afraid. My browser just times out and no
auto-generated certificate is ever generated. I've combed through a number
of configurations on the Internet at this point and I'm not seeing how mine
is terribly different from anyone else's who is having success. For the
sake of completeness I'll post my configuration as it stands today:

 # grep -v ^[\s]*$ /usr/local/squid/etc/squid.conf | grep -v ^#
acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
ssl_bump stare all
ssl_bump bump all
http_access deny all
http_port 3128 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=/usr/local/squid/etc/ssl/gzgtgCA.pem
cache_dir ufs /var/cache/squid 4000 16 256
coredump_dir /var/cache/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER
sslproxy_cert_sign signTrusted
cache_effective_user squid
cache_effective_group squid
access_log daemon:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s
/usr/local/squid/var/lib/ssl_db -M 4MB
sslcrtd_children 10


I've tried various different combinations of ssl_bump directives including
adding the step_1 and step_2 ACLs as suggested by Amos (verbatim), and
additionally (again verbatim) the configuration outlined on the
squid-cache.org site, but at this point the only behavior I'm getting out
of the system is that which I've described. I have also tried both peeking
and staring, as I understand the use case for my environment stare would be
most appropriate, however neither seem to be working for me at this point
so it's moot. I've turned off the debugging as I wasn't getting anything
terribly useful out of it. I could see CONNECTs to the https sites, and
mentions that they qualified for stare or bump, but never did it seem to
actually happen. If anyone has anything that I should grep for in debug
logs to maybe help I'd be happy to oblige. Perhaps I should just abandon
OpenBSD and move to a more common flavor of *nix - although I will miss PF.

Thanks for the help.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160804/a2577649/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160804/a2577649/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011771.html">[squid-users] SSLBump just not working
</A></li>
	<LI>Next message (by thread): <A HREF="011801.html">[squid-users] SSLBump just not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11783">[ date ]</a>
              <a href="thread.html#11783">[ thread ]</a>
              <a href="subject.html#11783">[ subject ]</a>
              <a href="author.html#11783">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
