<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid performance not able to drive a 1Gbps internet link
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20performance%20not%20able%20to%20drive%20a%201Gbps%0A%20internet%20link&In-Reply-To=%3CCAARxGtjOe5-bp%3DD2Tpb-BU5KVq0fPuuY%3DhE5YRn_jK2Q6MQtnw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011785.html">
   <LINK REL="Next"  HREF="011806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid performance not able to drive a 1Gbps internet link</H1>
    <B>brendan kearney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20performance%20not%20able%20to%20drive%20a%201Gbps%0A%20internet%20link&In-Reply-To=%3CCAARxGtjOe5-bp%3DD2Tpb-BU5KVq0fPuuY%3DhE5YRn_jK2Q6MQtnw%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid performance not able to drive a 1Gbps internet link">bpk678 at gmail.com
       </A><BR>
    <I>Thu Aug  4 11:55:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011785.html">[squid-users] Squid performance not able to drive a 1Gbps internet link
</A></li>
        <LI>Next message (by thread): <A HREF="011806.html">[squid-users] Squid performance not able to drive a 1Gbps internet link
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11796">[ date ]</a>
              <a href="thread.html#11796">[ thread ]</a>
              <a href="subject.html#11796">[ subject ]</a>
              <a href="author.html#11796">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At what point does buffer bloat set in?  I have a linux router with the
below sysctl tweaks load balancing with haproxy to 2 squid instances.  I
have 4 x 1Gb interfaces bonded and have bumped the ring buffers on RX and
TX to 1024 on all interfaces.

The squid servers run with almost the same hardware and tweaks, except the
ring buffers have only been bumped to 512.

DSL Reports has a speed test page that supposedly finds and quantifies
buffer bloat and my setup does not introduce it, per their tests.

I am only running a home internet connection (50 down x 15 up) but have a
wonderful browsing experience.  I imagine scale of bandwidth might be a
factor, but have no idea where buffer bloat begins to set in.

# Favor low latency over high bandwidth
net.ipv4.tcp_low_latency = 1

# Use the full range of ports.
net.ipv4.ip_local_port_range = 1025 65535

# Maximum number of open files per process; default 1048576
#fs.nr_open = 10000000

# Increase system file descriptor limit; default 402289
fs.file-max = 100000

# Maximum number of requests queued to a listen socket; default 128
net.core.somaxconn = 1024

# Maximum number of packets backlogged in the kernel; default 1000
#net.core.netdev_max_backlog = 2000
net.core.netdev_max_backlog = 4096

# Maximum number of outstanding syn requests allowed; default 128
#net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_max_syn_backlog = 16284

# Discourage Linux from swapping idle processes to disk (default = 60)
#vm.swappiness = 10

# Increase Linux autotuning TCP buffer limits
# Set max to 16MB for 1GE and 32M (33554432) or 54M (56623104) for 10GE
# Don't set tcp_mem itself! Let the kernel scale it based on RAM.
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.core.optmem_max = 40960
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Increase Linux autotuning UDP buffer limits
net.ipv4.udp_mem = 4096 87380 16777216

# Make room for more TIME_WAIT sockets due to more clients,
# and allow them to be reused if we run out of sockets
# Also increase the max packet backlog
net.core.netdev_max_backlog = 50000
net.ipv4.tcp_max_syn_backlog = 30000
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 10

# Disable TCP slow start on idle connections
net.ipv4.tcp_slow_start_after_idle = 0

On Aug 4, 2016 2:17 AM, &quot;Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 4/08/2016 2:32 a.m., Heiler Bemerguy wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think it doesn't really matter how much squid sets its default buffer.
</I>&gt;<i> &gt; The linux kernel will upscale to the maximum set by the third option.
</I>&gt;<i> &gt; (and the TCP Window Size will follow that)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; net.ipv4.tcp_wmem = 1024 32768 8388608
</I>&gt;<i> &gt; net.ipv4.tcp_rmem = 1024 32768 8388608
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Having large system buffers like that just leads to buffer bloat
</I>&gt;<i> problems. Squid is still the bottleneck if it is sending only 4KB each
</I>&gt;<i> I/O cycle to the client - no matter how much is already received by
</I>&gt;<i> Squid, or stuck in kernel queues waiting to arrive to Squid. The more
</I>&gt;<i> heavily loaded the proxy is the longer each I/O cycle gets as all
</I>&gt;<i> clients get one slice of the cycle to do whatever processing they need
</I>&gt;<i> done.
</I>&gt;<i>
</I>&gt;<i> The buffers limited by HTTP_REQBUF_SZ are not dynamic so its not just a
</I>&gt;<i> minimum. Nathan found a 300% speed increase from a 3x buffer size
</I>&gt;<i> increase. Which is barely noticable (but still present) on small
</I>&gt;<i> responses, but very noticable with large transactions.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160804/b7e0c140/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160804/b7e0c140/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011785.html">[squid-users] Squid performance not able to drive a 1Gbps internet link
</A></li>
	<LI>Next message (by thread): <A HREF="011806.html">[squid-users] Squid performance not able to drive a 1Gbps internet link
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11796">[ date ]</a>
              <a href="thread.html#11796">[ thread ]</a>
              <a href="subject.html#11796">[ subject ]</a>
              <a href="author.html#11796">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
