<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Range header is a hit ratio killer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Range%20header%20is%20a%20hit%20ratio%20killer&In-Reply-To=%3C5bf69bb8-8864-a4bf-abf1-003c5f3d7c3b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011850.html">
   <LINK REL="Next"  HREF="011817.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Range header is a hit ratio killer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Range%20header%20is%20a%20hit%20ratio%20killer&In-Reply-To=%3C5bf69bb8-8864-a4bf-abf1-003c5f3d7c3b%40treenet.co.nz%3E"
       TITLE="[squid-users] Range header is a hit ratio killer">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Aug  7 14:12:49 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011850.html">[squid-users] Range header is a hit ratio killer
</A></li>
        <LI>Next message (by thread): <A HREF="011817.html">[squid-users] Range header is a hit ratio killer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11815">[ date ]</a>
              <a href="thread.html#11815">[ thread ]</a>
              <a href="subject.html#11815">[ subject ]</a>
              <a href="author.html#11815">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/08/2016 9:56 p.m., k simon wrote:
&gt;<i> Hi,list,
</I>&gt;<i>   Code 206 is the most pain for our forwed proxy. Squid use
</I>&gt;<i> &#8220;range_offset_limit&#8221; to process byte-range request. when set it &quot;none&quot;,
</I>&gt;<i> it has 2 wellknown issue:
</I>&gt;<i> 1.  boost the traffic on the server side, we observed it's amplified
</I>&gt;<i> 500% compared to clients side on our box.
</I>
To which the answer currently is to see if enabling collapsed_forwarding
works okay for your needs.

&gt;<i> 2.  it's always failed on a lossy link, and squid refetched it again and
</I>&gt;<i> again.
</I>&gt;<i>   I've noticed that nginx have supported &quot;byte-range cacheing&quot; since
</I>&gt;<i> 1.9.8  by Module ngx_http_slice_module officially.
</I>&gt;<i> (1.
</I>&gt;<i> <A HREF="http://nginx.org/en/docs/http/ngx_http_slice_module.html?_ga=1.140845234.106894549.1470474534">http://nginx.org/en/docs/http/ngx_http_slice_module.html?_ga=1.140845234.106894549.1470474534</A>
</I>&gt;<i> 
</I>
So? what relevance does other software features have to Squid behaviour?

 &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>&gt;

... to be fair the storage code in Squid is a bit hairy in places. So
paying for it to be done is unlikely to be cheap. But still, waiting
wont fix the problem. We nearly go there in Squid-2.7, but the
experiment there is not able to completely port across to Squid-3 and
had some important problems anyway.


&gt;<i> 2. <A HREF="https://www.nginx.com/resources/admin-guide/content-caching/">https://www.nginx.com/resources/admin-guide/content-caching/</A>  ).
</I>&gt;<i>   The solution is not perfect, but it's really more usable than
</I>&gt;<i> &quot;range_offset_limit&quot;. The secret it's use a fixed size object replaced
</I>&gt;<i> the whole file, and we can alter the request range offset and passed it
</I>&gt;<i> to server;
</I>
Ah, thats what range_offset_limit does today. Updates the server request
to say &quot;deliver all of it&quot; and stores the response in a file the size of
the whole expected response the server informs will be arriving.

The reason you are seeing that 500% increase in bandwidth is that
multiple Range requests arrive while the initial part of the first
response is still arriving back to Squid, so 5 of them get sent through
to the server. When that first one finishes, its object becomes
available for use as a HIT and followup Range requests get bits of it
(so you dont see 600% -&gt; millions of % bandwidth increase).

collapsed_fowarding alters this by letting the first response be used by
other requests while it is still incomplete. But YMMV regarding the
savings and CF affects all traffic, so it may cause behaviours you dont
want on other types of request. Worth a try though.


&gt;<i> perhaps forward the origin range offset and cache a part of
</I>&gt;<i> the object with a range key is a better idea.
</I>&gt;<i> And squid should know how
</I>&gt;<i> to make up those object and process the request with range header.
</I>&gt;<i>   And with a fixed size object to cache it may benefits to disk IO.
</I>&gt;<i> Sounds it's similar like big-rock db concept, though I've not got
</I>&gt;<i> successed with rock on FreeBSD nor ubuntu box.
</I>&gt;<i>   Does squid has some plan to support this method or have another solution?
</I>&gt;<i> 
</I>
squid is software. It doesn't have its own plans (at least I hope not).

I'm not aware of any plans specifically to add Range caching any time
soon. Ideas for how to do it get thrown around in squid-dev a couple of
times a year, so lots of ideas but so far nothing concrete has come out
of it. Yes rock and/or memory caches are looking like the most easily
adapted cache types to enable storing partial objects in, someone still
has to do the actual coding work though.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011850.html">[squid-users] Range header is a hit ratio killer
</A></li>
	<LI>Next message (by thread): <A HREF="011817.html">[squid-users] Range header is a hit ratio killer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11815">[ date ]</a>
              <a href="thread.html#11815">[ thread ]</a>
              <a href="subject.html#11815">[ subject ]</a>
              <a href="author.html#11815">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
