<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Large memory leak with ssl_peek (now partly	understood)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Large%20memory%20leak%20with%20ssl_peek%20%28now%20partly%0A%09understood%29&In-Reply-To=%3C6ebc07c2-c8e7-13f1-8c9f-cd00ab812339%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011880.html">
   <LINK REL="Next"  HREF="011873.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Large memory leak with ssl_peek (now partly	understood)</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Large%20memory%20leak%20with%20ssl_peek%20%28now%20partly%0A%09understood%29&In-Reply-To=%3C6ebc07c2-c8e7-13f1-8c9f-cd00ab812339%40opendium.com%3E"
       TITLE="[squid-users] Large memory leak with ssl_peek (now partly	understood)">steve at opendium.com
       </A><BR>
    <I>Thu Aug 11 16:56:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011880.html">[squid-users] large downloads got interrupted
</A></li>
        <LI>Next message (by thread): <A HREF="011873.html">[squid-users] Large memory leak with ssl_peek (now partly understood)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11863">[ date ]</a>
              <a href="thread.html#11863">[ thread ]</a>
              <a href="subject.html#11863">[ subject ]</a>
              <a href="author.html#11863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I've been suffering from a significant memory leak on multiple servers 
running Squid 3.5 for months, but was unable to reproduce it in a test 
environment.  I've now figured out how to reproduce it and have done 
some investigation:

When using TPROXY, Squid generates fake &quot;CONNECT 192.0.2.1:443&quot; 
requests, using the IP address that the client connected to.  At 
ssl_bump step 1, we peek and Squid generates another fake &quot;CONNECT 
example.com:443&quot; request containing the SNI from the client's SSL handshake.

At ssl_bump step 2 we splice the connection and Squid does verification 
to make sure that example.com does actually resolve to 192.0.2.1.  If it 
doesn't, Squid is supposed to reject the connection in 
ClientRequestContext::hostHeaderVerifyFailed() to prevent clients from 
manipulating the SNI to bypass ACLs.

Unfortunately, when verification fails, rather than actually dropping 
the client's connection, Squid just leaves the client hanging. 
Eventually the client (hopefully) times out and drops the connection 
itself, but the associated ClientRequestContext is never destroyed.

This is testable by repeatedly executing:
openssl s_client -connect 17.252.76.30:443 -servername 
courier.push.apple.com

That is a traffic pattern that we see in the real world and is now 
clearly what is triggering the leak: Apple devices make connections to 
addresses within the 17.0.0.0/8 network with an SNI of 
&quot;courier.push.apple.com&quot;.  courier.push.apple.com resolves to a CNAME 
pointing to courier-push-apple.com.akadns.net, but 
courier-push-apple.com.akadns.net doesn't exist.  Since Squid can't 
verify the connection, it won't allow it and after 30 seconds the client 
times out.  Each Apple device keeps retrying the connection, leaking a 
ClientRequestContext each time, and before long we've leaked several 
gigabytes of memory (on some networks I'm seeing 16GB or more of leaked 
RAM over 24 hours!).

Unfortunately I'm a bit lost in the Squid code and can't quite figure 
out how to gracefully terminate the connection and destroy the context.

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Sales / enquiries:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011880.html">[squid-users] large downloads got interrupted
</A></li>
	<LI>Next message (by thread): <A HREF="011873.html">[squid-users] Large memory leak with ssl_peek (now partly understood)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11863">[ date ]</a>
              <a href="thread.html#11863">[ thread ]</a>
              <a href="subject.html#11863">[ subject ]</a>
              <a href="author.html#11863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
