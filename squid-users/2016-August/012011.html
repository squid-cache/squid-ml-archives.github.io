<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Malformed HTTP on tproxy squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Malformed%20HTTP%20on%20tproxy%20squid&In-Reply-To=%3C47d89333-8d24-ae94-66dd-d04bc9dfcd63%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011992.html">
   <LINK REL="Next"  HREF="012014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Malformed HTTP on tproxy squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Malformed%20HTTP%20on%20tproxy%20squid&In-Reply-To=%3C47d89333-8d24-ae94-66dd-d04bc9dfcd63%40treenet.co.nz%3E"
       TITLE="[squid-users] Malformed HTTP on tproxy squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 17 15:02:04 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011992.html">[squid-users] Malformed HTTP on tproxy squid
</A></li>
        <LI>Next message (by thread): <A HREF="012014.html">[squid-users] Malformed HTTP on tproxy squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12011">[ date ]</a>
              <a href="thread.html#12011">[ thread ]</a>
              <a href="subject.html#12011">[ subject ]</a>
              <a href="author.html#12011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/08/2016 9:26 p.m., Omid Kosari wrote:
&gt;<i> Hi Eliezer,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Eliezer Croitoru-2 wrote
</I>&gt;&gt;<i> If you know what domain or ip address causes and issue the first thing I
</I>&gt;&gt;<i> can think about is bypassing the malicious traffic to allow other
</I>&gt;&gt;<i> clients\users to reach the Internet.
</I>&gt;<i> 
</I>&gt;<i> Source ip may be 70% of our customers because it is a popular device so it
</I>&gt;<i> is not an option . Destination ip or domains are too much . 
</I>&gt;<i> 
</I>&gt;<i> Unfortunately because the requests are not normal http , so squid log does
</I>&gt;<i> not have the dst url/domain/ip so it is hard job to find them .
</I>&gt;<i> 1- First i should keep looking the squid access.log to find client which has
</I>&gt;<i> such request . 
</I>&gt;<i> 2-Then try to sniff that client from router. 
</I>&gt;<i> 3-Separate normal requests from malformed . 
</I>&gt;<i> 4-Find the destination from malformed requests.
</I>&gt;<i> 5-Put that ip in router acl to exclude from tproxy routing to squid .
</I>&gt;<i> 
</I>&gt;<i> Nobody knows how many times this loop should be repeated because nobody
</I>&gt;<i> knows count of destinations .
</I>&gt;<i> 
</I>
Easier way:

 logformat Xips %ts.%03tu %6tr %&gt;a %&gt;la %&gt;ru
 access_log stdio:/var/log/squid/xact.log Xips

Then just grep the xact.log file for the &quot;error:invalid-request&quot; URLs,
and see what the '&gt;la' column IP address is.

If you want to automate it make a logging daemon script.

&gt;<i> 
</I>&gt;<i> Eliezer Croitoru-2 wrote
</I>&gt;&gt;<i> And since squid is also being used as a http ACL enforcement tool
</I>&gt;&gt;<i> malformed requests basically should be dropped and not bypassed
</I>&gt;&gt;<i> automatically.
</I>&gt;<i> 
</I>&gt;<i> So then squid should be able to simply drop them.
</I>&gt;<i> Even it would be fine to have some patterns in iptables or something like
</I>&gt;<i> mod_security for apache etc which introduce by squid gurus to prevent these
</I>&gt;<i> kinds of problems .
</I>

Your Squid is not even getting far enough to apply security rules to the
garbage traffic. It is basically just doing: accept() connection,
unmangle the NAT/TPROXY details, read(2) some bytes, try to parse - bam
generate and send error page, close the TCP connection and log the event.


About the only thing you could do to speed it up is locate the error
page templates (file paths: en/ERR_INVALID_REQ and
templates/ERR_INVALID_REQ) and remove their contents. Then restart Squid.
That should remove at least a few of the vprintf() syscalls that your
earlier trace showed as being a significant source of CPU load.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011992.html">[squid-users] Malformed HTTP on tproxy squid
</A></li>
	<LI>Next message (by thread): <A HREF="012014.html">[squid-users] Malformed HTTP on tproxy squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12011">[ date ]</a>
              <a href="thread.html#12011">[ thread ]</a>
              <a href="subject.html#12011">[ subject ]</a>
              <a href="author.html#12011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
