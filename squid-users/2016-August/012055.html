<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems with Squid Authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20Squid%20Authentication&In-Reply-To=%3Cvmime.57b6d942.77ba.4578e4ce3f59062%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012051.html">
   <LINK REL="Next"  HREF="012073.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems with Squid Authentication</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20Squid%20Authentication&In-Reply-To=%3Cvmime.57b6d942.77ba.4578e4ce3f59062%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Problems with Squid Authentication">belle at bazuin.nl
       </A><BR>
    <I>Fri Aug 19 10:02:42 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012051.html">[squid-users] Problems with Squid Authentication
</A></li>
        <LI>Next message (by thread): <A HREF="012073.html">[squid-users] Problems with Squid Authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12055">[ date ]</a>
              <a href="thread.html#12055">[ thread ]</a>
              <a href="subject.html#12055">[ subject ]</a>
              <a href="author.html#12055">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai,

&#160;

Yes, all new things are hard..

I need some extra info because there are lots of things that can be wrong. 

&#160;

post what you see here : 

/usr/lib/squid/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy.empresa.com.br at EMPRESA.COM.BR</A> ?d ?i 

&#160;

&#160;

&gt;&gt;<i> kinit and klist are ok
</I>
&gt;&gt;<i> /etc/krb5.keytab and /etc/squid3/HTTP.keytab (both are identical)
</I>
These are normaly not identical. In the HTTPkeytab i have ONLY the HTTP spn. 

And in the krb5.keytab i&#160; have the host SPN and netbios_name($)&#160; 

&#160;

How to test the kerberos auth.. hmm, thats a difficult one for me. 

I know lot but not all..&#160; :-(&#160; .

&#160;

But what i do iknow, you can test with

/usr/lib/squid/negotiate_kerberos_auth -s GSS_C_NO_NAME 

If that works its probely an SPN or dns problem.

If that isnt working, then do check the time on the ad server and proxy server.

&#160;

I can only say. 

The proxy servername must exist in dns and must have A and PTR record. &#160;( add this in the samba AD ) 

The reverse zone is ( maybe ) created, if not, create it yourself and add the ptr records. 

&#160;

Cat /etc/hosts file may NOT contain any. 

127.0.1.1&#160;&#160;&#160;&#160;&#160;&#160;&#160; yourhostname.. ..&#160; 

if its in there, you installed with dhcp ip. 

&#160;

It should contain 

127.0.0.1&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; localhost 

IP_OF_SERVER&#160;&#160; hostname.domain.tld hostname

The is there if you install with a static ip. 

&#160;

Time must be in sync with the AD server ( max difference i allow is 1 min. ) 

If needed install ntp on the proxy and point the server &#160;to the ad dc. 

&#160;

And post what you now have in krb5.conf 

&#160;

These are the most common pitfalls, i?ll see what i can do to help out. 

&#160;

&#160;

Greetz, 

&#160;

Louis

&#160;

&#160;

&#160;

&#160;

&#160;


Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Marcio Demetrio Bacci
Verzonden: vrijdag 19 augustus 2016 3:50
Aan: Squid Users
Onderwerp: [squid-users] Problems with Squid Authentication


&#160;

My Kerberos Authentication doesn't work. This is very hard!


&#160;


My Squid3 is join in the Domain


kinit and klist are ok


wbinfo -g and wbinfo -u are ok too.


&#160;


I have created the squid3 file in /etc/default with the following content:&#160;


KRB5_KTNAME=/etc/squid3/HTTP.keytab


export KRB5_KTNAME


&#160;


I have two keytab files:


/etc/krb5.keytab and /etc/squid3/HTTP.keytab (both are identical)


&#160;


I have installed libsasl2-modules-gssapi-mit libsasl2-modules packages because my Squid server is Debian 8. But I didn't use msktutil tool. I have only joined Squid server in the Domain (net ads join -U administrator)


&#160;


How can I debbug the problem?


How can I test kerberos authentication in terminal (command line)?


&#160;


Below is my squid.conf file:


&#160;


### Configuracoes Basicas


&#160;


cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">administrator at empresa.com.br</A>


&#160;


http_port 3128


&#160;


#debug_options ALL,111,2 29,9 84,6


&#160;


cache_mem 512 MB


cache_swap_low 80


cache_swap_high 90


&#160;


maximum_object_size 512 MB


minimum_object_size 0 KB


&#160;


maximum_object_size_in_memory 4096 KB


&#160;


cache_replacement_policy heap LFUDA


memory_replacement_policy heap LFUDA


&#160;


#Para n&#227;o bloquear downloads


quick_abort_min -1 KB


&#160;


&#160;


#Resolve um problema com conexoes persistentes


detect_broken_pconn on


&#160;


fqdncache_size 1024


&#160;


### Parametros de atualizacao da memoria cache


refresh_pattern ^ftp:&#160;&#160; 1440&#160;&#160; 20%&#160;&#160; 10080


refresh_pattern ^gopher:&#160;&#160; 1440&#160;&#160; 0%&#160;&#160; 1440


refresh_pattern -i (/cgi-bin/|\?) 0 0%&#160;&#160;&#160; 0


refresh_pattern .&#160;&#160;&#160;&#160;&#160; 0&#160;&#160; 20%&#160;&#160; 4320


&#160;


### Localizacao dos logs


access_log /var/log/squid3/access.log


cache_log /var/log/squid3/cache.log


&#160;


&#160;


### define a localizacao do cache de disco, tamanho, qtd de diretorios pai e subdiretorios


cache_dir aufs /var/spool/squid3 600 16 256


&#160;


auth_param negotiate program /usr/lib/squid3/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy.empresa.com.br at EMPRESA.COM.BR</A>


auth_param negotiate children 20


auth_param negotiate keep_alive on


&#160;


visible_hostname proxy.empresa.com.br


&#160;


### acls


#acl manager proto cache_object


acl localhost src MailScanner warning: numerical links are often malicious: 192.168.200.7/32


acl to_localhost dst MailScanner warning: numerical links are often malicious: 192.168.200.7/32


acl SSL_ports port 22 443 563 7071 10000 # ssh, https, snews, zimbra, webmin


acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160; # ftp


acl Safe_ports port 70&#160;&#160;&#160;&#160;&#160;&#160; # gopher


acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160; # http


acl Safe_ports port 88&#160;&#160;&#160;&#160;&#160;&#160; # kerberos


acl Safe_ports port 210&#160;&#160;&#160;&#160;&#160;&#160; # wais


acl Safe_ports port 280&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt


acl Safe_ports port 389&#160;&#160;&#160;&#160;&#160;&#160; # ldap


acl Safe_ports port 443&#160;&#160;&#160; # https


acl Safe_ports port 488&#160;&#160;&#160;&#160;&#160;&#160; # gss-http


acl Safe_ports port 563&#160;&#160;&#160;&#160;&#160;&#160; # snews


acl Safe_ports port 591&#160;&#160;&#160;&#160;&#160;&#160; # filemaker


acl Safe_ports port 777&#160;&#160;&#160;&#160;&#160;&#160; # multiling http


acl Safe_ports port 3001 &#160; &#160; &#160; &#160; # imprenssa nacional


acl Safe_ports port 8080&#160;&#160;&#160; # http


acl Safe_ports port 1025-65535&#160;&#160;&#160; # unregistered ports


&#160;


acl purge method PURGE


acl CONNECT method CONNECT


&#160;


&#160;


### Regras iniciais do Squid


http_access allow localhost


http_access allow purge localhost


http_access deny purge


http_access deny !Safe_ports


http_access deny CONNECT !SSL_ports


&#160;


### Exige autenticacao


acl autenticados proxy_auth REQUIRED


http_access allow autenticados


&#160;


&#160;


&#160;


### Rede do Local #####


acl rede_local src MailScanner warning: numerical links are often malicious: 192.168.200.0/22&#160;


&#160;


&#160;


### Nega acesso de quem nao esta na rede local


http_access allow rede_local&#160;


&#160;


#negando o acesso para todos que nao estiverem nas regras anteriores


http_access deny all


&#160;


### Erros em portugues


error_directory /usr/share/squid3/errors/pt-br


&#160;


#cache_effective_user proxy


coredump_dir /var/spool/squid3


&#160;


&#160;


Regards,


&#160;


M&#225;rcio




-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160819/381d99e8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160819/381d99e8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012051.html">[squid-users] Problems with Squid Authentication
</A></li>
	<LI>Next message (by thread): <A HREF="012073.html">[squid-users] Problems with Squid Authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12055">[ date ]</a>
              <a href="thread.html#12055">[ thread ]</a>
              <a href="subject.html#12055">[ subject ]</a>
              <a href="author.html#12055">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
