<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] dynamic group using URI as group name on external acl	with ext_ldap_group_acl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20dynamic%20group%20using%20URI%20as%20group%20name%20on%20external%20acl%0A%09with%20ext_ldap_group_acl&In-Reply-To=%3CCAD8MJvAEM-zmVAntSGqeJhqXECZjv%3DW%3DqhASS%3Df77w4DAx%2BttA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012091.html">
   <LINK REL="Next"  HREF="012095.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] dynamic group using URI as group name on external acl	with ext_ldap_group_acl</H1>
    <B>Diogenes S. Jesus</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20dynamic%20group%20using%20URI%20as%20group%20name%20on%20external%20acl%0A%09with%20ext_ldap_group_acl&In-Reply-To=%3CCAD8MJvAEM-zmVAntSGqeJhqXECZjv%3DW%3DqhASS%3Df77w4DAx%2BttA%40mail.gmail.com%3E"
       TITLE="[squid-users] dynamic group using URI as group name on external acl	with ext_ldap_group_acl">splash at gmail.com
       </A><BR>
    <I>Sun Aug 21 22:54:36 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012091.html">[squid-users] Viber + squid = no images
</A></li>
        <LI>Next message (by thread): <A HREF="012095.html">[squid-users] dynamic group using URI as group name on external acl with ext_ldap_group_acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12092">[ date ]</a>
              <a href="thread.html#12092">[ thread ]</a>
              <a href="subject.html#12092">[ subject ]</a>
              <a href="author.html#12092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone.

I've the following use case to be accomplished using ACL:

- Allow any authenticated user who is member of a group named after the URI

To construct this I've built the following squid.conf (snippet):

---------
auth_param negotiate program /usr/lib/squid3/negotiate_kerberos_auth -d -r
auth_param negotiate children 10
auth_param negotiate keep_alive on

external_acl_type ldap_HTTP %LOGIN %URI
/usr/lib/squid/ext_ldap_group_acl -D &quot;cn=admin,dc=example,dc=com&quot; -w
test -R -b &quot;ou=authorization,dc=example,dc=com&quot; -B
&quot;ou=people,dc=example,dc=com&quot; -f
'(&amp;(objectclass=groupOfNames)(cn=%g)(member=uid=%u,ou=people,dc=example,dc=com))'
-h ldap01.example.com -d

acl allow_HTTP_ACL external ldap_HTTP &quot;&quot;

http_access deny !allow_HTTP_ACL all
http_access allow allow_HTTP_ACL
http_access deny all
---------

I call it a &quot;dynamic&quot; acl, because the value of the group is the
actual URI (the search filter will expand like:
cn=&lt;URI&gt;,ou=authorization,dc=example,dc=com). For that
&quot;allow_HTTP_ACL&quot; passes &quot;&quot; to ldap_HTTP.

This is working, however that's not documented. I was wondering how
this works, so I debugged.

I found out the %&lt;template filter var&gt; expands as following for the
following search filter:
-f '(&amp;(objectclass=groupOfNames)(&lt;template_filter_reference&gt;=%&lt;template_filter&gt;)(member=uid=%u,ou=people,dc=example,dc=com))'

1) '(&amp;(objectclass=groupOfNames)(a=%a)(member=uid=%u,ou=people,dc=example,dc=com))':
ext_ldap_group_acl.cc(718): pid=25913 :group filter
'(&amp;(objectclass=groupOfNames)(a=<A HREF="http://web.example.com/">http://web.example.com/</A>)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=ou=authorization,dc=example,dc=com'
ext_ldap_group_acl.cc(718): pid=25913 :group filter
'(&amp;(objectclass=groupOfNames)(a=GET)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'
ext_ldap_group_acl.cc(718): pid=25913 :group filter
'(&amp;(objectclass=groupOfNames)(a=80)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'

2) '(&amp;(objectclass=groupOfNames)(b=%b)(member=uid=%u,ou=people,dc=example,dc=com))':
ext_ldap_group_acl.cc(579): pid=26068 :Connected OK
ERROR: Unknown filter template string %b
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(b=L?II??U&quot;, user=&quot;john_doe&quot;,
group=&quot;<A HREF="http://web.example.com/">http://web.example.com/</A>&quot;
ERROR: Unknown filter template string %b
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(b=L?II??U&quot;, user=&quot;john_doe&quot;,
group=&quot;GET&quot;
ERROR: Unknown filter template string %b
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(b=L?II??U&quot;, user=&quot;john_doe&quot;,
group=&quot;80&quot;

3) '(&amp;(objectclass=groupOfNames)(c=%c)(member=uid=%u,ou=people,dc=example,dc=com))':
ERROR: Unknown filter template string %c
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(c=?&#1662;&gt;?U&quot;, user=&quot;john_doe&quot;,
group=&quot;<A HREF="http://web.example.com/">http://web.example.com/</A>&quot;
ERROR: Unknown filter template string %c
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(c=?&#1662;&gt;?U&quot;, user=&quot;john_doe&quot;,
group=&quot;GET&quot;
ERROR: Unknown filter template string %c
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(c=?&#1662;&gt;?U&quot;, user=&quot;john_doe&quot;,
group=&quot;80&quot;

4) '(&amp;(objectclass=groupOfNames)(test=%test)(member=uid=%u,ou=people,dc=example,dc=com))':
ERROR: Unknown filter template string %t
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(test=?,?U&quot;, user=&quot;john_doe&quot;,
group=&quot;<A HREF="http://web.example.com/">http://web.example.com/</A>&quot;
ERROR: Unknown filter template string %t
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(test=?,?U&quot;, user=&quot;john_doe&quot;,
group=&quot;GET&quot;
ERROR: Unknown filter template string %t
ext_ldap_group_acl: ERROR: Failed to construct LDAP search filter.
filter=&quot;(&amp;(objectclass=groupOfNames)(test=?,?U&quot;, user=&quot;john_doe&quot;,
group=&quot;80&quot;

5) '(&amp;(objectclass=groupOfNames)(v=%v)(member=uid=%u,ou=people,dc=example,dc=com))':
ext_ldap_group_acl.cc(718): pid=26314 :group filter
'(&amp;(objectclass=groupOfNames)(v=john_doe)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'
ext_ldap_group_acl.cc(718): pid=26314 :group filter
'(&amp;(objectclass=groupOfNames)(v=john_doe)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'
ext_ldap_group_acl.cc(718): pid=26314 :group filter
'(&amp;(objectclass=groupOfNames)(v=john_doe)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'


6) '(&amp;(objectclass=groupOfNames)(g=%g)(member=uid=%u,ou=people,dc=example,dc=com))':
ext_ldap_group_acl.cc(718): pid=26408 :group filter
'(&amp;(objectclass=groupOfNames)(g=<A HREF="http://web.example.com/">http://web.example.com/</A>)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'
ext_ldap_group_acl.cc(718): pid=26408 :group filter
'(&amp;(objectclass=groupOfNames)(g=GET)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'
ext_ldap_group_acl.cc(718): pid=26408 :group filter
'(&amp;(objectclass=groupOfNames)(g=80)(member=uid=john_doe,ou=people,dc=example,dc=com))',
searchbase 'ou=authorization,dc=example,dc=com'

This is all pretty much happening here
[<A HREF="https://github.com/squid-cache/squid/blob/master/helpers/external_acl/LDAP_group/ext_ldap_group_acl.cc#L638">https://github.com/squid-cache/squid/blob/master/helpers/external_acl/LDAP_group/ext_ldap_group_acl.cc#L638</A>]

So conclusions:
- %v and %u both map to &quot;user&quot;, which is expected (historical reasons
&amp; compatibility)
- %g and %a both map to &quot;group&quot;, which is expected (historical reasons
&amp; compatibility)
- any other template filter (%b, %c, %test, etc) is trash (only %a,
%u, %g, %v won't yield error)
- when &quot;&quot; is passed to the acl (&quot;acl &lt;ACL_name&gt; external ldap_HTTP
&quot;&quot;), the helper will attempt all FORMAT values, mapping then to
&quot;group&quot; (%a or %g)


Although I can move on with this for now, I would be actually more
relieved if I could use:
acl allow_HTTP_ACL external ldap_HTTP
&lt;a_var_which_is_available_here_representing_URI&gt;
 instead of
acl allow_HTTP_ACL external ldap_HTTP &quot;&quot;  + non-documented behavior of
ext_ldap_group_acl

However I don't know that &lt;acl&gt; directive has access to the URI
variable. Tips anyone?

Best regards

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012091.html">[squid-users] Viber + squid = no images
</A></li>
	<LI>Next message (by thread): <A HREF="012095.html">[squid-users] dynamic group using URI as group name on external acl with ext_ldap_group_acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12092">[ date ]</a>
              <a href="thread.html#12092">[ thread ]</a>
              <a href="subject.html#12092">[ subject ]</a>
              <a href="author.html#12092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
