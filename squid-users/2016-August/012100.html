<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20clarifying%20Features/SslPeekAndSplice%20on%20wiki%20%2B%0A%20fake%20CONNECT&In-Reply-To=%3Cecafc136-b76f-48ed-d5e1-c7feb3a7ef69%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012085.html">
   <LINK REL="Next"  HREF="012104.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20clarifying%20Features/SslPeekAndSplice%20on%20wiki%20%2B%0A%20fake%20CONNECT&In-Reply-To=%3Cecafc136-b76f-48ed-d5e1-c7feb3a7ef69%40measurement-factory.com%3E"
       TITLE="[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Aug 22 19:20:51 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012085.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake	CONNECT
</A></li>
        <LI>Next message (by thread): <A HREF="012104.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12100">[ date ]</a>
              <a href="thread.html#12100">[ thread ]</a>
              <a href="subject.html#12100">[ subject ]</a>
              <a href="author.html#12100">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/21/2016 06:46 AM, Marcus Kool wrote:
&gt;<i> there are still some issues with the wiki page that I like to clarify.
</I>
Thanks a lot for working on this!


&gt;<i> wiki: <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i> 
</I>&gt;<i> section &quot;processing steps&quot;
</I>&gt;<i> 
</I>&gt;<i> Can action &quot;none&quot; be removed from step 1?
</I>
Done.


&gt;<i> Step 1.  what is &quot;CONNECT info&quot;?  In the introduction one speaks
</I>&gt;<i> of &quot;HTTP CONNECT&quot; which has a FQDN.  But the fake CONNECT sent to
</I>&gt;<i> a URL rewriter has only an IP address.
</I>
CONNECT info is the info associated with a CONNECT request, real or fake
(depending on the http*_port being used for the transaction). Real
CONNECT requests often have FQDNs. Fake CONNECT requests have IP
addresses during step1.


&gt;<i> Why is the fake CONNECT that is sent to the URL rewriter done
</I>&gt;<i> at step 1 where only the IP and not the FQDN is available?
</I>
... because some rewriters want/need those CONNECTs, for various
reasons. The overall design here is simple and logical in my biased
opinion: Send everything by default but let admin control what should be
sent. If _your_ rewriter does not need some CONNECTs, configure Squid
not to send those unwanted CONNECTS to the rewriter. If Squid lacks ACLs
to detect unwanted CONNECTs, add support for those missing ACLs.

The url_rewrite_access directive controls what transactions are sent to
the redirector.

Note that CONNECTs should be sent both during step1 and during step2 by
default.


&gt;<i> In section &quot;Peek at SNI and Bump&quot; it is stated that SNI is obtained in
</I>&gt;<i> step 1. This contradicts the text at step 1 and 2.
</I>
In section &quot;Peek at SNI and Bump&quot; it is NOT stated that SNI is obtained
in step 1. It is stated that SNI is obtained by peeking during step 1.
&quot;obtaining SNI&quot; and &quot;peeking&quot; are not the same! If, during step 1, you
tell Squid to peek, then, during step 2, Squid peeks and obtains SNI.

There is no contradiction, but we are definitely struggling with how to
describe what is going on. Specific improvement suggestions are very
welcomed.


&gt;<i> squid.conf.documented has this:
</I>&gt;<i> #  At each SslBump step, Squid evaluates ssl_bump directives to find
</I>&gt;<i> #  the *next* bumping action (e.g., peek or splice).
</I>&gt;<i> Emphasis on &quot;*next* bumping action&quot;.
</I>&gt;<i> Should the wiki be reworded and use &quot;next bumping action&quot;?
</I>
Please suggest complete specific fixes. We know that the current wiki
text is difficult to follow for many so the attempts to rework it are
welcomed.


&gt;<i> Section &quot;Actions&quot;
</I>&gt;<i> 
</I>&gt;<i> item peek: Receive client SNI (step1), or server certificate (step2)  ...
</I>&gt;<i> This contradicts the explanation of the processing steps.
</I>&gt;<i> item stare: likewise.
</I>
I do not think it does (see the &quot;peeking during step1 tells Squid to get
SNI during step2&quot; discussion above), but please suggest a better way to
phrase those descriptions. We know they are confusing. SNI (and
certificate parsing) happens at the beginning of stepN+1 but whether
that step happens at all depends on the stepN action.


&gt;<i> I suggest to remove the &quot;Deprecated actions&quot; or use a BOLD warning not
</I>&gt;<i> to use them.
</I>
I do not think we should remove them because comparing their description
with the currently supported actions may be very useful for upgrading
admins. Does not Squid already emit a deprecation WARNING when those
actions are used?

If you know how to gray-out the rows with deprecated actions, please do
that. Otherwise (or in addition to that), please feel free to add a
&quot;Avoid this deprecated, poorly supported, and soon to be deleted
action.&quot; or similar text to each deprecated action description.


&gt;<i> Section &quot;Mimicking SSL client Hello properties when staring&quot;
</I>&gt;<i> The section has &quot;The information in this section is incomplete and
</I>&gt;<i> somewhat stale.&quot;
</I>&gt;<i> Is there any information to update this section ?
</I>
Yes, but it is only Squid sources and possibly commit log :-(.


&gt;<i> section &quot;Examples&quot;
</I>&gt;<i> 
</I>&gt;<i> I usually write explicit rules like this:
</I>
&gt;<i> # do not touch servers where ssl-bump breaks HSTS
</I>&gt;<i> acl tls_allowed_hsts ...
</I>&gt;<i> # prevent bumping some allowed servers with self-signed certificates
</I>&gt;<i> acl tls_allowed_selfsigned ...
</I>...

I recommend against documenting ACLs as actions. Your tls_allowed_hsts
does not prevent touching anything. Your tls_allowed_selfsigned does not
prevent bumping of any connections. Etc. ACLs are conditions. They only
identify certain transactions. They do not touch/prevent/allow/block
anything. The rules that use those ACLs do all that.


&gt;<i> # TLS/SSL bumping steps
</I>&gt;<i> ssl_bump peek   tls_s1_ip_connect   all                 # peek a client connecting at IP level
</I>&gt;<i> ssl_bump splice tls_s2_client_hello tls_to_splice       # splice some: do not bump/interfere
</I>&gt;<i> ssl_bump stare  tls_s2_client_hello all                 # connect to the server and stare(peek) at its TLS/SSL properties
</I>&gt;<i> ssl_bump bump   tls_s3_server_hello all                 # bump if we can (tls_s2_client_hello/stare succeeded)
</I>

&gt;<i> The above rules follow the steps of the wiki page but
</I>&gt;<i> the examples on the wiki have optimised rules and sometimes
</I>&gt;<i> there are messages on the mailing list that rules can be optimized
</I>&gt;<i> to save CPU cycles.
</I>

It is not primarily about CPU optimization. It is about readability.

&gt;<i> The last 4 lines of the example can be optimized into
</I>
&gt;<i> ssl_bump peek   tls_s1_ip_connect   all
</I>&gt;<i> ssl_bump splice tls_s2_client_hello tls_to_splice
</I>&gt;<i> ssl_bump stare  all
</I>&gt;<i> ssl_bump bump   all
</I>
Actually, they should be written as:

  ssl_bump peek   tls_s1_ip_connect
  ssl_bump splice tls_to_splice
  ssl_bump stare  all
  ssl_bump bump   all


And, most likely (possibly after some ACL adjustments) can be further
clarified as:

  ssl_bump splice tls_to_splice
  ssl_bump stare  all
  ssl_bump bump   all

Which is a lot clearer for some, but not for others.


&gt;<i> I prefer not to optimize since reading the rules is
</I>&gt;<i> easier and one understands better what happens at each step.
</I>
It is a matter of taste.


&gt;<i> However, if a significant number of CPU cycles are saved, I suggest to
</I>&gt;<i> include an example like above and rules of thumb on how to optimize and the
</I>&gt;<i> final optimized results so that a less experienced reader understands
</I>&gt;<i> the optimizations.
</I>
Please do, but this is not about optimization. It is about describing
desired outcome in two different ways:

* If you want to be verbose and prefix every rule with the step it
applies to, then you can do that (at the elevated risk of forgetting to
tell Squid what to do in some cases among all the noise).

* If you want to express the essence of your configuration, you can do
that instead (at the risk of misinterpreting which step a rule will be
applied at, due to increased complexity).


There are only two &quot;noise reduction&quot; or &quot;condensing&quot; rules AFAICT:

1. Do not say &quot;large green all&quot;. Just say &quot;large green&quot;.
2. Splice and peek rules are ignored during step 3.



&gt;<i> The examples in &quot;Avoid bumping banking traffic&quot; :
</I>&gt;<i> I can image what used (but not defined) serverIsBank acl looks like:
</I>&gt;<i>    acl serverIsBank  ssl::server_name .santander.com
</I>&gt;<i> but have no idea what the acl haveServerName looks like.
</I>&gt;<i> What is intended here?
</I>
IIRC, that example was originally written before ssl::server_name
existed. haveServerName would have to detect a request where the server
name is known (e.g., step2 with SNI or step3). The difficulties with
writing such ACLs is what prompted us to add ssl::server_name. The
example should probably be rewritten as:

  acl serverIsBank ssl::server_name ...
  ssl_bump peek step1
  ssl_bump splice serverIsBank
  ssl_bump bump all

or even

  acl serverIsBank ssl::server_name ...
  ssl_bump splice serverIsBank
  ssl_bump stare all
  ssl_bump bump all

if you do not want Squid to silently bump bank transactions that lack
SNI. I am not sure whether Squid will log level-1 warning when it cannot
splice after staring during step2, but it would be appropriate to teach
Squid to do so IMO (with a rate/count limit of course).

The example description would need to be adjusted accordingly.


Thank you,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012085.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake	CONNECT
</A></li>
	<LI>Next message (by thread): <A HREF="012104.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12100">[ date ]</a>
              <a href="thread.html#12100">[ thread ]</a>
              <a href="subject.html#12100">[ subject ]</a>
              <a href="author.html#12100">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
