<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20clarifying%20Features/SslPeekAndSplice%20on%20wiki%20%2B%0A%20fake%20CONNECT&In-Reply-To=%3C5b4c46a0-ef29-fcdd-f21c-189dade5bf80%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012100.html">
   <LINK REL="Next"  HREF="012105.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20clarifying%20Features/SslPeekAndSplice%20on%20wiki%20%2B%0A%20fake%20CONNECT&In-Reply-To=%3C5b4c46a0-ef29-fcdd-f21c-189dade5bf80%40urlfilterdb.com%3E"
       TITLE="[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Tue Aug 23 02:14:56 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012100.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
</A></li>
        <LI>Next message (by thread): <A HREF="012105.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12104">[ date ]</a>
              <a href="thread.html#12104">[ thread ]</a>
              <a href="subject.html#12104">[ subject ]</a>
              <a href="author.html#12104">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your reply.
I will start changing the wiki page.
When I think I am done, I will let you know for a review.

What is left is my desire to get a fake CONNECT with FQDN (see below).

Marcus

On 08/22/2016 04:20 PM, Alex Rousskov wrote:
&gt;<i> On 08/21/2016 06:46 AM, Marcus Kool wrote:
</I>&gt;&gt;<i> there are still some issues with the wiki page that I like to clarify.
</I>&gt;<i>
</I>&gt;<i> Thanks a lot for working on this!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> wiki: <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> section &quot;processing steps&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can action &quot;none&quot; be removed from step 1?
</I>&gt;<i>
</I>&gt;<i> Done.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Step 1.  what is &quot;CONNECT info&quot;?  In the introduction one speaks
</I>&gt;&gt;<i> of &quot;HTTP CONNECT&quot; which has a FQDN.  But the fake CONNECT sent to
</I>&gt;&gt;<i> a URL rewriter has only an IP address.
</I>&gt;<i>
</I>&gt;<i> CONNECT info is the info associated with a CONNECT request, real or fake
</I>&gt;<i> (depending on the http*_port being used for the transaction). Real
</I>&gt;<i> CONNECT requests often have FQDNs. Fake CONNECT requests have IP
</I>&gt;<i> addresses during step1.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Why is the fake CONNECT that is sent to the URL rewriter done
</I>&gt;&gt;<i> at step 1 where only the IP and not the FQDN is available?
</I>&gt;<i>
</I>&gt;<i> ... because some rewriters want/need those CONNECTs, for various
</I>&gt;<i> reasons. The overall design here is simple and logical in my biased
</I>&gt;<i> opinion: Send everything by default but let admin control what should be
</I>&gt;<i> sent. If _your_ rewriter does not need some CONNECTs, configure Squid
</I>&gt;<i> not to send those unwanted CONNECTS to the rewriter. If Squid lacks ACLs
</I>&gt;<i> to detect unwanted CONNECTs, add support for those missing ACLs.
</I>
The fake CONNECT _is_ desired, but with FQDN, to
1) have no differences in the CONNECT information sent to
    the URL rewriter in normal proxy mode and in transparent
    intercept mode.
2) be able to filter.  The url rewriter cannot filter based
    on the IP address, it needs a FQDN/SNI.  The parameter
    %ssl::&gt;sni in url_rewrite_extras is always '-' which is
    not only fatal for _my_ url rewriter.

squid.conf.documented adds to the confusion with
    acl aclname at_step step
    ...
    SslBump1: After getting TCP-level and HTTP CONNECT info.
The forward proxy has a FQDN and the intercept proxy has an IP.
Without this information the confusion is created.

&gt;<i> The url_rewrite_access directive controls what transactions are sent to
</I>&gt;<i> the redirector.
</I>&gt;<i>
</I>&gt;<i> Note that CONNECTs should be sent both during step1 and during step2 by
</I>&gt;<i> default.
</I>
I think I missed something.  The URL rewriter on my systems only get IP
addresses, never SNI/FQDN.  And never receives two CONNECTS (i.e. one
at step1 and one at step2).
Can I configure Squid to send a fake CONNECT during step2 ?
What is &quot;during&quot;?  Is the CONNECT sent at the end of step2 so it can
send the SNI?

&gt;&gt;<i> In section &quot;Peek at SNI and Bump&quot; it is stated that SNI is obtained in
</I>&gt;&gt;<i> step 1. This contradicts the text at step 1 and 2.
</I>&gt;<i>
</I>&gt;<i> In section &quot;Peek at SNI and Bump&quot; it is NOT stated that SNI is obtained
</I>&gt;<i> in step 1. It is stated that SNI is obtained by peeking during step 1.
</I>&gt;<i> &quot;obtaining SNI&quot; and &quot;peeking&quot; are not the same! If, during step 1, you
</I>&gt;<i> tell Squid to peek, then, during step 2, Squid peeks and obtains SNI.
</I>&gt;<i>
</I>&gt;<i> There is no contradiction, but we are definitely struggling with how to
</I>&gt;<i> describe what is going on. Specific improvement suggestions are very
</I>&gt;<i> welcomed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> squid.conf.documented has this:
</I>&gt;&gt;<i> #  At each SslBump step, Squid evaluates ssl_bump directives to find
</I>&gt;&gt;<i> #  the *next* bumping action (e.g., peek or splice).
</I>&gt;&gt;<i> Emphasis on &quot;*next* bumping action&quot;.
</I>&gt;&gt;<i> Should the wiki be reworded and use &quot;next bumping action&quot;?
</I>&gt;<i>
</I>&gt;<i> Please suggest complete specific fixes. We know that the current wiki
</I>&gt;<i> text is difficult to follow for many so the attempts to rework it are
</I>&gt;<i> welcomed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Section &quot;Actions&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> item peek: Receive client SNI (step1), or server certificate (step2)  ...
</I>&gt;&gt;<i> This contradicts the explanation of the processing steps.
</I>&gt;&gt;<i> item stare: likewise.
</I>&gt;<i>
</I>&gt;<i> I do not think it does (see the &quot;peeking during step1 tells Squid to get
</I>&gt;<i> SNI during step2&quot; discussion above), but please suggest a better way to
</I>&gt;<i> phrase those descriptions. We know they are confusing. SNI (and
</I>&gt;<i> certificate parsing) happens at the beginning of stepN+1 but whether
</I>&gt;<i> that step happens at all depends on the stepN action.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I suggest to remove the &quot;Deprecated actions&quot; or use a BOLD warning not
</I>&gt;&gt;<i> to use them.
</I>&gt;<i>
</I>&gt;<i> I do not think we should remove them because comparing their description
</I>&gt;<i> with the currently supported actions may be very useful for upgrading
</I>&gt;<i> admins. Does not Squid already emit a deprecation WARNING when those
</I>&gt;<i> actions are used?
</I>&gt;<i>
</I>&gt;<i> If you know how to gray-out the rows with deprecated actions, please do
</I>&gt;<i> that. Otherwise (or in addition to that), please feel free to add a
</I>&gt;<i> &quot;Avoid this deprecated, poorly supported, and soon to be deleted
</I>&gt;<i> action.&quot; or similar text to each deprecated action description.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Section &quot;Mimicking SSL client Hello properties when staring&quot;
</I>&gt;&gt;<i> The section has &quot;The information in this section is incomplete and
</I>&gt;&gt;<i> somewhat stale.&quot;
</I>&gt;&gt;<i> Is there any information to update this section ?
</I>&gt;<i>
</I>&gt;<i> Yes, but it is only Squid sources and possibly commit log :-(.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> section &quot;Examples&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I usually write explicit rules like this:
</I>&gt;<i>
</I>&gt;&gt;<i> # do not touch servers where ssl-bump breaks HSTS
</I>&gt;&gt;<i> acl tls_allowed_hsts ...
</I>&gt;&gt;<i> # prevent bumping some allowed servers with self-signed certificates
</I>&gt;&gt;<i> acl tls_allowed_selfsigned ...
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> I recommend against documenting ACLs as actions. Your tls_allowed_hsts
</I>&gt;<i> does not prevent touching anything. Your tls_allowed_selfsigned does not
</I>&gt;<i> prevent bumping of any connections. Etc. ACLs are conditions. They only
</I>&gt;<i> identify certain transactions. They do not touch/prevent/allow/block
</I>&gt;<i> anything. The rules that use those ACLs do all that.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> # TLS/SSL bumping steps
</I>&gt;&gt;<i> ssl_bump peek   tls_s1_ip_connect   all                 # peek a client connecting at IP level
</I>&gt;&gt;<i> ssl_bump splice tls_s2_client_hello tls_to_splice       # splice some: do not bump/interfere
</I>&gt;&gt;<i> ssl_bump stare  tls_s2_client_hello all                 # connect to the server and stare(peek) at its TLS/SSL properties
</I>&gt;&gt;<i> ssl_bump bump   tls_s3_server_hello all                 # bump if we can (tls_s2_client_hello/stare succeeded)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> The above rules follow the steps of the wiki page but
</I>&gt;&gt;<i> the examples on the wiki have optimised rules and sometimes
</I>&gt;&gt;<i> there are messages on the mailing list that rules can be optimized
</I>&gt;&gt;<i> to save CPU cycles.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It is not primarily about CPU optimization. It is about readability.
</I>&gt;<i>
</I>&gt;&gt;<i> The last 4 lines of the example can be optimized into
</I>&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek   tls_s1_ip_connect   all
</I>&gt;&gt;<i> ssl_bump splice tls_s2_client_hello tls_to_splice
</I>&gt;&gt;<i> ssl_bump stare  all
</I>&gt;&gt;<i> ssl_bump bump   all
</I>&gt;<i>
</I>&gt;<i> Actually, they should be written as:
</I>&gt;<i>
</I>&gt;<i>   ssl_bump peek   tls_s1_ip_connect
</I>&gt;<i>   ssl_bump splice tls_to_splice
</I>&gt;<i>   ssl_bump stare  all
</I>&gt;<i>   ssl_bump bump   all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And, most likely (possibly after some ACL adjustments) can be further
</I>&gt;<i> clarified as:
</I>&gt;<i>
</I>&gt;<i>   ssl_bump splice tls_to_splice
</I>&gt;<i>   ssl_bump stare  all
</I>&gt;<i>   ssl_bump bump   all
</I>&gt;<i>
</I>&gt;<i> Which is a lot clearer for some, but not for others.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I prefer not to optimize since reading the rules is
</I>&gt;&gt;<i> easier and one understands better what happens at each step.
</I>&gt;<i>
</I>&gt;<i> It is a matter of taste.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> However, if a significant number of CPU cycles are saved, I suggest to
</I>&gt;&gt;<i> include an example like above and rules of thumb on how to optimize and the
</I>&gt;&gt;<i> final optimized results so that a less experienced reader understands
</I>&gt;&gt;<i> the optimizations.
</I>&gt;<i>
</I>&gt;<i> Please do, but this is not about optimization. It is about describing
</I>&gt;<i> desired outcome in two different ways:
</I>&gt;<i>
</I>&gt;<i> * If you want to be verbose and prefix every rule with the step it
</I>&gt;<i> applies to, then you can do that (at the elevated risk of forgetting to
</I>&gt;<i> tell Squid what to do in some cases among all the noise).
</I>&gt;<i>
</I>&gt;<i> * If you want to express the essence of your configuration, you can do
</I>&gt;<i> that instead (at the risk of misinterpreting which step a rule will be
</I>&gt;<i> applied at, due to increased complexity).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There are only two &quot;noise reduction&quot; or &quot;condensing&quot; rules AFAICT:
</I>&gt;<i>
</I>&gt;<i> 1. Do not say &quot;large green all&quot;. Just say &quot;large green&quot;.
</I>&gt;<i> 2. Splice and peek rules are ignored during step 3.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> The examples in &quot;Avoid bumping banking traffic&quot; :
</I>&gt;&gt;<i> I can image what used (but not defined) serverIsBank acl looks like:
</I>&gt;&gt;<i>    acl serverIsBank  ssl::server_name .santander.com
</I>&gt;&gt;<i> but have no idea what the acl haveServerName looks like.
</I>&gt;&gt;<i> What is intended here?
</I>&gt;<i>
</I>&gt;<i> IIRC, that example was originally written before ssl::server_name
</I>&gt;<i> existed. haveServerName would have to detect a request where the server
</I>&gt;<i> name is known (e.g., step2 with SNI or step3). The difficulties with
</I>&gt;<i> writing such ACLs is what prompted us to add ssl::server_name. The
</I>&gt;<i> example should probably be rewritten as:
</I>&gt;<i>
</I>&gt;<i>   acl serverIsBank ssl::server_name ...
</I>&gt;<i>   ssl_bump peek step1
</I>&gt;<i>   ssl_bump splice serverIsBank
</I>&gt;<i>   ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> or even
</I>&gt;<i>
</I>&gt;<i>   acl serverIsBank ssl::server_name ...
</I>&gt;<i>   ssl_bump splice serverIsBank
</I>&gt;<i>   ssl_bump stare all
</I>&gt;<i>   ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> if you do not want Squid to silently bump bank transactions that lack
</I>&gt;<i> SNI. I am not sure whether Squid will log level-1 warning when it cannot
</I>&gt;<i> splice after staring during step2, but it would be appropriate to teach
</I>&gt;<i> Squid to do so IMO (with a rate/count limit of course).
</I>&gt;<i>
</I>&gt;<i> The example description would need to be adjusted accordingly.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012100.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
</A></li>
	<LI>Next message (by thread): <A HREF="012105.html">[squid-users] clarifying Features/SslPeekAndSplice on wiki + fake CONNECT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12104">[ date ]</a>
              <a href="thread.html#12104">[ thread ]</a>
              <a href="subject.html#12104">[ subject ]</a>
              <a href="author.html#12104">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
