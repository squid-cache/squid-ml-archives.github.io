<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Https_port with &quot;official&quot; certificate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Https_port%20with%20%22official%22%20certificate&In-Reply-To=%3CCAD8MJvAKuZL3g5YiWfgOpKgPEyVOb9sO6r%3DMFoUNGwdoxBqN_A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012149.html">
   <LINK REL="Next"  HREF="012155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Https_port with &quot;official&quot; certificate</H1>
    <B>Diogenes S. Jesus</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Https_port%20with%20%22official%22%20certificate&In-Reply-To=%3CCAD8MJvAKuZL3g5YiWfgOpKgPEyVOb9sO6r%3DMFoUNGwdoxBqN_A%40mail.gmail.com%3E"
       TITLE="[squid-users] Https_port with &quot;official&quot; certificate">splash at gmail.com
       </A><BR>
    <I>Wed Aug 24 14:37:31 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012149.html">[squid-users] Https_port with &quot;official&quot; certificate
</A></li>
        <LI>Next message (by thread): <A HREF="012155.html">[squid-users] Https_port with &quot;official&quot; certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12154">[ date ]</a>
              <a href="thread.html#12154">[ thread ]</a>
              <a href="subject.html#12154">[ subject ]</a>
              <a href="author.html#12154">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This configuration here covers the use case described by the OP:
<A HREF="https://gist.githubusercontent.com/splashx/758ff0c59ea291f32edafc516fdaad73/raw/8050fa054821657812961050332b38a56e7e3e68/">https://gist.githubusercontent.com/splashx/758ff0c59ea291f32edafc516fdaad73/raw/8050fa054821657812961050332b38a56e7e3e68/</A>

If everything works well, you'll notice you won't support HTTP proxy at
all, but users can reach  both HTTP and HTTPS target websites via your
HTTPS proxy.

# netstat -nltp

Active Internet connections (only servers)

Proto Recv-Q Send-Q Local Address           Foreign Address         State
    PID/Program name

tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
    32109/sshd

tcp6       0      0 :::80                   :::*                    LISTEN
    26627/apache2

tcp6       0      0 :::3443                 :::*                    LISTEN
    7303/(squid-1)

tcp6       0      0 :::22                   :::*                    LISTEN
    32109/sshd


The user connects to the proxy ONLY via HTTPS Proxy on port 3443

All traffic between the OP and the proxy is encrypted using TLS.
A) If the user enters <A HREF="http://target.example.com,">http://target.example.com,</A> between the proxy and the
target you'll see HTTP.
B) If the user enters <A HREF="https://target.example.com,">https://target.example.com,</A> between the proxy and the
target you'll see HTTPS.

If you sniff the traffic between the client and the proxy, you'll see TLS.

Tested with:

$ /Applications/Firefox\ 2.app/Contents/MacOS/firefox -v

Mozilla Firefox 48.0

Firefox set up to use PAC: Preferences &gt; Advanced &gt; Network &gt; Settings:
&quot;Automatic Proxy Configuration&quot;: <A HREF="http://squid.example.com/proxy.pac">http://squid.example.com/proxy.pac</A>

The downside here of course is the limited amount of clients supporting
HTTPS Proxy settings.

Dio


On Wed, Aug 24, 2016 at 3:46 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> Just to rewind this conversation to the actual problem ...
</I>&gt;<i>
</I>&gt;<i> On 24/08/2016 11:42 p.m., Samuraiii wrote:
</I>&gt;<i> &gt; On 24.8.2016 13:18, Antony Stone wrote:
</I>&gt;<i> &gt;&gt; Unfortunately it's not Squid that's the challenge - it's the browser.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If you're using Firefox and/or Chrome, you should be okay.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; See &quot;Encrypted browser-Squid connection&quot; at the bottom of
</I>&gt;<i> &gt;&gt; <A HREF="http://wiki.squid-cache.org/Features/HTTPS">http://wiki.squid-cache.org/Features/HTTPS</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Antony.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; I have seen that, it is the cause of my subscription to this list.
</I>&gt;<i> &gt; I haven't been able to find any usable hints.
</I>&gt;<i> &gt; My config attempt fails
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; https_port 8443 \
</I>&gt;<i> &gt;     cert=/etc/letsencrypt/live/sklad.duckdns.org/cert.pem \
</I>&gt;<i> &gt;     key=/etc/letsencrypt/live/sklad.duckdns.org/key.pem \
</I>&gt;<i> &gt;     cleintca=/etc/letsencrypt/live/sklad.duckdns.org/fullchain.pem \
</I>&gt;<i> &gt;     tls-dh=/etc/ssl/certs/dhparam.pem \
</I>&gt;<i> &gt;     sslproxy_options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE \
</I>&gt;<i> &gt;     cipher=HIGH
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As Dio mentioned the cleintca= (or rather clientca=) is for
</I>&gt;<i> authenticating clients ceritficates. Don't use that unless you are
</I>&gt;<i> requiring client certs in TLS.
</I>&gt;<i>
</I>&gt;<i> The rest of your config looks reasonable to me. I suspect you have found
</I>&gt;<i> a bug introduced during all the SSL-Bump code changes. Please make a
</I>&gt;<i> bugzilla report and include your exact Squid version (found with the
</I>&gt;<i> 'squid -v' command), the https_port line(s) and the exact error message
</I>&gt;<i> produced on startup.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


-- 

--------

Diogenes S. de Jesus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160824/bce4c338/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160824/bce4c338/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012149.html">[squid-users] Https_port with &quot;official&quot; certificate
</A></li>
	<LI>Next message (by thread): <A HREF="012155.html">[squid-users] Https_port with &quot;official&quot; certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12154">[ date ]</a>
              <a href="thread.html#12154">[ thread ]</a>
              <a href="subject.html#12154">[ subject ]</a>
              <a href="author.html#12154">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
