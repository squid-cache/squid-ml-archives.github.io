<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] More host header forgery pain with peek/splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20More%20host%20header%20forgery%20pain%20with%20peek/splice&In-Reply-To=%3Cfd37526a-d77a-66e5-93f0-29f2c62fec34%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012176.html">
   <LINK REL="Next"  HREF="012180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] More host header forgery pain with peek/splice</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20More%20host%20header%20forgery%20pain%20with%20peek/splice&In-Reply-To=%3Cfd37526a-d77a-66e5-93f0-29f2c62fec34%40opendium.com%3E"
       TITLE="[squid-users] More host header forgery pain with peek/splice">steve at opendium.com
       </A><BR>
    <I>Thu Aug 25 16:17:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012176.html">[squid-users] How to log ACL to custom log
</A></li>
        <LI>Next message (by thread): <A HREF="012180.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12177">[ date ]</a>
              <a href="thread.html#12177">[ thread ]</a>
              <a href="subject.html#12177">[ subject ]</a>
              <a href="author.html#12177">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
This one just seems to keep coming up and I'm wondering how other people 
are dealing with it:

When you peek and splice a transparently proxied connection, the SNI 
goes through the host validation phase.  Squid does a DNS lookup for the 
SNI, and if it doesn't resolve to the IP address that the client is 
connecting to, Squid drops the connection.

When accessing one of the increasingly common websites that use DNS load 
balancing, since the DNS results change on each lookup, Squid and the 
client may not get the same DNS results, so Squid drops perfectly good 
connections.

Most of this problem goes away if you ensure all the clients use the 
same DNS server as squid, but not quite.  Because the TTL on DNS records 
only has a resolution of 1 second, there is a period of up to 1 second 
when the DNS records Squid knows about doesn't match the ones that the 
client knows about.  The client and squid may expire the records up to 1 
second apart.

So what's the solution?  (Notably the validation check can't be disabled 
without hacking the code).

-- 
  - Steve Hill
    Technical Director
    Opendium    Online Safety / Web Filtering    <A HREF="http://www.opendium.com">http://www.opendium.com</A>

    Enquiries                 Support
    ---------                 -------
    <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>        <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    +44-1792-824568           +44-1792-825748

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012176.html">[squid-users] How to log ACL to custom log
</A></li>
	<LI>Next message (by thread): <A HREF="012180.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12177">[ date ]</a>
              <a href="thread.html#12177">[ thread ]</a>
              <a href="subject.html#12177">[ subject ]</a>
              <a href="author.html#12177">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
