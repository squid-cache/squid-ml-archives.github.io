<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache object with vary
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20object%20with%20vary&In-Reply-To=%3Cdfa9a967-d6a6-b874-e1d2-4725dd1e70e7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012218.html">
   <LINK REL="Next"  HREF="012227.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache object with vary</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20object%20with%20vary&In-Reply-To=%3Cdfa9a967-d6a6-b874-e1d2-4725dd1e70e7%40treenet.co.nz%3E"
       TITLE="[squid-users] cache object with vary">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Aug 28 16:48:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012218.html">[squid-users] cache object with vary
</A></li>
        <LI>Next message (by thread): <A HREF="012227.html">[squid-users] cache object with vary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12226">[ date ]</a>
              <a href="thread.html#12226">[ thread ]</a>
              <a href="subject.html#12226">[ subject ]</a>
              <a href="author.html#12226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/08/2016 12:56 p.m., joe wrote:
&gt;<i> is this bug or its made to work like that
</I>&gt;<i> lets say we have object in cache name 000000A5
</I>&gt;<i> url.com/some.js
</I>&gt;<i> vary=accept-encoding=&quot;gzip&quot;
</I>&gt;<i> 
</I>&gt;<i> if some browser get the same object
</I>&gt;<i> url.com/some.js
</I>&gt;<i> vary=accept-encoding=&quot;deflate&quot;
</I>&gt;<i> 
</I>&gt;<i> the md5 key wont match 
</I>
Correct.

&gt;<i> and it delete the old cached object with
</I>&gt;<i> accept-encoding=&quot;gzip&quot; and replace with
</I>&gt;<i> new one with vary=accept-encoding=&quot;deflate&quot; and prosess as TCP_MISS
</I>
Incorrect.

The first thing Squid does is lookup the URL (only). That finda a 'vark
marker' object which tels Squid the Vary header pattern to append to the
hash key and do another lookup for that.

The amended hash key for the second query finds no object ==&gt; a MISS.
Period.

The &quot;gzip&quot; object existence or absence is not related nor touched.

&gt;<i> 
</I>&gt;<i> that will result in &quot;varyEvaluateMatch: Oops. Not a Vary match on second
</I>&gt;<i> attempt
</I>&gt;<i> no match and the code in client_side.cc
</I>&gt;<i> return VARY_CANCEL
</I>
IF:
 * the second lookup with the amended hash key *did* find an object, and
 * it was for the same URL, and
 * it has no Vary header;
then a warning message (the above?) is output and the found object will
be replaced with whatever comes back from the MISS resolving actions.


I think you can get yourself into this type of situation when using
Store-ID in ways prohibited by the Store-ID design.

 Requirement #1 for Store-ID is that all objects found by the custom ID
key are identical.

 Variants are non-identical by definition. So at least one variant of
objects that Vary is not going to be identical to objects that lack Vary!


You can also encounter it with SMP workers at times. Since the workers
are processing more traffic than ever before the churn and key hash
collisions rate is potentially greater.


&gt;<i> 
</I>&gt;<i> and in client_side_reply.cc
</I>&gt;<i> 
</I>&gt;<i>     case VARY_CANCEL:
</I>&gt;<i>         /* varyEvaluateMatch found a object loop. Process as miss */
</I>&gt;<i>         debugs(88, DBG_IMPORTANT, &quot;clientProcessHit: Vary object loop!&quot;);
</I>
NP: the above statements may or may not be true. The code was written a
long time ago and things around it have changed a lot in the meantime.

&gt;<i>         http-&gt;logType = LOG_TCP_MISS; // we lack a more precise LOG_*_MISS
</I>&gt;<i> code
</I>&gt;<i>         processMiss();
</I>&gt;<i>         return;
</I>&gt;<i> 
</I>&gt;<i> the way it should be instead of replacing the existing obj  should be
</I>&gt;<i> another object with the 
</I>&gt;<i> new vary
</I>&gt;<i> shuld be 2 file 000000A5
</I>&gt;<i> and    000000A6     example each one has different vary to match the correct
</I>&gt;<i> obj if its gzip or ident or deflate or with useragent
</I>&gt;<i> wen vary not matching shuld be new obj file to be saved as diferent cache
</I>&gt;<i> name 000000A7
</I>&gt;<i> so it match the correct object name with its vary
</I>&gt;<i> 
</I>
If the above wasn't clear enough. This is how squid does it:

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot;)
 data: vary-marker object (&quot;Vary:Accept-Encoding&quot;, ...)

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot; + &quot;accept-encoding=&quot;)
 data: no- Accept-Encoding variant response

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot; + &quot;accept-encoding=identity&quot;)
 data: &quot;identity&quot; variant response

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot; + &quot;accept-encoding=gzip&quot;)
 data: &quot;gzip&quot; variant response

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot; + &quot;accept-encoding=deflate&quot;)
 data: &quot;deflate&quot; variant response

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot; + &quot;accept-encoding=deflate,gzip&quot;)
 data: &quot;deflate,gzip&quot; variant response

 key: MD5(&quot;<A HREF="http://url.com/some.js">http://url.com/some.js</A>&quot; + &quot;accept-encoding=gzip,deflate&quot;)
 data: &quot;gzip,deflate&quot; variant response

 ... and so on for all possible unique strings that could be sent in
Accept-Encoding.


If one of those 'data' objects contains a 'wrong' response object. The
transaction encountering it MISS'es  / VARY_CANCEL and that store
location gets updated with correct content resulting from the server fetch.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012218.html">[squid-users] cache object with vary
</A></li>
	<LI>Next message (by thread): <A HREF="012227.html">[squid-users] cache object with vary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12226">[ date ]</a>
              <a href="thread.html#12226">[ thread ]</a>
              <a href="subject.html#12226">[ subject ]</a>
              <a href="author.html#12226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
