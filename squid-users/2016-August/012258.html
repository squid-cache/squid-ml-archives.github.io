<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] More host header forgery pain with peek/splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20More%20host%20header%20forgery%20pain%20with%20peek/splice&In-Reply-To=%3C9ab7100a-228e-a96a-35ad-afbcf840e896%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012263.html">
   <LINK REL="Next"  HREF="012178.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] More host header forgery pain with peek/splice</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20More%20host%20header%20forgery%20pain%20with%20peek/splice&In-Reply-To=%3C9ab7100a-228e-a96a-35ad-afbcf840e896%40treenet.co.nz%3E"
       TITLE="[squid-users] More host header forgery pain with peek/splice">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 30 16:14:09 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012263.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
        <LI>Next message (by thread): <A HREF="012178.html">[squid-users] Strange log https problem??
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12258">[ date ]</a>
              <a href="thread.html#12258">[ thread ]</a>
              <a href="subject.html#12258">[ subject ]</a>
              <a href="author.html#12258">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/08/2016 4:17 a.m., Steve Hill wrote:
&gt;<i> 
</I>&gt;<i> This one just seems to keep coming up and I'm wondering how other people
</I>&gt;<i> are dealing with it:
</I>&gt;<i> 
</I>&gt;<i> When you peek and splice a transparently proxied connection, the SNI
</I>&gt;<i> goes through the host validation phase.  Squid does a DNS lookup for the
</I>&gt;<i> SNI, and if it doesn't resolve to the IP address that the client is
</I>&gt;<i> connecting to, Squid drops the connection.
</I>&gt;<i> 
</I>&gt;<i> When accessing one of the increasingly common websites that use DNS load
</I>&gt;<i> balancing, since the DNS results change on each lookup, Squid and the
</I>&gt;<i> client may not get the same DNS results, so Squid drops perfectly good
</I>&gt;<i> connections.
</I>&gt;<i> 
</I>&gt;<i> Most of this problem goes away if you ensure all the clients use the
</I>&gt;<i> same DNS server as squid, but not quite.  Because the TTL on DNS records
</I>&gt;<i> only has a resolution of 1 second, there is a period of up to 1 second
</I>&gt;<i> when the DNS records Squid knows about doesn't match the ones that the
</I>&gt;<i> client knows about.  The client and squid may expire the records up to 1
</I>&gt;<i> second apart.
</I>
FYI: Services sending TTL of just 1 or even a few seconds are abusing
the DNS system. Rotating the order of IPs in the RR record is a
standardized feature and works just fine with how Squid does its checks.

NP: using &quot;8.8.8.8&quot; in both Squid and client does not count as using the
same resolver. Because that service is an entire farm of resolvers that
can and do respond differently to any two requests - even if they are
made simultaneously. Not a single machine using a single cache of DNS data.

&gt;<i> 
</I>&gt;<i> So what's the solution?  (Notably the validation check can't be disabled
</I>&gt;<i> without hacking the code).
</I>&gt;<i> 
</I>
Well, hacking the code. But not necessarily in the obvious way of
disabling checks. Redesign in Squid DNS component is needed. If you want
to sponsor and/or test that work mail me privately. Though its unlikely
to be available for use in the short term .

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012263.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
	<LI>Next message (by thread): <A HREF="012178.html">[squid-users] Strange log https problem??
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12258">[ date ]</a>
              <a href="thread.html#12258">[ thread ]</a>
              <a href="subject.html#12258">[ subject ]</a>
              <a href="author.html#12258">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
