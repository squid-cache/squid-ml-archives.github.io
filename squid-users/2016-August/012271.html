<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy on OSX Yosemite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20on%20OSX%20Yosemite&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B90257AAB7BE%40EXWCMS01.fanniemae.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012267.html">
   <LINK REL="Next"  HREF="012279.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy on OSX Yosemite</H1>
    <B>Shively, Gregory</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20on%20OSX%20Yosemite&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B90257AAB7BE%40EXWCMS01.fanniemae.com%3E"
       TITLE="[squid-users] Transparent Proxy on OSX Yosemite">gregory_shively at fanniemae.com
       </A><BR>
    <I>Tue Aug 30 23:19:10 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012267.html">[squid-users] SQUID3 FreeRADIUS
</A></li>
        <LI>Next message (by thread): <A HREF="012279.html">[squid-users] Transparent Proxy on OSX Yosemite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12271">[ date ]</a>
              <a href="thread.html#12271">[ thread ]</a>
              <a href="subject.html#12271">[ subject ]</a>
              <a href="author.html#12271">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm attempting to get a squid working as a transparent proxy on OSX Yosemite. Every attempt ended with a &quot;Forward loop detected&quot;. I initially started with the version from homebrew and moved to just compiling myself to see if I could figure out what was going on. Being new to both pf network and squid, it might be something that I have configured wrong. I configured pf similar to:

              nat on $ext_if proto {udp, tcp} from $int_if:network to any port domain -&gt; ($ext_if)
              rdr pass on $int_if proto tcp from $int_if:network to any port {http, https} -&gt; 127.0.0.1 port 3129

And my squid.conf for my testing is basically:

http_port 3128
http_port 3129 intercept
http_access allow all

I'm not sure if this is more appropriate on this mailing list or the developer mailing list (hoping it is just something I'm doing wrong). The squid that I'm using doesn't have -with-nat-devpf enabled; it fails to compile with that option. I'm wondering if the getsockname() as per comment for PFIntercept (of the !_USE_NAT_DEVPF) in src/ip/Intercept.cc, on OSX is not returning the pre-rdr address and causing the forward loop.

As mentioned, the -with-nat-devpf fails to compile on OSX due to a missing header file. And from looking it sounds like the header is for the ioctl() on /dev/pf, which doesn't seem to be public API on OSX. So I'm trying to determine if my issue is due to a misconfiguration - or is this portion of the code not working with OSX. I looked at the code for mitmproxy, and it seems like they require a sudoers entry to run &quot;pfctl -s state&quot; and parse the state. Would something like that need to be added to squid to support transparent proxy on OSX. I had started to put some code together like mitmproxy, but thought better check if I didn't get something configured correctly.

Greg
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160830/231fc8ad/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160830/231fc8ad/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012267.html">[squid-users] SQUID3 FreeRADIUS
</A></li>
	<LI>Next message (by thread): <A HREF="012279.html">[squid-users] Transparent Proxy on OSX Yosemite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12271">[ date ]</a>
              <a href="thread.html#12271">[ thread ]</a>
              <a href="subject.html#12271">[ subject ]</a>
              <a href="author.html#12271">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
