<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Debugging NTLM problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20NTLM%20problem&In-Reply-To=%3Cf1165df6-eb78-529e-9068-0106b45f0d1e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012276.html">
   <LINK REL="Next"  HREF="012278.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Debugging NTLM problem</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20NTLM%20problem&In-Reply-To=%3Cf1165df6-eb78-529e-9068-0106b45f0d1e%40treenet.co.nz%3E"
       TITLE="[squid-users] Debugging NTLM problem">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 31 15:10:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012276.html">[squid-users] Debugging NTLM problem
</A></li>
        <LI>Next message (by thread): <A HREF="012278.html">[squid-users] HTTPS chrome  - SHA1 this page is insecure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12281">[ date ]</a>
              <a href="thread.html#12281">[ thread ]</a>
              <a href="subject.html#12281">[ subject ]</a>
              <a href="author.html#12281">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/09/2016 12:37 a.m., akn ab wrote:
&gt;<i> Dear all,
</I>&gt;<i> i'm facing a strange problem using squid 3.5.20 with ntlm transparent 
</I>&gt;<i> authentication.
</I>&gt;<i> I cannot use kerberos auth because i need to pass DOMAIN\user to my parent proxy 
</I>&gt;<i> with x-authenticated-user header, and the form <A HREF="https://lists.squid-cache.org/listinfo/squid-users">USERNAME at DOMAIN</A> is not supported.
</I>&gt;<i> Users can surf the web without problems but, sometimes, they receive request 
</I>&gt;<i> credential popup from browser (explorer, edge, mozilla and chrome it does not 
</I>&gt;<i> matter).
</I>&gt;<i> auth_param ntlm program /usr/local/samba/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 300 startup=200 idle=10 concurrency=0
</I>&gt;<i> auth_param ntlm keep_alive on
</I>&gt;<i> auth_param basic program /usr/local/samba/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 25 startup=15 idle=5 concurrency=0
</I>&gt;<i> auth_param basic realm PROXY AUTHORIZATION REQUIRED
</I>&gt;<i> auth_param basic credentialsttl 30 minutes
</I>&gt;<i> authenticate_cache_garbage_interval 1 hours
</I>&gt;<i> authenticate_ttl 30 minutes
</I>&gt;<i> authenticate_ip_ttl 30 minutes
</I>&gt;<i>
</I>&gt;<i> I migrated from squid 2.6.x and, with similar configuration, the required 
</I>&gt;<i> credentials was displayed only when the password was expired.
</I>&gt;<i> In this situation,  users must click on abort button many times to restore a 
</I>&gt;<i> good situation, but i cannot understand why the request popup suddenly.
</I>&gt;<i> Is this a credentials cache timeout problm (authenticate_ttl 30 minutes)?
</I>
Maybe. If so its not an NTLM problem since NTLM credentials are &quot;cached&quot;
by being tied to the TCP connection state, not stored in a regular cache
like Basic auth credentials.

I suggest trying:
  auth_param ntlm keep_alive off

Squid-3 is now HTTP/1.1 which behaves a bit differently with persistent
connectiosn than HTTP/1.0 did. Which affects the pile of nasty hacks
needed to make NTLM work over HTTP.

&gt;<i> Is this a problem in the browser?
</I>
Yes, at least partially. The popup only occurs when the browser thinks
none of its credentials are valid to send to the proxy. Why it thinks
that might be a browser bug or a Squid bug. Or just the way NTLM behaves
in some HTTP message circumstances.

&gt;<i> Is this a comunication problem with squind and Active Directory?
</I>
Unlikely. It's more probably between Squid and browser. Squid only
interacts with AD at the start of a new TCP connection, or when NTLM is
started on an existing connection.

It could be browser sending unacceptible credentials (eg. the users
machine's account instead of the users own account) then deciding NTLM
is unusable.

It could be the browser failing to send the right NTLM token for Squid
to check against the existing known credentials tied to the connection.


&gt;<i> I would like to undestrand why, so i need advices to start debug and find a 
</I>&gt;<i> solution.
</I>
&lt;<A HREF="http://wiki.squid-cache.org/KnowledgeBase/DebugSections">http://wiki.squid-cache.org/KnowledgeBase/DebugSections</A>&gt;

Section 29 is the various authenticators. You will also need the ACL
processing section and results.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012276.html">[squid-users] Debugging NTLM problem
</A></li>
	<LI>Next message (by thread): <A HREF="012278.html">[squid-users] HTTPS chrome  - SHA1 this page is insecure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12281">[ date ]</a>
              <a href="thread.html#12281">[ thread ]</a>
              <a href="subject.html#12281">[ subject ]</a>
              <a href="author.html#12281">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
