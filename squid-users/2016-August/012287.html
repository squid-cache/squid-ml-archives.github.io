<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy on OSX Yosemite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20on%20OSX%20Yosemite&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B90257C35106%40EXWCMS01.fanniemae.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012279.html">
   <LINK REL="Next"  HREF="012272.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy on OSX Yosemite</H1>
    <B>Shively, Gregory</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20on%20OSX%20Yosemite&In-Reply-To=%3CF25802A5228F1345B9BD8093E210C3B90257C35106%40EXWCMS01.fanniemae.com%3E"
       TITLE="[squid-users] Transparent Proxy on OSX Yosemite">gregory_shively at fanniemae.com
       </A><BR>
    <I>Wed Aug 31 17:59:15 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012279.html">[squid-users] Transparent Proxy on OSX Yosemite
</A></li>
        <LI>Next message (by thread): <A HREF="012272.html">[squid-users] Acl to deny all sites, and allow some sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12287">[ date ]</a>
              <a href="thread.html#12287">[ thread ]</a>
              <a href="subject.html#12287">[ subject ]</a>
              <a href="author.html#12287">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 31/08/2016 11:19 a.m., Shively, Gregory wrote:
</I>
&gt;<i> &gt; I'm attempting to get a squid working as a transparent proxy on OSX
</I>
&gt;<i> &gt; Yosemite. Every attempt ended with a &quot;Forward loop detected&quot;. I
</I>
&gt;<i> &gt; initially started with the version from homebrew and moved to just
</I>
&gt;<i> &gt; compiling myself to see if I could figure out what was going on.
</I>
&gt;<i> &gt; Being new to both pf network and squid, it might be something that I
</I>
&gt;<i> &gt; have configured wrong. I configured pf similar to:
</I>
&gt;<i> &gt;
</I>
&gt;<i> &gt;    nat on $ext_if proto {udp, tcp} from $int_if:network to any port domain -&gt; ($ext_if)
</I>
&gt;<i> &gt;    rdr pass on $int_if proto tcp from $int_if:network to any port
</I>
&gt;<i> &gt; {http, https} -&gt; 127.0.0.1 port 3129
</I>
&gt;<i> &gt;
</I>
&gt;<i> &gt; And my squid.conf for my testing is basically:
</I>
&gt;<i> &gt;
</I>
&gt;<i> &gt; http_port 3128
</I>
&gt;<i> &gt; http_port 3129 intercept
</I>
&gt;<i> &gt; http_access allow all
</I>
&gt;<i> &gt;
</I>


&gt;<i> &gt; I'm not sure if this is more appropriate on this mailing list or the
</I>
&gt;<i> &gt; developer mailing list (hoping it is just something I'm doing wrong).
</I>
&gt;<i> &gt; The squid that I'm using doesn't have -with-nat-devpf enabled; it
</I>
&gt;<i> &gt; fails to compile with that option. I'm wondering if the getsockname()
</I>
&gt;<i> &gt; as per comment for PFIntercept (of the !_USE_NAT_DEVPF) in
</I>
&gt;<i> &gt; src/ip/Intercept.cc, on OSX is not returning the pre-rdr address and
</I>
&gt;<i> &gt; causing the forward loop.
</I>


&gt;<i> Your access.log can show that. It shows up as the server the transaction is being sent to being port 3128/3129 on 127.0.0.1 or another IP assigned to the Squid machine.
</I>


It looks like I get 2 associated TCP_MISS entries in the access.log, followed by entries that looks like they are associated with the access denied error screen. All generate the forwarding loop warning when running squid in debug.  I also had the pf logging and see the rdr getting redirected, plus had started netcat listening on 3129 prior to starting squid and saw the HTTP request come in.



&gt;<i> &gt;
</I>
&gt;<i> &gt; As mentioned, the -with-nat-devpf fails to compile on OSX due to a
</I>
&gt;<i> &gt; missing header file. And from looking it sounds like the header is for
</I>
&gt;<i> &gt; the ioctl() on /dev/pf, which doesn't seem to be public API on OSX. So
</I>
&gt;<i> &gt; I'm trying to determine if my issue is due to a misconfiguration - or
</I>
&gt;<i> &gt; is this portion of the code not working with OSX.
</I>


&gt;<i> It has been a long time since anyone using MacOS has provided any particular feedback about Squid behaviour on MacOS. So it could be just bugs when running on MacOS.
</I>




&gt;<i> &gt; I looked at the code for mitmproxy, and it seems like they require a
</I>
&gt;<i> &gt; sudoers entry to run &quot;pfctl -s state&quot; and parse the state.
</I>
&gt;<i> &gt; Would something like that need to be added to squid to support
</I>
&gt;<i> &gt; transparent proxy on OSX. I had started to put some code together like
</I>
&gt;<i> &gt; mitmproxy, but thought better check if I didn't get something
</I>
&gt;<i> &gt; configured correctly.
</I>


&gt;<i> Squid (when built with the /dev/pf support) master process which is run as root [you are running Squid from the root account right?] should be preserving its permission to access the device before it drops down to low privilege levels for handling the network traffic.
</I>


Yeah - I'm running the squid process as root; that is partially what headed me down the road with the /dev/pf - the permissions had changed after a reboot of the Mac and I started getting curious on why squid didn't give me a permission warning in the same way that mitmproxy was. And from the code, at least in the portion of the code I was looking, since I didn't have the -use-devpf it doesn't seem to open the dev file.



&gt;<i> Some other troubleshooting things to try:
</I>


&gt;<i> * using the machines public IP addres instead of 127.0.0.1. There are hardware or driver level restrictions on locahost addresses that often prohibit that type of NAT.
</I>


&gt;<i> * using a divert-to rule instead of rdr. If your PF firewall accepts that and the 'tproxy' option in squid.conf works then the /dev/pf is not relevant. rdr sometimes does not work when divert-to is fine.
</I>


&gt;<i> * check the PF version in your MacOS. If it derives from OpenBSD 4.8 or later then the .dev.pf is not relevant - rdr/divert-to failure is then a bug somewhere AFAIK.
</I>


I tried using both the internal and external interface IP addresses on the rdr rule. Both ended in the same forward loop. And it doesn't look like, at least Yosemite, has the option to use the divert-to in the firewall rules. I can't seem to find the reference, but I think that the pf in OSX is based around OpenBSD 4.4 or 4.5, but don't hold me to it. I'm guessing that is the reason that the divert-to is not available. I can look at an El Capt machine, but don't currently have access.



Thanks for the help on getting this setup. I had put some code in the PfInterception method to replace the &quot;local&quot; address that I pulled from running the pfctl -s state command and it did change the results. But I'm thinking that I might have gotten the host or port in the &quot;address&quot; object incorrectly - it didn't seem to work and further connections just errored out. When I get a change will take a more detailed look and verify I'm getting the addresses in the correct form.



&gt;<i> Amos
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160831/e8a6c07a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160831/e8a6c07a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012279.html">[squid-users] Transparent Proxy on OSX Yosemite
</A></li>
	<LI>Next message (by thread): <A HREF="012272.html">[squid-users] Acl to deny all sites, and allow some sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12287">[ date ]</a>
              <a href="thread.html#12287">[ thread ]</a>
              <a href="subject.html#12287">[ subject ]</a>
              <a href="author.html#12287">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
