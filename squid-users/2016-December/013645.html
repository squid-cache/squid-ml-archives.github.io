<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 100% cpu after about an hour
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20100%25%20cpu%20after%20about%20an%20hour&In-Reply-To=%3Ca6874296-0065-4845-52cf-0a3b3fd2fa38%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013644.html">
   <LINK REL="Next"  HREF="013646.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 100% cpu after about an hour</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20100%25%20cpu%20after%20about%20an%20hour&In-Reply-To=%3Ca6874296-0065-4845-52cf-0a3b3fd2fa38%40treenet.co.nz%3E"
       TITLE="[squid-users] 100% cpu after about an hour">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Dec  2 01:27:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013644.html">[squid-users] 100% cpu after about an hour
</A></li>
        <LI>Next message (by thread): <A HREF="013646.html">[squid-users] this is definitely the coolest stuff ever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13645">[ date ]</a>
              <a href="thread.html#13645">[ thread ]</a>
              <a href="subject.html#13645">[ subject ]</a>
              <a href="author.html#13645">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/12/2016 1:18 p.m., Michael Gibson wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> Having about 100% CPU usage after about an hour running. We operate Squid v
</I>&gt;<i> 3.5 on multiple nodes. We range from 10 users, up through 200 on various
</I>&gt;<i> nodes. We recently updated from 3.3 to 3.5 and I've been unable to contain
</I>&gt;<i> the core usage of Squid. I attempted to get multiple Squid workers resulted
</I>&gt;<i> in both cores getting pegged on our small servers.
</I>
Which 3.5 release exactly?


Any hint about what its doing with all those cycles?
 cache.log might have something.

&gt;<i> 
</I>&gt;<i> Dual core Intel(R) Celeron(R) M processor         1.50GHz
</I>&gt;<i> 4GB RAM
</I>&gt;<i> 
</I>&gt;<i> Here's the config we're currently running:
</I>&gt;<i> 
</I>&gt;<i> # Managed by Chef
</I>&gt;<i> # Changes will be overwritten
</I>&gt;<i> 
</I>&gt;<i> # Crazy debug
</I>&gt;<i> #debug_options ALL,0 11,5 20,5 17,5 23,5 26,5 28,5 44,5 55,5 61,5 78,5 83,5
</I>&gt;<i> 
</I>&gt;<i> # Debug ACL issues
</I>&gt;<i> #debug_options ALL,1 28,4
</I>&gt;<i> 
</I>&gt;<i> # Debug ACL issues full access
</I>&gt;<i> #debug_options ALL,1 28,2 28,9
</I>&gt;<i> 
</I>&gt;<i> # Setup our local networks ACLs
</I>&gt;<i> acl VPN_Net src 10.1.2.0/24
</I>&gt;<i> acl No_Auth_Net src 10.10.1.0/24
</I>&gt;<i> acl Android_Server src 10.10.1.1/32
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80    # http
</I>&gt;<i> acl Safe_ports port 443   # https
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Custom acl for Telmate-controlled sites
</I>&gt;<i> acl telmate_domains dstdomain .telmate.com .telmate.cc
</I>&gt;<i> request_header_add ****************************
</I>&gt;<i> request_header_add **********************
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Content filtering
</I>&gt;<i> #
</I>&gt;<i> icap_enable on
</I>&gt;<i> 
</I>&gt;<i> # unlimited icap failure
</I>&gt;<i> icap_service_failure_limit -1
</I>&gt;<i> icap_retry allow all
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_retry_limit -1
</I>&gt;<i> 
</I>&gt;<i> icap_service service_req reqmod_precache bypass=0 <A HREF="icap://">icap://</A>
</I>&gt;<i> 127.0.0.1:1344/request
</I>&gt;<i> adaptation_access service_req allow VPN_Net !CONNECT
</I>&gt;<i> 
</I>&gt;<i> icap_service service_resp respmod_precache bypass=0 <A HREF="icap://">icap://</A>
</I>&gt;<i> 127.0.0.1:1344/response
</I>&gt;<i> adaptation_access service_resp allow VPN_Net
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from Android Server
</I>&gt;<i> http_access allow Android_Server manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>
In 3.5 move the manager stuff down below the CONNECT line...

&gt;<i> # Deny requests to ports we don't allow
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>
... here. It is a small bit faster that way.

&gt;<i> # URL Filtering
</I>&gt;<i> 
</I>&gt;<i> # acl No_Auth_Whitelist dstdomain &quot;/etc/squid3/approved-sites.squid&quot;
</I>&gt;<i> acl No_Auth_Whitelist dstdomain &quot;/etc/squid3/no-auth-approved-sites.squid&quot;
</I>&gt;<i> 
</I>&gt;<i> # dedicated, no exception URL blacklist managed by chef only
</I>&gt;<i> acl blacklist-urls url_regex &quot;/etc/squid3/blacklist-urls.squid&quot;
</I>&gt;<i> http_access deny blacklist-urls
</I>&gt;<i> 
</I>&gt;<i> # Allow localhost access in case of misconfigured application
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # Allow No_Auth_Net access to only the No auth whitelist
</I>&gt;<i> http_access allow No_Auth_Whitelist No_Auth_Net
</I>&gt;<i> 
</I>&gt;<i> # CONNECT method requests only have an IP address, allow all SSL CONNECT
</I>&gt;<i> handshakes
</I>&gt;<i> http_access allow No_Auth_Net CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Allow VPN_Net to anything as ICAP will be consulted for approval
</I>&gt;<i> http_access allow VPN_Net
</I>&gt;<i> 
</I>&gt;<i> # Default catch all to deny access not specifically granted
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Squid proxy interception config
</I>&gt;<i> http_port 10.10.1.1:3128
</I>&gt;<i> http_port 10.10.1.1:3126 intercept
</I>&gt;<i> https_port 10.10.1.1:3127 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/telmate-gk-CA.pem
</I>&gt;<i> 
</I>&gt;<i> # Proxy public hiding, don't tell site we are using a proxy
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for off
</I>&gt;<i> 
</I>&gt;<i> # ssl-bump goodies
</I>&gt;<i> always_direct allow all
</I>
Obsolete 3.1 hack for client-first SSL-Bump. Remove.

&gt;<i> ssl_bump server-first all
</I>
Deprecated bumping rules. Please update this to the 3.5 feature syntax.

IIRC, the 3.5 equivalent of the above line is:
 ssl_bump stare all
 ssl_bump bump all


&gt;<i> 
</I>&gt;<i> # the following two options are unsafe and not always necessary:
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>&gt;<i> # Prepare ssl_db: Done in Chef
</I>&gt;<i> # /usr/lib/squid3/ssl_crtd3 -c -s /var/spool/squid3/ssl_db -M 4MB
</I>&gt;<i> # chown -R proxy:proxy /var/spool/squid3/ssl_db
</I>&gt;<i> sslcrtd_program /usr/lib/squid3/ssl_crtd3 -s /var/spool/squid3/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 32 startup=5 idle=1
</I>&gt;<i> 
</I>&gt;<i> # Shutdown Squid after 2 seconds to flush current connections, default is 10
</I>&gt;<i> shutdown_lifetime 2 seconds
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the cache dir
</I>&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;<i> 
</I>&gt;<i> # Object size and lifetime settings
</I>&gt;<i> cache_mem 256 MB
</I>&gt;<i> maximum_object_size 1024 MB
</I>&gt;<i> range_offset_limit 200 MB
</I>

Since rock cache also breaks objects down into chunks of ~32KB it is
inefficient for large MB (or GB) sized objects. That is not going to do
much good for CPU performance.


&gt;<i> quick_abort_min -1
</I>&gt;<i> read_ahead_gap 50 MB
</I>&gt;<i> 
</I>
So 50+ MB of buffer per client connection.

 How many connections per second does your proxy service?
 How many of those are concurrent after this &quot;1 hour&quot; ?

  200 clients x 50 MB buffer =&gt; up to 10 GB of buffered data.
 Easily more than the ~3 GB RAM this machine might have spare.
 And thats assuming just one connection per client, usually browser
clients have 8-100 connections open at a time.
 There is a good reason the default 'gap' is set to 64KB :-)


If Squid starts to use swap memory performance does down the drain,
really, really badly.


&gt;<i> # cache the health_check to give poor snap a break :(
</I>&gt;<i> refresh_pattern ^<A HREF="https://*************/health_check">https://*************/health_check</A> 10 80% 30
</I>&gt;<i> override-expire override-lastmod ignore-reload ignore-no-store
</I>&gt;<i> ignore-must-revalidate ignore-private ignore-auth store-stale
</I>
Ah, you know that 30 means *minutes* right?

So the health checker will have a 30min delay between identifying
problems. Or counterwise, a 30min delay before identiying problems resolved.


&gt;<i> 
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0%  0
</I>&gt;<i> refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|
</I>&gt;<i> swf|flv|x-flv|mpg|wma|ogg|wmv|asx|asf)$ 260000 90% 260009 override-expire
</I>&gt;<i> refresh_pattern -i zip$ 432000 100% 864000 override-expire
</I>
You seem to be trying to cache video and multimedia objects in a
default/small RAM cache and a rock cache.

rock cache type is optimized for use caching very small objects in the
order of KB at most. While it can store larger ones now, that is quite
inefficient use of the rock cache design.

UFS/AUFS/diskd are the cache types to use for large MB/GB sized objects.


&gt;<i> refresh_pattern .   0 20% 4320
</I>&gt;<i> 
</I>&gt;<i> # Logging
</I>&gt;<i> # Following logformat WITH request headers, VERY chatty, debug only
</I>&gt;<i> # logformat squid %tl %5trms %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %&gt;ru %mt %&gt;ha
</I>&gt;<i> logformat squid-full %tl %5trms %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %&gt;ru %mt
</I>&gt;<i> logformat squid %tl %5trms %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %mt
</I>
Re-defining the built-in &quot;squid&quot; format does not do what you expect, and
is yet another drain on the CPU.

&gt;<i> # Log query params for telmate traffic only
</I>&gt;<i> access_log daemon:/var/log/squid3/telmate.log squid-full telmate_domains
</I>&gt;<i> access_log daemon:/var/log/squid3/access.log squid
</I>&gt;<i> 
</I>&gt;<i> # Cache_dir must be after maximum_object_size
</I>&gt;<i> cache_dir rock /var/spool/squid3 51200
</I>&gt;<i> 
</I>
HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013644.html">[squid-users] 100% cpu after about an hour
</A></li>
	<LI>Next message (by thread): <A HREF="013646.html">[squid-users] this is definitely the coolest stuff ever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13645">[ date ]</a>
              <a href="thread.html#13645">[ thread ]</a>
              <a href="subject.html#13645">[ subject ]</a>
              <a href="author.html#13645">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
