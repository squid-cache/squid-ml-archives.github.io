<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bad HTTP requests trigger ICAP suspension
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bad%20HTTP%20requests%20trigger%20ICAP%20suspension&In-Reply-To=%3C036c916d-57d7-58ae-f9cb-b28c7a8e7f4b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013662.html">
   <LINK REL="Next"  HREF="013665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bad HTTP requests trigger ICAP suspension</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bad%20HTTP%20requests%20trigger%20ICAP%20suspension&In-Reply-To=%3C036c916d-57d7-58ae-f9cb-b28c7a8e7f4b%40treenet.co.nz%3E"
       TITLE="[squid-users] Bad HTTP requests trigger ICAP suspension">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec  5 12:58:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013662.html">[squid-users] Bad HTTP requests trigger ICAP suspension
</A></li>
        <LI>Next message (by thread): <A HREF="013665.html">[squid-users] Bad HTTP requests trigger ICAP suspension
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13664">[ date ]</a>
              <a href="thread.html#13664">[ thread ]</a>
              <a href="subject.html#13664">[ subject ]</a>
              <a href="author.html#13664">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/12/2016 11:17 p.m., Silamael wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> We are using the ICAP services of Squid for filtering HTTP-Requests. Now
</I>&gt;<i> we encountered the problem that a buggy? web application creates
</I>&gt;<i> requests with an URL with the hostname set to '.'.
</I>
Ok.

&gt;<i> These bad requests than cause the suspension of the whole ICAP service
</I>&gt;<i> which then causes the bypass of the URL filtering as the ICAP service
</I>&gt;<i> has bypass=yes configured.
</I>
These are not exactly bad requests. '.' is a valid URL host segment.
Very much not likely to succeed in todays Internet, but still valid.

In DNS terms it means the root zone server is the origin host. However,
there is no requirement that hostnames resolve using DNS. So it may have
another meaning if passed to a service that resolves it differently (eg.
the /etc/hosts mapping, or your ICAP service).

There may or may not be bugs in the ICAP service itself handling that
weird input. I can't speak for that software.


&gt;<i> This sounds somehow wrong to me, the ICAP service doesn't have a
</I>&gt;<i> problem, just the HTTP request being forwarded is borken. Therefor is no
</I>
The ICAP service appears to be producing URLs without any host segment
at all (&quot;&quot;) instead of using the input &quot;.&quot; or some other value of its
choosing.

Strictly speaking Squid should accept that as a URL with no hostname,
just like it accepted the odd '.' hostname. That is one of the issues
bug 1961 seeks to fix.


&gt;<i> need to suspend the ICAP service at a whole for 30 seconds.
</I>&gt;<i> Am I wrong or is this behavior intended?
</I>&gt;<i> 
</I>
AIUI, for installations using bypass=yes the behaviour is expected. That
setting is not tied to particular types of error, it simply means the
service is optional. *any* HTTP request (even good ones) can bypass.


There is an interoperability issue between Squid and the ICAP service
causing the transaction to break down. The proper handling seems to
happen after that.


&gt;<i> This are the log messages:
</I>&gt;<i> 2016/11/28 13:30:00 kid1| SECURITY ALERT: Missing hostname in URL
</I>&gt;<i> '<A HREF="http:///?_task=mail&amp;_id=xxxxxxxxxxx&amp;_action=display-attachment&amp;_file=rcmfilexxxxxxxxxxxxxxxxxxxxx">http:///?_task=mail&amp;_id=xxxxxxxxxxx&amp;_action=display-attachment&amp;_file=rcmfilexxxxxxxxxxxxxxxxxxxxx</A>'.
</I>&gt;<i> see access.log for details.
</I>&gt;<i> 2016/11/28 13:30:00.740 kid1| 0,3| src/base/TextException.cc(87) Throw:
</I>&gt;<i> src/adaptation/icap/ModXact.cc:970:exception:
</I>&gt;<i> adapted.header-&gt;parse(&amp;httpBuf, true, &amp;error)
</I>&gt;<i> 2016/11/28 13:30:00.740 kid1| suspending ICAP service for too many failures
</I>&gt;<i> 2016/11/28 13:30:00.740 kid1| optional ICAP service is suspended:
</I>&gt;<i> <A HREF="icap://XXX.XXX.XXX.XXX:1344/reqmod">icap://XXX.XXX.XXX.XXX:1344/reqmod</A> [down,susp,fail11]
</I>&gt;<i> 
</I>
IIRC that &quot;fail11&quot; means the service repeatedly failed (11 times) before
it got suspended for 30sec. Presumably those were 10 bypasses and one
final 'I give up -&gt; suspend' from Squid.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013662.html">[squid-users] Bad HTTP requests trigger ICAP suspension
</A></li>
	<LI>Next message (by thread): <A HREF="013665.html">[squid-users] Bad HTTP requests trigger ICAP suspension
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13664">[ date ]</a>
              <a href="thread.html#13664">[ thread ]</a>
              <a href="subject.html#13664">[ subject ]</a>
              <a href="author.html#13664">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
