<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPv6 support for PF interception
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv6%20support%20for%20PF%20interception&In-Reply-To=%3C4ef91bbc-bcd0-fd0b-022c-7c2a8bf5dec6%40egervary.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013684.html">
   <LINK REL="Next"  HREF="013671.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPv6 support for PF interception</H1>
    <B>Egerv&#225;ry Gergely</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv6%20support%20for%20PF%20interception&In-Reply-To=%3C4ef91bbc-bcd0-fd0b-022c-7c2a8bf5dec6%40egervary.hu%3E"
       TITLE="[squid-users] IPv6 support for PF interception">gergely at egervary.hu
       </A><BR>
    <I>Mon Dec  5 18:34:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013684.html">[squid-users] TCP_MISS/419
</A></li>
        <LI>Next message (by thread): <A HREF="013671.html">[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13669">[ date ]</a>
              <a href="thread.html#13669">[ thread ]</a>
              <a href="subject.html#13669">[ subject ]</a>
              <a href="author.html#13669">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

So, do you want IPv4/IPv6 dual-stacked transparent interception on your
NetBSD box? Unfortunately, you are out of luck.

On NetBSD, we have three choices for packet filtering:

- Darren Reed's &quot;IPFilter&quot;. It has known bugs for years, and looks
abandoned.

- OpenBSD's &quot;PF&quot;. It's NetBSD port is very outdated, and porting newer
version of PF is abandoned by NetBSD developers. Squid has support for
PF interception for IPv4 only. (Newer OpenBSD PF supports IPv6 with
TPROXY, but TPROXY is not supported by NetBSD version of PF)

- NetBSD's &quot;NPF&quot;. It's quite new, and missing features like TPROXY /
divert sockets support, and Squid does not have interception code for
it.

We start working on NPF intercept support, but there's no working code
yet. Until then, I have prepared a very simple patch for Squid -
enabling IPv6 for PF interception. It works for me on my NetBSD 7-STABLE
box.

Please review and test it, especially on OpenBSD and newer PF versions.
If it's approiate, please commit it.

Thank you.

--- Intercept.cc.orig   2016-10-09 21:58:01.000000000 +0200
+++ Intercept.cc        2016-12-02 22:57:24.000000000 +0100
@@ -336,13 +336,20 @@
      }

      memset(&amp;nl, 0, sizeof(struct pfioc_natlook));
-    newConn-&gt;remote.getInAddr(nl.saddr.v4);
-    nl.sport = htons(newConn-&gt;remote.port());

-    newConn-&gt;local.getInAddr(nl.daddr.v4);
+    if (newConn-&gt;remote.isIPv6()) {
+        newConn-&gt;remote.getInAddr(nl.saddr.v6);
+        newConn-&gt;local.getInAddr(nl.daddr.v6);
+        nl.af = AF_INET6;
+    } else {
+        newConn-&gt;remote.getInAddr(nl.saddr.v4);
+        newConn-&gt;local.getInAddr(nl.daddr.v4);
+        nl.af = AF_INET;
+    }
+
+    nl.sport = htons(newConn-&gt;remote.port());
      nl.dport = htons(newConn-&gt;local.port());

-    nl.af = AF_INET;
      nl.proto = IPPROTO_TCP;
      nl.direction = PF_OUT;

@@ -358,7 +365,11 @@
          debugs(89, 9, HERE &lt;&lt; &quot;address: &quot; &lt;&lt; newConn);
          return false;
      } else {
-        newConn-&gt;local = nl.rdaddr.v4;
+        if (newConn-&gt;remote.isIPv6()) {
+            newConn-&gt;local = nl.rdaddr.v6;
+        } else {
+            newConn-&gt;local = nl.rdaddr.v4;
+        }
          newConn-&gt;local.port(ntohs(nl.rdport));
          debugs(89, 5, HERE &lt;&lt; &quot;address NAT: &quot; &lt;&lt; newConn);
          return true;


-- 
Gergely EGERVARY

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013684.html">[squid-users] TCP_MISS/419
</A></li>
	<LI>Next message (by thread): <A HREF="013671.html">[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13669">[ date ]</a>
              <a href="thread.html#13669">[ thread ]</a>
              <a href="subject.html#13669">[ subject ]</a>
              <a href="author.html#13669">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
