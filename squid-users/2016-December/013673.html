<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20for%20Business%20behind%20a%20transparent%20squid%0A%20%28TProxy%29%20HTTP/S&In-Reply-To=%3C98160ea5-dadb-72fb-6e69-abc3ec0bd69b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013717.html">
   <LINK REL="Next"  HREF="013691.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20for%20Business%20behind%20a%20transparent%20squid%0A%20%28TProxy%29%20HTTP/S&In-Reply-To=%3C98160ea5-dadb-72fb-6e69-abc3ec0bd69b%40treenet.co.nz%3E"
       TITLE="[squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec  5 23:35:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013717.html">[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
</A></li>
        <LI>Next message (by thread): <A HREF="013691.html">[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13673">[ date ]</a>
              <a href="thread.html#13673">[ thread ]</a>
              <a href="subject.html#13673">[ subject ]</a>
              <a href="author.html#13673">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/12/2016 11:46 a.m., Sameh Onaissi wrote:
&gt;<i>
</I>&gt;<i> I have a Ubuntu 16.04 server with Squid 3.5.22 installed. It acts as a 
</I>&gt;<i> gateway in a LAN.
</I>&gt;<i>
</I>&gt;<i> It is configured to intercept HTTP and HTTPS traffic (Transparent). So 
</I>&gt;<i> iptables redirects were used for ports 80 and 443.
</I>&gt;<i> The server runs two scripts:
</I>&gt;<i> _*nat.sh*_ to bridge the two network cards, allowing LAN computers 
</I>&gt;<i> access to the internet through the servers Internet interface card.
</I>&gt;<i> *_iptables.sh_* which defines the ip rules and port forwarding: 
</I>&gt;<i> <A HREF="http://pastebin.com/SqpbmYQQ">http://pastebin.com/SqpbmYQQ</A>
</I>&gt;<i>
</I>&gt;<i> BEFORE RUNNING iptables.sh...
</I>&gt;<i>
</I>&gt;<i> When I connect a LAN computer to it, everything works as expected. 
</I>&gt;<i> Complete Internet access with some HTTP and HTTPS domains 
</I>&gt;<i> blocked/redirected to another page. Skype for Business logs in 
</I>&gt;<i> successfully.
</I>&gt;<i>
</I>&gt;<i> AFTER RUNNING iptables.sh
</I>&gt;<i> Skype for Business disconnects, and fails to re-connect, normal skype 
</I>&gt;<i> works just fine.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I revised: 
</I>&gt;<i> <A HREF="https://support.office.com/en-us/article/Create-DNS-records-at-eNomCentral-for-Office-365-a6626053-a9c8-445b-81ee-eeb6672fae77?ui=en-US&amp;rs=en-US&amp;ad=US#bkmk_verify">https://support.office.com/en-us/article/Create-DNS-records-at-eNomCentral-for-Office-365-a6626053-a9c8-445b-81ee-eeb6672fae77?ui=en-US&amp;rs=en-US&amp;ad=US#bkmk_verify</A> And 
</I>&gt;<i> added all DNS configurations on enom.
</I>&gt;<i>
</I>&gt;<i> That got rid of the DNS error I was getting to another error saying 
</I>&gt;<i> service is temporarily unavailable.
</I>&gt;<i>
</I>&gt;<i> Any suggestions to why this is happening? Any solutions?
</I>
Skype is sending something that is not HTTPS over port 443. The 
on_unsupported_protocol feature in Squid-4 is needed to tunnel Skype 
traffic when intercepting port 443.

&gt;<i>
</I>&gt;<i> *Note:* both router and Ubuntu's WAN interface use Google's 8.8.8.8 DNS
</I>&gt;<i>
</I>
I hope that means the border router is providing DNS recursive lookup 
with 8.8.8.8 as the parent, with LAN devices using that border router as 
their DNS server. That will minimize the damage Google is causing, but 
not avoid it completely. If not you should make it so, or at least place 
another shared resolver somewhere to do the necessary DNS caching.


*Amos

*

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013717.html">[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
</A></li>
	<LI>Next message (by thread): <A HREF="013691.html">[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13673">[ date ]</a>
              <a href="thread.html#13673">[ thread ]</a>
              <a href="subject.html#13673">[ subject ]</a>
              <a href="author.html#13673">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
