<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20for%20Business%20behind%20a%20transparent%20squid%0A%09%28TProxy%29%20HTTP/S&In-Reply-To=%3C04b301d250cf%246f3089b0%244d919d10%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013713.html">
   <LINK REL="Next"  HREF="013716.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20for%20Business%20behind%20a%20transparent%20squid%0A%09%28TProxy%29%20HTTP/S&In-Reply-To=%3C04b301d250cf%246f3089b0%244d919d10%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Skype for Business behind a transparent squid	(TProxy) HTTP/S">eliezer at ngtech.co.il
       </A><BR>
    <I>Wed Dec  7 21:18:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013713.html">[squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S
</A></li>
        <LI>Next message (by thread): <A HREF="013716.html">[squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13714">[ date ]</a>
              <a href="thread.html#13714">[ thread ]</a>
              <a href="subject.html#13714">[ subject ]</a>
              <a href="author.html#13714">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Try to load these iptables rues using &quot;iptables-restore &lt; file.txt&quot;
<A HREF="http://pastebin.com/mYsqu8D7">http://pastebin.com/mYsqu8D7</A>

You are either running the script wrongly or my script is wrong.
Is this a trial or a production system?
It seems to me that you need to first test and resolve the iptables and
squid setup and then add my script to it.
What OS are you using?(sorry if I don't remember).

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Wednesday, December 7, 2016 10:11 PM
To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S

iptables is the same.. here is after I ran the script twice (with and
without proxy) 
<A HREF="http://pastebin.com/YFtbG6St">http://pastebin.com/YFtbG6St</A>


I have a script that bridges the two network cards, that uses nat, hence
having both

I can send you all the scripts I run to set up squid and the bypasses so you
can reproduce the situation.

thanks again!



Piensa en el medio ambiente antes de imprimir este email. 

On Dec 7, 2016, at 12:12 PM, Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
wrote:

Are you sure this setup works?
You have both REDIRECT and TPROXY on the same machine so you need to bypass
for both of these.
Is this iptables-save snapshot after you ran the script?
Also for this to work you will need to use the updated version of the script
at:
<A HREF="https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b">https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b</A>

And run it twice... once with tproxy and the other without tproxy.
After you run the script share the snapshot of &quot;iptables-save&quot; and &quot;ipset
list&quot;.
If it can be reproducible here when I will be using SKYPE I would be able to
test it but I believe it should work good enough to minimize the issue.
The above depends only on one thing: NTOP Skype networks identification.
Maybe I have mentioned but there is another script which I wrote that is
more simplified at:
<A HREF="https://gist.github.com/elico/e0faadf0cc63942c5aaade808a87deef">https://gist.github.com/elico/e0faadf0cc63942c5aaade808a87deef</A>

But can be adapted to be used against skype known domains.
The next level would be to use some kind of splice rules with an
external_acl helper.
The external_acl helper can receive information from squid about the request
SNI and to verify if the server only serves skype domains or others.
The above is a much more deeper level and I think that the first scripts
should be enough to resolve most of the issues.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Wednesday, December 7, 2016 6:09 PM
To: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S

iptables-save: &#160;<A HREF="http://pastebin.com/9JrVANtt">http://pastebin.com/9JrVANtt</A>

ipset list :&#160;<A HREF="http://pastebin.com/wtMtzaQe">http://pastebin.com/wtMtzaQe</A>
<A HREF="http://pastebin.com/wtMtzaQe">http://pastebin.com/wtMtzaQe</A>
<A HREF="http://pastebin.com/wtMtzaQe">http://pastebin.com/wtMtzaQe</A>
pastebin.com

<A HREF="http://pastebin.com/9JrVANtt">http://pastebin.com/9JrVANtt</A>
<A HREF="http://pastebin.com/9JrVANtt">http://pastebin.com/9JrVANtt</A>
pastebin.com


&#160;&#160;Piensa en el medio ambiente antes de imprimir este email.
________________________________________
From: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Sent: Wednesday, December 7, 2016 10:58:18 AM
To: Sameh Onaissi
Cc: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: RE: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S 
&#160;
Give us the &quot;iptables-save&quot; output and also &quot;ipset list&quot;.
(or what ever was the command of ipset to dump the content of the list).
After this we can understand what is causing this issue.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Wednesday, December 7, 2016 5:23 PM
To: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S

Still not working and I do not know what to do next. 

access.log shows IPs and domains that are supposed to be bypassed already.

Any further instructions are hugely appreciated.



Piensa en el medio ambiente antes de imprimir este email. 

On Dec 7, 2016, at 9:50 AM, Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
wrote:

Was there any progress with the script and the issues?

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Wednesday, December 7, 2016 12:36 AM
To: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: 'Amos Jeffries' &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;;
mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S


Hello Eliezer and thanks again.

I ran the script with the tproxy argument.

Tried to reconnect skype for business...&#160;

After about a 3 min wait, a pop up saying &quot;Skype for Business couldn't find
a skype for business server&quot;&#160;&#160;and&#160;access log shows:&#160;

1481061269.006 &#160; &#160;400 10.0.0.38 TCP_MISS/200 1068 GET
<A HREF="http://lyncdiscover.solcv.com/?">http://lyncdiscover.solcv.com/?</A> - ORIGINAL_DST/132.245.1.28
application/vnd.microsoft.rtc.autodiscover+xml
1481061269.270 &#160; &#160;667 10.0.0.38 TAG_NONE/200 0 CONNECT 132.245.1.28:443 -
HIER_NONE/- -
1481061269.270 &#160; &#160;665 10.0.0.38 TCP_TUNNEL/200 5568 CONNECT
lyncdiscover.solcv.com:443 - ORIGINAL_DST/132.245.1.28 -
1481061269.770 &#160; &#160;596 10.0.0.38 TAG_NONE/200 0 CONNECT 52.112.64.14:443 -
HIER_NONE/- -
1481061269.770 &#160; &#160;594 10.0.0.38 TCP_TUNNEL/200 6981 CONNECT
webdir0a.online.lync.com:443 - ORIGINAL_DST/52.112.64.14 -
1481061270.679 &#160; &#160;897 10.0.0.38 TAG_NONE/200 0 CONNECT 52.112.64.14:443 -
HIER_NONE/- -
1481061270.679 &#160; &#160;895 10.0.0.38 TCP_TUNNEL/200 7733 CONNECT
webdir0a.online.lync.com:443 - ORIGINAL_DST/52.112.64.14 -
1481061272.178 &#160; &#160;841 10.0.0.38 TAG_NONE/200 0 CONNECT 23.100.120.65:443 -
HIER_NONE/- -
1481061272.178 &#160; &#160;840 10.0.0.38 TCP_TUNNEL/200 20539 CONNECT
login.microsoftonline.com:443 - ORIGINAL_DST/23.100.120.65 -
1481061273.713 &#160; &#160;641 10.0.0.38 TAG_NONE/200 0 CONNECT 52.112.64.14:443 -
HIER_NONE/- -
1481061273.713 &#160; &#160;640 10.0.0.38 TCP_TUNNEL/200 8037 CONNECT
webdir0a.online.lync.com:443 - ORIGINAL_DST/52.112.64.14 -
1481061273.751 &#160; 3054 10.0.0.38 TAG_NONE/200 0 CONNECT 52.112.64.14:443 -
HIER_NONE/- -
1481061273.751 &#160; 3052 10.0.0.38 TCP_TUNNEL/200 24458 CONNECT
webdir0a.online.lync.com:443 - ORIGINAL_DST/52.112.64.14 -
1481061273.751 &#160; 1544 10.0.0.38 TAG_NONE/200 0 CONNECT 52.112.64.14:443 -
HIER_NONE/- -
1481061273.751 &#160; 1543 10.0.0.38 TCP_TUNNEL/200 11653 CONNECT
webdir0a.online.lync.com:443 - ORIGINAL_DST/52.112.64.14 -


so I added more ip ranges to the cidr-to-bypass.txt and ran the script again


1481063243.370 &#160; &#160;371 10.0.0.38 TCP_MISS/200 1068 GET
<A HREF="http://lyncdiscover.solcv.com/?">http://lyncdiscover.solcv.com/?</A> - ORIGINAL_DST/134.170.113.210
application/vnd.microsoft.rtc.autodiscover+xml
1481063278.271 &#160;74233 10.0.0.38 TAG_NONE/200 0 CONNECT 104.208.31.113:443 -
HIER_NONE/- -
1481063278.271 &#160;74231 10.0.0.38 TCP_TUNNEL/200 6746 CONNECT
pipe.skype.com:443 - ORIGINAL_DST/104.208.31.113 -
1481063344.143 &#160;60720 10.0.0.38 TAG_NONE/200 0 CONNECT 104.208.31.113:443 -
HIER_NONE/- -
1481063344.143 &#160;60719 10.0.0.38 TCP_TUNNEL/200 6389 CONNECT
pipe.skype.com:443 - ORIGINAL_DST/104.208.31.113 -

a new set showed up...

what more can we do?

keep adding ip ranges?

thanks

&#160;&#160;Piensa en el medio ambiente antes de imprimir este email.
________________________________________
From: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Sent: Tuesday, December 6, 2016 4:36:56 PM
To: Sameh Onaissi
Cc: 'Amos Jeffries'; mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: RE: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S 
&#160;
Try the next script:
<A HREF="https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b">https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b</A> 
<A HREF="https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b">https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b</A>
<A HREF="https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b">https://gist.github.com/elico/a54c2c8f8e1a2407b42210896b960f4b</A>
gist.github.com
bypass squid interception for skype



It has two modes: regular and tproxy.
In your case you should run the script with:
$ bypass-skype-cidr.sh tproxy

The tproxy flag should do the trick for you.

Let me know if it works for you.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Tuesday, December 6, 2016 9:24 PM
To: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: Amos Jeffries &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;;
mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S

Yes please, I would appreciate help with that script.&#160; 

As I aforementioned, totally new to all this



Piensa en el medio ambiente antes de imprimir este email. 

On Dec 6, 2016, at 1:27 PM, Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
wrote:

Now you can enhance the script by adding manually the ntop skype related
networks based on:
<A HREF="https://github.com/ntop/nDPI/blob/d9a2d9a6bd4d476d666d26cb713952760a975d92/s">https://github.com/ntop/nDPI/blob/d9a2d9a6bd4d476d666d26cb713952760a975d92/s</A>
rc/lib/ndpi_content_match.c.inc#L286

/*
Skype (Microsoft CDN)
157.56.135.64/26, 157.56.185.0/26, 157.56.52.0/26,
157.56.53.128/25, 157.56.198.0/26
157.60.0.0/16, 157.54.0.0/15 
13.107.3.128/32
13.107.3.129/32
111.221.64.0 - 111.221.127.255
91.190.216.0/21 (AS198015 Skype Communications Sarl)
91.190.218.0/24
40.126.129.109/32
65.55.223.0/26
*/

If you need help scripting this let me know.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Tuesday, December 6, 2016 7:29 PM
To: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: Amos Jeffries &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;;
mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S

Hello, 

OK, I added the ssl_bump slice on the skype domains text file
I installed ipset and ran the script.

Now access.log has much less skype related logs:

What is left is:
1481044996.398&#160;&#160; 3412 10.0.0.11 TAG_NONE/200 0 CONNECT 132.245.1.32:443 -
ORIGINAL_DST/132.245.1.32 -
1481044996.423&#160;&#160;&#160;&#160;&#160; 0 10.0.0.11 TAG_NONE/400 3998 REGISTER
sip:solcv.comSIP/2.0 - HIER_NONE/- text/html
1481045000.296&#160;&#160;&#160; 372 10.0.0.11 TAG_NONE/200 0 CONNECT 134.170.113.207:443 -
ORIGINAL_DST/134.170.113.207 -
1481045000.325&#160;&#160;&#160;&#160;&#160; 0 10.0.0.11 TAG_NONE/400 3998 REGISTER
sip:solcv.comSIP/2.0 - HIER_NONE/- text/html
1481045008.685&#160;&#160; 4259 10.0.0.11 TAG_NONE/200 0 CONNECT 134.170.113.207:443 -
ORIGINAL_DST/134.170.113.207 -
1481045008.726&#160;&#160;&#160;&#160;&#160; 0 10.0.0.11 TAG_NONE/400 3998 REGISTER
sip:solcv.comSIP/2.0 - HIER_NONE/- text/html


although <A HREF="http://solve.com">http://solve.com</A> is in the text file.

I ran whois on the first IP and got:

NetRange:&#160;&#160;&#160;&#160;&#160;&#160; 132.245.0.0 - 132.245.255.255
CIDR:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 132.245.0.0/16
NetName:&#160;&#160;&#160;&#160;&#160;&#160;&#160; MICROSOFT


Same with the 134.170. address. Can we slice that range?





Sameh Onaissi
Ingeniero de Soporte
Sol Cable Visi&#243;n
Cel: 316-3023424
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>



Piensa en el medio ambiente antes de imprimir este email. 

On Dec 6, 2016, at 12:11 PM, Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
wrote:

Hey,

Depends on your OS you will need to installthe&#160; ipset package.
Try to run &quot;apt-get install ipset&quot;.
And then run the script.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
&lt;Untitled Attachment 1.jpg&gt;

From: Sameh Onaissi [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sameh.onaissi at solcv.com</A>] 
Sent: Tuesday, December 6, 2016 5:23 PM
To: Amos Jeffries &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
Cc: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Subject: Re: [squid-users] Skype for Business behind a transparent squid
(TProxy) HTTP/S

Amos, thanks for the reply. 


This is getting more confusing.

I changed the script to: <A HREF="http://pastebin.com/jLgywstg">http://pastebin.com/jLgywstg</A>

And I ran it, but I am getting errors:

sudo sh <A HREF="http://bypass.sh/">http://bypass.sh/</A> + iptables -t mangle -L PREROUTING + grep
bypasspool + [ 1 -ne 0 ] + iptables -t mangle -I PREROUTING -m set
--match-set bypasspool dst,src -j DIVERT iptables <A HREF="http://v1.6.0/">http://v1.6.0/</A> Set
bypasspool doesn't exist. Try `iptables -h' or 'iptables --help' for more
information. + ipset create bypasspool hash:ip <A HREF="http://bypass.sh/">http://bypass.sh/</A> 10:
<A HREF="http://bypass.sh/">http://bypass.sh/</A> ipset: not found + read item +
<A HREF="echohttp://lyncdiscover.solcv.com/">echohttp://lyncdiscover.solcv.com/</A> <A HREF="http://lyncdiscover.solcv.com/">http://lyncdiscover.solcv.com/</A> + host -4
<A HREF="http://lyncdiscover.solcv.com/">http://lyncdiscover.solcv.com/</A> + grep has address + awk {print $4} + xargs
-l1 ipset add bypasspool xargs: ipset: No such file or directory + read item
+ echo <A HREF="http://webdir0a.online.lync.com/http://webdir0a.online.lync.com/">http://webdir0a.online.lync.com/http://webdir0a.online.lync.com/</A> +
host -4 <A HREF="http://webdir0a.online.lync.com/">http://webdir0a.online.lync.com/</A> + grep has address + awk {print $4}
+ xargs -l1 ipset add bypasspool xargs: ipset: No such file or directory

. this goes on the same for all the domains in the text file

My iptables is still &lt;<A HREF="http://pastebin.com/SqpbmYQQ">http://pastebin.com/SqpbmYQQ</A>&gt;

I did not quite understand what you meant by 
You should test whether -m set or -m socket work faster and put that one
first. My change above places it at line 2 (after -m socket) assuming
your iptables script is still &lt;<A HREF="http://pastebin.com/SqpbmYQQ">http://pastebin.com/SqpbmYQQ</A>&gt;

should I incorporate the bypass script into my iptables.sh script? run
iptables first then bypass?



On a side note, would adding ssl_bump exceptions to squid.conf do it?
Something like: 

acl skype_domains &lt;path to file&gt;
ssl_bump splice skype_domains
ssl_bump bump all



Again, thanks again for your help.



&lt;Untitled Attachment 2.jpg&gt; Piensa en el medio ambiente antes de imprimir
este email.

On Dec 6, 2016, at 9:50 AM, Amos Jeffries &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

On 7/12/2016 3:19 a.m., Sameh Onaissi wrote:
Hello,

I tried doing the changes to nat/REDIRECT in iptables.sh and I must have
messed up somewhere, so I am sticking with mangle/tproxy for now since squid
is working with them.

How can I change Eliezer's script to mangle/tproxy?
<A HREF="https://gist.github.com/elico/e0faadf0cc63942c5aaade808a87deef">https://gist.github.com/elico/e0faadf0cc63942c5aaade808a87deef</A>

Excuse my novice knowledge in iptables.

No worries.

You need to change where iptables attaches the 'bypasspool'. Both the
table/location (-t) and the jump/action (-j).

iptables -t mangle -L PREROUTING |grep bypasspool
if [ &quot;$?&quot; -ne &quot;0&quot; ];then

&#160; iptables -t mangle -I 2 PREROUTING \
&#160;&#160;&#160; -m set --match-set bypasspool dst,src \
&#160;&#160;&#160; -j DIVERT

fi

You should test whether -m set or -m socket work faster and put that one
first. My change above places it at line 2 (after -m socket) assuming
your iptables script is still &lt;<A HREF="http://pastebin.com/SqpbmYQQ">http://pastebin.com/SqpbmYQQ</A>&gt;

(Your script should do that line adding, not Eliezers - so that you can
be sure the order is always correct).


BTW: you should use iptables-save / iptables-restore instead of a slow
script calling iptables &quot;manually&quot;. Those other tools will ensure there
are no gaps in the firewall initialization for nasty traffic to sneak
through.

I am looking at access.log to collect all domains I see heading to skype for
business, as well as IPs. My question is, can I add the domains AND IPs into
the domains-to-bypass.txt that the above script uses?

IIRC you should be able to use domain as the parameter to ipset. But it
will resolve the domain immediately and only add those IPs that it finds
at that time into the pool. Any future changes, or a hidden set of IPs
that rotate in/out will not be listed.

Amos








</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013713.html">[squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S
</A></li>
	<LI>Next message (by thread): <A HREF="013716.html">[squid-users] Skype for Business behind a transparent squid (TProxy) HTTP/S
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13714">[ date ]</a>
              <a href="thread.html#13714">[ thread ]</a>
              <a href="subject.html#13714">[ subject ]</a>
              <a href="author.html#13714">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
