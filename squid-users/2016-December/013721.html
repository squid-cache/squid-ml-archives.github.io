<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL bump config or possible code issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20config%20or%20possible%20code%20issue&In-Reply-To=%3C7ec470d6-49fb-b08f-55e4-0002c73be1ab%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013720.html">
   <LINK REL="Next"  HREF="013724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL bump config or possible code issue</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20config%20or%20possible%20code%20issue&In-Reply-To=%3C7ec470d6-49fb-b08f-55e4-0002c73be1ab%40measurement-factory.com%3E"
       TITLE="[squid-users] SSL bump config or possible code issue">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec  8 16:41:31 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013720.html">[squid-users] SSL bump config or possible code issue
</A></li>
        <LI>Next message (by thread): <A HREF="013724.html">[squid-users] SSL bump config or possible code issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13721">[ date ]</a>
              <a href="thread.html#13721">[ thread ]</a>
              <a href="subject.html#13721">[ subject ]</a>
              <a href="author.html#13721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/08/2016 09:15 AM, Greg Saylor wrote:

&gt;<i> I'm trying to debug a situation where squid 3.4 would return a ERR_ACCESS_DENIED and version 3.5 does not.
</I>
I trust you use Squid v3.5.22 or later. Some v3.5 releases have serious
SslBump bugs so the minor version is important.


&gt;<i> I started looking at the source code between 3.4 and 3.5. In 3.5 there is this code in src/client_side_request.cc.
</I>&gt;<i> 
</I>&gt;<i>         if (sslBumpNeeded()) { 
</I>&gt;<i>             // We have to serve an error, so bump the client first.
</I>&gt;<i>             sslBumpNeed(Ssl::bumpClientFirst);
</I>&gt;<i>             // set final error but delay sending until we bump 
</I>...
&gt;<i>         } else  
</I>&gt;<i>             // send the error to the client now
</I>

&gt;<i> If I change:
</I>&gt;<i> 
</I>&gt;<i> if (sslBumpNeeded()) {
</I>&gt;<i> 
</I>&gt;<i> to:
</I>&gt;<i> 
</I>&gt;<i> if (sslBumpNeeded() &amp;&amp; 0) {
</I>&gt;<i> 
</I>&gt;<i> Then it correctly responds with ERR_ACCESS_DENIED.
</I>

Do you enable SslBump features in your Squid?

* If you did not enable SslBump and sslBumpNeeded() returns true, then
this is a Squid bug. If you can reproduce with the latest Squid v3.5 (or
later), please file a bug report.

* If you enabled SslBump, then Squid tries to bump the client connection
to serve the error message to the HTTPS client (because popular browsers
ignore errors delivered as CONNECT responses). I do not recall whether
Squid v3.4 did that, but that is pretty much irrelevant because v3.5
behavior is deliberate (that behavior may need more configuration
options, but that is unrelated to v3.4 anyway). There may be bugs with
that code path, but they are not related to the sslBumpNeeded() result
as such.


&gt;<i> It looks to me as if something is taking precedence over
</I>&gt;<i> calloutContext-&gt;error.  But even if it was not, because the request
</I>&gt;<i> is actually being processed it would allow a security hole where an
</I>&gt;<i> attacker could map a private internal network of https services based
</I>&gt;<i> on the time it takes them to respond - even if it allowed the
</I>&gt;<i> connection.
</I>
Agreed. If you are using SslBump, then, as the next step, I recommend
ignoring Squid code and clearly demonstrating that Squid forwards a
request that should be denied. A packet trace or Squid's HTTP request
printouts would be helpful for those of us who do not know what exactly
that &quot;socat&quot; command does in your environment, and what Squid does when
processing that traffic.

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013720.html">[squid-users] SSL bump config or possible code issue
</A></li>
	<LI>Next message (by thread): <A HREF="013724.html">[squid-users] SSL bump config or possible code issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13721">[ date ]</a>
              <a href="thread.html#13721">[ thread ]</a>
              <a href="subject.html#13721">[ subject ]</a>
              <a href="author.html#13721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
