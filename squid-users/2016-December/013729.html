<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent HTTPs proxy with Squid 3.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPs%20proxy%20with%20Squid%203.5&In-Reply-To=%3Ce9a871a6-d1cc-3dec-7c24-583abeabf9d1%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013727.html">
   <LINK REL="Next"  HREF="013733.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent HTTPs proxy with Squid 3.5</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPs%20proxy%20with%20Squid%203.5&In-Reply-To=%3Ce9a871a6-d1cc-3dec-7c24-583abeabf9d1%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent HTTPs proxy with Squid 3.5">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Dec 13 01:17:47 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013727.html">[squid-users] Transparent HTTPs proxy with Squid 3.5
</A></li>
        <LI>Next message (by thread): <A HREF="013733.html">[squid-users] Transparent HTTPs proxy with Squid 3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13729">[ date ]</a>
              <a href="thread.html#13729">[ thread ]</a>
              <a href="subject.html#13729">[ subject ]</a>
              <a href="author.html#13729">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/12/2016 5:11 a.m., Fomo Dong wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> For couple of days I'm trying to figure out how to get a transparent HTTPs
</I>&gt;<i> proxy to work with Squid. What I'm trying to achieve is a proxy that
</I>&gt;<i> accepts internet traffic from ports 80 &amp; 443, routes them through Squid to
</I>&gt;<i> Privoxy and finally through Tor and returns back the data. So essentially I
</I>&gt;<i> want to &quot;automatically&quot; revert some traffic through Tor without the user
</I>&gt;<i> needing to add a proxy to their connection.
</I>&gt;<i> 
</I>&gt;<i> I know how to setup the Privoxy and Tor part, but I'm struggling with the
</I>&gt;<i> Squid &amp; IP tables configuration.
</I>
The first thing to be aware of is that Squid obeys the HTTPS requirement
that traffic received on TLS connection also goes out one. So your
Privoxy must be capable of receiving TLS connections from Squid.

If Privoxy cannot do TLS like that you could have Squid do the privacy
filtering. But then Tor would face the same requirement.


Second thing I want to make clear is that a *transparent* proxy is the
opposite of anonyizing proxy. A transparent proxy hides *itself* while
_revealing_ the client.  An anonymous proxy reveals itself, while hiding
the client(s). They are almost direct opposites in behaviour.

Anyhow, what you meant by the word &quot;transparent&quot; turns out to actually
be &quot;intercepting&quot;. I hope that clarifies why 'tproxy' is definitely not
what you want to do here.



&gt;<i> Here is my setup
</I>&gt;<i> 
</I>&gt;<i> Download latest version
</I>&gt;<i> 
</I>&gt;<i> curl -O <A HREF="http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.22.tar.gz">http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.22.tar.gz</A>
</I>&gt;<i> &amp;&amp; tar zxvf squid-3.5.22.tar.gz &amp;&amp; cd squid-3.5.22
</I>&gt;<i> 
</I>&gt;<i> Install all needed packages
</I>&gt;<i> 
</I>&gt;<i> apt install devscripts build-essential openssl libssl-dev fakeroot
</I>&gt;<i> libcppunit-dev libsasl2-dev cdbs ccze libfile-readbackwards-perl
</I>&gt;<i> libcap2 libcap-dev libcap2-dev libnetfilter-conntrack-dev htop ccze
</I>&gt;<i> sysv-rc-conf -y
</I>&gt;<i> 
</I>&gt;<i> Configure the build and make and install
</I>&gt;<i> 
</I>&gt;<i> ./configure \
</I>&lt;snip&gt;
&gt;<i> --enable-err-languages=English \
</I>&gt;<i> --enable-default-err-language=English \
</I>&lt;snip&gt;

Those two saying &quot;English&quot; are not right. Squid uses ISO codes for
languages now. You can remove the above without affecting the build.

&gt;<i> 
</I>&gt;<i> Allow ip4 forwarding
</I>&gt;<i> 
</I>&gt;<i> echo -e &quot;net.ipv4.ip_forward = 1\nnet.ipv4.conf.default.rp_filter =
</I>&gt;<i> 0\nnet.ipv4.conf.all.rp_filter = 0\nnet.ipv4.conf.eth0.rp_filter =
</I>&gt;<i> 0\n&quot; &gt;&gt; /etc/sysctl.conf
</I>&gt;<i> 
</I>&gt;<i> Generate certificates
</I>&gt;<i> 
</I>&gt;<i> mkdir /etc/squid/ssl_certs &amp;&amp; cd /etc/squid/ssl_certs
</I>&gt;<i> openssl genrsa -out squid.key 2048
</I>&gt;<i> openssl req -new -key squid.key -out squid.csr -nodes
</I>&gt;<i> openssl x509 -req -days 3652 -in squid.csr -signkey squid.key -out squid.crt
</I>&gt;<i> cat squid.crt squid.key &gt; squid.pem
</I>&gt;<i> 
</I>&gt;<i> Generate certificate cache
</I>&gt;<i> 
</I>&gt;<i> mkdir /var/lib/squid &amp;&amp; chown -R proxy:proxy /var/lib/squid/
</I>&gt;<i> /usr/lib/squid/ssl_crtd -c -s /var/lib/squid/ssl_db
</I>&gt;<i> 
</I>&gt;<i> Change ownership and rights to folders
</I>&gt;<i> 
</I>&gt;<i> mkdir -p /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> chown -R proxy:proxy /etc/squid/squid.conf | chown -R proxy:proxy
</I>&gt;<i> /usr/lib/squid | chown -R proxy:proxy /var/lib/squid/ssl_db/ | chown
</I>&gt;<i> -R proxy:proxy /var/spool/squid | chown -R proxy:proxy /var/log/squid
</I>&gt;<i> | chmod 777 /var/spool/squid | chmod 777 /var/log/squid  | chmod 755
</I>&gt;<i> /var/lib/squid/ssl_db/certs | chown proxy:proxy /var/log/squid/
</I>&gt;<i> 
</I>
Er, I suggest you use '&amp;&amp;' or ';' between those instead of '|'.
chmod/chown do not take each others output as input.


Squid will be reading its config files as 'root', not as 'proxy'.

And you might want to rethink allowing world-writeable and
world-readable privileges on those directories. Particularly the TLS
certs one. 640 should be enough access for most logs, and 600 for the
certs area.

NP: if this is on a Debian/Ubuntu machine you should install the
squid/squid3 package to setup all the permissions and directories
properly. Then build your custom Squid so that the binary replaces the
default package one.


&gt;<i> Change configuration (bellow) and initialize the cache
</I>&gt;<i> 
</I>&gt;<i> squid -f /etc/squid/squid.conf -z
</I>&gt;<i> 
</I>&gt;<i> Redirect ports 80 and 443
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 3128
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 3129
</I>&gt;<i> 
</I>
Good start, there are a few more rules to add though. This config
example covers it all:
 &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;


&gt;<i> My actual squid configuration
</I>&gt;<i> 
</I>&gt;<i> acl localnet src all
</I>
No. localnet should only have your LAN subnets. There is a built-in ACL
'all' for use when you want the entire Internet to match.

&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>
You should at this position in your config add back in the default
security protection lines:

 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports


&gt;<i> never_direct allow all
</I>&gt;<i> always_direct allow all
</I>&gt;<i> 
</I>
Remove the always_direct line. The never_direct should not be necessary,
but could help later.


You need to setup a cache_peer line pointing Squid at the Privoxy
listening address and port.
 * that line will also need at least the 'ssl' option for the HTTPS
traffic to be sent there.
 * Privoxy will need to be configured to receive TLS traffic. If it can
receive proxy&lt;-&gt;proxy connections over TLS that would be great,
otherwise the cache_peer line might need the 'originserver' option to
send it port-443 / HTTPS formatted data.

More on cache_peer can be found at:
 &lt;<A HREF="http://www.squid-cache.org/Versions/v3/3.5/cfgman/cache_peer.html">http://www.squid-cache.org/Versions/v3/3.5/cfgman/cache_peer.html</A>&gt;


&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>
You are missing this line:

  http_access deny all

&gt;<i> debug_options ALL,2
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid
</I>
This is supposed to be a FQDN. It gets used in URLs for icons and such
things that Squid serves up from its port 3128 ... er 3127 below.

With this config file the clients will be told to fetch things from URLs
starting &quot;<A HREF="http://squid:3127/squid-internal-static/">http://squid:3127/squid-internal-static/</A>&quot; ...

&gt;<i> 
</I>&gt;<i> # stop squid taking forever to restart.
</I>&gt;<i> shutdown_lifetime 3
</I>&gt;<i> # for clients with a configured proxy.
</I>&gt;<i> http_port 3127
</I>&gt;<i> # for clients who are sent here via iptables ... REDIRECT.
</I>&gt;<i> http_port 3128 tproxy
</I>&gt;<i> # for https clients who are sent here via iptables ... REDIRECT
</I>&gt;<i> https_port 3129 tproxy ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.pem
</I>
Replace 'tproxy' with 'intercept'. NAT is just an intercept of the
traffic, no transparency.

&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M
</I>&gt;<i> 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> 
</I>&gt;<i> # acl step1 at_step SslBump1
</I>&gt;<i> # ssl_bump peek step1
</I>&gt;<i> # ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump server-first all
</I>
Two things wrong here:

1) server-first mode requires that Squid upstream be the origin server
for the HTTPS website. That is because Squid mimics the server
connection certificate. If that connection is not the origin server the
cert Squid presents to the client is almost guaranteed to be invalid and
breaks HTTPS.

The configuration you are planning will only work with the very unsafe
client-first bumping style. Where Squid generates a completely false
certificate, but has some chance of working if the client doesn't
validate it too thoroughly.

2) The server-first/client-first config actions are deprecated. For
Squid-3.5 use the peek/splice/bump/terminate actions.

You want to start with the below rules and build any special handing
from there:

 acl step1 at_step BumpStep1
 ssl_bump stare step1
 ssl_bump bump all


&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
Those can go. never_direct prevents Squid -&gt; origin connections existing
so the above dont work. Which is lucky, that could be nasty.

&gt;<i> via off
</I>&gt;<i> forwarded_for off
</I>
'forwarded_for transparent' would be better for your requirements. Maybe
'delete' if you want to also prevent clients using the header.

&gt;<i> 
</I>&gt;<i> request_header_access From deny all
</I>&gt;<i> request_header_access Server deny all
</I>&gt;<i> request_header_access WWW-Authenticate deny all
</I>
Server and WWW-Authenticate are not a request headers. You should be
able to remove those lines.


&gt;<i> request_header_access Link deny all
</I>&gt;<i> request_header_access Cache-Control deny all
</I>
That Cache-Control line will seriously break HTTP for the clients.


&gt;<i> request_header_access Proxy-Connection deny all
</I>
Squid is already erasing the obsolete Proxy-Connection headers. You can
remove the above line.

&gt;<i> request_header_access X-Cache deny all
</I>&gt;<i> request_header_access X-Cache-Lookup deny all
</I>&gt;<i> request_header_access Via deny all
</I>
The via off line is already doing that. You can remove.

&gt;<i> request_header_access X-Forwarded-For deny all
</I>
The forwarded_for line should already do that. You can remove.


&gt;<i> request_header_access Pragma deny all
</I>
FYI: Like Cache-Control, doing this to Pragma will cause breakage in
HTTP. But since it is not an HTTP/1.1 header that will be minimal.

&gt;<i> request_header_access Keep-Alive deny all
</I>
I suggest adding this to remove all custom headers from the request:

 request_header_access Other deny all


Squid also has a reply_header_access directive for anonymizing response
headers. Though hiding server details from the client is less important.

 reply_header_access Set-Cookie deny all
 reply_header_access Set-Cookie2 deny all
 reply_header_access Other deny all


You may find that you dont actually need Privoxy after doing all this
request filtering in squid.conf.

&gt;<i> 
</I>&gt;<i> cache_dir ufs /var/spool/squid 1024 16 256
</I>&gt;<i> coredump_dir /var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> ------------------------------
</I>&gt;<i> 
</I>&gt;<i> You can notice how benevolent I'm with the settings for Squid. It's only
</I>&gt;<i> for testing.
</I>
If you are referring to the missing security rules and the disabled TLS
validation. That is bad for testing as well as production use.

You need to test the real config that will be used in production and fix
the problems encountered with that. Disabling things for testing hides
problems they cause when enabled, and even introduces false problems
that wont occur in production.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013727.html">[squid-users] Transparent HTTPs proxy with Squid 3.5
</A></li>
	<LI>Next message (by thread): <A HREF="013733.html">[squid-users] Transparent HTTPs proxy with Squid 3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13729">[ date ]</a>
              <a href="thread.html#13729">[ thread ]</a>
              <a href="subject.html#13729">[ subject ]</a>
              <a href="author.html#13729">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
