<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Crash: every 1-2 hour: kernel: Out of memory:	Kill	process (squid)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Crash%3A%20every%201-2%20hour%3A%20kernel%3A%20Out%20of%20memory%3A%0A%09Kill%09process%20%28squid%29&In-Reply-To=%3C04d501d2562e%24e56d5e00%24b0481a00%24%40net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013761.html">
   <LINK REL="Next"  HREF="013777.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Crash: every 1-2 hour: kernel: Out of memory:	Kill	process (squid)</H1>
    <B>noc at forceline.net</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Crash%3A%20every%201-2%20hour%3A%20kernel%3A%20Out%20of%20memory%3A%0A%09Kill%09process%20%28squid%29&In-Reply-To=%3C04d501d2562e%24e56d5e00%24b0481a00%24%40net%3E"
       TITLE="[squid-users] Crash: every 1-2 hour: kernel: Out of memory:	Kill	process (squid)">noc at forceline.net
       </A><BR>
    <I>Wed Dec 14 17:24:15 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013761.html">[squid-users] Crash: every 1-2 hour: kernel: Out of memory:	Kill	process (squid)
</A></li>
        <LI>Next message (by thread): <A HREF="013777.html">[squid-users] Crash: every 1-2 hour: kernel: Out of memory: Kill process (squid)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13772">[ date ]</a>
              <a href="thread.html#13772">[ thread ]</a>
              <a href="subject.html#13772">[ subject ]</a>
              <a href="author.html#13772">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Eliezer, thanks for your reply. Guides:
<A HREF="http://wiki.squid-cache.org/Features/SslBump">http://wiki.squid-cache.org/Features/SslBump</A>
<A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
<A HREF="https://habrahabr.ru/post/267851/">https://habrahabr.ru/post/267851/</A>  &lt;-- Russian lang
<A HREF="https://habrahabr.ru/post/272733/">https://habrahabr.ru/post/272733/</A>  &lt;-- Russian lang

&gt;<i>First goes first change this: 13130:
</I>Done, nothing changed. Squid died.

Maby it will be work fine whith lower load even with https. But I don't
understand, why it killed by a kernel rather than just update memory by new
one.

<A HREF="http://wiki.squid-cache.org/Features/SslBump">http://wiki.squid-cache.org/Features/SslBump</A>
&gt;<i>Memory usage
</I>&gt;<i>
</I>&gt;<i>    /!\ Warning: Unlike the rest of this page at the time of writing, this
</I>section applies to Squid-3.3 and possibly later code capable of dynamic SSL
certificate generation and origin server certificate mimicking. The current
section text is intended primarily for developers and early adopters facing
excessive memory consumption in certain SslBump environments. These notes
may be relocated elsewhere if a better location is found. 
&gt;<i>
</I>&gt;<i>Current documentation is specific to bump-server-first configurations.
</I>
In attach server statistic.

--
Sergey

&gt;<i> -----Original Message-----
</I>&gt;<i> From: Eliezer Croitoru [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>]
</I>&gt;<i> Sent: Wednesday, December 14, 2016 5:02 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">noc at forceline.net</A>; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: RE: [squid-users] Crash: every 1-2 hour: kernel: Out of
</I>&gt;<i> memory: Kill process (squid)
</I>&gt;<i> 
</I>&gt;<i> First goes first change this:
</I>&gt;<i> https_port 192.168.253.10:3130 intercept ssl-bump
</I>&gt;<i> options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off
</I>&gt;<i> cert=/etc/squid/squidCA.pem
</I>&gt;<i> 
</I>&gt;<i> into:
</I>&gt;<i> http_port 192.168.253.10:13130 intercept ssl-bump
</I>&gt;<i> options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off
</I>&gt;<i> cert=/etc/squid/squidCA.pem
</I>&gt;<i> 
</I>&gt;<i> and iptables accordingly.
</I>&gt;<i> Are you working based on some tutorial?
</I>&gt;<i> If so please attach the link to it.
</I>&gt;<i> Notice that port 3130 is officially a port which should not be used for
</I>&gt;<i> interception but for other purposes.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;<i> Behalf Of <A HREF="https://lists.squid-cache.org/listinfo/squid-users">noc at forceline.net</A>
</I>&gt;<i> Sent: Wednesday, December 14, 2016 1:40 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] Crash: every 1-2 hour: kernel: Out of memory:
</I>&gt;<i> Kill
</I>&gt;<i> process (squid)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hello. I wrote earlier in wrong location:
</I>&gt;<i> <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4647">http://bugs.squid-cache.org/show_bug.cgi?id=4647</A>
</I>&gt;<i> 
</I>&gt;<i> &gt; Squid eats all RAM, then eats all swap in a hour and killed by
</I>&gt;<i> kernel.
</I>&gt;<i> &gt;I was try to turn off cache, change squid version, change some
</I>&gt;<i> configuration parameters by this guide
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidMemory">http://wiki.squid-cache.org/SquidFaq/SquidMemory</A> except malloc, but
</I>&gt;<i> nothing
</I>&gt;<i> helps.
</I>&gt;<i> 
</I>&gt;<i> I made some config changes in accordance with the advice of Amos
</I>&gt;<i> Jeffries
</I>&gt;<i> (via on). But it does not help.
</I>&gt;<i> This trouble somehow linked with https.
</I>&gt;<i> If wccp redirects only 80 port - works fine.
</I>&gt;<i>   wccp2_service_info 70 protocol = tcp flags = dst_ip_hash priority =
</I>&gt;<i> 231
</I>&gt;<i> ports = 80 If wccp redirects 443 too - then squid overflows and killed
</I>&gt;<i> by
</I>&gt;<i> kernel
</I>&gt;<i>   wccp2_service_info 70 protocol = tcp flags = dst_ip_hash priority =
</I>&gt;<i> 231
</I>&gt;<i> ports = 80,443
</I>&gt;<i> 
</I>&gt;<i> ---Before it died (HTTPS on):
</I>&gt;<i> Mem:  16291720k total, 16125288k used,   166432k free,      540k
</I>&gt;<i> buffers
</I>&gt;<i> Swap:  8216568k total,  8112628k used,   103940k free,    27112k cached
</I>&gt;<i>   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
</I>&gt;<i> 30858 squid     20   0 22.7g  14g 3612 S  8.0 94.6  14:50.82 squid
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # free -m
</I>&gt;<i>              total       used       free     shared    buffers
</I>&gt;<i> cached
</I>&gt;<i> Mem:         15909      15750        158          0          0
</I>&gt;<i> 26
</I>&gt;<i> -/+ buffers/cache:      15723        186
</I>&gt;<i> Swap:         8023       7936         87
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Start Time:	Sat, 10 Dec 2016 07:52:50 GMT
</I>&gt;<i> Current Time:	Sat, 10 Dec 2016 09:39:45 GMT
</I>&gt;<i> 
</I>&gt;<i> Connection information for squid:
</I>&gt;<i> 	Number of clients accessing cache:	1305
</I>&gt;<i> 	Number of HTTP requests received:	193434
</I>&gt;<i> 	Number of ICP messages received:	0
</I>&gt;<i> 	Number of ICP messages sent:	0
</I>&gt;<i> 	Number of queued ICP replies:	0
</I>&gt;<i> 	Number of HTCP messages received:	0
</I>&gt;<i> 	Number of HTCP messages sent:	0
</I>&gt;<i> 	Request failure ratio:	 0.00
</I>&gt;<i> 	Average HTTP requests per minute since start:	1809.2
</I>&gt;<i> 	Average ICP messages per minute since start:	0.0
</I>&gt;<i> 	Select loop called: 4529796 times, 1.416 ms avg Cache information
</I>&gt;<i> for squid:
</I>&gt;<i> 	Hits as % of all requests:	5min: 0.0%, 60min: 0.0%
</I>&gt;<i> 	Hits as % of bytes sent:	5min: 0.1%, 60min: -0.0%
</I>&gt;<i> 	Memory hits as % of hit requests:	5min: 0.0%, 60min: 0.0%
</I>&gt;<i> 	Disk hits as % of hit requests:	5min: 0.0%, 60min: 0.0%
</I>&gt;<i> 	Storage Swap size:	82044 KB
</I>&gt;<i> 	Storage Swap capacity:	80.1% used, 19.9% free
</I>&gt;<i> 	Storage Mem size:	107876 KB
</I>&gt;<i> 	Storage Mem capacity:	20.6% used, 79.4% free
</I>&gt;<i> 	Mean Object Size:	29.54 KB
</I>&gt;<i> 	Requests given to unlinkd:	9258
</I>&gt;<i> Median Service Times (seconds)  5 min    60 min:
</I>&gt;<i> 	HTTP Requests (All):   0.10857  0.04519
</I>&gt;<i> 	Cache Misses:          0.01648  0.00678
</I>&gt;<i> 	Cache Hits:            0.00000  0.00000
</I>&gt;<i> 	Near Hits:             0.00000  0.00000
</I>&gt;<i> 	Not-Modified Replies:  0.00000  0.00000
</I>&gt;<i> 	DNS Lookups:           0.00860  0.00779
</I>&gt;<i> 	ICP Queries:           0.00000  0.00000
</I>&gt;<i> Resource usage for squid:
</I>&gt;<i> 	UP Time:	6415.101 seconds
</I>&gt;<i> 	CPU Time:	902.767 seconds
</I>&gt;<i> 	CPU Usage:	14.07%
</I>&gt;<i> 	CPU Usage, 5 minute avg:	15.97%
</I>&gt;<i> 	CPU Usage, 60 minute avg:	13.96%
</I>&gt;<i> 	Maximum Resident Size: 62241760 KB
</I>&gt;<i> 	Page faults with physical i/o: 32647
</I>&gt;<i> Memory accounted for:
</I>&gt;<i> 	Total accounted:       1073388 KB
</I>&gt;<i> 	memPoolAlloc calls:     12969
</I>&gt;<i> 	memPoolFree calls:   35802441
</I>&gt;<i> File descriptor usage for squid:
</I>&gt;<i> 	Maximum number of file descriptors:   100000
</I>&gt;<i> 	Largest file desc currently in use:   28744
</I>&gt;<i> 	Number of file desc currently in use: 28738
</I>&gt;<i> 	Files queued for open:                   0
</I>&gt;<i> 	Available number of file descriptors: 71262
</I>&gt;<i> 	Reserved number of file descriptors:   100
</I>&gt;<i> 	Store Disk files open:                   0
</I>&gt;<i> Internal Data Structures:
</I>&gt;<i> 	 57337 StoreEntries
</I>&gt;<i> 	 54560 StoreEntries with MemObjects
</I>&gt;<i> 	    52 Hot Object Cache Items
</I>&gt;<i> 	  2777 on-disk objects
</I>&gt;<i> 
</I>&gt;<i> ---after:
</I>&gt;<i> /var/log/messages
</I>&gt;<i> kernel: 11733 total pagecache pages
</I>&gt;<i> kernel: 8957 pages in swap cache
</I>&gt;<i> kernel: Swap cache stats: add 21118384, delete 21109427, find
</I>&gt;<i> 12110273/12422740
</I>&gt;<i> kernel: Free swap  = 0kB
</I>&gt;<i> kernel: Total swap = 8216568kB
</I>&gt;<i> kernel: 4194303 pages RAM
</I>&gt;<i> kernel: 121373 pages reserved
</I>&gt;<i> kernel: 11781 pages shared
</I>&gt;<i> kernel: 4023631 pages non-shared
</I>&gt;<i> ...omitted...
</I>&gt;<i> kernel: Out of memory: Kill process 30858 (squid) score 954 or
</I>&gt;<i> sacrifice
</I>&gt;<i> child
</I>&gt;<i> kernel: Killed process 30868, UID 23, (log_file_daemon) total-
</I>&gt;<i> vm:26640kB,
</I>&gt;<i> anon-rss:48kB, file-rss:512kB
</I>&gt;<i> (squid-1): I don't handle this error well!
</I>&gt;<i> Dec 10 12:44:27 localhost squid[30855]: Squid Parent: (squid-1) process
</I>&gt;<i> 30858 exited due to signal 9 with status 0
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In attach all /var/log/messages output.
</I>&gt;<i> Main task for the server is to block bad sites and bypass others on
</I>&gt;<i> same
</I>&gt;<i> IPs.
</I>&gt;<i> Any ideas?
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Sergey
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: load.png
Type: image/png
Size: 59431 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161214/385060ce/attachment.png">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161214/385060ce/attachment.png</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013761.html">[squid-users] Crash: every 1-2 hour: kernel: Out of memory:	Kill	process (squid)
</A></li>
	<LI>Next message (by thread): <A HREF="013777.html">[squid-users] Crash: every 1-2 hour: kernel: Out of memory: Kill process (squid)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13772">[ date ]</a>
              <a href="thread.html#13772">[ thread ]</a>
              <a href="subject.html#13772">[ subject ]</a>
              <a href="author.html#13772">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
