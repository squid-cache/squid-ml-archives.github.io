<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] unknown source IP in access.log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20unknown%20source%20IP%20in%20access.log&In-Reply-To=%3C6230fc27-3ac9-9276-de7e-92a58fb203c9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013774.html">
   <LINK REL="Next"  HREF="013766.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] unknown source IP in access.log</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20unknown%20source%20IP%20in%20access.log&In-Reply-To=%3C6230fc27-3ac9-9276-de7e-92a58fb203c9%40treenet.co.nz%3E"
       TITLE="[squid-users] unknown source IP in access.log">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 15 04:16:44 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013774.html">[squid-users] unknown source IP in access.log
</A></li>
        <LI>Next message (by thread): <A HREF="013766.html">[squid-users] Setup wccp2 with squid3 and cisco switch 4507
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13776">[ date ]</a>
              <a href="thread.html#13776">[ thread ]</a>
              <a href="subject.html#13776">[ subject ]</a>
              <a href="author.html#13776">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/12/2016 8:58 a.m., Sameh Onaissi wrote:
&gt;<i> Hey Antony, all&#8230;
</I>&gt;<i> 
</I>&gt;<i> The file is where is should be: /etc/squid/squid.conf
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> squid -k parse returns nothing strange.
</I>&gt;<i> To make sure, I followed your instructions of writing deny wrong (in /etc/squid/squid.conf) and ran &quot;squid -k parse&#8221; again, and it complained:
</I>&gt;<i> 
</I>&gt;<i> 2016/12/14 14:45:15| Processing: http_access denyl !Safe_ports
</I>&gt;<i> 2016/12/14 14:45:15| aclParseAccessLine: /etc/squid/squid.conf line 35: http_access denyl !Safe_ports
</I>&gt;<i> 2016/12/14 14:45:15| aclParseAccessLine: expecting 'allow' or 'deny', got 'denyl'.
</I>&gt;<i> 2016/12/14 14:45:15| Processing: http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I also commented out the line allowing skype IPs and the access log continued showing said results.
</I>&gt;<i> 
</I>&gt;<i> I should mention that this behavior started today, when it was not happening before.
</I>&gt;<i> 
</I>&gt;<i> additionally:
</I>&gt;<i> 
</I>&gt;<i> find / -name squid.conf
</I>&gt;<i> /etc/fail2ban/filter.d/squid.conf
</I>&gt;<i> /etc/squid.bk/squid.conf
</I>&gt;<i> /etc/squid/squid.conf
</I>&gt;<i> find: &#8216;/run/user/118/gvfs&#8217;: Permission denied
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I am sure it is not the squid.bk/squid.conf because that has no acls defined nor configured to use squid guard to redirect pages (which currently is functioning)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any other ideas?
</I>
&gt;&gt;<i> acl Safe_ports port 587 #SMTP
</I>
SMTP is the #1 worst protocol to let anywhere near an HTTP proxy.
Preventing what you have allowed to happen is one of the primary reasons
Safe_ports exists in the first place!

Some (but not all) of the log lines you displayed show signs of email
being delivered through the HTTP proxy to external mailservers.

The protocols look nearly identical in syntax. But the semantic meaning
of the message is different and gets interpreted by HTTP and SMTP relays
in ways the make the results quite nasty (for you) and practically a
haven for spammers.

&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>
'deny all' is final. No following http_access will ever be used. Which
is lucky given your problem.

&gt;<i> http_access allow CONNECT localnet numeric_IPs Skype_UA
</I>&gt;<i> 
</I>&gt;<i> Maybe someone more knowledgeable can say if I'm wrong here, but I find it hard
</I>&gt;<i> to accept that this really is the squid.conf file you're using:
</I>&gt;<i> 
</I>&gt;<i> a) if it allows connections from IPs such as 118.89.21.244
</I>&gt;<i> 
</I>&gt;<i> b) if it allows *anything* to CONNECT.
</I>&gt;<i> 
</I>
With some simple mistake(s) in the iptables rules the port 587 being
allowed could lead to this behaviour. Though the external IP showing up
in the log and not being denied is odd.

Sameh Onaissi: what are your iptables rules? (all of them. For nat,
mangle and filter tables).


One other thing to try is to take the access.log and subtract the
duration times from the timestamp and see what turns out to be starting
at about the same times. The durations on these requests is very long,
so important bits will be happening long before they get logged.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013774.html">[squid-users] unknown source IP in access.log
</A></li>
	<LI>Next message (by thread): <A HREF="013766.html">[squid-users] Setup wccp2 with squid3 and cisco switch 4507
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13776">[ date ]</a>
              <a href="thread.html#13776">[ thread ]</a>
              <a href="subject.html#13776">[ subject ]</a>
              <a href="author.html#13776">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
