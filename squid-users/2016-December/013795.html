<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Websocket Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Websocket%20Issue&In-Reply-To=%3CCA%2BsSnVZo1250omWkLDzPpknEa-qqLNisA6YJeROx5BxL6pqv9Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013834.html">
   <LINK REL="Next"  HREF="013804.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Websocket Issue</H1>
    <B>Hardik Dangar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Websocket%20Issue&In-Reply-To=%3CCA%2BsSnVZo1250omWkLDzPpknEa-qqLNisA6YJeROx5BxL6pqv9Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid Websocket Issue">hardikdangar+squid at gmail.com
       </A><BR>
    <I>Sat Dec 17 09:16:55 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013834.html">[squid-users] squid.conf blocking live video stream
</A></li>
        <LI>Next message (by thread): <A HREF="013804.html">[squid-users] Squid Websocket Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13795">[ date ]</a>
              <a href="thread.html#13795">[ thread ]</a>
              <a href="subject.html#13795">[ subject ]</a>
              <a href="author.html#13795">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here is some information about my squid version,

Squid Cache: Version 3.5.22-20161115-r14113
Service Name: squid
configure options:  '--prefix=/usr' '--localstatedir=/var/squid'
'--libexecdir=/lib/squid' '--srcdir=.' '--datadir=/share/squid'
'--sysconfdir=/etc/squid' '--with-default-user=proxy'
'--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid'
'--with-openssl' '--enable-ssl-crtd' '--enable-inline'
'--disable-arch-native' '--enable-async-io=8'
'--enable-storeio=ufs,aufs,diskd,rock'
'--enable-removal-policies=lru,heap' '--enable-delay-pools'
'--enable-follow-x-forwarded-for' '--enable-url-rewrite-helpers=fake'
'--enable-ecap'

My squid config file is located at, <A HREF="http://pastebin.com/raw/LvDxEF4x">http://pastebin.com/raw/LvDxEF4x</A>

Now the issue is whenever someone requests a page which contains web socket
requests response is always bad request.
Here is an example,

Request URL:<A HREF="wss://w4.web.whatsapp.com/ws">wss://w4.web.whatsapp.com/ws</A>
Request Method:GET
Status Code:400 Bad Request

Response Headers
#################
Connection:keep-alive
Date:Sat, 17 Dec 2016 09:05:36 GMT
Transfer-Encoding:chunked
X-Cache:MISS from Proxy

Request Headers
#################
Accept-Encoding:gzip, deflate, sdch, br
Accept-Language:en-US,en;q=0.8
Cache-Control:no-cache
Connection:Upgrade
Host:w4.web.whatsapp.com
Origin:<A HREF="https://web.whatsapp.com">https://web.whatsapp.com</A>
Pragma:no-cache
Sec-WebSocket-Extensions:permessage-deflate; client_max_window_bits
Sec-WebSocket-Key:kzrB2ZcMHDAqvjDNXnjL/w==
Sec-WebSocket-Version:13
Upgrade:websocket
User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like
Gecko) Chrome/55.0.2883.75 Safari/537.36


My question is how we can work with web socket requests in squid or if not
by pass them squid. My squid instance is in interception mode and requests
are intercepted at instance via iptables and forwarded to squid using below
rules,

SQUIDIP=192.168.1.1

# your proxy listening port
SQUIDHTTPPORT=3128
SQUIDHTTPSPORT=3129


iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port
$SQUIDHTTPPORT

iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 443 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port
$SQUIDHTTPSPORT

iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -t mangle -A PREROUTING -p tcp --dport $SQUIDHTTPPORT -j DROP
iptables -t mangle -A PREROUTING -p tcp --dport $SQUIDHTTPSPORT -j DROP


If anyone can help me with this it would be really awesome. Thanks for your
support.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161217/90a68891/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161217/90a68891/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013834.html">[squid-users] squid.conf blocking live video stream
</A></li>
	<LI>Next message (by thread): <A HREF="013804.html">[squid-users] Squid Websocket Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13795">[ date ]</a>
              <a href="thread.html#13795">[ thread ]</a>
              <a href="subject.html#13795">[ subject ]</a>
              <a href="author.html#13795">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
