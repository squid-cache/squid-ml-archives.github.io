<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] sslpassword_program
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslpassword_program&In-Reply-To=%3C20921bd3-cbcd-e6f0-1788-abb7907f53ab%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013814.html">
   <LINK REL="Next"  HREF="013837.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] sslpassword_program</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslpassword_program&In-Reply-To=%3C20921bd3-cbcd-e6f0-1788-abb7907f53ab%40treenet.co.nz%3E"
       TITLE="[squid-users] sslpassword_program">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec 19 06:24:54 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013814.html">[squid-users] sslpassword_program
</A></li>
        <LI>Next message (by thread): <A HREF="013837.html">[squid-users] sslpassword_program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13815">[ date ]</a>
              <a href="thread.html#13815">[ thread ]</a>
              <a href="subject.html#13815">[ subject ]</a>
              <a href="author.html#13815">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/12/2016 5:59 p.m., creditu wrote:
&gt;<i> 
</I>&gt;<i> On Sun, Dec 18, 2016, at 01:21 PM, Michael Pelletier wrote:
</I>&gt;&gt;<i> Check your file permissions on the key.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Dec 18, 2016 2:13 PM, creditu wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm having trouble getting the sslpassword_program working for an
</I>&gt;&gt;&gt;<i> encrypted key.  Config looks like this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslpassword_program /usr/local/bin/pass.sh
</I>&gt;&gt;&gt;<i> https_port 10.10.10.1:443 accel vhost cert=/etc/squid/www.crt
</I>&gt;&gt;&gt;<i> key=/etc/squid/private.key
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On start, cache log states &quot;Ignoring https_port 10.10.10.1:443 due to
</I>&gt;&gt;&gt;<i> SSL initialization failure.&quot;
</I>&gt;&gt;&gt;<i> On stop, console states &quot;Failed to acquire SSL private key
</I>&gt;&gt;&gt;<i> '/etc/squid/private.key': error:0200100D:system library:fopen:Permission
</I>&gt;&gt;&gt;<i> denied&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Removing the passphrase from the private key, squid starts normally.
</I>&gt;&gt;&gt;<i> Permissions on the encrypted and non-encrypted keys are the same.  I
</I>&gt;&gt;&gt;<i> also tried putting the pass.sh program in /bin.  The pass.sh program
</I>&gt;&gt;&gt;<i> looks like this:
</I>&gt;&gt;&gt;<i> #!/bin/sh
</I>&gt;&gt;&gt;<i> echo &quot;testing&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The hash of the private key modulus and the certificate modulus match as
</I>&gt;&gt;&gt;<i> well.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Am I missing something? This is on squid 3.1.
</I>
If the ideas below don't help can you try an upgrade? there are a few
fixes in 3.2 and 3.3 related to that directive.

&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;<i> 
</I>&gt;<i> Checked the perms and they are identical as the private key that I
</I>&gt;<i> stripped the password out of.  They are also in the same directory.  The
</I>&gt;<i> one without a password works fine.
</I>
The one without a password is being opened by OpenSSL directly.

The one with pssword is being opened in Squid oeprating context, which
should be root, but may also be the low-privilege proxy user at the time
the script is run.

So you need the key file to be readable by whichever of those privilege
contexts Squid is using at the time. (Sorry I can't be more precise, I'm
not sure myself which is used in 3.1).

If you have SELinux or AppArmour they may also be interferring with the
priviledged access.

The script itself needs either executable permissions set, or squid.conf
containing the full shell interpreter path as well as the script path.
 ie. &quot;sslpassword_program /bin/sh /usr/local/bin/pass.sh&quot;


&gt;<i>  Also tried encrypting with des3
</I>&gt;<i> versus aes128 and that didn't make a difference either.   Gotta be
</I>&gt;<i> missing something.
</I>
&gt;<i>  The error points to a perms problem, but not seeing
</I>&gt;<i> how since everything is the same.
</I>
The error message says fopen() command is not permitted for whichever
user account is trying to access the .key file.
 It's not clear if that is fopen() of the .key file, or fopen() of the
pass.sh file before running it.

The way you describe the issues below hint to me that it is the
permission to access the script which is breaking things.


Also, those old Squid had some issues with processing errno at the wrong
times. So there is a small but non-zero chance that the error is
actually something else. :-(


&gt;<i>  Also, added a line in the
</I>&gt;<i> sslpassword_program to touch a file to see if it got executed and it
</I>&gt;<i> didn't create the file. Additionally, ran the stat command on the 
</I>&gt;<i> /usr/local/bin/pass.sh after squid started up
</I>
FYI: That test only works if your filesystem has been configured to
record access times. Using such a setup with Squid will cause major
slowdown as cache related files and logs get accessed *a lot*. So is
typically disabled via fstab &quot;noatime&quot; settings if anyone with expertise
has tuned the proxy machine before you.


&gt;<i> and the access time never
</I>&gt;<i> changes.  It seems like the shell script may not being executed for some
</I>&gt;<i> reason.  I'm able to launch the shell script from the command line and
</I>&gt;<i> it echos out the pass fine.
</I>
This kind of implies the file permission problem is for Squid to open
the script &quot;file&quot; before running whats inside.

Check /usr/local/bin/pass.sh ownership, executable rights, and
SELinux/AppArmour permissions (whichever is present on that achine).

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013814.html">[squid-users] sslpassword_program
</A></li>
	<LI>Next message (by thread): <A HREF="013837.html">[squid-users] sslpassword_program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13815">[ date ]</a>
              <a href="thread.html#13815">[ thread ]</a>
              <a href="subject.html#13815">[ subject ]</a>
              <a href="author.html#13815">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
