<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Websocket Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Websocket%20Issue&In-Reply-To=%3CCA%2BsSnVbob7T03YvK8RCHmd4o%3D9Ej8NZ6vhmgKj%2Bh75hnB1EXdQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013827.html">
   <LINK REL="Next"  HREF="013865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Websocket Issue</H1>
    <B>Hardik Dangar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Websocket%20Issue&In-Reply-To=%3CCA%2BsSnVbob7T03YvK8RCHmd4o%3D9Ej8NZ6vhmgKj%2Bh75hnB1EXdQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid Websocket Issue">hardikdangar+squid at gmail.com
       </A><BR>
    <I>Tue Dec 20 09:42:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013827.html">[squid-users] Squid Websocket Issue
</A></li>
        <LI>Next message (by thread): <A HREF="013865.html">[squid-users] Squid Websocket Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13842">[ date ]</a>
              <a href="thread.html#13842">[ thread ]</a>
              <a href="subject.html#13842">[ subject ]</a>
              <a href="author.html#13842">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>@Eliezer, @Amos

Following changes in config works and whatsapp starts working,

acl serverIsws ssl::server_name_regex ^w[0-9]+\.web\.whatsapp\.com$

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump splice serverIsws
ssl_bump bump !serverIsws all

[ above is a feature of whatsapp which allows you to connect to
web.whatsapp.com from browser]


now what happens at request level is following,

Request URL:<A HREF="wss://w8.web.whatsapp.com/ws">wss://w8.web.whatsapp.com/ws</A>
Request Method:GET
Status Code:101 Switching Protocols

----------------------------------

Response Headers

Connection:Upgrade
Sec-WebSocket-Accept:Z6CC+QVdvB0cCHPbJAQMaHKL2uQ=
Upgrade:websocket

----------------------------------
Request Headers

Accept-Encoding:gzip, deflate, sdch, br
Accept-Language:en-US,en;q=0.8
Cache-Control:no-cache
Connection:Upgrade
Host:w8.web.whatsapp.com
Origin:<A HREF="https://web.whatsapp.com">https://web.whatsapp.com</A>
Pragma:no-cache
Sec-WebSocket-Extensions:permessage-deflate; client_max_window_bits
Sec-WebSocket-Key:mbCFLN/Q1KMt58t6DoQI9Q==
Sec-WebSocket-Version:13
Upgrade:websocket
User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like
Gecko) Chrome/55.0.2883.75 Safari/537.36

After this no other web sockets open it seems whatsapp switches to normal
communication from websockets.

Above solution could help lot of people who is trying to configure
websockets to run. I have few more websocket applications which i need to
work on and i will let you know if it works soon.

Thank you very much for your help. Really appreciate the help.

On Mon, Dec 19, 2016 at 6:46 PM, Hardik Dangar &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hardikdangar+squid at gmail.com</A>
&gt;<i> wrote:
</I>
&gt;<i> Based on Amos's Answer,
</I>&gt;<i>
</I>&gt;<i> acl serverIsws ssl::server_name .w0.whatsapp.com
</I>&gt;<i> acl serverIsws ssl::server_name .w1.whatsapp.com
</I>&gt;<i>
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump !serverIsws all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> will above work ?
</I>&gt;<i>
</I>&gt;<i> Or should i splice first and bump all others later?
</I>&gt;<i>
</I>&gt;<i> This is very interesting. I will definitely try this when i will reach
</I>&gt;<i> office.
</I>&gt;<i>
</I>&gt;<i> On Mon, Dec 19, 2016 at 6:40 PM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I can give a hint that once you see the request you can identify using an
</I>&gt;&gt;<i> ICAP\ECAP services couple details about the request.
</I>&gt;&gt;<i> Basically I had a regex which allowed any what's app traffic to be
</I>&gt;&gt;<i> spliced by the SNI domain name.
</I>&gt;&gt;<i> It should be something like &quot;w[0-9]+\.web\.whatsapp\.com$&quot; to match the
</I>&gt;&gt;<i> required domains for whatsapp to be spliced.
</I>&gt;&gt;<i> If nobody will try it before me it's on my todo list for this release
</I>&gt;&gt;<i> (3.5.23, 4.0.17).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;<i> Linux System Administrator
</I>&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;&gt;<i> Behalf Of Amos Jeffries
</I>&gt;&gt;<i> Sent: Monday, December 19, 2016 8:51 AM
</I>&gt;&gt;<i> To: Hardik Dangar &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hardikdangar+squid at gmail.com</A>&gt;
</I>&gt;&gt;<i> Cc: Squid Users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> Subject: Re: [squid-users] Squid Websocket Issue
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 19/12/2016 12:14 p.m., Hardik Dangar wrote:
</I>&gt;&gt;<i> &gt; can you give me one example please ?
</I>&gt;&gt;<i> &gt; like in the above example.
</I>&gt;&gt;<i> &gt; w4.web.whatsapp.com domain is fixed
</I>&gt;&gt;<i> &gt; are you suggesting i can create acl and by pass it to squid ?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You are the first person to ask about WhatsApp traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These might be a useful starting point
</I>&gt;&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice#Confi">http://wiki.squid-cache.org/Features/SslPeekAndSplice#Confi</A>
</I>&gt;&gt;<i> guration_Examples&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What the examples are doing for banks is what you want to do for WhatsApp.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The trick though will be figuring out how to splice *before* seeing what
</I>&gt;&gt;<i> type of HTTP request exists inside the tunnel. If you are lucky the app
</I>&gt;&gt;<i> will be using SNI.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161220/4b4d795d/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161220/4b4d795d/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013827.html">[squid-users] Squid Websocket Issue
</A></li>
	<LI>Next message (by thread): <A HREF="013865.html">[squid-users] Squid Websocket Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13842">[ date ]</a>
              <a href="thread.html#13842">[ thread ]</a>
              <a href="subject.html#13842">[ subject ]</a>
              <a href="author.html#13842">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
