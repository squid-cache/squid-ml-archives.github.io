<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] sslpassword_program
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslpassword_program&In-Reply-To=%3C1482243700.1266664.824823329.0D9E02B7%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013837.html">
   <LINK REL="Next"  HREF="013822.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] sslpassword_program</H1>
    <B>creditu at eml.cc</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20sslpassword_program&In-Reply-To=%3C1482243700.1266664.824823329.0D9E02B7%40webmail.messagingengine.com%3E"
       TITLE="[squid-users] sslpassword_program">creditu at eml.cc
       </A><BR>
    <I>Tue Dec 20 14:21:40 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013837.html">[squid-users] sslpassword_program
</A></li>
        <LI>Next message (by thread): <A HREF="013822.html">[squid-users] cache_peer and PROXY protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13852">[ date ]</a>
              <a href="thread.html#13852">[ thread ]</a>
              <a href="subject.html#13852">[ subject ]</a>
              <a href="author.html#13852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On Mon, Dec 19, 2016, at 06:58 PM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">creditu at eml.cc</A> wrote:
&gt;<i> 
</I>&gt;<i> On Sun, Dec 18, 2016, at 11:24 PM, Amos Jeffries wrote:
</I>&gt;<i> &gt; On 19/12/2016 5:59 p.m., creditu wrote:
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; On Sun, Dec 18, 2016, at 01:21 PM, Michael Pelletier wrote:
</I>&gt;<i> &gt; &gt;&gt; Check your file permissions on the key.
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; On Dec 18, 2016 2:13 PM, creditu wrote:
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; I'm having trouble getting the sslpassword_program working for an
</I>&gt;<i> &gt; &gt;&gt;&gt; encrypted key.  Config looks like this:
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; sslpassword_program /usr/local/bin/pass.sh
</I>&gt;<i> &gt; &gt;&gt;&gt; https_port 10.10.10.1:443 accel vhost cert=/etc/squid/www.crt
</I>&gt;<i> &gt; &gt;&gt;&gt; key=/etc/squid/private.key
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; On start, cache log states &quot;Ignoring https_port 10.10.10.1:443 due to
</I>&gt;<i> &gt; &gt;&gt;&gt; SSL initialization failure.&quot;
</I>&gt;<i> &gt; &gt;&gt;&gt; On stop, console states &quot;Failed to acquire SSL private key
</I>&gt;<i> &gt; &gt;&gt;&gt; '/etc/squid/private.key': error:0200100D:system library:fopen:Permission
</I>&gt;<i> &gt; &gt;&gt;&gt; denied&quot;
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; Removing the passphrase from the private key, squid starts normally.
</I>&gt;<i> &gt; &gt;&gt;&gt; Permissions on the encrypted and non-encrypted keys are the same.  I
</I>&gt;<i> &gt; &gt;&gt;&gt; also tried putting the pass.sh program in /bin.  The pass.sh program
</I>&gt;<i> &gt; &gt;&gt;&gt; looks like this:
</I>&gt;<i> &gt; &gt;&gt;&gt; #!/bin/sh
</I>&gt;<i> &gt; &gt;&gt;&gt; echo &quot;testing&quot;
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; The hash of the private key modulus and the certificate modulus match as
</I>&gt;<i> &gt; &gt;&gt;&gt; well.
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; Am I missing something? This is on squid 3.1.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; If the ideas below don't help can you try an upgrade? there are a few
</I>&gt;<i> &gt; fixes in 3.2 and 3.3 related to that directive.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Checked the perms and they are identical as the private key that I
</I>&gt;<i> &gt; &gt; stripped the password out of.  They are also in the same directory.  The
</I>&gt;<i> &gt; &gt; one without a password works fine.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The one without a password is being opened by OpenSSL directly.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The one with pssword is being opened in Squid oeprating context, which
</I>&gt;<i> &gt; should be root, but may also be the low-privilege proxy user at the time
</I>&gt;<i> &gt; the script is run.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; So you need the key file to be readable by whichever of those privilege
</I>&gt;<i> &gt; contexts Squid is using at the time. (Sorry I can't be more precise, I'm
</I>&gt;<i> &gt; not sure myself which is used in 3.1).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; If you have SELinux or AppArmour they may also be interferring with the
</I>&gt;<i> &gt; priviledged access.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The script itself needs either executable permissions set, or squid.conf
</I>&gt;<i> &gt; containing the full shell interpreter path as well as the script path.
</I>&gt;<i> &gt;  ie. &quot;sslpassword_program /bin/sh /usr/local/bin/pass.sh&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt;  Also tried encrypting with des3
</I>&gt;<i> &gt; &gt; versus aes128 and that didn't make a difference either.   Gotta be
</I>&gt;<i> &gt; &gt; missing something.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt;  The error points to a perms problem, but not seeing
</I>&gt;<i> &gt; &gt; how since everything is the same.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The error message says fopen() command is not permitted for whichever
</I>&gt;<i> &gt; user account is trying to access the .key file.
</I>&gt;<i> &gt;  It's not clear if that is fopen() of the .key file, or fopen() of the
</I>&gt;<i> &gt; pass.sh file before running it.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The way you describe the issues below hint to me that it is the
</I>&gt;<i> &gt; permission to access the script which is breaking things.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Also, those old Squid had some issues with processing errno at the wrong
</I>&gt;<i> &gt; times. So there is a small but non-zero chance that the error is
</I>&gt;<i> &gt; actually something else. :-(
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt;  Also, added a line in the
</I>&gt;<i> &gt; &gt; sslpassword_program to touch a file to see if it got executed and it
</I>&gt;<i> &gt; &gt; didn't create the file. Additionally, ran the stat command on the 
</I>&gt;<i> &gt; &gt; /usr/local/bin/pass.sh after squid started up
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; FYI: That test only works if your filesystem has been configured to
</I>&gt;<i> &gt; record access times. Using such a setup with Squid will cause major
</I>&gt;<i> &gt; slowdown as cache related files and logs get accessed *a lot*. So is
</I>&gt;<i> &gt; typically disabled via fstab &quot;noatime&quot; settings if anyone with expertise
</I>&gt;<i> &gt; has tuned the proxy machine before you.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt; and the access time never
</I>&gt;<i> &gt; &gt; changes.  It seems like the shell script may not being executed for some
</I>&gt;<i> &gt; &gt; reason.  I'm able to launch the shell script from the command line and
</I>&gt;<i> &gt; &gt; it echos out the pass fine.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; This kind of implies the file permission problem is for Squid to open
</I>&gt;<i> &gt; the script &quot;file&quot; before running whats inside.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Check /usr/local/bin/pass.sh ownership, executable rights, and
</I>&gt;<i> &gt; SELinux/AppArmour permissions (whichever is present on that achine).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Amos
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> Thanks.  Worked down the list and the problem ended up being SELinux. 
</I>&gt;<i> Of course I would have sworn that it was not in enforcing mode.
</I>
After getting the SELinux straightened out, I tightened up the perms on
the key file and the pass program.  In my case, the tightest I could set
the perms and still have it work was the key file readable only by root
and the pass program owned by root and the group set to squid.  Both
having execute perms (750). 

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013837.html">[squid-users] sslpassword_program
</A></li>
	<LI>Next message (by thread): <A HREF="013822.html">[squid-users] cache_peer and PROXY protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13852">[ date ]</a>
              <a href="thread.html#13852">[ thread ]</a>
              <a href="subject.html#13852">[ subject ]</a>
              <a href="author.html#13852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
