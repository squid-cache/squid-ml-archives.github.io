<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squidcliente stopped working!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squidcliente%20stopped%20working%21&In-Reply-To=%3C24fd01d25ad5%246f685c90%244e3915b0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013851.html">
   <LINK REL="Next"  HREF="013856.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squidcliente stopped working!</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squidcliente%20stopped%20working%21&In-Reply-To=%3C24fd01d25ad5%246f685c90%244e3915b0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] squidcliente stopped working!">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Dec 20 15:26:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013851.html">[squid-users] squidcliente stopped working!
</A></li>
        <LI>Next message (by thread): <A HREF="013856.html">[squid-users] squidcliente stopped working!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13855">[ date ]</a>
              <a href="thread.html#13855">[ thread ]</a>
              <a href="subject.html#13855">[ subject ]</a>
              <a href="author.html#13855">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It looks like your acls are denying access to the localhost because it's trying to access the proxy using ipv6.
Try to comment the &quot;::1 localhost&quot; line from /etc/hosts and try to see if it's the same.
If it's still not working you will need to write couple rules at the top of the squid.conf files to allow manager interface access from localhost.
Also since squid 3.2 you have the option to use curl or any other tool to access the info pages without squid client which can help you.
Try the next:
# curl <A HREF="http://localhost:3128/squid-internal-mgr/info">http://localhost:3128/squid-internal-mgr/info</A>

And see what happens.
Also if you have some filtering solution in this squid setup you will need to make an exception from this inspection on connections for localhost(both ipv4 and ipv6) since the admin doesn't need these restrictions.

Let me know about the results.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Sameh Onaissi
Sent: Tuesday, December 20, 2016 4:04 PM
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] squidcliente stopped working!


On Dec 19, 2016, at 11:55 PM, Amos Jeffries &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

On 20/12/2016 9:52 a.m., Sameh Onaissi wrote:



On Dec 19, 2016, at 1:31 PM, Antony Stone wrote:

On Monday 19 December 2016 at 17:44:11, Sameh Onaissi wrote:


Hello,

I was using squid client to get cache stats, however this morning it
completely stopped working.


&lt;center&gt;&lt;img src=&quot;<A HREF="http://mydomainname.com/squid/access_denied.jpg">http://mydomainname.com/squid/access_denied.jpg</A>&quot;
alt=&quot;Acceso Denegado&quot; style=&quot;width:704px;height:428px;&quot;&gt;&lt;/center&gt;


the html code is the code of my redirect page whenever a client tries to
access a blacklisted website.

How big is your blacklist?  Could you show us what's in it?

Have you added the proxy itself to the whitelist?

The blacklist consistes of the ads, porn, socialnet and spyware lists of the BL list. 

I added both LAN and WAN IPs of the server to the whitelist but didn&#8217;t help.

What URL was being requested that got the above access denied response?

Use -vv parameter to squidclient and &quot;debug_options 11,2&quot; in squid.conf
to have the requests header logged and find that out.

This is what shows now:

verbosity level set to 2
Request:
GET cache_<A HREF="object://localhost/info">object://localhost/info</A> HTTP/1.0
Host: localhost
User-Agent: squidclient/3.5.22
Accept: */*
Connection: close


.
Transport detected: IPv4-mapped  and IPv6
Resolving localhost ...
Connecting... localhost ([::1]:3128)
Connected to: localhost ([::1]:3128)
Sending HTTP request ... 
done.
HTTP/1.1 200 OK
Date: Tue, 20 Dec 2016 14:03:46 GMT
Server: Apache/2.4.7 (Ubuntu)
Last-Modified: Fri, 25 Nov 2016 16:55:22 GMT
ETag: &quot;bd-54222fce80317&quot;
Accept-Ranges: bytes
Content-Length: 189
Vary: Accept-Encoding
Content-Type: text/html
Age: 103
X-Cache: HIT from <A HREF="http://squidpxy.domain.com">http://squidpxy.domain.com</A>
X-Cache-Lookup: HIT from <A HREF="http://squidpxy.domain.com:3128">http://squidpxy.domain.com:3128</A>
Via: 1.1 <A HREF="http://squidpxy.domain.com">http://squidpxy.domain.com</A> (squid/3.5.22)
Connection: close

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;


&lt;center&gt;&lt;img src=&quot;<A HREF="http://www.domain.com/squid/access_denied.jpg">http://www.domain.com/squid/access_denied.jpg</A>&quot; alt=&quot;Acceso Denegado&quot; style=&quot;width:704px;height:428px;&quot;&gt;&lt;/center&gt;

&lt;/body&gt;
&lt;/html&gt;


And in the access log:

1482242596.513      0 ::1 TCP_MEM_HIT/200 598 GET cache_<A HREF="object://localhost/info">object://localhost/info</A> - HIER_NONE/- text/html








So, I changed my default acl setting in squid guard config file to pass all for now (I know it is not ideal), just to monitor the cache as I am trying to get the HIT ratio up. (currently only at 7.8%)

squid guard config: <A HREF="http://pastebin.com/bbe8CWLE">http://pastebin.com/bbe8CWLE</A>

So your SG config just does basic IP, URL and time based allow or
redirect decisions.

I suggest you drop SG entirely and move that config into your squid.conf:


# Time rules
# abbrev for weekdays:
# s = sun, m = mon, t =tue, w = wed, h = thu, f = fri, a = sat
acl non-working-hours time MTWHF 18:00-24:00 00:00-08:00
acl non-working-hours time MTWHF 18:00-24:00 00:00-08:00
acl non-working-hours time SA 00:00-24:00

# Source addresses
acl exempt src 10.0.0.90 10.0.0.167
acl youtubers src 10.0.0.1-10.0.0.4
acl localnet src 10.0.0.0/24

# Destination classes
acl blah_domains dstdomain &quot;adv/domains&quot;
acl blah_domains dstdomain &quot;deny/domains&quot;
acl blah_domains dstdomain &quot;porn/domains&quot;
acl blah_domains dstdomain &quot;spyware/domains&quot;
acl blah_domains dstdomain &quot;socialnet/domains&quot;

acl blah_urls dstdom_regex &quot;adv/urls&quot;
acl blah_urls dstdom_regex &quot;deny/urls&quot;
acl blah_urls dstdom_regex &quot;porn/urls&quot;
acl blah_urls dstdom_regex &quot;spyware/urls&quot;
acl blah_urls dstdom_regex &quot;socialnet/urls&quot;

acl stuff_always_blocked anyof blah_domains blah_urls

acl whitelist_domains dstdomain &quot;whitelist/domains&quot;
acl whitelist_urls dstdom_regex &quot;whitelist/urls&quot;
acl whitelist anyof whitelist_domains whitelist_urls
deny_info 302:<A HREF="http://example.com/squid/denegado.html">http://example.com/squid/denegado.html</A> whitelist

acl youtubers_domains dstdomain &quot;socialnet/domains&quot;
acl youtubers_urls dstdom_regex &quot;adv/urls&quot;
acl youtubers anyof youtubers_domains youtubers_urls
deny_info 302:<A HREF="http://example.com/squid/denegado.html">http://example.com/squid/denegado.html</A> youtubers

# Policies
http_access deny !localnet
deny_info 302:<A HREF="http://example.com/squid/denegado.html">http://example.com/squid/denegado.html</A> localnet

http_access allow exempt
http_access allow youtubers !stuff_always_blocked
http_access deny youtubers
http_access allow non-working-hours
http_access allow whitelist !stuff_always_blocked
http_access deny whitelist
http_access allow localnet

deny_info 302:<A HREF="http://example.com/squid/denegado.html">http://example.com/squid/denegado.html</A> all
http_access deny all







squid.conf: <A HREF="http://pastebin.com/TQ8H6bRp">http://pastebin.com/TQ8H6bRp</A>

Quote from your config:

acl Safe_ports port 587 #SMTP

Did you read Amos' reply &quot;SMTP is the #1 worst protocol to let anywhere near 
an HTTP proxy.  Preventing what you have allowed to happen is one of the 
primary reasons Safe_ports exists in the first place!&#8221;



The reason I allow 587 is because the Squid Proxy lives on the same
server as a mail server which needs this port, and several clients have
their mail clientes (Outlook..etc) already configured to use this port.

Bogus. You should know it is possible that two pieces of software can
run on one machine without interferring with each other.

Whether or not a mailserver exists on the same machine has nothing to do
with Squid.

Your mailserver itself should be using that port and controlling what
traffic can use it. *HTTP* traffic should never be allowed to flow from
the proxy software through to the mailserver software.

Amos

_______________________________________________
squid-users mailing list
mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013851.html">[squid-users] squidcliente stopped working!
</A></li>
	<LI>Next message (by thread): <A HREF="013856.html">[squid-users] squidcliente stopped working!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13855">[ date ]</a>
              <a href="thread.html#13855">[ thread ]</a>
              <a href="subject.html#13855">[ subject ]</a>
              <a href="author.html#13855">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
