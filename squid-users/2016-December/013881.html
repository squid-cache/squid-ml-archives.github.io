<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Antw: Re: CentOS Linux 7 / squid-3.5.20-2.el7.x86_64 / LDAP / ECAP / squidGuard blacklisting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Antw%3A%20Re%3A%20CentOS%20Linux%207%20/%20squid-3.5.20-2.el7.x86_64%0A%20/%20LDAP%20/%20ECAP%20/%20squidGuard%20blacklisting&In-Reply-To=%3C585B9250020000090002447E%40mail01.hospital-borken.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013879.html">
   <LINK REL="Next"  HREF="013872.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Antw: Re: CentOS Linux 7 / squid-3.5.20-2.el7.x86_64 / LDAP / ECAP / squidGuard blacklisting</H1>
    <B>bjoern wahl</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Antw%3A%20Re%3A%20CentOS%20Linux%207%20/%20squid-3.5.20-2.el7.x86_64%0A%20/%20LDAP%20/%20ECAP%20/%20squidGuard%20blacklisting&In-Reply-To=%3C585B9250020000090002447E%40mail01.hospital-borken.de%3E"
       TITLE="[squid-users] Antw: Re: CentOS Linux 7 / squid-3.5.20-2.el7.x86_64 / LDAP / ECAP / squidGuard blacklisting">bjoern.wahl at hospital-borken.de
       </A><BR>
    <I>Thu Dec 22 07:44:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013879.html">[squid-users] CentOS Linux 7 / squid-3.5.20-2.el7.x86_64 / LDAP / ECAP / squidGuard blacklisting
</A></li>
        <LI>Next message (by thread): <A HREF="013872.html">[squid-users] Bypassed Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13881">[ date ]</a>
              <a href="thread.html#13881">[ thread ]</a>
              <a href="subject.html#13881">[ subject ]</a>
              <a href="author.html#13881">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello!

Thanks for your input.

Remember: This is still a test environment.

Never the less i very much appreciate your answer.

Lets do it one by one.

-&gt; this was never meant to be a tutorial. I just send this because such
an info would have saved me some time and as i didn`t find any
information on eDir/Ldap/Squid auth i just thought it would be nice to
post some infos, never meant to be a perfect solution to copy.

Skipping 1-2 things you mentioned, the next thing to answer would be the
&quot;bypass=off&quot; info you gave.

-&gt; Thanks for this, i also found that, and did a correction on this.

The securityrules  in the config, that are ignored...

-&gt; This is because of the whole testing i did here. These are leftovers
from the standard config comming with the installation.

Your comment an SquidGuard an HTTPS.

-&gt; It is right, that SquidGuard is blocking HTTPS by this config. So the
questions are two:

1.) What other to user than SquidGuard ?
2.) or how to deal with HTTPS  ?

Because of the clear-text credatials:

-&gt; what would be your alternative in this environment ?

Thanks for your time !

Bj&#246;rn

On 21/12/2016 11:24 p.m., bjoern wahl wrote:
&gt;<i> Hello!
</I>&gt;<i>
</I>&gt;<i> Just for those who would like to have a:
</I>&gt;<i>
</I>&gt;<i> Squid with Ldap user auth on an eDirectory with an ecap (watch out !
</I>It
&gt;<i> is not i-cap!) virus check and squidGuard for blacklisting.
</I>&gt;<i>
</I>&gt;<i> One think not working for me so far is the redirect to a virus info
</I>site
&gt;<i> if ecap/clamd did find a virus. By now the user is informed that the
</I>&gt;<i> access was &quot;denied&quot; but not why. A thing i do not like with this setup
</I>&gt;<i> right now. (still working on this!)
</I>
You have missed out the most important part of this tutorial...
  Where to get the eCAP adapter.


&gt;<i>
</I>&gt;<i> The working squid.conf looks like this:
</I>&gt;<i>
</I>&gt;<i> =================================================================
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">xxx at mail.de</A>
</I>&gt;<i> http_port IPADDRESSOFSERVER:3128
</I>
Or just use the default &quot;http_port 3128&quot; config line provided. If you
hard-code IP addresses unnecessarily into configs you just make yourself
do extra work maintaining them.

&gt;<i> acl localnet src 10.0.0.0/8    # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12    # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16    # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly
</I>plugged)
&gt;<i> machines
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80        # http
</I>&gt;<i> acl Safe_ports port 21        # ftp
</I>&gt;<i> acl Safe_ports port 443        # https
</I>&gt;<i> acl Safe_ports port 70        # gopher
</I>&gt;<i> acl Safe_ports port 210        # wais
</I>&gt;<i> acl Safe_ports port 1025-65535    # unregistered ports
</I>&gt;<i> acl Safe_ports port 280        # http-mgmt
</I>&gt;<i> acl Safe_ports port 488        # gss-http
</I>&gt;<i> acl Safe_ports port 591        # filemaker
</I>&gt;<i> acl Safe_ports port 777        # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> auth_param basic program /usr/lib64/squid/basic_ldap_auth -b o=XXXX -h
</I>&gt;<i> IPOFEDIRSERVER -D cn=XXX,o=XXX -w PASSWORDOFUSER -f
</I>&gt;<i> &quot;(&amp;(objectclass=User)(cn=%s))&quot;
</I>&gt;<i> auth_param basic children 5
</I>&gt;<i> auth_param basic realm WHATEVER-YOU-LIKE-TO-TELL-THE-USER
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> ecap_enable on
</I>&gt;<i> loadable_modules /usr/local/lib/ecap_clamav_adapter.so
</I>&gt;<i> ecap_service clamav_service_req reqmod_precache
</I>&gt;<i> uri=<A HREF="ecap://e-cap.org/ecap/services/clamav?mode=REQMOD">ecap://e-cap.org/ecap/services/clamav?mode=REQMOD</A> bypass=off
</I>&gt;<i> ecap_service clamav_service_resp respmod_precache
</I>&gt;<i> uri=<A HREF="ecap://e-cap.org/ecap/services/clamav?mode=RESPMOD">ecap://e-cap.org/ecap/services/clamav?mode=RESPMOD</A> bypass=on
</I>
Since bypass=on if the eCAP service has any error. (Such as finding a
virus perhapse?) The eCAP adapter will stop being used for some minutes.

If you want scanners like this to filter all traffic you need to set
bypass=off and fix any/every-thing that causes service outages.


&gt;<i> adaptation_access clamav_service_req allow all
</I>&gt;<i> adaptation_access clamav_service_resp allow all
</I>&gt;<i> acl ediruse
</I>r proxy_auth REQUIRED
&gt;<i> http_access allow ediruser
</I>&gt;<i> http_acbypass them completely for all traffic?
</I>
The http_access lines above this should all be down ...

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>
... here.

At which point you will find yourself looking at two &quot;deny all&quot; rules in
a row. Do the obvious to fix that.

&gt;<i> http_access deny all
</I>&gt;<i> http_port 3128
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:        1440    20%    10080
</I>&gt;<i> refresh_pattern ^gopher:    1440    0%    1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0
</I>&gt;<i> refresh_pattern .        0    20%    4320
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
</I>&gt;<i> url_rewrite_children 15
</I>&gt;<i> url_rewrite_access allow all
</I>
Which is the default setting for &quot;url_rewrite_access&quot; directive.

And BTW, SquidGuard cannot cope with many HTTP extension request methods
in modern traffic. You will at the very least have to prevent it seeing
the CONNECT messages.

You should then realize that any users doing HTTPS can easily bypass
your SG URL mangling &quot;control&quot;. If you are lucky right now SG will be
&quot;blocking&quot; HTTPS by breaking the Squid transaction on each attempt to
use it.

Otherwise what this config actually does is cause clients to send their
user credentials in clear-text across the network, while possibly
letting any client that can see and re-use anothers users credentials
create tunnels through the proxy. Hackers paradise.

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
Tr&#228;ger: Klinikum Westm&#252;nsterland GmbH
Jur. Sitz der Gesellschaft: Am Boltenhof 7, 46325 Borken
Registergericht Coesfeld, HRB Nr. 4184 I Ust.-Id.Nr.: DE123762133
Gesch&#228;ftsf&#252;hrer: Christoph Br&#246;cker, Ludger Hellmann (Sprecher)
Aufsichtsratsvorsitzender: J&#252;rgen B&#252;ngeler

Diese E-Mail enth&#228;lt vertrauliche oder rechtlich gesch&#252;tzte
Informationen. Wenn Sie nicht der beabsichtigte Empf&#228;nger sind,
informieren Sie bitte sofort den Absender und l&#246;schen Sie diese E-Mail.
Das unbefugte Kopieren dieser E-Mail oder die unbefugte Weitergabe der
enthaltenen Informationen ist nicht gestattet.




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013879.html">[squid-users] CentOS Linux 7 / squid-3.5.20-2.el7.x86_64 / LDAP / ECAP / squidGuard blacklisting
</A></li>
	<LI>Next message (by thread): <A HREF="013872.html">[squid-users] Bypassed Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13881">[ date ]</a>
              <a href="thread.html#13881">[ thread ]</a>
              <a href="subject.html#13881">[ subject ]</a>
              <a href="author.html#13881">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
