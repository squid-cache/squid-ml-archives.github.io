<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL and outgoing IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20and%20outgoing%20IP&In-Reply-To=%3Cb423a315c53ac771f5e746e761fa1a97%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013917.html">
   <LINK REL="Next"  HREF="013918.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL and outgoing IP</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20and%20outgoing%20IP&In-Reply-To=%3Cb423a315c53ac771f5e746e761fa1a97%40treenet.co.nz%3E"
       TITLE="[squid-users] ACL and outgoing IP">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 29 06:35:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013917.html">[squid-users] ACL and outgoing IP
</A></li>
        <LI>Next message (by thread): <A HREF="013918.html">[squid-users] SNAT BASED on tos. Anyone tried it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13924">[ date ]</a>
              <a href="thread.html#13924">[ thread ]</a>
              <a href="subject.html#13924">[ subject ]</a>
              <a href="author.html#13924">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2016-12-28 05:03, qdmetro wrote:
&gt;<i> Hello,
</I>&gt;<i> I have an issue with acl and outgoing ip address.
</I>&gt;<i> 
</I>&gt;<i> I have a squid connected behind a firewall. On the firewall, only the 
</I>&gt;<i> Ip of
</I>&gt;<i> the squid (192.168.1.1) is allowed to go on Internet.
</I>&gt;<i> 
</I>&gt;<i> Usually, when a user authenticate itself on the proxy, all the requests 
</I>&gt;<i> use
</I>&gt;<i> the outgoing IP of the squid (192.168.1.1) so the can access to the 
</I>&gt;<i> website.
</I>&gt;<i> I want to allow some websites to be reachable without authentication
</I>&gt;<i> (especially for the activation of windows licences). I've tried this :
</I>&gt;<i> 
</I>&gt;<i> /acl Microsoft dstdomain .microsoft.com
</I>&gt;<i> http_access allow Microsoft/
</I>&gt;<i> 
</I>&gt;<i> With this configuration, the requests don't use the outgoing Ip of the 
</I>&gt;<i> proxy
</I>&gt;<i> anymore, so they come to my firewall with the source IP of the client 
</I>&gt;<i> (which
</I>&gt;<i> is not allowed to go on the Internet).
</I>&gt;<i> I've tried this to force the outgoing IP for this acl :
</I>&gt;<i> 
</I>&gt;<i> /tcp_outgoing_address 192.168.1.1 Microsoft/
</I>&gt;<i> 
</I>&gt;<i> but the request still don't use the IP of the proxy.
</I>&gt;<i> 
</I>&gt;<i> Maybe this kind of configuration isn't possible, or I miss something...
</I>&gt;<i> Any idea to help me ?
</I>&gt;<i> 
</I>
Something other than Squid is causing that. Connections outgoing Squid 
have their IPs selected by the OS. Usually there is one main/primary IP 
on the machine and that gets selected. But things like routing rules or 
NAT can alter that.

Setting tcp_outgoing_address Squid tells the OS it should select that IP 
unless there is a specific admin config forcing something else (like a 
NAT on outgoing traffic).


I've added some comments about changes to improve your config below, but 
nothing that will fix the address issue.


On 2016-12-28 21:22, qdmetro wrote:
&gt;<i> Here the squid.conf :
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid3/squid_kerb_auth -s
</I>&gt;<i> GSS_C_NO_NAME HTTP/hostname.domain.com
</I>&gt;<i> auth_param negotiate children 200
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> auth_param basic program /usr/lib/squid3/squid_ldap_auth -b
</I>&gt;<i> &quot;ou=users,dc=ref,dc=local&quot; -u uid ref.domain.com
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c 
</I>&gt;<i> /etc/squidguard/squidGuard.conf
</I>&gt;<i> url_rewrite_children 80
</I>&gt;<i> acl SSL_ports port 443 4443
</I>&gt;<i> acl SSL_ports port 563 4431
</I>&gt;<i> acl SSL_ports port 873
</I>&gt;<i> acl SSL_ports port 7071
</I>&gt;<i> acl SSL_ports port 33333 33334
</I>&gt;<i> acl SSL_ports port 83
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 22
</I>&gt;<i> acl Safe_ports port 80 81
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl domain_auth proxy_auth REQUIRED
</I>&gt;<i> acl localhost src 127.0.0.1/32
</I>&gt;<i> acl password proxy_auth REQUIRED
</I>
Since &quot;password&quot; and &quot;domain_auth&quot; ACLs are defined identically and 
neither is tied to anything fancy like deny_inf. You can pick one of 
them and remove it.

&gt;<i> visible_hostname name
</I>&gt;<i> snmp_port 3401
</I>&gt;<i> acl acl_snmp snmp_community com_name
</I>&gt;<i> snmp_access allow acl_snmp
</I>&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;<i> acl Microsoft dstdomain .microsoft.com
</I>&gt;<i> delay_pools 2
</I>&gt;<i> delay_class 2 2
</I>&gt;<i> delay_access 2 allow localnet
</I>&gt;<i> delay_parameters 2 12233386/12233386 12233386/12233386
</I>&gt;<i> forwarded_for on
</I>&gt;<i> follow_x_forwarded_for allow localnet
</I>
That tells Squid that all clients within the localnet (LAN) are allowed 
to forge XFF headers.

Proper use of this directive is to &quot;allow&quot; only the client proxies you 
are confident will not send your proxy fake values in that header. 
Usually you are managing the downstream proxy yourself, or at least have 
contact with its admin if not.

NP: The follow_* directive has nothing to do with your Squid producing 
or updating the XFF headers. &quot;forwarded_for on&quot; does that.

The forwarded_for directive is set to its default. So unless there is 
any reason you need follow-* to be set for some clients you should just 
remove those XFF related lines and let Squid do the default action.


&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
I advise placing this rule here:
   http_access deny !localnet

After that you can then remove the 'localnet' ACL from the below lines.

&gt;<i> http_access allow Microsoft
</I>&gt;<i> tcp_outgoing_address 192.168.1.1 Microsoft
</I>&gt;<i> http_access allow localnet password
</I>&gt;<i> http_access allow localnet domain_auth
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_reply_access allow localnet
</I>
After the http_access change above, you can also remove this 
http_reply_access line.

&gt;<i> icp_access deny all
</I>&gt;<i> htcp_access deny all
</I>
Since you are just denying ICP and HTCP usage it would be better to 
remove all icp_* and htcp_* lines from your config. The default in 
current Squid versions is to no even open those ports.

&gt;<i> http_port 3128
</I>&gt;<i> icp_port 3130
</I>&gt;<i> dns_v4_first on
</I>

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013917.html">[squid-users] ACL and outgoing IP
</A></li>
	<LI>Next message (by thread): <A HREF="013918.html">[squid-users] SNAT BASED on tos. Anyone tried it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13924">[ date ]</a>
              <a href="thread.html#13924">[ thread ]</a>
              <a href="subject.html#13924">[ subject ]</a>
              <a href="author.html#13924">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
