<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid sibling peers and digest requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3CCAHvB88ycK3RbM9UG2pyjDxeO_3KJoLk3auqLZRnR9TNg3tsO%3DA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013926.html">
   <LINK REL="Next"  HREF="013930.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid sibling peers and digest requests</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3CCAHvB88ycK3RbM9UG2pyjDxeO_3KJoLk3auqLZRnR9TNg3tsO%3DA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid sibling peers and digest requests">xeron.oskom at gmail.com
       </A><BR>
    <I>Thu Dec 29 07:51:27 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013926.html">[squid-users] squid sibling peers and digest requests
</A></li>
        <LI>Next message (by thread): <A HREF="013930.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13928">[ date ]</a>
              <a href="thread.html#13928">[ thread ]</a>
              <a href="subject.html#13928">[ subject ]</a>
              <a href="author.html#13928">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm sure about forwarding because I see requests to
<A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> in parent
logs and my parent returns 502 because we do not allow requests to internal
IPs. Logs from the parent:

Got request: GET
<A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A>
Not allowing blacklisted IP 172.22.15.88
GET <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> 502 0ms

I do not have &quot;global_internal_static off&quot; in my config and also I'm able
to get <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> using
curl or telnet (with telnet I do &quot;GET /squid-internal-periodic/store_digest&quot;
&#8211; note relative URL).

However according to debug logs squid does this request using absolute URL
which probably works if target sibling can do direct requests (so it will
request itself for digest and return response to original squid). But I do
have &quot;never_direct allow all&quot; which probably makes sibling to forward such
request to a parent.

If my theory about absolute vs relative URL is correct then I believe
original squid should make store_digest request using relative URL (like I
can do with telnet) so sibling squid will return response right away w/o
asking itself for result.

This is more complete config (only stripped default things like localnet acls
/ http_access), note that I have 2 parents actually which I select based on
header (but all requests w/o header will go to the first parent), and also
have:

via off
never_direct allow all
forwarded_for off

# START CONFIG ====================

# Allow HTCP queries from local networks only
htcp_access allow localnet
htcp_access allow localhost
htcp_access deny all

# Other squids
cache_peer 172.22.15.88 sibling 3128 4827 htcp
cache_peer &#8230; sibling 3128 4827 htcp
acl siblings src 172.22.15.88/32
acl siblings src &#8230;/32
miss_access deny siblings

acl header_a req_header header_a -i true
acl header_b req_header header_b -i true

# name1 parent
cache_peer 127.0.0.1 parent 18070 0 no-query no-digest name=name1
cache_peer_access name1 deny header_a
cache_peer_access name1 deny header_b

# name2 parent
cache_peer 127.0.0.1 parent 18079 0 no-query no-digest name=name2
cache_peer_access name2 allow header_a
cache_peer_access name2 allow header_b
cache_peer_access name2 deny all

cache_mem &#8230;
maximum_object_size_in_memory &#8230;
memory_replacement_policy &#8230;
cache_replacement_policy &#8230;

cache_dir aufs &#8230; &#8230; 16 256

minimum_object_size &#8230; bytes # none-zero so we dont cache mistakes
maximum_object_size &#8230; KB

client_db off

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
# refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# don't cache errors
negative_ttl 0 minutes
# always fetch object from the beginning regardless of Range requests
range_offset_limit none
via off
cache_effective_user squid
cache_effective_group squid
# disable icp
icp_port 0
never_direct allow all
forwarded_for off

# END CONFIG ====================

On Wed, Dec 28, 2016 at 11:15 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 2016-12-29 16:03, Ivan Larionov wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to setup multiple squids as siblings with a parent which is
</I>&gt;&gt;<i> not even a squid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I'm getting following message in logs:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> temporary disabling (Bad Gateway) digest from 172.22.15.88
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> temporary disabling (Bad Gateway) digest from &#8230;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid 3.5.23, compiled with &quot;--enable-cache-digests&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For parent I'm setting no-digest, but I'd like to get digests between
</I>&gt;&gt;<i> siblings. However, it doesn't work and I probably found a reason after
</I>&gt;&gt;<i> reading debug logs:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is how squid does store_digest request from a sibling peer:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> GET <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1]
</I>&gt;&gt;<i> HTTP/1.1
</I>&gt;&gt;<i> Accept: application/cache-digest
</I>&gt;&gt;<i> Accept: text/html
</I>&gt;&gt;<i> X-Forwarded-For: unknown
</I>&gt;&gt;<i> Host: 172.22.15.88:3128 [2]
</I>&gt;&gt;<i> Cache-Control: max-age=259200
</I>&gt;&gt;<i> Connection: keep-alive
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Response (if I execute this request manually from telnet):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTTP/1.1 502 Bad Gateway
</I>&gt;&gt;<i> &#8230;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This request has been forwarded to a parent and parent returned 502!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Are you sure about that forwarding?
</I>&gt;<i>  Its not being generated by the sibling?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now if I manually do the same request with a relative URL:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> GET /squid-internal-periodic/store_digest HTTP/1.1
</I>&gt;&gt;<i> &#8230;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Response:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTTP/1.1 200 Cache Digest OK
</I>&gt;&gt;<i> &#8230;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My setup:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Multiple squids as siblings, one parent (not a squid).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Peers configuration:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Other squids
</I>&gt;&gt;<i> cache_peer 172.22.15.88 sibling 3128 4827 htcp
</I>&gt;&gt;<i> cache_peer &#8230; sibling 3128 4827 htcp
</I>&gt;&gt;<i> acl siblings src 172.22.15.88/32 [3]
</I>&gt;&gt;<i> acl siblings src &#8230;/32
</I>&gt;&gt;<i> miss_access deny siblings
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Parent
</I>&gt;&gt;<i> cache_peer 127.0.0.1 parent 18070 0 no-query no-digest name=NAME
</I>&gt;&gt;<i> cache_peer_access NAME deny some_acl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anyone else seen similar issue? Do you have an example of working
</I>&gt;&gt;<i> configuration with multiple siblings and enabled digests?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The default config usually just works.
</I>&gt;<i>
</I>&gt;<i> Do you have &quot;global_internal_static off&quot; in your squid.conf?
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161228/678804a0/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161228/678804a0/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013926.html">[squid-users] squid sibling peers and digest requests
</A></li>
	<LI>Next message (by thread): <A HREF="013930.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13928">[ date ]</a>
              <a href="thread.html#13928">[ thread ]</a>
              <a href="subject.html#13928">[ subject ]</a>
              <a href="author.html#13928">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
