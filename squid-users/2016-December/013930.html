<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid sibling peers and digest requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3Cfbac4b898433c81b46a362dd3869c0f6%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013928.html">
   <LINK REL="Next"  HREF="013932.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid sibling peers and digest requests</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3Cfbac4b898433c81b46a362dd3869c0f6%40treenet.co.nz%3E"
       TITLE="[squid-users] squid sibling peers and digest requests">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 29 09:00:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013928.html">[squid-users] squid sibling peers and digest requests
</A></li>
        <LI>Next message (by thread): <A HREF="013932.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13930">[ date ]</a>
              <a href="thread.html#13930">[ thread ]</a>
              <a href="subject.html#13930">[ subject ]</a>
              <a href="author.html#13930">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2016-12-29 20:51, Ivan Larionov wrote:
&gt;<i> I'm sure about forwarding because I see requests to
</I>&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1] in
</I>&gt;<i> parent logs and my parent returns 502 because we do not allow requests
</I>&gt;<i> to internal IPs. Logs from the parent:
</I>&gt;<i> 
</I>&gt;<i> Got request: GET
</I>&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A>
</I>&gt;<i> Not allowing blacklisted IP 172.22.15.88
</I>&gt;<i> GET <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> 502
</I>&gt;<i> 0ms
</I>&gt;<i> 
</I>&gt;<i> I do not have &quot;global_internal_static off&quot; in my config and also I'm
</I>&gt;<i> able to get
</I>&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1]
</I>&gt;<i> using curl or telnet (with telnet I do &quot;GET
</I>&gt;<i> /squid-internal-periodic/store_digest&quot; &#8211; note relative URL).
</I>
Okay, thats good.

&gt;<i> 
</I>&gt;<i> However according to debug logs squid does this request using absolute
</I>&gt;<i> URL which probably works if target sibling can do direct requests (so
</I>&gt;<i> it will request itself for digest and return response to original
</I>&gt;<i> squid). But I do have &quot;never_direct allow all&quot; which probably makes
</I>&gt;<i> sibling to forward such request to a parent.
</I>
Hmm, I think you might be right about that.
You can test it by adding:

  acl foo urlpath_regex +i /squid.internal.digest/
  never_direct deny foo


&gt;<i> 
</I>&gt;<i> If my theory about absolute vs relative URL is correct then I believe
</I>&gt;<i> original squid should make store_digest request using relative URL
</I>&gt;<i> (like I can do with telnet) so sibling squid will return response
</I>&gt;<i> right away w/o asking itself for result.
</I>
Whats happening with the URL is that the sending peer generates it from 
the cache_peer IP/host name and port.

The receiving peer checks the pathstarts with &quot;/squid-internal-&quot; and 
that the hostname portion matches its own visible_hostname or 
unique_hostname. If those match its marked for special handling as an 
internal request, otherwise global_internal_static is used to determine 
if the hostname not matching is ignored and it gets marked anyway.

Since the digest needs to be targeted at the specific peer and not 
anything which may inject itself in between them the hostname does need 
to be sent. The relative URLs are for things that don't vary between 
proxies, like the Squid icons.

If you configure cache_peer with the hostname of the receiving peer 
instead of its raw-IP the requests should be sent with that hostname 
instead of raw-IP.



The config looks okay. Thanks for that.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013928.html">[squid-users] squid sibling peers and digest requests
</A></li>
	<LI>Next message (by thread): <A HREF="013932.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13930">[ date ]</a>
              <a href="thread.html#13930">[ thread ]</a>
              <a href="subject.html#13930">[ subject ]</a>
              <a href="author.html#13930">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
