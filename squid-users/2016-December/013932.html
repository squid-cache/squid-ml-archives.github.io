<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid sibling peers and digest requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3CCAHvB88xBBL5TxaxuQ%2B47d2OvkhGHpK7oToBJC6AbW-i2nZ2h%3Dw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013930.html">
   <LINK REL="Next"  HREF="013933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid sibling peers and digest requests</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3CCAHvB88xBBL5TxaxuQ%2B47d2OvkhGHpK7oToBJC6AbW-i2nZ2h%3Dw%40mail.gmail.com%3E"
       TITLE="[squid-users] squid sibling peers and digest requests">xeron.oskom at gmail.com
       </A><BR>
    <I>Thu Dec 29 22:21:49 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013930.html">[squid-users] squid sibling peers and digest requests
</A></li>
        <LI>Next message (by thread): <A HREF="013933.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13932">[ date ]</a>
              <a href="thread.html#13932">[ thread ]</a>
              <a href="subject.html#13932">[ subject ]</a>
              <a href="author.html#13932">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for helping.

After some experiments and tcpdumping it looks like it's not sibling
sending request to the parent, but original squid!

So instead of asking sibling about his digests squid asks parent.

And your trick with urlpath_regex didn't help. I even tried:

acl internal_digest urlpath_regex +i /.*store_digest.*/
always_direct allow internal_digest
never_direct deny internal_digest

but no luck. It still asks parent.


On Thu, Dec 29, 2016 at 1:00 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 2016-12-29 20:51, Ivan Larionov wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I'm sure about forwarding because I see requests to
</I>&gt;&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1] in
</I>&gt;&gt;<i> parent logs and my parent returns 502 because we do not allow requests
</I>&gt;&gt;<i> to internal IPs. Logs from the parent:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Got request: GET
</I>&gt;&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A>
</I>&gt;&gt;<i> Not allowing blacklisted IP 172.22.15.88
</I>&gt;&gt;<i> GET <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> 502
</I>&gt;&gt;<i> 0ms
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not have &quot;global_internal_static off&quot; in my config and also I'm
</I>&gt;&gt;<i> able to get
</I>&gt;&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1]
</I>&gt;&gt;<i> using curl or telnet (with telnet I do &quot;GET
</I>&gt;&gt;<i> /squid-internal-periodic/store_digest&quot; &#8211; note relative URL).
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Okay, thats good.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> However according to debug logs squid does this request using absolute
</I>&gt;&gt;<i> URL which probably works if target sibling can do direct requests (so
</I>&gt;&gt;<i> it will request itself for digest and return response to original
</I>&gt;&gt;<i> squid). But I do have &quot;never_direct allow all&quot; which probably makes
</I>&gt;&gt;<i> sibling to forward such request to a parent.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hmm, I think you might be right about that.
</I>&gt;<i> You can test it by adding:
</I>&gt;<i>
</I>&gt;<i>  acl foo urlpath_regex +i /squid.internal.digest/
</I>&gt;<i>  never_direct deny foo
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> If my theory about absolute vs relative URL is correct then I believe
</I>&gt;&gt;<i> original squid should make store_digest request using relative URL
</I>&gt;&gt;<i> (like I can do with telnet) so sibling squid will return response
</I>&gt;&gt;<i> right away w/o asking itself for result.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Whats happening with the URL is that the sending peer generates it from
</I>&gt;<i> the cache_peer IP/host name and port.
</I>&gt;<i>
</I>&gt;<i> The receiving peer checks the pathstarts with &quot;/squid-internal-&quot; and that
</I>&gt;<i> the hostname portion matches its own visible_hostname or unique_hostname.
</I>&gt;<i> If those match its marked for special handling as an internal request,
</I>&gt;<i> otherwise global_internal_static is used to determine if the hostname not
</I>&gt;<i> matching is ignored and it gets marked anyway.
</I>&gt;<i>
</I>&gt;<i> Since the digest needs to be targeted at the specific peer and not
</I>&gt;<i> anything which may inject itself in between them the hostname does need to
</I>&gt;<i> be sent. The relative URLs are for things that don't vary between proxies,
</I>&gt;<i> like the Squid icons.
</I>&gt;<i>
</I>&gt;<i> If you configure cache_peer with the hostname of the receiving peer
</I>&gt;<i> instead of its raw-IP the requests should be sent with that hostname
</I>&gt;<i> instead of raw-IP.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The config looks okay. Thanks for that.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161229/a9cd1ff1/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161229/a9cd1ff1/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013930.html">[squid-users] squid sibling peers and digest requests
</A></li>
	<LI>Next message (by thread): <A HREF="013933.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13932">[ date ]</a>
              <a href="thread.html#13932">[ thread ]</a>
              <a href="subject.html#13932">[ subject ]</a>
              <a href="author.html#13932">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
