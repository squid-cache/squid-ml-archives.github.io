<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid sibling peers and digest requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3CCAHvB88xr0nRmh68JogRgSWMGoYtV9LtBvEUWJ-uL-RhneBiBNQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013932.html">
   <LINK REL="Next"  HREF="013934.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid sibling peers and digest requests</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20sibling%20peers%20and%20digest%20requests&In-Reply-To=%3CCAHvB88xr0nRmh68JogRgSWMGoYtV9LtBvEUWJ-uL-RhneBiBNQ%40mail.gmail.com%3E"
       TITLE="[squid-users] squid sibling peers and digest requests">xeron.oskom at gmail.com
       </A><BR>
    <I>Fri Dec 30 00:15:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013932.html">[squid-users] squid sibling peers and digest requests
</A></li>
        <LI>Next message (by thread): <A HREF="013934.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13933">[ date ]</a>
              <a href="thread.html#13933">[ thread ]</a>
              <a href="subject.html#13933">[ subject ]</a>
              <a href="author.html#13933">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here are some debug logs from FwdState which handles digest request.

172.22.13.210 &#8211; original squid
172.22.8.145 &#8211; sibling squid
127.0.0.1:18070 &#8211; parent

As you can see it uses connection to parent for this request (reusing pconn
local=127.0.0.1:44120 remote=127.0.0.1:18070 FD 16 flags=1) which is
probably a bug.

2016/12/29 15:57:41.121| 17,3| FwdState.cc(332) Start: '
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>'
2016/12/29 15:57:41.121| 17,2| FwdState.cc(133) FwdState: Forwarding client
request , url=<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 15:57:41.121| 17,3| FwdState.cc(387) startConnectionOrFail:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 15:57:41.121| 17,3| FwdState.cc(806) connectStart:
fwdConnectStart:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 15:57:41.121| 17,3| FwdState.cc(875) connectStart: reusing pconn
local=127.0.0.1:44120 remote=127.0.0.1:18070 FD 16 flags=1
2016/12/29 15:57:41.121| 17,3| FwdState.cc(908) dispatch: : Fetching GET
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 15:57:41.124| 17,3| FwdState.cc(447) unregister:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 15:57:41.124| 17,2| FwdState.cc(655)
handleUnregisteredServerEnd: self=0x1450738*2 err=0
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>

And peer_select logs:

2016/12/29 16:12:41.843| 44,3| peer_select.cc(137) peerSelect:
e:=IWV/0x148bae0*2
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 16:12:41.843| 44,3| peer_select.cc(441) peerSelectFoo: GET
172.22.8.145
2016/12/29 16:12:41.843| 44,3| peer_select.cc(446) peerSelectFoo:
peerSelectFoo: direct = DIRECT_UNKNOWN (always_direct to be checked)
2016/12/29 16:12:41.844| 44,3| peer_select.cc(194)
peerCheckAlwaysDirectDone: peerCheckAlwaysDirectDone: DENIED
2016/12/29 16:12:41.844| 44,3| peer_select.cc(441) peerSelectFoo: GET
172.22.8.145
2016/12/29 16:12:41.844| 44,3| peer_select.cc(454) peerSelectFoo:
peerSelectFoo: direct = DIRECT_UNKNOWN (never_direct to be checked)
2016/12/29 16:12:41.844| 44,3| peer_select.cc(171)
peerCheckNeverDirectDone: peerCheckNeverDirectDone: ALLOWED
2016/12/29 16:12:41.844| 44,3| peer_select.cc(177)
peerCheckNeverDirectDone: direct = DIRECT_NO (never_direct allow)
2016/12/29 16:12:41.844| 44,3| peer_select.cc(441) peerSelectFoo: GET
172.22.8.145
2016/12/29 16:12:41.844| 44,3| peer_select.cc(110) peerSelectIcpPing:
peerSelectIcpPing:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>
2016/12/29 16:12:41.844| 44,3| peer_select.cc(121) peerSelectIcpPing:
peerSelectIcpPing: counted 0 neighbors
2016/12/29 16:12:41.844| 44,3| peer_select.cc(685) peerGetSomeParent: GET
172.22.8.145
2016/12/29 16:12:41.844| 44,3| peer_select.cc(709) peerGetSomeParent:
peerSelect: FIRSTUP_PARENT/127.0.0.1
2016/12/29 16:12:41.844| 44,5| peer_select.cc(938) peerAddFwdServer:
peerAddFwdServer: adding 127.0.0.1 FIRSTUP_PARENT
2016/12/29 16:12:41.844| 44,5| peer_select.cc(938) peerAddFwdServer:
peerAddFwdServer: adding 127.0.0.1 ANY_OLD_PARENT
2016/12/29 16:12:41.844| 44,2| peer_select.cc(258) peerSelectDnsPaths: Find
IP destination for:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>' via 127.0.0.1
2016/12/29 16:12:41.844| 44,2| peer_select.cc(258) peerSelectDnsPaths: Find
IP destination for:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>' via 127.0.0.1
2016/12/29 16:12:41.844| 44,2| peer_select.cc(280) peerSelectDnsPaths:
Found sources for '
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>'
2016/12/29 16:12:41.844| 44,2| peer_select.cc(281) peerSelectDnsPaths:
always_direct = DENIED
2016/12/29 16:12:41.844| 44,2| peer_select.cc(282) peerSelectDnsPaths:
 never_direct = ALLOWED
2016/12/29 16:12:41.844| 44,2| peer_select.cc(292) peerSelectDnsPaths:
 cache_peer = local=0.0.0.0 remote=127.0.0.1:18070 flags=1
2016/12/29 16:12:41.844| 44,2| peer_select.cc(292) peerSelectDnsPaths:
 cache_peer = local=0.0.0.0 remote=127.0.0.1:18070 flags=1
2016/12/29 16:12:41.844| 44,2| peer_select.cc(295) peerSelectDnsPaths:
   timedout = 0
2016/12/29 16:12:41.844| 44,3| peer_select.cc(79) ~ps_state:
<A HREF="http://172.22.8.145:3128/squid-internal-periodic/store_digest">http://172.22.8.145:3128/squid-internal-periodic/store_digest</A>


On Thu, Dec 29, 2016 at 2:21 PM, Ivan Larionov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">xeron.oskom at gmail.com</A>&gt;
wrote:

&gt;<i> Thank you for helping.
</I>&gt;<i>
</I>&gt;<i> After some experiments and tcpdumping it looks like it's not sibling
</I>&gt;<i> sending request to the parent, but original squid!
</I>&gt;<i>
</I>&gt;<i> So instead of asking sibling about his digests squid asks parent.
</I>&gt;<i>
</I>&gt;<i> And your trick with urlpath_regex didn't help. I even tried:
</I>&gt;<i>
</I>&gt;<i> acl internal_digest urlpath_regex +i /.*store_digest.*/
</I>&gt;<i> always_direct allow internal_digest
</I>&gt;<i> never_direct deny internal_digest
</I>&gt;<i>
</I>&gt;<i> but no luck. It still asks parent.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Dec 29, 2016 at 1:00 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 2016-12-29 20:51, Ivan Larionov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm sure about forwarding because I see requests to
</I>&gt;&gt;&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1] in
</I>&gt;&gt;&gt;<i> parent logs and my parent returns 502 because we do not allow requests
</I>&gt;&gt;&gt;<i> to internal IPs. Logs from the parent:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Got request: GET
</I>&gt;&gt;&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A>
</I>&gt;&gt;&gt;<i> Not allowing blacklisted IP 172.22.15.88
</I>&gt;&gt;&gt;<i> GET <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> 502
</I>&gt;&gt;&gt;<i> 0ms
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I do not have &quot;global_internal_static off&quot; in my config and also I'm
</I>&gt;&gt;&gt;<i> able to get
</I>&gt;&gt;&gt;<i> <A HREF="http://172.22.15.88:3128/squid-internal-periodic/store_digest">http://172.22.15.88:3128/squid-internal-periodic/store_digest</A> [1]
</I>&gt;&gt;&gt;<i> using curl or telnet (with telnet I do &quot;GET
</I>&gt;&gt;&gt;<i> /squid-internal-periodic/store_digest&quot; &#8211; note relative URL).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Okay, thats good.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> However according to debug logs squid does this request using absolute
</I>&gt;&gt;&gt;<i> URL which probably works if target sibling can do direct requests (so
</I>&gt;&gt;&gt;<i> it will request itself for digest and return response to original
</I>&gt;&gt;&gt;<i> squid). But I do have &quot;never_direct allow all&quot; which probably makes
</I>&gt;&gt;&gt;<i> sibling to forward such request to a parent.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hmm, I think you might be right about that.
</I>&gt;&gt;<i> You can test it by adding:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  acl foo urlpath_regex +i /squid.internal.digest/
</I>&gt;&gt;<i>  never_direct deny foo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If my theory about absolute vs relative URL is correct then I believe
</I>&gt;&gt;&gt;<i> original squid should make store_digest request using relative URL
</I>&gt;&gt;&gt;<i> (like I can do with telnet) so sibling squid will return response
</I>&gt;&gt;&gt;<i> right away w/o asking itself for result.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Whats happening with the URL is that the sending peer generates it from
</I>&gt;&gt;<i> the cache_peer IP/host name and port.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The receiving peer checks the pathstarts with &quot;/squid-internal-&quot; and that
</I>&gt;&gt;<i> the hostname portion matches its own visible_hostname or unique_hostname.
</I>&gt;&gt;<i> If those match its marked for special handling as an internal request,
</I>&gt;&gt;<i> otherwise global_internal_static is used to determine if the hostname not
</I>&gt;&gt;<i> matching is ignored and it gets marked anyway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since the digest needs to be targeted at the specific peer and not
</I>&gt;&gt;<i> anything which may inject itself in between them the hostname does need to
</I>&gt;&gt;<i> be sent. The relative URLs are for things that don't vary between proxies,
</I>&gt;&gt;<i> like the Squid icons.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you configure cache_peer with the hostname of the receiving peer
</I>&gt;&gt;<i> instead of its raw-IP the requests should be sent with that hostname
</I>&gt;&gt;<i> instead of raw-IP.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The config looks okay. Thanks for that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> With best regards, Ivan Larionov.
</I>&gt;<i>
</I>


-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161229/a2d6b76a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161229/a2d6b76a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013932.html">[squid-users] squid sibling peers and digest requests
</A></li>
	<LI>Next message (by thread): <A HREF="013934.html">[squid-users] squid sibling peers and digest requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13933">[ date ]</a>
              <a href="thread.html#13933">[ thread ]</a>
              <a href="subject.html#13933">[ subject ]</a>
              <a href="author.html#13933">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
