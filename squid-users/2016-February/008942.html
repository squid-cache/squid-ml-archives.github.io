<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TeamViewer and other http tunneled connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TeamViewer%20and%20other%20http%20tunneled%20connections&In-Reply-To=%3C56AF28F9.6030508%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008940.html">
   <LINK REL="Next"  HREF="008943.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TeamViewer and other http tunneled connections</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TeamViewer%20and%20other%20http%20tunneled%20connections&In-Reply-To=%3C56AF28F9.6030508%40treenet.co.nz%3E"
       TITLE="[squid-users] TeamViewer and other http tunneled connections">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Feb  1 09:44:25 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008940.html">[squid-users] TeamViewer and other http tunneled connections
</A></li>
        <LI>Next message (by thread): <A HREF="008943.html">[squid-users] ext_ldap_group_acl not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8942">[ date ]</a>
              <a href="thread.html#8942">[ thread ]</a>
              <a href="subject.html#8942">[ subject ]</a>
              <a href="author.html#8942">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/02/2016 9:56 p.m., Markus wrote:
&gt;<i> I've got a Squid server (v. 3.5.x) configured that way, that only some
</I>&gt;<i> &quot;banking sites&quot; are allowed to be tunneled (spliced) - the rest of SSL
</I>&gt;<i> sites are bumped.
</I>&gt;<i> That works OK. I thought that it prevents me from illegal
</I>&gt;<i> tunneling-out by users. However recently I've realized that TeamViewer
</I>&gt;<i> is still able  to establish connection over my Squid.
</I>&gt;<i> Moreover user's PC are totally blocked on my firewall - they only have
</I>&gt;<i> access to the web via Squid-proxy (their browsers are proxy aware).
</I>&gt;<i> 
</I>&gt;<i> Of course I can block out teamviewer.com domain by ACL - and that
</I>&gt;<i> works. But I'm wondering if there is any way to prevent such
</I>&gt;<i> tunnel-connection in future. (I mean another -  mainly malicious
</I>&gt;<i> software)
</I>&gt;<i> 
</I>&gt;<i> I've captured some details using Etherreal and it looks like
</I>&gt;<i> Teamviewer app does a normal http GET request to the TeamViewer's ASP
</I>&gt;<i> script
</I>&gt;<i> <A HREF="http://master13.teamviewer.com/din.aspx?s=00000000&amp;id=0&amp;client=DynGate&amp;rnd=144452645&amp;p=10000001">http://master13.teamviewer.com/din.aspx?s=00000000&amp;id=0&amp;client=DynGate&amp;rnd=144452645&amp;p=10000001</A>
</I>&gt;<i> 
</I>&gt;<i> TeamViewer's server response is an application/octet-stream , but it
</I>&gt;<i> contains an ID which is presumably used later in client's POST
</I>&gt;<i> request.
</I>&gt;<i> 
</I>&gt;<i> See: <A HREF="http://dev.3d.pl/tmp/teamv.png">http://dev.3d.pl/tmp/teamv.png</A>  (screenshot from Ethereal) and
</I>&gt;<i> TCP the stream <A HREF="http://dev.3d.pl/tmp/teamv.txt">http://dev.3d.pl/tmp/teamv.txt</A>
</I>&gt;<i> 
</I>&gt;<i> My question is - does the TeamViewer tunnel traffic differ in any way
</I>&gt;<i> from normal http binary content transmission (eg. youtube or radio
</I>&gt;<i> streaming) ?
</I>
&quot;Maybe&quot;. Both of the examples you mention are applications that use both
HTTP(S)/ICY streaming, and non-HTTP(S) streaming protocols depending on
which works.

If TeamViewer traffic is taking the form of HTTP(S) messages, then
SSL-Bump has nothing to do with it. They are HTTP(S) messages.

If TeamViewer is using non-HTTP protocol over TLS after the initial
HTTP(S) setup, then...


&gt;<i> 
</I>&gt;<i> Can we somehow detect that this kind of transmission is probably a
</I>&gt;<i> tunnel traffic?
</I>
What Squid can determine is whether the TLS tunneled protocol is one
that it can proxy (HTTP, ICY, FTP). Squid-3 versions all have a single
explicit action that they do, which varies from auto-deny to auto-allow
depending on the version. You need Squid-4 to control it...

&gt;<i> 
</I>&gt;<i> Sorry if my post is a bit chaotic, but I'm kinda confused now , how it works.
</I>&gt;<i> 
</I>&gt;<i> Please note - I'm not talking only about TeamViewer itself but in
</I>&gt;<i> general about HTTP-tunneled traffic.  Maybe an ICAP server could be
</I>&gt;<i> useful here? but how do I know what to look for? (how should
</I>&gt;<i> ACLs/rules look like)
</I>
ICAP services cannot handle non-HTTP message types, and Squid does even
attempt to pass CONNECT messages to them IIRC.

&gt;<i> 
</I>&gt;<i> or you want to tell me, that the only possible way is continuous
</I>&gt;<i> observation what's new &quot;on market&quot; and adding new rules?
</I>
Squid-3.x depend on http_access rules managing the CONNECT requests that
Squid synthesizes for new client connections. The info on that is
limited to raw-IP:port or perhapse SNI:port, depending on version and
what ssl-bump processing as been done so far in the transaction.


Squid-4 also has the on_unsupported_protocol directive - which takes
effect at the point Squid attempts to decrypt the TLS traffic. At that
point Squid discovers if the traffic is HTTP/ICY or not. You can use
ACLs with that to whitelist non-HTTP TLS services you want tunneled
through Squid, but send an error for everything else.
The HTTP(S), ICY or FTP services are controlled as normal through
http_access.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008940.html">[squid-users] TeamViewer and other http tunneled connections
</A></li>
	<LI>Next message (by thread): <A HREF="008943.html">[squid-users] ext_ldap_group_acl not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8942">[ date ]</a>
              <a href="thread.html#8942">[ thread ]</a>
              <a href="subject.html#8942">[ subject ]</a>
              <a href="author.html#8942">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
