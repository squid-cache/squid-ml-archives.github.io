<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Debugging http_access and http_reply_access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20http_access%20and%20http_reply_access&In-Reply-To=%3C56B1D11F.7010707%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008981.html">
   <LINK REL="Next"  HREF="008992.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Debugging http_access and http_reply_access</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20http_access%20and%20http_reply_access&In-Reply-To=%3C56B1D11F.7010707%40treenet.co.nz%3E"
       TITLE="[squid-users] Debugging http_access and http_reply_access">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb  3 10:06:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008981.html">[squid-users] Debugging http_access and http_reply_access
</A></li>
        <LI>Next message (by thread): <A HREF="008992.html">[squid-users] Debugging http_access and http_reply_access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8982">[ date ]</a>
              <a href="thread.html#8982">[ thread ]</a>
              <a href="subject.html#8982">[ subject ]</a>
              <a href="author.html#8982">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/02/2016 7:19 p.m., <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at filter.luko.org</A> wrote:
&gt;<i> Hi Squid users,
</I>&gt;<i> 
</I>&gt;<i> I'm seeking some guidance regarding the best way to debug the http_access
</I>&gt;<i> and http_reply_access configuration statements on a moderately busy Squid
</I>&gt;<i> 3.5 cache.  In cases where a number (say, 5 or more) of http_access lines
</I>&gt;<i> are present, the goal is to find which configuration statement (if any) was
</I>&gt;<i> found to match for a given request, then write this information to a log for
</I>&gt;<i> further processing.  Example:
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny out_working_hours
</I>&gt;<i> http_access allow working_hours whitelist
</I>&gt;<i> http_access allow network
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> Let's assume each of those lines have an index (0, 1, 2 thru 8 in the
</I>&gt;<i> example above).  Is there any way to find which one matched?
</I>
Well, don't assume. They are logged in cache.log as http_access#1 to
http_access#9 as seen below (with a bit more optimal config than yours):

&quot;
2016/02/03 22:54:24.461 kid1| 28,3| ../src/acl/Checklist.cc(70)
preCheck: 0xa77d3a8 checking slow rules
2016/02/03 22:54:24.461 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: Safe_ports = 1
2016/02/03 22:54:24.461 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: !Safe_ports = 0
2016/02/03 22:54:24.461 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: http_access#1 = 0
2016/02/03 22:54:24.462 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: CONNECT = 0
2016/02/03 22:54:24.462 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: http_access#2 = 0
2016/02/03 22:54:24.462 kid1| 28,3| ../src/acl/Ip.cc(540) match:
aclIpMatchIp: '[::1]:43636' found
2016/02/03 22:54:24.463 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: localhost = 1
2016/02/03 22:54:24.463 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: http_access#3 = 1
2016/02/03 22:54:24.463 kid1| 28,3| ../src/acl/Acl.cc(290) matches:
checked: http_access = 1
2016/02/03 22:54:24.463 kid1| 28,3| ../src/acl/Checklist.cc(63)
markFinished: 0xa77d3a8 answer ALLOWED for match
2016/02/03 22:54:24.463 kid1| 28,3| ../src/acl/Checklist.cc(163)
checkCallback: ACLChecklist::checkCallback: 0xa77d3a8 answer=ALLOWED
&quot;

&gt;<i> 
</I>&gt;<i> Explored so far: using debug_options to look at sections 33 (Client Side
</I>&gt;<i> Routines), 88 (Client-side Reply Routines) and 85 (Client Side Request
</I>&gt;<i> Routines) return useful information, but it's hard to use it to identify
</I>&gt;<i> (programmatically) which log entries relate to which request on a busy
</I>&gt;<i> cache.  Activating debug logging on a busy cache also doesn't seem like the
</I>&gt;<i> right approach.
</I>
debug_options 11,2 28,3


11,2 gives you the HTTP messages.
28,3 gives you the ACL processing action and results.

Its a bit like quantum mechanics at the moment though. You can know the
request mesage details. OR you can know the ACL matching. Not both at once.

&gt;<i> 
</I>&gt;<i> Are there any other debug sections which would be more appropriate to the
</I>&gt;<i> task?  If not, is there another more suitable approach?
</I>&gt;<i> 
</I>
Why exactly are you doing this? What are you trying to achieve with it?

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008981.html">[squid-users] Debugging http_access and http_reply_access
</A></li>
	<LI>Next message (by thread): <A HREF="008992.html">[squid-users] Debugging http_access and http_reply_access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8982">[ date ]</a>
              <a href="thread.html#8982">[ thread ]</a>
              <a href="subject.html#8982">[ subject ]</a>
              <a href="author.html#8982">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
