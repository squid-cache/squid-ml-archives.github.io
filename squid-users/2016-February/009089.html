<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.4.1%20as%20a%20reverse%20Proxy%20for%20Exchange%202016%0A%20-%20Problems%20with%20Exchange%20Active%20Sync&In-Reply-To=%3C56BB6869.1070104%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009087.html">
   <LINK REL="Next"  HREF="009107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.4.1%20as%20a%20reverse%20Proxy%20for%20Exchange%202016%0A%20-%20Problems%20with%20Exchange%20Active%20Sync&In-Reply-To=%3C56BB6869.1070104%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb 10 16:42:17 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009087.html">[squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync
</A></li>
        <LI>Next message (by thread): <A HREF="009107.html">[squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9089">[ date ]</a>
              <a href="thread.html#9089">[ thread ]</a>
              <a href="subject.html#9089">[ subject ]</a>
              <a href="author.html#9089">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/02/2016 3:40 a.m., Philipp Fischer wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> i&#180;m trying to get squid working as reverse Proxy for Exchange 2016.
</I>&gt;<i> 
</I>&gt;<i> Actually  it works quite smooth for OWA but fails again and again
</I>&gt;<i> when trying to connecto to the EAS Site of my Exchange.
</I>&gt;<i> 
</I>&gt;<i> From the IIS-Logs of the mailserver i can see 401 replys two or three
</I>&gt;<i> times and then squid sends the user credentials which results in a
</I>&gt;<i> 200 message.
</I>&gt;<i> 
</I>&gt;<i> When using EAS the connect (from Exchange remote connectivty
</I>&gt;<i> analyzer) connects to the autodiscover site first &#8211; which produces
</I>&gt;<i> about three 401&#180;s and then to the eas-site &#8211; again about two or three
</I>&gt;<i> 401&#180;s.
</I>&gt;<i> 
</I>&gt;<i> Most times after the 5th 401 reply (not authenticated) squid cuts off
</I>&gt;<i> the Connection &#8211; is there any way to push squid to do more retries
</I>&gt;<i> after a 401 error?
</I>
I think you may have the wrong idea here. 401 is not an error, and it
not a message that matters to Squid. It is an instruction from the web
service to the client. Suqid shoul dmost definitely *not* retry when it
sees one.

Squid job in this case is simply to relay the 401 to the client. So that
the client can supply the necessary credentials on its next (repeated)
request.

Your cache_peer lines already contains &quot;login=PASSTHRU
connection-auth=on&quot; which is correct for handling any type of 401 login
that the server might want to use. Evrything else is a problem directly
between the IIS and the client browser.


&gt;<i>
</I>&gt;<i> Here&#180;s my IIS-Log:
</I>&gt;<i> 
</I>&gt;<i> 2016-02-10 13:18:56 10.89.5.3 OPTIONS /Autodiscover/Autodiscover.xml &amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=PBUQLXUG4EOZTNG08F3BGG&amp;cafeReqId=f7e3c699-96b5-4e79-8a54-03334a9fe7fe; 443 - 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 401 0 0 78
</I>&gt;<i> 
</I>&gt;<i> 2016-02-10 13:18:56 10.89.5.3 POST /Autodiscover/Autodiscover.xml &amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=LBQ9QZKE0YCFS3BZUOYG&amp;cafeReqId=392f5e78-5272-4ed1-a062-c1706e341dbf; 443 - 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 401 0 0 0
</I>&gt;<i> 
</I>&gt;<i> 2016-02-10 13:19:04 10.89.5.3 POST /Autodiscover/Autodiscover.xml &amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=XTSRHRKWV0ETDZKCRLXO6W&amp;cafeReqId=684a8948-eeb9-401f-a9bf-61d2581f138f; 443 DOMAIN\test 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 200 0 0 7515
</I>&gt;<i> 
</I>&gt;<i> 2016-02-10 13:19:05 10.89.5.3 OPTIONS /Microsoft-Server-ActiveSync/default.eas &amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=POVVU5U8Z0SDIKZWQEPRNA&amp;cafeReqId=109adc1a-93f9-4491-aadc-b615e5b7c36a; 443 - 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 401 2 5 0
</I>&gt;<i> 
</I>&gt;<i> Line 390924: 2016-02-10 13:19:07 10.89.5.3 OPTIONS /Microsoft-Server-ActiveSync/default.eas &amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=YDXPIAVIDEYCERPKPSRQ&amp;cafeReqId=402020a7-2bd9-4540-9050-b6dd9e34a136; 443 - 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 401 2 5 124
</I>&gt;<i> 
</I>&gt;<i> Line 390929: 2016-02-10 13:19:07 10.89.5.3 OPTIONS /Microsoft-Server-ActiveSync/default.eas &amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=PTIZMVB6NUOH1AJ1MGWWA&amp;cafeReqId=2b329cfa-a318-4102-bb5c-3a7652e84d5d; 443 DOMAIN\test 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 200 0 0 390
</I>&gt;<i> 
</I>&gt;<i> Line 390934: 2016-02-10 13:19:07 10.89.5.3 POST /Microsoft-Server-ActiveSync/default.eas Cmd=FolderSync&amp;User=test&amp;DeviceId=1797657923&amp;DeviceType=TestActiveSyncConnectivity&amp;CorrelationID=&lt;empty&gt;;&amp;ClientId=QC284CQDGK2JMD9TA6X6G&amp;cafeReqId=d9ceafa7-9767-4552-bb34-2444c6435a10; 443 - 10.89.5.248 Microsoft-Server-ActiveSync/12.0+(TestExchangeConnectivity.com) - 401 2 5 0
</I>&gt;<i> 
</I>
This looks normal by itself. It is simply the traffic making it through
Squid. NO problems are visible at that end.


&gt;<i> And here&#180;s my Squid.conf:
</I>&gt;<i> 
</I>&gt;<i> # This file is automatically generated by pfSense
</I>&gt;<i> # Do not edit manually !
</I>&gt;<i> 
</I>&gt;<i> icp_port 0
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> pid_filename /var/run/squid/squid.pid
</I>&gt;<i> cache_effective_user proxy
</I>&gt;<i> cache_effective_group proxy
</I>&gt;<i> error_default_language en
</I>&gt;<i> icon_directory /usr/pbi/squid-amd64/local/etc/squid/icons
</I>&gt;<i> visible_hostname localhost
</I>
Very bad idea to use &quot;localhost&quot; as your publicy visible domain name.

Recent Squid can auto-detect hostname quite well, and if that actually
has a problem, then use a resolvable FQDN.

Ubuntu found out the hard way some years back that there are ISP out
there also setting their proxies names to &quot;localhost&quot;. Which results in
one end or the other simply dropping the apparently looped traffic
in-transit.


&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at localhost</A>
</I>
Squid error pages instruct your users to email their problem reports to
this addres. Squid itself will try to email it crash reports if/when
they happen.

&gt;<i> access_log /var/squid/logs/access.log
</I>&gt;<i> cache_log /var/squid/logs/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> netdb_filename /var/squid/logs/netdb.state
</I>&gt;<i> pinger_enable on
</I>&gt;<i> pinger_program /usr/pbi/squid-amd64/local/libexec/squid/pinger
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 10
</I>&gt;<i> debug_options rotate=10
</I>
No need for that second line to exist unless you want the cache.log and
access.log rotation numbers to be different.

The above two sections of lines all look like defaults anyway. If so,
then you dont even need to configure any of them.


&gt;<i> shutdown_lifetime 3 seconds
</I>
NP: if you want short shutdown timeout to avoid problems then I highly
recommend upgrading to one of the latest Squid releases (3.5.10+).

&gt;<i> uri_whitespace strip
</I>&gt;<i> 
</I>&gt;<i> acl dynamic urlpath_regex cgi-bin \?
</I>&gt;<i> cache deny dynamic
</I>
The above is unnecessary. Squid correctly handles dynamic content and
your refresh_pattern is already setup for the rare cases where there are
problems.

&gt;<i> 
</I>&gt;<i> cache_mem 64 MB
</I>&gt;<i> maximum_object_size_in_memory 256 KB
</I>&gt;<i> memory_replacement_policy heap GDSF
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> cache_dir ufs /var/squid/cache 100 16 256
</I>
These ...

&gt;<i> forwarded_for on
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 4 MB
</I>&gt;<i> offline_mode off
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>
... are all defaults. No need to specify them.

&gt;<i> cache allow all
</I>
If you remove the above cache deny lines then you can also remove this one.

&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> refresh_pattern ^ftp:    1440  20%  10080
</I>&gt;<i> refresh_pattern ^gopher:  1440  0%  1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0  0%  0
</I>&gt;<i> refresh_pattern .    0  20%  4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #Remote proxies
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Setup some default acls
</I>&gt;<i> # From 3.2 further configuration cleanups have been done to make things easier and safer. The manager, localhost, and to_localhost ACL definitions are now built-in.
</I>&gt;<i> # acl localhost src 127.0.0.1/32
</I>&gt;<i> acl allsrc src all
</I>
The point of these ACLs being &quot;built-in&quot; is that you can *use* them
anywhere in the config without having t have thee &quot;acl ...&quot; lines
definign them manually.

So consider what is the point of the &quot;allsrc&quot; ACL? its identical to
&quot;all&quot; except that Squid has to use extra memory for the one with custom
alternative name.

I recommend replacing all uses of &quot;allsrc&quot; with &quot;all&quot; and removing the
above.


&gt;<i> acl safeports port 21 70 80 210 280 443 488 563 591 631 777 901 8080   1025-65535 
</I>&gt;<i> acl sslports port 443 563 8080 
</I>&gt;<i> 
</I>&gt;<i> # From 3.2 further configuration cleanups have been done to make things easier and safer. The manager, localhost, and to_localhost ACL definitions are now built-in.
</I>&gt;<i> #acl manager proto cache_object
</I>&gt;<i> 
</I>
... same goes for this.

&gt;<i> acl purge method PURGE
</I>&gt;<i> acl connect method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Define protocols used for redirects
</I>&gt;<i> acl HTTP proto HTTP
</I>&gt;<i> acl HTTPS proto HTTPS
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>
NP: current best practice is to put the above lines underneath the two
below. So the Safe_ports and CONNECT protections (which are DoS
protection) are applied before the slower and more resource hungry
manager and purge rules.

&gt;<i> http_access deny !safeports
</I>&gt;<i> http_access deny CONNECT !sslports
</I>&gt;<i> 
</I>&gt;<i> # Always allow localhost connections
</I>&gt;<i> # From 3.2 further configuration cleanups have been done to make things easier and safer.
</I>&gt;<i> # The manager, localhost, and to_localhost ACL definitions are now built-in.
</I>
That above comment has no relevance here. This part of squid.conf is
about *using* the localhost ACL.

&gt;<i> # http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> request_body_max_size 0 KB
</I>
Another default.

&gt;<i> delay_pools 1
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 -1/-1 -1/-1
</I>&gt;<i> delay_initial_bucket_level 100
</I>&gt;<i> delay_access 1 allow allsrc
</I>&gt;<i> 
</I>
Um. This is bad. Forces Squid to do a lot of delayPools traffic
accounting memory allocations and calculations. In an attempt to *not*
slow the traffic down. Very counter-productive.


&gt;<i> # Reverse Proxy settings
</I>&gt;<i> http_port 10.0.0.3:80 accel defaultsite=mail.DOMAIN.de vhost
</I>&gt;<i> https_port 10.0.0.3:443 accel cert=/usr/pbi/squid-amd64/local/etc/squid/56b21e54ee18f.crt key=/usr/pbi/squid-amd64/local/etc/squid/56b21e54ee18f.key  defaultsite=mail.DOMAIN.de vhost
</I>&gt;<i> cache_peer 10.89.5.3 parent 443 0 proxy-only no-query no-digest originserver login=PASSTHRU connection-auth=on ssl sslflags=DONT_VERIFY_PEER front-end-https=on name=OWA_HOST_443_1_pfs
</I>&gt;<i> cache_peer 10.89.5.3 parent 80 0 proxy-only no-query no-digest originserver login=PASSTHRU connection-auth=on name=OWA_HOST_80_1_pfs
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/owa.*$">https://mail.DOMAIN.de/owa.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/exchange.*$">https://mail.DOMAIN.de/exchange.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/public.*$">https://mail.DOMAIN.de/public.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/exchweb.*$">https://mail.DOMAIN.de/exchweb.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/ecp.*$">https://mail.DOMAIN.de/ecp.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/OAB.*$">https://mail.DOMAIN.de/OAB.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/Microsoft-Server-ActiveSync.*$">https://mail.DOMAIN.de/Microsoft-Server-ActiveSync.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/rpc/rpcproxy.dll.*$">https://mail.DOMAIN.de/rpc/rpcproxy.dll.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/rpcwithcert/rpcproxy.dll.*$">https://mail.DOMAIN.de/rpcwithcert/rpcproxy.dll.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/mapi.*$">https://mail.DOMAIN.de/mapi.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/EWS.*$">https://mail.DOMAIN.de/EWS.*$</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="http://mail.DOMAIN.de/AutoDiscover/AutoDiscover.xml">http://mail.DOMAIN.de/AutoDiscover/AutoDiscover.xml</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://mail.DOMAIN.de/AutoDiscover/AutoDiscover.xml">https://mail.DOMAIN.de/AutoDiscover/AutoDiscover.xml</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="http://autodiscover.DOMAIN.de/AutoDiscover/AutoDiscover.xml">http://autodiscover.DOMAIN.de/AutoDiscover/AutoDiscover.xml</A>
</I>&gt;<i> acl OWA_URI_pfs url_regex -i ^<A HREF="https://autodiscover.DOMAIN.de/AutoDiscover/AutoDiscover.xml">https://autodiscover.DOMAIN.de/AutoDiscover/AutoDiscover.xml</A>
</I>&gt;<i> cache_peer_access OWA_HOST_443_1_pfs allow OWA_URI_pfs
</I>&gt;<i> cache_peer_access OWA_HOST_80_1_pfs allow OWA_URI_pfs
</I>
Your OWA ACL has a mix of <A HREF="http://">http://</A> and <A HREF="https://">https://</A> URLs that it matches.
With Exchange and IIS its usually not a good idea to mix those up, and
teh serevr can auto-redirect <A HREF="http://">http://</A> URLs to teh <A HREF="https://">https://</A> variant and
loop if Squid sends to the wrong one. Or Squid can inadvertently publish
what teh server things is secured information over the port-80 client
connections.

Others have found these setups work much better if you lock the traffic
to only going to the cache_peer with same port type as it arrived to
Squid over.

like so:

 acl HTTPS proto HTTPS
 acl HTTP proto HTTP

 cache_peer_access OWA_HOST_443_1_pfs allow HTTPS OWA_URI_pfs
 cache_peer_access OWA_HOST_80_1_pfs allow HTTP OWA_URI_pfs

Where the OWA_URI_pfs ACL does not contains the &quot;http(s)://&quot; portion of
the URLs.

OR, if you want to strictly require only those path+scheme combos, use
two ACLs - one for each peer. With <A HREF="https://">https://</A> entries in one, and <A HREF="http://">http://</A>
in the other.


&gt;<i> cache_peer_access OWA_HOST_443_1_pfs deny allsrc
</I>&gt;<i> cache_peer_access OWA_HOST_80_1_pfs deny allsrc
</I>&gt;<i> never_direct allow OWA_URI_pfs
</I>&gt;<i> http_access allow OWA_URI_pfs
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Custom options before auth
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Setup allowed ACLs
</I>&gt;<i> # Default block all to be sure
</I>&gt;<i> http_access deny allsrc
</I>&gt;<i> 
</I>&gt;<i> I also tried to Change the squid.conf to a example config from the faq&#180;s &#8211; which had the same effect as described above.
</I>&gt;<i> 
</I>&gt;<i> Any ideas anybody?
</I>

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009087.html">[squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync
</A></li>
	<LI>Next message (by thread): <A HREF="009107.html">[squid-users] Squid 3.4.1 as a reverse Proxy for Exchange 2016 - Problems with Exchange Active Sync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9089">[ date ]</a>
              <a href="thread.html#9089">[ thread ]</a>
              <a href="subject.html#9089">[ subject ]</a>
              <a href="author.html#9089">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
