<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Filtering HTTPS URLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Filtering%20HTTPS%20URLs&In-Reply-To=%3CCAN-hnF3CBA4smqroAcZ2o%3D7SXB7OM3NNHFxvXtSWon8cjay6YA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009095.html">
   <LINK REL="Next"  HREF="009098.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Filtering HTTPS URLs</H1>
    <B>Victor Hugo</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Filtering%20HTTPS%20URLs&In-Reply-To=%3CCAN-hnF3CBA4smqroAcZ2o%3D7SXB7OM3NNHFxvXtSWon8cjay6YA%40mail.gmail.com%3E"
       TITLE="[squid-users] Filtering HTTPS URLs">fourtrials at gmail.com
       </A><BR>
    <I>Thu Feb 11 22:37:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009095.html">[squid-users] Filtering HTTPS URLs
</A></li>
        <LI>Next message (by thread): <A HREF="009098.html">[squid-users] Filtering HTTPS URLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9097">[ date ]</a>
              <a href="thread.html#9097">[ thread ]</a>
              <a href="subject.html#9097">[ subject ]</a>
              <a href="author.html#9097">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Panda,

Thanks for the suggestion.

I'm assuming from Panda and Amos's responses that what I'm trying to
achieve should actually be possible?

I tried adding what you suggested but unfortunately it didn't work.

New Config (based on Panda's suggestion):
acl localnet src 10.0.0.0/8 # RFC1918 possible internal network
acl localnet src 172.16.0.0/12 # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines
acl localnet src 132.234.0.0/16 # ANDREWN: Griffith University network
acl SSL_ports port 443
acl Safe_ports port 80 # http
acl Safe_ports port 21 # ftp
acl Safe_ports port 443 # https
acl Safe_ports port 70 # gopher
acl Safe_ports port 210 # wais
acl Safe_ports port 1025-65535 # unregistered ports
acl Safe_ports port 280 # http-mgmt
acl Safe_ports port 488 # gss-http
acl Safe_ports port 591 # filemaker
acl Safe_ports port 777 # multiling http
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
acl whitelist-regex url_regex -i reddit.com/r/news
http_port 3129 ssl-bump cert=/opt/squid-3.5.13/etc/squid3/ssl_cert/myCA.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

Browsing to <A HREF="https://www.reddit.com/r/news">https://www.reddit.com/r/news</A> still gives the following in the
access.log:
1455229976.342      0 132.234.20.39 TCP_DENIED/200 0 CONNECT
www.reddit.com:443 - HIER_NONE/- -
1455229976.423      0 132.234.20.39 TAG_NONE/403 4011 GET
<A HREF="https://www.reddit.com/r/news">https://www.reddit.com/r/news</A> - HIER_NONE/- text/html
1455229976.537      0 132.234.20.39 TCP_DENIED/200 0 CONNECT
www.reddit.com:443 - HIER_NONE/- -

Will now try Amos's suggestions of looking further into the ssl options and
trying 4.0.5 release and email the list to say how it goes.

thanks.
Victor

On Thu, Feb 11, 2016 at 11:46 PM, Panda Admin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">pandanonomous at gmail.com</A>&gt;
wrote:

&gt;<i> Try adding
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1 bump_sites
</I>&gt;<i>
</I>&gt;<i> This worked for me.  Just a suggestion:)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Feb 11, 2016 at 3:59 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 11/02/2016 1:05 p.m., Victor Hugo wrote:
</I>&gt;&gt;<i> &gt; Hi,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I was wondering if it is possible to filter HTTPS URLs using squid (for
</I>&gt;&gt;<i> &gt; example to blacklist reddit.com but allow
</I>&gt;&gt;<i> <A HREF="https://www.reddit.com/r/news/">https://www.reddit.com/r/news/</A>)?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I thought this may be possible using ssl_bump and url_regex. I have been
</I>&gt;&gt;<i> &gt; trying this using squid 3.5.13 but with no success.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Here is the squid configuration that I have tried but doesn't seem to
</I>&gt;&gt;<i> work
</I>&gt;&gt;<i> &gt; (it works for http sites though):
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;snip&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; acl whitelist-regex url_regex -i reddit.com/r/news
</I>&gt;&gt;<i> &gt; http_port 3129 ssl-bump
</I>&gt;&gt;<i> cert=/opt/squid-3.5.13/etc/squid3/ssl_cert/myCA.pem
</I>&gt;&gt;<i> &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt; acl bump_sites ssl::server_name .reddit.com
</I>&gt;&gt;<i> &gt; ssl_bump bump bump_sites
</I>&gt;&gt;<i> &gt; ssl_bump splice !bump_sites
</I>&gt;&gt;<i> &gt; http_access allow whitelist-regex
</I>&gt;&gt;<i> &gt; http_access allow localhost
</I>&gt;&gt;<i> &gt; http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Relevant access.log output (IP addresses redacted to x.x.x.x):
</I>&gt;&gt;<i> &gt; 1455145755.589      0 x.x.x.x TCP_DENIED/200 0 CONNECT
</I>&gt;&gt;<i> www.reddit.com:443 -
</I>&gt;&gt;<i> &gt; HIER_NONE/- -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So this is the bump happening, as you wanted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; 1455145755.669      0 x.x.x.x TAG_NONE/403 4011 GET
</I>&gt;&gt;<i> &gt; <A HREF="https://www.reddit.com/r/news">https://www.reddit.com/r/news</A> - HIER_NONE/- text/html
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And something else has 403 (Forbidden) the request. Your ACL and
</I>&gt;&gt;<i> http_access config looks fine. So I dont think its that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The first oddity is that your ssl_bump rules are doing bump without
</I>&gt;&gt;<i> having fetched the clientHello details yet. So this is a &quot;client-first&quot;
</I>&gt;&gt;<i> bumping situation in which Squid first negotiates TLS / HTTPS with the
</I>&gt;&gt;<i> client, then completely separately negotiates TLS/HTTPS with the server.
</I>&gt;&gt;<i>  - any errors in the server TLS might result in something like this 403
</I>&gt;&gt;<i> (though it should be a 5xx status, it may not always be).
</I>&gt;&gt;<i>  - the sslproxy_* settings are entirely what controls the server
</I>&gt;&gt;<i> connection TLS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Second oddity is that its saying DENIED/200. 200 is 'allowed' in CONNECT
</I>&gt;&gt;<i> actions. This could be a logging bug, or a sign of something going wrong
</I>&gt;&gt;<i> in the bumping stage that alters the CONNECT logging as well.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Are you able to experiment with using the Squid-4.0.5 release? there are
</I>&gt;&gt;<i> some bumping bug fixes that are only in that release series.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160212/35ff4623/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160212/35ff4623/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009095.html">[squid-users] Filtering HTTPS URLs
</A></li>
	<LI>Next message (by thread): <A HREF="009098.html">[squid-users] Filtering HTTPS URLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9097">[ date ]</a>
              <a href="thread.html#9097">[ thread ]</a>
              <a href="subject.html#9097">[ subject ]</a>
              <a href="author.html#9097">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
