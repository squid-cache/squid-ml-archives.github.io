<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock datastore, CFLAGS and a crash that (may be) known
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C33881.1040103%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009143.html">
   <LINK REL="Next"  HREF="009146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock datastore, CFLAGS and a crash that (may be) known</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C33881.1040103%40ngtech.co.il%3E"
       TITLE="[squid-users] Rock datastore, CFLAGS and a crash that (may be) known">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Feb 16 14:56:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009143.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
        <LI>Next message (by thread): <A HREF="009146.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9145">[ date ]</a>
              <a href="thread.html#9145">[ thread ]</a>
              <a href="subject.html#9145">[ subject ]</a>
              <a href="author.html#9145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Before digging into the details of the issue, can you supply the OS details?
What OS are you using? What distribution?
32 or 64 bit?
can you also add the output of &quot;squid -v&quot; for both 3.5.14 and 3.5.13 ?

Thanks,
Eliezer

On 16/02/2016 16:32, Jester Purtteman wrote:
&gt;<i> Greetings Squid users,
</I>&gt;<i>
</I>&gt;<i> With 3.5.14 out and activating CFLAGS, I am getting into trouble.  Funny
</I>&gt;<i> too, I spent a lot of time wondering why it wasn&#8217;t adding CFLAGS in
</I>&gt;<i> earlier builds.  In any event, I have a 3.5.13 instance configured as
</I>&gt;<i> follows:
</I>&gt;<i>
</I>&gt;<i> ./configure --prefix=/usr   --localstatedir=/var
</I>&gt;<i> --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid
</I>&gt;<i> --sysconfdir=/etc/squid   --with-default-user=proxy
</I>&gt;<i> --with-logdir=/var/log   --with-pidfile=/var/run/squid.pid
</I>&gt;<i> --enable-linux-netfilter  --enable-cache-digests
</I>&gt;<i> --enable-storeio=ufs,aufs,diskd,rock  --enable-async-io=30
</I>&gt;<i> --enable-http-violations --enable-zph-qos --with-netfilter-conntrack
</I>&gt;<i> --with-filedescriptors=65536 --with-large-files
</I>&gt;<i>
</I>&gt;<i> It has a quartet of cache-dirs (I&#8217;m still testing and monkeying) as follows:
</I>&gt;<i>
</I>&gt;<i> cache_dir rock /var/spool/squid/rock/1 64000 swap-timeout=600
</I>&gt;<i> max-swap-rate=600 min-size=0 max-size=128KB
</I>&gt;<i>
</I>&gt;<i> cache_dir rock /var/spool/squid/rock/2 102400 swap-timeout=600
</I>&gt;<i> max-swap-rate=600 min-size=128KB max-size=256KB
</I>&gt;<i>
</I>&gt;<i> cache_dir aufs /var/spool/squid/aufs/1 200000 16 128 min-size=256KB
</I>&gt;<i> max-size=4096KB
</I>&gt;<i>
</I>&gt;<i> cache_dir aufs /var/spool/squid/aufs/2 1500000 16 128 min-size=4096KB
</I>&gt;<i> max-size=8196000KB
</I>&gt;<i>
</I>&gt;<i> Permissions are all proxy.proxy for the cache dirs and everything is
</I>&gt;<i> happily running.  When I read that the CFLAGS bug was solved, I thought
</I>&gt;<i> &#8220;hey, didn&#8217;t I do some terrible thing to determine what cflags are
</I>&gt;<i> correct on a vmware virtual instance?&#8221; and dug up the cflags that I came
</I>&gt;<i> up with.  I then compiled 3.5.14 as follows:
</I>&gt;<i>
</I>&gt;<i> ./configure CFLAGS=&quot;-march=core2 -mcx16 -msahf -mno-movbe -mno-aes
</I>&gt;<i> -mno-pclmul -mno-popcnt -mno-sse4 -msse4.1&quot; CXXFLAGS=&quot;${CFLAGS}&quot;
</I>&gt;<i> --with-pthreads --prefix=/usr   --localstatedir=/var
</I>&gt;<i> --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid
</I>&gt;<i> --sysconfdir=/etc/squid   --with-default-user=proxy
</I>&gt;<i> --with-logdir=/var/log   --with-pidfile=/var/run/squid.pid
</I>&gt;<i> --enable-linux-netfilter  --enable-cache-digests
</I>&gt;<i> --enable-storeio=ufs,aufs,diskd,rock  --enable-async-io=30
</I>&gt;<i> --enable-http-violations --enable-zph-qos --with-netfilter-conntrack
</I>&gt;<i> --with-filedescriptors=65536 --with-large-files
</I>&gt;<i>
</I>&gt;<i> This leads to the following in the cache log, and a crash.
</I>&gt;<i>
</I>&gt;<i> &lt;&lt;&lt;SNIP
</I>&gt;<i>
</I>&gt;<i> FATAL: Ipc::Mem::Segment::open failed to
</I>&gt;<i> shm_open(/squid-var.spool.squid.rock.1_spaces.shm): (2) No such file or
</I>&gt;<i> directory
</I>&gt;<i>
</I>&gt;<i> Squid Cache (Version 3.5.14): Terminated abnormally.
</I>&gt;<i>
</I>&gt;<i> CPU Usage: 5.439 seconds = 2.581 user + 2.858 sys
</I>&gt;<i>
</I>&gt;<i>  &gt;&gt;&gt;SNIP
</I>&gt;<i>
</I>&gt;<i> This looks similar to a bug
</I>&gt;<i> <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3880#c1">http://bugs.squid-cache.org/show_bug.cgi?id=3880#c1</A> that was already
</I>&gt;<i> reported, but I don&#8217;t know enough to say with certainty.  It does look
</I>&gt;<i> like these compile options are allowing squid to launch with multiple
</I>&gt;<i> processes and do other things that I think I might want, but I can&#8217;t
</I>&gt;<i> tell for sure.  So, it does lead me to a few questions:
</I>&gt;<i>
</I>&gt;<i> (1)Do these flags make sense?  I only half know what half of them do,
</I>&gt;<i> but they appear to basically just be supported flags on a ESXi virtual
</I>&gt;<i> machine given my hardware.  I have googled, just not a lot of light shed
</I>&gt;<i> on this instance, thoughts and insights are appreciated.
</I>&gt;<i>
</I>&gt;<i> (2)Are my rock stores lagging out, and how would you recommend tuning
</I>&gt;<i> them if so?
</I>&gt;<i>
</I>&gt;<i> (3)Does the strategy above make sense?  My thinking is to segregate the
</I>&gt;<i> small cache items into a rock datastore, and the big items into an aufs
</I>&gt;<i> datastore.
</I>&gt;<i>
</I>&gt;<i> (4)Do you have any pointers on calculating the size of rocks and aufs
</I>&gt;<i> stores based on disk performance etc?  I&#8217;m guessing that there is sort
</I>&gt;<i> of a logical size to make a specific rock and aufs based on how big of
</I>&gt;<i> items you store in it and so on.  Is there some way I can apply some
</I>&gt;<i> math and find bottlenecks?
</I>&gt;<i>
</I>&gt;<i> Finally, 3.5.14 does run fine when compiled with the first set (even
</I>&gt;<i> with --with-pthreads added) so I think this is probably cflags related.
</I>&gt;<i> I would like to get multiple disker processes running, I think it would
</I>&gt;<i> probably help in my environment, but it&#8217;s not supremely critical.
</I>&gt;<i> Anyway, there is a note at the end of the bug saying that this wasn&#8217;t
</I>&gt;<i> seen for a while, and I thought I&#8217;d say &#8220;I&#8217;ve seen it! Maybe!&#8221;  let me
</I>&gt;<i> know if I am creating this bug through a creative mistake, or if you
</I>&gt;<i> have other ideas here.  Thanks!
</I>&gt;<i>
</I>&gt;<i> Jester Purtteman, P.E.
</I>&gt;<i>
</I>&gt;<i> OptimERA Inc
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009143.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
	<LI>Next message (by thread): <A HREF="009146.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9145">[ date ]</a>
              <a href="thread.html#9145">[ thread ]</a>
              <a href="subject.html#9145">[ subject ]</a>
              <a href="author.html#9145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
