<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock datastore, CFLAGS and a crash that (may be) known
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C33EB0.9090403%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009145.html">
   <LINK REL="Next"  HREF="009147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock datastore, CFLAGS and a crash that (may be) known</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C33EB0.9090403%40treenet.co.nz%3E"
       TITLE="[squid-users] Rock datastore, CFLAGS and a crash that (may be) known">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Feb 16 15:22:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009145.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
        <LI>Next message (by thread): <A HREF="009147.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9146">[ date ]</a>
              <a href="thread.html#9146">[ thread ]</a>
              <a href="subject.html#9146">[ subject ]</a>
              <a href="author.html#9146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/02/2016 3:32 a.m., Jester Purtteman wrote:
&gt;<i> Greetings Squid users,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> With 3.5.14 out and activating CFLAGS, I am getting into trouble.  Funny
</I>&gt;<i> too, I spent a lot of time wondering why it wasn't adding CFLAGS in earlier
</I>&gt;<i> builds.  In any event, I have a 3.5.13 instance configured as follows:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ./configure --prefix=/usr   --localstatedir=/var
</I>&gt;<i> --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid
</I>&gt;<i> --sysconfdir=/etc/squid   --with-default-user=proxy   --with-logdir=/var/log
</I>&gt;<i> --with-pidfile=/var/run/squid.pid --enable-linux-netfilter
</I>&gt;<i> --enable-cache-digests --enable-storeio=ufs,aufs,diskd,rock
</I>&gt;<i> --enable-async-io=30 --enable-http-violations --enable-zph-qos
</I>&gt;<i> --with-netfilter-conntrack --with-filedescriptors=65536 --with-large-files
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> It has a quartet of cache-dirs (I'm still testing and monkeying) as follows:
</I>&gt;<i> 
</I>&gt;<i> cache_dir rock /var/spool/squid/rock/1 64000 swap-timeout=600
</I>&gt;<i> max-swap-rate=600 min-size=0 max-size=128KB
</I>&gt;<i> 
</I>&gt;<i> cache_dir rock /var/spool/squid/rock/2 102400 swap-timeout=600
</I>&gt;<i> max-swap-rate=600 min-size=128KB max-size=256KB
</I>&gt;<i> 
</I>&gt;<i> cache_dir aufs /var/spool/squid/aufs/1 200000 16 128 min-size=256KB
</I>&gt;<i> max-size=4096KB
</I>&gt;<i> 
</I>&gt;<i> cache_dir aufs /var/spool/squid/aufs/2 1500000 16 128 min-size=4096KB
</I>&gt;<i> max-size=8196000KB
</I>
NP: don't forget to isolate the AUFS cache_dir within each worker.
Either with the squid.conf if-else-endif syntax, or ${process_id} macros.


&gt;<i> 
</I>&gt;<i> Permissions are all proxy.proxy for the cache dirs and everything is happily
</I>&gt;<i> running.  When I read that the CFLAGS bug was solved, I thought &quot;hey, didn't
</I>&gt;<i> I do some terrible thing to determine what cflags are correct on a vmware
</I>&gt;<i> virtual instance?&quot; and dug up the cflags that I came up with.  I then
</I>&gt;<i> compiled 3.5.14 as follows:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ./configure CFLAGS=&quot;-march=core2 -mcx16 -msahf -mno-movbe -mno-aes
</I>&gt;<i> -mno-pclmul -mno-popcnt -mno-sse4 -msse4.1&quot; CXXFLAGS=&quot;${CFLAGS}&quot;
</I>
Three potential problems I can see here:

 1) are those flags the current values or your old findings? things
might have changed in some nasty subtle way.

 2) that Squid is now tuned to that exact VM emulation running on that
exact underlying host-OS hardware. Any variation of the two and you risk
SEGFAULT. see (1)

 3) I dont think this expansion method is safe. Better to go something
like ./configure BOO=&quot;...&quot; CFLAGS=&quot;${BOO}&quot; CXXFLAGS=&quot;${BOO}&quot;

 4) current Squid versions add -march=native automatically.
Unless you also add the --disable-arch-native option, it might be
clashing with your choice of CPU flags (at least the -march=core2). Also
(1) and (2) are relevant when building with -march=native.


&gt;<i> --with-pthreads --prefix=/usr   --localstatedir=/var
</I>&gt;<i> --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid
</I>&gt;<i> --sysconfdir=/etc/squid   --with-default-user=proxy   --with-logdir=/var/log
</I>&gt;<i> --with-pidfile=/var/run/squid.pid --enable-linux-netfilter
</I>&gt;<i> --enable-cache-digests --enable-storeio=ufs,aufs,diskd,rock
</I>&gt;<i> --enable-async-io=30 --enable-http-violations --enable-zph-qos
</I>&gt;<i> --with-netfilter-conntrack --with-filedescriptors=65536 --with-large-files
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> This leads to the following in the cache log, and a crash.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> &lt;&lt;&lt;SNIP
</I>&gt;<i> 
</I>&gt;<i> FATAL: Ipc::Mem::Segment::open failed to
</I>&gt;<i> shm_open(/squid-var.spool.squid.rock.1_spaces.shm): (2) No such file or
</I>&gt;<i> directory
</I>&gt;<i> 
</I>
AFAIK the &quot;No such file&quot; is related to whether the /dev/shm system
device is operating properly (off by default on some Linux), and whether
the name Squid is requesting is too long (MacOS is nasty like that).
It should not be related to the CPU flags being set. And the code Squid
uses for that is C++ anyway, so the releases flag change should not be
related.


&gt;<i> 
</I>&gt;<i> This looks similar to a bug
</I>&gt;<i> <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3880#c1">http://bugs.squid-cache.org/show_bug.cgi?id=3880#c1</A> that was already
</I>&gt;<i> reported, but I don't know enough to say with certainty. 
</I>
Its not. That group of issues all specifically log as &quot;timeout&quot; error of
one sort or another.

&gt;<i> It does look like
</I>&gt;<i> these compile options are allowing squid to launch with multiple processes
</I>&gt;<i> and do other things that I think I might want, but I can't tell for sure.
</I>&gt;<i> So, it does lead me to a few questions:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> (1)    Do these flags make sense?  I only half know what half of them do,
</I>&gt;<i> but they appear to basically just be supported flags on a ESXi virtual
</I>&gt;<i> machine given my hardware.  I have googled, just not a lot of light shed on
</I>&gt;<i> this instance, thoughts and insights are appreciated.
</I>&gt;<i> 
</I>
I've learnt just enough in this area myself to know that the best thing
to do is find someone in the embedded hardware area (or an expert in
that specific hardware) and ask their advice on flags.

In principle it looks like you are headed in the right direction.
Setting the host machine CPU type, adding and removing the bits the VM
layer does (or not) supports providing access to.

But I'm not educated enough on it myself to give a good answer there and
I dont think anyone else could without detaisl of the specific hardware
and VM systems you are using. Which goes back to finding yourself a
friendly expert :-)



&gt;<i> (2)    Are my rock stores lagging out, and how would you recommend tuning
</I>&gt;<i> them if so?
</I>
No. The workers are not even able to open UDS channels to talk to each
other.

&gt;<i> 
</I>&gt;<i> (3)    Does the strategy above make sense?  My thinking is to segregate the
</I>&gt;<i> small cache items into a rock datastore, and the big items into an aufs
</I>&gt;<i> datastore.
</I>
Yes that is the recommended practice.

&gt;<i> 
</I>&gt;<i> (4)    Do you have any pointers on calculating the size of rocks and aufs
</I>&gt;<i> stores based on disk performance etc?  I'm guessing that there is sort of a
</I>&gt;<i> logical size to make a specific rock and aufs based on how big of items you
</I>&gt;<i> store in it and so on.  Is there some way I can apply some math and find
</I>&gt;<i> bottlenecks?
</I>
IFyou have a trace of your hetworks HTTP traffic over any good length of
time. Graph it and see where the peaks are. You should see one around 0,
one in the low KB range (16-32'ish) and one low MB range (Youtubes most
popular video codec size).

Tune the rock to store a reasonable portion of the lower hump(s). And
AUFS for the larger ones. You may even want to have a dedicated rock for
the 0-1KB ones which make it to disk, although those are usually memory
objects.


&gt;<i> Finally, 3.5.14 does run fine when compiled with the first set (even with
</I>&gt;<i> --with-pthreads added) so I think this is probably cflags related. 
</I>
cflags is only used on C files, which these days is limited to some one
or two third-party portability wrappers we still use. So not likely.
If that sentence above was right and not a typo of .13 , then you just
proved it was fine.

I suspect the problem is your custom flags colliding with -march=native.


&gt;<i> I would
</I>&gt;<i> like to get multiple disker processes running, I think it would probably
</I>&gt;<i> help in my environment, but it's not supremely critical.  Anyway, there is a
</I>&gt;<i> note at the end of the bug saying that this wasn't seen for a while, and I
</I>&gt;<i> thought I'd say &quot;I've seen it! Maybe!&quot;  let me know if I am creating this
</I>&gt;<i> bug through a creative mistake, or if you have other ideas here.  Thanks!
</I>
Your original build options should have provided you with an SMP version
of Squid for both versions of 3.5. All you need for the basic SMP
operation is UDS sockets and /dev/shm shared memory.

The rest is squid.conf details.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009145.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
	<LI>Next message (by thread): <A HREF="009147.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9146">[ date ]</a>
              <a href="thread.html#9146">[ thread ]</a>
              <a href="subject.html#9146">[ subject ]</a>
              <a href="author.html#9146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
