<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%09CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C006301d16988%24467d2390%24d3776ab0%24%40optimera.us%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009147.html">
   <LINK REL="Next"  HREF="009172.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known</H1>
    <B>Jester Purtteman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%09CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C006301d16988%24467d2390%24d3776ab0%24%40optimera.us%3E"
       TITLE="[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known">jester at optimera.us
       </A><BR>
    <I>Wed Feb 17 13:36:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009147.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
        <LI>Next message (by thread): <A HREF="009172.html">[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9170">[ date ]</a>
              <a href="thread.html#9170">[ thread ]</a>
              <a href="subject.html#9170">[ subject ]</a>
              <a href="author.html#9170">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Eliezer, Amos and Marcus,

Thank you, and sorry for the late reply, day jobs are a menace to productivity :)

So, in order of responses:  Eliezer:
&gt;<i> Before digging into the details of the issue, can you supply the OS details?
</I>&gt;<i> What OS are you using? What distribution?
</I>&gt;<i> 32 or 64 bit?
</I>&gt;<i> can you also add the output of &quot;squid -v&quot; for both 3.5.14 and 3.5.13 ?
</I>
I am running Ubuntu 14.04.2 updated to the latest apt-get binaries, 64-bit version, 4 processors, 24-gb of &quot;ram&quot; allocated under the VM.  This is all on a vmware ESXi 6.0 host, so I recognize that compiler flags are probably a bit like throwing water balloons at Jaws from a performance stand point.  The counter point is, with performance as bad as a VM, you need all the help you can get.  As much as anything, it was a curiousity. 

Squid -v for a working configuration is as follows:

Squid Cache: Version 3.5.14
Service Name: squid
configure options:  '--with-pthreads' '--prefix=/usr' '--localstatedir=/var' '--libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-default-user=proxy' '--with-logdir=/var/log' '--with-pidfile=/var/run/squid.pid' '--enable-linux-netfilter' '--enable-cache-digests' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-async-io=30' '--enable-http-violations' '--enable-zph-qos' '--with-netfilter-conntrack' '--with-filedescriptors=65536' '--with-large-files' --enable-ltdl-convenience

I cut and pasted the configuration string I'd used with 3.5.13, added &quot;--with-pthreads&quot;, and had no problems.  Here is the working 3.5.13 -v output:

Squid Cache: Version 3.5.13
Service Name: squid
configure options:  '--prefix=/usr' '--localstatedir=/var' '--libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-default-user=proxy' '--with-logdir=/var/log' '--with-pidfile=/var/run/squid.pid' '--enable-linux-netfilter' '--enable-cache-digests' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-async-io=30' '--enable-http-violations' '--enable-zph-qos' '--with-netfilter-conntrack' '--with-filedescriptors=65536' '--with-large-files' --enable-ltdl-convenience

Amos:

&gt;<i> &gt; cache_dir rock /var/spool/squid/rock/1 64000 swap-timeout=600
</I>&gt;<i> &gt; max-swap-rate=600 min-size=0 max-size=128KB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_dir rock /var/spool/squid/rock/2 102400 swap-timeout=600
</I>&gt;<i> &gt; max-swap-rate=600 min-size=128KB max-size=256KB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_dir aufs /var/spool/squid/aufs/1 200000 16 128 min-size=256KB
</I>&gt;<i> &gt; max-size=4096KB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_dir aufs /var/spool/squid/aufs/2 1500000 16 128 min-size=4096KB
</I>&gt;<i> &gt; max-size=8196000KB
</I>&gt;<i> 
</I>&gt;<i> NP: don't forget to isolate the AUFS cache_dir within each worker.
</I>&gt;<i> Either with the squid.conf if-else-endif syntax, or ${process_id} macros.
</I>
Right now I'm only running one worker, although I was hoping to gain a little speed by having several dickers.  Is that going to require the additional squid-conf syntax?  I had understood that to only be relevant to multiple workers, and as I understand it, workers don't gracefully share resources yet.  One of my future efforts will be to attempt to divvy up workers by traffic (if I can figure out a way to manage it with ACLs or something) so that windows updates and a few other (stasticically big file) sites are given to one worker, and the rest go to the other worker.  I'm hoping to be able to cache big files a little more efficiently, currently they can lead to little seizures while squid opens a 2-gb file into memory, seizures that update software doesn't notice but end users do.  I'm thinking isolation may be the answer there.  Just thinking out loud, I'll grep the docs tonight and think about that more, pointers welcome.

&gt;<i> Three potential problems I can see here:
</I>&gt;<i> 
</I>&gt;<i>  1) are those flags the current values or your old findings? things might have
</I>&gt;<i> changed in some nasty subtle way.
</I>&gt;<i> 
</I>&gt;<i>  2) that Squid is now tuned to that exact VM emulation running on that exact
</I>&gt;<i> underlying host-OS hardware. Any variation of the two and you risk
</I>&gt;<i> SEGFAULT. see (1)
</I>&gt;<i> 
</I>I haven't repeated it in a while, but I went through a pretty lengthy process to figure out what those were, and the only update has been new kernels since then.  That said, it&#8217;s a fair point, how tightly wound do I want squid to my exact hardware config.

&gt;<i>  3) I dont think this expansion method is safe. Better to go something like
</I>&gt;<i> ./configure BOO=&quot;...&quot; CFLAGS=&quot;${BOO}&quot; CXXFLAGS=&quot;${BOO}&quot;
</I>&gt;<i> 
</I>Hey, that&#8217;s a good tip, I'll do that.

&gt;<i>  4) current Squid versions add -march=native automatically.
</I>&gt;<i> Unless you also add the --disable-arch-native option, it might be clashing with
</I>&gt;<i> your choice of CPU flags (at least the -march=core2). Also
</I>&gt;<i> (1) and (2) are relevant when building with -march=native.
</I>&gt;<i>
</I>...
&gt;<i> I've learnt just enough in this area myself to know that the best thing to do is
</I>&gt;<i> find someone in the embedded hardware area (or an expert in that specific
</I>&gt;<i> hardware) and ask their advice on flags.
</I>
Yes, or dedicate some time to experimentation and watching compile traffic go, and testing testing testing.  You can save yourself a 5-minute conversation with months of diligent effort :).

&gt;<i> &gt; (3)    Does the strategy above make sense?  My thinking is to segregate the
</I>&gt;<i> &gt; small cache items into a rock datastore, and the big items into an
</I>&gt;<i> &gt; aufs datastore.
</I>&gt;<i> 
</I>&gt;<i> Yes that is the recommended practice.
</I>In the interest of time, I think I may work more on tuning the datastores and come back to compiler flags later.

&gt;<i> &gt; I would
</I>&gt;<i> &gt; like to get multiple disker processes running, I think it would
</I>&gt;<i> &gt; probably help in my environment, but it's not supremely critical.
</I>&gt;<i> &gt; Anyway, there is a note at the end of the bug saying that this wasn't
</I>&gt;<i> &gt; seen for a while, and I thought I'd say &quot;I've seen it! Maybe!&quot;  let me
</I>&gt;<i> &gt; know if I am creating this bug through a creative mistake, or if you have
</I>&gt;<i> other ideas here.  Thanks!
</I>&gt;<i> 
</I>&gt;<i> Your original build options should have provided you with an SMP version of
</I>&gt;<i> Squid for both versions of 3.5. All you need for the basic SMP operation is
</I>&gt;<i> UDS sockets and /dev/shm shared memory.
</I>&gt;<i> 
</I>&gt;<i> The rest is squid.conf details.
</I>
It is my experience that squid.conf knows all.  I'll endeavor to read what is actually written in the docs, one more time :).  My main point earlier had been &quot;oh, cflags wasn't working, interesting, I wonder what happens when I use my overly calibrated, haphazardly prepared string on it?  Oh look, fireworks!&quot;  but I guess that was a predictable result looking back.


Last, but certainly not least, Marcus:

&gt;<i> &gt; ./configure CFLAGS=&quot;-march=core2 -mcx16 -msahf -mno-movbe -mno-aes
</I>&gt;<i> -mno-pclmul -mno-popcnt -mno-sse4 -msse4.1&quot; CXXFLAGS=&quot;${CFLAGS}&quot; --
</I>&gt;<i> with-pthreads --prefix=/usr   --localstatedir=/var
</I>&gt;<i> &gt; --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid --
</I>&gt;<i> sysconfdir=/etc/squid   --with-default-user=proxy --with-logdir=/var/log   --
</I>&gt;<i> with-pidfile=/var/run/squid.pid
</I>&gt;<i> &gt; --enable-linux-netfilter  --enable-cache-digests --enable-
</I>&gt;<i> storeio=ufs,aufs,diskd,rock  --enable-async-io=30 --enable-http-violations --
</I>&gt;<i> enable-zph-qos --with-netfilter-conntrack
</I>&gt;<i> &gt; --with-filedescriptors=65536 --with-large-files
</I>&gt;<i> 
</I>&gt;<i> I do not recommend setting options this way, especially -mcx16 -msahf and
</I>&gt;<i> others may produce code that does not run correctly on all systems.
</I>&gt;<i> 
</I>&gt;<i> I recommend using
</I>&gt;<i>     CFLAGS='-g -O2 -Wall -march=native' CXXFLAGS='-g -O2 -Wall -
</I>&gt;<i> march=native'
</I>&gt;<i> to get the best performance since it turns on all possible processor features
</I>&gt;<i> like mcx16 if and only if the used system supports it.
</I>
It sounds like -march-native is probably unnecessary too, but I will give '-g -O2 -Wall' a try and let you know if I come up with a less explosive result.  

Sorry for the massive three way email, hope it was still readable.  I didn't want to leave anyone out of the reply, and I do appreciate everyone's input.  Before getting back to me (unless I'm proposing doing something insanely stupid) I'll try Marcus's flags, and as time permits I'll add in the other ones until something gets sparky.  It sounds like this is probably not terribly useful, but I hate leaving something unanswered that isn't going to take me long to sort out.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009147.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
	<LI>Next message (by thread): <A HREF="009172.html">[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9170">[ date ]</a>
              <a href="thread.html#9170">[ thread ]</a>
              <a href="subject.html#9170">[ subject ]</a>
              <a href="author.html#9170">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
