<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%09CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C006a01d1698b%24926e7c60%24b74b7520%24%40optimera.us%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009170.html">
   <LINK REL="Next"  HREF="009176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known</H1>
    <B>Jester Purtteman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%09CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C006a01d1698b%24926e7c60%24b74b7520%24%40optimera.us%3E"
       TITLE="[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known">jester at optimera.us
       </A><BR>
    <I>Wed Feb 17 14:00:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009170.html">[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
</A></li>
        <LI>Next message (by thread): <A HREF="009176.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9172">[ date ]</a>
              <a href="thread.html#9172">[ thread ]</a>
              <a href="subject.html#9172">[ subject ]</a>
              <a href="author.html#9172">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--march=core2 it was, all others worked fine.  Not that they provided any improvement to the actual performance, but they didn't break anything either.  Now, I'll get to work tuning my cache dirs..  Thanks!

&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;<i> Behalf Of Jester Purtteman
</I>&gt;<i> Sent: Wednesday, February 17, 2016 5:37 AM
</I>&gt;<i> To: 'Marcus Kool' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">marcus.kool at urlfilterdb.com</A>&gt;; 'Eliezer Croitoru'
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>; 'Amos Jeffries'
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] Rock datastore, CFLAGS and a crash that (may be)
</I>&gt;<i> known
</I>&gt;<i> 
</I>&gt;<i> Dear Eliezer, Amos and Marcus,
</I>&gt;<i> 
</I>&gt;<i> Thank you, and sorry for the late reply, day jobs are a menace to productivity
</I>&gt;<i> :)
</I>&gt;<i> 
</I>&gt;<i> So, in order of responses:  Eliezer:
</I>&gt;<i> &gt; Before digging into the details of the issue, can you supply the OS details?
</I>&gt;<i> &gt; What OS are you using? What distribution?
</I>&gt;<i> &gt; 32 or 64 bit?
</I>&gt;<i> &gt; can you also add the output of &quot;squid -v&quot; for both 3.5.14 and 3.5.13 ?
</I>&gt;<i> 
</I>&gt;<i> I am running Ubuntu 14.04.2 updated to the latest apt-get binaries, 64-bit
</I>&gt;<i> version, 4 processors, 24-gb of &quot;ram&quot; allocated under the VM.  This is all on a
</I>&gt;<i> vmware ESXi 6.0 host, so I recognize that compiler flags are probably a bit like
</I>&gt;<i> throwing water balloons at Jaws from a performance stand point.  The
</I>&gt;<i> counter point is, with performance as bad as a VM, you need all the help you
</I>&gt;<i> can get.  As much as anything, it was a curiousity.
</I>&gt;<i> 
</I>&gt;<i> Squid -v for a working configuration is as follows:
</I>&gt;<i> 
</I>&gt;<i> Squid Cache: Version 3.5.14
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--with-pthreads' '--prefix=/usr' '--localstatedir=/var' '--
</I>&gt;<i> libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' '--
</I>&gt;<i> sysconfdir=/etc/squid' '--with-default-user=proxy' '--with-logdir=/var/log' '--
</I>&gt;<i> with-pidfile=/var/run/squid.pid' '--enable-linux-netfilter' '--enable-cache-
</I>&gt;<i> digests' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-async-io=30' '--
</I>&gt;<i> enable-http-violations' '--enable-zph-qos' '--with-netfilter-conntrack' '--with-
</I>&gt;<i> filedescriptors=65536' '--with-large-files' --enable-ltdl-convenience
</I>&gt;<i> 
</I>&gt;<i> I cut and pasted the configuration string I'd used with 3.5.13, added &quot;--with-
</I>&gt;<i> pthreads&quot;, and had no problems.  Here is the working 3.5.13 -v output:
</I>&gt;<i> 
</I>&gt;<i> Squid Cache: Version 3.5.13
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--prefix=/usr' '--localstatedir=/var' '--
</I>&gt;<i> libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' '--
</I>&gt;<i> sysconfdir=/etc/squid' '--with-default-user=proxy' '--with-logdir=/var/log' '--
</I>&gt;<i> with-pidfile=/var/run/squid.pid' '--enable-linux-netfilter' '--enable-cache-
</I>&gt;<i> digests' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-async-io=30' '--
</I>&gt;<i> enable-http-violations' '--enable-zph-qos' '--with-netfilter-conntrack' '--with-
</I>&gt;<i> filedescriptors=65536' '--with-large-files' --enable-ltdl-convenience
</I>&gt;<i> 
</I>&gt;<i> Amos:
</I>&gt;<i> 
</I>&gt;<i> &gt; &gt; cache_dir rock /var/spool/squid/rock/1 64000 swap-timeout=600
</I>&gt;<i> &gt; &gt; max-swap-rate=600 min-size=0 max-size=128KB
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; cache_dir rock /var/spool/squid/rock/2 102400 swap-timeout=600
</I>&gt;<i> &gt; &gt; max-swap-rate=600 min-size=128KB max-size=256KB
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; cache_dir aufs /var/spool/squid/aufs/1 200000 16 128 min-size=256KB
</I>&gt;<i> &gt; &gt; max-size=4096KB
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; cache_dir aufs /var/spool/squid/aufs/2 1500000 16 128
</I>&gt;<i> &gt; &gt; min-size=4096KB max-size=8196000KB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; NP: don't forget to isolate the AUFS cache_dir within each worker.
</I>&gt;<i> &gt; Either with the squid.conf if-else-endif syntax, or ${process_id} macros.
</I>&gt;<i> 
</I>&gt;<i> Right now I'm only running one worker, although I was hoping to gain a little
</I>&gt;<i> speed by having several dickers.  Is that going to require the additional squid-
</I>&gt;<i> conf syntax?  I had understood that to only be relevant to multiple workers,
</I>&gt;<i> and as I understand it, workers don't gracefully share resources yet.  One of
</I>&gt;<i> my future efforts will be to attempt to divvy up workers by traffic (if I can
</I>&gt;<i> figure out a way to manage it with ACLs or something) so that windows
</I>&gt;<i> updates and a few other (stasticically big file) sites are given to one worker,
</I>&gt;<i> and the rest go to the other worker.  I'm hoping to be able to cache big files a
</I>&gt;<i> little more efficiently, currently they can lead to little seizures while squid
</I>&gt;<i> opens a 2-gb file into memory, seizures that update software doesn't notice
</I>&gt;<i> but end users do.  I'm thinking isolation may be the answer there.  Just
</I>&gt;<i> thinking out loud, I'll grep the docs tonight and think about that more,
</I>&gt;<i> pointers welcome.
</I>&gt;<i> 
</I>&gt;<i> &gt; Three potential problems I can see here:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  1) are those flags the current values or your old findings? things
</I>&gt;<i> &gt; might have changed in some nasty subtle way.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  2) that Squid is now tuned to that exact VM emulation running on that
</I>&gt;<i> &gt; exact underlying host-OS hardware. Any variation of the two and you
</I>&gt;<i> &gt; risk SEGFAULT. see (1)
</I>&gt;<i> &gt;
</I>&gt;<i> I haven't repeated it in a while, but I went through a pretty lengthy process
</I>&gt;<i> to figure out what those were, and the only update has been new kernels
</I>&gt;<i> since then.  That said, it&#8217;s a fair point, how tightly wound do I want squid to
</I>&gt;<i> my exact hardware config.
</I>&gt;<i> 
</I>&gt;<i> &gt;  3) I dont think this expansion method is safe. Better to go something
</I>&gt;<i> &gt; like ./configure BOO=&quot;...&quot; CFLAGS=&quot;${BOO}&quot; CXXFLAGS=&quot;${BOO}&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> Hey, that&#8217;s a good tip, I'll do that.
</I>&gt;<i> 
</I>&gt;<i> &gt;  4) current Squid versions add -march=native automatically.
</I>&gt;<i> &gt; Unless you also add the --disable-arch-native option, it might be
</I>&gt;<i> &gt; clashing with your choice of CPU flags (at least the -march=core2).
</I>&gt;<i> &gt; Also
</I>&gt;<i> &gt; (1) and (2) are relevant when building with -march=native.
</I>&gt;<i> &gt;
</I>&gt;<i> ...
</I>&gt;<i> &gt; I've learnt just enough in this area myself to know that the best
</I>&gt;<i> &gt; thing to do is find someone in the embedded hardware area (or an
</I>&gt;<i> &gt; expert in that specific
</I>&gt;<i> &gt; hardware) and ask their advice on flags.
</I>&gt;<i> 
</I>&gt;<i> Yes, or dedicate some time to experimentation and watching compile traffic
</I>&gt;<i> go, and testing testing testing.  You can save yourself a 5-minute
</I>&gt;<i> conversation with months of diligent effort :).
</I>&gt;<i> 
</I>&gt;<i> &gt; &gt; (3)    Does the strategy above make sense?  My thinking is to segregate
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; small cache items into a rock datastore, and the big items into an
</I>&gt;<i> &gt; &gt; aufs datastore.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Yes that is the recommended practice.
</I>&gt;<i> In the interest of time, I think I may work more on tuning the datastores and
</I>&gt;<i> come back to compiler flags later.
</I>&gt;<i> 
</I>&gt;<i> &gt; &gt; I would
</I>&gt;<i> &gt; &gt; like to get multiple disker processes running, I think it would
</I>&gt;<i> &gt; &gt; probably help in my environment, but it's not supremely critical.
</I>&gt;<i> &gt; &gt; Anyway, there is a note at the end of the bug saying that this
</I>&gt;<i> &gt; &gt; wasn't seen for a while, and I thought I'd say &quot;I've seen it!
</I>&gt;<i> &gt; &gt; Maybe!&quot;  let me know if I am creating this bug through a creative
</I>&gt;<i> &gt; &gt; mistake, or if you have
</I>&gt;<i> &gt; other ideas here.  Thanks!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Your original build options should have provided you with an SMP
</I>&gt;<i> &gt; version of Squid for both versions of 3.5. All you need for the basic
</I>&gt;<i> &gt; SMP operation is UDS sockets and /dev/shm shared memory.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The rest is squid.conf details.
</I>&gt;<i> 
</I>&gt;<i> It is my experience that squid.conf knows all.  I'll endeavor to read what is
</I>&gt;<i> actually written in the docs, one more time :).  My main point earlier had
</I>&gt;<i> been &quot;oh, cflags wasn't working, interesting, I wonder what happens when I
</I>&gt;<i> use my overly calibrated, haphazardly prepared string on it?  Oh look,
</I>&gt;<i> fireworks!&quot;  but I guess that was a predictable result looking back.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Last, but certainly not least, Marcus:
</I>&gt;<i> 
</I>&gt;<i> &gt; &gt; ./configure CFLAGS=&quot;-march=core2 -mcx16 -msahf -mno-movbe -mno-
</I>&gt;<i> aes
</I>&gt;<i> &gt; -mno-pclmul -mno-popcnt -mno-sse4 -msse4.1&quot; CXXFLAGS=&quot;${CFLAGS}&quot; --
</I>&gt;<i> &gt; with-pthreads --prefix=/usr   --localstatedir=/var
</I>&gt;<i> &gt; &gt; --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid --
</I>&gt;<i> &gt; sysconfdir=/etc/squid   --with-default-user=proxy --with-logdir=/var/log   --
</I>&gt;<i> &gt; with-pidfile=/var/run/squid.pid
</I>&gt;<i> &gt; &gt; --enable-linux-netfilter  --enable-cache-digests --enable-
</I>&gt;<i> &gt; storeio=ufs,aufs,diskd,rock  --enable-async-io=30
</I>&gt;<i> &gt; --enable-http-violations -- enable-zph-qos --with-netfilter-conntrack
</I>&gt;<i> &gt; &gt; --with-filedescriptors=65536 --with-large-files
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I do not recommend setting options this way, especially -mcx16 -msahf
</I>&gt;<i> &gt; and others may produce code that does not run correctly on all systems.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I recommend using
</I>&gt;<i> &gt;     CFLAGS='-g -O2 -Wall -march=native' CXXFLAGS='-g -O2 -Wall -
</I>&gt;<i> &gt; march=native'
</I>&gt;<i> &gt; to get the best performance since it turns on all possible processor
</I>&gt;<i> &gt; features like mcx16 if and only if the used system supports it.
</I>&gt;<i> 
</I>&gt;<i> It sounds like -march-native is probably unnecessary too, but I will give '-g -
</I>&gt;<i> O2 -Wall' a try and let you know if I come up with a less explosive result.
</I>&gt;<i> 
</I>&gt;<i> Sorry for the massive three way email, hope it was still readable.  I didn't
</I>&gt;<i> want to leave anyone out of the reply, and I do appreciate everyone's input.
</I>&gt;<i> Before getting back to me (unless I'm proposing doing something insanely
</I>&gt;<i> stupid) I'll try Marcus's flags, and as time permits I'll add in the other ones
</I>&gt;<i> until something gets sparky.  It sounds like this is probably not terribly useful,
</I>&gt;<i> but I hate leaving something unanswered that isn't going to take me long to
</I>&gt;<i> sort out.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009170.html">[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
</A></li>
	<LI>Next message (by thread): <A HREF="009176.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9172">[ date ]</a>
              <a href="thread.html#9172">[ thread ]</a>
              <a href="subject.html#9172">[ subject ]</a>
              <a href="author.html#9172">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
