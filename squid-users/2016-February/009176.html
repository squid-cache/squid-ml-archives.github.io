<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock datastore, CFLAGS and a crash that (may be) known
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C49C18.4000501%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009172.html">
   <LINK REL="Next"  HREF="009193.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock datastore, CFLAGS and a crash that (may be) known</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C49C18.4000501%40treenet.co.nz%3E"
       TITLE="[squid-users] Rock datastore, CFLAGS and a crash that (may be) known">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb 17 16:13:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009172.html">[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
</A></li>
        <LI>Next message (by thread): <A HREF="009193.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9176">[ date ]</a>
              <a href="thread.html#9176">[ thread ]</a>
              <a href="subject.html#9176">[ subject ]</a>
              <a href="author.html#9176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/02/2016 2:36 a.m., Jester Purtteman wrote:
&gt;<i> 
</I>&gt;&gt;&gt;<i> cache_dir rock /var/spool/squid/rock/1 64000 swap-timeout=600
</I>&gt;&gt;&gt;<i> max-swap-rate=600 min-size=0 max-size=128KB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_dir rock /var/spool/squid/rock/2 102400 swap-timeout=600
</I>&gt;&gt;&gt;<i> max-swap-rate=600 min-size=128KB max-size=256KB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_dir aufs /var/spool/squid/aufs/1 200000 16 128 min-size=256KB
</I>&gt;&gt;&gt;<i> max-size=4096KB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_dir aufs /var/spool/squid/aufs/2 1500000 16 128 min-size=4096KB
</I>&gt;&gt;&gt;<i> max-size=8196000KB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: don't forget to isolate the AUFS cache_dir within each worker.
</I>&gt;&gt;<i> Either with the squid.conf if-else-endif syntax, or ${process_id} macros.
</I>&gt;<i> 
</I>
&gt;<i> Right now I'm only running one worker, although I was hoping to gain a
</I>&gt;<i> little speed by having several dickers. Is that going to require the
</I>&gt;<i> additional squid-conf syntax?
</I>

It *should* not matter if you have &quot;workers 1&quot; (or not configured).
Once you go beyond that it will definitely be needed.

&gt;<i> I had understood that to only be relevant
</I>&gt;<i> to multiple workers, and as I understand it, workers don't gracefully
</I>&gt;<i> share resources yet.
</I>
&quot;graceful&quot; is not the word for it. More of an all or nothing situation
on a per-component basis. Things like Rock where they do SMP it can be
quite graceful, AUFS on the other hand is still a non-SMP component and
does not even protect against broken config.


&gt;<i> One of my future efforts will be to attempt to
</I>&gt;<i> divvy up workers by traffic (if I can figure out a way to manage it with
</I>&gt;<i> ACLs or something) so that windows updates and a few other
</I>&gt;<i> (stasticically big file) sites are given to one worker, and the rest go
</I>&gt;<i> to the other worker.
</I>
You won't achieve that in any easy way. For teh same reason that you
have never been able to configure in squid.conf for the taffic that you
want to bypass the proxy entirely. By the time Squid worker has received
the message its too late to send it anywhere else.

With the Disker model though you dont have to bother. All workers take
their HTTP message and pass it expicitly to the one Disker process that
has that object cached.
This is very similar in behaviour to how the CARP caching algorithm
behaves with a frontend/worker handling the HTTP messages and
backend/Disker doing the caching. But a huge amount more efficiently
than a 2-layer CARP setup.


&gt;<i> I'm hoping to be able to cache big files a little
</I>&gt;<i> more efficiently, currently they can lead to little seizures while squid
</I>&gt;<i> opens a 2-gb file into memory, seizures that update software doesn't
</I>&gt;<i> notice but end users do. I'm thinking isolation may be the answer there.
</I>&gt;<i> Just thinking out loud, I'll grep the docs tonight and think about that
</I>&gt;<i> more, pointers welcome.
</I>
If I'm understanding you right the &quot;seizure&quot; you speak of is the
(sometimes large) jitter Squid intoduces to packets and event processing
delays when a large object is being transferred.

What we know about that is that the memory handling algorithm is very
inefficient in how it looks up the next bit of a stored object to send.
Even though Squid-3 is much better than Squid-2 it still has issues in
the area. That affects Squid just relaying any large object and is not
particularly related to the caching of them.


If you are allowing Squid to move very large objects into memory storage
(via maximum_object_size_in_memory) that can cause unnecessary hiccups.
Just reduce the max size directive and it should even out.


&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> It sounds like -march-native is probably unnecessary too, but I will
</I>&gt;<i> give '-g -O2 -Wall' a try and let you know if I come up with a less
</I>&gt;<i> explosive result.
</I>&gt;<i> 
</I>
Less explosive definitely. But even those are probably unnecessary.

Have a look at any one of the compiler lines produced during the build
to see what Squid is automagically adding for you.

 OR, the text output by ./configure displays a bunch of &quot;BUILD &quot; lines
stating what the exact final set of flags, libraries, extra objects for
each compiler tool is going to be just prior to the Makefiles being created.

We have also tried to tune the default build (./configure &amp;&amp; make) for
maximum generic usefulness and performance &quot;out of the box&quot;.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009172.html">[squid-users] Rock datastore,	CFLAGS and a crash that (may be) known
</A></li>
	<LI>Next message (by thread): <A HREF="009193.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9176">[ date ]</a>
              <a href="thread.html#9176">[ thread ]</a>
              <a href="subject.html#9176">[ subject ]</a>
              <a href="author.html#9176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
