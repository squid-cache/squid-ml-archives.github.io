<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cannot intercept &quot;https://www.elastic.co/&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cannot%20intercept%20%22https%3A//www.elastic.co/%22&In-Reply-To=%3C56C5A6B3.7050109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009121.html">
   <LINK REL="Next"  HREF="009117.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cannot intercept &quot;https://www.elastic.co/&quot;</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cannot%20intercept%20%22https%3A//www.elastic.co/%22&In-Reply-To=%3C56C5A6B3.7050109%40treenet.co.nz%3E"
       TITLE="[squid-users] cannot intercept &quot;https://www.elastic.co/&quot;">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb 18 11:10:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009121.html">[squid-users] cannot intercept &quot;https://www.elastic.co/&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="009117.html">[squid-users] tcp_outgoing_mark not working in 3.5.13
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9192">[ date ]</a>
              <a href="thread.html#9192">[ thread ]</a>
              <a href="subject.html#9192">[ subject ]</a>
              <a href="author.html#9192">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/02/2016 10:58 p.m., Murat K wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> as you said I upgraded to squid-3.5.14-1.el6.src.rpm and my problems below are gone, however can you explain me what is wrong with my config please? this is my config:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> shutdown_lifetime 1 seconds
</I>&gt;<i> 
</I>&gt;<i> icp_port 0
</I>&gt;<i> 
</I>&gt;<i> workers 2
</I>&gt;<i> 
</I>&gt;<i> http_port 0.0.0.0:8080 ssl-bump cert=/var/ngf/proxy/https_cert generate-host-certificates=on
</I>&gt;<i> 
</I>&gt;<i> http_port 0.0.0.0:18080 intercept ssl-bump cert=/var/ngf/proxy/https_cert generate-host-certificates=on
</I>&gt;<i> 
</I>&gt;<i> https_port 0.0.0.0:18081 intercept ssl-bump cert=/var/ngf/proxy/https_cert generate-host-certificates=on
</I>&gt;<i> 
</I>&gt;<i> acl no_ssl_interception dstdom_regex  &quot;/etc/squid/https_exceptions&quot;
</I>&gt;<i> 
</I>
Problem #1:
  dstdom* ACLs do not work properly in ssl_bump. The dstdom* is taken
from HTTP message URL - but ssl_bump is operating before there is any
HTTP message decrypted for that detail to come from.

The correct ACL type to be using here is ssl::server_name_regex.
Assuming that list is actually a set of regex patterns and not just a
list of domain names (which is another common misconfiguration).


&gt;<i> ssl_bump none localhost
</I>&gt;<i> 
</I>&gt;<i> ssl_bump none no_ssl_interception 
</I>&gt;<i> 
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i> 
</I>
Problem #2:
 none and server-first are deprecated actions for bumping. You need to
upgrade it to peek, splice, stare, bump, terminate actions.

The equivalent to what you have above is:
  ssl_bump splice localhost
  ssl_bump splice no_ssl_interception

  acl step2 at_step SslBumpStep1
  ssl_bump step2 bump


&gt;<i> acl https_proto proto https
</I>&gt;<i> 
</I>&gt;<i> always_direct allow https_proto
</I>&gt;<i> 
</I>
You dont have any cache_peer that I can see. So this is not necessary.

&gt;<i> sslproxy_cert_error allow all
</I>
Bad idea. This makes Squid treat any TLS errors (security or syntax
alike) as if nothing had gone wrong.

This directive is supposed to be used to specify a small set of errors
which are known to be safe but for some reason unavoidable on your
server connections. There are some for which that is true. MOST errors
in TLS are actually bad and need to be handled.

&gt;<i> 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>

Very bad idea. This disables *all* security that TLS offers beyond very
basic TLS syntax errors. It was only ever intended for debugging broken
installations. Never for production use.

So you are not checking (verifying) that the other end of the connection
is the server you tried to connect to, AND ignoring all errors that
occur in the protocol or crypto. Think about what that means.

This TLS thing is a security protocol, I mean like - its supposed to do
security. Be secure and all that jazz.


&gt;<i> cache_effective_user squid
</I>&gt;<i> 
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i>
</I>
Check your squid -v output. If it contains &quot;--with-default-user=squid&quot;
then you can drop both of those.

If it contains another username, you should consider changing your file
permissions to be that default username instead of &quot;squid&quot;. Then
dropping the two above directives.


&gt;<i> cache_mem 60 MB
</I>&gt;<i> 
</I>&gt;<i> cache_dir rock /var/spool/squid 200 max-size=32768
</I>&gt;<i> error_directory /usr/share/squid/errors/tr
</I>&gt;<i> icon_directory /usr/share/squid/icons
</I>&gt;<i> max_filedesc 96751
</I>&gt;<i> server_persistent_connections off
</I>
This prevents Squid using one of the major performance features of
HTTP/1.1 protocol (persistent connections / keep-alive). You should
seriously re-enable it unless it causes grief directly attributable to
the HTTP keep-alive feature.

If you are doing this to reduce upstream server connections hogging
sockets too long, then tune the server_idle_pconn_timeout directive and
your systems TCP wait periods instead.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009121.html">[squid-users] cannot intercept &quot;https://www.elastic.co/&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="009117.html">[squid-users] tcp_outgoing_mark not working in 3.5.13
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9192">[ date ]</a>
              <a href="thread.html#9192">[ thread ]</a>
              <a href="subject.html#9192">[ subject ]</a>
              <a href="author.html#9192">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
