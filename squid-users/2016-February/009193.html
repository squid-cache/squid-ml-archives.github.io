<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock datastore, CFLAGS and a crash that (may be) known
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C5B2DA.1080606%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009176.html">
   <LINK REL="Next"  HREF="009178.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock datastore, CFLAGS and a crash that (may be) known</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20datastore%2C%0A%20CFLAGS%20and%20a%20crash%20that%20%28may%20be%29%20known&In-Reply-To=%3C56C5B2DA.1080606%40treenet.co.nz%3E"
       TITLE="[squid-users] Rock datastore, CFLAGS and a crash that (may be) known">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb 18 12:02:34 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009176.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
        <LI>Next message (by thread): <A HREF="009178.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9193">[ date ]</a>
              <a href="thread.html#9193">[ thread ]</a>
              <a href="subject.html#9193">[ subject ]</a>
              <a href="author.html#9193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/02/2016 5:21 p.m., Jester Purtteman wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>]
</I>&gt;&gt;<i> Sent: Wednesday, February 17, 2016 8:13 AM
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Cc: Jester Purtteman &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jester at optimera.us</A>&gt;
</I>&gt;&gt;<i> Subject: Re: [squid-users] Rock datastore, CFLAGS and a crash that (may be)
</I>&gt;&gt;<i> known
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 18/02/2016 2:36 a.m., Jester Purtteman wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> cache_dir rock /var/spool/squid/rock/1 64000 swap-timeout=600
</I>&gt;&gt;&gt;&gt;&gt;<i> max-swap-rate=600 min-size=0 max-size=128KB
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> cache_dir rock /var/spool/squid/rock/2 102400 swap-timeout=600
</I>&gt;&gt;&gt;&gt;&gt;<i> max-swap-rate=600 min-size=128KB max-size=256KB
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> cache_dir aufs /var/spool/squid/aufs/1 200000 16 128 min-size=256KB
</I>&gt;&gt;&gt;&gt;&gt;<i> max-size=4096KB
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> cache_dir aufs /var/spool/squid/aufs/2 1500000 16 128
</I>&gt;&gt;&gt;&gt;&gt;<i> min-size=4096KB max-size=8196000KB
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> NP: don't forget to isolate the AUFS cache_dir within each worker.
</I>&gt;&gt;&gt;&gt;<i> Either with the squid.conf if-else-endif syntax, or ${process_id} macros.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&lt;snip&gt;
&gt;&gt;<i>
</I>&gt;&gt;<i> With the Disker model though you dont have to bother. All workers take
</I>&gt;&gt;<i> their HTTP message and pass it expicitly to the one Disker process that has
</I>&gt;&gt;<i> that object cached.
</I>&gt;&gt;<i> This is very similar in behaviour to how the CARP caching algorithm behaves
</I>&gt;&gt;<i> with a frontend/worker handling the HTTP messages and backend/Disker
</I>&gt;&gt;<i> doing the caching. But a huge amount more efficiently than a 2-layer CARP
</I>&gt;&gt;<i> setup.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> So, my only concern had been that I would end up with N workers and N
</I>&gt;<i> separate datastores (with duplicated data).  Am I understanding that
</I>&gt;<i> I can have several workers that may potentially share a single
</I>&gt;<i> disker? (I am guessing there is a delay involved if two workers hit
</I>&gt;<i> the same cache dir disker at the same time).  Or is there a need to
</I>&gt;<i> do two datastores (that will have overlapping cache entries) and two
</I>&gt;<i> diskers if I want two workers?  The latter (needing redundant
</I>&gt;<i> datastores) is how I had understood that to work.  If I am wrong,
</I>&gt;<i> then what am I waiting for?  Let me know, I think I may be seeing
</I>&gt;<i> what I want to see in this case.
</I>&gt;<i> 
</I>
&quot;workers N&quot; initiates N workers for handling HTTP messages.
Each &quot;cache_dir rock&quot; entry initiates just one Disker process which is
in charge of the objects coming and going to that cache_dir.

The workers are all aware of the Diskers and request data from the
Disker be loaded via shared memory as needed to answer an HTTP message
being handled by the worker.

&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm hoping to be able to cache big files a little more efficiently,
</I>&gt;&gt;&gt;<i> currently they can lead to little seizures while squid opens a 2-gb
</I>&gt;&gt;&gt;<i> file into memory, seizures that update software doesn't notice but end
</I>&gt;&gt;&gt;<i> users do. I'm thinking isolation may be the answer there.
</I>&gt;&gt;&gt;<i> Just thinking out loud, I'll grep the docs tonight and think about
</I>&gt;&gt;&gt;<i> that more, pointers welcome.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I'm understanding you right the &quot;seizure&quot; you speak of is the (sometimes
</I>&gt;&gt;<i> large) jitter Squid intoduces to packets and event processing delays when a
</I>&gt;&gt;<i> large object is being transferred.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What we know about that is that the memory handling algorithm is very
</I>&gt;&gt;<i> inefficient in how it looks up the next bit of a stored object to send.
</I>&gt;&gt;<i> Even though Squid-3 is much better than Squid-2 it still has issues in the area.
</I>&gt;&gt;<i> That affects Squid just relaying any large object and is not particularly related
</I>&gt;&gt;<i> to the caching of them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are allowing Squid to move very large objects into memory storage (via
</I>&gt;&gt;<i> maximum_object_size_in_memory) that can cause unnecessary hiccups.
</I>&gt;&gt;<i> Just reduce the max size directive and it should even out.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Yeah, I actually think I might just set that up with no-cache, and
</I>&gt;<i> setup a separate squid proxy for Very Big Files (well, sites with a
</I>&gt;<i> high probability of generating Very Big Files, like windows update,
</I>&gt;<i> apple update etc) and let THAT lock up.  Then I can set my cache size
</I>&gt;<i> for the other 99.97% of the internet to something more reasonable,
</I>&gt;<i> and that may fix the trouble I have had.
</I>&gt;<i> 
</I>&gt;<i> The big glitch is windows updates, those blasted things are FRIGGEN
</I>&gt;<i> HUGE, and seem like quite the wasteful thing to pull over a satellite
</I>&gt;<i> twice if it can be helped.  I have 800 users now, and I suspect a
</I>&gt;<i> good fraction of all my traffic is just updates being sent and resent
</I>&gt;<i> and resent.
</I>&gt;<i> 
</I>
Nod. There was a thread not long ago where two of us tried to figure out
how best to handle those. The old strategy for dealing with Win7 and
older has kind of stopped working with the big Win10 updates and
forced-upgrades going on.
We got no good results yet AFAIK.

&lt;snip&gt;
&gt;<i> What actually seems to have induced a crash is having over 96 gb of
</I>&gt;<i> rock store specified.  Whenever I bump that up to 128GB or beyond, it
</I>&gt;<i> crashes with the error that started me out on this wild goose chase.
</I>&gt;<i> The following line is actually what caused the crash, I just didn't
</I>&gt;<i> catch that I changed both of them at once.  Thoughts?
</I>&gt;<i> 
</I>&gt;<i> cache_dir rock /var/spool/squid/rock/1 32000 swap-timeout=600 max-swap-rate=600 min-size=0 max-size=64KB
</I>&gt;<i> cache_dir rock /var/spool/squid/rock/2 128000 swap-timeout=600 max-swap-rate=600 min-size=64KB max-size=256KB
</I>&gt;<i> 
</I>
Those &quot;KB&quot; units are not understood by Squid. Will just be ignored at
present since they are not digits.


&gt;<i> Changing the size of cache_dir number 2 to 64000 stops it from
</I>&gt;<i> crashing.  Adding a third 64000 rock store causes a crash as well.
</I>&gt;<i> The disk itself is 180 gb formatted capacity.  I'll turn up the
</I>&gt;<i> debugging and see if it says anything interesting.
</I>&gt;<i> 
</I>
Just a guess, but I suspect this is related to either some limit in your
shared-memory size (SMP rock cache needs lots of shared memory for the
cache index).

Or other bugs may be possible. Maybe related to the objects size issue
above.

When you are creating a rock cache for large objects IIRC you should
increase the default slot size to reduce the number of slots per
objects. You get a bit of wastage in the last slot. But relative to the
total object size that should not be much to pay. Rock defaults are
tuned to small under-32KB objects.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009176.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
	<LI>Next message (by thread): <A HREF="009178.html">[squid-users] Rock datastore, CFLAGS and a crash that (may be) known
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9193">[ date ]</a>
              <a href="thread.html#9193">[ thread ]</a>
              <a href="subject.html#9193">[ subject ]</a>
              <a href="author.html#9193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
