<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.3.8 -- Authentication Problems when	usingAlias Host Name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.3.8%20--%20Authentication%20Problems%20when%0A%09usingAlias%20Host%20Name&In-Reply-To=%3Cnac95k%24uf6%241%40ger.gmane.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009118.html">
   <LINK REL="Next"  HREF="009126.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.3.8 -- Authentication Problems when	usingAlias Host Name</H1>
    <B>Markus Moeller</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.3.8%20--%20Authentication%20Problems%20when%0A%09usingAlias%20Host%20Name&In-Reply-To=%3Cnac95k%24uf6%241%40ger.gmane.org%3E"
       TITLE="[squid-users] Squid 3.3.8 -- Authentication Problems when	usingAlias Host Name">huaraz at moeller.plus.com
       </A><BR>
    <I>Sun Feb 21 12:05:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009118.html">[squid-users] Squid 3.3.8 -- Authentication Problems when using	Alias Host Name
</A></li>
        <LI>Next message (by thread): <A HREF="009126.html">[squid-users] Authentification, the login prompt appears twice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9202">[ date ]</a>
              <a href="thread.html#9202">[ thread ]</a>
              <a href="subject.html#9202">[ subject ]</a>
              <a href="author.html#9202">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Markus,

  When you say authentication does not work, do you mean Kerberos 
authentication or Kerberos and NTLM ?  Can you add a -d for debug to the 
Kerberos authentication helper and provide the log file messages ?

  Can you also provide the content of the keytab ?

Regards
Markus

&quot;Markus Sonnenberg&quot;  wrote in message news:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">56C1C720.5030804 at rz-amper.de...</A>

Hi,

i've set up a CentOS 7 machine with Squid 3.3.8 and kerberos/ntlm
authentication in order to replace our older Squid Proxy.
The new Squid server runs fine and authentication is working as
expected. We use group policies to set proxy server address at terminal
servers and workstations,which is &quot;proxy.company.com&quot;. This address is
an A record and currently points to the ip address of our old proxy
server. The hostname of our old proxy server is &quot;euprx001.company.com&quot;
and the hostname of our new proxy server is &quot;euprx101.company.com&quot;

When I change the A record for &quot;proxy.company.com&quot; pointing to the ip
address of our new proxy server then authentication is not working.

   proxy.company.com            10.222.40.106
   euprx101.company.com      10.222.40.106

Authentication work if internet explorer uses the real host name but it
does not work if uses &quot;proxy.company.com&quot;

Gues what, this A record is pointing currently to our old proxy server
and works fine regardless if internet explorer connects to proxy... or
euprx001....

Here's the current config I'm using on our new proxy server.

&lt;snip&gt;
#  Network Options
#
+-------------------------------------------------------------------------+
http_port 8080
icp_port 0
offline_mode off

#  Administrative Options
#
+-------------------------------------------------------------------------+
via off
cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">edc.helpdesk at company.com</A>
cachemgr_passwd ap0ll0 all
cache_effective_user squid
cache_effective_group squid
# cache_dir rock /cache 40000 max-size=4194304 slot-size=32768
cache_mem 6144 MB
memory_pools on
pid_filename /var/run/squid.pid
ftp_user anonymous
ftp_passive off
check_hostnames off
request_header_max_size 20 KB
snmp_port 3401
shutdown_lifetime 2 seconds
maximum_object_size 1048576 KB
maximum_object_size_in_memory 10240 KB
forwarded_for on
snmp_incoming_address 0.0.0.0
workers 4
error_directory /usr/share/squid/errors/TTI
deny_info ERR_AD_REMOVED AdServer
deny_info ERR_BLOCKED_FILES BlockedFiles
deny_info ERR_BLOCKED_SITES BlockedSites
deny_info ERR_BLOCKED_SOCIAL BlockedSocialnet
deny_info ERR_BLOCKED_WEBMAIL BlockedWebmail

### negotiate kerberos and ntlm authentication
auth_param negotiate program /usr/local/bin/negotiate_wrapper --ntlm
/usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp
--domain=DE.COMPANY.COM --kerberos
/usr/lib64/squid/negotiate_kerberos_auth -s GSS_C_NO_NAME
auth_param negotiate children 300 startup=10 idle=10
auth_param negotiate keep_alive on

### pure ntlm authentication
auth_param ntlm program /usr/bin/ntlm_auth
--helper-protocol=squid-2.5-ntlmssp --domain=DE.COMPANY.COM
auth_param ntlm children 10
auth_param ntlm keep_alive on

### provide basic authentication via ldap for clients not authenticated
via kerberos/ntlm
auth_param basic program /usr/lib64/squid/basic_ldap_auth -R -b
&quot;dc=DE,dc=COMPANY,dc=COM&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">SVC_Squid at company.com</A> -W
/etc/squid/ldappass.txt -f sAMAccountName=%s -h euads201.de.company.com
auth_param basic children 10 startup=0 idle=1
auth_param basic realm Company, Inc. European Web Proxy
auth_param basic credentialsttl 120 minute

### ldap authorisation
external_acl_type memberof %LOGIN /usr/lib64/squid/ext_ldap_group_acl -R
-K -S -b &quot;dc=DE,dc=COMPANY,dc=COM&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">SVC_Squid at de.company.com</A> -W
/etc/squid/ldappass.txt -f &quot;(&amp;(objectclass=person)(sAMAccountName=%v)
(memberof=cn=%g,cn=Users,dc=DE,dc=COMPANY,dc=COM))&quot; -h
euads201.de.company.com

#  Logging
#
+-------------------------------------------------------------------------+
logformat squid %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt
access_log daemon:/var/log/squid/squid-cache-access.log squid

#  Refresh Pattern
#
+-------------------------------------------------------------------------+
refresh_pattern ^<A HREF="http://.*\.gif$">http://.*\.gif$</A>   10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.png$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.jpg$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.jpeg$         10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.bmp$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.gif$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.ico$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.swf$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.flv$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.rar$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.ram$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.txt$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern -i \.css$          10080     100%       120960
reload-into-ims override-expire ignore-reload
refresh_pattern ^<A HREF="http://">http://</A>           1         100%       20160
reload-into-ims ignore-reload
refresh_pattern ^<A HREF="ftp://">ftp://</A>            10080     100%       120960
refresh_pattern ^<A HREF="gopher://">gopher://</A>         240       40%        20160
refresh_pattern -i (/cgi-bin/|\?)  0         0%         0
refresh_pattern .                  0         100%       20160
reload-into-ims

#  Access Control List
#
+-------------------------------------------------------------------------+
### acl for proxy auth and ldap authorizations
#
#   aclname             acltype  typename activedirectorygroup
acl snmppublic          snmp_community public
acl Java                browser Java/1.4 Java/1.5 Java/1.6 Java/1.7
Java/1.8 Java/1.9
acl auth                proxy_auth REQUIRED
acl AdminAccess         external memberof &quot;/etc/squid/group_admin.txt&quot;
acl BlockedAccess       external memberof &quot;/etc/squid/group_blocked.txt&quot;
acl RestrictedAccess    external memberof &quot;/etc/squid/group_restricted.txt&quot;
acl StandardAccess      external memberof &quot;/etc/squid/group_standard.txt&quot;
acl FullAccess          external memberof &quot;/etc/squid/group_full.txt&quot;
acl AdServer            dstdom_regex &quot;/etc/squid/dst_adserver.txt&quot;
acl BlockedSites        dstdom_regex &quot;/etc/squid/dst_blocked.txt&quot;
acl BlockedSocialnet    dstdom_regex &quot;/etc/squid/dst_socialnet.txt&quot;
acl BlockedWebmail      dstdom_regex &quot;/etc/squid/dst_webmail.txt&quot;
acl AllowedSites        dstdomain &quot;/etc/squid/dst_allowed.txt&quot;
acl noauthsites         dstdomain &quot;/etc/squid/dst_noauth.txt&quot;
acl dontcache           dstdomain &quot;/etc/squid/dst_dontcache.txt&quot;
acl BlockedFiles        urlpath_regex &quot;/etc/squid/blockedfiles.txt&quot;
acl vlan3042            dst 10.222.42.0/23
acl vlan3044            dst 10.222.44.0/23
acl vlan3247            dst 10.222.247.0/24
acl SSL_ports           port 80 87 443 446 447 481 482 563 1494 2598
6400 8020 8443 9250 9443 10000 10020 44300
acl Safe_ports          port 21 70 80 210 210 280 443 446 447 481 482
488 563 591 666 777 1025-65535
acl CONNECT             method CONNECT

### cache directives
cache deny dontcache

### snmp_access rules
snmp_access allow       snmppublic

### http_access rules
http_access allow       manager localhost
http_access deny        manager
http_access deny        !Safe_ports
http_access deny        CONNECT !SSL_ports
http_access allow       localhost

# enforce authentication, order of rules is important for authorization
levels
http_access allow       Java
http_access allow       noauthsites
http_access deny        !auth
http_access deny        AdServer
http_access allow       AdminAccess
http_access deny        BlockedAccess all
http_access deny        BlockedFiles
http_access allow       AllowedSites
http_access deny        RestrictedAccess all
http_access allow       FullAccess auth
http_access deny        BlockedSites
http_access deny        BlockedSocialnet
http_access deny        BlockedWebmail
http_access allow       StandardAccess auth
# DO NOT REMOVE THE FOLLOWING LINE
http_access deny all

# The End
#
+-------------------------------------------------------------------------+
You have new mail in /var/spool/mail/root
&lt;/snip&gt;

best regards
Markus

ct,

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009118.html">[squid-users] Squid 3.3.8 -- Authentication Problems when using	Alias Host Name
</A></li>
	<LI>Next message (by thread): <A HREF="009126.html">[squid-users] Authentification, the login prompt appears twice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9202">[ date ]</a>
              <a href="thread.html#9202">[ thread ]</a>
              <a href="subject.html#9202">[ subject ]</a>
              <a href="author.html#9202">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
