<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rock Store max object size 3.5.14
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20Store%20max%20object%20size%203.5.14&In-Reply-To=%3C56CCCFA7.6000905%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009243.html">
   <LINK REL="Next"  HREF="009249.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rock Store max object size 3.5.14</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rock%20Store%20max%20object%20size%203.5.14&In-Reply-To=%3C56CCCFA7.6000905%40measurement-factory.com%3E"
       TITLE="[squid-users] Rock Store max object size 3.5.14">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 23 21:31:19 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009243.html">[squid-users] Rock Store max object size 3.5.14
</A></li>
        <LI>Next message (by thread): <A HREF="009249.html">[squid-users] Rock Store max object size 3.5.14
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9248">[ date ]</a>
              <a href="thread.html#9248">[ thread ]</a>
              <a href="subject.html#9248">[ subject ]</a>
              <a href="author.html#9248">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/23/2016 12:11 PM, Heiler Bemerguy wrote:
&gt;<i> 
</I>&gt;<i> Thanks Alex.
</I>&gt;<i> 
</I>&gt;<i> We have a simple cache_dir config like this, with no &quot;workers&quot; defined:
</I>&gt;<i> cache_dir rock /cache2 80000 min-size=0 max-size=32767
</I>&gt;<i> cache_dir aufs /cache 320000 96 256 min-size=32768
</I>
FWIW, I do not know whether aufs and rock play well together. YMMV.


&gt;<i> And we are suffering from a 100% CPU use by a single squid thread. 
</I>
Sustained 100% CPU load, especially lasting more than a second,
especially while Squid mostly stays in &quot;user&quot; space, is most likely a
Squid bug (including, but not limited to, severe performance bugs like
linear searches through very long lists).

A year or two ago, there was at least one such bug when handling large
responses. I do not know whether that bug has been fixed but I suspect
it has not been. I suspect there are bugs like that.

If you see these signs, report them and help triage/fix the problem.


&gt;<i> We
</I>&gt;<i> have lots of ram, cores and disk space.. but also too many users:
</I>&gt;<i> Number of clients accessing cache:      1634
</I>&gt;<i> Number of HTTP requests received:       3276691
</I>&gt;<i> Average HTTP requests per minute since start:   12807.1
</I>&gt;<i> Select loop called: 60353401 times, 22.017 ms avg
</I>
&gt;<i> Getting rid of this big aufs and spreading to many rock stores will
</I>&gt;<i> improve things here? I've already shrunk the acls and patterns/regexes etc
</I>
If you have beefy hardware, want to optimize performance, and are ready
to spend non-trivial amounts of time/labor/money doing that, then
consider the following rules of thumb:

1. Use the largest cache_mem your system can handle safely.
   Please note that Squid will not tell you when you over-allocate
   but may crash.

2. One or two CPU core reserved for the OS, depending on network usage
   levels. Use OS CPU affinity configuration to restrict network
   interrupts to these OS core(s).

3. One Rock cache_dir per physical disk spindle with no other
   cache_dirs. No RAID. Diskers may be able to use virtual CPU cores.
   Tuning Rock is tricky. See Performance Tuning recommendations at
   <A HREF="http://wiki.squid-cache.org/Features/RockStore">http://wiki.squid-cache.org/Features/RockStore</A>

4. One SMP worker per remaining non-virtual CPU cores.

5. Use CPU affinity for each Squid kid process (diskers and workers).
   Prohibit kernel from moving kids from one CPU core to another.

6. Watch individual CPU core utilization (not just the total!). Adjust
   the number of workers, the number of diskers, and CPU affinity maps
   to achieve balance while leaving a healthy overload safety margin.

Disclaimer: The above general rules may not apply to your environment. YMMV.

Squid is unlikely to work well in a demanding environment without
investment of labor and/or money (i.e., others' labor). In many such
environments, Squid code changes are needed. Squid is a complex product
with many problems. If you want top-notch performance, there is no
simple blueprint. Getting Squid work well in a challenging environment
is not a &quot;one weekend&quot; project. Unfortunately.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009243.html">[squid-users] Rock Store max object size 3.5.14
</A></li>
	<LI>Next message (by thread): <A HREF="009249.html">[squid-users] Rock Store max object size 3.5.14
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9248">[ date ]</a>
              <a href="thread.html#9248">[ thread ]</a>
              <a href="subject.html#9248">[ subject ]</a>
              <a href="author.html#9248">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
