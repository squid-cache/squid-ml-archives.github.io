<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL bump memory leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20memory%20leak&In-Reply-To=%3C56CD8347.3030606%40opendium.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009247.html">
   <LINK REL="Next"  HREF="009298.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL bump memory leak</H1>
    <B>Steve Hill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20bump%20memory%20leak&In-Reply-To=%3C56CD8347.3030606%40opendium.com%3E"
       TITLE="[squid-users] SSL bump memory leak">steve at opendium.com
       </A><BR>
    <I>Wed Feb 24 10:17:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009247.html">[squid-users] SSL bump memory leak
</A></li>
        <LI>Next message (by thread): <A HREF="009298.html">[squid-users] SSL bump memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9274">[ date ]</a>
              <a href="thread.html#9274">[ thread ]</a>
              <a href="subject.html#9274">[ subject ]</a>
              <a href="author.html#9274">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/02/16 21:28, Amos Jeffries wrote:

&gt;<i> Ah, you said &quot;a small number&quot; of wiki cert strings with those details. I
</I>&gt;<i> took that as meaning a small number of definitely squid generated ones
</I>&gt;<i> amidst the 130K indeterminate ones leaking.
</I>
Ah, a misunderstanding on my part - sorry.  Yes, there were 302 strings 
containing &quot;signTrusted&quot; (77 of them unique), all of them appear to be 
server certificates (i.e. with a CN containing a domain name), so it is 
possibly reasonable to assume that they were for in-progress sessions 
and would therefore be cleaned up.

This leaves around 131297 other subject/issuer strings (581 unique) 
which, to my mind, can't be explained by anything other than a leak 
(whether that be a &quot;real&quot; leak where the pointers have been discarded 
without freeing the data, or a &quot;pseudo&quot; leak caused by references to 
them being held forever).

The SslBump wiki page (<A HREF="http://wiki.squid-cache.org/Features/SslBump">http://wiki.squid-cache.org/Features/SslBump</A>) 
says that the SSL context used for talking to servers is wiped on 
reconfigure, and from what I've seen in the code it looks like this 
should still be true.  However, a reconfigure doesn't seem to help in 
this case, so my assumption is that this data is not part of that SSL 
context.  I'm not sure where else all of this data could be from though.

As much of the data seem to be intermediate and root CA certificates, it 
is presumably being collected from web servers, rather than being 
generated locally.  Of the 131K strings not containing &quot;signTrusted&quot;, 
only 2760 of them appear to be server certificates (86 unique), so it 
seems to me that the rest of the data are probably the intermediate 
certificate chains from web servers that Squid has connected to.

It looks like there were also over 400K bumped requests split across 2 
workers, so although 131K certificates is a massive amount of &quot;leaked&quot; 
data, I don't think we are leaking on every connection.  Coupled with 
the fact that I can't seem to reproduce this in a test environment, 
suggests that there is something a little abnormal going on to trigger 
the leak.  Also bear in mind that a single certificate will show up as 2 
separate strings, since it has both a subject and an issuer, so we're 
probably actually talking about around 65K certificates.

-- 
  - Steve Hill
    Technical Director
    Opendium Limited     <A HREF="http://www.opendium.com">http://www.opendium.com</A>

Direct contacts:
    Instant messager: xmpp:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>
    Phone:            sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">steve at opendium.com</A>

Sales / enquiries contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>
    Phone:            +44-1792-824568 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sales at opendium.com</A>

Support contacts:
    Email:            <A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>
    Phone:            +44-1792-825748 / sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">support at opendium.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009247.html">[squid-users] SSL bump memory leak
</A></li>
	<LI>Next message (by thread): <A HREF="009298.html">[squid-users] SSL bump memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9274">[ date ]</a>
              <a href="thread.html#9274">[ thread ]</a>
              <a href="subject.html#9274">[ subject ]</a>
              <a href="author.html#9274">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
