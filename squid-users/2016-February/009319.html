<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Optimizing squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Optimizing%20squid&In-Reply-To=%3C56CF374E.6040600%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009318.html">
   <LINK REL="Next"  HREF="009322.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Optimizing squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Optimizing%20squid&In-Reply-To=%3C56CF374E.6040600%40treenet.co.nz%3E"
       TITLE="[squid-users] Optimizing squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb 25 17:18:06 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009318.html">[squid-users] Optimizing squid
</A></li>
        <LI>Next message (by thread): <A HREF="009322.html">[squid-users] Optimizing squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9319">[ date ]</a>
              <a href="thread.html#9319">[ thread ]</a>
              <a href="subject.html#9319">[ subject ]</a>
              <a href="author.html#9319">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/02/2016 5:58 a.m., Heiler Bemerguy wrote:
&gt;<i> 
</I>&gt;<i> Hi Alex, Eliezer, Yuri, Amos..
</I>&gt;<i> 
</I>&gt;<i> So, to start from the start, after seeing squid was totally stable and
</I>&gt;<i> fast, running with NO cache_dirs, I tried to add only 2 rockstore
</I>&gt;<i> cache_dirs to test.
</I>&gt;<i> 
</I>&gt;<i> conf:
</I>&gt;<i> /cache_dir rock /cache2/rock1 20000 min-size=0 max-size=4096
</I>&gt;<i> slot-size=2048//
</I>&gt;<i> //cache_dir rock /cache2/rock2 30000 min-size=4097 max-size=16384
</I>&gt;<i> slot-size=4096/
</I>&gt;<i> (ps.: I know it would be nice to use one store PER partition/disk/lun
</I>&gt;<i> whatever.. but I'm trying to lessen disk wasting by using small
</I>&gt;<i> slot-sizes for small files.. am I wrong?)
</I>&gt;<i> 
</I>&gt;<i> Then squid -z:
</I>&gt;<i> /2016/02/25 13:42:00 kid2| Creating Rock db: /cache2/rock1/rock//
</I>&gt;<i> //2016/02/25 13:42:00 kid3| Creating Rock db: /cache2/rock2/rock/
</I>&gt;<i> 
</I>&gt;<i> Then running squid for the first time with these newly created rock
</I>&gt;<i> stores....
</I>&gt;<i> 
</I>&gt;<i> /2016/02/25 13:42:09 kid3| Loading cache_dir #1 from /cache2/rock2/rock//
</I>&gt;<i> //2016/02/25 13:42:09 kid2| Loading cache_dir #0 from /cache2/rock1/rock//
</I>&gt;<i> //2016/02/25 13:42:09 kid3| Store rebuilding is 0.01% complete//
</I>&gt;<i> //2016/02/25 13:42:09 kid2| Store rebuilding is 0.01% complete/
</I>&gt;<i> 
</I>&gt;<i> Rebuilding what? just creating the huge files I think...
</I>
The cache index for those rock DB.

Unlike UFS which stores a swap.state file, rock rebuilds its index on
each startup.

&gt;<i> 
</I>&gt;<i> Then:
</I>&gt;<i> /2016/02/25 13:42:19 kid1| WARNING: swapfile header inconsistent with
</I>&gt;<i> available data
</I>&gt;<i> 2016/02/25 13:42:21 kid2| WARNING: cache_dir[0]: Ignoring malformed
</I>&gt;<i> cache entry meta data at 6943832064
</I>&lt;snip repeats&gt;
&gt;<i> 2016/02/25 13:42:40 kid1| ctx: enter level  0:
</I>&gt;<i> '<A HREF="http://static.bn-static.com/pg/0plcB0QjJpBbwN7rMMDjKKO5Z63Nhu3zfPw==.gif">http://static.bn-static.com/pg/0plcB0QjJpBbwN7rMMDjKKO5Z63Nhu3zfPw==.gif</A>'
</I>&gt;<i> 2016/02/25 13:42:40 kid1| WARNING: swapfile header inconsistent with
</I>&gt;<i> available data
</I>&gt;<i> 2016/02/25 13:42:40 kid2| WARNING: cache_dir[0]: Ignoring malformed
</I>&gt;<i> cache entry meta data at 19581075456
</I>&gt;<i> 2016/02/25 13:42:41 kid2| WARNING: cache_dir[0]: Ignoring malformed
</I>&gt;<i> cache entry meta data at 19757760512
</I>&gt;<i> 2016/02/25 13:42:43 kid2| Finished rebuilding storage from disk.
</I>&gt;<i> 2016/02/25 13:42:43 kid2|   10239992 Entries scanned
</I>&gt;<i> 2016/02/25 13:42:43 kid2|        14 Invalid entries.///
</I>&gt;<i> 
</I>&gt;<i> What entry? why malformed? Wasn't it just a empty store?! it just
</I>&gt;<i> created it.......
</I>&gt;<i> 
</I>

Did you wait for the -z background processes to finish creating the 50GB
of disk allocation before starting the main Squid process ?

Are your workers trying to serve up traffic to or from the cache before
the rebuild has completed?


As you can see from the log timestamps on startup it will take ~30-60
sec for the rock caches of that size to be loaded in your system.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009318.html">[squid-users] Optimizing squid
</A></li>
	<LI>Next message (by thread): <A HREF="009322.html">[squid-users] Optimizing squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9319">[ date ]</a>
              <a href="thread.html#9319">[ thread ]</a>
              <a href="subject.html#9319">[ subject ]</a>
              <a href="author.html#9319">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
