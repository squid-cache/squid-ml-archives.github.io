<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Optimizing squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Optimizing%20squid&In-Reply-To=%3C56CF55FE.7060903%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009328.html">
   <LINK REL="Next"  HREF="009329.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Optimizing squid</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Optimizing%20squid&In-Reply-To=%3C56CF55FE.7060903%40measurement-factory.com%3E"
       TITLE="[squid-users] Optimizing squid">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Feb 25 19:29:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009328.html">[squid-users] Optimizing squid
</A></li>
        <LI>Next message (by thread): <A HREF="009329.html">[squid-users] Optimizing squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9326">[ date ]</a>
              <a href="thread.html#9326">[ thread ]</a>
              <a href="subject.html#9326">[ subject ]</a>
              <a href="author.html#9326">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/25/2016 09:58 AM, Heiler Bemerguy wrote:

&gt;<i> So, to start from the start, after seeing squid was totally stable and
</I>&gt;<i> fast, running with NO cache_dirs, I tried to add only 2 rockstore
</I>&gt;<i> cache_dirs to test.
</I>
&gt;<i> cache_dir rock /cache2/rock1 20000 min-size=0 max-size=4096 slot-size=2048
</I>&gt;<i> cache_dir rock /cache2/rock2 30000 min-size=4097 max-size=16384 slot-size=4096
</I>

&gt;<i> (ps.: I know it would be nice to use one store PER partition/disk/lun
</I>&gt;<i> whatever.. but I'm trying to lessen disk wasting by using small
</I>&gt;<i> slot-sizes for small files.. am I wrong?)
</I>
There is nothing wrong with the desire to reduce waste. However, you are
combining multiple optimization goals into one mess that would be
difficult to untangle. I recommend that you focus on _one_ primary goal
and, once that goal is accomplished, move on to the next one. I see a
growing list of [potential] goals in your emails:

  1. Solve occasional 100% CPU utilization problem.
  2. Optimize Squid performance on beefy hardware.
  3. Reduce disk space waste.
  4. Solve &quot;malformed cache entry&quot; problems.

In general, if something does not work, report a bug to bugzilla or your
support team and, if possible, back off or simplify to avoid that bug
while you focus on your primary goal. Solving 100% CPU usage problems
while battling cache rebuild problems, optimizing cache space
allocation, learning to interpret Squid logs, and juggling contradictory
squid-users advice is a recipe for lots of headaches and little progress!


&gt;<i> /2016/02/25 13:42:09 kid3| Loading cache_dir #1 from /cache2/rock2/rock//
</I>&gt;<i> /2016/02/25 13:42:09 kid2| Loading cache_dir #0 from /cache2/rock1/rock//
</I>&gt;<i> /2016/02/25 13:42:09 kid3| Store rebuilding is 0.01% complete//
</I>&gt;<i> /2016/02/25 13:42:09 kid2| Store rebuilding is 0.01% complete/
</I>&gt;<i> 
</I>&gt;<i> Rebuilding what? just creating the huge files I think...
</I>
The &quot;huge files&quot; were already created during squid -z.

As Amos have said, rock store is [re]building an in-memory cache index.
Other stores do that too, but rock store takes longer under most common
circumstances. Please note that rock does not know that you have created
a new rock db a few minutes ago.

Patches optimizing index build and/or log messages are welcomed.


&gt;<i> Then:
</I>&gt;<i> /2016/02/25 13:42:19 kid1| WARNING: swapfile header inconsistent with
</I>&gt;<i> available data
</I>
I do not know what causes these in your environment. Do you see them
when _not_ using any optional options on the cache_dir lines and not
sending any HTTP requests to Squid?

&gt;<i> 2016/02/25 13:42:40 kid1| ctx: enter level  0:
</I>&gt;<i> '<A HREF="http://static.bn-static.com/pg/0plcB0QjJpBbwN7rMMDjKKO5Z63Nhu3zfPw==.gif">http://static.bn-static.com/pg/0plcB0QjJpBbwN7rMMDjKKO5Z63Nhu3zfPw==.gif</A>'
</I>
It looks like you Squid is receiving some traffic while rebuilding its
index. Bugs notwithstanding, that should work and is supported, but it
may be helpful to know whether you get any errors when there is no
traffic while cache index is being built.


&gt;<i> 2016/02/25 13:42:43 kid2|   10239992 Entries scanned
</I>&gt;<i> 2016/02/25 13:42:43 kid2|        14 Invalid entries.///
</I>
&gt;<i> What entry?
</I>
Squid calls HTTP responses stored in its cache &quot;cache entries&quot; or &quot;store
entries&quot;. IIRC, in rock case, the entries in this specific log message
are actually rock db slots, but the Squid &quot;core&quot; code doing this
reporting does not know that.


&gt;<i> why malformed? 
</I>
Squid either does not know or is configured not to say. You can enable
more verbose logging to see more details. Overall, this problem is best
handled as a bug report than a squid-users discussion IMO, but see above
for some first triage steps.

If you report a bug, please specify what Squid version you are using and
on what OS.


&gt;<i> Wasn't it just a empty store?! it just created it.......
</I>
This could be a Squid bug, but AFAICT, you also sent some traffic
through Squid so the store may not be empty because of that.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009328.html">[squid-users] Optimizing squid
</A></li>
	<LI>Next message (by thread): <A HREF="009329.html">[squid-users] Optimizing squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9326">[ date ]</a>
              <a href="thread.html#9326">[ thread ]</a>
              <a href="subject.html#9326">[ subject ]</a>
              <a href="author.html#9326">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
