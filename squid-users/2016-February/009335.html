<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump matching Subject Alternative Names
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20matching%20Subject%20Alternative%20Names&In-Reply-To=%3C56CF7DBF.5060005%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009308.html">
   <LINK REL="Next"  HREF="009356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump matching Subject Alternative Names</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20matching%20Subject%20Alternative%20Names&In-Reply-To=%3C56CF7DBF.5060005%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL Bump matching Subject Alternative Names">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb 25 22:18:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009308.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
        <LI>Next message (by thread): <A HREF="009356.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9335">[ date ]</a>
              <a href="thread.html#9335">[ thread ]</a>
              <a href="subject.html#9335">[ subject ]</a>
              <a href="author.html#9335">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/02/2016 12:38 a.m., Cohen-Rose, Adam wrote:
&gt;<i> We&#185;re trying to use SSL bump to splice traffic from a CDN (cdn.teads.tv)
</I>&gt;<i> 
</I>&gt;<i> The CDN server certificate uses Subject Alternative Names in its
</I>&gt;<i> certificate to identify the cdn.teads.tv domain rather than the Common
</I>&gt;<i> Name (which is set to aka.proceau.net).
</I>&gt;<i> 
</I>&gt;<i> Can we use SSL bump to splice requests to cdn.teads.tv or do we need to
</I>&gt;<i> use the CN domain to identify the CDN?
</I>
Yes the ssl::server_name ACL type matches SubjectAltName in the server
certificate during *step 3* of the ssl_bump process.

You first have to peek/stare at the serverHello data to get it.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We&#185;d like to terminate other connections so our current SSL Bump config is:
</I>&gt;<i> 
</I>&gt;<i> acl tcp_level at_step SslBump1
</I>&gt;<i> acl client_hello_peeked at_step SslBump2
</I>&gt;<i> ssl_bump peek tcp_level all
</I>
NP: the &quot; all&quot; is meaningless.

&gt;<i> 
</I>&gt;<i> acl to_teads_tv_ssl ssl::server_name cdn.teads.tv
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice client_hello_peeked to_teads_tv_ssl
</I>&gt;<i> 
</I>
That deals with the cases where SNI matched. But the serverHello is
still not known yet, so the SubjectAtName is not known.

The terminate will happen on step2 if the SNI did not match. You need to
peek/stare again to move on to the cert details.

&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>

Why dont you try this:

  # splice whenever cdn.teads.tv is identified
  ssl_bump splice to_teads_tv_ssl

  # peek at both clientHello or serverHello data
  acl hello at_step SslBump1 SslBump2
  ssl_bump peek hello

  # otherwise terminate
  ssl_bump terminate all


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009308.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
	<LI>Next message (by thread): <A HREF="009356.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9335">[ date ]</a>
              <a href="thread.html#9335">[ thread ]</a>
              <a href="subject.html#9335">[ subject ]</a>
              <a href="author.html#9335">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
