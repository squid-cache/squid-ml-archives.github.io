<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump matching Subject Alternative Names
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20matching%20Subject%20Alternative%20Names&In-Reply-To=%3CD2F62C18.50633%25adam.cohen-rose%40sky.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009335.html">
   <LINK REL="Next"  HREF="009365.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump matching Subject Alternative Names</H1>
    <B>Cohen-Rose, Adam</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20matching%20Subject%20Alternative%20Names&In-Reply-To=%3CD2F62C18.50633%25adam.cohen-rose%40sky.uk%3E"
       TITLE="[squid-users] SSL Bump matching Subject Alternative Names">Adam.Cohen-Rose at sky.uk
       </A><BR>
    <I>Fri Feb 26 17:33:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009335.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
        <LI>Next message (by thread): <A HREF="009365.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9356">[ date ]</a>
              <a href="thread.html#9356">[ thread ]</a>
              <a href="subject.html#9356">[ subject ]</a>
              <a href="author.html#9356">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Amos, thanks so much for your help -- we're now seeing those requests get
through when they were just being dropped before.

We still have a couple of puzzles left...


Firstly, we're not seeing those cdn.teads.tv requests being marked as
spliced in our access log, despite including the %ssl::bump_mode
%ssl::&gt;sni fields in our logformat.

We do see some other whitelisted hosts in the access logs -- they appear
as a couple of lines, the first one saying &quot;...TAG_NONE:HIER_NONE peek
[hostname]&quot; and the second saying &quot;...TCP_TUNNEL:ORIGINAL_DST splice
[hostname]&quot;)

However, the cdn.teads.tv requests log the first of those lines (the
&quot;...TAG_NONE:HIER_NONE peek [hostname]&quot;) followed by a second peek log
line &quot;...TCP_TUNNEL:ORIGINAL_DST peek [hostname]&quot; but no splice (even
though the requests do appear to be spliced as we&#8217;re getting traffic!)

Also, should we expect to see the terminated requests being logged?


Secondly, we deal with a *lot* of traffic through our SSL bumping proxy
and we are finding that Squid is using a lot of memory -- often running
out and needing to be restarted!

We&#8217;re currently using multiple squid instances as per
<A HREF="http://wiki.squid-cache.org/MultipleInstances">http://wiki.squid-cache.org/MultipleInstances</A> to handle the traffic. Would
we be better using SMP Squid as per
<A HREF="http://wiki.squid-cache.org/Features/SmpScale">http://wiki.squid-cache.org/Features/SmpScale</A> ?

And what are some good ways to inspect or manage the squid instances&#8217;
memory usage? And what rough level of memory usage should we expect? All
our cacheing is turned off -- we&#8217;re just using squid as access control.


Thank you once again! Happy to help with more details of our config if
required.

Adam





On 25/02/2016 22:18, &quot;squid-users on behalf of Amos Jeffries&quot;
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A> on behalf of
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i>On 26/02/2016 12:38 a.m., Cohen-Rose, Adam wrote:
</I>&gt;&gt;<i> We&#185;re trying to use SSL bump to splice traffic from a CDN (cdn.teads.tv)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The CDN server certificate uses Subject Alternative Names in its
</I>&gt;&gt;<i> certificate to identify the cdn.teads.tv domain rather than the Common
</I>&gt;&gt;<i> Name (which is set to aka.proceau.net).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can we use SSL bump to splice requests to cdn.teads.tv or do we need to
</I>&gt;&gt;<i> use the CN domain to identify the CDN?
</I>&gt;<i>
</I>&gt;<i>Yes the ssl::server_name ACL type matches SubjectAltName in the server
</I>&gt;<i>certificate during *step 3* of the ssl_bump process.
</I>&gt;<i>
</I>&gt;<i>You first have to peek/stare at the serverHello data to get it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We&#185;d like to terminate other connections so our current SSL Bump config
</I>&gt;&gt;<i>is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl tcp_level at_step SslBump1
</I>&gt;&gt;<i> acl client_hello_peeked at_step SslBump2
</I>&gt;&gt;<i> ssl_bump peek tcp_level all
</I>&gt;<i>
</I>&gt;<i>NP: the &quot; all&quot; is meaningless.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl to_teads_tv_ssl ssl::server_name cdn.teads.tv
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump splice client_hello_peeked to_teads_tv_ssl
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>That deals with the cases where SNI matched. But the serverHello is
</I>&gt;<i>still not known yet, so the SubjectAtName is not known.
</I>&gt;<i>
</I>&gt;<i>The terminate will happen on step2 if the SNI did not match. You need to
</I>&gt;<i>peek/stare again to move on to the cert details.
</I>&gt;<i>
</I>&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Why dont you try this:
</I>&gt;<i>
</I>&gt;<i>  # splice whenever cdn.teads.tv is identified
</I>&gt;<i>  ssl_bump splice to_teads_tv_ssl
</I>&gt;<i>
</I>&gt;<i>  # peek at both clientHello or serverHello data
</I>&gt;<i>  acl hello at_step SslBump1 SslBump2
</I>&gt;<i>  ssl_bump peek hello
</I>&gt;<i>
</I>&gt;<i>  # otherwise terminate
</I>&gt;<i>  ssl_bump terminate all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Amos
</I>&gt;<i>_______________________________________________
</I>&gt;<i>squid-users mailing list
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i><A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
Information in this email including any attachments may be privileged, confidential and is intended exclusively for the addressee. The views expressed may not be official policy, but the personal views of the originator. If you have received it in error, please notify the sender by return e-mail and delete it from your system. You should not reproduce, distribute, store, retransmit, use or disclose its contents to anyone. Please note we reserve the right to monitor all e-mail communication through our internal and external networks. SKY and the SKY marks are trademarks of Sky plc and Sky International AG and are used under licence. Sky UK Limited (Registration No. 2906991), Sky-In-Home Service Limited (Registration No. 2067075) and Sky Subscribers Services Limited (Registration No. 2340150) are direct or indirect subsidiaries of Sky plc (Registration No. 2247735). All of the companies mentioned in this paragraph are incorporated in England and Wales and share the same registered office at Grant Way, Isleworth, Middlesex TW7 5QD.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009335.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
	<LI>Next message (by thread): <A HREF="009365.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9356">[ date ]</a>
              <a href="thread.html#9356">[ thread ]</a>
              <a href="subject.html#9356">[ subject ]</a>
              <a href="author.html#9356">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
