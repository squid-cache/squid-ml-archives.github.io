<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump matching Subject Alternative Names
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20matching%20Subject%20Alternative%20Names&In-Reply-To=%3C56D101CF.7030109%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009356.html">
   <LINK REL="Next"  HREF="009336.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump matching Subject Alternative Names</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20matching%20Subject%20Alternative%20Names&In-Reply-To=%3C56D101CF.7030109%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL Bump matching Subject Alternative Names">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Feb 27 01:54:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009356.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
        <LI>Next message (by thread): <A HREF="009336.html">[squid-users] HEAD over HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9365">[ date ]</a>
              <a href="thread.html#9365">[ thread ]</a>
              <a href="subject.html#9365">[ subject ]</a>
              <a href="author.html#9365">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/02/2016 6:33 a.m., Cohen-Rose, Adam wrote:
&gt;<i> Amos, thanks so much for your help -- we're now seeing those requests get
</I>&gt;<i> through when they were just being dropped before.
</I>&gt;<i> 
</I>&gt;<i> We still have a couple of puzzles left...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Firstly, we're not seeing those cdn.teads.tv requests being marked as
</I>&gt;<i> spliced in our access log, despite including the %ssl::bump_mode
</I>&gt;<i> %ssl::&gt;sni fields in our logformat.
</I>&gt;<i> 
</I>&gt;<i> We do see some other whitelisted hosts in the access logs -- they appear
</I>&gt;<i> as a couple of lines, the first one saying &quot;...TAG_NONE:HIER_NONE peek
</I>&gt;<i> [hostname]&quot; and the second saying &quot;...TCP_TUNNEL:ORIGINAL_DST splice
</I>&gt;<i> [hostname]&quot;)
</I>&gt;<i> 
</I>&gt;<i> However, the cdn.teads.tv requests log the first of those lines (the
</I>&gt;<i> &quot;...TAG_NONE:HIER_NONE peek [hostname]&quot;) followed by a second peek log
</I>&gt;<i> line &quot;...TCP_TUNNEL:ORIGINAL_DST peek [hostname]&quot; but no splice (even
</I>&gt;<i> though the requests do appear to be spliced as we&#8217;re getting traffic!)
</I>

I'm not sure about that one. Things only get logged on completion
though, so is it possible they are just very long active connections?


&gt;<i> 
</I>&gt;<i> Also, should we expect to see the terminated requests being logged?
</I>
IIRC terminated requests not being logged is an open bug.

&gt;<i> 
</I>&gt;<i> Secondly, we deal with a *lot* of traffic through our SSL bumping proxy
</I>&gt;<i> and we are finding that Squid is using a lot of memory -- often running
</I>&gt;<i> out and needing to be restarted!
</I>
There are some leaks being fixed right up to the latest release.
And OpenSSL has a tendency to attach things into sessions and contexts
which can cause a lot of memory. We are working to minimize that, but
its taking a while.

Looking at using flags=NO_DEFAULT_CA on your http(s)_port lines if you
have a Squid older than 4.0.4. Default CA use a lot of memory
per-session and are useless on client connections, usually on cache_peer
too but that latter varies.

&gt;<i> 
</I>&gt;<i> We&#8217;re currently using multiple squid instances as per
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/MultipleInstances">http://wiki.squid-cache.org/MultipleInstances</A> to handle the traffic. Would
</I>&gt;<i> we be better using SMP Squid as per
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/SmpScale">http://wiki.squid-cache.org/Features/SmpScale</A> ?
</I>&gt;<i> 
</I>
Either or both. They each have different benefits, which may or may not
be a priority for you.


&gt;<i> And what are some good ways to inspect or manage the squid instances&#8217;
</I>&gt;<i> memory usage? And what rough level of memory usage should we expect? All
</I>&gt;<i> our cacheing is turned off -- we&#8217;re just using squid as access control.
</I>
SNMP reports querying both squid and the machine itself are good. The
squid cachemgr 'mem' report is a good snapshot for spot checking whats
causing teh most usage if you know there is a problem already.



&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you once again! Happy to help with more details of our config if
</I>&gt;<i> required.
</I>&gt;<i> 
</I>&gt;<i> Adam
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 25/02/2016 22:18, &quot;squid-users on behalf of Amos Jeffries&quot;
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A> on behalf of
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 26/02/2016 12:38 a.m., Cohen-Rose, Adam wrote:
</I>&gt;&gt;&gt;<i> We&#185;re trying to use SSL bump to splice traffic from a CDN (cdn.teads.tv)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The CDN server certificate uses Subject Alternative Names in its
</I>&gt;&gt;&gt;<i> certificate to identify the cdn.teads.tv domain rather than the Common
</I>&gt;&gt;&gt;<i> Name (which is set to aka.proceau.net).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can we use SSL bump to splice requests to cdn.teads.tv or do we need to
</I>&gt;&gt;&gt;<i> use the CN domain to identify the CDN?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes the ssl::server_name ACL type matches SubjectAltName in the server
</I>&gt;&gt;<i> certificate during *step 3* of the ssl_bump process.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You first have to peek/stare at the serverHello data to get it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We&#185;d like to terminate other connections so our current SSL Bump config
</I>&gt;&gt;&gt;<i> is:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl tcp_level at_step SslBump1
</I>&gt;&gt;&gt;<i> acl client_hello_peeked at_step SslBump2
</I>&gt;&gt;&gt;<i> ssl_bump peek tcp_level all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: the &quot; all&quot; is meaningless.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl to_teads_tv_ssl ssl::server_name cdn.teads.tv
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump splice client_hello_peeked to_teads_tv_ssl
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That deals with the cases where SNI matched. But the serverHello is
</I>&gt;&gt;<i> still not known yet, so the SubjectAtName is not known.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The terminate will happen on step2 if the SNI did not match. You need to
</I>&gt;&gt;<i> peek/stare again to move on to the cert details.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why dont you try this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  # splice whenever cdn.teads.tv is identified
</I>&gt;&gt;<i>  ssl_bump splice to_teads_tv_ssl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  # peek at both clientHello or serverHello data
</I>&gt;&gt;<i>  acl hello at_step SslBump1 SslBump2
</I>&gt;&gt;<i>  ssl_bump peek hello
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  # otherwise terminate
</I>&gt;&gt;<i>  ssl_bump terminate all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> Information in this email including any attachments may be privileged, confidential and is intended exclusively for the addressee. The views expressed may not be official policy, but the personal views of the originator. If you have received it in error, please notify the sender by return e-mail and delete it from your system. You should not reproduce, distribute, store, retransmit, use or disclose its contents to anyone. Please note we reserve the right to monitor all e-mail communication through our internal and external networks. SKY and the SKY marks are trademarks of Sky plc and Sky International AG and are used under licence. Sky UK Limited (Registration No. 2906991), Sky-In-Home Service Limited (Registration No. 2067075) and Sky Subscribers Services Limited (Registration No. 2340150) are direct or indirect subsidiaries of Sky plc (Registration No. 2247735). All of the companies mentioned in this paragraph are incorporated in England and Wales and share the same registered o
</I>ffice at Grant Way, Isleworth, Middlesex TW7 5QD.
&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009356.html">[squid-users] SSL Bump matching Subject Alternative Names
</A></li>
	<LI>Next message (by thread): <A HREF="009336.html">[squid-users] HEAD over HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9365">[ date ]</a>
              <a href="thread.html#9365">[ thread ]</a>
              <a href="subject.html#9365">[ subject ]</a>
              <a href="author.html#9365">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
