<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to prevent caching of request or configure smart handling?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20prevent%20caching%20of%20request%20or%20configure%0A%20smart%20handling%3F&In-Reply-To=%3C56D39A33.2070504%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009405.html">
   <LINK REL="Next"  HREF="009414.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to prevent caching of request or configure smart handling?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20prevent%20caching%20of%20request%20or%20configure%0A%20smart%20handling%3F&In-Reply-To=%3C56D39A33.2070504%40treenet.co.nz%3E"
       TITLE="[squid-users] How to prevent caching of request or configure smart handling?">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Feb 29 01:09:07 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009405.html">[squid-users] How to prevent caching of request or configure smart handling?
</A></li>
        <LI>Next message (by thread): <A HREF="009414.html">[squid-users] Squid proxy return gzip responses when I don't include Accept-Encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9409">[ date ]</a>
              <a href="thread.html#9409">[ thread ]</a>
              <a href="subject.html#9409">[ subject ]</a>
              <a href="author.html#9409">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/02/2016 9:46 a.m., Karl-Philipp Richter wrote:
&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> 
</I>&lt;sip&gt;

&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>
&lt;snip&gt;
&gt;<i> acl git_ports port 9418         # git protocol
</I>
Combine these two by addng port 9418 into SSL_ports ACL.

&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access allow CONNECT git_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow CONNECT git_ports
</I>
 ... then you can remove these duplicated &quot;allow CONNECT git_ports&quot; lines.

&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ## Service configuration
</I>&gt;<i> http_port 192.168.178.20:3128 intercept
</I>&gt;<i> 
</I>&gt;<i> https_port 192.168.178.20:3130 intercept ssl-bump cert=/etc/squid3/ssl_cert/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> # sslproxy_capath /etc/ssl/certs # obsolete in 4.0.1
</I>&gt;<i> 
</I>&gt;<i> #sslproxy_cafile /usr/local/openssl/cabundle.file # unclear where it is in package manager installation
</I>&gt;<i> 
</I>&gt;<i> # insecure -&gt; use for debugging only
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> # sslproxy_flags DONT_VERIFY_PEER # obsolete in 4.0.1
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cache_dir ufs /var/squid/cache 100 16 256
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/squid/cache
</I>&gt;<i> 
</I>&gt;<i> #refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> #refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 10080 90% 43200
</I>&gt;<i> refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 432000 99% 4320000
</I>&gt;<i> refresh_pattern -i \.(deb|rpm|exe|zip|tar|tgz|tar\.gz|txz|tar\.xz|ram|rar|bin|ppt|doc|tiff|gz|git)$ 100800 99% 432000 store-stale
</I>
You are missing the .bz2 and .xz extensions. Then you can remove the
tar.gz and tar.xz entries.

And if RAR are really that popular you will want to add  r[0-9][0-9]
extensions as well.

And stuffing a query string on the URL is also common so for all of the
file extension lines you will want to replace the &quot;$&quot; at the end with
this:   (\?.*)?$


Remove this line:

&gt;<i> refresh_pattern -i .* 100800 99% 432000 store-stale
</I>
 ... it is unsafe and clobbers the finely tuned protocol behaviour
initiated by the below defaults.

Instead adjust the pct and max values of the '.' pattern rule below
(leaving the min as 0), and add store-stale to it as well.

&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> ftp_port 192.168.178.20:3129
</I>&gt;<i> 
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> 
</I>&gt;<i> access_log /usr/local/squid/var/log/access.log
</I>&gt;<i> cache_store_log /usr/local/squid/var/log/cache_store.log
</I>&gt;<i> cache_log /usr/local/squid/var/log/cache.log
</I>
You should not need store.log. Unless you have some tool specially
needing it, you can remove the above line completely and gain a bit of
performance.

The other logs look like the default paths for Squid. If that is right
you can remove them from your config file Squid will still log there.

&gt;<i> 
</I>&gt;<i> pid_filename /usr/local/squid/var/run/squid.pid
</I>&gt;<i> 
</I>
Likewise, the .pid file location should not need to be explicit. Try
removing.

&gt;<i> 
</I>&gt;<i> ## Cache access
</I>&gt;<i> acl domain_all dstdom_regex -i .*
</I>&gt;<i> cache allow domain_all
</I>&gt;<i> 
</I>&gt;<i> # avoid caching of results from IP lookup services (unclear why they're cached
</I>&gt;<i> # anyway, i.e. whether squid configuration of HTTP reply is badly configured)
</I>&gt;<i> acl ip_services dstdomain &quot;/etc/squid3/no-cache.acl&quot;
</I>&gt;<i> cache deny ip_services
</I>
To answer the implied question. This is probably a side effect of the
unusual &quot;.*&quot; refresh pattern and/or the domain_all ACL used.

Try removing all of the above &quot;cache&quot; lines. If you still need to deny
these after fixing the refresh_patterns, then add back only the
p_services rule with ACL entries relevant to the new situation.

&gt;<i> 
</I>&gt;<i> always_direct  allow ip_services
</I>&gt;<i> 
</I>
Okay, remove the always_direct line. You are not using cache_peer's.

&gt;<i> 
</I>&gt;<i> ## Cache storage
</I>&gt;<i> maximum_object_size 20 GB
</I>&gt;<i> maximum_object_size_in_memory 20 MB
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ## Others
</I>&gt;<i> range_offset_limit -1
</I>&gt;<i> 
</I>&gt;<i> dns_v4_first on
</I>
See if you can remove the above. A properly working network does not
need it. If issues appear when its not used, then they *need* to be
fixed. Regular attempts should be tried anyway even if you find you have
to add it back in for a while.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009405.html">[squid-users] How to prevent caching of request or configure smart handling?
</A></li>
	<LI>Next message (by thread): <A HREF="009414.html">[squid-users] Squid proxy return gzip responses when I don't include Accept-Encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9409">[ date ]</a>
              <a href="thread.html#9409">[ thread ]</a>
              <a href="subject.html#9409">[ subject ]</a>
              <a href="author.html#9409">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
