<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Delay Pools or Traffic Shaping per port?!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay%20Pools%20or%20Traffic%20Shaping%20per%20port%3F%21&In-Reply-To=%3C568B1885.6010403%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008558.html">
   <LINK REL="Next"  HREF="008546.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Delay Pools or Traffic Shaping per port?!</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay%20Pools%20or%20Traffic%20Shaping%20per%20port%3F%21&In-Reply-To=%3C568B1885.6010403%40treenet.co.nz%3E"
       TITLE="[squid-users] Delay Pools or Traffic Shaping per port?!">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan  5 01:12:37 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008558.html">[squid-users] Delay Pools or Traffic Shaping per port?!
</A></li>
        <LI>Next message (by thread): <A HREF="008546.html">[squid-users] Question about redirect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8568">[ date ]</a>
              <a href="thread.html#8568">[ thread ]</a>
              <a href="subject.html#8568">[ subject ]</a>
              <a href="author.html#8568">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/01/2016 1:41 a.m., Christian Kunkel wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Am 04.01.2016 um 12:46 schrieb Amos Jeffries:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid is limited to 64 listening ports. That can be extended a little in
</I>&gt;&gt;<i> exchange for reducing Squid operating speed, but 200-500 is going very
</I>&gt;&gt;<i> far. This will cause problems with your stated goal of handling Gbps,
</I>&gt;&gt;<i> Squid will need some fine tuning to get near that speed as it is.
</I>&gt;<i> 
</I>&gt;<i> ok. so actually i can run 3 or 4 instances of squid to acomplish my goal of 200 users? lets say the server needs to handle that amount of users and not squid. this would work i guess?
</I>&gt;<i> 
</I>
Possibly 2 will be needed to hit 1Gbps. And yes, HTTP is stateless
protocol - as load increases you just add more proxies to handle it. But
that is related to the bps speed, not the number of users. Squid is
limited most by the time it takes to parse and process the HTTP messages.

One Squid can handle many thousands of *users* - when the users are
doing the normal low-ish request rates. Or max out your bandwidth by a
single user doing many thousands of requests.


&gt;&gt;&gt;&gt;<i> Is there any reason you can't use authentication to identify different users?
</I>&gt;&gt;&gt;<i> it does not work with nated ips.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Authentication does.
</I>&gt;<i> 
</I>&gt;<i> ok. but i can not use authetication. the main os which will be used to connect to squid can not handle http auth headers. no arp and so on. or lets say it this way: no way to get something unique out of the os to autheticate or authorize on. only thing is used are ports. every user gets a unique port to work with. after login through captive this port is redirected to squid. that ports is actually opened for everyone for 48h. after that time user will see captive to login again. lets say: thats not the best way but the best way i could come up with to do something like authetication. maybe there is a better way but i did not find something to make it better.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> it autheticates with ip adress anyway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is *not* Authentication. That is IP based authorization (access
</I>&gt;&gt;<i> control).
</I>&gt;<i> 
</I>&gt;<i> explained above.
</I>
What you explained was *not* authentication, and the reasons given are
not relevant to authentication. Which is a good sign that you do not
understand authentication in HTTP.

That is a clear that you are not going to be able to have it any time
soon with your current level of understanding, whether its possible or
not. So I will continue

&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> so it will limit the ip to 10mbit but behind that ip there are maybe 10 or more ppl.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> With authentication each of these &quot;ppl&quot; has different credentials and
</I>&gt;&gt;<i> messages using those credentials are used to count the bandwidth shaping
</I>&gt;&gt;<i> towards each user.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If your system defines a &quot;user&quot; as being one IP address. Then the IP
</I>&gt;&gt;<i> address is what the traffic needs to be accounted against.
</I>&gt;<i> 
</I>&gt;<i> main problem of NATed users (in my case): their ip adresses changes from time to time or based on their location. so if ip is used for authorization then a big amount gets ahthorized or they need to relogin constantly. not that nice.
</I>
With your current setup you are not going to be able to resolve that
problem, or the one about multiple users behind each IP. It is simply
not possible so long as your tie the IP:port details into the definition
of &quot;user&quot; at the captive portal.

Which is why Anthony and I are making such a fuss about checking whether
you can do proper HTTP authentication. Since that has nothing to do with
NAT, IP, port or any of the problematic TCP layer juggling you are doing
in the portal.

&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> What stops users &quot;investigating&quot; the system, and finding out they can get extra 
</I>&gt;&gt;&gt;&gt;<i> bandwidth by using ports which haven't been assigned to them?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> thats the second problem to deal with. there is some kind of a captive portal with login but it opens the port after user autheticates so actually someone else can use that port. so if you have an idea. i would be really thankful :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FYI: the only thing that Squid can do that OS level QoS controls cannot
</I>&gt;&gt;<i> easily do is base its shaping on HTTP message header values (ie the
</I>&gt;&gt;<i> users proxy-auth credentials).
</I>&gt;<i> 
</I>&gt;<i> the os does not really save those credentials. every http request then asks for the credentials. thats to messed up this way.
</I>
HTTP is a stateless and multiplexed protocol. Each request is designed
to be a standalone description of how to fetch its reply.

&gt;&gt;<i>
</I>&gt;&gt;<i> Since you want to do this shaping &quot;per-user&quot; without authentication
</I>&gt;&gt;<i> credentials to correctly identify what a single &quot;user&quot; actually is and
</I>&gt;&gt;<i> are instead basing the definition of &quot;user&quot; as stuff coming from an IP
</I>&gt;&gt;<i> address (that IP based authorization) - then OS level QoS controls
</I>&gt;&gt;<i> shaping the traffic based on IP address is the best you are going to
</I>&gt;&gt;<i> get. Despite the NAT related issues.
</I>&gt;<i> 
</I>&gt;<i> see above for ports as unique definition of a user.
</I>
Which as you repeatedly have said is not providing you with the unique
portion of the requirement - leaving multiple users behind each IP
and/or ports being re-used by different users.


Now, as to solving your problem:
 I think the best you are going to achieve is to create an external ACL
helper script that receives the client connection IP:port numbers from
Squid, queries the captive portal software and receives a unique tag (or
user= label) assigned for that port, then supplies Squid with the user
name label (almost) as if it had been sent in the HTTP headers.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008558.html">[squid-users] Delay Pools or Traffic Shaping per port?!
</A></li>
	<LI>Next message (by thread): <A HREF="008546.html">[squid-users] Question about redirect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8568">[ date ]</a>
              <a href="thread.html#8568">[ thread ]</a>
              <a href="subject.html#8568">[ subject ]</a>
              <a href="author.html#8568">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
