<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] kerberos authentication with a machine account	doesn't work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerberos%20authentication%20with%20a%20machine%20account%0A%09doesn%27t%20work&In-Reply-To=%3C20160107042324.GE11718%40baea.com.au%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008611.html">
   <LINK REL="Next"  HREF="008616.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] kerberos authentication with a machine account	doesn't work</H1>
    <B>LYMN</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerberos%20authentication%20with%20a%20machine%20account%0A%09doesn%27t%20work&In-Reply-To=%3C20160107042324.GE11718%40baea.com.au%3E"
       TITLE="[squid-users] kerberos authentication with a machine account	doesn't work">brett.lymn at baesystems.com
       </A><BR>
    <I>Thu Jan  7 04:23:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008611.html">[squid-users] NAT/TPROXY lookup failed to locate original IPs
</A></li>
        <LI>Next message (by thread): <A HREF="008616.html">[squid-users] kerberos authentication with a machine account doesn't work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8615">[ date ]</a>
              <a href="thread.html#8615">[ thread ]</a>
              <a href="subject.html#8615">[ subject ]</a>
              <a href="author.html#8615">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi,

We have been using kerberos authentication against Active Directory here
for a long time by using a SPN attached to a user account and exporting
the keytab.  The issue we have is that security policy mandates that
the password on the user account be changed which means we have to go
and regenerate keytabs every time this happens.  Not exactly difficult
but tedious nonetheless.

To avoid the password change I thought it may be an idea to use the
machine account and add a SPN (http/fqdn.is.here) to that.  I added:

        kerberos method = secrets and keytab
        dedicated keytab file = /etc/krb5.keytab

to the smb.conf so samba will manage the keytab for me then did:

net ads join
net ads keytab add http

klist -k shows me the principals that should be there and AD agrees they
exist.  I can get a TGT using:

kinit -k

without error (setting the UPN to host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fqdn.is.here at KERBEROS.REALM</A> may
have helped this).  Doing a 

kinit -kS http/fqdn.is.here

works without error too.  So, I think kerberos is ok but with a squid
3.5.12 configured with negotiate_kerberos_auth I see the dreaded
message:

negotiate_kerberos_auth.cc(180): pid=4888 :2016/01/07 12:50:29| negotiate_kerberos_auth: ERROR: gss_accept_sec_context() failed: Unspecified GSS failure.  Minor code may provide more information. 

and only that, no minor code when I try to use the proxy with a browser
on a windows client.  Interestingly, doing a klist on the windows client
I can see a kerberos ticket for HTTP/fqdn.is.here that is for the proxy
I am testing.

Not sure what is missing here, I have a bee in my bonnet that this should
Just Work (tm) as the only real difference is that the SPN is attached
to a computer account not a user account - I would have thought as long
as the keytab is done correctly that this should not matter but clearly
something is not agreeing with me.

-- 
Brett Lymn
This email has been sent on behalf of one of the following companies within the BAE Systems Australia group of companies:

    BAE Systems Australia Limited - Australian Company Number 008 423 005
    BAE Systems Australia Defence Pty Limited - Australian Company Number 006 870 846
    BAE Systems Australia Logistics Pty Limited - Australian Company Number 086 228 864

Our registered office is Evans Building, Taranaki Road, Edinburgh Parks,
Edinburgh, South Australia, 5111. If the identity of the sending company is
not clear from the content of this email please contact the sender.

This email and any attachments may contain confidential and legally
privileged information.  If you are not the intended recipient, do not copy or
disclose its content, but please reply to this email immediately and highlight
the error to the sender and then immediately delete the message.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008611.html">[squid-users] NAT/TPROXY lookup failed to locate original IPs
</A></li>
	<LI>Next message (by thread): <A HREF="008616.html">[squid-users] kerberos authentication with a machine account doesn't work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8615">[ date ]</a>
              <a href="thread.html#8615">[ thread ]</a>
              <a href="subject.html#8615">[ subject ]</a>
              <a href="author.html#8615">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
