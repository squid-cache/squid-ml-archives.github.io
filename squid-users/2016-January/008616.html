<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] kerberos authentication with a machine account doesn't work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerberos%20authentication%20with%20a%20machine%20account%0A%20doesn%27t%20work&In-Reply-To=%3Cvmime.568e23da.2316.4f425ef6e68687a%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008615.html">
   <LINK REL="Next"  HREF="008665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] kerberos authentication with a machine account doesn't work</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerberos%20authentication%20with%20a%20machine%20account%0A%20doesn%27t%20work&In-Reply-To=%3Cvmime.568e23da.2316.4f425ef6e68687a%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] kerberos authentication with a machine account doesn't work">belle at bazuin.nl
       </A><BR>
    <I>Thu Jan  7 08:37:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008615.html">[squid-users] kerberos authentication with a machine account	doesn't work
</A></li>
        <LI>Next message (by thread): <A HREF="008665.html">[squid-users] kerberos authentication with a machine account	doesn't work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8616">[ date ]</a>
              <a href="thread.html#8616">[ thread ]</a>
              <a href="subject.html#8616">[ subject ]</a>
              <a href="author.html#8616">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai, 

&#160;

First whats your OS/squid and samba version, handy to know. 

And post your smb.conf please. 

&#160;

Few things to check. 

/etc/krb5.keytab should have rights 600 (root:root) 

Run : klist -e -k /etc/krb5.keytab&#160; post the output.

&#160;

Your SPN for squid must be HTTP/fqdn 

And not http/fqdn CAPS do matter here. 

&#160;

Put the HTTP/fqdn spn in a separated file and put it in the squid dir. 

Chown and chmod it root:squid-user 440 

&#160;

Add it in your squid init script ( for debian i added it in /etc/default/squid&#160; ( squid for 3.5.12 ) (squid3 for 3.4.8 )

KRB5_KTNAME=/etc/squid/keytab.PROXY1-HTTP

export KRB5_KTNAME

&#160;

&#160;

The squid keytab should be like (manualy added on a different user in the AD, special user for squid services.):

KVNO Principal

---- -----------------------------------------------------------------------

&#160;&#160; 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (des-cbc-crc)

&#160;&#160; 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (des-cbc-md5)

&#160;&#160; 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (arcfour-hmac)

&#160;

This is my default ( /etc/krb5.keytab ) (from the join of samba.) 

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (des-cbc-crc)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (des-cbc-md5)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (aes128-cts-hmac-sha1-96)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (aes256-cts-hmac-sha1-96)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> (arcfour-hmac)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host at YOUR_REALM</A> (des-cbc-crc)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host at YOUR_REALM</A> (des-cbc-md5)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host at YOUR_REALM</A> (aes128-cts-hmac-sha1-96)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host at YOUR_REALM</A> (aes256-cts-hmac-sha1-96)

&#160;&#160; 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">host at YOUR_REALM</A> (arcfour-hmac)

&#160;&#160; 1 HOST$@YOUR_REALM (des-cbc-crc)

&#160;&#160; 1 HOST$@YOUR_REALM (des-cbc-md5)

&#160;&#160; 1 HOST$@YOUR_REALM (aes128-cts-hmac-sha1-96)

&#160;&#160; 1 HOST$@YOUR_REALM (aes256-cts-hmac-sha1-96)

&#160;&#160; 1 HOST$@YOUR_REALM (arcfour-hmac)

&#160;

&#160;

The needed krb5.conf

cat /etc/krb5.conf

[libdefaults]

&#160;&#160;&#160; default_realm = YOUR_REALM

&#160;&#160;&#160; dns_lookup_kdc = true

&#160;&#160;&#160; dns_lookup_realm = false

&#160;&#160;&#160; ticket_lifetime = 24h

&#160;&#160;&#160; ccache_type = 4

&#160;&#160;&#160; forwardable = true

&#160;&#160;&#160; proxiable = true

&#160;

&#160;

install ntp and point it to you AD so time is always in sync. 

&#160;

Now you have 2 options to setup and you choose&#160; based on you SPN setup. 

Seperated keytab for squid HTTP service. 

Use: 

auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth -d \

&#160;&#160;&#160; --kerberos /usr/lib/squid/negotiate_kerberos_auth -s HTTP/ <A HREF="https://lists.squid-cache.org/listinfo/squid-users">host.internal.domain.tld at YOUR_REALM</A> \

&#160;&#160;&#160; --ntlm /usr/bin/ntlm_auth --helper-protocol=gss-spnego --domain=NTDOMAIN

&#160;

Or with everyting in one keytab file and make sure squid can read this keytab file 640 root:squid !! :&#160; 

auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth \

&#160;&#160;&#160; --kerberos /usr/lib/squid/negotiate_kerberos_auth -s GSS_C_NO_NAME -d \

&#160;&#160;&#160; --ntlm /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --domain=NTDOMAIN

&#160;

I have a setup with a separated keytab file, i tested above and these work. 

( tested on debian jessie, samba 4.1, squid 3.4.8, 3.5.10 and 3.5.12. ) 

&#160;

Above i told about how i did setup. 

A big advantave with the squid-service user. You kan add all you squid hosts/services in that user.

I have 1 user for this and 3 proxy servers. 

&#160;

So where did you go wrong. 

&gt;<i> net ads keytab add HTTP
</I>
And rights on the /etc/krb5.keytab file are the first things to check. 

&#160;

Optionaly, start the auth progrom on command line, with the debugging enabled. 

&#160;

Greetz, 

&#160;

Louis

&#160;

&#160;

&#160;

&gt;<i> -----Oorspronkelijk bericht-----
</I>
&gt;<i> Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens
</I>
&gt;<i> LYMN
</I>
&gt;<i> Verzonden: donderdag 7 januari 2016 5:23
</I>
&gt;<i> Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>
</I>
&gt;<i> Onderwerp: [squid-users] kerberos authentication with a machine account
</I>
&gt;<i> doesn't work
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> Hi,
</I>
&gt;<i> 
</I>
&gt;<i> We have been using kerberos authentication against Active Directory here
</I>
&gt;<i> for a long time by using a SPN attached to a user account and exporting
</I>
&gt;<i> the keytab.&#160; The issue we have is that security policy mandates that
</I>
&gt;<i> the password on the user account be changed which means we have to go
</I>
&gt;<i> and regenerate keytabs every time this happens.&#160; Not exactly difficult
</I>
&gt;<i> but tedious nonetheless.
</I>
&gt;<i> 
</I>
&gt;<i> To avoid the password change I thought it may be an idea to use the
</I>
&gt;<i> machine account and add a SPN (http/fqdn.is.here) to that.&#160; I added:
</I>
&gt;<i> 
</I>
&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;kerberos method = secrets and keytab
</I>
&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;dedicated keytab file = /etc/krb5.keytab
</I>
&gt;<i> 
</I>
&gt;<i> to the smb.conf so samba will manage the keytab for me then did:
</I>
&gt;<i> 
</I>
&gt;<i> net ads join
</I>
&gt;<i> net ads keytab add http
</I>
&gt;<i> 
</I>
&gt;<i> klist -k shows me the principals that should be there and AD agrees they
</I>
&gt;<i> exist.&#160; I can get a TGT using:
</I>
&gt;<i> 
</I>
&gt;<i> kinit -k
</I>
&gt;<i> 
</I>
&gt;<i> without error (setting the UPN to host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fqdn.is.here at KERBEROS.REALM</A> may
</I>
&gt;<i> have helped this).&#160; Doing a
</I>
&gt;<i> 
</I>
&gt;<i> kinit -kS http/fqdn.is.here
</I>
&gt;<i> 
</I>
&gt;<i> works without error too.&#160; So, I think kerberos is ok but with a squid
</I>
&gt;<i> 3.5.12 configured with negotiate_kerberos_auth I see the dreaded
</I>
&gt;<i> message:
</I>
&gt;<i> 
</I>
&gt;<i> negotiate_kerberos_auth.cc(180): pid=4888 :2016/01/07 12:50:29|
</I>
&gt;<i> negotiate_kerberos_auth: ERROR: gss_accept_sec_context() failed:
</I>
&gt;<i> Unspecified GSS failure.&#160; Minor code may provide more information.
</I>
&gt;<i> 
</I>
&gt;<i> and only that, no minor code when I try to use the proxy with a browser
</I>
&gt;<i> on a windows client.&#160; Interestingly, doing a klist on the windows client
</I>
&gt;<i> I can see a kerberos ticket for HTTP/fqdn.is.here that is for the proxy
</I>
&gt;<i> I am testing.
</I>
&gt;<i> 
</I>
&gt;<i> Not sure what is missing here, I have a bee in my bonnet that this should
</I>
&gt;<i> Just Work (tm) as the only real difference is that the SPN is attached
</I>
&gt;<i> to a computer account not a user account - I would have thought as long
</I>
&gt;<i> as the keytab is done correctly that this should not matter but clearly
</I>
&gt;<i> something is not agreeing with me.
</I>
&gt;<i> 
</I>
&gt;<i> --
</I>
&gt;<i> Brett Lymn
</I>
&gt;<i> This email has been sent on behalf of one of the following companies
</I>
&gt;<i> within the BAE Systems Australia group of companies:
</I>
&gt;<i> 
</I>
&gt;<i> &#160;&#160;&#160;&#160;BAE Systems Australia Limited - Australian Company Number 008 423 005
</I>
&gt;<i> &#160;&#160;&#160;&#160;BAE Systems Australia Defence Pty Limited - Australian Company Number
</I>
&gt;<i> 006 870 846
</I>
&gt;<i> &#160;&#160;&#160;&#160;BAE Systems Australia Logistics Pty Limited - Australian Company
</I>
&gt;<i> Number 086 228 864
</I>
&gt;<i> 
</I>
&gt;<i> Our registered office is Evans Building, Taranaki Road, Edinburgh Parks,
</I>
&gt;<i> Edinburgh, South Australia, 5111. If the identity of the sending company
</I>
&gt;<i> is
</I>
&gt;<i> not clear from the content of this email please contact the sender.
</I>
&gt;<i> 
</I>
&gt;<i> This email and any attachments may contain confidential and legally
</I>
&gt;<i> privileged information.&#160; If you are not the intended recipient, do not
</I>
&gt;<i> copy or
</I>
&gt;<i> disclose its content, but please reply to this email immediately and
</I>
&gt;<i> highlight
</I>
&gt;<i> the error to the sender and then immediately delete the message.
</I>
&gt;<i> 
</I>
&gt;<i> _______________________________________________
</I>
&gt;<i> squid-users mailing list
</I>
&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>
&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160107/14d4e968/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160107/14d4e968/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008615.html">[squid-users] kerberos authentication with a machine account	doesn't work
</A></li>
	<LI>Next message (by thread): <A HREF="008665.html">[squid-users] kerberos authentication with a machine account	doesn't work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8616">[ date ]</a>
              <a href="thread.html#8616">[ thread ]</a>
              <a href="subject.html#8616">[ subject ]</a>
              <a href="author.html#8616">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
