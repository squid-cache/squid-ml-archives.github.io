<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] kerberos authentication with a machine account	doesn't work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerberos%20authentication%20with%20a%20machine%20account%0A%09doesn%27t%20work&In-Reply-To=%3C20160111014830.GD17928%40baea.com.au%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008616.html">
   <LINK REL="Next"  HREF="008667.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] kerberos authentication with a machine account	doesn't work</H1>
    <B>LYMN</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerberos%20authentication%20with%20a%20machine%20account%0A%09doesn%27t%20work&In-Reply-To=%3C20160111014830.GD17928%40baea.com.au%3E"
       TITLE="[squid-users] kerberos authentication with a machine account	doesn't work">brett.lymn at baesystems.com
       </A><BR>
    <I>Mon Jan 11 01:48:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008616.html">[squid-users] kerberos authentication with a machine account doesn't work
</A></li>
        <LI>Next message (by thread): <A HREF="008667.html">[squid-users] kerberos authentication with a machine account doesn't work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8665">[ date ]</a>
              <a href="thread.html#8665">[ thread ]</a>
              <a href="subject.html#8665">[ subject ]</a>
              <a href="author.html#8665">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Firstly, let me say that whatever you are using for a mail client makes
reading/replying to your message difficult (see below for a small
sample, I will clean up the rest as best I can)...

I did manage to get this working, you did mention the correct solution
right down the end of your message.

On Thu, Jan 07, 2016 at 09:37:46AM +0100, L.P.H. van Belle wrote:
&gt;<i> Hai, 
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>

Just in case it doesn't show - you have a lot of control-M characters
through your message.

&gt;<i> First whats your OS/squid and samba version, handy to know. 
</I>&gt;<i> 
</I>
I did mention squid as being 3.5.12, OS is RHEL 6.7, samba was the
built in RHEL version, 3.6.23.

&gt;<i> And post your smb.conf please. 
</I>&gt;<i> 
</I>
Well, just for posterity.

[global]
        workgroup = AU
        server string = %h
        netbios name = %h
        pid directory = /var/run
        lock directory = /var/cache/samba
        log file = /var/log/samba/%m.log

        security = user
        passdb backend = tdbsam
        security = ADS
        client use spnego = yes

        realm = AU.BAESYSTEMS.COM
        server signing = auto
        domain master = no

        dns proxy = no

        kerberos method = secrets and keytab
        dedicated keytab file = /etc/krb5.keytab


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Few things to check. 
</I>&gt;<i> 
</I>&gt;<i> /etc/krb5.keytab should have rights 600 (root:root) 
</I>&gt;<i> 
</I>
And this was the problem but it should not, in my case, be as you
stated. In fact, /etc/krb5.keytab needed to have rights 640 with
ownership root:nobody.  This is because the kerberos authenticator runs
as the user nobody and needs access to the keytab.  I am not so sure I
like this situation because this does mean the nobody user now has
access to the machine kerberos keys not just the ones for the http SPN.

&gt;<i> Run : klist -e -k /etc/krb5.keytab&#160; post the output.
</I>&gt;<i> 
</I>
I won't do this for brevity - the principals and encryption types were
fine.  I had already checked this as I stated in my original post.

&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Your SPN for squid must be HTTP/fqdn 
</I>&gt;<i> 
</I>&gt;<i> And not http/fqdn CAPS do matter here. 
</I>&gt;<i> 
</I>
windows doesn't care, lower case actually worked fine for me in the end.
If you do a kinit on the linux command line then you must match the case
in the keytab.

&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Put the HTTP/fqdn spn in a separated file and put it in the squid dir. 
</I>&gt;<i> 
</I>&gt;<i> Chown and chmod it root:squid-user 440 
</I>&gt;<i> 
</I>
If you do this then when/if the machine account password changes then
the SPN will be invalidated.  Also you assume that the kerberos
authenticator is being run as a user in the group squid-user which is
not always the case.

&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Add it in your squid init script ( for debian i added it in /etc/default/squid&#160; ( squid for 3.5.12 ) (squid3 for 3.4.8 )
</I>&gt;<i> 
</I>&gt;<i> KRB5_KTNAME=/etc/squid/keytab.PROXY1-HTTP
</I>&gt;<i> 
</I>&gt;<i> export KRB5_KTNAME
</I>&gt;<i> 
</I>
For RHEL that is /etc/sysconfig/squid.

&gt;<i> 
</I>&gt;<i> The squid keytab should be like (manualy added on a different user in the AD, special user for squid services.):
</I>&gt;<i> 
</I>
This is how we currently run.  Security policies require the user
account password to be changed regularly.  This means a disruption to
the squid services while we change the password, export the keytab and
merge the entries into the proxy server keytab.

&gt;<i> 
</I>&gt;<i> install ntp and point it to you AD so time is always in sync. 
</I>&gt;<i> 
</I>
Yes, time sync is important but pointing ntp at AD won't work properly.
The inital ntpdate will work but the ongoing sync does not - AD doesn't
do ntp.  Much better if you sync AD time to a proper ntpd (unix/linux)

&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Or with everyting in one keytab file and make sure squid can read this keytab file 640 root:squid !! :&#160; 
</I>&gt;<i> 
</I>
Yes, this is what I did eventually though mine was root:nobody.

&gt;<i> 
</I>&gt;<i> I have a setup with a separated keytab file, i tested above and these work. 
</I>&gt;<i> 
</I>&gt;<i> ( tested on debian jessie, samba 4.1, squid 3.4.8, 3.5.10 and 3.5.12. ) 
</I>&gt;<i> 
</I>
Yes, we have had a separate keytab file working for a long time on rhel
with samba3 and our custom squid rpms.  I wanted to avoid having to
manage a separate AD user.

&gt;<i> &#160;
</I>&gt;<i> A big advantave with the squid-service user. You kan add all you squid hosts/services in that user.
</I>&gt;<i> 
</I>&gt;<i> I have 1 user for this and 3 proxy servers. 
</I>&gt;<i> 
</I>
It does mean that one password change invalidates the keytab on 3
proxies...

&gt;<i> 
</I>&gt;<i> Optionaly, start the auth progrom on command line, with the debugging enabled. 
</I>&gt;<i> 
</I>
Yes, that wasn't terribly usful in this case though and running
negotiate_kerberos_auth_test as root and actually getting tickets was
downright confusing.

-- 
Brett Lymn
This email has been sent on behalf of one of the following companies within the BAE Systems Australia group of companies:

    BAE Systems Australia Limited - Australian Company Number 008 423 005
    BAE Systems Australia Defence Pty Limited - Australian Company Number 006 870 846
    BAE Systems Australia Logistics Pty Limited - Australian Company Number 086 228 864

Our registered office is Evans Building, Taranaki Road, Edinburgh Parks,
Edinburgh, South Australia, 5111. If the identity of the sending company is
not clear from the content of this email please contact the sender.

This email and any attachments may contain confidential and legally
privileged information.  If you are not the intended recipient, do not copy or
disclose its content, but please reply to this email immediately and highlight
the error to the sender and then immediately delete the message.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008616.html">[squid-users] kerberos authentication with a machine account doesn't work
</A></li>
	<LI>Next message (by thread): <A HREF="008667.html">[squid-users] kerberos authentication with a machine account doesn't work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8665">[ date ]</a>
              <a href="thread.html#8665">[ thread ]</a>
              <a href="subject.html#8665">[ subject ]</a>
              <a href="author.html#8665">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
