<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Possible SSL Bug in v3.5.13?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20SSL%20Bug%20in%20v3.5.13%3F&In-Reply-To=%3C5695D275.4010401%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008704.html">
   <LINK REL="Next"  HREF="008749.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Possible SSL Bug in v3.5.13?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20SSL%20Bug%20in%20v3.5.13%3F&In-Reply-To=%3C5695D275.4010401%40treenet.co.nz%3E"
       TITLE="[squid-users] Possible SSL Bug in v3.5.13?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 13 04:28:37 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008704.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
        <LI>Next message (by thread): <A HREF="008749.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8706">[ date ]</a>
              <a href="thread.html#8706">[ thread ]</a>
              <a href="subject.html#8706">[ subject ]</a>
              <a href="author.html#8706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/01/2016 3:42 p.m., David Marcos wrote:
&gt;<i> I recently upgraded to Squid v3.5.13 and am encountering at least two
</I>&gt;<i> errors when processing certain HTTPS connections.  I am not sure if it is a
</I>&gt;<i> bug or a configuration error on my part.
</I>&gt;<i> 
</I>&gt;<i> The first error I am seeing is when shutterfly.com is accessed by a user.
</I>&gt;<i> The issue occurs regardless of whether I splice or bump the site.  A user
</I>&gt;<i> can browse to the page, but if they click on anything on the site, squid
</I>&gt;<i> encounters a fault.  The system does not crash; it recovers, but the proxy
</I>&gt;<i> is down for about 30 seconds.  Note that this occurs in regular forward
</I>&gt;<i> proxy mode, not intercept mode.
</I>
Squid crashing or hanging entirely is very odd. Especially with splice,
which is just blindly passing the TLS details between client and server.


&gt;<i> 
</I>&gt;<i> My knowledge of SSL is somewhat limited, so I am not sure if I have
</I>&gt;<i> misconfigured things in a way that creates the problem.  Two questions I
</I>&gt;<i> have are (a) to apply ECDH properly, must an optional cipher be chosen for
</I>&gt;<i> the tls-dh option? and (b) to properly apply ECDH, do I have to recreate
</I>&gt;<i> the dhparam file using an ECDH cipher (I'm currently using the dhparam file
</I>&gt;<i> that I previously had)?
</I>
If you omit or misconfigure the tls-dh / dhparams in a way that is not
complained about on startup/reconfigure all that happens is the DH based
ciphers are not usable. The RSA, DES, AES etc ciphers should all still
work normally.

When dhparam= or tls-dh= is configured &quot;old-style&quot; (ie with no curve
name) it only sets the parameters necessary for plain DH or EDH/DHE
ciphers to be used.

When tls-dh= is set with a curve name then the ECDH and EECDH/ECHDE
ciphers are configured.

&gt;<i> 
</I>&gt;<i> Separate from the above (or perhaps related), the second issue I am also
</I>&gt;<i> seeing are odd errors in the cache.log that are causing squid to fault and
</I>&gt;<i> recover.  I am not yet sure which sites are causing the issue, but I am
</I>&gt;<i> seeing the following error: FATAL: dying from an unhandled exception:
</I>&gt;<i> !theConsumer.  This error seems to be consistently preceded by &quot;Error
</I>&gt;<i> negotiating SSL on FD 25: error:14077102:SSL
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:unsupported protocol (1/-1/0)&quot;.
</I>
This is usually seen when non-TLS protocol (ie plain HTTP) is being
received in the HTTPS port.

Or in recent releases it could possibly be SSLv2 or SSLv2-compatible
protocol being received by a library that does not support SSLv2 on a
SSLv3+ or TLSv1+ -only port.


&gt;<i> 
</I>&gt;<i> The prior version I was running was v3.5.12 and I know that version had no
</I>&gt;<i> problems when accessing shutterfly.com nor the odd FATAL message I am
</I>&gt;<i> seeing with the below configuration.
</I>&gt;<i> 
</I>&gt;<i> Following is more detailed info for the first problem I am encountering
</I>&gt;<i> above with shutterfly.com.  Please let me know additional information is
</I>&gt;<i> needed.
</I>&gt;<i> 
</I>&gt;<i> Cache.log extracts when accessing shutterfly.com:
</I>&gt;<i> --------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:39:59 kid1| Error negotiating SSL on FD 91:
</I>&gt;<i> error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:39:59 kid1| Error negotiating SSL on FD 98:
</I>&gt;<i> error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:39:59 kid1| Error negotiating SSL on FD 89:
</I>&gt;<i> error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:40:02 kid1| Error negotiating SSL on FD 62:
</I>&gt;<i> error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify
</I>&gt;<i> failed (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:40:02 kid1| Error negotiating SSL on FD 63:
</I>&gt;<i> error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify
</I>&gt;<i> failed (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:40:03 kid1| Error negotiating SSL on FD 56:
</I>&gt;<i> error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 2016/01/12 22:40:03 kid1| Error negotiating SSL on FD 56:
</I>&gt;<i> error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 2016/01/12 22:40:03 kid1| Error negotiating SSL on FD 58:
</I>&gt;<i> error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Extracts from my squid.conf file:
</I>&gt;<i> ----------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> http_port 127.0.0.1:3128
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.10.1:3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=cert.pem tls-dh=cert.dhparam.pem
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.10.1:3129 intercept  disable-pmtu-discovery=transparent
</I>&gt;<i> name=http_icept
</I>&gt;<i> 
</I>&gt;<i> https_port 192.168.10.1:3130 intercept  disable-pmtu-discovery=transparent
</I>&gt;<i> ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=cert.pem tls-dh=cert.dhparam.pem name=https_icept
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /disk/dyn-certs/sslcrtd_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek SSL_Step1 !dont_peek_or_stare mynet
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice dont_bump_me mynet
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump mynet
</I>&gt;<i> 
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>
Since the above rules all contain &quot;mynet&quot; as a criterion for happening,
why not you re-order as:

  ssl_bump terminate !mynet
  ssl_bump peek SSL_Step1 !dont_peek_or_stare
  ssl_bump splice dont_bump_me
  ssl_bump bump all


&gt;<i> 
</I>&gt;<i> sslproxy_foreign_intermediate_certs /etc/ssl/certs/
</I>&gt;<i> 
</I>
This new directive takes a filename. Not a directory name.


&gt;<i> sslproxy_options
</I>&gt;<i> No_Compression,NO_TLSv1,NO_SSLv2,NO_SSLv3,SINGLE_DH_USE,CIPHER_SERVER_PREFERENCE
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cipher
</I>&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> 
</I>
The tls-dh / dhparams settings lacking a curve name for the EC* or EEC*
part mean that these ciphers will not work despite being configured as
acceptible :

 EECDH+ECDSA+AESGCM: EECDH+aRSA+AESGCM: EECDH+ECDSA+SHA384:
EECDH+ECDSA+SHA256: EECDH+aRSA+SHA384: EECDH+aRSA+SHA256:
EECDH+aRSA+RC4:EECDH:

Leaving your proxy only able to use this one:
 EDH+aRSA

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008704.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
	<LI>Next message (by thread): <A HREF="008749.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8706">[ date ]</a>
              <a href="thread.html#8706">[ thread ]</a>
              <a href="subject.html#8706">[ subject ]</a>
              <a href="author.html#8706">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
