<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host header forgery false positives
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host%20header%20forgery%20false%20positives&In-Reply-To=%3C5697B036.8080704%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008697.html">
   <LINK REL="Next"  HREF="008691.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host header forgery false positives</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host%20header%20forgery%20false%20positives&In-Reply-To=%3C5697B036.8080704%40treenet.co.nz%3E"
       TITLE="[squid-users] host header forgery false positives">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 14 14:27:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008697.html">[squid-users] host header forgery false positives
</A></li>
        <LI>Next message (by thread): <A HREF="008691.html">[squid-users] multiple client certfifcates for ssl bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8748">[ date ]</a>
              <a href="thread.html#8748">[ thread ]</a>
              <a href="subject.html#8748">[ subject ]</a>
              <a href="author.html#8748">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/01/2016 2:40 p.m., Jason Haar wrote:
&gt;<i> Hi there
</I>&gt;<i> 
</I>&gt;<i> I am finding squid-3.5.13 is false positive-ing on ssl-bump way too
</I>&gt;<i> often. I'm just using &quot;peek-and-splice&quot; on intercepted port 443 to
</I>&gt;<i> create better squid logfiles (ie I'm not actually bump-ing) but that
</I>&gt;<i> enables enough of the code to cause the Host forgery code to kick in -
</I>&gt;<i> but it doesn't work well in a real network
</I>&gt;<i> 
</I>&gt;<i> As you can see below, here's a handful of sites that we're seeing this
</I>&gt;<i> trigger on, and as it's my home network I can guarantee there's no odd
</I>&gt;<i> DNS setups or forgery going on. This is just real-world websites doing
</I>&gt;<i> what they do (ie are totally outside our control or influence)
</I>
Unfortunately that is not how the vulnerability works. Any web page you
visit could have an embedded script or advertisement that performs the
Host forgery without your knowledge or ability to prevent.

&gt;<i> 
</I>&gt;<i> I don't know how the forgery-checking code works, but I guess what's
</I>&gt;<i> happened is the DNS lookups the squid server does doesn't contain the
</I>&gt;<i> same IP addresses the client resolved the same DNS name to.
</I>
Correct. That is exactly how it works.

&gt;<i> I must say
</I>&gt;<i> that is odd because all our home computers use the squid server as their
</I>&gt;<i> DNS server - just as the squid service does - so there shouldn't be any
</I>&gt;<i> such conflict - but I imagine caching could be to blame (maybe the
</I>&gt;<i> clients cache old values longer/shorter timeframes than squid does).
</I>
HTTP persistent connections can last longer than the DNS TTL period. We
have found that if the DNS records rotate while the connection is still
receiving requests those new requests will wrongly fail the validation.

I have a plan for how to fix this case. But it requires some big changes
in the Squid DNS cache to avoid adding a new vulnerability, and I plan
to do that work later this year for the Squid-5 development cycle.


&gt;<i> 
</I>&gt;<i> This is a bit of a show-stopper to ever using bump: having perfectly
</I>&gt;<i> good websites being unavailable really isn't an option (in the case of
</I>&gt;<i> &quot;peek-and-splice&quot; over intercepted they seem to hang forever when this
</I>&gt;<i> error occurs). Perhaps an option to change it's behaviour would be
</I>&gt;<i> better? eg enable/disable and maybe &quot;ignore client and use the IP
</I>&gt;<i> addresses squid thinks are best&quot; could work?
</I>
Host validation should not be happening for CONNECT requests or bumped
traffic.

If you can obtain an ALL,9 cache.log trace it might help identifying the
issue. A bug report would be nice as well to track progress.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008697.html">[squid-users] host header forgery false positives
</A></li>
	<LI>Next message (by thread): <A HREF="008691.html">[squid-users] multiple client certfifcates for ssl bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8748">[ date ]</a>
              <a href="thread.html#8748">[ thread ]</a>
              <a href="subject.html#8748">[ subject ]</a>
              <a href="author.html#8748">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
