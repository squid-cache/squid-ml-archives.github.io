<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Possible SSL Bug in v3.5.13?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20SSL%20Bug%20in%20v3.5.13%3F&In-Reply-To=%3CCADd_%2B56RH5rL-LMwPWHh4ESeADXDMUZtA0EiFX_xaa8OphCcAA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008706.html">
   <LINK REL="Next"  HREF="008750.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Possible SSL Bug in v3.5.13?</H1>
    <B>David Marcos</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20SSL%20Bug%20in%20v3.5.13%3F&In-Reply-To=%3CCADd_%2B56RH5rL-LMwPWHh4ESeADXDMUZtA0EiFX_xaa8OphCcAA%40mail.gmail.com%3E"
       TITLE="[squid-users] Possible SSL Bug in v3.5.13?">davem.business at gmail.com
       </A><BR>
    <I>Thu Jan 14 14:47:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008706.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
        <LI>Next message (by thread): <A HREF="008750.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8749">[ date ]</a>
              <a href="thread.html#8749">[ thread ]</a>
              <a href="subject.html#8749">[ subject ]</a>
              <a href="author.html#8749">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Eliezer, Amos,

I wanted to follow-up on the below thread since I encountered an
additional, interesting issue.

Per my issue with shutterfly.com below, if I *do not* set an ECDH cipher in
the tls-dh parameter, then I have to remove NO_SSLv2 from sslproxy_options.

However, if I set an ECDH cipher (I chose secp384r1), I can add NO_SSLv2
back to sslproxy_options and shutterfly.com works without a hitch.  My full
sslproxy_options list now looks as follows having set the ECDH cipher in
tls-dh -

sslproxy_options
No_Compression,NO_TLSv1,NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE,SINGLE_DH_USE,CIPHER_SERVER_PREFERENCE

I don't know if this is a bug or expected behavior, so defer to you.  If
you'd like me to submit a bug request, I can do so.

Thanks again for the assistance,

    Dave

On Wed, Jan 13, 2016 at 6:26 AM, David Marcos &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">davem.business at gmail.com</A>&gt;
wrote:

&gt;<i> Eliezer, Amos,
</I>&gt;<i>
</I>&gt;<i> Thanks very much for the prompt responses.
</I>&gt;<i>
</I>&gt;<i> I removed NO_SSLv2 from sslproxy_options and the issue with shutterfly.com
</I>&gt;<i> went away.  If I remove NO_SSLv3 and keep NO_SSLv2, squid reports a
</I>&gt;<i> handshake negotiation error to the browser.  I've thus altered the options
</I>&gt;<i> to remove NO_SSLv2.  The only odd thing about this is that things worked
</I>&gt;<i> fine in v3.5.12 with my below configuration.
</I>&gt;<i>
</I>&gt;<i> I'll make some other changes per Amos's suggestions and follow-up if I see
</I>&gt;<i> anything additional of concern.
</I>&gt;<i>
</I>&gt;<i> Thanks again for the help,
</I>&gt;<i>
</I>&gt;<i>     Dave
</I>&gt;<i>
</I>&gt;<i> On Tue, Jan 12, 2016 at 11:28 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 13/01/2016 3:42 p.m., David Marcos wrote:
</I>&gt;&gt;<i> &gt; I recently upgraded to Squid v3.5.13 and am encountering at least two
</I>&gt;&gt;<i> &gt; errors when processing certain HTTPS connections.  I am not sure if it
</I>&gt;&gt;<i> is a
</I>&gt;&gt;<i> &gt; bug or a configuration error on my part.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The first error I am seeing is when shutterfly.com is accessed by a
</I>&gt;&gt;<i> user.
</I>&gt;&gt;<i> &gt; The issue occurs regardless of whether I splice or bump the site.  A
</I>&gt;&gt;<i> user
</I>&gt;&gt;<i> &gt; can browse to the page, but if they click on anything on the site, squid
</I>&gt;&gt;<i> &gt; encounters a fault.  The system does not crash; it recovers, but the
</I>&gt;&gt;<i> proxy
</I>&gt;&gt;<i> &gt; is down for about 30 seconds.  Note that this occurs in regular forward
</I>&gt;&gt;<i> &gt; proxy mode, not intercept mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid crashing or hanging entirely is very odd. Especially with splice,
</I>&gt;&gt;<i> which is just blindly passing the TLS details between client and server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; My knowledge of SSL is somewhat limited, so I am not sure if I have
</I>&gt;&gt;<i> &gt; misconfigured things in a way that creates the problem.  Two questions I
</I>&gt;&gt;<i> &gt; have are (a) to apply ECDH properly, must an optional cipher be chosen
</I>&gt;&gt;<i> for
</I>&gt;&gt;<i> &gt; the tls-dh option? and (b) to properly apply ECDH, do I have to recreate
</I>&gt;&gt;<i> &gt; the dhparam file using an ECDH cipher (I'm currently using the dhparam
</I>&gt;&gt;<i> file
</I>&gt;&gt;<i> &gt; that I previously had)?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you omit or misconfigure the tls-dh / dhparams in a way that is not
</I>&gt;&gt;<i> complained about on startup/reconfigure all that happens is the DH based
</I>&gt;&gt;<i> ciphers are not usable. The RSA, DES, AES etc ciphers should all still
</I>&gt;&gt;<i> work normally.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When dhparam= or tls-dh= is configured &quot;old-style&quot; (ie with no curve
</I>&gt;&gt;<i> name) it only sets the parameters necessary for plain DH or EDH/DHE
</I>&gt;&gt;<i> ciphers to be used.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When tls-dh= is set with a curve name then the ECDH and EECDH/ECHDE
</I>&gt;&gt;<i> ciphers are configured.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Separate from the above (or perhaps related), the second issue I am also
</I>&gt;&gt;<i> &gt; seeing are odd errors in the cache.log that are causing squid to fault
</I>&gt;&gt;<i> and
</I>&gt;&gt;<i> &gt; recover.  I am not yet sure which sites are causing the issue, but I am
</I>&gt;&gt;<i> &gt; seeing the following error: FATAL: dying from an unhandled exception:
</I>&gt;&gt;<i> &gt; !theConsumer.  This error seems to be consistently preceded by &quot;Error
</I>&gt;&gt;<i> &gt; negotiating SSL on FD 25: error:14077102:SSL
</I>&gt;&gt;<i> &gt; routines:SSL23_GET_SERVER_HELLO:unsupported protocol (1/-1/0)&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is usually seen when non-TLS protocol (ie plain HTTP) is being
</I>&gt;&gt;<i> received in the HTTPS port.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Or in recent releases it could possibly be SSLv2 or SSLv2-compatible
</I>&gt;&gt;<i> protocol being received by a library that does not support SSLv2 on a
</I>&gt;&gt;<i> SSLv3+ or TLSv1+ -only port.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The prior version I was running was v3.5.12 and I know that version had
</I>&gt;&gt;<i> no
</I>&gt;&gt;<i> &gt; problems when accessing shutterfly.com nor the odd FATAL message I am
</I>&gt;&gt;<i> &gt; seeing with the below configuration.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Following is more detailed info for the first problem I am encountering
</I>&gt;&gt;<i> &gt; above with shutterfly.com.  Please let me know additional information
</I>&gt;&gt;<i> is
</I>&gt;&gt;<i> &gt; needed.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Cache.log extracts when accessing shutterfly.com:
</I>&gt;&gt;<i> &gt; --------------------------------------------------------------------
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:39:59 kid1| Error negotiating SSL on FD 91:
</I>&gt;&gt;<i> &gt; error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;&gt;<i> &gt; (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:39:59 kid1| Error negotiating SSL on FD 98:
</I>&gt;&gt;<i> &gt; error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;&gt;<i> &gt; (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:39:59 kid1| Error negotiating SSL on FD 89:
</I>&gt;&gt;<i> &gt; error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;&gt;<i> &gt; (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:40:02 kid1| Error negotiating SSL on FD 62:
</I>&gt;&gt;<i> &gt; error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate
</I>&gt;&gt;<i> verify
</I>&gt;&gt;<i> &gt; failed (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:40:02 kid1| Error negotiating SSL on FD 63:
</I>&gt;&gt;<i> &gt; error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate
</I>&gt;&gt;<i> verify
</I>&gt;&gt;<i> &gt; failed (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:40:03 kid1| Error negotiating SSL on FD 56:
</I>&gt;&gt;<i> &gt; error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;&gt;<i> &gt; (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2016/01/12 22:40:03 kid1| Error negotiating SSL on FD 56:
</I>&gt;&gt;<i> &gt; error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;&gt;<i> &gt; (1/-1/0)
</I>&gt;&gt;<i> &gt; 2016/01/12 22:40:03 kid1| Error negotiating SSL on FD 58:
</I>&gt;&gt;<i> &gt; error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
</I>&gt;&gt;<i> &gt; (1/-1/0)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Extracts from my squid.conf file:
</I>&gt;&gt;<i> &gt; ----------------------------------------------
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; http_port 127.0.0.1:3128
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; http_port 192.168.10.1:3128 ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB cert=cert.pem tls-dh=cert.dhparam.pem
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; http_port 192.168.10.1:3129 intercept
</I>&gt;&gt;<i> disable-pmtu-discovery=transparent
</I>&gt;&gt;<i> &gt; name=http_icept
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; https_port 192.168.10.1:3130 intercept
</I>&gt;&gt;<i> disable-pmtu-discovery=transparent
</I>&gt;&gt;<i> &gt; ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt; cert=cert.pem tls-dh=cert.dhparam.pem name=https_icept
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; sslcrtd_program /usr/lib/squid/ssl_crtd -s /disk/dyn-certs/sslcrtd_db
</I>&gt;&gt;<i> -M 4MB
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ...
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump peek SSL_Step1 !dont_peek_or_stare mynet
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump splice dont_bump_me mynet
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump bump mynet
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ssl_bump terminate all
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since the above rules all contain &quot;mynet&quot; as a criterion for happening,
</I>&gt;&gt;<i> why not you re-order as:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   ssl_bump terminate !mynet
</I>&gt;&gt;<i>   ssl_bump peek SSL_Step1 !dont_peek_or_stare
</I>&gt;&gt;<i>   ssl_bump splice dont_bump_me
</I>&gt;&gt;<i>   ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; sslproxy_foreign_intermediate_certs /etc/ssl/certs/
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This new directive takes a filename. Not a directory name.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; sslproxy_options
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> No_Compression,NO_TLSv1,NO_SSLv2,NO_SSLv3,SINGLE_DH_USE,CIPHER_SERVER_PREFERENCE
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; sslproxy_cipher
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The tls-dh / dhparams settings lacking a curve name for the EC* or EEC*
</I>&gt;&gt;<i> part mean that these ciphers will not work despite being configured as
</I>&gt;&gt;<i> acceptible :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  EECDH+ECDSA+AESGCM: EECDH+aRSA+AESGCM: EECDH+ECDSA+SHA384:
</I>&gt;&gt;<i> EECDH+ECDSA+SHA256: EECDH+aRSA+SHA384: EECDH+aRSA+SHA256:
</I>&gt;&gt;<i> EECDH+aRSA+RC4:EECDH:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Leaving your proxy only able to use this one:
</I>&gt;&gt;<i>  EDH+aRSA
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> ___________________________________________________________
</I>&gt;<i> David J. Marcos
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">davem.business at gmail.com</A>
</I>&gt;<i>
</I>


-- 
___________________________________________________________
David J. Marcos
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">davem.business at gmail.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160114/8b2d128e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160114/8b2d128e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008706.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
	<LI>Next message (by thread): <A HREF="008750.html">[squid-users] Possible SSL Bug in v3.5.13?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8749">[ date ]</a>
              <a href="thread.html#8749">[ thread ]</a>
              <a href="subject.html#8749">[ subject ]</a>
              <a href="author.html#8749">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
