<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] I can't block streaming !!!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20I%20can%27t%20block%20streaming%20%21%21%21&In-Reply-To=%3C569F0B7C.30700%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008848.html">
   <LINK REL="Next"  HREF="008845.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] I can't block streaming !!!</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20I%20can%27t%20block%20streaming%20%21%21%21&In-Reply-To=%3C569F0B7C.30700%40treenet.co.nz%3E"
       TITLE="[squid-users] I can't block streaming !!!">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 20 04:22:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008848.html">[squid-users] I can't block streaming !!!
</A></li>
        <LI>Next message (by thread): <A HREF="008845.html">[squid-users] dynamic messages from acl helper program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8853">[ date ]</a>
              <a href="thread.html#8853">[ thread ]</a>
              <a href="subject.html#8853">[ subject ]</a>
              <a href="author.html#8853">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/01/2016 5:16 a.m., Aismel wrote:
&gt;<i> Hi guys
</I>&gt;<i> 
</I>&gt;<i> Thx for your replys
</I>&gt;<i> I want to block all streaming video and music....
</I>&gt;<i> 
</I>&gt;<i> I'm testing with Youtube this code but don't work and try
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/KnowledgeBase/Block%20QUIC%20protocol">http://wiki.squid-cache.org/KnowledgeBase/Block%20QUIC%20protocol</A>
</I>&gt;<i> 
</I>
Notice how QUIC protocol is a protocol and YouTube is a website - two
different things.

&gt;<i> but nothing happened... maybe I'm doing something wrong with iptable, juts
</I>&gt;<i> copy and paste the example...
</I>&gt;<i> 
</I>
You now have three problems; youtube not being blocked, the idea in your
head, and the cut-n-paste config.


You need to understand what that config does in order to make the
changes necessary to make it actually work in your network. The intro
text at the top of the page is supposed to explain that for you.

What it does not mention is that the config following is in fact partial
config snippets for 8 separate and often unrelated pieces of hardware.

The important thing to know is that all it does is block ports UDP/80
and UDP/443 in your firewall(s). That is all.

If you are playing with networking you should know how to do that for
your own systems without cut-n-paste from our wiki.


&gt;<i> So I need understand first to all see the all picture because for one side
</I>&gt;<i> some user say something and by other hand another thing and really I don't
</I>&gt;<i> think this issue is a some important... pls enlighten me
</I>&gt;<i> 
</I>
At this point you are so confused what you think no longer matters. Its
wrong in some ways.

So stop, pause. Lets see how much of my analysis matches your
understanding, and where you might be diverging.


&gt;<i> 
</I>&gt;<i> My SQUID Log tell this when a user open Youtube
</I>&gt;<i> 
</I>
By &quot;youtube&quot; here you are meaning the web page text (HTML) - not
anything even remotely resembling a stream.

&gt;<i> 
</I>&gt;<i> 1453231046.695  12165 172.16.1.50 TCP_MISS/301 471 GET <A HREF="http://youtube.com/">http://youtube.com/</A>
</I>&gt;<i> someuser DIRECT/74.125.196.91 text/html
</I>&gt;<i> 
</I>&gt;<i> 1453231059.561  12654 172.16.1.50 TCP_MISS/301 830 GET
</I>&gt;<i> <A HREF="http://www.youtube.com/">http://www.youtube.com/</A> someuser DIRECT/74.125.196.93 text/html
</I>&gt;<i> 
</I>
Then it stops being &quot;youtube&quot; ... and starts being &quot;google&quot;.

This is background traffic setting up TLS to Google:

&gt;<i> 1453231064.593   2239 172.16.1.50 TCP_MISS/000 0 POST
</I>&gt;<i> <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> someuser DIRECT/clients1.google.com -
</I>&gt;<i> 
</I>&gt;<i> 1453231079.463   1805 172.16.1.50 TCP_MISS/000 0 POST
</I>&gt;<i> <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> someuser DIRECT/74.125.196.101 -
</I>&gt;<i> 
</I>&gt;<i> 1453231080.243   2759 172.16.1.50 TCP_MISS/000 0 POST
</I>&gt;<i> <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> someuser DIRECT/74.125.196.101 -
</I>&gt;<i> 
</I>&gt;<i> 1453231126.749    620 172.16.1.50 TCP_MISS/200 1012 POST
</I>&gt;<i> <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> someuser DIRECT/74.125.196.102
</I>&gt;<i> application/ocsp-response
</I>&gt;<i> 
</I>&gt;<i> 1453231126.784    470 172.16.1.50 TCP_MISS/200 1012 POST
</I>&gt;<i> <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> someuser DIRECT/74.125.196.102
</I>&gt;<i> application/ocsp-response
</I>&gt;<i> 
</I>
This is advertising, from various of the Google owned advertising outlets:

&gt;<i> 1453231140.519  64309 172.16.1.50 TCP_MISS/200 11581 CONNECT
</I>&gt;<i> pubads.g.doubleclick.net:443 someuser DIRECT/74.125.196.155 -
</I>&gt;<i> 
</I>&gt;<i> 1453231141.600  66654 172.16.1.50 TCP_MISS/200 37205 CONNECT
</I>&gt;<i> yt3.ggpht.com:443 someuser DIRECT/74.125.196.132 -
</I>&gt;<i> 
</I>&gt;<i> 1453231154.532  61052 172.16.1.50 TCP_MISS/200 4714 CONNECT
</I>&gt;<i> gg.google.com:443 someuser DIRECT/74.125.196.102 -
</I>&gt;<i> 
</I>&gt;<i> 1453231163.576  60340 172.16.1.50 TCP_MISS/200 5079 CONNECT
</I>&gt;<i> googleads.g.doubleclick.net:443 someuser DIRECT/173.194.37.77 -
</I>

This is &quot;youtube&quot; again, images for the page from earlier:

&gt;<i> 
</I>&gt;<i> 1453231163.564  88718 172.16.1.50 TCP_MISS/200 365630 CONNECT
</I>&gt;<i> i.ytimg.com:443 someuser DIRECT/74.125.196.101 -
</I>&gt;<i> 
</I>&gt;<i> 1453231164.565 104857 172.16.1.50 TCP_MISS/200 47731 CONNECT
</I>&gt;<i> www.youtube.com:443 someuser DIRECT/74.125.196.93 -
</I>&gt;<i> 
</I>&gt;<i> 1453231169.599 103517 172.16.1.50 TCP_MISS/200 376650 CONNECT
</I>&gt;<i> s.ytimg.com:443 someuser DIRECT/74.125.196.139 -
</I>&gt;<i> 
</I>
This is google login happening:

&gt;<i> 1453231185.663  60424 172.16.1.50 TCP_MISS/200 4870 CONNECT
</I>&gt;<i> accounts.google.com:443 someuser DIRECT/74.125.196.84 -
</I>&gt;<i> 
</I>&gt;<i> 1453231187.657  84365 172.16.1.50 TCP_MISS/200 121248 CONNECT
</I>&gt;<i> apis.google.com:443 someuser DIRECT/74.125.196.100 -
</I>&gt;<i> 
</I>&gt;<i> 1453231187.669  60628 172.16.1.50 TCP_MISS/200 27795 CONNECT
</I>&gt;<i> oauth.googleusercontent.com:443 someuser DIRECT/74.125.196.132 -
</I>&gt;<i> 
</I>&gt;<i> 1453231187.681  60639 172.16.1.50 TCP_MISS/200 8105 CONNECT
</I>&gt;<i> ssl.gstatic.com:443 someuser DIRECT/74.125.196.94 -
</I>&gt;<i> 
</I>&gt;<i> 1453231188.673  63279 172.16.1.50 TCP_MISS/200 8763 CONNECT
</I>&gt;<i> content.googleapis.com:443 someuser DIRECT/74.125.21.95 -
</I>&gt;<i> 
</I>
So far it has taken a full 2 minutes to show the page. And these are
just the parts which finished so far. From experience there are maybe a
dozen more parts that are not listed here. D/L of the player scripts,
jQuery, the &quot;please install Chrome&quot; nagware, and some other spyware.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I don't not if is necessary block the youtube page I only want to block when
</I>&gt;<i> some user try to play a video... 
</I>&gt;<i> 
</I>
The actual video AFAICT is not in that log section. Which means it is
either in a connection that is not yet finished according to that log
section, or bypassing the proxy.

If its a long duration CONNECT it could be still open when you went
looking for it. You need the video to have been fully stopped and
preferrably the page/tab closed as well to be sure everything is logged.


Bypassing the proxy is what QUIC is about. You can add those rules from
the wiki to block it at your firewall. But doing so is not a guarantee
even if you get them right - because it is just one possibility amongst
several for how the video is happening. When QUIC is blocked, one of the
others is used. You have to locate and block all of them.



Another nastier alternative is Alternate-Protocol headers in the HTTP.
They are how the browser is told to use QUIC. But it could be told to
use QUIC over unusual ports, or non-QUIC protocols as well. Stripping
the headers is needed to prevent this. That might mean decrypting the
CONNECT tunnels and processing the HTTPS requests from inside them.


The easy way out is to just reject/deny the youtube.com domain entirely
being accessed through the proxy. That blocks the HTML page that starts
the whole nasty sequence. Remember it? the very first two lines in your log.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008848.html">[squid-users] I can't block streaming !!!
</A></li>
	<LI>Next message (by thread): <A HREF="008845.html">[squid-users] dynamic messages from acl helper program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8853">[ date ]</a>
              <a href="thread.html#8853">[ thread ]</a>
              <a href="subject.html#8853">[ subject ]</a>
              <a href="author.html#8853">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
