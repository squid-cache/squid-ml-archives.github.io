<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] MS update woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20MS%20update%20woes&In-Reply-To=%3CCAJ%2BQ1PVSR6TmEN58TE2o4iM5iuOz7CsntZbo3UiszJX8FFtnng%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008850.html">
   <LINK REL="Next"  HREF="008887.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] MS update woes</H1>
    <B>Alex Samad</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20MS%20update%20woes&In-Reply-To=%3CCAJ%2BQ1PVSR6TmEN58TE2o4iM5iuOz7CsntZbo3UiszJX8FFtnng%40mail.gmail.com%3E"
       TITLE="[squid-users] MS update woes">alex at samad.com.au
       </A><BR>
    <I>Sun Jan 24 22:20:45 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008850.html">[squid-users] MS update woes
</A></li>
        <LI>Next message (by thread): <A HREF="008887.html">[squid-users] MS update woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8886">[ date ]</a>
              <a href="thread.html#8886">[ thread ]</a>
              <a href="subject.html#8886">[ subject ]</a>
              <a href="author.html#8886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

Seems like I getting a bit confused in my conf now .. with
never_direct, always_direct. and miss_access


# ##
# acl
# ##
acl sblMal dstdomain -i &quot;/etc/squid/lists/squid-malicious.acl&quot;
acl sblPorn dstdomain -i &quot;/etc/squid/lists/squid-porn.acl&quot;
acl localnet src 10.32.80.0/24
acl localnet_auth src 10.32.0.0/14
acl localnet_auth src 10.172.0.0/16
acl localnet_auth src 10.43.200.51/32
acl localnet_guest src 10.172.202.0/24
acl localnet_appproxy src 10.172.203.30/32
acl sblYBOveride dstdomain -i &quot;/etc/squid/lists/yb-nonsquidblacklist.acl&quot;
acl nonAuthDom dstdomain -i &quot;/etc/squid/lists/nonAuthDom.lst&quot;
acl nonAuthSrc src &quot;/etc/squid/lists/nonAuthServer.lst&quot;
acl FTP proto FTP
acl DMZSRV src 10.32.20.110
acl DMZSRV src 10.32.20.111
acl DirectExceptions url_regex -i
^<A HREF="http://(www.|">http://(www.|</A>)smh.com.au/business/markets-live/.*
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl CONNECT method CONNECT
acl SQUIDSPECIAL urlpath_regex ^/squid-internal-static/
acl AuthorizedUsers proxy_auth REQUIRED
acl icp_allowed src 10.32.20.110/32
acl icp_allowed src 10.32.20.111/32
acl icp_allowed src 10.172.203.30/32
acl icp_allowed src 10.172.203.34/32
acl windowsupdate_url url_regex -i
microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
acl windowsupdate_url url_regex -i
windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
acl windowsupdate_url url_regex -i
windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
acl notwindowsupdate_url dstdomain ctldl.windowsupdate.com
acl nonCacheDom dstdomain -i &quot;/etc/squid/lists/nonCacheDom.lst&quot;
acl nonCacheURL urlpath_regex /x86_64/repodata/repomd.xml$
acl Delay_Domain dstdomain -i &quot;/etc/squid/lists/delayDom.lst&quot;



##http_access
## presume this is processed first

# manager access
http_access allow manager localhost
http_access allow manager icp_allowed
http_access deny manager

# icp access
http_access allow icp_allowed

# the squid special url
http_access allow SQUIDSPECIAL
# block non safe ports
http_access deny !Safe_ports
# block ssl non non ssl  ports
http_access deny CONNECT !SSL_ports

#http_access deny to_localhost

# Who can access
# network with no auth
http_access allow localnet
# local machine
http_access allow localhost
# other downstreams
http_access allow localnet_appproxy

# this is my just in case MS update goes wild again turn this on ACL
#http_access deny !DMZSRV windowsupdate_url

# the catch all for ip address range
http_access deny !localnet_auth

# special guest network rules (basically non auth)
http_access allow localnet_guest sblYBOveride
http_access deny localnet_guest sblMal
http_access deny localnet_guest sblPorn
http_access allow localnet_guest

# non guest sources that can access via non auth
http_access allow nonAuthSrc
# non auth dest domains
http_access allow nonAuthDom

# over ride some black list sites
http_access allow sblYBOveride FTP
http_access allow sblYBOveride AuthorizedUsers

# squid blacklists
http_access deny sblMal
http_access deny sblPorn

# allow FTP
http_access allow FTP
# allow Authorised
http_access allow AuthorizedUsers
# deny every one else
http_access deny all




# Alway direct
# if its FTP then go direct
always_direct allow FTP
# stop the looping. so peer cache requests are always direct
always_direct allow DMZSRV
# Some url's still have issues with looping and caching back responses
# this makes them allways do direct and never loop
always_direct allow DirectExceptions

# never Direct
# there are some MS urls that should be direct (they are usually not cached)
never_direct deny notwindowsupdate_url
# block all MS update's except from certain sources from going direct
# does this allow a cache peer to start a windows update ???
never_direct allow !DMZSRV windowsupdate_url


# ### This is my newly added
# miss_access
# <A HREF="http://www.squid-cache.org/Doc/config/miss_access/">http://www.squid-cache.org/Doc/config/miss_access/</A>
# Some MS urls are need and can't be cached !
miss_access allow notwindowsupdate_url
# Deny Access to MS Update only from DMZ boxes
miss_access deny !DMZSRV windowsupdate_url


# <A HREF="http://wiki.squid-cache.org/SquidFaq/WindowsUpdate">http://wiki.squid-cache.org/SquidFaq/WindowsUpdate</A>
# 800M for MS SQL patch file
# made bigger to handle bigger Patch files !
range_offset_limit 800 MB
maximum_object_size 800 MB
quick_abort_min -1


# special refresh pattarns that force files to be cached. I have
changed it up to 90days of caching
# also added in the [^?] to stop it trying to cache those
refresh_pattern -i
microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?] 4320
80% 129600 reload-into-ims
refresh_pattern -i
windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
4320 80% 129600 reload-into-ims
refresh_pattern -i
windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?] 4320
80% 129600 reload-into-ims

# Add any of your own refresh_pattern entries above these.
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# NON Cache Domain
acl nonCacheDom dstdomain -i &quot;/etc/squid/lists/nonCacheDom.lst&quot;
cache deny nonCacheDom

# NON Cache URL
acl nonCacheURL urlpath_regex /x86_64/repodata/repomd.xml$
cache deny nonCacheURL



So what I have hoped to have done here is
1) stop all except DMZSRV hosts from access the Microsoft Update urls,
unless its cached ...
2) allowed DMZSRV hosts to request those files and place them in the cache.


I had thought I had done that before, but i noticed this morning a
spike as machine where turned on and they started to make request


These are lines before I added the miss_access config. I had though
the never direct would have stopped these !
I had to turn on the explicit
#http_access deny !DMZSRV windowsupdate_url


# ##
1453672641.992     28 10.172.202.102 TCP_MISS/206 1819330 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672652.908   9943 10.172.202.102 TCP_MISS/206 3639200 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672661.916   8973 10.172.202.102 TCP_MISS/206 1686624 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672662.026     20 10.172.202.102 TCP_MISS/206 1160541 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672664.922   1918 10.172.202.102 TCP_MISS/206 3119331 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672697.955  32927 10.172.202.102 TCP_MISS/206 1697038 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672698.245     16 10.172.202.102 TCP_MISS/206 1140456 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672699.359    130 10.172.202.102 TCP_MISS/206 3424893 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
1453672700.269     38 10.172.202.102 TCP_MISS/206 2338346 GET
<A HREF="http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf">http://wsus.ds.download.windowsupdate.com/c/msdownload/update/software/secu/2015/12/ie11-windows6.1-kb3124275-x86_da23592568a57c26665a23d23d888428d831d739.psf</A>
- HIER_NONE/- application/octet-stream
# ##



any comments welcome

Thanks


On 20 January 2016 at 14:27, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 20/01/2016 1:56 p.m., Alex Samad wrote:
</I>&gt;&gt;<i> Oh
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am missing something. your saying the actualy get include more past
</I>&gt;&gt;<i> the ? and that squid logging isn't recording it !
</I>&gt;<i>
</I>&gt;<i> Yes. There is part of the URL that is not logged by default. Sometimes
</I>&gt;<i> that part is very big by many KB, and/or wrongly containing sensitive info.
</I>&gt;<i> Set &lt;<A HREF="http://www.squid-cache.org/Doc/config/strip_query_terms/">http://www.squid-cache.org/Doc/config/strip_query_terms/</A>&gt; to
</I>&gt;<i> show/hide that part.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So what I really need to do is modify the original to exclude any urls
</I>&gt;&gt;<i> that have ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> something like ?
</I>&gt;&gt;<i> &quot;windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]&quot;
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What I suspect is that some part of the hidden query-string is different
</I>&gt;<i> between the MISS and possibly between your prefetch request.
</I>&gt;<i>
</I>&gt;<i> You may be able to use the Store-ID feature to compact duplicates if the
</I>&gt;<i> changing part is unimportant. But that would have to be done very
</I>&gt;<i> carefully as there are some nasty side effects worse than bandwidth
</I>&gt;<i> usage if it goes wrong.
</I>&gt;<i>  So leave off trying for a fix until you/we are clear on what exactly
</I>&gt;<i> the reason for the MISS is.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008850.html">[squid-users] MS update woes
</A></li>
	<LI>Next message (by thread): <A HREF="008887.html">[squid-users] MS update woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8886">[ date ]</a>
              <a href="thread.html#8886">[ thread ]</a>
              <a href="subject.html#8886">[ subject ]</a>
              <a href="author.html#8886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
