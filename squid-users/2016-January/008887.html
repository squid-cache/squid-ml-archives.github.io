<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] MS update woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20MS%20update%20woes&In-Reply-To=%3C56A575DD.8030401%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008886.html">
   <LINK REL="Next"  HREF="008889.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] MS update woes</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20MS%20update%20woes&In-Reply-To=%3C56A575DD.8030401%40treenet.co.nz%3E"
       TITLE="[squid-users] MS update woes">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jan 25 01:09:49 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008886.html">[squid-users] MS update woes
</A></li>
        <LI>Next message (by thread): <A HREF="008889.html">[squid-users] MS update woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8887">[ date ]</a>
              <a href="thread.html#8887">[ thread ]</a>
              <a href="subject.html#8887">[ subject ]</a>
              <a href="author.html#8887">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/01/2016 11:20 a.m., Alex Samad wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> Seems like I getting a bit confused in my conf now .. with
</I>&gt;<i> never_direct, always_direct. and miss_access
</I>&gt;<i> 
</I>
never_direct and always_direct determine whether cache_peer are required
or allowed to be used on that connection respectively. You dont have
cache_peer so only never_direct will have an effect via preventing any
server connections from Squid.

miss_access determines whether Squid is allowed to service a MISS
transaction.

In your setup never_direct and miss_access are roughly the same end
result. But Squid does a lot more work in the never_direct case.


&gt;<i> 
</I>&gt;<i> # ##
</I>&gt;<i> # acl
</I>&gt;<i> # ##
</I>&gt;<i> acl sblMal dstdomain -i &quot;/etc/squid/lists/squid-malicious.acl&quot;
</I>&gt;<i> acl sblPorn dstdomain -i &quot;/etc/squid/lists/squid-porn.acl&quot;
</I>&gt;<i> acl localnet src 10.32.80.0/24
</I>&gt;<i> acl localnet_auth src 10.32.0.0/14
</I>&gt;<i> acl localnet_auth src 10.172.0.0/16
</I>&gt;<i> acl localnet_auth src 10.43.200.51/32
</I>&gt;<i> acl localnet_guest src 10.172.202.0/24
</I>&gt;<i> acl localnet_appproxy src 10.172.203.30/32
</I>&gt;<i> acl sblYBOveride dstdomain -i &quot;/etc/squid/lists/yb-nonsquidblacklist.acl&quot;
</I>&gt;<i> acl nonAuthDom dstdomain -i &quot;/etc/squid/lists/nonAuthDom.lst&quot;
</I>&gt;<i> acl nonAuthSrc src &quot;/etc/squid/lists/nonAuthServer.lst&quot;
</I>&gt;<i> acl FTP proto FTP
</I>&gt;<i> acl DMZSRV src 10.32.20.110
</I>&gt;<i> acl DMZSRV src 10.32.20.111
</I>&gt;<i> acl DirectExceptions url_regex -i
</I>&gt;<i> ^<A HREF="http://(www.|">http://(www.|</A>)smh.com.au/business/markets-live/.*
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl SQUIDSPECIAL urlpath_regex ^/squid-internal-static/
</I>&gt;<i> acl AuthorizedUsers proxy_auth REQUIRED
</I>&gt;<i> acl icp_allowed src 10.32.20.110/32
</I>&gt;<i> acl icp_allowed src 10.32.20.111/32
</I>&gt;<i> acl icp_allowed src 10.172.203.30/32
</I>&gt;<i> acl icp_allowed src 10.172.203.34/32
</I>&gt;<i> acl windowsupdate_url url_regex -i
</I>&gt;<i> microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
</I>&gt;<i> acl windowsupdate_url url_regex -i
</I>&gt;<i> windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
</I>&gt;<i> acl windowsupdate_url url_regex -i
</I>&gt;<i> windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
</I>&gt;<i> acl notwindowsupdate_url dstdomain ctldl.windowsupdate.com
</I>&gt;<i> acl nonCacheDom dstdomain -i &quot;/etc/squid/lists/nonCacheDom.lst&quot;
</I>&gt;<i> acl nonCacheURL urlpath_regex /x86_64/repodata/repomd.xml$
</I>&gt;<i> acl Delay_Domain dstdomain -i &quot;/etc/squid/lists/delayDom.lst&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ##http_access
</I>&gt;<i> ## presume this is processed first
</I>&gt;<i> 
</I>&gt;<i> # manager access
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access allow manager icp_allowed
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # icp access
</I>&gt;<i> http_access allow icp_allowed
</I>&gt;<i> 
</I>&gt;<i> # the squid special url
</I>&gt;<i> http_access allow SQUIDSPECIAL
</I>&gt;<i> # block non safe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> # block ssl non non ssl  ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> # Who can access
</I>&gt;<i> # network with no auth
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> # local machine
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> # other downstreams
</I>&gt;<i> http_access allow localnet_appproxy
</I>&gt;<i> 
</I>&gt;<i> # this is my just in case MS update goes wild again turn this on ACL
</I>&gt;<i> #http_access deny !DMZSRV windowsupdate_url
</I>&gt;<i> 
</I>
That should be above the &quot;allow localnet&quot; line
... and maybe also above &quot;allow icp_allowed&quot; line.


&gt;<i> # the catch all for ip address range
</I>&gt;<i> http_access deny !localnet_auth
</I>&gt;<i> 
</I>&gt;<i> # special guest network rules (basically non auth)
</I>&gt;<i> http_access allow localnet_guest sblYBOveride
</I>&gt;<i> http_access deny localnet_guest sblMal
</I>&gt;<i> http_access deny localnet_guest sblPorn
</I>&gt;<i> http_access allow localnet_guest
</I>&gt;<i> 
</I>&gt;<i> # non guest sources that can access via non auth
</I>&gt;<i> http_access allow nonAuthSrc
</I>&gt;<i> # non auth dest domains
</I>&gt;<i> http_access allow nonAuthDom
</I>&gt;<i> 
</I>&gt;<i> # over ride some black list sites
</I>&gt;<i> http_access allow sblYBOveride FTP
</I>&gt;<i> http_access allow sblYBOveride AuthorizedUsers
</I>&gt;<i> 
</I>&gt;<i> # squid blacklists
</I>&gt;<i> http_access deny sblMal
</I>&gt;<i> http_access deny sblPorn
</I>&gt;<i> 
</I>&gt;<i> # allow FTP
</I>&gt;<i> http_access allow FTP
</I>&gt;<i> # allow Authorised
</I>&gt;<i> http_access allow AuthorizedUsers
</I>&gt;<i> # deny every one else
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Alway direct
</I>&gt;<i> # if its FTP then go direct
</I>&gt;<i> always_direct allow FTP
</I>&gt;<i> # stop the looping. so peer cache requests are always direct
</I>&gt;<i> always_direct allow DMZSRV
</I>&gt;<i> # Some url's still have issues with looping and caching back responses
</I>&gt;<i> # this makes them allways do direct and never loop
</I>&gt;<i> always_direct allow DirectExceptions
</I>&gt;<i> 
</I>&gt;<i> # never Direct
</I>&gt;<i> # there are some MS urls that should be direct (they are usually not cached)
</I>&gt;<i> never_direct deny notwindowsupdate_url
</I>&gt;<i> # block all MS update's except from certain sources from going direct
</I>&gt;<i> # does this allow a cache peer to start a windows update ???
</I>&gt;<i> never_direct allow !DMZSRV windowsupdate_url
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # ### This is my newly added
</I>&gt;<i> # miss_access
</I>&gt;<i> # <A HREF="http://www.squid-cache.org/Doc/config/miss_access/">http://www.squid-cache.org/Doc/config/miss_access/</A>
</I>&gt;<i> # Some MS urls are need and can't be cached !
</I>&gt;<i> miss_access allow notwindowsupdate_url
</I>&gt;<i> # Deny Access to MS Update only from DMZ boxes
</I>&gt;<i> miss_access deny !DMZSRV windowsupdate_url
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # <A HREF="http://wiki.squid-cache.org/SquidFaq/WindowsUpdate">http://wiki.squid-cache.org/SquidFaq/WindowsUpdate</A>
</I>&gt;<i> # 800M for MS SQL patch file
</I>&gt;<i> # made bigger to handle bigger Patch files !
</I>&gt;<i> range_offset_limit 800 MB
</I>&gt;<i> maximum_object_size 800 MB
</I>&gt;<i> quick_abort_min -1
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # special refresh pattarns that force files to be cached. I have
</I>&gt;<i> changed it up to 90days of caching
</I>&gt;<i> # also added in the [^?] to stop it trying to cache those
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?] 4320
</I>&gt;<i> 80% 129600 reload-into-ims
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?]
</I>&gt;<i> 4320 80% 129600 reload-into-ims
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip)[^?] 4320
</I>&gt;<i> 80% 129600 reload-into-ims
</I>&gt;<i> 
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> # NON Cache Domain
</I>&gt;<i> acl nonCacheDom dstdomain -i &quot;/etc/squid/lists/nonCacheDom.lst&quot;
</I>&gt;<i> cache deny nonCacheDom
</I>&gt;<i> 
</I>&gt;<i> # NON Cache URL
</I>&gt;<i> acl nonCacheURL urlpath_regex /x86_64/repodata/repomd.xml$
</I>&gt;<i> cache deny nonCacheURL
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So what I have hoped to have done here is
</I>&gt;<i> 1) stop all except DMZSRV hosts from access the Microsoft Update urls,
</I>&gt;<i> unless its cached ...
</I>&gt;<i> 2) allowed DMZSRV hosts to request those files and place them in the cache.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I had thought I had done that before, but i noticed this morning a
</I>&gt;<i> spike as machine where turned on and they started to make request
</I>

I do not see any cache_dir lines in your config file. Which means the
Squid is operating with only its default 256MB memory cache.

Objects bigger than the cache itself (eg the 600 MB ones) will not be
stored. Objects in there will be removed whenever Squid restarts even if
they can be stored. Raising the limits to 800MB wont help when there is
only 256MB total space.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008886.html">[squid-users] MS update woes
</A></li>
	<LI>Next message (by thread): <A HREF="008889.html">[squid-users] MS update woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8887">[ date ]</a>
              <a href="thread.html#8887">[ thread ]</a>
              <a href="subject.html#8887">[ subject ]</a>
              <a href="author.html#8887">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
