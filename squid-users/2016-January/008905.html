<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS Content Filtering without de-crypting traffic?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20Content%20Filtering%20without%20de-crypting%0A%20traffic%3F&In-Reply-To=%3C7a24718c7a38bad3c9895cf332484153%40localhost%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008900.html">
   <LINK REL="Next"  HREF="008901.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS Content Filtering without de-crypting traffic?</H1>
    <B>James Lay</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20Content%20Filtering%20without%20de-crypting%0A%20traffic%3F&In-Reply-To=%3C7a24718c7a38bad3c9895cf332484153%40localhost%3E"
       TITLE="[squid-users] HTTPS Content Filtering without de-crypting traffic?">jlay at slave-tothe-box.net
       </A><BR>
    <I>Wed Jan 27 16:33:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008900.html">[squid-users] HTTPS Content Filtering without de-crypting traffic?
</A></li>
        <LI>Next message (by thread): <A HREF="008901.html">[squid-users] http://bugs.squid-cache.org/show_bug.cgi?id=4223
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8905">[ date ]</a>
              <a href="thread.html#8905">[ thread ]</a>
              <a href="subject.html#8905">[ subject ]</a>
              <a href="author.html#8905">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> 

On 2016-01-26 15:59, Panda Admin wrote: 

&gt;<i> Hello, 
</I>&gt;<i> 
</I>&gt;<i> I attempting to terminate https traffic based on ACLs using ssl_bumping WITHOUT de-crypting the traffic in intercept/transparent mode.  Has anyone got this to work before? I have copied my configuration and what my iptables nat rules look like.  
</I>&gt;<i> 
</I>&gt;<i> I am using squid 3.5.13 with the following compile options: 
</I>&gt;<i> 
</I>&gt;<i> Squid Cache: Version 3.5.12 
</I>&gt;<i> Service Name: squid 
</I>&gt;<i> configure options:  '--prefix=/usr' '--localstatedir=/var' '--libexecdir=/lib/squid3' '--datadir=/share/squid3' '--sysconfdir=/etc/squid3' '--with-default-user=proxy' '--with-logdir=/var/log/squid3' '--with-pidfile=/var/run/squid3.pid' '--with-openssl' '-enable-ssl-crtd' '--enable-icap-client' '--with-large-files' --enable-ltdl-convenience 
</I>&gt;<i> 
</I>&gt;<i> squid.conf: 
</I>&gt;<i> 
</I>&gt;<i> acl social dstdomain .google.com [1] .facebook.com [2] .reddit.com [3] 
</I>&gt;<i> acl step1 at_step SslBump1 
</I>&gt;<i> acl step2 at_step SslBump2 
</I>&gt;<i> ssl_bump stare step2 all 
</I>&gt;<i> ssl_bump terminate social 
</I>&gt;<i> acl localnet src 192.168.50.0/24 [4] 
</I>&gt;<i> acl SSL_ports port 443 
</I>&gt;<i> acl Safe_ports port 80 # http 
</I>&gt;<i> acl Safe_ports port 21 # ftp 
</I>&gt;<i> acl Safe_ports port 443 # https 
</I>&gt;<i> acl Safe_ports port 70 # gopher 
</I>&gt;<i> acl Safe_ports port 210 # wais 
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports 
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt 
</I>&gt;<i> acl Safe_ports port 488 # gss-http 
</I>&gt;<i> acl Safe_ports port 591 # filemaker 
</I>&gt;<i> acl Safe_ports port 777 # multiling http 
</I>&gt;<i> acl CONNECT method CONNECT 
</I>&gt;<i> http_access allow manager localhost 
</I>&gt;<i> http_access deny manager 
</I>&gt;<i> http_access deny !Safe_ports 
</I>&gt;<i> http_access deny CONNECT !SSL_ports 
</I>&gt;<i> http_access allow localnet 
</I>&gt;<i> http_access allow localhost 
</I>&gt;<i> http_access allow all 
</I>&gt;<i> http_port 3128 transparent 
</I>&gt;<i> https_port 3129 intercept ssl-bump cert=/etc/squid3/ssl_cert/squidSSL.pem 
</I>&gt;<i> cache_dir ufs /cache/squid3/spool 100 16 256 
</I>&gt;<i> access_log syslog:local5.info [5] squid 
</I>&gt;<i> coredump_dir /var/spool/squid3 
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /cache/config/daemons/squidguard/squidGuard.conf 
</I>&gt;<i> url_rewrite_children 15 
</I>&gt;<i> url_rewrite_access allow all 
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080 
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440 
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0 
</I>&gt;<i> refresh_pattern . 0 20% 4320 
</I>&gt;<i> icap_enable on 
</I>&gt;<i> icap_send_client_ip on 
</I>&gt;<i> icap_send_client_username on 
</I>&gt;<i> icap_client_username_encode off 
</I>&gt;<i> icap_client_username_header X-Authenticated-User 
</I>&gt;<i> icap_preview_enable on 
</I>&gt;<i> icap_preview_size 1024 
</I>&gt;<i> icap_service service_req reqmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> [6] 
</I>&gt;<i> adaptation_access service_req allow all 
</I>&gt;<i> icap_service service_resp respmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> [6] 
</I>&gt;<i> adaptation_access service_resp allow all 
</I>&gt;<i> 
</I>&gt;<i> iptables -L -v -t nat(only relevant rules): 
</I>&gt;<i> 
</I>&gt;<i> Chain PREROUTING (policy ACCEPT 1083 packets, 233K bytes) 
</I>&gt;<i> pkts bytes target     prot opt in     out     source               destination              
</I>&gt;<i> 157  9420 DNAT       tcp  --  eth1   any     anywhere             anywhere             tcp dpt:https to:192.168.11.1:3129 [7] 
</I>&gt;<i> 
</I>&gt;<i> Chain PREROUTING-daemon-tcp (1 references) 
</I>&gt;<i> pkts bytes target     prot opt in     out     source               destination          
</I>&gt;<i> 443 26580 DNAT       tcp  --  eth1   any     anywhere             anywhere             tcp dpt:http /* 7:PFD::CF-3128 */ to:192.168.11.1:3128 [8] 
</I>&gt;<i> 0     0 DNAT       tcp  --  eth2   any     anywhere             anywhere             tcp dpt:http /* 8:PFD::CF-3128 */ to:172.17.0.1:3128 [9] 
</I>&gt;<i> 
</I>&gt;<i> Right now I can't get it to terminate ANY https traffic. All it does is allow it through.   
</I>&gt;<i> Any and all help would be greatly appreciated! 
</I>&gt;<i> 
</I>&gt;<i> ~ Extremely Confused Squid User ~ 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
Read: 

<A HREF="http://thread.gmane.org/gmane.comp.web.squid.general/114384/focus=114389">http://thread.gmane.org/gmane.comp.web.squid.general/114384/focus=114389</A>


I'm doing exactly what you're wanting. 

James 
  

Links:
------
[1] <A HREF="http://google.com/">http://google.com/</A>
[2] <A HREF="http://facebook.com/">http://facebook.com/</A>
[3] <A HREF="http://reddit.com/">http://reddit.com/</A>
[4] <A HREF="http://192.168.50.0/24">http://192.168.50.0/24</A>
[5] <A HREF="http://local5.info/">http://local5.info/</A>
[6] <A HREF="http://127.0.0.1:1344/squidclamav">http://127.0.0.1:1344/squidclamav</A>
[7] <A HREF="http://192.168.11.1:3129/">http://192.168.11.1:3129/</A>
[8] <A HREF="http://192.168.11.1:3128/">http://192.168.11.1:3128/</A>
[9] <A HREF="http://172.17.0.1:3128/">http://172.17.0.1:3128/</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160127/cd42ccc5/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160127/cd42ccc5/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008900.html">[squid-users] HTTPS Content Filtering without de-crypting traffic?
</A></li>
	<LI>Next message (by thread): <A HREF="008901.html">[squid-users] http://bugs.squid-cache.org/show_bug.cgi?id=4223
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8905">[ date ]</a>
              <a href="thread.html#8905">[ thread ]</a>
              <a href="subject.html#8905">[ subject ]</a>
              <a href="author.html#8905">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
