<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forwarded_for problems log client ip apache 2.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forwarded_for%20problems%20log%20client%20ip%20apache%202.4&In-Reply-To=%3Cvmime.56aa19ce.3d3e.283f60a258e12bae%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008907.html">
   <LINK REL="Next"  HREF="008910.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forwarded_for problems log client ip apache 2.4</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forwarded_for%20problems%20log%20client%20ip%20apache%202.4&In-Reply-To=%3Cvmime.56aa19ce.3d3e.283f60a258e12bae%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] forwarded_for problems log client ip apache 2.4">belle at bazuin.nl
       </A><BR>
    <I>Thu Jan 28 13:38:22 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008907.html">[squid-users] Help - Squid for windows - Configuring upstream proxy with Active Directory authentication details
</A></li>
        <LI>Next message (by thread): <A HREF="008910.html">[squid-users] forwarded_for problems log client ip apache 2.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8909">[ date ]</a>
              <a href="thread.html#8909">[ thread ]</a>
              <a href="subject.html#8909">[ subject ]</a>
              <a href="author.html#8909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai, 

&#160;

I having some troubles to get my client ip (and/or hostname) logged in my apache webserver. 

I do think this is something in my squid setup, but i can find it..&#160; 

So if anyone can help me out a bit, would be great. 

&#160;

I&#8217;ve tested with the forwarded_for options tried all options here.

<A HREF="http://www.squid-cache.org/Versions/v3/3.5/cfgman/forwarded_for.html">http://www.squid-cache.org/Versions/v3/3.5/cfgman/forwarded_for.html</A> 

&#160;

im using Debian Jessie, Apache 2.4 with mod_remoteip 

<A HREF="http://httpd.apache.org/docs/current/mod/mod_remoteip.html#remoteipheader">http://httpd.apache.org/docs/current/mod/mod_remoteip.html#remoteipheader</A> 

&#160;

My settings for remoteip &#160;&#160;( and yes the modules is enabled ) 

a2query -m | grep remote

remoteip (enabled by site administrator)

&#160;

&lt;IfModule mod_remoteip&gt;

&#160;&#160;&#160; # for remote proxy setup

&#160;&#160;&#160; RemoteIPHeader X-Forwarded-For

&#160;&#160;&#160; # for cluster setup

&#160;&#160;&#160; #RemoteIPHeader X-Real-IP

&#160;

&#160;&#160;&#160; RemoteIPTrustedProxy 127.0.0.1/8

&#160;&#160;&#160; RemoteIPTrustedProxy 192.168.x.x/24

&#160;&#160;&#160; RemoteIPTrustedProxy 192.168.x.x/24

&#160;&#160;&#160; RemoteIPTrustedProxy prxy1.internal.domain.tld

&#160;&#160;&#160; RemoteIPTrustedProxy prxy2.internal.domain.tld

&#160;

#original : LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combined

LogFormat &quot;%a %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combined

&#160;

&lt;/IfModule&gt;

&#160;

&#160;

any tips on howto debug this, i did find lots of things with google, but none worked for me. 

&#160;

This is my (sanitized)&#160; squid config, default values are not shown. 

Any improvement tips are welkom&#160; ;-) but my bigest problem now is getting the ip of the client in my webserver logs. 

&#160;

Greetz, 

&#160;

Louis 

&#160;

&#160;

# squid 3.5.12 config

auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth -d \

&#160;&#160;&#160; --kerberos /usr/lib/squid/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">prxy1.internal.domain.tld at REALM</A> \

&#160;&#160;&#160; --ntlm /usr/bin/ntlm_auth --helper-protocol=gss-spnego --domain=NTDOMAIN

auth_param negotiate children 50 startup=10 idle=1

auth_param negotiate keep_alive on

&#160;

auth_param basic program /usr/lib/squid/basic_ldap_auth -R \

&#160;&#160;&#160; -b &quot;ou=domain,dc=internal,dc=domain,dc=tld&quot; \

&#160;&#160;&#160; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">changed_to_protect_myself at internal.domain.tld</A> -W /etc/squid/private/ldap-bind \

&#160;&#160;&#160; -f (sAMAccountName=%s) \

&#160;&#160;&#160; -h dc2.internal.domain.tld \

&#160;&#160;&#160; -h dc1.internal.domain.tld

auth_param basic children 5 startup=5 idle=1

auth_param basic realm Internet Proxy Autorisation

auth_param basic credentialsttl 2 hours

&#160;

authenticate_cache_garbage_interval 2 hour

authenticate_ttl 2 hour

authenticate_ip_ttl 2 hour

&#160;

# ACCESS CONTROLS

# -----------------------------------------------------------------------------

acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network range

acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly plugged) machines

&#160;

## PC Networks

acl localnet src 192.168.XXX.0/24

acl localnet src 10.XXX.0.0/24

acl localnet src 10.XXX.1.0/24

acl localnet src 10.XXX.2.0/24

acl localnet src 10.XXX.3.0/24

acl localnet src 10.XXX.4.0/24

&#160;

## Per location/function networks

acl localnet-funct1 src 192.168.XXX.0/24

acl localnet-funct2 src 10.XXX.0.0/24

acl localnet-funct3 src 10.XXX.1.0/24

acl localnet-funct4 src 10.XXX.2.0/24

acl localnet-funct5 src 10.XXX.3.0/24

acl localnet-funct6 src 10.XXX.4.0/24

acl localnet-funct7 src 10.XXX.210.0/24

acl localnet-funct8 src 172.20.XXX.0/24

&#160;

acl localnet-funct1-server-range src 192.168.XXX.XXX-192.168.XXX.XXX

acl localnet-funct1-mailhopper src 192.168.XXX.XXX

acl localnet-funct1-antivirus src 192.168.XXX.XXX

acl localnet-funct1-xen1 src 192.168.XXX.XXX

acl localnet-funct1-gateway src 192.168.XXX.XXX

acl localnet-funct1-mail1 src 192.168.XXX.XXX

acl localnet-funct1-lin-228 src 192.168.XXX.XXX

acl localnet-funct1-lin-009 src 192.168.XXX.XXX

acl localnet-funct1-monitoring src 192.168.XXX.XXX

acl localnet-funct1-lin-003 src 192.168.XXX.XXX

&#160;

## acl time frames.

acl work-ochtend time MTWHF 08:15-11:59

acl work-pauze time MTWHF 12:00-13:30

acl work-middag time MTWHF 13:31-17:00

acl after-work-hours time MTWHF 17:01-23:59

acl before-work-hours time MTWHF 00:00-08:14

&#160;

######Block Video Streaming##############

acl media rep_mime_type video/flv video/x-flv

acl media rep_mime_type -i ^video/

acl media rep_mime_type -i ^video\/

acl media rep_mime_type ^application/x-shockwave-flash

acl media rep_mime_type ^application/vnd.ms.wms-hdr.asfv1

acl media rep_mime_type ^application/x-fcs

acl media rep_mime_type ^application/x-mms-framed

acl media rep_mime_type ^video/x-ms-asf

acl media rep_mime_type ^audio/mpeg

acl media rep_mime_type ^audio/x-scpls

acl media rep_mime_type ^video/x-flv

acl media rep_mime_type ^video/mp2t

acl media rep_mime_type ^video/mpeg4

acl media rep_mime_type ms-hdr

acl media rep_mime_type x-fcs

&#160;

acl mediapr urlpath_regex \.flv(\?.*)?$

acl mediapr urlpath_regex -i \.(avi|mp4|mov|m4v|mkv|flv)(\?.*)?$

acl mediapr urlpath_regex -i \.(mpg|mpeg|avi|mov|flv|wmv|mkv|rmvb|ts|)(\?.*)?$

&#160;

acl whitelistsites url_regex -i &quot;/etc/squid/acl/domain-customer-sites.txt&quot;

acl whitelistsites url_regex -i &quot;/etc/squid/acl/allowed-sites.txt&quot;

acl whitelistdirect url_regex -i &quot;/etc/squid/acl/allowed-direct-sites.txt&quot;

&#160;

acl ads dstdom_regex &quot;/etc/squid/acl/blocked-ads-company.txt&quot;

acl blockedsites dstdom_regex -i &quot;/etc/squid/acl/blocked-sites.txt&quot;

&#160;

acl allow_client_mac arp &quot;/etc/squid/acl/allow-arp-client.txt&quot;

&#160;

acl downloaders rep_mime_type -i ^application/x-nzb$

&#160;

acl lan-domainname dstdomain .internal.domain.tld

acl lan-domainname dstdomain .internal2.domain.tld

acl lan-domainname dstdomain .internal3.domain.tld

acl lan-domainname dstdomain .internal4.domain.tld

acl lan-domainname dstdomain .internal5.domain.tld

acl lan-domainname dstdomain .internal6.domain.tld

acl wan-domainname dstdomain .domain.tld

&#160;

acl windowsupdate dstdomain windowsupdate.microsoft.com

acl windowsupdate dstdomain .update.microsoft.com

acl windowsupdate dstdomain download.windowsupdate.com

acl windowsupdate dstdomain redir.metaservices.microsoft.com

acl windowsupdate dstdomain images.metaservices.microsoft.com

acl windowsupdate dstdomain c.microsoft.com

acl windowsupdate dstdomain www.download.windowsupdate.com

acl windowsupdate dstdomain wustat.windows.com

acl windowsupdate dstdomain crl.microsoft.com

acl windowsupdate dstdomain sls.microsoft.com

acl windowsupdate dstdomain productactivation.one.microsoft.com

acl windowsupdate dstdomain ntservicepack.microsoft.com

acl windowsupdate dstdomain au.download.windowsupdate.com

acl windowsupdate dstdomain ds.download.windowsupdate.com

acl windowsupdate dstdomain ctldl.windowsupdate.com

acl windowsupdate dstdomain .data.microsoft.com

&#160;

acl antivirusupdate dstdomain .trendmicro.com

acl antivirusupdate dstdomain safebrowsing.google.com

acl antivirusupdate dstdomain safebrowsing-cache.google.com

&#160;

acl wuCONNECT dstdomain www.update.microsoft.com

acl wuCONNECT dstdomain sls.microsoft.com

&#160;

## SSL PORTS ( you need to define ssl ports also at Safe_ports )

acl SSL_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https

acl SSL_ports port 631&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # cups

acl SSL_ports port 888&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # 3dm raid manager

acl SSL_ports port 2812&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # Monit

acl SSL_ports port 5225&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # HP Toolbox

acl SSL_ports port 8000&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ?

acl SSL_ports port 8080&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ?

acl SSL_ports port 16384-16403&#160; # iChat AV (Audio-RTP, RTCP; Video-RTP, RTCP)

&#160;

acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp

acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http

acl Safe_ports port 70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gopher

acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https

acl Safe_ports port 210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # wais

acl Safe_ports port 280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt

acl Safe_ports port 488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gss-http

acl Safe_ports port 591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # filemaker

acl Safe_ports port 631&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # cups

acl Safe_ports port 667&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # darkstat

acl Safe_ports port 777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # multiling http

acl Safe_ports port 888&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # 3dm raid manager

acl Safe_ports port 8000&#160;&#160;&#160;&#160;&#160; &#160;&#160;# ?

acl Safe_ports port 8080&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ?

acl Safe_ports port 16384-16403 # iChat AV (Audio-RTP, RTCP; Video-RTP, RTCP)

#acl Safe_ports port 1025-65535&#160; # unregistered ports

&#160;

acl CONNECT method CONNECT

http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports

&#160;

# Only allow cachemgr access from localhost

http_access allow localhost manager

http_access deny manager

&#160;

http_access deny to_localhost

&#160;

#

# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS

#

&#160;

## BEFORE AUTH : bypass autorisation ( windows updates/antivirus )

http_access allow CONNECT wuCONNECT localnet

http_access allow windowsupdate localnet

http_access allow antivirusupdate localnet

&#160;

## Deny blocked sites first.

http_access deny blockedsites

&#160;

## Deny Ads servers

http_access deny ads

deny_info TCP_RESET ads

&#160;

#### Override rules for internal use

http_access allow localnet-funct1-server-range

http_access allow localnet-funct2

http_access allow lan-domainname localnet

http_access allow wan-domainname localnet

http_access allow whitelistdirect localnet

&#160;

&#160;

###############################################################################

## AUTH HERE

http_access allow authenticated

###############################################################################

&#160;

##########Access Lists VIDEO STREAMS #########

http_access allow mediapr allow_client_mac

http_reply_access allow media allow_client_mac

http_access deny mediapr

http_reply_access deny media

&#160;

################################## other rules.

# whitelisted sites

http_access allow whitelistsites

&#160;

# Example rule allowing access from your local networks.

# Adapt localnet in the ACL section to list your (internal) IP networks

# from where browsing should be allowed

http_access allow localnet

&#160;

# And finally deny all other access to this proxy

http_access deny all

&#160;

## iptables port 80 redirect to 3128

http_port 192.168.XXX.XXX:3128 intercept connection-auth=off

## company default port set by GPO (must use hostname.internal.domain.tld for kerberos auth )

http_port 192.168.XXX.XXX:8080

&#160;

cache_mem 65536 MB

maximum_object_size_in_memory 5 MB

&#160;

coredump_dir /var/spool/squid

&#160;

# disable cache_log

cache_log /dev/null

## obligated setting for disableing cache_log

logfile_rotate 0

&#160;

ftp_user <A HREF="https://lists.squid-cache.org/listinfo/squid-users">anonymousftp at domain.tld</A>

pinger_enable off

&#160;

# OPTIONS FOR TUNING THE CACHE

# -----------------------------------------------------------------------------

#cache deny localnet-funct3

#cache deny localnet-funct2

&#160;

## order is important, first one hit is used.

## windows cache

refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 129600 reload-into-ims

refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 129600 reload-into-ims

refresh_pattern -i windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 129600 reload-into-ims

&#160;

# debian cache

refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Packages\.(bz2|gz|diff/Index">tp://.*debian.*/Packages\.(bz2|gz|diff/Index</A>)$&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0

refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Release(\.gpg">tp://.*debian.*/Release(\.gpg</A>)?$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0

refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Sources\.(bz2|gz|diff/Index">tp://.*debian.*/Sources\.(bz2|gz|diff/Index</A>)$&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0

refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Translation-en_GB\.bz2">tp://.*debian.*/Translation-en_GB\.bz2</A>)$&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0

&#160;

# Add any of your own refresh_pattern entries above these.

refresh_pattern ^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 10080

refresh_pattern ^gopher:&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 1440

refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0

refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 4320

&#160;

# range-offset

range_offset_limit 800 MB windowsupdate

range_offset_limit 100 MB antivirusupdate

&#160;

quick_abort_min -1

forward_timeout 1 minutes

connect_timeout 5 seconds

&#160;

cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">webmaster at domain.tld</A>

mail_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">prxy1 at internal.domain.tld</A>

visible_hostname prxy1.internal.domain.tld

hostname_aliases prxy1.internal.domain.tld

httpd_suppress_version_string on

&#160;

snmp_port 3401

snmp_access allow localnet-funct1-monitoring

snmp_access deny all

snmp_incoming_address 192.168.XXX.XXX

icp_port 3130

htcp_port 4827

udp_incoming_address 192.168.XXX.XXX

error_default_language nl

err_page_stylesheet /etc/squid/errorpage.css

&#160;

always_direct allow CONNECT

&#160;

# ICAP OPTIONS

# -----------------------------------------------------------------------------

## Tested with Squid 3.5.10/3.5.12 squidclamav 6.14

icap_enable on

icap_send_client_ip on

icap_send_client_username on

icap_client_username_header X-Authenticated-User

icap_persistent_connections on

icap_preview_enable on

icap_preview_size 1024

icap_service service_req reqmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>

adaptation_access service_req allow all

icap_service service_resp respmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>

adaptation_access service_resp allow all

&#160;

dns_v4_first on

fqdncache_size 2048

memory_pools on

memory_pools_limit 512 MB

&#160;

forwarded_for on

&#160;

refresh_all_ims on

reload_into_ims on

&#160;

workers 8

&#160;

&#160;

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160128/0fb04675/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160128/0fb04675/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008907.html">[squid-users] Help - Squid for windows - Configuring upstream proxy with Active Directory authentication details
</A></li>
	<LI>Next message (by thread): <A HREF="008910.html">[squid-users] forwarded_for problems log client ip apache 2.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8909">[ date ]</a>
              <a href="thread.html#8909">[ thread ]</a>
              <a href="subject.html#8909">[ subject ]</a>
              <a href="author.html#8909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
