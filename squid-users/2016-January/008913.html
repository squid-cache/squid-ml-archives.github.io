<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forwarded_for problems log client ip apache 2.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forwarded_for%20problems%20log%20client%20ip%20apache%202.4&In-Reply-To=%3C56AAB463.9040306%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008910.html">
   <LINK REL="Next"  HREF="008919.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forwarded_for problems log client ip apache 2.4</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forwarded_for%20problems%20log%20client%20ip%20apache%202.4&In-Reply-To=%3C56AAB463.9040306%40ngtech.co.il%3E"
       TITLE="[squid-users] forwarded_for problems log client ip apache 2.4">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Jan 29 00:37:55 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008910.html">[squid-users] forwarded_for problems log client ip apache 2.4
</A></li>
        <LI>Next message (by thread): <A HREF="008919.html">[squid-users] forwarded_for problems log client ip apache 2.4 (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8913">[ date ]</a>
              <a href="thread.html#8913">[ thread ]</a>
              <a href="subject.html#8913">[ subject ]</a>
              <a href="author.html#8913">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

It is off-topic but I do have a setup that works with this and it 
depends on couple things.
The first thing is that if it's not clear to me how you use the squid 
and the apache services together.
You squid.conf shows two ports that both are in forward mode rather then 
reverse mode which the setup would be pretty different by the proxy 
functionality.

The basic scenario that the proxy provides a Forwarded-For header is 
when it is when it has someone to inform about it such as internal 
service or a reverse proxy.
When it's a parent or sibling proxy then the forwarded_for option should 
be in &quot;on&quot; mode. Just notice that if you have some WAN connection in the 
middle then without an HTTPS secured connection it would probably be 
meaningless for a service unless it has a specific set of IP addresses 
that it trusts.(unless the service has a reverse or forward dns 
resolution mechanism that will &quot;automatically&quot; add\identify origin 
sources by the domain name A\AAAA\CNAME records)

Currently squid doesn't have the option to use some ACLs in order to 
decide to who\what he will send the forwarded-for headers which might be 
important in use cases like I think yours is.
Basically based on the assumption that this proxy doesn't have any child 
proxy services the right way to implement the forwarded-for is using the 
&quot;truncate&quot; and not the &quot;on&quot; option to avoid any sort of ip 
impersonations.(since any client can add &quot;X-Forwarded-For: X.Y.Z.I&quot; to 
the request).

As for the apache remote_ip module and squid it is very simple to test, 
a simple tcpdump on the proxy or the apache server with some filters 
will show you what is on the wire and what the apache server receives.

The main question is what you do see in your apache logs and what you 
expect to appear in them?
I can lend you my working remoteip modules settings:
RemoteIPHeader X-Forwarded-For
RemoteIPInternalProxy 192.168.10.10

 From the docs at:
- 
<A HREF="https://httpd.apache.org/docs/trunk/mod/mod_remoteip.html#remoteiptrustedproxy">https://httpd.apache.org/docs/trunk/mod/mod_remoteip.html#remoteiptrustedproxy</A>
- 
<A HREF="https://httpd.apache.org/docs/trunk/mod/mod_remoteip.html#remoteipinternalproxy">https://httpd.apache.org/docs/trunk/mod/mod_remoteip.html#remoteipinternalproxy</A>

I assume that you are wrongly using the
&quot;RemoteIPTrustedProxy&quot; directive to trust this proxy about internal 10/8 
192.168/16 etc addresses spaces which it cannot(as documented).

So my suggestion is to try the &quot;RemoteIPInternalProxy&quot; instead of 
&quot;RemoteIPTrustedProxy&quot;.

Notice that remote_ip is IP related module and will not result in 
reporting any sort of domain name in the access logs, resulting in such 
log format will be an apache log related subject which I have never used.

Currently the log format I am using in apache is:
LogFormat &quot;%a %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot; 
%v&quot; combined_vhost

Which will show the remote_ip module resolved IP address and will report 
the target vhost in the end of the log line so it won't break some log 
parsing tools.

All The Bests,
Eliezer

* I wrote this long email partially as documentation of the subject for 
later use in searches.

On 28/01/2016 15:38, L.P.H. van Belle wrote:
&gt;<i> Hai,
</I>&gt;<i>
</I>&gt;<i> I having some troubles to get my client ip (and/or hostname) logged in
</I>&gt;<i> my apache webserver.
</I>&gt;<i>
</I>&gt;<i> I do think this is something in my squid setup, but i can find it..
</I>&gt;<i>
</I>&gt;<i> So if anyone can help me out a bit, would be great.
</I>&gt;<i>
</I>&gt;<i> I&#8217;ve tested with the forwarded_for options tried all options here.
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Versions/v3/3.5/cfgman/forwarded_for.html">http://www.squid-cache.org/Versions/v3/3.5/cfgman/forwarded_for.html</A>
</I>&gt;<i>
</I>&gt;<i> im using Debian Jessie, Apache 2.4 with mod_remoteip
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://httpd.apache.org/docs/current/mod/mod_remoteip.html#remoteipheader">http://httpd.apache.org/docs/current/mod/mod_remoteip.html#remoteipheader</A>
</I>&gt;<i>
</I>&gt;<i> My settings for remoteip   ( and yes the modules is enabled )
</I>&gt;<i>
</I>&gt;<i> a2query -m | grep remote
</I>&gt;<i>
</I>&gt;<i> remoteip (enabled by site administrator)
</I>&gt;<i>
</I>&gt;<i> &lt;IfModule mod_remoteip&gt;
</I>&gt;<i>
</I>&gt;<i>      # for remote proxy setup
</I>&gt;<i>
</I>&gt;<i>      RemoteIPHeader X-Forwarded-For
</I>&gt;<i>
</I>&gt;<i>      # for cluster setup
</I>&gt;<i>
</I>&gt;<i>      #RemoteIPHeader X-Real-IP
</I>&gt;<i>
</I>&gt;<i>      RemoteIPTrustedProxy 127.0.0.1/8
</I>&gt;<i>
</I>&gt;<i>      RemoteIPTrustedProxy 192.168.x.x/24
</I>&gt;<i>
</I>&gt;<i>      RemoteIPTrustedProxy 192.168.x.x/24
</I>&gt;<i>
</I>&gt;<i>      RemoteIPTrustedProxy prxy1.internal.domain.tld
</I>&gt;<i>
</I>&gt;<i>      RemoteIPTrustedProxy prxy2.internal.domain.tld
</I>&gt;<i>
</I>&gt;<i> #original : LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%{Referer}i\&quot;
</I>&gt;<i> \&quot;%{User-Agent}i\&quot;&quot; combined
</I>&gt;<i>
</I>&gt;<i> LogFormat &quot;%a %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot;
</I>&gt;<i> combined
</I>&gt;<i>
</I>&gt;<i> &lt;/IfModule&gt;
</I>&gt;<i>
</I>&gt;<i> any tips on howto debug this, i did find lots of things with google, but
</I>&gt;<i> none worked for me.
</I>&gt;<i>
</I>&gt;<i> This is my (sanitized)  squid config, default values are not shown.
</I>&gt;<i>
</I>&gt;<i> Any improvement tips are welkom  ;-) but my bigest problem now is
</I>&gt;<i> getting the ip of the client in my webserver logs.
</I>&gt;<i>
</I>&gt;<i> Greetz,
</I>&gt;<i>
</I>&gt;<i> Louis
</I>&gt;<i>
</I>&gt;<i> # squid 3.5.12 config
</I>&gt;<i>
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth -d \
</I>&gt;<i>
</I>&gt;<i>      --kerberos /usr/lib/squid/negotiate_kerberos_auth -s
</I>&gt;<i> HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">prxy1.internal.domain.tld at REALM</A> \
</I>&gt;<i>
</I>&gt;<i>      --ntlm /usr/bin/ntlm_auth --helper-protocol=gss-spnego
</I>&gt;<i> --domain=NTDOMAIN
</I>&gt;<i>
</I>&gt;<i> auth_param negotiate children 50 startup=10 idle=1
</I>&gt;<i>
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i>
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ldap_auth -R \
</I>&gt;<i>
</I>&gt;<i>      -b &quot;ou=domain,dc=internal,dc=domain,dc=tld&quot; \
</I>&gt;<i>
</I>&gt;<i>      -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">changed_to_protect_myself at internal.domain.tld</A> -W
</I>&gt;<i> /etc/squid/private/ldap-bind \
</I>&gt;<i>
</I>&gt;<i>      -f (sAMAccountName=%s) \
</I>&gt;<i>
</I>&gt;<i>      -h dc2.internal.domain.tld \
</I>&gt;<i>
</I>&gt;<i>      -h dc1.internal.domain.tld
</I>&gt;<i>
</I>&gt;<i> auth_param basic children 5 startup=5 idle=1
</I>&gt;<i>
</I>&gt;<i> auth_param basic realm Internet Proxy Autorisation
</I>&gt;<i>
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i>
</I>&gt;<i> authenticate_cache_garbage_interval 2 hour
</I>&gt;<i>
</I>&gt;<i> authenticate_ttl 2 hour
</I>&gt;<i>
</I>&gt;<i> authenticate_ip_ttl 2 hour
</I>&gt;<i>
</I>&gt;<i> # ACCESS CONTROLS
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> -----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i>
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i>
</I>&gt;<i> ## PC Networks
</I>&gt;<i>
</I>&gt;<i> acl localnet src 192.168.XXX.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet src 10.XXX.0.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet src 10.XXX.1.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet src 10.XXX.2.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet src 10.XXX.3.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet src 10.XXX.4.0/24
</I>&gt;<i>
</I>&gt;<i> ## Per location/function networks
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1 src 192.168.XXX.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct2 src 10.XXX.0.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct3 src 10.XXX.1.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct4 src 10.XXX.2.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct5 src 10.XXX.3.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct6 src 10.XXX.4.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct7 src 10.XXX.210.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct8 src 172.20.XXX.0/24
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-server-range src 192.168.XXX.XXX-192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-mailhopper src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-antivirus src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-xen1 src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-gateway src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-mail1 src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-lin-228 src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-lin-009 src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-monitoring src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> acl localnet-funct1-lin-003 src 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> ## acl time frames.
</I>&gt;<i>
</I>&gt;<i> acl work-ochtend time MTWHF 08:15-11:59
</I>&gt;<i>
</I>&gt;<i> acl work-pauze time MTWHF 12:00-13:30
</I>&gt;<i>
</I>&gt;<i> acl work-middag time MTWHF 13:31-17:00
</I>&gt;<i>
</I>&gt;<i> acl after-work-hours time MTWHF 17:01-23:59
</I>&gt;<i>
</I>&gt;<i> acl before-work-hours time MTWHF 00:00-08:14
</I>&gt;<i>
</I>&gt;<i> ######Block Video Streaming##############
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type video/flv video/x-flv
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type -i ^video/
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type -i ^video\/
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^application/x-shockwave-flash
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^application/vnd.ms.wms-hdr.asfv1
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^application/x-fcs
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^application/x-mms-framed
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^video/x-ms-asf
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^audio/mpeg
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^audio/x-scpls
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^video/x-flv
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^video/mp2t
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ^video/mpeg4
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type ms-hdr
</I>&gt;<i>
</I>&gt;<i> acl media rep_mime_type x-fcs
</I>&gt;<i>
</I>&gt;<i> acl mediapr urlpath_regex \.flv(\?.*)?$
</I>&gt;<i>
</I>&gt;<i> acl mediapr urlpath_regex -i \.(avi|mp4|mov|m4v|mkv|flv)(\?.*)?$
</I>&gt;<i>
</I>&gt;<i> acl mediapr urlpath_regex -i
</I>&gt;<i> \.(mpg|mpeg|avi|mov|flv|wmv|mkv|rmvb|ts|)(\?.*)?$
</I>&gt;<i>
</I>&gt;<i> acl whitelistsites url_regex -i &quot;/etc/squid/acl/domain-customer-sites.txt&quot;
</I>&gt;<i>
</I>&gt;<i> acl whitelistsites url_regex -i &quot;/etc/squid/acl/allowed-sites.txt&quot;
</I>&gt;<i>
</I>&gt;<i> acl whitelistdirect url_regex -i &quot;/etc/squid/acl/allowed-direct-sites.txt&quot;
</I>&gt;<i>
</I>&gt;<i> acl ads dstdom_regex &quot;/etc/squid/acl/blocked-ads-company.txt&quot;
</I>&gt;<i>
</I>&gt;<i> acl blockedsites dstdom_regex -i &quot;/etc/squid/acl/blocked-sites.txt&quot;
</I>&gt;<i>
</I>&gt;<i> acl allow_client_mac arp &quot;/etc/squid/acl/allow-arp-client.txt&quot;
</I>&gt;<i>
</I>&gt;<i> acl downloaders rep_mime_type -i ^application/x-nzb$
</I>&gt;<i>
</I>&gt;<i> acl lan-domainname dstdomain .internal.domain.tld
</I>&gt;<i>
</I>&gt;<i> acl lan-domainname dstdomain .internal2.domain.tld
</I>&gt;<i>
</I>&gt;<i> acl lan-domainname dstdomain .internal3.domain.tld
</I>&gt;<i>
</I>&gt;<i> acl lan-domainname dstdomain .internal4.domain.tld
</I>&gt;<i>
</I>&gt;<i> acl lan-domainname dstdomain .internal5.domain.tld
</I>&gt;<i>
</I>&gt;<i> acl lan-domainname dstdomain .internal6.domain.tld
</I>&gt;<i>
</I>&gt;<i> acl wan-domainname dstdomain .domain.tld
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain windowsupdate.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain .update.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain download.windowsupdate.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain redir.metaservices.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain images.metaservices.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain c.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain www.download.windowsupdate.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain wustat.windows.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain crl.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain sls.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain productactivation.one.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain ntservicepack.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain au.download.windowsupdate.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain ds.download.windowsupdate.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain ctldl.windowsupdate.com
</I>&gt;<i>
</I>&gt;<i> acl windowsupdate dstdomain .data.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl antivirusupdate dstdomain .trendmicro.com
</I>&gt;<i>
</I>&gt;<i> acl antivirusupdate dstdomain safebrowsing.google.com
</I>&gt;<i>
</I>&gt;<i> acl antivirusupdate dstdomain safebrowsing-cache.google.com
</I>&gt;<i>
</I>&gt;<i> acl wuCONNECT dstdomain www.update.microsoft.com
</I>&gt;<i>
</I>&gt;<i> acl wuCONNECT dstdomain sls.microsoft.com
</I>&gt;<i>
</I>&gt;<i> ## SSL PORTS ( you need to define ssl ports also at Safe_ports )
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443          # https
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 631          # cups
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 888          # 3dm raid manager
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 2812         # Monit
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 5225         # HP Toolbox
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 8000         # ?
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 8080         # ?
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 16384-16403  # iChat AV (Audio-RTP, RTCP; Video-RTP,
</I>&gt;<i> RTCP)
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 631         # cups
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 667         # darkstat
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 888         # 3dm raid manager
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 8000        # ?
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 8080        # ?
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 16384-16403 # iChat AV (Audio-RTP, RTCP; Video-RTP,
</I>&gt;<i> RTCP)
</I>&gt;<i>
</I>&gt;<i> #acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i>
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i>
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i>
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> ## BEFORE AUTH : bypass autorisation ( windows updates/antivirus )
</I>&gt;<i>
</I>&gt;<i> http_access allow CONNECT wuCONNECT localnet
</I>&gt;<i>
</I>&gt;<i> http_access allow windowsupdate localnet
</I>&gt;<i>
</I>&gt;<i> http_access allow antivirusupdate localnet
</I>&gt;<i>
</I>&gt;<i> ## Deny blocked sites first.
</I>&gt;<i>
</I>&gt;<i> http_access deny blockedsites
</I>&gt;<i>
</I>&gt;<i> ## Deny Ads servers
</I>&gt;<i>
</I>&gt;<i> http_access deny ads
</I>&gt;<i>
</I>&gt;<i> deny_info TCP_RESET ads
</I>&gt;<i>
</I>&gt;<i> #### Override rules for internal use
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet-funct1-server-range
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet-funct2
</I>&gt;<i>
</I>&gt;<i> http_access allow lan-domainname localnet
</I>&gt;<i>
</I>&gt;<i> http_access allow wan-domainname localnet
</I>&gt;<i>
</I>&gt;<i> http_access allow whitelistdirect localnet
</I>&gt;<i>
</I>&gt;<i> ###############################################################################
</I>&gt;<i>
</I>&gt;<i> ## AUTH HERE
</I>&gt;<i>
</I>&gt;<i> http_access allow authenticated
</I>&gt;<i>
</I>&gt;<i> ###############################################################################
</I>&gt;<i>
</I>&gt;<i> ##########Access Lists VIDEO STREAMS #########
</I>&gt;<i>
</I>&gt;<i> http_access allow mediapr allow_client_mac
</I>&gt;<i>
</I>&gt;<i> http_reply_access allow media allow_client_mac
</I>&gt;<i>
</I>&gt;<i> http_access deny mediapr
</I>&gt;<i>
</I>&gt;<i> http_reply_access deny media
</I>&gt;<i>
</I>&gt;<i> ################################## other rules.
</I>&gt;<i>
</I>&gt;<i> # whitelisted sites
</I>&gt;<i>
</I>&gt;<i> http_access allow whitelistsites
</I>&gt;<i>
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i>
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i>
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i>
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> ## iptables port 80 redirect to 3128
</I>&gt;<i>
</I>&gt;<i> http_port 192.168.XXX.XXX:3128 intercept connection-auth=off
</I>&gt;<i>
</I>&gt;<i> ## company default port set by GPO (must use
</I>&gt;<i> hostname.internal.domain.tld for kerberos auth )
</I>&gt;<i>
</I>&gt;<i> http_port 192.168.XXX.XXX:8080
</I>&gt;<i>
</I>&gt;<i> cache_mem 65536 MB
</I>&gt;<i>
</I>&gt;<i> maximum_object_size_in_memory 5 MB
</I>&gt;<i>
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i>
</I>&gt;<i> # disable cache_log
</I>&gt;<i>
</I>&gt;<i> cache_log /dev/null
</I>&gt;<i>
</I>&gt;<i> ## obligated setting for disableing cache_log
</I>&gt;<i>
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i>
</I>&gt;<i> ftp_user <A HREF="https://lists.squid-cache.org/listinfo/squid-users">anonymousftp at domain.tld</A>
</I>&gt;<i>
</I>&gt;<i> pinger_enable off
</I>&gt;<i>
</I>&gt;<i> # OPTIONS FOR TUNING THE CACHE
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> -----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> #cache deny localnet-funct3
</I>&gt;<i>
</I>&gt;<i> #cache deny localnet-funct2
</I>&gt;<i>
</I>&gt;<i> ## order is important, first one hit is used.
</I>&gt;<i>
</I>&gt;<i> ## windows cache
</I>&gt;<i>
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320
</I>&gt;<i> 80% 129600 reload-into-ims
</I>&gt;<i>
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80%
</I>&gt;<i> 129600 reload-into-ims
</I>&gt;<i>
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80%
</I>&gt;<i> 129600 reload-into-ims
</I>&gt;<i>
</I>&gt;<i> # debian cache
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Packages\.(bz2|gz|diff/Index">tp://.*debian.*/Packages\.(bz2|gz|diff/Index</A>)$
</I>&gt;<i> 0       0%      0
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Release(\.gpg">tp://.*debian.*/Release(\.gpg</A>)?$
</I>&gt;<i> 0       0%      0
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Sources\.(bz2|gz|diff/Index">tp://.*debian.*/Sources\.(bz2|gz|diff/Index</A>)$
</I>&gt;<i> 0       0%      0
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^(ht|f)<A HREF="tp://.*debian.*/Translation-en_GB\.bz2">tp://.*debian.*/Translation-en_GB\.bz2</A>)$
</I>&gt;<i> 0       0%      0
</I>&gt;<i>
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i>
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i>
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i>
</I>&gt;<i> # range-offset
</I>&gt;<i>
</I>&gt;<i> range_offset_limit 800 MB windowsupdate
</I>&gt;<i>
</I>&gt;<i> range_offset_limit 100 MB antivirusupdate
</I>&gt;<i>
</I>&gt;<i> quick_abort_min -1
</I>&gt;<i>
</I>&gt;<i> forward_timeout 1 minutes
</I>&gt;<i>
</I>&gt;<i> connect_timeout 5 seconds
</I>&gt;<i>
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">webmaster at domain.tld</A>
</I>&gt;<i>
</I>&gt;<i> mail_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">prxy1 at internal.domain.tld</A>
</I>&gt;<i>
</I>&gt;<i> visible_hostname prxy1.internal.domain.tld
</I>&gt;<i>
</I>&gt;<i> hostname_aliases prxy1.internal.domain.tld
</I>&gt;<i>
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i>
</I>&gt;<i> snmp_port 3401
</I>&gt;<i>
</I>&gt;<i> snmp_access allow localnet-funct1-monitoring
</I>&gt;<i>
</I>&gt;<i> snmp_access deny all
</I>&gt;<i>
</I>&gt;<i> snmp_incoming_address 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> icp_port 3130
</I>&gt;<i>
</I>&gt;<i> htcp_port 4827
</I>&gt;<i>
</I>&gt;<i> udp_incoming_address 192.168.XXX.XXX
</I>&gt;<i>
</I>&gt;<i> error_default_language nl
</I>&gt;<i>
</I>&gt;<i> err_page_stylesheet /etc/squid/errorpage.css
</I>&gt;<i>
</I>&gt;<i> always_direct allow CONNECT
</I>&gt;<i>
</I>&gt;<i> # ICAP OPTIONS
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> -----------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> ## Tested with Squid 3.5.10/3.5.12 squidclamav 6.14
</I>&gt;<i>
</I>&gt;<i> icap_enable on
</I>&gt;<i>
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i>
</I>&gt;<i> icap_send_client_username on
</I>&gt;<i>
</I>&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;<i>
</I>&gt;<i> icap_persistent_connections on
</I>&gt;<i>
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i>
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i>
</I>&gt;<i> icap_service service_req reqmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i>
</I>&gt;<i> adaptation_access service_req allow all
</I>&gt;<i>
</I>&gt;<i> icap_service service_resp respmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i>
</I>&gt;<i> adaptation_access service_resp allow all
</I>&gt;<i>
</I>&gt;<i> dns_v4_first on
</I>&gt;<i>
</I>&gt;<i> fqdncache_size 2048
</I>&gt;<i>
</I>&gt;<i> memory_pools on
</I>&gt;<i>
</I>&gt;<i> memory_pools_limit 512 MB
</I>&gt;<i>
</I>&gt;<i> forwarded_for on
</I>&gt;<i>
</I>&gt;<i> refresh_all_ims on
</I>&gt;<i>
</I>&gt;<i> reload_into_ims on
</I>&gt;<i>
</I>&gt;<i> workers 8
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008910.html">[squid-users] forwarded_for problems log client ip apache 2.4
</A></li>
	<LI>Next message (by thread): <A HREF="008919.html">[squid-users] forwarded_for problems log client ip apache 2.4 (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8913">[ date ]</a>
              <a href="thread.html#8913">[ thread ]</a>
              <a href="subject.html#8913">[ subject ]</a>
              <a href="author.html#8913">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
