<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.13%20transparent%20compiling%20fails%20with%0A%20ubuntu%2014.04%20server&In-Reply-To=%3Cvmime.56ab6872.2cc6.7c99af1e4db7da92%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008924.html">
   <LINK REL="Next"  HREF="008926.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.13%20transparent%20compiling%20fails%20with%0A%20ubuntu%2014.04%20server&In-Reply-To=%3Cvmime.56ab6872.2cc6.7c99af1e4db7da92%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server">belle at bazuin.nl
       </A><BR>
    <I>Fri Jan 29 13:26:10 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="008924.html">[squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server
</A></li>
        <LI>Next message (by thread): <A HREF="008926.html">[squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8925">[ date ]</a>
              <a href="thread.html#8925">[ thread ]</a>
              <a href="subject.html#8925">[ subject ]</a>
              <a href="author.html#8925">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This works on a debian Jessie, so to adapt this for ubuntu 14.04 should be simple.

Have a look whats doen here, and change it to Ubuntu. 

&#160;

I&#8217;ve put : ## CHECK THIS for Ubuntu &#160;where you need to check things for Ubuntu. 

&#160;

And with the check this, look at the version numbers and change accordingly. 

&#160;

Greetz, 

&#160;

Louis

&#160;

&#160;

#!/bin/bash

&#160;

## TEST DATE : 25-01-2016.

## a local (file) repo is setup, 

## to make squid 3.5.12 from Debian SID work on Debian Jessie, the following ## is needed.

## 1) libecap dependes on GCC 5.2, this is changed to 4.9 (Jessie version) ## (debian/control)

## 2) we added --enable-ssl , --with-open-ssl=/etc/ssl/openssl.cnf,

##&#160;&#160;&#160; --enable-linux-netfilter' to the debian/rules in squid.

## 3) the correct order of installing files is needed.

&#160;

&#160;

SETPATH=`pwd`

CURRENT_DATE=`date -R`

&#160;

function update-debs () {

cp *.deb /var/www/mydebs

cd /var/www/mydebs

dpkg-scanpackages . /dev/null | gzip -9c &gt; Packages.gz

cd $SETPATH

echo &quot;Running apt-get update, please wait.&quot;

apt-get update 2&gt; /dev/null

sleep 1

}

&#160;

&#160;

if [ ! -e /etc/apt/sources.list.d/sid.list ]; then

# adding sid repo

cat &lt;&lt; EOF &gt;&gt; /etc/apt/sources.list.d/sid.list

#

#deb <A HREF="http://ftp.nl.debian.org/debian/">http://ftp.nl.debian.org/debian/</A> sid main non-free contrib

deb-src <A HREF="http://ftp.nl.debian.org/debian/">http://ftp.nl.debian.org/debian/</A> sid main non-free contrib

EOF

else

&#160;&#160;&#160; echo &quot;sid repo already setup&quot;

fi

&#160;

&#160;

echo &quot;Updating apt-repo, please wait&quot;

apt-get update &gt;/dev/null

&#160;

if [ ! -e /etc/apt/sources.list.d/localrepo.list ]; then

# adding local repo ( webserver based )

cat &lt;&lt; EOF &gt;&gt; /etc/apt/sources.list.d/localrepo.list

#

# change if you done have a webserver.

deb file:/var/www/mydebs ./

#deb <A HREF="http://localhost/mydebs/">http://localhost/mydebs/</A> ./

EOF

else

&#160;&#160;&#160; echo &quot;local repo already setup&quot;

fi

&#160;

&#160;

if [ ! -e /var/www/mydebs ]; then

# get dependes, sources and build sources, setup local apt.

mkdir -p&#160; /var/www/mydebs

apt-get install dpkg-dev -y

else

&#160;&#160;&#160; echo &quot;setup of /var/www/mydebs already done&quot;

fi

&#160;

### ORDER IS IMPORTANT BECAUSE OF THE DEPENDES

## C-icap

apt-get source c-icap

apt-get build-dep c-icap

apt-get source c-icap -b

update-debs

&#160;

## C-icap-modules

apt-get source c-icap-modules

apt-get build-dep c-icap-modules

apt-get source c-icap-modules -b

update-debs

&#160;

&#160;

## CHECK THIS for Ubuntu 

## Libecap

apt-get source libecap

LIBECAPVER=`ls | grep libecap| grep tar.xz | cut -d&quot;_&quot; -f2 | cut -d&quot;.&quot; -f1,2,3`

&#160;&#160;&#160; cat &lt;&lt; EOF &gt;&gt; libecap-1.0.1/debian/changelog.new

libecap (${LIBECAPVER}-custom1) unstable; urgency=medium

&#160;

&#160; * debian/control changed G++ 5.2 to G++ Jessie

&#160;&#160;&#160; - Rebuilt for debian Jessie

&#160;

&#160;-- Unknown User &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">not at existing.tld</A>&gt;&#160; ${CURRENT_DATE}

&#160;

EOF

cat libecap-1.0.1/debian/changelog &gt;&gt; libecap-1.0.1/debian/changelog.new

mv libecap-1.0.1/debian/changelog libecap-1.0.1/debian/changelog.old

mv libecap-1.0.1/debian/changelog.new libecap-1.0.1/debian/changelog

&#160;

&#160;

## CHECK THIS for Ubuntu 

echo &quot;change GCC 5.2 to Jessie G++ 4.9 in libecap-1.0.1/debian/control&quot;

sed -i 's/g++ (&gt;= 4:5.2)/g++ (&gt;= 4:4.9)/g' libecap-1.0.1/debian/control

apt-get install cdbs -y

apt-get build-dep libecap

apt-get source libecap -b

update-debs

&#160;

&#160;

## CHECK THIS for Ubuntu

## Squid

apt-get source squid

if [ `cat squid3-3.5.12/debian/rules | wc -l` -ge 1 ]; then

&#160;&#160;&#160; echo &quot;squid rules already changed&quot;

else

&#160;&#160;&#160; sed -i 's/--with-default-user=proxy/--with-default-user=proxy \\/g' squid3-3.5.12/debian/rules

&#160;&#160;&#160; sed -i '/with-default-user=proxy/a \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ --enable-ssl \\'&#160; squid3-3.5.12/debian/rules

&#160;&#160;&#160; sed -i '/enable-ssl/a \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ --with-open-ssl=/etc/ssl/openssl.cnf \\'&#160; squid3-3.5.12/debian/rules

&#160;&#160;&#160; sed -i '/with-open-ssl/a \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ --enable-linux-netfilter'&#160; squid3-3.5.12/debian/rules

&#160;&#160;&#160;&#160;&#160;&#160;&#160; SQUIDVER=`ls | grep squid| grep tar.xz | cut -d&quot;_&quot; -f2 | cut -d&quot;.&quot; -f1,2,3`

&#160;&#160;&#160; cat &lt;&lt; EOF &gt;&gt; squid3-3.5.12/debian/changelog.new

squid3 (${SQUIDVER}-custom1-ssl) unstable; urgency=medium

&#160;

&#160; * rebuild from Debian Sid to Jessie

&#160;&#160;&#160; - parameters added to debian/rules

&#160;&#160;&#160;&#160;&#160;&#160;&#160; --enable-ssl \

&#160;&#160;&#160;&#160;&#160;&#160;&#160; --with-open-ssl=/etc/ssl/openssl.cnf \

&#160;&#160;&#160;&#160;&#160;&#160;&#160; --enable-linux-netfilter

&#160;

&#160;-- Unknown User &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">not at existing.tld</A>&gt;&#160; ${CURRENT_DATE}

&#160;

EOF

&#160;&#160;&#160;&#160;&#160;&#160;&#160; cat squid3-3.5.12/debian/changelog &gt;&gt; squid3-3.5.12/debian/changelog.new

&#160;&#160;&#160;&#160;&#160;&#160;&#160; mv squid3-3.5.12/debian/changelog squid3-3.5.12/debian/changelog.old

&#160;&#160;&#160;&#160;&#160;&#160;&#160; mv squid3-3.5.12/debian/changelog.new squid3-3.5.12/debian/changelog

&#160;

fi

apt-get build-dep squid

apt-get source squid -b

update-debs

&#160;

apt-cache policy squid

&#160;

&#160;

&#160;


Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Hardik Dangar
Verzonden: vrijdag 29 januari 2016 14:06
Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Onderwerp: [squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server


&#160;

Hello,

&#160;


I am trying to build squid 3.5.13 with following options on ubuntu 14.04 freshly installed server,


&#160;


# apt-get update


&#160;


# apt-get build-dep squid3


&#160;


# apt-get install build-essential sharutils ccze libzip-dev libssl-dev



&#160;


# ./configure


--prefix=/usr


--exec-prefix=/usr


--includedir=/usr/include


--datadir=${prefix}/share/squid


--libdir=/usr/lib64


--libexecdir=${prefix}/lib/squid


--localstatedir=/var


--sysconfdir=/etc/squid


--sharedstatedir=/var/lib


--with-logdir=/var/log/squid


--with-pidfile=/var/run/squid.pid


--with-default-user=squid


--with-openssl


--enable-silent-rules


--enable-dependency-tracking&#160;


--enable-linux-netfilter


--enable-icmp


--enable-delay-pools


--enable-useragent-log


--enable-esi


--enable-follow-x-forwarded-for


--enable-ipf-transparent


--enable-ssl


--enable-ssl-crtd


--enable-auth



&#160;


I want to build https transparent proxy so i have enabled enable ipf transparent and ssl options in config.


&#160;


configure fails with option,


configure: error: unable to make IPFilter work with netinet/ headers


&#160;


$ cat config.log | grep netinet &#160; &#160;reveals,



conftest.cpp:326:25: fatal error: netinet/ipl.h: No such file or directory


&#160;


i did check iptables are installed ( $ which iptables) so netfilter should be installed too.


&#160;


article at,&#160;<A HREF="https://www.smoothnet.org/squid-v3-5-proxy-with-ssl-bump/">https://www.smoothnet.org/squid-v3-5-proxy-with-ssl-bump/</A> says i need to use hack,


#define USE_SOLARIS_IPFILTER_MINOR_T_HACK 0


&#160;


but after changing that line also result is same. i found very old squid 2.5 threads related to IPFilter compiling issue but couldn't find the code they ask to hack.


&#160;


Anyone else has faced this issue? what's the solution for this ?




-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160129/f48ed976/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160129/f48ed976/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="008924.html">[squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server
</A></li>
	<LI>Next message (by thread): <A HREF="008926.html">[squid-users] Squid 3.5.13 transparent compiling fails with ubuntu 14.04 server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8925">[ date ]</a>
              <a href="thread.html#8925">[ thread ]</a>
              <a href="subject.html#8925">[ subject ]</a>
              <a href="author.html#8925">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
