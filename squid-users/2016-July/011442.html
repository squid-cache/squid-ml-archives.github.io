<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program shows IP addresses instead of	domain name when rewriting SSL/HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%09domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3C36403f2f3f37d9aee6f1b1f6f93e2e1f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011440.html">
   <LINK REL="Next"  HREF="011479.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program shows IP addresses instead of	domain name when rewriting SSL/HTTPS</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%09domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3C36403f2f3f37d9aee6f1b1f6f93e2e1f%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program shows IP addresses instead of	domain name when rewriting SSL/HTTPS">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul  6 07:30:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011440.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="011479.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11442">[ date ]</a>
              <a href="thread.html#11442">[ thread ]</a>
              <a href="subject.html#11442">[ subject ]</a>
              <a href="author.html#11442">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2016-07-06 10:48, Moataz Elmasry wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to create a kind of captive portal when only my domain and
</I>&gt;<i> google play are whitelisted and other addresses(http/https) are
</I>&gt;<i> forwarded to my domain.
</I>&gt;<i> All http requests are landing fine in the url_rewrite program, while
</I>&gt;<i> the https requests appear as only the IP address but not the dns name.
</I>&gt;<i> I'm aware of <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A> and
</I>&gt;<i> especially the note that during ssl_bump no dns name is available yet
</I>&gt;<i> and instead one should be using the acl ssl::server_name directive,
</I>&gt;<i> but for some reason no https address is being sent to my url_rewrite
</I>&gt;<i> program.
</I>&gt;<i> 
</I>&gt;<i> The same SSL certificate used on my domain is also being used with
</I>&gt;<i> squid at https_port
</I>
&gt;<i> 
</I>&gt;<i> Here's my squid.conf
</I>&gt;<i> 
</I>&gt;<i> &quot;
</I>&gt;<i> 
</I>&gt;<i> pinger_enable off
</I>&gt;<i> acl localnet src 10.0.0.0/8 [1] # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 172.16.0.0/12 [2] # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 [3] # RFC1918 possible internal
</I>&gt;<i> network
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> acl http dstdomain play.google.com [4] mydomain.com [5]
</I>&gt;<i> acl https ssl::server_name play.google.com [4] mydomain.com [5]
</I>
This is ... weird. There is nothing in the ACL matching which would 
indicate it was HTTP vs HTTPS.

* dstdomain can match for CONNECT tunnels transferring non-HTTP traffic 
when the URI contains the domain specified. It only indicates that HTTP 
was used by the client ... except for intercepted HTTPS traffic, where 
it merely indicates that Squid itself is wrapping the inbound traffic 
into HTTP compatible format before interpreting them. Squid sometimes 
uses the TLS SNI value as the URI dstdomain.
   -&gt; unreliable.

* TLS SNI can contain the listed server name for non-HTTPS protocols.
   -&gt; unreliable.

&gt;<i> 
</I>&gt;<i> http_access allow http
</I>&gt;<i> http_access allow https
</I>
* &quot;http_access&quot; means Squid is testing whether an HTTP protocol client 
is allowed to use the proxy. The &quot;http&quot; URL contains HTTP protocol 
matching. Which is okay, but see above about what the &quot;dstdomain &quot;value 
could be.

* The &quot;https&quot; ACL contains TLS details matching - so is usually not 
possible to even test like this.

* localnet and localhost are already allowed to do anything safe by the 
earlier http_access rules. I doubt these confused matches are even 
getting used.

&gt;<i> 
</I>&gt;<i> url_rewrite_program /bin/bash -c -l /etc/squid/redirect.bash
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_access allow all !http
</I>&gt;<i> url_rewrite_access allow all !https
</I>
Several problems here:

* &quot;all&quot; is only a meaningless waste of CPU time and memory in this 
usage.

* &quot;https&quot; ACL probably is not possible to match. Rewriting of the *HTTP* 
URL is a HTTP decision. Not TLS.

* The use of negation (!) means you have expicitly configured Squid 
*not* to send any lookups to the helper when the ACL listed domain 
name(s) are present in the HTTP request.
  So you were asking why no requests with the domain name show up in the 
helper?
  Squid is obeying your explicit instructions not to send them.


&gt;<i> 
</I>&gt;<i> sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> http_access allow all
</I>
Not safe.

localnet and localhost are already allowed to do anything safe by the 
earlier http_access rules. SO you should not see a change if you set 
this back to the &quot;deny all&quot; which it should be.

&gt;<i> 
</I>&gt;<i> http_port 3127
</I>&gt;<i> http_port 3128 intercept
</I>
Not safe practice. Port 3128 is the officialy registered Squid proxy 
port and quite well known. There are several attacks that can be done if 
the attacker happens to identify what intercept port is numbered and 
connect there. Use a randomly selected other port number.

Same for the below 3129. It is used in our documetation as an example 
only.


&gt;<i> https_port 3129 intercept cert=mycert.cert key=mykey.key ssl-bump
</I>&gt;<i> intercept generate-host-certificates=on  version=1
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE  cafile=Intermediate.crt
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
always_direct is not needed for SSL-Bump. It was a bug workaround needed 
only for a very few releases many years ago now.

&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice localhost
</I>&gt;<i> ssl_bump splice https
</I>&gt;<i> 
</I>
You are splicing traffic. This means there are no HTTPS messages 
interpreted by Squid. Thus no possibility of your URL-rewrite helper 
ever being even considered for use on them.
At best it might be considered for the CONNECT tunnel used by splice, 
but that means CONNECT URI has its domain set, the dstdomain would match 
and &quot;!http&quot; comes into affect to prevent it being asked.


&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/cache/squid
</I>&gt;<i> &quot;
</I>&gt;<i> 
</I>&gt;<i> So any idea why no https urls are being redirected to the url_rewrite
</I>&gt;<i> program?
</I>&gt;<i> Any alternative solution is also very much welcome
</I>&gt;<i> 
</I>
1) If you really meant to detect HTTP vs HTTPS traffic. Use the proper 
ACL definitions:
   acl HTTP proto HTTP
   acl HTTPS proto HTTPS


2) Most rewriters cannot correctly handle the URI type used on CONNECT 
tunnels, and more importantly are not able to safely decide where to 
redirect to even if they could produce the right URI output.

So, normal installations should block requests to your re-writer by 
using the available &quot;CONNECT&quot; ACL like so:
  url_rewrite_access deny CONNECT

However, if your rewriter is an exception and can actually divert whole 
tunnels correctly (or knows corectly to return &quot;ERR&quot; and skip 
re-writing). Then use the method field it receives from Squid to have it 
decide what to do.

3) If you want to rewrite or redirect <A HREF="https://">https://</A> URLs ... in other words 
modifying the HTTPS messages inside the crypto.

That requires &quot;ssl_bump bump&quot; action to be configured and the traffic 
decrypted.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011440.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="011479.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11442">[ date ]</a>
              <a href="thread.html#11442">[ thread ]</a>
              <a href="subject.html#11442">[ subject ]</a>
              <a href="author.html#11442">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
