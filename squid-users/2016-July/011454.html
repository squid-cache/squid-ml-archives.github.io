<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_strict and wildcard SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577D8DE6.4070805%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011474.html">
   <LINK REL="Next"  HREF="011456.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_strict and wildcard SNI</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577D8DE6.4070805%40urlfilterdb.com%3E"
       TITLE="[squid-users] host_verify_strict and wildcard SNI">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Wed Jul  6 23:01:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011474.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
        <LI>Next message (by thread): <A HREF="011456.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11454">[ date ]</a>
              <a href="thread.html#11454">[ thread ]</a>
              <a href="subject.html#11454">[ subject ]</a>
              <a href="author.html#11454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 07/06/2016 11:36 AM, Steve Hill wrote:
&gt;<i>
</I>&gt;<i> I'm using a transparent proxy and SSL-peek and have hit a problem with an iOS app which seems to be doing broken things with the SNI.
</I>&gt;<i>
</I>&gt;<i> The app is making an HTTPS connection to a server and presenting an SNI with a wildcard in it - i.e. &quot;*.example.com&quot;.  I'm not sure if this behaviour is actually illegal, but it certainly doesn't seem
</I>&gt;<i> to make a lot of sense to me.
</I>&gt;<i>
</I>&gt;<i> Squid then internally generates a &quot;CONNECT *.example.com:443&quot; request based on the peeked SNI, which is picked up by hostHeaderIpVerify(). Since *.example.com isn't a valid DNS name, Squid rejects the
</I>&gt;<i> connection on the basis that *.example.com doesn't match the IP address that the client is connecting to.
</I>&gt;<i>
</I>&gt;<i> Unfortunately, I can't see any way of working around the problem - &quot;host_verify_strict&quot; is disabled, but according to the docs,
</I>&gt;<i> &quot;For now suspicious intercepted CONNECT requests are always responded to with an HTTP 409 (Conflict) error page.&quot;
</I>&gt;<i>
</I>&gt;<i> As I understand it, turning host_verify_strict on causes problems with CDNs which use DNS tricks for load balancing, so I'm not sure I understand the rationale behind preventing it from being turned
</I>&gt;<i> off for CONNECT requests?
</I>
An SNI with a wildcard indeed does not make sense.

Since Squid tries to mimic the behavior of the server and of the client,
it deserves a patch where instead of doing a DNS lookup and then doing a
connect (based on the result of the DNS lookup?),
Squid simply connects to the IP address that the client tries to connect to
and does the TLS handshake with the SNI (that does not make sense).
This way it mimics the client a bit better.

Marcus

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011474.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
	<LI>Next message (by thread): <A HREF="011456.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11454">[ date ]</a>
              <a href="thread.html#11454">[ thread ]</a>
              <a href="subject.html#11454">[ subject ]</a>
              <a href="author.html#11454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
