<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_strict and wildcard SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577DAB45.5030502%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011454.html">
   <LINK REL="Next"  HREF="011457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_strict and wildcard SNI</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577DAB45.5030502%40measurement-factory.com%3E"
       TITLE="[squid-users] host_verify_strict and wildcard SNI">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jul  7 01:07:17 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011454.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
        <LI>Next message (by thread): <A HREF="011457.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11456">[ date ]</a>
              <a href="thread.html#11456">[ thread ]</a>
              <a href="subject.html#11456">[ subject ]</a>
              <a href="author.html#11456">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/06/2016 05:01 PM, Marcus Kool wrote:
&gt;<i> On 07/06/2016 11:36 AM, Steve Hill wrote:
</I>&gt;&gt;<i> I'm using a transparent proxy and SSL-peek and have hit a problem with
</I>&gt;&gt;<i> an iOS app which seems to be doing broken things with the SNI.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The app is making an HTTPS connection to a server and presenting an
</I>&gt;&gt;<i> SNI with a wildcard in it - i.e. &quot;*.example.com&quot;.  I'm not sure if
</I>&gt;&gt;<i> this behaviour is actually illegal, but it certainly doesn't seem
</I>&gt;&gt;<i> to make a lot of sense to me.
</I>

&gt;<i> An SNI with a wildcard indeed does not make sense.
</I>
There are three rather different questions to consider here:

1. Is wildcard SNI &quot;legal/valid&quot;?
2. Can wildcard SNI &quot;make sense&quot; in some cases?
3. What should Squid do when receiving a wildcard SNI?


Q1. Is wildcard SNI &quot;legal/valid&quot;?

I do not know the answer to that question. The &quot;*.example.com&quot; name is
certainly legal in many DNS contexts. RFC 6066 requires HostName SNI to
be a &quot;fully qualified domain name&quot;, but I failed to find a strict-enough
RFC definition of an FQDN that would either accept or reject wildcards
as FQDNs. I would not be surprised if FQDN syntax is not defined to the
level that would allow one to reject wildcards as FQDNs based on syntax
alone.


Q2. Can wildcard SNI &quot;make sense&quot; in some cases?

Yes, of course. The client essentially says &quot;I am trying to connect to
_any_ example.com subdomain at this IP:port address. If you have any
service like that, please connect me&quot;. That would work fine in
deployment contexts where several servers with different names provide
essentially the same service and the central &quot;routing point&quot; would pick
the &quot;best&quot; service to use. I am not saying it is a good idea to use
wildcard SNIs, but I can see them &quot;making sense&quot; in some cases.


Q3. What should Squid do when receiving a wildcard SNI?

The first two questions are not really important and each may not even
have a single &quot;correct&quot; answer. I am sure protocol purists can argue
about them forever. The last question is important, which brings us to:

&gt;<i> Since Squid tries to mimic the behavior of the server and of the client,
</I>&gt;<i> it deserves a patch where instead of doing a DNS lookup and then doing a
</I>&gt;<i> connect (based on the result of the DNS lookup?),
</I>&gt;<i> Squid simply connects to the IP address that the client tries to connect to
</I>&gt;<i> and does the TLS handshake with the SNI (that does not make sense).
</I>&gt;<i> This way it mimics the client a bit better.
</I>
I believe that is what Squid does already but please correct me if I am
wrong.

When forming a fake CONNECT request, Squid uses SNI information because
that is what ACLs and adaptation services usually want to see. However,
I hope that intercepting Squid always connects to the intended
destination of the intercepted connection instead of trusting its own
fake CONNECT request.

Whether Squid should generate a fake CONNECT with a wildcard host name
is an interesting question:

1. A fake CONNECT targeting an wildcard name may break ACL-driven rules
and adaptation services (at least).

2. A fake CONNECT targeting an IP address instead of a wildcard name may
not give some ACL-driven rules and adaptation services enough
information to make the right decision.

3. A premature rejection of a connection with wildcard SNI does not
allow the admin to make the bump/splice/terminate decision.

#2 is probably the lesser of the three evils, but I wonder whether Squid
should also include the invalid host name as an X-SNI or similar HTTP
header in that CONNECT request, to give advanced ACLs and adaptation
services a better chance to work around known benign issues where the
admin knows the wildcard is not malicious (and to kill wildcard
transactions the admin knows to be malicious!).


A similar question can be asked about SNI names containing unusual
characters. At some point, it would be too dangerous to include SNI
information in the fake CONNECT request because it will interfere with
HTTP rules, but it is not clear where that point is exactly.


Cheers,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011454.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
	<LI>Next message (by thread): <A HREF="011457.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11456">[ date ]</a>
              <a href="thread.html#11456">[ thread ]</a>
              <a href="subject.html#11456">[ subject ]</a>
              <a href="author.html#11456">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
