<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_strict and wildcard SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577DB691.90305%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011456.html">
   <LINK REL="Next"  HREF="011464.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_strict and wildcard SNI</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577DB691.90305%40urlfilterdb.com%3E"
       TITLE="[squid-users] host_verify_strict and wildcard SNI">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Thu Jul  7 01:55:29 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011456.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
        <LI>Next message (by thread): <A HREF="011464.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11457">[ date ]</a>
              <a href="thread.html#11457">[ thread ]</a>
              <a href="subject.html#11457">[ subject ]</a>
              <a href="author.html#11457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 07/06/2016 10:07 PM, Alex Rousskov wrote:
&gt;<i> On 07/06/2016 05:01 PM, Marcus Kool wrote:
</I>&gt;&gt;<i> On 07/06/2016 11:36 AM, Steve Hill wrote:
</I>&gt;&gt;&gt;<i> I'm using a transparent proxy and SSL-peek and have hit a problem with
</I>&gt;&gt;&gt;<i> an iOS app which seems to be doing broken things with the SNI.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The app is making an HTTPS connection to a server and presenting an
</I>&gt;&gt;&gt;<i> SNI with a wildcard in it - i.e. &quot;*.example.com&quot;.  I'm not sure if
</I>&gt;&gt;&gt;<i> this behaviour is actually illegal, but it certainly doesn't seem
</I>&gt;&gt;&gt;<i> to make a lot of sense to me.
</I>
[snip]

&gt;<i>
</I>&gt;<i> Q3. What should Squid do when receiving a wildcard SNI?
</I>&gt;<i>
</I>&gt;<i> The first two questions are not really important and each may not even
</I>&gt;<i> have a single &quot;correct&quot; answer. I am sure protocol purists can argue
</I>&gt;<i> about them forever. The last question is important, which brings us to:
</I>&gt;<i>
</I>&gt;&gt;<i> Since Squid tries to mimic the behavior of the server and of the client,
</I>&gt;&gt;<i> it deserves a patch where instead of doing a DNS lookup and then doing a
</I>&gt;&gt;<i> connect (based on the result of the DNS lookup?),
</I>&gt;&gt;<i> Squid simply connects to the IP address that the client tries to connect to
</I>&gt;&gt;<i> and does the TLS handshake with the SNI (that does not make sense).
</I>&gt;&gt;<i> This way it mimics the client a bit better.
</I>&gt;<i>
</I>&gt;<i> I believe that is what Squid does already but please correct me if I am
</I>&gt;<i> wrong.
</I>
Steve said that Squid rejects the connection because of a failed DNS lookup.
So what is Squid doing?  Is it doing  the following ?
- connect to the original IP
- use the presented SNI to the server
- do a DNS lookup and reject

&gt;<i> When forming a fake CONNECT request, Squid uses SNI information because
</I>&gt;<i> that is what ACLs and adaptation services usually want to see. However,
</I>&gt;<i> I hope that intercepting Squid always connects to the intended
</I>&gt;<i> destination of the intercepted connection instead of trusting its own
</I>&gt;<i> fake CONNECT request.
</I>
It is interesting to know if an ICAP server or URL rewriter is called
and with which parameters when the ios app breaks.

&gt;<i> Whether Squid should generate a fake CONNECT with a wildcard host name
</I>&gt;<i> is an interesting question:
</I>&gt;<i>
</I>&gt;<i> 1. A fake CONNECT targeting an wildcard name may break ACL-driven rules
</I>&gt;<i> and adaptation services (at least).
</I> &gt;
&gt;<i> 2. A fake CONNECT targeting an IP address instead of a wildcard name may
</I>&gt;<i> not give some ACL-driven rules and adaptation services enough
</I>&gt;<i> information to make the right decision.
</I>&gt;<i>
</I>&gt;<i> 3. A premature rejection of a connection with wildcard SNI does not
</I>&gt;<i> allow the admin to make the bump/splice/terminate decision.
</I>&gt;<i>
</I>&gt;<i> #2 is probably the lesser of the three evils, but I wonder whether Squid
</I>&gt;<i> should also include the invalid host name as an X-SNI or similar HTTP
</I>&gt;<i> header in that CONNECT request, to give advanced ACLs and adaptation
</I>&gt;<i> services a better chance to work around known benign issues where the
</I>&gt;<i> admin knows the wildcard is not malicious (and to kill wildcard
</I>&gt;<i> transactions the admin knows to be malicious!).
</I>
I use url_rewrite_extras with &quot;... sni=\&quot;%ssl::&gt;sni\&quot; ...&quot;
so the URL redirector receives both the original IP address and
the peeked SNI value to make its decisions.
I agree that an ICAP service needs X-SNI or perhaps X-Squid-SNI to
also get both the IP address and the SNI value.

&gt;<i> A similar question can be asked about SNI names containing unusual
</I>&gt;<i> characters. At some point, it would be too dangerous to include SNI
</I>&gt;<i> information in the fake CONNECT request because it will interfere with
</I>&gt;<i> HTTP rules, but it is not clear where that point is exactly.
</I>
To support the weirdest apps Squid might have to simply copy all
unusual characters to present the same parameter values to the server.
But we do not want to break things... so which characters are
so unusual that Squid does not want to accept them?

Marcus

&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011456.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
	<LI>Next message (by thread): <A HREF="011464.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11457">[ date ]</a>
              <a href="thread.html#11457">[ thread ]</a>
              <a href="subject.html#11457">[ subject ]</a>
              <a href="author.html#11457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
