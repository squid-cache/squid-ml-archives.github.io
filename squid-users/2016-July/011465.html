<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_strict and wildcard SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577E3D54.2060209%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011464.html">
   <LINK REL="Next"  HREF="011467.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_strict and wildcard SNI</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577E3D54.2060209%40urlfilterdb.com%3E"
       TITLE="[squid-users] host_verify_strict and wildcard SNI">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Thu Jul  7 11:30:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011464.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
        <LI>Next message (by thread): <A HREF="011467.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11465">[ date ]</a>
              <a href="thread.html#11465">[ thread ]</a>
              <a href="subject.html#11465">[ subject ]</a>
              <a href="author.html#11465">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 07/07/2016 07:15 AM, Amos Jeffries wrote:
&gt;<i> On 7/07/2016 1:55 p.m., Marcus Kool wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 07/06/2016 10:07 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 07/06/2016 05:01 PM, Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;<i> On 07/06/2016 11:36 AM, Steve Hill wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> I'm using a transparent proxy and SSL-peek and have hit a problem with
</I>&gt;&gt;&gt;&gt;&gt;<i> an iOS app which seems to be doing broken things with the SNI.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The app is making an HTTPS connection to a server and presenting an
</I>&gt;&gt;&gt;&gt;&gt;<i> SNI with a wildcard in it - i.e. &quot;*.example.com&quot;.  I'm not sure if
</I>&gt;&gt;&gt;&gt;&gt;<i> this behaviour is actually illegal, but it certainly doesn't seem
</I>&gt;&gt;&gt;&gt;&gt;<i> to make a lot of sense to me.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [snip]
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Q3. What should Squid do when receiving a wildcard SNI?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The first two questions are not really important and each may not even
</I>&gt;&gt;&gt;<i> have a single &quot;correct&quot; answer. I am sure protocol purists can argue
</I>&gt;&gt;&gt;<i> about them forever. The last question is important, which brings us to:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Since Squid tries to mimic the behavior of the server and of the client,
</I>&gt;&gt;&gt;&gt;<i> it deserves a patch where instead of doing a DNS lookup and then doing a
</I>&gt;&gt;&gt;&gt;<i> connect (based on the result of the DNS lookup?),
</I>&gt;&gt;&gt;&gt;<i> Squid simply connects to the IP address that the client tries to
</I>&gt;&gt;&gt;&gt;<i> connect to
</I>&gt;&gt;&gt;&gt;<i> and does the TLS handshake with the SNI (that does not make sense).
</I>&gt;&gt;&gt;&gt;<i> This way it mimics the client a bit better.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I believe that is what Squid does already but please correct me if I am
</I>&gt;&gt;&gt;<i> wrong.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Steve said that Squid rejects the connection because of a failed DNS
</I>&gt;&gt;<i> lookup.
</I>&gt;&gt;<i> So what is Squid doing?  Is it doing  the following ?
</I>&gt;&gt;<i> - connect to the original IP
</I>&gt;&gt;<i> - use the presented SNI to the server
</I>&gt;&gt;<i> - do a DNS lookup and reject
</I>&gt;<i>
</I>&gt;<i> No it is doing Host: header verification on the faked CONNECT request
</I>&gt;<i> which uses the SNI in the Host: header value. This is not strictly
</I>&gt;<i> required for CONNECT messages, but does potentially prevent Squid using
</I>&gt;<i> other IPs than the original one the client was contacting.
</I>
Squid _has_ the original IP so why would Squid potentially connect to an
other IP ?

&gt;<i> If the SNI is a valid domain name (ie resolves in DNS). Then Squid
</I>&gt;<i> should continue on past the check.
</I>
Does Squid do a DNS lookup or only check the value for &quot;valid&quot; characters?

&gt;&gt;&gt;<i> When forming a fake CONNECT request, Squid uses SNI information because
</I>&gt;&gt;&gt;<i> that is what ACLs and adaptation services usually want to see. However,
</I>&gt;&gt;&gt;<i> I hope that intercepting Squid always connects to the intended
</I>&gt;&gt;&gt;<i> destination of the intercepted connection instead of trusting its own
</I>&gt;&gt;&gt;<i> fake CONNECT request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It is interesting to know if an ICAP server or URL rewriter is called
</I>&gt;&gt;<i> and with which parameters when the ios app breaks.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Whether Squid should generate a fake CONNECT with a wildcard host name
</I>&gt;&gt;&gt;<i> is an interesting question:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1. A fake CONNECT targeting an wildcard name may break ACL-driven rules
</I>&gt;&gt;&gt;<i> and adaptation services (at least).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2. A fake CONNECT targeting an IP address instead of a wildcard name may
</I>&gt;&gt;&gt;<i> not give some ACL-driven rules and adaptation services enough
</I>&gt;&gt;&gt;<i> information to make the right decision.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 3. A premature rejection of a connection with wildcard SNI does not
</I>&gt;&gt;&gt;<i> allow the admin to make the bump/splice/terminate decision.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #2 is probably the lesser of the three evils, but I wonder whether Squid
</I>&gt;&gt;&gt;<i> should also include the invalid host name as an X-SNI or similar HTTP
</I>&gt;&gt;&gt;<i> header in that CONNECT request, to give advanced ACLs and adaptation
</I>&gt;&gt;&gt;<i> services a better chance to work around known benign issues where the
</I>&gt;&gt;&gt;<i> admin knows the wildcard is not malicious (and to kill wildcard
</I>&gt;&gt;&gt;<i> transactions the admin knows to be malicious!).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I use url_rewrite_extras with &quot;... sni=\&quot;%ssl::&gt;sni\&quot; ...&quot;
</I>&gt;&gt;<i> so the URL redirector receives both the original IP address and
</I>&gt;&gt;<i> the peeked SNI value to make its decisions.
</I>&gt;&gt;<i> I agree that an ICAP service needs X-SNI or perhaps X-Squid-SNI to
</I>&gt;&gt;<i> also get both the IP address and the SNI value.
</I>&gt;<i>
</I>&gt;<i> That is a problem for the service. Squid can already send anything in:
</I>&gt;<i> &lt;<A HREF="http://www.squid-cache.org/Doc/config/adaptation_meta/">http://www.squid-cache.org/Doc/config/adaptation_meta/</A>&gt;.
</I>
Which problem are you referring to?

&gt;<i> Maybe you have mistaken it for the inability of most ICAP services to
</I>&gt;<i> send things back to Squid in the same way.
</I>
The ICAP server needs both the IP and the SNI which Squid can be configured
to do.  What do you suggest that an ICAP server needs to send back to Squid?

&gt;&gt;&gt;<i> A similar question can be asked about SNI names containing unusual
</I>&gt;&gt;&gt;<i> characters. At some point, it would be too dangerous to include SNI
</I>&gt;&gt;&gt;<i> information in the fake CONNECT request because it will interfere with
</I>&gt;&gt;&gt;<i> HTTP rules, but it is not clear where that point is exactly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To support the weirdest apps Squid might have to simply copy all
</I>&gt;&gt;<i> unusual characters to present the same parameter values to the server.
</I>&gt;<i>
</I>&gt;<i> It is being mapped into the HTTP equivalent value. Which are Host:
</I>&gt;<i> header and authority-URI. Only valid FQDN names can make it through the
</I>&gt;<i> mapping.
</I>
Here things get complicated.
It is correct that Squid enforces apps to follow standards or
should Squid try to proxy connections for apps when it can?

Marcus

&gt;&gt;<i> But we do not want to break things... so which characters are
</I>&gt;&gt;<i> so unusual that Squid does not want to accept them?
</I>&gt;<i>
</I>&gt;<i> In Steve's case the asterisk at the start of the domain name. The name
</I>&gt;<i> labels must each start with an alphabet character a-z or A-Z.  That is a
</I>&gt;<i> fixed requirement. The other characters that follow are where things get
</I>&gt;<i> fuzzy depending on what RFCs you follow.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011464.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
	<LI>Next message (by thread): <A HREF="011467.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11465">[ date ]</a>
              <a href="thread.html#11465">[ thread ]</a>
              <a href="subject.html#11465">[ subject ]</a>
              <a href="author.html#11465">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
