<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_strict and wildcard SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577E544E.7030702%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011467.html">
   <LINK REL="Next"  HREF="011469.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_strict and wildcard SNI</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3C577E544E.7030702%40urlfilterdb.com%3E"
       TITLE="[squid-users] host_verify_strict and wildcard SNI">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Thu Jul  7 13:08:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011467.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
        <LI>Next message (by thread): <A HREF="011469.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11468">[ date ]</a>
              <a href="thread.html#11468">[ thread ]</a>
              <a href="subject.html#11468">[ subject ]</a>
              <a href="author.html#11468">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 07/07/2016 09:23 AM, Amos Jeffries wrote:
&gt;<i> On 7/07/2016 11:30 p.m., Marcus Kool wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 07/07/2016 07:15 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 7/07/2016 1:55 p.m., Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 07/06/2016 10:07 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> On 07/06/2016 05:01 PM, Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On 07/06/2016 11:36 AM, Steve Hill wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> I'm using a transparent proxy and SSL-peek and have hit a problem
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> with
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> an iOS app which seems to be doing broken things with the SNI.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> The app is making an HTTPS connection to a server and presenting an
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> SNI with a wildcard in it - i.e. &quot;*.example.com&quot;.  I'm not sure if
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> this behaviour is actually illegal, but it certainly doesn't seem
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> to make a lot of sense to me.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> [snip]
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Q3. What should Squid do when receiving a wildcard SNI?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The first two questions are not really important and each may not even
</I>&gt;&gt;&gt;&gt;&gt;<i> have a single &quot;correct&quot; answer. I am sure protocol purists can argue
</I>&gt;&gt;&gt;&gt;&gt;<i> about them forever. The last question is important, which brings us to:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Since Squid tries to mimic the behavior of the server and of the
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> client,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> it deserves a patch where instead of doing a DNS lookup and then
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> doing a
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> connect (based on the result of the DNS lookup?),
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Squid simply connects to the IP address that the client tries to
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> connect to
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> and does the TLS handshake with the SNI (that does not make sense).
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> This way it mimics the client a bit better.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I believe that is what Squid does already but please correct me if I am
</I>&gt;&gt;&gt;&gt;&gt;<i> wrong.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Steve said that Squid rejects the connection because of a failed DNS
</I>&gt;&gt;&gt;&gt;<i> lookup.
</I>&gt;&gt;&gt;&gt;<i> So what is Squid doing?  Is it doing  the following ?
</I>&gt;&gt;&gt;&gt;<i> - connect to the original IP
</I>&gt;&gt;&gt;&gt;<i> - use the presented SNI to the server
</I>&gt;&gt;&gt;&gt;<i> - do a DNS lookup and reject
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> No it is doing Host: header verification on the faked CONNECT request
</I>&gt;&gt;&gt;<i> which uses the SNI in the Host: header value. This is not strictly
</I>&gt;&gt;&gt;<i> required for CONNECT messages, but does potentially prevent Squid using
</I>&gt;&gt;&gt;<i> other IPs than the original one the client was contacting.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid _has_ the original IP so why would Squid potentially connect to an
</I>&gt;&gt;<i> other IP ?
</I>&gt;<i>
</I>&gt;<i> Because the inbound and outbound connections are not related. The
</I>&gt;<i> outbound is normally done to any of the IPs that the request message
</I>&gt;<i> domain/Host header resolve to. It takes special circumstances (such as
</I>&gt;<i> failing the Host verification) to tie them together.
</I>
Oops.  An application wants to connect to A.B.C.D has an SNI for foo.example.com
which resolves to A.B.C.D and A.B.C.E and Squid may connect the stream
to A.B.C.E... It is easy to imagine that some applications break with this behavior.

&gt;&gt;&gt;<i> If the SNI is a valid domain name (ie resolves in DNS). Then Squid
</I>&gt;&gt;&gt;<i> should continue on past the check.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does Squid do a DNS lookup or only check the value for &quot;valid&quot; characters?
</I>&gt;<i>
</I>&gt;<i> DNS lookup.
</I>
[snip]

&gt;&gt;&gt;&gt;&gt;<i> A similar question can be asked about SNI names containing unusual
</I>&gt;&gt;&gt;&gt;&gt;<i> characters. At some point, it would be too dangerous to include SNI
</I>&gt;&gt;&gt;&gt;&gt;<i> information in the fake CONNECT request because it will interfere with
</I>&gt;&gt;&gt;&gt;&gt;<i> HTTP rules, but it is not clear where that point is exactly.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> To support the weirdest apps Squid might have to simply copy all
</I>&gt;&gt;&gt;&gt;<i> unusual characters to present the same parameter values to the server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It is being mapped into the HTTP equivalent value. Which are Host:
</I>&gt;&gt;&gt;<i> header and authority-URI. Only valid FQDN names can make it through the
</I>&gt;&gt;&gt;<i> mapping.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here things get complicated.
</I>&gt;&gt;<i> It is correct that Squid enforces apps to follow standards or
</I>&gt;&gt;<i> should Squid try to proxy connections for apps when it can?
</I>&gt;<i>
</I>&gt;<i> Squid isn't enforcing standards here. As Steve original messge says it:
</I>&gt;<i> &quot;generates a &quot;CONNECT *.example.com:443&quot; request based on the peeked SNI&quot;
</I>&gt;<i>   - which is arguably invalid HTTP syntax, but oh well.
</I>&gt;<i>
</I>&gt;<i> It then is unable to do a DNS lookup for *.example.com to find out what
</I>&gt;<i> its IPs are and does the error handling action for a failure to verify
</I>&gt;<i> on a CONNECT message.
</I>
yes, the fake CONNECT is dealt with like a regular CONNECT including
DNS lookup.  I fear for other apps (besides the one ios app that Steve
refers to) to break because Squid may connect to a different IP than
the client/app is requesting.
If Squid uses the original IP to connect without doing a DNS lookup,
Steve's app will work and potential issues with other apps are
prevented.

Marcus

&gt;<i> Amos
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011467.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
	<LI>Next message (by thread): <A HREF="011469.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11468">[ date ]</a>
              <a href="thread.html#11468">[ thread ]</a>
              <a href="subject.html#11468">[ subject ]</a>
              <a href="author.html#11468">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
