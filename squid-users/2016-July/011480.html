<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_strict and wildcard SNI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3Cdb00b2ef-7baf-fae0-72be-edbb03279475%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011476.html">
   <LINK REL="Next"  HREF="011489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_strict and wildcard SNI</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_strict%20and%20wildcard%20SNI&In-Reply-To=%3Cdb00b2ef-7baf-fae0-72be-edbb03279475%40treenet.co.nz%3E"
       TITLE="[squid-users] host_verify_strict and wildcard SNI">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul  7 19:53:32 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011476.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
        <LI>Next message (by thread): <A HREF="011489.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11480">[ date ]</a>
              <a href="thread.html#11480">[ thread ]</a>
              <a href="subject.html#11480">[ subject ]</a>
              <a href="author.html#11480">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/07/2016 4:50 a.m., Alex Rousskov wrote:
&gt;<i> On 07/07/2016 06:23 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 7/07/2016 11:30 p.m., Marcus Kool wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> On 07/06/2016 10:07 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Q3. What should Squid do when receiving a wildcard SNI?
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Squid _has_ the original IP so why would Squid potentially connect to an
</I>&gt;&gt;&gt;<i> other IP ?
</I>&gt;<i> 
</I>&gt;&gt;<i> Because the inbound and outbound connections are not related. 
</I>&gt;<i> 
</I>&gt;<i> For intercepted connections they should be IMHO. By default, we should
</I>&gt;<i> [if allowed by all the internal checks] connect to the exact IP the
</I>&gt;<i> client was connecting to when we intercepted (cache peering, cache hits,
</I>&gt;<i> and similar special cases aside, of course).
</I>&gt;<i> 
</I>&gt;<i> Amos, are you sure we not doing that already for intercepted
</I>&gt;<i> connections? If we are not, I think this is a missing feature essential
</I>&gt;<i> for many (most?) deployments! I certainly understand that some admins
</I>&gt;<i> will need to &quot;reroute&quot; some intercepted requests, but rerouting ought to
</I>&gt;<i> be an exception, not the norm. Do you agree?
</I>
Yes we are using the client ORIGINAL_DST as most preferred outgoing route.

However, when the admin configures &quot;client_dst_passthru off&quot; to force
the DNS results to be used, or configures cache_peer to be used instead
we obey those instructions instead. Also if the most preferred route is
down the alternatives can happen.


&gt;<i> 
</I>&gt;<i> Please note that going to where the client went does not have to weaken
</I>&gt;<i> any internal checks.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The
</I>&gt;&gt;<i> outbound is normally done to any of the IPs that the request message
</I>&gt;&gt;<i> domain/Host header resolve to.
</I>&gt;<i> 
</I>&gt;<i> For intercepted SSL connections, there is no HTTP request message with
</I>&gt;<i> that information so it is especially pressing to connect to where the
</I>&gt;<i> client was going.
</I>&gt;<i> 
</I>&gt;<i> Perhaps we screwed it up by replacing the IP address with SNI in the
</I>&gt;<i> fake CONNECT target at some point? If that is what changed Squid
</I>&gt;<i> behavior, then we should fix the code so that Squid connects to the
</I>&gt;<i> intended destination IP regardless of the fake CONNECT target. One way
</I>&gt;<i> to do that would be to provide that intended IP address in the fake
</I>&gt;<i> CONNECT request itself, via X-Going-To or similar -- doing so would
</I>&gt;<i> allow adaptation services to adjust Squid behavior as needed.
</I>
I think the first CONNECT message which uses raw-IP should end with
setting up a (TCP only at this point) server connection of type PINNED.
Then the TLS bumping and second CONNECT message with SNI details should
use that connection for all the followup activity.
That would resolve other problems we are seeing with server connection
closure races as well.

&gt;<i> 
</I>&gt;<i> [Wildcard] SNI validation is a separate problem that also needs a
</I>&gt;<i> solution. The feature/fix discussed above is not sufficient alone.
</I>&gt;<i> 
</I>
Nod.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011476.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
	<LI>Next message (by thread): <A HREF="011489.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11480">[ date ]</a>
              <a href="thread.html#11480">[ thread ]</a>
              <a href="subject.html#11480">[ subject ]</a>
              <a href="author.html#11480">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
