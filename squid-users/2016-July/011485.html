<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3CCAJ_yQBniWDp3ESA4MpXgGK7_GXb1ucCx4CgddNvxhVO01PWgzQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011479.html">
   <LINK REL="Next"  HREF="011487.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS</H1>
    <B>Moataz Elmasry</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3CCAJ_yQBniWDp3ESA4MpXgGK7_GXb1ucCx4CgddNvxhVO01PWgzQ%40mail.gmail.com%3E"
       TITLE="[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS">zaza1851983ml at googlemail.com
       </A><BR>
    <I>Thu Jul  7 22:42:25 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011479.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="011487.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11485">[ date ]</a>
              <a href="thread.html#11485">[ thread ]</a>
              <a href="subject.html#11485">[ subject ]</a>
              <a href="author.html#11485">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I just had an idea. Refering to the last email.
The reason why I'm getting those &quot;Header forgery&quot; errors might be because
of the defined nat rules. I'm using the following rules:

iptables -t nat -A OUTPUT --match owner --uid-owner proxy -p tcp --dport 80
-j ACCEPT
iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to-destination
${MY_IP}:3128
iptables -t nat -A OUTPUT --match owner --uid-owner proxy -p tcp --dport
443 -j ACCEPT
iptables -t nat -A OUTPUT -p tcp --dport 443 -j DNAT --to-destination
${MY_IP}:3129

so, the next thing is I changed the --to-destination lines as follows:

iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner proxy --dport 443
-j REDIRECT --to-port 3129

But no success. Do these nat rules have anything to do with the header
forgery problem?

On Thu, Jul 7, 2016 at 7:28 PM, Moataz Elmasry &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">zaza1851983ml at googlemail.com</A>
&gt;<i> wrote:
</I>
&gt;<i> Sorry, I just realized, I sent you a private email instead of to the
</I>&gt;<i> mailing list. Apologies for that.
</I>&gt;<i>
</I>&gt;<i> Hi Amos,
</I>&gt;<i>
</I>&gt;<i> I did some progress today so that least I'm not getting any errors in the
</I>&gt;<i> browser, te url_redirect_program receives the actual url. Redirecting
</I>&gt;<i> normal http urls work fine, but redirecting https urls results in a similar
</I>&gt;<i> error in the logs:
</I>&gt;<i> &quot;
</I>&gt;<i> 2016/07/07 17:19:28| SECURITY ALERT: Host header forgery detected on local=
</I>&gt;<i> 31.13.92.36:443 remote=x.x.x.x:65228 FD 18 flags=33 (local IP does not
</I>&gt;<i> match any domain IP)
</I>&gt;<i> 2016/07/07 17:19:28| SECURITY ALERT: on URL: www.facebook.com:443
</I>&gt;<i> &quot;
</I>&gt;<i> And the browser tab hags (in page loading)
</I>&gt;<i>
</I>&gt;<i> Heres the squid.conf important parts
</I>&gt;<i>
</I>&gt;<i> &quot;
</I>&gt;<i> acl http_sites dstdomain play.google.com mydomain.com
</I>&gt;<i> acl https_sites ssl::server_name play.google.com mydomain.com
</I>&gt;<i>
</I>&gt;<i> acl HTTP proto HTTP
</I>&gt;<i> acl HTTPS proto HTTPS
</I>&gt;<i>
</I>&gt;<i> http_access allow http_sites
</I>&gt;<i> http_access allow https_sites
</I>&gt;<i>
</I>&gt;<i> sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i>
</I>&gt;<i> http_access allow all
</I>&gt;<i>
</I>&gt;<i> http_port 3127
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3129 cert=/etc/squid/ssl/example.com.cert key=/etc/squid/ssl/example.com.private
</I>&gt;<i> ssl-bump intercept generate-host-certificates=on  version=1
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE capath=/etc/ssl/certs/
</I>&gt;<i>
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i>
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice step2 all !https_sites
</I>&gt;<i> ssl_bump bump step3 all !https_sites
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> url_rewrite_program /bin/bash -c -l /etc/squid/redirect.bash
</I>&gt;<i> url_rewrite_extras &quot;%&gt;a/%&gt;A %&lt;A %un %&gt;rm myip=%la myport=%lp  ru=%ru
</I>&gt;<i> ru2=%&gt;ru ru3=%&lt;ru rd=%&gt;rd rd2=%&lt;rd h=%&gt;h ssl1=%ssl::bump_mode
</I>&gt;<i> ssl2=%ssl::&gt;sni rp1=%rp rp2=%&gt;rp rp3=%&lt;rp h1=%&gt;h h2=%&gt;ha&quot;
</I>&gt;<i> logformat squid &quot;%&gt;a/%&gt;A %&lt;A %un %&gt;rm myip=%la myport=%lp  ru=%ru
</I>&gt;<i> ru2=%&gt;ru ru3=%&lt;ru rd=%&gt;rd rd2=%&lt;rd h=%&gt;h ssl1=%ssl::bump_mode
</I>&gt;<i> ssl2=%ssl::&gt;sni rp1=%rp rp2=%&gt;rp rp3=%&lt;rp h1=%&gt;h h2=%&gt;ha&quot;
</I>&gt;<i> url_rewrite_access allow all !http_sites !https_sites
</I>&gt;<i>
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/cache/squid
</I>&gt;<i>
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>&gt;<i> I searched a bit on the &quot;Host header forgery detected&quot; but could not find
</I>&gt;<i> a similar situation to mines
</I>&gt;<i> Any ideas how to overcome this error?
</I>&gt;<i>
</I>&gt;<i> Many thanks and regards,
</I>&gt;<i> Moataz
</I>&gt;<i>
</I>&gt;<i> On Wed, Jul 6, 2016 at 9:30 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 2016-07-06 10:48, Moataz Elmasry wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm trying to create a kind of captive portal when only my domain and
</I>&gt;&gt;&gt;<i> google play are whitelisted and other addresses(http/https) are
</I>&gt;&gt;&gt;<i> forwarded to my domain.
</I>&gt;&gt;&gt;<i> All http requests are landing fine in the url_rewrite program, while
</I>&gt;&gt;&gt;<i> the https requests appear as only the IP address but not the dns name.
</I>&gt;&gt;&gt;<i> I'm aware of <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A> and
</I>&gt;&gt;&gt;<i> especially the note that during ssl_bump no dns name is available yet
</I>&gt;&gt;&gt;<i> and instead one should be using the acl ssl::server_name directive,
</I>&gt;&gt;&gt;<i> but for some reason no https address is being sent to my url_rewrite
</I>&gt;&gt;&gt;<i> program.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The same SSL certificate used on my domain is also being used with
</I>&gt;&gt;&gt;<i> squid at https_port
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's my squid.conf
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> pinger_enable off
</I>&gt;&gt;&gt;<i> acl localnet src 10.0.0.0/8 [1] # RFC1918 possible internal network
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl localnet src 172.16.0.0/12 [2] # RFC1918 possible internal network
</I>&gt;&gt;&gt;<i> acl localnet src 192.168.0.0/16 [3] # RFC1918 possible internal
</I>&gt;&gt;&gt;<i> network
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;&gt;<i> acl Safe_ports port 80 # http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 443 # https
</I>&gt;&gt;&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl http dstdomain play.google.com [4] mydomain.com [5]
</I>&gt;&gt;&gt;<i> acl https ssl::server_name play.google.com [4] mydomain.com [5]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is ... weird. There is nothing in the ACL matching which would
</I>&gt;&gt;<i> indicate it was HTTP vs HTTPS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * dstdomain can match for CONNECT tunnels transferring non-HTTP traffic
</I>&gt;&gt;<i> when the URI contains the domain specified. It only indicates that HTTP was
</I>&gt;&gt;<i> used by the client ... except for intercepted HTTPS traffic, where it
</I>&gt;&gt;<i> merely indicates that Squid itself is wrapping the inbound traffic into
</I>&gt;&gt;<i> HTTP compatible format before interpreting them. Squid sometimes uses the
</I>&gt;&gt;<i> TLS SNI value as the URI dstdomain.
</I>&gt;&gt;<i>   -&gt; unreliable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * TLS SNI can contain the listed server name for non-HTTPS protocols.
</I>&gt;&gt;<i>   -&gt; unreliable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow http
</I>&gt;&gt;&gt;<i> http_access allow https
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * &quot;http_access&quot; means Squid is testing whether an HTTP protocol client is
</I>&gt;&gt;<i> allowed to use the proxy. The &quot;http&quot; URL contains HTTP protocol matching.
</I>&gt;&gt;<i> Which is okay, but see above about what the &quot;dstdomain &quot;value could be.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * The &quot;https&quot; ACL contains TLS details matching - so is usually not
</I>&gt;&gt;<i> possible to even test like this.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * localnet and localhost are already allowed to do anything safe by the
</I>&gt;&gt;<i> earlier http_access rules. I doubt these confused matches are even getting
</I>&gt;&gt;<i> used.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> url_rewrite_program /bin/bash -c -l /etc/squid/redirect.bash
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> url_rewrite_access allow all !http
</I>&gt;&gt;&gt;<i> url_rewrite_access allow all !https
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Several problems here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * &quot;all&quot; is only a meaningless waste of CPU time and memory in this usage.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * &quot;https&quot; ACL probably is not possible to match. Rewriting of the *HTTP*
</I>&gt;&gt;<i> URL is a HTTP decision. Not TLS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * The use of negation (!) means you have expicitly configured Squid *not*
</I>&gt;&gt;<i> to send any lookups to the helper when the ACL listed domain name(s) are
</I>&gt;&gt;<i> present in the HTTP request.
</I>&gt;&gt;<i>  So you were asking why no requests with the domain name show up in the
</I>&gt;&gt;<i> helper?
</I>&gt;&gt;<i>  Squid is obeying your explicit instructions not to send them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not safe.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> localnet and localhost are already allowed to do anything safe by the
</I>&gt;&gt;<i> earlier http_access rules. SO you should not see a change if you set this
</I>&gt;&gt;<i> back to the &quot;deny all&quot; which it should be.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 3127
</I>&gt;&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not safe practice. Port 3128 is the officialy registered Squid proxy port
</I>&gt;&gt;<i> and quite well known. There are several attacks that can be done if the
</I>&gt;&gt;<i> attacker happens to identify what intercept port is numbered and connect
</I>&gt;&gt;<i> there. Use a randomly selected other port number.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Same for the below 3129. It is used in our documetation as an example
</I>&gt;&gt;<i> only.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 3129 intercept cert=mycert.cert key=mykey.key ssl-bump
</I>&gt;&gt;&gt;<i> intercept generate-host-certificates=on  version=1
</I>&gt;&gt;&gt;<i> options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE  cafile=Intermediate.crt
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> always_direct allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> always_direct is not needed for SSL-Bump. It was a bug workaround needed
</I>&gt;&gt;<i> only for a very few releases many years ago now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump splice localhost
</I>&gt;&gt;&gt;<i> ssl_bump splice https
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> You are splicing traffic. This means there are no HTTPS messages
</I>&gt;&gt;<i> interpreted by Squid. Thus no possibility of your URL-rewrite helper ever
</I>&gt;&gt;<i> being even considered for use on them.
</I>&gt;&gt;<i> At best it might be considered for the CONNECT tunnel used by splice, but
</I>&gt;&gt;<i> that means CONNECT URI has its domain set, the dstdomain would match and
</I>&gt;&gt;<i> &quot;!http&quot; comes into affect to prevent it being asked.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> coredump_dir /var/cache/squid
</I>&gt;&gt;&gt;<i> &quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So any idea why no https urls are being redirected to the url_rewrite
</I>&gt;&gt;&gt;<i> program?
</I>&gt;&gt;&gt;<i> Any alternative solution is also very much welcome
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> 1) If you really meant to detect HTTP vs HTTPS traffic. Use the proper
</I>&gt;&gt;<i> ACL definitions:
</I>&gt;&gt;<i>   acl HTTP proto HTTP
</I>&gt;&gt;<i>   acl HTTPS proto HTTPS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2) Most rewriters cannot correctly handle the URI type used on CONNECT
</I>&gt;&gt;<i> tunnels, and more importantly are not able to safely decide where to
</I>&gt;&gt;<i> redirect to even if they could produce the right URI output.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, normal installations should block requests to your re-writer by using
</I>&gt;&gt;<i> the available &quot;CONNECT&quot; ACL like so:
</I>&gt;&gt;<i>  url_rewrite_access deny CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, if your rewriter is an exception and can actually divert whole
</I>&gt;&gt;<i> tunnels correctly (or knows corectly to return &quot;ERR&quot; and skip re-writing).
</I>&gt;&gt;<i> Then use the method field it receives from Squid to have it decide what to
</I>&gt;&gt;<i> do.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3) If you want to rewrite or redirect <A HREF="https://">https://</A> URLs ... in other words
</I>&gt;&gt;<i> modifying the HTTPS messages inside the crypto.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That requires &quot;ssl_bump bump&quot; action to be configured and the traffic
</I>&gt;&gt;<i> decrypted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160708/290e2390/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160708/290e2390/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011479.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="011487.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11485">[ date ]</a>
              <a href="thread.html#11485">[ thread ]</a>
              <a href="subject.html#11485">[ subject ]</a>
              <a href="author.html#11485">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
