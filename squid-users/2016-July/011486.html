<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3Cdc387582-6f1b-6702-b066-bc0b1f1397be%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011517.html">
   <LINK REL="Next"  HREF="011445.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3Cdc387582-6f1b-6702-b066-bc0b1f1397be%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul  7 22:49:52 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011517.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="011445.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11486">[ date ]</a>
              <a href="thread.html#11486">[ thread ]</a>
              <a href="subject.html#11486">[ subject ]</a>
              <a href="author.html#11486">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/07/2016 5:28 a.m., Moataz Elmasry wrote:
&gt;<i> Sorry, I just realized, I sent you a private email instead of to the
</I>&gt;<i> mailing list. Apologies for that.
</I>&gt;<i> 
</I>&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> I did some progress today so that least I'm not getting any errors in the
</I>&gt;<i> browser, te url_redirect_program receives the actual url. Redirecting
</I>&gt;<i> normal http urls work fine, but redirecting https urls results in a similar
</I>&gt;<i> error in the logs:
</I>&gt;<i> &quot;
</I>&gt;<i> 2016/07/07 17:19:28| SECURITY ALERT: Host header forgery detected on local=
</I>&gt;<i> 31.13.92.36:443 remote=x.x.x.x:65228 FD 18 flags=33 (local IP does not
</I>&gt;<i> match any domain IP)
</I>&gt;<i> 2016/07/07 17:19:28| SECURITY ALERT: on URL: www.facebook.com:443
</I>&gt;<i> &quot;
</I>&gt;<i> And the browser tab hags (in page loading)
</I>
Two subtle details:

 1) that is not an error, it is a security alert. Warning that dire
consequences are likely happening for the client.

 2) this is pretty much an expected outcome from changing where a
CONNECT tunnel is going. Your altered domain is not likely to match the
transport layer details after alteration.

The dire consequences in (1) of course being the undefined behaviour
resulting from &quot;redirecting&quot; a tunnel in (2).


&gt;<i> On Wed, Jul 6, 2016 at 9:30 AM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2) Most rewriters cannot correctly handle the URI type used on CONNECT
</I>&gt;&gt;<i> tunnels, and more importantly are not able to safely decide where to
</I>&gt;&gt;<i> redirect to even if they could produce the right URI output.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, normal installations should block requests to your re-writer by using
</I>&gt;&gt;<i> the available &quot;CONNECT&quot; ACL like so:
</I>&gt;&gt;<i>  url_rewrite_access deny CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, if your rewriter is an exception and can actually divert whole
</I>&gt;&gt;<i> tunnels correctly (or knows corectly to return &quot;ERR&quot; and skip re-writing).
</I>&gt;&gt;<i> Then use the method field it receives from Squid to have it decide what to
</I>&gt;&gt;<i> do.
</I>&gt;&gt;<i>
</I>
It seems that your redirector is not one of those exceptional ones that
can do this to CONNECT tunnels.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011517.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="011445.html">[squid-users] host_verify_strict and wildcard SNI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11486">[ date ]</a>
              <a href="thread.html#11486">[ thread ]</a>
              <a href="subject.html#11486">[ subject ]</a>
              <a href="author.html#11486">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
