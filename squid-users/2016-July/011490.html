<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3CCAJ_yQBmrFF8HDZLOOFRYU9zGkb7PJy8qCMVgEe1qrNNFUsnWtA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011487.html">
   <LINK REL="Next"  HREF="011491.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS</H1>
    <B>Moataz Elmasry</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3CCAJ_yQBmrFF8HDZLOOFRYU9zGkb7PJy8qCMVgEe1qrNNFUsnWtA%40mail.gmail.com%3E"
       TITLE="[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS">zaza1851983ml at googlemail.com
       </A><BR>
    <I>Fri Jul  8 10:20:55 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011487.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="011491.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11490">[ date ]</a>
              <a href="thread.html#11490">[ thread ]</a>
              <a href="subject.html#11490">[ subject ]</a>
              <a href="author.html#11490">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Do you know any of those 'exceptional' redirectors that can handle https?

Ok. So let's ignore the redirection for now and just try to whitelist some
https urls and deny anything else.

Now I'm trying to peek and bump the connection, just to obtain the
servername without causing much harm, but the https sites are now either
loading infinitely, or loading successfully, where they should have been
blacklisted, assuming the https unwrapping happened successfully. Could you
please have a look and tell me what's wrong with the following
configuration? BTW after playing with ssl_bump I realized that I didn't
really understand the steps(1,2,3) as well as when to peek/bump/stare
etc... . The squid.conf contains some comments and questions

squid.conf

&quot;
acl http_sites dstdomain play.google.com mydomain.com
acl https_sites ssl::server_name play.google.com mydomain.com

#match any url where the servername in the SNI is not empty
acl haveServerName ssl::server_name_regex .


http_access allow http_sites
http_access allow https_sites #My expectation is that this rule is matched
when the https connection has been unwrapped

sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB

http_access deny all

http_port 3127
http_port 3128 intercept
https_port 3129 cert=/etc/squid/ssl/example.com.cert
key=/etc/squid/ssl/example.com.private ssl-bump intercept
generate-host-certificates=on  version=1
options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE capath=/etc/ssl/certs/

sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3


ssl_bump peek step1  #Is this equivelant to &quot;ssl_bump peek step1 all ???&quot;

ssl_bump bump haveServerName !https_sites
#What about connections that didn't provide sni yet? Do they get to have
own definition for step2?
#Is this equivelant to &quot;ssl_bump  bump step2 haveServerName !https_sites&quot; ??
#Can I use step2 with some other acl?

ssl_bump splice all
#Is this now step3 for all?what about those urls who didn't have a match in
step2. Is this step2 for some and step3 for others?

coredump_dir /var/cache/squid
&quot;

Cheers and many thanks
Moataz

On Fri, Jul 8, 2016 at 12:52 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 8/07/2016 10:42 a.m., Moataz Elmasry wrote:
</I>&gt;<i> &gt; Hi all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I just had an idea. Refering to the last email.
</I>&gt;<i> &gt; The reason why I'm getting those &quot;Header forgery&quot; errors might be because
</I>&gt;<i> &gt; of the defined nat rules. I'm using the following rules:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; iptables -t nat -A OUTPUT --match owner --uid-owner proxy -p tcp --dport
</I>&gt;<i> 80
</I>&gt;<i> &gt; -j ACCEPT
</I>&gt;<i> &gt; iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to-destination
</I>&gt;<i> &gt; ${MY_IP}:3128
</I>&gt;<i> &gt; iptables -t nat -A OUTPUT --match owner --uid-owner proxy -p tcp --dport
</I>&gt;<i> &gt; 443 -j ACCEPT
</I>&gt;<i> &gt; iptables -t nat -A OUTPUT -p tcp --dport 443 -j DNAT --to-destination
</I>&gt;<i> &gt; ${MY_IP}:3129
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; so, the next thing is I changed the --to-destination lines as follows:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner proxy --dport 443
</I>&gt;<i> &gt; -j REDIRECT --to-port 3129
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But no success. Do these nat rules have anything to do with the header
</I>&gt;<i> &gt; forgery problem?
</I>&gt;<i>
</I>&gt;<i> Indirectly they do. The existence of NAT is why the security test is
</I>&gt;<i> being done. But that is unlikely to be avoidable.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160708/14dc018f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160708/14dc018f/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011487.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="011491.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11490">[ date ]</a>
              <a href="thread.html#11490">[ thread ]</a>
              <a href="subject.html#11490">[ subject ]</a>
              <a href="author.html#11490">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
