<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3C26c73a17-5495-1816-a41e-6fa0d70b29ae%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011490.html">
   <LINK REL="Next"  HREF="011492.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3C26c73a17-5495-1816-a41e-6fa0d70b29ae%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul  8 11:18:52 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011490.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="011492.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11491">[ date ]</a>
              <a href="thread.html#11491">[ thread ]</a>
              <a href="subject.html#11491">[ subject ]</a>
              <a href="author.html#11491">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/07/2016 10:20 p.m., Moataz Elmasry wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Do you know any of those 'exceptional' redirectors that can handle https?
</I>&gt;<i> 
</I>
I know they exist, some of my clients wrote and use some. But I can't
point you to any if thats what you are asking.

I can say though there r two things that can reliably be done with a
CONNECT request by a URL-rewriter;

1) return ERR, explicitly telling Squid not to re-write those tunnels.

This trades helper complexity for simpler squid.conf ACLs. Both simply
telling Squid not to re-write.

2) re-write the URI from domain:port to be IP:port.

If the IP it gets re-written to is the one the client was going to, this
is in effect telling Squid not to do DNS lookup when figuring out where
to send it. That can be useful when you don't want Squid to use
alternative IPs it might find via DNS.
 (NP: This wont affect the host verify checking as it happens too late.
This is actually just a fancy way to enforce the ORIGINAL_DST pass-thru
behaviour based on more complex things than host-verify detects)


&gt;<i> Ok. So let's ignore the redirection for now and just try to whitelist some
</I>&gt;<i> https urls and deny anything else.
</I>&gt;<i> 
</I>&gt;<i> Now I'm trying to peek and bump the connection, just to obtain the
</I>&gt;<i> servername without causing much harm, but the https sites are now either
</I>&gt;<i> loading infinitely, or loading successfully, where they should have been
</I>&gt;<i> blacklisted, assuming the https unwrapping happened successfully. Could you
</I>&gt;<i> please have a look and tell me what's wrong with the following
</I>&gt;<i> configuration? BTW after playing with ssl_bump I realized that I didn't
</I>&gt;<i> really understand the steps(1,2,3) as well as when to peek/bump/stare
</I>&gt;<i> etc... . The squid.conf contains some comments and questions
</I>&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> 
</I>&gt;<i> &quot;
</I>&gt;<i> acl http_sites dstdomain play.google.com mydomain.com
</I>&gt;<i> acl https_sites ssl::server_name play.google.com mydomain.com
</I>&gt;<i> 
</I>&gt;<i> #match any url where the servername in the SNI is not empty
</I>&gt;<i> acl haveServerName ssl::server_name_regex .
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access allow http_sites
</I>&gt;<i> http_access allow https_sites #My expectation is that this rule is matched
</I>&gt;<i> when the https connection has been unwrapped
</I>
On HTTP traffic the &quot;http_sites&quot; ACL will match the URL domain.

On HTTPS traffic without (or before finding) the SNI neither ACL will
match. Because URL is a raw-IP at that stage.

On HTTPS traffic with SNI the &quot;http_sites&quot; ACL will match. Because the
SNI got copied to the request URI.

The &quot;https_sites&quot; ACL will only be reached on traffic where the SNI does
*not* contain the values its looking for. This test will always be a
non-match / false.

&gt;<i> 
</I>&gt;<i> sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 3127
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3129 cert=/etc/squid/ssl/example.com.cert
</I>&gt;<i> key=/etc/squid/ssl/example.com.private ssl-bump intercept
</I>&gt;<i> generate-host-certificates=on  version=1
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE capath=/etc/ssl/certs/
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1  #Is this equivelant to &quot;ssl_bump peek step1 all ???&quot;
</I>&gt;<i> 
</I>
Yes. &quot;all&quot; is a test that always produces match / true.

The &quot;ssl_bump peek step1 all&quot; means:
 If (at_step == SslBump1 and true == true) then do peeking.
 else ...

&gt;<i> ssl_bump bump haveServerName !https_sites
</I>&gt;<i> #What about connections that didn't provide sni yet? Do they get to have
</I>&gt;<i> own definition for step2?
</I>
For those:

 &quot;haveServerName&quot; being a regex &quot;.&quot; pattern will match the raw-IP in the
CONNECT request, the SNI value, or any subjectAltName in the server
certificate. One of those three will always exist and have a value that
'.' is matched against. Basically it can't fail - therefore you can
consider it just a complicated (and slow / CPU draining) way of checking
&quot;all&quot;.

AND

 &quot;https_sites&quot; produces false. The &quot;!&quot; turns that false into true.

So that line matches and &quot;bump&quot; action is done at step 2.

Bump being a final action means there is no step 3 for those requests.

NOTE:  Side effects of bump at step 2 (aka client-first bumping) is that
certificate Squid generates will be generated ONLY from squid.conf
settings and clientHello details.
 No server involvement, thus a very high chance that the server TLS
connection requirements and what Squid offers the client to use will
conflict or introduce downgrade attack vulnerabilities into these
connections.

 Whether that is okay is a grey area with disagreement possibilities on
all sides.
 * On the one hand you are probably configuring good security for the
client connection even when the server connection has worse TLS.
 * On the two hand you are potentially configuring something worse than
some servers.
 * On the third hand you are definitely fooling the client into thinking
it has different security level than the server connection can provide,
or vice-versa for the server knowledge about the client connection. Its
risky, and you can expect problems.


&gt;<i> #Is this equivelant to &quot;ssl_bump  bump step2 haveServerName !https_sites&quot; ??
</I>
Yes it is.

&gt;<i> #Can I use step2 with some other acl?
</I>
Er. You can use any ACL that has available data for the time and
position at which it is tested.
 In other words I would not suggest using ACLs that check HTTP response
headers at the ssl_bump checking time.

At step 2 of SSL-Bumping process you have client TCP connection details,
TLS clientHello details and initial extensions like SNI (well the ones
that have been implemented - SNI being the only useful one AFAIK).

&gt;<i> 
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> #Is this now step3 for all?what about those urls who didn't have a match in
</I>&gt;<i> step2. Is this step2 for some and step3 for others?
</I>
Any step2 traffic which fails the &quot;!https_sites&quot; test will match this.
Which means there is no step3 for those requests.

If you have been paying attention you will have noticed that all traffic
passing the &quot;!https_sites&quot; has been bumped, and all traffic failing that
same test has been spliced.

==&gt; Therefore, zero traffic reaches step 3.


My advice on this as a general rule-of-thumb is to splice at step 1 or 2
if you can. That solves a lot of possible problems with the splicing.
And to bump only at step 3 where the mimic feature can avoid a lot of
other problems with the bumping.

You will still encounter some problems though (guaranteed). Don't forget
that TLS is specifically designed to prevent 'bumping' from being done
on its connections. The fact that we can offer the feature at all for
generic use is a terrible statement about the Internets bad lack of
security.


Cheers.
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011490.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="011492.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11491">[ date ]</a>
              <a href="thread.html#11491">[ thread ]</a>
              <a href="subject.html#11491">[ subject ]</a>
              <a href="author.html#11491">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
