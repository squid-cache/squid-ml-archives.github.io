<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3CCAJ_yQB%3DqhjyNomcEK02Gva_RgOqZDfCnoWJ_S1-u-nuRAZ%3DdHQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011493.html">
   <LINK REL="Next"  HREF="011512.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS</H1>
    <B>Moataz Elmasry</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20shows%20IP%20addresses%20instead%20of%0A%20domain%20name%20when%20rewriting%20SSL/HTTPS&In-Reply-To=%3CCAJ_yQB%3DqhjyNomcEK02Gva_RgOqZDfCnoWJ_S1-u-nuRAZ%3DdHQ%40mail.gmail.com%3E"
       TITLE="[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS">zaza1851983ml at googlemail.com
       </A><BR>
    <I>Tue Jul 12 17:46:03 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011493.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="011512.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11509">[ date ]</a>
              <a href="thread.html#11509">[ thread ]</a>
              <a href="subject.html#11509">[ subject ]</a>
              <a href="author.html#11509">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

I kinda solved the problem (Thanks to you!!!)
All what was needed is to peek the important domains in step2 in order not
to cause them harm and bump everything else in step3. In this case I'm able
to read the dns names in the redirect script and block them accordingly

Here is the relevant part:
acl http_sites dstdomain play.google.com mydomain.com
acl https_sites ssl::server_name play.google.com mydomain.com

ssl_bump peek step1 all
ssl_bump peek step2 https_sites
ssl_bump bump step3 all !https_sites #http_sites won't be bumped anyway.
But just to be sure
url_rewrite_access allow all !http_sites

Of course I'm still not able to rewrite https address as discussed, but
this is a different story I guess.

The SslPeekAndSplice wiki page needs serious rework though as many of the
stuff discussed here are not explained on the page, which makes life really
hard for noobs like me. Is there a way to contribute back a little bit by
reworking that wiki page? I'll try to write a small post about
the SslPeekAndSplice in the next few days.

Many Thanks again for the great help. Really appreciate it

Cheers,
Moataz

On Sun, Jul 10, 2016 at 10:42 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 10/07/2016 8:13 p.m., Moataz Elmasry wrote:
</I>&gt;<i> &gt; Hi Amos,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks I really learnt alot from your previous email.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; going on..
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Fri, Jul 8, 2016 at 1:18 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; On 8/07/2016 10:20 p.m., Moataz Elmasry wrote:
</I>&gt;<i> &gt;&gt;&gt; Hi Amos,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Do you know any of those 'exceptional' redirectors that can handle
</I>&gt;<i> https?
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I know they exist, some of my clients wrote and use some. But I can't
</I>&gt;<i> &gt;&gt; point you to any if thats what you are asking.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I can say though there r two things that can reliably be done with a
</I>&gt;<i> &gt;&gt; CONNECT request by a URL-rewriter;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; 1) return ERR, explicitly telling Squid not to re-write those tunnels.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This trades helper complexity for simpler squid.conf ACLs. Both simply
</I>&gt;<i> &gt;&gt; telling Squid not to re-write.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; 2) re-write the URI from domain:port to be IP:port.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; Funny thing is when I'm getting the URL in the redirect.bash, I'm not
</I>&gt;<i> &gt; getting an IP. I probed and logged in many fields as described in the
</I>&gt;<i> &gt; logformat page, and I usually get either the IP or the DNS inside
</I>&gt;<i> &gt; redirect.bash but not both
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If the IP it gets re-written to is the one the client was going to, this
</I>&gt;<i> &gt;&gt; is in effect telling Squid not to do DNS lookup when figuring out where
</I>&gt;<i> &gt;&gt; to send it. That can be useful when you don't want Squid to use
</I>&gt;<i> &gt;&gt; alternative IPs it might find via DNS.
</I>&gt;<i> &gt;&gt;  (NP: This wont affect the host verify checking as it happens too late.
</I>&gt;<i> &gt;&gt; This is actually just a fancy way to enforce the ORIGINAL_DST pass-thru
</I>&gt;<i> &gt;&gt; behaviour based on more complex things than host-verify detects)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Ok. So let's ignore the redirection for now and just try to whitelist
</I>&gt;<i> &gt;&gt; some
</I>&gt;<i> &gt;&gt;&gt; https urls and deny anything else.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Now I'm trying to peek and bump the connection, just to obtain the
</I>&gt;<i> &gt;&gt;&gt; servername without causing much harm, but the https sites are now
</I>&gt;<i> either
</I>&gt;<i> &gt;&gt;&gt; loading infinitely, or loading successfully, where they should have
</I>&gt;<i> been
</I>&gt;<i> &gt;&gt;&gt; blacklisted, assuming the https unwrapping happened successfully. Could
</I>&gt;<i> &gt;&gt; you
</I>&gt;<i> &gt;&gt;&gt; please have a look and tell me what's wrong with the following
</I>&gt;<i> &gt;&gt;&gt; configuration? BTW after playing with ssl_bump I realized that I didn't
</I>&gt;<i> &gt;&gt;&gt; really understand the steps(1,2,3) as well as when to peek/bump/stare
</I>&gt;<i> &gt;&gt;&gt; etc... . The squid.conf contains some comments and questions
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; squid.conf
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; &quot;
</I>&gt;<i> &gt;&gt;&gt; acl http_sites dstdomain play.google.com mydomain.com
</I>&gt;<i> &gt;&gt;&gt; acl https_sites ssl::server_name play.google.com mydomain.com
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; #match any url where the servername in the SNI is not empty
</I>&gt;<i> &gt;&gt;&gt; acl haveServerName ssl::server_name_regex .
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access allow http_sites
</I>&gt;<i> &gt;&gt;&gt; http_access allow https_sites #My expectation is that this rule is
</I>&gt;<i> &gt;&gt; matched
</I>&gt;<i> &gt;&gt;&gt; when the https connection has been unwrapped
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On HTTP traffic the &quot;http_sites&quot; ACL will match the URL domain.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On HTTPS traffic without (or before finding) the SNI neither ACL will
</I>&gt;<i> &gt;&gt; match. Because URL is a raw-IP at that stage.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On HTTPS traffic with SNI the &quot;http_sites&quot; ACL will match. Because the
</I>&gt;<i> &gt;&gt; SNI got copied to the request URI.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The &quot;https_sites&quot; ACL will only be reached on traffic where the SNI does
</I>&gt;<i> &gt;&gt; *not* contain the values its looking for. This test will always be a
</I>&gt;<i> &gt;&gt; non-match / false.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; Ouch, I now see in the docs that ssl::server_name is suitable for usage
</I>&gt;<i> &gt; within ssl_bump. So this is the only use case I suppose.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access deny all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_port 3127
</I>&gt;<i> &gt;&gt;&gt; http_port 3128 intercept
</I>&gt;<i> &gt;&gt;&gt; https_port 3129 cert=/etc/squid/ssl/example.com.cert
</I>&gt;<i> &gt;&gt;&gt; key=/etc/squid/ssl/example.com.private ssl-bump intercept
</I>&gt;<i> &gt;&gt;&gt; generate-host-certificates=on  version=1
</I>&gt;<i> &gt;&gt;&gt; options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE capath=/etc/ssl/certs/
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; sslproxy_cert_error allow all
</I>&gt;<i> &gt;&gt;&gt; sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt;&gt;&gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt;&gt;&gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step1  #Is this equivelant to &quot;ssl_bump peek step1 all
</I>&gt;<i> ???&quot;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Yes. &quot;all&quot; is a test that always produces match / true.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The &quot;ssl_bump peek step1 all&quot; means:
</I>&gt;<i> &gt;&gt;  If (at_step == SslBump1 and true == true) then do peeking.
</I>&gt;<i> &gt;&gt;  else ...
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump bump haveServerName !https_sites
</I>&gt;<i> &gt;&gt;&gt; #What about connections that didn't provide sni yet? Do they get to
</I>&gt;<i> have
</I>&gt;<i> &gt;&gt;&gt; own definition for step2?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; For those:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  &quot;haveServerName&quot; being a regex &quot;.&quot; pattern will match the raw-IP in the
</I>&gt;<i> &gt;&gt; CONNECT request, the SNI value, or any subjectAltName in the server
</I>&gt;<i> &gt;&gt; certificate. One of those three will always exist and have a value that
</I>&gt;<i> &gt;&gt; '.' is matched against. Basically it can't fail - therefore you can
</I>&gt;<i> &gt;&gt; consider it just a complicated (and slow / CPU draining) way of checking
</I>&gt;<i> &gt;&gt; &quot;all&quot;.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; AND
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  &quot;https_sites&quot; produces false. The &quot;!&quot; turns that false into true.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; So that line matches and &quot;bump&quot; action is done at step 2.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Bump being a final action means there is no step 3 for those requests.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; NOTE:  Side effects of bump at step 2 (aka client-first bumping) is that
</I>&gt;<i> &gt;&gt; certificate Squid generates will be generated ONLY from squid.conf
</I>&gt;<i> &gt;&gt; settings and clientHello details.
</I>&gt;<i> &gt;&gt;  No server involvement, thus a very high chance that the server TLS
</I>&gt;<i> &gt;&gt; connection requirements and what Squid offers the client to use will
</I>&gt;<i> &gt;&gt; conflict or introduce downgrade attack vulnerabilities into these
</I>&gt;<i> &gt;&gt; connections.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  Whether that is okay is a grey area with disagreement possibilities on
</I>&gt;<i> &gt;&gt; all sides.
</I>&gt;<i> &gt;&gt;  * On the one hand you are probably configuring good security for the
</I>&gt;<i> &gt;&gt; client connection even when the server connection has worse TLS.
</I>&gt;<i> &gt;&gt;  * On the two hand you are potentially configuring something worse than
</I>&gt;<i> &gt;&gt; some servers.
</I>&gt;<i> &gt;&gt;  * On the third hand you are definitely fooling the client into thinking
</I>&gt;<i> &gt;&gt; it has different security level than the server connection can provide,
</I>&gt;<i> &gt;&gt; or vice-versa for the server knowledge about the client connection. Its
</I>&gt;<i> &gt;&gt; risky, and you can expect problems.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; #Is this equivelant to &quot;ssl_bump  bump step2 haveServerName
</I>&gt;<i> &gt;&gt; !https_sites&quot; ??
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Yes it is.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; #Can I use step2 with some other acl?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Er. You can use any ACL that has available data for the time and
</I>&gt;<i> &gt;&gt; position at which it is tested.
</I>&gt;<i> &gt;&gt;  In other words I would not suggest using ACLs that check HTTP response
</I>&gt;<i> &gt;&gt; headers at the ssl_bump checking time.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; At step 2 of SSL-Bumping process you have client TCP connection details,
</I>&gt;<i> &gt;&gt; TLS clientHello details and initial extensions like SNI (well the ones
</I>&gt;<i> &gt;&gt; that have been implemented - SNI being the only useful one AFAIK).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump splice all
</I>&gt;<i> &gt;&gt;&gt; #Is this now step3 for all?what about those urls who didn't have a
</I>&gt;<i> match
</I>&gt;<i> &gt;&gt; in
</I>&gt;<i> &gt;&gt;&gt; step2. Is this step2 for some and step3 for others?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Any step2 traffic which fails the &quot;!https_sites&quot; test will match this.
</I>&gt;<i> &gt;&gt; Which means there is no step3 for those requests.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If you have been paying attention you will have noticed that all traffic
</I>&gt;<i> &gt;&gt; passing the &quot;!https_sites&quot; has been bumped, and all traffic failing that
</I>&gt;<i> &gt;&gt; same test has been spliced.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ==&gt; Therefore, zero traffic reaches step 3.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Many thanks for the detailed clarification, this really helps ALOT!!!!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; My advice on this as a general rule-of-thumb is to splice at step 1 or 2
</I>&gt;<i> &gt;&gt; if you can. That solves a lot of possible problems with the splicing.
</I>&gt;<i> &gt;&gt; And to bump only at step 3 where the mimic feature can avoid a lot of
</I>&gt;<i> &gt;&gt; other problems with the bumping.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; You will still encounter some problems though (guaranteed). Don't forget
</I>&gt;<i> &gt;&gt; that TLS is specifically designed to prevent 'bumping' from being done
</I>&gt;<i> &gt;&gt; on its connections. The fact that we can offer the feature at all for
</I>&gt;<i> &gt;&gt; generic use is a terrible statement about the Internets bad lack of
</I>&gt;<i> &gt;&gt; security.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Cheers.
</I>&gt;<i> &gt;&gt; Amos
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; Ok. new try.  The following are common configurations:
</I>&gt;<i> &gt; &quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl http_sites dstdomain play.google.com mydomain.com
</I>&gt;<i> &gt; acl https_sites ssl::server_name play.google.com mydomain.com
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow http_sites
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 3127
</I>&gt;<i> &gt; http_port 3128 intercept
</I>&gt;<i> &gt; https_port 3129 cert=/etc/squid/ssl/example.com.cert
</I>&gt;<i> &gt; key=/etc/squid/ssl/example.com.private ssl-bump intercept
</I>&gt;<i> &gt; generate-host-certificates=on  version=1
</I>&gt;<i> &gt; options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE capath=/etc/ssl/certs/
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sslproxy_cert_error allow all
</I>&gt;<i> &gt; sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; url_rewrite_program /bin/bash -c -l /etc/squid/redirect.bash
</I>&gt;<i> &gt; url_rewrite_extras &quot;%&gt;a/%&gt;A %&lt;A la=%la:%lp la2=%&lt;a/%&lt;a  la3=%&lt;la:%&lt;lp %un
</I>&gt;<i> &gt; %&gt;rm myip=%la myport=%lp  ru=%ru ru2=%&gt;ru ru3=%&lt;ru rd=%&gt;rd rd2=%&lt;rd h=%&gt;h
</I>&gt;<i> &gt; ssl1=%ssl::bump_mode ssl2=%ssl::&gt;sni ssl3=%ssl::&gt;cert_subject
</I>&gt;<i> &gt; ssl4=%ssl::&gt;cert_issuer  rp1=%rp rp2=%&gt;rp rp3=%&lt;rp h1=%&gt;h h2=%&gt;ha&quot;
</I>&gt;<i> &gt; logformat squid &quot;%&gt;a/%&gt;A %&lt;A la=%la:%lp la2=%&lt;a/%&lt;a  la3=%&lt;la:%&lt;lp  %un
</I>&gt;<i> &gt; %&gt;rm myip=%la myport=%lp  ru=%ru ru2=%&gt;ru ru3=%&lt;ru rd=%&gt;rd rd2=%&lt;rd h=%&gt;h
</I>&gt;<i> &gt; ssl1=%ssl::bump_mode ssl2=%ssl::&gt;sni ssl3=%ssl::&gt;cert_subject
</I>&gt;<i> &gt; ssl4=%ssl::&gt;cert_issuer  rp1=%rp rp2=%&gt;rp rp3=%&lt;rp h1=%&gt;h h2=%&gt;ha&quot;
</I>&gt;<i> &gt; url_rewrite_access allow all
</I>&gt;<i> &gt; &quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Using
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &quot;ssl_bump splice step1 all
</I>&gt;<i> &gt; ssl_bump bump step3 all&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Nothing is blocked. And I don't see any urls, nor sni info neither in
</I>&gt;<i> &gt; access.log nor in my redirect.log.Only IPs.  I'm trying many https sites.
</I>&gt;<i>
</I>&gt;<i> Because &quot;all&quot; traffic got spliced at step1. Nothing go to the step3
</I>&gt;<i> bumping.
</I>&gt;<i>
</I>&gt;<i> Sorry if my general rule-of-thumb description was not clear. I meant
</I>&gt;<i> those RoT to be used as a preference for what stage to do splice or bump
</I>&gt;<i> - for the things you want them respectively to apply to.
</I>&gt;<i>  You still need other ACLs defining what traffic the action is to be
</I>&gt;<i> applied on.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Using
</I>&gt;<i> &gt; &quot;ssl_bump splice step2 all
</I>&gt;<i> &gt; ssl_bump bump step3 all&quot;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Splice still happens to &quot;all&quot; traffic.
</I>&gt;<i>
</I>&gt;<i> &gt; Same result.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Using
</I>&gt;<i> &gt; &quot;
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt; ssl_bump splice step2  all
</I>&gt;<i> &gt; ssl_bump bump step3 all
</I>&gt;<i> &gt; &quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I can see URLs in the access.log and redirect.log but no IP's. Further
</I>&gt;<i> I'm
</I>&gt;<i> &gt; getting the header forgery warning in the logs, and all pages start
</I>&gt;<i> &gt; loading, but never finish. Maybe this is something related to the nat
</I>&gt;<i> rules
</I>&gt;<i> &gt; in the iptables?
</I>&gt;<i>
</I>&gt;<i> No.
</I>&gt;<i>
</I>&gt;<i> peek is  non-final action, grabbing the SNI and clientHello details. It
</I>&gt;<i> only stops the current step's ACL evaluation. ssl_bump gets re-evaluated
</I>&gt;<i> for future step's.
</I>&gt;<i>
</I>&gt;<i> splice and bump are both &quot;final&quot; actions. SSL-Bumping process in its
</I>&gt;<i> entirety stops and does the action chosen. It does not continue to do
</I>&gt;<i> any other ssl_bump things once one of them is reached.
</I>&gt;<i>
</I>&gt;<i> In the above peek happens to all traffic, then splice happens to all
</I>&gt;<i> traffic.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For info, I'm using the simplest bash redirector for now. Here's the code
</I>&gt;<i> &gt; while true;
</I>&gt;<i> &gt; do
</I>&gt;<i> &gt;     read input;
</I>&gt;<i> &gt;     echo &quot;input=${input}&quot;  &gt;&gt;/var/log/squid/redirects.log 2&gt;&amp;1
</I>&gt;<i> &gt;     old_url=$(echo ${input} | awk '{print $1}')
</I>&gt;<i> &gt;     echo &quot;${old_url}&quot;
</I>&gt;<i> &gt;     [[ $? != 0 ]] &amp;&amp; exit -1
</I>&gt;<i> &gt;     continue
</I>&gt;<i> &gt; done
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'll try squid4 next week, maybe the result will be better
</I>&gt;<i>
</I>&gt;<i> It won't be much better, the problem so far is in the ssl_bump ACL design.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160712/c35859a6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160712/c35859a6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011493.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="011512.html">[squid-users] url_rewrite_program shows IP addresses instead of domain name when rewriting SSL/HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11509">[ date ]</a>
              <a href="thread.html#11509">[ thread ]</a>
              <a href="subject.html#11509">[ subject ]</a>
              <a href="author.html#11509">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
