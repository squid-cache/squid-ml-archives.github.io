<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid and mysql to autenticate groups
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20and%20mysql%20to%20autenticate%20groups&In-Reply-To=%3C1dc3693b-2c96-a55e-835d-5eed6a50a4e5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011546.html">
   <LINK REL="Next"  HREF="011547.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid and mysql to autenticate groups</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20and%20mysql%20to%20autenticate%20groups&In-Reply-To=%3C1dc3693b-2c96-a55e-835d-5eed6a50a4e5%40treenet.co.nz%3E"
       TITLE="[squid-users] squid and mysql to autenticate groups">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 15 08:51:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011546.html">[squid-users] squid and mysql to autenticate groups
</A></li>
        <LI>Next message (by thread): <A HREF="011547.html">[squid-users] about cpu status
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11551">[ date ]</a>
              <a href="thread.html#11551">[ thread ]</a>
              <a href="subject.html#11551">[ subject ]</a>
              <a href="author.html#11551">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/07/2016 5:14 a.m., Ottavia Neruda wrote:
&gt;<i> hello,
</I>&gt;<i> I'have 2 tables in mysql.
</I>&gt;<i> First table is Group1 and other is Group2.
</I>&gt;<i> I'd like that user in Group1 are enabled to surfing in Sites1 list of 
</I>&gt;<i> sites and Group2 in Sites2 list of sites.
</I>
&lt;snip/paste&gt;
&gt;<i>
</I>&gt;<i> Why it does'nt work?
</I>
Because authorization (auth-z) is different from authentication
(auth-n). Simply naming an ACL a &quot;group&quot; check, does not make it one.

* Auth-n is a simple check to verify that _the client is who it claims
to be_.
 It is all about identity. Not access.

* Auth-z is a check to see whether the user account the client claims to
be is _allowed to access_ the requested URL resource.
 Its all about access, not identity.

. N
&gt;<i> In squid.conf I did:
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program  /usr/lib/squid/basic_db_auth --dsn 
</I>&gt;<i> &quot;DBI:mysql:database=squid&quot; --user &quot;utente_lettore&quot; --password &quot;password&quot; 
</I>&gt;<i> --table &quot;Group1&quot; --usercol &quot;user&quot; --passwdcol &quot;passwor$
</I>
Tells Squid how to perform auth-n using the Basic authentication
protocol and a MySQL database.
The user accounts are stored in a tables called &quot;Group1&quot;.

&gt;<i> 
</I>&gt;<i> auth_param basic children 15
</I>&gt;<i> auth_param basic realm proxy2
</I>&gt;<i> auth_param basic credentialsttl 1 minute
</I>&gt;<i> auth_param basic casesensitive off
</I>&gt;<i> 
</I>&gt;<i> acl db-Group1 proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program  /usr/lib/squid/basic_db_auth --dsn 
</I>&gt;<i> &quot;DBI:mysql:database=squid&quot; --user &quot;utente_lettore&quot; --password &quot;password&quot; 
</I>&gt;<i> --table &quot;Group2&quot; --usercol &quot;user&quot; --passwdcol &quot;passwor$
</I>&gt;<i> 
</I>
Tells Squid how to perform auth-n using the Basic authentication
protocol and a MySQL database.
The user accounts are stored in a tables called &quot;Group2&quot;.

This *replaces* the previous Basic authentication configuration.

Only users in the &quot;Group2&quot; table can be authenticated (auth-n), all
others are un-authenticated.


&gt;<i> auth_param basic children 15
</I>&gt;<i> auth_param basic realm proxy2
</I>&gt;<i> auth_param basic credentialsttl 1 minute
</I>&gt;<i> auth_param basic casesensitive off
</I>
So do these settings, but they replace previous config with the same
values. So no noticable harm from that. Just a waste of space in squid.conf.

&gt;<i> 
</I>&gt;<i> acl db-Group2 proxy_auth REQUIRED
</I>&gt;<i> 
</I>
You now have two ACLs called db-Group1 and db-Group2 - for which the way
to authenticate is offering Basic authentication to the client, and
looking the credentials it replies with up in the &quot;Group2&quot; table in your
MySQL database.
 These ACLs both do the exact same thing so are redundant.

&gt;<i> 
</I>&gt;<i> acl Sites1 dstdomain &quot;/etc/squid/webconsentiti.txt&quot;
</I>&gt;<i> acl Sites2 dstdomain &quot;/etc/squid/webconsentiti2.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access allow db-Group1 Sites1
</I>&gt;<i> http_access allow db-Group2 Sites2
</I>
Authenticated (auth-n) users are allowed to access domains listed in
Sites1 or in Sites2.

&gt;<i>  
</I>&gt;<i> http_access deny all
</I>
All other traffic is denied.



What you need to do is to have a table of users, where their username
and password can be verified (auth-n / authenticted). The basic_db_auth
helper looks there to do the authentication.

NP: I recommend against having a column called 'password'. That can
cause trouble with the MSQL built-in function called password in some
queries. It's caused me some headaches in the past.

And a second table listing the groups each user belongs to. And an
external_acl_type helper that looks up that table and tells Squid if a
user is in group1 or group2. You can copy and update the basic_db_auth
script to do external_acl_type checking intead of authentication. I've
called the example one below /etc/squid/db_group, it receives &quot;username
groupname&quot; from Squid.


 # how to authenticate
 auth_param basic program  /usr/lib/squid/basic_db_auth \
  --dsn &quot;DBI:mysql:database=squid&quot; --user &quot;...&quot; --password &quot;...&quot; \
  --table &quot;accounts&quot; --usercol &quot;user&quot; --passwdcol &quot;passwd&quot;

 acl login proxy_auth REQUIRED

 # check what groups a user belongs to
 external_acl_type group %LOGIN /etc/squid/db_group \
  --dsn &quot;DBI:mysql:database=squid&quot; --user &quot;...&quot; --passsword &quot;...&quot; \
  --table &quot;groups&quot; --usercol &quot;user&quot; --passwdcol &quot;group&quot;

 acl group1 external group Group1
 acl group2 external group Group2

 # basic security controls and DoS prevention
 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

 # require authentication for any access
 http_access deny !login

 # allow groups only to their listed domains
 http_access allow group1 sites1
 http_access allow group2 sites2

 http_access deny all

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011546.html">[squid-users] squid and mysql to autenticate groups
</A></li>
	<LI>Next message (by thread): <A HREF="011547.html">[squid-users] about cpu status
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11551">[ date ]</a>
              <a href="thread.html#11551">[ thread ]</a>
              <a href="subject.html#11551">[ subject ]</a>
              <a href="author.html#11551">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
