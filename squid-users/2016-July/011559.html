<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] adaptation_access not working with squid acl's
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20adaptation_access%20not%20working%20with%20squid%20acl%27s&In-Reply-To=%3CCAOKqvx5B5UnG3AXn87OS6quTUj2OXcOX4SgJmboe-cmH%2BmmFcA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011558.html">
   <LINK REL="Next"  HREF="011570.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] adaptation_access not working with squid acl's</H1>
    <B>Stephen Stark</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20adaptation_access%20not%20working%20with%20squid%20acl%27s&In-Reply-To=%3CCAOKqvx5B5UnG3AXn87OS6quTUj2OXcOX4SgJmboe-cmH%2BmmFcA%40mail.gmail.com%3E"
       TITLE="[squid-users] adaptation_access not working with squid acl's">logic4life at gmail.com
       </A><BR>
    <I>Fri Jul 15 14:38:40 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011558.html">[squid-users] adaptation_access not working with squid acl's
</A></li>
        <LI>Next message (by thread): <A HREF="011570.html">[squid-users] adaptation_access not working with squid acl's
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11559">[ date ]</a>
              <a href="thread.html#11559">[ thread ]</a>
              <a href="subject.html#11559">[ subject ]</a>
              <a href="author.html#11559">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I think I figured out what the problem is but I'd appreciate if someone
could check my reasoning.

My ACL is type localport, so I'm targeting the original request to Squid
based on the Squid port the client is connecting to:

acl test localport 4000

Then I enable adaptation_access based on the ACL test:

adaptation_access service_avi_req allow test
adaptation_access service_avi_resp allow test

So here is where I think the problem is.  The client is connecting to Squid
on port 4000, so the initial request it put in the ACL &quot;test&quot;, however for
some reason this ACL is not being
hit when adaptation_access is being used. I'm wondering if the reason is
because localport is no longer the port the client connected to Squid on,
but rather the port Squid is using to connect to the ICAP server?

I've verified with full debugging that the test ACL is not matched in the
adaptation checks:

(initial request)

2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(70) preCheck: 0xf3c2f8
checking slow rules
2016/07/15 10:32:44.246 kid1| 28,3| ServerName.cc(42) match: checking
'64.182.224.149'
2016/07/15 10:32:44.246 kid1| 28,3| ServerName.cc(47) match:
'64.182.224.149' NOT found
2016/07/15 10:32:44.246 kid1| 28,3| ServerName.cc(42) match: checking 'none'
2016/07/15 10:32:44.246 kid1| 28,3| ServerName.cc(47) match: 'none' NOT
found
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked:
nobumpSites = 0
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked: (ssl_bump
rule) = 0
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked: Test = 1
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked: (ssl_bump
rule) = 1
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked: (ssl_bump
rules) = 1
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(63) markFinished: 0xf3c2f8
answer ALLOWED for match
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(163) checkCallback:
ACLChecklist::checkCallback: 0xf3c2f8 answer=ALLOWED

(And now I'm guessing this is adaptation checking ACL's)

2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(70) preCheck: 0xf40bb8
checking slow rules
2016/07/15 10:32:44.246 kid1| 28,3| Ip.cc(539) match: aclIpMatchIp: '
192.168.100.6:61769' found
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked:
http_access#1 = 1
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked:
http_access = 1
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(63) markFinished: 0xf40bb8
answer ALLOWED for match
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(163) checkCallback:
ACLChecklist::checkCallback: 0xf40bb8 answer=ALLOWED
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(70) preCheck: 0xf3c2f8
checking slow rules
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked: Test = 0
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked:
adaptation_access#1 = 0
2016/07/15 10:32:44.246 kid1| 28,3| Ip.cc(539) match: aclIpMatchIp: '
192.168.100.6:61769' found
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked: all = 1
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked:
adaptation_access#2 = 1
2016/07/15 10:32:44.246 kid1| 28,3| Acl.cc(158) matches: checked:
adaptation_access = 1
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(63) markFinished: 0xf3c2f8
answer DENIED for match
2016/07/15 10:32:44.246 kid1| 28,3| Checklist.cc(163) checkCallback:
ACLChecklist::checkCallback: 0xf3c2f8 answer=DENIED

What I don't get however is in this above log entry snapshot, the client
source port (192.168.100.6) is shown, so I'd assume the localport would
match.

This works if I change the ACL type to src IP address rather than
localport, however the whole point of this is because I have another
facility that is categorizing users by group and distributing them to Squid
on specific destination ports.  So I really need this to work based on
localport.

Any thoughts?





On Fri, Jul 15, 2016 at 6:53 AM, Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA256
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 15.07.2016 15:41, Amos Jeffries &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;<i> &gt; On 15/07/2016 6:35 a.m., Yuri Voinov wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/action/show/HelpOnAccessControlLists?action=show&amp;redirect=HelpOnAcl">http://wiki.squid-cache.org/action/show/HelpOnAccessControlLists?action=show&amp;redirect=HelpOnAcl</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Yrui;  note that the &quot;HelpOn&quot; wiki pages are for help using the wiki
</I>&gt;<i> &gt; itself. Not help using Squid.
</I>&gt;<i> Oooooooops. My mistake.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think you meant to reference:
</I>&gt;<i> &gt; &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&gt;
</I>&gt;<i> Yes, sure.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Amos
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2
</I>&gt;<i>
</I>&gt;<i> iQEcBAEBCAAGBQJXiMCiAAoJENNXIZxhPexGqdcH/02vxPWujZRDFeK6BZOXkGiX
</I>&gt;<i> IwAR6A3ovJpaucTaQhMXZUblIOcWXKs9MzZ2vwS8dCXaK6cppTWYL5+2rjxelOER
</I>&gt;<i> YE7Sjwf7J1gxC7DoHfvXkCWSL8ueBnF+9xrWj/dflaZBYRqGqdmUq0QT7FqTXXBu
</I>&gt;<i> 8EGnXvyORd7Ta9xgEuhjwLcUkQ51wMRd4CB861LmmidHD2nXm78DaYomIHKanYtD
</I>&gt;<i> fcE+i7G6tQyUBh9V0F5IEa6p6/PfvTokLbO5OlsJhGIE5rb8DoA7P78q7X2WJJi6
</I>&gt;<i> 89dR2mW+G8bcKmnVWLy8gl5Q1k8ByUvkmKbapdsuOOyzKK6grsY7nqE7+MyffRQ=
</I>&gt;<i> =1gkl
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160715/a411f20c/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160715/a411f20c/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011558.html">[squid-users] adaptation_access not working with squid acl's
</A></li>
	<LI>Next message (by thread): <A HREF="011570.html">[squid-users] adaptation_access not working with squid acl's
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11559">[ date ]</a>
              <a href="thread.html#11559">[ thread ]</a>
              <a href="subject.html#11559">[ subject ]</a>
              <a href="author.html#11559">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
