<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl maxconn and max_user_ip config help please
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20maxconn%20and%20max_user_ip%20config%20help%20please&In-Reply-To=%3C818bab3f-c7ea-9b62-a699-03ca6293a758%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011585.html">
   <LINK REL="Next"  HREF="011610.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl maxconn and max_user_ip config help please</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20maxconn%20and%20max_user_ip%20config%20help%20please&In-Reply-To=%3C818bab3f-c7ea-9b62-a699-03ca6293a758%40treenet.co.nz%3E"
       TITLE="[squid-users] acl maxconn and max_user_ip config help please">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jul 18 07:15:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011585.html">[squid-users] acl maxconn and max_user_ip config help please
</A></li>
        <LI>Next message (by thread): <A HREF="011610.html">[squid-users] acl maxconn and max_user_ip config help please
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11587">[ date ]</a>
              <a href="thread.html#11587">[ thread ]</a>
              <a href="subject.html#11587">[ subject ]</a>
              <a href="author.html#11587">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/07/2016 6:23 p.m., B. Henry wrote:
&gt;<i> First, thanks for answering.
</I>&gt;<i> Second, I have read the entire default conf file, yes, once made the mistake of reading one for a different squid version than mine, but then got a fresh 
</I>&gt;<i> copy of the one for my exact version.
</I>&gt;<i> I've also read the FAQ, and most all the configuration guide, but if I had not I certainly would be greatful for the links.
</I>&gt;<i> My misunderstanding then is now in how to apply a rule that will only effect group foo with out reusing the name.
</I>&gt;<i> Would I first name the group as I have and then make a maxconn line, e.g.
</I>&gt;<i> acl foo_MC maxconn 15
</I>&gt;<i> and then
</I>&gt;<i>  http_access allow foo
</I>&gt;<i>  http_access foo_MC
</I>&gt;<i> 
</I>&gt;<i> and if this is correct, 
</I>
It is not correct as-is. The allow/deny action is missing on the foo_MC
line. (Plus the logic mistake explained below.)

&gt;<i> is it just the ordering there that means that this maxconn will only apply to group foo?
</I>
No. The above config means the opposite of that.

Top-to-bottom, left-to-right boolean conditions.

 # if foo, then Allow
 http_access allow foo

 # else if foo_MC, then ???
 http_access ??? foo_MC

 # else if true, then deny
 http_access deny all

foo_MC test will never be reached (and so not applied) for anything
which is already Allow'ed by the &quot;foo&quot; ACL test.

So logically, the foo_MC rule is applied (only) to non-&quot;foo&quot; traffic.


&gt;<i> If not, how do I make the rule only apply to group foo?
</I>

One would usually construct the access lists to enforce a logically
arranged policy something like this:

 # 0) default security rules preventing various attacks
 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

 # 1) prevent foo from using more that 15 TCP connections to the proxy
 http_access deny foo foo_MC

 # 2) allow foo (with 15 or les connections) to use the proxy
 http_access allow foo

 # 3) allow LAN clients (not in group foo) to use the proxy
 http_access allow locanet

 # 4) deny other (external / non-LAN) traffic
 http_access deny all


Any http_access line which contains 'foo' ACL can only match when that
test of foo is a match, so that action on it by definition applies only
to the set of transactions where foo is matched/true.

Any http_access line which matches completely will halt http_access
processing. So a line which contains only &quot;foo&quot; ACL and the action, will
prevent any following lines being used for that group.

The above two points/details are why the &quot;deny foo foo_MC&quot; line is
ordered above the &quot;allow foo&quot; line in the above example config.
 --&gt; If they were the other way around the &quot;allow foo&quot; would end the
processing for &quot;foo&quot; group with an allow action. The any line containign
&quot;foo&quot; after that would never be a match for anything that could reach it.



PS. there is a gotcha with the maxconn ACL in HTTP/1.1 traffic that you
need to be aware of. Particularly when using the -s flag.

 If a client opens more than maxconn limit number of TCP connections.
Then *any* HTTP request received from that client on *any* of those
connections will see a true/match for the maxconn test. So will be
denied until one of the connections is closed.

 maxconn was designed for use in HTTP/1.0 traffic where each TCP
connection carried only one HTTP request, then gets closed. So the deny
action would directly result in -1 TCP connections and other requests
possibly being allowed.

 HTTP/1.1 connections (eg Squid-3.1 and later) are by default
persistent, so can carry multiple requests. The denial response does not
trigger a -1 TCP connection like HTTP/.0 did. So HTTP/1.1 connections
can stay open and triggering denial for a long while after the client
hits the limit. Traffic where maxconn works well is becoming rare.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011585.html">[squid-users] acl maxconn and max_user_ip config help please
</A></li>
	<LI>Next message (by thread): <A HREF="011610.html">[squid-users] acl maxconn and max_user_ip config help please
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11587">[ date ]</a>
              <a href="thread.html#11587">[ thread ]</a>
              <a href="subject.html#11587">[ subject ]</a>
              <a href="author.html#11587">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
