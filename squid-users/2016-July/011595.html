<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20req_header%20result%20in%20cache_peer_access%20when%0A%20using%20ssl_bump&In-Reply-To=%3CCANJ0oHcaiLvPkAD5hF69ddGbFED-rhJu4D-63%2B385YTF1QvHRA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011567.html">
   <LINK REL="Next"  HREF="011599.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump</H1>
    <B>Mihai Ene</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20req_header%20result%20in%20cache_peer_access%20when%0A%20using%20ssl_bump&In-Reply-To=%3CCANJ0oHcaiLvPkAD5hF69ddGbFED-rhJu4D-63%2B385YTF1QvHRA%40mail.gmail.com%3E"
       TITLE="[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump">me at ub.io
       </A><BR>
    <I>Mon Jul 18 10:23:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011567.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="011599.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11595">[ date ]</a>
              <a href="thread.html#11595">[ thread ]</a>
              <a href="subject.html#11595">[ subject ]</a>
              <a href="author.html#11595">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I have created a gist with the relevant parts of `cache.log`
(post-connection)
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52</A>

The following logs are available:

1. The initial HTTP CONNECT requests on port :8000 on line 51
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L51">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L51</A>

2. The mark 0x10 is set on line 435
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L435">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L435</A>

3. The redirected HTTPS request on port :8443 comes in, line 467
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L467">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L467</A>

4. The forwarded CONNECT request is on line 526
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L526">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L526</A>

5. X-My-Header is *NOT* found on line 966
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L966">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L966</A>

5. The bumped contents are on line 1575
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L1575">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L1575</A>
, where X-My-Header is visible


The following inconsistencies are seen:

a. The X-My-Header is *not* added to the CONNECT request according to
config
<A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-1-squid-conf-L19">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-1-squid-conf-L19</A>
b. X-My-Header NOT found on line 966, although it is clearly visible on
line 1579

-----

The reason I was asking earlier whether this is the expected behaviour or
not, was because I was wondering whether the ACLs apply to the CONNECT
request contents, or to the ssl_bump contents.

Is there a way to determine the cache_peer based on ssl bumped contents?

If not, is there a way to add X-My-Header to the CONNECT request, as a
workaround to ssl bumped contents not following any ACLs?

If not, is there a way to set the cache_peer based on the headers of the
bumped request?

If there's nothing I can do about this, is there a way to set the
ssl_bumped cache_peer based on the earlier proxy_auth username?



*Mihai Ene*
Software Developer

*UB | Your universal basket*

<A HREF="http://ub.io">http://ub.io</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">me at ub.io</A>
@shop_ub
+44 (0)7473 804972 &lt;+447473804972&gt;

On Fri, Jul 15, 2016 at 8:18 PM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 07/15/2016 12:11 PM, Mihai Ene wrote:
</I>&gt;<i> &gt; I have a working ssl_bump
</I>&gt;<i> &gt; configuration when using direct connections. However, cache_peer and
</I>&gt;<i> &gt; cache_peer_access have req_header rules which aren't followed in bumped
</I>&gt;<i> &gt; connections.
</I>&gt;<i>
</I>&gt;<i> If Squid has access to [fake or real] request headers, they should be
</I>&gt;<i> available to ACLs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; In logs, immediately after bumping, I see attempts to read X-My-Header
</I>&gt;<i> &gt; during cache_peer_access rules, and the header appears to always be
</I>&gt;<i> &gt; empty and ACLs always evaluate to 0, although the same logs show the
</I>&gt;<i> &gt; correct, expected X-My-Header later on, when forwarding the request.
</I>&gt;<i>
</I>&gt;<i> I can think of two possibilities:
</I>&gt;<i>
</I>&gt;<i> 1. When debugging, you are looking at CONNECT transactions (rather than
</I>&gt;<i> HTTP requests inside bumped CONNECT tunnels) _and_ your CONNECT
</I>&gt;<i> transactions do not have X-My-Header.
</I>&gt;<i>
</I>&gt;<i> 2. It is a bug you should report.
</I>&gt;<i>
</I>&gt;<i> If there is an X-My-Header in CONNECT transactions that your Squid
</I>&gt;<i> receives, see #2. Otherwise, see #1. You can use wireshark or Squid
</I>&gt;<i> ALL,2 debugging to see CONNECT headers that Squid receives.
</I>&gt;<i>
</I>&gt;<i> The above assumes you are not intercepting SSL connections and are not
</I>&gt;<i> dynamically adding X-My-Header to the received requests.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160718/819f88ec/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160718/819f88ec/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011567.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="011599.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11595">[ date ]</a>
              <a href="thread.html#11595">[ thread ]</a>
              <a href="subject.html#11595">[ subject ]</a>
              <a href="author.html#11595">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
