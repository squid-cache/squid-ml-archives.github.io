<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20communication%20about%20HIT/MISS%20between%0A%20squid%20and%20and%20non-squid%20peer&In-Reply-To=%3C98811263-6c3e-034d-3c22-68b7d1a4b43f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011589.html">
   <LINK REL="Next"  HREF="011623.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20communication%20about%20HIT/MISS%20between%0A%20squid%20and%20and%20non-squid%20peer&In-Reply-To=%3C98811263-6c3e-034d-3c22-68b7d1a4b43f%40treenet.co.nz%3E"
       TITLE="[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jul 18 10:55:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011589.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
        <LI>Next message (by thread): <A HREF="011623.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11597">[ date ]</a>
              <a href="thread.html#11597">[ thread ]</a>
              <a href="subject.html#11597">[ subject ]</a>
              <a href="author.html#11597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/07/2016 8:05 p.m., Omid Kosari wrote:
&gt;<i> Maybe i should describe more .
</I>&gt;<i> The port 8080 is a parent peer of squid . It is
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Windows-Updates-a-Caching-Stub-zone-A-windows-updates-store-td4678454.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Windows-Updates-a-Caching-Stub-zone-A-windows-updates-store-td4678454.html</A>
</I>&gt;<i> 
</I>&gt;<i> squid config is 
</I>&gt;<i> 
</I>&gt;<i> acl wu dstdom_regex \.download\.windowsupdate\.com$
</I>&gt;<i> acl wu-rejects dstdom_regex stats
</I>&gt;<i> acl GET method GET
</I>&gt;<i> cache_peer 127.0.0.1 parent 8080 0 proxy-only no-tproxy no-digest no-query
</I>&gt;<i> no-netdb-exchange name=ms1
</I>&gt;<i> cache_peer_access ms1 allow GET wu !wu-rejects
</I>&gt;<i> cache_peer_access ms1 deny all
</I>&gt;<i> never_direct allow GET wu !wu-rejects
</I>&gt;<i> never_direct deny all
</I>&gt;<i> 
</I>&gt;<i> and
</I>&gt;<i> 
</I>&gt;<i> iptables -t mangle -A OUTPUT -p tcp -m tcp -d
</I>&gt;<i> 127.0.0.1,192.168.1.1,192.168.1.2 --sport 8080 -j DSCP --set-dscp 0x60
</I>&gt;<i> 
</I>&gt;<i> Now with this iptables rule i want to change the dscp of packets which comes
</I>&gt;<i> from parent peer to squid . Then squid preserve that dscp and send it to
</I>&gt;<i> clients . With my description will everything work as i want ?
</I>
That is a clearer description. Thanks

Your answer is:  No. There are kernel patches required to allow Squid to
load the DSCP TOS marking from *incoming* packets from the peer.

Last I heard those patches were not accepted into the kernel, no longer
being maintained and no recent Linux kernel is compatible with them. You
might be lucky and find out otherwise, but I am doubtful.

There are two alternatives though:

 1) your above iptables rule is no different in behaviour on the
outgoing traffic side of Squid from what &quot;qos_flows tos parent-hit=0x60&quot;
should be doing.

So modulo bugs, there is no need to do anything with TOS on incoming
because Squid cache_peer line has the info saying that traffic was from
a parent (a versus any random connection marked with DSCP 0x60 inbound).
Data from the parent always arrives over connections associated by Squid
with that cache_peer config.


2) Squid can do pass-thru using Netfilter MARK flags. Each squid.conf
directive that deals with TOS has both a 'tos' and a 'mark' variant. The
'mark' ones are able to pass-thru these netfilter markings the way you want.

However, since netfilter marks are local to the one machine and not
transmitted externally. You need to use iptables rules to convert
received TOS/DSCP values into local MARK values on packets arriving, and
the reverse translation for packets leaving the machine.

IIRC there were some gotchas involved. I do remember specifically that
the TOS needed to be converted to CONNMARK (not MARK) in mangle or
earlier. Then the NF MARK values sync'd with CONNMARK at some stage just
after that (sorry my memory of that particular bit is long gone). The
sync'd NF MARK is what gets passed between Squid and the kernel.

It is a bit clumsy and annoying, but without any kernel API to receive
the TOS/DSCP values on incoming packets it is what it is.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011589.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
	<LI>Next message (by thread): <A HREF="011623.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11597">[ date ]</a>
              <a href="thread.html#11597">[ thread ]</a>
              <a href="subject.html#11597">[ subject ]</a>
              <a href="author.html#11597">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
