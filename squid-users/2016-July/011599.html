<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20req_header%20result%20in%20cache_peer_access%20when%0A%20using%20ssl_bump&In-Reply-To=%3C837cac1e-2a59-b3e0-fd88-c340214b48d8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011595.html">
   <LINK REL="Next"  HREF="011601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20req_header%20result%20in%20cache_peer_access%20when%0A%20using%20ssl_bump&In-Reply-To=%3C837cac1e-2a59-b3e0-fd88-c340214b48d8%40treenet.co.nz%3E"
       TITLE="[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jul 18 13:03:05 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011595.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="011601.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11599">[ date ]</a>
              <a href="thread.html#11599">[ thread ]</a>
              <a href="subject.html#11599">[ subject ]</a>
              <a href="author.html#11599">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/07/2016 10:23 p.m., Mihai Ene wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have created a gist with the relevant parts of `cache.log`
</I>&gt;<i> (post-connection)
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52</A>
</I>&gt;<i> 
</I>&gt;<i> The following logs are available:
</I>&gt;<i> 
</I>&gt;<i> 1. The initial HTTP CONNECT requests on port :8000 on line 51
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L51">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L51</A>
</I>&gt;<i> 
</I>
Between lines 1 and line 462;

Your Squid is receiving an HTTP CONNECT tunnel request from curl on FD
12. Your custom header exists on that CONNECT request.

Your access controls determine that:
 a) this tunnel is *not* to be bumped (by http_port lacking ssl-bump
option).
 b) that a direct outgoing server TCP connection is required (by
always_direct allow),

So Squid is required to *decapsulate* the CONNECT request and send the
data inside it to upstream server.

At this point there is an opaque payload in the CONNECT tunnel arriving
from client and being delivered over an opaque TCP connection to the
server. There is no HTTP messaging over that server connection as far as
Squid is concerned, just opaque bytes of data.

==&gt; Squid is not able to attach your custom HTTP header when there is no
outgoing HTTP message.


&gt;<i> 2. The mark 0x10 is set on line 435
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L435">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L435</A>
</I>&gt;<i> 
</I>&gt;<i> 3. The redirected HTTPS request on port :8443 comes in, line 467
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L467">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L467</A>
</I>&gt;<i> 
</I>
By &quot;redirected&quot; you mean NAT'ed.

At line 466 your OS NAT configuration folds the outgoing opaque tunnel
connection back into Squid.

As far as Squid is concerned this is a *new* HTTPS connection on the
intercept port using FD 18. It is important to be aware that there is
*no* information about your custom header from the previous CONNECT. A
new inbound connection is a clean slate.


&gt;<i> 4. The forwarded CONNECT request is on line 526
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L526">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L526</A>
</I>&gt;<i> 
</I>
No. Between line 467 and 628;

Squid is processing the fake CONNECT request representing the raw TCP
connection IP:port details. To see if the connection is to be rejected
immeditely, ssl-bump'ed or bypassed, etc.

==&gt; Since the request is completely internal to Squid, on a fresh new
TCP connection, it does not contain any of the curl sent headers.

==&gt; Since it is of course not an *outgoing* message. It does not have
any request_header_add custom alterations.

At line 611 your http_access rules fail to match (all of them). So the
implicit &quot;allow all&quot; happens to this pseudo-CONNECT.

at 628 ssl_bump indicates a need to peek at the TLS traffic.


between line 642 and 655; Squid is shoveling some of the opaque data
between its FD 12 and FD 16 connections.

Things then start interleaving between the inbound FD 18 connection and
the FD 12 &lt;-&gt; FD 16 opaque tunnel data transfer. I will ignore that
opaque shovelling from now in the between line X and Y statements.


between line 655 and 907 SSL-Bump is doing its peek thing with the TLS
now arriving on FD 18. At 907 it decides to bump using only the client
Hello details.


&gt;<i> 5. X-My-Header is *NOT* found on line 966
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L966">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L966</A>
</I>&gt;<i> 
</I>
between lines 908 and 1043;

Squid is doing its outbound server destination selection to figure out
where this TLS client request is going to go to.

Note that at this point the only state Squid has associated with this
transaction is the TCP connections details, that fake-CONNECT request
(updated to contain the TLS SNI - if any), and the TLS clientHello details.
 Any rules that you have regarding HTTP state is using that fake-CONNECT
still.

At line 1044 Squid determines that there are no permitted ways to
contact any server and complete the TLS bumping.

Between lines 1045 and 1372; Squid is performing the SSL-Bump process on
the client connection so it can deliver the HTTP error message about
that server connectivity problem.

At line 1373 it begins receiving from FD 18 the HTTPS message that curl
sent inside the tunnel way back on FD 12.

Your custom header is visible on that curl request. But that is
irrelevant by now, Squid is delivering its message about no server being
permitted to be used for the SSL-Bump server connection. That response
gets delivered at line 1652.


&gt;<i> 5. The bumped contents are on line 1575
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L1575">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L1575</A>
</I>&gt;<i> , where X-My-Header is visible
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The following inconsistencies are seen:
</I>&gt;<i> 
</I>&gt;<i> a. The X-My-Header is *not* added to the CONNECT request according to
</I>&gt;<i> config
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-1-squid-conf-L19">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-1-squid-conf-L19</A>
</I>
There is never any outbound CONNECT request to send that header on.

&gt;<i> b. X-My-Header NOT found on line 966, although it is clearly visible on
</I>&gt;<i> line 1579
</I>&gt;<i> 
</I>
Your header is visible on every request where it can reasonably be
expected to exist.


&gt;<i> -----
</I>&gt;<i> 
</I>&gt;<i> The reason I was asking earlier whether this is the expected behaviour or
</I>&gt;<i> not, was because I was wondering whether the ACLs apply to the CONNECT
</I>&gt;<i> request contents, or to the ssl_bump contents.
</I>
The answer is yes. However they are not that problem, both of those you
refer to have the header and it is detected.

It is the side effects of NAT which is causing the headache. The
fake-CONNECT and lack of support for it in your squid.conf rules.


&gt;<i> 
</I>&gt;<i> Is there a way to determine the cache_peer based on ssl bumped contents?
</I>
Yes, but that is not your problem.

&gt;<i> 
</I>&gt;<i> If not, is there a way to add X-My-Header to the CONNECT request, as a
</I>&gt;<i> workaround to ssl bumped contents not following any ACLs?
</I>
The way you are doing it is correct and will be applied on any CONNECT
request which leaves Squid to a cache_peer.

Your problem is that the CONNECT you receive from curl is being
tunneled, then redirected using NAT.

That process discards your header and any other state about the client
TCP connection that would have been useful during the http_access and
ssl_bump evaluation for bumping the TLS traffic.


&gt;<i> 
</I>&gt;<i> If not, is there a way to set the cache_peer based on the headers of the
</I>&gt;<i> bumped request?
</I>&gt;<i> 
</I>&gt;<i> If there's nothing I can do about this, is there a way to set the
</I>&gt;<i> ssl_bumped cache_peer based on the earlier proxy_auth username?
</I>&gt;<i> 
</I>
Start by adding the ssl-bump option on your http_port line which will
resolve this case of traffic event.

Properly NAT'ed client connections arriving on your intercept port will
still have the problem. So you will need to remove the never_direct rule
preventing server connections being used by the bumping process.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011595.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="011601.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11599">[ date ]</a>
              <a href="thread.html#11599">[ thread ]</a>
              <a href="subject.html#11599">[ subject ]</a>
              <a href="author.html#11599">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
