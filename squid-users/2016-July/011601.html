<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20req_header%20result%20in%20cache_peer_access%20when%0A%20using%20ssl_bump&In-Reply-To=%3CCANJ0oHc04ZNzNj%3DJsVA%3D9pni6KUixQhzyY0P7LSH_2yZEC0Rkg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011599.html">
   <LINK REL="Next"  HREF="011616.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump</H1>
    <B>Mihai Ene</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20req_header%20result%20in%20cache_peer_access%20when%0A%20using%20ssl_bump&In-Reply-To=%3CCANJ0oHc04ZNzNj%3DJsVA%3D9pni6KUixQhzyY0P7LSH_2yZEC0Rkg%40mail.gmail.com%3E"
       TITLE="[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump">me at ub.io
       </A><BR>
    <I>Mon Jul 18 15:19:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011599.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="011616.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11601">[ date ]</a>
              <a href="thread.html#11601">[ thread ]</a>
              <a href="subject.html#11601">[ subject ]</a>
              <a href="author.html#11601">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Your details helped me understand a lot better.

It turns out squid correctly adds the header to the CONNECT request, when
that request is made to another proxy. It cannot be itself, unfortunately,
because then it complains about a loop.

Also unfortunately, your suggestion of doing `ssl-bump` on the http port
doesn't work because the squid process terminates with a failed assertion
when using cache_peer, it seems to be this bug
<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3963">http://bugs.squid-cache.org/show_bug.cgi?id=3963</A> , which I get during with
my squid 3.5.20 `2016/07/18 15:07:50.566| assertion failed:
PeerConnector.cc:116: &quot;peer-&gt;use_ssl&quot;`.

Config used:

```
http_port 8000 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=16MB cert=/etc/squid/ca.crt
key=/etc/squid/ca.key dhparams=/etc/squid/dh2048.pem options=NO_SSLv3

sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid_ssl_db -M 32MB
sslcrtd_children 32
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

never_direct allow all

cache_peer 192.71.64.174 parent 6745 0 no-query no-digest default

http_access allow all
```

Considering the fact that I can't do `ssl-bump` on http port because of the
`peer-use_ssl` assertion (bug linked above), also considering the fact that
squid :8000 using itself as a proxy :8443 complains about a proxy loop, are
there any other options I might have to use ssl_bump *with* multiple
cache_peer, and cache_peer selection based on proxy_auth and/or req_header?





*Mihai Ene*
Software Developer

*UB | Your universal basket*

<A HREF="http://ub.io">http://ub.io</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">me at ub.io</A>
@shop_ub
+44 (0)7473 804972 &lt;+447473804972&gt;

On Mon, Jul 18, 2016 at 2:03 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 18/07/2016 10:23 p.m., Mihai Ene wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have created a gist with the relevant parts of `cache.log`
</I>&gt;<i> &gt; (post-connection)
</I>&gt;<i> &gt; <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The following logs are available:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. The initial HTTP CONNECT requests on port :8000 on line 51
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L51">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L51</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Between lines 1 and line 462;
</I>&gt;<i>
</I>&gt;<i> Your Squid is receiving an HTTP CONNECT tunnel request from curl on FD
</I>&gt;<i> 12. Your custom header exists on that CONNECT request.
</I>&gt;<i>
</I>&gt;<i> Your access controls determine that:
</I>&gt;<i>  a) this tunnel is *not* to be bumped (by http_port lacking ssl-bump
</I>&gt;<i> option).
</I>&gt;<i>  b) that a direct outgoing server TCP connection is required (by
</I>&gt;<i> always_direct allow),
</I>&gt;<i>
</I>&gt;<i> So Squid is required to *decapsulate* the CONNECT request and send the
</I>&gt;<i> data inside it to upstream server.
</I>&gt;<i>
</I>&gt;<i> At this point there is an opaque payload in the CONNECT tunnel arriving
</I>&gt;<i> from client and being delivered over an opaque TCP connection to the
</I>&gt;<i> server. There is no HTTP messaging over that server connection as far as
</I>&gt;<i> Squid is concerned, just opaque bytes of data.
</I>&gt;<i>
</I>&gt;<i> ==&gt; Squid is not able to attach your custom HTTP header when there is no
</I>&gt;<i> outgoing HTTP message.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2. The mark 0x10 is set on line 435
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L435">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L435</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 3. The redirected HTTPS request on port :8443 comes in, line 467
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L467">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L467</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> By &quot;redirected&quot; you mean NAT'ed.
</I>&gt;<i>
</I>&gt;<i> At line 466 your OS NAT configuration folds the outgoing opaque tunnel
</I>&gt;<i> connection back into Squid.
</I>&gt;<i>
</I>&gt;<i> As far as Squid is concerned this is a *new* HTTPS connection on the
</I>&gt;<i> intercept port using FD 18. It is important to be aware that there is
</I>&gt;<i> *no* information about your custom header from the previous CONNECT. A
</I>&gt;<i> new inbound connection is a clean slate.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 4. The forwarded CONNECT request is on line 526
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L526">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L526</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> No. Between line 467 and 628;
</I>&gt;<i>
</I>&gt;<i> Squid is processing the fake CONNECT request representing the raw TCP
</I>&gt;<i> connection IP:port details. To see if the connection is to be rejected
</I>&gt;<i> immeditely, ssl-bump'ed or bypassed, etc.
</I>&gt;<i>
</I>&gt;<i> ==&gt; Since the request is completely internal to Squid, on a fresh new
</I>&gt;<i> TCP connection, it does not contain any of the curl sent headers.
</I>&gt;<i>
</I>&gt;<i> ==&gt; Since it is of course not an *outgoing* message. It does not have
</I>&gt;<i> any request_header_add custom alterations.
</I>&gt;<i>
</I>&gt;<i> At line 611 your http_access rules fail to match (all of them). So the
</I>&gt;<i> implicit &quot;allow all&quot; happens to this pseudo-CONNECT.
</I>&gt;<i>
</I>&gt;<i> at 628 ssl_bump indicates a need to peek at the TLS traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> between line 642 and 655; Squid is shoveling some of the opaque data
</I>&gt;<i> between its FD 12 and FD 16 connections.
</I>&gt;<i>
</I>&gt;<i> Things then start interleaving between the inbound FD 18 connection and
</I>&gt;<i> the FD 12 &lt;-&gt; FD 16 opaque tunnel data transfer. I will ignore that
</I>&gt;<i> opaque shovelling from now in the between line X and Y statements.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> between line 655 and 907 SSL-Bump is doing its peek thing with the TLS
</I>&gt;<i> now arriving on FD 18. At 907 it decides to bump using only the client
</I>&gt;<i> Hello details.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 5. X-My-Header is *NOT* found on line 966
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L966">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L966</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> between lines 908 and 1043;
</I>&gt;<i>
</I>&gt;<i> Squid is doing its outbound server destination selection to figure out
</I>&gt;<i> where this TLS client request is going to go to.
</I>&gt;<i>
</I>&gt;<i> Note that at this point the only state Squid has associated with this
</I>&gt;<i> transaction is the TCP connections details, that fake-CONNECT request
</I>&gt;<i> (updated to contain the TLS SNI - if any), and the TLS clientHello details.
</I>&gt;<i>  Any rules that you have regarding HTTP state is using that fake-CONNECT
</I>&gt;<i> still.
</I>&gt;<i>
</I>&gt;<i> At line 1044 Squid determines that there are no permitted ways to
</I>&gt;<i> contact any server and complete the TLS bumping.
</I>&gt;<i>
</I>&gt;<i> Between lines 1045 and 1372; Squid is performing the SSL-Bump process on
</I>&gt;<i> the client connection so it can deliver the HTTP error message about
</I>&gt;<i> that server connectivity problem.
</I>&gt;<i>
</I>&gt;<i> At line 1373 it begins receiving from FD 18 the HTTPS message that curl
</I>&gt;<i> sent inside the tunnel way back on FD 12.
</I>&gt;<i>
</I>&gt;<i> Your custom header is visible on that curl request. But that is
</I>&gt;<i> irrelevant by now, Squid is delivering its message about no server being
</I>&gt;<i> permitted to be used for the SSL-Bump server connection. That response
</I>&gt;<i> gets delivered at line 1652.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 5. The bumped contents are on line 1575
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L1575">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-3-cache-log-L1575</A>
</I>&gt;<i> &gt; , where X-My-Header is visible
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The following inconsistencies are seen:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; a. The X-My-Header is *not* added to the CONNECT request according to
</I>&gt;<i> &gt; config
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-1-squid-conf-L19">https://gist.github.com/randunel/5c0d282c52e9135aa21b8c6e28925a52#file-1-squid-conf-L19</A>
</I>&gt;<i>
</I>&gt;<i> There is never any outbound CONNECT request to send that header on.
</I>&gt;<i>
</I>&gt;<i> &gt; b. X-My-Header NOT found on line 966, although it is clearly visible on
</I>&gt;<i> &gt; line 1579
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Your header is visible on every request where it can reasonably be
</I>&gt;<i> expected to exist.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The reason I was asking earlier whether this is the expected behaviour or
</I>&gt;<i> &gt; not, was because I was wondering whether the ACLs apply to the CONNECT
</I>&gt;<i> &gt; request contents, or to the ssl_bump contents.
</I>&gt;<i>
</I>&gt;<i> The answer is yes. However they are not that problem, both of those you
</I>&gt;<i> refer to have the header and it is detected.
</I>&gt;<i>
</I>&gt;<i> It is the side effects of NAT which is causing the headache. The
</I>&gt;<i> fake-CONNECT and lack of support for it in your squid.conf rules.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there a way to determine the cache_peer based on ssl bumped contents?
</I>&gt;<i>
</I>&gt;<i> Yes, but that is not your problem.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If not, is there a way to add X-My-Header to the CONNECT request, as a
</I>&gt;<i> &gt; workaround to ssl bumped contents not following any ACLs?
</I>&gt;<i>
</I>&gt;<i> The way you are doing it is correct and will be applied on any CONNECT
</I>&gt;<i> request which leaves Squid to a cache_peer.
</I>&gt;<i>
</I>&gt;<i> Your problem is that the CONNECT you receive from curl is being
</I>&gt;<i> tunneled, then redirected using NAT.
</I>&gt;<i>
</I>&gt;<i> That process discards your header and any other state about the client
</I>&gt;<i> TCP connection that would have been useful during the http_access and
</I>&gt;<i> ssl_bump evaluation for bumping the TLS traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If not, is there a way to set the cache_peer based on the headers of the
</I>&gt;<i> &gt; bumped request?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If there's nothing I can do about this, is there a way to set the
</I>&gt;<i> &gt; ssl_bumped cache_peer based on the earlier proxy_auth username?
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Start by adding the ssl-bump option on your http_port line which will
</I>&gt;<i> resolve this case of traffic event.
</I>&gt;<i>
</I>&gt;<i> Properly NAT'ed client connections arriving on your intercept port will
</I>&gt;<i> still have the problem. So you will need to remove the never_direct rule
</I>&gt;<i> preventing server connections being used by the bumping process.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160718/a299c7f6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160718/a299c7f6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011599.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="011616.html">[squid-users] Wrong req_header result in cache_peer_access when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11601">[ date ]</a>
              <a href="thread.html#11601">[ thread ]</a>
              <a href="subject.html#11601">[ subject ]</a>
              <a href="author.html#11601">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
