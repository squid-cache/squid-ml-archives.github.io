<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Skype+intercept+ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%2Bintercept%2Bssl_bump&In-Reply-To=%3C578D603C.4050009%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011605.html">
   <LINK REL="Next"  HREF="011748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Skype+intercept+ssl_bump</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%2Bintercept%2Bssl_bump&In-Reply-To=%3C578D603C.4050009%40measurement-factory.com%3E"
       TITLE="[squid-users] Skype+intercept+ssl_bump">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jul 18 23:03:24 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011605.html">[squid-users] Skype+intercept+ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="011748.html">[squid-users] Skype+intercept+ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11609">[ date ]</a>
              <a href="thread.html#11609">[ thread ]</a>
              <a href="subject.html#11609">[ subject ]</a>
              <a href="author.html#11609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/18/2016 01:27 AM, Amos Jeffries wrote:
&gt;<i> On 15/07/2016 10:38 p.m., Evgeniy Kononov wrote:
</I>&gt;&gt;<i> With this setup I have problem with group chats, calls and attachments in messages.
</I>
&gt;<i> The problem is with identifying it in fairly reliable way from all the
</I>&gt;<i> other traffic. That is where we are currently all stuck.
</I>
I cannot offer a comprehensive solution for all Skype problems, but I
can share an in-progress triage that we are doing for one particular
problem related to Skype group chats. According to some of the logs I
have seen, group chat uses MSNP(?) messages instead of HTTP. Squid fails
to parse MSNP, as expected:

&gt;<i> RequestParser.cc(340) parse: Parse buf={length=68, data='CNT 1 CON 185
</I>&gt;<i> 
</I>&gt;<i> &lt;connect&gt;&lt;ver&gt;2&lt;/ver&gt;&lt;agent&gt;&lt;os&gt;Windows&lt;/os&gt;&lt;osVer&gt;'}
</I>&gt;<i> RequestParser.cc(228) parseHttpVersionField: invalid request-line: not HTTP
</I>

AFAICT, Squid then hits an on_unsupported_protocol bug: When deciding
whether to tunnel an intercepted unsupported protocol, Squid never
tunnels traffic on connections that have seen more than one HTTP request
already. The intent behind that check is noble (if a connection started
with a valid HTTP request, then it is probably an HTTP connection), but
the actual result is unfortunate:

1. Intercepted connections start with one or two fake SslBump CONNECT
requests that are counted as &quot;seen HTTP requests&quot;.

2. The invalid HTTP request that we just failed to parse is also counted
as a &quot;seen HTTP request&quot;.

In the particular case I have seen, once Squid bumps the Skype
connection and receives a non-HTTP MSNP request, the &quot;seen requests&quot;
counter probably reaches 2, and the on_unsupported_protocol option is
not checked.


I am trying to come up with a use case that would justify the current
request counting check. Would switching to a blind tunnel in the middle
of an intercepted connection expose Squid (or its users) to any
_additional_ risks compared to switching to a blind tunnel only when the
bumped connection starts with an invalid HTTP request? If not, it is
trivial to remove the check as the attached patch illustrates.


Thank you,

Alex.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: IP-12900-tunnel-at-any-time-t1.patch
Type: text/x-diff
Size: 2837 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160718/91feb142/attachment.patch">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160718/91feb142/attachment.patch</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011605.html">[squid-users] Skype+intercept+ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="011748.html">[squid-users] Skype+intercept+ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11609">[ date ]</a>
              <a href="thread.html#11609">[ thread ]</a>
              <a href="subject.html#11609">[ subject ]</a>
              <a href="author.html#11609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
