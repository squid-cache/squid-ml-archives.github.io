<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20communication%20about%20HIT/MISS%20between%0A%20squid%20and%20and%20non-squid%20peer&In-Reply-To=%3C1e916489-c628-29dc-6311-d0eda85860f8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011671.html">
   <LINK REL="Next"  HREF="011674.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20peer%20communication%20about%20HIT/MISS%20between%0A%20squid%20and%20and%20non-squid%20peer&In-Reply-To=%3C1e916489-c628-29dc-6311-d0eda85860f8%40treenet.co.nz%3E"
       TITLE="[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 21 07:23:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011671.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
        <LI>Next message (by thread): <A HREF="011674.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11673">[ date ]</a>
              <a href="thread.html#11673">[ thread ]</a>
              <a href="subject.html#11673">[ subject ]</a>
              <a href="author.html#11673">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/07/2016 6:21 p.m., Omid Kosari wrote:
&gt;<i> Amos Jeffries wrote
</I>&gt;&gt;<i> 2) Squid can do pass-thru using Netfilter MARK flags. Each squid.conf
</I>&gt;&gt;<i> directive that deals with TOS has both a 'tos' and a 'mark' variant. The
</I>&gt;&gt;<i> 'mark' ones are able to pass-thru these netfilter markings the way you
</I>&gt;&gt;<i> want.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, since netfilter marks are local to the one machine and not
</I>&gt;&gt;<i> transmitted externally. You need to use iptables rules to convert
</I>&gt;&gt;<i> received TOS/DSCP values into local MARK values on packets arriving, and
</I>&gt;&gt;<i> the reverse translation for packets leaving the machine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IIRC there were some gotchas involved. I do remember specifically that
</I>&gt;&gt;<i> the TOS needed to be converted to CONNMARK (not MARK) in mangle or
</I>&gt;&gt;<i> earlier. Then the NF MARK values sync'd with CONNMARK at some stage just
</I>&gt;&gt;<i> after that (sorry my memory of that particular bit is long gone). The
</I>&gt;&gt;<i> sync'd NF MARK is what gets passed between Squid and the kernel.
</I>
Sorry, go that bit wrong. Its the sync'd CONNMARK that gets passed.

&gt;&gt;<i>
</I>&gt;&gt;<i> It is a bit clumsy and annoying, but without any kernel API to receive
</I>&gt;&gt;<i> the TOS/DSCP values on incoming packets it is what it is.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> First i am going to to it on same server which may be simpler and no need to
</I>&gt;<i> involve with convert to/from TOS
</I>&gt;<i> 
</I>&gt;<i> I have following iptables log
</I>&gt;<i> 
</I>&gt;<i>  IN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=4148 TOS=0x00 PREC=0x00 TTL=64
</I>&gt;<i> ID=57642 DF PROTO=TCP SPT=8080 DPT=12513 WINDOW=1495 RES=0x00 ACK PSH URGP=0
</I>&gt;<i> MARK=0x30 
</I>
squid.conf:

  qos_flows mark


As the documentation says:
&quot;
By default this functionality is disabled.

To enable it with the default settings simply use &quot;qos_flows mark&quot; ...

Default settings will result in the netfilter mark ... value being
copied from the upstream connection to the client.

Note that it is the connection CONNMARK value not the packet MARK value
that is copied.
&quot;



Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011671.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
	<LI>Next message (by thread): <A HREF="011674.html">[squid-users] cache peer communication about HIT/MISS between squid and and non-squid peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11673">[ date ]</a>
              <a href="thread.html#11673">[ thread ]</a>
              <a href="subject.html#11673">[ subject ]</a>
              <a href="author.html#11673">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
