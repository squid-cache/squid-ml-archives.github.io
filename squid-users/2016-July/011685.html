<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid - AD integration Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20-%20AD%20integration%20Issue&In-Reply-To=%3COFDDE4B57C.63CCC20E-ON80257FF7.004CBEB0-80257FF7.004DBC89%40tcs.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011691.html">
   <LINK REL="Next"  HREF="011693.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid - AD integration Issue</H1>
    <B>Nilesh Gavali</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20-%20AD%20integration%20Issue&In-Reply-To=%3COFDDE4B57C.63CCC20E-ON80257FF7.004CBEB0-80257FF7.004DBC89%40tcs.com%3E"
       TITLE="[squid-users] Squid - AD integration Issue">nilesh.gavali at tcs.com
       </A><BR>
    <I>Thu Jul 21 14:09:06 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011691.html">[squid-users] protect squid.conf file
</A></li>
        <LI>Next message (by thread): <A HREF="011693.html">[squid-users] Squid - AD integration Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11685">[ date ]</a>
              <a href="thread.html#11685">[ thread ]</a>
              <a href="subject.html#11685">[ subject ]</a>
              <a href="author.html#11685">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>HI All;

Squid integration with AD kerberos auth was working properly for me. Today 
faced issue, as users are getting login prompt while accessing Proxy. 
Not sure what went wrong. here is my configuration and also cache.log o/p. 
Need urgent help.

==============================================================
#
# Recommended minimum configuration:
####  AD SSO Integration  #####
auth_param negotiate program /usr/lib64/squid/squid_kerb_auth -s 
HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy02.ABCD.gov.eu at ABCD.GOV.EU</A> -d
auth_param negotiate children 10
auth_param negotiate keep_alive on
#auth_param basic credentialsttl 2 hours
acl ad_auth proxy_auth REQUIRED

####  AD Group membership  ####

external_acl_type AD_Group ttl=300 negative_ttl=0 %LOGIN 
/usr/lib64/squid/squid_ldap_group -P -R -b &quot;DC=ABCD,DC=GOV,DC=EU&quot; -D 
svcproxy -W /etc/squid/pswd/pswd -f 
&quot;(&amp;(objectclass=person)(userPrincipalName=%v)(memberof=cn=%a,ou=InternetAccess,ou=Groups,dc=ABCD,dc=GOV,dc=EU))&quot; 
-h ABCD.GOV.EU -s sub -v 3 -d

acl AVWSUS external AD_Group lgOnlineUpdate
acl windowsupdate dstdomain &quot;/etc/squid/sitelist/infra_update_site&quot;

acl manager proto cache_object
acl localhost src 127.0.0.1/32 ::1
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1

# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl AVSRVR src xx.xx.8.123      # Cloud SEPM Server
acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) 
machines
#
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

# Recommended minimum Access Permission configuration:
#
# Only allow cachemgr access from localhost
http_access allow manager localhost
http_access deny manager

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# We strongly recommend the following be uncommitted to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on &quot;localhost&quot; is a local user
#http_access deny to_localhost

# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed

http_access allow AVSRVR windowsupdate
http_access allow AVWSUS windowsupdate
http_access deny all
http_access allow ad_auth

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 8080
never_direct allow all

cache_peer x.x.2.108 parent 8080 0 default

dns_nameservers x.x.2.108

# We recommend you to use at least the following line.
#hierarchy_stoplist cgi-bin ?

# Uncomment and adjust the following to add a disk cache directory.
cache_dir ufs /var/spool/squid 2048 16 256

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

# Log forwarding to SysLog
access_log syslog:local1.info squid

# Add any of your own refresh_pattern entries above these.
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
==================================================
Cache.log-
====================================
2016/07/21 14:52:53| squid_kerb_auth: ERROR: gss_accept_sec_context() 
failed: Unspecified GSS failure.  Minor code may provide more information.
2016/07/21 14:52:53| authenticateNegotiateHandleReply: Error validating 
user via Negotiate. Error returned 'BH gss_accept_sec_context() failed: 
Unspecified GSS failure.  Minor code may provide more information. '
===================================

Also observed Squid_ldap_group helper throwing ERR when checking user 
group membership. but user is part of the said group in AD.

========================================================================
 #/usr/lib64/squid/squid_ldap_group -P -R -b &quot;DC=ABCD,DC=GOV,DC=EU&quot; -D 
svcproxy -W /etc/squid/pswd/pswd -f 
&quot;(&amp;(objectclass=person)(userPrincipalName=%v)(memberof=cn=%a,ou=InternetAccess,ou=Groups,dc=ABCD,dc=GOV,dc=EU))&quot; 
-h ABCD.GOV.EU -s sub -v 3 -d
853438 lgOnlineUpdate
Connected OK
group filter 
'(&amp;(objectclass=person)(userPrincipalName=853438)(memberof=cn=lgOnlineUpdate,ou=InternetAccess,ou=Groups,dc=ABCD,dc=GOV,dc=EU))', 
searchbase 'DC=ABCD,DC=GOV,DC=EU'
ERR
==========================================




Thanks &amp; Regards
Nilesh Suresh Gavali
=====-----=====-----=====
Notice: The information contained in this e-mail
message and/or attachments to it may contain 
confidential or privileged information. If you are 
not the intended recipient, any dissemination, use, 
review, distribution, printing or copying of the 
information contained in this e-mail message 
and/or attachments to it are strictly prohibited. If 
you have received this communication in error, 
please notify us by reply e-mail or telephone and 
immediately and permanently delete the message 
and any attachments. Thank you


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160721/cf7970bb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160721/cf7970bb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011691.html">[squid-users] protect squid.conf file
</A></li>
	<LI>Next message (by thread): <A HREF="011693.html">[squid-users] Squid - AD integration Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11685">[ date ]</a>
              <a href="thread.html#11685">[ thread ]</a>
              <a href="subject.html#11685">[ subject ]</a>
              <a href="author.html#11685">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
