<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid - AD integration Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20-%20AD%20integration%20Issue&In-Reply-To=%3Cef9078f4-8076-af46-4359-50432fbc03a5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011685.html">
   <LINK REL="Next"  HREF="011692.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid - AD integration Issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20-%20AD%20integration%20Issue&In-Reply-To=%3Cef9078f4-8076-af46-4359-50432fbc03a5%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid - AD integration Issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 22 05:16:56 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011685.html">[squid-users] Squid - AD integration Issue
</A></li>
        <LI>Next message (by thread): <A HREF="011692.html">[squid-users] squid stops working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11693">[ date ]</a>
              <a href="thread.html#11693">[ thread ]</a>
              <a href="subject.html#11693">[ subject ]</a>
              <a href="author.html#11693">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/07/2016 2:09 a.m., Nilesh Gavali wrote:
&gt;<i> HI All;
</I>&gt;<i> 
</I>&gt;<i> Squid integration with AD kerberos auth was working properly for me. Today 
</I>&gt;<i> faced issue, as users are getting login prompt while accessing Proxy. 
</I>&gt;<i> Not sure what went wrong. here is my configuration and also cache.log o/p. 
</I>&gt;<i> Need urgent help.
</I>&gt;<i> 
</I>&gt;<i> ==============================================================
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> ####  AD SSO Integration  #####
</I>&gt;<i> auth_param negotiate program /usr/lib64/squid/squid_kerb_auth -s 
</I>&gt;<i> HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy02.ABCD.gov.eu at ABCD.GOV.EU</A> -d
</I>&gt;<i> auth_param negotiate children 10
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> #auth_param basic credentialsttl 2 hours
</I>&gt;<i> acl ad_auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> ####  AD Group membership  ####
</I>&gt;<i> 
</I>&gt;<i> external_acl_type AD_Group ttl=300 negative_ttl=0 %LOGIN 
</I>&gt;<i> /usr/lib64/squid/squid_ldap_group -P -R -b &quot;DC=ABCD,DC=GOV,DC=EU&quot; -D 
</I>&gt;<i> svcproxy -W /etc/squid/pswd/pswd -f 
</I>&gt;<i> &quot;(&amp;(objectclass=person)(userPrincipalName=%v)(memberof=cn=%a,ou=InternetAccess,ou=Groups,dc=ABCD,dc=GOV,dc=EU))&quot; 
</I>&gt;<i> -h ABCD.GOV.EU -s sub -v 3 -d
</I>&gt;<i> 
</I>&gt;<i> acl AVWSUS external AD_Group lgOnlineUpdate
</I>&gt;<i> acl windowsupdate dstdomain &quot;/etc/squid/sitelist/infra_update_site&quot;
</I>&gt;<i> 
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32 ::1
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> acl AVSRVR src xx.xx.8.123      # Cloud SEPM Server
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) 
</I>&gt;<i> machines
</I>&gt;<i> #
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommitted to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> 
</I>&gt;<i> http_access allow AVSRVR windowsupdate
</I>&gt;<i> http_access allow AVWSUS windowsupdate
</I>
&gt;<i> http_access deny all
</I>
If the &quot;deny all&quot; above is actually what you want, then remove all the
following http_access rules.

If the &quot;allow ad_auth&quot; below is what you want, then remove the above
&quot;allow ... windowsupdate&quot; and &quot;deny all&quot; lines - checking groups is
pointless if any authenticated client is allowed.

&gt;<i> http_access allow ad_auth
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>

&gt;<i> Cache.log-
</I>&gt;<i> ====================================
</I>&gt;<i> 2016/07/21 14:52:53| squid_kerb_auth: ERROR: gss_accept_sec_context() 
</I>&gt;<i> failed: Unspecified GSS failure.  Minor code may provide more information.
</I>&gt;<i> 2016/07/21 14:52:53| authenticateNegotiateHandleReply: Error validating 
</I>&gt;<i> user via Negotiate. Error returned 'BH gss_accept_sec_context() failed: 
</I>&gt;<i> Unspecified GSS failure.  Minor code may provide more information. '
</I>&gt;<i> ===================================
</I>
Perhapse your Keytab entry expired or got updated in AD without the
Squid machine one being updated ?


&gt;<i> 
</I>&gt;<i> Also observed Squid_ldap_group helper throwing ERR when checking user 
</I>&gt;<i> group membership. but user is part of the said group in AD.
</I>
If the user account credentials are not being identified as valid by the
auth_param helper, there is no &quot;user&quot; to be part of any group check by
the external ACL helper.



&gt;<i> 
</I>&gt;<i> ========================================================================
</I>&gt;<i>  #/usr/lib64/squid/squid_ldap_group -P -R -b &quot;DC=ABCD,DC=GOV,DC=EU&quot; -D 
</I>&gt;<i> svcproxy -W /etc/squid/pswd/pswd -f 
</I>&gt;<i> &quot;(&amp;(objectclass=person)(userPrincipalName=%v)(memberof=cn=%a,ou=InternetAccess,ou=Groups,dc=ABCD,dc=GOV,dc=EU))&quot; 
</I>&gt;<i> -h ABCD.GOV.EU -s sub -v 3 -d
</I>&gt;<i> 853438 lgOnlineUpdate
</I>&gt;<i> Connected OK
</I>&gt;<i> group filter 
</I>&gt;<i> '(&amp;(objectclass=person)(userPrincipalName=853438)(memberof=cn=lgOnlineUpdate,ou=InternetAccess,ou=Groups,dc=ABCD,dc=GOV,dc=EU))', 
</I>&gt;<i> searchbase 'DC=ABCD,DC=GOV,DC=EU'
</I>&gt;<i> ERR
</I>&gt;<i> ==========================================
</I>&gt;<i> 
</I>
Tried with any recent version of Squid and/or helper? yours seem to be
many years outdated.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011685.html">[squid-users] Squid - AD integration Issue
</A></li>
	<LI>Next message (by thread): <A HREF="011692.html">[squid-users] squid stops working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11693">[ date ]</a>
              <a href="thread.html#11693">[ thread ]</a>
              <a href="subject.html#11693">[ subject ]</a>
              <a href="author.html#11693">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
