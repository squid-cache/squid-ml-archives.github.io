<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid not caching some files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20caching%20some%20files&In-Reply-To=%3C814930be-803f-f4a5-3d0b-07cb85f883b8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011729.html">
   <LINK REL="Next"  HREF="011731.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid not caching some files</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20caching%20some%20files&In-Reply-To=%3C814930be-803f-f4a5-3d0b-07cb85f883b8%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid not caching some files">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 28 10:30:03 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011729.html">[squid-users] Squid not caching some files
</A></li>
        <LI>Next message (by thread): <A HREF="011731.html">[squid-users] any reason why squid 3.5.2 get restarted after some	time ??
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11734">[ date ]</a>
              <a href="thread.html#11734">[ thread ]</a>
              <a href="subject.html#11734">[ subject ]</a>
              <a href="author.html#11734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/07/2016 1:33 p.m., John Pearson wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> main problem: different squid configurations are not caching certain files.
</I>&gt;<i> 
</I>&gt;<i> These are my conf files `1_squid.conf` and `2_squid.conf` both can be found
</I>&gt;<i> here:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://gist.github.com/ironpillow/e6b86354f4ac3941f74db86d893008f1">https://gist.github.com/ironpillow/e6b86354f4ac3941f74db86d893008f1</A>
</I>&gt;<i> 
</I>&gt;<i> I am using <A HREF="http://www.thinkbroadband.com/download/">http://www.thinkbroadband.com/download/</A> to download the 5MB zip
</I>&gt;<i> file but it's always a tcp_miss UNLESS I uncomment (use) lines 57 and 58 in
</I>&gt;<i> 1_squid.conf. dmg files are being cached.
</I>&gt;<i> 
</I>&gt;<i> But when using 2_squid.conf, the above zip file is cached (tcp_hit) but dmg
</I>&gt;<i> files (<A HREF="https://support.apple.com/kb/dl1870?locale=en_US">https://support.apple.com/kb/dl1870?locale=en_US</A>) are not being
</I>&gt;<i> cached.
</I>&gt;<i> 
</I>&gt;<i> Any advice?
</I>
Quite a lot.

Firstly, the design of those two configs is quite different about what
they do when caching. Some of the below details about #1 config should
explain why #2 config does them differently, the rest of the changes
apply to both configs.

Specifics:

1) there are no such things as &quot;files&quot; in HTTP. &quot;file&quot; is a disk storage
concept. Network transfer protocols are about resources and where they
are located (URL). Any relationship between URL and a filename is a
coincidence of that domains designer having made it so, and certainly
not reliable in the general case. That effects the (3) behaviour below.

2) in HTTP the relationship between &quot;site&quot; and URL is tenuous at best.
Just because one URL is displayed as being where to fetch an object does
not mean thats where the object resides. Redirects can happen in between
initial fetch, and your Store-ID helper will also be having effects on
what URL the refresh_pattern see as representing the object.

3) the regex patterns you have for URLs *ending* with specific 4-letter
sequences between lines 54-70 are;
 a) specifically bound to individual domain names (thats good because of
#1 above), and
 b) do not include the domains you mention having trouble with (which
explains why they do not do what you expect to those domains).

4) due to the way you have configured the &quot;cache&quot; directives. Only
domain names listed in /etc/squid/updatesites.txt will ever be stored by
Squid. This effects the behaviours created by (2) and (3) -
refresh_pattern is only relevant for stored content.

5) Squid *will not* store responses for intercepted traffic unless it
can verify the server being contacted is actually the authoritative
origin server for that URL domain.
 * The DNS servers behind &quot;8.8.8.8&quot; are expicitly configured to rotate
teh IP addresses on every single lookup. Which makes it almost
guaranteed that Squid and the client being intercepted will be seeing
different sets of origin servers when they lookup the domain.

6) configuring &quot;dns_defnames&quot; to pass *single label* domain names out to
the global 8.8.8.8 service is plain wrong. Remove that line.

7) &quot;logformat squid&quot; - do not redefine Squid's built-in log formats. It
will *not* record the values you think it records.

8) remove the comment from line 84 of 1_squid.conf. That line defines
the proper way to deal with URLs when they have query strings.

9) remove the &quot;regex_pattern -i cgi-bin&quot; lines at 86-87. Its an old and
wrong config setting.

10) you can remove the &quot;always_direct allow all&quot; it is about whether to
use cache_peer's and is pointless in your configuration that doesn't use
any peers.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011729.html">[squid-users] Squid not caching some files
</A></li>
	<LI>Next message (by thread): <A HREF="011731.html">[squid-users] any reason why squid 3.5.2 get restarted after some	time ??
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11734">[ date ]</a>
              <a href="thread.html#11734">[ thread ]</a>
              <a href="subject.html#11734">[ subject ]</a>
              <a href="author.html#11734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
