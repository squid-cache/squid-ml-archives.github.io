<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Vary object loop returns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3C0de88873-53a5-14f6-5c98-93aa252c682b%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010846.html">
   <LINK REL="Next"  HREF="010848.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Vary object loop returns</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3C0de88873-53a5-14f6-5c98-93aa252c682b%40gmail.com%3E"
       TITLE="[squid-users] Vary object loop returns">yvoinov at gmail.com
       </A><BR>
    <I>Fri Jun  3 19:33:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010846.html">[squid-users] Vary object loop returns
</A></li>
        <LI>Next message (by thread): <A HREF="010848.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10847">[ date ]</a>
              <a href="thread.html#10847">[ thread ]</a>
              <a href="subject.html#10847">[ subject ]</a>
              <a href="author.html#10847">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
Man, you right.

You change dramatically increases HIT. Some checked sites with
traditional low HIT ratio now caching.

Wow.


03.06.2016 23:37, joe &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> i will just have to do patch i work direct on source if you want
</I>&gt;<i> i post  and its not regx yet and the sbuf routine the dev guys shuld do it
</I>&gt;<i> its missing function str.erase in sbuf i gess
</I>&gt;<i> not good for production untill somone do regx match  on  --&gt;    %20 filter
</I>&gt;<i> out
</I>&gt;<i>
</I>&gt;<i> int
</I>&gt;<i> varyEvaluateMatch(StoreEntry * entry, HttpRequest * request)
</I>&gt;<i> {
</I>&gt;<i>     SBuf vary(request-&gt;vary_headers);
</I>&gt;<i>     int has_vary = entry-&gt;getReply()-&gt;header.has(HDR_VARY);
</I>&gt;<i> #if X_ACCELERATOR_VARY
</I>&gt;<i>     has_vary |=
</I>&gt;<i>         entry-&gt;getReply()-&gt;header.has(HDR_X_ACCELERATOR_VARY);
</I>&gt;<i> #endif
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     if (!has_vary || entry-&gt;mem_obj-&gt;vary_headers.isEmpty()) {
</I>&gt;<i>         if (!vary.isEmpty()) {
</I>&gt;<i>             /* Oops... something odd is going on here.. */
</I>&gt;<i>             debugs(33, DBG_IMPORTANT, &quot;varyEvaluateMatch: Oops. Not a Vary
</I>&gt;<i> object on second attempt, '&quot; &lt;&lt;
</I>&gt;<i>                    entry-&gt;mem_obj-&gt;urlXXX() &lt;&lt; &quot;' '&quot; &lt;&lt; vary &lt;&lt; &quot;'&quot;);
</I>&gt;<i>             request-&gt;vary_headers.clear();
</I>&gt;<i>             return VARY_CANCEL;
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         if (!has_vary) {
</I>&gt;<i>             /* This is not a varying object */
</I>&gt;<i>             return VARY_NONE;
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         /* virtual &quot;vary&quot; object found. Calculate the vary key and
</I>&gt;<i>          * continue the search
</I>&gt;<i>          */
</I>&gt;<i>         vary = httpMakeVaryMark(request, entry-&gt;getReply());
</I>&gt;<i>
</I>&gt;<i>         if (!vary.isEmpty()) {
</I>&gt;<i>             request-&gt;vary_headers = vary;
</I>&gt;<i>             return VARY_OTHER;
</I>&gt;<i>         } else {
</I>&gt;<i>             /* Ouch.. we cannot handle this kind of variance */
</I>&gt;<i>             /* XXX This cannot really happen, but just to be complete */
</I>&gt;<i>             return VARY_CANCEL;
</I>&gt;<i>         }
</I>&gt;<i>     } else {
</I>&gt;<i>         if (vary.isEmpty()) {
</I>&gt;<i>             vary = httpMakeVaryMark(request, entry-&gt;getReply());
</I>&gt;<i>
</I>&gt;<i>             if (!vary.isEmpty())
</I>&gt;<i>                 request-&gt;vary_headers = vary;
</I>&gt;<i>         }
</I>&gt;<i> if (!vary.isEmpty()) {
</I>&gt;<i>         std::string t = vary.c_str();
</I>&gt;<i>
</I>&gt;<i>         std::string s = &quot;,%20sdch&quot;;
</I>&gt;<i>         std::string::size_type i = t.find(s);
</I>&gt;<i>   if (i != std::string::npos){
</I>&gt;<i>      t.erase(i, s.length());
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>         std::string s1 = &quot;,%20deflate&quot;;
</I>&gt;<i>         std::string::size_type i1 = t.find(s1);
</I>&gt;<i>
</I>&gt;<i>   if (i1 != std::string::npos){
</I>&gt;<i>      t.erase(i1, s1.length());
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>         std::string s2 = &quot;,%20gzip&quot;;
</I>&gt;<i>         std::string::size_type i2 = t.find(s2);
</I>&gt;<i>
</I>&gt;<i>   if (i2 != std::string::npos){
</I>&gt;<i>      t.erase(i2, s2.length());
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>         std::string s3 = &quot;,%20identity&quot;;
</I>&gt;<i>         std::string::size_type i3 = t.find(s3);
</I>&gt;<i>
</I>&gt;<i>   if (i3 != std::string::npos){
</I>&gt;<i>      t.erase(i3, s3.length());
</I>&gt;<i>   }
</I>&gt;<i>         vary=SBuf(t);
</I>&gt;<i>               return VARY_MATCH;
</I>&gt;<i> }
</I>&gt;<i>         if (vary.isEmpty()) {
</I>&gt;<i>             /* Ouch.. we cannot handle this kind of variance */
</I>&gt;<i>             /* XXX This cannot really happen, but just to be complete */
</I>&gt;<i>             return VARY_CANCEL;
</I>&gt;<i>         } else if (vary.cmp(entry-&gt;mem_obj-&gt;vary_headers) == 0) {
</I>&gt;<i>             return VARY_MATCH;
</I>&gt;<i>         } else {
</I>&gt;<i>             /* Oops.. we have already been here and still haven't
</I>&gt;<i>              * found the requested variant. Bail out
</I>&gt;<i>              */
</I>&gt;<i>
</I>&gt;<i>             debugs(33, DBG_IMPORTANT, &quot;varyEvaluateMatch: Oops. Not a Vary
</I>&gt;<i> match on second attempt, '&quot; &lt;&lt;
</I>&gt;<i>                    entry-&gt;mem_obj-&gt;urlXXX() &lt;&lt; &quot;' '&quot; &lt;&lt; vary &lt;&lt; &quot;'&quot;);
</I>&gt;<i>             return VARY_CANCEL;
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> just replace the old function on client_side.cc  --&gt;
</I>varyEvaluateMatch  with
&gt;<i> the one i post  or i post later  the patch
</I>&gt;<i> dont lough im not pro but i do my home work
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> View this message in context:
</I><A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Vary-object-loop-returns-tp4677716p4677792.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Vary-object-loop-returns-tp4677716p4677792.html</A>
&gt;<i> Sent from the Squid - Users mailing list archive at Nabble.com.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJXUduWAAoJENNXIZxhPexGP1QH/2Fx0TWZrviMgFavyUsR6jXv
LADswxk5iCEX20frmDCbIGXRgbmzvGwohYcAWR5aCPCyJxirvkmnSN4KP6it6D5b
DuwrLVDcxBGg5CeR7ajRO9+yg/0r/MwF2NG7aLSa/ao+sxjJi+D+fRjxy5vQ3Ucq
TrxjdZn119dbrVkiP8mljoK4pohvEFT07pbA30K0mf2olRg98TTQFOFSWTnnPnjf
Lhpp60+o9h67p4ELBvAJ8yCloiFRs/2fljCpqDUkwIY74aIX/wjTfbh3+0VLNrYn
V6GKJ0zpGyr7OcM9BawjfJcoyjMEUy1ZCN5Yf+vjtSqG/UydVbX9OwnhapSlk5U=
=enzv
-----END PGP SIGNATURE-----

-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160604/766038c0/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160604/766038c0/attachment.key</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010846.html">[squid-users] Vary object loop returns
</A></li>
	<LI>Next message (by thread): <A HREF="010848.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10847">[ date ]</a>
              <a href="thread.html#10847">[ thread ]</a>
              <a href="subject.html#10847">[ subject ]</a>
              <a href="author.html#10847">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
