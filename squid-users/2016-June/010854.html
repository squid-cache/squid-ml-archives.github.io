<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Vary object loop returns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3Cd5c74d63-9036-8f92-ed55-9d4e9a6561c9%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010850.html">
   <LINK REL="Next"  HREF="010855.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Vary object loop returns</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3Cd5c74d63-9036-8f92-ed55-9d4e9a6561c9%40gmail.com%3E"
       TITLE="[squid-users] Vary object loop returns">yvoinov at gmail.com
       </A><BR>
    <I>Sat Jun  4 09:44:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010850.html">[squid-users] Vary object loop returns
</A></li>
        <LI>Next message (by thread): <A HREF="010855.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10854">[ date ]</a>
              <a href="thread.html#10854">[ thread ]</a>
              <a href="subject.html#10854">[ subject ]</a>
              <a href="author.html#10854">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://i1.someimage.com/rk2cwdN.png">https://i1.someimage.com/rk2cwdN.png</A>

Two times HIT increase on diagram - was client_side.cc changed.

But also some new problems occurs - partially, BBC video can't work 
after patch.

Need more research by dev team. If they want to made Squid which it must be.


04.06.2016 1:33, Yuri Voinov &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA256
</I>&gt;<i>   
</I>&gt;<i> Man, you right.
</I>&gt;<i>
</I>&gt;<i> You change dramatically increases HIT. Some checked sites with
</I>&gt;<i> traditional low HIT ratio now caching.
</I>&gt;<i>
</I>&gt;<i> Wow.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 03.06.2016 23:37, joe &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> i will just have to do patch i work direct on source if you want
</I>&gt;&gt;<i> i post  and its not regx yet and the sbuf routine the dev guys shuld do it
</I>&gt;&gt;<i> its missing function str.erase in sbuf i gess
</I>&gt;&gt;<i> not good for production untill somone do regx match  on  --&gt;    %20 filter
</I>&gt;&gt;<i> out
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> int
</I>&gt;&gt;<i> varyEvaluateMatch(StoreEntry * entry, HttpRequest * request)
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i>      SBuf vary(request-&gt;vary_headers);
</I>&gt;&gt;<i>      int has_vary = entry-&gt;getReply()-&gt;header.has(HDR_VARY);
</I>&gt;&gt;<i> #if X_ACCELERATOR_VARY
</I>&gt;&gt;<i>      has_vary |=
</I>&gt;&gt;<i>          entry-&gt;getReply()-&gt;header.has(HDR_X_ACCELERATOR_VARY);
</I>&gt;&gt;<i> #endif
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      if (!has_vary || entry-&gt;mem_obj-&gt;vary_headers.isEmpty()) {
</I>&gt;&gt;<i>          if (!vary.isEmpty()) {
</I>&gt;&gt;<i>              /* Oops... something odd is going on here.. */
</I>&gt;&gt;<i>              debugs(33, DBG_IMPORTANT, &quot;varyEvaluateMatch: Oops. Not a Vary
</I>&gt;&gt;<i> object on second attempt, '&quot; &lt;&lt;
</I>&gt;&gt;<i>                     entry-&gt;mem_obj-&gt;urlXXX() &lt;&lt; &quot;' '&quot; &lt;&lt; vary &lt;&lt; &quot;'&quot;);
</I>&gt;&gt;<i>              request-&gt;vary_headers.clear();
</I>&gt;&gt;<i>              return VARY_CANCEL;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          if (!has_vary) {
</I>&gt;&gt;<i>              /* This is not a varying object */
</I>&gt;&gt;<i>              return VARY_NONE;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          /* virtual &quot;vary&quot; object found. Calculate the vary key and
</I>&gt;&gt;<i>           * continue the search
</I>&gt;&gt;<i>           */
</I>&gt;&gt;<i>          vary = httpMakeVaryMark(request, entry-&gt;getReply());
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          if (!vary.isEmpty()) {
</I>&gt;&gt;<i>              request-&gt;vary_headers = vary;
</I>&gt;&gt;<i>              return VARY_OTHER;
</I>&gt;&gt;<i>          } else {
</I>&gt;&gt;<i>              /* Ouch.. we cannot handle this kind of variance */
</I>&gt;&gt;<i>              /* XXX This cannot really happen, but just to be complete */
</I>&gt;&gt;<i>              return VARY_CANCEL;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>      } else {
</I>&gt;&gt;<i>          if (vary.isEmpty()) {
</I>&gt;&gt;<i>              vary = httpMakeVaryMark(request, entry-&gt;getReply());
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>              if (!vary.isEmpty())
</I>&gt;&gt;<i>                  request-&gt;vary_headers = vary;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i> if (!vary.isEmpty()) {
</I>&gt;&gt;<i>          std::string t = vary.c_str();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          std::string s = &quot;,%20sdch&quot;;
</I>&gt;&gt;<i>          std::string::size_type i = t.find(s);
</I>&gt;&gt;<i>    if (i != std::string::npos){
</I>&gt;&gt;<i>       t.erase(i, s.length());
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          std::string s1 = &quot;,%20deflate&quot;;
</I>&gt;&gt;<i>          std::string::size_type i1 = t.find(s1);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    if (i1 != std::string::npos){
</I>&gt;&gt;<i>       t.erase(i1, s1.length());
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          std::string s2 = &quot;,%20gzip&quot;;
</I>&gt;&gt;<i>          std::string::size_type i2 = t.find(s2);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    if (i2 != std::string::npos){
</I>&gt;&gt;<i>       t.erase(i2, s2.length());
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          std::string s3 = &quot;,%20identity&quot;;
</I>&gt;&gt;<i>          std::string::size_type i3 = t.find(s3);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    if (i3 != std::string::npos){
</I>&gt;&gt;<i>       t.erase(i3, s3.length());
</I>&gt;&gt;<i>    }
</I>&gt;&gt;<i>          vary=SBuf(t);
</I>&gt;&gt;<i>                return VARY_MATCH;
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>          if (vary.isEmpty()) {
</I>&gt;&gt;<i>              /* Ouch.. we cannot handle this kind of variance */
</I>&gt;&gt;<i>              /* XXX This cannot really happen, but just to be complete */
</I>&gt;&gt;<i>              return VARY_CANCEL;
</I>&gt;&gt;<i>          } else if (vary.cmp(entry-&gt;mem_obj-&gt;vary_headers) == 0) {
</I>&gt;&gt;<i>              return VARY_MATCH;
</I>&gt;&gt;<i>          } else {
</I>&gt;&gt;<i>              /* Oops.. we have already been here and still haven't
</I>&gt;&gt;<i>               * found the requested variant. Bail out
</I>&gt;&gt;<i>               */
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>              debugs(33, DBG_IMPORTANT, &quot;varyEvaluateMatch: Oops. Not a Vary
</I>&gt;&gt;<i> match on second attempt, '&quot; &lt;&lt;
</I>&gt;&gt;<i>                     entry-&gt;mem_obj-&gt;urlXXX() &lt;&lt; &quot;' '&quot; &lt;&lt; vary &lt;&lt; &quot;'&quot;);
</I>&gt;&gt;<i>              return VARY_CANCEL;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> just replace the old function on client_side.cc  --&gt;
</I>&gt;<i> varyEvaluateMatch  with
</I>&gt;&gt;<i> the one i post  or i post later  the patch
</I>&gt;&gt;<i> dont lough im not pro but i do my home work
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> View this message in context:
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Vary-object-loop-returns-tp4677716p4677792.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Vary-object-loop-returns-tp4677716p4677792.html</A>
</I>&gt;&gt;<i> Sent from the Squid - Users mailing list archive at Nabble.com.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v2
</I>&gt;<i>   
</I>&gt;<i> iQEcBAEBCAAGBQJXUduWAAoJENNXIZxhPexGP1QH/2Fx0TWZrviMgFavyUsR6jXv
</I>&gt;<i> LADswxk5iCEX20frmDCbIGXRgbmzvGwohYcAWR5aCPCyJxirvkmnSN4KP6it6D5b
</I>&gt;<i> DuwrLVDcxBGg5CeR7ajRO9+yg/0r/MwF2NG7aLSa/ao+sxjJi+D+fRjxy5vQ3Ucq
</I>&gt;<i> TrxjdZn119dbrVkiP8mljoK4pohvEFT07pbA30K0mf2olRg98TTQFOFSWTnnPnjf
</I>&gt;<i> Lhpp60+o9h67p4ELBvAJ8yCloiFRs/2fljCpqDUkwIY74aIX/wjTfbh3+0VLNrYn
</I>&gt;<i> V6GKJ0zpGyr7OcM9BawjfJcoyjMEUy1ZCN5Yf+vjtSqG/UydVbX9OwnhapSlk5U=
</I>&gt;<i> =enzv
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010850.html">[squid-users] Vary object loop returns
</A></li>
	<LI>Next message (by thread): <A HREF="010855.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10854">[ date ]</a>
              <a href="thread.html#10854">[ thread ]</a>
              <a href="subject.html#10854">[ subject ]</a>
              <a href="author.html#10854">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
