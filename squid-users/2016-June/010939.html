<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Vary object loop returns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3C1efe1579-6386-0de8-25a1-d87437f27ded%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010934.html">
   <LINK REL="Next"  HREF="010940.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Vary object loop returns</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3C1efe1579-6386-0de8-25a1-d87437f27ded%40treenet.co.nz%3E"
       TITLE="[squid-users] Vary object loop returns">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun  7 11:00:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010934.html">[squid-users] Vary object loop returns
</A></li>
        <LI>Next message (by thread): <A HREF="010940.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10939">[ date ]</a>
              <a href="thread.html#10939">[ thread ]</a>
              <a href="subject.html#10939">[ subject ]</a>
              <a href="author.html#10939">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/06/2016 9:12 p.m., Yuri Voinov wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 07.06.2016 5:13, Amos Jeffries &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> On 7/06/2016 6:20 a.m., Yuri Voinov wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> By the way, we have another problem. Caching is greatly reduced by the
</I>&gt;&gt;&gt;<i> presence of User-Agent header Vary. Although I know that Amos says - he
</I>&gt;&gt;&gt;<i> says, we should break the Internet and cached separately all types of
</I>&gt;&gt;&gt;<i> user agents.
</I>&gt;<i> 
</I>&gt;&gt;<i> Please do not put your own beliefs into my mouth. I am very much in
</I>&gt;<i> Sorry, Amos. This was sarcasm. May be, not too relevant.
</I>&gt;<i> 
</I>&gt;&gt;<i> favour of denying Vary:User-Agent from being cached *at all* until the
</I>&gt;&gt;<i> UA start sending sensible contents in the header. That would lower your
</I>&gt;&gt;<i> precious HIT ratio a tiny amount.
</I>&gt;<i> Maybe. However, this greatly increases the content duplication. &#1040;gree?
</I>
I'm not sure what you are asking me to agree with there.

The Vary:User-Agent has three cases that can happen:

1) caching it properly results in huge number of probably duplicated
variants in the cache. Each response though is guaranteed to be correct
for that UA when HIT happen.
 I think we agree that situation is bad. Currently the store_miss
directive is the best way to avoid that. Which makes #2 happen instead
of this #1 case.

2) not caching it at all will lower the HIT ratio from sites using it.
However a potentially large amount of cache space will become available
for other better caching sites to use and raise their HIT ratio.
Again each response is guaranteed to be correct for that UA.

3) caching one random copy from the server and delivering it to all
clients regardless of their UA will produce a high HIT ratio. Something
like the HIT ratio from #1 plus ratio gained by #2.
 However, each response will randomy break a) clients expectations, b)
the servers expectations, and c) the site authors behaviour expectations
(ie security model).

I believe #2 is the best tradeoff. You seem to be arguing for #3 solely
on the IT ratio numbers, without considering the actual nasty side effect.


&gt;<i> 
</I>&gt;&gt;<i> BTW: Do you know what &quot;breaking the Internet&quot; actually means? It's a bit
</I>&gt;&gt;<i> ironic that you would throw that insult at me while praising what these
</I>&gt;&gt;<i> patches currently do.
</I>&gt;<i> :) Really sorry.
</I>&gt;<i> 
</I>&gt;<i> Sometimes our experiments scratching the hell out of the display content
</I>&gt;<i> in browsers. That's what I called &quot;break the Internet&quot;. :) But
</I>&gt;<i> seriously, we're trying to find a compromise between a high cache and
</I>&gt;<i> the desire to satisfy customers. It seems to me, mutually exclusive things.
</I>
Ah. What I have been trying to get across is that they are not mutually
exclusive like that.

You have seen the display breakage. That is caused directly by things
like client requesting identity encoding but being delivered a cached
gzip object. Or worse, the garbage output from trying to decompress an
identity object with gzip decompressor. The display gets F*'d.

Note that the reason the wrong content came back in all the above
display problems was that it was a cache HIT and the proxy ignored part
of the Vary header when producing its response.


&gt;<i> 
</I>&gt;<i> Meanwhile, Amos, I still believe that the team should now, in 2016, to
</I>&gt;<i> seriously reconsider attitude to compress the content and possibly
</I>&gt;<i> revise Vary processing algorithms in favor of more vysokgo cache hit
</I>&gt;<i> ratio. Under the conditions of high-speed Internet only a high hit ratio
</I>&gt;<i> justifies the use of caching proxy.
</I>
What attitude? For my part the response (to every submission) is that a
patch doing it right will go in, not another hacked up job.

Who is this &quot;the team&quot; ? It is all of us including you.

We cannot revise the Vary algorithm, it is RFC defined. The best we can
do for the forseeable future is hacked up tricks like filtering what
headers get sent through to the server. I am part-time working with the
Apache and Chrome devs in IETF to design a replacement Key header that
works far better.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010934.html">[squid-users] Vary object loop returns
</A></li>
	<LI>Next message (by thread): <A HREF="010940.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10939">[ date ]</a>
              <a href="thread.html#10939">[ thread ]</a>
              <a href="subject.html#10939">[ subject ]</a>
              <a href="author.html#10939">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
