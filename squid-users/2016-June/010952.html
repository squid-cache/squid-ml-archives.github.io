<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Vary object loop returns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3C8b616b59-3fdb-0428-9379-ab51e1f46c4c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010982.html">
   <LINK REL="Next"  HREF="010914.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Vary object loop returns</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Vary%20object%20loop%20returns&In-Reply-To=%3C8b616b59-3fdb-0428-9379-ab51e1f46c4c%40treenet.co.nz%3E"
       TITLE="[squid-users] Vary object loop returns">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jun  8 06:48:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010982.html">[squid-users] Vary object loop returns
</A></li>
        <LI>Next message (by thread): <A HREF="010914.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10952">[ date ]</a>
              <a href="thread.html#10952">[ thread ]</a>
              <a href="subject.html#10952">[ subject ]</a>
              <a href="author.html#10952">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/06/2016 8:21 a.m., Heiler Bemerguy wrote:
&gt;<i> 
</I>&gt;<i> Some servers will reply like this, trying to avoid caching at any cost
</I>&gt;<i> (I think):
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: nginx
</I>&gt;<i> Content-Type: image/x-icon
</I>&gt;<i> Last-Modified: Tue, 07 Jun 2016 11:16:55 GMT
</I>&gt;<i> ETag: &quot;5756ad27-47e&quot;
</I>&gt;<i> Content-Length: 1150
</I>&gt;<i> X-Suppressed-Cache-Control: max-age=600
</I>&gt;<i> Cache-Control: private, max-age=0, must-revalidate
</I>&gt;<i> X-Suppressed-Expires: Tue, 07 Jun 2016 20:07:36 GMT
</I>&gt;<i> Expires: Thu, 01 Jan 1970 00:00:00 GMT
</I>&gt;<i> Date: Tue, 07 Jun 2016 19:57:36 GMT
</I>&gt;<i> X-Varnish: 510207311
</I>&gt;<i> *Vary:
</I>&gt;<i> Accept,If-None-Match,If-Modified-Since,Accept-Language,Accept-Encoding,X-Client-Locale,User-Agent,X-Device*
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Then our squid will create a vary object with all that information,
</I>&gt;<i> giving this bomb: httpMakeVaryMark:
</I>&gt;<i> accept=&quot;image%2Fpng,image%2F*%3Bq%3D0.8,*%2F*%3Bq%3D0.5&quot;,
</I>&gt;<i> if-none-match=&quot;%225756ad27-47e%22&quot;, if-modified-since,
</I>&gt;<i> accept-language=&quot;en-US,en%3Bq%3D0.8,pt-BR%3Bq%3D0.5,pt%3Bq%3D0.3&quot;,
</I>&gt;<i> accept-encoding=&quot;none&quot;, x-client-locale,
</I>&gt;<i> user-agent=&quot;Mozilla%2F5.0%20(Windows%20NT%2010.0%3B%20WOW64%3B%20rv%3A46.0)%20Gecko%2F20100101%20Firefox%2F46.0&quot;,
</I>&gt;<i> x-device
</I>&gt;<i> 
</I>&gt;<i> It's squid &quot;fault&quot; to convert spaces and symbols to %values, and I think
</I>&gt;<i> no sanity check is performed on it..
</I>
There are at least three sanity checks/protections performed.

 1) the client request headers must parse according to HTTP rules. If
any one of them dont Squid either wont get this far, or will be treating
that header as non-existent/empty.

 2) as of 3.5.19 the total length of the expansion must be short enough
to store in a limited string buffer (~64KB). The recent CVE-2016-* set
of issues happened because it was possible to get past this sometimes.

 3) the header field values are RFC1738 encoded as they are added to the
sub-key to ensure it complies with HTTP octet requirements and prevent
log based attacks. Thats the %-encoding you see in the logs.


&gt;<i> still, I don't see the code where
</I>&gt;<i> it checks if all this info from the new client is identical to the
</I>&gt;<i> stored one.. and I don't know where the &quot;loop&quot; comes from...
</I>
That is a set of separate checks deeper inside store itself which are
performed for every lookup, not just Vary sub-key lookups. One of which
is to compare the URL of the found object with the active request. The
second of which you found with your extra debug already.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010982.html">[squid-users] Vary object loop returns
</A></li>
	<LI>Next message (by thread): <A HREF="010914.html">[squid-users] Vary object loop returns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10952">[ date ]</a>
              <a href="thread.html#10952">[ thread ]</a>
              <a href="subject.html#10952">[ subject ]</a>
              <a href="author.html#10952">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
