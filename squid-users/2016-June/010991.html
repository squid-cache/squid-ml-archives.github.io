<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Unable to IPv6 DNAT &amp; intercept (Debian Stretch, Linux 3.16.0, Squid 3.5.19)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20IPv6%20DNAT%20%26%20intercept%20%28Debian%20Stretch%2C%0A%20Linux%203.16.0%2C%20Squid%203.5.19%29&In-Reply-To=%3Cb1ccacf8-e84d-5e48-ba0c-8148a6e02c30%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010985.html">
   <LINK REL="Next"  HREF="010986.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Unable to IPv6 DNAT &amp; intercept (Debian Stretch, Linux 3.16.0, Squid 3.5.19)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20IPv6%20DNAT%20%26%20intercept%20%28Debian%20Stretch%2C%0A%20Linux%203.16.0%2C%20Squid%203.5.19%29&In-Reply-To=%3Cb1ccacf8-e84d-5e48-ba0c-8148a6e02c30%40treenet.co.nz%3E"
       TITLE="[squid-users] Unable to IPv6 DNAT &amp; intercept (Debian Stretch, Linux 3.16.0, Squid 3.5.19)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun  9 22:22:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010985.html">[squid-users] Unable to IPv6 DNAT &amp; intercept (Debian Stretch,	Linux 3.16.0, Squid 3.5.19)
</A></li>
        <LI>Next message (by thread): <A HREF="010986.html">[squid-users] Response Blocked from sites with multiple IPs (Host	Header Forgery)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10991">[ date ]</a>
              <a href="thread.html#10991">[ thread ]</a>
              <a href="subject.html#10991">[ subject ]</a>
              <a href="author.html#10991">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/06/2016 3:48 a.m., Joni K&#228;h&#228;r&#228; wrote:
&gt;<i> Hello list,
</I>&gt;<i> 
</I>&gt;<i> I'm approaching you with a question regarding intercept proxying and IPv6.
</I>&gt;<i> I have a working IPv4 setup that redirects port 80 traffic to a port that
</I>&gt;<i> Squid is listening on:
</I>&gt;<i> 
</I>&gt;<i>     -A PREROUTING -s &lt;source-net&gt; -p tcp -m tcp --dport 80 -j REDIRECT
</I>&gt;<i> --to-ports &lt;squid-port&gt;
</I>&gt;<i> 
</I>&gt;<i> When I try to duplicate this behaviour on IPv6 side, it does not work. This
</I>&gt;<i> does not seem to be an ACL issue as the symptoms are the same even with an
</I>&gt;<i> all-allowing ACL, and because I'm unable to get even an &quot;access denied&quot;
</I>&gt;<i> error from Squid. I can reach the IPv6 Squid port by accessing it directly
</I>&gt;<i> from the local machine.
</I>&gt;<i> 
</I>&gt;<i> Also, if the REDIRECT is changed to a DNAT, the behaviour is identical
</I>&gt;<i> (i.e. not working):
</I>&gt;<i> 
</I>&gt;<i>     -A PREROUTING -s &lt;source-net&gt; -p tcp -m tcp --dport 80 -j DNAT
</I>&gt;<i> --to-destination [&lt;squid-ip&gt;]:&lt;squid-port&gt;
</I>&gt;<i> 
</I>&gt;<i> By looking at ip6tables packet counters and tcpdump I have come to a
</I>&gt;<i> conclusion that a SYN packet hits the REDIRECT rule, but even if it ever
</I>&gt;<i> reaches Squid, it looks as if Squid is ignoring it and not returning
</I>&gt;<i> anything. Enabling debug sections 5 and 89 show nothing in cache.log while
</I>&gt;<i> the connection establishment is supposed to be happening. While trying to
</I>
Then the issue is in the kernel. That debug level always produces
output, starting with the NAT-mangled IP:port details given by the
accept(2) syscall triggered by SYN arrival.

If the kernel IPv6 NAT is not resulting in an accept(2) operation
something is buggy in the TCP stack.

Double-check that libcap-dev was used when Squid was built. That
rpfilter, SELinux, Apparmor etc. are not blocking the activity.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010985.html">[squid-users] Unable to IPv6 DNAT &amp; intercept (Debian Stretch,	Linux 3.16.0, Squid 3.5.19)
</A></li>
	<LI>Next message (by thread): <A HREF="010986.html">[squid-users] Response Blocked from sites with multiple IPs (Host	Header Forgery)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10991">[ date ]</a>
              <a href="thread.html#10991">[ thread ]</a>
              <a href="subject.html#10991">[ subject ]</a>
              <a href="author.html#10991">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
