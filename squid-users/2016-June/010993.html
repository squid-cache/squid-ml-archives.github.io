<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Response%20Blocked%20from%20sites%20with%20multiple%20IPs%0A%20%28Host%20Header%20Forgery%29&In-Reply-To=%3C66291048-7e48-25d8-23aa-8fd2332a7cd6%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010990.html">
   <LINK REL="Next"  HREF="011007.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Response%20Blocked%20from%20sites%20with%20multiple%20IPs%0A%20%28Host%20Header%20Forgery%29&In-Reply-To=%3C66291048-7e48-25d8-23aa-8fd2332a7cd6%40treenet.co.nz%3E"
       TITLE="[squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun  9 22:54:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010990.html">[squid-users] Response Blocked from sites with multiple IPs	(Host	Header Forgery)
</A></li>
        <LI>Next message (by thread): <A HREF="011007.html">[squid-users] Response Blocked from sites with multiple IPs	(Host	Header Forgery)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10993">[ date ]</a>
              <a href="thread.html#10993">[ thread ]</a>
              <a href="subject.html#10993">[ subject ]</a>
              <a href="author.html#10993">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/06/2016 6:09 a.m., Eng Hooda wrote:
&gt;<i> Hello Squid Users,
</I>&gt;<i> I have just started using squid less than a week ago .
</I>&gt;<i> My setup is a transparent proxy with sslbump , I peek for media streaming sites then terminate their connections then I splice all.
</I>&gt;<i> I noticed that some https sites (not all of the time) , does not respond , when Investigated I found the following in cache.log :
</I>&gt;<i> 
</I>&gt;<i> 3105 2016/06/09 12:45:40.630 kid1| SECURITY ALERT: on URL: mail.live.com:443
</I>&gt;<i> 3106 2016/06/09 12:45:40.631 kid1| SECURITY ALERT: Host header forgery detected on local=157.55.43.16:443 remote=10.3.1.80:58328 FD 94 flags=33 (local IP does not match any domain IP)
</I>&gt;<i> 3330 2016/06/09 13:26:26.676 kid1| SECURITY ALERT: on URL: mail.live.com:443
</I>&gt;<i> 3331 2016/06/09 13:26:26.676 kid1| SECURITY ALERT: Host header forgery detected on local=157.56.122.210:443 remote=10.3.1.80:58414 FD 141 flags=33 (local IP does not match any domain IP)
</I>&gt;<i> 3530 2016/06/09 13:49:49.481 kid1| SECURITY ALERT: on URL: mail.live.com:443
</I>&gt;<i> 3531 2016/06/09 13:49:49.481 kid1| SECURITY ALERT: Host header forgery detected on local=157.55.43.17:443 remote=10.3.1.80:58616 FD 119 flags=33 (local IP does not match any domain IP)
</I>&gt;<i> 
</I>&gt;<i> I searched for a solution which lead me to (1st result)  :  
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>
</I>&gt;<i> 
</I>&gt;<i> I read it and it seems to be a dead end .
</I>&gt;<i> 
</I>&gt;<i> What I understood that client requested page from a certain IP , reply came from another IP then it's blocked for security reasons.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Well I tried to nslookup the mentioned IPs , and all of them are sub domains of mail.live.com
</I>
No, all of them claim to be in their reverse-DNS responses. That is just
the IP address owners view of things. In the case of an attack its the
attackers opinion about what you should believe. Not safe.

Forward-DNS results which provide the domain owners authoritative list
of what IPs they are using. Say a different message contradicting those
reverse-DNS results ...


&gt;<i> also tried to nslookup mail.live.com , and every time I get different IPs
</I>&gt;<i> 
</I>
Exactly. So do Squid and the client. Which means Squid is almost always
unable to see the IP the client is contacting as being a valid one for
that domain.


&gt;<i> nslookup mail.live.com
</I>&gt;<i> Server:  google-public-dns-a.google.com
</I>&gt;<i> Address:  8.8.8.8
</I>&gt;<i> 
</I>
It is a problem caused by Google DNS.

The best way to get around it is to setup a recursive resolver on your
network that is used by both Squid and clients. Diverting the client
port 53 traffic to it if necessary.

If you wish to use Google DNS after having that available, then 8.8.8.8
should be setup as a parent of that local resolver. Not as something
Squid or client contact separately.

That setup makes the google DNS results more often be cached in the
shared resolver for long enough that Squid can see it when it does the
validation steps.

NP: there are other causes of this known, related to connection
persistence, and SSL-Bump SNI being validated. They are bugs in Squid
and still being worked on fixing. So dont expect the above to solve all
instances of it.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010990.html">[squid-users] Response Blocked from sites with multiple IPs	(Host	Header Forgery)
</A></li>
	<LI>Next message (by thread): <A HREF="011007.html">[squid-users] Response Blocked from sites with multiple IPs	(Host	Header Forgery)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10993">[ date ]</a>
              <a href="thread.html#10993">[ thread ]</a>
              <a href="subject.html#10993">[ subject ]</a>
              <a href="author.html#10993">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
