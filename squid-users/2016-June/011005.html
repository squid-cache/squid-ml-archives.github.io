<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] pinger crash - Bad opcode: 112
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20pinger%20crash%20-%20Bad%20opcode%3A%20112&In-Reply-To=%3Caa120a29-edb0-52b8-375e-09cb1f0453ac%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010840.html">
   <LINK REL="Next"  HREF="010819.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] pinger crash - Bad opcode: 112</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20pinger%20crash%20-%20Bad%20opcode%3A%20112&In-Reply-To=%3Caa120a29-edb0-52b8-375e-09cb1f0453ac%40treenet.co.nz%3E"
       TITLE="[squid-users] pinger crash - Bad opcode: 112">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jun 11 05:14:26 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010840.html">[squid-users] pinger crash - Bad opcode: 112
</A></li>
        <LI>Next message (by thread): <A HREF="010819.html">[squid-users] How to analyse squid memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11005">[ date ]</a>
              <a href="thread.html#11005">[ thread ]</a>
              <a href="subject.html#11005">[ subject ]</a>
              <a href="author.html#11005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/06/2016 3:47 a.m., Tomas Mozes wrote:
&gt;<i> On Wed, Jun 1, 2016 at 1:53 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 31/05/2016 9:56 p.m., Tomas Mozes wrote:
</I>&gt;&gt;&gt;<i> On Thu, May 26, 2016 at 8:04 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 24/05/2016 7:52 p.m., Tomas Mozes wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;&gt;&gt;<i> on two different squid servers I've observed a crash of pinger. First
</I>&gt;&gt;<i> it
</I>&gt;&gt;&gt;&gt;&gt;<i> appeared on version 3.5.15 and later on version 3.5.17.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Cache.log contains these lines:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> (pinger): Address.cc:671: void Ip::Address::getAddrInfo(addrinfo*&amp;,
</I>&gt;&gt;<i> int)
</I>&gt;&gt;&gt;&gt;&gt;<i> const: Assertion `false' failed.
</I>&gt;&gt;&gt;&gt;&gt;<i> 2016/05/14 21:55:25 kid1| Bad opcode: 112 from
</I>&gt;&gt;&gt;&gt;&gt;<i> [6661:6c73:6522:2061:7420:6c69:6e65:2036]
</I>&gt;&gt;&gt;&gt;&gt;<i> 2016/05/14 21:59:13 kid1| recv: (111) Connection refused
</I>&gt;&gt;&gt;&gt;&gt;<i> 2016/05/14 21:59:13 kid1| Closing Pinger socket on FD 17
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On both servers, that IPv6 address was the same -
</I>&gt;&gt;&gt;&gt;&gt;<i> 6661:6c73:6522:2061:7420:6c69:6e65:2036
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> That is the hexadecimal representation of the error:
</I>&gt;&gt;&gt;&gt;<i>  false&quot; at line 6
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Which means that your kernel is producing garbage when asked to resolve
</I>&gt;&gt;&gt;&gt;<i> an IPv6 address or respond to an ICMPv6 packet.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Cannot we prevent Squid from crashing in these cases?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid is not crashing. The pinger is. Squid continues with degraded
</I>&gt;&gt;<i> service latency.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Yes, sorry, I wasn't specific. I meant like some part of Squid, not the
</I>&gt;<i> Squid caching process itself.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> What kind of continued operations would you expect a program to do when
</I>&gt;&gt;<i> it discovers at least some portion of its RAM has been filled with
</I>&gt;&gt;<i> garbage by the system kernel?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In the worst case - wouldn't it be possible for the master process to
</I>&gt;<i> restart it?
</I>&gt;<i> 
</I>
For most helpers that is exacty what happens, but with frequent enough
failures killing Squid. That latter bit has been part of the problem
preventing this one being the same so far.

This paticular helper needs root permission to use ICMP sockets. It has
a long history of being installed with wrong ownership and access
permissions, which cause it to exit early. So the most common form of it
dying is not a situation in which Squid can reasonably restart it - or
risks almost certainly dying itself.

Thesituation has been improving in recent years though. So I'm hopeful
we will get there eventually. If you wish to sponsor some work to speed
that up it could be made a configurable action.


&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now cross your fingers and pray that no other programs on your whole
</I>&gt;&gt;<i> system (network, if you did the same &quot;disable&quot; on other machines) are
</I>&gt;&gt;<i> behaving badly in secret when given the garbage by the kernel like
</I>&gt;&gt;<i> Squid's pinger was.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> You know, the strange thing is I only found those strings on google
</I>&gt;<i> attached with Squid. No other place. If it's a general issue in the Linux
</I>&gt;<i> kernel, then it's been there for years, unnoticed. And as I mentioned
</I>&gt;<i> before, it happened on two machines, separate from each other, in
</I>&gt;<i> completely different data-centers with the same error message.
</I>&gt;<i> 
</I>&gt;<i> What would you suggest?
</I>&gt;<i> 
</I>
I suggest enabling IPv6 within your network. :-) It can be firewalled if
you want it not to be used, same as any other digital service.

That will also give you a way to measure whether you have reached
tipping point of it being useful. The global traffic passed 12% last
weekend and growth rate is somewhere between exponential and hyperbolic
despite a lot of networks still clinging to IPv4.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010840.html">[squid-users] pinger crash - Bad opcode: 112
</A></li>
	<LI>Next message (by thread): <A HREF="010819.html">[squid-users] How to analyse squid memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11005">[ date ]</a>
              <a href="thread.html#11005">[ thread ]</a>
              <a href="subject.html#11005">[ subject ]</a>
              <a href="author.html#11005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
