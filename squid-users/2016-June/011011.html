<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Response Blocked from sites with multiple IPs	(Host Header Forgery)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Response%20Blocked%20from%20sites%20with%20multiple%20IPs%0A%09%28Host%20Header%20Forgery%29&In-Reply-To=%3C036201d1c4dc%248f9682b0%24aec38810%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011008.html">
   <LINK REL="Next"  HREF="011014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Response Blocked from sites with multiple IPs	(Host Header Forgery)</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Response%20Blocked%20from%20sites%20with%20multiple%20IPs%0A%09%28Host%20Header%20Forgery%29&In-Reply-To=%3C036201d1c4dc%248f9682b0%24aec38810%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Response Blocked from sites with multiple IPs	(Host Header Forgery)">eliezer at ngtech.co.il
       </A><BR>
    <I>Sun Jun 12 18:59:34 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011008.html">[squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)
</A></li>
        <LI>Next message (by thread): <A HREF="011014.html">[squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11011">[ date ]</a>
              <a href="thread.html#11011">[ thread ]</a>
              <a href="subject.html#11011">[ subject ]</a>
              <a href="author.html#11011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

There are couple options to do that.
Since you are using Debian 8 the most used are:
-	Bind
-	Unbound
They both have a very simple installation and configuration.
The first step would be to let squid access the caching service.
If you can point your clients to this specific DNS host it would be good but if not and you are able to Intercept DNS traffic,
you can try to see how Interception of all 8.8.8.8 and other dns services works.
You can use the iptables REDIRECT which is similar to what you might use in\for squid.
The next tutorial is for CentOS but have the needed configuration snippets that would work with any Unbound installation:
<A HREF="http://www.tecmint.com/setup-dns-cache-server-in-centos-7/">http://www.tecmint.com/setup-dns-cache-server-in-centos-7/</A>
And another one which looks a bit different
<A HREF="https://calomel.org/unbound_dns.html">https://calomel.org/unbound_dns.html</A>

And another guide for ubnutu on using Bind as a caching dns service:
<A HREF="https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-caching-or-forwarding-dns-server-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-caching-or-forwarding-dns-server-on-ubuntu-14-04</A>

Which should work almost the same for Debian.

If you need more details let me know.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Eng Hooda
Sent: Saturday, June 11, 2016 7:44 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>; Amos Jeffries
Subject: [squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)

Thank You for your response.
What is the best way to setup recursive resolver ?

Best Regards,
Eng Hooda

--------------------------------------------
On Fri, 6/10/16, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

 Subject: Re: [squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)
 To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 Date: Friday, June 10, 2016, 12:54 AM
 
 On 10/06/2016 6:09 a.m.,
 Eng Hooda wrote:
 &gt; Hello Squid Users,
 &gt; I have just started using squid less than  a week ago .
 &gt; My setup is a transparent
 proxy with sslbump , I peek for media streaming sites then  terminate their connections then I splice all.
 &gt; I noticed that some https sites (not all  of the time) , does not respond , when Investigated I found  the following in cache.log :
 &gt;
 &gt; 3105 2016/06/09 12:45:40.630 kid1|
 SECURITY ALERT: on URL: mail.live.com:443  &gt; 3106 2016/06/09 12:45:40.631 kid1|  SECURITY ALERT: Host header forgery detected on
 local=157.55.43.16:443 remote=10.3.1.80:58328 FD 94 flags=33  (local IP does not match any domain IP)  &gt;
 3330 2016/06/09 13:26:26.676 kid1| SECURITY ALERT: on URL:
 mail.live.com:443
 &gt; 3331 2016/06/09
 13:26:26.676 kid1| SECURITY ALERT: Host header forgery  detected on local=157.56.122.210:443 remote=10.3.1.80:58414  FD 141 flags=33 (local IP does not match any domain IP)  &gt; 3530 2016/06/09 13:49:49.481 kid1|  SECURITY ALERT: on URL: mail.live.com:443  &gt; 3531 2016/06/09 13:49:49.481 kid1|  SECURITY ALERT: Host header forgery detected on
 local=157.55.43.17:443 remote=10.3.1.80:58616 FD 119
 flags=33 (local IP does not match any domain IP)  &gt;  &gt; I searched for a  solution which lead me to (1st result)  :  &gt; <A HREF="http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>
 &gt;
 &gt; I read it and it
 seems to be a dead end .
 &gt;
 &gt; What I understood that client requested  page from a certain IP , reply came from another IP then  it's blocked for security reasons.
 &gt;
 
 &gt;
 &gt; Well I tried to
 nslookup the mentioned IPs , and all of them are sub domains  of mail.live.com
 
 No, all of
 them claim to be in their reverse-DNS responses. That is  just  the IP address owners view of things.
 In the case of an attack its the
 attackers
 opinion about what you should believe. Not safe.
 
 Forward-DNS results which
 provide the domain owners authoritative list  of what IPs they are using. Say a different  message contradicting those  reverse-DNS  results ...
 
 
 &gt; also tried to nslookup mail.live.com , and  every time I get different IPs  &gt; 
 
 Exactly. So do Squid and the
 client. Which means Squid is almost always  unable to see the IP the client is contacting  as being a valid one for  that domain.
 
 
 &gt; nslookup mail.live.com
 &gt; Server:
 google-public-dns-a.google.com
 &gt;
 Address:  8.8.8.8
 &gt; 
 
 It is a problem caused by
 Google DNS.
 
 The best way to
 get around it is to setup a recursive resolver on your  network that is used by both Squid and clients.
 Diverting the client
 port 53 traffic to it
 if necessary.
 
 If you wish
 to use Google DNS after having that available, then
 8.8.8.8
 should be setup as a parent of that
 local resolver. Not as something
 Squid or
 client contact separately.
 
 That setup makes the google DNS results more  often be cached in the  shared resolver for  long enough that Squid can see it when it does the  validation steps.
 
 NP: there are other causes of this known,  related to connection  persistence, and  SSL-Bump SNI being validated. They are bugs in Squid  and still being worked on fixing. So dont  expect the above to solve all  instances of  it.
 
 Amos
 
 _______________________________________________
 squid-users mailing list
 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160612/7da989f7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160612/7da989f7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011008.html">[squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)
</A></li>
	<LI>Next message (by thread): <A HREF="011014.html">[squid-users] Response Blocked from sites with multiple IPs (Host Header Forgery)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11011">[ date ]</a>
              <a href="thread.html#11011">[ thread ]</a>
              <a href="subject.html#11011">[ subject ]</a>
              <a href="author.html#11011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
