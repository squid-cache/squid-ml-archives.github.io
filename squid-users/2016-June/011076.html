<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS issues with squidguard after upgrading from	squid 2.7 to 3.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20issues%20with%20squidguard%20after%20upgrading%20from%0A%09squid%202.7%20to%203.5&In-Reply-To=%3C09d101d1c836%249daa06d0%24d8fe1470%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011063.html">
   <LINK REL="Next"  HREF="011077.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS issues with squidguard after upgrading from	squid 2.7 to 3.5</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20issues%20with%20squidguard%20after%20upgrading%20from%0A%09squid%202.7%20to%203.5&In-Reply-To=%3C09d101d1c836%249daa06d0%24d8fe1470%24%40ngtech.co.il%3E"
       TITLE="[squid-users] HTTPS issues with squidguard after upgrading from	squid 2.7 to 3.5">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Jun 17 01:21:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011063.html">[squid-users] HTTPS issues with squidguard after upgrading from squid 2.7 to 3.5
</A></li>
        <LI>Next message (by thread): <A HREF="011077.html">[squid-users] HTTPS issues with squidguard after upgrading from squid 2.7 to 3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11076">[ date ]</a>
              <a href="thread.html#11076">[ thread ]</a>
              <a href="subject.html#11076">[ subject ]</a>
              <a href="author.html#11076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Good to hear!!!
Indeed Amos is correct and now I think this thread will be used for many users as a very good example.
Eventually as I mentioned, if it works for you and others then great.
I have encountered couple cases which the squidGuard update was too &quot;expensive&quot; and riskey but it seems that squidGuard is still kicking despite to not being maintain.

I have a non-public question but if you can share it will be nice.
What is the users size\capacity of the system?
I am asking since I have seen that many squidGuard based systems have acted slower then with ICAP.
By slower I mean that the initial squidGuard lookup response caused slower page display by ms to couple secs.
I have not researched the exact reasons since I will not try to fix what is already fine for many.

Thanks,
Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of reqman
Sent: Thursday, June 16, 2016 10:55 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] HTTPS issues with squidguard after upgrading from squid 2.7 to 3.5

Hello Eliezer,

first let me thank you for providing a complete and detailed explanation, I think I understand now what gives here.

Minor note: Amos is correct in stating that url_rewrite_access basically controls what is thrown into the redirector.

Now, before I opened this discussion I also came to the conclusion that to get rid of these issues, I had to avoid throwing HTTPS through a rewrite with squidguard. Indeed, setting the following solved the
issue...:

========================
url_rewrite_program /usr/local/bin/squidGuard url_rewrite_children 8
startup=4 idle=4 concurrency=0
url_rewrite_access deny CONNECT
url_rewrite_access allow all
========================

... only to introduce another one: all HTTPS passes unfiltered.

So I tried to follow your advice to implement the same things, without using url_rewrite_program. I have tested and have the patched version of squidGuard (or so it seems). In doing so, I stumbled upon a couple of issues that complicate the solution, specifically:

* My error redirect page can not be used when the original request was a CONNECT one
* Even if it did, it would be complicated a bit to try and extract additional information (ie class that registered a hit with) from squidguard back to squid.

With your information, I was able to happily combine both the functionality of url_rewrite_program, as well as using an external acl.

In not so many words, the modifications to my original.
url_rewrite-based approach is to:
1) first do not use url_rewrite at all for CONNECT methods
2) modify http_access when made via CONNECT, to take into account the external acl rule (again based on squidguard), and block via TCP_RESET

In coding this means that:
1) The initial handling with:
========================
url_rewrite_program /usr/local/bin/squidGuard url_rewrite_children 8
startup=4 idle=4 concurrency=0
url_rewrite_access allow all
========================

... now becomes:
========================
url_rewrite_program /usr/local/bin/squidGuard url_rewrite_children 8
startup=4 idle=4 concurrency=0
url_rewrite_access deny CONNECT
url_rewrite_access allow all
========================

2) To handle CONNECT, the existing block that handles CONNECT logic:
========================
acl CONNECT method CONNECT

http_access deny CONNECT !SSL_ports
http_access allow CONNECT
========================

becomes:

========================
acl CONNECT method CONNECT
external_acl_type filter_url ipv4 concurrency=0 ttl=3 %URI %SRC %{-} %un %METHOD /usr/local/bin/squidGuard acl filter_url_acl external filter_url

# Important: When an unwanted site appears in HTTPS, just forcefully close the TCP connection!
deny_info TCP_RESET filter_url_acl

http_access deny CONNECT filter_url_acl
http_access deny CONNECT !SSL_ports

http_access allow CONNECT
========================

With this approach, some squidguard children are spawned as redirectors (via url_rewrite_program), whereas some more are spawned from &quot;external_acl_type filter_url&quot;.

2016-06-15 21:12 GMT+03:00 Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;:
&gt;<i> Hey Michael,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Well I have not tested FreeBSD dependencies and patches and I am not 
</I>&gt;<i> following them daily.
</I>&gt;<i>
</I>&gt;<i> The issue itself with SquidGuard and the url_rewrite interface is more 
</I>&gt;<i> of an issue in most cases with CONNECT requests as you mentioned.
</I>&gt;<i>
</I>&gt;<i> Since you are not using ssl_bump then you need to deny the 
</I>&gt;<i> traffic\requests in a way that will not leave squid or the clients and 
</I>&gt;<i> the session in an unknown or unexpected situation.
</I>&gt;<i>
</I>&gt;<i> When the url_rewrite interface is used to &quot;Deny&quot; something it's not 
</I>&gt;<i> really denying but rather &quot;rewriting&quot; something due to it's nature.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On regular plain http requests some mangling to the request(affecting 
</I>&gt;<i> the
</I>&gt;<i> response) is possible but when handling CONNECT requests it's a whole 
</I>&gt;<i> new story.
</I>&gt;<i>
</I>&gt;<i> We don't know how the client will respond to a malformed response or 
</I>&gt;<i> squid to a malformed rewritten request, and it is possible that the 
</I>&gt;<i> client will expect a specific 50x\40x response code.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The external_acl interface was built as an ACL extension with the 
</I>&gt;<i> basic ability to overcome the limits of the url_rewrite interface.
</I>&gt;<i>
</I>&gt;<i> Content or url filtering is an ACL level operation and not url 
</I>&gt;<i> rewriting\mangling and there for it is better(in squid) to do it in a 
</I>&gt;<i> way that the client can identify(30x).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The best possible way to deny such a connection(CONNECT) is using a 
</I>&gt;<i> 50x or 40x code.
</I>&gt;<i> I do not remember which one is accepted better by browsers and clients 
</I>&gt;<i> and you will be able to find it yourself easily adding couple lines or 
</I>&gt;<i> using the scripts I wrote before.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And more directly to the subject, I will say that if these network &quot;issues&quot;
</I>&gt;<i> are might be because of any squid side of wrongly handling CONNECT 
</I>&gt;<i> requests that was mangled with a url_rewrite.
</I>&gt;<i> I would say that these specific cases is the proof of the wrongly used 
</I>&gt;<i> interface.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The url_rewrite might contain a bug when handling a CONNECT request 
</I>&gt;<i> but the bug is that it is handling these connections at all and not otherwise.
</I>&gt;<i>
</I>&gt;<i> My suggestion is that you would try to see if you can use something 
</I>&gt;<i> like
</I>&gt;<i> that:
</I>&gt;<i>
</I>&gt;<i> ## START
</I>&gt;<i>
</I>&gt;<i> url_rewrite_program /usr/local/bin/squidGuard url_rewrite_children 8
</I>&gt;<i> startup=4 idle=4 concurrency=0
</I>&gt;<i>
</I>&gt;<i> url_rewrite_access deny CONNECT
</I>&gt;<i>
</I>&gt;<i> url_rewrite_access allow all
</I>&gt;<i>
</I>&gt;<i> ## END
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And  add another external_acl helper with the wrapper I gave you 
</I>&gt;<i> without any special deny_info for the ACL.
</I>&gt;<i> Squid will be able to handle these probably fine and will deny the 
</I>&gt;<i> connections using some right access deny code(don't expect fancy 
</I>&gt;<i> warning pages without using some level of ssl_bump).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I do not know if you need a fast solution or you are planning 
</I>&gt;<i> carefully with the available options.
</I>&gt;<i>
</I>&gt;<i> The options are to either use a &quot;fast&quot; solution to mitigate an 
</I>&gt;<i> annoying issue or to find the right path.
</I>&gt;<i>
</I>&gt;<i> The solution to either of the options is in your hands..
</I>&gt;<i>
</I>&gt;<i> If for your squidGuard setup offers you the right solution from all 
</I>&gt;<i> the right aspects despite to the fact that it's working slower then 
</I>&gt;<i> other solutions then it is the solution for you!!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The technology of black and white listing was enhanced in the last 
</I>&gt;<i> decade but not too drastically.
</I>&gt;<i>
</I>&gt;<i> The basic concept is that there are query and analysis components 
</I>&gt;<i> which are not forced to be one software.
</I>&gt;<i>
</I>&gt;<i> There will always be false positives to this or another way but some 
</I>&gt;<i> categorizing systems are much stricter and sensitive about the subject 
</I>&gt;<i> then others.
</I>&gt;<i>
</I>&gt;<i> All this leaving aside the sources of the lists you and since only you 
</I>&gt;<i> have a definition of the wanted\desired results with the available options.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You also stated that you have some funding issues, but just as a side note:
</I>&gt;<i> the wanted result is eventually forcing the final product of work and 
</I>&gt;<i> the expense(any if at all).
</I>&gt;<i>
</I>&gt;<i> I mean with these words that if you do not care about false positives 
</I>&gt;<i> and using some product satisfy the desire or need then I think it's ok 
</I>&gt;<i> for your case.
</I>
I am taking care of false positives by whitelisting sites over this last decade. My whitelisted sites are basically non-growing.

At some point I *will* have to look at something else. But first, I'll have to examine:
1) Which software to use: e2guardian and ufdbguard were referenced.
I'll have to delve into some study here
2) Same thing on which free *lists* to use. Will definitely need some reading here too.

Again, thanks for taking all this time to respond. HUGELY appreciated :)

&gt;<i> I will add that from my tests there are different results to basic 
</I>&gt;<i> pages\objects loading\access speed when using one software or another, 
</I>&gt;<i> and\or one protocol\interface or another.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here if you need more help\advice handling the situation.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> Linux System Administrator
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">michail.pappas at gmail.com</A> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">michail.pappas at gmail.com</A>] On 
</I>&gt;<i> Behalf Of reqman
</I>&gt;<i> Sent: Wednesday, June 15, 2016 2:19 PM
</I>&gt;<i> To: Eliezer Croitoru
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> Subject: Re: [squid-users] HTTPS issues with squidguard after 
</I>&gt;<i> upgrading from squid 2.7 to 3.5
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hello Eliezer,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2016-06-15 11:45 GMT+03:00 Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> Hey Michael,
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I am missing couple details about the setup which might affect the 
</I>&gt;&gt;<i> way we would be able to understand what is causing the issue and how to resolve it.
</I>&gt;<i>
</I>&gt;&gt;<i> There are changes from squid 2.7 to 3.5 and to my opinion these are 
</I>&gt;&gt;<i> mandatory to resolve and to not go one step back.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes, I saw that 3.5 effectively disabled/obsoleted/deactivated various 
</I>&gt;<i> options. I believe I took care in following through those requirements.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> What version of SquidGuard 1.4 did you installed? The patched for 
</I>&gt;&gt;<i> squid 3.4+ compatibility?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I installed a ready to use package from FreeBSD. I presume that is is 
</I>&gt;<i> ok with squid 3.4, according to its dependencies:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # pkg query &quot;%do%dv&quot; squidGuard
</I>&gt;<i>
</I>&gt;<i> www/squid3.5.19
</I>&gt;<i>
</I>&gt;<i> databases/db55.3.28_3
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Other information for squidGuard:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # pkg info squidGuard
</I>&gt;<i>
</I>&gt;<i> squidGuard-1.4_15
</I>&gt;<i>
</I>&gt;<i> Name           : squidGuard
</I>&gt;<i>
</I>&gt;<i> Version        : 1.4_15
</I>&gt;<i>
</I>&gt;<i> Installed on   : Mon May 30 08:24:17 2016 EEST
</I>&gt;<i>
</I>&gt;<i> Origin         : www/squidguard
</I>&gt;<i>
</I>&gt;<i> Architecture   : freebsd:10:x86:64
</I>&gt;<i>
</I>&gt;<i> Prefix         : /usr/local
</I>&gt;<i>
</I>&gt;<i> Categories     : www
</I>&gt;<i>
</I>&gt;<i> Licenses       : GPLv2
</I>&gt;<i>
</I>&gt;<i> Maintainer     : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">garga at FreeBSD.org</A>
</I>&gt;<i>
</I>&gt;<i> WWW            : <A HREF="http://www.squidguard.org/">http://www.squidguard.org/</A>
</I>&gt;<i>
</I>&gt;<i> Comment        : Fast redirector for squid
</I>&gt;<i>
</I>&gt;<i> Options        :
</I>&gt;<i>
</I>&gt;<i>        DNS_BL         : off
</I>&gt;<i>
</I>&gt;<i>        DOCS           : on
</I>&gt;<i>
</I>&gt;<i>        EXAMPLES       : on
</I>&gt;<i>
</I>&gt;<i>        LDAP           : off
</I>&gt;<i>
</I>&gt;<i>        QUOTE_STRING   : off
</I>&gt;<i>
</I>&gt;<i>        STRIP_NTDOMAIN : off
</I>&gt;<i>
</I>&gt;<i> Shared Libs required:
</I>&gt;<i>
</I>&gt;<i>        libdb-5.3.so.0
</I>&gt;<i>
</I>&gt;<i> Annotations    :
</I>&gt;<i>
</I>&gt;<i>        repo_type      : binary
</I>&gt;<i>
</I>&gt;<i>        repository     : FreeBSD
</I>&gt;<i>
</I>&gt;<i> Flat size      : 2.24MiB
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> More details about it here:
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=3978">http://bugs.squid-cache.org/show_bug.cgi?id=3978</A>
</I>&gt;<i>
</I>&gt;&gt;<i> Now if it is indeed patched and works as expected it from the 3.4+ 
</I>&gt;&gt;<i> computability level of things then lets move on.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Checking the bug and if I understand correctly, if my squidGuard was 
</I>&gt;<i> not patched then it wouldn't work. This is not the case. It works ok 
</I>&gt;<i> for http urls, ie blocks fine and the user is correctly redirected to 
</I>&gt;<i> the block page setup for this purpose. It's HTTPS I'm having issues
</I>&gt;<i>
</I>&gt;<i> with: according to some talks, if something gets blocked by 
</I>&gt;<i> squidguard, something is miscommunicated (or not communicated at all) with squid.
</I>&gt;<i> Instead of a block, the users waits endlessly for the page.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Are you using Squid in intercept\transparent\trpoxy mode or is it 
</I>&gt;&gt;<i> defined in the browsers directly?
</I>&gt;<i>
</I>&gt;&gt;<i> If you are using intercept mode, what have you defined on the FreeBSD 
</I>&gt;&gt;<i> pf\ipfw?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Squid operates in normal mode. I've configured a 10year old proxy 
</I>&gt;<i> autodiscovery script, which is published through DHCP. All browsers 
</I>&gt;<i> are set to configure everything automatically.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> And about the quote from the mailing list:
</I>&gt;<i>
</I>&gt;&gt;<i> SquidGuard was written to operate under the url_rewrite 
</I>&gt;&gt;<i> interface\protocol and not external_acl.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I've lost you here: why do I need squidGuard to operate under external_acl?
</I>&gt;<i> Can't I leave it running with url_rewrite?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Due to this it has some disadvantages and the advised details are to 
</I>&gt;&gt;<i> modify the helper(SquidGuard or another) to operate in another way.
</I>&gt;<i>
</I>&gt;&gt;<i> It is possible to use the patched version of SquidGuard under the 
</I>&gt;&gt;<i> external_acl interface and use squid options to deny\redirect the request.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I saw your other email, but I again have to ask. My own squidguard &quot;seems&quot;
</I>&gt;<i> to work. What are the merits of doing things with external_acl instead 
</I>&gt;<i> of the way I am doing things right now?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> It removes some things from the complexity of the issue.
</I>&gt;<i>
</I>&gt;&gt;<i> I have just written an example on how to use use my software 
</I>&gt;&gt;<i> SquidBlocker under external_acl and here the adapted example that can 
</I>&gt;&gt;<i> be used with a patched SquidGuard:
</I>&gt;<i>
</I>&gt;&gt;<i> ## START OF SETTINGS
</I>&gt;<i>
</I>&gt;&gt;<i> external_acl_type filter_url ipv4 concurrency=0 ttl=3 %URI %SRC/-
</I>&gt;<i>
</I>&gt;&gt;<i> %LOGIN %METHOD /usr/local/bin/squidGuard url_rewrite_children acl
</I>&gt;<i>
</I>&gt;&gt;<i> filter_url_acl external filter_url deny_info
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://ngtech.co.il/block_page/?url=%u&amp;domain=%H">http://ngtech.co.il/block_page/?url=%u&amp;domain=%H</A> filter_url_acl #or #
</I>&gt;<i>
</I>&gt;&gt;<i> deny_info 302:<A HREF="http://ngtech.co.il/block_page/?url=%u&amp;domain=%H">http://ngtech.co.il/block_page/?url=%u&amp;domain=%H</A>
</I>&gt;<i>
</I>&gt;&gt;<i> filter_url_acl http_access deny !filter_url_acl http_access allow
</I>&gt;<i>
</I>&gt;&gt;<i> localnet filter_url_acl ## END OF SETTINGS
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I have not tested this request format but if it doesn't work this way 
</I>&gt;&gt;<i> then a little cosmetics will make it work.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> When more information will be available we can try to see where the 
</I>&gt;&gt;<i> issue is from.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;<i>
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;&gt;<i> Linux System Administrator
</I>&gt;<i>
</I>&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;<i>
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;<i>
</I>&gt;&gt;<i> On Behalf Of reqman
</I>&gt;<i>
</I>&gt;&gt;<i> Sent: Wednesday, June 15, 2016 10:22 AM
</I>&gt;<i>
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;&gt;<i> Subject: [squid-users] HTTPS issues with squidguard after upgrading
</I>&gt;<i>
</I>&gt;&gt;<i> from squid 2.7 to 3.5
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Hello all,
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I have been running squid 2.7.X alongside squidguard 1.4 on a FreeBSD 
</I>&gt;&gt;<i> 8.x box for years.
</I>&gt;<i>
</I>&gt;&gt;<i> Started out some 10 years ago, with a much older 
</I>&gt;&gt;<i> squid/squidguard/FreeBSD combination.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Having to upgrade to FreeBSD 10.3, I examined my option regarding squid.
</I>&gt;<i>
</I>&gt;&gt;<i> 3.5.19 was available which I assumed would behave the same as 2.7, 
</I>&gt;&gt;<i> regarding compatibility.
</I>&gt;<i>
</I>&gt;&gt;<i> Squidguard 1.4 was also installed.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> - Squid was configured to behave along the lines of what I had on 2.7.
</I>&gt;<i>
</I>&gt;&gt;<i> - For squidguard I used the exact same blocklists and configurations.
</I>&gt;<i>
</I>&gt;&gt;<i> Note that I do not employ an URL rewriting in squidguard, only 
</I>&gt;&gt;<i> redirection.
</I>&gt;<i>
</I>&gt;&gt;<i> - no SSL-bump or other SSL interception takes place
</I>&gt;<i>
</I>&gt;&gt;<i> - the squidguard-related lines on squid are the following:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> url_rewrite_program /usr/local/bin/squidGuard url_rewrite_children 8
</I>&gt;<i>
</I>&gt;&gt;<i> startup=4 idle=4 concurrency=0 url_rewrite_access allow all
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> - In squidGuard.conf, the typical redirect section is like:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>  default {
</I>&gt;<i>
</I>&gt;&gt;<i>                 pass local-ok !block1 !block2 !blockN all
</I>&gt;<i>
</I>&gt;&gt;<i>                 redirect
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 301:<A HREF="http://localsite/block.htm?clientaddr=%a+clientname=%n+clientiden">http://localsite/block.htm?clientaddr=%a+clientname=%n+clientiden</A>
</I>&gt;&gt;<i> t=%i+srcclass=%s+targetclass=%t+url=%u
</I>&gt;<i>
</I>&gt;&gt;<i>         }
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I am now experiencing problems that I did not have. Specifically, 
</I>&gt;&gt;<i> access to certain but *not* all HTTPS sites seems to timeout.
</I>&gt;<i>
</I>&gt;&gt;<i> Furthermore, I see entries similar to the following in cache.log:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3446 FD 591 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3448 FD 592 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3452 FD 594 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3456 FD 596 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3454 FD 595 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3458 FD 597 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i> 2016/06/15 09:27:59 kid1| abandoning local=192.168.0.1:3128
</I>&gt;<i>
</I>&gt;&gt;<i> remote=192.168.2.239:3462 FD 599 flags=1
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Searching around, the closest I have come to an answer is the
</I>&gt;<i>
</I>&gt;&gt;<i> following:
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://www.squid-cache.org/mail-archive/squid-users/201211/0165.html">http://www.squid-cache.org/mail-archive/squid-users/201211/0165.html</A>
</I>&gt;<i>
</I>&gt;&gt;<i> I am not sure though whether I am plagued by the same issue, 
</I>&gt;&gt;<i> considering that the thread refers to a squid version dated 4 years 
</I>&gt;&gt;<i> ago. And I definitely do not understand what the is meant by the poster's proposal:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> &quot;If you can't alter the re-writer to perform redirection you can work 
</I>&gt;&gt;<i> around that by using:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>   acl foo ... some test to match the re-written URL ...
</I>&gt;<i>
</I>&gt;&gt;<i>   deny_info 302:%s foo
</I>&gt;<i>
</I>&gt;&gt;<i>   adapted_http_access deny foo &quot;
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Can someone help resolve this?
</I>&gt;<i>
</I>&gt;&gt;<i> Is the 2.7 series supported at all?
</I>&gt;<i>
</I>&gt;&gt;<i> As is if everything fails, I'll have to go back to it if there's some 
</I>&gt;&gt;<i> support.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> BR,
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Michael.-
</I>&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;<i>
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011063.html">[squid-users] HTTPS issues with squidguard after upgrading from squid 2.7 to 3.5
</A></li>
	<LI>Next message (by thread): <A HREF="011077.html">[squid-users] HTTPS issues with squidguard after upgrading from squid 2.7 to 3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11076">[ date ]</a>
              <a href="thread.html#11076">[ thread ]</a>
              <a href="subject.html#11076">[ subject ]</a>
              <a href="author.html#11076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
