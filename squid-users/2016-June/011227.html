<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Conditional IPv6 usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Conditional%20IPv6%20usage&In-Reply-To=%3C1e0703b4-3fff-62f9-f215-1d2a9b2bf33b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011225.html">
   <LINK REL="Next"  HREF="011300.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Conditional IPv6 usage</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Conditional%20IPv6%20usage&In-Reply-To=%3C1e0703b4-3fff-62f9-f215-1d2a9b2bf33b%40treenet.co.nz%3E"
       TITLE="[squid-users] Conditional IPv6 usage">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jun 25 05:35:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011225.html">[squid-users] Conditional IPv6 usage
</A></li>
        <LI>Next message (by thread): <A HREF="011300.html">[squid-users] Conditional IPv6 usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11227">[ date ]</a>
              <a href="thread.html#11227">[ thread ]</a>
              <a href="subject.html#11227">[ subject ]</a>
              <a href="author.html#11227">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/06/2016 6:27 a.m., Stefan H&#246;lzle wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm having trouble configuring a forward proxy.
</I>&gt;<i> My goal is the following:
</I>&gt;<i> Only for one destination domain IPv6 should be used, otherwise IPv4.
</I>
This is not how the Internet Protocol (IP) works. If a domain is
advertising IPv6 addresses, then it can and should be contacted using
those addresses.

&gt;<i> 
</I>&gt;<i> The proxy has multiple incoming IPs and multiple outgoing IPs, here is
</I>&gt;<i> the relevant part of the squid.conf:
</I>&gt;<i> 
</I>&gt;<i> acl port80 localport 80
</I>&gt;<i> acl port88 localport 88
</I>&gt;<i> acl port443 localport 443
</I>&gt;<i> 
</I>&gt;<i> http_port 10.0.0.54:80
</I>&gt;<i> http_port 10.0.0.54:443
</I>&gt;<i> http_port 10.0.0.59:80
</I>&gt;<i> http_port 10.0.0.59:443
</I>&gt;<i> http_port 10.0.0.59:88
</I>
Problem #1: you are configuring a forward proxy on port 80 and 443 which
are registered ports for reverse-proxy traffic syntax.

This is not necessarily a big problem. But other software in the
environment that handles port 80 and 443 traffic may interpret the
format wrongly and scew things up.


&gt;<i> 
</I>&gt;<i> acl ipA localip 10.0.0.54
</I>&gt;<i> acl ipB localip 10.0.0.59
</I>&gt;<i> 
</I>&gt;<i> # only somedomain.asdf via IPv6
</I>&gt;<i> acl domain_acl dstdom_regex -i \.somedomain\.asdf
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 10.0.0.93 ipB port88
</I>&gt;<i> tcp_outgoing_address 2001:cdba::3257:9652 ipB port88 domain_acl
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 10.0.0.54 ipA port80
</I>&gt;<i> tcp_outgoing_address 10.0.0.63 ipA port443
</I>&gt;<i> tcp_outgoing_address 10.0.0.59 ipB port80
</I>&gt;<i> tcp_outgoing_address 10.0.0.93 ipB port443
</I>&gt;<i> 
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> Expected behavior:
</I>&gt;<i> A connection on http_port 10.0.0.59:88 is requesting a domain matching
</I>&gt;<i> regex &quot;\.somedomain\.asdf&quot;, then the first matching tcp_outgoing_address
</I>&gt;<i> is used, namely
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 2001:cdba::3257:9652 ipB port88 domain_acl
</I>&gt;<i> 
</I>
Expectation is a bit wrong.

tcp_outgoing_address configures _which address to use the type of
traffic that server requires. The connection has already been allowed by
tha http_access rules - which do not distinguish whether IPv4 or IPv6 is
used to contact any particular server.


You literally cannot send traffic to an IPv6 addressed server using IPv4
packet format. Nor vice versa. Squid knows that and does not attempt to
use the wrong family of IP for any outgoing traffic.

So:
- The server destination *has already been selected for use* by
determining in various *_access lists that the client is allowed to
contact that *domain*.

- IPv6 entries are ignored for IPv4 server destinations.

- IPv4 entries are ignored for IPv6 server destinations.

&gt;<i> 
</I>&gt;<i> Actual behavior:
</I>&gt;<i> A connection on http_port 10.0.0.59:88 is requesting a domain matching
</I>&gt;<i> regex &quot;\.somedomain\.net&quot; and
</I>&gt;<i> 
</I>
Incoming port has nothing to do with outgoing IP format.

* DNS tells Squid a set of IP addresses that the domain can be contacted at.

** &quot;dns_v4_first on&quot; tells Squid to use the servers A address(es) as
first choice before attempting IPv6 contact.

That domain *does* have an A address. So...

&gt;<i> tcp_outgoing_address 10.0.1.54 ipA port80
</I>&gt;<i> 
</I>&gt;<i> is used.
</I>
If that fails it might fail over to another IPv4 or to the domains IPv6
address.


&gt;<i> If I change dns_v4_first from on to off,
</I>&gt;<i> 
</I>
** then &quot;dns_v4_first on&quot; tells Squid to use the servers AAAA address as
first choice before attempting IPv6 contact.

** That domain *does* have an AAAA address. So ...

&gt;<i> tcp_outgoing_address 2001:cdba::3257:9652 ipB port88 domain_acl
</I>&gt;<i> 
</I>
... or the machines default IPv6 addresss is used when contacting the
servers AAAA address(es).

If that fails then Squid might failover to another of the servers IPv6
addresses, or to its IPv4 address.




You can choose a particular IP from amongst the appropriate v4/v6 types
available. But you cannot force a particular type to be used.
 (though you might configure an IPv4/IPv6 address which will force
breakage on the connection).


It is the network firewalls job to determine whether *Squid* is allowed
contact from IP A to IP B. If it blocks unwanted IPv6 traffic properly,
then the normal ICMPv6 packet that comes back from the firewall will
tell Squid to try the next IP on the list for the server being contacted.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011225.html">[squid-users] Conditional IPv6 usage
</A></li>
	<LI>Next message (by thread): <A HREF="011300.html">[squid-users] Conditional IPv6 usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11227">[ date ]</a>
              <a href="thread.html#11227">[ thread ]</a>
              <a href="subject.html#11227">[ subject ]</a>
              <a href="author.html#11227">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
