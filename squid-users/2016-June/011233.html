<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid question with letsencrypt
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20question%20with%20letsencrypt&In-Reply-To=%3C70332e91-3b59-1d02-4ade-f215d2d99957%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011223.html">
   <LINK REL="Next"  HREF="011276.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid question with letsencrypt</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20question%20with%20letsencrypt&In-Reply-To=%3C70332e91-3b59-1d02-4ade-f215d2d99957%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid question with letsencrypt">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jun 25 06:51:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011223.html">[squid-users] Squid question with letsencrypt
</A></li>
        <LI>Next message (by thread): <A HREF="011276.html">[squid-users] Squid question with letsencrypt
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11233">[ date ]</a>
              <a href="thread.html#11233">[ thread ]</a>
              <a href="subject.html#11233">[ subject ]</a>
              <a href="author.html#11233">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/06/2016 4:48 a.m., Bidwell, Christopher wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I'm very new to squid and we are wanting to implement letsencrypt for our
</I>&gt;<i> ssl certificates.
</I>&gt;<i> 
</I>&gt;<i> Here's the scenario:
</I>&gt;<i> 
</I>&gt;<i> We've got several frontend servers running squid that are caching from the
</I>&gt;<i> backend systems.
</I>
Ok,

&gt;<i> 
</I>&gt;<i> i.e. test.com -&gt; 10.0.0.1, 10.0.1.1, 10.0.2.1 (all physically separated
</I>&gt;<i> from one another)
</I>&gt;<i> 
</I>
Ok,

&gt;<i> Each internal server also has its own dns name:
</I>&gt;<i> 
</I>&gt;<i> web1.test.com -&gt; 10.0.0.1
</I>&gt;<i> web2.test.com -&gt; 10.0.1.1
</I>&gt;<i> web3.test.com -&gt; 10.0.2.1
</I>&gt;<i> 
</I>&gt;<i> Note that these are all public. Using 10. as examples.
</I>
Ok, but dangerous. That allows the frontend to be bypassed whenever a
client wants. So you will need to ensure security to the backend stays
in sync with the frontend. If you don't have to, its best to avoid that
trouble and filter everything consistently through the frontend.

That also allows the backends to avoid public CAs like LetsEncrypt
entirely. You can use a single custom CA exclusively for the
frontend&lt;-&gt;backend traffic and have much better security settings on
those internal links since you no longer have to worry about random
visitors capabilities.

&gt;<i> 
</I>&gt;<i> I'd like to create a SAN certificate naming the 3 internal systems in
</I>&gt;<i> addition to the public name:
</I>&gt;<i> 
</I>&gt;<i> test.com, web1.test.com, web2.test.com, and web3.test.com.
</I>&gt;<i> 
</I>&gt;<i> On the letsencrypt forum they said that I could do a HTTP 301 redirect from
</I>&gt;<i> the squid servers to the backend letsencrypt server where any match for:
</I>&gt;<i>  /.well-known/acme-challenge/* would redirect with an HTTP 301 to that
</I>&gt;<i> backend letsencrypt server.  I'm not sure how to do this and the squid
</I>&gt;<i> documentation is not easy to comprehend.
</I>&gt;<i> 
</I>&gt;<i> Let me know if this isn't clear how I've explained this.
</I>&gt;<i> 
</I>
If LetsEncrypt are contacting web1 for example. They should be going to
the backend directly. Since <A HREF="http://web1.test.*">http://web1.test.*</A> is not a frontend request.

Whatever server is performing the LetsEncrypt for the frontend needs to
know its doing it for the generic domain as well as itself. Squid is not
a web server, so you need to nominate a backend to do that (could be a
new one just of LetsEncrypt stuff).

For example doing it on web1 would mean fitting these lines into your
existing config (this order, but not necesarily together like this):

 acl acme urlpath_regex ^/.well-known/acme-challenge
 cache_peer_access web1 allow acme
 cache_peer_access web2 deny acme
 cache_peer_access web3 deny acme

No &quot;redirect&quot; involved. Just tell Squid that server is where those URL
are handled.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011223.html">[squid-users] Squid question with letsencrypt
</A></li>
	<LI>Next message (by thread): <A HREF="011276.html">[squid-users] Squid question with letsencrypt
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11233">[ date ]</a>
              <a href="thread.html#11233">[ thread ]</a>
              <a href="subject.html#11233">[ subject ]</a>
              <a href="author.html#11233">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
