<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Skype Issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20Issues&In-Reply-To=%3Ca30b3e16-5209-8240-359a-0cf736fe129f%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011239.html">
   <LINK REL="Next"  HREF="011244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Skype Issues</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Skype%20Issues&In-Reply-To=%3Ca30b3e16-5209-8240-359a-0cf736fe129f%40gmail.com%3E"
       TITLE="[squid-users] Skype Issues">yvoinov at gmail.com
       </A><BR>
    <I>Sat Jun 25 16:32:18 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011239.html">[squid-users] Skype Issues
</A></li>
        <LI>Next message (by thread): <A HREF="011244.html">[squid-users] Skype Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11241">[ date ]</a>
              <a href="thread.html#11241">[ thread ]</a>
              <a href="subject.html#11241">[ subject ]</a>
              <a href="author.html#11241">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
Amos, you are a wrong.

No Squid-4. It's unstable and not ready for production. Whenever it's
features.

Some time ago I have the same issue and know what happens exactly.

Skype initial connection site uses RC4 cipher. Which is disabled in most
squid's configuration.

To make it works (as by as most M$ update sites) it's require simple use
this cipher's suite:

HIGH:MEDIUM:RC4:3DES:!aNULL:!eNULL:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS

That works for me in 5 SSL bumped setups. There is no matter which squid
version installed.


25.06.2016 20:22, Amos Jeffries &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> On 26/06/2016 1:19 a.m., Renato Jop wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i> I've configured squid to filter both HTTP and HTTPS traffic and for the
</I>&gt;&gt;<i> most part the squid server is working correctly, however, I am always
</I>&gt;&gt;<i> unable to login with skype.  Skype does send all the requests through the
</I>&gt;&gt;<i> suid server, but looking into the cache.log I always get a Error
</I>&gt;&gt;<i> negotiating SSL connection on FD 12: error:1408A0C1:SSL
</I>&gt;&gt;<i> routines:SSL3_GET_CLIENT_HELLO:no shared cipher.
</I>&gt;&gt;<i> If I run: openssl s_client -crlf -connect 157.55.56.164:443 I get exactly
</I>&gt;&gt;<i> the same error. However if I run: openssl s_client -crlf -connect
</I>&gt;&gt;<i> 157.55.56.164:443 -tls1_2 -ssl2 I am able to connect.
</I>&gt;&gt;<i> If I disable HTTPS, skype logins with no problems.
</I>&gt;&gt;<i> I've searched on the mailing list archive and found that other people
</I>have
&gt;&gt;<i> had the same issues but none have been able to fix them. Is this a known
</I>&gt;&gt;<i> issue with squid? Any help would be greatly appreciated.
</I>&gt;<i>
</I>&gt;<i> Yes its known. Well two problems are known with Skype...
</I>&gt;<i>
</I>&gt;<i> 1) Handling Skype cleanly through Squid with HTTPS interception (aka
</I>&gt;<i> SSL-Bump) currently requires features from Squid-4. Specifically the
</I>&gt;<i> on_unsupported_protocol feature to avoid having to bypass each IP
</I>&gt;<i> address your clients connect to manually (PITA) for the connections at
</I>&gt;<i> least some versions of it make that dont use TLS/SSL on port 443.
</I>&gt;<i>
</I>&gt;<i>  This does not seem to be your particular problem though. Maybe you will
</I>&gt;<i> hit it only after solving the &quot;no shared cipher&quot; problem.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2) Recently a few people have been finding the &quot;no shared cipher&quot; issue
</I>&gt;<i> appearing with other software or domains. Last sighting of it turned out
</I>&gt;<i> to be the new ChaCha and Poly1305 ciphers. Which required a migration to
</I>&gt;<i> LibreSSL since OpenSSL implementation was still finding bugs as recently
</I>&gt;<i> as March this year.
</I>&gt;<i>
</I>&gt;<i> But wait, theres more ...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> http_port 175.15.2.239:8080 ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=100MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;&gt;<i> capath=/usr/local/share/certs/
</I>&gt;&gt;<i>
</I>cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
&gt;&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 127.0.0.1:8080 intercept ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=100MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;&gt;<i> capath=/usr/local/share/certs/
</I>&gt;&gt;<i>
</I>cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
&gt;&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 127.0.0.1:3129 intercept ssl-bump
</I>generate-host-certificates=on
&gt;&gt;<i> dynamic_cert_mem_cache_size=100MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;&gt;<i> capath=/usr/local/share/certs/
</I>&gt;&gt;<i>
</I>cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
&gt;&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It is easy to think that the above enables a lot of ciphers.
</I>&gt;<i>
</I>&gt;<i> HOWEVER, most of them involve &quot;EC&quot; and that requires a curve to be
</I>&gt;<i> configured as well. You are using the dhparams= option instead of
</I>&gt;<i> tls-dh= option. Thus have not told Squid what Curve to use for any EC.
</I>&gt;<i> So most of those &quot;allowed&quot; ciphers are thus not working.
</I>&gt;<i>
</I>&gt;<i> Which means you effectively have configured only this:
</I>&gt;<i>
</I>&gt;<i>
</I>cipher=EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
&gt;<i>
</I>&gt;<i> I'm not sure right now how many ciphers &quot;HIGH&quot; enables with those
</I>&gt;<i> following rejections, but I'd bet its also not many.
</I>&gt;<i>
</I>&gt;<i> That limited number of ciphers on your side of the TLS handshake may be
</I>&gt;<i> at least a big part of what is leading to &quot;no shared cipher&quot; situation.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You have a few things that might help there. In the order you should try
</I>&gt;<i> them:
</I>&gt;<i>
</I>&gt;<i> * Using the tls-dh= option with a curve name. It might start working
</I>&gt;<i> with an EC cipher.
</I>&gt;<i>
</I>&gt;<i> * Using an updated library with ChaCha and Poly1305 ciphers. In case the
</I>&gt;<i> other end only wants one of those. This should not require a rebuild of
</I>&gt;<i> Squid, but it might.
</I>&gt;<i>
</I>&gt;<i> * An upgrade to Squid-4.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> sslproxy_capath /usr/local/share/certs/
</I>&gt;&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i> sslproxy_cipher
</I>&gt;&gt;<i>
</I>EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
&gt;<i>
</I>&gt;<i> Note: The outgoing connections might actually do the Elliptic Curves.
</I>&gt;<i> Since the server tells Squid what curve to use.
</I>&gt;<i>
</I>&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i>
</I>&gt;<i> Nasty. Anyone is allowed to hack your proxies outgoing connections and
</I>&gt;<i> do what they like to the TLS. You will ignore any security alerts or
</I>&gt;<i> errors TLS/SSL protocol uses to protect you.
</I>&gt;<i>
</I>&gt;<i> So, whats the point of extending the acceptable CA with sslproxy_capath
</I>&gt;<i> if you are going to ignore the verification results?
</I>&gt;<i>
</I>&gt;<i> Whats the point of TLS if anyone is allowed to break into the &quot;secure&quot;
</I>&gt;<i> connections?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJXbrIRAAoJENNXIZxhPexGirEH/AzlKxZRG7dBgzHTrFNwAJdS
kO4Q1a18TsFRQLgC7nYuA2BQVVY7ORBDFYJ0z++Jb+wWFqqXYCWBrfeH0XSjPCoQ
uTMJoKRBzIqb5ZXGs5/GlRvRvWBW2Q8wOPk9Ig4fPVJS9fMulXyaukemD+h8Nu1/
UUzoZKtEQxH6ICLVgkJWrQSWvJNWzOSQ6vS9GZYxW4Pu7qnjNiXhx+mDN+ZUH6tf
rCMKqBSIOOL1axf7Gt6wUn9ctu2Y9d/avYim5rsqRbJ4Th4P31QWhw3DOXKW/vDw
avhXgThQgq2PsHcijeSZEccJUdD4vNlgPWJIxVDkjj6Ypy8TX+4fChpnMlXKa3Y=
=Gvwa
-----END PGP SIGNATURE-----

-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160625/77e1535a/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160625/77e1535a/attachment.key</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011239.html">[squid-users] Skype Issues
</A></li>
	<LI>Next message (by thread): <A HREF="011244.html">[squid-users] Skype Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11241">[ date ]</a>
              <a href="thread.html#11241">[ thread ]</a>
              <a href="subject.html#11241">[ subject ]</a>
              <a href="author.html#11241">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
