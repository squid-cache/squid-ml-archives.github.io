<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt	for UDS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20Squid%203.5.19%20SMP%20under%20OpenBSD%20-%20setsockopt%0A%09for%20UDS&In-Reply-To=%3C5770EEF3.5060306%40coronamundi.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011275.html">
   <LINK REL="Next"  HREF="011259.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt	for UDS</H1>
    <B>Silamael</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20Squid%203.5.19%20SMP%20under%20OpenBSD%20-%20setsockopt%0A%09for%20UDS&In-Reply-To=%3C5770EEF3.5060306%40coronamundi.de%3E"
       TITLE="[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt	for UDS">Silamael at coronamundi.de
       </A><BR>
    <I>Mon Jun 27 09:16:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011275.html">[squid-users] Some websites doesn't work with squid anymore
</A></li>
        <LI>Next message (by thread): <A HREF="011259.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11256">[ date ]</a>
              <a href="thread.html#11256">[ thread ]</a>
              <a href="subject.html#11256">[ subject ]</a>
              <a href="author.html#11256">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm playing around with the SMP feature on OpenBSD 5.9 and noticed that
Squid does not run due to hard coded limits for the receive and send
buffer sizes of Unix Domain Sockets. In contrary to other OSes these
limits cannot be adjusted by a sysctl.
The attached patch adds some setsockopt() calls to comm.cc which sets
the buffer sizes to 256kb.

PS: Also i noticed that if squid is called with -z for creating the
cache directories, that ${process_number} macro is not expanded but
always set to 0. squid -z only creates one cache dir although in the
configuration
cache_dir ufs /var/squid/cache/cache-foo-${process_number} 700 8 16
is set.

Greetings,
Matthias
-------------- next part --------------
--- src/comm.cc.orig	Thu Jun 23 14:52:52 2016
+++ src/comm.cc	Thu Jun 23 14:54:34 2016
@@ -1937,6 +1937,20 @@ comm_open_uds(int sock_type,
     if (Config.tcpRcvBufsz &gt; 0 &amp;&amp; sock_type == SOCK_STREAM)
         commSetTcpRcvbuf(new_socket, Config.tcpRcvBufsz);
 
+#ifdef _SQUID_OPENBSD_
+    /* Set socket buffer size on Unix domain dgram sockets as OpenBSD defaults
+     * to 2k send and 4k recv buffer size
+     */
+    if (sock_type == SOCK_DGRAM) {
+	int size = 262144;
+	int error = 0;
+	if ((error = setsockopt(new_socket, SOL_SOCKET, SO_RCVBUF, &amp;size, sizeof(size))) &lt; 0)
+	    debugs(50, DBG_IMPORTANT, &quot;Error setting rcv buffer size to &quot; &lt;&lt; size &lt;&lt; &quot;: &quot; &lt;&lt; xstrerr(error));
+	if ((error = setsockopt(new_socket, SOL_SOCKET, SO_SNDBUF, &amp;size, sizeof(size))) &lt; 0)
+	    debugs(50, DBG_IMPORTANT, &quot;Error setting send buffer size to &quot; &lt;&lt; size &lt;&lt; &quot;: &quot; &lt;&lt; xstrerr(error));
+    }
+#endif
+
     PROF_stop(comm_open);
 
     return new_socket;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011275.html">[squid-users] Some websites doesn't work with squid anymore
</A></li>
	<LI>Next message (by thread): <A HREF="011259.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11256">[ date ]</a>
              <a href="thread.html#11256">[ thread ]</a>
              <a href="subject.html#11256">[ subject ]</a>
              <a href="author.html#11256">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
