<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20Squid%203.5.19%20SMP%20under%20OpenBSD%20-%0A%20setsockopt%20for%20UDS&In-Reply-To=%3C98490fa4-2a7e-e9a1-1b71-4995e7a6ac0b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011256.html">
   <LINK REL="Next"  HREF="011261.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20Squid%203.5.19%20SMP%20under%20OpenBSD%20-%0A%20setsockopt%20for%20UDS&In-Reply-To=%3C98490fa4-2a7e-e9a1-1b71-4995e7a6ac0b%40treenet.co.nz%3E"
       TITLE="[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jun 27 11:19:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011256.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt	for UDS
</A></li>
        <LI>Next message (by thread): <A HREF="011261.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11259">[ date ]</a>
              <a href="thread.html#11259">[ thread ]</a>
              <a href="subject.html#11259">[ subject ]</a>
              <a href="author.html#11259">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/06/2016 9:16 p.m., Silamael wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm playing around with the SMP feature on OpenBSD 5.9 and noticed that
</I>&gt;<i> Squid does not run due to hard coded limits for the receive and send
</I>&gt;<i> buffer sizes of Unix Domain Sockets. In contrary to other OSes these
</I>&gt;<i> limits cannot be adjusted by a sysctl.
</I>
Is that a new regression in 5.9?
Can you provide a reference please?

We have had Squid working just fine with SMP on OpenBSD before.


&gt;<i> The attached patch adds some setsockopt() calls to comm.cc which sets
</I>&gt;<i> the buffer sizes to 256kb.
</I>
Please submit patchs to the squid-dev mailing list.

Please also include an example of the errors that are visible to users
with your squid-dev submission so we can refer people complaining about
specific error messages to the appropriate fix.

And detail of where the 2K/4K limit you mention is located. So we can
verify if you are looking at the right limitation and what else it affects.
 AFAIK, the UDS limitations are about the size of objects which are used
over UDS sockets. Reading 256KB into a 4KB object does not have pretty
results. Likewise a blocking queue of up to 64 time-critical SMP actions
awaiting the first one getting its synchronous UDS response does not
have good side effects.

We no longer accept #ifdef construction in squid coding guidelines. Use
#if instead. If you can please also identify what other *BSD are needing
this and add them to the #if condition.
 Though if this is accepted the change may be relevant to all OS and not
needing a wrapper at all.


&gt;<i> 
</I>&gt;<i> PS: Also i noticed that if squid is called with -z for creating the
</I>&gt;<i> cache directories, that ${process_number} macro is not expanded but
</I>&gt;<i> always set to 0. squid -z only creates one cache dir although in the
</I>&gt;<i> configuration
</I>&gt;<i> cache_dir ufs /var/squid/cache/cache-foo-${process_number} 700 8 16
</I>&gt;<i> is set.
</I>
That sounds more like the behaviour of &quot;-N -z&quot;.

Just &quot;-z&quot; spawns the SMP workers and each worker generates its own cache
directories before exiting. That is needed in Squid-3 since only the
worker knows what its cache_dir expansions are.

Note that the master -z process may exit far faster than any of the
workers during a SMP aware -z execution since it has nothing to do. Your
script may not be waiting long enough for the cache dir creation to
happen in workers. YMMV, but I give -z at least 10 seconds to complete.

If a worker is still running when you start the normal Squid process
then UDS socket errors are almost guaranteed. Timing races mean it may
not happen reliably, but usually does.

Squid-4 has the --foreground command line option to avoid these problems.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011256.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt	for UDS
</A></li>
	<LI>Next message (by thread): <A HREF="011261.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11259">[ date ]</a>
              <a href="thread.html#11259">[ thread ]</a>
              <a href="subject.html#11259">[ subject ]</a>
              <a href="author.html#11259">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
