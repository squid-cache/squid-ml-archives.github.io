<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20Squid%203.5.19%20SMP%20under%20OpenBSD%20-%0A%20setsockopt%20for%20UDS&In-Reply-To=%3C86f17aa1-88a5-ba82-51c3-f46a8c7e39a1%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011261.html">
   <LINK REL="Next"  HREF="011262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BPATCH%5D%20Squid%203.5.19%20SMP%20under%20OpenBSD%20-%0A%20setsockopt%20for%20UDS&In-Reply-To=%3C86f17aa1-88a5-ba82-51c3-f46a8c7e39a1%40borrill.org.uk%3E"
       TITLE="[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS">squid at borrill.org.uk
       </A><BR>
    <I>Mon Jun 27 13:55:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011261.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
</A></li>
        <LI>Next message (by thread): <A HREF="011262.html">[squid-users] Cipher suites errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11266">[ date ]</a>
              <a href="thread.html#11266">[ thread ]</a>
              <a href="subject.html#11266">[ subject ]</a>
              <a href="author.html#11266">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/06/2016 12:35, Silamael wrote:
&gt;<i> On 27.06.2016 13:19, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 27/06/2016 9:16 p.m., Silamael wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm playing around with the SMP feature on OpenBSD 5.9 and noticed that
</I>&gt;&gt;&gt;<i> Squid does not run due to hard coded limits for the receive and send
</I>&gt;&gt;&gt;<i> buffer sizes of Unix Domain Sockets. In contrary to other OSes these
</I>&gt;&gt;&gt;<i> limits cannot be adjusted by a sysctl.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is that a new regression in 5.9?
</I>&gt;&gt;<i> Can you provide a reference please?
</I>&gt;<i> 
</I>&gt;<i> Haven't tested it with a prior version than 5.9.
</I>&gt;<i> But as the buffer limits haven't changed for a long time I don't think
</I>&gt;<i> that's a regression in 5.9.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We have had Squid working just fine with SMP on OpenBSD before.
</I>&gt;<i> 
</I>&gt;<i> That's interesting. Without the patch with no disk cache at all
</I>&gt;<i> configured and 4 workers, Squid seem to run a short time until the
</I>&gt;<i> children terminate due to a registration timeout.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The attached patch adds some setsockopt() calls to comm.cc which sets
</I>&gt;&gt;&gt;<i> the buffer sizes to 256kb.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please submit patchs to the squid-dev mailing list.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please also include an example of the errors that are visible to users
</I>&gt;&gt;<i> with your squid-dev submission so we can refer people complaining about
</I>&gt;&gt;<i> specific error messages to the appropriate fix.
</I>&gt;<i> 
</I>&gt;<i> The error I got was a write failed on the UDS socket. Error code was
</I>&gt;<i> EMSGSIZE. Squid tried to write 4320 bytes on the socket.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And detail of where the 2K/4K limit you mention is located. So we can
</I>&gt;&gt;<i> verify if you are looking at the right limitation and what else it affects.
</I>&gt;&gt;<i>  AFAIK, the UDS limitations are about the size of objects which are used
</I>&gt;&gt;<i> over UDS sockets. Reading 256KB into a 4KB object does not have pretty
</I>&gt;&gt;<i> results. Likewise a blocking queue of up to 64 time-critical SMP actions
</I>&gt;&gt;<i> awaiting the first one getting its synchronous UDS response does not
</I>&gt;&gt;<i> have good side effects.
</I>&gt;<i> 
</I>&gt;<i> The limits can be found in /usr/src/sys/kern/uipc_usrreq.c:
</I>&gt;<i> u_long unpdg_sendspace = 2*1024;
</I>&gt;<i> u_long unpdg_recvspace = 4*1024;
</I>&gt;<i> 
</I>&gt;<i> Quick check against OpenBSD 5.2 showed no difference.
</I>&gt;<i> The value of 256kb is just taken from the Squid SMP FAQ page.
</I>
Yes, namely:

Squid workers exchange Unix Domain Sockets (UDS) messages (not to be
confused with UDP messages or System V IPC messages). These messages
should be smaller than 16KB in size, but even that creates problems in
some environments because of very low default UDS message size and
buffer size limits.

Usually, the limits can be adjusted using sysctl but exact control names
are not documented and vary from one OS to another. Here is one known
variant with recommended minimum settings (please add more if you know
them!):


net.local.dgram.recvspace: 262144
net.local.dgram.maxdgram: 16384

&gt;&gt;<i> We no longer accept #ifdef construction in squid coding guidelines. Use
</I>&gt;&gt;<i> #if instead. If you can please also identify what other *BSD are needing
</I>&gt;&gt;<i> this and add them to the #if condition.
</I>&gt;&gt;<i>  Though if this is accepted the change may be relevant to all OS and not
</I>&gt;&gt;<i> needing a wrapper at all.
</I>&gt;<i> 
</I>&gt;<i> Ok, I can change the #ifdef into an #if. But I don't have other BSDs for
</I>&gt;<i> testing.
</I>
I can help you there :-)

&gt;<i>From NetBSD:
</I>FATAL: kid2 registration timed out
Squid Cache (Version 3.5.19): Terminated abnormally.
CPU Usage: 0.169 seconds = 0.074 user + 0.095 sys
Maximum Resident Size: 0 KB
Page faults with physical i/o: 55


/usr/src/sys/kern/uipc_usrreq.c is the same as OpenBSD:

/*
 * Both send and receive buffers are allocated PIPSIZ bytes of buffering
 * for stream sockets, although the total for sender and receiver is
 * actually only PIPSIZ.
 * Datagram sockets really use the sendspace as the maximum datagram size,
 * and don't really want to reserve the sendspace.  Their recvspace should
 * be large enough for at least one max-size datagram plus address.
 */
#define PIPSIZ  4096
u_long  unpst_sendspace = PIPSIZ;
u_long  unpst_recvspace = PIPSIZ;
u_long  unpdg_sendspace = 2*1024;       /* really max datagram size */
u_long  unpdg_recvspace = 4*1024;



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011261.html">[squid-users] [PATCH] Squid 3.5.19 SMP under OpenBSD - setsockopt for UDS
</A></li>
	<LI>Next message (by thread): <A HREF="011262.html">[squid-users] Cipher suites errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11266">[ date ]</a>
              <a href="thread.html#11266">[ thread ]</a>
              <a href="subject.html#11266">[ subject ]</a>
              <a href="author.html#11266">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
