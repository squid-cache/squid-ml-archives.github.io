<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Conditional IPv6 usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Conditional%20IPv6%20usage&In-Reply-To=%3C57726034.9070609%40hoelzle.work%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011227.html">
   <LINK REL="Next"  HREF="011313.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Conditional IPv6 usage</H1>
    <B>Stefan H&#246;lzle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Conditional%20IPv6%20usage&In-Reply-To=%3C57726034.9070609%40hoelzle.work%3E"
       TITLE="[squid-users] Conditional IPv6 usage">stefan at hoelzle.work
       </A><BR>
    <I>Tue Jun 28 11:32:04 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011227.html">[squid-users] Conditional IPv6 usage
</A></li>
        <LI>Next message (by thread): <A HREF="011313.html">[squid-users] Conditional IPv6 usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11300">[ date ]</a>
              <a href="thread.html#11300">[ thread ]</a>
              <a href="subject.html#11300">[ subject ]</a>
              <a href="author.html#11300">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I inserted an iptables rule which rejects outgoing tcp packets from the
default IPv4 address to the ip of somedomain.asdf.
This causes Squid to fall back to IPv6.

I'd like to change Squid's behavior in this case to immediately fall
back to IPv6 instead of falling back to the default IPv4 address first.
Can this behavior easily be changed in the source code ?

--
Best Regards
Stefan

On 25.06.2016 07:35, Amos Jeffries wrote:
&gt;<i> On 25/06/2016 6:27 a.m., Stefan H&#246;lzle wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm having trouble configuring a forward proxy.
</I>&gt;&gt;<i> My goal is the following:
</I>&gt;&gt;<i> Only for one destination domain IPv6 should be used, otherwise IPv4.
</I>&gt;<i> This is not how the Internet Protocol (IP) works. If a domain is
</I>&gt;<i> advertising IPv6 addresses, then it can and should be contacted using
</I>&gt;<i> those addresses.
</I>&gt;<i>
</I>&gt;&gt;<i> The proxy has multiple incoming IPs and multiple outgoing IPs, here is
</I>&gt;&gt;<i> the relevant part of the squid.conf:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl port80 localport 80
</I>&gt;&gt;<i> acl port88 localport 88
</I>&gt;&gt;<i> acl port443 localport 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 10.0.0.54:80
</I>&gt;&gt;<i> http_port 10.0.0.54:443
</I>&gt;&gt;<i> http_port 10.0.0.59:80
</I>&gt;&gt;<i> http_port 10.0.0.59:443
</I>&gt;&gt;<i> http_port 10.0.0.59:88
</I>&gt;<i> Problem #1: you are configuring a forward proxy on port 80 and 443 which
</I>&gt;<i> are registered ports for reverse-proxy traffic syntax.
</I>&gt;<i>
</I>&gt;<i> This is not necessarily a big problem. But other software in the
</I>&gt;<i> environment that handles port 80 and 443 traffic may interpret the
</I>&gt;<i> format wrongly and scew things up.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> acl ipA localip 10.0.0.54
</I>&gt;&gt;<i> acl ipB localip 10.0.0.59
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # only somedomain.asdf via IPv6
</I>&gt;&gt;<i> acl domain_acl dstdom_regex -i \.somedomain\.asdf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 10.0.0.93 ipB port88
</I>&gt;&gt;<i> tcp_outgoing_address 2001:cdba::3257:9652 ipB port88 domain_acl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 10.0.0.54 ipA port80
</I>&gt;&gt;<i> tcp_outgoing_address 10.0.0.63 ipA port443
</I>&gt;&gt;<i> tcp_outgoing_address 10.0.0.59 ipB port80
</I>&gt;&gt;<i> tcp_outgoing_address 10.0.0.93 ipB port443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> dns_v4_first on
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Expected behavior:
</I>&gt;&gt;<i> A connection on http_port 10.0.0.59:88 is requesting a domain matching
</I>&gt;&gt;<i> regex &quot;\.somedomain\.asdf&quot;, then the first matching tcp_outgoing_address
</I>&gt;&gt;<i> is used, namely
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 2001:cdba::3257:9652 ipB port88 domain_acl
</I>&gt;&gt;<i>
</I>&gt;<i> Expectation is a bit wrong.
</I>&gt;<i>
</I>&gt;<i> tcp_outgoing_address configures _which address to use the type of
</I>&gt;<i> traffic that server requires. The connection has already been allowed by
</I>&gt;<i> tha http_access rules - which do not distinguish whether IPv4 or IPv6 is
</I>&gt;<i> used to contact any particular server.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You literally cannot send traffic to an IPv6 addressed server using IPv4
</I>&gt;<i> packet format. Nor vice versa. Squid knows that and does not attempt to
</I>&gt;<i> use the wrong family of IP for any outgoing traffic.
</I>&gt;<i>
</I>&gt;<i> So:
</I>&gt;<i> - The server destination *has already been selected for use* by
</I>&gt;<i> determining in various *_access lists that the client is allowed to
</I>&gt;<i> contact that *domain*.
</I>&gt;<i>
</I>&gt;<i> - IPv6 entries are ignored for IPv4 server destinations.
</I>&gt;<i>
</I>&gt;<i> - IPv4 entries are ignored for IPv6 server destinations.
</I>&gt;<i>
</I>&gt;&gt;<i> Actual behavior:
</I>&gt;&gt;<i> A connection on http_port 10.0.0.59:88 is requesting a domain matching
</I>&gt;&gt;<i> regex &quot;\.somedomain\.net&quot; and
</I>&gt;&gt;<i>
</I>&gt;<i> Incoming port has nothing to do with outgoing IP format.
</I>&gt;<i>
</I>&gt;<i> * DNS tells Squid a set of IP addresses that the domain can be contacted at.
</I>&gt;<i>
</I>&gt;<i> ** &quot;dns_v4_first on&quot; tells Squid to use the servers A address(es) as
</I>&gt;<i> first choice before attempting IPv6 contact.
</I>&gt;<i>
</I>&gt;<i> That domain *does* have an A address. So...
</I>&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 10.0.1.54 ipA port80
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> is used.
</I>&gt;<i> If that fails it might fail over to another IPv4 or to the domains IPv6
</I>&gt;<i> address.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> If I change dns_v4_first from on to off,
</I>&gt;&gt;<i>
</I>&gt;<i> ** then &quot;dns_v4_first on&quot; tells Squid to use the servers AAAA address as
</I>&gt;<i> first choice before attempting IPv6 contact.
</I>&gt;<i>
</I>&gt;<i> ** That domain *does* have an AAAA address. So ...
</I>&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 2001:cdba::3257:9652 ipB port88 domain_acl
</I>&gt;&gt;<i>
</I>&gt;<i> ... or the machines default IPv6 addresss is used when contacting the
</I>&gt;<i> servers AAAA address(es).
</I>&gt;<i>
</I>&gt;<i> If that fails then Squid might failover to another of the servers IPv6
</I>&gt;<i> addresses, or to its IPv4 address.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You can choose a particular IP from amongst the appropriate v4/v6 types
</I>&gt;<i> available. But you cannot force a particular type to be used.
</I>&gt;<i>  (though you might configure an IPv4/IPv6 address which will force
</I>&gt;<i> breakage on the connection).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It is the network firewalls job to determine whether *Squid* is allowed
</I>&gt;<i> contact from IP A to IP B. If it blocks unwanted IPv6 traffic properly,
</I>&gt;<i> then the normal ICMPv6 packet that comes back from the firewall will
</I>&gt;<i> tell Squid to try the next IP on the list for the server being contacted.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011227.html">[squid-users] Conditional IPv6 usage
</A></li>
	<LI>Next message (by thread): <A HREF="011313.html">[squid-users] Conditional IPv6 usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11300">[ date ]</a>
              <a href="thread.html#11300">[ thread ]</a>
              <a href="subject.html#11300">[ subject ]</a>
              <a href="author.html#11300">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
