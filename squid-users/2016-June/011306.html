<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Strange NTLM problem.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20NTLM%20problem.&In-Reply-To=%3C17d8ae3a-9365-b8da-2311-eeabdda0f638%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011304.html">
   <LINK REL="Next"  HREF="011307.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Strange NTLM problem.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20NTLM%20problem.&In-Reply-To=%3C17d8ae3a-9365-b8da-2311-eeabdda0f638%40treenet.co.nz%3E"
       TITLE="[squid-users] Strange NTLM problem.">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 28 13:43:09 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011304.html">[squid-users] Strange NTLM problem.
</A></li>
        <LI>Next message (by thread): <A HREF="011307.html">[squid-users] Strange NTLM problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11306">[ date ]</a>
              <a href="thread.html#11306">[ thread ]</a>
              <a href="subject.html#11306">[ subject ]</a>
              <a href="author.html#11306">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/06/2016 12:45 a.m., Bruno de Paula Larini wrote:
&gt;<i> Em 28/06/2016 03:14, drcimino drcimino escreveu:
</I>&gt;&gt;<i> Dear all,
</I>&gt;&gt;<i> i have a strange problem with my squid 3.5.19 and authentication NTLM.
</I>&gt;&gt;<i> On my configuration i have 2 auth method:
</I>&gt;&gt;<i> NTLM negotiated with ntlm_auth from samba 3
</I>&gt;&gt;<i> auth_param ntlm program /usr/local/samba/bin/ntlm_auth
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;&gt;<i> auth_param ntlm children 200 startup=100 idle=10 concurrency=0
</I>&gt;&gt;<i> auth_param ntlm keep_alive on
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and as a fallback basic ntlm
</I>&gt;&gt;<i> auth_param basic program /usr/local/samba/bin/ntlm_auth
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;&gt;<i> auth_param basic children 25 startup=15 idle=5 concurrency=0
</I>&gt;&gt;<i> auth_param basic realm PROXY AUTHORIZATION REQUIRED
</I>&gt;&gt;<i> auth_param basic credentialsttl 30 minutes
</I>&gt;&gt;<i> TTL
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> authenticate_cache_garbage_interval 1 hours
</I>&gt;&gt;<i> authenticate_ttl 30 minutes
</I>&gt;&gt;<i> authenticate_ip_ttl 30 minutes
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Groups identification with LDAPS
</I>&gt;&gt;<i> external_acl_type NAV children-max=200 children-startup=100
</I>&gt;&gt;<i> children-idle=10 ttl=1800 %LOGIN
</I>&gt;&gt;<i> /usr/local/squid/libexec/ext_ldap_group_acl -s sub -b
</I>&gt;&gt;<i> &quot;dc=domain,dc=xxx&quot; -D &quot;cn=squid,cn=Users,dc
</I>&gt;&gt;<i> =domain,dc=xxx&quot; -w &quot;password&quot; -f
</I>&gt;&gt;<i> &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(membero
</I>&gt;&gt;<i> f=cn=%a,ou=INTERNET,ou=AAA,dc=domain,dc=xxx))&quot; -S -K -H
</I>&gt;&gt;<i> <A HREF="ldaps://domain.xxx:3269">ldaps://domain.xxx:3269</A>
</I>&gt;<i> 
</I>&gt;<i> I've been using the helper &quot;ext_wbinfo_group_acl&quot; to work with AD groups
</I>&gt;<i> and transparent authentication for domain members. The config below also
</I>&gt;<i> makes the auth pop-up to show when the machine isn't member of the
</I>&gt;<i> domain - no need to use the fallback part. You just have to configure
</I>&gt;<i> Kerberos, Samba, join the Squid machine to the domain with &quot;net ads
</I>&gt;<i> join&quot; and enable winbind.
</I>
You are not using Negotiate/Kerberos, so I'm not sure why that is related.

Winbind is needed for the particular wbinfo helper. Note that winbind
has much more several issues with concurrent number of connections to AD
being only 256.


&gt;<i> 
</I>&gt;<i>     auth_param ntlm program /usr/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=MYDOMAIN
</I>&gt;<i> --enable-external-acl-helpers=&quot;ext_wbinfo_group_acl&quot;
</I>&gt;<i>     auth_param ntlm children 10 startup=0 idle=2
</I>&gt;<i> 
</I>&gt;<i>     external_acl_type NTGroup children-startup=10 children-idle=2
</I>&gt;<i> children-max=50 %LOGIN /usr/lib64/squid/ext_wbinfo_group_acl
</I>&gt;<i> 
</I>&gt;<i>     acl authenticated proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i>     acl ad_group external NTGroup MYDOMAIN\AD_Group
</I>&gt;<i>     acl denied_websites dstdom_regex -i &quot;/etc/squid/denied-websites.txt&quot;
</I>&gt;<i>     http_access deny ad_group denied_websites
</I>&gt;<i> 
</I>&gt;<i> In my set of acls, the pop-up was also appearing in specific sites.
</I>&gt;<i> Changing the order of acls made it stop appearing for me.
</I>&gt;<i> This:
</I>&gt;<i> 
</I>&gt;<i>     http_access allow website_list user_list
</I>&gt;<i> 
</I>&gt;<i> seems to work differently from this:
</I>&gt;<i> 
</I>&gt;<i>     http_access allow user_list website_list
</I>&gt;<i> 
</I>
Not seem to. It does. Intentionally.
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/OrderIsImportant">http://wiki.squid-cache.org/SquidFaq/OrderIsImportant</A>&gt;

Having something like website_list, which I guess is a dstdomain or such
ACL at the end of the line prevents auth or group test mis-matches from
re-authenticating to get credentials that might pass the ACL test.

Preventing these ACLs triggering authentication activity is probably a
large part of what actually got fixed in your situation. NTLM related
auth takes a relatively long time so reducing the number of auth and
re-auth tests needed to check a users access permissions can be a big win.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011304.html">[squid-users] Strange NTLM problem.
</A></li>
	<LI>Next message (by thread): <A HREF="011307.html">[squid-users] Strange NTLM problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11306">[ date ]</a>
              <a href="thread.html#11306">[ thread ]</a>
              <a href="subject.html#11306">[ subject ]</a>
              <a href="author.html#11306">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
