<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Strange NTLM problem.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20NTLM%20problem.&In-Reply-To=%3Cb28f3b80-d73c-3f5d-e43a-9fa1a4395791%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011306.html">
   <LINK REL="Next"  HREF="011293.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Strange NTLM problem.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20NTLM%20problem.&In-Reply-To=%3Cb28f3b80-d73c-3f5d-e43a-9fa1a4395791%40treenet.co.nz%3E"
       TITLE="[squid-users] Strange NTLM problem.">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 28 13:45:56 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011306.html">[squid-users] Strange NTLM problem.
</A></li>
        <LI>Next message (by thread): <A HREF="011293.html">[squid-users] squid with HTTPS and some APPs not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11307">[ date ]</a>
              <a href="thread.html#11307">[ thread ]</a>
              <a href="subject.html#11307">[ subject ]</a>
              <a href="author.html#11307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/06/2016 6:14 p.m., drcimino drcimino wrote:
&gt;<i> Dear all,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> i have a strange problem with my squid 3.5.19 and authentication NTLM.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On my configuration i have 2 auth method:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> NTLM negotiated with ntlm_auth from samba 3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/local/samba/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm children 200 startup=100 idle=10 concurrency=0
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm keep_alive on
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> and as a fallback basic ntlm
</I>&gt;<i> 
</I>
Just to be clear. There is no such thing as &quot;basic ntlm&quot;.

What you have configured is Basic authentication (user:password in the
clear over the network.
It just happens that the Samba helper is called &quot;ntlm_auth&quot;. That name
does not make it NTLM protocol in any way.

&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/local/samba/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;<i> 
</I>&gt;<i> auth_param basic children 25 startup=15 idle=5 concurrency=0
</I>&gt;<i> 
</I>&gt;<i> auth_param basic realm PROXY AUTHORIZATION REQUIRED
</I>&gt;<i> 
</I>&gt;<i> auth_param basic credentialsttl 30 minutes
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> TTL
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> authenticate_cache_garbage_interval 1 hours
</I>&gt;<i> 
</I>&gt;<i> authenticate_ttl 30 minutes
</I>&gt;<i> 
</I>&gt;<i> authenticate_ip_ttl 30 minutes
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Groups identification with LDAPS
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> external_acl_type NAV children-max=200 children-startup=100 children-idle=10
</I>&gt;<i> ttl=1800 %LOGIN
</I>&gt;<i> 
</I>&gt;<i> /usr/local/squid/libexec/ext_ldap_group_acl -s sub -b &quot;dc=domain,dc=xxx&quot; -D
</I>&gt;<i> &quot;cn=squid,cn=Users,dc
</I>&gt;<i> 
</I>&gt;<i> =domain,dc=xxx&quot; -w &quot;password&quot; -f
</I>&gt;<i> &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(membero
</I>&gt;<i> 
</I>&gt;<i> f=cn=%a,ou=INTERNET,ou=AAA,dc=domain,dc=xxx))&quot; -S -K -H
</I>&gt;<i> <A HREF="ldaps://domain.xxx:3269">ldaps://domain.xxx:3269</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &nbsp;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ... and all work very well.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Sometimes and randomly, my users reported to me that squid cannot do ntlm
</I>&gt;<i> transparent authentication and request for user/password pair (falling back
</I>&gt;<i> to ntlm basic).
</I>
No. It is falling back *past* the Basic authentication to user input.


&gt;<i> Entering right credential does not work and to proceed further&nbsp; users
</I>&gt;<i> need to click on &quot;abort&quot; button many times.
</I>&gt;<i> 
</I>
One popup for each connection which the browser has opened and not been
able to authenticate.

NTLM is both slow and has a limited number of connections that it can
make to AD simultaneously for authentication. All those popups for one
user, multiplied by the number of users currently doing authentication
across the whole time period that NTLM handshakes take up and its easy
to get very large numbers of concurrent authentication actions.
 And when the system gets bogged down, users start to feel the impact
either in longer latency or outright ejected logins.


&gt;<i> 
</I>&gt;<i> On my cache.log i see:
</I>&gt;<i> 
</I>&gt;<i> Login for user [DOMAIN]\[userx]@[PC_XXX] failed due to [Access denied]
</I>&gt;<i> 
</I>&gt;<i> NTLMSSP BH: NT_STATUS_ACCESS_DENIED
</I>&gt;<i> 
</I>&gt;<i> 2016/06/27 22:59:06 kid1| ERROR: NTLM Authentication validating user.
</I>&gt;<i> Result: {result=BH, notes={mes
</I>&gt;<i> 
</I>&gt;<i> sage: NT_STATUS_ACCESS_DENIED; }}
</I>
Means the credentials were not correct like you said. It can be tricky
since the browser does not give much in the way of hints about which
auth protocol the popup details will be used in. You could need to enter
the Basic user + password, or Basic DOMAIN\user + password, or NTLM user
+ password, or NTLM DOMAIN\user + password, or NTLM MACHINE\user + password.
 About the only thing that you can use to provide any hints which one is
needed is the &quot;realm&quot; string Squid provides for each auth type.

&gt;<i> 
</I>&gt;<i> every times a user receive credential request.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> After aborting each requests squid do, users can surf the internet without
</I>&gt;<i> problems and i cannot replicate the issue.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Trying to close the browser, clear cache, and going to the same site does
</I>&gt;<i> not produce same error.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Stopping squid, remove cache, starting squid does not produce same error.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It's totally random and i'm going mad to understand why.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Can someone help me to debug and understand the problem?
</I>&gt;<i> 
</I>
You will likely need to enable debugging on the helper to see what it
has to say about the rejection.


Bruno already mentioned Kerberos. I second that. Kerberos can be a bit
of a learning curve, but is worth it for the extra speed and security
gained.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011306.html">[squid-users] Strange NTLM problem.
</A></li>
	<LI>Next message (by thread): <A HREF="011293.html">[squid-users] squid with HTTPS and some APPs not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11307">[ date ]</a>
              <a href="thread.html#11307">[ thread ]</a>
              <a href="subject.html#11307">[ subject ]</a>
              <a href="author.html#11307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
