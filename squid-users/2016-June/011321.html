<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Running squid on a machine with only one network interface.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Running%20squid%20on%20a%20machine%20with%20only%20one%20network%0A%20interface.&In-Reply-To=%3Ce339451b-1310-a689-7f75-b69c6fc5afff%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011309.html">
   <LINK REL="Next"  HREF="011292.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Running squid on a machine with only one network interface.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Running%20squid%20on%20a%20machine%20with%20only%20one%20network%0A%20interface.&In-Reply-To=%3Ce339451b-1310-a689-7f75-b69c6fc5afff%40treenet.co.nz%3E"
       TITLE="[squid-users] Running squid on a machine with only one network interface.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jun 29 01:02:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011309.html">[squid-users] Running squid on a machine with only one network	interface.
</A></li>
        <LI>Next message (by thread): <A HREF="011292.html">[squid-users] Strange NTLM problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11321">[ date ]</a>
              <a href="thread.html#11321">[ thread ]</a>
              <a href="subject.html#11321">[ subject ]</a>
              <a href="author.html#11321">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/06/2016 1:49 a.m., Ataro wrote:
&gt;<i> Hi and thanks for your help.
</I>&gt;<i> 
</I>&gt;<i> as for your request, here's the content of my IPFW rules and my squid configuration:
</I>&gt;<i> 
</I>&gt;<i> IPFW rules:
</I>&gt;<i> 
</I>&gt;<i> ipfw -f flush
</I>&gt;<i> ipfw add 50 pass all from any to any via lo0
</I>&gt;<i> ipfw add 100 pass all from any to any proto udp
</I>&gt;<i> ipfw add 150 pass icmp from any to any
</I>&gt;<i> ipfw add 200 fwd 127.0.0.1,3128 tag 1111 tcp from me to any
</I>&gt;<i> ipfw add 250 pass all from 10.0.2.15 to any tagged 1111
</I>&gt;<i> 
</I>
You said earlier there was a VM running Squid.

Do not use localhost IP addresses for any of this. Use the globally
routable IP assigned to the VM.

Do not tag the traffic in IPFW. Squid uses tcp_outgoing_tos or *_mark
directives to tag its outgoing the traffic. The firewall just uses those
tags for tags exceptions.



&gt;<i> squid.conf:
</I>&gt;<i> 
</I>&gt;<i> acl my_machine src 10.0.2.15 # this is the ip of my machine.
</I>
So what?..

&gt;<i> http_access allow my_machine
</I>&gt;<i> 
</I>
... Ah. Open proxy!

And since this is in 10.*/8 the localnet ACL will also allow the traffic
through, but after some basic safety checks.

Which means the above ACL and rule are not useful.


&gt;<i> acl localnet src 10.0.0.0/8 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7 # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10 # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i> 
</I>&lt;snip ...&gt;
&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> visible_hostname mynet.mydomain
</I>&gt;<i> acl MYSITE dstdomain cnn.com
</I>

Matches <A HREF="http://cnn.com/*">http://cnn.com/*</A> URLs.

I'm pointing that out to highlight that it wont match sub-domains like
www.cnn.com etc.

&gt;<i> acl MYSITE dstdomain 10.0.2.15
</I>
Matches <A HREF="http://10.0.2.15/*">http://10.0.2.15/*</A> URLs.

&gt;<i> http_access allow MYSITE
</I>&gt;<i> 
</I>
The MYSITE stuff is also not needed since traffic comes from a 10.*
machine. The &quot;allow localnet&quot; line right below will let that traffic
through, and much more.

&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 127.0.0.1:3128 intercept
</I>&gt;<i> http_port 3129
</I>
Replace that with:
  http_port 3129 intercept
  http_port 3128

Why? 3128 is a well known port for proxy traffic. It can be very
dangerous to use a known port for intercept. There are also some changes
coming in future Squid that will prevent the registered ports being used
for special modes like intercept.


Notice that after the above changes that the only thing different from
the default squid.conf is your new &quot;intercept&quot; port line.

&gt;<i> 
</I>&gt;<i> I'm almost surely that the problem is that as other people said here, the firewall redirect the traffic originated from the squid server back to squid and hence the forwarding loop.
</I>&gt;<i> 
</I>&gt;<i> I've tried to allow the traffic originated from the squid server by using the &quot;tag/tagged&quot; feature in the IPFW rules but this doesn't work, apparently because squid issue a new connection that is not tagged.
</I>
Yes.

&gt;<i> since squid and the firewall resides on the same machine I've no idea how to tell the firewall to allow the traffic which squid initiate.
</I>
You spoke earlier about Squid being inside a VM. In the above sentence
do you mean &quot;same machine&quot; as in hardware machine, or both are in the VM
? there is an important difference, and for this setup to work you need
to treat them as if they were different hardware communicating via
TCP/IP over a LAN.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011309.html">[squid-users] Running squid on a machine with only one network	interface.
</A></li>
	<LI>Next message (by thread): <A HREF="011292.html">[squid-users] Strange NTLM problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11321">[ date ]</a>
              <a href="thread.html#11321">[ thread ]</a>
              <a href="subject.html#11321">[ subject ]</a>
              <a href="author.html#11321">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
