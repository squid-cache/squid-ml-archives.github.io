<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cafile and capath not working as expected with SSL	bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cafile%20and%20capath%20not%20working%20as%20expected%20with%20SSL%0A%09bump&In-Reply-To=%3CCAHaxnUKy2W2Q%3D3cmou%3DuPgo8sQapaMTkPvsPjswHMoMcFS-a9Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011351.html">
   <LINK REL="Next"  HREF="011330.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cafile and capath not working as expected with SSL	bump</H1>
    <B>Bruce Rosenberg</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cafile%20and%20capath%20not%20working%20as%20expected%20with%20SSL%0A%09bump&In-Reply-To=%3CCAHaxnUKy2W2Q%3D3cmou%3DuPgo8sQapaMTkPvsPjswHMoMcFS-a9Q%40mail.gmail.com%3E"
       TITLE="[squid-users] cafile and capath not working as expected with SSL	bump">bruce.rosenberg.au at gmail.com
       </A><BR>
    <I>Wed Jun 29 10:01:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011351.html">[squid-users] Subject: Bandwidth Ceiling
</A></li>
        <LI>Next message (by thread): <A HREF="011330.html">[squid-users] cafile and capath not working as expected with SSL bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11328">[ date ]</a>
              <a href="thread.html#11328">[ thread ]</a>
              <a href="subject.html#11328">[ subject ]</a>
              <a href="author.html#11328">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm using squid 3.5.19 on RHEL6 and have configured SSL bump, which for the
most part is working great.
The issue I have is I need to install some additional CA certs that are not
provided by the ca-certificates-2015 RPM in the /etc/pki/tls/cert.pem file
(symlinked to /etc/pki/tls/certs/ca-bundle.crt).
I've tried adding both the cafile and capath options to the http_port entry
but neither seems to have any affect.
With the cafile option I can see squid open the file via an strace but when
I connect to the server it fails with a 503 as the SSL session to the
remote side is failing to verify.
With the capath option, strace shows that squid never attempts to open any
files in that directory.
Dynamic certificate generation between squid and the client is working fine
however.


cafile strace (strace -fp &lt;squid_pid&gt; -e trace=open):

[pid 27532] open(&quot;/var/lib/ssl_db/index.txt&quot;, O_RDWR) = 3
[pid 27532] open(&quot;/var/lib/ssl_db/index.txt&quot;, O_RDONLY) = 4
[pid 27532] open(&quot;/etc/localtime&quot;, O_RDONLY) = 4
[pid 27532]
open(&quot;/var/lib/ssl_db/certs/3EA5A8686DE52F6FBED1CD16F119603FF223563F.pem&quot;,
O_RDONLY) = 4
[pid 27532]
open(&quot;/var/lib/ssl_db/certs/3EA5A8686DE52F6FBED1CD16F119603FF223563F.pem&quot;,
O_RDONLY) = 4
[pid 27528] open(&quot;/etc/squid/ssl/cafile.pem&quot;, O_RDONLY) = 13
[pid 27528] open(&quot;/etc/pki/tls/cert.pem&quot;, O_RDONLY) = 13
[pid 27532] open(&quot;/var/lib/ssl_db/index.txt&quot;, O_RDWR) = 3
[pid 27532] open(&quot;/var/lib/ssl_db/index.txt&quot;, O_RDONLY) = 4
[pid 27532]
open(&quot;/var/lib/ssl_db/certs/666F7FE36508EC9B6E154D4FA0AE36DAFE9AC520.pem&quot;,
O_RDONLY) = 4
[pid 27532]
open(&quot;/var/lib/ssl_db/certs/666F7FE36508EC9B6E154D4FA0AE36DAFE9AC520.pem&quot;,
O_RDONLY) = 4
[pid 27528] open(&quot;/etc/squid/ssl/cafile.pem&quot;, O_RDONLY) = 13
[pid 27528] open(&quot;/etc/pki/tls/cert.pem&quot;, O_RDONLY) = 13
[pid 27528] open(&quot;/etc/squid/ssl/cafile.pem&quot;, O_RDONLY) = 13
[pid 27528] open(&quot;/etc/pki/tls/cert.pem&quot;, O_RDONLY) = 13


Subsequent error in the access log:

[29/Jun/2016:18:46:30 +1000] 198.142.126.173 TAG_NONE:HIER_DIRECT/200
&quot;CONNECT www.example.com:443 HTTP/1.1&quot; - www.example.com 130 0 - 14
[29/Jun/2016:18:46:30 +1000] 198.142.126.173 TAG_NONE:HIER_NONE/503 &quot;GET
<A HREF="https://www.example.com/postorders/postorders.php">https://www.example.com/postorders/postorders.php</A> HTTP/1.1&quot; - - 249 4699 - -


Relevant config:

sslproxy_options NO_SSLv2
sslproxy_cert_sign signTrusted
sslproxy_cert_sign_hash sha1
sslcrtd_children 8 startup=1 idle=1

acl step1 at_step SslBump1
ssl_bump peek step1 sslbump_src
ssl_bump bump sslbump_dst sslbump_src

ssl_bump none all

#http_port 3128 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=8MB capath=/etc/squid/ssl/cacerts/
key=/etc/squid/ssl_cert/mitm_root_ca.key
 cert=/etc/squid/ssl_cert/mitm_root_ca.crt
http_port 3128 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=8MB cafile=/etc/squid/ssl/cafile.pem
key=/etc/squid/ssl_cert/mitm_root_ca.key
 cert=/etc/squid/ssl_cert/mitm_root_ca.crt


I can work around the issue by appending the additional CA certs to the
Redhat managed /etc/pki/tls/certs/ca-bundle.crt file but this is not ideal.

Are the cafile and capath options supposed to work like this i.e. do they
allow you to complement the OS supplied CA certs for remote site
verification or have I completely misread the documentation?

cafile= File containing additional CA certificates to
use when verifying client certificates. If unset
clientca will be used.

capath= Directory containing additional CA certificates
and CRL lists to use when verifying client certificates.

Many thanks and any help greatly appreciated,
Bruce
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160629/a7ed0b27/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160629/a7ed0b27/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011351.html">[squid-users] Subject: Bandwidth Ceiling
</A></li>
	<LI>Next message (by thread): <A HREF="011330.html">[squid-users] cafile and capath not working as expected with SSL bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11328">[ date ]</a>
              <a href="thread.html#11328">[ thread ]</a>
              <a href="subject.html#11328">[ subject ]</a>
              <a href="author.html#11328">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
