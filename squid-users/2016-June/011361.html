<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] large downloads got interrupted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20large%20downloads%20got%20interrupted&In-Reply-To=%3Cbad52c96-20d6-c538-4fde-8f7c5e9326e8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011332.html">
   <LINK REL="Next"  HREF="011301.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] large downloads got interrupted</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20large%20downloads%20got%20interrupted&In-Reply-To=%3Cbad52c96-20d6-c538-4fde-8f7c5e9326e8%40treenet.co.nz%3E"
       TITLE="[squid-users] large downloads got interrupted">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun 30 12:19:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="011332.html">[squid-users] large downloads got interrupted
</A></li>
        <LI>Next message (by thread): <A HREF="011301.html">[squid-users] Squid's cache management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11361">[ date ]</a>
              <a href="thread.html#11361">[ thread ]</a>
              <a href="subject.html#11361">[ subject ]</a>
              <a href="author.html#11361">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/06/2016 2:24 a.m., Eugene M. Zheganin wrote:
&gt;<i> Hi.
</I>&gt;<i> 
</I>&gt;<i> On 29.06.16 05:26, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 28/06/2016 8:46 p.m., Eugene M. Zheganin wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> recently I started to get the problem when large downloads via squid are
</I>&gt;&gt;&gt;<i> often interrupted. I tried to investigate it, but, to be honest, got
</I>&gt;&gt;&gt;<i> nowhere. However, I took two tcpdump captures, and it seems to me that
</I>&gt;&gt;&gt;<i> for some reason squid sends FIN to it's client and correctly closes the
</I>&gt;&gt;&gt;<i> connection (wget reports that connection is closed), and in the same
</I>&gt;&gt;&gt;<i> time for some reason it sends like tonns of RSTs towards the server. No
</I>&gt;&gt;&gt;<i> errors in logs are reported (at least on a  ALL,1 loglevel).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> It sounds like a timeout or such has happened inside Squid. We'd need to
</I>&gt;&gt;<i> see your squid.conf to see if that was it.
</I>&gt;<i> Well... it quite long, since it's at large production site. I guess you
</I>&gt;<i> don't need the acl and auth lines, so without them it's as follows
</I>&gt;<i> (nothing secret in them, just that they are really numerous):
</I>
Okay. I was kind of hoping you had set some of the timeouts to a
unusually low value. Since its all default, then I think its one of the
much more difficult bug related issues.

&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> The download I test this issue on is:
</I>&gt;<i> - a large iso file, 4G from Yandex mirror
</I>&gt;<i> - goes via plain http (so no sslBump)
</I>&gt;<i> - client is authenticated using basic authentication
</I>&gt;<i> - you can see a delay pools in squid.config, but this is just a
</I>&gt;<i> definition, no clients are assigned into it
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When connection is closed the client receives FIN sequence, and squid
</I>&gt;<i> sends a loooot of RSTs towards target server I'm downloading the file from.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What version are you using? there have been a few bugs found that can
</I>&gt;&gt;<i> cause unrelated connections to be closed early like this.
</I>&gt;<i> I noticed this problem on squid 3.5.11, but it's reproducible on 3.5.19
</I>&gt;<i> as well.
</I>&gt;<i> 
</I>&gt;&gt;<i> Screen dump of packet capture does not usually help. We usually only ask
</I>&gt;&gt;<i> for packet captures when one of the dev needs to personally analyse the
</I>&gt;&gt;<i> full traffic behaviour.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A cache.log trace at debug level 11,2 shows all the HTTP messages going
</I>&gt;&gt;<i> through in an easier format to read. There might be hints in there, but
</I>&gt;&gt;<i> if it is a timeout like I suspect probably not.
</I>&gt;<i> Well... do you need it already ? I should say that it will be way huge.
</I>&gt;<i> May be there's a way to grep only the interesting parts ?
</I>&gt;<i> 
</I>
Okay, I wasn't suggesting you post it here. Its likely to be too big for
that.

I would look for the messages about the large object, and its FD. Then,
for anthing about why it was closed by Squid. Not sure what tha would be
at this point though.
There are some scripts in the Squid sources scripts/ directory that
might help wade through the log. Or the grep tool.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="011332.html">[squid-users] large downloads got interrupted
</A></li>
	<LI>Next message (by thread): <A HREF="011301.html">[squid-users] Squid's cache management
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11361">[ date ]</a>
              <a href="thread.html#11361">[ thread ]</a>
              <a href="subject.html#11361">[ subject ]</a>
              <a href="author.html#11361">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
