<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Sudden but sustained high bandwidth usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sudden%20but%20sustained%20high%20bandwidth%20usage&In-Reply-To=%3C56D666D6.6070304%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009467.html">
   <LINK REL="Next"  HREF="009493.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Sudden but sustained high bandwidth usage</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sudden%20but%20sustained%20high%20bandwidth%20usage&In-Reply-To=%3C56D666D6.6070304%40treenet.co.nz%3E"
       TITLE="[squid-users] Sudden but sustained high bandwidth usage">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar  2 04:06:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009467.html">[squid-users] Sudden but sustained high bandwidth usage
</A></li>
        <LI>Next message (by thread): <A HREF="009493.html">[squid-users] Sudden but sustained high bandwidth usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9471">[ date ]</a>
              <a href="thread.html#9471">[ thread ]</a>
              <a href="subject.html#9471">[ subject ]</a>
              <a href="author.html#9471">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/03/2016 10:57 a.m., Heiler Bemerguy wrote:
&gt;<i> 
</I>&gt;<i> Hey guys.
</I>&gt;<i> 
</I>&gt;<i> For the third time, we got a sudden high bandwidth usage, almost saturating our 
</I>&gt;<i> link, and it won't stop until squid is restarted.
</I>&gt;<i> I'm totally SURE this inbound traffic comes from squid. It's like it's download 
</I>&gt;<i> stuff itself....
</I>&gt;<i> 
</I>
Yes, it probably is. Or something very close...

&gt;<i> 
</I>&gt;<i> Look that after squid was restarted near 10:45, the network usage drops 
</I>&gt;<i> immediately and won't increase as high as before anymore..
</I>&gt;<i> 
</I>&gt;<i> This pattern started to happen when I changed from ROCK+AUFS to ROCK+ROCK, squid 
</I>&gt;<i> 3.5.14 x64.
</I>
Please upgrade to 3.5.15 asap. Or better the latest snapshot if you have
trouble with the main release (a few more side effects have been fixed
this week).

&gt;<i> 
</I>&gt;<i> Here's the most important conf settings.. I appreciate all comments about it.
</I>&gt;<i> 
</I>&gt;<i> /acl windowsupdate dstdomain .ws.microsoft.com .windowsupdate.microsoft.com 
</I>&gt;<i> .update.microsoft.com .windowsupdate.com//
</I>&gt;<i> //http_access allow windowsupdate//
</I>&gt;<i> //range_offset_limit none windowsupdate//
</I>
I suspect you are hitting a case of clients aborting downloads of Win10
files early and Squid continuing to try to complete them.

The secret downloads the GWX application does of multi-GB files on a
per-machine basis have been quite a problem for several people over the
last few months.


&gt;<i> //cache_mem 4 GB//
</I>&gt;<i> //maximum_object_size_in_memory 5 MB//
</I>&gt;<i> //memory_replacement_policy heap GDSF//
</I>&gt;<i> //cache_replacement_policy heap LFUDA//
</I>&gt;<i> //maximum_object_size 10 GB//
</I>&gt;<i> //cpu_affinity_map process_numbers=1,2,3,4,5,6 cores=1,2,3,4,5,6//
</I>&gt;<i> /*/workers 2/**/
</I>&gt;<i> /**/cache_dir rock /cache2/rock1 90000 min-size=0 max-size=32768/**/
</I>&gt;<i> /**/cache_dir rock /cache/rock1 300000 min-size=32768 max-size=10737418240/*/
</I>&gt;<i> //store_dir_select_algorithm round-robin//
</I>
Don't force-configure this when you have min/max controlling which dir
are usable. Squid default should try to round-robin anyway, but it may
select a better best-fit action.

&gt;<i> //read_ahead_gap 4096 KB//
</I>&gt;<i> //client_request_buffer_max_size 2048 KB//
</I>

 !!! 2MB packets !??

Please have a read of
&lt;<A HREF="http://www.bufferbloat.net/projects/bloat/wiki/Introduction">http://www.bufferbloat.net/projects/bloat/wiki/Introduction</A>&gt;

Ths buffer only needs to store the maximum size of expected HTTP request
mime headers on a single request. That is ~64KB for Squid due to
hardcoded internal issues. Going far beyond that leads to trouble.

Having larger buffer for multipe requests can be a small help with
pipelining. BUT you have completely disabled that performance enhancing
feature of HTTP in your proxy (the *_persistent_connections off settings
below)



&gt;<i> //dns_v4_first on//
</I>&gt;<i> //ipcache_size 80000//
</I>&gt;<i> //fqdncache_size 40000//
</I>&gt;<i> //memory_pools on//
</I>&gt;<i> //memory_pools_limit 150 MB//
</I>&gt;<i> //reload_into_ims on//
</I>&gt;<i> //connect_retries 3//
</I>&gt;<i> //cache_swap_low 98//
</I>&gt;<i> //cache_swap_high 99//
</I>&gt;<i> //store_avg_object_size 92 KB//
</I>&gt;<i> //client_idle_pconn_timeout 30 seconds//
</I>&gt;<i> //client_persistent_connections off//
</I>&gt;<i> //server_persistent_connections off/
</I>&gt;<i> 
</I>&gt;<i> error.log right in this moment:
</I>
Ayayeye, you got many troubles.

&gt;<i> 08:55:29 kid1| local=10.1.10.9:3080 remote=10.107.0.71:54515 FD 3665 flags=1: 
</I>&gt;<i> read/write failure: (32) Broken pipe
</I>&gt;<i> 09:00:02 kid2| snmpHandleUdp: FD 55 recvfrom: (11) Resource temporarily unavailable
</I>&gt;<i> 09:00:02 kid1| snmpHandleUdp: FD 29 recvfrom: (11) Resource temporarily unavailable
</I>
Unresolved bug in Squid.

&gt;<i> 09:02:14 kid2| WARNING: Closing client connection due to lifetime timeout
</I>&gt;<i> 09:02:14 kid2| 
</I>&gt;<i> <A HREF="http://prod.video.msn.com/tenant/amp/entityid/BBq7uZY?blobrefkey=103&amp;$blob=1">http://prod.video.msn.com/tenant/amp/entityid/BBq7uZY?blobrefkey=103&amp;$blob=1</A>
</I>
That would be a single HTTP request+reply transaction that took more
than 24hrs (!?) to complete.


&gt;<i> 09:03:34 kid1| WARNING: HTTP: Invalid Response: Bad header encountered from 
</I>&gt;<i> <A HREF="http://sable.madmimi.com/view?id=24371.4971993.01561ff3">http://sable.madmimi.com/view?id=24371.4971993.01561ff3</A>
</I>&gt;<i> e8e7c09ac362ded25f80a76b AKA 
</I>&gt;<i> sable.madmimi.com/view?id=24371.4971993.01561ff3e8e7c09ac362ded25f80a76b
</I>
Okay. That server is being a bad HTTP citizen. This is just info to help
with the client complaints you will probably get about the 4xx/5xx
errors contacting that site through Squid. If you want to assist fixing
you can report the issue to its admin.


&gt;<i> 09:03:38 kid1| WARNING: Closing client connection due to lifetime timeout
</I>&gt;<i> 09:03:38 kid1| 
</I>&gt;<i> <A HREF="http://download.windowsupdate.com/d/msdownload/update/software/defu/2016/02/am_delta_patch_1.213.7305.0_59c57a">http://download.windowsupdate.com/d/msdownload/update/software/defu/2016/02/am_delta_patch_1.213.7305.0_59c57a</A>
</I>&gt;<i> caccbdfa7fa9dd5574f0a7ded60de11963.exe
</I>
Another 24hr one ?


&gt;<i> 09:04:15 kid1| WARNING: HTTP: Invalid Response: Bad header encountered from 
</I>&gt;<i> <A HREF="http://sable.madmimi.com/view?id=24371.4931972.b5133065">http://sable.madmimi.com/view?id=24371.4931972.b5133065</A>
</I>&gt;<i> c861d91790f59bf39ef1abf3 AKA 
</I>&gt;<i> sable.madmimi.com/view?id=24371.4931972.b5133065c861d91790f59bf39ef1abf3
</I>&gt;<i> 09:04:28 kid2| WARNING: Closing client connection due to lifetime timeout
</I>&gt;<i> 09:04:28 kid2| <A HREF="http://www.ingressocerto.com/facet-search.json?f=/p-data-Offset:2">http://www.ingressocerto.com/facet-search.json?f=/p-data-Offset:2</A>
</I>
Getting a lot of these long transactions.

&gt;<i> 09:04:42 kid2| Could not parse headers from on disk object
</I>
This innocent seeming message is related to the CVE-2016-2571 issue. It
is a sign that the vulnerability has happened in some past transaction.
Squid is handling this part of the fallout though, so whats happened
*right now* is okay.

&gt;<i> 09:05:02 kid1| snmpHandleUdp: FD 29 recvfrom: (11) Resource temporarily unavailable
</I>&gt;<i> 09:05:02 kid2| snmpHandleUdp: FD 55 recvfrom: (11) Resource temporarily unavailable
</I>&gt;<i> 09:05:02 kid1| snmpHandleUdp: FD 29 recvfrom: (11) Resource temporarily unavailable
</I>&gt;<i> 09:05:18 kid2| SECURITY ALERT: Missing hostname in URL '<A HREF="http://">http://</A>'. see access.log 
</I>&gt;<i> for details.
</I>
Should be self explanatory. Your proxy appears to be under attack.
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidLogs#Squid_Error_Messages">http://wiki.squid-cache.org/SquidFaq/SquidLogs#Squid_Error_Messages</A>&gt;

&lt;snip many repeats of earier problems&gt;
&gt;<i> 09:25:49 kid1| urlParse: URL too large (8231 bytes)
</I>&gt;<i> 09:27:24 kid1| urlParse: URL too large (8231 bytes)
</I>&gt;<i> 09:27:46 kid2| urlParse: URL too large (10742 bytes)
</I>
These should also be self-explanatory. They are also attack signatures
for certain types of buffer-overrun attacks.
Squid is coping, but you should really do something forceful to whack
the source of these requests over the head.

It might be related to the ALERT situation. For example a &quot;GET
<A HREF="http://...">http://...</A> HTTP/1.1&quot; where the ... is a 8-10 KB long &quot;domain name&quot;.


&lt;snip more repeats&gt;
&gt;<i> 09:50:28 kid1| Could not parse headers from on disk object
</I>&gt;<i> 09:50:28 kid1| varyEvaluateMatch: Oops. Not a Vary object on second attempt, 
</I>&gt;<i> '<A HREF="http://pix04.revsci.net/D08734/a1/0/3/0.js?DM_LOC=%3D">http://pix04.revsci.net/D08734/a1/0/3/0.js?DM_LOC=%3D</A>
</I>&gt;<i> http%3A%2F%2Fna.com%3FdlxInitiated%3Dtrue%26nada%3D%26naid%3D2015121611542932923036123812%26namp%3D' 
</I>&gt;<i> 'accept-encoding=&quot;gzip,%20deflate,%20sdch
</I>&gt;<i> &quot;'
</I>&gt;<i> 09:50:28 kid1| clientProcessHit: Vary object loop!
</I>
Probably a side effect of the other nasties going on. Though some people
do see this happening and it has open bug report(s), we are still trying
to get to the bottom of it.


&gt;<i> 09:50:46 kid1| helperHandleRead: unexpected reply on channel 0 from redirector 
</I>&gt;<i> #Hlpr301 'OK'
</I>&gt;<i> 09:50:46 kid1| helperHandleRead: unexpected reply on channel 0 from redirector 
</I>&gt;<i> #Hlpr301 'OK'
</I>
** URGENT PROBLEM: **

The redirector helper you are using is broken. It is presenting either
multiple-lines for each reply, or replies without being asked about any URL.
In both cases Squid will be given wrong instructions to re-write random
requests to some other URL for producing the reply.

This could be the root cause behind some of those weird long request
timeouts or aborted transaction issues. It will *definitely* result in
clients randomly being given wrong objects to their replies.


So, my advice:

 * fix the redirector. See what other issues / side effects of that
disappear.

 * if they remain track down what those SECURITY ALERT are about. Get
that fixed if you can.


I expect the high bandwith will reduce with those two above issues gone
and the WU settings altered.

You can also further improve things by looking into the too-long URL
issues if they remain.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009467.html">[squid-users] Sudden but sustained high bandwidth usage
</A></li>
	<LI>Next message (by thread): <A HREF="009493.html">[squid-users] Sudden but sustained high bandwidth usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9471">[ date ]</a>
              <a href="thread.html#9471">[ thread ]</a>
              <a href="subject.html#9471">[ subject ]</a>
              <a href="author.html#9471">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
