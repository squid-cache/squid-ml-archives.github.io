<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bizarrely slow, timing out DNS only via Squid :D
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bizarrely%20slow%2C%20timing%20out%20DNS%20only%20via%20Squid%20%3AD&In-Reply-To=%3C56D7EB41.502%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009501.html">
   <LINK REL="Next"  HREF="009518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bizarrely slow, timing out DNS only via Squid :D</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bizarrely%20slow%2C%20timing%20out%20DNS%20only%20via%20Squid%20%3AD&In-Reply-To=%3C56D7EB41.502%40ngtech.co.il%3E"
       TITLE="[squid-users] Bizarrely slow, timing out DNS only via Squid :D">eliezer at ngtech.co.il
       </A><BR>
    <I>Thu Mar  3 07:44:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009501.html">[squid-users] Bizarrely slow, timing out DNS only via Squid &#128534;
</A></li>
        <LI>Next message (by thread): <A HREF="009518.html">[squid-users] Bizarrely slow, timing out DNS only via Squid :D
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9503">[ date ]</a>
              <a href="thread.html#9503">[ thread ]</a>
              <a href="subject.html#9503">[ subject ]</a>
              <a href="author.html#9503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well what I can see is that there are couple queries ID and the issues are:
0x8528: timeout
0x69c2 - timeout

but I am pretty sure that the DNS server that the query is against is:
192.231.203.132:53

So the first thing is to findout what dns servers are defined inside 
squid.conf
if you don't have any then look at /etc/resolv.conf

You should have there a list of server that you should run the dig -x 
command against and see how every one of them responses.
 From squid point of view the issues are probably:
- network routing or firewall level issues(another middle machine or 
local settings)
- buggy or faulty or wrongly-configured dns server

The main reason that squid does the PTR lookup and other queries is 
since these are required.

If you want to start from the bottom and up you can try another thing:
use the dns_nameserver squid.conf option [ 
<A HREF="http://www.squid-cache.org/Doc/config/dns_nameservers/">http://www.squid-cache.org/Doc/config/dns_nameservers/</A> ] with the local 
dns that worked fast for dig and nslookup(192.231.203.3) and only this use.
It should be:
dns_nameservers 192.231.203.3

You can run couple trials against public dns services like 
opendns\google or any other that is mentioned at: 
<A HREF="http://pcsupport.about.com/od/tipstricks/a/free-public-dns-servers.htm">http://pcsupport.about.com/od/tipstricks/a/free-public-dns-servers.htm</A>

Also try to contact a http service with an ip such as 
ngtech.co.il|84.95.212.160 (which will be a good test against a server 
that has only ipv4 address).

If after all the above something is weird I would suggest you for a 
second to run the squid with default squid.conf(if you are using debian 
then you will need to remove couple &quot;#&quot; for the localnet acls).

You should know that there are cases which couple dns services just 
stops responding to dns queries which looks like what you see if it 
worked before.

Eliezer

On 03/03/2016 09:08, Dan Charlesworth wrote:
&gt;&gt;&gt;&gt;<i>On 03/03/2016 07:39, Dan Charlesworth wrote:
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;Right now we have 1 squid box (out of a lot), running 3.5.13, which does something like this for every request, taking about 10 seconds:
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.883 kid1| 78,3| dns_internal.cc(1794) idnsPTRLookup: idnsPTRLookup: buf is 43 bytes for 10.100.128.1, id = 0x733a
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.883 kid1| 78,3| dns_internal.cc(1745) idnsALookup: idnsALookup: buf is 29 bytes for httpbin.org, id = 0x8528
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.883 kid1| 78,3| dns_internal.cc(1683) idnsSendSlaveAAAAQuery: buf is 29 bytes for httpbin.org, id = 0x69c2
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1277) idnsRead: idnsRead: starting with FD 7
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1323) idnsRead: idnsRead: FD 7: received 93 bytes from 192.231.203.132:53
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1130) idnsGrokReply: idnsGrokReply: QID 0x733a, -3 answers
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1195) idnsGrokReply: idnsGrokReply: error Name Error: The domain name does not exist. (3)
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.884 kid1| 78,3| dns_internal.cc(1384) idnsCheckQueue: idnsCheckQueue: ID dns8 QID 0x8528: timeout
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.884 kid1| 78,3| dns_internal.cc(1384) idnsCheckQueue: idnsCheckQueue: ID dns0 QID 0x69c2: timeout
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.885 kid1| 78,3| dns_internal.cc(1277) idnsRead: idnsRead: starting with FD 7
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.885 kid1| 78,3| dns_internal.cc(1323) idnsRead: idnsRead: FD 7: received 110 bytes from 172.16.100.4:53
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.885 kid1| 78,3| dns_internal.cc(1130) idnsGrokReply: idnsGrokReply: QID 0x69c2, 0 answers
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.885 kid1| 78,3| dns_internal.cc(1384) idnsCheckQueue: idnsCheckQueue: ID dns8 QID 0x8528: timeout
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.886 kid1| 78,3| dns_internal.cc(1277) idnsRead: idnsRead: starting with FD 7
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.886 kid1| 78,3| dns_internal.cc(1323) idnsRead: idnsRead: FD 7: received 246 bytes from 172.16.100.5:53
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.886 kid1| 78,3| dns_internal.cc(1130) idnsGrokReply: idnsGrokReply: QID 0x8528, 1 answers
</I>&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009501.html">[squid-users] Bizarrely slow, timing out DNS only via Squid &#128534;
</A></li>
	<LI>Next message (by thread): <A HREF="009518.html">[squid-users] Bizarrely slow, timing out DNS only via Squid :D
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9503">[ date ]</a>
              <a href="thread.html#9503">[ thread ]</a>
              <a href="subject.html#9503">[ subject ]</a>
              <a href="author.html#9503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
