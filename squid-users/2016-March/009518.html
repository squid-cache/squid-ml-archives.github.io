<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bizarrely slow, timing out DNS only via Squid :D
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bizarrely%20slow%2C%20timing%20out%20DNS%20only%20via%20Squid%20%3AD&In-Reply-To=%3CCAN8nrKC-bxvuHMWYVgh6uB1pxB9tKjDqRw2Dm%3DyWbxvT3WRbyw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009503.html">
   <LINK REL="Next"  HREF="009519.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bizarrely slow, timing out DNS only via Squid :D</H1>
    <B>Dan Charlesworth</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bizarrely%20slow%2C%20timing%20out%20DNS%20only%20via%20Squid%20%3AD&In-Reply-To=%3CCAN8nrKC-bxvuHMWYVgh6uB1pxB9tKjDqRw2Dm%3DyWbxvT3WRbyw%40mail.gmail.com%3E"
       TITLE="[squid-users] Bizarrely slow, timing out DNS only via Squid :D">dan at getbusi.com
       </A><BR>
    <I>Thu Mar  3 22:42:11 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009503.html">[squid-users] Bizarrely slow, timing out DNS only via Squid :D
</A></li>
        <LI>Next message (by thread): <A HREF="009519.html">[squid-users] Bizarrely slow, timing out DNS only via Squid :D
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9518">[ date ]</a>
              <a href="thread.html#9518">[ thread ]</a>
              <a href="subject.html#9518">[ subject ]</a>
              <a href="author.html#9518">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your input Eliezer.

I've tested against various public DNS servers at this point so I'm ruling
out any DNS-server-side problems. The only time there's any timeouts or
slowness is when the request is going through squid. Doesn't seem to matter
which HTTP server I'm requesting, whether it returns multiple IPs or not.

Also worth noting that this company has about 30 other sites with mostly
identical network topologies and equipment where it's completely fine.


On 3 March 2016 at 18:44, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:

&gt;<i> Well what I can see is that there are couple queries ID and the issues are:
</I>&gt;<i> 0x8528: timeout
</I>&gt;<i> 0x69c2 - timeout
</I>&gt;<i>
</I>&gt;<i> but I am pretty sure that the DNS server that the query is against is:
</I>&gt;<i> 192.231.203.132:53
</I>&gt;<i>
</I>&gt;<i> So the first thing is to findout what dns servers are defined inside
</I>&gt;<i> squid.conf
</I>&gt;<i> if you don't have any then look at /etc/resolv.conf
</I>&gt;<i>
</I>&gt;<i> You should have there a list of server that you should run the dig -x
</I>&gt;<i> command against and see how every one of them responses.
</I>&gt;<i> From squid point of view the issues are probably:
</I>&gt;<i> - network routing or firewall level issues(another middle machine or local
</I>&gt;<i> settings)
</I>&gt;<i> - buggy or faulty or wrongly-configured dns server
</I>&gt;<i>
</I>&gt;<i> The main reason that squid does the PTR lookup and other queries is since
</I>&gt;<i> these are required.
</I>&gt;<i>
</I>&gt;<i> If you want to start from the bottom and up you can try another thing:
</I>&gt;<i> use the dns_nameserver squid.conf option [
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/dns_nameservers/">http://www.squid-cache.org/Doc/config/dns_nameservers/</A> ] with the local
</I>&gt;<i> dns that worked fast for dig and nslookup(192.231.203.3) and only this use.
</I>&gt;<i> It should be:
</I>&gt;<i> dns_nameservers 192.231.203.3
</I>&gt;<i>
</I>&gt;<i> You can run couple trials against public dns services like opendns\google
</I>&gt;<i> or any other that is mentioned at:
</I>&gt;<i> <A HREF="http://pcsupport.about.com/od/tipstricks/a/free-public-dns-servers.htm">http://pcsupport.about.com/od/tipstricks/a/free-public-dns-servers.htm</A>
</I>&gt;<i>
</I>&gt;<i> Also try to contact a http service with an ip such as ngtech.co.il|
</I>&gt;<i> 84.95.212.160 (which will be a good test against a server that has only
</I>&gt;<i> ipv4 address).
</I>&gt;<i>
</I>&gt;<i> If after all the above something is weird I would suggest you for a second
</I>&gt;<i> to run the squid with default squid.conf(if you are using debian then you
</I>&gt;<i> will need to remove couple &quot;#&quot; for the localnet acls).
</I>&gt;<i>
</I>&gt;<i> You should know that there are cases which couple dns services just stops
</I>&gt;<i> responding to dns queries which looks like what you see if it worked before.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> On 03/03/2016 09:08, Dan Charlesworth wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 03/03/2016 07:39, Dan Charlesworth wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;Right now we have 1 squid box (out of a lot), running 3.5.13, which
</I>&gt;&gt;&gt;<i> does something like this for every request, taking about 10 seconds:
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.883 kid1| 78,3| dns_internal.cc(1794)
</I>&gt;&gt;&gt;<i> idnsPTRLookup: idnsPTRLookup: buf is 43 bytes for 10.100.128.1, id = 0x733a
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.883 kid1| 78,3| dns_internal.cc(1745)
</I>&gt;&gt;&gt;<i> idnsALookup: idnsALookup: buf is 29 bytes for httpbin.org, id = 0x8528
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.883 kid1| 78,3| dns_internal.cc(1683)
</I>&gt;&gt;&gt;<i> idnsSendSlaveAAAAQuery: buf is 29 bytes for httpbin.org, id = 0x69c2
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1277) idnsRead:
</I>&gt;&gt;&gt;<i> idnsRead: starting with FD 7
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1323) idnsRead:
</I>&gt;&gt;&gt;<i> idnsRead: FD 7: received 93 bytes from 192.231.203.132:53
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1130)
</I>&gt;&gt;&gt;<i> idnsGrokReply: idnsGrokReply: QID 0x733a, -3 answers
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:48.884 kid1| 78,3| dns_internal.cc(1195)
</I>&gt;&gt;&gt;<i> idnsGrokReply: idnsGrokReply: error Name Error: The domain name does not
</I>&gt;&gt;&gt;<i> exist. (3)
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.884 kid1| 78,3| dns_internal.cc(1384)
</I>&gt;&gt;&gt;<i> idnsCheckQueue: idnsCheckQueue: ID dns8 QID 0x8528: timeout
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.884 kid1| 78,3| dns_internal.cc(1384)
</I>&gt;&gt;&gt;<i> idnsCheckQueue: idnsCheckQueue: ID dns0 QID 0x69c2: timeout
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.885 kid1| 78,3| dns_internal.cc(1277) idnsRead:
</I>&gt;&gt;&gt;<i> idnsRead: starting with FD 7
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.885 kid1| 78,3| dns_internal.cc(1323) idnsRead:
</I>&gt;&gt;&gt;<i> idnsRead: FD 7: received 110 bytes from 172.16.100.4:53
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:53.885 kid1| 78,3| dns_internal.cc(1130)
</I>&gt;&gt;&gt;<i> idnsGrokReply: idnsGrokReply: QID 0x69c2, 0 answers
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.885 kid1| 78,3| dns_internal.cc(1384)
</I>&gt;&gt;&gt;<i> idnsCheckQueue: idnsCheckQueue: ID dns8 QID 0x8528: timeout
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.886 kid1| 78,3| dns_internal.cc(1277) idnsRead:
</I>&gt;&gt;&gt;<i> idnsRead: starting with FD 7
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.886 kid1| 78,3| dns_internal.cc(1323) idnsRead:
</I>&gt;&gt;&gt;<i> idnsRead: FD 7: received 246 bytes from 172.16.100.5:53
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;2016/03/03 16:30:58.886 kid1| 78,3| dns_internal.cc(1130)
</I>&gt;&gt;&gt;<i> idnsGrokReply: idnsGrokReply: QID 0x8528, 1 answers
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160304/9516bd33/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160304/9516bd33/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009503.html">[squid-users] Bizarrely slow, timing out DNS only via Squid :D
</A></li>
	<LI>Next message (by thread): <A HREF="009519.html">[squid-users] Bizarrely slow, timing out DNS only via Squid :D
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9518">[ date ]</a>
              <a href="thread.html#9518">[ thread ]</a>
              <a href="subject.html#9518">[ subject ]</a>
              <a href="author.html#9518">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
