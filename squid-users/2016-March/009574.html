<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Issue&In-Reply-To=%3C56DCEE2C.3050101%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009571.html">
   <LINK REL="Next"  HREF="009577.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump Issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Issue&In-Reply-To=%3C56DCEE2C.3050101%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL Bump Issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Mar  7 02:57:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009571.html">[squid-users] SSL Bump Issue
</A></li>
        <LI>Next message (by thread): <A HREF="009577.html">[squid-users] SSL Bump Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9574">[ date ]</a>
              <a href="thread.html#9574">[ thread ]</a>
              <a href="subject.html#9574">[ subject ]</a>
              <a href="author.html#9574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/03/2016 2:50 p.m., Ali Jawad wrote:
&gt;<i> Hi
</I>&gt;<i> Pardon me if I am mistaken but isnt it the case that 1 :
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp  --dport 443 --destination
</I>&gt;<i> 162.220.xx.xx -j REDIRECT --to-ports 3129
</I>&gt;<i> The rule above would only match for the IP of squid and squid should be
</I>&gt;<i> heading to the actual IP of the site in question which is not on the same
</I>&gt;<i> server
</I>
Squid itself is *never* a valid destination IP on intercepted traffic.
The purpose of the REDIRECT/DNAT is to make it a destination when it did
not start that way.

If you meant to write &quot; ! --destination&quot;, you would be correct. However
the difficulty you already had in using the '!' correctly is a good
reason why we dont demo that way. Its just plain difficult for beginners
to understand whats going on (and some experts even).

Also, the ! mechanism does not cope well with multiple IPs on the Squid
machine. In the modern Internet every machine in existence always has a
minimum of between 3 and 6 IPs, maybe more if the admin active assigns
multiple global IPs. They all need to be excluded for the protection to
be fully effective.


&gt;<i> 
</I>&gt;<i> and 2 :
</I>&gt;<i> 
</I>&gt;<i> If Squid is intercepting the PREROUTING chain would not apply anymore, as
</I>&gt;<i> traffic passing through local daemons goes through OUTPUT and POSTROUTING
</I>&gt;<i> chains
</I>
If the packets stayed within the Squid machine that would be right.
However outgoing packets with Squid IP as the destination can reach the
switch to which Squid is plugged in and &quot;bounce&quot; right back in through
all the normal PREROUTING logics. Infinite loop and very much pain
trying to figure out what is going on.

&gt;<i> 
</I>&gt;<i> As for
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
</I>&gt;<i> 
</I>
Both the -s parameter here and the mangle table rule are pre-emptively
truncating the NAT loop so that the packets end up being routed normally
instead of diverted into that Squid intercept port. They also
simultaneously prevent external attacks on the NAT system (and Squid)
from remote clients.

As mentioned above the --destination way(s) of doing things both does
not scale to all the IPs on the current machine, and is far less easy
for beginners to understand. So it is a multiple-win situation to do it
the way we demo.

&gt;<i> 
</I>&gt;<i> All traffic set to ACCEPT ..thanks !
</I>

Not all traffic hopefully. Just the stuff outgoing / generated by Squid
itself :-P

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009571.html">[squid-users] SSL Bump Issue
</A></li>
	<LI>Next message (by thread): <A HREF="009577.html">[squid-users] SSL Bump Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9574">[ date ]</a>
              <a href="thread.html#9574">[ thread ]</a>
              <a href="subject.html#9574">[ subject ]</a>
              <a href="author.html#9574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
