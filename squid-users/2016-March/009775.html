<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squidGuard%3A%20redirect%20to%20squid-internal%20URLs%20no%0A%20longer%20working%20with%203.5%3F&In-Reply-To=%3C56E7F777.7030808%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009773.html">
   <LINK REL="Next"  HREF="009779.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squidGuard%3A%20redirect%20to%20squid-internal%20URLs%20no%0A%20longer%20working%20with%203.5%3F&In-Reply-To=%3C56E7F777.7030808%40treenet.co.nz%3E"
       TITLE="[squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 15 11:52:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009773.html">[squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?
</A></li>
        <LI>Next message (by thread): <A HREF="009779.html">[squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9775">[ date ]</a>
              <a href="thread.html#9775">[ thread ]</a>
              <a href="subject.html#9775">[ subject ]</a>
              <a href="author.html#9775">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/03/2016 9:25 p.m., Silamael wrote:
&gt;<i> On 03/15/2016 12:10 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 15/03/2016 2:22 a.m., Silamael wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 03/14/2016 02:16 PM, Kinkie wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;&gt;<i>   .. has it ever? <A HREF="internal://">internal://</A> doesn't seem like a recognized protocol to me.
</I>&gt;&gt;&gt;<i> It worked till the update to Squid 3.5.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It should not have. That was a bug.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The correct syntax for 'internal:' URI looks like:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   <A HREF="internal://$visible_hostname:3128/squid-internal-static/...">internal://$visible_hostname:3128/squid-internal-static/...</A>
</I>&gt;<i> 
</I>&gt;<i> Sorry, I don't get it. Formerly we had
</I>&gt;<i> <A HREF="internal://squid-internal-static/error-access-denied">internal://squid-internal-static/error-access-denied</A> and this resulted
</I>&gt;<i> in the ERR_ACCESS_DENIED page being delivered to the client.
</I>&gt;<i> Now you say this has been wrong all the time and the correct path would
</I>&gt;<i> be <A HREF="internal://$visible_hostname:3128/squid-internal-static/...">internal://$visible_hostname:3128/squid-internal-static/...</A>
</I>
Yes.

&gt;<i> So, if i try this, i get a 404 response and the ERR_INVALID_REQ page.
</I>
Okay. That is the correct behaviour for this situation.
Squid does not normally load anything at the
/squid-internal-static/error-access-denied path.

A second bug / undefined behaviour that got fixed in 3.5 was incorrect
HTTP status codes being delivered on cachemgr and internal responses. It
now returns 404 Not Found when URL internal URL does not point at an
object, not &quot;access denied&quot; - because access wasn't denied, the file was
not found.

The /squid-internal-static/* objects to be loaded are configured in the
squid /etc/squid/mime.conf configuration file. (though some OS distros
move it out of /etc/squid for some reason).

However, that would just make the response a 200 OK with the internal
object as the payload. If you want to retain 403 you need to block the
re-written URL from being serviced by Squid:

 acl SG_deny urlpath_regex ^/squid-internal-static/error-access-denied$
 adapted_http_access deny SG_deny

(If that dont work you can use miss_access instead)


&gt;<i> With debugging I can see that there is a request like
</I>&gt;<i> GET ://127.0.0.1:3128/squid-internal-static/error-access-denied
</I>&gt;<i> This is indeed an invalid request...
</I>
Nod. Though the internal ID being used is correct, so its only the
output display and upstream messages which are broken. I'm looking into
that now, but the fix wont change anything relating to your actual
problem. You will still need to use the above config settings to trigger
a 403.


&gt;<i> If I use <A HREF="http://">http://</A> instead of <A HREF="internal://">internal://</A> the whole request is forwarded
</I>&gt;<i> to the upstream cache peer and again replied with ERR_INVALID_REQ...
</I>&gt;<i> With
</I>&gt;<i> <A HREF="internal://$visible_hostname:3128/squid-internal-static/error-access-denied">internal://$visible_hostname:3128/squid-internal-static/error-access-denied</A>
</I>&gt;<i> the response is a 400 Bad Request with ERR_UNSUP_REQ.
</I>&gt;<i> According to debugging here again the internal schema is not passed
</I>&gt;<i> along when building the GET request.
</I>&gt;<i> 
</I>&gt;<i> BTW, the old URL I used worked for years!
</I>
The problem with relying on undefined behaviour is that it can work for
a long time then disappear without warning.

What I think was going on previously was the parser handling the
URL-rewriter output accepted the URL with 'squid-internal-static' as
hostname. When Squid got to the upstream forwarding stage the check for
internal status did a sub-string check and (wrongly) found
&quot;/squid-internal-&quot;. So decided to handle it as internal. But the
internal-server logics could not find any object and (wrongly) generated
a 403 error page.

So a chain of at least 2 bugs being relied on to produce a 403 Access
Denied, when it should not have. We have now fixed those bugs, so what
you had relying on them goes splat.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009773.html">[squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?
</A></li>
	<LI>Next message (by thread): <A HREF="009779.html">[squid-users] squidGuard: redirect to squid-internal URLs no longer working with 3.5?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9775">[ date ]</a>
              <a href="thread.html#9775">[ thread ]</a>
              <a href="subject.html#9775">[ subject ]</a>
              <a href="author.html#9775">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
