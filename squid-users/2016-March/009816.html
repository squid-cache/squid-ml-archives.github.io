<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Two connections per client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Two%20connections%20per%20client&In-Reply-To=%3C56EA6FC4.4050603%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009814.html">
   <LINK REL="Next"  HREF="009837.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Two connections per client</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Two%20connections%20per%20client&In-Reply-To=%3C56EA6FC4.4050603%40treenet.co.nz%3E"
       TITLE="[squid-users] Two connections per client">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Mar 17 08:50:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009814.html">[squid-users] Two connections per client
</A></li>
        <LI>Next message (by thread): <A HREF="009837.html">[squid-users] Two connections per client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9816">[ date ]</a>
              <a href="thread.html#9816">[ thread ]</a>
              <a href="subject.html#9816">[ subject ]</a>
              <a href="author.html#9816">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/03/2016 4:56 a.m., Chris Nighswonger wrote:
&gt;<i> On Wed, Mar 16, 2016 at 10:44 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 17/03/2016 3:03 a.m., Chris Nighswonger wrote:
</I>&gt;&gt;&gt;<i> On Wed, Mar 16, 2016 at 9:07 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 17/03/2016 1:57 a.m., Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> On 17/03/2016 1:25 a.m., Chris Nighswonger wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On Wed, Mar 16, 2016 at 1:03 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> On 16/03/2016 12:38 p.m., Chris Nighswonger wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Why does netstat show two connections per client connection to
</I>&gt;&gt;<i> Squid:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> tcp        0      0 127.0.0.1:3128          127.0.0.1:34167
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> ESTABLISHED
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> tcp        0      0 127.0.0.1:34167         127.0.0.1:3128
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> ESTABLISHED
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> In this case, there is a content filter running in front of Squid on
</I>&gt;&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> same box. The same netstat command filtered on the content filter
</I>&gt;&gt;<i> port
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> shows only one connection per client:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> tcp        0      0 192.168.x.x:8080      192.168.x.y:1310
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>  ESTABLISHED
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Details of your Squid configuration are needed to answer that.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Here it is. I've stripped out all of the acl lines to reduce the
</I>&gt;&gt;<i> length:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> tcp_outgoing_address 184.x.x.x
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> http_port 127.0.0.1:3128
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> It would seem that it is not Squid making those connections outbound
</I>&gt;&gt;&gt;&gt;&gt;<i> from 127.0.0.1:3128. Squid uses that 184.x.x.x address with random
</I>&gt;&gt;&gt;&gt;&gt;<i> source ports for *all* its outbound connections.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Ah, just had an idea. Do you have IDENT protocol in those ACLs you
</I>&gt;&gt;<i> elided?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> IDENT makes a reverse connection back to the client to find the
</I>&gt;&gt;<i> identity.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So I have this acl in the list:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl AuthorizedUsers proxy_auth REQUIRED
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Might that be the one?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No, if existing it would have 'ident' or 'ident_regex' type.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Log formats would be the other way to hit ident. But I didn't notice
</I>&gt;&gt;<i> anything fancy like that in the config you posted.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Sorry for the direct reply on the last iteration. Silly g-mail does not
</I>&gt;<i> support reply to list apparently.
</I>&gt;<i> 
</I>&gt;<i> I've cleaned up the config based on your suggestions.
</I>&gt;<i> 
</I>&gt;<i> I'm not super concerned about the two connection issue. I was mostly
</I>&gt;<i> wondering what was up. Perhaps I should be. Ignorance is not always bliss.
</I>&gt;<i> 
</I>
Nod. Its an oddity. If it is Squid doing ident from behind a gateway
device/software then its probably a waste of CPU and sockets - things
would be slightly better off without waste.

If its not Squid then something is playing around with the Squid port.
Best know what it is even if thats okay.


&gt;<i> WRT follow_x_forwarded_for allow all, I've changed &quot;all&quot; to &quot;localhost.&quot; I
</I>&gt;<i> don't know if that tightens things up maybe? 
</I>
It does. Quite a lot :-)

&gt;<i> I need this enabled so that
</I>&gt;<i> the client IPs show up in the Squid log. At least I think I do.
</I>
I think so, at least assuming the gateway software which is passing
traffic to Squid sets the XFF header.

If that software frontend is not setting the header then following it is
useless.

&gt;<i> 
</I>&gt;<i> Thanks for the help. We've run Squid for over 16 years and it mostly just
</I>&gt;<i> works.
</I>&gt;<i> 
</I>&gt;<i> Kind regards,
</I>&gt;<i> Chris
</I>&gt;<i> 
</I>
Thank you.
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009814.html">[squid-users] Two connections per client
</A></li>
	<LI>Next message (by thread): <A HREF="009837.html">[squid-users] Two connections per client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9816">[ date ]</a>
              <a href="thread.html#9816">[ thread ]</a>
              <a href="subject.html#9816">[ subject ]</a>
              <a href="author.html#9816">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
