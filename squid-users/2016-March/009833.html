<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid with ICAP filter?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20ICAP%20filter%3F&In-Reply-To=%3C56EB09CA.9000905%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009828.html">
   <LINK REL="Next"  HREF="009834.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid with ICAP filter?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20ICAP%20filter%3F&In-Reply-To=%3C56EB09CA.9000905%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid with ICAP filter?">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Mar 17 19:47:22 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009828.html">[squid-users] Squid with ICAP filter?
</A></li>
        <LI>Next message (by thread): <A HREF="009834.html">[squid-users] Squid with ICAP filter?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9833">[ date ]</a>
              <a href="thread.html#9833">[ thread ]</a>
              <a href="subject.html#9833">[ subject ]</a>
              <a href="author.html#9833">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/17/2016 12:25 PM, Mike Summers wrote:
&gt;<i> We have a situation where we need to filter compressed HTTP traffic
</I>&gt;<i> through an ICAP service, logging failures (4xx) or passing the original
</I>&gt;<i> compressed payload to it's target destination on 2xx.
</I>&gt;<i> 
</I>&gt;<i> Something like this:
</I>&gt;<i> 
</I>&gt;<i>   * Incoming compressed HTTP
</I>&gt;<i>   * Decompress and forward to ICAP service
</I>&gt;<i>   * Log and discard if ICAP service returns 4xx
</I>&gt;<i>   * Send original, compressed payload to destination if ICAP returns 2xx
</I>&gt;<i> 
</I>&gt;<i> Is that an appropriate use for Squid? If so what sort of configuration
</I>&gt;<i> commands would we use? We're not certain where to begin.
</I>
I do not know what you mean by &quot;compressed HTTP&quot;. If compressed HTTP
means something like &quot;HTTP where message bodies contain zipped or
gzipped content&quot;, then you can accomplish the above by sandwiching your
ICAP service between two eCAP services in a single adaptation chain.

  <A HREF="http://www.squid-cache.org/Doc/config/adaptation_service_chain/">http://www.squid-cache.org/Doc/config/adaptation_service_chain/</A>
  <A HREF="http://www.squid-cache.org/Doc/config/icap_service/">http://www.squid-cache.org/Doc/config/icap_service/</A>
  <A HREF="http://www.squid-cache.org/Doc/config/ecap_service/">http://www.squid-cache.org/Doc/config/ecap_service/</A>

Without going into many necessary details, the overall scheme may work
similar to this:

 0. Squid receives &quot;compressed&quot; message M.z.

 1. eCAP decompression service gets message M.z from Squid,
    decompresses M.z body, and
    sends the decompressed message M back to Squid.

 2. Your ICAP service gets message M and either blocks or allows it.

 3. If message M was allowed in #2,
    eCAP compression service gets message M from Squid,
    compresses M body, and
    sends the compressed M.z back to Squid.

 4. Squid forwards M.z to the next hop.

The above can be done using standard eCAP/ICAP interfaces and squid.conf
directives without reinventing the wheel, provided your ICAP service is
compatible with Squid. Certain performance optimizations are possible
with more work (e.g., the eCAP services may cache and reuse the
compressed version of the message).

If you want to reinvent the wheel by writing an ICAP client, then you
can write a single eCAP or ICAP service that talks directly to your ICAP
service, without using Squid adaptation chains. From Squid point of
view, there will be just one eCAP or ICAP service doing everything.

Needless to say that adding decompression support to the original ICAP
service itself would be the fastest and simplest option (but it requires
modifying the existing ICAP service code which I am guessing you cannot
or do not want to do).


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009828.html">[squid-users] Squid with ICAP filter?
</A></li>
	<LI>Next message (by thread): <A HREF="009834.html">[squid-users] Squid with ICAP filter?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9833">[ date ]</a>
              <a href="thread.html#9833">[ thread ]</a>
              <a href="subject.html#9833">[ subject ]</a>
              <a href="author.html#9833">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
