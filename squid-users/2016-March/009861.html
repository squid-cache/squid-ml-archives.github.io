<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] intercepting tcp/443 purely for logging purposes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercepting%20tcp/443%20purely%20for%20logging%20purposes&In-Reply-To=%3CCAFChrgJ%2BtMn-VW0O_8gWrQHbk4zb_gds61mFVFvGTE7q%3DiF9ew%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009857.html">
   <LINK REL="Next"  HREF="009862.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] intercepting tcp/443 purely for logging purposes</H1>
    <B>Jason Haar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercepting%20tcp/443%20purely%20for%20logging%20purposes&In-Reply-To=%3CCAFChrgJ%2BtMn-VW0O_8gWrQHbk4zb_gds61mFVFvGTE7q%3DiF9ew%40mail.gmail.com%3E"
       TITLE="[squid-users] intercepting tcp/443 purely for logging purposes">jason_haar at trimble.com
       </A><BR>
    <I>Mon Mar 21 09:32:45 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009857.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
        <LI>Next message (by thread): <A HREF="009862.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9861">[ date ]</a>
              <a href="thread.html#9861">[ thread ]</a>
              <a href="subject.html#9861">[ subject ]</a>
              <a href="author.html#9861">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yeah I know that, but there are issues with invoking peek: like the host
forgery checks suddenly kick in, and squid starts seeing SSL errors
(probably due to CentOS6 not supporting the newest standards that Chrome
uses) and then squid starts blocking things. That's why I'm sticking to
this simplest case for the moment and avoid the &quot;peek&quot; call


Thanks!

Jason

On Mon, Mar 21, 2016 at 8:53 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 21/03/2016 10:29 a.m., Jason Haar wrote:
</I>&gt;<i> &gt; Hi there
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm wanting to use tls intercept to just log (well OK, and potentially
</I>&gt;<i> &gt; block) HTTPS sites based on hostnames (from SNI), but have had problems
</I>&gt;<i> &gt; even in peek-and-splice mode. So I'm willing to compromise and instead
</I>&gt;<i> just
</I>&gt;<i> &gt; intercept that traffic, log it, block on IP addresses if need be, and
</I>&gt;<i> don't
</I>&gt;<i> &gt; use ssl-bump beyond that.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So far the following seems to work perfectly, can someone confirm this is
</I>&gt;<i> &gt; &quot;supported&quot; - ie that I'm not relying on some bug that might get fixed
</I>&gt;<i> &gt; later? ;-)
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> It is supporteed.
</I>&gt;<i>
</I>&gt;<i> &gt; sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M
</I>&gt;<i> 256MB
</I>&gt;<i> &gt; sslcrtd_children 32 startup=15 idle=5
</I>&gt;<i> &gt; acl SSL_https port 443
</I>&gt;<i> &gt; ssl_bump splice SSL_https
</I>&gt;<i> &gt; acl BlacklistedHTTPSsites dstdomain
</I>&gt;<i> &gt; &quot;/etc/squid/acl-BlacklistedHTTPSsites.txt&quot;
</I>&gt;<i> &gt; http_access deny BlacklistedHTTPSsites
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The &quot;bug&quot; comment comes down to how acl seems to work. I half-expected
</I>&gt;<i> the
</I>&gt;<i> &gt; above not to work - but it does. It would appear squid will treat an
</I>&gt;<i> &gt; intercept's dst IP as the &quot;dns name&quot; as that's all it's got - so
</I>&gt;<i> &gt; &quot;dstdomain&quot; works fine for both CONNECT and intercept IFF the acl
</I>&gt;<i> contains
</I>&gt;<i> &gt; IP addresses
</I>&gt;<i>
</I>&gt;<i> This is because the ssl_bump rules are saying to splice immediately when
</I>&gt;<i> only the pseudo-CONNECT with an IP address is known.
</I>&gt;<i>
</I>&gt;<i> If you use this:
</I>&gt;<i>  ssl_bump peek all
</I>&gt;<i>  ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> it will peek at the client SNI and server public cert details before
</I>&gt;<i> dropping back to a transparent pass-tru. Then it will have that domain
</I>&gt;<i> and any other non-encrypted details available for logging.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


-- 
Cheers

Jason Haar
Information Security Manager, Trimble Navigation Ltd.
Phone: +1 408 481 8171
PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160321/ab9be4b0/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160321/ab9be4b0/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009857.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
	<LI>Next message (by thread): <A HREF="009862.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9861">[ date ]</a>
              <a href="thread.html#9861">[ thread ]</a>
              <a href="subject.html#9861">[ subject ]</a>
              <a href="author.html#9861">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
