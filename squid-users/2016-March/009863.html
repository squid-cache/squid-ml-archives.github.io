<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] intercepting tcp/443 purely for logging purposes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercepting%20tcp/443%20purely%20for%20logging%20purposes&In-Reply-To=%3CCAFChrg%2Bgxu7Q4VYG-X%3D1umQ3%3Dps4u4i%2BjwfLHCEzi44rNWnGcA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009862.html">
   <LINK REL="Next"  HREF="009864.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] intercepting tcp/443 purely for logging purposes</H1>
    <B>Jason Haar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercepting%20tcp/443%20purely%20for%20logging%20purposes&In-Reply-To=%3CCAFChrg%2Bgxu7Q4VYG-X%3D1umQ3%3Dps4u4i%2BjwfLHCEzi44rNWnGcA%40mail.gmail.com%3E"
       TITLE="[squid-users] intercepting tcp/443 purely for logging purposes">jason_haar at trimble.com
       </A><BR>
    <I>Mon Mar 21 19:01:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009862.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
        <LI>Next message (by thread): <A HREF="009864.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9863">[ date ]</a>
              <a href="thread.html#9863">[ thread ]</a>
              <a href="subject.html#9863">[ subject ]</a>
              <a href="author.html#9863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It's really not much more than what I first posted (I can't send my config
- it's pretty specific to our site - you'll have to figure out the standard
stuff yourself)

So this will make a squid-3.5 server capable of doing &quot;transparent HTTPS&quot;
without any fiddling with the transactions. Of course it assumes you
already know how to redirect port 443 traffic onto your proxy, and know how
to reconfigure the OS to support that too (ie same as transparent HTTP on
port 80)

acl BlacklistedHTTPSsites dstdomain
&quot;/etc/squid/acl-BlacklistedHTTPSsites.txt&quot;
http_access deny BlacklistedHTTPSsites
https_port 3127 intercept ssl-bump cert=/etc/squid/squid-CA.cert
 cafile=/etc/squid/ca-bundle.crt generate-host-certificates=on
dynamic_cert_mem_cache_size=256MB options=ALL
sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 256MB
sslcrtd_children 32 startup=15 idle=5
acl SSL_https port 443
ssl_bump splice SSL_https


On Tue, Mar 22, 2016 at 12:05 AM, Vito A. Smaldino &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">vitoantonio.smaldino at istruzione.it</A>&gt; wrote:

&gt;<i> Hi all,
</I>&gt;<i> great, i'm just searching for this. Jason can you kindly post the whole
</I>&gt;<i> squid.conf?
</I>&gt;<i> Thanks
</I>&gt;<i> V
</I>&gt;<i>
</I>&gt;<i> 2016-03-20 22:29 GMT+01:00 Jason Haar &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jason_haar at trimble.com</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi there
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm wanting to use tls intercept to just log (well OK, and potentially
</I>&gt;&gt;<i> block) HTTPS sites based on hostnames (from SNI), but have had problems
</I>&gt;&gt;<i> even in peek-and-splice mode. So I'm willing to compromise and instead just
</I>&gt;&gt;<i> intercept that traffic, log it, block on IP addresses if need be, and don't
</I>&gt;&gt;<i> use ssl-bump beyond that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So far the following seems to work perfectly, can someone confirm this is
</I>&gt;&gt;<i> &quot;supported&quot; - ie that I'm not relying on some bug that might get fixed
</I>&gt;&gt;<i> later? ;-)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M
</I>&gt;&gt;<i> 256MB
</I>&gt;&gt;<i> sslcrtd_children 32 startup=15 idle=5
</I>&gt;&gt;<i> acl SSL_https port 443
</I>&gt;&gt;<i> ssl_bump splice SSL_https
</I>&gt;&gt;<i> acl BlacklistedHTTPSsites dstdomain
</I>&gt;&gt;<i> &quot;/etc/squid/acl-BlacklistedHTTPSsites.txt&quot;
</I>&gt;&gt;<i> http_access deny BlacklistedHTTPSsites
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The &quot;bug&quot; comment comes down to how acl seems to work. I half-expected
</I>&gt;&gt;<i> the above not to work - but it does. It would appear squid will treat an
</I>&gt;&gt;<i> intercept's dst IP as the &quot;dns name&quot; as that's all it's got - so
</I>&gt;&gt;<i> &quot;dstdomain&quot; works fine for both CONNECT and intercept IFF the acl contains
</I>&gt;&gt;<i> IP addresses
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was hoping I wouldn't need ssl-bump at all, but you need squid to be
</I>&gt;&gt;<i> running a https_port, and for it to support &quot;intercept&quot;, and to do that
</I>&gt;&gt;<i> squid insists on &quot;ssl-bump&quot; too - although that seems likely was a
</I>&gt;&gt;<i> programmer assumption that didn't include people like me doing mad things
</I>&gt;&gt;<i> like this? :-). I'd also guess I don't need 32 children/etc  - 1 would
</I>&gt;&gt;<i> suffice as it's never used?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So the end result is that all CONNECT and/or intercept SSL/TLS traffic is
</I>&gt;&gt;<i> supported via the proxy, with all TLS security decisions residing on the
</I>&gt;&gt;<i> client. I get my logs, and if I want to block some known bad IP address, I
</I>&gt;&gt;<i> can: CONNECT causes a 403 HTTP error page and intercept basically ditches
</I>&gt;&gt;<i> the tcp/443 connection - which is as good as it gets without getting into
</I>&gt;&gt;<i> the wonderful world of real &quot;bump&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Cheers
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jason Haar
</I>&gt;&gt;<i> Information Security Manager, Trimble Navigation Ltd.
</I>&gt;&gt;<i> Phone: +1 408 481 8171
</I>&gt;&gt;<i> PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Vito A. Smaldino
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Cheers

Jason Haar
Information Security Manager, Trimble Navigation Ltd.
Phone: +1 408 481 8171
PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160322/cd85baf4/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160322/cd85baf4/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009862.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
	<LI>Next message (by thread): <A HREF="009864.html">[squid-users] intercepting tcp/443 purely for logging purposes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9863">[ date ]</a>
              <a href="thread.html#9863">[ thread ]</a>
              <a href="subject.html#9863">[ subject ]</a>
              <a href="author.html#9863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
