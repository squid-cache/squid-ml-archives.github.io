<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] substituing sniproxy for squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20substituing%20sniproxy%20for%20squid&In-Reply-To=%3CCAFLo2QxPBJ_u-07GMk_UFaH7SZ1s-Z3ysZXUNxUw7%2BMHRaCeFA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009882.html">
   <LINK REL="Next"  HREF="009885.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] substituing sniproxy for squid</H1>
    <B>Luis Daniel Lucio Quiroz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20substituing%20sniproxy%20for%20squid&In-Reply-To=%3CCAFLo2QxPBJ_u-07GMk_UFaH7SZ1s-Z3ysZXUNxUw7%2BMHRaCeFA%40mail.gmail.com%3E"
       TITLE="[squid-users] substituing sniproxy for squid">luis.daniel.lucio at gmail.com
       </A><BR>
    <I>Thu Mar 24 02:56:38 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009882.html">[squid-users] substituing sniproxy for squid
</A></li>
        <LI>Next message (by thread): <A HREF="009885.html">[squid-users] substituing sniproxy for squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9883">[ date ]</a>
              <a href="thread.html#9883">[ thread ]</a>
              <a href="subject.html#9883">[ subject ]</a>
              <a href="author.html#9883">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>As A side note, I am reading the code seems file
src/client_side_request.cc function
ClientRequestContext::hostHeaderVerify() is responsible for this.

And to be exact this option:
    if (ia != NULL &amp;&amp; ia-&gt;count &gt; 0) {
       // Is the NAT destination IP in DNS?
       for (int i = 0; i &lt; ia-&gt;count; ++i) {
           if (clientConn-&gt;local.matchIPAddr(ia-&gt;in_addrs[i]) == 0) {
               debugs(85, 3, HERE &lt;&lt; &quot;validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt;
&quot; possible from Host:&quot;);
               http-&gt;request-&gt;flags.hostVerified = true;
               http-&gt;doCallouts();
               return;
           }
           debugs(85, 3, HERE &lt;&lt; &quot;validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot;
non-match from Host: IP &quot; &lt;&lt; ia-&gt;in_addrs[i]);
       }
   }
   debugs(85, 3, HERE &lt;&lt; &quot;FAIL: validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot;
possible from Host:&quot;);
   hostHeaderVerifyFailed(&quot;local IP&quot;, &quot;any domain IP&quot;);



As far as I understand there is no a possible way.
Would you be interested on a patch to allow this behaivour optional?

--
Luis Daniel Lucio Quiroz
CISSP, CISM, CISA
Linux, VoIP and much more fun
www.okay.com.mx

Need LCR? Check out LCR for FusionPBX with FreeSWITCH
Need Billing? Check out Billing for FusionPBX with FreeSWITCH

2016-03-23 21:25 GMT-04:00 Luis Daniel Lucio Quiroz &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">luis.daniel.lucio at gmail.com</A>&gt;:

&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> Well, I am now stuck with the Host header forgery detected
</I>&gt;<i> Which it means that client and squid resolve different IP (in my use case
</I>&gt;<i> that is what I want).
</I>&gt;<i>
</I>&gt;<i> I already have  host_verify_strict
</I>&gt;<i> &lt;<A HREF="http://www.squid-cache.org/Doc/config/host_verify_strict">http://www.squid-cache.org/Doc/config/host_verify_strict</A>&gt;   disabled,
</I>&gt;<i> but that is not enough.
</I>&gt;<i>
</I>&gt;<i> Any advice? (Rather than do a patch and disable that verification? )
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Luis Daniel Lucio Quiroz
</I>&gt;<i> CISSP, CISM, CISA
</I>&gt;<i> Linux, VoIP and much more fun
</I>&gt;<i> www.okay.com.mx
</I>&gt;<i>
</I>&gt;<i> Need LCR? Check out LCR for FusionPBX with FreeSWITCH
</I>&gt;<i> Need Billing? Check out Billing for FusionPBX with FreeSWITCH
</I>&gt;<i>
</I>&gt;<i> 2016-02-01 16:31 GMT-05:00 Luis Daniel Lucio Quiroz &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">luis.daniel.lucio at gmail.com</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> Thank you
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I understand what you mean, but ssl/tls will warm the browser if
</I>&gt;&gt;<i> something is modified.
</I>&gt;&gt;<i> Le 1 f&#233;vr. 2016 7:08 AM, &quot;Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; a &#233;crit :
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 1/02/2016 11:35 a.m., Luis Daniel Lucio Quiroz wrote:
</I>&gt;&gt;&gt;<i> &gt; Hello
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt; Can anyone give some clue, link something to read on how to do the
</I>&gt;&gt;&gt;<i> HTTPs
</I>&gt;&gt;&gt;<i> &gt; work with SNI, i just want to forward to the correct server based on
</I>&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i> &gt; SNI. I want to get rid of SNIproxy in favor of squid.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That should be possible with Squid-3.5 or later by intercepting the port
</I>&gt;&gt;&gt;<i> 443 traffic (*not* reverse-proxy / accel) and using:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  acl step1 at_step SslBumpStep1
</I>&gt;&gt;&gt;<i>  ssl_bump peek step1
</I>&gt;&gt;&gt;<i>  ssl_bump splice all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But be aware that SNI does not provide any guarantee of &quot;correct
</I>&gt;&gt;&gt;<i> server&quot;. HTTP (even in its 'HTTPS' form) is a multiplexed messaging
</I>&gt;&gt;&gt;<i> protocol. When you do the above Squid will not be able to protect you
</I>&gt;&gt;&gt;<i> against any Host header attacks buried inside the TLS layer - not that
</I>&gt;&gt;&gt;<i> sniproxy does either (in fact sniproxy seems by design to actively
</I>&gt;&gt;&gt;<i> _enable_ those type of vulnerabilities).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160323/63f68df3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160323/63f68df3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009882.html">[squid-users] substituing sniproxy for squid
</A></li>
	<LI>Next message (by thread): <A HREF="009885.html">[squid-users] substituing sniproxy for squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9883">[ date ]</a>
              <a href="thread.html#9883">[ thread ]</a>
              <a href="subject.html#9883">[ subject ]</a>
              <a href="author.html#9883">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
