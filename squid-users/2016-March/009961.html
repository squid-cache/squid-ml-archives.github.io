<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Slowly rising CPU load (eventually hits 100)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Slowly%20rising%20CPU%20load%20%28eventually%20hits%20100%29&In-Reply-To=%3C56FD2F2F.9060301%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009960.html">
   <LINK REL="Next"  HREF="009962.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Slowly rising CPU load (eventually hits 100)</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Slowly%20rising%20CPU%20load%20%28eventually%20hits%20100%29&In-Reply-To=%3C56FD2F2F.9060301%40gmail.com%3E"
       TITLE="[squid-users] Slowly rising CPU load (eventually hits 100)">yvoinov at gmail.com
       </A><BR>
    <I>Thu Mar 31 14:07:43 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009960.html">[squid-users] Slowly rising CPU load (eventually hits 100)
</A></li>
        <LI>Next message (by thread): <A HREF="009962.html">[squid-users] Slowly rising CPU load (eventually hits 100)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9961">[ date ]</a>
              <a href="thread.html#9961">[ thread ]</a>
              <a href="subject.html#9961">[ subject ]</a>
              <a href="author.html#9961">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
Looks like permanently running clients, which is exausted network
resources and then initiating connection abort.

Try to add

client_persistent_connections off

to squid.conf.

Then observe.

31.03.16 19:53, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at peralex.com</A> &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm running:
</I>&gt;<i>
</I>&gt;<i> Squid Cache: Version 3.5.15  (including patches up to revision 14000)
</I>&gt;<i>
</I>&gt;<i> on FreeBSD 9.3-STABLE (recently updated)
</I>&gt;<i>
</I>&gt;<i> Every week or so I run into a problem where squid's CPU usage starts
</I>&gt;<i> growing slowly, reaching 100% over the course of a day or so.  When
</I>&gt;<i> running normally its CPU usage is usually less than 5%.  Restarting
</I>&gt;<i> squid fixes the problem.
</I>&gt;<i>
</I>&gt;<i> Memory usage is about 2 GBytes (on a system with 8 GBytes of RAM).
</I>&gt;<i>
</I>&gt;<i> The number of socket connections (from clients and to servers) is about
</I>&gt;<i> the same (roughly 500) when I have the problem as when I don't have the
</I>&gt;<i> problem.
</I>&gt;<i>
</I>&gt;<i> Attaching GDB and getting a stack trace while squid is stuck at 100%
</I>&gt;<i> generally gives me this:
</I>&gt;<i>
</I>&gt;<i> #0  0x00000000005deef4 in mem_node::end ()
</I>&gt;<i> #1  0x00000000005df076 in mem_node::dataRange ()
</I>&gt;<i> #2  0x0000000000625d34 in mem_hdr::NodeCompare ()
</I>&gt;<i> #3  0x0000000000628ad1 in SplayNode&lt;mem_node*&gt;::splay&lt;mem_node*&gt; ()
</I>&gt;<i> #4  0x0000000000628b85 in Splay&lt;mem_node*&gt;::find&lt;mem_node*&gt; ()
</I>&gt;<i> #5  0x0000000000625f8e in mem_hdr::getBlockContainingLocation ()
</I>&gt;<i> #6  0x0000000000625ff8 in mem_hdr::hasContigousContentRange ()
</I>&gt;<i> #7  0x00000000005e00fe in MemObject::isContiguous ()
</I>&gt;<i> #8  0x0000000000649d05 in StoreEntry::mayStartSwapOut ()
</I>&gt;<i> #9  0x0000000000648b96 in StoreEntry::swapOut ()
</I>&gt;<i> #10 0x0000000000639e87 in StoreEntry::invokeHandlers ()
</I>&gt;<i> #11 0x0000000000633e09 in StoreEntry::write ()
</I>&gt;<i> #12 0x000000000079caa1 in Client::storeReplyBody ()
</I>&gt;<i> #13 0x000000000059c0bf in HttpStateData::writeReplyBody ()
</I>&gt;<i> #14 0x00000000005a18fd in HttpStateData::processReplyBody ()
</I>&gt;<i> #15 0x00000000005a41ce in HttpStateData::processReply ()
</I>&gt;<i> #16 0x00000000005a4408 in HttpStateData::readReply ()
</I>&gt;<i> #17 0x00000000005ab6df in JobDialer&lt;HttpStateData&gt;::dial ()
</I>&gt;<i> #18 0x00000000006fd81a in AsyncCall::make ()
</I>&gt;<i> #19 0x0000000000701bc6 in AsyncCallQueue::fireNext ()
</I>&gt;<i> #20 0x0000000000701ecf in AsyncCallQueue::fire ()
</I>&gt;<i> #21 0x0000000000566621 in EventLoop::dispatchCalls ()
</I>&gt;<i> #22 0x0000000000566930 in EventLoop::runOnce ()
</I>&gt;<i> #23 0x0000000000566b18 in EventLoop::run ()
</I>&gt;<i> #24 0x00000000005dbb73 in SquidMain ()
</I>&gt;<i> #25 0x00000000005dc0fd in SquidMainSafe ()
</I>&gt;<i> #26 0x00000000004cf401 in _start ()
</I>&gt;<i> #27 0x0000000800ae4000 in ?? ()
</I>&gt;<i> #28 0x0000000000000000 in ?? ()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The cache.log file gets a few lines looking like this:
</I>&gt;<i>
</I>&gt;<i> 2016/03/31 11:51:04 kid1| local=192.168.1.15:3128
</I>&gt;<i> remote=192.168.1.164:49540 FD 339 flags=1: read/write failure: (60)
</I>&gt;<i> Operation timed out
</I>&gt;<i>
</I>&gt;<i> and some others looking like this:
</I>&gt;<i>
</I>&gt;<i> 2016/03/31 14:40:05 kid1|  FD 16, 192.168.1.15 [Stopped, reason:Listener
</I>&gt;<i> socket closed job3132772]: (53) Software caused connection abort
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Does anybody have any suggestions on how to fix/improve this?  Currently
</I>&gt;<i> I have cron restarting squid every morning.
</I>&gt;<i>
</I>&gt;<i> Should I file a bug?
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i> Mark
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJW/S8uAAoJENNXIZxhPexGg60H/i4QPMqNZtbZ+9Cw2RhBgLBy
PtW4A76bM8+Fdolgags28atI0IkZlmacLxzZDjKUKjxwP7j+QkMNToNpUcFVpN4g
zURmM1FqGbRtvIPsXeaExdo9oyl+qIVljtfBLaEwN85bT5SkIe79jNqpTb6SkJ/s
DdI5gZTZQG27Ix6Z2ajohVSYmAdNUl7CeM4bcGWlFXtDP80daeqC+EKlQACg+Lou
QyoVeJ/PSoLk+ecglIPObTrRHyhdpcacGWdd2p/TKiP0FppwxJGxPH/uxPJcBeHJ
iLHh4Irf0Fo9CvnqqcxZsxsqxrsXQ+rj5q/cB8G6My95Gy8jnkNstZtCtMmLx8I=
=H/Cg
-----END PGP SIGNATURE-----

-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160331/d8f7cbf9/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160331/d8f7cbf9/attachment.key</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009960.html">[squid-users] Slowly rising CPU load (eventually hits 100)
</A></li>
	<LI>Next message (by thread): <A HREF="009962.html">[squid-users] Slowly rising CPU load (eventually hits 100)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9961">[ date ]</a>
              <a href="thread.html#9961">[ thread ]</a>
              <a href="subject.html#9961">[ subject ]</a>
              <a href="author.html#9961">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
