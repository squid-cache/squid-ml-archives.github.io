<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Slowly rising CPU load (eventually hits 100)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Slowly%20rising%20CPU%20load%20%28eventually%20hits%20100%29&In-Reply-To=%3C56FD53D3.4040006%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009962.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Slowly rising CPU load (eventually hits 100)</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Slowly%20rising%20CPU%20load%20%28eventually%20hits%20100%29&In-Reply-To=%3C56FD53D3.4040006%40measurement-factory.com%3E"
       TITLE="[squid-users] Slowly rising CPU load (eventually hits 100)">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Mar 31 16:44:03 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="009962.html">[squid-users] Slowly rising CPU load (eventually hits 100)
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9963">[ date ]</a>
              <a href="thread.html#9963">[ thread ]</a>
              <a href="subject.html#9963">[ subject ]</a>
              <a href="author.html#9963">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/31/2016 07:53 AM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at peralex.com</A> wrote:

&gt;<i> Every week or so I run into a problem where squid's CPU usage starts
</I>&gt;<i> growing slowly, reaching 100% over the course of a day or so.  When
</I>&gt;<i> running normally its CPU usage is usually less than 5%.  Restarting
</I>&gt;<i> squid fixes the problem.
</I>
My working theory is that the longer you let your Squid run, the bigger
objects it might store in RAM, increasing the severity of the linear
search delays mentioned below. A similar pattern may also be caused by
larger objects becoming more popular during certain days of the week.


&gt;<i> Attaching GDB and getting a stack trace while squid is stuck at 100%
</I>&gt;<i> generally gives me this:
</I>&gt;<i> 
</I>&gt;<i> #0  0x00000000005deef4 in mem_node::end ()
</I>&gt;<i> #1  0x00000000005df076 in mem_node::dataRange ()
</I>&gt;<i> #2  0x0000000000625d34 in mem_hdr::NodeCompare ()
</I>&gt;<i> #3  0x0000000000628ad1 in SplayNode&lt;mem_node*&gt;::splay&lt;mem_node*&gt; ()
</I>&gt;<i> #4  0x0000000000628b85 in Splay&lt;mem_node*&gt;::find&lt;mem_node*&gt; ()
</I>&gt;<i> #5  0x0000000000625f8e in mem_hdr::getBlockContainingLocation ()
</I>&gt;<i> #6  0x0000000000625ff8 in mem_hdr::hasContigousContentRange ()
</I>&gt;<i> #7  0x00000000005e00fe in MemObject::isContiguous ()
</I>&gt;<i> #8  0x0000000000649d05 in StoreEntry::mayStartSwapOut ()
</I>
IIRC, this is a known linear search in Squid local memory code that does
not scale with object sizes. It has been discovered a year or more ago,
but I am not aware of anybody working to optimize it since then.

In summary, dealing with in-RAM objects significantly larger than 1MB
may slow Squid down to a crawl with 100% CPU usage as the symptom and
backtraces pointing to getBlockContainingLocation() or similar code. The
bigger the object, the longer Squid takes to scan its nodes.

Unfortunately, I do not remember whether this affects just cached or
both cached and in-transit objects.


&gt;<i> Does anybody have any suggestions on how to fix/improve this?  
</I>
Short term, try limiting the size of in-RAM objects using
maximum_object_size_in_memory first. If that solves the problem, then,
most likely, only cached objects are affected.

Also, forcing shared memory cache (even if you are not using SMP Squid)
might help, but shared memory cache does not cache Varying objects so I
hesitate recommending that as a solution for non-SMP Squids. Also, I am
not sure whether shared memory cache avoids this bug because, while the
shared memory code itself does not have the above linear search, SMP
Squid still uses local memory code and might hit the same linear search.


&gt;<i> Should I file a bug?
</I>
Yes, of course. It is a [serious] bug. If it were filed long time ago,
we would have more information about it (at least) and would have to
guess less. Please point to or copy to this email exchange to your bug
report.


Thank you,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="009962.html">[squid-users] Slowly rising CPU load (eventually hits 100)
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9963">[ date ]</a>
              <a href="thread.html#9963">[ thread ]</a>
              <a href="subject.html#9963">[ subject ]</a>
              <a href="author.html#9963">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
