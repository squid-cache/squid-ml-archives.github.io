<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to analyse squid memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20analyse%20squid%20memory%20usage&In-Reply-To=%3Cecf5502a-73c1-a39c-141f-a61db41697f7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010536.html">
   <LINK REL="Next"  HREF="010565.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to analyse squid memory usage</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20analyse%20squid%20memory%20usage&In-Reply-To=%3Cecf5502a-73c1-a39c-141f-a61db41697f7%40treenet.co.nz%3E"
       TITLE="[squid-users] How to analyse squid memory usage">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 11 06:30:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010536.html">[squid-users] How to analyse squid memory usage
</A></li>
        <LI>Next message (by thread): <A HREF="010565.html">[squid-users] How to analyse squid memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10539">[ date ]</a>
              <a href="thread.html#10539">[ thread ]</a>
              <a href="subject.html#10539">[ subject ]</a>
              <a href="author.html#10539">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/05/2016 4:37 p.m., Dan Charlesworth wrote:
&gt;<i> Thanks Amos -
</I>&gt;<i> 
</I>&gt;<i> Not sure how self-explanatory the output is, though.
</I>&gt;<i> 
</I>&gt;<i> I&#8217;ve attached the output from a site with a 12GB server where top was showing 2.9GB allocated to squid (this is normal e.g. &#8220;the control&quot;). But the mem output shows the allocated total as ~1GB, apparently?
</I>&gt;<i> 
</I>
That ~1GB looks like correct interpretation to me.

One thing to be aware of is that some OS allocate memory in multiples of
4KB. So objects like mem_node which are just a few bytes over use 8KB -
twice as much memory as Squid is aware of. mem_node is know to hit this
problem, other objects get pooled in larger batches so Squid use tends
to self-correct that. In this case the number of mem_node allocated does
not account for more than a tiny slice of 12 vs 1 GB difference.

Another thing is that virtual memory accounting by top etc is useless as
a metric. Squid uses fork() for its child processes, each time it forks
the virtual memory &quot;size&quot; gets doubled. So 12GB could just mean Squid is
running 11 helpers (1GB RAM used by Squid, 100KB by each of 11 helpers
== 1GB RAM aka. 12 x 1GB virtual memory !).

 ==&gt; I see cbdata helper_server has 12 objects (ie 12 helpers running).
Which does almost exactly account for the 1 vs 12 scale of the
difference you see between mgr:mem and top.

NP: there are also STL objects and stuff not using Squid memory pools.
So there can be some MB of difference between mgr:mem report and
external tools. But that should not grow very big.


&gt;<i> Maybe things will become clearer once I have a &#8220;leaky&#8221; server&#8217;s output to compare with it.
</I>&gt;<i> 
</I>
Leaks show up in the mem report looking a lot like the ClientInfo line
in that one you provided. Objects allocated, all in use, and none or
very few savings.
 ClientInfo here is only some KB. So probably not an actual leak, but
thats how they usually show up. The same signature in a popular object
like mem_node or HttpRequest it would be a leak.

If you need to we also have a build option for embedding valgrind hooks
into Squid between the custom pool allocators and the general code. That
allows valgrind to be run and trace leaks in its normal way, unlike the
allocator OpenSSL got a bad rep from.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010536.html">[squid-users] How to analyse squid memory usage
</A></li>
	<LI>Next message (by thread): <A HREF="010565.html">[squid-users] How to analyse squid memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10539">[ date ]</a>
              <a href="thread.html#10539">[ thread ]</a>
              <a href="subject.html#10539">[ subject ]</a>
              <a href="author.html#10539">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
