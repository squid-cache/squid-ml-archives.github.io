<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Mark outgoing connection mark same as client side mark
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mark%20outgoing%20connection%20mark%20same%20as%20client%20side%0A%20mark&In-Reply-To=%3C48cee11c-bcfe-ef83-086a-9d0d95c8600d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010544.html">
   <LINK REL="Next"  HREF="010551.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Mark outgoing connection mark same as client side mark</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mark%20outgoing%20connection%20mark%20same%20as%20client%20side%0A%20mark&In-Reply-To=%3C48cee11c-bcfe-ef83-086a-9d0d95c8600d%40treenet.co.nz%3E"
       TITLE="[squid-users] Mark outgoing connection mark same as client side mark">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 11 11:53:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010544.html">[squid-users] Mark outgoing connection mark same as client side mark
</A></li>
        <LI>Next message (by thread): <A HREF="010551.html">[squid-users] Fwd: Mark outgoing connection mark same as client	side mark
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10549">[ date ]</a>
              <a href="thread.html#10549">[ thread ]</a>
              <a href="subject.html#10549">[ subject ]</a>
              <a href="author.html#10549">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/05/2016 8:19 p.m., Deniz Eren wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> In my system I am using netfilter marks to shape traffic(SNAT, QoS,
</I>&gt;<i> etc.) however when I redirect traffic to Squid using Tproxy I lose the
</I>&gt;<i> mark value(obviously).
</I>
Not obvious at all. The MARK vaue is available to Squid, and if
configured to look it up Squid should be doing so.

&gt;<i> I saw configuration directive qos_flow but it's
</I>&gt;<i> only applicable for incoming connections( some website -&gt; squid -&gt;
</I>&gt;<i> client PC), what I need is the opposite one I want to pass mark of
</I>&gt;<i> outgoing connections( client PC -&gt; squid -&gt; some website ). I want to
</I>&gt;<i> mark packet in mangle PREROUTING and then redirect packet to TPROXY
</I>&gt;<i> and after packets coming out of squid I want to use the same mark in
</I>&gt;<i> mangle OUTPUT or POSTROUTING chains. Is there a way to do that?
</I>&gt;<i> 
</I>
tcp_outgoing_mark or qos_flows mark.

The problem you will find however is that HTTP is both stateless and
multiplexing. One incoming request may generate zero or several outgoing
requests. The outbound connection may also be shared by several requests
with differnet incoming connection MARK values.

So you need to design your system not to rely on an outbound connection
existing, and to handle MARK being changed mid-connection.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010544.html">[squid-users] Mark outgoing connection mark same as client side mark
</A></li>
	<LI>Next message (by thread): <A HREF="010551.html">[squid-users] Fwd: Mark outgoing connection mark same as client	side mark
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10549">[ date ]</a>
              <a href="thread.html#10549">[ thread ]</a>
              <a href="subject.html#10549">[ subject ]</a>
              <a href="author.html#10549">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
