<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and AD =&gt; That' s don't work !
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20AD%20%3D%3E%20That%27%20s%20don%27t%20work%20%21&In-Reply-To=%3Cvmime.57331f52.2fe4.7bbe6f3e13794f72%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010545.html">
   <LINK REL="Next"  HREF="010544.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and AD =&gt; That' s don't work !</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20AD%20%3D%3E%20That%27%20s%20don%27t%20work%20%21&In-Reply-To=%3Cvmime.57331f52.2fe4.7bbe6f3e13794f72%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Squid and AD =&gt; That' s don't work !">belle at bazuin.nl
       </A><BR>
    <I>Wed May 11 12:02:26 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010545.html">[squid-users] Squid and AD =&gt; That' s don't work !
</A></li>
        <LI>Next message (by thread): <A HREF="010544.html">[squid-users] Mark outgoing connection mark same as client side mark
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10550">[ date ]</a>
              <a href="thread.html#10550">[ thread ]</a>
              <a href="subject.html#10550">[ subject ]</a>
              <a href="author.html#10550">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, well. Its not only the squid conf you need, so here is what you need in total. 

https, yes works to, but im dont use sslbump etc. 

&#160;

below is all based on debian packages 0 source installs are used. 

( if you need squid 3.5.19 in debian jessie amd64 i can share them to, ssl is enabled in my build ) 

Read through is, see what you can use, and mail if you dont get it. 

&#160;

Below works as of debian 3.4.8 up to 3.5.19 ( tested ) 

&#160;

Squid: 

This is what i have in the auth lines : 

&#160;

auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth \

&#160;&#160;&#160; --kerberos /usr/lib/squid/negotiate_kerberos_auth -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy1.internal.domain.tld at REALM</A> \

&#160;&#160;&#160; --ntlm /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --domain=NTDOMAIN

&#160;

auth_param negotiate children 50 startup=10 idle=1

auth_param negotiate keep_alive on 

&#160;

auth_param basic program /usr/lib/squid/basic_ldap_auth -R -v 3 \

&#160;&#160;&#160; -b &quot;ou=Company,dc=internal,dc=domain,dc=tld&quot; \

&#160;&#160;&#160; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ldap-bind at internal.domain.tld</A> \

&#160;&#160;&#160; -W /etc/squid/private/ldap-bind \

&#160;&#160;&#160; -f sAMAccountName=%s \

&#160;&#160;&#160; -H <A HREF="ldaps://ad-dc2.internal.domain.tld">ldaps://ad-dc2.internal.domain.tld</A> \

&#160;&#160;&#160; -H <A HREF="ldaps://ad-dc1.internal.domain.tld">ldaps://ad-dc1.internal.domain.tld</A>

&#160;

auth_param basic children 5 startup=5 idle=1

auth_param basic realm Internet Proxy Auth

auth_param basic credentialsttl 2 hours

&#160;

&#160;

The samba smb.conf im using with it. 

About samba, last update is a complex one, you must configure this correctly for samba and ldap. 

I&#8217;ll explain that below. 

&#160;

[global]

&#160;&#160;&#160; workgroup = NTDOMAIN

&#160;&#160;&#160; security = ads

&#160;&#160;&#160; realm = REALM

&#160;

&#160;&#160;&#160; netbios name = PROXY

&#160;&#160;&#160; preferred master = no

&#160;&#160;&#160; domain master = no

&#160;&#160;&#160; host msdfs = no

&#160;

&#160;&#160;&#160; dns proxy = yes

&#160;

&#160;&#160;&#160; server signing = mandatory

&#160;&#160;&#160; ntlm auth = no

&#160;

&#160;&#160;&#160; #Add and Update TLS Key

&#160;&#160;&#160; tls enabled = yes

&#160;&#160;&#160; tls keyfile = /etc/ssl/local/private/proxy.key.pem

&#160;&#160;&#160; tls certfile = /etc/ssl/local/certs/proxy.cert.pem

&#160;&#160;&#160; tls cafile = /etc/ssl/certs/personal-ca.pem

&#160;

&#160;&#160;&#160; ## map id's outside to domain to tdb files.

&#160;&#160;&#160; idmap config *:backend = tdb

&#160;&#160;&#160; idmap config *:range = 2000-9999

&#160;

&#160;&#160;&#160; ## map ids from the domain&#160; the range may not overlap !

&#160;&#160;&#160; idmap config NTDOMAIN : backend = ad

&#160;&#160;&#160; idmap config NTDOMAIN : schema_mode = rfc2307

&#160;&#160;&#160; idmap config NTDOMAIN : range = 10000-3999999

&#160;

&#160;&#160;&#160; dedicated keytab file = /etc/krb5.keytab

&#160;&#160;&#160; kerberos method = secrets and keytab

&#160;

&#160;&#160;&#160; # renew the kerberos ticket

&#160;&#160;&#160; winbind refresh tickets = yes

&#160;

&#160;&#160;&#160; # Use home directory and shell information from AD

&#160;&#160;&#160; winbind nss info = rfc2307

&#160;

&#160;&#160;&#160; winbind trusted domains only = no

&#160;&#160;&#160; winbind use default domain = yes

&#160;

&#160;&#160;&#160; winbind enum users&#160; = yes

&#160;&#160;&#160; winbind enum groups = yes

&#160;

&#160;&#160;&#160; # enable offline logins

&#160;&#160;&#160; winbind offline logon = yes

&#160;

&#160;&#160;&#160; # check depth of nested groups, ! slows down you samba, if to much groups depth

&#160;&#160;&#160; winbind expand groups = 4

&#160;

&#160;&#160;&#160; # disable usershares creating, when set empty no error log messages.

&#160;&#160;&#160; usershare path =

&#160;

&#160;&#160;&#160; # Disable printing completely

&#160;&#160;&#160; load printers = no

&#160;&#160;&#160; printing = bsd

&#160;&#160;&#160; printcap name = /dev/null

&#160;&#160;&#160; disable spoolss = yes

&#160;

the krb5.conf for this: 

[libdefaults]

&#160;&#160;&#160; default_realm = REALM

&#160;&#160;&#160; dns_lookup_kdc = true

&#160;&#160;&#160; dns_lookup_realm = false

&#160;&#160;&#160; ticket_lifetime = 24h

&#160;&#160;&#160; ccache_type = 4

&#160;

; for Windows 2003

;&#160;&#160;&#160; default_tgs_enctypes = rc4-hmac des-cbc-crc des-cbc-md5

;&#160;&#160;&#160; default_tkt_enctypes = rc4-hmac des-cbc-crc des-cbc-md5

;&#160;&#160;&#160; permitted_enctypes = rc4-hmac des-cbc-crc des-cbc-md5

&#160;

; for Windows 2008 with AES

;&#160;&#160;&#160; default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5

; &#160;&#160;&#160;default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5

;&#160;&#160;&#160; permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5

&#160;

&#160;

For /etc/ldap/ldap.conf ( client conf )

&#160;

A &#8220;correcty&#8221; ca-root and client certs setup. Needed for samba and ldap clients 

&#160;

Add in /etc/ldap/ldap.conf ( minimal )

TLS_CACERT&#160;&#160;&#160;&#160;&#160; /etc/ssl/certs/ca-certificates.crt

TLS_REQCERT allow

&#160;

Setup your own &quot;rootCA&quot; like this.

&#160;

( if not done, apt-get install ca-certificates )

&#160;

&#160;

&#160;

mkdir -p /usr/local/share/ca-certificates/yourCArootFolder 

copy your root CA cert (.crt or it wont be detected) &#160;in /usr/local/share/ca-certificates/yourCArootFolder 

run : update-ca-certificates

&#160;

! MUST BE /usr/local/share/ca-certificates else its not picked up with the update-ca-certificates command.

&#160;

you should see:

update-ca-certificates

Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.

Running hooks in /etc/ca-certificates/update.d....done.

&#160;

&#160;

Now after done above your CA Cert is hashed in /etc/ssl/certs

And its added in /etc/ssl/certs/ca-certificates.crt

&#160;

For windows, now setup a GPO to deploy the rootCa to your pc's and your good to go. 

How : 

<A HREF="https://technet.microsoft.com/nl-nl/library/cc770315(v=ws.10">https://technet.microsoft.com/nl-nl/library/cc770315(v=ws.10</A>).aspx 

&#160;

This folder : /etc/ssl/local is adviced for your personal certificates. 

Try to avoid mixing personal/(un)official certificates in /etc/ssl/certs.

&#160;

So create a folders 

/etc/ssl/local/certs

/etc/ssl/local/private

Much easier to maintain this way. 

&#160;

&#160;

Some advice on samba/winbind. 

&#160;

Above only needs winbind installed and i do advice 4.4.3 recompile it from debian SID.

Of if your on debian jessie amd64, you can use my deb files. 

Found here &#160;<A HREF="http://downloads.van-belle.nl/samba4/">http://downloads.van-belle.nl/samba4/</A>

Please do read the README.txt 

&#160;

&#160;

Greetz, 

&#160;

Louis

&#160;

&#160;


Van: Olivier CALVANO [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">o.calvano at gmail.com</A>] 
Verzonden: woensdag 11 mei 2016 13:34
Aan: L.P.H. van Belle
Onderwerp: Re: [squid-users] Squid and AD =&gt; That' s don't work !


&#160;

Hi

&#160;


thanks for your answer.&#160;


Https work too ?


&#160;


because before we use 3.3.8 but NTLM/Kerberos&#160;walking randomly, that's work very good 1 or 2 days but after


a lot of user can't connect.


&#160;


We update in 3.5.x and now, all https don't work :&lt;


&#160;


can you help me ? if you have a sample of your squid.conf


&#160;


regards


olivier



&#160;

2016-05-11 10:23 GMT+02:00 L.P.H. van Belle &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">belle at bazuin.nl</A>&gt;:

Yes and it works great. 

&#160;

My setup Debian Jessie,

Squid tested : 3.4.8 upto 3.5.19 

I use kerberos and ntlm and ldap auto in that order. 

&#160;

Samba 4.4.3 AD DC

&#160;

So what do you want to know? 

&#160;

Greetz, 

&#160;

Louis

&#160;

&#160;


Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Olivier CALVANO
Verzonden: woensdag 11 mei 2016 10:08
Aan: Squid Users
Onderwerp: [squid-users] Squid and AD =&gt; That' s don't work !


&#160;

Hi


&#160;


is that someone has actually used squid with ntlm AD authentication?


because it don't works really well and no there is no one who reponds to problems, it's a shame.


&#160;


there is commercial support a squid?


&#160;


Regards


Olivier









_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


&#160;



-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160511/9f84d7b8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160511/9f84d7b8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010545.html">[squid-users] Squid and AD =&gt; That' s don't work !
</A></li>
	<LI>Next message (by thread): <A HREF="010544.html">[squid-users] Mark outgoing connection mark same as client side mark
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10550">[ date ]</a>
              <a href="thread.html#10550">[ thread ]</a>
              <a href="subject.html#10550">[ subject ]</a>
              <a href="author.html#10550">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
