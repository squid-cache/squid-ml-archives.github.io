<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20configuring%20Squid%20with%0A%20C-ICAP%2BSquidclamav%20%28SOLVED%29&In-Reply-To=%3C20160512084239.GB5002%40beagle.bcn.sia.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010559.html">
   <LINK REL="Next"  HREF="010571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)</H1>
    <B>C. L. Martinez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20configuring%20Squid%20with%0A%20C-ICAP%2BSquidclamav%20%28SOLVED%29&In-Reply-To=%3C20160512084239.GB5002%40beagle.bcn.sia.es%3E"
       TITLE="[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)">carlopmart at gmail.com
       </A><BR>
    <I>Thu May 12 08:42:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010559.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav
</A></li>
        <LI>Next message (by thread): <A HREF="010571.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10570">[ date ]</a>
              <a href="thread.html#10570">[ thread ]</a>
              <a href="subject.html#10570">[ subject ]</a>
              <a href="author.html#10570">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed 11.May'16 at 21:14:08 +0600, Yuri Voinov wrote:
&gt;<i> 
</I>&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA256
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 11.05.16 21:04, L.P.H. van Belle &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hai,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I reviewd your config, thing whats different in c-icap.conf compared
</I>&gt;<i> to me.
</I>&gt;<i> &gt;
</I>&gt;<i> Obviously, the mindless copying and pasting the config - very bad
</I>&gt;<i> practice, is not it?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; RemoteProxyUsers off ( for you ) on for me.
</I>&gt;<i> &gt;
</I>&gt;<i> # TAG: RemoteProxyUsers
</I>&gt;<i> # Format: RemoteProxyUsers onoff
</I>&gt;<i> # Description:
</I>&gt;<i> #    Set it to on if you want to use username provided by the proxy server.
</I>&gt;<i> #    This is the recomended way to use users in c-icap.
</I>&gt;<i> #    If the RemoteProxyUsers is off and c-icap configured to use users or
</I>&gt;<i> #    groups the internal authentication mechanism will be used.
</I>&gt;<i> # Default:
</I>&gt;<i> #    RemoteProxyUsers off
</I>&gt;<i> RemoteProxyUsers off
</I>&gt;<i> 
</I>&gt;<i> This is depending proxy configuration. And irrelevant current case.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Whats the content of /etc/c-icap/squidclamav.conf ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The important part for me of the file :
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #clamd_local /var/run/clamd.socket ! change/check this
</I>&gt;<i> &gt;
</I>&gt;<i> This is OS-dependent, as obvious.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; clamd_ip 127.0.0.1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; clamd_port 3310
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If you use socket make sure your rights are correct and icap is added
</I>&gt;<i> to the clamav group.
</I>&gt;<i> &gt;
</I>&gt;<i> Wrong. Squid group, not clamav.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And my c-icap part of the squid.conf
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ## Tested with Squid 3.4.8 and 3.5.x + squidclamav 6.14 and 6.15
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_enable on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_send_client_ip on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_send_client_username on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_client_username_header X-Authenticated-User
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_persistent_connections on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_preview_enable on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_preview_size 1024
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_service service_req reqmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; adaptation_access service_req allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_service service_resp respmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; adaptation_access service_resp allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think you changed to much in the example.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Im reffering to these in the squid.conf
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; adaptation_access service_avi_resp allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; service_avi_resp?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;
</I>&gt;<i> Complete squid.conf fragment:
</I>&gt;<i> 
</I>&gt;<i> icap_service service_avi_req reqmod_precache
</I>&gt;<i> <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
</I>&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;<i> <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on
</I>&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;<i> 
</I>&gt;<i> Please, PLEASE, do not make recommendation when you not understand what
</I>&gt;<i> does config lines means!
</I>&gt;<i>  
</I>
Ok, problem is solved. Seems there is some problem between squid and my unbound DNS server. Changing the following lines:

icap_service service_avi_req reqmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
icap_service service_avi_resp respmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on

to:

icap_service service_avi_req reqmod_precache <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> bypass=off
icap_service service_avi_resp respmod_precache <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> bypass=on

all works as expected. As you can see I have changed &quot;localhost&quot; for &quot;127.0.0.1&quot; ... localhost entry exists inside my /etc/hosts file, and OpenBSD resolves correctly, but under unbound's config I have enabled &quot;do-not-query-localhost: no&quot; because unbound is configured to work with dnscrypt-proxy service...

I am not sure about this, but it is the only answer that explains this problem ... or it is a bug (but I don't think so).

What do you think??


-- 
Greetings,
C. L. Martinez

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010559.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav
</A></li>
	<LI>Next message (by thread): <A HREF="010571.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10570">[ date ]</a>
              <a href="thread.html#10570">[ thread ]</a>
              <a href="subject.html#10570">[ subject ]</a>
              <a href="author.html#10570">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
