<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20configuring%20Squid%20with%0A%20C-ICAP%2BSquidclamav%20%28SOLVED%29&In-Reply-To=%3Cb19cbee9-41ce-b25a-59d5-0c856f832acb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010570.html">
   <LINK REL="Next"  HREF="010573.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20configuring%20Squid%20with%0A%20C-ICAP%2BSquidclamav%20%28SOLVED%29&In-Reply-To=%3Cb19cbee9-41ce-b25a-59d5-0c856f832acb%40treenet.co.nz%3E"
       TITLE="[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May 12 10:20:47 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010570.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
        <LI>Next message (by thread): <A HREF="010573.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10571">[ date ]</a>
              <a href="thread.html#10571">[ thread ]</a>
              <a href="subject.html#10571">[ subject ]</a>
              <a href="author.html#10571">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/05/2016 8:42 p.m., C. L. Martinez wrote:
&gt;<i> On Wed 11.May'16 at 21:14:08 +0600, Yuri Voinov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;&gt;<i> Hash: SHA256
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 11.05.16 21:04, L.P.H. van Belle &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hai,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I reviewd your config, thing whats different in c-icap.conf compared
</I>&gt;&gt;<i> to me.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Obviously, the mindless copying and pasting the config - very bad
</I>&gt;&gt;<i> practice, is not it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> RemoteProxyUsers off ( for you ) on for me.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> # TAG: RemoteProxyUsers
</I>&gt;&gt;<i> # Format: RemoteProxyUsers onoff
</I>&gt;&gt;<i> # Description:
</I>&gt;&gt;<i> #    Set it to on if you want to use username provided by the proxy server.
</I>&gt;&gt;<i> #    This is the recomended way to use users in c-icap.
</I>&gt;&gt;<i> #    If the RemoteProxyUsers is off and c-icap configured to use users or
</I>&gt;&gt;<i> #    groups the internal authentication mechanism will be used.
</I>&gt;&gt;<i> # Default:
</I>&gt;&gt;<i> #    RemoteProxyUsers off
</I>&gt;&gt;<i> RemoteProxyUsers off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is depending proxy configuration. And irrelevant current case.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Whats the content of /etc/c-icap/squidclamav.conf ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The important part for me of the file :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #clamd_local /var/run/clamd.socket ! change/check this
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> This is OS-dependent, as obvious.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> clamd_ip 127.0.0.1
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> clamd_port 3310
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If you use socket make sure your rights are correct and icap is added
</I>&gt;&gt;<i> to the clamav group.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Wrong. Squid group, not clamav.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And my c-icap part of the squid.conf
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ## Tested with Squid 3.4.8 and 3.5.x + squidclamav 6.14 and 6.15
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_enable on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_send_client_ip on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_send_client_username on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_persistent_connections on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_preview_size 1024
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_service service_req reqmod_precache bypass=1
</I>&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> adaptation_access service_req allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_service service_resp respmod_precache bypass=1
</I>&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> adaptation_access service_resp allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think you changed to much in the example.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Im reffering to these in the squid.conf
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> service_avi_resp?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Complete squid.conf fragment:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> icap_service service_avi_req reqmod_precache
</I>&gt;&gt;<i> <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
</I>&gt;&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;&gt;<i> <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on
</I>&gt;&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please, PLEASE, do not make recommendation when you not understand what
</I>&gt;&gt;<i> does config lines means!
</I>&gt;&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Ok, problem is solved. Seems there is some problem between squid and my unbound DNS server. Changing the following lines:
</I>&gt;<i> 
</I>&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
</I>&gt;<i> icap_service service_avi_resp respmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on
</I>&gt;<i> 
</I>&gt;<i> to:
</I>&gt;<i> 
</I>&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> bypass=off
</I>&gt;<i> icap_service service_avi_resp respmod_precache <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> bypass=on
</I>&gt;<i> 
</I>&gt;<i> all works as expected. As you can see I have changed &quot;localhost&quot; for &quot;127.0.0.1&quot; ... localhost entry exists inside my /etc/hosts file, and OpenBSD resolves correctly, but under unbound's config I have enabled &quot;do-not-query-localhost: no&quot; because unbound is configured to work with dnscrypt-proxy service...
</I>&gt;<i> 
</I>&gt;<i> I am not sure about this, but it is the only answer that explains this problem ... or it is a bug (but I don't think so).
</I>&gt;<i> 
</I>&gt;<i> What do you think??
</I>&gt;<i> 
</I>
I think that Squid told you it was sending an OPTIONS request to ICAP
service, which failed. So it marked the service down. The service was
not allowed to be bypassed (bypass=off), so cannot cope with being down.

It is possible &quot;localhost&quot; had to be resolved to do that OPTIONS
request. However, if as you say it already has an entry in your
/etc/hosts file then Squid should have loaded that entry as a permanent
record and never be looking it up in DNS.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010570.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
	<LI>Next message (by thread): <A HREF="010573.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10571">[ date ]</a>
              <a href="thread.html#10571">[ thread ]</a>
              <a href="subject.html#10571">[ subject ]</a>
              <a href="author.html#10571">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
