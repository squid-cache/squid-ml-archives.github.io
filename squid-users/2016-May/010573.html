<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20configuring%20Squid%20with%0A%20C-ICAP%2BSquidclamav%20%28SOLVED%29&In-Reply-To=%3C20160512111318.GA18713%40beagle.bcn.sia.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010571.html">
   <LINK REL="Next"  HREF="010574.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)</H1>
    <B>C. L. Martinez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20configuring%20Squid%20with%0A%20C-ICAP%2BSquidclamav%20%28SOLVED%29&In-Reply-To=%3C20160512111318.GA18713%40beagle.bcn.sia.es%3E"
       TITLE="[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)">carlopmart at gmail.com
       </A><BR>
    <I>Thu May 12 11:13:44 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010571.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
        <LI>Next message (by thread): <A HREF="010574.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10573">[ date ]</a>
              <a href="thread.html#10573">[ thread ]</a>
              <a href="subject.html#10573">[ subject ]</a>
              <a href="author.html#10573">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu 12.May'16 at 22:20:47 +1200, Amos Jeffries wrote:
&gt;<i> On 12/05/2016 8:42 p.m., C. L. Martinez wrote:
</I>&gt;<i> &gt; On Wed 11.May'16 at 21:14:08 +0600, Yuri Voinov wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> &gt;&gt; Hash: SHA256
</I>&gt;<i> &gt;&gt;  
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; 11.05.16 21:04, L.P.H. van Belle &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Hai,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I reviewd your config, thing whats different in c-icap.conf compared
</I>&gt;<i> &gt;&gt; to me.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; Obviously, the mindless copying and pasting the config - very bad
</I>&gt;<i> &gt;&gt; practice, is not it?
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; RemoteProxyUsers off ( for you ) on for me.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; # TAG: RemoteProxyUsers
</I>&gt;<i> &gt;&gt; # Format: RemoteProxyUsers onoff
</I>&gt;<i> &gt;&gt; # Description:
</I>&gt;<i> &gt;&gt; #    Set it to on if you want to use username provided by the proxy server.
</I>&gt;<i> &gt;&gt; #    This is the recomended way to use users in c-icap.
</I>&gt;<i> &gt;&gt; #    If the RemoteProxyUsers is off and c-icap configured to use users or
</I>&gt;<i> &gt;&gt; #    groups the internal authentication mechanism will be used.
</I>&gt;<i> &gt;&gt; # Default:
</I>&gt;<i> &gt;&gt; #    RemoteProxyUsers off
</I>&gt;<i> &gt;&gt; RemoteProxyUsers off
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This is depending proxy configuration. And irrelevant current case.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Whats the content of /etc/c-icap/squidclamav.conf ?
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; The important part for me of the file :
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; #clamd_local /var/run/clamd.socket ! change/check this
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; This is OS-dependent, as obvious.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; clamd_ip 127.0.0.1
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; clamd_port 3310
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; If you use socket make sure your rights are correct and icap is added
</I>&gt;<i> &gt;&gt; to the clamav group.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; Wrong. Squid group, not clamav.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; And my c-icap part of the squid.conf
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ## Tested with Squid 3.4.8 and 3.5.x + squidclamav 6.14 and 6.15
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_enable on
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_send_client_ip on
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_send_client_username on
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_client_username_header X-Authenticated-User
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_persistent_connections on
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_preview_enable on
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_preview_size 1024
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_service service_req reqmod_precache bypass=1
</I>&gt;<i> &gt;&gt; <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; adaptation_access service_req allow all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; icap_service service_resp respmod_precache bypass=1
</I>&gt;<i> &gt;&gt; <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; adaptation_access service_resp allow all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I think you changed to much in the example.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Im reffering to these in the squid.conf
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; adaptation_access service_avi_resp allow all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; service_avi_resp?
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; Complete squid.conf fragment:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; icap_service service_avi_req reqmod_precache
</I>&gt;<i> &gt;&gt; <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
</I>&gt;<i> &gt;&gt; adaptation_access service_avi_req allow all
</I>&gt;<i> &gt;&gt; icap_service service_avi_resp respmod_precache
</I>&gt;<i> &gt;&gt; <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on
</I>&gt;<i> &gt;&gt; adaptation_access service_avi_resp allow all
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Please, PLEASE, do not make recommendation when you not understand what
</I>&gt;<i> &gt;&gt; does config lines means!
</I>&gt;<i> &gt;&gt;  
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Ok, problem is solved. Seems there is some problem between squid and my unbound DNS server. Changing the following lines:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; icap_service service_avi_req reqmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
</I>&gt;<i> &gt; icap_service service_avi_resp respmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; to:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; icap_service service_avi_req reqmod_precache <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> bypass=off
</I>&gt;<i> &gt; icap_service service_avi_resp respmod_precache <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A> bypass=on
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; all works as expected. As you can see I have changed &quot;localhost&quot; for &quot;127.0.0.1&quot; ... localhost entry exists inside my /etc/hosts file, and OpenBSD resolves correctly, but under unbound's config I have enabled &quot;do-not-query-localhost: no&quot; because unbound is configured to work with dnscrypt-proxy service...
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I am not sure about this, but it is the only answer that explains this problem ... or it is a bug (but I don't think so).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; What do you think??
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> I think that Squid told you it was sending an OPTIONS request to ICAP
</I>&gt;<i> service, which failed. So it marked the service down. The service was
</I>&gt;<i> not allowed to be bypassed (bypass=off), so cannot cope with being down.
</I>&gt;<i> 
</I>&gt;<i> It is possible &quot;localhost&quot; had to be resolved to do that OPTIONS
</I>&gt;<i> request. However, if as you say it already has an entry in your
</I>&gt;<i> /etc/hosts file then Squid should have loaded that entry as a permanent
</I>&gt;<i> record and never be looking it up in DNS.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>
But when squid sents an OPTIONS request to ICAP, why works when I use 127.0.0.1 and not localhost?? Maybe it is a problem with openbsd's package ...

-- 
Greetings,
C. L. Martinez

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010571.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
	<LI>Next message (by thread): <A HREF="010574.html">[squid-users] Problems configuring Squid with C-ICAP+Squidclamav (SOLVED)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10573">[ date ]</a>
              <a href="thread.html#10573">[ thread ]</a>
              <a href="subject.html#10573">[ subject ]</a>
              <a href="author.html#10573">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
