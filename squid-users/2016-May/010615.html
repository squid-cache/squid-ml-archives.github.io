<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Regular expressions with dstdom_regex ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Regular%20expressions%20with%20dstdom_regex%20ACL&In-Reply-To=%3C1a7027ad-dfe8-9363-3e0e-e494e2d0200c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010610.html">
   <LINK REL="Next"  HREF="010601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Regular expressions with dstdom_regex ACL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Regular%20expressions%20with%20dstdom_regex%20ACL&In-Reply-To=%3C1a7027ad-dfe8-9363-3e0e-e494e2d0200c%40treenet.co.nz%3E"
       TITLE="[squid-users] Regular expressions with dstdom_regex ACL">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 13 11:46:53 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010610.html">[squid-users] Regular expressions with dstdom_regex ACL
</A></li>
        <LI>Next message (by thread): <A HREF="010601.html">[squid-users] ACL is used in context without an HTTP response.	Assuming mismatch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10615">[ date ]</a>
              <a href="thread.html#10615">[ thread ]</a>
              <a href="subject.html#10615">[ subject ]</a>
              <a href="author.html#10615">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/05/2016 8:22 p.m., Walter H. wrote:
&gt;<i> On Fri, May 13, 2016 07:32, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 13/05/2016 3:44 p.m., Walter H. wrote:
</I>&gt;&gt;&gt;<i> p.s.
</I>&gt;&gt;&gt;<i> the sample here
</I>&gt;&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Chat/Skype">http://wiki.squid-cache.org/ConfigExamples/Chat/Skype</A>
</I>&gt;&gt;&gt;<i> doesn't work, too
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The skype pattern is matching the port Skype uses. You need to drop that
</I>&gt;&gt;<i> off the pattern. But it should match if you use just the raw-IP part.
</I>&gt;<i> 
</I>&gt;<i> it is somewhat weired, because
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:3:1::c5a5:8590">http://[2a00:1a68:3:1::c5a5:8590</A>]/
</I>&gt;<i> isn't blocked and the following are
</I>&gt;<i> all blocked as they should:
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:3::c5a5:8590">http://[2a00:1a68:3::c5a5:8590</A>]/
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:3:1::c5a:8590">http://[2a00:1a68:3:1::c5a:8590</A>]/
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:3:1::c5a5:859">http://[2a00:1a68:3:1::c5a5:859</A>]/
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:2:1::c5a5:8590">http://[2a00:1a68:2:1::c5a5:8590</A>]/
</I>&gt;<i> 
</I>&gt;<i> here this part in access.log
</I>&gt;<i> 
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:44:10 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://[2a00:1a68:2:1::c5a5:8590">http://[2a00:1a68:2:1::c5a5:8590</A>]/ HTTP/1.0&quot; 403 1578
</I>&gt;<i> &quot;-&quot; &quot;Wget/1.12 (linux-gnu)&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:46:53 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://[2a00:1a68:3:1::c5a5:8590">http://[2a00:1a68:3:1::c5a5:8590</A>]/ HTTP/1.0&quot; 301 590 &quot;
</I>&gt;<i> -&quot; &quot;Wget/1.12 (linux-gnu)&quot; TCP_MISS:HIER_DIRECT
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:46:54 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://mathemainzel.info/">http://mathemainzel.info/</A> HTTP/1.0&quot; 200 2662 &quot;-&quot; &quot;Wget
</I>&gt;<i> /1.12 (linux-gnu)&quot; TCP_MISS:HIER_DIRECT
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:47:03 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://[2a00:1a68:2:1::c5a5:8590">http://[2a00:1a68:2:1::c5a5:8590</A>]/ HTTP/1.0&quot; 403 1578
</I>&gt;<i> &quot;-&quot; &quot;Wget/1.12 (linux-gnu)&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:47:14 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://[2a00:1a68:3::c5a5:8590">http://[2a00:1a68:3::c5a5:8590</A>]/ HTTP/1.0&quot; 403 1574 &quot;-
</I>&gt;<i> &quot; &quot;Wget/1.12 (linux-gnu)&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:47:37 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://[2a00:1a68:3:1::c5a:8590">http://[2a00:1a68:3:1::c5a:8590</A>]/ HTTP/1.0&quot; 403 1576 &quot;
</I>&gt;<i> -&quot; &quot;Wget/1.12 (linux-gnu)&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> parentproxy.local - - [13/May/2016:09:47:45 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://[2a00:1a68:3:1::c5a5:859">http://[2a00:1a68:3:1::c5a5:859</A>]/ HTTP/1.0&quot; 403 1576 &quot;
</I>&gt;<i> -&quot; &quot;Wget/1.12 (linux-gnu)&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> 
</I>&gt;<i> here the ACL
</I>&gt;<i> 
</I>&gt;<i> acl block_domains_iphost dstdom_regex &quot;/etc/squid/iphost-acl.squid&quot;
</I>&gt;<i> deny_info ERR_DOMAIN_IPHOST_BLOCKED block_domains_iphost
</I>&gt;<i> http_access deny block_domains_iphost
</I>&gt;<i> 
</I>&gt;<i> and iphost-acl.squid has the following content:
</I>&gt;<i> 
</I>&gt;<i> ^[12]?[0-9]{1,2}\.[12]?[0-9]{1,2}\.[12]?[0-9]{1,2}\.[12]?[0-9]{1,2}$
</I>&gt;<i> ^\[([0-9a-f]{0,4})(:|[0-9a-f]{0,4}){1,7}\]$
</I>&gt;<i> ^\[::1\]$
</I>&gt;<i> ^\[.*\]$
</I>&gt;<i> ^([0-9a-f]{0,4})(:|[0-9a-f]{0,4}){1,7}$
</I>&gt;<i> ^::1$
</I>&gt;<i> ^.*$
</I>
This last pattern overlaps with all the previous ones and any possible
following as well. Squid takes short patterns and merges them in to one
pattern if it can to pass to that optimizer. They might all just be
optimized away by the regex compile step.

Your block_domains_iphost should thus be an alias for &quot;all&quot;.

&gt;<i> 
</I>&gt;<i> some part above I have this in squid.conf
</I>&gt;<i> 
</I>&gt;<i> acl allow_domains dstdom_regex &quot;/etc/squid/domain_regex-acl.squid&quot;
</I>&gt;<i> http_access allow allow_domains
</I>&gt;<i> 
</I>&gt;<i> and domain_regex-acl.squid has the following content:
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> \.mathemainzel\.info$
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> what is this mystic, that
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:3:1::c5a5:8590">http://[2a00:1a68:3:1::c5a5:8590</A>]/
</I>&gt;<i> isn't blocked, even it should ...
</I>&gt;<i> 
</I>&gt;<i> by the way  wget <A HREF="http://81.19.145.52/">http://81.19.145.52/</A> is blocked as you see in the log
</I>&gt;<i> 
</I>&gt;<i> parentproxy.local - - [13/May/2016:10:12:53 +0200] &quot;GET
</I>&gt;<i> <A HREF="http://81.19.145.52/">http://81.19.145.52/</A> HTTP/1.0&quot; 403 1550 &quot;-&quot; &quot;Wget/1.12 (li
</I>&gt;<i> nux-gnu)&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> 
</I>&gt;<i> just as an experiment, if I remove this one entry of domain_regex-acl.squid
</I>&gt;<i> then
</I>&gt;<i> wget <A HREF="http://[2a00:1a68:3:1::c5a5:8590">http://[2a00:1a68:3:1::c5a5:8590</A>]/
</I>&gt;<i> is blocked, why not with this entry?
</I>
Nobody can answer that question without actually seeing your whole
squid.conf http_access set and all ACLs used there.

You are correct in that those regex patterns should match the domains an
URLs passed to the proxy. But we have no way to know if those particular
lines are even relevant / reachable when processing those requests.
 Since these ACL types are very old and well tested logic. I suggest
that they are probably not.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010610.html">[squid-users] Regular expressions with dstdom_regex ACL
</A></li>
	<LI>Next message (by thread): <A HREF="010601.html">[squid-users] ACL is used in context without an HTTP response.	Assuming mismatch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10615">[ date ]</a>
              <a href="thread.html#10615">[ thread ]</a>
              <a href="subject.html#10615">[ subject ]</a>
              <a href="author.html#10615">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
