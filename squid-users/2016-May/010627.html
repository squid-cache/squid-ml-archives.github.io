<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] authenticate_ip_ttl does not work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20authenticate_ip_ttl%20does%20not%20work&In-Reply-To=%3Cf577d0b7-d115-6271-c69f-25d03d18042f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010619.html">
   <LINK REL="Next"  HREF="010622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] authenticate_ip_ttl does not work</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20authenticate_ip_ttl%20does%20not%20work&In-Reply-To=%3Cf577d0b7-d115-6271-c69f-25d03d18042f%40treenet.co.nz%3E"
       TITLE="[squid-users] authenticate_ip_ttl does not work">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 13 14:31:27 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010619.html">[squid-users] authenticate_ip_ttl does not work
</A></li>
        <LI>Next message (by thread): <A HREF="010622.html">[squid-users] Squid: Caching Google Drive Files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10627">[ date ]</a>
              <a href="thread.html#10627">[ thread ]</a>
              <a href="subject.html#10627">[ subject ]</a>
              <a href="author.html#10627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/05/2016 12:26 a.m., <A HREF="https://lists.squid-cache.org/listinfo/squid-users">asakura at ioc.dnp.co.jp</A> wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> Thank you always for your kind support.
</I>&gt;<i> 
</I>&gt;<i> I testing squid-3.5.19 &quot;max_user_ip/authenticate_ip_ttl&quot; feature.
</I>&gt;<i> but, access control not work well.
</I>&gt;<i> (Value of authenticate_ip_ttl is not enable)
</I>&gt;<i> 
</I>&gt;<i> I investigating, and tried to change as follows.
</I>&gt;<i> 
</I>&gt;<i> src/auth/User.cc
</I>&gt;<i> ----
</I>&gt;<i> # diff User.cc.org User.cc
</I>&gt;<i> 287c287
</I>&gt;<i> &lt;             ipdata-&gt;ip_expiretime = squid_curtime;
</I>&gt;<i> ---
</I>&gt;&gt;<i>             ipdata-&gt;ip_expiretime = squid_curtime + ::Config.authenticateIpTTL;
</I>&gt;<i> ----
</I>&gt;<i> 
</I>&gt;<i> Is this would be correct change?
</I>
No. That particular data cache is one in Squid that works on a very
weird staleness orientation rather than freshness.

Caches that work on freshness behave like one would expect. Things start
out fresh and grow towards some TTL 0 point where the flip to being
stale and can be removed or replaced.

But these weird staleness oriented things start out at some origin point
in time (squid_curtime) and just continue to get more and more stale.
Operations that need to be done on them can use multiple and different
TTL offsets, which change over time (for example on reconfigure) without
affecting the cached objects. It is up to the logic doing that operation
to check the staleness against the right TTL.

You can see this in Auth::User::cacheCleanup() which applies
authenticate_ip_ttl to see what can be erased. Compared to the
Auth::User::absorb() which compares two lists of objects against each
other and drops from one list anything that is not brand new (current
second).

I suspect bugs you are seeing are in that absorb operation since it is
timing-critical and happens with an async delay in the middle of the
list being created and method happening.


If you want to help out with that whole mess there, please discuss
intended changes on squid-dev mailing list where the other dev are sure
to see your proposals.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010619.html">[squid-users] authenticate_ip_ttl does not work
</A></li>
	<LI>Next message (by thread): <A HREF="010622.html">[squid-users] Squid: Caching Google Drive Files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10627">[ date ]</a>
              <a href="thread.html#10627">[ thread ]</a>
              <a href="subject.html#10627">[ subject ]</a>
              <a href="author.html#10627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
