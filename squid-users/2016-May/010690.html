<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Internet%20Browsing%20very%20slow%20after%20implementing%0A%20Squid%20peek%20%26%20splice%20%2B%20Access%20log%20not%20tracing%20full%20URL&In-Reply-To=%3Ccc51a531-9d11-d8cc-17c8-34e06a4105f5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010686.html">
   <LINK REL="Next"  HREF="010694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Internet%20Browsing%20very%20slow%20after%20implementing%0A%20Squid%20peek%20%26%20splice%20%2B%20Access%20log%20not%20tracing%20full%20URL&In-Reply-To=%3Ccc51a531-9d11-d8cc-17c8-34e06a4105f5%40treenet.co.nz%3E"
       TITLE="[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 18 12:39:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010686.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
        <LI>Next message (by thread): <A HREF="010694.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10690">[ date ]</a>
              <a href="thread.html#10690">[ thread ]</a>
              <a href="subject.html#10690">[ subject ]</a>
              <a href="author.html#10690">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/05/2016 11:05 p.m., Sagar Malve wrote:
&gt;<i> Scenario :  I want to block certain HTTPS website using SSL Bump and
</I>&gt;<i> without installing any SSL Certificate on Clients End as I will be
</I>&gt;<i> distributing this Same Network for Mobile Devices so I don't want to keep
</I>&gt;<i> installing certificate in each Mobile Device like Android / IOS / Windows
</I>&gt;<i> etc phones .......
</I>&gt;<i> 
</I>&gt;<i> *I have installed Squid 3.5.13 and we have Broadband Connection with speed
</I>
Please upgrade. 3.5.19 is now the minimum version to use with SSL-Bump
feature. Due to almost a dozen CVE issues fixed recently most of which
are only bad when SSL-Bump is used.


&gt;<i> 50 Mb/sec. I have gone through lots of document where I found that we can
</I>&gt;<i> Block Https Traffic without installing Certificate by enabling Peek &amp;
</I>&gt;<i> Splice feature.*
</I>&gt;<i> 
</I>
Lets be accurate:

* You can *terminate* TLS connections with &quot;ssl_bump terminate&quot; rules.

* You cannot send the client errors or rejection notices unless they
trust the Squid cert generators' CA.


&gt;<i>
</I>&gt;<i> *Also I am not getting full URL for HTTPS Traffic in Access Logs ........*
</I>&gt;<i> We have tried to implement Caching DNS Server (Local) but still it didn't
</I>&gt;<i> work then we have given the Google Public DNS .......
</I>&gt;<i>
</I>&gt;<i> Could you please let us know where we are doing mistake .......
</I>&gt;<i>
</I>
The URL for HTTPS requests is encrypted. Squid cannot get access to even
see what it is without decrypting the connection. Which is the action
that requires the CA be installed on the clients.





&gt;<i> ------------------- Below is the Configuration file of Squid
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> 
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # Access Control Lists
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> acl localnet src 192.168.0.0/24    # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 8443        # Telecom exclusion
</I>&gt;<i> acl Safe_ports port 80        # http
</I>&gt;<i> acl Safe_ports port 21        # ftp
</I>&gt;<i> acl Safe_ports port 443        # https
</I>&gt;<i> acl Safe_ports port 70        # gopher
</I>&gt;<i> acl Safe_ports port 210        # wais
</I>&gt;<i> acl Safe_ports port 280        # http-mgmt
</I>&gt;<i> acl Safe_ports port 488        # gss-http
</I>&gt;<i> acl Safe_ports port 591        # filemaker
</I>&gt;<i> acl Safe_ports port 777        # multiling http
</I>&gt;<i> 
</I>&gt;<i> # Common methods
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl PURGE method PURGE
</I>&gt;<i> acl GET method GET
</I>&gt;<i> 
</I>&gt;<i> # Windows update acls
</I>&gt;<i> acl windowsupdate dstdomain sls.update.microsoft.com.akadns.net
</I>&gt;<i> acl windowsupdate dstdomain windowsupdate.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain .update.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain download.windowsupdate.com
</I>&gt;<i> acl windowsupdate dstdomain redir.metaservices.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain images.metaservices.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain c.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain www.download.windowsupdate.com
</I>&gt;<i> acl windowsupdate dstdomain wustat.windows.com
</I>&gt;<i> acl windowsupdate dstdomain crl.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain sls.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain productactivation.one.microsoft.com
</I>&gt;<i> acl windowsupdate dstdomain ntservicepack.microsoft.com
</I>&gt;<i> 
</I>&gt;<i> # Windows update methods
</I>&gt;<i> acl wuCONNECT dstdomain www.update.microsoft.com
</I>&gt;<i> acl wuCONNECT dstdomain sls.microsoft.com
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # SSL bump acl
</I>&gt;<i> acl net_bump src &quot;/etc/squid/net.bump&quot;
</I>&gt;<i> 
</I>&gt;<i> # TLD acl
</I>&gt;<i> acl block_tld dstdomain &quot;/etc/squid/dstdom.tld&quot;
</I>&gt;<i> 
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # Access parameters
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # Deny requests to unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> # Deny CONNECT to other than SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> # Allow purge from localhost
</I>&gt;<i> http_access allow PURGE localhost
</I>&gt;<i> http_access deny PURGE
</I>&gt;<i> 
</I>&gt;<i> # Normalize Accept-Encoding to support compression via eCAP
</I>&gt;<i> request_header_access Accept-Encoding deny all
</I>&gt;<i> request_header_replace Accept-Encoding gzip;q=1.0, identity;q=0.5, *;q=0
</I>&gt;<i> # Disable alternate protocols
</I>&gt;<i> request_header_access Alternate-Protocol deny all
</I>&gt;<i> reply_header_access Alternate-Protocol deny all
</I>&gt;<i> # Disable HSTS
</I>&gt;<i> reply_header_access Strict-Transport-Security deny all
</I>&gt;<i> reply_header_replace Strict-Transport-Security max-age=0; includeSubDomains
</I>&gt;<i> # Remove User-Agent from Vary
</I>&gt;<i> reply_header_access Vary deny all
</I>&gt;<i> reply_header_replace Vary Accept-Encoding
</I>&gt;<i> # Workaround 4253
</I>&gt;<i> request_header_access Surrogate-Capability deny all
</I>&gt;<i> 
</I>&gt;<i> # Block top level domains
</I>&gt;<i> http_access deny block_tld
</I>&gt;<i> deny_info TCP_RESET block_tld
</I>&gt;<i> 
</I>&gt;<i> # Rule allowing access from local networks
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # ICP/HTCP access
</I>&gt;<i> icp_access allow localnet
</I>&gt;<i> icp_access deny all
</I>&gt;<i> htcp_access allow localnet
</I>&gt;<i> htcp_access deny all
</I>&gt;<i> 
</I>&gt;<i> # 302 loop
</I>&gt;<i> acl text_mime rep_mime_type text/html text/plain
</I>&gt;<i> acl http302 http_status 302
</I>&gt;<i> store_miss deny text_mime http302
</I>&gt;<i> send_hit deny text_mime http302
</I>&gt;<i> 
</I>&gt;<i> # Windows updates rules
</I>&gt;<i> http_access allow CONNECT wuCONNECT localnet
</I>&gt;<i> http_access allow CONNECT wuCONNECT localhost
</I>&gt;<i> http_access allow windowsupdate localnet
</I>&gt;<i> http_access allow windowsupdate localhost
</I>&gt;<i> 
</I>&gt;<i> # SSL bump rules
</I>&gt;<i> acl DiscoverSNIHost at_step SslBump1
</I>&gt;<i> # ICQ/MRA must splice first
</I>&gt;<i> acl NoSSLIntercept ssl::server_name_regex -i &quot;/etc/squid/url.nobump&quot;
</I>
&gt;<i> ssl_bump splice NoSSLIntercept
</I>&gt;<i> ssl_bump bump net_bump
</I>
This will decrypt at step 1 using Squids CA and generated certificate.
*NO* details from the serverHello or the clientHello are available at
that point. The probablility of having problems is very high. The client
getting a TLS warning alert is almost guaranteed.


&gt;<i> acl tls_s3_server_hello at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> # TLS/SSL bumping steps
</I>
This is the second time you have a comment like that. This is a sign of
someone copy-n-pasting config snippets from many sources without
understanding what they do.
I also recognise pieces of three config examples myself and Yuri have
given over the past year to different people with *very* different
behaviours they needed out of the proxy.


&gt;<i> ssl_bump peek   tls_s1_connect      all      # peek at the incoming TLS/SSL
</I>&gt;<i> connect data
</I>&gt;<i> ssl_bump splice all                          # splice the stream:
</I>&gt;<i> pass-through mode
</I>&gt;<i> 
</I>
Not a good idea to put comments on lines with directives like that. Some
Squid versions and some individual directives do not support it and will
try to check any ACLs matching words in the comment.

BTW, HTTP authentication happening is not a problem in ssl_bump. You can
remove the &quot;all&quot; from that peek line.


&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # HTTP parameters
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # Local Privoxy is cache parent
</I>&gt;<i> cache_peer 127.0.0.1 parent 8118 0 no-query no-digest default
</I>&gt;<i> 
</I>&gt;<i> cache_peer_access 127.0.0.1 deny all
</I>

WTF? what is the point of configuring a peer that nothing is ever
allowed to go through?

&gt;<i> 
</I>&gt;<i> # Don't cache 404 long time
</I>&gt;<i> negative_ttl 5 minutes
</I>&gt;<i> positive_dns_ttl 15 hours
</I>&gt;<i> negative_dns_ttl 1 minutes
</I>
Very likely the DNS problems created by altering these from the web
services own DNS TTL is part of your problem.


&gt;<i> 
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # Cache parameters
</I>&gt;<i> # -------------------------------------
</I>&gt;<i> # dhparams is before squid-3.5.12-20151222-r13967
</I>&gt;<i> # tls-dh is AFTER squid-3.5.12-20151222-r13967
</I>&gt;<i> #http_port 3126 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
</I>&gt;<i> key=/etc/squid/ssl_certs/squid.key options=NO_SSLv3
</I>&gt;<i> tls-dh=/etc/squid/dhparam.pem
</I>&gt;<i> http_port 3127
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> # dhparams is before squid-3.5.12-20151222-r13967
</I>&gt;<i> # tls-dh is AFTER squid-3.5.12-20151222-r13967
</I>&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
</I>&gt;<i> key=/etc/squid/ssl_certs/squid.key options=NO_SSLv3
</I>&gt;<i> tls-dh=/etc/squid/dhparam.pem
</I>&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;<i> # SINGLE_DH_USE is 3.5 before squid-3.5.12-20151222-r13967
</I>&gt;<i> #sslproxy_options NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i> # SINGLE_ECDH_USE is AFTER squid-3.5.12-20151222-r13967
</I>&gt;<i> sslproxy_options NO_SSLv3,SINGLE_ECDH_USE
</I>&gt;<i> sslproxy_cipher
</I>&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> # Specify ICP/HTCP explicity
</I>&gt;<i> icp_port 3130
</I>&gt;<i> htcp_port 4827
</I>&gt;<i> 
</I>&gt;<i> # Cache manager
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">mymail at gmail.com</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Forces reload-into-ims
</I>&gt;<i> reload_into_ims on
</I>&gt;<i> 
</I>&gt;<i> # Hide internal networks details outside
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> 
</I>&gt;<i> # Do not show Squid version
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Prioritization of local hits
</I>&gt;<i> qos_flows tos local-hit=0x68
</I>&gt;<i> 
</I>&gt;<i> # Specify local DNS cache
</I>&gt;<i> dns_nameservers 8.8.8.8
</I>&gt;<i> 
</I>
This has been demonstrated as a very effective way to make all your
traffic turn into cache MISS' and go very slowly.

The requirements for interception are that the client and the proxy use
the same DNS resolver. This is needed to ensure the *same* results are
seen by both. Google have some fancy logic to detect different sources
of queries and return different results. You can see how this is going
to go wrong?

The best way to operate is to run a recursive resolver of your own. Make
the proxy use it and direct client DNS traffic through it as well.

If you want to Google DNS could be configured as an upstream resolver of
that. Though why you would need to make all your systems rely on access
to Google when you now have a properly functioning recursive resolver of
your own anyway is a puzzle.

&gt;<i> # Cacle squidinternal
</I>&gt;<i> refresh_pattern -i video-srv\.youtube\.squidinternal    0    0%    0
</I>&gt;<i> refresh_pattern -i squidinternal    14400    100%    518400 override-expire
</I>&gt;<i> override-lastmod refresh-ims reload-into-ims ignore-private ignore-auth
</I>&gt;<i> ignore-must-revalidate store-stale ignore-no-store
</I>
Using ignore-private and ignore-must-revalidate on the same
refresh_pattern is *extremely* dangerous. Just asking to get your cache
pwned.

Also ignore-auth makes things *not* be cacheable in all the auth related
cases when it would normally be stored by Squid.


&gt;<i> # Keep swf in cache
</I>&gt;<i> refresh_pattern -i \.swf$    10080    100%    43200    override-expire
</I>&gt;<i> reload-into-ims ignore-private
</I>&gt;<i> # .NET cache
</I>&gt;<i> refresh_pattern -i \.((a|m)s(h|p)x?)$        10080    100%    43200
</I>&gt;<i> reload-into-ims ignore-private
</I>&gt;<i> # Other long-lived items
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> \.(jp(e?g|e|2)|gif|png|bmp|ico|svg|web(p|m)|wm(v|a)|flv|f4f|mp(3|4)|ttf|eot|woff2?|(c|x|j)ss|js(t?|px?))(\?.*)?$
</I>&gt;<i> 14400    100%    518400    override-expire override-lastmod reload-into-ims
</I>&gt;<i> ignore-private ignore-no-store ignore-must-revalidate
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> \.((cs|d?|m?|p?|r?|s?|w?|x?|z?)h?t?m?(l?)|php(3?|5?)|rss|atom|vr(t|ml))(\?.*)?$
</I>&gt;<i> 10080    100%    86400    override-expire override-lastmod reload-into-ims
</I>&gt;<i> ignore-private ignore-no-store ignore-must-revalidate
</I>
see above.

&gt;<i> # Default patterns
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?)    0    0%    0
</I>&gt;<i> refresh_pattern    .    0    20%    4320    reload-into-ims
</I>&gt;<i> 
</I>&gt;<i> ------------------------- Squid Configuration End
</I>&gt;<i> ----------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> When we give Network Connection Dirtectly through the Router then Internet
</I>&gt;<i> is working fine but when we pass the Network through Squid the Internet
</I>&gt;<i> work very slow .......
</I>
Be aware that Squid is doing some, and possibly a lot of extra
processing on each and every packet. Raw speed gain is not one of the
benefits of an intercepting proxy. Which is why accel(erator) mode is
something entirely different.


&gt;<i> 
</I>&gt;<i> ---------------- IPTables ---------------------
</I>&gt;<i> 
</I>&gt;<i> Chain PREROUTING (policy ACCEPT 25461 packets, 3444K bytes)
</I>&gt;<i>  pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>   996 55869 DNAT       tcp  --  eth1   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            tcp dpt:80 to:192.168.0.200:3128
</I>&gt;<i>     0     0 REDIRECT   tcp  --  eth0   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            tcp dpt:80 redir ports 3128
</I>&gt;<i>  3597  211K DNAT       tcp  --  eth1   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            tcp dpt:443 to:192.168.0.200:3129
</I>&gt;<i>     0     0 REDIRECT   tcp  --  eth0   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            tcp dpt:443 redir ports 3129
</I>
NP: your &quot;REDIRECT&quot; rules are not doing anything because you have DNAT
rules that do the same thing(s) to the same packets beforehand.
 DNAT or REDIRECT - pick one.

&gt;<i> 
</I>&gt;<i> ---------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> Access Logs:
</I>&gt;<i> 1463478680.312  33025 192.168.0.66 TCP_TUNNEL/200 3865 CONNECT
</I>&gt;<i> 216.58.199.165:443 - ORIGINAL_DST/216.58.199.165 -
</I>
a) A TLS connection to 216.58.199.165:443 was intercepted.
b) It was allowed into the proxy (&quot;http_access allow localnet&quot;).
c.1) &quot;splice NoSSLIntercept&quot; matched
OR,
c.2) no SNI was present and &quot;splice all&quot; matched.

What were you expecting?

&gt;<i> 1463478686.862     40 192.168.0.66 TCP_REFRESH_MODIFIED/200 539 GET
</I>&gt;<i> <A HREF="http://kerastasesalonlocator.com/">http://kerastasesalonlocator.com/</A> - ORIGINAL_DST/103.21.58.154 text/html
</I>&gt;<i> 1463478686.880      5 192.168.0.66 TCP_MISS_ABORTED/000 0 GET
</I>&gt;<i> <A HREF="http://kerastasesalonlocator.com/cgi-sys/defaultwebpage.cgi">http://kerastasesalonlocator.com/cgi-sys/defaultwebpage.cgi</A> - ORIGINAL_DST/
</I>&gt;<i> 103.21.58.154 -
</I>
Client aborted after just 5 milliseconds. Would not seem to be a problem
unless it happens a lot. And probably not a Squid problem even then.

&gt;<i> -----------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We have installed Squid on Ubuntu Server 14.04  Ram: 32 GB HDD: 1TB
</I>&gt;<i> 
</I>

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010686.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
	<LI>Next message (by thread): <A HREF="010694.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10690">[ date ]</a>
              <a href="thread.html#10690">[ thread ]</a>
              <a href="subject.html#10690">[ subject ]</a>
              <a href="author.html#10690">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
