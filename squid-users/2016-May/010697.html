<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Mode w/ Peek and Splice trouble
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Mode%20w/%20Peek%20and%20Splice%20trouble&In-Reply-To=%3Cb15d9e00-a416-fbd3-3833-dfead5576b45%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010696.html">
   <LINK REL="Next"  HREF="010700.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Mode w/ Peek and Splice trouble</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Mode%20w/%20Peek%20and%20Splice%20trouble&In-Reply-To=%3Cb15d9e00-a416-fbd3-3833-dfead5576b45%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent Mode w/ Peek and Splice trouble">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 18 16:46:04 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010696.html">[squid-users] Transparent Mode w/ Peek and Splice trouble
</A></li>
        <LI>Next message (by thread): <A HREF="010700.html">[squid-users] Problem talking ICAP to McAfee Web Gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10697">[ date ]</a>
              <a href="thread.html#10697">[ thread ]</a>
              <a href="subject.html#10697">[ subject ]</a>
              <a href="author.html#10697">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/05/2016 2:14 a.m., <A HREF="https://lists.squid-cache.org/listinfo/squid-users">se at kpa.gr</A> wrote:
&gt;<i> Hello!
</I>&gt;<i> 
</I>&gt;<i> I am currently setting up a squid server, which should serve as a
</I>&gt;<i> transparent proxy in our network.
</I>&gt;<i> 
</I>&gt;<i> We mainly need it to do the following:
</I>&gt;<i> Allow and Block Domains on HTTP and HTTPS protocol (withOUT bumping the
</I>&gt;<i> traffic). We only want to allow domain names on the SSL port, no URLs.
</I>&gt;<i> 
</I>&gt;<i> It actually works fine for HTTP, but I can't configure the &quot;peek and
</I>&gt;<i> splice&quot; method for the HTTPS traffic.
</I>&gt;<i> 
</I>&gt;<i> I have come to a point, where HTTP access is being filtered exactly as I
</I>&gt;<i> wanted to, but following odd error occures when visiting HTTPS sites:
</I>&gt;<i> 
</I>&gt;<i> When using &quot;https_port 10.0.0.222:3130 cert=/root/cert.pem
</I>&gt;<i> key=/root/key.pem ssl-bump intercept&quot;
</I>&gt;<i> I get an Access Denied Error for any Website I try to access, which
</I>&gt;<i> occured while &quot;trying to retrieve the URL: 10.0.0.222:3130&quot;!
</I>&gt;<i> 
</I>
It appears you are not doing NAT on the Squid machine. That is mandatory
for interception.


&gt;<i> If I configure the https_port option with &quot;accel vhost allow-direct&quot;
</I>&gt;<i> like the http_port, the allowed Pages work fine but with squid's
</I>&gt;<i> certificate.
</I>
'accel' mode is very much *not* transparent, nor equivalent to intercept
mode.

Using 'accel' mode tells Squid *it* is supposed to be the public origin
server for the received web request. The behaviour differences are not
very visible in plain-text HTTP - though there are some. In TLS the
differences are very much visible in the way the certificates are used.
Which you are now seeing.

&gt;<i> 
</I>&gt;<i> Somewhere the Squid seems to redirect his actual https traffic back to
</I>&gt;<i> itself when using the &quot;intercept&quot; option and that is why I cannot use
</I>&gt;<i> the splice method.
</I>
'intercept' mode tells Squid to lookup the NAT details and obey the
requirements of acting &quot;transparent&quot; with regards to traffic delivery.
Delivering it to the same place it was originally going to when it
entered the machine.

If you are doing NAT external to the Squid machine it is your NAT setup
which is causing the problem. Not Squid.


Your message reads to me like Squid is behaving correctly for the modes
of operation you configured it to follow.

You need to fix the NAT setup. Route or tunnel the trafic to the Squid
machine and do the NAT there. Then intercept and SSL-Bump will start
working, for both http_port and https_port.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010696.html">[squid-users] Transparent Mode w/ Peek and Splice trouble
</A></li>
	<LI>Next message (by thread): <A HREF="010700.html">[squid-users] Problem talking ICAP to McAfee Web Gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10697">[ date ]</a>
              <a href="thread.html#10697">[ thread ]</a>
              <a href="subject.html#10697">[ subject ]</a>
              <a href="author.html#10697">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
