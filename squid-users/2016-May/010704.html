<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Internet%20Browsing%20very%20slow%20after%20implementing%0A%20Squid%20peek%20%26%20splice%20%2B%20Access%20log%20not%20tracing%20full%20URL&In-Reply-To=%3C085dc4db-d597-08d3-9f90-537e3b8cc717%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010703.html">
   <LINK REL="Next"  HREF="010705.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Internet%20Browsing%20very%20slow%20after%20implementing%0A%20Squid%20peek%20%26%20splice%20%2B%20Access%20log%20not%20tracing%20full%20URL&In-Reply-To=%3C085dc4db-d597-08d3-9f90-537e3b8cc717%40treenet.co.nz%3E"
       TITLE="[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May 19 12:03:07 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010703.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
        <LI>Next message (by thread): <A HREF="010705.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10704">[ date ]</a>
              <a href="thread.html#10704">[ thread ]</a>
              <a href="subject.html#10704">[ subject ]</a>
              <a href="author.html#10704">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/05/2016 11:08 p.m., Sagar Malve wrote:
&gt;<i> Hi Team,
</I>&gt;<i> 
</I>&gt;<i> I have done some modification as per thread and temporary removed Refresh
</I>&gt;<i> pattern and have kept the Default refresh pattern ...
</I>&gt;<i> 
</I>&gt;<i> This is how my Configuration looks like .....
</I>&gt;<i> 
</I>&gt;<i> 
</I>
&gt;<i> # SSL bump acl
</I>&gt;<i> acl net_bump src &quot;/etc/squid/net.bump&quot;
</I>&gt;<i> 
</I>&gt;<i> # TLD acl
</I>&gt;<i> acl block_tld url_regex &quot;/etc/squid/dstdom.tld&quot;
</I>&gt;<i> 
</I>
You called the file &quot;dstdom&quot;, but it is not a dstdomain ACL type.

To match when the domain is listed in the path or query string sections
of URL this is right as-is. Though it would be worth making a note of
that in the config so it doesn't get undone.


To match only the URL domain section with regex use dstdom_regex as the
ACL type. Or, since the unknown part of the listed domains is all the
sub-domain section. Use dstdomain which is faster.


&gt;<i> 
</I>&gt;<i> # Block top level domains
</I>&gt;<i> http_access deny block_tld
</I>&gt;<i> deny_info TCP_RESET block_tld
</I>&gt;<i> 
</I>&gt;<i> # Rule allowing access from local networks
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>
Notice how localnet and localhost are allowed through the proxy above
without any further ACL conditions.

That means the below &quot;Windows Update rules&quot; have nothing to do and never
match any request which reaches them. You can remove.

&gt;<i> # Windows updates rules
</I>&gt;<i> http_access allow CONNECT wuCONNECT localnet
</I>&gt;<i> http_access allow CONNECT wuCONNECT localhost
</I>&gt;<i> http_access allow windowsupdate localnet
</I>&gt;<i> http_access allow windowsupdate localhost
</I>

&gt;<i> 
</I>&gt;<i> # SSL bump rules
</I>&gt;<i> acl DiscoverSNIHost at_step SslBump1
</I>
DiscoverSNIHost is never being used. You can remove it.

&gt;<i> # ICQ/MRA must splice first
</I>&gt;<i> acl NoSSLIntercept ssl::server_name_regex -i &quot;/etc/squid/url.nobump&quot;
</I>&gt;<i> ssl_bump splice NoSSLIntercept
</I>&gt;<i> ssl_bump bump net_bump
</I>&gt;<i> acl tls_s1_connect      at_step SslBump1
</I>&gt;<i> acl tls_s3_server_hello at_step SslBump3
</I>&gt;<i> 
</I>
tls_s3_server_hello is never being used. You can remove it.

&gt;<i> # TLS/SSL bumping steps
</I>&gt;<i> ssl_bump peek   tls_s1_connect        # peek at the incoming TLS/SSL
</I>&gt;<i> connect data
</I>&gt;<i> ssl_bump splice all                          # splice the stream:
</I>&gt;<i> pass-through mode
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>
&lt;snip&gt;

&gt;<i> -------------Config End ---------------
</I>&gt;<i> 
</I>&gt;<i> ------------net.bump File -------------------
</I>&gt;<i> 
</I>&gt;<i> google.com
</I>&gt;<i> youtube.com
</I>&gt;<i> reddit.com
</I>
This file is being loaded into a 'src' ACL.

Firstly, why are the Google, YouTube, and Reddit servers making requests
through your proxy? they are your customers?

I think you meant 'dst' ACL for this. Your cutomers going *to* Google,
YouTube, or Reddit.


Secondly, the IP addresses of the listed hosts will be resolved on Squid
startup *only* (applies to both src and dst ACL types).

Any other IPs which the site rotates into its DNS RR set after the
single resolve that Squid does for config loading will not match.



&gt;<i> -------------------------------
</I>&gt;<i> 
</I>&gt;<i> ------------dstdom.tld file --------------
</I>&gt;<i> 
</I>&gt;<i> yahoo.com
</I>&gt;<i> facebook.com
</I>&gt;<i> 
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --------------- Url.nobump--------
</I>&gt;<i> 
</I>&gt;<i> axisbank.com
</I>&gt;<i> hdfcbank.com
</I>&gt;<i> 
</I>
This file is being used by an ACL which has nothing to do with URLs.
That name is really confusing.


&gt;<i> ------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Now issue is that I need to block yahoo and facebook but I am able to
</I>&gt;<i> access the facebook website and yahoo is getting blocked ....
</I>&gt;<i> 
</I>
Hint: The facebook website does not always use the domain &quot;facebook.com&quot;
except in the URL part visible to people. Most people dont type URLs in
to their address bar anyway, so most access to FB will be through Google
etc. straight to the other domain name used for content display.


&gt;<i> And also all Google website like google, gmail, youtube are working very
</I>&gt;<i> slow it takes lots of time to load this websites but other Https websites
</I>&gt;<i> like axisbank / hdfc etc are working properly ....
</I>
Think about that. The domains that your net_bump ACL has told Squid to
bump (decrypt) are going slow, the ones you have told it to splice
(bypass decryption) are going &quot;properly&quot; (whatever that means).

&gt;<i> 
</I>&gt;<i> Also somtime website does not work with Chrome browser like Gmail but same
</I>&gt;<i> is working in Mozilla Firefox but take time to load ......
</I>&gt;<i> 
</I>
1) Same as above.

2) Chrome is a Google app. It has the TLS certs for Gmail and other
Google services pinned (hard-coded) into it. If your Squid happens to
try decrypting its traffic without having the Squid CA custom installed
in a way that overrides that pinning, it refuses to work.

3) Sometimes (usually?) Chrome does not use HTTP or HTTPS to contact
Gmail and other Google properties. Even if the URL in the address bar
makes you think thats what its doing. There are 5 different protocols
that can be used to contact servers and fetch <A HREF="https://">https://</A> URLs.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010703.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
	<LI>Next message (by thread): <A HREF="010705.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10704">[ date ]</a>
              <a href="thread.html#10704">[ thread ]</a>
              <a href="subject.html#10704">[ subject ]</a>
              <a href="author.html#10704">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
