<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Internet%20Browsing%20very%20slow%20after%20implementing%0A%20Squid%20peek%20%26%20splice%20%2B%20Access%20log%20not%20tracing%20full%20URL&In-Reply-To=%3C33dd4adf-24bc-fd31-14f2-307397bd9580%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010704.html">
   <LINK REL="Next"  HREF="010693.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Internet%20Browsing%20very%20slow%20after%20implementing%0A%20Squid%20peek%20%26%20splice%20%2B%20Access%20log%20not%20tracing%20full%20URL&In-Reply-To=%3C33dd4adf-24bc-fd31-14f2-307397bd9580%40gmail.com%3E"
       TITLE="[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL">yvoinov at gmail.com
       </A><BR>
    <I>Thu May 19 13:56:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010704.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
        <LI>Next message (by thread): <A HREF="010693.html">[squid-users] Transparent Mode w/ Peek and Splice trouble
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10705">[ date ]</a>
              <a href="thread.html#10705">[ thread ]</a>
              <a href="subject.html#10705">[ subject ]</a>
              <a href="author.html#10705">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

19.05.2016 18:03, Amos Jeffries &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> On 19/05/2016 11:08 p.m., Sagar Malve wrote:
</I>&gt;&gt;<i> Hi Team,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have done some modification as per thread and temporary removed Refresh
</I>&gt;&gt;<i> pattern and have kept the Default refresh pattern ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is how my Configuration looks like .....
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # SSL bump acl
</I>&gt;&gt;<i> acl net_bump src &quot;/etc/squid/net.bump&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # TLD acl
</I>&gt;&gt;<i> acl block_tld url_regex &quot;/etc/squid/dstdom.tld&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> You called the file &quot;dstdom&quot;, but it is not a dstdomain ACL type.
</I>&gt;<i>
</I>&gt;<i> To match when the domain is listed in the path or query string sections
</I>&gt;<i> of URL this is right as-is. Though it would be worth making a note of
</I>&gt;<i> that in the config so it doesn't get undone.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> To match only the URL domain section with regex use dstdom_regex as the
</I>&gt;<i> ACL type. Or, since the unknown part of the listed domains is all the
</I>&gt;<i> sub-domain section. Use dstdomain which is faster.
</I>NB: Original ACL was:

# TLD acl
acl block_tld dstdomain &quot;/usr/local/squid/etc/dstdom.tld&quot;

NB2: This is brainless copy-n-paste from my config I've accidentally 
shared here in the past.

NB3: facebook.com (and etc.) is NOT TLD (Top Level Domain). This is 
SECOND level domain. Originally this part of my config uses for block 
REAL TLD, like .tv, .xxx.
&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> # Block top level domains
</I>&gt;&gt;<i> http_access deny block_tld
</I>&gt;&gt;<i> deny_info TCP_RESET block_tld
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Rule allowing access from local networks
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i>
</I>&gt;<i> Notice how localnet and localhost are allowed through the proxy above
</I>&gt;<i> without any further ACL conditions.
</I>&gt;<i>
</I>&gt;<i> That means the below &quot;Windows Update rules&quot; have nothing to do and never
</I>&gt;<i> match any request which reaches them. You can remove.
</I>&gt;<i>
</I>&gt;&gt;<i> # Windows updates rules
</I>&gt;&gt;<i> http_access allow CONNECT wuCONNECT localnet
</I>&gt;&gt;<i> http_access allow CONNECT wuCONNECT localhost
</I>&gt;&gt;<i> http_access allow windowsupdate localnet
</I>&gt;&gt;<i> http_access allow windowsupdate localhost
</I>&gt;<i>
</I>&gt;&gt;<i> # SSL bump rules
</I>&gt;&gt;<i> acl DiscoverSNIHost at_step SslBump1
</I>&gt;<i> DiscoverSNIHost is never being used. You can remove it.
</I>&gt;<i>
</I>&gt;&gt;<i> # ICQ/MRA must splice first
</I>&gt;&gt;<i> acl NoSSLIntercept ssl::server_name_regex -i &quot;/etc/squid/url.nobump&quot;
</I>&gt;&gt;<i> ssl_bump splice NoSSLIntercept
</I>&gt;&gt;<i> ssl_bump bump net_bump
</I>&gt;&gt;<i> acl tls_s1_connect      at_step SslBump1
</I>&gt;&gt;<i> acl tls_s3_server_hello at_step SslBump3
</I>&gt;&gt;<i>
</I>&gt;<i> tls_s3_server_hello is never being used. You can remove it.
</I>&gt;<i>
</I>&gt;&gt;<i> # TLS/SSL bumping steps
</I>&gt;&gt;<i> ssl_bump peek   tls_s1_connect        # peek at the incoming TLS/SSL
</I>&gt;&gt;<i> connect data
</I>&gt;&gt;<i> ssl_bump splice all                          # splice the stream:
</I>&gt;&gt;<i> pass-through mode
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # And finally deny all other access to this proxy
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i>
</I>&gt;&gt;<i> -------------Config End ---------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ------------net.bump File -------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> google.com
</I>&gt;&gt;<i> youtube.com
</I>&gt;&gt;<i> reddit.com
</I>&gt;<i> This file is being loaded into a 'src' ACL.
</I>&gt;<i>
</I>&gt;<i> Firstly, why are the Google, YouTube, and Reddit servers making requests
</I>&gt;<i> through your proxy? they are your customers?
</I>&gt;<i>
</I>&gt;<i> I think you meant 'dst' ACL for this. Your cutomers going *to* Google,
</I>&gt;<i> YouTube, or Reddit.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Secondly, the IP addresses of the listed hosts will be resolved on Squid
</I>&gt;<i> startup *only* (applies to both src and dst ACL types).
</I>&gt;<i>
</I>&gt;<i> Any other IPs which the site rotates into its DNS RR set after the
</I>&gt;<i> single resolve that Squid does for config loading will not match.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> -------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ------------dstdom.tld file --------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> yahoo.com
</I>&gt;&gt;<i> facebook.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --------------- Url.nobump--------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> axisbank.com
</I>&gt;&gt;<i> hdfcbank.com
</I>&gt;&gt;<i>
</I>&gt;<i> This file is being used by an ACL which has nothing to do with URLs.
</I>&gt;<i> That name is really confusing.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ------------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now issue is that I need to block yahoo and facebook but I am able to
</I>&gt;&gt;<i> access the facebook website and yahoo is getting blocked ....
</I>&gt;&gt;<i>
</I>&gt;<i> Hint: The facebook website does not always use the domain &quot;facebook.com&quot;
</I>&gt;<i> except in the URL part visible to people. Most people dont type URLs in
</I>&gt;<i> to their address bar anyway, so most access to FB will be through Google
</I>&gt;<i> etc. straight to the other domain name used for content display.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> And also all Google website like google, gmail, youtube are working very
</I>&gt;&gt;<i> slow it takes lots of time to load this websites but other Https websites
</I>&gt;&gt;<i> like axisbank / hdfc etc are working properly ....
</I>&gt;<i> Think about that. The domains that your net_bump ACL has told Squid to
</I>&gt;<i> bump (decrypt) are going slow, the ones you have told it to splice
</I>&gt;<i> (bypass decryption) are going &quot;properly&quot; (whatever that means).
</I>&gt;<i>
</I>&gt;&gt;<i> Also somtime website does not work with Chrome browser like Gmail but same
</I>&gt;&gt;<i> is working in Mozilla Firefox but take time to load ......
</I>&gt;&gt;<i>
</I>&gt;<i> 1) Same as above.
</I>&gt;<i>
</I>&gt;<i> 2) Chrome is a Google app. It has the TLS certs for Gmail and other
</I>&gt;<i> Google services pinned (hard-coded) into it. If your Squid happens to
</I>&gt;<i> try decrypting its traffic without having the Squid CA custom installed
</I>&gt;<i> in a way that overrides that pinning, it refuses to work.
</I>&gt;<i>
</I>&gt;<i> 3) Sometimes (usually?) Chrome does not use HTTP or HTTPS to contact
</I>&gt;<i> Gmail and other Google properties. Even if the URL in the address bar
</I>&gt;<i> makes you think thats what its doing. There are 5 different protocols
</I>&gt;<i> that can be used to contact servers and fetch <A HREF="https://">https://</A> URLs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
I cursed everything that once posted my config. They mindlessly copy, 
mangling the parameters and hoping that it will work. I am a thousand 
times told those fanboys of Linux that can not do this.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010704.html">[squid-users] Internet Browsing very slow after implementing Squid peek &amp; splice + Access log not tracing full URL
</A></li>
	<LI>Next message (by thread): <A HREF="010693.html">[squid-users] Transparent Mode w/ Peek and Splice trouble
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10705">[ date ]</a>
              <a href="thread.html#10705">[ thread ]</a>
              <a href="subject.html#10705">[ subject ]</a>
              <a href="author.html#10705">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
