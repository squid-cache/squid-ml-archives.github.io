<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid, SMP and authentication and service regression over time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%2C%0A%20SMP%20and%20authentication%20and%20service%20regression%20over%20time&In-Reply-To=%3C1c5ed718-390f-d277-1dfe-f57ddc7920f4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010653.html">
   <LINK REL="Next"  HREF="010659.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid, SMP and authentication and service regression over time</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%2C%0A%20SMP%20and%20authentication%20and%20service%20regression%20over%20time&In-Reply-To=%3C1c5ed718-390f-d277-1dfe-f57ddc7920f4%40treenet.co.nz%3E"
       TITLE="[squid-users] squid, SMP and authentication and service regression over time">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 20 10:40:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010653.html">[squid-users] squid,	SMP and authentication and service regression over time
</A></li>
        <LI>Next message (by thread): <A HREF="010659.html">[squid-users] Squid unable to send full PNG file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10707">[ date ]</a>
              <a href="thread.html#10707">[ thread ]</a>
              <a href="subject.html#10707">[ subject ]</a>
              <a href="author.html#10707">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/05/2016 6:27 a.m., Eugene M. Zheganin wrote:
&gt;<i> Hi.
</I>&gt;<i> 
</I>
I dont see any mention of the Squid version. Which one are you having
this issue in?

&gt;<i> I'm using squid for a long time, I'm using it to authenticate/authorize
</I>&gt;<i> users accessing the Internet with LDAP in a Windows corporate
</I>&gt;<i> enviromnent (Basic/NTLM/GSS-SPNEGO) and recently (about several months
</I>&gt;<i> ago) I had to switch to the SMP scheme, because one process started to
</I>&gt;<i> eat the whole core sometimes, thus bottlenecking users on it.
</I>
This might be a version-specific problem. We've had a few bugs solved
that could match that description.

&gt;<i> Situation
</I>&gt;<i> with CPU effectiveness improved, however I discovered several issues.
</I>&gt;<i> The first I was aware of, it's the non-functional SNMP (since there's no
</I>&gt;<i> solution, I just had to sacrifice it).
</I>
Do you mean its fully non-functional?

Or that you are just getting randomly different responses from different
workers when they share an SNMP receiving port?

That latter is worked around by configuring per-worker SNMP ports and
querying each individually for its details.


&gt;<i> But the second one is more
</I>&gt;<i> disturbing. I discovered that after a several uptime (usually couple of
</I>&gt;<i> weeks, a month at it's best) squid somehow degrades and stops
</I>&gt;<i> authorizing users.
</I>
Which auth scheme are those users using?

&gt;<i> I have about active 600 users on my biggest site
</I>&gt;<i> (withount SNMP I'm not sure how many simultaneous users I got) but
</I>
The mgr:client_db report can help give a good ballpark number there if
you have it enabled.

&gt;<i> usually this starts like this: someone (this starts with one person)
</I>&gt;<i> complains that he lost his access to the internet - not entirely, no. At
</I>&gt;<i> first the access is very slow, and the victim has to wait several
</I>&gt;<i> minutes for the page to load. Others are unaffected at this time. From
</I>&gt;<i> time to time the victim is able to load one of two tabs in the browser,
</I>&gt;<i> eventually, but at the end of the day this becomes unuseable, and my
</I>&gt;<i> support has to come in. Then this gots escalated to me. First I was
</I>&gt;<i> debugging various kerberos stuff, NTLM, victim's machine domain
</I>&gt;<i> membership and so on. But today I managed to figure out that all I have
</I>&gt;<i> to do is just restart squid, yeah (sounds silly, but I don't like to
</I>&gt;<i> restart things, like in the &quot;IT Crowd&quot; TV Series, this is kinda last
</I>&gt;<i> resort measure, when I'm desperate).
</I>
That could be either one of four bugs I'm aware of:

1) NTLM connection limit to AD.
 Winbind access to AD cannot make more than concurrent 256 connections
to any given AD. Thats aggregate across all the NTLM + Negotiate helpers
and any other proceses also running on the Squid machine.
 This can result in an ever growing queue of pending auth requests until
the proxy is treading water just trying to catch up on which clients
have not yet disconnected.

2) NTLM helper limits exceeded.
 NTLM handshake duration is not limited. If for any reason it pauses for
a long time between the multiple HTTP requests involved, that helper is
blocked from use by any other users.
 This can result in both an ever growing queue, and ever fewer helpers
available to service that queue.

Don't you just love NTLM?


3) NTLM and Negotiate involve the helper passing Squid a unique token
with every HTTP request made on an new connection. The annotations
feature in Squid for quite a few releases was adding these to each
username's auth state.
 The number of these unique token Notes could build up over a few hours
to a day or two depending on the clients activity rate - to a number big
enough to cause noticable delays on every request they made, and others.

4) Recent versions of Firefox are known to begin NTLM handshakes badly.
They work find for Kerberos handshakes, and sometimes for NTLM. But for
certain requests they advertise keep-alive on the type-1 message then
just hang.

Fortunately this is a behaviour seen with MSIE 5.x back in the day, so
the auth_param &quot;keepalive off&quot; setting is already available to resolve
that. Though it does mean the NTLM handshakes require a TCP teardown and
reconnect, which can make issue (2) above hurt more.



&gt;<i> If I'm stubborn enough to continue
</I>&gt;<i> the investigation, soon I got 2 users complaining, then 3, then more.
</I>&gt;<i> During previous outages eventually I used to restart squid (to change
</I>&gt;<i> the domain controller in kerberos config, if I blame one; to disable the
</I>&gt;<i> external Kerberos/LDAP helper connection pooling, if I blame one) - so
</I>&gt;<i> each time there was a candidate to blame. But this time I just decided
</I>&gt;<i> to restart squid, since I started to think it's the main reason, et
</I>&gt;<i> voila. I should also mention that I run this AAA scheme in squid for
</I>&gt;<i> years, and I didn't have this issue previously.
</I>
Keep in mind that if you have been keeping up with important
patches/updates to Squid AD and/or Samba. Or just client OS updates.
Then a lot of things have been changing from all sides of the process
across those years.


&gt;<i> I also have like dozen
</I>&gt;<i> of other squids running same (very similar) config, - same AAA stuff -
</I>&gt;<i> Basic/NTLM/GSS-SpNego, same AD group checking, but only for the
</I>&gt;<i> different groups membership - and none of it has this issue. I'm
</I>&gt;<i> thinking there's SMP involved, really.
</I>
Maybe. Each worker does its own auth, with no sharing. So they should be
operating same as if they were different instances which happened to
have identical config.
 That itself can make problem (1) happen as the Winbind count multiplies
by the number of workers.

Other than that each TCP connection might end up going to a different
worker. BUT, re-auth is always needed on new TCP connections anyway. So
if the client is using HTTP properly that should not be causing any
issue. Might be a big &quot;IF&quot; there though.
 I have to keep reassuring myself that NTLM can handle the TCP
re-connect going to a different worker. The bits prior to type-1
handshake doesn't need a helper, so it should not have issues, but Im
not completely confident about it.

&gt;<i> 
</I>&gt;<i> I realize this is a poor problem report. &quot;Something degrades, I restart
</I>&gt;<i> squid, please help, I think it's SMP-related&quot;. But the thing is - I
</I>&gt;<i> don't know where to start to narrow this stuff. If anyone's having a
</I>&gt;<i> good idea please let me know.
</I>
The above might give you ideas. Otherwise I can only suggest turning on
debug for the authentication section and see if anything odd shows up.
 debug_options ALl,1 29,4

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010653.html">[squid-users] squid,	SMP and authentication and service regression over time
</A></li>
	<LI>Next message (by thread): <A HREF="010659.html">[squid-users] Squid unable to send full PNG file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10707">[ date ]</a>
              <a href="thread.html#10707">[ thread ]</a>
              <a href="subject.html#10707">[ subject ]</a>
              <a href="author.html#10707">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
