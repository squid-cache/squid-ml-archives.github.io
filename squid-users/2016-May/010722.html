<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] CPU Load 100% after implementing SSL Bump ....
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20CPU%20Load%20100%25%20after%20implementing%20SSL%20Bump%20....&In-Reply-To=%3Cb8d315ba-00da-ef5f-7624-23d11bd53b68%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010719.html">
   <LINK REL="Next"  HREF="010724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] CPU Load 100% after implementing SSL Bump ....</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20CPU%20Load%20100%25%20after%20implementing%20SSL%20Bump%20....&In-Reply-To=%3Cb8d315ba-00da-ef5f-7624-23d11bd53b68%40treenet.co.nz%3E"
       TITLE="[squid-users] CPU Load 100% after implementing SSL Bump ....">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 23 07:22:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010719.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
        <LI>Next message (by thread): <A HREF="010724.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10722">[ date ]</a>
              <a href="thread.html#10722">[ thread ]</a>
              <a href="subject.html#10722">[ subject ]</a>
              <a href="author.html#10722">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/05/2016 6:27 p.m., Sagar Malve wrote:
&gt;<i> Hi Team,
</I>&gt;<i> 
</I>&gt;<i> System Config:
</I>&gt;<i> 
</I>&gt;<i> Intel S2400SC2 Motherboard
</I>&gt;<i> Intel Xeon ES 2407 V2 CPU
</I>&gt;<i> RAM 32 GB
</I>&gt;<i> 
</I>
What Squid version?

&gt;<i> 
</I>&gt;<i> http_port 3127
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
</I>&gt;<i> key=/etc/squid/ssl_certs/squid.key options=NO_SSLv3
</I>&gt;<i> tls-dh=/etc/squid/dhparam.pem
</I>&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # FILTERING HTTPS
</I>&gt;<i> acl 1 dstdomain .fbcdn.net .akamaihd.net .fbsbx.com
</I>&gt;<i> #acl 2a dstdomain .mahadana.com .mql4.com .metaquotes.net
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/attachment\.fbsbx\.com\/.*\?(id=[0-9]*).*
</I>&gt;<i> acl 2 url_regex -i
</I>&gt;<i> \.fbsbx\.com\/.*\/(.*\.(unity3d|pak|zip|exe|dll|jpg|png|gif|swf)/)$
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/.*\.ytimg\.com(.*\.(webp|jpg|gif))
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/([^\.]*)\.yimg\.com\/(.*)
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/.*\.gstatic\.com\/images\?q=tbn\:(.*)
</I>&gt;<i> acl 2 url_regex -i
</I>&gt;<i> ^https?:\/\/.*\.reverbnation\.com\/.*\/(ec_stream_song|download_song_direct|stream_song)\/([0-9]*).*
</I>&gt;<i> acl 2 url_regex -i
</I>&gt;<i> ^https?:\/\/([a-z0-9.]*)(\.doubleclick\.net|\.quantserve\.com|.exoclick\.com|interclick.\com|\.googlesyndication\.com|\.auditude\.com|.visiblemeasures\.com|yieldmanager|cpxinteractive)(.*)
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/(.*?)\/(ads)\?(.*?)
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/.*steampowered\.com\/.*\/([0-9]+\/(.*))
</I>&gt;<i> acl 3 url_regex -i
</I>&gt;<i> ^https?:\/\/(.*?)\/speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
</I>&gt;<i> acl 3 url_regex -i speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
</I>&gt;<i> acl 4 url_regex -i reverbnation.*audio_player.*ec_stream_song.*$
</I>&gt;<i> acl 5 url_regex -i utm.gif.*
</I>&gt;<i> acl 6 url_regex -i c.android.clients.google.com.market.GetBinary.GetBinary.*
</I>&gt;<i> acl 7 url_regex -i youtube.*(ptracking|stream_204|player_204|gen_204).*$
</I>&gt;<i> acl 7 url_regex -i
</I>&gt;<i> \.c\.(youtube|google)\.com\/(get_video|videoplayback|videoplay).*$
</I>&gt;<i> acl 7 url_regex -i (youtube|google).*\/videoplayback\?.*
</I>&gt;<i> acl 8 http_status 302
</I>&gt;<i> acl getmethod method GET
</I>&gt;<i> 
</I>
Using .* on the beginning or end of a regex does nothing but cause more
CPU workload for Squid.

If you put it inside (.*), or with an anchor ^.* or .*$ just makes the
CPU usage worse.

What http_access rules are using those?

&gt;<i> 
</I>&gt;<i> ssl_bump splice localhost
</I>&gt;<i> acl 9 at_step SslBump1
</I>&gt;<i> acl 10 at_step SslBump2
</I>&gt;<i> acl 11 at_step SslBump3
</I>&gt;<i> ssl_bump peek 9 all
</I>&gt;<i> ssl_bump bump 10 all
</I>&gt;<i> ssl_bump bump 11 all
</I>
Step3 of bumping process will never happen. You told Squid to begin
decryption at step2.

Have you disabled &quot;via&quot;?


&gt;<i> 
</I>&gt;<i> ----------------------------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Is there any way where it can Cache SSL Certificate for all HTTPS Traffic
</I>&gt;<i> ....
</I>&gt;<i> Because SSL Cert &amp; Squid process were using 99% of CPU Load ....
</I>
Er, what do you think caching does exactly?

Caching HTTPS will have no effect on your described CPU problem. Might
make it worse even.


Between them?

How much is each process using?

How may concurrent connections are being handled by Squid to get that
loading ?


Check whether Squid is finished loading its cache_dir indexes, or if any
of them are undergoing a &quot;DIRTY&quot; rebuild. That can use a lot of CPU
while its happening and caching cannot be fully operational until its
finished either.


&gt;<i> 
</I>&gt;<i> We have approx 200 users ....
</I>&gt;<i> 
</I>&gt;<i> I have set the open file limit to 100000
</I>
FYI: SSL-Bump with your configuration will use 3 FD for each client
inbound HTTPS request. That 100K limit will restrict your users to 150
concurrent connections each.
A browser using Happy eyeballs will open 16 connections to each domain.
Average web page on the most popular sites involve around 100 objects
spread over 10+ domains.
  =&gt; ~160 FD needed to load an average page.

I'd double that limit, if you expect this proxy to have much traffic.

&gt;<i> 
</I>&gt;<i> Could you please let us know if there is any way to Cache the HTTPS Request
</I>&gt;<i> in Squid .....
</I>&gt;<i> 
</I>
You are already SSL-Bumping traffic. That removes the 'S' from HTTPS.
Leaving Squid with regular HTTP messages, which already are cached if it
can.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010719.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
	<LI>Next message (by thread): <A HREF="010724.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10722">[ date ]</a>
              <a href="thread.html#10722">[ thread ]</a>
              <a href="subject.html#10722">[ subject ]</a>
              <a href="author.html#10722">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
