<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] CPU Load 100% after implementing SSL Bump ....
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20CPU%20Load%20100%25%20after%20implementing%20SSL%20Bump%20....&In-Reply-To=%3CCAKQSiAVt2jnrH%3DmByuLXz-B6F92%3DnZCZKpGpV7%3DBkmfWDAntUg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010722.html">
   <LINK REL="Next"  HREF="010725.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] CPU Load 100% after implementing SSL Bump ....</H1>
    <B>Sagar Malve</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20CPU%20Load%20100%25%20after%20implementing%20SSL%20Bump%20....&In-Reply-To=%3CCAKQSiAVt2jnrH%3DmByuLXz-B6F92%3DnZCZKpGpV7%3DBkmfWDAntUg%40mail.gmail.com%3E"
       TITLE="[squid-users] CPU Load 100% after implementing SSL Bump ....">sagarmalve91 at gmail.com
       </A><BR>
    <I>Mon May 23 08:18:16 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010722.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
        <LI>Next message (by thread): <A HREF="010725.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10724">[ date ]</a>
              <a href="thread.html#10724">[ thread ]</a>
              <a href="subject.html#10724">[ subject ]</a>
              <a href="author.html#10724">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Team,

Squid - Version 3.5.13


Please find the below Squid Cache Logs
2016/05/23 13:35:55 kid1| Error negotiating SSL connection on FD 138:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:35:55 kid1| Error negotiating SSL connection on FD 457:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:00 kid1| Error negotiating SSL connection on FD 33:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:01 kid1| Error negotiating SSL connection on FD 438:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:05 kid1| Error negotiating SSL connection on FD 555: (104)
Connection reset by peer
2016/05/23 13:36:06 kid1| Error negotiating SSL connection on FD 512:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:09 kid1| Error negotiating SSL connection on FD 618: (104)
Connection reset by peer
2016/05/23 13:36:15 kid1| Error negotiating SSL connection on FD 514:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:15 kid1| Error negotiating SSL connection on FD 206:
error:14094416:SSL routines:SSL3_READ_BYTES:sslv3 alert certificate unknown
(1/0)
2016/05/23 13:36:18 kid1| Error negotiating SSL connection on FD 627: (104)
Connection reset by peer
2016/05/23 13:36:18 kid1| Error negotiating SSL on FD 147:
error:14094410:SSL routines:SSL3_READ_BYTES:sslv3 alert handshake failure
(1/0/0)
2016/05/23 13:36:19 kid1| Error negotiating SSL connection on FD 343:
error:14094416:SSL routines:SSL3_READ_BYTES:sslv3 alert certificate unknown
(1/0)
2016/05/23 13:36:24 kid1| Error negotiating SSL connection on FD 378: (104)
Connection reset by peer
2016/05/23 13:36:25 kid1| Error negotiating SSL connection on FD 491:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:28 kid1| ctx: enter level  0: '
<A HREF="http://afs.moatads.com/empty_flash?tracer=">http://afs.moatads.com/empty_flash?tracer=</A>'
2016/05/23 13:36:28 kid1| keepaliveAccounting: Impossible keep-alive header
from '<A HREF="http://afs.moatads.com/empty_flash?tracer=">http://afs.moatads.com/empty_flash?tracer=</A>'
2016/05/23 13:36:34 kid1| ctx: exit level  0
2016/05/23 13:36:34 kid1| Error negotiating SSL connection on FD 257: (104)
Connection reset by peer
2016/05/23 13:36:34 kid1| Error negotiating SSL connection on FD 90:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:38 kid1| Error negotiating SSL on FD 125:
error:14094410:SSL routines:SSL3_READ_BYTES:sslv3 alert handshake failure
(1/0/0)
2016/05/23 13:36:38 kid1| Error negotiating SSL connection on FD 577: (104)
Connection reset by peer
2016/05/23 13:36:38 kid1| Error negotiating SSL connection on FD 91: (104)
Connection reset by peer
2016/05/23 13:36:39 kid1| Error negotiating SSL connection on FD 220:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:36:43 kid1| Error negotiating SSL connection on FD 50: (104)
Connection reset by peer
2016/05/23 13:36:48 kid1| Error negotiating SSL connection on FD 579: (104)
Connection reset by peer
2016/05/23 13:36:48 kid1| Error negotiating SSL connection on FD 455: (104)
Connection reset by peer
2016/05/23 13:36:49 kid1| Error negotiating SSL connection on FD 414:
error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
2016/05/23 13:39:28 kid1| varyEvaluateMatch: Oops. Not a Vary match on
second attempt, '
<A HREF="http://cdn.sstatic.net/Sites/stackoverflow/all.css?v=fada5080e3ea">http://cdn.sstatic.net/Sites/stackoverflow/all.css?v=fada5080e3ea</A>'
'accept-encoding=&quot;gzip,%20deflate&quot;'



----------------------------Cache log End
--------------------------------------

Do we need to update openssl? I got to know these from the forum previous
post ....
If we need to update the openssl then where can we find the updated version
of CA Certs ....





On Mon, May 23, 2016 at 12:52 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 23/05/2016 6:27 p.m., Sagar Malve wrote:
</I>&gt;<i> &gt; Hi Team,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; System Config:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Intel S2400SC2 Motherboard
</I>&gt;<i> &gt; Intel Xeon ES 2407 V2 CPU
</I>&gt;<i> &gt; RAM 32 GB
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> What Squid version?
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 3127
</I>&gt;<i> &gt; http_port 3128 intercept
</I>&gt;<i> &gt; https_port 3129 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
</I>&gt;<i> &gt; key=/etc/squid/ssl_certs/squid.key options=NO_SSLv3
</I>&gt;<i> &gt; tls-dh=/etc/squid/dhparam.pem
</I>&gt;<i> &gt; sslproxy_capath /etc/ssl/certs
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # FILTERING HTTPS
</I>&gt;<i> &gt; acl 1 dstdomain .fbcdn.net .akamaihd.net .fbsbx.com
</I>&gt;<i> &gt; #acl 2a dstdomain .mahadana.com .mql4.com .metaquotes.net
</I>&gt;<i> &gt; acl 2 url_regex -i ^https?:\/\/attachment\.fbsbx\.com\/.*\?(id=[0-9]*).*
</I>&gt;<i> &gt; acl 2 url_regex -i
</I>&gt;<i> &gt; \.fbsbx\.com\/.*\/(.*\.(unity3d|pak|zip|exe|dll|jpg|png|gif|swf)/)$
</I>&gt;<i> &gt; acl 2 url_regex -i ^https?:\/\/.*\.ytimg\.com(.*\.(webp|jpg|gif))
</I>&gt;<i> &gt; acl 2 url_regex -i ^https?:\/\/([^\.]*)\.yimg\.com\/(.*)
</I>&gt;<i> &gt; acl 2 url_regex -i ^https?:\/\/.*\.gstatic\.com\/images\?q=tbn\:(.*)
</I>&gt;<i> &gt; acl 2 url_regex -i
</I>&gt;<i> &gt;
</I>&gt;<i> ^https?:\/\/.*\.reverbnation\.com\/.*\/(ec_stream_song|download_song_direct|stream_song)\/([0-9]*).*
</I>&gt;<i> &gt; acl 2 url_regex -i
</I>&gt;<i> &gt;
</I>&gt;<i> ^https?:\/\/([a-z0-9.]*)(\.doubleclick\.net|\.quantserve\.com|.exoclick\.com|interclick.\com|\.googlesyndication\.com|\.auditude\.com|.visiblemeasures\.com|yieldmanager|cpxinteractive)(.*)
</I>&gt;<i> &gt; acl 2 url_regex -i ^https?:\/\/(.*?)\/(ads)\?(.*?)
</I>&gt;<i> &gt; acl 2 url_regex -i ^https?:\/\/.*steampowered\.com\/.*\/([0-9]+\/(.*))
</I>&gt;<i> &gt; acl 3 url_regex -i
</I>&gt;<i> &gt; ^https?:\/\/(.*?)\/speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
</I>&gt;<i> &gt; acl 3 url_regex -i speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
</I>&gt;<i> &gt; acl 4 url_regex -i reverbnation.*audio_player.*ec_stream_song.*$
</I>&gt;<i> &gt; acl 5 url_regex -i utm.gif.*
</I>&gt;<i> &gt; acl 6 url_regex -i
</I>&gt;<i> c.android.clients.google.com.market.GetBinary.GetBinary.*
</I>&gt;<i> &gt; acl 7 url_regex -i youtube.*(ptracking|stream_204|player_204|gen_204).*$
</I>&gt;<i> &gt; acl 7 url_regex -i
</I>&gt;<i> &gt; \.c\.(youtube|google)\.com\/(get_video|videoplayback|videoplay).*$
</I>&gt;<i> &gt; acl 7 url_regex -i (youtube|google).*\/videoplayback\?.*
</I>&gt;<i> &gt; acl 8 http_status 302
</I>&gt;<i> &gt; acl getmethod method GET
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Using .* on the beginning or end of a regex does nothing but cause more
</I>&gt;<i> CPU workload for Squid.
</I>&gt;<i>
</I>&gt;<i> If you put it inside (.*), or with an anchor ^.* or .*$ just makes the
</I>&gt;<i> CPU usage worse.
</I>&gt;<i>
</I>&gt;<i> What http_access rules are using those?
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump splice localhost
</I>&gt;<i> &gt; acl 9 at_step SslBump1
</I>&gt;<i> &gt; acl 10 at_step SslBump2
</I>&gt;<i> &gt; acl 11 at_step SslBump3
</I>&gt;<i> &gt; ssl_bump peek 9 all
</I>&gt;<i> &gt; ssl_bump bump 10 all
</I>&gt;<i> &gt; ssl_bump bump 11 all
</I>&gt;<i>
</I>&gt;<i> Step3 of bumping process will never happen. You told Squid to begin
</I>&gt;<i> decryption at step2.
</I>&gt;<i>
</I>&gt;<i> Have you disabled &quot;via&quot;?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> ----------------------------------------------------------------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is there any way where it can Cache SSL Certificate for all HTTPS Traffic
</I>&gt;<i> &gt; ....
</I>&gt;<i> &gt; Because SSL Cert &amp; Squid process were using 99% of CPU Load ....
</I>&gt;<i>
</I>&gt;<i> Er, what do you think caching does exactly?
</I>&gt;<i>
</I>&gt;<i> Caching HTTPS will have no effect on your described CPU problem. Might
</I>&gt;<i> make it worse even.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Between them?
</I>&gt;<i>
</I>&gt;<i> How much is each process using?
</I>&gt;<i>
</I>&gt;<i> How may concurrent connections are being handled by Squid to get that
</I>&gt;<i> loading ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Check whether Squid is finished loading its cache_dir indexes, or if any
</I>&gt;<i> of them are undergoing a &quot;DIRTY&quot; rebuild. That can use a lot of CPU
</I>&gt;<i> while its happening and caching cannot be fully operational until its
</I>&gt;<i> finished either.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have approx 200 users ....
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have set the open file limit to 100000
</I>&gt;<i>
</I>&gt;<i> FYI: SSL-Bump with your configuration will use 3 FD for each client
</I>&gt;<i> inbound HTTPS request. That 100K limit will restrict your users to 150
</I>&gt;<i> concurrent connections each.
</I>&gt;<i> A browser using Happy eyeballs will open 16 connections to each domain.
</I>&gt;<i> Average web page on the most popular sites involve around 100 objects
</I>&gt;<i> spread over 10+ domains.
</I>&gt;<i>   =&gt; ~160 FD needed to load an average page.
</I>&gt;<i>
</I>&gt;<i> I'd double that limit, if you expect this proxy to have much traffic.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Could you please let us know if there is any way to Cache the HTTPS
</I>&gt;<i> Request
</I>&gt;<i> &gt; in Squid .....
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> You are already SSL-Bumping traffic. That removes the 'S' from HTTPS.
</I>&gt;<i> Leaving Squid with regular HTTP messages, which already are cached if it
</I>&gt;<i> can.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160523/692a3b1a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160523/692a3b1a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010722.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
	<LI>Next message (by thread): <A HREF="010725.html">[squid-users] CPU Load 100% after implementing SSL Bump ....
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10724">[ date ]</a>
              <a href="thread.html#10724">[ thread ]</a>
              <a href="subject.html#10724">[ subject ]</a>
              <a href="author.html#10724">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
