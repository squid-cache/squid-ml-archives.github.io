<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Excessive TCP memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Excessive%20TCP%20memory%20usage&In-Reply-To=%3C20948875-1d61-94eb-a6ec-f3d93ea716ec%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010734.html">
   <LINK REL="Next"  HREF="010739.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Excessive TCP memory usage</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Excessive%20TCP%20memory%20usage&In-Reply-To=%3C20948875-1d61-94eb-a6ec-f3d93ea716ec%40treenet.co.nz%3E"
       TITLE="[squid-users] Excessive TCP memory usage">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May 24 18:47:36 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="010734.html">[squid-users] Excessive TCP memory usage
</A></li>
        <LI>Next message (by thread): <A HREF="010739.html">[squid-users] Excessive TCP memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10736">[ date ]</a>
              <a href="thread.html#10736">[ thread ]</a>
              <a href="subject.html#10736">[ subject ]</a>
              <a href="author.html#10736">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/05/2016 5:50 a.m., Deniz Eren wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> After upgrading to squid 3.5.16 I realized that squid started using
</I>&gt;<i> much of kernel's TCP memory.
</I>
Upgrade from which version?

&gt;<i> 
</I>&gt;<i> When squid was running for a long time TCP memory usage is like below:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">test at test</A>:~$ cat /proc/net/sockstat
</I>&gt;<i> sockets: used *
</I>&gt;<i> TCP: inuse * orphan * tw * alloc * mem 200000
</I>&gt;<i> UDP: inuse * mem *
</I>&gt;<i> UDPLITE: inuse *
</I>&gt;<i> RAW: inuse *
</I>&gt;<i> FRAG: inuse * memory *
</I>&gt;<i> 
</I>&gt;<i> When I restart squid the memory usage drops dramatically:
</I>
Of course it does. By restarting you just erased all of the operational
state for an unknown but large number of active network connections.

Whether many of those should have been still active or not is a
different question. the answer to which depends on how you have your
Squid configured, and what the traffic through it has been doing.


&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">test at test</A>:~$ cat /proc/net/sockstat
</I>&gt;<i> sockets: used *
</I>&gt;<i> TCP: inuse * orphan * tw * alloc * mem 10
</I>&gt;<i> UDP: inuse * mem *
</I>&gt;<i> UDPLITE: inuse *
</I>&gt;<i> RAW: inuse *
</I>&gt;<i> FRAG: inuse * memory *
</I>&gt;<i> 
</I>
The numbers you replaced with &quot;*&quot; are rather important for context.


&gt;<i> I'm using Squid 3.5.16.
</I>&gt;<i> 
</I>
Please upgrade to 3.5.19. Some important issues have been resolved. Some
of them may be related to your TCP memory problem.


&gt;<i> When I look with &quot;netstat&quot; and &quot;ss&quot; I see lots of CLOSE_WAIT
</I>&gt;<i> connections from squid to ICAP or from squid to upstream server.
</I>&gt;<i> 
</I>&gt;<i> Do you have any idea about this problem?
</I>
Memory use by the TCP system of your kernel has very little to do with
Squid. Number of sockets in CLOSE_WAIT does have some relation to Squid
or at least to how the traffic going through it is handled.

If you have disabled persistent connections in squid.conf then lots of
closed sockets and FD are to be expected.

If you have persistent connections enabled, then fewer closures should
happen. But some will so expectations depends on how high the traffic
load is.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="010734.html">[squid-users] Excessive TCP memory usage
</A></li>
	<LI>Next message (by thread): <A HREF="010739.html">[squid-users] Excessive TCP memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10736">[ date ]</a>
              <a href="thread.html#10736">[ thread ]</a>
              <a href="subject.html#10736">[ subject ]</a>
              <a href="author.html#10736">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
