<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP Outgoing Address ACL Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP%20Outgoing%20Address%20ACL%20Problem&In-Reply-To=%3C75ecbaf5dd48b6520b4798e884414f74%40comnet.uz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013412.html">
   <LINK REL="Next"  HREF="013417.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP Outgoing Address ACL Problem</H1>
    <B>Garri Djavadyan</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP%20Outgoing%20Address%20ACL%20Problem&In-Reply-To=%3C75ecbaf5dd48b6520b4798e884414f74%40comnet.uz%3E"
       TITLE="[squid-users] TCP Outgoing Address ACL Problem">garryd at comnet.uz
       </A><BR>
    <I>Fri Nov 11 18:44:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013412.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
        <LI>Next message (by thread): <A HREF="013417.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13415">[ date ]</a>
              <a href="thread.html#13415">[ thread ]</a>
              <a href="subject.html#13415">[ subject ]</a>
              <a href="author.html#13415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2016-11-11 22:28, Antony Stone wrote:
&gt;<i> On Friday 11 November 2016 at 17:51:04, 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jarrett+squid-users at jarrettgraham.com</A>
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm trying to use ACLs to direct incoming traffic on assigned ports to
</I>&gt;&gt;<i> assigned outgoing addresses.  But, squid uses the first IP address
</I>&gt;&gt;<i> assigned to the interface not listed in the config instead.
</I>&gt;<i> 
</I>&gt;<i> See <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-">http://lists.squid-cache.org/pipermail/squid-users/2016-</A>
</I>&gt;<i> October/013270.html
</I>&gt;<i> 
</I>&gt;<i> Specifically &quot;IP addressing on the outgoing connections is an operating 
</I>&gt;<i> system
</I>&gt;<i> choice.  Squid does not have any direct control over outgoing 
</I>&gt;<i> connections
</I>&gt;<i> besides their destination IP:port.&quot;
</I>
Hi,

The following configuration works for me on Linux.

1. I set second /32 IP address for Internet facing interface.
# ip addr show wlp3s0 | fgrep 'inet '
     inet 192.168.2.102/24 brd 192.168.2.255 scope global dynamic wlp3s0
     inet 192.168.2.108/32 scope global wlp3s0


2. I added second http_port, ACL for the second http_port and the rule 
to use second IP address if connection is for second http_port.
# diff -u etc/squid.conf.default etc/squid.conf
--- etc/squid.conf.default	2016-10-28 15:54:53.851704360 +0500
+++ etc/squid.conf	2016-11-11 23:18:48.654385840 +0500
@@ -23,6 +23,7 @@
  acl Safe_ports port 591		# filemaker
  acl Safe_ports port 777		# multiling http
  acl CONNECT method CONNECT
+acl port3129 localport 3129

  #
  # Recommended minimum Access Permission configuration:
@@ -57,6 +58,7 @@

  # Squid normally listens to port 3128
  http_port 3128
+http_port 3129

  # Uncomment and adjust the following to add a disk cache directory.
  #cache_dir ufs /usr/local/squid35/var/cache/squid 100 16 256
@@ -71,3 +73,4 @@
  refresh_pattern ^gopher:	1440	0%	1440
  refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
  refresh_pattern .		0	20%	4320
+tcp_outgoing_address 192.168.2.108 port3129


3. I initiated two requests on different http ports:
$ curl -x <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> -H 'Cache-Control: no-cache' 
<A HREF="http://mirror.comnet.uz/centos/2/readme.txt">http://mirror.comnet.uz/centos/2/readme.txt</A> &gt; /dev/null
$ curl -x <A HREF="http://127.0.0.1:3129">http://127.0.0.1:3129</A> -H 'Cache-Control: no-cache' 
<A HREF="http://mirror.comnet.uz/centos/2/readme.txt">http://mirror.comnet.uz/centos/2/readme.txt</A> &gt; /dev/null


4. Using tcpdump I confirmed that the rule is working.
# tcpdump -i wlp3s0 dst host mirror.comnet.uz
...
23:42:02.230713 IP 192.168.2.102.40506 &gt; mirror.comnet.uz.http: Flags 
[P.], seq 0:218, ack 1, win 229, options [nop,nop,TS val 845937144 ecr 
1281004287], length 218: HTTP: GET /centos/2/readme.txt HTTP/1.1
...
23:42:15.166311 IP 192.168.2.108.48575 &gt; mirror.comnet.uz.http: Flags 
[P.], seq 0:218, ack 1, win 229, options [nop,nop,TS val 845950080 ecr 
1281016928], length 218: HTTP: GET /centos/2/readme.txt HTTP/1.1
...


Thanks for attention!

Garri

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013412.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
	<LI>Next message (by thread): <A HREF="013417.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13415">[ date ]</a>
              <a href="thread.html#13415">[ thread ]</a>
              <a href="subject.html#13415">[ subject ]</a>
              <a href="author.html#13415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
