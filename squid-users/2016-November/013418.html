<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP Outgoing Address ACL Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP%20Outgoing%20Address%20ACL%20Problem&In-Reply-To=%3Cc417ae41-0d3a-a281-47ef-3dc71fa72da8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013414.html">
   <LINK REL="Next"  HREF="013422.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP Outgoing Address ACL Problem</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP%20Outgoing%20Address%20ACL%20Problem&In-Reply-To=%3Cc417ae41-0d3a-a281-47ef-3dc71fa72da8%40treenet.co.nz%3E"
       TITLE="[squid-users] TCP Outgoing Address ACL Problem">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Nov 12 03:25:08 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013414.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
        <LI>Next message (by thread): <A HREF="013422.html">[squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13418">[ date ]</a>
              <a href="thread.html#13418">[ thread ]</a>
              <a href="subject.html#13418">[ subject ]</a>
              <a href="author.html#13418">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/11/2016 5:51 a.m., jarrett+squid-users wrote:
&gt;<i> Can anyone point out what I'm doing wrong in my config?
</I>&gt;<i> 
</I>&gt;<i> Squid config:
</I>&gt;<i> &lt;snip URL&gt;
</I>&gt;<i> 
</I>&gt;<i> acl ipv4-1 myportname 3128 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-2 myportname 3129 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-3 myportname 3130 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-4 myportname 3131 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-5 myportname 3132 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-6 myportname 3133 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-7 myportname 3134 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-8 myportname 3135 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-9 myportname 3136 src 10.99.0.0/24
</I>&gt;<i> acl ipv4-10 myportname 3137 src 10.99.0.0/24
</I>
As Garri said these ACLs contain garbage.

There is no http_port line with a name &quot;src&quot; or name &quot;10.99.0.0/24&quot;. So
those values are meaningless / useless. They may also be confusing you
about what the ACL matches.

The 31xx values (first) value entry in each ACL will match


&gt;<i> forwarded_for delete
</I>
Not great. &quot;forwarded_for transparent&quot; is better.

But this is pointless anyway since your request_header_access
 &quot;All deny all&quot; line below will delete the X-Forwarded-For and Forwarded
headers anyway.


&gt;<i> http_access allow ipv4-1
</I>&gt;<i> http_access allow ipv4-2
</I>&gt;<i> http_access allow ipv4-3
</I>&gt;<i> http_access allow ipv4-4
</I>&gt;<i> http_access allow ipv4-5
</I>&gt;<i> http_access allow ipv4-6
</I>&gt;<i> http_access allow ipv4-7
</I>&gt;<i> http_access allow ipv4-8
</I>&gt;<i> http_access allow ipv4-9
</I>&gt;<i> http_access allow ipv4-10
</I>
Due to the mistake mentioned already in the ipv4-* definitions the above
access controls are equivalent to a single line:
 http_access allow all

So none of the below http_access lines do anything. You have an open proxy.

&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access deny all
</I>
IMPORTANT:
 The *below* lines are the basic minimal security rules a proxy needs.
 Your custom rules which are curently configured *above* should be
placed ...


&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny to_localhost
</I>
 ... down here.

&gt;<i> http_port 10.99.0.1:3128 name=3128
</I>&gt;<i> http_port 10.99.0.1:3129 name=3129
</I>&gt;<i> http_port 10.99.0.1:3130 name=3130
</I>&gt;<i> http_port 10.99.0.1:3131 name=3131
</I>&gt;<i> http_port 10.99.0.1:3132 name=3132
</I>&gt;<i> http_port 10.99.0.1:3133 name=3133
</I>&gt;<i> http_port 10.99.0.1:3134 name=3134
</I>&gt;<i> http_port 10.99.0.1:3135 name=3135
</I>&gt;<i> http_port 10.99.0.1:3136 name=3136
</I>&gt;<i> http_port 10.99.0.1:3137 name=3137
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> request_header_access Accept allow all
</I>&gt;<i> request_header_access Accept-Charset allow all
</I>&gt;<i> request_header_access Accept-Encoding allow all
</I>&gt;<i> request_header_access Accept-Language allow all
</I>&gt;<i> request_header_access All deny all
</I>
NP: &quot;All&quot; is not a header name. It is a special *_header_access value
meaning do this action for *all* headers which do not have their own
named entry here in your config file.

I suggest it is a good idea to put that line last in the config sequence
of request_header_access with a comment to say thats the default action
applied to *all* headers not listed above. Just so its clear what and
why Squid is doing when strange things happen in your traffic...

... such as logging in with WWW-Authorization and
WWW-Authentication-Info credentials.


&gt;<i> request_header_access Allow allow all
</I>&gt;<i> request_header_access Authorization allow all
</I>&gt;<i> request_header_access Cache-Control allow all
</I>&gt;<i> request_header_access Connection allow all
</I>&gt;<i> request_header_access Content-Encoding allow all
</I>&gt;<i> request_header_access Content-Language allow all
</I>&gt;<i> request_header_access Content-Length allow all
</I>&gt;<i> request_header_access Content-Type allow all
</I>&gt;<i> request_header_access Cookie deny all
</I>&gt;<i> request_header_access Date allow all
</I>&gt;<i> request_header_access Expires allow all
</I>&gt;<i> request_header_access Host allow all
</I>&gt;<i> request_header_access If-Modified-Since allow all
</I>
You should also allow these headers:

 If-Unmodified-Since
 If-None-Match
 If-Match
 If


&gt;<i> request_header_access Last-Modified allow all
</I>&gt;<i> request_header_access Location allow all
</I>&gt;<i> request_header_access Mime-Version allow all
</I>&gt;<i> request_header_access Retry-After allow all
</I>&gt;<i> request_header_access Title allow all
</I>&gt;<i> request_header_access Pragma allow all
</I>&gt;<i> request_header_access Proxy-Authorization allow all
</I>&gt;<i> request_header_access Proxy-Authenticate allow all
</I>&gt;<i> request_header_access Proxy-Connection allow all
</I>
&quot;Proxy-Connection&quot; is an invalid and obsolete header. Squid deletes it
already. You can remove the above line.

&gt;<i> request_header_access User-Agent deny all
</I>&gt;<i> request_header_access WWW-Authenticate allow all 
</I>

&gt;<i> tcp_outgoing_address 45.2.xxx.155 ipv4-1
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.156 ipv4-2
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.157 ipv4-3
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.158 ipv4-4
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.159 ipv4-5
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.160 ipv4-6
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.161 ipv4-7
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.162 ipv4-8
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.163 ipv4-9
</I>&gt;<i> tcp_outgoing_address 45.2.xxx.164 ipv4-10
</I>&gt;<i>
</I>&gt;<i> I'm trying to use ACLs to direct incoming traffic on assigned ports to
</I>&gt;<i> assigned outgoing addresses.  But, squid uses the first IP address
</I>&gt;<i> assigned to the interface not listed in the config instead.
</I>&gt;<i> 
</I>&gt;<i> IP/Ethernet Interface Assignment:
</I>&gt;<i> <A HREF="https://bpaste.net/show/5cf068a4ce9a">https://bpaste.net/show/5cf068a4ce9a</A>
</I>&gt;<i> 
</I>
What info do you see that makes you think that?
Both the squid.conf and the outerface assignments you mention look correct.

Perhapse you have NAT changing the outgoing IP on traffic leaving either
the machine or the network?
 If so you need to make sure the 45.* IPs requested by Squid are allowed
to bypass that NAT.

Or perhapse you are using a Squid older than 3.4?
 the tcp_outgoing_address selection in older versions had some bugs that
could result in what you describe for *some* traffic (though not allways).

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013414.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
	<LI>Next message (by thread): <A HREF="013422.html">[squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13418">[ date ]</a>
              <a href="thread.html#13418">[ thread ]</a>
              <a href="subject.html#13418">[ subject ]</a>
              <a href="author.html#13418">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
