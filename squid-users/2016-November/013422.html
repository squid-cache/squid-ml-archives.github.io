<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Using%20Squid%20to%20redirect%20Steam%20CDNs%20using%0A%09storeID_rewrite&In-Reply-To=%3CCAFd3cJ2S6m2sVbx3oTBzknHXOqorPud8Fg9bZBar4a-n21zR0g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013418.html">
   <LINK REL="Next"  HREF="013423.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite</H1>
    <B>Stefan Wickstrom</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Using%20Squid%20to%20redirect%20Steam%20CDNs%20using%0A%09storeID_rewrite&In-Reply-To=%3CCAFd3cJ2S6m2sVbx3oTBzknHXOqorPud8Fg9bZBar4a-n21zR0g%40mail.gmail.com%3E"
       TITLE="[squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite">carbonvirus at gmail.com
       </A><BR>
    <I>Sat Nov 12 23:50:51 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013418.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
        <LI>Next message (by thread): <A HREF="013423.html">[squid-users] Fwd: Using Squid to redirect Steam CDNs using storeID_rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13422">[ date ]</a>
              <a href="thread.html#13422">[ thread ]</a>
              <a href="subject.html#13422">[ subject ]</a>
              <a href="author.html#13422">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,
Apologies for the possibly incorrect format/posting of this query; I am new
to this mode of discussion in relation to software.

I am attempting to use Squid, in combination with storeID rewrite, to
redirect Steam CDN requests allowing multiple CDN requests to be served
from the single Squid cache entry.
Here's a breakdown of my current versions/configurations:

OS: IPFire 2.19 (x86_64) - core103
Kernel: Linux ipfire 3.14.65-ipfire #1
&lt;<A HREF="https://github.com/squid-cache/squid/pull/1">https://github.com/squid-cache/squid/pull/1</A>&gt; SMP Tue Jun 14 06:21:39 GMT
2016 x86_64 GNU/Linux
Squid: 3.5.19

/var/ipfire/proxy/advanced/acls/include.acl
#squid.conf
acl cacheDomain dstdomain .steampowered.com .edgesuite.net .steamstatic.com
.steamcontent.com
cache deny !cacheDomain
store_id_program /usr/lib/squid/storeid_file_rewrite
/etc/squid/storeid_rewrite.conf
store_id_children 10 startup=3 idle=1 concurrency=0

/etc/squid/storeid_rewrite.conf
^http.*steam.*\.com\/(.*) <A HREF="http://steamupdates.squid.internal/$1">http://steamupdates.squid.internal/$1</A>

The issue appears to be stemming from how squid and storeID_rewrite
interact; currently if I test the storeid_rewrite.conf with the following
command:
echo <A HREF="http://valve314.steamcontent.com/depot/255711/chunk/">http://valve314.steamcontent.com/depot/255711/chunk/</A>
a3f17a1be9c7861cbc56d1098b8ede146e114391? | /usr/lib/squid/storeid_file_rewrite
/etc/squid/storeid_rewrite.conf
I get in return:
OK store-id=<A HREF="http://steamupdates.squid.internal/depot/255711/chunk/">http://steamupdates.squid.internal/depot/255711/chunk/</A>
a3f17a1be9c7861cbc56d1098b8ede146e114391?

This indicates that storeID rewrite is functioning and using my RegEx
command to rewrite the URL into one that only contains the unique game and
chunk IDs from the URL. The issue is when I test the entire system using
the following process I see multiple entries into the squid cache for the
specific game chunk ID:

   - Remove /var/log/squid/access.log to ensure no previous attempts will
   appear in test
   - Clear the cache through ipFire webUI
   - Restart Squid cache service through ipFire webUI
   - Download game through Steam interface
   - Verify Squid cached the download chunks by grepping through both
   /var/log/squid/access.log and Squid cache for specific game chunk IDs (this
   is a spot check at best)
   - Change Steam CDN location through Steam UI
   - Delete Steam game local content
   - Re-download Steam game
   - Verify Squid cache using game chunk ID

The command used to grep against the Squid cache and it's results are as
follows:
squidclient -h 192.168.1.1 cache_<A HREF="object://192.168.1.1">object://192.168.1.1</A> mgr:objects | grep
f37f9405e2f38417a226eac378ac3982223d2966?
GET <A HREF="http://valve608.steamcontent.com/depot/26502/chunk/">http://valve608.steamcontent.com/depot/26502/chunk/</A>
f37f9405e2f38417a226eac378ac3982223d2966?
GET <A HREF="http://valve313.steamcontent.com/depot/26502/chunk/">http://valve313.steamcontent.com/depot/26502/chunk/</A>
f37f9405e2f38417a226eac378ac3982223d2966?

This indicates that at some point in the process, Squid is generating a KEY
entry for the chunk based off the original Steam CDN URL and NOT the
RegEx'd URL storeID_rewrite is supposedly generating.
I have attempted to determine how Squid is generating it's KEY entries for
the chunks it is storing, but have had no luck (basing attempts off this white
paper entry &lt;<A HREF="http://www.squid-cache.org/CacheDigest/cache-digest-v5.txt">http://www.squid-cache.org/CacheDigest/cache-digest-v5.txt</A>&gt;)
At this point I've exhausted my limited knowledge of how Squid and storeID
rewrite function and any assistance would be quite welcome; please let me
know if there's any further info needed to try and crack this walnut open!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161112/3529b155/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161112/3529b155/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013418.html">[squid-users] TCP Outgoing Address ACL Problem
</A></li>
	<LI>Next message (by thread): <A HREF="013423.html">[squid-users] Fwd: Using Squid to redirect Steam CDNs using storeID_rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13422">[ date ]</a>
              <a href="thread.html#13422">[ thread ]</a>
              <a href="subject.html#13422">[ subject ]</a>
              <a href="author.html#13422">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
