<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Using Squid to redirect Steam CDNs using storeID_rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Using%20Squid%20to%20redirect%20Steam%20CDNs%20using%0A%20storeID_rewrite&In-Reply-To=%3C95cea297-a891-ba1b-687e-29dea294c58c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013422.html">
   <LINK REL="Next"  HREF="013426.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Using Squid to redirect Steam CDNs using storeID_rewrite</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Using%20Squid%20to%20redirect%20Steam%20CDNs%20using%0A%20storeID_rewrite&In-Reply-To=%3C95cea297-a891-ba1b-687e-29dea294c58c%40treenet.co.nz%3E"
       TITLE="[squid-users] Fwd: Using Squid to redirect Steam CDNs using storeID_rewrite">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Nov 13 14:26:06 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013422.html">[squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite
</A></li>
        <LI>Next message (by thread): <A HREF="013426.html">[squid-users] Controlling Cache Peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13423">[ date ]</a>
              <a href="thread.html#13423">[ thread ]</a>
              <a href="subject.html#13423">[ subject ]</a>
              <a href="author.html#13423">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/11/2016 12:50 p.m., Stefan Wickstrom wrote:
&gt;<i> Hello all,
</I>&gt;<i> Apologies for the possibly incorrect format/posting of this query; I am new
</I>&gt;<i> to this mode of discussion in relation to software.
</I>&gt;<i> 
</I>&gt;<i> I am attempting to use Squid, in combination with storeID rewrite, to
</I>&gt;<i> redirect Steam CDN requests allowing multiple CDN requests to be served
</I>&gt;<i> from the single Squid cache entry.
</I>
Well, firstly. Store-ID does not _redirect_ anything. It simply
de-duplicates cache objects by re-writing the location where certain
ones are stored, so it is different to where their URL would store it.

If a backend server needs to be contacted the one the clients was going
to will be contacted and the shared Store-ID location gets updated with
any new data that server produces.

&gt;<i> 
</I>&gt;<i> /var/ipfire/proxy/advanced/acls/include.acl
</I>&gt;<i> #squid.conf
</I>&gt;<i> acl cacheDomain dstdomain .steampowered.com .edgesuite.net .steamstatic.com
</I>&gt;<i> .steamcontent.com
</I>&gt;<i> cache deny !cacheDomain
</I>&gt;<i> store_id_program /usr/lib/squid/storeid_file_rewrite
</I>&gt;<i> /etc/squid/storeid_rewrite.conf
</I>&gt;<i> store_id_children 10 startup=3 idle=1 concurrency=0
</I>&gt;<i> 
</I>&gt;<i> /etc/squid/storeid_rewrite.conf
</I>&gt;<i> ^http.*steam.*\.com\/(.*) <A HREF="http://steamupdates.squid.internal/$1">http://steamupdates.squid.internal/$1</A>
</I>&gt;<i> 
</I>
I highly recommend that you make that pattern a LOT more targeted. The
presence of &quot;.*&quot; allows any URL that happens to include the word &quot;steam&quot;
and then &quot;.com/&quot; to have its final portion stored in your cache as &quot;game
content&quot;.


&gt;<i> The issue appears to be stemming from how squid and storeID_rewrite
</I>&gt;<i> interact; currently if I test the storeid_rewrite.conf with the following
</I>&gt;<i> command:
</I>&gt;<i> echo <A HREF="http://valve314.steamcontent.com/depot/255711/chunk/">http://valve314.steamcontent.com/depot/255711/chunk/</A>
</I>&gt;<i> a3f17a1be9c7861cbc56d1098b8ede146e114391? | /usr/lib/squid/storeid_file_rewrite
</I>&gt;<i> /etc/squid/storeid_rewrite.conf
</I>&gt;<i> I get in return:
</I>&gt;<i> OK store-id=<A HREF="http://steamupdates.squid.internal/depot/255711/chunk/">http://steamupdates.squid.internal/depot/255711/chunk/</A>
</I>&gt;<i> a3f17a1be9c7861cbc56d1098b8ede146e114391?
</I>&gt;<i> 
</I>
NOTE: when your log contains URLs ending in '?' check that you have
turned off the strip_query_terms mechanism before debugging. Otherwise
that significant part of the URLs will be hidden from you, and your test
results may be different from expectations.
&lt;<A HREF="http://www.squid-cache.org/Doc/config/strip_query_terms/">http://www.squid-cache.org/Doc/config/strip_query_terms/</A>&gt;


&gt;<i> This indicates that storeID rewrite is functioning and using my RegEx
</I>&gt;<i> command to rewrite the URL into one that only contains the unique game and
</I>&gt;<i> chunk IDs from the URL.
</I>
No, the new key contains anything that happened to follow the string
&quot;.com/&quot;.

eg.
<A HREF="http://haha.example.net/steam/gotcha.com/depot/255711/chunk/a3f17a1be9c7861cbc56d1098b8ede146e114391?boo">http://haha.example.net/steam/gotcha.com/depot/255711/chunk/a3f17a1be9c7861cbc56d1098b8ede146e114391?boo</A>


&gt;<i> The issue is when I test the entire system using
</I>&gt;<i> the following process I see multiple entries into the squid cache for the
</I>&gt;<i> specific game chunk ID:
</I>&gt;<i> 
</I>&gt;<i>    - Remove /var/log/squid/access.log to ensure no previous attempts will
</I>&gt;<i>    appear in test
</I>&gt;<i>    - Clear the cache through ipFire webUI
</I>&gt;<i>    - Restart Squid cache service through ipFire webUI
</I>&gt;<i>    - Download game through Steam interface
</I>&gt;<i>    - Verify Squid cached the download chunks by grepping through both
</I>&gt;<i>    /var/log/squid/access.log and Squid cache for specific game chunk IDs (this
</I>&gt;<i>    is a spot check at best)
</I>&gt;<i>    - Change Steam CDN location through Steam UI
</I>&gt;<i>    - Delete Steam game local content
</I>&gt;<i>    - Re-download Steam game
</I>&gt;<i>    - Verify Squid cache using game chunk ID
</I>&gt;<i> 
</I>&gt;<i> The command used to grep against the Squid cache and it's results are as
</I>&gt;<i> follows:
</I>&gt;<i> squidclient -h 192.168.1.1 cache_<A HREF="object://192.168.1.1">object://192.168.1.1</A> mgr:objects | grep
</I>&gt;<i> f37f9405e2f38417a226eac378ac3982223d2966?
</I>&gt;<i> GET <A HREF="http://valve608.steamcontent.com/depot/26502/chunk/">http://valve608.steamcontent.com/depot/26502/chunk/</A>
</I>&gt;<i> f37f9405e2f38417a226eac378ac3982223d2966?
</I>&gt;<i> GET <A HREF="http://valve313.steamcontent.com/depot/26502/chunk/">http://valve313.steamcontent.com/depot/26502/chunk/</A>
</I>&gt;<i> f37f9405e2f38417a226eac378ac3982223d2966?
</I>&gt;<i> 
</I>
See the note above about strip_query_terms.

If a single byte of any of the query portion of those URLs is different
then your Store-ID keys for them will be likewise different. Since
*everything* following the &quot;.com/&quot; is part of the Store-ID key produced
by your pattern.


&gt;<i> This indicates that at some point in the process, Squid is generating a KEY
</I>&gt;<i> entry for the chunk based off the original Steam CDN URL and NOT the
</I>&gt;<i> RegEx'd URL storeID_rewrite is supposedly generating.
</I>
The mgr:objects report lists the client request that object was a
response to. &lt;<A HREF="http://wiki.squid-cache.org/Features/CacheManager/Objects">http://wiki.squid-cache.org/Features/CacheManager/Objects</A>&gt;

So the test above just indicates that objects exist which were stored
from those URLs. Client requests are of course not for the Store-ID
keys, but (one of) the actual URLs for that object.


&gt;<i> I have attempted to determine how Squid is generating it's KEY entries for
</I>&gt;<i> the chunks it is storing, but have had no luck (basing attempts off this white
</I>&gt;<i> paper entry &lt;<A HREF="http://www.squid-cache.org/CacheDigest/cache-digest-v5.txt">http://www.squid-cache.org/CacheDigest/cache-digest-v5.txt</A>&gt;)
</I>
That is about using digests used to inform other proxies about what is
possibly still in cache. Nothing to do with the storage itself. And
should not contain Store-ID keys (if it does that is a bug).

&gt;<i> At this point I've exhausted my limited knowledge of how Squid and storeID
</I>&gt;<i> rewrite function and any assistance would be quite welcome; please let me
</I>&gt;<i> know if there's any further info needed to try and crack this walnut open!
</I>&gt;<i> 
</I>
Start with disabling strip_query_terms. Then check the Store-ID keys
actually contain only the usefully different parts of the URL(s) input.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013422.html">[squid-users] Fwd: Using Squid to redirect Steam CDNs using	storeID_rewrite
</A></li>
	<LI>Next message (by thread): <A HREF="013426.html">[squid-users] Controlling Cache Peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13423">[ date ]</a>
              <a href="thread.html#13423">[ thread ]</a>
              <a href="subject.html#13423">[ subject ]</a>
              <a href="author.html#13423">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
