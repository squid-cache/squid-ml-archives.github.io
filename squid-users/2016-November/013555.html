<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to block www.infobae.com
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20block%20www.infobae.com&In-Reply-To=%3C7a9d2dbb-8975-006b-0a2a-9ce3a86641db%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013546.html">
   <LINK REL="Next"  HREF="013587.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to block www.infobae.com</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20block%20www.infobae.com&In-Reply-To=%3C7a9d2dbb-8975-006b-0a2a-9ce3a86641db%40treenet.co.nz%3E"
       TITLE="[squid-users] How to block www.infobae.com">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov 23 05:36:17 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013546.html">[squid-users] How to block www.infobae.com
</A></li>
        <LI>Next message (by thread): <A HREF="013587.html">[squid-users] How to block www.infobae.com
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13555">[ date ]</a>
              <a href="thread.html#13555">[ thread ]</a>
              <a href="subject.html#13555">[ subject ]</a>
              <a href="author.html#13555">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
You can simplify this quite a bit which might make things clearer.

Though please ensure that you are using a current 3.5.19 or later since
you are using SSL-Bump feature. Then run &quot;squid -k parse&quot; and erase the
obsolete options from your config file.


On 23/11/2016 12:40 a.m., chcs wrote:
&gt;<i> My squid (3.5.21) conf file:
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.10.1:3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;<i> capath=/usr/local/share/certs/
</I>&gt;<i> cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i> 
</I>&gt;<i> http_port 5.5.5.1:3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;<i> capath=/usr/local/share/certs/
</I>&gt;<i> cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i> 
</I>&gt;<i> http_port 127.0.0.1:3128 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;<i> capath=/usr/local/share/certs/
</I>&gt;<i> cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i> 
</I>&gt;<i> https_port 127.0.0.1:3129 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB cert=/usr/local/etc/squid/serverkey.pem
</I>&gt;<i> capath=/usr/local/share/certs/
</I>&gt;<i> cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> dhparams=/etc/dh-parameters.2048 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i> 
</I>
For all of the above;
* you have not configured an EC cipher to use (tls-dh= option)
  - so none of the ECDHE ciphers will work

* you have disabled DES
  - so none of the DES ciphers will work

* you have disables RC4
 - so none of the RC4 ciphers will work

Please run the comand:
  openssl ciphers -v \
'EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS'
 \
  | grep -v EC

to see what ciphers your Squid machine actually has available after that
reduction.

&gt;<i> icp_port 0
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> pid_filename /var/run/squid/squid.pid
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group proxy
</I>&gt;<i> error_default_language es
</I>&gt;<i> icon_directory /usr/local/etc/squid/icons
</I>&gt;<i> visible_hostname chcs
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">chca at hotmail.com</A>
</I>&gt;<i> access_log /var/squid/logs/access.log
</I>&gt;<i> cache_log /var/squid/logs/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> netdb_filename /var/squid/logs/netdb.state
</I>&gt;<i> pinger_enable on
</I>&gt;<i> pinger_program /usr/local/libexec/squid/pinger
</I>
Most of the above are default values. Check them against your Squid
version documentation and remove the ones that actually are default.
 &lt;<A HREF="http://www.squid-config.org/Doc/config/">http://www.squid-config.org/Doc/config/</A>&gt;

&gt;<i> sslcrtd_program /usr/local/libexec/squid/ssl_crtd -s /var/squid/lib/ssl_db
</I>&gt;<i> -M 4MB -b 2048
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> sslproxy_capath /usr/local/share/certs/
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i> sslproxy_cipher
</I>&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> 
</I>
Similar problem as with the ports. Only the EC ciphers should work here
because client does not need to configure a cipher.


&gt;<i> logfile_rotate 10
</I>&gt;<i> debug_options rotate=10
</I>
Above are more defaults you can remove.

&gt;<i> shutdown_lifetime 3 seconds
</I>&gt;<i> # Allow local network(s) on interface(s)
</I>&gt;<i> acl localnet src  192.168.10.0/24 5.5.5.0/24
</I>
Your LAN contains global IP address space 5.5.5.0/24?

&gt;<i> forwarded_for on
</I>&gt;<i> via off
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> uri_whitespace strip
</I>&gt;<i> 
</I>&gt;<i> acl dynamic urlpath_regex cgi-bin \?
</I>&gt;<i> cache deny dynamic
</I>
You already have the required refresh_pattern to handle these objects
correctly. You may want to consider removing the above two lines.


&gt;<i> 
</I>&gt;<i> cache_mem 1200 MB
</I>&gt;<i> maximum_object_size_in_memory 256 KB
</I>&gt;<i> memory_replacement_policy heap GDSF
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 50 MB
</I>&gt;<i> cache_dir aufs /var/squid/cache 128000 32 256
</I>
These...
&gt;<i> offline_mode off
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> cache allow all
</I>
... are more unnecessary defaults.


&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> refresh_pattern ^ftp:    1440  20%  10080
</I>&gt;<i> refresh_pattern ^gopher:  1440  0%  1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0  0%  0
</I>&gt;<i> refresh_pattern .    0  20%  4320
</I>&gt;<i> 
</I>
If you actually read the text in the comments below you will see that
most of these lines can be erased from your config file:

&gt;<i> # Setup some default acls
</I>&gt;<i> # From 3.2 further configuration cleanups have been done to make things
</I>&gt;<i> easier and safer. The manager, localhost, and to_localhost ACL definitions
</I>&gt;<i> are now built-in.
</I>&gt;<i> # acl localhost src 127.0.0.1/32
</I>&gt;<i> acl allsrc src all
</I>&gt;<i> acl safeports port 21 70 80 210 280 443
</I>&gt;<i> acl sslports port 443 563 8500 443 563
</I>&gt;<i> 
</I>&gt;<i> # From 3.2 further configuration cleanups have been done to make things
</I>&gt;<i> easier and safer. The manager, localhost, and to_localhost ACL definitions
</I>&gt;<i> are now built-in.
</I>&gt;<i> #acl manager proto cache_object
</I>&gt;<i> 
</I>
NP: the &quot;allsrc&quot; ACL is pointless. &quot;all&quot; works just fine still. It is
built-in too.

... leaving you with just:
 acl safeports port 21 70 80 210 280 443
 acl sslports port 443 563 8500 443 563

(though why you rename the default Safe_ports and SSL_ports ACLs is
beyond me).

&gt;<i> acl purge method PURGE
</I>&gt;<i> acl connect method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Define protocols used for redirects
</I>&gt;<i> acl HTTP proto HTTP
</I>&gt;<i> acl HTTPS proto HTTPS
</I>&gt;<i> acl allowed_subnets src 192.168.10.0/24 5.5.5.0/24
</I>
So &quot;allowed_subnets&quot; is identical to localnet.

Replace all 0 uses of &quot;allowed_subnets&quot; with &quot;localnet&quot; and remove the
above line.

Current recommendations are to move all these manager and purge:

&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>
... from here ...

&gt;<i> http_access deny !safeports
</I>&gt;<i> http_access deny CONNECT !sslports
</I>
... down to here after the quicker port checks have blocked attacks.

Also, your Squid does not appear to be doing anything that would make
you need PURGE functionality. You can remove the purge stuff and your
Squid will work a bit faster and with less memory.

&gt;<i> 
</I>&gt;<i> request_body_max_size 0 KB
</I>&gt;<i> delay_pools 1
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 -1/-1 -1/-1
</I>&gt;<i> delay_initial_bucket_level 100
</I>&gt;<i> delay_access 1 allow allsrc
</I>
The delay pool feature is doing nothing for your Squid except wasting
CPU time and memory. Erase all the above delay pool lines.

&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
Unnecessary old hack for Squid-3.1 SSL-Bump. Remove the above line.

If you are still using Squid-3.1 upgrade *urgently*.

&gt;<i> 
</I>&gt;<i> # Determina IPs para todopermitido
</I>&gt;<i> acl todopermitido src &quot;/usr/local/etc/squid/reglas/todopermitido.ips&quot;
</I>&gt;<i> 
</I>&gt;<i> # Determina IPs para parcialpermitido
</I>&gt;<i> acl parcialpermitido src &quot;/usr/local/etc/squid/reglas/parcialpermitido.ips&quot;
</I>&gt;<i> 
</I>&gt;<i> # Determina IPs para dhcp_lanwifi
</I>&gt;<i> acl dhcp_lanwifi src &quot;/usr/local/etc/squid/reglas/dhcp_lanwifi.ips&quot;
</I>&gt;<i> 
</I>
parcialpermitido and dhcp_lanwifi are of the same type and the rules
applied to both are identical.

You can simplify quite a bit by loading them into the same ACL check.
Liks this:


 # Determina IPs para parcialpermitido
 acl parcialpermitido src &quot;./parcialpermitido.ips&quot;

 # Determina IPs para dhcp_lanwifi
 acl parcialpermitido src &quot;./dhcp_lanwifi.ips&quot;

... then removing all other lines mentioning &quot;dhcp_lanwifi&quot;.


&gt;<i> # Reglas para permitidos
</I>&gt;<i> acl permitidos dstdomain &quot;/usr/local/etc/squid/reglas/permitidos.acl&quot;
</I>&gt;<i> 
</I>&gt;<i> # Reglas para no permitidos
</I>&gt;<i> acl nopermitidos dstdomain &quot;/usr/local/etc/squid/reglas/nopermitidos.acl&quot;
</I>&gt;<i> 
</I>&gt;<i> # Determina archivos no permitidos para descargar
</I>&gt;<i> acl extNO urlpath_regex -i &quot;/usr/local/etc/squid/reglas/extNO.acl&quot;
</I>&gt;<i> 
</I>&gt;<i> # Accesos
</I>&gt;<i> 
</I>&gt;<i> # Permisos para IPs &quot;todopermitido&quot;
</I>&gt;<i> # http_reply_access allow todopermitido skype
</I>&gt;<i> # http_reply_access allow todopermitido skypeIP
</I>&gt;<i> http_access deny todopermitido sxl
</I>&gt;<i> http_access deny todopermitido adsNO
</I>

&quot;sxl&quot; is not defined.

&quot;adsNO&quot; is also not defined.

Are you sure this is actually the config being run by your Squid?

&gt;<i> http_reply_access allow todopermitido all
</I>
Use of &quot;all&quot; is pointless here. Replace with:
 http_reply_access allow todopermitido

&gt;<i> 
</I>&gt;<i> # Permisos para IPs &quot;parcialpermitido&quot;
</I>&gt;<i> http_access deny parcialpermitido adsNO
</I>&gt;<i> http_access deny parcialpermitido extNO
</I>&gt;<i> http_reply_access allow parcialpermitido permitidos
</I>&gt;<i> http_reply_access deny parcialpermitido nopermitidos
</I>&gt;<i> 
</I>&gt;<i> # Permisos para IPs &quot;dhcp_lanwifi&quot;
</I>&gt;<i> http_access deny dhcp_lanwifi adsNO
</I>&gt;<i> http_access deny dhcp_lanwifi extNO
</I>&gt;<i> http_reply_access allow dhcp_lanwifi permitidos
</I>&gt;<i> http_reply_access deny dhcp_lanwifi nopermitidos
</I>&gt;<i> 
</I>
Since the next thing done is &quot;deny all&quot; you can remove all the liens
involving &quot;nopermitidos&quot;. It is a waste of CPU cycles checking.


&gt;<i> # Sitios no SSL interceptados
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl excludeSSL ssl::server_name_regex
</I>&gt;<i> &quot;/usr/local/etc/squid/reglas/nossl.acl&quot;
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice todopermitido excludeSSL
</I>&gt;<i> ssl_bump splice parcialpermitido excludeSSL
</I>&gt;<i> ssl_bump splice dhcp_lanwifi excludeSSL
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> # Deniega todo por defecto
</I>&gt;<i> http_reply_access deny all
</I>&gt;<i> 
</I>

Your http_access rules look very bad. You have just the default rule of
&quot;what is not denied explicitly is allowed&quot;.

So any visitor who is _not_ part of your todopermitido,
parcialpermitido, and dhcp_lanwifi files *is* allowed access to do
whatever the like with your proxy.

Also, any of the clients listed there is allowed to do anything they
like that is not explicitly forbidden.

Also, denying dstdomain, src, urlpath_* things at reply time is far too
late. All the badness they may be doing has already completed by the
time a reply starts coming back to Squid from the server.


So I advise re-writing your access rules as:

 http_access deny !safeports
 http_access deny CONNECT !sslports
 http_access allow localhost
 http_access deny manager
 http_access deny !localnet

 http_access deny todopermitido sxl
 http_access deny todopermitido adsNO
 http_access allow todopermitido

 http_access deny parcialpermitido adsNO
 http_access deny parcialpermitido extNO
 http_access allow parcialpermitido permitidos

 http_access deny all

NP: You may find there are things that have been happening that are not
allowed anymore with that. If you want them to keep happening add rules
to allow them.

As you your infobae problem. It might be a sie effect of that weird
permissions setup. But I think it is more likely to be certificate
pinning done by your browser, or the restricted set of ciphers you are
using.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013546.html">[squid-users] How to block www.infobae.com
</A></li>
	<LI>Next message (by thread): <A HREF="013587.html">[squid-users] How to block www.infobae.com
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13555">[ date ]</a>
              <a href="thread.html#13555">[ thread ]</a>
              <a href="subject.html#13555">[ subject ]</a>
              <a href="author.html#13555">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
