<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Wrong client IP address in log file
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20client%20IP%20address%20in%20log%20file&In-Reply-To=%3Cjzddchgnrnpdfztfnscd%40rxqb%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013599.html">
   <LINK REL="Next"  HREF="013592.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Wrong client IP address in log file</H1>
    <B>gk180984 at interia.pl</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Wrong%20client%20IP%20address%20in%20log%20file&In-Reply-To=%3Cjzddchgnrnpdfztfnscd%40rxqb%3E"
       TITLE="[squid-users] Wrong client IP address in log file">gk180984 at interia.pl
       </A><BR>
    <I>Fri Nov 25 13:31:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013599.html">[squid-users] Accelerator http to https
</A></li>
        <LI>Next message (by thread): <A HREF="013592.html">[squid-users] Wrong client IP address in log file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13589">[ date ]</a>
              <a href="thread.html#13589">[ thread ]</a>
              <a href="subject.html#13589">[ subject ]</a>
              <a href="author.html#13589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>HelloI'm looking solutions of my problem but I can't find.I have Squid + dansguardian installation as transparent proxy and in this configuration must be something wrong. This is a Debian 7 and working in local network as router (local address 10.0.0.4, 10.99.0.1).In dansguardian log file I have good IP client address, but in squid log file this address is equal to the router address (10.0.0.4).# tailf /var/log/dansguardian/access.log2016.11.25 13:52:16 - 10.99.0.98 <A HREF="http://businessclick.b...10.99.0.98">http://businessclick.b...10.99.0.98</A> is real client address~# tailf /var/log/squid/access.log25/Nov/2016:13:34:08 +0100 1480077248.293 170 10.0.0.4 10.0.0.4 TCP_MISS/200 1004 POST <A HREF="http://ocsp.digic...10.0.0.4">http://ocsp.digic...10.0.0.4</A> is not a real client address, it's look like dansguardian IP.&nbsp; Second address is a '%&gt;a' parameter, I try also with '%&gt;A'I try change squid and dansguardian listen address to 0.0.0.0 but this not help. I don't know what is the reason of that. I have same older installation in Debian 6 and there it works fine.My clients is: 10.0.0.0/24 10.99.0.0/24# squid -vSquid Cache: Version 2.7.STABLE9configure options:  '--prefix=/usr' '--exec_prefix=/usr' '--bindir=/usr/sbin' '--sbindir=/usr/sbin' '--libexecdir=/usr/lib/squid' '--sysconfdir=/etc/squid' '--localstatedir=/var/spool/squid' '--datadir=/usr/share/squid' '--with-pthreads' '--enable-async-io' '--enable-storeio=ufs,aufs,coss,diskd,null' '--enable-linux-netfilter' '--enable-arp-acl' '--enable-epoll' '--enable-removal-policies=lru,heap' '--enable-snmp' '--enable-delay-pools' '--enable-htcp' '--enable-cache-digests' '--enable-referer-log' '--enable-useragent-log' '--enable-auth=basic,digest,ntlm,negotiate' '--enable-negotiate-auth-helpers=squid_kerb_auth' '--enable-carp' '--enable-follow-x-forwarded-for' '--with-large-files' '--with-maxfd=65536' '--build' 'x86_64-linux-gnu' 'build_alias=x86_64-linux-gnu'# dansguardian -vDansGuardian 2.10.1.1Built with:  '--prefix=/usr' '--enable-clamav=yes' '--enable-clamd=yes' '--with-proxyuser=dansguardian' '--with-proxygroup=dansguardian' '--sysconfdir=/etc' '--localstatedir=/var' '--enable-icap=yes' '--enable-commandline=yes' '--enable-email=yes' '--enable-ntlm=yes' '--enable-trickledm=yes' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' 'CXXFLAGS=-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security' 'LDFLAGS=-Wl,-z,relro' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CFLAGS=-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security'~# netstat -ntlpActive Internet connections (only servers)Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name...tcp 0 0 10.99.0.1:8080 0.0.0.0:* LISTEN 8478/dansguardiantcp 0 0 10.0.0.4:8080 0.0.0.0:* LISTEN 8478/dansguardian...tcp 0 0 10.99.0.1:3128 0.0.0.0:* LISTEN 9952/(squid)tcp 0 0 10.0.0.4:3128 0.0.0.0:* LISTEN 9952/(squid)...# grep -v '^$\|^\s*\#' /etc/squid/squid.confacl all src 0.0.0.0/0.0.0.0acl manager proto cache_objectacl localhost src 127.0.0.1/32acl to_localhost dst 127.0.0.0/8acl LAN src 10.0.0.0/24acl LAN2 src 10.99.0.0/24acl SSL_ports port 443 # httpsacl Safe_ports port 80 # httpacl purge method PURGEacl CONNECT method CONNECThttp_access allow LANhttp_access allow LAN2http_access allow manager localhosthttp_access deny managerhttp_access allow purge localhosthttp_access deny purgehttp_access deny !Safe_portshttp_access allow localhosthttp_access deny allicp_access deny allfollow_x_forwarded_for allow localhosthttp_port 10.0.0.4:3128 transparenthttp_port 10.99.0.1:3128 transparenttcp_outgoing_address 79.188.96.14hierarchy_stoplist cgi-bin ?cache_mem 64 MBcache_dir ufs /tmp/squid 100 16 256logformat squid %tl %ts.%03tu %6tr %la %&gt;a %Ss/%03Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt &quot;%{User-Agent}&gt;h&quot;access_log /var/log/squid/access.log squidrefresh_pattern ^ftp: 1440 20% 10080refresh_pattern ^gopher: 1440 0% 1440refresh_pattern -i (/cgi-bin/|\?) 0 0% 0refresh_pattern (Release|Packages(.gz)*)$ 0 20% 2880refresh_pattern . 0 20% 4320acl shoutcast rep_header X-HTTP09-First-Line ^ICY.[0-9]upgrade_http0.9 deny shoutcastacl apache rep_header Server ^Apachebroken_vary_encoding allow apacheextension_methods REPORT MERGE MKACTIVITY CHECKOUThosts_file /etc/hostscoredump_dir /tmp/squid# grep -v '^$\|^\s*\#' /etc/dansguardian/dansguardian.confreportinglevel = 3languagedir = '/etc/dansguardian/languages'language = 'polish'loglevel = 2logexceptionhits = 2logfileformat = 1filterip = 10.0.0.4filterip = 10.99.0.1filterport = 8080proxyip = 10.0.0.4proxyip = 10.99.0.1proxyport = 3128accessdeniedaddress = '<A HREF="http://YOURSERVER.YOURDOMAIN/cgi-bin/dansguardian.pl">http://YOURSERVER.YOURDOMAIN/cgi-bin/dansguardian.pl</A>'nonstandarddelimiter = onusecustombannedimage = oncustombannedimagefile = '/usr/share/dansguardian/transparent1x1.gif'filtergroups = 1filtergroupslist = '/etc/dansguardian/lists/filtergroupslist'bannediplist = '/etc/dansguardian/lists/bannediplist'exceptioniplist = '/etc/dansguardian/lists/exceptioniplist'showweightedfound = onweightedphrasemode = 2urlcachenumber = 1000urlcacheage = 900scancleancache = onphrasefiltermode = 2preservecase = 0hexdecodecontent = offforcequicksearch = offreverseaddresslookups = offreverseclientiplookups = offlogclienthostnames = offcreatelistcachefiles = onmaxuploadsize = -1maxcontentfiltersize = 256maxcontentramcachescansize = 2000maxcontentfilecachescansize = 20000filecachedir = '/tmp'deletedownloadedtempfiles = oninitialtrickledelay = 20trickledelay = 10downloadmanager = '/etc/dansguardian/downloadmanagers/fancy.conf'downloadmanager = '/etc/dansguardian/downloadmanagers/default.conf'contentscannertimeout = 60contentscanexceptions = offrecheckreplacedurls = offforwardedfor = offusexforwardedfor = offlogconnectionhandlingerrors = onlogchildprocesshandling = offmaxchildren = 120minchildren = 8minsparechildren = 4preforkchildren = 6maxsparechildren = 32maxagechildren = 500maxips = 0ipcfilename = '/tmp/.dguardianipc'urlipcfilename = '/tmp/.dguardianurlipc'ipipcfilename = '/tmp/.dguardianipipc'nodaemon = offnologger = offlogadblocks = offloguseragent = offsoftrestart = offmailer = '/usr/sbin/sendmail -t'# iptables -L -nv -t natChain PREROUTING (policy ACCEPT 51435 packets, 3996K bytes)&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination11951&nbsp;
 590K REDIRECT&nbsp;&nbsp; tcp&nbsp; --&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10.0.0.0/24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:80flags: 0x17/0x02 state NEW redir ports 
8080&nbsp;8453&nbsp; 425K REDIRECT&nbsp;&nbsp; tcp&nbsp; --&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
10.99.0.0/24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:80flags: 0x17/0x02 
state NEW redir ports 8080Chain INPUT (policy ACCEPT 57817 packets, 3748K bytes)&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destinationChain OUTPUT (policy ACCEPT 54832 packets, 3473K bytes)&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destinationChain POSTROUTING (policy ACCEPT 21292 packets, 1338K bytes)&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp; 11M&nbsp; 990M MASQUERADE&nbsp; all&nbsp; --&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eth0&nbsp;&nbsp;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0Thanks for any help-- Grzegorz Kuczy&#324;ski
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161125/50235652/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161125/50235652/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013599.html">[squid-users] Accelerator http to https
</A></li>
	<LI>Next message (by thread): <A HREF="013592.html">[squid-users] Wrong client IP address in log file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13589">[ date ]</a>
              <a href="thread.html#13589">[ thread ]</a>
              <a href="subject.html#13589">[ subject ]</a>
              <a href="author.html#13589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
