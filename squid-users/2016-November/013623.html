<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy in AWS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20in%20AWS&In-Reply-To=%3C1480368783954-4680691.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013618.html">
   <LINK REL="Next"  HREF="013626.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy in AWS</H1>
    <B>kevin2345</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20in%20AWS&In-Reply-To=%3C1480368783954-4680691.post%40n4.nabble.com%3E"
       TITLE="[squid-users] Transparent Proxy in AWS">kevynt+squidusers at gmail.com
       </A><BR>
    <I>Mon Nov 28 21:33:03 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013618.html">[squid-users] Squid 3.5.x and NTLM
</A></li>
        <LI>Next message (by thread): <A HREF="013626.html">[squid-users] Transparent Proxy in AWS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13623">[ date ]</a>
              <a href="thread.html#13623">[ thread ]</a>
              <a href="subject.html#13623">[ subject ]</a>
              <a href="author.html#13623">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, new to squid here.  I'm trying to setup a transparent proxy with squid
for my internal hosts to reach outbound destinations.  We are hosted in AWS
with a VPC setup and multiple subnets.  The squid host is in a &quot;public&quot;
subnet that has outbound access, while the other subnets are &quot;private&quot; with
access to the hosts in the public subnet.  The end goal is to have all
outbound traffic in the VPC routed to the squid host before going to the
internet.  By doing this, we'll have a central &quot;choke point&quot; to manage in
terms of access/auditing.  We want to accomplish this with iptables rules on
the clients (eventually managed with config management) that direct outbound
traffic (http/https for example) to the squid host.

I've tried setting up the squid host with Ubuntu 14.04 and squid 3.3.8.  I
am testing http access with a curl to ifconfig.co (which would return the
external IP address), but I'm running into 403/access denied errors.  See
below for log excerpts and the config files.  &quot;172.18.128.58&quot; is my squid
proxy host and &quot;172.18.145.88&quot; is my test client.


squid.conf:
--------
http_port 3128 intercept
http_port 80

acl localnet src 172.18.0.0/16
acl localhost src 127.0.0.1

acl SSL_ports port 443
acl Safe_ports port 80 # http
acl Safe_ports port 443 # https
acl CONNECT method CONNECT
follow_x_forwarded_for allow localhost

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access allow all

cache_dir ufs /var/spool/squid3 100 16 256
coredump_dir /var/spool/squid3

visible_hostname squidhost

debug_options ALL,1 33,2 28,9
--------


squid logs:
--------
==&gt; /var/log/squid3/cache.log &lt;==
2016/11/28 19:26:45.118| Eui48.cc(262) lookup: Looking up ARP address for
172.18.145.88 on eth0
2016/11/28 19:26:45.118| Eui48.cc(537) lookup: 172.18.145.88 NOT found
2016/11/28 19:26:45.118| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187eab10
2016/11/28 19:26:45.118| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187eab10
2016/11/28 19:26:45.118| Checklist.cc(153) preCheck: 0x7f6f34837328 checking
slow rules
2016/11/28 19:26:45.118| Checklist.cc(160) checkAccessList: 0x7f6f34837328
checking 'http_access deny !Safe_ports'
2016/11/28 19:26:45.118| Acl.cc(336) matches: ACLList::matches: checking
!Safe_ports
2016/11/28 19:26:45.118| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'Safe_ports'
2016/11/28 19:26:45.118| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'Safe_ports' is 1
2016/11/28 19:26:45.118| Acl.cc(340) matches: Safe_ports matched, negating.
2016/11/28 19:26:45.118| Acl.cc(354) matches: !Safe_ports result is false
2016/11/28 19:26:45.118| Checklist.cc(275) matchNode: 0x7f6f34837328
matched=0 async=0 finished=0
2016/11/28 19:26:45.118| Checklist.cc(299) matchNode: 0x7f6f34837328 simple
mismatch
2016/11/28 19:26:45.118| Checklist.cc(160) checkAccessList: 0x7f6f34837328
checking 'http_access deny CONNECT !SSL_ports'
2016/11/28 19:26:45.118| Acl.cc(336) matches: ACLList::matches: checking
CONNECT
2016/11/28 19:26:45.118| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'CONNECT'
2016/11/28 19:26:45.118| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'CONNECT' is 0
2016/11/28 19:26:45.118| Acl.cc(349) matches: CONNECT mismatched.
2016/11/28 19:26:45.118| Acl.cc(354) matches: CONNECT result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34837328
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34837328 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34837328
checking 'http_access allow localhost manager'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
localhost
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'localhost'
2016/11/28 19:26:45.119| Ip.cc(134) aclIpAddrNetworkCompare:
aclIpAddrNetworkCompare: compare:
172.18.145.88:36030/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]
(172.18.145.88:36030)  vs
127.0.0.1-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]
2016/11/28 19:26:45.119| Ip.cc(560) match: aclIpMatchIp:
'172.18.145.88:36030' NOT found
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'localhost' is 0
2016/11/28 19:26:45.119| Acl.cc(349) matches: localhost mismatched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: localhost result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34837328
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34837328 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34837328
checking 'http_access deny manager'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
manager
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'manager'
2016/11/28 19:26:45.119| RegexData.cc(71) match: aclRegexData::match:
checking '<A HREF="http://ifconfig.co/">http://ifconfig.co/</A>'
2016/11/28 19:26:45.119| RegexData.cc(82) match: aclRegexData::match:
looking for '(^cache_<A HREF="object://">object://</A>)'
2016/11/28 19:26:45.119| RegexData.cc(82) match: aclRegexData::match:
looking for '(^https?://[^/]+/squid-internal-mgr/)'
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'manager' is 0
2016/11/28 19:26:45.119| Acl.cc(349) matches: manager mismatched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: manager result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34837328
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34837328 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34837328
checking 'http_access allow localnet'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
localnet
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'localnet'
2016/11/28 19:26:45.119| Ip.cc(134) aclIpAddrNetworkCompare:
aclIpAddrNetworkCompare: compare:
172.18.145.88:36030/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:0]
(172.18.0.0:36030)  vs
172.18.0.0-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:0]
2016/11/28 19:26:45.119| Ip.cc(560) match: aclIpMatchIp:
'172.18.145.88:36030' found
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'localnet' is 1
2016/11/28 19:26:45.119| Acl.cc(340) matches: localnet matched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: localnet result is true
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34837328
matched=1 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(260) matchNodes: 0x7f6f34837328
success: all ACLs matched
2016/11/28 19:26:45.119| Checklist.cc(146) markFinished: 0x7f6f34837328
answer ALLOWED for first matching rule won
2016/11/28 19:26:45.119| Checklist.cc(88) matchNonBlocking:
ACLChecklist::check: 0x7f6f34837328 match found, calling back with ALLOWED
2016/11/28 19:26:45.119| Checklist.cc(182) checkCallback:
ACLChecklist::checkCallback: 0x7f6f34837328 answer=ALLOWED
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187e9dd0
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187e9dd0
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187e9dd0
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187e9dd0
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187e9370
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187e9370
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7f6f34837328
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7f6f34837328
2016/11/28 19:26:45.119| Eui48.cc(262) lookup: Looking up ARP address for
172.18.128.58 on eth0
2016/11/28 19:26:45.119| Eui48.cc(537) lookup: 172.18.128.58 NOT found
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187eab10
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187eab10
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187ea430
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187ea430
2016/11/28 19:26:45.119| Checklist.cc(153) preCheck: 0x7f6f34837328 checking
slow rules
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34837328
checking 'follow_x_forwarded_for allow localhost'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
localhost
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'localhost'
2016/11/28 19:26:45.119| Ip.cc(134) aclIpAddrNetworkCompare:
aclIpAddrNetworkCompare: compare:
172.18.128.58/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff] (172.18.128.58)  vs
127.0.0.1-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]
2016/11/28 19:26:45.119| Ip.cc(560) match: aclIpMatchIp: '172.18.128.58' NOT
found
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'localhost' is 0
2016/11/28 19:26:45.119| Acl.cc(349) matches: localhost mismatched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: localhost result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34837328
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34837328 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(456) calcImplicitAnswer:
0x7f6f34837328 NO match found, last action ALLOWED so returning DENIED
2016/11/28 19:26:45.119| Checklist.cc(146) markFinished: 0x7f6f34837328
answer DENIED for implicit rule won
2016/11/28 19:26:45.119| Checklist.cc(182) checkCallback:
ACLChecklist::checkCallback: 0x7f6f34837328 answer=DENIED
2016/11/28 19:26:45.119| Checklist.cc(153) preCheck: 0x7f6f34c78a98 checking
slow rules
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34c78a98
checking 'http_access deny !Safe_ports'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
!Safe_ports
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'Safe_ports'
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'Safe_ports' is 1
2016/11/28 19:26:45.119| Acl.cc(340) matches: Safe_ports matched, negating.
2016/11/28 19:26:45.119| Acl.cc(354) matches: !Safe_ports result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34c78a98
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34c78a98 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34c78a98
checking 'http_access deny CONNECT !SSL_ports'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
CONNECT
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'CONNECT'
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'CONNECT' is 0
2016/11/28 19:26:45.119| Acl.cc(349) matches: CONNECT mismatched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: CONNECT result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34c78a98
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34c78a98 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34c78a98
checking 'http_access allow localhost manager'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
localhost
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'localhost'
2016/11/28 19:26:45.119| Ip.cc(134) aclIpAddrNetworkCompare:
aclIpAddrNetworkCompare: compare:
172.18.128.58/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff] (172.18.128.58)  vs
127.0.0.1-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]
2016/11/28 19:26:45.119| Ip.cc(560) match: aclIpMatchIp: '172.18.128.58' NOT
found
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'localhost' is 0
2016/11/28 19:26:45.119| Acl.cc(349) matches: localhost mismatched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: localhost result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34c78a98
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34c78a98 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34c78a98
checking 'http_access deny manager'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
manager
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'manager'
2016/11/28 19:26:45.119| RegexData.cc(71) match: aclRegexData::match:
checking '<A HREF="http://ifconfig.co/">http://ifconfig.co/</A>'
2016/11/28 19:26:45.119| RegexData.cc(82) match: aclRegexData::match:
looking for '(^cache_<A HREF="object://">object://</A>)'
2016/11/28 19:26:45.119| RegexData.cc(82) match: aclRegexData::match:
looking for '(^https?://[^/]+/squid-internal-mgr/)'
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'manager' is 0
2016/11/28 19:26:45.119| Acl.cc(349) matches: manager mismatched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: manager result is false
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34c78a98
matched=0 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(299) matchNode: 0x7f6f34c78a98 simple
mismatch
2016/11/28 19:26:45.119| Checklist.cc(160) checkAccessList: 0x7f6f34c78a98
checking 'http_access allow localnet'
2016/11/28 19:26:45.119| Acl.cc(336) matches: ACLList::matches: checking
localnet
2016/11/28 19:26:45.119| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'localnet'
2016/11/28 19:26:45.119| Ip.cc(134) aclIpAddrNetworkCompare:
aclIpAddrNetworkCompare: compare:
172.18.128.58/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:0] (172.18.0.0)  vs
172.18.0.0-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:0]
2016/11/28 19:26:45.119| Ip.cc(560) match: aclIpMatchIp: '172.18.128.58'
found
2016/11/28 19:26:45.119| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'localnet' is 1
2016/11/28 19:26:45.119| Acl.cc(340) matches: localnet matched.
2016/11/28 19:26:45.119| Acl.cc(354) matches: localnet result is true
2016/11/28 19:26:45.119| Checklist.cc(275) matchNode: 0x7f6f34c78a98
matched=1 async=0 finished=0
2016/11/28 19:26:45.119| Checklist.cc(260) matchNodes: 0x7f6f34c78a98
success: all ACLs matched
2016/11/28 19:26:45.119| Checklist.cc(146) markFinished: 0x7f6f34c78a98
answer ALLOWED for first matching rule won
2016/11/28 19:26:45.119| Checklist.cc(88) matchNonBlocking:
ACLChecklist::check: 0x7f6f34c78a98 match found, calling back with ALLOWED
2016/11/28 19:26:45.119| Checklist.cc(182) checkCallback:
ACLChecklist::checkCallback: 0x7f6f34c78a98 answer=ALLOWED
2016/11/28 19:26:45.119| WARNING: Forwarding loop detected for:
GET / HTTP/1.1
User-Agent: curl/7.35.0
Accept: */*
Via: 1.1 squidhost (squid/3.3.8)
X-Forwarded-For: 172.18.145.88
Cache-Control: max-age=259200
Connection: keep-alive
Host: ifconfig.co


2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187e99b0
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187e99b0
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff187e99b0
2016/11/28 19:26:45.119| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff187e99b0
2016/11/28 19:26:45.119| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7f6f34c78a98
2016/11/28 19:26:45.120| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7f6f34c78a98
2016/11/28 19:26:45.120| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7f6f34837328
2016/11/28 19:26:45.120| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7f6f34837328
2016/11/28 19:26:45.120| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7f6f34837328
2016/11/28 19:26:45.120| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7f6f34837328
2016/11/28 19:26:45.120| FilledChecklist.cc(77) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7f6f34837328
2016/11/28 19:26:45.120| Checklist.cc(334) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7f6f34837328

==&gt; /var/log/squid3/access.log &lt;==
1480361205.120      0 172.18.128.58 TCP_MISS/403 3629 GET
<A HREF="http://ifconfig.co/">http://ifconfig.co/</A> - HIER_NONE/- text/html
1480361205.120      1 172.18.145.88 TCP_MISS/403 3728 GET
<A HREF="http://ifconfig.co/">http://ifconfig.co/</A> - HIER_DIRECT/172.18.128.58 text/html

==&gt; /var/log/squid3/cache.log &lt;==

==&gt; /var/log/squid3/access.log &lt;==

==&gt; /var/log/squid3/cache.log &lt;==
2016/11/28 19:26:45.123| client_side.cc(777) swanSong:
local=172.18.128.58:3128 remote=172.18.145.88:36030 flags=33
--------


iptables rules on test client:
--------
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at ip-172-18-145-88</A>:~$ sudo iptables -t nat -nvL
Chain PREROUTING (policy ACCEPT 7 packets, 448 bytes)
 pkts bytes target     prot opt in     out     source              
destination

Chain INPUT (policy ACCEPT 7 packets, 448 bytes)
 pkts bytes target     prot opt in     out     source              
destination

Chain OUTPUT (policy ACCEPT 624 packets, 125K bytes)
 pkts bytes target     prot opt in     out     source              
destination
  442 26520 DNAT       tcp  --  *      *       0.0.0.0/0           
0.0.0.0/0            tcp dpt:80 to:172.18.128.58:3128

Chain POSTROUTING (policy ACCEPT 1066 packets, 152K bytes)
 pkts bytes target     prot opt in     out     source              
destination
--------


test commands on client:
--------
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at ip-172-18-145-88</A>:~$ curl <A HREF="https://ifconfig.co">https://ifconfig.co</A>
52.*.*.*


<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at ip-172-18-145-88</A>:~$ curl <A HREF="http://ifconfig.co">http://ifconfig.co</A>
...
&lt;div id=&quot;content&quot;&gt;
&lt;p&gt;The following error was encountered while trying to retrieve the URL: 
<A HREF="http://ifconfig.co/">http://ifconfig.co/</A> &lt;<A HREF="http://ifconfig.co/">http://ifconfig.co/</A>&gt;  &lt;/p&gt;

&lt;blockquote id=&quot;error&quot;&gt;
&lt;p&gt;*Access Denied.*&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Access control configuration prevents your request from being allowed at
this time. Please contact your service provider if you feel this is
incorrect.&lt;/p&gt;

&lt;p&gt;Your cache administrator is  webmaster
&lt;mailto:webmaster?subject=CacheErrorInfo%20-%20ERR_ACCESS_DENIED&amp;body=CacheHost%3A%20squidhost%0D%0AErrPage%3A%20ERR_ACCESS_DENIED%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Mon,%2028%20Nov%202016%2019%3A26%3A45%20GMT%0D%0A%0D%0AClientIP%3A%20172.18.128.58%0D%0A%0D%0AHTTP%20Request%3A%0D%0AGET%20%2F%20HTTP%2F1.1%0AUser-Agent%3A%20curl%2F7.35.0%0D%0AAccept%3A%20*%2F*%0D%0AVia%3A%201.1%20squidhost%20(squid%2F3.3.8)%0D%0AX-Forwarded-For%3A%20172.18.145.88%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20keep-alive%0D%0AHost%3A%20ifconfig.co%0D%0A%0D%0A%0D%0A&gt; 
.&lt;/p&gt;
&lt;br&gt;
&lt;/div&gt;
...
--------










--
View this message in context: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Transparent-Proxy-in-AWS-tp4680691.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Transparent-Proxy-in-AWS-tp4680691.html</A>
Sent from the Squid - Users mailing list archive at Nabble.com.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013618.html">[squid-users] Squid 3.5.x and NTLM
</A></li>
	<LI>Next message (by thread): <A HREF="013626.html">[squid-users] Transparent Proxy in AWS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13623">[ date ]</a>
              <a href="thread.html#13623">[ thread ]</a>
              <a href="subject.html#13623">[ subject ]</a>
              <a href="author.html#13623">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
