<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy in AWS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20in%20AWS&In-Reply-To=%3C583CF4B7.3030107%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013623.html">
   <LINK REL="Next"  HREF="013629.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy in AWS</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy%20in%20AWS&In-Reply-To=%3C583CF4B7.3030107%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent Proxy in AWS">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 29 03:23:35 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013623.html">[squid-users] Transparent Proxy in AWS
</A></li>
        <LI>Next message (by thread): <A HREF="013629.html">[squid-users] Squid 3.5.21 ssl bump and x-forward
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13626">[ date ]</a>
              <a href="thread.html#13626">[ thread ]</a>
              <a href="subject.html#13626">[ subject ]</a>
              <a href="author.html#13626">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 29/11/2016 10:33 a.m., kevin2345 wrote:
&gt;<i> Hello, new to squid here.  I'm trying to setup a transparent proxy with squid
</I>&gt;<i> for my internal hosts to reach outbound destinations.  We are hosted in AWS
</I>&gt;<i> with a VPC setup and multiple subnets.  The squid host is in a &quot;public&quot;
</I>&gt;<i> subnet that has outbound access, while the other subnets are &quot;private&quot; with
</I>&gt;<i> access to the hosts in the public subnet.  The end goal is to have all
</I>&gt;<i> outbound traffic in the VPC routed to the squid host before going to the
</I>&gt;<i> internet.  By doing this, we'll have a central &quot;choke point&quot; to manage in
</I>
Hint: In networking that is called a _gateway_ or router.

&gt;<i> terms of access/auditing.  We want to accomplish this with iptables rules on
</I>&gt;<i> the clients (eventually managed with config management) that direct outbound
</I>&gt;<i> traffic (http/https for example) to the squid host.
</I>
So long as you dont use DNAT or REDIRECT. Any form of routing or tunnel, 
or setting the clients gateway to be the Squid machine should be okay.

&gt;<i> I've tried setting up the squid host with Ubuntu 14.04 and squid 3.3.8.  I
</I>&gt;<i> am testing http access with a curl to ifconfig.co (which would return the
</I>&gt;<i> external IP address),
</I>
  ... but apparently does not.

&gt;<i>   but I'm running into 403/access denied errors.  See
</I>&gt;<i> below for log excerpts and the config files.  &quot;172.18.128.58&quot; is my squid
</I>&gt;<i> proxy host and &quot;172.18.145.88&quot; is my test client.
</I>
Not any old &quot;403 Access Denied&quot; but Forwarding Loop denials.


&gt;<i> squid.conf:
</I>&gt;<i> --------
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> http_port 80
</I>&gt;<i>
</I>&gt;<i> acl localnet src 172.18.0.0/16
</I>&gt;<i> acl localhost src 127.0.0.1
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> follow_x_forwarded_for allow localhost
</I>&gt;<i>
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow all
</I>&gt;<i>
</I>&gt;<i> cache_dir ufs /var/spool/squid3 100 16 256
</I>&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;<i>
</I>&gt;<i> visible_hostname squidhost
</I>&gt;<i>
</I>&gt;<i> debug_options ALL,1 33,2 28,9
</I>&gt;<i> --------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> squid logs:
</I>&gt;<i> --------
</I>&gt;<i> ==&gt; /var/log/squid3/cache.log &lt;==
</I>&gt;<i> 2016/11/28 19:26:45.119| WARNING: Forwarding loop detected for:
</I>&gt;<i> GET / HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.35.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Via: 1.1 squidhost (squid/3.3.8)
</I>&gt;<i> X-Forwarded-For: 172.18.145.88
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> Host: ifconfig.co
</I>&gt;<i>
</I>
&gt;<i>
</I>&gt;<i> ==&gt; /var/log/squid3/access.log &lt;==
</I>&gt;<i> 1480361205.120      0 172.18.128.58 TCP_MISS/403 3629 GET
</I>&gt;<i> <A HREF="http://ifconfig.co/">http://ifconfig.co/</A> - HIER_NONE/- text/html
</I>&gt;<i> 1480361205.120      1 172.18.145.88 TCP_MISS/403 3728 GET
</I>&gt;<i> <A HREF="http://ifconfig.co/">http://ifconfig.co/</A> - HIER_DIRECT/172.18.128.58 text/html
</I>&gt;<i>
</I>&gt;<i> ==&gt; /var/log/squid3/cache.log &lt;==
</I>&gt;<i>
</I>&gt;<i> ==&gt; /var/log/squid3/access.log &lt;==
</I>&gt;<i>
</I>&gt;<i> ==&gt; /var/log/squid3/cache.log &lt;==
</I>&gt;<i> 2016/11/28 19:26:45.123| client_side.cc(777) swanSong:
</I>&gt;<i> local=172.18.128.58:3128 remote=172.18.145.88:36030 flags=33
</I>&gt;<i> --------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> iptables rules on test client:
</I>&gt;<i> --------
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at ip-172-18-145-88</A>:~$ sudo iptables -t nat -nvL
</I>&gt;<i> Chain PREROUTING (policy ACCEPT 7 packets, 448 bytes)
</I>&gt;<i>   pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>
</I>&gt;<i> Chain INPUT (policy ACCEPT 7 packets, 448 bytes)
</I>&gt;<i>   pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>
</I>&gt;<i> Chain OUTPUT (policy ACCEPT 624 packets, 125K bytes)
</I>&gt;<i>   pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>    442 26520 DNAT       tcp  --  *      *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            tcp dpt:80 to:172.18.128.58:3128
</I>
The DNAT on the client informs Squid that the real IP of the server is 
172.18.128.58. Squid will send the request upstream to that IP ...

Please follow the Config Example 
&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>&gt;, in 
particular the first NOTE about where the configuration needs to be 
done. Hint: not on the client.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013623.html">[squid-users] Transparent Proxy in AWS
</A></li>
	<LI>Next message (by thread): <A HREF="013629.html">[squid-users] Squid 3.5.21 ssl bump and x-forward
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13626">[ date ]</a>
              <a href="thread.html#13626">[ thread ]</a>
              <a href="subject.html#13626">[ subject ]</a>
              <a href="author.html#13626">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
