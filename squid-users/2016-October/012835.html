<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] handshake problems with stare and bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20handshake%20problems%20with%20stare%20and%20bump&In-Reply-To=%3C838791f0-8b15-d3f5-0dc4-4c3d87def405%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012834.html">
   <LINK REL="Next"  HREF="012909.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] handshake problems with stare and bump</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20handshake%20problems%20with%20stare%20and%20bump&In-Reply-To=%3C838791f0-8b15-d3f5-0dc4-4c3d87def405%40gmail.com%3E"
       TITLE="[squid-users] handshake problems with stare and bump">yvoinov at gmail.com
       </A><BR>
    <I>Mon Oct  3 18:09:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012834.html">[squid-users] handshake problems with stare and bump
</A></li>
        <LI>Next message (by thread): <A HREF="012909.html">[squid-users] handshake problems with stare and bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12835">[ date ]</a>
              <a href="thread.html#12835">[ thread ]</a>
              <a href="subject.html#12835">[ subject ]</a>
              <a href="author.html#12835">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit#Hardening">http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit#Hardening</A>


03.10.2016 23:50, Marc &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I've got an issue with squid stare and bump, hope someone can help!
</I>&gt;<i>
</I>&gt;<i> I'm staring and bumping everything, using transparent proxy on Fedora
</I>&gt;<i> Core 24 using squid-3.5.20-1.fc24.x86_64 (see below for config). Now
</I>&gt;<i> the client (iphone app) does TLS v1.0 and has the following ciphers in
</I>&gt;<i> the Client Hello (from wireshark):
</I>&gt;<i> TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)
</I>&gt;<i> TLS_RSA_WITH_AES_128_CBC_SHA (0x002f)
</I>&gt;<i> TLS_RSA_WITH_3DES_EDE_CBC_SHA (0x000a)
</I>&gt;<i> TLS_RSA_WITH_RC4_128_SHA (0x0005)
</I>&gt;<i> TLS_RSA_WITH_RC4_128_MD5 (0x0004)
</I>&gt;<i> TLS_RSA_WITH_DES_CBC_SHA (0x0009)
</I>&gt;<i>
</I>&gt;<i> What squid does is replicating all of them in the Client Hello to the
</I>&gt;<i> server. This in general goes without problems most of the time, but in
</I>&gt;<i> this case not. In the cases where it fails, squid logs an error:
</I>&gt;<i> 2016/10/01 00:08:13 kid1| Error negotiating SSL on FD 26:
</I>&gt;<i> error:1409F07F:SSL routines:ssl3_write_pending:bad write retry
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> I've also seen:
</I>&gt;<i> 2016/10/02 20:53:09 kid1| Error negotiating SSL connection on FD 12:
</I>&gt;<i> error:1408A0C1:SSL routines:ssl3_get_client_hello:no shared cipher
</I>&gt;<i> (1/-1)
</I>&gt;<i>
</I>&gt;<i> Squid then sends the following html to the client (http over https
</I>&gt;<i> port 443 - I had to get it out of my pcap):
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> (71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</I>&gt;<i> Handshake with SSL server failed: error:1409F07F:SSL
</I>&gt;<i> routines:ssl3_write_pending:bad write retry
</I>&gt;<i> This proxy and the remote host failed to negotiate a mutually
</I>&gt;<i> acceptable security settings for handling your request. (..)
</I>&gt;<i> --
</I>&gt;<i> Now it would've been nicer if squid sent out that error over HTTPS,
</I>&gt;<i> but my main problem is the error happening in the first place.
</I>&gt;<i>
</I>&gt;<i> I think it has something to do with the cipher. If I look at my pcaps
</I>&gt;<i> I can see the webserver is selecting 'TLS_RSA_WITH_3DES_EDE_CBC_SHA
</I>&gt;<i> (0x000a)' in the Server Hello. In openssl, this cipher is called
</I>&gt;<i> 'DES-CBC3-SHA'. So if I try to reproduce on another client (linux),
</I>&gt;<i> only using one cipher in the client hello:
</I>&gt;<i> 1) echo -e &quot;GET / HTTP/1.1\nHost: $host\n\n&quot; | openssl s_client
</I>&gt;<i> -cipher DES-CBC3-SHA -quiet -connect $host:443 2&gt;/dev/null
</I>&gt;<i> 2) echo -e &quot;GET / HTTP/1.1\nHost: $host\n\n&quot; | openssl s_client
</I>&gt;<i> -cipher AES256-SHA -quiet -connect $host:443 2&gt;/dev/null
</I>&gt;<i>
</I>&gt;<i> 1 breaks like the iphone app. 2 works fine. I've looked on the host
</I>&gt;<i> squid is running on, but 1 works there as well. So the host running
</I>&gt;<i> squid seems to support the cipher, also according to openssl:
</I>&gt;<i> # openssl ciphers -V | grep &quot;0x00,0x0A&quot;
</I>&gt;<i>           0x00,0x0A - DES-CBC3-SHA            SSLv3 Kx=RSA      Au=RSA
</I>&gt;<i>  Enc=3DES(168) Mac=SHA1
</I>&gt;<i>
</I>&gt;<i> Things that come to mind:
</I>&gt;<i> 1) Why doesn't DES-CBC3-SHA work with squid ? The host seems to
</I>supports it.
&gt;<i> 2) Squid forwards the Client Hello, including ciphers the host running
</I>&gt;<i> squid doesn't support (in my case, the DES and RC4 ones). This could
</I>&gt;<i> also potentially lead to problems. Why doesn't squid filter them out
</I>&gt;<i> from the Client Hello sent from squid to the webserver ? Or replace
</I>&gt;<i> all of them with the ciphers preferred by squid. Perhaps by using the
</I>&gt;<i> sslproxy_cipher directive (which is currently ignored in ssl_bump
</I>&gt;<i> configurations).
</I>&gt;<i> 3) Nice to have: Is it possible for squid to report errors to the user
</I>&gt;<i> over HTTPS instead of HTTP ?
</I>&gt;<i>
</I>&gt;<i> My squid conf:
</I>&gt;<i>
</I>&gt;<i> #####################################
</I>&gt;<i> http_port      3128 transparent
</I>&gt;<i> https_port     3129 transparent ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=100MB
</I>&gt;<i> cert=/etc/pki/rootca/public+private.pem
</I>&gt;<i> http_port      3130 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=100MB
</I>&gt;<i> cert=/etc/pki/rootca/public+private.pem
</I>&gt;<i>
</I>&gt;<i> logformat      combined %&gt;a %ui %un [%tl] &quot;%rm %ru HTTP/%rv&quot; %Hs %&lt;st
</I>&gt;<i> &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %Ss:%Sh
</I>&gt;<i> access_log     /export/logs/squid/access_log combined
</I>&gt;<i> cache_log      /export/logs/squid/cache_log
</I>&gt;<i> coredump_dir   /var/spool/squid
</I>&gt;<i>
</I>&gt;<i> acl localhost  src    127.0.0.1/32 ::1
</I>&gt;<i>
</I>&gt;<i> acl localnet   src    10.5.0.0/16
</I>&gt;<i> acl localnet   src    fc00::/7
</I>&gt;<i> acl localnet   src    fe80::/10
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports  port   443
</I>&gt;<i> acl Safe_ports port   80
</I>&gt;<i> acl Safe_ports port   443
</I>&gt;<i> acl CONNECT    method CONNECT
</I>&gt;<i>
</I>&gt;<i> http_access    allow  manager     localhost
</I>&gt;<i> http_access    deny   manager
</I>&gt;<i> http_access    deny   !Safe_ports
</I>&gt;<i> http_access    deny   CONNECT     !SSL_ports
</I>&gt;<i> http_access    allow  localnet
</I>&gt;<i> http_access    allow  localhost
</I>&gt;<i> http_access    deny   all
</I>&gt;<i>
</I>&gt;<i> forwarded_for  delete
</I>&gt;<i> cache deny     all
</I>&gt;<i> always_direct  allow  all
</I>&gt;<i>
</I>&gt;<i> ssl_bump       stare  all
</I>&gt;<i> ssl_bump       bump   all
</I>&gt;<i> #####################################
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Marc
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJX8p7XAAoJENNXIZxhPexG9c0H/0I1b0yyZdHTTsb9q3jj+Tsv
Gggl5zd7xFy6lkV7Z7wtRdMOUrWzrSXGiVZz81uFbfizYf8rMZ4BJMDvGzhUFKN6
YJjLsqtBqaYRWbOqgWeXHngOIQKAeHbugOOcBMgNJ+bOhCSj0ZzkL1KdqZJpTR3b
0zSjwnRcsmmMk0Bdmck/ihRBrbRJ+rpOV3OX5h+viEO83UlIR3/Awz9FYd3oAg5Q
WWXz9ugyFXzkHF9DABeTuckd9z0L0/eIercPdIPCgB/QkfF9nlyY7vm17ijNfare
ehAPdP4+dH7jjZjg5KWICXL9ijMSL/eoR9gzbPuCDWqDYNzHAjVMrIH336nJeT8=
=+epU
-----END PGP SIGNATURE-----

-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161004/f03f3c3e/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161004/f03f3c3e/attachment.key</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012834.html">[squid-users] handshake problems with stare and bump
</A></li>
	<LI>Next message (by thread): <A HREF="012909.html">[squid-users] handshake problems with stare and bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12835">[ date ]</a>
              <a href="thread.html#12835">[ thread ]</a>
              <a href="subject.html#12835">[ subject ]</a>
              <a href="author.html#12835">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
