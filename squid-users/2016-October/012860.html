<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20squid%20tproxy%20ssl-bump%20and%20Protocol%20error%20%28TLS%0A%20code%3A%20SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C2aeb5cbc-67aa-0742-efb1-ab123c638bc6%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012855.html">
   <LINK REL="Next"  HREF="012920.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20squid%20tproxy%20ssl-bump%20and%20Protocol%20error%20%28TLS%0A%20code%3A%20SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C2aeb5cbc-67aa-0742-efb1-ab123c638bc6%40treenet.co.nz%3E"
       TITLE="[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct  4 12:06:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012855.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
        <LI>Next message (by thread): <A HREF="012920.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12860">[ date ]</a>
              <a href="thread.html#12860">[ thread ]</a>
              <a href="subject.html#12860">[ subject ]</a>
              <a href="author.html#12860">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/10/2016 12:07 a.m., Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Whatever the reason, for an end-user like me it seems that the XP
</I>&gt;&gt;&gt;<i> client is able to negotiate TLS correctly with Google and
</I>&gt;&gt;&gt;<i> presumably using the cipher DES-CBC3-SHA (maybe after failing
</I>&gt;&gt;&gt;<i> with RC4-MD5 on a first attempt), whereas Squid immediately fails
</I>&gt;&gt;&gt;<i> with RC4-MD5. It doesn't ever seem to try DES-CBC3-SHA even
</I>&gt;&gt;&gt;<i> though it's available in openssl.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ... in this case it might be. But not for the reasons stated. The 
</I>&gt;&gt;<i> problem known so far is that RC4-MD5 cipher. Why it is not being
</I>&gt;&gt;<i> used by your OpenSSL library.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> That could bear some further investigation. There may be things you
</I>&gt;&gt;<i> need to enable in the config passed to OpenSSL, or a different
</I>&gt;&gt;<i> build of the library needed. Something along those lines - Im just
</I>&gt;&gt;<i> guessing here.
</I>&gt;<i> 
</I>&gt;<i> Thanks for your reply.
</I>&gt;<i> 
</I>&gt;<i> I don't fully understand your point. I hope you don't mind if I try
</I>&gt;<i> to make a quick recap here below:
</I>&gt;<i> 
</I>&gt;<i> 1) www.google.com ONLY allows the following ciphers for TLS V 1.0
</I>&gt;<i> (which is the highest TLS version for WinXP IE8):
</I>&gt;<i> 
</I>&gt;<i> TLSv1.0: ciphers: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA - strong 
</I>&gt;<i> TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA - strong 
</I>&gt;<i> TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA - strong 
</I>&gt;<i> TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA - strong 
</I>&gt;<i> TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong TLS_RSA_WITH_AES_128_CBC_SHA -
</I>&gt;<i> strong TLS_RSA_WITH_AES_256_CBC_SHA - strong
</I>&gt;<i> 
</I>&gt;<i> Correct?
</I>&gt;<i> 
</I>
Insufficient data. Assuming true ...


&gt;<i> 2) According to <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> the
</I>&gt;<i> Windows XP IE8 client supports: TLS 1.0 and the following cipher
</I>&gt;<i> list: TLS_RSA_WITH_RC4_128_MD5 (0x4)   INSECURE 128 
</I>&gt;<i> TLS_RSA_WITH_RC4_128_SHA (0x5)   INSECURE 128 
</I>&gt;<i> TLS_RSA_WITH_3DES_EDE_CBC_SHA (0xa)  112 TLS_RSA_WITH_DES_CBC_SHA
</I>&gt;<i> (0x9)   WEAK 56 TLS_RSA_EXPORT1024_WITH_RC4_56_SHA (0x64)   INSECURE
</I>&gt;<i> 56 TLS_RSA_EXPORT1024_WITH_DES_CBC_SHA (0x62)   WEAK 56 
</I>&gt;<i> TLS_RSA_EXPORT_WITH_RC4_40_MD5 (0x3)   INSECURE 40 
</I>&gt;<i> TLS_RSA_EXPORT_WITH_RC2_CBC_40_MD5 (0x6)   INSECURE 40 
</I>&gt;<i> TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA (0x13)   Forward Secrecy2  112 
</I>&gt;<i> TLS_DHE_DSS_WITH_DES_CBC_SHA (0x12)   WEAK 56 
</I>&gt;<i> TLS_DHE_DSS_EXPORT1024_WITH_DES_CBC_SHA (0x63)   WEAK 56
</I>&gt;<i> 
</I>&gt;<i> of which the least weak are:
</I>&gt;<i> 
</I>&gt;<i> TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA TLS_RSA_WITH_3DES_EDE_CBC_SHA
</I>&gt;<i> 
</I>&gt;<i> Does that sound correct?
</I>&gt;<i> 
</I>
Insufficient data. Assuming true ...


&gt;<i> 3) I'm deducing from the previous two points that the only eligible
</I>&gt;<i> cipher is TLS_RSA_WITH_3DES_EDE_CBC_SHA because it's the only cipher
</I>&gt;<i> supported by both google.com and WinXP&amp;IE8.
</I>&gt;<i> 
</I>&gt;<i> Right?
</I>&gt;<i> 
</I>
Yes. Qualified by above assumptions.


&gt;<i> 4) According to <A HREF="https://testssl.sh/openssl-rfc.mappping.html">https://testssl.sh/openssl-rfc.mappping.html</A> the
</I>&gt;<i> openssl cipher name equivalent for TLS_RSA_WITH_3DES_EDE_CBC_SHA is
</I>&gt;<i> DES-CBC3-SHA.
</I>&gt;<i> 
</I>&gt;<i> Correct?
</I>
Yes.

&gt;<i> 
</I>&gt;<i> 5) So if all the previous points are correct, now I'm assuming that
</I>&gt;<i> if I run openssl at the command line on the same system where Squid
</I>&gt;<i> is running then I can &quot;reproduce&quot; what the WinXP client &quot;wants&quot;. I
</I>&gt;<i> run the following:
</I>&gt;<i> 
</I>&gt;<i> # openssl s_client -connect google.com:443 -tls1 -cipher
</I>&gt;<i> DES-CBC3-SHA [...] SSL-Session: Protocol  : TLSv1 Cipher    :
</I>&gt;<i> DES-CBC3-SHA [...] (that went well)
</I>&gt;<i> 
</I>&gt;<i> I also run this other command:
</I>&gt;<i> 
</I>&gt;<i> # curl --tlsv1.0 --ciphers DES-CBC3-SHA <A HREF="https://www.google.com">https://www.google.com</A>
</I>&gt;<i> --trace trace.log
</I>&gt;<i> 
</I>&gt;<i> The trace.log file contains lines such as: == Info: Cipher selection:
</I>&gt;<i> DES-CBC3-SHA Handshake OK and web page is accessed.
</I>&gt;<i> 
</I>&gt;<i> Is it correct to assume at this point that the current openssl build
</I>&gt;<i> on this system is &quot;OK&quot; as far as supporting &quot;Win XP TLS 1.0 ciphers
</I>&gt;<i> to access at least google.com&quot;?
</I>
Yes. The build is capable of it. That is one of 3 conditions that must
be met for it to work.

The other two being:

* whether it is enabled in the library config.
 - OpenSSL library has its own conf file somewhere.
 - it is possible that curl and other tools whose primary design purpose
is communication (not testing) override the library normal defaults for
their own use, or re-try certain things after failures. That needs to be
eliminated to be sure.

* that the squid.conf settings combine with those library settings to
cause it to be (or stay) enabled.


&gt;<i> 
</I>&gt;<i> 6) I don't understand why you say that my openssl library does not
</I>&gt;<i> use RC4-MD5 (did I understand your sentence correctly?). Why should
</I>&gt;<i> the RC4-MD5 cipher be used in the first place? Who is requesting it?
</I>&gt;<i> If it's the Windows XP client then it should obviously be discarded
</I>&gt;<i> since google.com does not support it. So maybe this is what IE8 on XP
</I>&gt;<i> does: it first tries RC4-MD5 and when that fails, it goes for
</I>&gt;<i> DES-CBC3-SHA. In any case, when the WinXP client uses Squid as MITM,
</I>&gt;<i> Squid *IS* using the RC4-MD5 cipher *AND* my openssl library *does*
</I>&gt;<i> support this cipher as shown in the following command:
</I>&gt;<i> 
</I>&gt;<i> # openssl ciphers 
</I>&gt;<i> ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:SRP-DSS-AES-256-CBC-SHA:SRP-RSA-AES-256-CBC-SHA:SRP-AES-256-CBC-SHA:DH-DSS-AES256-GCM-SHA384:DHE-DSS-AES256-GCM-SHA384:DH-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA256:DH-RSA-AES256-SHA256:DH-DSS-AES256-SHA256:DHE-RSA-AES256-SHA:DHE-DSS-AES256-SHA:DH-RSA-AES256-SHA:DH-DSS-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:DHE-DSS-CAMELLIA256-SHA:DH-RSA-CAMELLIA256-SHA:DH-DSS-CAMELLIA256-SHA:ECDH-RSA-AES256-GCM-SHA384:ECDH-ECDSA-AES256-GCM-SHA384:ECDH-RSA-AES256-SHA384:ECDH-ECDSA-AES256-SHA384:ECDH-RSA-AES256-SHA:ECDH-ECDSA-AES256-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:CAMELLIA256-SHA:PSK-AES256-CBC-SHA:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:SRP-DSS-AES-128-CBC-SHA:SRP-RSA-AES-128-CBC-SHA:SRP-AES-128-CBC-SHA:DH-DSS-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:DH-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-SHA256:DHE-DSS-AES128-SHA256:DH-RSA-AES128-SHA256:DH-DSS-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA:DH-RSA-AES128-SHA:DH-DSS-AES128-SHA:DHE-RSA-SEED-SHA:DHE-DSS-SEED-SHA:DH-RSA-SEED-SHA:DH-DSS-SEED-SHA:DHE-RSA-CAMELLIA128-SHA:DHE-DSS-CAMELLIA128-SHA:DH-RSA-CAMELLIA128-SHA:DH-DSS-CAMELLIA128-SHA:ECDH-RSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-GCM-SHA256:ECDH-RSA-AES128-SHA256:ECDH-ECDSA-AES128-SHA256:ECDH-RSA-AES128-SHA:ECDH-ECDSA-AES128-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:SEED-SHA:CAMELLIA128-SHA:IDEA-CBC-SHA:PSK-AES128-CBC-SHA:KRB5-IDEA-CBC-SHA:KRB5-IDEA-CBC-MD5:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:ECDH-RSA-RC4-SHA:ECDH-ECDSA-RC4-SHA:RC4-SHA:RC4-MD5:PSK-RC4-SHA:KRB5-RC4-SHA:KRB5-RC4-MD5:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:SRP-DSS-3DES-EDE-CBC-SHA:SRP-RSA-3DES-EDE-CBC-SHA:SRP-3DES-EDE-CBC-SHA:EDH-RSA-DES-CBC3-SHA:EDH-DSS-DES-CBC3-SHA:DH-RSA-DES-CBC3-SHA:DH-DSS-DES-CBC3-SHA:ECDH-RSA-DES-CBC3-SHA:ECDH-ECDSA-DES-CBC3-SHA:DES-CBC3-SHA:PSK-3DES-EDE-CBC-SHA:KRB5-DES-CBC3-SHA:KRB5-DES-CBC3-MD5:EDH-RSA-DES-CBC-SHA:EDH-DSS-DES-CBC-SHA:DH-RSA-DES-CBC-SHA:DH-DSS-DES-CBC-SHA:DES-CBC-SHA:KRB5-DES-CBC-SHA:KRB5-DES-CBC-MD5
</I>&gt;<i>
</I>&gt;<i>  Am I right?
</I>&gt;<i> 
</I>Yes. Sorry. I should have written DES-CBC3-SHA instead.


&gt;<i> 7) Squid uses openssl, right?
</I>&gt;<i> 
</I>
For SSL-Bump in current Squid releases. Yes.

&gt;<i> 8) If the previous point is true then shouldn't I assume that Squid
</I>&gt;<i> should have the same features as the ones I can &quot;reproduce&quot; by
</I>&gt;<i> running the openssl commands as in the above examples? In other
</I>&gt;<i> words, shouldn't Squid &quot;support&quot; both RC4-MD5 and DES-CBC3-SHA?
</I>&gt;<i> 
</I>
No. see the answer to (5).


&gt;<i> 9) If all the previous points are true then: a) I'm lucky b) I'd like
</I>&gt;<i> to know if the issue is simply the fact that Squid is unable to do
</I>&gt;<i> anything with WinXP&amp;IE8 clients that wrongly ask to use a cipher
</I>&gt;<i> that's not supoprted by a given web site. Since it's MITM, Squid
</I>&gt;<i> can't negotiate another cipher I suppose. But then again, like I said
</I>&gt;<i> before, I don't know how the internals work.
</I>
Squid has to decrypt and re-encrypt the two TCP connections data.
That adds the third set of ciphers (those supported by Squid \w OpenSSL)
to the sets which must overlap.

So far we can assume that it is either a Squid bug relaying the
available cipher list between the two remote endpoints. Or that the set
of ciphers available to Squid does not include the DES-CBC3-SHA one.

To test that last detail you probably need to setup a normal https_port
with SSL and see if you can connect to it with TLSv1.0 and only that
cipher in curl. That will eliminate any possible server details
polluting the test result.


&gt;<i> 
</I>&gt;<i> 10) I'm not stating that &quot;working TLS behaviour is a bug in Squid&quot;.
</I>&gt;<i> I'm merely assuming that if some modern TLS 1.2 clients can connect
</I>&gt;<i> seemlessly with Squid in a MITM scenario (intercepted ssl-bump) then
</I>&gt;<i> the same should happen with older TLS 1.0 clients when connecting to
</I>&gt;<i> sites that supoprt both the protocol and the ciphers.
</I>&gt;<i> 
</I>&gt;<i> Is that an incorrect assumption?
</I>
&quot;should&quot; is determined by that 3-way cipher set combo (amongst other
protocol feature 3-way combos). The fact that the library can be
configured independent of any application using it throws a rather big
spanner into the expected behaviour logics.

&gt;<i> 
</I>&gt;<i> If the WinXP client is faulty because it doesn't abide to the
</I>&gt;<i> standard protocol then I'll assume it can't be used with Squid as
</I>&gt;<i> MITM and force users to browse with FF or upgrade their OS.
</I>
Sorry, what I was trying to get across was that one endpoint not
following the protocol properly is when bumping *does* work.

So throwing blame at anyone when it &quot;fails&quot; without a bug being clearly
in evidence is the wrong thing to do. It is usually a sign that
everybody is actually doing &quot;The Right Thing&quot;.

So far your tests are showing that it is about a 50/50 chance of being a
bug in Squid versus a Squid/OpenSSL misconfiguration somewhere.

Amos
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012855.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
	<LI>Next message (by thread): <A HREF="012920.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12860">[ date ]</a>
              <a href="thread.html#12860">[ thread ]</a>
              <a href="subject.html#12860">[ subject ]</a>
              <a href="author.html#12860">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
