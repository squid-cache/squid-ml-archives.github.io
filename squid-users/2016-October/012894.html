<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] problem in configuring squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20in%20configuring%20squid&In-Reply-To=%3C4fbed5fe-bd6e-54c9-1fce-ddcb449774cd%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012878.html">
   <LINK REL="Next"  HREF="012829.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] problem in configuring squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20problem%20in%20configuring%20squid&In-Reply-To=%3C4fbed5fe-bd6e-54c9-1fce-ddcb449774cd%40treenet.co.nz%3E"
       TITLE="[squid-users] problem in configuring squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct  5 01:02:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012878.html">[squid-users] problem in configuring squid
</A></li>
        <LI>Next message (by thread): <A HREF="012829.html">[squid-users] IPv6 interception crash: Ip::Address::getInAddr : Cannot convert non-IPv4 to IPv4.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12894">[ date ]</a>
              <a href="thread.html#12894">[ thread ]</a>
              <a href="subject.html#12894">[ subject ]</a>
              <a href="author.html#12894">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/10/2016 4:42 a.m., Shark wrote:
&gt;<i> Sorry for my bad english,
</I>&gt;<i> 
</I>&gt;<i> I want to make a anonymous https &amp; http proxy that pass through any
</I>&gt;<i> requests without decrypting or change them,
</I>&gt;<i> only change ip address from client ip to my server ip address and define ip
</I>&gt;<i> address of my websites that i want to access them from my client in
</I>&gt;<i> /etc/hosts,
</I>&gt;<i> so i try to install squid on my server and i have good experience when i
</I>&gt;<i> set proxy in client with server ip and port 3128 and i can access http &amp;
</I>&gt;<i> https behind this proxy,
</I>
By configuring your client with details about the proxy you have
configured a forward (aka explicit) proxy.

That is the best type to have when you can. Because it lets you use the
full capabilities of proxying in HTTP.

However, it also means that the clients do not use DNS nor /etc/hosts
file. The proxy is what does DNS lookups about where to send the traffic
the client(s) ask it to fetch.


&gt;<i> but when i try to using /etc/hosts i cannot access to https websites.
</I>
HTTPS is designed to prevent people playing around with the traffic. The
'S' means *secure(d)* - for a good reason.

&gt;<i> i try
</I>&gt;<i> to install squid lot of time with any install instructions that i found
</I>&gt;<i> from googling.
</I>&gt;<i> I have server with CentOS 7 with one valid internet ip address.
</I>&gt;<i> 
</I>&gt;<i> For more explain of what i want to do, i need my squid to work like this ip
</I>&gt;<i> 173.161.0.227
</I>&gt;<i> When i add *173.161.0.227 www.iplocation.net &lt;<A HREF="http://www.iplocation.net">http://www.iplocation.net</A>&gt;* to
</I>&gt;<i> my client /etc/hosts
</I>&gt;<i> I can browse <A HREF="https://www.iplocation.net">https://www.iplocation.net</A> that tell me my client ip address
</I>&gt;<i> is 173.161.0.227
</I>&gt;<i> I want do my proxy server same as 173.161.0.227
</I>&gt;<i> 
</I>
&gt;<i>From what you have said so far it is clear the domain names you plan to
</I>use this for are owned by somebody who is not you.


&gt;<i> *My problem is now with below config is:*
</I>&gt;<i> 
</I>&gt;<i> when i define *216.55.x.x www.iplocation.net &lt;<A HREF="http://www.iplocation.net">http://www.iplocation.net</A>&gt;* to
</I>&gt;<i> /etc/hosts in my client i cannot access to <A HREF="https://www.iplocation.net">https://www.iplocation.net</A> and
</I>&gt;<i> hang on connecting and then give me timeout error,
</I>&gt;<i> I`m appreciate for help me to resolve this problem.
</I>&gt;<i> I ask it before in
</I>&gt;<i> <A HREF="http://serverfault.com/questions/805413/squid-with-iptables-bypass-https">http://serverfault.com/questions/805413/squid-with-iptables-bypass-https</A>
</I>&gt;<i>  but i cannot resolve it
</I>
When you are not the owner of that domain name; ..

That means you do not own the secret encryption key that HTTPS
associates with that domain name.

That means you cannot setup your proxy to perform encryption/decryption
of traffic when acting as a web server for it.

The only options you have for HTTPS are:

1) to use the proxy as a proper forward/explicit proxy the normal way
HTTP does that.

Or

2) to forget the idea of setting your own IP as web server and use MITM
interception of the clients normal port 443 traffic with SSL-Bump
feature enabled in your Squid.


&gt;<i> 
</I>&gt;<i> *My Iptables config is:*
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3130
</I>&gt;<i> 
</I>
That is okay. It is the (2) option mentioned above.

Be aware that it is incompatible with the idea of setting /etc/hosts IP
address for the domain as a way to get it to the proxy.

This iptables rules is the way to catch client traffic already on its
way to the *real* domain server(s) and send it through the proxy instead.

It is a bit nasty to work with, but still way better than MITM through
/etc/hosts entries.


&gt;<i> *My squid config is:*
</I>&gt;<i> 
</I>&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> http_port 3128
</I>
Okay. This port will accept traffic from the above option (1) setups.


&gt;<i> http_port 80
</I>
No.

&gt;<i> http_port 0.0.0.0:3129 ssl-bump  cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> https_port 0.0.0.0:3130 ssl-bump intercept
</I>&gt;<i> cert=/etc/squid/ssl_cert/myCA.pem generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>
Okay. These ports will accept traffic for the above option (2) setups.


&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
Those are wrong for any installation. Even testing ones. You need to see
the errors to even start to find solutions.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012878.html">[squid-users] problem in configuring squid
</A></li>
	<LI>Next message (by thread): <A HREF="012829.html">[squid-users] IPv6 interception crash: Ip::Address::getInAddr : Cannot convert non-IPv4 to IPv4.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12894">[ date ]</a>
              <a href="thread.html#12894">[ thread ]</a>
              <a href="subject.html#12894">[ subject ]</a>
              <a href="author.html#12894">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
