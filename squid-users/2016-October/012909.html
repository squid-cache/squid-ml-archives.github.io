<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] handshake problems with stare and bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20handshake%20problems%20with%20stare%20and%20bump&In-Reply-To=%3CCAPxJK5Ca9cyqu7dG%3DTH5tf-dSvj3cK8x1VQu%2BQ2DX25QOG9hEA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012835.html">
   <LINK REL="Next"  HREF="012838.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] handshake problems with stare and bump</H1>
    <B>Marc</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20handshake%20problems%20with%20stare%20and%20bump&In-Reply-To=%3CCAPxJK5Ca9cyqu7dG%3DTH5tf-dSvj3cK8x1VQu%2BQ2DX25QOG9hEA%40mail.gmail.com%3E"
       TITLE="[squid-users] handshake problems with stare and bump">gaardiolor at gmail.com
       </A><BR>
    <I>Wed Oct  5 16:30:31 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012835.html">[squid-users] handshake problems with stare and bump
</A></li>
        <LI>Next message (by thread): <A HREF="012838.html">[squid-users] handshake problems with stare and bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12909">[ date ]</a>
              <a href="thread.html#12909">[ thread ]</a>
              <a href="subject.html#12909">[ subject ]</a>
              <a href="author.html#12909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for the replies. I've figured out more details. First, my
assumption that sslproxy_cipher was ignored in my setup was incorrect.
I confused it with what I've read about sslproxy_options on
<A HREF="http://bazaar.launchpad.net/~yadi/squid/warnings/revision/13928">http://bazaar.launchpad.net/~yadi/squid/warnings/revision/13928</A> .
Thanks Yuri for making me come to that conclusion. So I've put in
'sslproxy_cipher ALL' (just for troubleshooting purposes..). After
that, previously mentioned test 1 works on the linux client, however,
the iphone app still does not. So I went on and did more tests.

First, the iphone uses more then one cipher. I'll start with curl,
using TLS1.0 like the app.

3) curl --insecure --tlsv1.0 <A HREF="https://www.google.com">https://www.google.com</A>
SQUID_ERR_SSL_HANDSHAKE. So with the default ciphers curl using tls
1.0 also breaks.

4) curl --insecure --tlsv1.0 --ciphers rsa_3des_sha <A HREF="https://www.google.com">https://www.google.com</A>
Works. So using one cipher 'fixes' it.. just like we saw using openssl
s_client. Back to openssl s_client, default ciphers.

5) echo -e &quot;GET / HTTP/1.1\nHost: www.google.com\n\n&quot; | openssl
s_client -quiet -connect www.google.com:443 -tls1
SQUID_ERR_SSL_HANDSHAKE. Also here, using more ciphers generates an error.

6) echo -e &quot;GET / HTTP/1.1\nHost: www.google.com\n\n&quot; | openssl
s_client -quiet -connect www.google.com:443 -tls1_1
SQUID_ERR_SSL_HANDSHAKE. TLS 1.1 does not help.

7) echo -e &quot;GET / HTTP/1.1\nHost: www.google.com\n\n&quot; | openssl
s_client -quiet -connect www.google.com:443 -tls1_2
This works! When using TLS 1.2, we do not have this problem. Note that
compared to the previous 2 tests we have an extra TLS security
extension in the Client Hello, signature_algorithms. Now more tests
with TLS 1.0.

8) Firefox with TLS 1.0 (security.tls.version.max = 1).
Works. But.. Firefox is also using multiple ciphers. Hmm. Firefox also
uses a whole bunch of TLS Extensions with TLS 1.0. Back to openssl and
focus on extensions.

9) echo -e &quot;GET / HTTP/1.1\nHost: www.google.com\n\n&quot; | openssl
s_client -quiet -connect www.google.com:443 -tls1 -servername
www.google.com
SQUID_ERR_SSL_HANDSHAKE. Adding the server_name extension doesn't
help. Now let's try to add other TLS extensions. Since openssl didn't
want to play along I started with a fake one, 33554.

10) echo -e &quot;GET / HTTP/1.1\nHost: www.google.com\n\n&quot; | openssl
s_client -quiet -connect www.google.com:443 -tls1 -servername
www.google.com -serverinfo 33554
This works! Removing SNI, keeping the fake extension:

11) echo -e &quot;GET / HTTP/1.1\nHost: www.google.com\n\n&quot; | openssl
s_client -quiet -connect www.google.com:443 -tls1 -serverinfo 33554
Also works. Adding other extensions instead of the fake one also works.

So yeah.. I'm still confused.
- If TLS v1.0 or TLS v1.1, and more then one cipher, and not some
seemingly random extension then error. TLS v1.2 seems to work, maybe
just because the extra extension signature_algorithms, no idea.
- Squid forwards ciphers in the Client Hello to the webserver, except
for some CHACHA20 ones that are filtered out. Squid should make it's
own decision though when using stare right ? Squid does upgrade the
TLS version.

Should I report 2 bugs and/or attach debug logging ? I'll try test
with squid4 later this week. It doesn't want to compile on FC24 for
some reason.. while my gcc has c11 support. Have to dive into it..
unless someone has tips.

#######
# /usr/bin/g++ -DHAVE_CONFIG_H -I../.. -I../../include -I../../lib
-I../../src -I../../include -I../../libltdl -Wall -Wpointer-arith
-Wwrite-strings -Wcomments -Wshadow -Woverloaded-virtual -Werror
-Wno-deprecated-register -pipe -D_REENTRANT -g -O2 -march=native -MT
Handshake.lo -MD -MP -MF .deps/Handshake.Tpo -c Handshake.cc -o
Handshake.o
Handshake.cc: In member function &#8216;void
Security::HandshakeParser::parseServerCertificates(const SBuf&amp;)&#8217;:
Handshake.cc:560:31: error: &#8216;cert&#8217; may be used uninitialized in this
function [-Werror=maybe-uninitialized]
         Security::CertPointer cert;
                               ^~~~
At global scope:
cc1plus: error: unrecognized command line option
&#8216;-Wno-deprecated-register&#8217; [-Werror]
cc1plus: all warnings being treated as errors

# g++ --version
g++ (GCC) 6.2.1 20160916 (Red Hat 6.2.1-2)
Copyright (C) 2016 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/6.2.1/lto-wrapper
Target: x86_64-redhat-linux
Configured with: ../configure --enable-bootstrap
--enable-languages=c,c++,objc,obj-c++,fortran,ada,go,lto --prefix=/usr
--mandir=/usr/share/man --infodir=/usr/share/info
--with-bugurl=<A HREF="http://bugzilla.redhat.com/bugzilla">http://bugzilla.redhat.com/bugzilla</A> --enable-shared
--enable-threads=posix --enable-checking=release --enable-multilib
--with-system-zlib --enable-__cxa_atexit
--disable-libunwind-exceptions --enable-gnu-unique-object
--enable-linker-build-id --with-linker-hash-style=gnu --enable-plugin
--enable-initfini-array --disable-libgcj --with-isl --enable-libmpx
--enable-gnu-indirect-function --with-tune=generic --with-arch_32=i686
--build=x86_64-redhat-linux
Thread model: posix
gcc version 6.2.1 20160916 (Red Hat 6.2.1-2) (GCC)

#######

Regards,

Marc

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012835.html">[squid-users] handshake problems with stare and bump
</A></li>
	<LI>Next message (by thread): <A HREF="012838.html">[squid-users] handshake problems with stare and bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12909">[ date ]</a>
              <a href="thread.html#12909">[ thread ]</a>
              <a href="subject.html#12909">[ subject ]</a>
              <a href="author.html#12909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
