<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] intercept + IPv6 + IPFilter 5.1
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercept%20%2B%20IPv6%20%2B%20IPFilter%205.1&In-Reply-To=%3C57F54B52.4000803%40egervary.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012845.html">
   <LINK REL="Next"  HREF="012816.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] intercept + IPv6 + IPFilter 5.1</H1>
    <B>Egerv&#225;ry Gergely</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercept%20%2B%20IPv6%20%2B%20IPFilter%205.1&In-Reply-To=%3C57F54B52.4000803%40egervary.hu%3E"
       TITLE="[squid-users] intercept + IPv6 + IPFilter 5.1">gergely at egervary.hu
       </A><BR>
    <I>Wed Oct  5 18:49:54 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012845.html">[squid-users] intercept + IPv6 + IPFilter 5.1
</A></li>
        <LI>Next message (by thread): <A HREF="012816.html">[squid-users] --enable-openssl-crtd -- not	building	openssl-crtd? (3.5.21)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12913">[ date ]</a>
              <a href="thread.html#12913">[ thread ]</a>
              <a href="subject.html#12913">[ subject ]</a>
              <a href="author.html#12913">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i> Should &quot;intercept&quot; work with IPv6 on NetBSD 7-STABLE and IPFilter 5.1?
</I>
Okay, we have &quot;fixed&quot; Squid interception, and IPFilter in the kernel,
and now it's working good. But did we do it in the right way?

While reading ip_nat.c in IPFilter, I found that SIOCGNATL - and its
function called ipf_nat_lookupredir() - is a frontend to two functions:
ipf_nat_inlookup() and ipf_nat_outlookup().

We are now calling SIOCGNATL to use ipf_nat_outlookup(). But should not
we call it to use ipf_nat_inlookup() instead?

In Squid, we are working with 3 different addresses:
- source IP:port of the connection (browser client)
- real destination IP:port (the target web server)
- interception destination IP:port (Squid itself)

In IPFilter, the terminology is different: &quot;real&quot; refers to the
original source, not the original destination.

In my understanding, on redirect (RDR) rules, where we know the
original source address and the rewrited destination address, we should
use ipf_nat_inlookup() to get the original destination address.

ipf_nat_outlookup() should be used on source-NAT (MAP) scenarios,
what we don't need for Squid.

If that's true, IPFilter was correct - we have to revert our IPFilter
patches - and modify Intercept.cc instead.

See IPFilter source code comments below:

========
Function: ipf_nat_inlookup
Returns: nat_t* - NULL == no match, else pointer to matching NAT entry
Parameters:
fin(I) - pointer to packet information
flags(I) - NAT flags for this packet
p(I) - protocol for this packet
src(I) - source IP address
mapdst(I) - destination IP address

Lookup a nat entry based on the mapped destination ip address/port
and real source address/port. We use this lookup when receiving a
packet, we're looking for a table entry, based on the destination
address.

========
Function: ipf_nat_outlookup
Returns: nat_t* - NULL == no match, else pointer to matching NAT entry
Parameters:
fin(I) - pointer to packet information
flags(I) - NAT flags for this packet
p(I) - protocol for this packet
src(I) - source IP address
dst(I) - destination IP address
rw(I) - 1 == write lock on held, 0 == read lock.

Lookup a nat entry based on the source 'real' ip address/port
and destination address/port. We use this lookup when sending a packet
out, we're looking for a table entry, based on the source address.

========

See full ip_nat.c source code here:

<A HREF="http://cvsweb.netbsd.org/bsdweb.cgi/src/sys/external/bsd/ipf/netinet/ip_nat.c?rev=1.16&amp;content-type=text/x-cvsweb-markup">http://cvsweb.netbsd.org/bsdweb.cgi/src/sys/external/bsd/ipf/netinet/ip_nat.c?rev=1.16&amp;content-type=text/x-cvsweb-markup</A>

Thank you,
-- 
Gergely EGERVARY


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012845.html">[squid-users] intercept + IPv6 + IPFilter 5.1
</A></li>
	<LI>Next message (by thread): <A HREF="012816.html">[squid-users] --enable-openssl-crtd -- not	building	openssl-crtd? (3.5.21)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12913">[ date ]</a>
              <a href="thread.html#12913">[ thread ]</a>
              <a href="subject.html#12913">[ subject ]</a>
              <a href="author.html#12913">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
