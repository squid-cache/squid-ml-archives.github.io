<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20squid%20tproxy%20ssl-bump%20and%20Protocol%20error%20%28TLS%0A%20code%3A%20SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C586bfd7a-ce0b-5654-a63c-da03e20a0bcb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012929.html">
   <LINK REL="Next"  HREF="012825.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20squid%20tproxy%20ssl-bump%20and%20Protocol%20error%20%28TLS%0A%20code%3A%20SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C586bfd7a-ce0b-5654-a63c-da03e20a0bcb%40treenet.co.nz%3E"
       TITLE="[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct  6 10:57:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012929.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
        <LI>Next message (by thread): <A HREF="012825.html">[squid-users] Caching application/octet-stream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12935">[ date ]</a>
              <a href="thread.html#12935">[ thread ]</a>
              <a href="subject.html#12935">[ subject ]</a>
              <a href="author.html#12935">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/10/2016 8:46 p.m., Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----- Original Message -----
</I>&gt;&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;&gt;<i> Is it correct to assume at this point that the current openssl
</I>&gt;&gt;&gt;<i> build on this system is &quot;OK&quot; as far as supporting &quot;Win XP TLS 1.0
</I>&gt;&gt;&gt;<i> ciphers to access at least google.com&quot;?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Yes. The build is capable of it. That is one of 3 conditions that
</I>&gt;&gt;<i> must
</I>&gt;<i> 
</I>&gt;&gt;<i> be met for it to work.&gt; The other two being:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> * whether it is enabled in the library config. - OpenSSL library
</I>&gt;&gt;<i> has its own conf file somewhere. - it is possible that curl and
</I>&gt;&gt;<i> other tools whose primary design purpose
</I>&gt;<i> 
</I>&gt;&gt;<i> is communication (not testing) override the library normal defaults
</I>&gt;&gt;<i> for&gt; their own use, or re-try certain things after failures. That
</I>&gt;&gt;<i> needs to be
</I>&gt;<i> 
</I>&gt;&gt;<i> eliminated to be sure.&gt; * that the squid.conf settings combine with
</I>&gt;&gt;<i> those library settings to
</I>&gt;<i> 
</I>&gt;&gt;<i> cause it to be (or stay) enabled.[...] So far we can assume that it
</I>&gt;&gt;<i> is either a Squid bug relaying the
</I>&gt;<i> 
</I>&gt;&gt;<i> available cipher list between the two remote endpoints. Or that the
</I>&gt;&gt;<i> set of ciphers available to Squid does not include the DES-CBC3-SHA
</I>&gt;&gt;<i> one.[...]
</I>&gt;<i> 
</I>&gt;&gt;<i> The fact that the library can be
</I>&gt;<i> 
</I>&gt;&gt;<i> configured independent of any application using it throws a rather
</I>&gt;&gt;<i> big
</I>&gt;<i> 
</I>&gt;&gt;<i> spanner into the expected behaviour logics.
</I>&gt;<i> [...]
</I>&gt;&gt;<i> So far your tests are showing that it is about a 50/50 chance of
</I>&gt;&gt;<i> being a bug in Squid versus a Squid/OpenSSL misconfiguration
</I>&gt;&gt;<i> somewhere.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I don't know what a library configuration file is. OpenSSL has a CONF
</I>&gt;<i> library/functions to read its own .cnf files. An application such as
</I>&gt;<i> Squid can use these functions to read a conf file, or not.
</I>
Unless I'm totally confused there is a system-wide conf file that the
library can/does load on its own before all that.

&gt;<i> 
</I>&gt;<i> I'm assuming that at compile time, both the openssl library and squid
</I>&gt;<i> were built with most features. Is there a way to list available
</I>&gt;<i> openssl ciphers from squid (like a squid command line tool)? As if
</I>&gt;<i> Squid were to call an openssl library function to &quot;list available
</I>&gt;<i> ciphers&quot;,or something.
</I>
Unfortunately not. Squid (mostly) passes the squid.conf strings directly
to the library parser so that list the library produced should be what
Squid is _able_ to use. The detail to be careful of is whether
squid.conf contains any such strings that change the library defaults.

&gt;<i> 
</I>&gt;&gt;<i> To test that last detail you probably need to setup a normal
</I>&gt;&gt;<i> https_port with SSL and see if you can connect to it with TLSv1.0
</I>&gt;&gt;<i> and only that cipher in curl. That will eliminate any possible
</I>&gt;&gt;<i> server details polluting the test result.
</I>&gt;<i> 
</I>&gt;<i> What is a &quot;normal https_port with SSL&quot;? eg. https_port 3132
</I>&gt;<i> cert=/etc/ssl/squid/proxyserver.pem I would appreciate a full conf
</I>&gt;<i> example so there are no squid misconfigurations that would make the
</I>&gt;<i> test results even more confusing.
</I>
I mean an https_port that is not doing ssl-bump or intercept.

 https_port 3129 ssl \
   cert=/etc/ssl/squid/cert.pem \
   key=/etc/ssl/squid/key.pam

(unless you have cert + key in the same .pem, then key= is not needed)

&gt;<i> 
</I>&gt;<i> BTW, does sslproxy_cipher default to ALL if undefined in squid.conf?
</I>&gt;<i> 
</I>
No.

If undefined in squid.conf the library default ciphers are used. In
recent years that has been a bit volatile and changes with library
version, so I cant be more specific.

&quot;ALL&quot; enables a lot of ciphers and TLS/SSL features that were known to
be unsafe when the library was released. So are not included in the
default available set.


&gt;<i>. Squid
</I>&gt;<i> &quot;debug_options&quot; is already very verbose but maybe it would help in
</I>&gt;<i> this case to add extra information as to how Squid is calling openssl
</I>&gt;<i> (and maybe seeing if it's possible to get the cipher list).
</I>&gt;<i> 
</I>
Good idea. Thanks.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012929.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
	<LI>Next message (by thread): <A HREF="012825.html">[squid-users] Caching application/octet-stream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12935">[ date ]</a>
              <a href="thread.html#12935">[ thread ]</a>
              <a href="subject.html#12935">[ subject ]</a>
              <a href="author.html#12935">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
