<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ICAP question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20question&In-Reply-To=%3Ce48029e8-b0aa-32a2-1b65-1ed310597898%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012975.html">
   <LINK REL="Next"  HREF="012977.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ICAP question</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20question&In-Reply-To=%3Ce48029e8-b0aa-32a2-1b65-1ed310597898%40measurement-factory.com%3E"
       TITLE="[squid-users] ICAP question">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Oct  9 18:43:23 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012975.html">[squid-users] ICAP question
</A></li>
        <LI>Next message (by thread): <A HREF="012977.html">[squid-users] ICAP question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12976">[ date ]</a>
              <a href="thread.html#12976">[ thread ]</a>
              <a href="subject.html#12976">[ subject ]</a>
              <a href="author.html#12976">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/09/2016 11:02 AM, James Lay wrote:

&gt;<i> WARNING: Squid is configured to use ICAP method REQMOD for service
</I>&gt;<i> <A HREF="icap://localhost:1344/srv_cfg_filter">icap://localhost:1344/srv_cfg_filter</A> but OPTIONS response declares the
</I>&gt;<i> methods are RESPMOD
</I>
If your srv_content_filtering.so service does not need to see HTTP
requests, then you can remove srv_cfg_filter_req from your Squid
configuration.

If your srv_content_filtering.so service needs to see both HTTP requests
and responses, then you have two options, in no particular order:

A) Tell c-icap and/or srv_content_filtering.so to send a &quot;Methods:
REQMOD,RESPMOD&quot; ICAP response header field in OPTIONS response. Sorry, I
do not know how to do that in c-icap and even whether that is actually
possible with that software. Please note that using one service URI for
two modes is not uncommon in the ICAP world, but violates the following
ICAP RFC 3507 MUST:

  Each service should have a distinct URI
  and support only one method in addition to OPTIONS

B) Use different ICAP service URIs for different services (REQMOD and
RESPMOD) and configure each service appropriately on both Squid and
c-icap side. This is what RFC 3507 wants you to do. For example, some
ICAP servers and services would allow you to use these URIs:

  * for REQMOD: <A HREF="icap://localhost:1344/srv_cfg_filter?mode=REQMOD">icap://localhost:1344/srv_cfg_filter?mode=REQMOD</A>
  * for RESPMOD: <A HREF="icap://localhost:1344/srv_cfg_filter?mode=RESPMOD">icap://localhost:1344/srv_cfg_filter?mode=RESPMOD</A>


IIRC, Squid will try to use your service in both modes despite that
WARNING. However, I do not know whether c-icap and that service itself
will be happy about receiving REQMOD requests.


HTH,

Alex.



&gt;<i> Here's the icap snippet from squid.conf:
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_persistent_connections on
</I>&gt;<i> icap_service srv_cfg_filter_req reqmod_precache
</I>&gt;<i> <A HREF="icap://localhost:1344/srv_cfg_filter">icap://localhost:1344/srv_cfg_filter</A> bypass=on
</I>&gt;<i> adaptation_access srv_cfg_filter_req allow all
</I>&gt;<i> icap_service srv_cfg_filter_resp respmod_precache
</I>&gt;<i> <A HREF="icap://localhost:1344/srv_cfg_filter">icap://localhost:1344/srv_cfg_filter</A> bypass=off
</I>&gt;<i> adaptation_access srv_cfg_filter_resp allow all
</I>&gt;<i> 
</I>&gt;<i> interesting c-icap.conf bits:
</I>&gt;<i> 
</I>&gt;<i> ModulesDir /opt/icap/lib/c_icap
</I>&gt;<i> ServicesDir /opt/icap/lib/c_icap
</I>&gt;<i> acl localhost src 127.0.0.1/255.255.255.255
</I>&gt;<i> acl PERMIT_REQUESTS type REQMOD RESPMOD
</I>&gt;<i> icap_access allow localhost PERMIT_REQUESTS
</I>&gt;<i> icap_access deny all
</I>&gt;<i> Include srv_content_filtering.conf
</I>&gt;<i> 
</I>&gt;<i> lastly, srv_content_filtering.conf:
</I>&gt;<i> 
</I>&gt;<i> Service srv_cfg_filter srv_content_filtering.so
</I>&gt;<i> srv_content_filtering.Match default body /(test)/ig score=5
</I>&gt;<i> LogFormat mySrvContentFiltering &quot;%tl, %&gt;a %im %is %huo  [Scores:
</I>&gt;<i> %{srv_content_filtering:scores}Sa] [ActionFilter:
</I>&gt;<i> %{srv_content_filtering:action_filter}Sa] [Action:
</I>&gt;<i> %{srv_content_filtering:action}Sa]&quot;
</I>&gt;<i> 
</I>&gt;<i> not sure why I can't seem to get this to fly...any assistance would be
</I>&gt;<i> appreciated...thank you.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012975.html">[squid-users] ICAP question
</A></li>
	<LI>Next message (by thread): <A HREF="012977.html">[squid-users] ICAP question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12976">[ date ]</a>
              <a href="thread.html#12976">[ thread ]</a>
              <a href="subject.html#12976">[ subject ]</a>
              <a href="author.html#12976">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
