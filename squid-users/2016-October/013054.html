<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Identifying%20the%20source%20of%20Invalid-request%20%28squid%0A%203%29%20-%3E%20error%3Atransaction-end-before-headers%20%28Squid%204%29&In-Reply-To=%3C9fe943c5-28d8-1f17-6f36-ccc16169222f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013053.html">
   <LINK REL="Next"  HREF="013056.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Identifying%20the%20source%20of%20Invalid-request%20%28squid%0A%203%29%20-%3E%20error%3Atransaction-end-before-headers%20%28Squid%204%29&In-Reply-To=%3C9fe943c5-28d8-1f17-6f36-ccc16169222f%40measurement-factory.com%3E"
       TITLE="[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Oct 15 17:57:38 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013053.html">[squid-users] Identifying the source of Invalid-request (squid 3)	-&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
        <LI>Next message (by thread): <A HREF="013056.html">[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13054">[ date ]</a>
              <a href="thread.html#13054">[ thread ]</a>
              <a href="subject.html#13054">[ subject ]</a>
              <a href="author.html#13054">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/15/2016 07:36 AM, Jester Purtteman wrote:
&gt;<i> I have been seeing lines in my access log like the following:  
</I>&gt;<i> 
</I>&gt;<i> 1476535967.570      0 xxx.xxx.xxx.xxx TAG_NONE/400 4538 NONE
</I>&gt;<i> error:invalid-request - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> After some digging on this list I began to suspect websockets or other
</I>&gt;<i> non-http traffic coming across port 80.  I decided to try squid
</I>&gt;<i> 4.0.15 with on-unsupported-protocol.  I get what I am guessing to be the
</I>&gt;<i> same result with new error text around it:
</I>&gt;<i> 
</I>&gt;<i> 1476536369.742      0 xxx.xxx.xxx.xxx NONE/000 0 NONE
</I>&gt;<i> error:transaction-end-before-headers - HIER_NONE/- -
</I>&gt;<i> 
</I>&gt;<i> An interesting point to interject here is that my &#8220;Hits as % bytes sent&#8221;
</I>&gt;<i> in 3.5.x has always been in the 2 to 5% range, but there are periods
</I>&gt;<i> (sometimes long ones) where the inbound traffic to squid is much higher
</I>&gt;<i> than the outbound.  When I switch to 4.0.x, I am now running about -27%
</I>&gt;<i> (note, negative twenty-seven) as bytes, which makes me suspect it is
</I>&gt;<i> logging the higher inbound than outbound now.
</I>
That difference sounds potentially important to me. I encourage you to
figure out what causes it (which is exactly what you have started doing,
of course).


&gt;<i> So, apparently, this
</I>&gt;<i> unsupported protocol is triggering some sort of large download, but does
</I>&gt;<i> not end up going to the client.
</I>
There might be some exceptions, but non-tunneled
error:transaction-end-before-headers are not supposed to trigger a
download. Squid does not know what to download because Squid cannot
parse the request...

When enabled, tunneled error:transaction-end-before-headers do download
data, of course, but you may be able to measure how much they download
then by finding the corresponding transactions in access log.


&gt;<i> I would like to know a couple things, first: is there some debugging
</I>&gt;<i> level other than ALL,9 that might give me some illumination? 
</I>
I am sure there is. Once you know what the problem/cause is, it is easy
to come up with the corresponding optimal debug_options settings to show
the cause. Before that? You can try various settings (debugging sections
are semi-documented in doc/debug-sections.txt), but it is often not
worth your time.


&gt;<i> ALL,9
</I>&gt;<i> generates about 15 MB of debug log per second at my current load level,
</I>&gt;<i> and these errors aren&#8217;t real frequent, so I end up with ~ 400 MB of text
</I>&gt;<i> that needs to be sifted through.  As you can imagine, that can be a bit
</I>&gt;<i> brutal.  
</I>
I do not quite understand the problem of a 400MB ALL,9 cache.log. IMHO,
it is not much more difficult to deal with than a 1MB ALL,9 cache.log:
Either you can navigate ALL,9 noise or you cannot; the total log size
does not really matter much beyond a few MB levels IMO (provided you
have enough disk space to store it and logging itself does not slow
Squid down too much to reproduce the problem).

Please note that I am not saying that you are doing something wrong or
even complaining about a non-problem. I am only saying that I do not see
a [solvable in the context of this email thread] problem with ALL,9 logs
so I cannot help you solve it.


&gt;<i> So, I have a few questions I guess: 
</I>&gt;<i> 
</I>&gt;<i> (1)    For one thing, what are the implications of
</I>&gt;<i> &#8220;on_unsupported_protocol tunnel all&#8221;?  
</I>
In rough terms, everything that is not SSL or HTTP will be tunneled.
AFAIK, non-HTTP inside SSL will not be tunneled yet (there is an
important patch for that going through squid-dev review right now).


&gt;<i> I did it as a quick attempt to
</I>&gt;<i> see if that had any new and interesting impacts, but is it safe-ish?
</I>
I do not know what you mean by &quot;safe&quot;, but, in a sense, it is more
&quot;safe&quot; than having no proxy at all because your access.log will show you
those tunnels.


&gt;<i> Am I letting the bad-guys come pouring through with that?
</I>
I personally do not know -- in general, it depends on the bad guys in
your environment. Others here may have deployment-specific stories that
I lack.


&gt;<i> (2)    What debug levels should I be thinking about to try and figure
</I>&gt;<i> out what is happening.  Seems like we won&#8217;t get very far without
</I>&gt;<i> identifying what is throwing that error.
</I>
If you do not want to deal with ALL,9, I would recommend this combination:

* a packet capture (you can limit the captured packet size if needed)
* access log format that logs all IPs and all TCP ports so that you can
match an access log line with captured packets/connection.


&gt;<i> (3)    Has anyone else seen this?  Right now, for example (after 10
</I>&gt;<i> minutes of typing an email) I&#8217;m actually running -61% Hits as Bytes! 
</I>&gt;<i> (Negative!)  Ouch!
</I>
As I said earlier, I am not sure the negative byte hit ratio is actually
related to these errors, but it could be. Squid v4 fixed a few
size-related accounting bugs. It is possible that we screw something up
in the process or that your actual byte hit ratio was always bad (but
you did not know about it because Squid was lying to you).

Can you compare Squid-reported numbers with OS/interfaces-reported
numbers somehow? If OS/interface numbers confirm v3.5 report but not
v4.0 report, then there is a bug we need to fix.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013053.html">[squid-users] Identifying the source of Invalid-request (squid 3)	-&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
	<LI>Next message (by thread): <A HREF="013056.html">[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13054">[ date ]</a>
              <a href="thread.html#13054">[ thread ]</a>
              <a href="subject.html#13054">[ subject ]</a>
              <a href="author.html#13054">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
