<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Identifying%20the%20source%20of%20Invalid-request%20%28squid%0A%203%29%20-%3E%20error%3Atransaction-end-before-headers%20%28Squid%204%29&In-Reply-To=%3Cad69e19a-e59b-ad21-9d9c-7fcc3f0eda9c%40optimera.us%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013054.html">
   <LINK REL="Next"  HREF="013058.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)</H1>
    <B>Jester Purtteman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Identifying%20the%20source%20of%20Invalid-request%20%28squid%0A%203%29%20-%3E%20error%3Atransaction-end-before-headers%20%28Squid%204%29&In-Reply-To=%3Cad69e19a-e59b-ad21-9d9c-7fcc3f0eda9c%40optimera.us%3E"
       TITLE="[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)">jester at optimera.us
       </A><BR>
    <I>Sat Oct 15 23:16:55 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013054.html">[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
        <LI>Next message (by thread): <A HREF="013058.html">[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13056">[ date ]</a>
              <a href="thread.html#13056">[ thread ]</a>
              <a href="subject.html#13056">[ subject ]</a>
              <a href="author.html#13056">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the reply Alex, I've embedded some comments below, and I will 
get back to you with additional info after some testing.


On 10/15/2016 10:57 AM, Alex Rousskov wrote:
&gt;<i> On 10/15/2016 07:36 AM, Jester Purtteman wrote:
</I>&gt;&gt;<i> I have been seeing lines in my access log like the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1476535967.570      0 xxx.xxx.xxx.xxx TAG_NONE/400 4538 NONE
</I>&gt;&gt;<i> error:invalid-request - HIER_NONE/- text/html
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After some digging on this list I began to suspect websockets or other
</I>&gt;&gt;<i> non-http traffic coming across port 80.  I decided to try squid
</I>&gt;&gt;<i> 4.0.15 with on-unsupported-protocol.  I get what I am guessing to be the
</I>&gt;&gt;<i> same result with new error text around it:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1476536369.742      0 xxx.xxx.xxx.xxx NONE/000 0 NONE
</I>&gt;&gt;<i> error:transaction-end-before-headers - HIER_NONE/- -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> An interesting point to interject here is that my &#8220;Hits as % bytes sent&#8221;
</I>&gt;&gt;<i> in 3.5.x has always been in the 2 to 5% range, but there are periods
</I>&gt;&gt;<i> (sometimes long ones) where the inbound traffic to squid is much higher
</I>&gt;&gt;<i> than the outbound.  When I switch to 4.0.x, I am now running about -27%
</I>&gt;&gt;<i> (note, negative twenty-seven) as bytes, which makes me suspect it is
</I>&gt;&gt;<i> logging the higher inbound than outbound now.
</I>&gt;<i> That difference sounds potentially important to me. I encourage you to
</I>&gt;<i> figure out what causes it (which is exactly what you have started doing,
</I>&gt;<i> of course).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> So, apparently, this
</I>&gt;&gt;<i> unsupported protocol is triggering some sort of large download, but does
</I>&gt;&gt;<i> not end up going to the client.
</I>&gt;<i> There might be some exceptions, but non-tunneled
</I>&gt;<i> error:transaction-end-before-headers are not supposed to trigger a
</I>&gt;<i> download. Squid does not know what to download because Squid cannot
</I>&gt;<i> parse the request...
</I>&gt;<i>
</I>&gt;<i> When enabled, tunneled error:transaction-end-before-headers do download
</I>&gt;<i> data, of course, but you may be able to measure how much they download
</I>&gt;<i> then by finding the corresponding transactions in access log.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I would like to know a couple things, first: is there some debugging
</I>&gt;&gt;<i> level other than ALL,9 that might give me some illumination?
</I>&gt;<i> I am sure there is. Once you know what the problem/cause is, it is easy
</I>&gt;<i> to come up with the corresponding optimal debug_options settings to show
</I>&gt;<i> the cause. Before that? You can try various settings (debugging sections
</I>&gt;<i> are semi-documented in doc/debug-sections.txt), but it is often not
</I>&gt;<i> worth your time.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ALL,9
</I>&gt;&gt;<i> generates about 15 MB of debug log per second at my current load level,
</I>&gt;&gt;<i> and these errors aren&#8217;t real frequent, so I end up with ~ 400 MB of text
</I>&gt;&gt;<i> that needs to be sifted through.  As you can imagine, that can be a bit
</I>&gt;&gt;<i> brutal.
</I>&gt;<i> I do not quite understand the problem of a 400MB ALL,9 cache.log. IMHO,
</I>&gt;<i> it is not much more difficult to deal with than a 1MB ALL,9 cache.log:
</I>&gt;<i> Either you can navigate ALL,9 noise or you cannot; the total log size
</I>&gt;<i> does not really matter much beyond a few MB levels IMO (provided you
</I>&gt;<i> have enough disk space to store it and logging itself does not slow
</I>&gt;<i> Squid down too much to reproduce the problem).
</I>&gt;<i>
</I>&gt;<i> Please note that I am not saying that you are doing something wrong or
</I>&gt;<i> even complaining about a non-problem. I am only saying that I do not see
</I>&gt;<i> a [solvable in the context of this email thread] problem with ALL,9 logs
</I>&gt;<i> so I cannot help you solve it.
</I>&gt;<i>
</I>I gotcha, I'll start the digging.  I was curious what it would take to 
get the a dump of what the request looked like, but its some non-HTTP, 
so that probably doesn't make sense anyway

&gt;&gt;<i> So, I have a few questions I guess:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (1)    For one thing, what are the implications of
</I>&gt;&gt;<i> &#8220;on_unsupported_protocol tunnel all&#8221;?
</I>&gt;<i> In rough terms, everything that is not SSL or HTTP will be tunneled.
</I>&gt;<i> AFAIK, non-HTTP inside SSL will not be tunneled yet (there is an
</I>&gt;<i> important patch for that going through squid-dev review right now).
</I>&gt;<i>
</I>Okay, that i think is the desired behavoir in my case, I basically want 
squid to handle the requests that it knows how deal with, and ignore and 
pass along the ones it cannot.  The environment is pretty promiscuous, 
and i don't need to restrict clients from using non-http stuff.
&gt;&gt;<i> I did it as a quick attempt to
</I>&gt;&gt;<i> see if that had any new and interesting impacts, but is it safe-ish?
</I>&gt;<i> I do not know what you mean by &quot;safe&quot;, but, in a sense, it is more
</I>&gt;<i> &quot;safe&quot; than having no proxy at all because your access.log will show you
</I>&gt;<i> those tunnels.
</I>Safe as in, not causing security holes.
&gt;<i>
</I>&gt;&gt;<i> Am I letting the bad-guys come pouring through with that?
</I>&gt;<i> I personally do not know -- in general, it depends on the bad guys in
</I>&gt;<i> your environment. Others here may have deployment-specific stories that
</I>&gt;<i> I lack.
</I>&gt;<i>
</I>I was concerned that by permitting connects through the proxy there may 
be security concerns, but i have the thing bolted down so that only our 
clients can get to it, and it doesn't have much access to anywhere else 
on the network, so I am thinking that is probably fine.
&gt;&gt;<i> (2)    What debug levels should I be thinking about to try and figure
</I>&gt;&gt;<i> out what is happening.  Seems like we won&#8217;t get very far without
</I>&gt;&gt;<i> identifying what is throwing that error.
</I>&gt;<i> If you do not want to deal with ALL,9, I would recommend this combination:
</I>&gt;<i>
</I>&gt;<i> * a packet capture (you can limit the captured packet size if needed)
</I>&gt;<i> * access log format that logs all IPs and all TCP ports so that you can
</I>&gt;<i> match an access log line with captured packets/connection.
</I>&gt;<i>
</I>I'll just suck it up and do an ALL,9 capture.  It will take me a couple 
tries to get a capture that includes the problem, but it isn't a huge 
problem.  The packet capture idea is a good one too, I'll do that as 
well.  Similar issue (sifting a small amount of info out of an ocean of 
data) but I think valuable.
&gt;&gt;<i> (3)    Has anyone else seen this?  Right now, for example (after 10
</I>&gt;&gt;<i> minutes of typing an email) I&#8217;m actually running -61% Hits as Bytes!
</I>&gt;&gt;<i> (Negative!)  Ouch!
</I>&gt;<i> As I said earlier, I am not sure the negative byte hit ratio is actually
</I>&gt;<i> related to these errors, but it could be. Squid v4 fixed a few
</I>&gt;<i> size-related accounting bugs. It is possible that we screw something up
</I>&gt;<i> in the process or that your actual byte hit ratio was always bad (but
</I>&gt;<i> you did not know about it because Squid was lying to you).
</I>&gt;<i>
</I>&gt;<i> Can you compare Squid-reported numbers with OS/interfaces-reported
</I>&gt;<i> numbers somehow? If OS/interface numbers confirm v3.5 report but not
</I>&gt;<i> v4.0 report, then there is a bug we need to fix.
</I>&gt;<i>
</I>I can, i have interface statistics that I should be able to get pretty 
close with.  It won't be perfect (my ssh session will throw it off a 
tad, etc) but it will be able to detect a 30%+ problem without issue.  
I'll do some experiments and share the result.
&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013054.html">[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
	<LI>Next message (by thread): <A HREF="013058.html">[squid-users] Identifying the source of Invalid-request (squid 3) -&gt; error:transaction-end-before-headers (Squid 4)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13056">[ date ]</a>
              <a href="thread.html#13056">[ thread ]</a>
              <a href="subject.html#13056">[ subject ]</a>
              <a href="author.html#13056">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
