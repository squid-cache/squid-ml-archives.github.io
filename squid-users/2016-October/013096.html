<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.x and Peek and Splice - Host Header	Forgery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%20and%20Peek%20and%20Splice%20-%20Host%20Header%0A%09Forgery&In-Reply-To=%3CCACU80L6yVWm7haDBMYhZWnWtRdu%3D9qb2NLeSihULDa5KXyKvSA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013095.html">
   <LINK REL="Next"  HREF="013087.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.x and Peek and Splice - Host Header	Forgery</H1>
    <B>John Wright</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%20and%20Peek%20and%20Splice%20-%20Host%20Header%0A%09Forgery&In-Reply-To=%3CCACU80L6yVWm7haDBMYhZWnWtRdu%3D9qb2NLeSihULDa5KXyKvSA%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 4.x and Peek and Splice - Host Header	Forgery">unixdeaf at gmail.com
       </A><BR>
    <I>Tue Oct 18 18:17:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013095.html">[squid-users] Squid 4.x and Peek and Splice - Host Header	Forgery
</A></li>
        <LI>Next message (by thread): <A HREF="013087.html">[squid-users] Error DiskThreadsDiskFile::openDone: (2) No such file	or directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13096">[ date ]</a>
              <a href="thread.html#13096">[ thread ]</a>
              <a href="subject.html#13096">[ subject ]</a>
              <a href="author.html#13096">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Also here is an example showing the issues when pushing to S3 as well as
the same error with some google url's.

2016/10/17 18:33:32 kid1| SECURITY ALERT: Host header forgery detected on
local=209.85.144.113:443 remote=x.x.x.x:62402 FD 49 flags=33 (local IP does
not match any domain IP)
2016/10/17 18:33:32 kid1| SECURITY ALERT: on URL: tools.google.com:443
2016/10/17 18:34:04 kid1| SECURITY ALERT: Host header forgery detected on
local=209.85.144.113:443 remote=x.x.x.x:62405 FD 110 flags=33 (local IP
does not match any domain IP)
2016/10/17 18:34:04 kid1| SECURITY ALERT: on URL: tools.google.com:443
2016/10/17 18:34:45 kid1| SECURITY ALERT: Host header forgery detected on
local=209.85.144.113:443 remote=x.x.x.x:62409 FD 56 flags=33 (local IP does
not match any domain IP)
2016/10/17 18:34:45 kid1| SECURITY ALERT: on URL: tools.google.com:443
2016/10/17 18:35:16 kid1| SECURITY ALERT: Host header forgery detected on
local=209.85.144.113:443 remote=x.x.x.x:62412 FD 65 flags=33 (local IP does
not match any domain IP)
2016/10/17 18:35:16 kid1| SECURITY ALERT: on URL: tools.google.com:443
2016/10/17 18:57:11 kid1| SECURITY ALERT: Host header forgery detected on
local=172.217.17.78:443 remote=x.x.x.x:52958 FD 66 flags=33 (local IP does
not match any domain IP)
2016/10/17 18:57:11 kid1| SECURITY ALERT: on URL:
alt2-safebrowsing.google.com:443
2016/10/17 18:58:00 kid1| SECURITY ALERT: Host header forgery detected on
local=172.217.17.78:443 remote=x.x.x.x:52965 FD 42 flags=33 (local IP does
not match any domain IP)
2016/10/17 18:58:00 kid1| SECURITY ALERT: on URL:
alt2-safebrowsing.google.com:443



Also please note my dig response time :

;; Query time: 1 msec


And from my DNS server itself :

;; Query time: 2 msec


My bind server is setup as a simple forwarder which always returns
repsonses in about 1-2 msec

So again , things that are big , big files, timely requests to query some
API , they all appear to have host header forgery problems that squid shows
and then drops if the request takes longer to process than the TTL of the
DNS entry associated with the traffic

I have many examples and if i dont use squid everything works fine, with
squid it breaks , thats my simple point is squid is seeing an issue the app
and client themselves dont and thats OK but with no way to &quot;disable &quot; or
&quot;workaround&quot; the errors for lets say S3 on AWS

how do i keep using squid?

On Tue, Oct 18, 2016 at 2:10 PM, John Wright &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">unixdeaf at gmail.com</A>&gt; wrote:

&gt;<i> In response to it not being a false positive , maybe its not specifically
</I>&gt;<i> the TTL but in this other article on the mailing lists someone else had the
</I>&gt;<i> same issue
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is the response Amos gave, this is a known issue and apparently there
</I>&gt;<i> is no way to &quot;ignore host header forgery issues&quot; or bypass them in the
</I>&gt;<i> squid config.
</I>&gt;<i> My understanding is that , maybe the short TTL is ok, but it is small
</I>&gt;<i> enough to where when a cloud based client is connecting to server a server
</I>&gt;<i> b to amazon S3 etc it can take a few seconds
</I>&gt;<i> Thus that 5 second TTL (which again is often 2-3 seconds) is small enough
</I>&gt;<i> to hurt.
</I>&gt;<i>
</I>&gt;<i> Specifically some of these people (aws , google) in some dns situations
</I>&gt;<i> they are doing things that squid has been known to identify as host header
</I>&gt;<i> forgery just becuse it doesnt understand whats happening.
</I>&gt;<i> Also if im doing an S3 call pulling or pushing a big file which is very
</I>&gt;<i> common in cloud environments it can take 10-20 seconds for the request to
</I>&gt;<i> process , and if TTL expires mid stream , squid is for some reason flagging
</I>&gt;<i> as forgery and it hangs until it either returns to the same ip in
</I>&gt;<i> DNS by chance or until the connection is dropped.
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-August/012261.html">http://lists.squid-cache.org/pipermail/squid-users/2016-August/012261.html</A>
</I>&gt;<i> Here is the note from Amos
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;* The cases where Squid still gets it wrong are where the popular CDN
</I>&gt;<i> *&gt;&gt;* service(s) in question are performing DNS actions indistinguishable to
</I>&gt;<i> *&gt;&gt;* those malware attacks. If Squid can't tell the difference between an
</I>&gt;<i> *&gt;&gt;* attack and normal DNS behaviour the only code change possible is to
</I>&gt;<i> *&gt;&gt;* disable the check (see above about the risk level).
</I>&gt;<i> *&gt;&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, Oct 18, 2016 at 2:01 PM, &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">garryd at comnet.uz</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 2016-10-18 22:42, John Wright wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Replying to the list
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Yes i get that error on many different sites same exact error about
</I>&gt;&gt;&gt;<i> host headers.
</I>&gt;&gt;&gt;<i> Also if you watch the TTL on the amazonaws url i provided it changes
</I>&gt;&gt;&gt;<i> from 3 to 5 to 10 seconds to 60 to 10 back and forth.
</I>&gt;&gt;&gt;<i> If you go online to an dns lookup site like kloth i see via kloth 5
</I>&gt;&gt;&gt;<i> seconds TTL
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> i get a different TTL value at different times, it appears they dont
</I>&gt;&gt;&gt;<i> have a set TTL but they change it often and it varies.
</I>&gt;&gt;&gt;<i> Right now it appears to be a ttl of 60 seconds as you found but
</I>&gt;&gt;&gt;<i> earlier and over the weekend it has shown 5 seconds and even AWS
</I>&gt;&gt;&gt;<i> support verified it can vary as low as 5 seconds.
</I>&gt;&gt;&gt;<i> That being said , when it is changing every 3-5 seconds which comes
</I>&gt;&gt;&gt;<i> and goes , squid gives the header forgery errors as shown before.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The time interval between client's and Squid's name lookup is measured in
</I>&gt;&gt;<i> milliseconds. So, in most cases, the would not be false positives in
</I>&gt;&gt;<i> environments where same cashing DNS server is used.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That specific issue you encounter except alert messages and Squid's
</I>&gt;&gt;<i> inability to cache HTTP responses for &quot;forged&quot; HTTP requests?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Thank you for your time,
</I>&gt;<i>
</I>&gt;<i> John Wright
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Thank you for your time,

John Wright
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161018/0f31068a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161018/0f31068a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013095.html">[squid-users] Squid 4.x and Peek and Splice - Host Header	Forgery
</A></li>
	<LI>Next message (by thread): <A HREF="013087.html">[squid-users] Error DiskThreadsDiskFile::openDone: (2) No such file	or directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13096">[ date ]</a>
              <a href="thread.html#13096">[ thread ]</a>
              <a href="subject.html#13096">[ subject ]</a>
              <a href="author.html#13096">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
