<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Peeking on TLS traffic: unknown cipher returned
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peeking%20on%20TLS%20traffic%3A%20unknown%20cipher%20returned&In-Reply-To=%3CCAARTC8n7dGRbD3hW0PwhfG5EX2horcwM4vAuqu%3D8MCkWuiwD%3DQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013105.html">
   <LINK REL="Next"  HREF="013110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Peeking on TLS traffic: unknown cipher returned</H1>
    <B>Leandro Barragan</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peeking%20on%20TLS%20traffic%3A%20unknown%20cipher%20returned&In-Reply-To=%3CCAARTC8n7dGRbD3hW0PwhfG5EX2horcwM4vAuqu%3D8MCkWuiwD%3DQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Peeking on TLS traffic: unknown cipher returned">lean0x2f at gmail.com
       </A><BR>
    <I>Thu Oct 20 02:51:32 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013105.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
        <LI>Next message (by thread): <A HREF="013110.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13108">[ date ]</a>
              <a href="thread.html#13108">[ thread ]</a>
              <a href="subject.html#13108">[ subject ]</a>
              <a href="author.html#13108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Amos,

I really appreciate your answer and the time you took trying to
explain me the rules. I'm already compiling Squid 3.5.22 with OpenSSL
1.0.2j to see if that solves my issue.

Leaving aside the software version, it seems weird to me that I see
this behaviour not only on blocked (terminated) sites like facebook,
but in other sites too, like microsoft.com, which should only be
peeked (taking into account that I applied the config you recommended
me: peek all, terminate facebook&amp;twitter, and splice all).
When I access microsoft.com, I get the unknown cipher error on Squid
but on the client I see a certificate error. When I look at the
certificate info, it is signed by Squid. It makes no sense at all.
Microsoft.com should be peeked and then spliced, not bumped. That
makes me think that I'm missing something else. I don't want to bump
at all, I just want to block sites by looking at SNI info.

Thanks

Leandro

On 19 October 2016 at 10:42, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 19/10/2016 7:44 p.m., Leandro Barragan wrote:
</I>&gt;&gt;<i> Hi!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm having trouble with SSL Peek &amp; Splice in Squid 3.5.16 using
</I>&gt;<i>
</I>&gt;<i> Please upgrade to 3.5.19 or later. Current is 3.5.22.
</I>&gt;<i>
</I>&gt;&gt;<i> intercept mode. I'm trying to configure a transparent proxy (no CA
</I>&gt;&gt;<i> installed on clients) which denies access to specific sites. I
</I>&gt;&gt;<i> understand that if I can't Bump (my case), then I can only use SNI
</I>&gt;&gt;<i> information from TLS &quot;Client Hello&quot; on Step 2.
</I>&gt;<i>
</I>&gt;<i> Correct.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Everything works OK with most sites, but when I try to connect to some
</I>&gt;&gt;<i> sites like facebook.com or microsoft.com, clients can't connect and I
</I>&gt;&gt;<i> get this error on cache.log:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [...]
</I>&gt;&gt;&gt;<i> Error negotiating SSL on FD 111: error:140920F8:SSL routines:SSL3_GET_SERVER_HELLO:unknown cipher returned (1/-1/0)
</I>&gt;&gt;&gt;<i> [...]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Reading emails from this list, I came to the conclusion that this
</I>&gt;&gt;<i> error is related to new ciphers (like ChaCha20) which are not
</I>&gt;&gt;<i> supported by OpenSSL 1.0.1... So I tried to compile Squid using
</I>&gt;&gt;<i> OpenSSL 1.1.0, which is not possible (bug #4599). I also tried to
</I>&gt;&gt;<i> compile it using LibreSSL unsuccessfully.
</I>&gt;<i>
</I>&gt;<i> A more current Squid (3.5.19+) and OpenSSL 1.0.2 latest should work. It
</I>&gt;<i> has for others.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I fail to see why is this happening. I only need to peek on the
</I>&gt;&gt;<i> connection and make a decision based on SNI, I'm not Bumping, so I
</I>&gt;&gt;<i> don't understand why ciphers matter in my situation.
</I>&gt;<i>
</I>&gt;<i> Note that the sites you get this error on are the ones where &quot;terminate&quot;
</I>&gt;<i> action is configured to happen.
</I>&gt;<i>
</I>&gt;<i> Terminate means impersonating the server and responding to the client
</I>&gt;<i> with an HTTPS error page.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My squid.conf:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [...]
</I>&gt;&gt;&gt;<i> acl face ssl::server_name_regex -i facebook
</I>&gt;&gt;&gt;<i> acl twitter ssl::server_name_regex -i twitter
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslproxy_cipher HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;&gt;&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 3128
</I>&gt;&gt;&gt;<i> http_port 3129 intercept
</I>&gt;&gt;&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/myCA.pem options=NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslproxy_capath /var/lib/ssl_db
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek all step1
</I>&gt;&gt;&gt;<i> ssl_bump peek all step2
</I>&gt;<i>
</I>&gt;<i> The use of &quot;all&quot; is redundant and useless in the above lines.
</I>&gt;<i>
</I>&gt;<i> Since peek is only valid at step #1 and #2 anyway the &quot;step1 and step2
</I>&gt;<i> are pointless.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump terminate face step3
</I>&gt;&gt;&gt;<i> ssl_bump terminate twitter step3
</I>&gt;&gt;&gt;<i> ssl_bump splice all step3
</I>&gt;<i>
</I>&gt;<i> The use of &quot;step3&quot; is redundant and useless.
</I>&gt;<i>
</I>&gt;<i> Since ACL &quot;face&quot; and ACL &quot;twitter&quot; are of the same type and used as a
</I>&gt;<i> pair with the same action. You would be better off merging their values
</I>&gt;<i> under one ACL name.
</I>&gt;<i>
</I>&gt;<i> Oh, and most content from facebook actually comes from the &quot;fbcdn&quot; domain.
</I>&gt;<i>
</I>&gt;<i> You might as well configure:
</I>&gt;<i>
</I>&gt;<i>  acl TF ssl::server_name_regex -i facebook fbcdn twitter
</I>&gt;<i>  ssl_bump peek all
</I>&gt;<i>  ssl_bump terminate TF
</I>&gt;<i>  ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013105.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
	<LI>Next message (by thread): <A HREF="013110.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13108">[ date ]</a>
              <a href="thread.html#13108">[ thread ]</a>
              <a href="subject.html#13108">[ subject ]</a>
              <a href="author.html#13108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
