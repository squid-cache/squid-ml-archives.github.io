<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Peeking on TLS traffic: unknown cipher returned
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peeking%20on%20TLS%20traffic%3A%20unknown%20cipher%20returned&In-Reply-To=%3C2d98d293-f2ff-8f87-1d6c-c425d803115f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013110.html">
   <LINK REL="Next"  HREF="013111.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Peeking on TLS traffic: unknown cipher returned</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peeking%20on%20TLS%20traffic%3A%20unknown%20cipher%20returned&In-Reply-To=%3C2d98d293-f2ff-8f87-1d6c-c425d803115f%40measurement-factory.com%3E"
       TITLE="[squid-users] Peeking on TLS traffic: unknown cipher returned">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct 20 04:01:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013110.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
        <LI>Next message (by thread): <A HREF="013111.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13109">[ date ]</a>
              <a href="thread.html#13109">[ thread ]</a>
              <a href="subject.html#13109">[ subject ]</a>
              <a href="author.html#13109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/19/2016 12:44 AM, Leandro Barragan wrote:

&gt;&gt;<i> error:140920F8:SSL routines:SSL3_GET_SERVER_HELLO:unknown cipher returned (1/-1/0)
</I>
&gt;<i> I fail to see why is this happening. I only need to peek on the
</I>&gt;<i> connection and make a decision based on SNI, 
</I>
Please note that &quot;peek and make a decision based on SNI&quot; is not what
your configuration tells Squid to do. Your configuration tells Squid to
peek during step2, which means making a decision based on server
certificates (and SNI).


&gt;<i> I'm not Bumping, so I
</I>&gt;<i> don't understand why ciphers matter in my situation.
</I>
The ciphers matter because Squid v3 uses OpenSSL parsers during step1,
step2, and step3. FWIW, Squid v4 uses OpenSSL parsers during step2 (a
little) and step3. It is possible to completely remove OpenSSL from
step2 but there is currently no project to do that AFAIK.


&gt;&gt;<i> ssl_bump peek all step1
</I>&gt;&gt;<i> ssl_bump peek all step2
</I>&gt;&gt;<i> ssl_bump terminate face step3
</I>&gt;&gt;<i> ssl_bump terminate twitter step3
</I>&gt;&gt;<i> ssl_bump splice all step3
</I>
BTW, &quot;step1&quot;, &quot;step2&quot;, and &quot;step3&quot; ACLs do nothing useful in the above
config. You can safely remove them to arrive at the equivalent ssl_bump
configuration.


On 10/19/2016 07:42 AM, Amos Jeffries wrote:
&gt;<i> Terminate means impersonating the server and responding to the client
</I>&gt;<i> with an HTTPS error page.
</I>
Terminate means &quot;close client and server connections immediately&quot;. The
problem is not with the terminate action but with peeking (which relies
on OpenSSL, especially during step2, especially in Squid v3).


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013110.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
	<LI>Next message (by thread): <A HREF="013111.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13109">[ date ]</a>
              <a href="thread.html#13109">[ thread ]</a>
              <a href="subject.html#13109">[ subject ]</a>
              <a href="author.html#13109">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
