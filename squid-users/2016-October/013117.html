<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Peeking on TLS traffic: unknown cipher returned
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peeking%20on%20TLS%20traffic%3A%20unknown%20cipher%20returned&In-Reply-To=%3CCAARTC8kyKsnKQv%2BSXci0C02q_Nt7w0piYCKmxS_WaNFUb%3DNLqw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013112.html">
   <LINK REL="Next"  HREF="013122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Peeking on TLS traffic: unknown cipher returned</H1>
    <B>Leandro Barragan</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peeking%20on%20TLS%20traffic%3A%20unknown%20cipher%20returned&In-Reply-To=%3CCAARTC8kyKsnKQv%2BSXci0C02q_Nt7w0piYCKmxS_WaNFUb%3DNLqw%40mail.gmail.com%3E"
       TITLE="[squid-users] Peeking on TLS traffic: unknown cipher returned">lean0x2f at gmail.com
       </A><BR>
    <I>Fri Oct 21 02:15:56 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013112.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
        <LI>Next message (by thread): <A HREF="013122.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13117">[ date ]</a>
              <a href="thread.html#13117">[ thread ]</a>
              <a href="subject.html#13117">[ subject ]</a>
              <a href="author.html#13117">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your time Alex! I modified my original config based on Amos
recommendations, so I think now I have a more consistent peek &amp; splice
config:

 acl TF ssl::server_name_regex -i facebook fbcdn twitter reddit
 ssl_bump peek all
 ssl_bump terminate TF
 ssl_bump splice all

As you mentioned, terminate closes the connection, it doesn't serve an
error page (when it works, i.e. with reddit and twitter).

I've compiled Squid 3.5.22 using OpenSSL 1.0.2j and I'm having the
same exact issue, even with this new config. Based on what you
explained, I think it's a OpenSSL problem and Squid can't do anything
about it. I have two reasons to believe that:

1) The &quot;unknown cipher returned&quot; error get's triggered on terminated
and non terminated (e.g. microsoft.com) sites, which makes me think it
has nothing to do with Squid ACLs.
2) All problematic sites use a new cipher called &quot;ChaCha20&quot; (E.g.
TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256....according to Qualys
online analyzer and TestSSLServer tool)

A lot of sites are using this new cipher. I'm back at the beginning, I
will continue trying to compile Squid with patched versions of OpenSSL
or LibreSSL.

Thanks!

On 20 October 2016 at 01:01, Alex Rousskov
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 10/19/2016 12:44 AM, Leandro Barragan wrote:
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> error:140920F8:SSL routines:SSL3_GET_SERVER_HELLO:unknown cipher returned (1/-1/0)
</I>&gt;<i>
</I>&gt;&gt;<i> I fail to see why is this happening. I only need to peek on the
</I>&gt;&gt;<i> connection and make a decision based on SNI,
</I>&gt;<i>
</I>&gt;<i> Please note that &quot;peek and make a decision based on SNI&quot; is not what
</I>&gt;<i> your configuration tells Squid to do. Your configuration tells Squid to
</I>&gt;<i> peek during step2, which means making a decision based on server
</I>&gt;<i> certificates (and SNI).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I'm not Bumping, so I
</I>&gt;&gt;<i> don't understand why ciphers matter in my situation.
</I>&gt;<i>
</I>&gt;<i> The ciphers matter because Squid v3 uses OpenSSL parsers during step1,
</I>&gt;<i> step2, and step3. FWIW, Squid v4 uses OpenSSL parsers during step2 (a
</I>&gt;<i> little) and step3. It is possible to completely remove OpenSSL from
</I>&gt;<i> step2 but there is currently no project to do that AFAIK.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek all step1
</I>&gt;&gt;&gt;<i> ssl_bump peek all step2
</I>&gt;&gt;&gt;<i> ssl_bump terminate face step3
</I>&gt;&gt;&gt;<i> ssl_bump terminate twitter step3
</I>&gt;&gt;&gt;<i> ssl_bump splice all step3
</I>&gt;<i>
</I>&gt;<i> BTW, &quot;step1&quot;, &quot;step2&quot;, and &quot;step3&quot; ACLs do nothing useful in the above
</I>&gt;<i> config. You can safely remove them to arrive at the equivalent ssl_bump
</I>&gt;<i> configuration.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 10/19/2016 07:42 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> Terminate means impersonating the server and responding to the client
</I>&gt;&gt;<i> with an HTTPS error page.
</I>&gt;<i>
</I>&gt;<i> Terminate means &quot;close client and server connections immediately&quot;. The
</I>&gt;<i> problem is not with the terminate action but with peeking (which relies
</I>&gt;<i> on OpenSSL, especially during step2, especially in Squid v3).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013112.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
	<LI>Next message (by thread): <A HREF="013122.html">[squid-users] Peeking on TLS traffic: unknown cipher returned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13117">[ date ]</a>
              <a href="thread.html#13117">[ thread ]</a>
              <a href="subject.html#13117">[ subject ]</a>
              <a href="author.html#13117">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
