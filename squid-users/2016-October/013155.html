<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FTP : Squid sending private IP in PASV response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FTP%20%3A%20Squid%20sending%20private%20IP%20in%20PASV%20response&In-Reply-To=%3C4f14e849-c48b-596e-798f-148b26841ced%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013120.html">
   <LINK REL="Next"  HREF="013121.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FTP : Squid sending private IP in PASV response</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FTP%20%3A%20Squid%20sending%20private%20IP%20in%20PASV%20response&In-Reply-To=%3C4f14e849-c48b-596e-798f-148b26841ced%40treenet.co.nz%3E"
       TITLE="[squid-users] FTP : Squid sending private IP in PASV response">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Oct 23 12:32:26 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013120.html">[squid-users] FTP : Squid sending private IP in PASV response
</A></li>
        <LI>Next message (by thread): <A HREF="013121.html">[squid-users] sourcehash load balance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13155">[ date ]</a>
              <a href="thread.html#13155">[ thread ]</a>
              <a href="subject.html#13155">[ subject ]</a>
              <a href="author.html#13155">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/10/2016 10:02 p.m., Garri Djavadyan wrote:
&gt;<i> On Fri, 2016-10-21 at 08:27 +0000, Gael Ancelin wrote:
</I>&gt;&gt;<i> WAN_IP---[FW]-------localIP1-[SQUID]-localIP2------------localIP3-
</I>&gt;&gt;<i> [FTP_Server]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was expecting something like &quot;227 Entering Passive Mode
</I>&gt;&gt;<i> (54,xx,xx,xx,213,249).&quot; 
</I>&gt;&gt;<i> with public ip.
</I>&gt;&gt;<i> What I want is a response like (WAN_IP,port), but what I obtain is 
</I>&gt;&gt;<i> (localIP1,port) instead.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid does not respond with the FTP server address, so I presume that
</I>&gt;&gt;<i> Squid is
</I>&gt;&gt;<i> understanding enough FTP protocol to modify response and put his own
</I>&gt;&gt;<i> ip address
</I>&gt;&gt;<i> instead of the real FTP server's.
</I>&gt;<i> 
</I>&gt;<i> According to your scheme, FW is DNAT device and it forwards packets
</I>&gt;<i> destined to FTP control channel port (21) on public IP of FW to private
</I>&gt;<i> localIP1 of SQUID. In that scenario Squid don't even know that the
</I>&gt;<i> client used WAN_IP to access FTP service and therefore it can't use the
</I>&gt;<i> public IP even if it wish.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> So I'm wondering if it exists a way to force squid to respond with a
</I>&gt;&gt;<i>  fixed IP &gt; address instead of his own local address.
</I>&gt;<i> 
</I>&gt;<i> Here <A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A> you can find all available
</I>&gt;<i> options.
</I>
'accel' mode is a thing very specific to HTTP port 80 and 443.

The closest thing Squid has for FTP is 'intercept'. I am assuming that
mode works

That brings us to the often repeated advice about NAT intercepted traffic:

 Destination NAT *MUST NOT* be performed on traffic from the client
before it reaches the Squid machine.

When you correct the DNAT to be happening on the Squid machine instead
of the FW, use the 'intercept' option on the ftp_port instead of 'accel'.
(I have not tried it myself, but AFAIK that should work for this scenario)

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013120.html">[squid-users] FTP : Squid sending private IP in PASV response
</A></li>
	<LI>Next message (by thread): <A HREF="013121.html">[squid-users] sourcehash load balance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13155">[ date ]</a>
              <a href="thread.html#13155">[ thread ]</a>
              <a href="subject.html#13155">[ subject ]</a>
              <a href="author.html#13155">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
