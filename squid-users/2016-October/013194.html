<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Caching%20Google%20Chrome%0A%20googlechromestandaloneenterprise64.msi&In-Reply-To=%3C86f78bf4-28ee-4f6a-b855-90a87d86a673%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013192.html">
   <LINK REL="Next"  HREF="013196.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Caching%20Google%20Chrome%0A%20googlechromestandaloneenterprise64.msi&In-Reply-To=%3C86f78bf4-28ee-4f6a-b855-90a87d86a673%40treenet.co.nz%3E"
       TITLE="[squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Oct 24 12:22:30 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013192.html">[squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi
</A></li>
        <LI>Next message (by thread): <A HREF="013196.html">[squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13194">[ date ]</a>
              <a href="thread.html#13194">[ thread ]</a>
              <a href="subject.html#13194">[ subject ]</a>
              <a href="author.html#13194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/10/2016 12:32 a.m., Garri Djavadyan wrote:
&gt;<i> On Mon, 2016-10-24 at 23:51 +1300, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 24/10/2016 9:59 p.m., Garri Djavadyan wrote:
</I>&gt;&gt;&gt;<i> Nevertheless, the topic surfaced new details regarding the Vary and
</I>&gt;&gt;&gt;<i> I
</I>&gt;&gt;&gt;<i> tried conditional requests on same URL (Google Chrome) from
</I>&gt;&gt;&gt;<i> different
</I>&gt;&gt;&gt;<i> machines/IPs. Here results:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> $ curl --head --header &quot;If-Modified-Since: Thu, 22 Oct 2016
</I>&gt;&gt;&gt;<i> 08:29:09
</I>&gt;&gt;&gt;<i> GMT&quot; <A HREF="https://dl.google.com/linux/direct/google-chrome-stable_curren">https://dl.google.com/linux/direct/google-chrome-stable_curren</A>
</I>&gt;&gt;&gt;<i> t_am
</I>&gt;&gt;&gt;<i> d64.deb
</I>&gt;&gt;&gt;<i> HTTP/1.1 304 Not Modified
</I>&gt;&gt;&gt;<i> Etag: &quot;101395&quot;
</I>&gt;&gt;&gt;<i> Server: downloads
</I>&gt;&gt;&gt;<i> Vary: *
</I>&gt;&gt;&gt;<i> X-Content-Type-Options: nosniff
</I>&gt;&gt;&gt;<i> X-Frame-Options: SAMEORIGIN
</I>&gt;&gt;&gt;<i> X-Xss-Protection: 1; mode=block
</I>&gt;&gt;&gt;<i> Date: Mon, 24 Oct 2016 08:53:44 GMT
</I>&gt;&gt;&gt;<i> Alt-Svc: quic=&quot;:443&quot;; ma=2592000; v=&quot;36,35,34&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ----
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> $ curl --head --header 'If-None-Match: &quot;101395&quot;' <A HREF="https://dl.google.">https://dl.google.</A>
</I>&gt;&gt;&gt;<i> com/
</I>&gt;&gt;&gt;<i> linux/direct/google-chrome-stable_current_amd64.deb 
</I>&gt;&gt;&gt;<i> HTTP/1.1 304 Not Modified
</I>&gt;&gt;&gt;<i> Etag: &quot;101395&quot;
</I>&gt;&gt;&gt;<i> Last-Modified: Thu, 20 Oct 2016 08:29:09 GMT
</I>&gt;&gt;&gt;<i> Server: downloads
</I>&gt;&gt;&gt;<i> Vary: *
</I>&gt;&gt;&gt;<i> X-Content-Type-Options: nosniff
</I>&gt;&gt;&gt;<i> X-Frame-Options: SAMEORIGIN
</I>&gt;&gt;&gt;<i> X-Xss-Protection: 1; mode=block
</I>&gt;&gt;&gt;<i> Date: Mon, 24 Oct 2016 08:54:18 GMT
</I>&gt;&gt;&gt;<i> Alt-Svc: quic=&quot;:443&quot;; ma=2592000; v=&quot;36,35,34&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sweet! Far better than I was expecting. That means this patch should
</I>&gt;&gt;<i> work:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> === modified file 'src/http.cc'
</I>&gt;&gt;<i> --- src/http.cc 2016-10-08 22:19:44 +0000
</I>&gt;&gt;<i> +++ src/http.cc 2016-10-24 10:50:16 +0000
</I>&gt;&gt;<i> @@ -593,7 +593,7 @@
</I>&gt;&gt;<i>      while (strListGetItem(&amp;vary, ',', &amp;item, &amp;ilen, &amp;pos)) {
</I>&gt;&gt;<i>          SBuf name(item, ilen);
</I>&gt;&gt;<i>          if (name == asterisk) {
</I>&gt;&gt;<i> -            vstr.clear();
</I>&gt;&gt;<i> +            vstr = asterisk;
</I>&gt;&gt;<i>              break;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>          name.toLower();
</I>&gt;&gt;<i> @@ -947,6 +947,12 @@
</I>&gt;&gt;<i>              varyFailure = true;
</I>&gt;&gt;<i>          } else {
</I>&gt;&gt;<i>              entry-&gt;mem_obj-&gt;vary_headers = vary;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +            // RFC 7231 section 7.1.4
</I>&gt;&gt;<i> +            // Vary:* can be cached, but has mandatory revalidation
</I>&gt;&gt;<i> +            static const SBuf asterisk(&quot;*&quot;);
</I>&gt;&gt;<i> +            if (vary == asterisk)
</I>&gt;&gt;<i> +                EBIT_SET(entry-&gt;flags, ENTRY_REVALIDATE_ALWAYS);
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> I have applied the patch. Below my results.
</I>&gt;<i> 
</I>&gt;<i> In access.log I see:
</I>&gt;<i> 
</I>&gt;<i> 1477307991.672  49890 127.0.0.1 TCP_REFRESH_MODIFIED/200 45532786 GET h
</I>&gt;<i> <A HREF="ttp://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb">ttp://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</A>
</I>&gt;<i>  - HIER_DIRECT/173.194.222.136 application/x-debian-package
</I>&gt;<i> 
</I>&gt;<i> In packet capture, I see that Squid doesn't use conditional request:
</I>&gt;<i> 
</I>&gt;<i> GET /linux/direct/google-chrome-stable_current_amd64.deb HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.50.3
</I>&gt;<i> Accept: */*
</I>&gt;<i> Host: dl.google.com
</I>&gt;<i> Via: 1.1 gentoo.comnet.uz (squid/3.5.22)
</I>&gt;<i> X-Forwarded-For: 127.0.0.1
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>
Hmmm. That looks to me like the new patch is working (log says REFRESH
being done) but there is some bug in the revalidate logic not adding the
required headers.
 If thats right, then that bug might be causing other revalidate traffic
to have major /200 issues.

I'm in need of sleep right now. If you can grab a ALL,9 cache.log trace
and mail it to me I will take a look in the morning. Otherwise I will
try to replicate the case myself and track it down in the next few days.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013192.html">[squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi
</A></li>
	<LI>Next message (by thread): <A HREF="013196.html">[squid-users] Caching Google Chrome googlechromestandaloneenterprise64.msi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13194">[ date ]</a>
              <a href="thread.html#13194">[ thread ]</a>
              <a href="subject.html#13194">[ subject ]</a>
              <a href="author.html#13194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
