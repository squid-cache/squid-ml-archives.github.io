<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External nat'ed transparent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C063101d22ecd%247b0c6930%2471253b90%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013214.html">
   <LINK REL="Next"  HREF="013235.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External nat'ed transparent proxy</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C063101d22ecd%247b0c6930%2471253b90%24%40ngtech.co.il%3E"
       TITLE="[squid-users] External nat'ed transparent proxy">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Oct 25 14:38:41 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013214.html">[squid-users] External nat'ed transparent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="013235.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13226">[ date ]</a>
              <a href="thread.html#13226">[ thread ]</a>
              <a href="subject.html#13226">[ subject ]</a>
              <a href="author.html#13226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

As Amos suggested you should use Policy based routing and not DNAT.
The main reason for that is since it's breaking the Interception layer which squid relies on for fallback scenarios.

I can write the logic for this pretty fast but you should first understand that your setup is wrong in a way.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: Henry Paulissen [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A>] 
Sent: Friday, September 30, 2016 12:48
To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] External nat'ed transparent proxy

Good morning Eliezer,


It took some time for me to construct a drawing who would be understandable enough how our setup is, as the diagrams you provided didn't fully fit the case. But, I think I managed to make a understandable drawing of it :-)

[ Link to PNG image ]
<A HREF="https://drive.google.com/file/d/0BysciyDBahUtWU55RjNPUlFjMTQ/view">https://drive.google.com/file/d/0BysciyDBahUtWU55RjNPUlFjMTQ/view</A>


Some additional info with the drwaing:
  - Each linux firewall server handles top ~5G traffic. After that we
    build a new firewall cluster and new servers are connected to
    that one.

  - The linux firewall is gateway for the vlan.

  - As you might know: LVS is internally also a DNAT, so bassicly we do
    a double DNAT.

  - The green and blue line indicates how the traffic is routed

  - Linux firewalls is physical hardware, but all the servers
    (including the squid hosts) are linux vservers (like LXC containers
    or docker containers).


Hopes this clears up our setup and where I run into problems with squid3.

Regards,

--
Henry Paulissen - PD0OM
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A> - Phone: +31-(0)6-115.305.64 Linux/Unix System Engineer

On 30-09-16 00:35, Eliezer Croitoru wrote:
&gt;<i> Hey Henry,
</I>&gt;<i> 
</I>&gt;<i> I want to emulate the setup to understand the complication with a FULL linux based setup here on my local testing grounds.
</I>&gt;<i> Can you give more details on the networks in the form of subnets and VLAN numbers?
</I>&gt;<i> What is not clear to me is: Who is doing the DNAT?
</I>&gt;<i> Also, if you have not used tproxy and intercept on the PROXY machine you should re-think the whole logic of the system first before deciding on the next step.
</I>&gt;<i> There are systems which needs redesign when moving from Squid 2 to 3 or 4.
</I>&gt;<i> When I and you will have the right understanding of the scenario I believe we can find the right path if this is not already there.
</I>&gt;<i> 
</I>&gt;<i> Let me know if these( the diagrams..):
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Intoduction">http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Intoduction</A>_
</I>&gt;<i> to_MultiWAN_LoadBalancing
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2">http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2</A>
</I>&gt;<i> 
</I>&gt;<i> Make any sense to you so we can find the right words to fill the gaps in the situation.
</I>&gt;<i> Once I will have the right picture I would probably have enough information to draw some picture in VISIO and move forward to the Systems table.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile+WhatsApp: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] 
</I>&gt;<i> On Behalf Of Henry Paulissen
</I>&gt;<i> Sent: Thursday, September 29, 2016 5:40 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] External nat'ed transparent proxy
</I>&gt;<i> 
</I>&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> In the company I work for we are currently using squid v2 proxies in transparent mode to intercept traffic from servers to the outside (access control).
</I>&gt;<i> 
</I>&gt;<i> The technical solution for this is roughly as follows:
</I>&gt;<i> [server] -&gt; [gateway] -&gt; [firewall]
</I>&gt;<i>                               |
</I>&gt;<i>     ----------- DNAT ---------
</I>&gt;<i>    v
</I>&gt;<i> [squid]  -&gt; [gateway] -&gt; [firewall] -&gt; [internet router]
</I>&gt;<i> 
</I>&gt;<i> Our firewalls (who live between the vlan gateway and internet router), DNAT the traffic towards separate squid proxies (who are in a lvs cluster). These squid proxies are in their own vlan with special permissions to allow unrestricted port 80 outbound, etc, etc...
</I>&gt;<i> 
</I>&gt;<i> Because squid v2 is becoming more and more obsolete we are looking at upgrading it towards squid v3.
</I>&gt;<i> 
</I>&gt;<i> From what I read in the manuals, transparent mode is replaced by intercept (and tproxy) mode. But both dont seem to be fully backward complaint with the v2 transparent mode.
</I>&gt;<i> 
</I>&gt;<i> The old trasparent mode allowed us to just dnat traffic towards the squid host without the need for the client to be aware of this. For example, the old style accepted 'GET / HTTP/1.1' (without full URL in the GET request and looking at the Host header for the destination).
</I>&gt;<i> 
</I>&gt;<i> The new intercept mode comes close to this behavior, but instead of 
</I>&gt;<i> remotly dnat, it wants us to next-hop it towards the squid proxy and 
</I>&gt;<i> redirect it locally. This is problematic for us as firewall and squid 
</I>&gt;<i> proxy dont live in the same vlan, so next-hop should be the router to 
</I>&gt;<i> that vlan (and forgetting about the path back to the server). 
</I>&gt;<i> Secondly, and not less blocking, we use vservers (predecessor to linux 
</I>&gt;<i> containers
</I>&gt;<i> lxc) as such, we dont have any promiscuous interfaces rights within the container.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Is there still a option to emulate normal 'regular&#180; style squid (as without any listen options) but instead accepting the URI path in the GET request and looking at the Host header for the destination? (lets call it passthrough mode?).
</I>&gt;<i> 
</I>&gt;<i> Or, is there in squid3 a new and better way to facilitate larger setups, with the knowledge the server, firewall and squids are all in different vlans (and no, we dont have Cisco firewalls in between them ;-)).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance,
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Henry Paulissen - PD0OM
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A> - Phone: +31-(0)6-115.305.64 Linux/Unix System 
</I>&gt;<i> Engineer
</I>&gt;<i> 
</I>&gt;<i> 
</I>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013214.html">[squid-users] External nat'ed transparent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="013235.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13226">[ date ]</a>
              <a href="thread.html#13226">[ thread ]</a>
              <a href="subject.html#13226">[ subject ]</a>
              <a href="author.html#13226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
