<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External nat'ed transparent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C06af01d22edc%2499080c50%24cb1824f0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013226.html">
   <LINK REL="Next"  HREF="013241.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External nat'ed transparent proxy</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C06af01d22edc%2499080c50%24cb1824f0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] External nat'ed transparent proxy">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Oct 25 16:26:54 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013226.html">[squid-users] External nat'ed transparent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="013241.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13235">[ date ]</a>
              <a href="thread.html#13235">[ thread ]</a>
              <a href="subject.html#13235">[ subject ]</a>
              <a href="author.html#13235">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Henry,

It's not about RFC at all from my point of view.
It's very simple to setup the system in a way that will work as you want but with Let say Ubuntu 16.04 or Debian 8(latest).
These are very stable in my environment and if you need some help with the design I would be able to assist you with it.
I cannot find right now the whole setup specs but it's very simple to mark connections by the VLAN or the source network:
You will just need to change the next rules to be static and to not rely on NFQUEUE:
<A HREF="http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#iptables_rules_example">http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#iptables_rules_example</A>

Then write a special routing table per vlan.
The reason to do so is since this is how it is suppose to be and not because of the RFC.
Your setup breaks good connections but maybe you are just not aware of it.
I believe that migrating from 2.X to a 3.5 can be completed smoothly enough in a way that nobody will fill it.

Elezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: Henry Paulissen [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A>] 
Sent: Tuesday, October 25, 2016 18:45
To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] External nat'ed transparent proxy

Hi Eliezer,

Thank you for looking into it.

I fully understand the setup is far from ideal and breaks RFC's (I was already aware of this).

The reason we would like to keep this in place is to keep support on the older applications who aren't proxy aware. While still being able to keep some control of standard outbound connections. We know, that a sufficient knowledgeable hacker would very easily bypass the proxy but it is not in place to stop them. The proxy is there to stop the automatic bots / script kiddies / etc. A first line of defense.

That being said,
As a fast solution I now installed a debian weezy machine (who comes standard with squid 2.7.x). That proxy will act as transparent one and have the acls pushed to it from the new squid 3.x ones (so we can have a mixed env). That way we can keep supporting the older stuff (and have logging on it, who still uses it to encourage them to swap to the &quot;real&quot;
proxy).

Regards,

--
Henry Paulissen - PD0OM
mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A> - Phone: +31-(0)6-115.305.64 Linux/Unix System Engineer

On 25-10-16 16:38, Eliezer Croitoru wrote:
&gt;<i> Hey,
</I>&gt;<i> 
</I>&gt;<i> As Amos suggested you should use Policy based routing and not DNAT.
</I>&gt;<i> The main reason for that is since it's breaking the Interception layer which squid relies on for fallback scenarios.
</I>&gt;<i> 
</I>&gt;<i> I can write the logic for this pretty fast but you should first understand that your setup is wrong in a way.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Henry Paulissen [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A>]
</I>&gt;<i> Sent: Friday, September 30, 2016 12:48
</I>&gt;<i> To: Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> Cc: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] External nat'ed transparent proxy
</I>&gt;<i> 
</I>&gt;<i> Good morning Eliezer,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It took some time for me to construct a drawing who would be 
</I>&gt;<i> understandable enough how our setup is, as the diagrams you provided 
</I>&gt;<i> didn't fully fit the case. But, I think I managed to make a 
</I>&gt;<i> understandable drawing of it :-)
</I>&gt;<i> 
</I>&gt;<i> [ Link to PNG image ]
</I>&gt;<i> <A HREF="https://drive.google.com/file/d/0BysciyDBahUtWU55RjNPUlFjMTQ/view">https://drive.google.com/file/d/0BysciyDBahUtWU55RjNPUlFjMTQ/view</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Some additional info with the drwaing:
</I>&gt;<i>   - Each linux firewall server handles top ~5G traffic. After that we
</I>&gt;<i>     build a new firewall cluster and new servers are connected to
</I>&gt;<i>     that one.
</I>&gt;<i> 
</I>&gt;<i>   - The linux firewall is gateway for the vlan.
</I>&gt;<i> 
</I>&gt;<i>   - As you might know: LVS is internally also a DNAT, so bassicly we do
</I>&gt;<i>     a double DNAT.
</I>&gt;<i> 
</I>&gt;<i>   - The green and blue line indicates how the traffic is routed
</I>&gt;<i> 
</I>&gt;<i>   - Linux firewalls is physical hardware, but all the servers
</I>&gt;<i>     (including the squid hosts) are linux vservers (like LXC containers
</I>&gt;<i>     or docker containers).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hopes this clears up our setup and where I run into problems with squid3.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Henry Paulissen - PD0OM
</I>&gt;<i> mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A> - Phone: +31-(0)6-115.305.64 Linux/Unix System 
</I>&gt;<i> Engineer
</I>&gt;<i> 
</I>&gt;<i> On 30-09-16 00:35, Eliezer Croitoru wrote:
</I>&gt;&gt;<i> Hey Henry,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I want to emulate the setup to understand the complication with a FULL linux based setup here on my local testing grounds.
</I>&gt;&gt;<i> Can you give more details on the networks in the form of subnets and VLAN numbers?
</I>&gt;&gt;<i> What is not clear to me is: Who is doing the DNAT?
</I>&gt;&gt;<i> Also, if you have not used tproxy and intercept on the PROXY machine you should re-think the whole logic of the system first before deciding on the next step.
</I>&gt;&gt;<i> There are systems which needs redesign when moving from Squid 2 to 3 or 4.
</I>&gt;&gt;<i> When I and you will have the right understanding of the scenario I believe we can find the right path if this is not already there.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Let me know if these( the diagrams..):
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Intoduction">http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Intoduction</A>
</I>&gt;&gt;<i> _
</I>&gt;&gt;<i> to_MultiWAN_LoadBalancing
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2">http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Make any sense to you so we can find the right words to fill the gaps in the situation.
</I>&gt;&gt;<i> Once I will have the right picture I would probably have enough information to draw some picture in VISIO and move forward to the Systems table.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;<i> Linux System Administrator
</I>&gt;&gt;<i> Mobile+WhatsApp: +972-5-28704261
</I>&gt;&gt;<i> Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;&gt;<i> On Behalf Of Henry Paulissen
</I>&gt;&gt;<i> Sent: Thursday, September 29, 2016 5:40 PM
</I>&gt;&gt;<i> To: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: [squid-users] External nat'ed transparent proxy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In the company I work for we are currently using squid v2 proxies in transparent mode to intercept traffic from servers to the outside (access control).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The technical solution for this is roughly as follows:
</I>&gt;&gt;<i> [server] -&gt; [gateway] -&gt; [firewall]
</I>&gt;&gt;<i>                               |
</I>&gt;&gt;<i>     ----------- DNAT ---------
</I>&gt;&gt;<i>    v
</I>&gt;&gt;<i> [squid]  -&gt; [gateway] -&gt; [firewall] -&gt; [internet router]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Our firewalls (who live between the vlan gateway and internet router), DNAT the traffic towards separate squid proxies (who are in a lvs cluster). These squid proxies are in their own vlan with special permissions to allow unrestricted port 80 outbound, etc, etc...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Because squid v2 is becoming more and more obsolete we are looking at upgrading it towards squid v3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> From what I read in the manuals, transparent mode is replaced by intercept (and tproxy) mode. But both dont seem to be fully backward complaint with the v2 transparent mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The old trasparent mode allowed us to just dnat traffic towards the squid host without the need for the client to be aware of this. For example, the old style accepted 'GET / HTTP/1.1' (without full URL in the GET request and looking at the Host header for the destination).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The new intercept mode comes close to this behavior, but instead of 
</I>&gt;&gt;<i> remotly dnat, it wants us to next-hop it towards the squid proxy and 
</I>&gt;&gt;<i> redirect it locally. This is problematic for us as firewall and squid 
</I>&gt;&gt;<i> proxy dont live in the same vlan, so next-hop should be the router to 
</I>&gt;&gt;<i> that vlan (and forgetting about the path back to the server).
</I>&gt;&gt;<i> Secondly, and not less blocking, we use vservers (predecessor to 
</I>&gt;&gt;<i> linux containers
</I>&gt;&gt;<i> lxc) as such, we dont have any promiscuous interfaces rights within the container.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there still a option to emulate normal 'regular&#180; style squid (as without any listen options) but instead accepting the URI path in the GET request and looking at the Host header for the destination? (lets call it passthrough mode?).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Or, is there in squid3 a new and better way to facilitate larger setups, with the knowledge the server, firewall and squids are all in different vlans (and no, we dont have Cisco firewalls in between them ;-)).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks in advance,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Henry Paulissen - PD0OM
</I>&gt;&gt;<i> mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A> - Phone: +31-(0)6-115.305.64 Linux/Unix System 
</I>&gt;&gt;<i> Engineer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013226.html">[squid-users] External nat'ed transparent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="013241.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13235">[ date ]</a>
              <a href="thread.html#13235">[ thread ]</a>
              <a href="subject.html#13235">[ subject ]</a>
              <a href="author.html#13235">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
