<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TProxy not working (Squid 3.5.12, Ubuntu Server 16.04.1)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20not%20working%20%28Squid%203.5.12%2C%0A%20Ubuntu%20Server%2016.04.1%29&In-Reply-To=%3C1a01fc55-1673-ff7a-2503-4749a0d5796a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013245.html">
   <LINK REL="Next"  HREF="013271.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TProxy not working (Squid 3.5.12, Ubuntu Server 16.04.1)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20not%20working%20%28Squid%203.5.12%2C%0A%20Ubuntu%20Server%2016.04.1%29&In-Reply-To=%3C1a01fc55-1673-ff7a-2503-4749a0d5796a%40treenet.co.nz%3E"
       TITLE="[squid-users] TProxy not working (Squid 3.5.12, Ubuntu Server 16.04.1)">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 26 11:12:50 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013245.html">[squid-users] TProxy not working (Squid 3.5.12,	Ubuntu Server 16.04.1)
</A></li>
        <LI>Next message (by thread): <A HREF="013271.html">[squid-users] TProxy not working (Squid 3.5.12, Ubuntu Server 16.04.1)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13249">[ date ]</a>
              <a href="thread.html#13249">[ thread ]</a>
              <a href="subject.html#13249">[ subject ]</a>
              <a href="author.html#13249">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/10/2016 7:42 p.m., Jens Offenbach wrote:
&gt;<i> Hi,
</I>&gt;<i> I am trying to setup a transparent proxy with Squid 3.5.12 on Ubuntu Server 16.04.1, but I cannot get it working. When a client tries to connect to the web, the connection always times out.
</I>&gt;<i> 
</I>&gt;<i> Hopefully, someone has an idea what's going.
</I>&gt;<i> 
</I>&gt;<i> uname-r:
</I>&gt;<i> 4.4.0-45-generic
</I>&gt;<i> 
</I>&gt;<i> sysct:
</I>&gt;<i> net.ipv4.ip_forward=1
</I>&gt;<i> net.ipv4.conf.default.rp_filter=0
</I>&gt;<i> net.ipv4.conf.all.rp_filter=0
</I>&gt;<i> 
</I>&gt;<i> squid.conf:
</I>&gt;<i> # ACCESS CONTROLS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   acl localnet    src 139.2.0.0/16
</I>&gt;<i>   acl localnet    src 193.96.112.0/21
</I>&gt;<i>   acl localnet    src 192.109.216.0/24
</I>&gt;<i>   acl localnet    src 100.1.4.0/22
</I>&gt;<i>   acl localnet    src 10.0.0.0/8
</I>&gt;<i>   acl localnet    src 172.16.0.0/12
</I>&gt;<i>   acl localnet    src 192.168.0.0/16
</I>&gt;<i>   acl to_localnet dst 139.2.0.0/16
</I>&gt;<i>   acl to_localnet dst 193.96.112.0/21
</I>&gt;<i>   acl to_localnet dst 192.109.216.0/24
</I>&gt;<i>   acl to_localnet dst 100.1.4.0/22
</I>&gt;<i>   acl to_localnet dst 10.0.0.0/8
</I>&gt;<i>   acl to_localnet dst 172.16.0.0/12
</I>&gt;<i>   acl to_localnet dst 192.168.0.0/16
</I>&gt;<i> 
</I>
Missing basic security controlsto prevent this being an abused open proxy.
 http_access deny !Safe_Ports
 http_access deny CONNECT !SSL_Ports


&gt;<i>   http_access allow manager localhost
</I>&gt;<i>   http_access deny  manager
</I>&gt;<i>   http_access allow localnet
</I>&gt;<i>   http_access allow localhost
</I>&gt;<i>   http_access allow to_localnet
</I>
Permits external visitors uncontrolled access to your LAN IP spaces.
Particularly when combined with the &quot;always_direct allow to_localnet&quot; below.
  Really want that?

&gt;<i>   http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # NETWORK OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   http_port 10.30.200.99:3128
</I>&gt;<i>   http_port 10.30.216.254:3128
</I>&gt;<i>   http_port 10.30.216.254:3129 tproxy
</I>&gt;<i> 
</I>&gt;<i> # OPTIONS WHICH AFFECT THE NEIGHBOR SELECTION ALGORITHM
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   cache_peer proxy.mycompany.com parent 8080 0 no-query no-digest default
</I>&gt;<i>   cache_peer  roxy.mycompany.com parent 8080 0 no-query no-digest
</I>
I suspect the peers are sending TCP SYN+ACK responses directly back to
the client IP which Squid is spoofing.

Add the option &quot;no-tproxy&quot; to these peer lines to avoid that.

&gt;<i> 
</I>&gt;<i> # MEMORY CACHE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size_in_memory 8 MB
</I>&gt;<i>   memory_replacement_policy heap LFUDA
</I>&gt;<i>   cache_mem 256 MB
</I>&gt;<i> 
</I>&gt;<i> # DISK CACHE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   maximum_object_size 10 GB
</I>&gt;<i>   cache_replacement_policy heap GDSF
</I>&gt;<i>   cache_dir ufs /var/cache/squid 88894 16 256 max-size=10737418240
</I>&gt;<i> 
</I>&gt;<i> # LOGFILE OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   access_log daemon:/var/log/squid/access.log squid
</I>&gt;<i>   cache_store_log daemon:/var/log/squid/store.log
</I>&gt;<i> 
</I>
store.log is very rarely needed. You might consider removing it for some
extra speed out of the proxy.


&gt;<i> # OPTIONS FOR TROUBLESHOOTING
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   cache_log /var/log/squid/cache.log
</I>&gt;<i>   coredump_dir /var/log/squid
</I>&gt;<i>   
</I>&gt;<i> # OPTIONS FOR TUNING THE CACHE
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   cache allow all
</I>
Unnecessary default value configured.

&gt;<i>   
</I>&gt;<i> # ADMINISTRATIVE PARAMETERS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   visible_hostname my-proxy.mycompany.com
</I>&gt;<i> 
</I>&gt;<i> # ICP OPTIONS
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   icp_port 0
</I>&gt;<i> 
</I>
Unnecessary default value configured.

&gt;<i> # OPTIONS INFLUENCING REQUEST FORWARDING 
</I>&gt;<i> # -----------------------------------------------------------------------------
</I>&gt;<i>   always_direct allow to_localnet
</I>&gt;<i>   always_direct allow to_localhost
</I>&gt;<i>   never_direct  allow all
</I>&gt;<i> 
</I>
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013245.html">[squid-users] TProxy not working (Squid 3.5.12,	Ubuntu Server 16.04.1)
</A></li>
	<LI>Next message (by thread): <A HREF="013271.html">[squid-users] TProxy not working (Squid 3.5.12, Ubuntu Server 16.04.1)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13249">[ date ]</a>
              <a href="thread.html#13249">[ thread ]</a>
              <a href="subject.html#13249">[ subject ]</a>
              <a href="author.html#13249">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
