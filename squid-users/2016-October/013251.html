<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] external_acl_type problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20external_acl_type%20problem&In-Reply-To=%3C868d4c4c-629b-2245-b86e-544090eb3b7e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013272.html">
   <LINK REL="Next"  HREF="013157.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] external_acl_type problem</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20external_acl_type%20problem&In-Reply-To=%3C868d4c4c-629b-2245-b86e-544090eb3b7e%40treenet.co.nz%3E"
       TITLE="[squid-users] external_acl_type problem">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 26 11:50:31 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013272.html">[squid-users] external_acl_type problem
</A></li>
        <LI>Next message (by thread): <A HREF="013157.html">[squid-users] squid-users Digest, Vol 26, Issue 82
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13251">[ date ]</a>
              <a href="thread.html#13251">[ thread ]</a>
              <a href="subject.html#13251">[ subject ]</a>
              <a href="author.html#13251">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/10/2016 9:56 p.m., reinerotto wrote:
&gt;&gt;<i> You referred to some assumptions that we might have on a linux system but
</I>&gt;<i> the question from my side is:
</I>&gt;<i> What for example?
</I>&gt;<i> Disk Space?
</I>&gt;<i> Libraries?
</I>&gt;<i> Etc..&lt;
</I>&gt;<i> 
</I>&gt;<i> Sorry, I do not really know. I had one similar, very strange effect on my
</I>&gt;<i> embedded LINUX, regarding bash:
</I>&gt;<i> It was necessary for redirect function in bash to work, to have this one:
</I>&gt;<i> ln -s /proc/self/fd /dev/fd
</I>&gt;<i> So just my idea about this special squid function having a similar reason.
</I>&gt;<i> Because as I have seen, squid uses socket connections to communicate with
</I>&gt;<i> the helper. 
</I>&gt;<i> So just a long shot.
</I>&gt;<i> 
</I>&gt;<i> It very looks like squids accouting of helpers is disturbed: I see much more
</I>&gt;<i> than max helpers active after a few hours.  And lot of helpers stay alive,
</I>&gt;<i> when I kill parent process squid. 
</I>
By 'kill' do you mean something like &quot;kill -9&quot; ?

Or do you mean the proper &quot;kill -SIGHUP&quot; or &quot;squid -k shutdown&quot; sequence ?



&gt;<i> This problem only shows up, in case of having 2 (or more) active requests to
</I>&gt;<i> 2 helpers (same key: %SRC).
</I>&gt;<i> Like squid assumes some internal queuing of the 2 requests, but second
</I>&gt;<i> request is not.
</I>
There *is* queueing for what it sends to the helper. The queue length
defaults to being equal to the number of running helpers.

Squid writes multiple lookups and waits for the responses. When
concurrency is disabled the helper must reply to them in order. When
concurrency is enabled it can reply in any order, but must deliver the
relevant channel-ID back to Squid with each reply.

If two requests have already been written to the helper, but it crashes
or exists after replying to the first one, the second should be handled
as if the helper replied with a BH (broken helper) response.


NP: if the helper does not real each &quot;line&quot; of input and response with
exactly 1 line of output for each. Then it is the helper which is broken.
Also, any helper which exitst or closes after only one line of input is
broken. Squid requires that they stay running.

&gt;<i> So it also could be some type of resource issue: Only one socket conn
</I>&gt;<i> allowed for squid, second one is silently ignored. This would cause exactly
</I>&gt;<i> my effect.
</I>
There better not be any socket limits like that. A *single* client web
browser opening a web page can cause around a hundred connections to be
opened. And these helpers require 3 FD/sockets (stdin-&gt;FD, stdout-&gt;FD,
and stderr-&gt;cache.log)


I see that you are using the obsolete RHEL custom built option
&quot;--with-maxfd=4096&quot;. That will mean the --with-filedescriptors option
defaults to being 4096 unless the system building the Squid binary had a
smaller value enforced.


&gt;<i> It must be something very special, as I have a lot of other software running
</I>&gt;<i> on this embedded LINUX, incl. nginx, rsync. And without the helper, squid
</I>&gt;<i> ran fine for long time, incl. cache to SSD.
</I>

Squid uses fork() + execv() to start helpers. That results in the helper
process using as much virtual memory space a the main Squid was using at
the time the helper started. On an embeded system that could blow either
Squid or the helper out of the allowed memory limits.


&gt;<i> 
</I>&gt;<i> configure options:
</I>&gt;<i> Squid Cache: Version 3.5.22
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--target=mipsel-openwrt-linux'
</I>&gt;<i> '--host=mipsel-openwrt-linux' '--build=x86_64-linux-gnu' '--program-prefix='
</I>&gt;<i> '--program-suffix=' '--prefix=/usr' '--exec-prefix=/usr' '--bindir=/usr/bin'
</I>&gt;<i> '--sbindir=/usr/sbin' '--libexecdir=/usr/lib' '--sysconfdir=/etc'
</I>&gt;<i> '--datadir=/usr/share' '--localstatedir=/var' '--mandir=/usr/man'
</I>&gt;<i> '--infodir=/usr/info' '--disable-nls' '--config-cache'
</I>&gt;<i> '--datadir=/usr/share/squid' '--libexecdir=/usr/lib/squid'
</I>&gt;<i> '--sysconfdir=/etc/squid' '--enable-shared' '--disable-static'
</I>&gt;<i> '--disable-icmp' '--enable-delay-pools' '--disable-icap-client'
</I>&gt;<i> '--enable-kill-parent-hack' '--disable-snmp' '--disable-ecap'
</I>&gt;<i> '--disable-wccp' '--disable-wccpv2' '--disable-eui' '--disable-htcp'
</I>&gt;<i> '--disable-ident-lookups' '--enable-auth'
</I>&gt;<i> '--disable-storeid-rewrite-helpers' '--disable-ipv6' '--enable-ssl'
</I>
&quot;--enable-ssl&quot; is obsolete. Remove.

&gt;<i> '--enable-ssl-crtd' '--disable-cache-digests' '--enable-linux-netfilter'
</I>&gt;<i> '--disable-unlinkd' '--disable-x-accelerator-vary' '--disable-translation'
</I>&gt;<i> '--disable-auto-locale' '--with-dl' '--with-pthreads' '--without-expat'
</I>&gt;<i> '--without-libxml2' '--without-gnutls' '--without-nettle'
</I>&gt;<i> '--with-openssl=/etc/openwrt/mw-m96/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr'
</I>&gt;<i> '--enable-epoll' '--with-maxfd=4096' '--enable-external-acl-helpers'
</I>&gt;<i> '--disable-auth-negotiate' '--disable-auth-ntlm' '--disable-auth-digest'
</I>&gt;<i> '--enable-auth-basic' '--disable-arch-native' '--with-krb5-config=no'
</I>&gt;<i> '--without-mit-krb5' '--without-libcap' '--without-netfilter-conntrack'
</I>&gt;<i> 'build_alias=x86_64-linux-gnu' 'host_alias=mipsel-openwrt-linux'
</I>&gt;<i> 'target_alias=mipsel-openwrt-linux' 'CC=mipsel-openwrt-linux-uclibc-gcc'
</I>&gt;<i> 'CFLAGS=-Os -pipe -mno-branch-likely -mips32r2 -mtune=24kec -mdsp
</I>&gt;<i> -fno-caller-saves -fhonour-copts -Wno-error=unused-but-set-variable
</I>&gt;<i> -Wno-error=unused-result -msoft-float '
</I>&gt;<i> 'LDFLAGS=-L/etc/openwrt/mw-m96/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr/lib
</I>&gt;<i> -L/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/lib
</I>&gt;<i> -L/etc/openwrt/router/staging_dir/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2/usr/lib
</I>&gt;<i> -L/etc/openwrt/router/staging_dir/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2/lib
</I>&gt;<i> '
</I>&gt;<i> 'CPPFLAGS=-I/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr/include
</I>&gt;<i> -I/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/include
</I>&gt;<i> -I/etc/openwrt/router/staging_dir/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2/usr/include
</I>&gt;<i> -I/etc/openwrt/router/staging_dir/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2/include
</I>&gt;<i> ' 'CXX=mipsel-openwrt-linux-uclibc-g++' 'CXXFLAGS=-Os -pipe
</I>&gt;<i> -mno-branch-likely -mips32r2 -mtune=24kec -mdsp -fno-caller-saves
</I>&gt;<i> -fhonour-copts -Wno-error=unused-but-set-variable -Wno-error=unused-result
</I>&gt;<i> -msoft-float '
</I>&gt;<i> 'PKG_CONFIG=/etc/openwrt/router/staging_dir/host/bin/pkg-config'
</I>&gt;<i> 'PKG_CONFIG_PATH=/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr/lib/pkgconfig:/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr/share/pkgconfig'
</I>&gt;<i> 'PKG_CONFIG_LIBDIR=/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr/lib/pkgconfig:/etc/openwrt/router/staging_dir/target-mipsel_24kec+dsp_uClibc-0.9.33.2/usr/share/pkgconfig'
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013272.html">[squid-users] external_acl_type problem
</A></li>
	<LI>Next message (by thread): <A HREF="013157.html">[squid-users] squid-users Digest, Vol 26, Issue 82
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13251">[ date ]</a>
              <a href="thread.html#13251">[ thread ]</a>
              <a href="subject.html#13251">[ subject ]</a>
              <a href="author.html#13251">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
