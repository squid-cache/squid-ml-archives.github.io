<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] filtering http(s) sites, transparently
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3C3ebec194-d16b-15a3-7ea8-e83a4f47abb0%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013260.html">
   <LINK REL="Next"  HREF="013262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] filtering http(s) sites, transparently</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filtering%20http%28s%29%20sites%2C%20transparently&In-Reply-To=%3C3ebec194-d16b-15a3-7ea8-e83a4f47abb0%40gmail.com%3E"
       TITLE="[squid-users] filtering http(s) sites, transparently">yvoinov at gmail.com
       </A><BR>
    <I>Wed Oct 26 18:45:19 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013260.html">[squid-users] filtering http(s) sites, transparently
</A></li>
        <LI>Next message (by thread): <A HREF="013262.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13261">[ date ]</a>
              <a href="thread.html#13261">[ thread ]</a>
              <a href="subject.html#13261">[ subject ]</a>
              <a href="author.html#13261">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256
 
Jok,

it can be DNS leak. Does you tested it? 8.8.8.8 can be poisoned
(probably) or intercepted by ISP.


27.10.2016 0:01, Jok Thuau &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> After being side-tracked with a few different project, I ended up with the config below. It appears to
</I>do the right things, though the ACL organization could use some cleanup...
&gt;<i> (Browsing to authorized sites works, browsing to something else, i get
</I>a denied page from squid)
&gt;<i>
</I>&gt;<i> However, even though msdn.microsoft.com &lt;<A HREF="http://msdn.microsoft.com">http://msdn.microsoft.com</A>&gt; is
</I>on my whitelist, it appears to &quot;timeout&quot;. Looking at the logs, I see
entries like this:
&gt;<i>
</I>&gt;<i> 2016/09/20 15:10:19.640 kid1| SECURITY ALERT: Host header forgery
</I>detected on local=65.54.226.150:443 &lt;<A HREF="http://65.54.226.150:443">http://65.54.226.150:443</A>&gt;
remote=10.11.12.13:51984 &lt;<A HREF="http://10.0.32.177:51984">http://10.0.32.177:51984</A>&gt; FD 18 flags=33
(local IP does not match any domain IP)
&gt;<i> 2016/09/20 15:10:19.640 kid1| SECURITY ALERT: By user agent:
</I>&gt;<i> 2016/09/20 15:10:19.640 kid1| SECURITY ALERT: on URL:
</I>msdn.microsoft.com:443 &lt;<A HREF="http://msdn.microsoft.com:443">http://msdn.microsoft.com:443</A>&gt;
&gt;<i> 2016/09/20 15:10:19.640 kid1| 4,2| errorpage.cc(1262) BuildContent: No
</I>existing error page language negotiated for ERR_CONFLICT_HOST. Using
default error file.
&gt;<i> 2016/09/20 15:10:19.641 kid1| 20,2| store.cc(954) checkCachable:
</I>StoreEntry::checkCachable: NO: not cachable
&gt;<i> 2016/09/20 15:10:19.641 kid1| 20,2| store.cc(954) checkCachable:
</I>StoreEntry::checkCachable: NO: not cachable
&gt;<i> 2016/09/20 15:10:19.641 kid1| 88,2| client_side_reply.cc(2001)
</I>processReplyAccessResult: The reply for CONNECT msdn.microsoft.com:443
&lt;<A HREF="http://msdn.microsoft.com:443">http://msdn.microsoft.com:443</A>&gt; is ALLOWED, because it matched SniBypass
&gt;<i> 2016/09/20 15:10:19.641 kid1| 33,2| client_side.cc(925)
</I>deferRecipientForLater: clientSocketRecipient: Deferring request
msdn.microsoft.com:443 &lt;<A HREF="http://msdn.microsoft.com:443">http://msdn.microsoft.com:443</A>&gt;
&gt;<i>
</I>&gt;<i> What is interesting is that we changed from using 8.8.8.8 as our DNS
</I>server to a locally installed bind instance, and we no longer see any
issues.
&gt;<i> that is NOT what I expected... I can't explain why the client browser
</I>was hanging. Any suggestions?
&gt;<i>
</I>&gt;<i> It's all happy now, with the following config, with a firewall doing
</I>policy based routing, a local iptables rule to redirect from port 443 to
8443, and from 80 to 3129, as well as the certificate deployed as
trusted on each endpoint:
&gt;<i>
</I>&gt;<i> squid.conf:
</I>&gt;<i> # setup standard ports
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl Safe_ports port 70
</I>&gt;<i> acl Safe_ports port 210
</I>&gt;<i> acl Safe_ports port 1025-65535
</I>&gt;<i> acl Safe_ports port 280
</I>&gt;<i> acl Safe_ports port 488
</I>&gt;<i> acl Safe_ports port 591
</I>&gt;<i> acl Safe_ports port 777
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> # for security
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> # not actually used and blocked by local firewall on host, but squid
</I>complains if it's not there...
&gt;<i> http_port 3128
</I>&gt;<i>
</I>&gt;<i> # http intercept, and ACL that matches that inbound port
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> acl http_proxy myportname 3129
</I>&gt;<i>
</I>&gt;<i> # same for https
</I>&gt;<i> https_port 8443 intercept ssl-bump \
</I>&gt;<i>     generate-host-certificates=on \
</I>&gt;<i>     dynamic_cert_mem_cache_size=64MB \
</I>&gt;<i>     cert=/etc/squid/ssl/proxy.pem \
</I>&gt;<i>     key=/etc/squid/ssl/proxy.key \
</I>&gt;<i>     cafile=/etc/squid/ssl/proxy.pe &lt;<A HREF="http://proxy.pe">http://proxy.pe</A>&gt;m
</I>&gt;<i> acl https_proxy myportname 8443
</I>&gt;<i>
</I>&gt;<i> always_direct allow all
</I>&gt;<i>
</I>&gt;<i> # define the steps needed for bumping...
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i>
</I>&gt;<i> # and the list of domains that are allowed
</I>&gt;<i> acl SniBypass ssl::server_name_regex -i &quot;/etc/squid/snibypass.acl&quot;
</I>&gt;<i> acl http_bypass dstdom_regex -n -i &quot;/etc/squid/snibypass.acl&quot;
</I>&gt;<i>
</I>&gt;<i> # ensure we have target SSL port when checking data
</I>&gt;<i> acl https_ok all-of SniBypass SSL_ports
</I>&gt;<i> # and the destination domain when not SSL...
</I>&gt;<i> acl http_ok all-of http_bypass Safe_ports
</I>&gt;<i>
</I>&gt;<i> # splice when we know the target matches
</I>&gt;<i> ssl_bump splice SniBypass
</I>&gt;<i> # peek and bump otherwise
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump stare step2
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> # some options for the certificate generation..
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE
</I>&gt;<i> sslproxy_cert_sign_hash sha256
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 64MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i>
</I>&gt;<i> # for http, let's block if we're not on the whitelist
</I>&gt;<i> http_access         deny !http_ok        http_proxy
</I>&gt;<i> # for https, let's wait until step3 of the bumping, so we can replace
</I>the SSL content post-bumping)
&gt;<i> http_access         deny !https_ok step3 https_proxy
</I>&gt;<i>
</I>&gt;<i> # never cache anything
</I>&gt;<i> cache deny all
</I>&gt;<i>
</I>&gt;<i> #for windows updates
</I>&gt;<i> quick_abort_min -1
</I>&gt;<i> range_offset_limit 0 all
</I>&gt;<i>
</I>&gt;<i> shutdown_lifetime 2 seconds
</I>&gt;<i> connect_timeout 20 seconds
</I>&gt;<i> #debug_options ALL,2
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
- -- 
Cats - delicious. You just do not know how to cook them.
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v2
 
iQEcBAEBCAAGBQJYEPm+AAoJENNXIZxhPexGnewH/0e2rK5ZU87NSgskaJsZ5orA
3E7kwxXa9pt8M1LJLlcSD73HM3ASfO3xKqY+ajhKp0hvcApH+SwJFUVyuQktAoVS
P96WCIwobasSH7rGuBvvsuny0pwDrJfjvdkJjD7e2l/qFkHE9Fv1HBwMD1Kidp51
mJ8hqhh/xghUDOQgcGN1+Ae519+jOBwE/R8/fgtQ/i5TJeljEVgEaLFcw7eZ2/E1
qk/H1kV3YCrVeslUWIxqxAPPhcS6WQLSaqKxlxYgVk1n0Ya2SC7u75MtK2n/68z2
ejQwEguAn+uMx/IuX1nxVx47jK7DGsAyMeASLqIjofMst1ct0WuhQxyeAh7O4MA=
=H5/c
-----END PGP SIGNATURE-----

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161027/7973af63/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161027/7973af63/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20161027/7973af63/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20161027/7973af63/attachment.key</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013260.html">[squid-users] filtering http(s) sites, transparently
</A></li>
	<LI>Next message (by thread): <A HREF="013262.html">[squid-users] filtering http(s) sites, transparently
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13261">[ date ]</a>
              <a href="thread.html#13261">[ thread ]</a>
              <a href="subject.html#13261">[ subject ]</a>
              <a href="author.html#13261">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
