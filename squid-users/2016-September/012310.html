<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.20 rock store and enable-disk-io
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.20%20rock%20store%20and%20enable-disk-io&In-Reply-To=%3C65be8023-a5fe-617b-002b-8d12b23a436f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012307.html">
   <LINK REL="Next"  HREF="012322.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.20 rock store and enable-disk-io</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.20%20rock%20store%20and%20enable-disk-io&In-Reply-To=%3C65be8023-a5fe-617b-002b-8d12b23a436f%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.20 rock store and enable-disk-io">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep  1 15:26:29 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012307.html">[squid-users] Squid 3.5.20 rock store and enable-disk-io
</A></li>
        <LI>Next message (by thread): <A HREF="012322.html">[squid-users] Squid 3.5.20 rock store and enable-disk-io
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12310">[ date ]</a>
              <a href="thread.html#12310">[ thread ]</a>
              <a href="subject.html#12310">[ subject ]</a>
              <a href="author.html#12310">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/09/2016 2:42 a.m., Alex Rousskov wrote:
&gt;<i> On 09/01/2016 01:48 AM, FredB wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [Unit]
</I>&gt;&gt;&gt;<i> Description=Squid Web Proxy Server
</I>&gt;&gt;&gt;<i> After=network.target
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [Service]
</I>&gt;&gt;&gt;<i> Type=simple
</I>&gt;&gt;&gt;<i> ExecStart=/usr/sbin/squid -sYC -N
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Yes this is the default value 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://bazaar.launchpad.net/~squid/squid/3.5/view/head:/tools/systemd/squid.service">http://bazaar.launchpad.net/~squid/squid/3.5/view/head:/tools/systemd/squid.service</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I guess this is wrong no ?
</I>&gt;<i> 
</I>&gt;<i> First of all, startup scripts is not my area of expertise. AFAICT, the
</I>&gt;<i> correct short answer is &quot;Using -N to start production Squid is usually
</I>&gt;<i> wrong&quot;, but that is misleading because the _default_ systemd script may
</I>&gt;<i> have to use -N until Squid itself provides a better alternative that is
</I>&gt;<i> easy to use from the default systemd script.
</I>
Squid-3 and systemd do not play nicely together, especially in SMP mode.

Why?
 Both systemd and the initial 'squid' Squid-3 process are daemon manager
processes. Running a daemon manager to manage a daemon manager of a
different type results in some very weird 'broken' behaviours. (which
are logicaly consistent and should be expected when you look closely at
what the layers of managers are doing).

Also, systemd makes some (arguably brain-dead) assumptions about
processes it starts. Which are; that its only being used to start a
single-process binary (multi-thread is okay, multi-process like Squid
gets weird even when you take the manager part away), that the PID it
started is a daemon or can be run as one, that the .pid file can be
ignored. For kernel services that probably okay, for Squid-3 (and any
other daemon manager process like it) those assumptions are critically
wrong.

The result is that -N (forcing Squid to be a single daemon/worker
process) is the least problematic way to run Squid-3 under systemd,
Upstart, or OpenRC. It is still a bad way to run Squid, but the
most-working way with those daemon managers.

If you want Squid to run well with systemd you need Squid-4 with its
updated .service file (_dont_ use that .service file with Squid-3 it
will do more damage than good).


&gt;<i> 
</I>&gt;<i> A better answer is probably something like &quot;Do not use the default
</I>&gt;<i> systemd script in production&quot; and &quot;Make sure you understand the command
</I>&gt;<i> line options you pass to Squid&quot;.
</I>&gt;<i> 
</I>&gt;<i> Squid startup and daemon mode configuration is a complicated area that
</I>&gt;<i> affects SMP, -z, and other features. There may be consensus among
</I>&gt;<i> developers on what needs to be done there to improve/fix things, but
</I>&gt;<i> nobody is working on that at the moment AFAICT.
</I>
AFAIK, most of what is needed has been done for Squid-4 and is too big a
change for Squid-3. The remaining bit is removing need for -z. Which is
optional anyhow and systemd can ignore.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012307.html">[squid-users] Squid 3.5.20 rock store and enable-disk-io
</A></li>
	<LI>Next message (by thread): <A HREF="012322.html">[squid-users] Squid 3.5.20 rock store and enable-disk-io
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12310">[ date ]</a>
              <a href="thread.html#12310">[ thread ]</a>
              <a href="subject.html#12310">[ subject ]</a>
              <a href="author.html#12310">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
