<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Debugging NTLM problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20NTLM%20problem&In-Reply-To=%3Cae9856e6-9945-0285-250f-cd81e0f4cbf6%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012328.html">
   <LINK REL="Next"  HREF="012383.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Debugging NTLM problem</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Debugging%20NTLM%20problem&In-Reply-To=%3Cae9856e6-9945-0285-250f-cd81e0f4cbf6%40treenet.co.nz%3E"
       TITLE="[squid-users] Debugging NTLM problem">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Sep  3 02:43:36 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012328.html">[squid-users] Debugging NTLM problem
</A></li>
        <LI>Next message (by thread): <A HREF="012383.html">[squid-users] Debugging NTLM problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12332">[ date ]</a>
              <a href="thread.html#12332">[ thread ]</a>
              <a href="subject.html#12332">[ subject ]</a>
              <a href="author.html#12332">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/09/2016 3:06 a.m., akn ab wrote:
&gt;<i> Hello Amos,
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> unfortunately does not solve the problem.
</I>&gt;<i> I did more investigation about the problem and i found informations.
</I>&gt;<i> Every time a user get the browser popup requesting credentials, i found on squid 
</I>&gt;<i> log this event:
</I>&gt;<i> Login for user [DOMAIN]\[user]@[PC_XXXX] failed due to [Access denied]
</I>&gt;<i> NTLMSSP BH: NT_STATUS_ACCESS_DENIED
</I>&gt;<i> 2016/09/02 16:56:13 kid1| ERROR: NTLM Authentication validating user. Result: 
</I>&gt;<i> {result=BH, notes={message: NT_STATUS_ACCESS_DENIED; }}
</I>
That is ntlm_auth (on behalf of AD) telling Squid the user credentials
are not correct. There is no NTLM protocol problem.

Consider this NT_STATUS_ACCESS_DENIED as if a user entered the wrong
password. Why do you want to allow them access in that case?


&gt;<i> It's not easy to do more debug because i have 9000 concurrent connections, but 
</I>&gt;<i> if you think that can help me, i try to set debug_option to something like 29,5
</I>&gt;<i> Sometimes users left the office letting the browser open.
</I>&gt;<i> After 1 hour (more or less), they return to the pc and popup show as soos as 
</I>&gt;<i> mouse point to a new link on the open browser.
</I>&gt;<i> It's probably because something cached expire, but i cannot demostrate it so 
</I>&gt;<i> easily beceuse, as you said, ntlm never cache.
</I>&gt;<i> On my samba/winbind logs i see many
</I>&gt;<i> rpccli_netlogon_sam_network_logon: credentials chain check failed
</I>&gt;<i> So it's very strange to understand if some problem occur beetween squid and 
</I>&gt;<i> browser or samba and Active Directory.
</I>&gt;<i> What do you think about?
</I>&gt;<i> Thanks.
</I>&gt;<i> Giulius.
</I>&gt;<i> 
</I>&gt;<i> On 1/09/2016 12:37 a.m., akn ab wrote:
</I>&gt;<i>  &gt; Dear all,
</I>&gt;<i>  &gt; i'm facing a strange problem using squid 3.5.20 with ntlm transparent
</I>&gt;<i>  &gt; authentication.
</I>&gt;<i>  &gt; I cannot use kerberos auth because i need to pass DOMAIN\user to my parent proxy
</I>&gt;<i>  &gt; with x-authenticated-user header, and the form <A HREF="https://lists.squid-cache.org/listinfo/squid-users">USERNAME at DOMAIN</A> is not supported.
</I>
I suggest you use an external_acl_type helper that takes the %LOGIN
format parameter and sends 'OK upstream_user_=&quot;...&quot; ' back to Squid. Use
the %note{upstream_user_} in your request_header_add directive to send
the right header value upstream.

That will allow you to at least keep your part of the proxy chain using
secure Negotiate authentication even though the parent proxy allows
anyone to inject traffic spoofing your user accounts.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012328.html">[squid-users] Debugging NTLM problem
</A></li>
	<LI>Next message (by thread): <A HREF="012383.html">[squid-users] Debugging NTLM problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12332">[ date ]</a>
              <a href="thread.html#12332">[ thread ]</a>
              <a href="subject.html#12332">[ subject ]</a>
              <a href="author.html#12332">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
