<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Acl to deny all sites, and allow some sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Acl%20to%20deny%20all%20sites%2C%20and%20allow%20some%20sites&In-Reply-To=%3C14487fb5-d9b9-302d-7e44-54fdb1ff3797%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012378.html">
   <LINK REL="Next"  HREF="012344.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Acl to deny all sites, and allow some sites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Acl%20to%20deny%20all%20sites%2C%20and%20allow%20some%20sites&In-Reply-To=%3C14487fb5-d9b9-302d-7e44-54fdb1ff3797%40treenet.co.nz%3E"
       TITLE="[squid-users] Acl to deny all sites, and allow some sites">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Sep  4 15:54:21 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012378.html">[squid-users] Copy and send decrypted HTTPS traffic to specific location
</A></li>
        <LI>Next message (by thread): <A HREF="012344.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12343">[ date ]</a>
              <a href="thread.html#12343">[ thread ]</a>
              <a href="subject.html#12343">[ subject ]</a>
              <a href="author.html#12343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/08/2016 1:55 p.m., hibandx wrote:
&gt;<i> So, i have an squid configured and ok with ad 2012, but the acl
</I>&gt;<i> Proxy_restrito is not working...
</I>&gt;<i> 
</I>&gt;<i> This acl is for 
</I>&gt;<i> 
</I>&gt;<i> any solution?
</I>
What version of Squid are you using?
 the &quot;squid -v&quot; command will show that detail.

&gt;<i> 
</I>&gt;<i> This is my conf is for deny all sites, and allow just some sites on file
</I>&gt;<i> proxy_restrito_whitelist...
</I>&gt;<i> 
</I>
Your http_access rules allow a lot of things to go through the proxy
before proxy_restrito_whitelist is every considered as a limitation.

After those allows there is no rule allowing access to clients that do
get past the rule involving proxy_restrito_whitelistd.


&gt;<i> follow:
</I>&gt;<i> 
</I>&gt;<i> #Porta padr&#227;o do proxy
</I>&gt;<i> http_port 3128
</I>&gt;<i>  
</I>&gt;<i> #Endereco de E-mail do administrador do proxy
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">suporte at dominio.local</A>
</I>&gt;<i>  
</I>
&gt;<i>From here ...
</I>
&gt;<i> #Nao faz cache de dados de formularios html,em de resultados de programas
</I>&gt;<i> cgi                      
</I>&gt;<i> #hierarchy_stoplist cgi-bin ?
</I>&gt;<i>  
</I>&gt;<i> #Cria uma access control list, baseando-se na url e utilizando exp.
</I>&gt;<i> regulares nesta situacao   
</I>&gt;<i> #foi criado uma exp. regular para cgi e ?.        
</I>&gt;<i> acl QUERY urlpath_regex cgi-bin \?
</I>&gt;<i>  
</I>&gt;<i> #Nao faz cache da acl QUERY                        
</I>&gt;<i> cache deny QUERY
</I>
.. to here can be removed completely.

Your config contains the refresh_pattern necessary to handle dynamic
content properly.

&lt;snip a lot of directives mostly set to default values&gt;
If you have a Squid-3.1 or later you can remove any config options which
are set to the default values. That will help clarify the non-normal
things your Squid is doing.



&gt;<i> #Maquinas que nao precisaram de autenticacao   
</I>&gt;<i> acl liberados dstdomain &quot;/etc/squid/regras/liberados&quot;
</I>&gt;<i> http_access allow liberados
</I>&gt;<i>  
</I>&gt;<i> #liberar o acesso ao site da caixa que est&#225; com problemas 
</I>&gt;<i> #acl caixa dstdomain caixa.gov.br
</I>&gt;<i> #always_direct allow caixa
</I>&gt;<i> #cache deny caixa
</I>&gt;<i>  
</I>&gt;<i> #MACS que est&#227;o liberados.
</I>&gt;<i> acl macliberado   arp &quot;/etc/squid/regras/mac_liberado&quot;
</I>&gt;<i> http_access allow macliberado
</I>&gt;<i>  
</I>
Please place custom http_access rules down ....

&gt;<i>  
</I>&gt;<i> ### ACL Padroes
</I>&gt;<i> acl SSL_ports port 443 # https
</I>&gt;<i> acl SSL_ports port 563 # snews
</I>&gt;<i> acl SSL_ports port 873 # rsync
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 563 # https, snews
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;<i> acl Safe_ports port 631 # cups
</I>&gt;<i> acl Safe_ports port 873 # rsync
</I>&gt;<i> acl Safe_ports port 901 # SWAT
</I>&gt;<i> acl Safe_ports port 1080
</I>&gt;<i> acl Safe_ports port 1863
</I>&gt;<i> acl Safe_ports port 8443 # https
</I>&gt;<i> acl Safe_ports port 5222 # gTalk
</I>&gt;<i> acl Safe_ports port 5223 # gTalk
</I>&gt;<i> acl Safe_ports port 47057 # torrent
</I>&gt;<i> 
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>
... here after the security default http_access rules.

&gt;<i> #Limita conexeos HTTP
</I>&gt;<i> #acl connect_abertas maxconn 8
</I>&gt;<i> 
</I>&gt;<i> #sites que n&#227;o ser&#227;o feito cache geralmente bancos
</I>&gt;<i> acl NOCACHE dstdomain &quot;/etc/squid/regras/direto&quot; \?
</I>&gt;<i> no_cache deny NOCACHE
</I>
Remove the &quot;no_&quot; part from the above line.


&gt;<i>  
</I>&gt;<i> #### Autenticao no Windows 2008/2012/Samba 4 via WINBIND
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 30
</I>&gt;<i> auth_param basic program /usr/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 5
</I>&gt;<i> auth_param basic realm Squid proxy server
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> #Note que abaixo o meu sistema &#233; 64 ent&#227;o as minhas libs est&#227;o em /usr/lib64
</I>&gt;<i> caso esteja utilizando sistema 32 troque para /usr/lib
</I>&gt;<i> external_acl_type ad_group ttl=1800 children=200 %LOGIN
</I>&gt;<i> /usr/lib64/squid/ext_wbinfo_group_acl
</I>&gt;<i> 
</I>&gt;<i> #-----------------------------------------------------------------------------------#
</I>&gt;<i> #       Nome ACL                TIPO                    Nome Grupo AD              
</I>&gt;<i> #
</I>&gt;<i> #-----------------------------------------------------------------------------------#
</I>&gt;<i> 
</I>&gt;<i> acl    proxy_livre        external ad_group          proxy_livre
</I>&gt;<i> acl    proxy_geral           external ad_group          proxy_geral
</I>&gt;<i> acl    proxy_restrito      external ad_group         proxy_restrito
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Whitelists / Blacklists
</I>&gt;<i> acl downloads         urlpath_regex -i &quot;/etc/squid/regras/downloads&quot;
</I>&gt;<i> acl proxy_restrito_whitelist url_regex -i
</I>&gt;<i> &quot;/etc/squid/regras/proxy_restrito_whitelist&quot;
</I>&gt;<i> acl proxy_geral_bracklist   url_regex  -i
</I>&gt;<i> &quot;/etc/squid/regras/proxy_geral_blacklist&quot;
</I>&gt;<i> acl proxy_livre_proibidos	url_regex	 -i
</I>&gt;<i> &quot;/etc/squid/regras/proxy_livre_proibidos&quot;
</I>&gt;<i> 
</I>&gt;<i> #Bloquear determinados usu&#225;rios autenticados
</I>&gt;<i> acl usuarios_bloqueados proxy_auth &quot;/etc/squid/regras/usuarios_bloqueados&quot;
</I>&gt;<i>  
</I>&gt;<i> #Controle de acesso por hor&#225;rio aqui, vamos liberar o acesso no hor&#225;rio do
</I>&gt;<i> almo&#231;o
</I>&gt;<i> #aqui os usu&#225;rio v&#227;o poder acessar alguns sites diferenciados entre as 12:00
</I>&gt;<i> at&#233; as 13:00
</I>&gt;<i> #acl almoco time MTWHFAS 12:30-13:30
</I>&gt;<i> 
</I>&gt;<i> #Agora vamos criar uma regra para garantir que os usu&#225;rios que v&#227;o acessar
</I>&gt;<i> no almo&#231;o est&#227;o autenticados
</I>&gt;<i> acl autenticados proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> #Agora vamos criar uma lista de sites que eles v&#227;o poder acessar no hor&#225;rio
</I>&gt;<i> do almo&#231;o
</I>&gt;<i> acl sites-almoco   url_regex     -i &quot;/etc/squid/regras/sites_almoco&quot;
</I>&gt;<i> 
</I>&gt;<i> # Permissoes de Acesso
</I>&gt;<i> http_access allow proxy_livre !proxy_livre_proibidos
</I>&gt;<i> http_access deny  downloads
</I>&gt;<i> http_access deny  usu_bloqueados
</I>&gt;<i> http_access allow proxy_geral !proxy_geral_bracklist
</I>&gt;<i> http_access deny proxy_restrito 	!proxy_restrito_whitelist
</I>
Any &quot;http_access deny&quot; rule folowed by &quot;http_access deny all&quot; is almost
guaraneed to be useless waste of CPU and config file text.

&gt;<i> ############################################################
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i> icp_access allow all
</I>&gt;<i> miss_access allow all
</I>&gt;<i> visible_hostname proxy
</I>&gt;<i> error_directory /usr/share/squid/errors/pt-br
</I>&gt;<i> #cache_effective_group squid
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012378.html">[squid-users] Copy and send decrypted HTTPS traffic to specific location
</A></li>
	<LI>Next message (by thread): <A HREF="012344.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12343">[ date ]</a>
              <a href="thread.html#12343">[ thread ]</a>
              <a href="subject.html#12343">[ subject ]</a>
              <a href="author.html#12343">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
