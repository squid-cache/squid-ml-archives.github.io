<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3Cba42abf98b0746c0ac080a7484b444ec%40IT-S-MAIL1.asd.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012349.html">
   <LINK REL="Next"  HREF="012386.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy</H1>
    <B>John Sayce</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3Cba42abf98b0746c0ac080a7484b444ec%40IT-S-MAIL1.asd.local%3E"
       TITLE="[squid-users] Transparent Proxy">jsayce at asdlighting.com
       </A><BR>
    <I>Wed Sep  7 08:23:02 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012349.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
        <LI>Next message (by thread): <A HREF="012386.html">[squid-users] Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12385">[ date ]</a>
              <a href="thread.html#12385">[ thread ]</a>
              <a href="subject.html#12385">[ subject ]</a>
              <a href="author.html#12385">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to set up a transparent proxy but I'm fairly sure I'm missing something.

I've followed the instructions on the juniper website along with a couple of other blogs as per:
<A HREF="https://damn.technology/using-squid-juniper-pbr-transparent-proxy">https://damn.technology/using-squid-juniper-pbr-transparent-proxy</A>
<A HREF="http://davehope.co.uk/Blog/implementing-pbr-and-squid3-as-a-transparent-proxy/">http://davehope.co.uk/Blog/implementing-pbr-and-squid3-as-a-transparent-proxy/</A>
<A HREF="https://kb.juniper.net/InfoCenter/index?id=KB24139&amp;page=content&amp;actp=search">https://kb.juniper.net/InfoCenter/index?id=KB24139&amp;page=content&amp;actp=search</A>


I have a juniper SSG320 firewall setup with policy based routing.  For my chosen subnet this is configured to forward traffic on port 80 to the squid server.

The traffic from my firewall is forwarded to squid.  This appears to be happening.  

The client starts with a syn packet which is forwarded from the firewall to the squid server. The packet is forwarded to the squid server with the source IP address remaining that of the client.  The problem is that the squid server then responds to the client as itself rather than spoofing the address that the client originally requested. So the ACK packet the client receives is from the squid server rather than the remote webserver the client made a request to, which isn't going to work.

So should my firewall be doing something more, or is it my squid server that's not performing as expected?

In addition to forwarding the packet to squid I can enable source translation on the firewall (which isn't in the guides I mentioned) so the source address of the packet sent to squid comes from the firewall, squid then responds to the firewall, which in turn translates the packet back to the client.  This configuration works, however the access log stores the address of the firewall rather than the address of the client.  Is this how it's meant to work, or am I missing something?

Thanks

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012349.html">[squid-users] More host header forgery pain with peek/splice
</A></li>
	<LI>Next message (by thread): <A HREF="012386.html">[squid-users] Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12385">[ date ]</a>
              <a href="thread.html#12385">[ thread ]</a>
              <a href="subject.html#12385">[ subject ]</a>
              <a href="author.html#12385">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
