<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3Cc1871bc8b9fe4e51b02fba9f36e274e6%40IT-S-MAIL1.asd.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012414.html">
   <LINK REL="Next"  HREF="012416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent Proxy</H1>
    <B>John Sayce</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20Proxy&In-Reply-To=%3Cc1871bc8b9fe4e51b02fba9f36e274e6%40IT-S-MAIL1.asd.local%3E"
       TITLE="[squid-users] Transparent Proxy">jsayce at asdlighting.com
       </A><BR>
    <I>Thu Sep  8 08:44:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012414.html">[squid-users] Transparent Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="012416.html">[squid-users] Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12415">[ date ]</a>
              <a href="thread.html#12415">[ thread ]</a>
              <a href="subject.html#12415">[ subject ]</a>
              <a href="author.html#12415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>After I wrote this I realised it should be changing the mac not the ip, which is not what&#8217;s happeneing.  I think it's my firewall configuration that's wrong.

Thanks



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Antony Stone
Sent: 08 September 2016 09:36
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Transparent Proxy

On Thursday 08 September 2016 at 10:12:48, John Sayce wrote:

&gt;<i> For testing purposes I've reduced it to the following:
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> #dns_v4_first on
</I>&gt;<i> dns_nameservers 10.8.2.3 194.168.4.100 10.8.2.2 8.8.8.8 acl wifi src 
</I>&gt;<i> 10.8.14.0/24 acl all src all http_access allow all maximum_object_size 
</I>&gt;<i> 1 GB minimum_object_size 0 KB maximum_object_size_in_memory 4 MB 
</I>&gt;<i> cache_mem 1700 MB cache_dir aufs /var/cache/squid 40000 32 512 
</I>&gt;<i> coredump_dir /var/cache/squid access_log /var/log/squid/access.log 
</I>&gt;<i> squid cache_log /var/log/squid/cache.log
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> cache_effective_user asd
</I>&gt;<i> cache_effective_group asd
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jsayce at asdlighting.com</A>
</I>&gt;<i> forwarded_for off
</I>&gt;<i> 
</I>&gt;<i> The version is 3.5.12
</I>&gt;<i> 
</I>&gt;<i> Okay.  Sorry, to clarify with a specific example.
</I>
Don't apologise - specific examples are good, because it makes sure we're both talking about the same thing (and sometimes, as below, reveals little details about the network arrangement which weren't previously clear).

&gt;<i> Lets say I'm contacting <A HREF="http://1.1.1.1/">http://1.1.1.1/</A> then the ack packet starts off 
</I>&gt;<i> with the client with ip address 10.8.14.9
</I>
So, source IP = 10.8.14.9 : destination IP = 1.1.11

&gt;<i> in subnet 10.8.14.9/24 with default gateway 10.8.14.1. 
</I>&gt;<i> It's routed through my core switch to my my firewall with ip 10.8.1.1.
</I>
So that's a router, not just a switch?  It has one interface 10.8.14.1 on subnet 10.8.14.0/24 and another interface on (presumably) 10.8.1.0/24 pointing at 10.8.1.1 as the next-hop route towards 1.1.1.1

&gt;<i> My firewall recognises that the packet has a destination port 80 and 
</I>&gt;<i> is in subnet 10.8.14.0/24
</I>
The source address is in that subnet, yes.

&gt;<i> and changes the destination address to be that of my proxy server 10.8.2.11.
</I>
No - see below.

&gt;<i> So now the ack packet has source 10.8.14.9 and destination 10.8.2.11.
</I>
No, it doesn't.  When a packet goes via a router, its destination IP address is not changed to the address of the next-hop router (otherwise things would never work across the Internet).

It's only the destination MAC address in the encapsulating ethernet frame which gets changed to that of the next-hop router.  The source and destination IP addresses inside are not touched.

&gt;<i> How does iptables know to reply to my client 10.8.14.9 with source 
</I>&gt;<i> address 1.1.1.1?  Does iptables know to read the header?
</I>
TCP header, yes.

HTTP header, no.

Just think about the very first link between the client and its default
gateway:

Packet with source address = 10.8.14.9, destinatoin address = 1.1.1.1

How does that packet get to the default router 10.8.14.1?  Its destination IP is 1.1.1.1, so that doesn't help.

It's because the destination MAC address in the ethernet frame containing that IP packet is the MAC address of 10.8.14.1.

A few minutes playing around with wireshark on your network could be quite enlightening :)



Regards,


Antony.

-- 
I think broken pencils are pointless.

                                                   Please reply to the list;
                                                         please *don't* CC me.
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012414.html">[squid-users] Transparent Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="012416.html">[squid-users] Transparent Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12415">[ date ]</a>
              <a href="thread.html#12415">[ thread ]</a>
              <a href="subject.html#12415">[ subject ]</a>
              <a href="author.html#12415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
