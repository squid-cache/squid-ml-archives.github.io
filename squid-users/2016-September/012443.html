<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TProxy and client_dst_passthru
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3Cf6cbebb8-3ca6-8d7f-8524-0649a020703c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012440.html">
   <LINK REL="Next"  HREF="012444.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TProxy and client_dst_passthru</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TProxy%20and%20client_dst_passthru&In-Reply-To=%3Cf6cbebb8-3ca6-8d7f-8524-0649a020703c%40treenet.co.nz%3E"
       TITLE="[squid-users] TProxy and client_dst_passthru">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Sep 11 16:23:39 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012440.html">[squid-users] TProxy and client_dst_passthru
</A></li>
        <LI>Next message (by thread): <A HREF="012444.html">[squid-users] TProxy and client_dst_passthru
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12443">[ date ]</a>
              <a href="thread.html#12443">[ thread ]</a>
              <a href="subject.html#12443">[ subject ]</a>
              <a href="author.html#12443">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/09/2016 3:04 a.m., Omid Kosari wrote:
&gt;<i> 
</I>&gt;<i> I refer to following messages .i have same problem
</I>&gt;<i> 
</I>
The &quot;problem&quot; is misunderstanding of the log entry meaning.

&gt;<i> 
</I>&gt;<i> FredT wrote
</I>&gt;&gt;<i> Hi Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We have done additional tests in production with ISPs and the ORIGINAL_DST
</I>&gt;&gt;<i> in tproxy cannot be cached.
</I>&gt;&gt;<i> In normal mode (not tproxy), ORIGINAL_DST can be cached, no problem.
</I>&gt;&gt;<i> But once in tproxy (http_port 3128 tproxy), no way, it's impossible to get
</I>&gt;&gt;<i> TCP_HIT.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We have played with the client_dst_passthru and the host_verify_strict,
</I>&gt;&gt;<i> many combinaisons on/off.
</I>&gt;&gt;<i> By settings client_dst_passthru ON and host_verify_strict OFF, we can
</I>&gt;&gt;<i> reduce the number of ORIGINAL_DST (generating DNS &quot;alerts&quot; in the
</I>&gt;&gt;<i> cache.log) but it makes issues with HTTPS websites (facebook, hotmail,
</I>&gt;&gt;<i> gmail, etc...).
</I>
Nod. That is the purpose of those controls. So they are working.

&gt;&gt;<i> We have also tried many DNS servers (internals and/or externals), same
</I>&gt;&gt;<i> issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I read what you explain in your previous email but it seems there is
</I>&gt;&gt;<i> something weird.
</I>&gt;&gt;<i> The problem is that the ORIGINAL_DST could be up to 25% of the traffic
</I>&gt;&gt;<i> with some installations meaning this part is &quot;out-of-control&quot; in term of
</I>&gt;&gt;<i> cache potential.
</I>
Any server type could be up to 100%. The type of server used implies
nothing about caching potential.

The reverse is true: caching potential implies server type, with
adjustments for traffic mode type and squid.conf settings.

For example:
 HIT implies HEIR_NONE.

 MISS with intercept/tproxy implies ORIGINAL_DST or a peer.
 REFRESH with intercept/tproxy implies ORIGINAL_DST or a peer.

 MISS in forward-proxy implies DIRECT or a peer.
 REFRESH in forward-proxy implies DIRECT or a peer.

&gt;<i> 
</I>&gt;<i> FredT wrote
</I>&gt;&gt;<i> Hi Eliezer,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, we have done many tests with Squid (3.1 to 3.5.x), disabling
</I>&gt;&gt;<i> &quot;client_dst_passthru&quot; (off) will stop the DNS entry as explained in the
</I>&gt;&gt;<i> wiki, the option directly acts on the flag &quot;ORIGINAL_DST&quot;.
</I>&gt;&gt;<i> As you know, ORIGINAL_DST switches the optimization off (ex: StoreID) then
</I>&gt;&gt;<i> it's not possible to cache the URL (ex:
</I>&gt;&gt;<i> <A HREF="http://cdn2.example.com/mypic.png">http://cdn2.example.com/mypic.png</A>).
</I>
ORIGINAL_DST does nothing. It is simply a label indicating which type of
server supplied the HTTP response message for the transaction.

&gt;&gt;<i>
</I>&gt;&gt;<i> In no tproxy/NAT mode, the client_dst_passthru works perfectly by
</I>&gt;&gt;<i> disabling the DNS entry control, so optimization is done correctly.
</I>&gt;&gt;<i> But in tproxy/NAT, the client_dst_passthru has no effect, we see
</I>&gt;&gt;<i> ORIGINAL_DST in logs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, maybe I'm totaly wrong here the client_dst_passthru is not related to
</I>&gt;&gt;<i> the ORIGINAL_DST,
</I>
&quot;client_dst_passthru on&quot; makes Squid use ORIGINAL_DST (client provided)
server instead of DIRECT (DNS lookup) server(s) for *all* intercepted
traffic. Even requests where DIRECT is possible.


&gt;<i> or there is an explaination why the client_dst_passthru
</I>&gt;&gt;<i> does not act in tproxy/NAT...
</I>&gt;&gt;<i>
</I>
There is. The &quot;transparent&quot; part of &quot;transparent interception proxy&quot;
means that MISS should use the same server the client was originally
sending its request to (the ORIGINAL_DST server).


&gt;&gt;<i> Bye Fred
</I>&gt;<i> 
</I>&gt;<i> please look at following results 
</I>...
&gt;<i> 
</I>&gt;<i> 60% vs 2% hit ratio(bytes) . The problem is ORIGINAL_DST
</I>&gt;<i> 
</I>
The only visible problem is why that 2% exists.

==&gt; ORIGINAL_DST is should *only* ever be used on MISS or
REFRESH/revalidate traffic. Never on a HIT. Thus zero (0%) hit-ratio is
the expected behaviour.

For the same reason that a report of the log traffic using &quot;grep -v HIT&quot;
will show zero cache ratio.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012440.html">[squid-users] TProxy and client_dst_passthru
</A></li>
	<LI>Next message (by thread): <A HREF="012444.html">[squid-users] TProxy and client_dst_passthru
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12443">[ date ]</a>
              <a href="thread.html#12443">[ thread ]</a>
              <a href="subject.html#12443">[ subject ]</a>
              <a href="author.html#12443">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
