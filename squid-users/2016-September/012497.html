<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cannot get ACL to work
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cannot%20get%20ACL%20to%20work&In-Reply-To=%3C2ecd5868-4e68-cd94-75d5-c921eaf72e10%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012494.html">
   <LINK REL="Next"  HREF="012512.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cannot get ACL to work</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cannot%20get%20ACL%20to%20work&In-Reply-To=%3C2ecd5868-4e68-cd94-75d5-c921eaf72e10%40treenet.co.nz%3E"
       TITLE="[squid-users] Cannot get ACL to work">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Sep 14 13:35:13 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012494.html">[squid-users] Cannot get ACL to work
</A></li>
        <LI>Next message (by thread): <A HREF="012512.html">[squid-users] Cannot get ACL to work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12497">[ date ]</a>
              <a href="thread.html#12497">[ thread ]</a>
              <a href="subject.html#12497">[ subject ]</a>
              <a href="author.html#12497">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/09/2016 5:43 p.m., Jason Leshchyshyn wrote:
&gt;<i> Ugh, I am trying to get Squid to deny access to a particular AD group, but when I enable the rule, then it denys everyone. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This is what I have in squid.conf 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # NTLM 
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp 
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm children 15 
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm keep_alive on 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Limit access for Factory users 
</I>&gt;<i> 
</I>&gt;<i> external_acl_type nt_group %LOGIN /usr/lib64/squid/ext_wbinfo_group_acl 
</I>&gt;<i> 
</I>&gt;<i> acl FactoryDeny external nt_group sec_deny_internet 
</I>&gt;<i> 
</I>&gt;<i> http_access deny FactoryDeny 
</I>&gt;<i> 
</I>
Move all that below the &quot;deny !auth&quot; line. One would expect clients to
login before group checking. Order is important.


&gt;<i> 
</I>&gt;<i> acl auth proxy_auth REQUIRED 
</I>&gt;<i> 
</I>&gt;<i> http_access deny !auth 
</I>&gt;<i> 
</I>&gt;<i> http_access allow auth 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -=- 
</I>&gt;<i> I have verified the ext_wbinfo_group_acl works: 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;blockquote&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at fac-proxy</A> squid]# ./ext_wbinfo_group_acl -d 
</I>&gt;<i> 
</I>&gt;<i> Debugging mode ON. 
</I>&gt;<i> 
</I>&gt;<i> user sec_vpn_users 
</I>&gt;<i> 
</I>&gt;<i> Got user sec_vpn_users from squid 
</I>
This is irrelevant sec_vpn_users is not a group in the config above.

&gt;<i> 
</I>&gt;<i> user sec_deny_internet 
</I>&gt;<i> 
</I>&gt;<i> Got user sec_deny_internet from squid 
</I>&gt;<i> 
</I>&gt;<i> User: -user- 
</I>&gt;<i> 
</I>&gt;<i> Group: -sec_deny_internet- 
</I>&gt;<i> 
</I>&gt;<i> SID: -S-1-5-21-1978138449-291607360-3720246513-18148- 
</I>&gt;<i> 
</I>&gt;<i> GID: -1677721- 
</I>&gt;<i> 
</I>&gt;<i> Sending ERR to squid 
</I>&gt;<i> 
</I>
Meaning the &quot;deny FactoryDeny&quot; is false (no deny action) when the
username is &quot;user&quot;.


&gt;<i> 
</I>&gt;<i> Because this is a production server there's a bunch of traffic on it so I can't catch too much of the log, but this is what I can see with debugging turned on: 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;blockquote&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2016/09/13 23:22:32.552 kid1| Acl.cc(336) matches: ACLList::matches: checking FactoryDeny 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2016/09/13 23:22:32.552 kid1| Acl.cc(319) checklistMatches: ACL::checklistMatches: checking 'FactoryDeny' 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2016/09/13 23:22:32.552 kid1| Acl.cc(321) checklistMatches: ACL::ChecklistMatches: result for 'FactoryDeny' is -1 
</I>&gt;<i> 
</I>
Login credentials are unknown (-1). Authentication needs to be performed
and the ACLs checked again.


&gt;<i> 
</I>&gt;<i> 2016/09/13 23:22:32.552 kid1| Acl.cc(343) matches: FactoryDeny failed. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2016/09/13 23:22:32.552 kid1| Acl.cc(354) matches: FactoryDeny result is false 
</I>&gt;<i> &lt;/blockquote&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If the result is false then the deny should be false and it should continue to the next rule, right? 
</I>&gt;<i> 
</I>
Normally yes, but authentication is involved here and that makes it a
bit more complex.

Since the external_acl_type uses %LOGIN and responds with -1, that is a
signal that the false actually means Squid is to generate the 407/401
response to make authentication happen. The http_access action is not
known yet, and wont be until the client presents some credentials.


The suggestion above to place the authentication above the group lookup
simplifies things again by ensuring that auth has already happened and
this special-case situation with %LOGIN does not happen very often.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012494.html">[squid-users] Cannot get ACL to work
</A></li>
	<LI>Next message (by thread): <A HREF="012512.html">[squid-users] Cannot get ACL to work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12497">[ date ]</a>
              <a href="thread.html#12497">[ thread ]</a>
              <a href="subject.html#12497">[ subject ]</a>
              <a href="author.html#12497">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
