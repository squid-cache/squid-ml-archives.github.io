<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache github zip repositories
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20github%20zip%20repositories&In-Reply-To=%3C555fbe87-18f2-2998-3d26-3837a9fb8337%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012509.html">
   <LINK REL="Next"  HREF="012538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache github zip repositories</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20github%20zip%20repositories&In-Reply-To=%3C555fbe87-18f2-2998-3d26-3837a9fb8337%40treenet.co.nz%3E"
       TITLE="[squid-users] cache github zip repositories">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep 15 00:35:03 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012509.html">[squid-users] cache github zip repositories
</A></li>
        <LI>Next message (by thread): <A HREF="012538.html">[squid-users] cache github zip repositories
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12510">[ date ]</a>
              <a href="thread.html#12510">[ thread ]</a>
              <a href="subject.html#12510">[ subject ]</a>
              <a href="author.html#12510">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/09/2016 11:54 a.m., Hardik Dangar wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I am trying to cache Github zip URL's so it can be effectively cached as a
</I>&gt;<i> composer(php dependency management tool) uses them and in our local setup (
</I>&gt;<i> we are about 40 developers on a Lan and it will really help us managing
</I>&gt;<i> cache.). My squid version is 3.5.12 and our squid cache server is ubuntu
</I>&gt;<i> 16.04. Here is squid.conf file we use,
</I>&gt;<i> <A HREF="https://gist.github.com/hardikdangar/df31d5bce725eff66e06f3abd6e77600">https://gist.github.com/hardikdangar/df31d5bce725eff66e06f3abd6e77600</A>
</I>&gt;<i> 
</I>&gt;<i> Here is the part which I want to cache,
</I>&gt;<i> say for example you want to download repo from GitHub then URL looks like
</I>&gt;<i> <A HREF="https://github.com/hardikdangar/test/archive/master.zip">https://github.com/hardikdangar/test/archive/master.zip</A>
</I>&gt;<i> but it redirects to the following,
</I>&gt;<i> <A HREF="https://codeload.github.com/hardikdangar/test/zip/master">https://codeload.github.com/hardikdangar/test/zip/master</A>
</I>&gt;<i> 
</I>&gt;<i> You can see the response parameters via redbot.org
</I>&gt;<i> <A HREF="https://redbot.org/?uri=https%3A%2F%2Fcodeload.github.com%">https://redbot.org/?uri=https%3A%2F%2Fcodeload.github.com%</A>
</I>&gt;<i> 2Fhardikdangar%2Ftest%2Fzip%2Fmaster
</I>&gt;<i> 
</I>&gt;<i>   HTTP/1.1 200 OK
</I>&gt;<i>     Content-Length: 929
</I>&gt;<i>     Access-Control-Allow-Origin: <A HREF="https://render.githubusercontent.com">https://render.githubusercontent.com</A>
</I>&gt;<i>     Content-Security-Policy: default-src 'none'; style-src 'unsafe-inline'
</I>&gt;<i>     Strict-Transport-Security: max-age=31536000
</I>&gt;<i>     Vary: Authorization,Accept-Encoding
</I>&gt;<i>     X-Content-Type-Options: nosniff
</I>&gt;<i>     X-Frame-Options: deny
</I>&gt;<i>     X-XSS-Protection: 1; mode=block
</I>&gt;<i>     ETag: &quot;9ea9838812d6f7bc53763eb1577da04e2fa473d5&quot;
</I>&gt;<i>     Content-Type: application/zip
</I>&gt;<i>     Content-Disposition: attachment; filename=test-master.zip
</I>&gt;<i>     X-Geo-Block-List:
</I>&gt;<i>     Date: Wed, 14 Sep 2016 23:24:44 GMT
</I>&gt;<i>     X-GitHub-Request-Id: 77092BF1:7F40:346461:57D9DC3C
</I>&gt;<i> 
</I>&gt;<i> Now if i do any change to above repository github does change ETAG and if i
</I>&gt;<i> don't change anything then ETAG remains the same so i believe we should be
</I>&gt;<i> able to cache those .zip files.
</I>&gt;<i> 
</I>&gt;<i> By default, squid does not cache codeload.github.com, to put it into cache,
</I>&gt;<i> I added,
</I>&gt;<i> refresh_pattern codeload.github.com 900 20% 4320 reload-into-ims
</I>&gt;<i> 
</I>&gt;<i> Now as per my understanding this should check etag as Last-Modified is not
</I>&gt;<i> provided by github for each new request. This does cache the zip file but
</I>&gt;<i> what happens is in next request even if i change the content and etag
</I>&gt;<i> changes squid sends the cached file from its cache instead of downloading
</I>&gt;<i> new file.
</I>&gt;<i> 
</I>&gt;<i> I have no clue why this happens. Can anyone help me figure out what's wrong
</I>&gt;<i> here? why squid does not detect new etag when repository is updated? why it
</I>&gt;<i> sends cache file even though there is new file available.
</I>&gt;<i> 
</I>
Consider: how does Squid know the ETag has changed on the server?

What you know about things happening in RL is not what Squid knows.

I fact how do *you* know someone else did not commit a change during
that ~1 second it takes to look at the page and click the download button?
 Simply, you don't, and cannot until the new object has been fetched.

Likewise, Squid cannot know if the object is the same until it has
fetched a MISS from the server. Except that Squid does not look at the
previous page content, so it cannot even 'see' if there is a commit
listed there that might be different since whenever it got the previous
object.

There is no Cache-Control or Expires header indicating a specific
storage timeout or revalidation procedure. So refresh_pattern defaults
will be used. These responses will be cached for the refresh_pattern
'Min' duration (900 minutes) before being considered for revalidated.


NP 1: Synthesizing Last-Modified from the Date header is only just being
fixed in Squid the past few weeks, and some parts of it still to be
committed. So I would not expect that response to be revalidated, just
re-fetched fully in older Squid.


NP 2: The Vary header indicates that every person logged in gets a
differently cached response based on how their credentials are hashed on
each request (in Authorization tokens). So caching these objects will
not help much with many developers involved. It will be of most help for
the anonymous visitors where username is always a generic NIL value.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012509.html">[squid-users] cache github zip repositories
</A></li>
	<LI>Next message (by thread): <A HREF="012538.html">[squid-users] cache github zip repositories
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12510">[ date ]</a>
              <a href="thread.html#12510">[ thread ]</a>
              <a href="subject.html#12510">[ subject ]</a>
              <a href="author.html#12510">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
