<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Delay pools for authentcated users
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay%20pools%20for%20authentcated%20users&In-Reply-To=%3C4bfe0297-ce91-9aa0-43fb-bfc5337b8c8f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012545.html">
   <LINK REL="Next"  HREF="012547.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Delay pools for authentcated users</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay%20pools%20for%20authentcated%20users&In-Reply-To=%3C4bfe0297-ce91-9aa0-43fb-bfc5337b8c8f%40treenet.co.nz%3E"
       TITLE="[squid-users] Delay pools for authentcated users">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 16 14:34:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012545.html">[squid-users] Delay pools for authentcated users
</A></li>
        <LI>Next message (by thread): <A HREF="012547.html">[squid-users] SQUID 3.4.8 on RPi 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12550">[ date ]</a>
              <a href="thread.html#12550">[ thread ]</a>
              <a href="subject.html#12550">[ subject ]</a>
              <a href="author.html#12550">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/09/2016 11:45 p.m., Ver&#243;nica Ovando wrote:
&gt;<i> Hi!
</I>&gt;<i> 
</I>&gt;<i> I am trying to set up delay pools for AD authenticated users.
</I>&gt;<i> 
</I>&gt;<i> I run Squid 3.4.8 in a Debian 8 server.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I configured come delay pools, but they really don't have effect. What I want to do is to provide full bandwidth for some pages and create a delay for ALL the others. This is because I can't restrict internet surfing and I need a solution and control bandwidth usage.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> (Squid is working without problems with AD, so I will omit some directives about authentication )
</I>&gt;<i> 
</I>
delay_access is a 'fast' category access control. It cannot do auth or
group lookups itself. In order to work with those type of ACL it
requires a previous access control (usually http_access) to have checked
them first and recorded the results as part of the transacion state.


&gt;<i> 
</I>&gt;<i> For example:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #****************************ACLs**************************#
</I>&gt;<i> 
</I>&gt;<i> acl AD_Standard external Grupos_AD Standard
</I>&gt;<i> 
</I>&gt;<i> acl redLocal src 90.0.0.0/22
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #****************************Delay Pools**************************#
</I>&gt;<i> 
</I>&gt;<i> delay_pools 3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> delay_class 1 4
</I>&gt;<i> 
</I>&gt;<i> delay_access 1 allow AD_Standard socialNets
</I>&gt;<i> delay_access 1 deny all
</I>&gt;<i> delay_parameters 1 32000/32000 8000/8000 600/64000 1000/10000
</I>&gt;<i> 
</I>&gt;<i> delay_class 2 1
</I>&gt;<i> delay_parameters 2 -1/-1
</I>
This is a useless pool. It wastes time calculating bandwidth caps
delays, only to not do any limiting.

Instead of having an &quot;unlimited&quot; pool, simply deny these transactions
from having one of the other pools applied to them. By definition
anything which does not have a pool assigned is unlimited.


Especially since when a transaction meets the criteria for multiple
pools they will *all* have some effect on that transactions bandwidth.
Which can lead to some weird behaviours and (negative!) available
bandwidth values in the byte accounting.


&gt;<i> delay_access 2 allow redLocal redLocal
</I>&gt;<i> delay_access 2 allow redLocal oficiales
</I>&gt;<i> delay_access 2 allow redLocal diarios
</I>&gt;<i> delay_access 2 allow redLocal bancos
</I>&gt;<i> delay_access 2 allow redLocal tarjCred
</I>&gt;<i> delay_access 2 allow redLocal inmueble
</I>&gt;<i> delay_access 2 allow redLocal mails
</I>&gt;<i> delay_access 2 allow redLocal externos
</I>&gt;<i> delay_access 2 allow redLocal varias
</I>&gt;<i> delay_access 2 allow redLocal servicios
</I>&gt;<i> delay_access 2 deny all
</I>&gt;<i> 
</I>&gt;<i> delay_class 3 4
</I>&gt;<i> delay_parameters 3 32000/32000 8000/8000 10000/64000 15000/50000
</I>&gt;<i> delay_access 3 allow AD_Standard all
</I>&gt;<i> delay_access 3 deny all
</I>&gt;<i> 
</I>&gt;<i> #*******************************************************************************************#
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So, I am creating three delay_pools, the first one provides 10KB for
</I>&gt;<i> each user (for the AD group Standard), no matters hoy many hosts are
</I>&gt;<i> logged in; the second one provides full usage of the bandwidth for my
</I>&gt;<i> local network to access those pages; the third delay provides up to 50KB
</I>&gt;<i> for the ALL the websites, with exception of those defined in the delay
</I>&gt;<i> 2. Is this correct?
</I>
No. The 'restore' is the averaged N/sec byte amount. The smallest of the
parameters for each pool will be the limiting factor.


A transaction that gets assigned to pool #3 will be able to download at
most (ever) 8000 bytes in one second (due to the 8000/8000 bucket). The
other buckets are all larger, so they will refill faster than they are
allowed to drain.
 ** Also the 8000 bucket is the per-network bucket. So you have 8000
bytes/sec being shared by each /24 subnet of clients.


A transaction that gets assigned to pool #1 will be able to download at
most (ever) 8000 bytes in one second (due to the 8000/8000 bucket).
However, the other pools refill at slower rates so it gets more complex...

Assuming that pool #1 is completely full to begin with, and only 1
transaction happens:
 For the 1st second of transfer that maximum 8000 B/sec will happen.
 For the 2nd second of transfer the bandwidth will drop to 3000 B/sec
(there will now only be 3000 bytes in the per-user bucket).
 For the 3rd second of transfer the bandwidth will drop to 1000 B/sec
(the refill rate of the per-user bucket).
 Then 135 seconds later if the transaction is still going the 64000
bucket will be drained and start limiting the transfer to 600 B/sec (the
refill rate of the per-network bucket).

If anything else is going on these buckets may drain faster than
mentioned above as they may (or not) get shared by parallel transaction
and clients.
 If the proxy gets loaded you will increasingly not see the initial
'high' speeds, just the 1000 B/sec or 600 B/sec rates being applied most
of the time.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012545.html">[squid-users] Delay pools for authentcated users
</A></li>
	<LI>Next message (by thread): <A HREF="012547.html">[squid-users] SQUID 3.4.8 on RPi 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12550">[ date ]</a>
              <a href="thread.html#12550">[ thread ]</a>
              <a href="subject.html#12550">[ subject ]</a>
              <a href="author.html#12550">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
