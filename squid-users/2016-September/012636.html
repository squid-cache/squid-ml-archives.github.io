<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Question about the url rewrite before proxy out
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Question%20about%20the%20url%20rewrite%20before%20proxy%20out&In-Reply-To=%3C003401d2148e%24ddabc8a0%24990359e0%24%40filter.luko.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012635.html">
   <LINK REL="Next"  HREF="012639.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Question about the url rewrite before proxy out</H1>
    <B>squid-users at filter.luko.org</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Question%20about%20the%20url%20rewrite%20before%20proxy%20out&In-Reply-To=%3C003401d2148e%24ddabc8a0%24990359e0%24%40filter.luko.org%3E"
       TITLE="[squid-users] Question about the url rewrite before proxy out">squid-users at filter.luko.org
       </A><BR>
    <I>Thu Sep 22 05:04:58 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012635.html">[squid-users] Question about the url rewrite before proxy out
</A></li>
        <LI>Next message (by thread): <A HREF="012639.html">[squid-users] Question about the url rewrite before proxy out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12636">[ date ]</a>
              <a href="thread.html#12636">[ thread ]</a>
              <a href="subject.html#12636">[ subject ]</a>
              <a href="author.html#12636">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> i am looking for a proxy which can &quot;bounce&quot; the request, which is not a classic proxy.
</I>&gt;<i>
</I>&gt;<i> I want it works in this way.
</I>&gt;<i> 
</I>&gt;<i> e.g. a proxy is running a 192.168.1.1 
</I>&gt;<i> and when i want to open <A HREF="http://www.yahoo.com,">http://www.yahoo.com,</A> i just need call <A HREF="http://192.168.1.1/www.yahoo.com">http://192.168.1.1/www.yahoo.com</A>
</I>&gt;<i> the proxy can pickup the the host &quot;<A HREF="http://www.yahoo.com">http://www.yahoo.com</A>&quot; from the URI, and retrieve the info for me&#8203;, 
</I>&gt;<i> so it need to get the new $host from $location, and remove the $host from the $location before proxy pass it.
</I>&gt;<i> it is doable via squid?
</I>
Yes it is doable (but unusual).  First you need to tell Squid which requests should be rewritten, then send them to a rewrite program to be transformed.  Identify the domains like this:

acl rewrite-domains dstdomain .yahoo.com .google.com etc)

Then set up a URL rewriting program, and only allow it to process requests matching the rewrite-domains ACL, like this:

url_rewrite_program /tmp/rewrite-program.pl
url_rewrite_extras &quot;%&gt;ru&quot;
url_rewrite_access allow rewrite-domains
url_rewrite_access deny all

The program itself can be anything.  A very simple example in Perl might look like this:

#!/usr/bin/perl
use strict;
$| = 1;

# Enter loop
while (my $thisline = &lt;&gt;) {
	my @parts = split(/\s+/, $thisline);
	my $url = $parts[0];
	$url =~ s/http:\/\/(.*)/http:\/\/192.168.1.1\/$1/g;
	print &quot;OK rewrite-url=\&quot;$url\&quot;\n&quot;;
}

If you input <A HREF="http://www.yahoo.com/page.html,">http://www.yahoo.com/page.html,</A> this will be transformed to <A HREF="http://192.168.1.1/www.google.com/page.html.">http://192.168.1.1/www.google.com/page.html.</A>  The helper just needs to print that out prepended by &quot;OK rewrite-url=xxx&quot;.  More info at <A HREF="http://www.squid-cache.org/Doc/config/url_rewrite_program/">http://www.squid-cache.org/Doc/config/url_rewrite_program/</A>

Of course, you will need something listening on 192.168.1.1 (Apache, nginx, whatever) that can deal with those rewritten requests.  That is an unusual way of getting requests to 192.168.1.1 though, because you are effectively putting the hostname component into the URL then sending it to a web service and expecting it to deal with that.

Another note.  If you have a cache_peer defined, you might need some config to force rewritten requests to be sent to 192.168.1.1 and not your cache peer.  In that case this should do the trick:

acl rewrite-host dst 192.168.1.1
always_direct allow rewrite-host

HtH.

Luke



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012635.html">[squid-users] Question about the url rewrite before proxy out
</A></li>
	<LI>Next message (by thread): <A HREF="012639.html">[squid-users] Question about the url rewrite before proxy out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12636">[ date ]</a>
              <a href="thread.html#12636">[ thread ]</a>
              <a href="subject.html#12636">[ subject ]</a>
              <a href="author.html#12636">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
