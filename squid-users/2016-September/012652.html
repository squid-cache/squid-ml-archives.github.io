<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Errors in cache.log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Errors%20in%20cache.log&In-Reply-To=%3C5756dcf2-f88b-1f15-9b43-dff112f17894%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012642.html">
   <LINK REL="Next"  HREF="012655.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Errors in cache.log</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Errors%20in%20cache.log&In-Reply-To=%3C5756dcf2-f88b-1f15-9b43-dff112f17894%40treenet.co.nz%3E"
       TITLE="[squid-users] Errors in cache.log">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 23 05:26:57 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012642.html">[squid-users] Errors in cache.log
</A></li>
        <LI>Next message (by thread): <A HREF="012655.html">[squid-users] Errors in cache.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12652">[ date ]</a>
              <a href="thread.html#12652">[ thread ]</a>
              <a href="subject.html#12652">[ subject ]</a>
              <a href="author.html#12652">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/09/2016 6:11 a.m., erdosain9 wrote:
&gt;<i> Hi.
</I>&gt;<i> Im having this message in cache.log
</I>&gt;<i> 
</I>&gt;<i>  Error negotiating SSL on FD 121: error:00000000:lib(0):func(0):reason(0)
</I>&gt;<i> (5/0/0)
</I>&gt;<i> 2016/09/22 14:20:36 kid1| BUG: Unexpected state while connecting to a
</I>&gt;<i> cache_peer or origin server
</I>&gt;<i> 2016/09/22 14:29:23 kid1| Error negotiating SSL connection on FD 33:
</I>&gt;<i> error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
</I>&gt;<i> 2016/09/22 14:29:24 kid1| Error negotiating SSL connection on FD 33:
</I>&gt;<i> error:14094418:SSL routines:SSL3_READ_BYTES:tlsv1 alert unknown ca (1/0)
</I>&gt;<i> 2016/09/22 14:32:02 kid1| WARNING: HTTP: Invalid Response: No object data
</I>&gt;<i> received for
</I>&gt;<i> <A HREF="https://r3---sn-q4f7sn7l.googlevideo.com/videoplayback?pl=21&amp;itag=242&amp;dur=3973.160&amp;source=youtube&amp;keepalive=yes&amp;expire=1474585097&amp;mime=video%2Fwebm&amp;signature=14F5607A717C8A9DD579A55C69F6CDF4C2308FC5.47CE0A2B9F54F2C8C4042FF7797A08708951C276&amp;clen=12532131&amp;gir=yes&amp;key=cms1&amp;ip=190.113.224.106&amp;ipbits=0&amp;id=o-ABdgV3GldzFU1c8jBp6s_27abh9g_9c3hA0dbUgDkgjM&amp;upn=4Xlvne-1RrE&amp;lmt=1449585312748326&amp;sparams=clen,dur,ei,expire,gir,id,initcwndbps,ip,ipbits,itag,keepalive,lmt,mime,mm,mn,ms,mv,nh,pl,requiressl,source,upn&amp;ei=qQ3kV7rtJNT0wQTR0I_oDg&amp;requiressl=yes&amp;cpn=jdZ-1Vthefy2q9Og&amp;alr=yes&amp;ratebypass=yes&amp;c=WEB&amp;cver=1.20160921&amp;redirect_counter=1&amp;req_id=ad722d06312b3cfc&amp;cms_redirect=yes&amp;mm=34&amp;mn=sn-q4f7sn7l&amp;ms=ltu&amp;mt=1474563648&amp;mv=m&amp;nh=IgpwcjAyLmV6ZTAxKgkxMjcuMC4wLjE&amp;range=8224151-8353222&amp;rn=840&amp;rbuf=585667">https://r3---sn-q4f7sn7l.googlevideo.com/videoplayback?pl=21&amp;itag=242&amp;dur=3973.160&amp;source=youtube&amp;keepalive=yes&amp;expire=1474585097&amp;mime=video%2Fwebm&amp;signature=14F5607A717C8A9DD579A55C69F6CDF4C2308FC5.47CE0A2B9F54F2C8C4042FF7797A08708951C276&amp;clen=12532131&amp;gir=yes&amp;key=cms1&amp;ip=190.113.224.106&amp;ipbits=0&amp;id=o-ABdgV3GldzFU1c8jBp6s_27abh9g_9c3hA0dbUgDkgjM&amp;upn=4Xlvne-1RrE&amp;lmt=1449585312748326&amp;sparams=clen,dur,ei,expire,gir,id,initcwndbps,ip,ipbits,itag,keepalive,lmt,mime,mm,mn,ms,mv,nh,pl,requiressl,source,upn&amp;ei=qQ3kV7rtJNT0wQTR0I_oDg&amp;requiressl=yes&amp;cpn=jdZ-1Vthefy2q9Og&amp;alr=yes&amp;ratebypass=yes&amp;c=WEB&amp;cver=1.20160921&amp;redirect_counter=1&amp;req_id=ad722d06312b3cfc&amp;cms_redirect=yes&amp;mm=34&amp;mn=sn-q4f7sn7l&amp;ms=ltu&amp;mt=1474563648&amp;mv=m&amp;nh=IgpwcjAyLmV6ZTAxKgkxMjcuMC4wLjE&amp;range=8224151-8353222&amp;rn=840&amp;rbuf=585667</A>
</I>&gt;<i> AKA
</I>&gt;<i> r3---sn-q4f7sn7l.googlevideo.com/videoplayback?pl=21&amp;itag=242&amp;dur=3973.160&amp;source=youtube&amp;keepalive=yes&amp;expire=1474585097&amp;mime=video%2Fwebm&amp;signature=14F5607A717C8A9DD579A55C69F6CDF4C2308FC5.47CE0A2B9F54F2C8C4042FF7797A08708951C276&amp;clen=12532131&amp;gir=yes&amp;key=cms1&amp;ip=190.113.224.106&amp;ipbits=0&amp;id=o-ABdgV3GldzFU1c8jBp6s_27abh9g_9c3hA0dbUgDkgjM&amp;upn=4Xlvne-1RrE&amp;lmt=1449585312748326&amp;sparams=clen,dur,ei,expire,gir,id,initcwndbps,ip,ipbits,itag,keepalive,lmt,mime,mm,mn,ms,mv,nh,pl,requiressl,source,upn&amp;ei=qQ3kV7rtJNT0wQTR0I_oDg&amp;requiressl=yes&amp;cpn=jdZ-1Vthefy2q9Og&amp;alr=yes&amp;ratebypass=yes&amp;c=WEB&amp;cver=1.20160921&amp;redirect_counter=1&amp;req_id=ad722d06312b3cfc&amp;cms_redirect=yes&amp;mm=34&amp;mn=sn-q4f7sn7l&amp;ms=ltu&amp;mt=1474563648&amp;mv=m&amp;nh=IgpwcjAyLmV6ZTAxKgkxMjcuMC4wLjE&amp;range=8224151-8353222&amp;rn=840&amp;rbuf=585667
</I>&gt;<i> Error negotiating SSL on FD 91: error:00000000:lib(0):func(0):reason(0)
</I>&gt;<i> (5/-1/104)
</I>&gt;<i> 
</I>
Firstly, it is not one message. It is 4 and one partial message.

They may be related log entries, or maybe not. It is hard to say when
they are occuring across ~12 minutes. A single TLS handshake should be
much faster than that, so I suspect they are a mix of at least three
different transactions worth of info.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Sometimes in webbrowser give something like bad CA
</I>&gt;<i> 
</I>&gt;<i> or this (IPV6??)
</I>&gt;<i> 
</I>
The below error is not necessarily IPv6 related. It shows an IPv6
address because you configured &quot;dns_v4_first on&quot;, so the _last_ thing to
be tried was that IPv6 address.

What it means is that *all* the IPv4 and IPv6 ways to contact the server
are not working.


&gt;<i> The following error was encountered while trying to retrieve the URL:
</I>&gt;<i> <A HREF="https://www.facebook.com/*">https://www.facebook.com/*</A>
</I>&gt;<i> 
</I>&gt;<i> Connection to 2a03:2880:f105:83:face:b00c:0:25de failed.
</I>&gt;<i> 
</I>&gt;<i> The system returned: (101) Network is unreachable
</I>&gt;<i> 
</I>&gt;<i> The remote host or network may be down. Please try the request again.
</I>&gt;<i> 
</I>&gt;<i> Your cache administrator is webmaster.
</I>&gt;<i> 
</I>&gt;<i> This is my config
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i> 
</I>
&lt;snip commented out ACL definitions&gt;

&gt;<i> 
</I>&gt;<i> ####GRUPOS DE IP
</I>&gt;<i> acl full src &quot;/etc/squid/ips/full.lst&quot;
</I>&gt;<i> acl limitado src &quot;/etc/squid/ips/limitado.lst&quot;
</I>&gt;<i> acl sistemas src &quot;/etc/squid/ips/sistemas.lst&quot;
</I>&gt;<i> acl adminis  src &quot;/etc/squid/ips/adminis.lst&quot;
</I>
&lt;snip commented out lines&gt;

&gt;<i> 
</I>&gt;<i> ####Bloquea Publicidad ( <A HREF="http://pgl.yoyo.org/adservers/">http://pgl.yoyo.org/adservers/</A> )
</I>&gt;<i> acl ads dstdom_regex &quot;/etc/squid/listas/ad_block.lst&quot;
</I>&gt;<i> http_access deny ads
</I>
&lt;snip commented out lines&gt;

&gt;<i> acl stream url_regex -i \.flv$
</I>&gt;<i> acl stream url_regex -i \.mp4$
</I>&gt;<i> acl stream url_regex -i watch?
</I>&gt;<i> acl stream url_regex -i youtube
</I>&gt;<i> acl stream url_regex -i facebook
</I>&gt;<i> acl stream url_regex -i fbcdn\.net\/v\/(.*\.mp4)\?
</I>&gt;<i> acl stream url_regex -i fbcdn\.net\/v\/(.*\.jpg)\? 
</I>&gt;<i> acl stream url_regex -i akamaihd\.net\/v\/(.*\.mp4)\?
</I>&gt;<i> acl stream url_regex -i akamaihd\.net\/v\/(.*\.jpg)\?
</I>&gt;<i> 
</I>&gt;<i> ##Dominios denegados
</I>&gt;<i> acl dominios_denegados dstdomain &quot;/etc/squid/listas/dominios_denegados.lst&quot;
</I>&gt;<i> 
</I>&gt;<i> ##Extensiones bloqueadas
</I>&gt;<i> acl multimedia urlpath_regex &quot;/etc/squid/listas/multimedia.lst&quot;
</I>&gt;<i> 
</I>&gt;<i> ##Extensiones peligrosas
</I>&gt;<i> acl peligrosos urlpath_regex &quot;/etc/squid/listas/peligrosos.lst&quot;
</I>&gt;<i> 
</I>&gt;<i> #Bypass squid
</I>&gt;<i> #acl bypass_dst_dom  dstdomain &quot;/etc/squid/listas/bypass_dst_domain.lst&quot;
</I>&gt;<i> 
</I>&gt;<i> ##Redes sociales
</I>&gt;<i> acl redes_sociales url_regex -i &#8220;/etc/squid/listas/redes_sociales.lst&#8221;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #Puertos
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 8443
</I>&gt;<i> acl SSL_ports port 8080
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 631		# httpCUPS
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 8443        # httpsalt
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl Safe_ports port 8080	# edesur y otros
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> #http_access allow adminsquid manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>
&lt;snip commented out lines in the below rules&gt;

&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow limitado !dominios_denegados !multimedia !peligrosos
</I>&gt;<i> http_access allow full !peligrosos
</I>&gt;<i> http_access allow adminis !multimedia
</I>&gt;<i> http_access allow sistemas
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
&gt;<i> http_port 192.168.1.97:3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=5MB cert=/etc/squid/ssl_cert/myca.pem
</I>&gt;<i> key=/etc/squid/ssl_cert/myca.pem 
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cafile /etc/pki/tls/certs/ca-bundle.crt
</I>&gt;<i> 
</I>
&lt;snip commented out lines&gt;

&gt;<i> 
</I>&gt;<i> ############################################################
</I>&gt;<i> acl excluidosSSL dstdomain &quot;/etc/squid/listas/excluidosSSL.lst&quot;
</I>&gt;<i> ssl_bump none excluidosSSL
</I>&gt;<i> 
</I>&gt;<i> # SSL Bump Config
</I>&gt;<i> ssl_bump stare all  
</I>&gt;<i> ssl_bump bump all 
</I>
The &quot;none&quot; action from Squid-3.1 bumping design is not compatible with
&quot;stare&quot; and &quot;bump&quot; actions from Squid-3.4+ bumping design.

I believe this incorrect mix of bumping actions is probably the cause of
some of the TLS errors you are encountering.

Use &quot;splice excluidosSSL&quot; instead. To get the splice to work you may
need to peek at bumping step #1 instead of stare'ing.

&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
Very bad options. When combined they destroy all security bnefits TLS is
supposed to provide.

Remove those lines, then fix any specific issues that occur afterwards
via a more correct fix.


&gt;<i> #
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 5MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> 
</I>&gt;<i> #OJO ESTO!
</I>&gt;<i> always_direct allow all
</I>
Above rule has no effect. You do not have any cache_peer configured.


&gt;<i> 
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> cache_dir aufs /var/spool/squid 1000 16 256
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>
Notice what the above line says. It is important ...

&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> #obliga el cache de imagenes .jgp
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i \.jpg$ 30 0% 30 ignore-no-cache ignore-no-store
</I>&gt;<i> ignore-private
</I>
... this refresh_pattern is never reached nor used, because it does not
go above the default patterns.


&lt;snip comments&gt;
&gt;<i> 
</I>&gt;<i> ###ACTIVAR EN CASO DE &quot;Connection reset by peer&quot; EN MUCHOS HOST
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> ###
</I>&gt;<i> 
</I>&gt;<i> #Pools para ancho de Banda
</I>&gt;<i> delay_pools 6
</I>&gt;<i> 
</I>&gt;<i> ###VELOCIDAD PARA REDES SOCIALES
</I>&gt;<i> delay_class 1 1
</I>&gt;<i> delay_parameters 1 10000/100000
</I>&gt;<i> delay_access 1 allow redes_sociales limitado
</I>&gt;<i> delay_access 1 allow redes_sociales full
</I>&gt;<i> delay_access 1 allow redes_sociales adminis
</I>&gt;<i> delay_access 1 deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #Limitar Video Streaming a 20k
</I>&gt;<i> delay_class 2 1
</I>&gt;<i> delay_parameters 2 40000/100000
</I>&gt;<i> delay_access 2 allow stream adminis
</I>&gt;<i> delay_access 2 allow stream full
</I>&gt;<i> delay_access 2 allow stream limitado
</I>&gt;<i> delay_access 2 deny all
</I>&gt;<i> 
</I>&gt;<i> #Limitar Video Streaming a 500k
</I>&gt;<i> delay_class 3 1
</I>&gt;<i> delay_parameters 3 500000/500000
</I>&gt;<i> delay_access 3 allow stream sistemas
</I>&gt;<i> delay_access 3 deny all
</I>&gt;<i> 
</I>&gt;<i> #Ancho de Banda Administracion
</I>&gt;<i> delay_class 4 1
</I>&gt;<i> delay_parameters 4 256000/256000
</I>&gt;<i> delay_access 4 allow adminis
</I>&gt;<i> delay_access 4 deny all
</I>&gt;<i> 
</I>
Note: requests which match the &quot;redes_sociales adminis&quot; ACLs have BOTH
pool #1 and pool #4 restrictions applied to them.

Note: requests which match the &quot;stream adminis&quot; ACLs have BOTH pool #2
and pool #4 restrictions applied to them.

&gt;<i> 
</I>&gt;<i> #Ancho de Banda Sistemas
</I>&gt;<i> delay_class 5 2
</I>&gt;<i> delay_parameters 5 512000/512000 64000/256000
</I>&gt;<i> delay_access 5 allow sistemas
</I>&gt;<i> delay_access 5 deny all
</I>&gt;<i> 
</I>
Note: requests which match the &quot;redes_sociales sistemas&quot; ACLs have BOTH
pool #1 and pool #5 restrictions applied to them.

Note: requests which match the &quot;stream sistemas&quot; ACLs have BOTH pool #3
and pool #5 restrictions applied to them.

&gt;<i> #Ancho de Banda Logistica
</I>&gt;<i> delay_class 6 2
</I>&gt;<i> delay_parameters 6 256000/256000 30000/125000
</I>&gt;<i> delay_access 6 allow limitado
</I>&gt;<i> delay_access 6 deny all
</I>&gt;<i> 
</I>
Note: requests which match the &quot;redes_sociales limitado&quot; ACLs have BOTH
pool #1 and pool #6 restrictions applied to them.

Note: requests which match the &quot;stream limitado&quot; ACLs have BOTH pool #2
and pool #6 restrictions applied to them.


&gt;<i> ###ACTIVAR EN CASO DE &quot;Connection reset by peer&quot; EN MUCHOS HOST
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>
These details are duplicated above the deal pool stuff. Remove the
duplication.


&gt;<i> visible_hostname squid
</I>
This needs to be a FQDN. That will reduce the number of problems you
have with the Via header being sent out.


&gt;<i> 
</I>&gt;<i> # try connecting to first 25 ips of a domain name
</I>&gt;<i> forward_max_tries 25
</I>&gt;<i> 
</I>&gt;<i> # fix some ipv6 errors (recommended to comment out)
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> 
</I>
FYI: This does not fix any IPv6 errors. It hides IPv6 problems by making
Squid first try IPv4 when contacting servers unless their IPv4 is broken
or unavailable.

One should never consider it a &quot;fix&quot;. At best it is a temporary
workaround that will cease working as the Internet migrates to IPv6-only
(which has already begun in some parts of the world).

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012642.html">[squid-users] Errors in cache.log
</A></li>
	<LI>Next message (by thread): <A HREF="012655.html">[squid-users] Errors in cache.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12652">[ date ]</a>
              <a href="thread.html#12652">[ thread ]</a>
              <a href="subject.html#12652">[ subject ]</a>
              <a href="author.html#12652">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
