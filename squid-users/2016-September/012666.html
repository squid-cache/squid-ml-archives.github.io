<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid binding outgoing ip with a username auth
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20binding%20outgoing%20ip%20with%20a%20username%20auth&In-Reply-To=%3Cedd4ef36-b783-3afc-6c29-7781479ac796%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012665.html">
   <LINK REL="Next"  HREF="012676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid binding outgoing ip with a username auth</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20binding%20outgoing%20ip%20with%20a%20username%20auth&In-Reply-To=%3Cedd4ef36-b783-3afc-6c29-7781479ac796%40treenet.co.nz%3E"
       TITLE="[squid-users] squid binding outgoing ip with a username auth">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Sep 24 21:58:05 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012665.html">[squid-users] squid binding outgoing ip with a username auth
</A></li>
        <LI>Next message (by thread): <A HREF="012676.html">[squid-users] squid binding outgoing ip with a username auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12666">[ date ]</a>
              <a href="thread.html#12666">[ thread ]</a>
              <a href="subject.html#12666">[ subject ]</a>
              <a href="author.html#12666">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/09/2016 6:13 p.m., --Ahmad-- wrote:
&gt;<i> hi folks .
</I>&gt;<i> 
</I>&gt;<i> i have many ips on same server .
</I>&gt;<i> also i  have  basic_ncsa auth type on squid .
</I>&gt;<i> 
</I>&gt;<i> say i have 3 ips  and i created 3 users .
</I>&gt;<i> 
</I>&gt;<i> the issue i have now is any user can use any outgoing address .
</I>&gt;<i> 
</I>&gt;<i> let me explain below :
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /lib/squid/basic_ncsa_auth /etc/squid/squid_user
</I>&gt;<i> acl ncsa_users proxy_auth REQUIRED
</I>&gt;<i> auth_param basic children 100
</I>&gt;<i> http_access allow ncsa_users
</I>&gt;<i> 
</I>&gt;<i> ###############
</I>&gt;<i> http_port 100.160.238.0:17648
</I>&gt;<i> http_port 100.160.238.1:48049
</I>&gt;<i> http_port 100.160.238.2:26394
</I>&gt;<i> 
</I>&gt;<i> #############
</I>&gt;<i> acl  ip1myip 100.160.238.0
</I>&gt;<i> acl  ip2 myip 100.160.238.1
</I>&gt;<i> acl  ip3 myip 100.160.238.2
</I>&gt;<i> #############
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 100.160.238.0 ip1
</I>&gt;<i> tcp_outgoing_address 100.160.238.1 ip2
</I>&gt;<i> tcp_outgoing_address 100.160.238.2 ip3
</I>&gt;<i> 
</I>
'myip' matches the Squid IP address.
tcp_outgoing_address is what sets the Squid IP address.
See any problem with using the Squid IP address current value to set the
Squid IP address?

Use the myportname ACL instead. In your above config it will match the
IP:port string on the htp_port line. For example:

  acl ip0 myportname 100.160.238.0:17648
  tcp_outgoing_address 100.160.238.0 ip0

Or you can add a name= parameter to each port to set a custom name for
it that the myportname ACL looks for.


&gt;<i> ########################
</I>&gt;<i> 
</I>&gt;<i> i created 3 users :
</I>&gt;<i> 
</I>&gt;<i> htpasswd -cdb   /etc/squid/squid_user user1 user1
</I>&gt;<i> htpasswd -cdb   /etc/squid/squid_user user2 user2
</I>&gt;<i> htpasswd -cdb   /etc/squid/squid_user user3 user3
</I>&gt;<i> 
</I>&gt;<i> #################
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> now if user1 connected to 100.160.238.0:17648 it will be able to use it 
</I>&gt;<i> also if connected to   100.160.238.1:48049 also will be able .
</I>&gt;<i> 
</I>&gt;<i>  and so for 100.160.238.2:26394.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> the question is
</I>&gt;<i>  how can i let user1 only use  100.160.238.0:17648  and user2 only use  100.160.238.1:48049  and user3 only use  100.160.238.2:26394 ???
</I>&gt;<i> 
</I>
Use the ext_file_userip_acl helper. The format for entries in the helper
config file is listed in the man page:
&lt;<A HREF="http://www.squid-cache.org/Versions/v3/3.5/manuals/ext_file_userip_acl.html">http://www.squid-cache.org/Versions/v3/3.5/manuals/ext_file_userip_acl.html</A>&gt;

Replace the line &quot;http_access allow ncsa_users&quot; with the following:

 external_acl_type userIp %SRC /usr/bin/ext_file_userip_acl -f
/etc/squid/userIP.conf
 acl userIp external userIp

 http_access deny !ncsa_users
 http_access allow userIp

NP: that is all. Do not add userIp check to tcp_outgoing_address lines.


After all the above changes your squid.conf should look something like this:

 ## ... the default http_access rules at the top ...
 ##
 ## Your local custom rules go here:

 auth_param basic program /lib/squid/basic_ncsa_auth \
    /etc/squid/squid_user
 auth_param basic children 100

 external_acl_type userIp %SRC %LOGIN /lib/squid/ext_file_userip_acl \
    -f /etc/squid/userIP.conf

 acl ncsa_users proxy_auth REQUIRED
 acl userIp external userIp

 http_access deny !ncsa_users
 http_access allow userIp
 http_access deny all

 ##
 http_port 100.160.238.0:17648 name=0
 acl ip0 myportname 0
 tcp_outgoing_address 100.160.238.0 ip0

 http_port 100.160.238.1:48049 name=1
 acl ip1 myportname 1
 tcp_outgoing_address 100.160.238.1 ip1

 http_port 100.160.238.2:26394 name=2
 acl ip2 myportname 2
 tcp_outgoing_address 100.160.238.2 ip2


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012665.html">[squid-users] squid binding outgoing ip with a username auth
</A></li>
	<LI>Next message (by thread): <A HREF="012676.html">[squid-users] squid binding outgoing ip with a username auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12666">[ date ]</a>
              <a href="thread.html#12666">[ thread ]</a>
              <a href="subject.html#12666">[ subject ]</a>
              <a href="author.html#12666">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
