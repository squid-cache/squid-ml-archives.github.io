<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Accelerator Mode - HSTS and Redirect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Accelerator%20Mode%20-%20HSTS%20and%20Redirect&In-Reply-To=%3C64f6b9e8-4b55-8e85-63b9-231e3c45fcf5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012663.html">
   <LINK REL="Next"  HREF="012654.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Accelerator Mode - HSTS and Redirect</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Accelerator%20Mode%20-%20HSTS%20and%20Redirect&In-Reply-To=%3C64f6b9e8-4b55-8e85-63b9-231e3c45fcf5%40treenet.co.nz%3E"
       TITLE="[squid-users] Accelerator Mode - HSTS and Redirect">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Sep 24 23:40:19 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012663.html">[squid-users] Accelerator Mode - HSTS and Redirect
</A></li>
        <LI>Next message (by thread): <A HREF="012654.html">[squid-users] squid with apple updates caching problem !
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12669">[ date ]</a>
              <a href="thread.html#12669">[ thread ]</a>
              <a href="subject.html#12669">[ subject ]</a>
              <a href="author.html#12669">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/09/2016 10:25 a.m., squid wrote:
&gt;<i> Thank you.  Just want to make sure I understand before we dive in.
</I>&gt;<i> 
</I>&gt;<i> On Thu, Sep 22, 2016, at 09:03 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 23/09/2016 12:45 p.m., creditu wrote:
</I>&gt;&gt;&gt;<i> We have been using squid in accelerator mode for a number of years. In
</I>&gt;&gt;&gt;<i> the current setup we have the squid frontends that send all the http
</I>&gt;&gt;&gt;<i> requests to the backend apache webservers using a simple redirect
</I>&gt;&gt;&gt;<i> script.  We need to switch to https for the public presence.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> redirect/rewrite script is very rarely a suitable way to do this for
</I>&gt;&gt;<i> reverse-proxy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Use cache_peer to configure what backend servers exist and
</I>&gt;&gt;<i> cache_peer_access rules to determine which one(s) any given request can
</I>&gt;&gt;<i> be sent to.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The backends should be capable of accepting the traffic as if the proxy
</I>&gt;&gt;<i> were not there. If for some reason it has to have a different domain
</I>&gt;&gt;<i> name (actual need for this is rare), then the cache_peer forcedomain=
</I>&gt;&gt;<i> option can be used.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So, our initial thought would be to use https_port for public HTTPS
</I>&gt;&gt;&gt;<i> presence and send the requests using cache_peer to the backend apache
</I>&gt;&gt;&gt;<i> servers using plain http.  Basically terminating HTTPS from clients and
</I>&gt;&gt;&gt;<i> relaying it to backend servers using HTTP.  
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We will need to implement HSTS at some point (i.e.
</I>&gt;&gt;&gt;<i> Strict-Transport-Security: max-age=8888; includeSubDomains; preload),
</I>&gt;&gt;&gt;<i> will we be able to do this in the above scenario.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes. Provided you can get rid of that redirect/rewrite script. The
</I>&gt;&gt;<i> background things cache_peer logic does to the traffic will be needed
</I>&gt;&gt;<i> for the HTTPS transition.
</I>&gt;<i> 
</I>&gt;<i> We will get rid of the script, but, not sure I understand the rest of
</I>&gt;<i> the statement.  Can you elaborate?
</I>
By &quot;background things&quot; I mean the code inside Squid. reverse-proxy logic
does things to the request and reply when sending to a peer that are not
done on DIRECT requests to servers.

&gt;<i> Since  HSTS is only set when there
</I>&gt;<i> is a secure connection it seems that I would have send to the backend
</I>&gt;<i> via https and set the Strict-Transport . . . header on the backend
</I>&gt;<i> Apache servers (ssl.conf) so the reply would be sent back to the
</I>&gt;<i> Internet user via Squid?
</I>
No. The reply is sent back along the same TCP connection the request was
received over. Always.

For a reverse-proxy it does not matter if that connection happens to be
TLS encrypted or not.

If the cache_peer line in squid.conf says to use port 80 that will be
the server port used. Likewise it could say port 443 and use TLS to get
there. The server connection is completely independent from the client
connections.

HSTS simply tells clients to not bother using <A HREF="http://">http://</A> to contact the
domain. Always to try <A HREF="https://">https://</A> first. A properly setup reverse-proxy
does not care about HSTS. It will simply listen on the port it is
configured to listen on and send to the server it is configured to send to.



&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Also, we will initially be providing both http and https, but will need
</I>&gt;&gt;&gt;<i> to stop http at some point.  Is there a way to redirect the clients that
</I>&gt;&gt;&gt;<i> try to connect via http to use https with squid?  Something like the
</I>&gt;&gt;&gt;<i> rewrite engine in apache?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer can be configured to contact the peer over TLS. This can be
</I>&gt;&gt;<i> done individually, and before the HSTS gets added for public viewing.
</I>&gt;<i> 
</I>&gt;<i> I'm sure I'm missing something here.  What I will need to do is force
</I>&gt;<i> Internet users who come to us over via http to use https instead. 
</I>&gt;<i> Something like what happens when someone types <A HREF="http://www.google.com">http://www.google.com</A>
</I>&gt;<i> they get sent to <A HREF="https://www.google.com.">https://www.google.com.</A> This is pretty simple going
</I>&gt;<i> straight to an Apache server, but I haven't seen a way to do it directly
</I>&gt;<i> with Squid.  In a very quick test on some non-production systems I sent
</I>&gt;<i> a http request through the squid and did the redirect on the backend
</I>&gt;<i> Apache server.  I assume in the Apache config I would do something like
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i> VirtualHost *:80&gt;
</I>&gt;<i>    ServerName www.example.com
</I>&gt;<i>    Redirect permanent / <A HREF="https://SquidPublicIP/">https://SquidPublicIP/</A>
</I>&gt;<i> &lt;/VirtualHost&gt;
</I>&gt;<i> 
</I>&gt;<i>  Just trying to understand how this would work.  Thanks Again. 
</I>
Squid would listen on port 80 and 'deny' any traffic arriving in that
port with a 30x redirect pointing at the relevant <A HREF="https://">https://</A> URL.

 http_port 80 accel
 acl HTTP proto HTTP
 deny_info 301:<A HREF="https://%H%R">https://%H%R</A> HTTP
 http_access deny HTTP

Zero involvement from the server.

The current releases of Squid should be able to also add a static STS
header to the denial reply if you want to use HSTS.

But that is all for later. First get the proxy connected to the server
working with the traffic (HTTP-only?) that your site receives _right now_.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012663.html">[squid-users] Accelerator Mode - HSTS and Redirect
</A></li>
	<LI>Next message (by thread): <A HREF="012654.html">[squid-users] squid with apple updates caching problem !
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12669">[ date ]</a>
              <a href="thread.html#12669">[ thread ]</a>
              <a href="subject.html#12669">[ subject ]</a>
              <a href="author.html#12669">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
