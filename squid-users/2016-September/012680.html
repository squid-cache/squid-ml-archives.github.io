<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.21 - High CPU (100%)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.21%20-%20High%20CPU%20%28100%25%29&In-Reply-To=%3C1474873185.9155.24.camel%40shoprite.co.za%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012622.html">
   <LINK REL="Next"  HREF="012685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.21 - High CPU (100%)</H1>
    <B>Jasper Van Der Westhuizen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.21%20-%20High%20CPU%20%28100%25%29&In-Reply-To=%3C1474873185.9155.24.camel%40shoprite.co.za%3E"
       TITLE="[squid-users] Squid 3.5.21 - High CPU (100%)">jvdwesthuiz at shoprite.co.za
       </A><BR>
    <I>Mon Sep 26 06:59:45 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012622.html">[squid-users] Squid 3.5.21 - High CPU (100%)
</A></li>
        <LI>Next message (by thread): <A HREF="012685.html">[squid-users] Squid 3.5.21 - High CPU (100%)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12680">[ date ]</a>
              <a href="thread.html#12680">[ thread ]</a>
              <a href="subject.html#12680">[ subject ]</a>
              <a href="author.html#12680">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On Wed, 2016-09-21 at 08:34 -0600, Alex Rousskov wrote:

On 09/21/2016 07:53 AM, Jasper Van Der Westhuizen wrote:


I have been having some problems with Squid using
100% CPU at times which impacts my users browsing experience.



Sustained 100% CPU load at ~100/s rates with regular traffic on
reasonable hardware is a sign (albeit not a proof!) of a Squid bug
(including long searches and similar optimization problems).


I seem to have gotten better results/performance by doing some config changed. I removed a whole bunch of pattern_refresh lines and replaced them with better formulated lines.








During the last time I had a proxy servers CPU reach 100% I ran a
cachemgr export and below is an extract.



Next time this happens, consider getting a stack trace or two from the
process showing sustained 100% CPU utilization. It is possible to do
that without killing the processes (at least on Linux). I do not have
step-by-step instructions, but you can find them. Make sure you run (or
at least use for getting the stack trace?) an unstripped Squid binary,
preferably built with --disable-optimizations.

If the place where Squid gets stuck is known, somebody may volunteer to
fix the corresponding code.



I do not have much experience with strace. What I found now after making changes to my squid.conf file, my cache drive gets *hammered* at times of high usage. Especially in the morning when all the users come online. I have huge amounts of writes happening and this creates CPU wait and the user experience goes out of the window. My proxies are VM's with separate drives for the cache, running on reiserfs(previously EXT3). My L1 and L2 directory structure is 32 and 256 respectively with the aufs store type. In my VMWare cluster I see high write latency to the cache disks.

Is there anything that you guys can suggest I do around the cache? Should I try a different store type? A different filesystem type perhaps?

Kind Regards
Jasper




Disclaimer:
<A HREF="http://www.shopriteholdings.co.za/Pages/ShopriteE-mailDisclaimer.aspx">http://www.shopriteholdings.co.za/Pages/ShopriteE-mailDisclaimer.aspx</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20160926/b27b64ee/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20160926/b27b64ee/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012622.html">[squid-users] Squid 3.5.21 - High CPU (100%)
</A></li>
	<LI>Next message (by thread): <A HREF="012685.html">[squid-users] Squid 3.5.21 - High CPU (100%)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12680">[ date ]</a>
              <a href="thread.html#12680">[ thread ]</a>
              <a href="subject.html#12680">[ subject ]</a>
              <a href="author.html#12680">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
