<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] connections from particular users sometimes get stuck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%20stuck&In-Reply-To=%3C42b972b9-77a7-f43d-1630-fe31a71ab508%40norma.perm.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012717.html">
   <LINK REL="Next"  HREF="012720.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] connections from particular users sometimes get stuck</H1>
    <B>Eugene M. Zheganin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%20stuck&In-Reply-To=%3C42b972b9-77a7-f43d-1630-fe31a71ab508%40norma.perm.ru%3E"
       TITLE="[squid-users] connections from particular users sometimes get stuck">emz at norma.perm.ru
       </A><BR>
    <I>Tue Sep 27 17:13:17 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012717.html">[squid-users] R: Re: problem reload configuration with workers
</A></li>
        <LI>Next message (by thread): <A HREF="012720.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12719">[ date ]</a>
              <a href="thread.html#12719">[ thread ]</a>
              <a href="subject.html#12719">[ subject ]</a>
              <a href="author.html#12719">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

I have a weird problem. I run a squid cache 3.5.19 on FreeBSD/amd64, 
with about 300 active users, lots of authentication, external helpers 
(yeah, it's usually the place when one starts to post configs, but let 
me get to the point), and everything basically works just fine, but 
sometimes one particular user (don't know, may be it's one particular 
machine or some other entity) starts to have troubles. Usual trouble 
looks like the following:

- around 299 users are working and authenticatiing just fine

- one particular user starts experiencing connection stucking: his 
browser requests a web page, it starts to load and then some random 
object on it blocks indefinitely.

- this happens every time on one machine, for the time given. This 
machine is permanent for a given issue, until it's gone. Then it's some 
another machine, and I cannot figure out the pattern.

- this machine may be locked in this malfuctioning state for days. This 
state is usually cleared by the squid restart, or it may clear itself.

- after a month or so the issue appears on another machine. and it 
persists on a new machine for quite some time.

On a l3 level this looks simple: browser requests an object, gets 407 
answer, replies with proper credentials set and then this connection 
goes indefinitely into a keepalived state: the squid and the browser 
send keepalives to each other, but nothing happens other than 
keepalives. User sees the spinning loader on a browser tab, and some 
content inside the tab, depending on how many objects the browses has 
received. In the same time new connections to squid are opening from 
this machine just fine, and the basic connectivity is normal for both 
the squid and the troubled machine. Furthermore, I'm sure that this 
problem isn't caused by bottlenecks on the squid machine: because it 
this way all the users would have eventually this problem, not only one. 
In the same time these aren't bottlenecks on the user machine: while the 
browser is stuck, other applications are working fine. If I switch the 
proxy to a backup squid (on another server) this machine is able to 
browse the internet.

I really need to solve this, but I have no idea where to start. The 
error log show nothing suspicious.

The wireshark screen where the issue is isolated for one particular 
connection can be found here - 
<A HREF="https://gyazo.com/fdec1d9d7c31a75afc7d4676abb83d15">https://gyazo.com/fdec1d9d7c31a75afc7d4676abb83d15</A> (it's really a simple 
picture: TCP connection establishing, then GET -&gt; 407 -&gt; GET and bunch 
of keepalives, not a rocket science).

Any ideas ?

Thanks.

Eugene.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012717.html">[squid-users] R: Re: problem reload configuration with workers
</A></li>
	<LI>Next message (by thread): <A HREF="012720.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12719">[ date ]</a>
              <a href="thread.html#12719">[ thread ]</a>
              <a href="subject.html#12719">[ subject ]</a>
              <a href="author.html#12719">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
