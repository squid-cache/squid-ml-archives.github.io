<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20tproxy%20ssl-bump%20and%20Protocol%20error%20%28TLS%20code%3A%0A%20SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C414102480.6739156.1475150556309%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012804.html">
   <LINK REL="Next"  HREF="012762.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)</H1>
    <B>Vieri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20tproxy%20ssl-bump%20and%20Protocol%20error%20%28TLS%20code%3A%0A%20SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C414102480.6739156.1475150556309%40mail.yahoo.com%3E"
       TITLE="[squid-users] squid tproxy ssl-bump and Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)">rentorbuy at yahoo.com
       </A><BR>
    <I>Thu Sep 29 12:02:36 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012804.html">[squid-users] Large text ACL lists
</A></li>
        <LI>Next message (by thread): <A HREF="012762.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS	code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12753">[ date ]</a>
              <a href="thread.html#12753">[ thread ]</a>
              <a href="subject.html#12753">[ subject ]</a>
              <a href="author.html#12753">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm running a Squid proxy like so:

http_port 3129 tproxy
https_port 3130 tproxy ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=16MB cert=/etc/ssl/squid/proxyserver.pem

The squid server certificate was self-generated:
openssl req -new -newkey rsa:2048 -sha256 -days 7300 -nodes -x509 -keyout /etc/ssl/squid/proxyserver.pem -out /etc/ssl/squid/proxyserver.pem

I configured my firewall rules approriately and everything seems to work fine on systems such as Windows 7 32bits/64bits with IE11, IE8 or latest Firefox.
However, I'm having trouble with Windows XP Pro SP3 and IE8.
On this client OS, Firefox 45.0.1 works fine with HTTP and HTTPS sites. However, IE8 on this same client OS works fine accessing HTTP sites but not HTTPS.

When I try to access google.com I first get a certificate warning (untrusted cert). That's the first flaw because I shouldn't get this page since the proxy server's certificate is in the IE Trust Store (under root certificates).
Then if I try to connect to google.com despite the &quot;untrusted certificate&quot; warning, I get the exception:

71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
Handshake with SSL server failed: error:1409F07F:SSL routines:ssl3_write_pending:bad write retry

I noticed that this browser/OS only has TLS up to 1.0 (no 1.2 or 1.1).

I can reproduce the same Squid exception on a Windows 7 IE8 system if I disable TLS 1.2 and only use TLS 1.1 and/or lower.

Any ideas?

Regards,

Vieri

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012804.html">[squid-users] Large text ACL lists
</A></li>
	<LI>Next message (by thread): <A HREF="012762.html">[squid-users] FW: squid tproxy ssl-bump and Protocol error (TLS	code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12753">[ date ]</a>
              <a href="thread.html#12753">[ thread ]</a>
              <a href="subject.html#12753">[ subject ]</a>
              <a href="author.html#12753">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
