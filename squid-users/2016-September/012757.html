<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] connections from particular users sometimes get stuck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%0A%20stuck&In-Reply-To=%3C5ec198bf-ae59-1972-698b-591a575285bc%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012750.html">
   <LINK REL="Next"  HREF="012780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] connections from particular users sometimes get stuck</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%0A%20stuck&In-Reply-To=%3C5ec198bf-ae59-1972-698b-591a575285bc%40measurement-factory.com%3E"
       TITLE="[squid-users] connections from particular users sometimes get stuck">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 29 18:17:12 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012750.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
        <LI>Next message (by thread): <A HREF="012780.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12757">[ date ]</a>
              <a href="thread.html#12757">[ thread ]</a>
              <a href="subject.html#12757">[ subject ]</a>
              <a href="author.html#12757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/29/2016 02:58 AM, Eugene M. Zheganin wrote:
&gt;<i> This time turbodom.ru entries are present in the debug log
</I>
Yes, there are two complete HTTP transactions with that domain. One is a
407 Authentication Required and one is a 301 redirect:

&gt;<i> HTTP/1.1 301 Moved Permanently
</I>...
&gt;<i> Location: <A HREF="http://turbodom.ru/index.html/">http://turbodom.ru/index.html/</A>
</I>
I see no relevant problems with those two transactions.


&gt;<i> tcpdump capture taken from a client machine:
</I>&gt;<i> <A HREF="http://zhegan.in/files/squid/squid-stuck-client.pcap">http://zhegan.in/files/squid/squid-stuck-client.pcap</A>
</I>
This capture one is missing most of the second transaction packets
(tcp.stream eq 186). I do not know why tcpdump was unable to collect them.


&gt;<i> tcpdump capture taken from squid machine, on the interface the client
</I>&gt;<i> machine is connected via:
</I>&gt;<i> <A HREF="http://zhegan.in/files/squid/squid-stuck-server-to-client.pcap">http://zhegan.in/files/squid/squid-stuck-server-to-client.pcap</A>
</I>
This one has both HTTP transactions described above (tcp.stream eq 206).

It also contains a related and incomplete transaction that follows the
above redirect (tcp.stream eq 346). According to tcpdump, that
transaction starts around 13:31:26.

Squid cache log does not mention that third transaction (or that TCP
connection), probably because Squid could not accept it. There were a
few accept failures (ECONNABORTED) right around the time of that
third/missing transaction:

&gt;<i> 13:31:25.060 kid1| accept failure: (53) Software caused connection abort
</I>&gt;<i> 13:31:25.865 kid1| accept failure: (53) Software caused connection abort
</I>&gt;<i> 13:31:25.904 kid2| accept failure: (53) Software caused connection abort
</I>
The timestamps are a ~second off, but AFAICT, they are a ~second off for
successful accepts as well, so it is probably just a tcpdump logging
artifact.

In summary, your browser is probably stuck because Squid could not
accept a connection. Why did that accept call fail with ECONNABORTED? I
cannot say for sure -- the packet trace is rather dirty/misleading
(e.g., it shows the redirect packet being sent to the client _after_ the
client follows that redirect which does not make sense).

Any relevant errors in you system logs?

If you cancel browser wait and repeat the request, will it work? If this
was just a random accept failure, then it should work on the second try.
If it does not work again, then there is something more serious going on
(but you would need to collect more logs to study that).

The connection accepting code in Squid is in poor shape, but I do not
think those minor code problems affect this particular use case.

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012750.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
	<LI>Next message (by thread): <A HREF="012780.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12757">[ date ]</a>
              <a href="thread.html#12757">[ thread ]</a>
              <a href="subject.html#12757">[ subject ]</a>
              <a href="author.html#12757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
