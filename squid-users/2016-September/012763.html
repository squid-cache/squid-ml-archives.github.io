<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External nat'ed transparent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAP1vRcAAnWlNoU7f4f0YNhgBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADQt4cUeAlsQ6ihb0bN4K2wAQAAAAA%3D%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012755.html">
   <LINK REL="Next"  HREF="012774.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External nat'ed transparent proxy</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAP1vRcAAnWlNoU7f4f0YNhgBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADQt4cUeAlsQ6ihb0bN4K2wAQAAAAA%3D%40ngtech.co.il%3E"
       TITLE="[squid-users] External nat'ed transparent proxy">eliezer at ngtech.co.il
       </A><BR>
    <I>Thu Sep 29 22:35:20 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012755.html">[squid-users] External nat'ed transparent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="012774.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12763">[ date ]</a>
              <a href="thread.html#12763">[ thread ]</a>
              <a href="subject.html#12763">[ subject ]</a>
              <a href="author.html#12763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Henry,

I want to emulate the setup to understand the complication with a FULL linux based setup here on my local testing grounds.
Can you give more details on the networks in the form of subnets and VLAN numbers?
What is not clear to me is: Who is doing the DNAT?
Also, if you have not used tproxy and intercept on the PROXY machine you should re-think the whole logic of the system first before deciding on the next step.
There are systems which needs redesign when moving from Squid 2 to 3 or 4.
When I and you will have the right understanding of the scenario I believe we can find the right path if this is not already there.

Let me know if these( the diagrams..):
<A HREF="http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Intoduction_to_MultiWAN_LoadBalancing">http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Intoduction_to_MultiWAN_LoadBalancing</A>
<A HREF="http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2">http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2</A>

Make any sense to you so we can find the right words to fill the gaps in the situation.
Once I will have the right picture I would probably have enough information to draw some picture in VISIO and move forward to the Systems table.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile+WhatsApp: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Henry Paulissen
Sent: Thursday, September 29, 2016 5:40 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] External nat'ed transparent proxy

Hi all,

In the company I work for we are currently using squid v2 proxies in transparent mode to intercept traffic from servers to the outside (access control).

The technical solution for this is roughly as follows:
[server] -&gt; [gateway] -&gt; [firewall]
                              |
    ----------- DNAT ---------
   v
[squid]  -&gt; [gateway] -&gt; [firewall] -&gt; [internet router]

Our firewalls (who live between the vlan gateway and internet router), DNAT the traffic towards separate squid proxies (who are in a lvs cluster). These squid proxies are in their own vlan with special permissions to allow unrestricted port 80 outbound, etc, etc...

Because squid v2 is becoming more and more obsolete we are looking at upgrading it towards squid v3.

&gt;<i>From what I read in the manuals, transparent mode is replaced by intercept (and tproxy) mode. But both dont seem to be fully backward complaint with the v2 transparent mode.
</I>
The old trasparent mode allowed us to just dnat traffic towards the squid host without the need for the client to be aware of this. For example, the old style accepted 'GET / HTTP/1.1' (without full URL in the GET request and looking at the Host header for the destination).

The new intercept mode comes close to this behavior, but instead of remotly dnat, it wants us to next-hop it towards the squid proxy and redirect it locally. This is problematic for us as firewall and squid proxy dont live in the same vlan, so next-hop should be the router to that vlan (and forgetting about the path back to the server). Secondly, and not less blocking, we use vservers (predecessor to linux containers
lxc) as such, we dont have any promiscuous interfaces rights within the container.


Is there still a option to emulate normal 'regular&#180; style squid (as without any listen options) but instead accepting the URI path in the GET request and looking at the Host header for the destination? (lets call it passthrough mode?).

Or, is there in squid3 a new and better way to facilitate larger setups, with the knowledge the server, firewall and squids are all in different vlans (and no, we dont have Cisco firewalls in between them ;-)).


Thanks in advance,

--
Henry Paulissen - PD0OM
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">henry at nitronetworks.nl</A> - Phone: +31-(0)6-115.305.64 Linux/Unix System Engineer



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012755.html">[squid-users] External nat'ed transparent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="012774.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12763">[ date ]</a>
              <a href="thread.html#12763">[ thread ]</a>
              <a href="subject.html#12763">[ subject ]</a>
              <a href="author.html#12763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
