<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External nat'ed transparent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3Cdeafc1e1-ab42-2921-ce89-3fdeb2bdf772%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012763.html">
   <LINK REL="Next"  HREF="012786.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External nat'ed transparent proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3Cdeafc1e1-ab42-2921-ce89-3fdeb2bdf772%40treenet.co.nz%3E"
       TITLE="[squid-users] External nat'ed transparent proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 30 02:29:36 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012763.html">[squid-users] External nat'ed transparent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="012786.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12774">[ date ]</a>
              <a href="thread.html#12774">[ thread ]</a>
              <a href="subject.html#12774">[ subject ]</a>
              <a href="author.html#12774">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/09/2016 11:35 a.m., Eliezer Croitoru wrote:
&gt;<i> Hey Henry,
</I>&gt;<i> 
</I>&gt;<i> I want to emulate the setup to understand the complication with a FULL linux based setup here on my local testing grounds.
</I>
No need Eliezer. This is the basic NAT re-writing problem.

&gt;<i> Can you give more details on the networks in the form of subnets and VLAN numbers?
</I>&gt;<i> What is not clear to me is: Who is doing the DNAT?
</I>
The firewall *outside* the Squid machine.

&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Henry Paulissen
</I>&gt;<i> 
</I>&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> In the company I work for we are currently using squid v2 proxies in
</I>&gt;<i> transparent mode to intercept traffic from servers to the outside
</I>&gt;<i> (access control).
</I>&gt;<i>
</I>&gt;<i> The technical solution for this is roughly as follows:
</I>&gt;<i> [server] -&gt; [gateway] -&gt; [firewall]
</I>&gt;<i>                               |
</I>&gt;<i>     ----------- DNAT ---------
</I>&gt;<i>    v
</I>&gt;<i> [squid]  -&gt; [gateway] -&gt; [firewall] -&gt; [internet router]
</I>&gt;<i> 
</I>&gt;<i> Our firewalls (who live between the vlan gateway and internet
</I>&gt;<i> router), DNAT the traffic towards separate squid proxies (who are in
</I>&gt;<i> a lvs cluster). These squid proxies are in their own vlan with
</I>&gt;<i> special permissions to allow unrestricted port 80 outbound, etc,
</I>&gt;<i> etc...
</I>&gt;<i> 
</I>&gt;<i> Because squid v2 is becoming more and more obsolete we are looking
</I>&gt;<i> at upgrading it towards squid v3.
</I>&gt;<i> 
</I>&gt;<i> From what I read in the manuals, transparent mode is replaced by 
</I>&gt;<i> intercept (and tproxy) mode. But both dont seem to be fully backward 
</I>&gt;<i> complaint with the v2 transparent mode.
</I>&gt;<i> 
</I>&gt;<i> The old trasparent mode allowed us to just dnat traffic towards the 
</I>&gt;<i> squid host without the need for the client to be aware of this. For 
</I>&gt;<i> example, the old style accepted 'GET / HTTP/1.1' (without full URL
</I>&gt;<i> in the GET request and looking at the Host header for the
</I>&gt;<i> destination).
</I>
Sadly. That is incorrect.

Squid-2 used to simply lie to you, silently hiding any attacks that were
happening through the proxy. Whenever NAT on the Squid machine failed to
identify the packet destination it gave Squid false information for the
logs based on the client-supplied Host header DNS results.

&gt;<i> 
</I>&gt;<i> The new intercept mode comes close to this behavior, but instead of 
</I>&gt;<i> remotly dnat, it wants us to next-hop it towards the squid proxy and 
</I>&gt;<i> redirect it locally. This is problematic for us as firewall and
</I>&gt;<i> squid proxy dont live in the same vlan, so next-hop should be the
</I>&gt;<i> router to that vlan (and forgetting about the path back to the
</I>&gt;<i> server). Secondly, and not less blocking, we use vservers
</I>&gt;<i> (predecessor to linux containers lxc) as such, we dont have any
</I>&gt;<i> promiscuous interfaces rights within the container.
</I>
Sorry. That is a requirement nowdays. Browser offer a full XHR or Flash
networking stack for use by remotely supplied (ie attacker supplied)
code that can forge requests so we cannot trust the client delivered
Host headers anymore.
NP: This actually makes Squid behave more &quot;transparent&quot; than ever
before, since it now preserves the destination IP.

You have a couple of options;

1) tunneling the packets from the machine which used to do NAT through
to the Squid machine. WCCP, IP-over-IP, GRE, etc.

 The NAT you used to have was just a way to tunnel the packets through
the DMZ subnet to Squid anyway. So this is conceptually no different to
what you have now. The issues which you might associate with tunnels
were already happening, just hidden by the NAT.


2) route the packets from the internal gateway to the squid machine as
if it were another gateway. Conceptually Squid *is* being a gateway for
port 80 traffic.

There are a couple of routing designs detailed at
&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>&gt;
for setting that up if your gateway machine uses iptables. You might be
able to find equivalent documentation for other OS if you need.

Or you might design your own routing methods. The key thing is that the
destination IP:port numbers cannot be changed on the TCP packets between
the client and Squid.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012763.html">[squid-users] External nat'ed transparent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="012786.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12774">[ date ]</a>
              <a href="thread.html#12774">[ thread ]</a>
              <a href="subject.html#12774">[ subject ]</a>
              <a href="author.html#12774">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
