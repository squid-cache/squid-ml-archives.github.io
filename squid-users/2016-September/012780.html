<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] connections from particular users sometimes get stuck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%0A%20stuck&In-Reply-To=%3C57EE084F.6020505%40norma.perm.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012757.html">
   <LINK REL="Next"  HREF="012783.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] connections from particular users sometimes get stuck</H1>
    <B>Eugene M. Zheganin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%0A%20stuck&In-Reply-To=%3C57EE084F.6020505%40norma.perm.ru%3E"
       TITLE="[squid-users] connections from particular users sometimes get stuck">emz at norma.perm.ru
       </A><BR>
    <I>Fri Sep 30 06:38:07 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012757.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
        <LI>Next message (by thread): <A HREF="012783.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12780">[ date ]</a>
              <a href="thread.html#12780">[ thread ]</a>
              <a href="subject.html#12780">[ subject ]</a>
              <a href="author.html#12780">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

On 29.09.2016 23:17, Alex Rousskov wrote:
&gt;<i> On 09/29/2016 02:58 AM, Eugene M. Zheganin wrote:
</I>&gt;&gt;<i> This time turbodom.ru entries are present in the debug log
</I>&gt;<i> Yes, there are two complete HTTP transactions with that domain. One is a
</I>&gt;<i> 407 Authentication Required and one is a 301 redirect:
</I>&gt;<i>
</I>&gt;&gt;<i> HTTP/1.1 301 Moved Permanently
</I>&gt;<i> ...
</I>&gt;&gt;<i> Location: <A HREF="http://turbodom.ru/index.html/">http://turbodom.ru/index.html/</A>
</I>&gt;<i> I see no relevant problems with those two transactions.
</I>Me neither, but the original transaction start wasn't 'GET
<A HREF="http://turbodom.ru/index.html/">http://turbodom.ru/index.html/</A>', it was 'GET
<A HREF="http://turbodom.ru/index.html">http://turbodom.ru/index.html</A>', without trailing slash. Trailing slash
was added by the web-server, due to it's specific configuration. And the
main sign indicating there's something wrong with this initial
transaction was the fact that 407 answer took 42 seconds to appear in
both tcpdump captures.
&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> tcpdump capture taken from a client machine:
</I>&gt;&gt;<i> <A HREF="http://zhegan.in/files/squid/squid-stuck-client.pcap">http://zhegan.in/files/squid/squid-stuck-client.pcap</A>
</I>&gt;<i> This capture one is missing most of the second transaction packets
</I>&gt;<i> (tcp.stream eq 186). I do not know why tcpdump was unable to collect them.
</I>This is because of the gap between Ctrl^C issued in the client machine
cmd console and squid server ssh console (in this exact order) - I had
to switch between windows on my desktop, and because about a minute has
passed since the beginning of the transaction (42 seconds plus quite
some time), and I was worried that the debug log will grow more and
more, making it difficult to navigate then.
&gt;&gt;<i> tcpdump capture taken from squid machine, on the interface the client
</I>&gt;&gt;<i> machine is connected via:
</I>&gt;&gt;<i> <A HREF="http://zhegan.in/files/squid/squid-stuck-server-to-client.pcap">http://zhegan.in/files/squid/squid-stuck-server-to-client.pcap</A>
</I>&gt;<i> This one has both HTTP transactions described above (tcp.stream eq 206).
</I>&gt;<i>
</I>&gt;<i> It also contains a related and incomplete transaction that follows the
</I>&gt;<i> above redirect (tcp.stream eq 346). According to tcpdump, that
</I>&gt;<i> transaction starts around 13:31:26.
</I>&gt;<i>
</I>&gt;<i> Squid cache log does not mention that third transaction (or that TCP
</I>&gt;<i> connection), probably because Squid could not accept it. There were a
</I>&gt;<i> few accept failures (ECONNABORTED) right around the time of that
</I>&gt;<i> third/missing transaction:
</I>&gt;<i>
</I>&gt;&gt;<i> 13:31:25.060 kid1| accept failure: (53) Software caused connection abort
</I>&gt;&gt;<i> 13:31:25.865 kid1| accept failure: (53) Software caused connection abort
</I>&gt;&gt;<i> 13:31:25.904 kid2| accept failure: (53) Software caused connection abort
</I>&gt;<i> The timestamps are a ~second off, but AFAICT, they are a ~second off for
</I>&gt;<i> successful accepts as well, so it is probably just a tcpdump logging
</I>&gt;<i> artifact.
</I>&gt;<i>
</I>&gt;<i> In summary, your browser is probably stuck because Squid could not
</I>&gt;<i> accept a connection. Why did that accept call fail with ECONNABORTED? I
</I>&gt;<i> cannot say for sure -- the packet trace is rather dirty/misleading
</I>&gt;<i> (e.g., it shows the redirect packet being sent to the client _after_ the
</I>&gt;<i> client follows that redirect which does not make sense).
</I>&gt;<i>
</I>&gt;<i> Any relevant errors in you system logs?
</I>Nothing except

Limiting closed port RST response from 294 to 200 packets/sec

repeated by many times, which doesn't look related to this, because they
keep popping even when nobody's complaining. I've already did the
initial investigation and found no signs of resource starvation -
meaning no connection/files/mbufs/memory/pf states starvation happens.
At least I didn't find it. Plus, it would affect all of the clients
randomly, right ? Not this particular one.
&gt;<i>
</I>&gt;<i> If you cancel browser wait and repeat the request, will it work?
</I>Sometimes, but this means like 3-5% percents. Most of the time
rerequests lead to the same timeout, Chrome shows the request is
&quot;pending&quot; in the developer's tools/network tab for dozens of seconds,
and so on.
&gt;<i>  If this
</I>&gt;<i> was just a random accept failure, then it should work on the second try.
</I>&gt;<i> If it does not work again, then there is something more serious going on
</I>&gt;<i> (but you would need to collect more logs to study that).
</I>&gt;<i>
</I>&gt;<i> The connection accepting code in Squid is in poor shape, but I do not
</I>&gt;<i> think those minor code problems affect this particular use case.
</I>&gt;<i>
</I>I still have this machine in stuck state (I think), what should I focus on ?

Thanks.
Eugene.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012757.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
	<LI>Next message (by thread): <A HREF="012783.html">[squid-users] connections from particular users sometimes get stuck
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12780">[ date ]</a>
              <a href="thread.html#12780">[ thread ]</a>
              <a href="subject.html#12780">[ subject ]</a>
              <a href="author.html#12780">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
