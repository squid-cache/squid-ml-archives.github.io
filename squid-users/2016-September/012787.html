<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External nat'ed transparent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C20160930103642.GB29597%40fantomas.sk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012786.html">
   <LINK REL="Next"  HREF="012789.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External nat'ed transparent proxy</H1>
    <B>Matus UHLAR - fantomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C20160930103642.GB29597%40fantomas.sk%3E"
       TITLE="[squid-users] External nat'ed transparent proxy">uhlar at fantomas.sk
       </A><BR>
    <I>Fri Sep 30 10:36:42 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012786.html">[squid-users] External nat'ed transparent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="012789.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12787">[ date ]</a>
              <a href="thread.html#12787">[ thread ]</a>
              <a href="subject.html#12787">[ subject ]</a>
              <a href="author.html#12787">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29.09.16 16:39, Henry Paulissen wrote:
&gt;<i>In the company I work for we are currently using squid v2 proxies in
</I>&gt;<i>transparent mode to intercept traffic from servers to the outside
</I>&gt;<i>(access control).
</I>&gt;<i>
</I>&gt;<i>The technical solution for this is roughly as follows:
</I>&gt;<i>[server] -&gt; [gateway] -&gt; [firewall]
</I>&gt;<i>                              |
</I>&gt;<i>    ----------- DNAT ---------
</I>&gt;<i>   v
</I>&gt;<i>[squid]  -&gt; [gateway] -&gt; [firewall] -&gt; [internet router]
</I>
this is a bad configuration. The firewall in the path should NOT use DNAT,
since it makes the important part of connection (destination IP) invisible
to squid.

&gt;<i>Because squid v2 is becoming more and more obsolete we are looking at
</I>&gt;<i>upgrading it towards squid v3.
</I>&gt;<i>
</I>&gt;<i>From what I read in the manuals, transparent mode is replaced by
</I>&gt;<i>intercept (and tproxy) mode. But both dont seem to be fully backward
</I>&gt;<i>complaint with the v2 transparent mode.
</I>
not replaced, but renamed.

A &quot;transparent proxy&quot; is a proxy that does not modify the request or
response beyond what is required for proxy authentication and
identification.

An intercepting proxy is a proxy that intercepts request sent to other
server and handles it by itself.

otherwise the functionality is the same (just better) with intercept.
tproxy is intercepting in special mode, so the connection comes from the
client's instead of proxy server's IP address.

&gt;<i>The old trasparent mode allowed us to just dnat traffic towards the
</I>&gt;<i>squid host without the need for the client to be aware of this. For
</I>&gt;<i>example, the old style accepted 'GET / HTTP/1.1' (without full URL in
</I>&gt;<i>the GET request and looking at the Host header for the destination).
</I>&gt;<i>
</I>&gt;<i>The new intercept mode comes close to this behavior, but instead of
</I>&gt;<i>remotly dnat, it wants us to next-hop it towards the squid proxy and
</I>&gt;<i>redirect it locally. This is problematic for us as firewall and squid
</I>&gt;<i>proxy dont live in the same vlan, so next-hop should be the router to
</I>&gt;<i>that vlan (and forgetting about the path back to the server). Secondly,
</I>&gt;<i>and not less blocking, we use vservers (predecessor to linux containers
</I>&gt;<i>lxc) as such, we dont have any promiscuous interfaces rights within the
</I>&gt;<i>container.
</I>
if you really need to intercept users' requests, your network architecture
should be able to do it.

&gt;<i>Is there still a option to emulate normal 'regular&#180; style squid (as
</I>&gt;<i>without any listen options) but instead accepting the URI path in the
</I>&gt;<i>GET request and looking at the Host header for the destination? (lets
</I>&gt;<i>call it passthrough mode?).
</I>
Have you tried configuring WPAD?

&gt;<i>Or, is there in squid3 a new and better way to facilitate larger setups,
</I>&gt;<i>with the knowledge the server, firewall and squids are all in different
</I>&gt;<i>vlans (and no, we dont have Cisco firewalls in between them ;-)).
</I>
I am not sure whether it's a good design to intercept requests on one router
and direct them through multiple routers/firewalls.

-- 
Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Enter any 12-digit prime number to continue.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012786.html">[squid-users] External nat'ed transparent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="012789.html">[squid-users] External nat'ed transparent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12787">[ date ]</a>
              <a href="thread.html#12787">[ thread ]</a>
              <a href="subject.html#12787">[ subject ]</a>
              <a href="author.html#12787">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
