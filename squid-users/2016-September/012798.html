<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] connections from particular users sometimes get stuck
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%0A%20stuck&In-Reply-To=%3C35294bd8-93cf-0ff6-b155-d973cd8e99c1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012796.html">
   <LINK REL="Next"  HREF="012724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] connections from particular users sometimes get stuck</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20connections%20from%20particular%20users%20sometimes%20get%0A%20stuck&In-Reply-To=%3C35294bd8-93cf-0ff6-b155-d973cd8e99c1%40measurement-factory.com%3E"
       TITLE="[squid-users] connections from particular users sometimes get stuck">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep 30 15:12:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012796.html">[squid-users] connections from particular users sometimes get	stuck
</A></li>
        <LI>Next message (by thread): <A HREF="012724.html">[squid-users] R: Re: R: Re: problem reload configuration with workers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12798">[ date ]</a>
              <a href="thread.html#12798">[ thread ]</a>
              <a href="subject.html#12798">[ subject ]</a>
              <a href="author.html#12798">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/30/2016 12:38 AM, Eugene M. Zheganin wrote:
&gt;<i> And the
</I>&gt;<i> main sign indicating there's something wrong with this initial
</I>&gt;<i> transaction was the fact that 407 answer took 42 seconds to appear in
</I>&gt;<i> both tcpdump captures.
</I>
To avoid misunderstanding: There are many red flags in your logs,
including excessive processing delays. I am ignoring the ones that do
not appear to be related to the &quot;stuck browser&quot; problem.


&gt;&gt;&gt;<i> tcpdump capture taken from a client machine:
</I>&gt;&gt;&gt;<i> <A HREF="http://zhegan.in/files/squid/squid-stuck-client.pcap">http://zhegan.in/files/squid/squid-stuck-client.pcap</A>
</I>
&gt;&gt;<i> This capture one is missing most of the second transaction packets
</I>&gt;&gt;<i> (tcp.stream eq 186). I do not know why tcpdump was unable to collect them.
</I>
&gt;<i> This is because of the gap between Ctrl^C issued in the client machine
</I>&gt;<i> cmd console and squid server ssh console (in this exact order) - I had
</I>&gt;<i> to switch between windows on my desktop, and because about a minute has
</I>&gt;<i> passed since the beginning of the transaction (42 seconds plus quite
</I>&gt;<i> some time), and I was worried that the debug log will grow more and
</I>&gt;<i> more, making it difficult to navigate then.
</I>
Please do not worry about log navigation -- you are already posting logs
with 95+% of irrelevant transactions; adding 2% more would make no
difference. Focus on collecting complete logs. However, please
_compress_ your logs before posting them.


&gt;&gt;<i> In summary, your browser is probably stuck because Squid could not
</I>&gt;&gt;<i> accept a connection. Why did that accept call fail with ECONNABORTED?
</I>
&gt;&gt;<i> If you cancel browser wait and repeat the request, will it work?
</I>
&gt;<i> Sometimes, but this means like 3-5% percents. 
</I>
This may be your pathway to the answer! A _random_ ECONNABORTED
accept(2) error would have a ~100% probability of disappearing on the
second attempt. Your observations seem to confirm that this error
(assuming Squid gets ECONNABORTED for all stuck transactions) is caused
by something on that client or something between that specific client
and Squid.

We obviously do not know what is wrong yet, but just for the sake of an
example, consider a mismatching negotiated Ethernet settings that lead
to packet loss and similar low-level problems that lead to TCP accept(2)
errors from Squid point of view. Again, I am not claiming that this is
what is going on.


&gt;<i> Most of the time
</I>&gt;<i> rerequests lead to the same timeout, Chrome shows the request is
</I>&gt;<i> &quot;pending&quot; in the developer's tools/network tab for dozens of seconds,
</I>&gt;<i> and so on.
</I>
Very good. This is something we can use to investigate.



&gt;<i> I still have this machine in stuck state (I think), what should I focus on ?
</I>
I recommend the following:

0. Start capturing to/from-Squid packets on the client machine.
   Make sure tcpdump does not do DNS resolution (if applicable).
1. Start capturing to/from-clientS packets on the Squid machine.
   Make sure tcpdump does not do DNS resolution (if applicable).
2. Start Squid debugging.

3. On both machines (if possible):
   Collect &quot;netstat -s&quot; or equivalent TCP stack stats.
   Collect &quot;ifconfig ...&quot; or equivalent high-level interface stats.
   Collect &quot;ethtool -s ...&quot; or equivalent low-level interface stats.

4. Reproduce the problem. Wait until Chrome times out.

5. On both machines (if possible):
   Collect &quot;netstat -s&quot; or equivalent TCP stack stats.
   Collect &quot;ifconfig ...&quot; or equivalent high-level interface stats.
   Collect &quot;ethtool -s ...&quot; or equivalent low-level interface stats.

6. Rereproduce the problem. Wait until Chrome times out.
   If possible, use a slightly different URL for this test.
   For example, append &quot;?test2&quot; to the URL in #4, assuming
   that will not screw things up.

7. On both machines (if possible):
   Collect &quot;netstat -s&quot; or equivalent TCP stack stats.
   Collect &quot;ifconfig ...&quot; or equivalent high-level interface stats.
   Collect &quot;ethtool -s ...&quot; or equivalent low-level interface stats.

8. Wait 60 seconds.

9. Stop all captures and Squid debugging.
10. Archive, compress, and share all the logs and the test URL(s).
    When archiving, please preserve file modification times for
    logs from steps 3,5,7.

Adjust the procedure as needed, of course.

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012796.html">[squid-users] connections from particular users sometimes get	stuck
</A></li>
	<LI>Next message (by thread): <A HREF="012724.html">[squid-users] R: Re: R: Re: problem reload configuration with workers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12798">[ date ]</a>
              <a href="thread.html#12798">[ thread ]</a>
              <a href="subject.html#12798">[ subject ]</a>
              <a href="author.html#12798">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
