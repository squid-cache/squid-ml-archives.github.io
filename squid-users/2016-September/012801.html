<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External nat'ed transparent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C262ddf06-6781-a49b-335a-11a807a0ce73%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012789.html">
   <LINK REL="Next"  HREF="012766.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External nat'ed transparent proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20nat%27ed%20transparent%20proxy&In-Reply-To=%3C262ddf06-6781-a49b-335a-11a807a0ce73%40treenet.co.nz%3E"
       TITLE="[squid-users] External nat'ed transparent proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 30 17:35:42 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="012789.html">[squid-users] External nat'ed transparent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="012766.html">[squid-users] No matter what I do I can not get %ssl:&gt;sni (or other	%ssl) to log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12801">[ date ]</a>
              <a href="thread.html#12801">[ thread ]</a>
              <a href="subject.html#12801">[ subject ]</a>
              <a href="author.html#12801">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/10/2016 12:27 a.m., Henry Paulissen wrote:
&gt;<i> Hi Matus,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 30-09-16 12:36, Matus UHLAR - fantomas wrote:
</I>&gt;&gt;<i> On 29.09.16 16:39, Henry Paulissen wrote:
</I>&gt;&gt;&gt;<i> In the company I work for we are currently using squid v2 proxies in
</I>&gt;&gt;&gt;<i> transparent mode to intercept traffic from servers to the outside
</I>&gt;&gt;&gt;<i> (access control).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The technical solution for this is roughly as follows:
</I>&gt;&gt;&gt;<i> [server] -&gt; [gateway] -&gt; [firewall]
</I>&gt;&gt;&gt;<i>                              |
</I>&gt;&gt;&gt;<i>    ----------- DNAT ---------
</I>&gt;&gt;&gt;<i>   v
</I>&gt;&gt;&gt;<i> [squid]  -&gt; [gateway] -&gt; [firewall] -&gt; [internet router]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> this is a bad configuration. The firewall in the path should NOT use DNAT,
</I>&gt;&gt;<i> since it makes the important part of connection (destination IP) invisible
</I>&gt;&gt;<i> to squid.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> That is where the HTTP Host header can be used for... For squid to
</I>&gt;<i> figure out the destination of the request. (aren&#180;t they?)
</I>
That is what it was intended for 20 or so years ago. But times change
and nowdays we have to deal with browsers that can be sent a scimple
script and instructed to do all sorts of nasty things in the traffic. If
you want the gory details you can find my prvious answers to people
asking this same question repeatedly over the last 5 years.

The TL;DR is: no, that is no longer safe to do and Squid will not do it
any more. Simply dont use DNAT on the port 80 (or 443) packets before
they hit the machine running Squid. Routing is a more powerful feature
than most realize, make use of it.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="012789.html">[squid-users] External nat'ed transparent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="012766.html">[squid-users] No matter what I do I can not get %ssl:&gt;sni (or other	%ssl) to log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12801">[ date ]</a>
              <a href="thread.html#12801">[ thread ]</a>
              <a href="subject.html#12801">[ subject ]</a>
              <a href="author.html#12801">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
