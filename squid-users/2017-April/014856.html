<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS reverse proxy: SSL Certficate verification failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20reverse%20proxy%3A%20SSL%20Certficate%20verification%0A%20failed&In-Reply-To=%3C7e8eeb8e-0b3d-fdd0-472c-76cb1b06743b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014873.html">
   <LINK REL="Next"  HREF="014863.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS reverse proxy: SSL Certficate verification failed</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20reverse%20proxy%3A%20SSL%20Certficate%20verification%0A%20failed&In-Reply-To=%3C7e8eeb8e-0b3d-fdd0-472c-76cb1b06743b%40treenet.co.nz%3E"
       TITLE="[squid-users] HTTPS reverse proxy: SSL Certficate verification failed">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Apr  2 08:27:04 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014873.html">[squid-users] Using client certificate for all connection
</A></li>
        <LI>Next message (by thread): <A HREF="014863.html">[squid-users] HTTPS reverse proxy: SSL Certficate verification	failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14856">[ date ]</a>
              <a href="thread.html#14856">[ thread ]</a>
              <a href="subject.html#14856">[ subject ]</a>
              <a href="author.html#14856">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/04/2017 4:42 a.m., Eric Veiras Galisson wrote:
&gt;<i> On Fri, Mar 31, 2017 at 4:44 AM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 31/03/2017 4:01 a.m., Eric Veiras Galisson wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I want to setup Squid as a HTTPS reverse proxy for several of our
</I>&gt;&gt;<i> websites,
</I>&gt;&gt;&gt;<i> but I have a certificate verification problem on Squid access.log.
</I>&gt;&gt;&gt;<i> Our upstream webservers are behind a VPN tunnel and only the Squid server
</I>&gt;&gt;&gt;<i> can access it. (*We actually use Nginx for the same purpose but want to
</I>&gt;&gt;&gt;<i> switch to Squid)*
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>                               HTTPS                           HTTPS
</I>&gt;&gt;&gt;<i> [client browser] -----------------------&gt; [Squid]
</I>&gt;&gt;&gt;<i> --------------------------&gt; [upstream server]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I run squid 3.4.8-6+deb8u4 recompiled with --enable-ssl
</I>&gt;&gt;&gt;<i> --with-open-ssl=&quot;/etc/ssl/openssl.cnf&quot; on Debian Jessie.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The certificate presented to the client is the same as on the upstream
</I>&gt;&gt;&gt;<i> server, a wildcard one signed by GeoTrust (with intermediate CA). It
</I>&gt;&gt;&gt;<i> appears correctly in the browser.
</I>&gt;&gt;&gt;<i> The problem comes from squid verification of upstream certificate.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> ...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What am I doing wrong? and what should I do to make squid work in this
</I>&gt;&gt;&gt;<i> setup?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The server (and Squid) should be supplying the intermediate cert along
</I>&gt;&gt;<i> with its own cert for best validation behaviour.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Both the server and squid (https_port cert= option) are actually using the
</I>&gt;<i> same certificate: a single file with priv key, server certificate and
</I>&gt;<i> intermediary cert CA.
</I>&gt;<i> 
</I>
That does not matter. TLS is point-to-point.

What matters is that *any* software operating as the server endpoint of
a TLS connection sends the right details along with its cert.

Your setup is special in that it has multiple pieces of software using
the same cert (Squid and the peer web service). That is not great for
security (reduces the effective trust lifetime of the cert), but is doable.


&gt;<i> 
</I>&gt;&gt;<i> If it cannot, use the cache_peer sslcafile= option to provide Squid with
</I>&gt;&gt;<i> a PEM file containing the public certs of the whole chain (excluding the
</I>&gt;&gt;<i> server cert itself). Order of those certs in the file is important. I've
</I>&gt;&gt;<i> forgotten which end of the chain to start with sorry, but it is one or
</I>&gt;&gt;<i> the other and definitely sequential.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> I changed cache_peer directive to add sslcafile option to a PEM file
</I>&gt;<i> containing root and intermediary CA certificate, in one order or the other.
</I>&gt;<i> 
</I>&gt;<i> And when verifying with openssl s_client -showcerts -connect
</I>&gt;<i> upstream1.domain.tld directly (no squid) or via squid, it's OK [1]
</I>&gt;<i> 
</I>&gt;<i> $ openssl s_client -showcerts -connect upstream.domain.tld:443
</I>&gt;<i> CONNECTED(00000003)
</I>&gt;<i> depth=2 C = US, O = GeoTrust Inc., CN = GeoTrust Global CA
</I>&gt;<i> verify return:1
</I>&gt;<i> depth=1 C = US, O = GeoTrust Inc., CN = RapidSSL SHA256 CA
</I>&gt;<i> verify return:1
</I>&gt;<i> depth=0 CN = *.domain.tld
</I>&gt;<i> verify return:1
</I>&gt;<i> ---
</I>&gt;<i>     Verify return code: 0 (ok)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> But I still have the same error when connecting to the website with a
</I>&gt;<i> browser.
</I>&gt;<i> 
</I>
Exact same error? Since Squid is juggling multiple TLS connections for
the transaction I am looking at &quot;fwdNegotiateSSL&quot; in the log message
which is the only detail indicating what connection is having the issue.

That Squid-&gt;server connection has zero difference between the browser
and the command line tool connecting to a reverse-proxy, or when both
are using opaque (non-Bumped) CONNECT tunnels. So one working and the
other not is impossible.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014873.html">[squid-users] Using client certificate for all connection
</A></li>
	<LI>Next message (by thread): <A HREF="014863.html">[squid-users] HTTPS reverse proxy: SSL Certficate verification	failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14856">[ date ]</a>
              <a href="thread.html#14856">[ thread ]</a>
              <a href="subject.html#14856">[ subject ]</a>
              <a href="author.html#14856">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
