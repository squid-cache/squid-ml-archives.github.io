<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Authentication if URL is on a Blacklist from SquidGuard
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Authentication%20if%20URL%20is%20on%20a%20Blacklist%0A%20from%20SquidGuard&In-Reply-To=%3C9decae7d-d2d3-3650-6fc9-aa6b29510489%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014884.html">
   <LINK REL="Next"  HREF="014897.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Authentication if URL is on a Blacklist from SquidGuard</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Authentication%20if%20URL%20is%20on%20a%20Blacklist%0A%20from%20SquidGuard&In-Reply-To=%3C9decae7d-d2d3-3650-6fc9-aa6b29510489%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Authentication if URL is on a Blacklist from SquidGuard">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr  6 15:38:22 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014884.html">[squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard
</A></li>
        <LI>Next message (by thread): <A HREF="014897.html">[squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14893">[ date ]</a>
              <a href="thread.html#14893">[ thread ]</a>
              <a href="subject.html#14893">[ subject ]</a>
              <a href="author.html#14893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/04/2017 7:48 p.m., CrossfireAUT wrote:
&gt;<i> /If you have such a thing as AD and the ability to push Group Policy to
</I>&gt;<i> the users there is no need to avoid authentication./
</I>&gt;<i> 
</I>&gt;<i> I have a running AD on Ubuntu 16.04 with samba4.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /Perhapse the client is actually asking to get away from lots of annoying
</I>&gt;<i> popups the browsers are forcing on them? if that is happening it is a
</I>&gt;<i> strong sign that the authentication system needs fixing. When it works
</I>&gt;<i> there should be zero popups./
</I>&gt;<i> 
</I>&gt;<i> The client gets asked for his username/password everytime he closes &amp; opens
</I>&gt;<i> the browser, while surfing, there are no PopUps so the client can surf
</I>&gt;<i> undisturbed.
</I>&gt;<i> At first, my client wanted to authenticate everytime someone opens &amp; closes
</I>&gt;<i> the browser, now he wants to authenticate ONLY if someone calls up &quot;a bad
</I>&gt;<i> Website&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /Er, credentials are valid for 2 hours, but the &quot;users&quot; are jumping
</I>&gt;<i> around between IPs every second?
</I>&gt;<i> NP: the authenticate_ip_* stuff is irrelevant unless a maxuserip type
</I>&gt;<i> ACL is being used.
</I>&gt;<i> /
</I>&gt;<i> 
</I>&gt;<i> Thanks, the thing with &quot;authenticate_ip_ttl 1 second&quot; was my fallacy.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /Funky.
</I>&gt;<i> Have you check that is not simple the browser &quot;Password Manager&quot;
</I>&gt;<i> feature requesting access to their machine or AD &quot;Domain login&quot; details?/
</I>&gt;<i> 
</I>&gt;<i> Browsers with &quot;Password-Manager&quot;-Features can save the password, but only
</I>&gt;<i> fill in the saved username and password.
</I>&gt;<i> So you would have to press Enter in order to continue. If you don't use this
</I>&gt;<i> Feature, you will get asked everytime you close &amp; open the browser and have
</I>&gt;<i> to enter it yourself.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /
</I>&gt;<i> To use SG as requested you need to make an external_acl_type helper that
</I>&gt;<i> receives the same things SG needs and passes them on to it, mapping the
</I>&gt;<i> result back to an OK/ERR result for Squid ACL use.
</I>&gt;<i>  [ IIRC Eliezer has posted a helper that does that to the list . ]
</I>&gt;<i> 
</I>&gt;<i> Then you can do something like:
</I>&gt;<i>   external_acl_type sgMapper ...
</I>&gt;<i>   acl testWithSg external sgMapper
</I>&gt;<i> 
</I>&gt;<i>   http_access allow testWithSG
</I>&gt;<i>   http_access deny !auth
</I>&gt;<i>   ...
</I>&gt;<i> 
</I>&gt;<i> Note that this does not involve the url_rewrite_* API. You can drop that
</I>&gt;<i> entirely. Unless you want some traffic to still be redirected/rewritten
</I>&gt;<i> by SG. In which case you need url_rewrite_access to define which traffic
</I>&gt;<i> SG applies to./
</I>&gt;<i> 
</I>&gt;<i> I have to excuse myself, I'm still a beginner in the world of Squid.
</I>&gt;<i> Thanks for understanding.
</I>&gt;<i> You are right, I don't need to redirect to Blockpages anymore.
</I>&gt;<i> If the user authenticates because he called up a bad url, he should be
</I>&gt;<i> allowed to pass.
</I>&gt;<i> 
</I>&gt;<i> I don't understand that solution, why do I need to make that
</I>&gt;<i> external_acl_type helper?
</I>
You need external_acl_type is because of that requirement that SG be
used. It is too late to authenticate by the time url_rewrite_helper API
gets consulted. So a complex ACL is needed that does a lookup with SG.
 The external_acl_type helper interface exists for that type of purpose.

You need the special mapping helper only because SG is very outdated
software and no longer maintained. It does not understand the generic
helper syntax Squid uses these days, and only responds with the old
redirect_helper syntax.

The wrapper helper is needed to map that old SG syntax to new OK/ERR
responses that the ACL interface expects.

My answer went that way because you said using SG was a client
requirement. I assumed you could not change that.

FWIW: Any helper which responds using the generic helper syntax
(produces OK/ERR codes) can be used directly in an external_acl_type
directive without the special wrapper SG needs. ufdbGuard is one I
expect could be used like that as a replacement for SG.


&gt;<i> Isn't it the same as my external_acl_type?
</I>&gt;<i> 
</I>&gt;<i> /external_acl_type webusers %LOGIN /usr/lib/squid/ext_ldap_group_acl -b
</I>&gt;<i> &quot;dc=xxxx,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">testuser at xxxx.local</A> -W /etc/squid/squid.secrets -f
</I>&gt;<i> &quot;(&amp;(sAMAccountName=%v)(memberOf=cn=%a,cn=Users,dc=xxxx,dc=local))&quot; -h
</I>&gt;<i> 172.30.0.36
</I>
This external_acl_type is a lookup to check the already logged-in users
group membership.

It does not check what SG thinks about the URL (good or bad), or
anything else. Just the group check.


You can have multiple external_acl_type lines. Having one for SG does
not affect the above group one in any way. They are named in that first
parameter so your &quot;acl ... external&quot; lines can reference which helper is
to be sent the lookup by that ACL.


&gt;<i> 
</I>&gt;<i> acl ldapgroup_webusers external webusers webusers
</I>&gt;<i> 
</I>&gt;<i> http_access allow ldapgroup_webusers
</I>&gt;<i> /
</I>&gt;<i> 
</I>&gt;<i> My helper are working well:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">xxxx at xxxx-testproxy01</A>:~# /usr/lib/squid/basic_ldap_auth -R -b
</I>&gt;<i> &quot;dc=xxxx,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">testuser at xxxx.local</A> -W /etc/squid/squid.secrets -f
</I>&gt;<i> sAMAccountName=%s -h 172.30.0.36
</I>&gt;<i> testuser xxxx
</I>&gt;<i> OK
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">xxxx at xxxx-testproxy01</A>:~# /usr/lib/squid/ext_ldap_group_acl -b
</I>&gt;<i> &quot;dc=xxxx,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">testuser at xxxx.local</A> -W /etc/squid/squid.secrets -f
</I>&gt;<i> &quot;(&amp;(sAMAccountName=%v)(memberOf=cn=%a,cn=Users,dc=xxxx,dc=local))&quot; -h
</I>&gt;<i> 172.30.0.36
</I>&gt;<i> testuser webusers
</I>&gt;<i> OK
</I>&gt;<i> 
</I>&gt;<i> How can I match the requested URL against the Blacklists without SquidGuard?
</I>&gt;<i> I still need to match it against the Blacklist, and then it has to get
</I>&gt;<i> decided if he needs to authenticate or not.
</I>

It depends on exactly what format the blacklist is. If it is just a list
of domains, you can load it into a dstdomain ACL.
Like so:
 acl bad dstdomain &quot;/etc/squid/blacklist.domains&quot;

Or, if it has regex patterns one of the regex ACLs. There are a bunch
that can do full-URL, domain, or path-only regex matching. Though regex
is kind of slow so if you can avoid that it helps with performance.
 &lt;<A HREF="http://www.squid-cache.org/Doc/config/acl/">http://www.squid-cache.org/Doc/config/acl/</A>&gt;

Or, using a more up to date helper than SG for the external lookup, as
mentioned above.

The benefit from doing the lists outside if squid.conf ACLs is ability
to change them easily without reconfiguring Squid. That comes in handy
for large lists.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014884.html">[squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard
</A></li>
	<LI>Next message (by thread): <A HREF="014897.html">[squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14893">[ date ]</a>
              <a href="thread.html#14893">[ thread ]</a>
              <a href="subject.html#14893">[ subject ]</a>
              <a href="author.html#14893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
