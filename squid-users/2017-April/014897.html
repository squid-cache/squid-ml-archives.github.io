<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Authentication%20if%20URL%20is%20on%20a%20Blacklist%0A%09from%20SquidGuard&In-Reply-To=%3C05d001d2aef4%24b13e9e90%2413bbdbb0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014893.html">
   <LINK REL="Next"  HREF="014880.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard</H1>
    <B>Eliezer  Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Authentication%20if%20URL%20is%20on%20a%20Blacklist%0A%09from%20SquidGuard&In-Reply-To=%3C05d001d2aef4%24b13e9e90%2413bbdbb0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Squid Authentication if URL is on a Blacklist	from SquidGuard">eliezer at ngtech.co.il
       </A><BR>
    <I>Thu Apr  6 16:41:51 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014893.html">[squid-users] Squid Authentication if URL is on a Blacklist from SquidGuard
</A></li>
        <LI>Next message (by thread): <A HREF="014880.html">[squid-users] https_port and capath
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14897">[ date ]</a>
              <a href="thread.html#14897">[ thread ]</a>
              <a href="subject.html#14897">[ subject ]</a>
              <a href="author.html#14897">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A copy of the message which includes the script and the relevant details at: <A HREF="http://www.ngtech.co.il/paste/1758/raw/">http://www.ngtech.co.il/paste/1758/raw/</A>

Or on the list archives:
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-June/011047.html">http://lists.squid-cache.org/pipermail/squid-users/2016-June/011047.html</A>

Or on the next gist:
<A HREF="https://gist.github.com/elico/865938620fb7a61ce5293bbce0b2bb06">https://gist.github.com/elico/865938620fb7a61ce5293bbce0b2bb06</A>

Eliezer

* Should I add it to the wiki?... this is a 3 Clause  BSD licensed piece of code

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: Tuesday, April 4, 2017 9:18 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid Authentication if URL is on a Blacklist from SquidGuard

On 31/03/2017 9:22 p.m., CrossfireAUT wrote:
&gt;<i> Hello Squid-Community!
</I>&gt;<i> 
</I>&gt;<i> I need your help with a rather non-standard config.
</I>&gt;<i> My aim is as following:
</I>&gt;<i> -&gt; Users that use my proxy (will deploy it via group policy in AD) should be
</I>&gt;<i> able to use my proxy without authentication
</I>
If you have such a thing as AD and the ability to push Group Policy to
the users there is no need to avoid authentication.

Perhapse the client is actually asking to get away from lots of annoying
popups the browsers are forcing on them? if that is happening it is a
strong sign that the authentication system needs fixing. When it works
there should be zero popups.


&gt;<i> -&gt; if a user invokes SquidGuard (he wants to call up a URL on my
</I>&gt;<i> blacklists), he should get prompted for his username and password
</I>&gt;<i> -&gt; only users of the AD-group webusers should be able to continue and go to
</I>&gt;<i> this site on the blacklist
</I>&gt;<i> I know, it isn't the best way to use SquidGuard, but a customer wants it
</I>&gt;<i> that way.
</I>
Ewww. Okay. See below....


&gt;<i> 
</I>&gt;<i> My current config is as following:
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ldap_auth -R -b
</I>&gt;<i> &quot;dc=xxxx,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">testuser at xxxx.local</A> -W /etc/squid/squid.secrets -f
</I>&gt;<i> sAMAccountName=%s -h 172.30.0.36
</I>&gt;<i> auth_param basic children 10
</I>&gt;<i> auth_param basic realm xxxx
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> 
</I>&gt;<i> external_acl_type webusers %LOGIN /usr/lib/squid/ext_ldap_group_acl -b
</I>&gt;<i> &quot;dc=xxxx,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">testuser at xxxx.local</A> -W /etc/squid/squid.secrets -f
</I>&gt;<i> &quot;(&amp;(sAMAccountName=%v)(memberOf=cn=%a,cn=Users,dc=xxxx,dc=local))&quot; -h
</I>&gt;<i> 172.30.0.36
</I>&gt;<i> 
</I>&gt;<i> authenticate_ip_ttl 1 second
</I>&gt;<i> 
</I>
Er, credentials are valid for 2 hours, but the &quot;users&quot; are jumping
around between IPs every second?

NP: the authenticate_ip_* stuff is irrelevant unless a maxuserip type
ACL is being used.

&gt;<i> 
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> acl no_webusers dstdomain .xxxx.at
</I>&gt;<i> acl ldapgroup_webusers external webusers webusers
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> http_access allow no_webusers
</I>&gt;<i> 
</I>&gt;<i> http_access allow ldapgroup_webuser
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>&gt;<i> url_rewrite_children 4
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So my users get prompted for their username/passwords everytime they restart
</I>&gt;<i> their browser.
</I>
Funky.
 Have you check that is not simple the browser &quot;Password Manager&quot;
feature requesting access to their machine or AD &quot;Domain login&quot; details?

I have seen a few computer-illiterate people confuse their browser
&quot;master password&quot; as some form of password associated with their default
homepage website. This can be particularly bad when that is set the
homepage to some popular social media site or search engine.


&gt;<i> If they call up a domain on my blacklists, they get ACCESS DENIED.
</I>&gt;<i> 
</I>&gt;<i> Does anyone know how you can achieve this?
</I>&gt;<i> Until know, I tried really hard, thought it would be a good idea to ask the
</I>&gt;<i> user-list!
</I>
So ignoring SG for now the problem is a matter of access control. That
means the right way to do it is with ACLs in http_access.


To use SG as requested you need to make an external_acl_type helper that
receives the same things SG needs and passes them on to it, mapping the
result back to an OK/ERR result for Squid ACL use.
 [ IIRC Eliezer has posted a helper that does that to the list . ]

Then you can do something like:
  external_acl_type sgMapper ...
  acl testWithSg external sgMapper

  http_access allow testWithSG
  http_access deny !auth
  ...

Note that this does not involve the url_rewrite_* API. You can drop that
entirely. Unless you want some traffic to still be redirected/rewritten
by SG. In which case you need url_rewrite_access to define which traffic
SG applies to.

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014893.html">[squid-users] Squid Authentication if URL is on a Blacklist from SquidGuard
</A></li>
	<LI>Next message (by thread): <A HREF="014880.html">[squid-users] https_port and capath
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14897">[ date ]</a>
              <a href="thread.html#14897">[ thread ]</a>
              <a href="subject.html#14897">[ subject ]</a>
              <a href="author.html#14897">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
