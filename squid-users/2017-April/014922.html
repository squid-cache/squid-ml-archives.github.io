<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] https log message formatting help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https%20log%20message%20formatting%20help&In-Reply-To=%3C21716d8f-0027-f61f-c5e1-9305cbdfb354%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014920.html">
   <LINK REL="Next"  HREF="014928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] https log message formatting help</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https%20log%20message%20formatting%20help&In-Reply-To=%3C21716d8f-0027-f61f-c5e1-9305cbdfb354%40treenet.co.nz%3E"
       TITLE="[squid-users] https log message formatting help">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Apr 10 03:35:56 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014920.html">[squid-users] https log message formatting help
</A></li>
        <LI>Next message (by thread): <A HREF="014928.html">[squid-users] https log message formatting help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14922">[ date ]</a>
              <a href="thread.html#14922">[ thread ]</a>
              <a href="subject.html#14922">[ subject ]</a>
              <a href="author.html#14922">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/04/2017 1:36 p.m., daveh wrote:
&gt;<i> Thanks for the reply.
</I>&gt;<i> 
</I>&gt;<i> Im parsing squid logs to send to a SIEM to identify IOCs. The SIEM agent
</I>&gt;<i> requires a URL to be formatted with http|<A HREF="https://&lt;URI">https://&lt;URI</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> It knows then that it can break the string out into various components such
</I>&gt;<i> as request URL authority, host etc
</I>
So it can understand *URL* format. But that is not what is being logged.
Squid technically logs a URI, and this log processing is one of the
cases were the difference between URI and URL matters.


&gt;<i> 
</I>&gt;<i> Your comment on logging https connections is not what I have found. I would
</I>
I think you misread what I wrote. There are only two ways to get Squid
to know what the <A HREF="https://">https://</A> URL was - neither of them are normal proxy usage.

&gt;<i> expect that typing <A HREF="https://something.net">https://something.net</A> will return that extact string in
</I>&gt;<i> the log. Every https connection is logged as a CONNECT with the FQDN
</I>&gt;<i> appended the :443.
</I>
You expect wrong.

The URL you entered into some client software starts with the schema
&quot;<A HREF="https://">https://</A>&quot; ... which requires that the fetching of that URL is done
securely. The last thing you should expect is that URL being sent over
plain-text / &quot;in the clear&quot; to some external software.


To do HTTPS the client software has to setup multiple layers of
protocols and security.

1) First it has to open a TCP connection to the proxy.

2) It does then have to tell the proxy where it is going to. But no more
than that. Thus the CONNECT request. As per
&lt;<A HREF="https://tools.ietf.org/html/rfc7230#section-5.3.3">https://tools.ietf.org/html/rfc7230#section-5.3.3</A>&gt; all that any
plain-text connection to a proxy contains is:

 CONNECT www.example.com:443 HTTP/1.1


3) Then it has to setup TLS/SSL encryption over those two TCP
connections. So the crypto happens directly between the client and the
server (as if the proxy were not there).

4) Then, and only then, after all that has been successful does it start
to send the first (or potentially many, hundreds, thousands...) of HTTP
requests over the connection:

  GET /index.html HTTP/1.1
  Host: example.com
   ...


If you look closely at that #4 layer request there is no &quot;<A HREF="https://">https://</A>&quot;
there. Nor any way to reconstruct it.
 It might even be another CONNECT (thought TOR invented onion routing?
HTTPS beat it by decades).

That meme from The Matrix &quot;there is no spoon&quot; has never been more apt.
There is no &quot;<A HREF="https://">https://</A>&quot; - at least, not once the client interprets its
input URL. It vanishes right there and then.



&gt;<i> Is there something in the config to force this to happen?
</I>
There is no simple config option. In fact we go out of our way to ensure
data accuracy. So the log contains reality and log interpreters can make
whatever assumptions you want it to about what they read there.

p-PS. I find it particularly odd that you would be trying to feed false
information into a SIEM system - security event detection depends on
accuracy of inputs. But its your neck.


&gt;<i> DOesnt seem to be a way of doing it with log formatting
</I>&gt;<i> 
</I>
There is that logformat directive and the codes I gave in my earlier
mail. &lt;<A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>&gt; and
&quot;%&gt;<A HREF="rs://%">rs://%</A>&gt;rd:%&gt;rP%&gt;rp&quot;

If the %&gt;rs is not producing a scheme for CONNECT transactions you could
hard-code &quot;https&quot;. Either way its a good idea to log these faked-up
records to a different log all of their own.

Use the access_log directive to setup multiple outputs:
 &lt;<A HREF="http://www.squid-cache.org/Doc/config/access_log/">http://www.squid-cache.org/Doc/config/access_log/</A>&gt;


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014920.html">[squid-users] https log message formatting help
</A></li>
	<LI>Next message (by thread): <A HREF="014928.html">[squid-users] https log message formatting help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14922">[ date ]</a>
              <a href="thread.html#14922">[ thread ]</a>
              <a href="subject.html#14922">[ subject ]</a>
              <a href="author.html#14922">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
