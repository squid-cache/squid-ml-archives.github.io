<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.23 X-forwader and log bug ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.23%20X-forwader%20and%20log%20bug%20%3F&In-Reply-To=%3Cfd9ab48c-e931-8884-6cdd-c49a66044ac9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014923.html">
   <LINK REL="Next"  HREF="014924.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.23 X-forwader and log bug ?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.23%20X-forwader%20and%20log%20bug%20%3F&In-Reply-To=%3Cfd9ab48c-e931-8884-6cdd-c49a66044ac9%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.23 X-forwader and log bug ?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Apr 11 00:52:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014923.html">[squid-users] Squid 3.5.23 X-forwader and log bug ?
</A></li>
        <LI>Next message (by thread): <A HREF="014924.html">[squid-users] Squid Redirection Scripting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14925">[ date ]</a>
              <a href="thread.html#14925">[ thread ]</a>
              <a href="subject.html#14925">[ subject ]</a>
              <a href="author.html#14925">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/04/2017 7:52 p.m., FredB wrote:
&gt;<i> Hello, 
</I>&gt;<i> 
</I>&gt;<i> I'm debugging e2guardian and I found something in squid log the X-forwarwed IP seems not always recorded? I saw nothing particular with tcpdumd so I made a change in code (e2guardian) to show the header passed 
</I>&gt;<i> 
</I>&gt;<i> ------------------- With problem -------------
</I>&gt;<i> E2 Debug:
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: Client: 192.168.0.5 START-------------------------------
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: CONNECT avissec.centprod.com:443 HTTP/1.0
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: Connection: close
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: Connection: keep-alive
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: Host: avissec.centprod.com
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: Proxy-Authorization: Digest username=&quot;test&quot;, realm=&quot;PROXY&quot;, nonce=&quot;RS/rWAAAAADwSIzYAQAAADkmpUgAAAA&quot;, uri=&quot;avissec.centprod.com:443&quot;, response=&quot;b02fa966d373a2aaf06c43bc24a180b2&quot;, qop=auth, nc=00000001, cnonce=&quot;750b04766a809d18&quot;
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: OUT: Client IP at 192.168.0.5 header: X-Forwarded-For: 192.168.0.5
</I>&gt;<i> Apr 10 09:07:49 proxytest1 e2guardian[27726]: Client: 192.168.0.5 END-------------------------------
</I>&gt;<i>  
</I>&gt;<i> Squid log:
</I>&gt;<i> 127.0.0.1 - test [10/Apr/2017:09:07:54 +0200] &quot;CONNECT avissec.centprod.com:443 HTTP/1.1&quot; 200 33960 451 TCP_TUNNEL:HIER_DIRECT &quot;Mozilla/5.0 (Windows NT 6.3; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0&quot;
</I>&gt;<i> -------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> -------------------- Without problem ------
</I>&gt;<i> 
</I>&gt;<i> E2:
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: Client: 192.16.0.2 START-------------------------------
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: CONNECT 0.client-channel.google.com:443 HTTP/1.0
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: Connection: close
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: Connection: keep-alive
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: Host: 0.client-channel.google.com
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: Proxy-Authorization: Digest username=&quot;test&quot;, realm=&quot;PROXY&quot;, nonce=&quot;NC/rWAAAAAAgRqZUAQAAAKXVAHcAAAA&quot;, uri=&quot;0.client-channel.google.com:443&quot;, response=&quot;ec5d46ce223d987f95393e2a35557bd0&quot;, qop=auth, nc=00000036, cnonce=&quot;877bd5e852b857c5&quot;
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: OUT: Client IP at 192.16.0.2 header: X-Forwarded-For: 192.16.0.2
</I>&gt;<i> Apr 10 09:07:45 proxytest1 e2guardian[27726]: Client: 192.16.0.2 END-------------------------------
</I>&gt;<i> 
</I>&gt;<i> Squid log:
</I>&gt;<i> 192.16.0.2 - test [10/Apr/2017:09:07:16 +0200] &quot;CONNECT 0.client-channel.google.com:443 HTTP/1.0&quot; 200 62701 486 TCP_TUNNEL:HIER_DIRECT &quot;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0&quot;
</I>&gt;<i> 
</I>
When doing this debugging *the* most critical thing is to get the
correlation between logs correct.

a) e2guardian records are not loggig their UTC offset. Your correlation
may be off by up to 4 hrs judging by the Squid offset.

b) you are not logging milliseconds in either log. Since transactions
can take place fully within 1ms that is important, or you will in
best-case be off in the logs by 1 second (over 2000 requests).

c) you are not logging duration for any of these transactions. Since
Squid logs on completion that means these transactions may be off by up
to a week, or when you last restarted Squid - whichever is smaller.

 - at the very least esure e2guardian is logging on send to Squid and
have Squid log the %tr value.


So in aggregate the above Squid log entry may be for any request
e2guardian logged in the 1 week 4 hours 1 seconds beforehand.

(Realistically its only in the time since you restarted e2guardian or
Squid, but taking it to the extreme there I hope demonstrates the
reasons Squid does not log in human local time - and no other program
recording machine activity should either.)


&gt;<i> ------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> This not related with user, the same machine have no problem at all every day but sometime one request is logged as 127.0.0.1, of course exactly the same request have not problem at another time.
</I>
Until you fix the above correlation issue your statement of &quot;exact same
request&quot; is not possible to be known.

&gt;<i> More strange there is no problem at all with HTTP requests, only HTTPS
</I>&gt;<i> 
</I>&gt;<i> I'm not using SSLBump just basic proxy chaining 
</I>&gt;<i> 
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> logformat mylog %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st %&gt;st %Ss:%Sh &quot;%{User-Agent}&gt;h&quot;
</I>&gt;<i> access_log stdio:/var/log/squid/access.log mylog
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> logfile_daemon /var/log/squid/log_file_daemon
</I>&gt;<i> log_icp_queries off
</I>&gt;<i> shutdown_lifetime 1 second
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /home/squid
</I>&gt;<i> 
</I>&gt;<i> pid_filename /var/run/squid.pid
</I>&gt;<i> 
</I>&gt;<i> follow_x_forwarded_for allow all
</I>
This is extremely dangerous. Any client can send an X-Forwarded-For
header and have Squid trust it. See
&lt;<A HREF="http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/">http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/</A>&gt; for more
details, pay attention to the &quot;SECURITY CONSIDERATIONS&quot; note.

The proper use of this directive is to create a src ACL that matches the
IPs Squid is supposed to be directly receiving traffic from. Then *only*
allow traffic matching that ACL to be 'followed'. As per the config
example in that documentation page.

As far as I know right now that ACL should only contain the IP
address(es) used by your e2guardian to send to Squid.


NP: When you are adjusting the e2guardian logs you may also want to
record the X-Forwaded-For headers so it records the details this
directive is trying to cope with.


&gt;<i> forwarded_for off
</I>&gt;<i> cache_store_log none
</I>&gt;<i> buffered_logs on
</I>&gt;<i> 
</I>&gt;<i> request_header_access X-Forwarded-For deny all
</I>&gt;<i> request_header_access Via deny all
</I>&gt;<i> 
</I>
FYI, the above two line are a complex and slow way of performing:

 forwarded_for delete
 via off

... especially bad since your earlier use of &quot;forwarded_for off&quot; is
expicitly adding an &quot;X-Forwarded-For: unknown&quot; header to outgoing
request traffic.


&gt;<i> acl_uses_indirect_client on
</I>&gt;<i> log_uses_indirect_client on
</I>&gt;<i> client_db off
</I>&gt;<i> half_closed_clients off
</I>&gt;<i> quick_abort_min 0 KB
</I>&gt;<i> quick_abort_max 0 KB
</I>&gt;<i> 
</I>&gt;<i> Perhaps 2/5 % of requests are wrong. 
</I>&gt;<i> 
</I>&gt;<i> What do you think, I open a bug ticket ?
</I>
Firstly fix your squid.conf and your logging. The re-evaluate.

One other thing to consider is whether the '127.0.0.1' request is an
internal request being made by e2guardian or Squid, or some service on
the Squid machine. If it can be tracked down to any of those cases -
then it is not a bug.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014923.html">[squid-users] Squid 3.5.23 X-forwader and log bug ?
</A></li>
	<LI>Next message (by thread): <A HREF="014924.html">[squid-users] Squid Redirection Scripting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14925">[ date ]</a>
              <a href="thread.html#14925">[ thread ]</a>
              <a href="subject.html#14925">[ subject ]</a>
              <a href="author.html#14925">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
