<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.15 - ERR_CONNECTION_REFUSED while accessing blocked non-HTTPS pages.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.15%20-%20ERR_CONNECTION_REFUSED%20while%0A%20accessing%20blocked%20non-HTTPS%20pages.&In-Reply-To=%3Cc6e4918d-3a93-19ac-4ecb-feeca7208585%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014939.html">
   <LINK REL="Next"  HREF="014943.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.15 - ERR_CONNECTION_REFUSED while accessing blocked non-HTTPS pages.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.15%20-%20ERR_CONNECTION_REFUSED%20while%0A%20accessing%20blocked%20non-HTTPS%20pages.&In-Reply-To=%3Cc6e4918d-3a93-19ac-4ecb-feeca7208585%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.15 - ERR_CONNECTION_REFUSED while accessing blocked non-HTTPS pages.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 12 16:17:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014939.html">[squid-users] Squid 3.5.15 - ERR_CONNECTION_REFUSED while accessing blocked non-HTTPS pages.
</A></li>
        <LI>Next message (by thread): <A HREF="014943.html">[squid-users] [RFC] Changes to http_access defaults
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14941">[ date ]</a>
              <a href="thread.html#14941">[ thread ]</a>
              <a href="subject.html#14941">[ subject ]</a>
              <a href="author.html#14941">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>SSL-Bump featres in Squid are still very volatile. What appear to be
minor change can have big behaviour differences and security fixes
between any two releases. It is not worth anyones time (including yours)
re-debugging and re-fixing an older release for things that have already
been fixed.

So, Rule #1 when using those features is to follow new releases. If any
problems are encountered try the very latest to see if it is fixed.
Today that is 3.5.25, or if 3.5 is still affected the 4.0.19 beta.


On 13/04/2017 2:24 a.m., Irakli Gobejishvili wrote:
&gt;<i> Hello everyone.
</I>&gt;<i> 
</I>&gt;<i> I am successfully filtering HTTPS traffic with intercept/PBR setup and
</I>&gt;<i> users get my custom ERR_ACCESS_DENIED page from Squid. Permitted pages
</I>&gt;<i> (both HTTP/HTTPS) also work absolutely fine.
</I>&gt;<i> 
</I>&gt;<i> The problem is, when users try to access filtered page with HTTP request,
</I>&gt;<i> then they get ERR_CONNECTION_REFUSED in their browsers, instead of seeing
</I>&gt;<i> that custom deny page and I see nothing in access.log, as if Squid never
</I>&gt;<i> even got the request. If I remove that domain from deny ACL or access it
</I>&gt;<i> via HTTPS, then it works fine and can be seen in access.log. What can I do
</I>&gt;<i> to fix this?
</I>
What is the exact traffic behaviour that is going on?

&quot;filtering HTTPS traffic with intercept/PBR setup&quot; tells us nothing
about the tiny but critical input details that the security systems huge
differences in correct vs wrong behaviour hinge on.

 and what do you think Squid is doing in reaction to that?



&gt;<i> 
</I>&gt;<i> Relevant fragment from configuration:
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> reply_header_access Alternate-Protocol deny all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Ah, sure. Things can look like they are working well when you hide all
possible TLS/SSL errors from yourself (and the users).

Anything major could be going on and you simply not seeing it.


&gt;<i> 
</I>&gt;<i> acl BADSITES ssl::server_name &quot;/etc/squid/BADSITES&quot;
</I>&gt;<i> acl USERS src 10.10.80.0/24
</I>&gt;<i> 
</I>
Missing:
 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_Ports
 http_acecss deny !localhost manager

&gt;<i> http_access deny BADSITES USERS
</I>&gt;<i> http_access allow USERS
</I>&gt;<i> 
</I>
Missing:
 http_access deny all


&gt;<i> http_port 3128
</I>&gt;<i> https_port 3130 intercept ssl-bump connection-auth=off
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=8MB
</I>&gt;<i> cert=/etc/squid/ssl_cert/CA.pem
</I>&gt;<i> 
</I>
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014939.html">[squid-users] Squid 3.5.15 - ERR_CONNECTION_REFUSED while accessing blocked non-HTTPS pages.
</A></li>
	<LI>Next message (by thread): <A HREF="014943.html">[squid-users] [RFC] Changes to http_access defaults
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14941">[ date ]</a>
              <a href="thread.html#14941">[ thread ]</a>
              <a href="subject.html#14941">[ subject ]</a>
              <a href="author.html#14941">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
