<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3Cf15c4b67-8462-4260-d7c7-1f8dbd3e9b97%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014955.html">
   <LINK REL="Next"  HREF="014959.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS woes</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3Cf15c4b67-8462-4260-d7c7-1f8dbd3e9b97%40gmail.com%3E"
       TITLE="[squid-users] HTTPS woes">yvoinov at gmail.com
       </A><BR>
    <I>Thu Apr 13 18:00:48 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014955.html">[squid-users] HTTPS woes
</A></li>
        <LI>Next message (by thread): <A HREF="014959.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14956">[ date ]</a>
              <a href="thread.html#14956">[ thread ]</a>
              <a href="subject.html#14956">[ subject ]</a>
              <a href="author.html#14956">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

13.04.2017 22:57, Olly Lennox &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi There,
</I>&gt;<i>
</I>&gt;<i> I've been battling for the last few days on a little project to setup a Raspberry PI device as a small parental blocking server. I've managed to configure the device to work as a transparent proxy using squid which is assigned as the default gateway via DHCP and after a lot of messing about I've finally got to the point where it's routing traffic correctly, proxying and blocking unwanted websites over HTTP.
</I>&gt;<i>
</I>&gt;<i> The problem I have is that for the life of me I cannot get things to work over HTTPS. It's working over the older, insecure web browsers where anything goes but the more modern browsers will not accept the SSL certificates and fail with insecure messages. I've tried various ways of generating a cert and also generating a CA cert and signing my other cert with it to no avail. I've had a mixture of errors back from the browser from WEAK_ALGORITHM to BAD_AUTHORITY to INVALID_CERT.
</I>&gt;<i>
</I>&gt;<i> I've been using openssl to generate self-signed certificates and create a der file. Below is a recent attempt but I've tried lots of different approaches:
</I>&gt;<i>
</I>&gt;<i> ------------
</I>&gt;<i> openssl req -x509 -nodes -sha256 -days 3650 -newkey rsa:2048 -keyout squid.key -out squid.crt 
</I>&gt;<i> openssl req -new -x509 -key squid.key -out squid.pem 
</I>&gt;<i> openssl x509 -in squid.pem -inform pem -out squid.der -outform der
</I>&gt;<i> ------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Then my config in Squid is like this, the dhparams file I generated as per instructions in the squid wiki:
</I>First of all: what's Squid's version?
&gt;<i>
</I>&gt;<i> ------------
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.crt key=/etc/squid3/ssl_cert/squid.key options=NO_SSLv3 dhparams=/etc/squid3/ssl_cert/dhparam.pem 
</I>You squid's built with interception support? show squid -v output.
&gt;<i>
</I>&gt;<i> ssl_bump server-first all 
</I>This  ^^^^^^^^^^^^^^^^^^^^^ option valid only up to Squid 3.4. If you
using 3.5.x, you should use new peek-n-splice rules.
&gt;<i> sslproxy_cert_error allow all 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER 
</I>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Don't do this. Never. This force
squid to ignore (and hide) all security issues with SSL from user and
from you.
&gt;<i> sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS 
</I>&gt;<i>
</I>&gt;<i> ------------
</I>&gt;<i>
</I>&gt;<i> The only routing rules I'm using are to forward port 80/443 to 3128/2129 respectively and also a POST_ROUTING &quot;masquerade&quot; rule which I got from a guide (and I'm not sure I 100% understand!)
</I>80/443 should be NATed to squid's box on squid's box.
&gt;<i>  
</I>&gt;<i>
</I>&gt;<i> Can anyone tell me where I'm going wrong? This is only for use on very small networks (home router + 2 or 3 trusted devices and users) so security between the rPI and the client is not a major concern - I just want it to work in the most simple and foolproof way possible.
</I>You doing wrong only one: you not give any important to resolve issue
information.
At least squid's version and build options.
&gt;<i>
</I>&gt;<i> Any advice would be very welcome.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Olly
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
</I>&gt;<i> lennox-it.uk
</I>&gt;<i> tel: 07900 648 252
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
Bugs to the Future
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170414/2facccdb/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170414/2facccdb/attachment.key</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 473 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170414/2facccdb/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170414/2facccdb/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014955.html">[squid-users] HTTPS woes
</A></li>
	<LI>Next message (by thread): <A HREF="014959.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14956">[ date ]</a>
              <a href="thread.html#14956">[ thread ]</a>
              <a href="subject.html#14956">[ subject ]</a>
              <a href="author.html#14956">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
