<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [squid-dev] [RFC] Changes to http_access defaults
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5Bsquid-dev%5D%20%5BRFC%5D%20Changes%20to%20http_access%20defaults&In-Reply-To=%3Cb5848e92-cce4-83c8-ef86-9b0811833ee9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014964.html">
   <LINK REL="Next"  HREF="014977.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [squid-dev] [RFC] Changes to http_access defaults</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5Bsquid-dev%5D%20%5BRFC%5D%20Changes%20to%20http_access%20defaults&In-Reply-To=%3Cb5848e92-cce4-83c8-ef86-9b0811833ee9%40treenet.co.nz%3E"
       TITLE="[squid-users] [squid-dev] [RFC] Changes to http_access defaults">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Apr 14 13:15:38 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014964.html">[squid-users] [squid-dev] [RFC] Changes to http_access defaults
</A></li>
        <LI>Next message (by thread): <A HREF="014977.html">[squid-users] [RFC] Changes to http_access defaults
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14968">[ date ]</a>
              <a href="thread.html#14968">[ thread ]</a>
              <a href="subject.html#14968">[ subject ]</a>
              <a href="author.html#14968">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/04/2017 1:15 p.m., Alex Rousskov wrote:
&gt;<i> On 04/12/2017 12:16 PM, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Changes to http_access defaults
</I>&gt;<i> 
</I>&gt;<i> Clearly stating what you are trying to accomplish with these changes may
</I>&gt;<i> help others evaluate your proposal. Your initial email focuses on _how_
</I>&gt;<i> you are going to accomplish some implied/vague goal. What is the goal here?
</I>&gt;<i> 
</I>
I've have two goals here:

1) reduce peoples ability to shoot themselves in the foot.

 This is an ongoing problem with newbies and even with more experienced
naive people.
 But there are some few cases where foot shooting is the local sport and
we have to let it happen.


2) further reduce the things people are required to manually configure
in squid.conf to get a usable Squid.

Telling people where to put their custom rules in relation to these
settings is getting to be a rather monotonous problem.

ALso, sometimes it is not easy to find the right words to describe the
location when language/knowledge barriers or previous screwing up of
squid.conf contents gets in the way.


I have the idea that we can do this porposal or something equivalent to
get rid of these problems with a technical fix for the long-term.

&gt;<i> 
</I>&gt;&gt;<i> I have become convinced that Squid always checks those
</I>&gt;&gt;<i> security rules, then do the custom access rules. All other orderings
</I>&gt;&gt;<i> seem to have turned out to be problematic and security-buggy in some
</I>&gt;&gt;<i> edge cases or another.
</I>&gt;<i> 
</I>&gt;<i> s/Squid always checks/Squid should always check/
</I>&gt;<i> 
</I>
Oops. Yes. Thank you for that.

&gt;<i> 
</I>&gt;&gt;<i> What are peoples opinions about making the following items built-in
</I>&gt;&gt;<i> defaults?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  acl Safe_ports port 21 80 443
</I>&gt;&gt;<i>  acl CONNECT_ports port 443
</I>&gt;&gt;<i>  acl CONNECT method CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  http_acces deny !Safe_ports
</I>&gt;&gt;<i>  http_access deny CONNECT !CONNECT_ports
</I>&gt;<i> 
</I>&gt;&gt;<i> The above change will have some effect on installations that try to use
</I>&gt;&gt;<i> an empty squid.conf.
</I>&gt;<i> 
</I>&gt;<i> And on many other existing installations, of course, especially on those
</I>&gt;<i> with complex access rules which are usually the most difficult to
</I>&gt;<i> modify/adjust. In other words, this is a pretty serious change.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> If the proposal goes ahead some extra additions
</I>&gt;&gt;<i> would be included to retain that default-reject behaviour.
</I>&gt;<i> 
</I>&gt;<i> It is difficult to properly evaluate your proposal until it details how
</I>&gt;<i> one would be able to override the proposed defaults.
</I>
Okay. As I mentioned to yuri's post:

 acl Safe_ports port 0-65535
 acl CONNECT_ports port 0-65535


NP: s/CONNECT_pors/SSL_ports/ depending on whether the name change there
happens or not. I had initially the idea that detecting the SSL_ports
existence as a way to determine between old and new configs. Similar to
the deny_unsafe_ports approach you propose below.


&gt;<i> These defaults, in
</I>&gt;<i> some shape or form, make sense for most installations, of course. The
</I>&gt;<i> difficult parts are:
</I>&gt;<i> 
</I>&gt;<i> * minimizing surprises (e.g, when the hidden defaults change, are wrong,
</I>&gt;<i> and/or interact with deny_info rules in surprising ways);
</I>&gt;<i> 
</I>&gt;<i> * avoiding configurations that compute essentially the same rules
</I>&gt;<i> multiple times (hidden defaults + explicit defaults); and
</I>&gt;<i> 
</I>&gt;<i> * designing a configuration approach to overwrite defaults without
</I>&gt;<i> either screwing up a lot of admins or virtually eliminating the positive
</I>&gt;<i> effect of those defaults in new configurations.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> To address the last bullet, we could add a
</I>&gt;<i> 
</I>&gt;<i>   deny_unsafe_ports &lt;on|off&gt;
</I>&gt;<i> 
</I>&gt;<i> directive.
</I>&gt;<i> 
</I>&gt;<i> If that directive is &quot;on&quot; by default [for any squid.conf that does not
</I>&gt;<i> define a Safe_ports ACL??], then it does not address the first two
</I>&gt;<i> bullets well.
</I>&gt;<i> 
</I>&gt;<i> Perhaps it should be off by default but explicitly added (and turned
</I>&gt;<i> &quot;on&quot;) to every newly generated squid.conf.default?
</I>&gt;<i> 
</I>
If it is on by default unless we have reason to turn it off, we have
trouble with all the intentional open-proxy or similar configs.

If it is off by default unless we have reason to turn it on. That does
not help at all for newbie admin installs which most need it to be on by
default.


With Safe_ports being a default too, the detect would have to be based
on SSL_ports. In which case, we may as well use an internal boolean
check for SSL_ports as the detection of old installation instead of
putting anything confusing in front of newbie admin.
 - this will also catch the case of newbie cut-n-pasting old configs.

However, that still leaves us with trouble for all the intentional
open-proxy or similar configs. They will still have surprise blocking of
unsafe traffic until config gets adjusted.

&gt;<i> 
</I>&gt;<i> Also, how will the http_access rules in newly generated
</I>&gt;<i> squid.conf.default look like if we add default http_access rules?
</I>&gt;<i> 
</I>
I expect it would look like it does now but without the top two deny rules:

  http_access allow localhost manager
  http_access deny manager

  #
  # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
  #

  http_access allow localnet
  http_access allow localhost
  http_access deny all


&gt;<i> 
</I>&gt;<i> I am worried that adding hidden default http_access rules will make
</I>&gt;<i> things overall worse rather than solving the problem you are trying to
</I>&gt;<i> solve. I wonder if fiddling with http_access internals might be the
</I>&gt;<i> wrong direction here.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>
Noted. Thank you for the feedback.

Amos



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014964.html">[squid-users] [squid-dev] [RFC] Changes to http_access defaults
</A></li>
	<LI>Next message (by thread): <A HREF="014977.html">[squid-users] [RFC] Changes to http_access defaults
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14968">[ date ]</a>
              <a href="thread.html#14968">[ thread ]</a>
              <a href="subject.html#14968">[ subject ]</a>
              <a href="author.html#14968">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
