<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C1779924576.2690948.1492525040924%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015006.html">
   <LINK REL="Next"  HREF="015008.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS woes</H1>
    <B>Olly Lennox</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C1779924576.2690948.1492525040924%40mail.yahoo.com%3E"
       TITLE="[squid-users] HTTPS woes">oliver at lennox-it.uk
       </A><BR>
    <I>Tue Apr 18 14:17:20 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015006.html">[squid-users] HTTPS woes
</A></li>
        <LI>Next message (by thread): <A HREF="015008.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15007">[ date ]</a>
              <a href="thread.html#15007">[ thread ]</a>
              <a href="subject.html#15007">[ subject ]</a>
              <a href="author.html#15007">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Yuri! The Mozilla Bundle has worked!! Most of the major sites seem to be working which is all we need. How often do these certificates refresh? Would they need updating every month or so?&#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
lennox-it.uk
tel: 07900 648 252

      From: Yuri Voinov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt;
 To: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;; &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
 Sent: Tuesday, 18 April 2017, 14:43
 Subject: Re: [squid-users] HTTPS woes
   
 You talked about two different things. 1. root CA usually built-in in clients. For standalone use, root CA (from Mozilla) usually distributes with openssl distributions. If you need (or your openssl distribution does not contains root CAs), you can find separately distributed Mozilla CA's by short googling: 
  <A HREF="https://www.google.com/search?q=Mozilla+CA+bundle">https://www.google.com/search?q=Mozilla+CA+bundle</A> 2. Intermediate CA's is subordinate for roots CA. It does not exists by gouverned repository (because of supporting it is work, manual work and should be do by somebody), moreover, it spreaded across CA authorities. There is no automated tool to support this _intermediate_list. The problem also: intermediate CA's usuallu has much short validity period instead of roots, and should supports all time at time. Finally - it you want to use Squid with SSL Bump, you should understand PKI infrastructure and yes - you should support root CA &amp; intermediate CAs on proxy by yourself all time. There is no free or payment basis service which is do it for you.
  
 18.04.2017 19:35, Olly Lennox &#1087;&#1080;&#1096;&#1077;&#1090;:
  
  So anyone who wants to use Squid over HTTPS in the way has to build this repository themselves by manually downloading all the CA bundles? &#160; 
  
 
        From: Yuri &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt;
 To: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;; &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
 Sent: Tuesday, 18 April 2017, 14:03
 Subject: Re: [squid-users] HTTPS woes
  
   
  
 18.04.2017 18:56, Olly Lennox &#1087;&#1080;&#1096;&#1077;&#1090;:
  
  I'm using&#160; 
  sslproxy_foreign_intermediate_certs 
  Is this the same thing? 
   
 No. You firstly required CA roots available for squid. CA roots and intermediate is the different things.
 
  
  Also is there anywhere to get a bundle of all the major CA intermdiate certs or do you have to download them all manually?  
 No. You should build it by yourself. 
 
  
  Cheers, &#160; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
 lennox-it.uk
 tel: 07900 648 252 
 
         From: Yuri &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt;
 To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
 Sent: Tuesday, 18 April 2017, 13:51
 Subject: Re: [squid-users] HTTPS woes
  
 Try to specify roots CA bundle/dir explicity by specifying one of this 
 params:
 
 
 #&#160; TAG: sslproxy_cafile
 #&#160; &#160; file containing CA certificates to use when verifying server
 #&#160; &#160; certificates while proxying <A HREF="https://">https://</A> URLs
 #Default:
 # none
 
 #&#160; TAG: sslproxy_capath
 #&#160; &#160; directory containing CA certificates to use when verifying
 #&#160; &#160; server certificates while proxying <A HREF="https://">https://</A> URLs
 #Default:
 # none
 
 
 
 18.04.2017 18:46, Olly Lennox &#1087;&#1080;&#1096;&#1077;&#1090;:
 &gt; Hi All,
 &gt;
 &gt; Still having problems here. This is my https config now:
 &gt;
 &gt;
 &gt; ---------------------------------https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.crt  key=/etc/squid3/ssl_cert/squid.key options=NO_SSLv3 dhparams=/etc/squid3/ssl_cert/dhparam.pem
 &gt;
 &gt; acl step1 at_step SslBump1
 &gt; ssl_bump peek step1
 &gt; ssl_bump bump all
 &gt; sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
 &gt; sslproxy_cipherEECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
 &gt;
 &gt; sslcrtd_program /usr/lib/squid3/ssl_crtd -s /var/lib/ssl_db -M 4MB
 &gt; sslcrtd_children 8 startup=1 idle=1
 &gt;
 &gt; ---------------------------------
 &gt;
 &gt;
 &gt; I'm running version 3.5.23 with openssl 1.0. I've had to disable libecap because I couldn't build 3.5  with ecap enabled. I'm getting the following error when trying to connect with SSL:
 &gt;
 &gt; ---------------------------------
 &gt;
 &gt; The following error was encountered while trying to retrieve the URL: <A HREF="https://www.google.co.uk/*">https://www.google.co.uk/*</A>
 &gt;
 &gt; Failed to establish a secure connection to 216.58.198.67
 &gt;
 &gt; The system returned:
 &gt;
 &gt; (71) Protocol error (TLS code:X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
 &gt; SSL Certficate error: certificate issuer (CA) not known: /C=US/O=Equifax/OU=Equifax Secure  Certificate Authority
 &gt;
 &gt; This proxy and the remote host failed to negotiate a mutually acceptable security settings for  handling your request. It is possible that the remote host does not support secure connections, or the proxy is not satisfied with the host security credentials.
 &gt;
 &gt; Your cache administrator is webmaster.
 &gt;
 &gt; Generated Tue, 18 Apr 2017 12:23:40 GMT by raspberrypi (squid/3.5.23)
 &gt; ---------------------------------
 &gt;
 &gt; The CA is always listed as not known not matter what site I try I always get this error.
 &gt;
 &gt; Any ideas?
 &gt;
 &gt; Thanks,
 &gt;
 &gt; Olly
 &gt;
 &gt; ________________________________
 &gt; From: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;
 &gt; To: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;; &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
 &gt; Sent: Sunday, 16 April 2017, 9:31
 &gt; Subject: Re: [squid-users] HTTPS woes
 &gt;
 &gt;
 &gt;
 &gt; Thanks Amos, it's finally built but I had to disabled ecap, for whatever reason this kept failing  (with version 1.0.1 installed). It failed on a reference to the Area function I think but I don't have the error message copied. I'm trying now to configure the ssl stare/peek  and will let you know how it goes.
 &gt;
 &gt; Olly
 &gt;&#160; 
 &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
 &gt; lennox-it.uk
 &gt; tel: 07900 648 252
 &gt;
 &gt;
 &gt;
 &gt; ________________________________
 &gt; From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
 &gt; To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 &gt; Sent: Saturday, 15 April 2017, 23:07
 &gt; Subject: Re: [squid-users] HTTPS woes
 &gt;
 &gt;
 &gt;
 &gt; On 15/04/2017 9:59 a.m., Olly Lennox wrote:
 &gt;&gt; Hi Guys.
 &gt;&gt; I'm still struggling with this. I'm trying to build a version of 3.5 but I just can't get it to  work. I'm currently attempting to rebuild the stretch package with SSL enabled but build keeps failing with the following:
 &gt;&gt; ../../src/ssl/gadgets.h:83:45: error: &#226;CRYPTO_LOCK_X509&#226; was not declared in this scope typedef LockingPointer&lt;X509, X509_free_cpp, CRYPTO_LOCK_X509&gt; X509_Pointer;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^~~~~~~~~~~~~~~~../../src/ssl/gadgets.h:83:61: error: template argument 3 is  invalid typedef LockingPointer&lt;X509, X509_free_cpp, CRYPTO_LOCK_X509&gt; X509_Pointer;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^../../src/ssl/gadgets.h:89:53: error: &#226;CRYPTO_LOCK_EVP_PKEY&#226; was not declared in this scope typedef LockingPointer&lt;EVP_PKEY, EVP_PKEY_free_cpp, CRYPTO_LOCK_EVP_PKEY&gt; EVP_PKEY_Pointer;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^~~~~~~~~~~~~~~~~~~~../../src/ssl/gadgets.h:89:73: error: template argument 3 is  invalid typedef LockingPointer&lt;EVP_PKEY, EVP_PKEY_free_cpp, CRYPTO_LOCK_EVP_PKEY&gt; EVP_PKEY_Pointer;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^../../src/ssl/gadgets.h:116:43: error: &#226;CRYPTO_LOCK_SSL&#226; was not declared in this scope typedef LockingPointer&lt;SSL, SSL_free_cpp, CRYPTO_LOCK_SSL&gt; SSL_Pointer;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^~~~~~~~~~~~~~~../../src/ssl/gadgets.h:116:58: error: template argument 3 is  invalid typedef LockingPointer&lt;SSL, SSL_free_cpp, CRYPTO_LOCK_SSL&gt; SSL_Pointer;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^
 &gt;&gt; Any ideas?
 &gt;
 &gt;
 &gt; On Jesse/stable:
 &gt;
 &gt; apt-get build-dep squid3
 &gt; apt-get install libss-dev
 &gt;
 &gt;
 &gt; On stretch/testing/unstable:
 &gt;
 &gt; apt-get build-dep squid
 &gt; apt-get install libss1.0-dev
 &gt;
 &gt;
 &gt; That should do it for you.
 &gt;
 &gt; Amos
 &gt;
 &gt;
 &gt; _______________________________________________
 &gt; squid-users mailing list
 &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
 &gt;
 &gt;
 &gt;
 &gt; _______________________________________________
 &gt; squid-users mailing list
 &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> 
 &gt; _______________________________________________
 &gt; squid-users mailing list
 &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
 
 
_______________________________________________
 squid-users mailing list
 <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
 <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
   
 
      
 
    
 
      
 
 -- 
 Bugs to the Future 

   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170418/88600b4e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170418/88600b4e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015006.html">[squid-users] HTTPS woes
</A></li>
	<LI>Next message (by thread): <A HREF="015008.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15007">[ date ]</a>
              <a href="thread.html#15007">[ thread ]</a>
              <a href="subject.html#15007">[ subject ]</a>
              <a href="author.html#15007">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
