<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C2043293620.4077015.1492642124107%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015025.html">
   <LINK REL="Next"  HREF="015027.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS woes</H1>
    <B>Olly Lennox</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C2043293620.4077015.1492642124107%40mail.yahoo.com%3E"
       TITLE="[squid-users] HTTPS woes">oliver at lennox-it.uk
       </A><BR>
    <I>Wed Apr 19 22:48:44 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015025.html">[squid-users] HTTPS woes
</A></li>
        <LI>Next message (by thread): <A HREF="015027.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15026">[ date ]</a>
              <a href="thread.html#15026">[ thread ]</a>
              <a href="subject.html#15026">[ subject ]</a>
              <a href="author.html#15026">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Raspberry Pi (3) / Stretch repository (requird to build 3.5) / Squid  3.5.23

After further investigation the problem is something to do with permissions related to ssl_crtd. I can run squid as root but using the default account (proxy?) it won't run and is giving this error in cache.log:

2017/04/19 23:43:54 kid1| helperOpenServers: Starting 1/8 'ssl_crtd' processes
FATAL: Ipc::Mem::Segment::open failed to shm_open(/squid-ssl_session_cache.shm): (2) No such file or directory


I've checked the file and folder permissions across all aspects of squid and everything I can see is owned by proxy:proxy so not sure where it is failing. My config is now as follows:


acl SSL_ports port 443 
acl Safe_ports port 80        # http 
acl Safe_ports port 21        # ftp 
acl Safe_ports port 443        # https 
acl Safe_ports port 70        # gopher 
acl Safe_ports port 210        # wais 
acl Safe_ports port 1025-65535    # unregistered ports 
acl Safe_ports port 280        # http-mgmt 
acl Safe_ports port 488        # gss-http 
acl Safe_ports port 591        # filemaker 
acl Safe_ports port 777        # multiling http 
acl CONNECT method CONNECT 

http_access deny !Safe_ports 
http_access deny CONNECT !SSL_ports 
http_access allow all 

http_port 3130 

http_port 3128 intercept 
https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.crt key=/etc/squid3/ssl_cert/squid.key options=NO_SSLv3 dhparams=/etc/squid3/ssl_cert/dhparam.pem 

acl step1 at_step SslBump1 
ssl_bump peek step1 
ssl_bump bump all 
sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE 
sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS 
sslproxy_cafile /etc/squid/ssl_cert/mozcacert.pem 

sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/spool/squid_ssldb -M 4MB 
sslcrtd_children 8 startup=1 idle=1 

coredump_dir /var/spool/squid 

# Add any of your own refresh_pattern entries above these. 
refresh_pattern ^ftp:        1440    20%    10080 
refresh_pattern ^gopher:    1440    0%    1440 
refresh_pattern -i (/cgi-bin/|\?) 0    0%    0 
refresh_pattern .        0    20%    4320 

cache_dir ufs /cache 400 16 256 



<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
lennox-it.uk
tel: 07900 648 252



________________________________
From: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
To: &quot;'<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.</A> org'&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt; 
Cc: 'Olly Lennox' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;; 'L. P. H. van Belle' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">belle at bazuin.nl</A>&gt;
Sent: Wednesday, 19 April 2017, 22:24
Subject: RE: [squid-users] HTTPS woes



What OS are you using?

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Olly Lennox
Sent: Wednesday, April 19, 2017 7:30 PM
To: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;; L. P. H. van Belle &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">belle at bazuin.nl</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.</A> org &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt;
Subject: Re: [squid-users] HTTPS woes

Sorry it's back,


I've narrowed down the problem, hopefully someone can help. When Squid starts it creates the directory /var/run/squid as user proxy:proxy. 

If I remove this or leave it as is then the application won't launch on subsequent reboots.

If I chown the directory as root:root then the application will launch on boot but proxy:proxy takes back ownership and it won't launch again on subsequent reboots.

I'm guessing this is something to do with the running processes, does anyone know what's going wrong?

Cheers,

Olly


------------




Never mind I've sorted it! The issue was due to the /var/run directory and the program not being able to create squid.pid. I amended the permissions and seems to be working fine now


Thanks a lot for the link, I'll implement that once I get this problem fixed. Sadly the change hasn't worked. My current /etc/fstab looks like this:


proc            /proc           proc    defaults          0       0 
PARTUUID=0d001852-01  /boot           vfat    defaults          0       2 
PARTUUID=0d001852-02  /               ext4    defaults,noatime  0       1 
# a swapfile is not a swap partition, no line here 
#   use  dphys-swapfile swap[on|off]  for that 
tmpfs /cache tmpfs defaults,noatime,nosuid,size=8000m 0 0 
none      /dev/shm        tmpfs  defaults        0 0 

could the existing tmpfs line be causing problems?

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
lennox-it.uk
tel: 07900 648 252



________________________________
From: L. P. H.  van Belle &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">belle at bazuin.nl</A>&gt;
To: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.</A> org&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt; 
Sent: Wednesday, 19 April 2017, 11:05
Subject: Re: [squid-users] HTTPS woes



Hai, 


Im guess, squid is starting to soon, or there is not /dev/shm 


Check/Try adding, if not already in /etc/fstab 


none      /dev/shm        tmpfs   defaults        0 0 


And reboot the server. 



Or, i dont know and someone else can tell you. ;-) 

But on my jessie with squid 3.5.24+ssl i dont see this problem. 


A small tip about the certificates on debian or ubuntu. 

Install ca-certificates ( apt-get install ca-certificates ) 

And read : <A HREF="https://www.brightbox.com/blog/2014/03/04/add-cacert-ubuntu-debian/">https://www.brightbox.com/blog/2014/03/04/add-cacert-ubuntu-debian/</A> 




Greetz, 


Louis








&gt;<i> -----Oorspronkelijk bericht-----
</I>
&gt;<i> Van: squid-users 
</I>
&gt;<i> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Olly Lennox
</I>
&gt;<i> Verzonden: woensdag 19 april 2017 11:22
</I>
&gt;<i> Aan: Amos Jeffries; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>
&gt;<i> Onderwerp: Re: [squid-users] HTTPS woes
</I>
&gt;<i> 
</I>
&gt;<i> Thanks Amos, I'll install this. One last question if I may! 
</I>
&gt;<i> Squid is working fine now with both HTTP and HTTPS but for 
</I>
&gt;<i> some reason it is refusing to launch on boot. 
</I>
&gt;<i> 
</I>
&gt;<i> It works perfectly when started with &quot;service squid start&quot; 
</I>
&gt;<i> but not boot. The error is:
</I>
&gt;<i> squid.service - LSB: Squid HTTP Proxy version 3.x
</I>
&gt;<i>    Loaded: loaded (/etc/init.d/squid; generated; vendor 
</I>
&gt;<i> preset: enabled)
</I>
&gt;<i>    Active: failed (Result: resources) since Wed 2017-04-19 
</I>
&gt;<i> 10:19:18 BST; 53s ago
</I>
&gt;<i>      Docs: man:systemd-sysv-generator(8)
</I>
&gt;<i>   Process: 598 ExecStart=/etc/init.d/squid start 
</I>
&gt;<i> (code=exited, status=0/SUCCESS)
</I>
&gt;<i> 
</I>
&gt;<i> Apr 19 10:19:13 raspberrypi (squid-1)[1606]: 
</I>
&gt;<i> Ipc::Mem::Segment::open failed to 
</I>
&gt;<i> shm_open(/squid-ssl_session_cache.shm): (2) No such file or 
</I>
&gt;<i> direct Apr 19 10:19:13 raspberrypi squid[1283]: Squid Parent: 
</I>
&gt;<i> (squid-1) process 1606 exited with status 1 Apr 19 10:19:16 
</I>
&gt;<i> raspberrypi squid[1283]: Squid Parent: (squid-1) process 1633 
</I>
&gt;<i> started Apr 19 10:19:18 raspberrypi squid[1283]: Squid 
</I>
&gt;<i> Parent: (squid-1) process 1633 exited with status 1 Apr 19 
</I>
&gt;<i> 10:19:18 raspberrypi squid[1283]: Squid Parent: (squid-1) 
</I>
&gt;<i> process 1633 will not be restarted due to repeated, frequent 
</I>
&gt;<i> failures Apr 19 10:19:18 raspberrypi squid[1283]: Exiting due 
</I>
&gt;<i> to repeated, frequent failures Apr 19 10:19:18 raspberrypi 
</I>
&gt;<i> systemd[1]: squid.service: Daemon never wrote its PID file. Failing.
</I>
&gt;<i> Apr 19 10:19:18 raspberrypi systemd[1]: Failed to start LSB: 
</I>
&gt;<i> Squid HTTP Proxy version 3.x.
</I>
&gt;<i> Apr 19 10:19:18 raspberrypi systemd[1]: squid.service: Unit 
</I>
&gt;<i> entered failed state.
</I>
&gt;<i> Apr 19 10:19:18 raspberrypi systemd[1]: squid.service: Failed 
</I>
&gt;<i> with result 'resources'.
</I>
&gt;<i> 
</I>
&gt;<i> Any ideas?
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> ________________________________
</I>
&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>
&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>
&gt;<i> Sent: Wednesday, 19 April 2017, 5:22
</I>
&gt;<i> Subject: Re: [squid-users] HTTPS woes
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> Olly,  Debian provides a ca-certificates package containing 
</I>
&gt;<i> the Mozilla CA list. It is updated whenever the CA set 
</I>
&gt;<i> changes. Though of course you should have apt connected to 
</I>
&gt;<i> the relevant security repository (jesse-security?) for 
</I>
&gt;<i> regular updates.
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> Amos
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> On 19/04/17 03:10, Olly Lennox wrote:
</I>
&gt;<i> 
</I>
&gt;<i> Would you mind sharing the script you use?
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
</I>
&gt;<i> &gt;lennox-it.uk
</I>
&gt;<i> &gt;tel: 07900 648 252
</I>
&gt;<i> &gt;
</I>
&gt;<i> 
</I>

_______________________________________________

squid-users mailing list

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>

<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015025.html">[squid-users] HTTPS woes
</A></li>
	<LI>Next message (by thread): <A HREF="015027.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15026">[ date ]</a>
              <a href="thread.html#15026">[ thread ]</a>
              <a href="subject.html#15026">[ subject ]</a>
              <a href="author.html#15026">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
