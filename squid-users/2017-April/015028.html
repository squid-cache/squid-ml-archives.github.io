<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C57862982.49199.1492644938626%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015027.html">
   <LINK REL="Next"  HREF="015029.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS woes</H1>
    <B>Olly Lennox</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C57862982.49199.1492644938626%40mail.yahoo.com%3E"
       TITLE="[squid-users] HTTPS woes">oliver at lennox-it.uk
       </A><BR>
    <I>Wed Apr 19 23:35:38 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015027.html">[squid-users] HTTPS woes
</A></li>
        <LI>Next message (by thread): <A HREF="015029.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15028">[ date ]</a>
              <a href="thread.html#15028">[ thread ]</a>
              <a href="subject.html#15028">[ subject ]</a>
              <a href="author.html#15028">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,


Thanks for your response. I can confirm that disabling the ssl sesison cache seems to have resolved the issue. I found another post which references this patch to resolve the issue:

<A HREF="http://www.squid-cache.org/Versions/v4/changesets/squid-4-13984.patch">http://www.squid-cache.org/Versions/v4/changesets/squid-4-13984.patch</A>

I've checked the source in main.cc and this seems quite different to what I have in 3.5.23 so I guess it would involve an upgrade to version 4? After the blood and tears I have gone through to get 3.5 working I don't think I'm read to make that leap yet!!

I check and the /dev/shm directory does exist with 777 permissions so from what I can see the OS should support it. I'm out of my depth here so maybe there is more to it but I can't see why squid couldn't write to this location. 
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
lennox-it.uk
tel: 07900 648 252



________________________________
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
To: &quot;'<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.</A> org'&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt; 
Cc: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;
Sent: Thursday, 20 April 2017, 0:13
Subject: Re: [squid-users] HTTPS woes



On 04/19/2017 04:48 PM, Olly Lennox wrote:

&gt;<i> After further investigation the problem is something to do with permissions related to ssl_crtd.
</I>
No, it is not (or at least not yet).


&gt;<i> I can run squid as root but using the default account (proxy?) it
</I>&gt;<i> won't run and is giving this error in cache.log:
</I>
&gt;<i> 2017/04/19 23:43:54 kid1| helperOpenServers: Starting 1/8 'ssl_crtd' processes
</I>&gt;<i> FATAL: Ipc::Mem::Segment::open failed to shm_open(/squid-ssl_session_cache.shm): (2) No such file or directory
</I>
The FATAL line is unrelated to the ssl_crtd line above it (this is one
of several problems with FATAL error handling in Squid).


&gt;<i> I've checked the file and folder permissions across all aspects of
</I>&gt;<i> squid and everything I can see is owned by proxy:proxy so not sure
</I>&gt;<i> where it is failing.
</I>
Squid is failing when trying to open a shared memory segment used for
storing SSL sessions. This probably means two things:

1. Your OS environment is not compatible with Squid shared memory needs
(e.g., missing /dev/shm/ or equivalent). More info at
<A HREF="http://wiki.squid-cache.org/Features/SmpScale#Ipc::Mem::Segment::create_failed_to_shm_open.28....29:_.282.29_No_such_file_or_directory">http://wiki.squid-cache.org/Features/SmpScale#Ipc::Mem::Segment::create_failed_to_shm_open.28....29:_.282.29_No_such_file_or_directory</A>

2. There is a bug in Squid: Squid should not create shared memory
segments when running in non-SMP mode. Please consider reporting this
bug if it has not been reported already. At the expense of losing SSL
session resumption capabilities, you should be able to work around this
bug by disabling the session cache:
<A HREF="http://www.squid-cache.org/Doc/config/sslproxy_session_cache_size/">http://www.squid-cache.org/Doc/config/sslproxy_session_cache_size/</A>


HTH,

Alex.



&gt;<i> acl SSL_ports port 443 
</I>&gt;<i> acl Safe_ports port 80        # http 
</I>&gt;<i> acl Safe_ports port 21        # ftp 
</I>&gt;<i> acl Safe_ports port 443        # https 
</I>&gt;<i> acl Safe_ports port 70        # gopher 
</I>&gt;<i> acl Safe_ports port 210        # wais 
</I>&gt;<i> acl Safe_ports port 1025-65535    # unregistered ports 
</I>&gt;<i> acl Safe_ports port 280        # http-mgmt 
</I>&gt;<i> acl Safe_ports port 488        # gss-http 
</I>&gt;<i> acl Safe_ports port 591        # filemaker 
</I>&gt;<i> acl Safe_ports port 777        # multiling http 
</I>&gt;<i> acl CONNECT method CONNECT 
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports 
</I>&gt;<i> http_access deny CONNECT !SSL_ports 
</I>&gt;<i> http_access allow all 
</I>&gt;<i> 
</I>&gt;<i> http_port 3130 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept 
</I>&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.crt key=/etc/squid3/ssl_cert/squid.key options=NO_SSLv3 dhparams=/etc/squid3/ssl_cert/dhparam.pem 
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1 
</I>&gt;<i> ssl_bump peek step1 
</I>&gt;<i> ssl_bump bump all 
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE 
</I>&gt;<i> sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS 
</I>&gt;<i> sslproxy_cafile /etc/squid/ssl_cert/mozcacert.pem 
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/spool/squid_ssldb -M 4MB 
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1 
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/spool/squid 
</I>&gt;<i> 
</I>&gt;<i> # Add any of your own refresh_pattern entries above these. 
</I>&gt;<i> refresh_pattern ^ftp:        1440    20%    10080 
</I>&gt;<i> refresh_pattern ^gopher:    1440    0%    1440 
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0 
</I>&gt;<i> refresh_pattern .        0    20%    4320 
</I>&gt;<i> 
</I>&gt;<i> cache_dir ufs /cache 400 16 256 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015027.html">[squid-users] HTTPS woes
</A></li>
	<LI>Next message (by thread): <A HREF="015029.html">[squid-users] HTTPS woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15028">[ date ]</a>
              <a href="thread.html#15028">[ thread ]</a>
              <a href="subject.html#15028">[ subject ]</a>
              <a href="author.html#15028">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
