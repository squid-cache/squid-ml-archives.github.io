<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C1853580132.454651.1492695550555%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015029.html">
   <LINK REL="Next"  HREF="014969.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS woes</H1>
    <B>Olly Lennox</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20woes&In-Reply-To=%3C1853580132.454651.1492695550555%40mail.yahoo.com%3E"
       TITLE="[squid-users] HTTPS woes">oliver at lennox-it.uk
       </A><BR>
    <I>Thu Apr 20 13:39:10 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015029.html">[squid-users] HTTPS woes
</A></li>
        <LI>Next message (by thread): <A HREF="014969.html">[squid-users] Squid proxy with ssl-bump - unrecognized: 'ssl-bump'	error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15032">[ date ]</a>
              <a href="thread.html#15032">[ thread ]</a>
              <a href="subject.html#15032">[ subject ]</a>
              <a href="author.html#15032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>After two and a bit weeks on this I finally have the Raspberry Pi working as a transparent proxy server utilising Diladele to provide web filtering. I'm going to trial it all for the next few weeks to ensure that it's stable but so far the results have been positive and its working with HTTP and HTTPS across Windows, IOS and Android devices. 

I wanted to say a big thank you to everyone who has responded to my many messages.I'm sure there will be more to come but I wouldn't have got this far without your help so thank you very much. 

FYI the following steps have been necessary:


HTTPS Squid on Raspberry Pi 3:
1. The stretch repositories are required to build squid 3.5 and should be enabled
2. after running apt-get update you should downgrade to openssl v1.0 (from v1.1) to avoid build failures
3. You must disable ecap functionality to avoid build failures, I couldn't get squid 3.5.23 to build with ecap regardless of the version of libecap I used.
4. download the 3.5.23 source from stretch and follow a guide online to configure, make, and install the packages with ssl and ssl_crtd enabled (careful with the flags if you're following a guide for an older version of squid as the syntax changed)
5. follow a guide online to install / configure squid 3.5 - specifically creating the cache folders and setting up ssl_crtd and the ssl cache
6. download the mozilla ca certs bundle (<A HREF="https://curl.haxx.se/ca/cacert.pem">https://curl.haxx.se/ca/cacert.pem</A> or google) which are required for HTTPS to work 
7. ensure sslproxy_session_cache_size is disabled (example config below). Squid will not load on boot with this setting enabled.

8. check permissions across your squid installation (specifically cache, ssl_crtd and cerificate cache/locations) to ensure the proxy:proxy account has access
9. be careful of the runtime directories which are used. The default location on Rpi is /squid3 but this approach will move everything in /squid so be sure that you use the right one in your config
10. Ensure you generate your self-signed CA certificate/key with SHA-256 (as a minimum) to avoid cert failures in the browser. 
11. Bear in mind that your CA certificate will need to be installed/trusted on any device that you wish to use HTTPS on the network

My Config:

acl SSL_ports port 443 
acl Safe_ports port 80        # http 
acl Safe_ports port 21        # ftp 
acl Safe_ports port 443        # https 
acl Safe_ports port 70        # gopher 
acl Safe_ports port 210        # wais 
acl Safe_ports port 1025-65535    # unregistered ports 
acl Safe_ports port 280        # http-mgmt 
acl Safe_ports port 488        # gss-http 
acl Safe_ports port 591        # filemaker 
acl Safe_ports port 777        # multiling http 
acl CONNECT method CONNECT 

http_access deny !Safe_ports 
http_access deny CONNECT !SSL_ports 
http_access allow all 

http_port 3130 
http_port 3128 intercept 
https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.crt key=/etc/squid3/ssl_cert/squid.key options=NO_SSLv3 

acl step1 at_step SslBump1 
ssl_bump peek step1 
ssl_bump bump all 
sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE 
sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS 
sslproxy_cafile /etc/squid/ssl_cert/mozcacert.pem 

sslproxy_session_cache_size 0 
sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/spool/squid_ssldb -M 4MB 
sslcrtd_children 8 startup=1 idle=1 

coredump_dir /var/spool/squid 

# Add any of your own refresh_pattern entries above these. 
refresh_pattern ^ftp:        1440    20%    10080 
refresh_pattern ^gopher:    1440    0%    1440 
refresh_pattern -i (/cgi-bin/|\?) 0    0%    0 
refresh_pattern .        0    20%    4320 

cache_dir ufs /cache 400 16 256 


----------------

It's worth noting that I could not get udhcpd to start on boot with the Raspberry Pi (which seemed to be the recommended DHCP server online) and had to switch to ISC to get DHCP to work. Bind works fine though and the Diladele filter also installed without a hitch so it's only really DHCP that can trip you up. 

Hope this helps someone

Olly

 
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>
lennox-it.uk
tel: 07900 648 252



________________________________
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
To: &quot;'<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.</A> org'&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt; 
Cc: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;
Sent: Thursday, 20 April 2017, 1:21
Subject: Re: [squid-users] HTTPS woes



On 04/19/2017 05:35 PM, Olly Lennox wrote:

&gt;<i> I can confirm that disabling the ssl sesison cache seems to have resolved the issue.
</I>
Great!


&gt;<i> I found another post which references this patch to resolve the issue:
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Versions/v4/changesets/squid-4-13984.patch">http://www.squid-cache.org/Versions/v4/changesets/squid-4-13984.patch</A>
</I>
I am not sure that patch is related to any issues I have talked about.
What &quot;another post&quot; did you find?


&gt;<i> I check and the /dev/shm directory does exist with 777 permissions so
</I>&gt;<i> from what I can see the OS should support it. I'm out of my depth
</I>&gt;<i> here so maybe there is more to it but I can't see why squid couldn't
</I>&gt;<i> write to this location.
</I>
Forget about my &quot;OS environment is not compatible&quot; theory (at least for
now). I now see that Squid is failing while trying to _open_ that memory
segment as opposed to failing while _creating_ it.

Did Squid try to create it? Set debug_options to &quot;ALL,3 54,9&quot; and search
for &quot;shm_&quot; and &quot;ssl_session_cache&quot; in cache.log for more clues.


Alex.



&gt;<i> ________________________________
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> To: &quot;'<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.</A> org'&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at squid-cache.org</A>&gt; 
</I>&gt;<i> Cc: Olly Lennox &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">oliver at lennox-it.uk</A>&gt;
</I>&gt;<i> Sent: Thursday, 20 April 2017, 0:13
</I>&gt;<i> Subject: Re: [squid-users] HTTPS woes
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 04/19/2017 04:48 PM, Olly Lennox wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> After further investigation the problem is something to do with permissions related to ssl_crtd.
</I>&gt;<i> 
</I>&gt;<i> No, it is not (or at least not yet).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I can run squid as root but using the default account (proxy?) it
</I>&gt;&gt;<i> won't run and is giving this error in cache.log:
</I>&gt;<i> 
</I>&gt;&gt;<i> 2017/04/19 23:43:54 kid1| helperOpenServers: Starting 1/8 'ssl_crtd' processes
</I>&gt;&gt;<i> FATAL: Ipc::Mem::Segment::open failed to shm_open(/squid-ssl_session_cache.shm): (2) No such file or directory
</I>&gt;<i> 
</I>&gt;<i> The FATAL line is unrelated to the ssl_crtd line above it (this is one
</I>&gt;<i> of several problems with FATAL error handling in Squid).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I've checked the file and folder permissions across all aspects of
</I>&gt;&gt;<i> squid and everything I can see is owned by proxy:proxy so not sure
</I>&gt;&gt;<i> where it is failing.
</I>&gt;<i> 
</I>&gt;<i> Squid is failing when trying to open a shared memory segment used for
</I>&gt;<i> storing SSL sessions. This probably means two things:
</I>&gt;<i> 
</I>&gt;<i> 1. Your OS environment is not compatible with Squid shared memory needs
</I>&gt;<i> (e.g., missing /dev/shm/ or equivalent). More info at
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/Features/SmpScale#Ipc::Mem::Segment::create_failed_to_shm_open.28....29:_.282.29_No_such_file_or_directory">http://wiki.squid-cache.org/Features/SmpScale#Ipc::Mem::Segment::create_failed_to_shm_open.28....29:_.282.29_No_such_file_or_directory</A>
</I>&gt;<i> 
</I>&gt;<i> 2. There is a bug in Squid: Squid should not create shared memory
</I>&gt;<i> segments when running in non-SMP mode. Please consider reporting this
</I>&gt;<i> bug if it has not been reported already. At the expense of losing SSL
</I>&gt;<i> session resumption capabilities, you should be able to work around this
</I>&gt;<i> bug by disabling the session cache:
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/sslproxy_session_cache_size/">http://www.squid-cache.org/Doc/config/sslproxy_session_cache_size/</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> acl SSL_ports port 443 
</I>&gt;&gt;<i> acl Safe_ports port 80        # http 
</I>&gt;&gt;<i> acl Safe_ports port 21        # ftp 
</I>&gt;&gt;<i> acl Safe_ports port 443        # https 
</I>&gt;&gt;<i> acl Safe_ports port 70        # gopher 
</I>&gt;&gt;<i> acl Safe_ports port 210        # wais 
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535    # unregistered ports 
</I>&gt;&gt;<i> acl Safe_ports port 280        # http-mgmt 
</I>&gt;&gt;<i> acl Safe_ports port 488        # gss-http 
</I>&gt;&gt;<i> acl Safe_ports port 591        # filemaker 
</I>&gt;&gt;<i> acl Safe_ports port 777        # multiling http 
</I>&gt;&gt;<i> acl CONNECT method CONNECT 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny !Safe_ports 
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports 
</I>&gt;&gt;<i> http_access allow all 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3130 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3128 intercept 
</I>&gt;&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl_cert/squid.crt key=/etc/squid3/ssl_cert/squid.key options=NO_SSLv3 dhparams=/etc/squid3/ssl_cert/dhparam.pem 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1 
</I>&gt;&gt;<i> ssl_bump peek step1 
</I>&gt;&gt;<i> ssl_bump bump all 
</I>&gt;&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE 
</I>&gt;&gt;<i> sslproxy_cipher EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS 
</I>&gt;&gt;<i> sslproxy_cafile /etc/squid/ssl_cert/mozcacert.pem 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/spool/squid_ssldb -M 4MB 
</I>&gt;&gt;<i> sslcrtd_children 8 startup=1 idle=1 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> coredump_dir /var/spool/squid 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Add any of your own refresh_pattern entries above these. 
</I>&gt;&gt;<i> refresh_pattern ^ftp:        1440    20%    10080 
</I>&gt;&gt;<i> refresh_pattern ^gopher:    1440    0%    1440 
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0 
</I>&gt;&gt;<i> refresh_pattern .        0    20%    4320 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_dir ufs /cache 400 16 256 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015029.html">[squid-users] HTTPS woes
</A></li>
	<LI>Next message (by thread): <A HREF="014969.html">[squid-users] Squid proxy with ssl-bump - unrecognized: 'ssl-bump'	error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15032">[ date ]</a>
              <a href="thread.html#15032">[ thread ]</a>
              <a href="subject.html#15032">[ subject ]</a>
              <a href="author.html#15032">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
