<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Huge memory required for squid 3.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20memory%20required%20for%20squid%203.5&In-Reply-To=%3CCAC%3Dab-_6AYGdE1zV5qMRq%3DUrW%3Dzh3rmwPWHUB%2BDtrGMZe9WLhg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015064.html">
   <LINK REL="Next"  HREF="015068.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Huge memory required for squid 3.5</H1>
    <B>Sabu Thaliyath</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20memory%20required%20for%20squid%203.5&In-Reply-To=%3CCAC%3Dab-_6AYGdE1zV5qMRq%3DUrW%3Dzh3rmwPWHUB%2BDtrGMZe9WLhg%40mail.gmail.com%3E"
       TITLE="[squid-users] Huge memory required for squid 3.5">sabu.thaliyath at gmail.com
       </A><BR>
    <I>Wed Apr 26 07:00:53 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015064.html">[squid-users] Huge memory required for squid 3.5
</A></li>
        <LI>Next message (by thread): <A HREF="015068.html">[squid-users] Huge memory required for squid 3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15065">[ date ]</a>
              <a href="thread.html#15065">[ thread ]</a>
              <a href="subject.html#15065">[ subject ]</a>
              <a href="author.html#15065">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have the same issue as Nil. I have set No_DEFAULT_CA and also did
&quot;generate-host-certificates=off&quot;.  I see with these changes it takes more
time reach 2GB but it does reach there (in about 6 hours for me with peak
usage).

These were my settings.

https_port 192.168.0.10:3129 generate-host-certificates=off
dynamic_cert_mem_cache_size=4MB cert=/etc/squid/myserver.pem intercept
ssl-bump sslflags=NO_DEFAULT_CA
https_port 192.168.0.10:3128 generate-host-certificates=off
dynamic_cert_mem_cache_size=4MB cert=/etc/squid/myserver.pem intercept
ssl-bump sslflags=NO_DEFAULT_CA

I did a 10 minutes test to compare the behavior in Squid 3.3 and squid 3.5.
My test scenario was kept exactly same except for following diff in squid
3.5.

acl exceptions ssl::server_name_regex &quot;/etc/squid/exception_list.txt&quot;
acl step1 at_step SslBump1
acl step2 at_step SslBump2
ssl_bump peek step1 all !exceptions
ssl_bump splice step2 !exceptions

Here are the results after 10mins -

1. When I didn't use NO_DEFAULT_CA and generate-host-certificates=on

Squid 3.3 = 550MB
Squid 3.5 = 1.1GB

2. When I use NO_DEFAULT_CA and generate-host-certificates=off

Squid 3.3 = 402MB
Squid 3.5 = 560MB

So it looks like Squid 3.5 have higher mem usage than 3.3 in both cases
which makes me wonder, is it that more CAs are being loaded into cache in
3.5 ?

Also, is there any more change  I can do to my config to arrest the memory
growth to 2GB  in 3.5 in my production system ? I got only 4Gb RAM.


Thanks and Regards,
Davis

On Wed, Apr 26, 2017 at 8:38 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 26/04/17 10:53, Yuri Voinov wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Ok, but how NO_DEFAULT_CA should help with this?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It prevents OpenSSL copying that 1MB into each incoming client connections
</I>&gt;<i> memory. The CAs are only useful there when you have some of the global CAs
</I>&gt;<i> as root for client certificates - in which case you still only want to
</I>&gt;<i> trust the roots you paid for service and not all of them.
</I>&gt;<i>
</I>&gt;<i> Just something to try if there are huge memory issues with TLS/SSL
</I>&gt;<i> proxying. The default behaviour is fixed for Squid-4 with the config
</I>&gt;<i> options changes. But due to being a major surprise for anyone already
</I>&gt;<i> relying on global roots for client certs it remains a problem in 3.5.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170426/c4154640/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170426/c4154640/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015064.html">[squid-users] Huge memory required for squid 3.5
</A></li>
	<LI>Next message (by thread): <A HREF="015068.html">[squid-users] Huge memory required for squid 3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15065">[ date ]</a>
              <a href="thread.html#15065">[ thread ]</a>
              <a href="subject.html#15065">[ subject ]</a>
              <a href="author.html#15065">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
