<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid with MySQL auth not denying pages with
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20MySQL%20auth%20not%20denying%20pages%20with&In-Reply-To=%3Cc4fd8ecf-7239-bb71-53d5-9146678f9b08%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015066.html">
   <LINK REL="Next"  HREF="015072.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid with MySQL auth not denying pages with</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20with%20MySQL%20auth%20not%20denying%20pages%20with&In-Reply-To=%3Cc4fd8ecf-7239-bb71-53d5-9146678f9b08%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid with MySQL auth not denying pages with">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 26 13:21:21 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015066.html">[squid-users] Squid with MySQL auth not denying pages with
</A></li>
        <LI>Next message (by thread): <A HREF="015072.html">[squid-users] Squid with MySQL auth not denying pages with
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15067">[ date ]</a>
              <a href="thread.html#15067">[ thread ]</a>
              <a href="subject.html#15067">[ subject ]</a>
              <a href="author.html#15067">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/04/17 00:04, prashantbhosale wrote:
&gt;<i> I am setting up simple squid server for denying URL's. Below is my squid
</I>&gt;<i> config, URL's are getting blocked and TCP_DENIED/403 seen in access.log
</I>&gt;<i> file.
</I>&gt;<i> But not showing error message/page shown in browser.
</I>&gt;<i>
</I>&gt;<i> Another main task that I want to do is Squid authentication with MySQL.
</I>&gt;<i> Followed the instructions provided on
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Mysql#Squid_Installation">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Mysql#Squid_Installation</A>
</I>&gt;<i> Auth is working. But one problem is now the denied log is with
</I>&gt;<i> TCP_DENIED/407 instead of TCP_DENIED/403
</I>&gt;<i> and no user is specified in log.
</I>
This usually means the browser did not send any credentials at all to 
Squid. The 407 is Squid telling the browser it needs to login.

&gt;<i> 1493126753.944      0 x.x.x.x TCP_DENIED/407 4510 GET
</I>&gt;<i> <A HREF="http://tg.symcd.com/MFEwTzBNMEswSTAJBgUrDgMCGgUABBRVuMwyhZnBGWkFKlkeoNe9zdlbSwQUK5o1rgEYODDhcHoF4BF2o869kBQCED3fM9dlZGIkaXhmllPjYgM%3D">http://tg.symcd.com/MFEwTzBNMEswSTAJBgUrDgMCGgUABBRVuMwyhZnBGWkFKlkeoNe9zdlbSwQUK5o1rgEYODDhcHoF4BF2o869kBQCED3fM9dlZGIkaXhmllPjYgM%3D</A>
</I>&gt;<i> - HIER_NONE/- text/html
</I>&gt;<i> Below is config with MySQL auth:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at proxy</A>:~$ cat /etc/squid/squid.conf
</I>&gt;<i> auth_param basic program /usr/lib/squid3/basic_db_auth --user root
</I>&gt;<i> --password <A HREF="https://lists.squid-cache.org/listinfo/squid-users">pass at 123</A> --plaintext  --persist
</I>
Okay ... assuming the defaults: your database name is 'squid', table 
name is 'passwd', and has an 'enabled' column containing '1' for the 
user account being tested.

If not then the 407 is authentication will fail due to the SQL query not 
returning any useful credentials to compare with those given by the 
browser(if any).

...
&gt;<i> #acl db-auth proxy_auth REQUIRED
</I>&gt;<i> #http_access allow db-auth
</I>
The above (when uncommented) will only allow authenticated users. Any 
clients sending bad credentials will just skip to the next lines... 
eventually reaching that &quot;allow all&quot;. So much for requiring login.

Better security practice is to perform checks that do not require login, 
then:
   http_access deny !db-login

then to do any allow/deny things for authenticated users.

&gt;<i> acl addomain dstdomain &quot;/etc/squid/addomains.acl&quot;
</I>&gt;<i> http_access deny addomain
</I>&gt;<i>
</I>&gt;<i> acl easyprivacy-regex url_regex -i &quot;/etc/squid/easyprivacy.txt&quot;
</I>&gt;<i> acl easylist-regex url_regex -i &quot;/etc/squid/easylist.txt&quot;
</I>&gt;<i> http_access deny easylist-regex
</I>&gt;<i> http_access deny easyprivacy-regex
</I>&gt;<i>
</I>&gt;<i> http_access allow all
</I>
Any http_access lines following this &quot;allow all&quot; are unreachable and 
pointless.

&gt;<i> http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> http_port 3128
</I>&gt;<i>
</I>

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015066.html">[squid-users] Squid with MySQL auth not denying pages with
</A></li>
	<LI>Next message (by thread): <A HREF="015072.html">[squid-users] Squid with MySQL auth not denying pages with
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15067">[ date ]</a>
              <a href="thread.html#15067">[ thread ]</a>
              <a href="subject.html#15067">[ subject ]</a>
              <a href="author.html#15067">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
