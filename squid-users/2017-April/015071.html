<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Huge memory required for squid 3.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20memory%20required%20for%20squid%203.5&In-Reply-To=%3C35f15acb-9b86-edc7-1152-a53dfaabfc22%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015070.html">
   <LINK REL="Next"  HREF="015057.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Huge memory required for squid 3.5</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20memory%20required%20for%20squid%203.5&In-Reply-To=%3C35f15acb-9b86-edc7-1152-a53dfaabfc22%40measurement-factory.com%3E"
       TITLE="[squid-users] Huge memory required for squid 3.5">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Apr 26 19:37:37 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015070.html">[squid-users] Huge memory required for squid 3.5
</A></li>
        <LI>Next message (by thread): <A HREF="015057.html">[squid-users] Transparent Squidding Teething Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15071">[ date ]</a>
              <a href="thread.html#15071">[ thread ]</a>
              <a href="subject.html#15071">[ subject ]</a>
              <a href="author.html#15071">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/26/2017 09:35 AM, Yuri Voinov wrote:

&gt;<i> This is openssl issue or squid's?
</I>
AFAIK, the underlying issue (i.e., bug #4005) is mostly a Squid problem:
Squid is caching SSL contexts (instead of certificates) and does a poor
job maintaining that cache.

Earlier OpenSSL versions (that had to be used when the original code was
written) complicated solving this problem. OpenSSL v1.0.1+ added APIs
that simplify some aspects of the anticipated fix. Certain OpenSSL
aspects will continue to hurt Squid, even with OpenSSL v1.0.1, but if
you want to blame a single project (instead of both), blame Squid.


&gt;<i> Why sessions can't share CA's data cached in memory? shared_ptr invented
</I>&gt;<i> already.
</I>
OpenSSL knew how to share things well before std::shared_ptr became
available. However, it is the responsibility of the application to tell
OpenSSL what to create from scratch and what to share. A part of the
problem is that Squid tells OpenSSL to create many large things from
scratch and then caches those large things while underestimating their
size by several(?) orders of magnitude (and probably also missing many
cache hits).

More details, including the difference between problems associated with
from-client and to-server connections, are documented in the &quot;Memory
Usage&quot; section of <A HREF="http://wiki.squid-cache.org/Features/SslBump">http://wiki.squid-cache.org/Features/SslBump</A>

FWIW, we have spent a lot of resources on triaging this problem and
drafting possible solutions (in various overlapping areas), but there is
currently no sponsor to finalize and implement any of the fixes. AFAIK,
bug #4005 is stuck.

I am glad that NO_DEFAULT_CA helps mitigate some of the problems in some
environments.


HTH,

Alex.


&gt;<i> 26.04.2017 9:08, Amos Jeffries &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> On 26/04/17 10:53, Yuri Voinov wrote:
</I>&gt;&gt;&gt;<i> Ok, but how NO_DEFAULT_CA should help with this?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It prevents OpenSSL copying that 1MB into each incoming client
</I>&gt;&gt;<i> connections memory. The CAs are only useful there when you have some
</I>&gt;&gt;<i> of the global CAs as root for client certificates - in which case you
</I>&gt;&gt;<i> still only want to trust the roots you paid for service and not all of
</I>&gt;&gt;<i> them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Just something to try if there are huge memory issues with TLS/SSL
</I>&gt;&gt;<i> proxying. The default behaviour is fixed for Squid-4 with the config
</I>&gt;&gt;<i> options changes. But due to being a major surprise for anyone already
</I>&gt;&gt;<i> relying on global roots for client certs it remains a problem in 3.5.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015070.html">[squid-users] Huge memory required for squid 3.5
</A></li>
	<LI>Next message (by thread): <A HREF="015057.html">[squid-users] Transparent Squidding Teething Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15071">[ date ]</a>
              <a href="thread.html#15071">[ thread ]</a>
              <a href="subject.html#15071">[ subject ]</a>
              <a href="author.html#15071">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
