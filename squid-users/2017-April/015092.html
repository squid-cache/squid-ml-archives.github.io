<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 3.5.25: (71) Protocol error (TLS code:	SQUID_ERR_SSL_HANDSHAKE)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.25%3A%20%2871%29%20Protocol%20error%20%28TLS%20code%3A%0A%09SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C0dcb01d2c008%24316500e0%24942f02a0%24%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015086.html">
   <LINK REL="Next"  HREF="015093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 3.5.25: (71) Protocol error (TLS code:	SQUID_ERR_SSL_HANDSHAKE)</H1>
    <B>David Touzeau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.25%3A%20%2871%29%20Protocol%20error%20%28TLS%20code%3A%0A%09SQUID_ERR_SSL_HANDSHAKE%29&In-Reply-To=%3C0dcb01d2c008%24316500e0%24942f02a0%24%40articatech.com%3E"
       TITLE="[squid-users] 3.5.25: (71) Protocol error (TLS code:	SQUID_ERR_SSL_HANDSHAKE)">david at articatech.com
       </A><BR>
    <I>Fri Apr 28 10:14:16 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015086.html">[squid-users] 3.5.25: (71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
        <LI>Next message (by thread): <A HREF="015093.html">[squid-users] 3.5.25: (71) Protocol error (TLS code:	SQUID_ERR_SSL_HANDSHAKE)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15092">[ date ]</a>
              <a href="thread.html#15092">[ thread ]</a>
              <a href="subject.html#15092">[ subject ]</a>
              <a href="author.html#15092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm fighting to find the correct certificate chain for this website:
<A HREF="https://www.boutique.afnor.org">https://www.boutique.afnor.org</A>

I have also added all certificates included in this package:
<A HREF="https://packages.debian.org/fr/sid/ca-certificates">https://packages.debian.org/fr/sid/ca-certificates</A>


Do you have any tips to help ?

Best regards

-----Message d'origine-----
De : Yuri Voinov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>] 
Envoy&#233; : jeudi 27 avril 2017 23:26
&#192; : David Touzeau &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">david at articatech.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Objet : Re: [squid-users] 3.5.25: (71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)

Be careful with intermediate CA's you grabbed. Check they validity, fingerprints and attributes.

Proxying SSL requires much more work with Squid.


28.04.2017 3:12, David Touzeau &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Thanks Yuri
</I>&gt;<i>
</I>&gt;<i>  ! but i have still have the error &quot; Error negotiating SSL on FD 13: 
</I>&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/0/0) &quot; and cannot browse to 
</I>&gt;<i> site ( as i seen you can with your squid...??? )
</I>Yes. With two different versions.
&gt;<i>
</I>&gt;<i> Created a file /etc/squid3/cabundle.pem
</I>&gt;<i>
</I>&gt;<i> Added Symantec certificates available here:
</I>&gt;<i> <A HREF="https://knowledge.symantec.com/kb/index?page=content&amp;actp=CROSSLINK&amp;id">https://knowledge.symantec.com/kb/index?page=content&amp;actp=CROSSLINK&amp;id</A>
</I>&gt;<i> =INFO2047
</I>&gt;<i>
</I>&gt;<i> add
</I>&gt;<i>
</I>&gt;<i> sslproxy_foreign_intermediate_certs  /etc/squid3/cabundle.pem
</I>&gt;<i>
</I>&gt;<i> and perform a squid -k reconfigure
</I>&gt;<i>
</I>&gt;<i> Missing something ???
</I>May be. I'm recommend to re-initialize mimic certificates DB also and restart Squid, not reconfigure.

Keep in mind, that SSL bump critical important for success. For example, AFAIK stare often opposite to bump (in most cases). Read wiki article, but also remember this functionality still evolving, and can changed without notices. So, experiment.
&gt;<i>
</I>&gt;<i> Best regards
</I>&gt;<i>
</I>&gt;<i> -----Message d'origine-----
</I>&gt;<i> De : Yuri Voinov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>] Envoy&#233; : jeudi 27 avril 
</I>&gt;<i> 2017 22:52 &#192; : David Touzeau &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">david at articatech.com</A>&gt;; 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> Objet : Re: [squid-users] 3.5.25: 
</I>&gt;<i> (71) Protocol error (TLS code:
</I>&gt;<i> SQUID_ERR_SSL_HANDSHAKE)
</I>&gt;<i>
</I>&gt;<i> Squid can't have any intermediate certificates. As by as root CA's.
</I>&gt;<i>
</I>&gt;<i> You can use this:
</I>&gt;<i>
</I>&gt;<i> #  TAG: sslproxy_foreign_intermediate_certs
</I>&gt;<i> #    Many origin servers fail to send their full server certificate
</I>&gt;<i> #    chain for verification, assuming the client already has or can
</I>&gt;<i> #    easily locate any missing intermediate certificates.
</I>&gt;<i> #
</I>&gt;<i> #    Squid uses the certificates from the specified file to fill in
</I>&gt;<i> #    these missing chains when trying to validate origin server
</I>&gt;<i> #    certificate chains.
</I>&gt;<i> #
</I>&gt;<i> #    The file is expected to contain zero or more PEM-encoded
</I>&gt;<i> #    intermediate certificates. These certificates are not treated
</I>&gt;<i> #    as trusted root certificates, and any self-signed certificate in
</I>&gt;<i> #    this file will be ignored.
</I>&gt;<i> #Default:
</I>&gt;<i> # none
</I>&gt;<i>
</I>&gt;<i> However, you should identiry and collect them by yourself.
</I>&gt;<i>
</I>&gt;<i> The biggest problem:
</I>&gt;<i>
</I>&gt;<i> Instead of root CA's, which can be taken from Mozilla's, intermediate 
</I>&gt;<i> CAs spreaded over CA's providers, have much shorter valid period (most 
</I>&gt;<i> cases up to 5-7 years) and, by this reason, should be continiously 
</I>&gt;<i> maintained by proxy admin.
</I>&gt;<i>
</I>&gt;<i> Also, remove this:
</I>&gt;<i>
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i>
</I>&gt;<i> From your config. Don't. Never. This is completely disable ANY 
</I>&gt;<i> security checks for certificates, which leads to giant vulnerability to your users.
</I>&gt;<i> ssl_proxy_cert_error should be restricted by very specific ACL(s) in 
</I>&gt;<i> your config only for number of sites you trust.
</I>&gt;<i>
</I>&gt;<i> 28.04.2017 2:27, David Touzeau &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> Hi yuri
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did not know if squid have Symantec intermediate certificate Squid 
</I>&gt;&gt;<i> is installed as default...
</I>&gt;&gt;<i> Any howto ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Message d'origine-----
</I>&gt;&gt;<i> De : squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] 
</I>&gt;&gt;<i> De la part de Yuri Voinov Envoy&#233; : jeudi 27 avril 2017 22:09 &#192; :
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> Objet : Re: [squid-users] 3.5.25:
</I>&gt;&gt;<i> (71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Look. It can be intermediate certificates issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does Squid have Symantec intermediate certificates?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 27.04.2017 22:47, David Touzeau &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i> I'm unable to access to <A HREF="https://www.boutique.afnor.org">https://www.boutique.afnor.org</A> website.
</I>&gt;&gt;&gt;<i> I would like to know if this issue cannot be fixed and must deny 
</I>&gt;&gt;&gt;<i> bump website to fix it.
</I>&gt;&gt;&gt;<i> Without Squid the website is correctly displayed
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid claim an error page with &quot;(71) Protocol error (TLS code:
</I>&gt;&gt;&gt;<i> SQUID_ERR_SSL_HANDSHAKE)&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In cache.log: &quot;Error negotiating SSL on FD 17:
</I>&gt;&gt;&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/0/0)&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Using the following configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 0.0.0.0:3128  name=MyPortNameID20 ssl-bump 
</I>&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>&gt;&gt;&gt;<i> cert=/etc/squid3/ssl/0c451f46b4d05031560d8195f30165cb.dyn
</I>&gt;&gt;&gt;<i> sslproxy_foreign_intermediate_certs /etc/squid3/intermediate_ca.pem 
</I>&gt;&gt;&gt;<i> sslcrtd_program /lib/squid3/ssl_crtd -s 
</I>&gt;&gt;&gt;<i> /var/lib/squid/session/ssl/ssl_db -M 8MB sslcrtd_children 16
</I>&gt;&gt;&gt;<i> startup=5
</I>&gt;&gt;&gt;<i> idle=1 acl FakeCert ssl::server_name .apple.com acl FakeCert 
</I>&gt;&gt;&gt;<i> ssl::server_name .icloud.com acl FakeCert ssl::server_name 
</I>&gt;&gt;&gt;<i> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl
</I>&gt;&gt;&gt;<i> ssl_step1 at_step SslBump1 acl ssl_step2 at_step SslBump2 acl
</I>&gt;&gt;&gt;<i> ssl_step3 at_step
</I>&gt;&gt;&gt;<i> SslBump3 ssl_bump peek ssl_step1 ssl_bump splice FakeCert ssl_bump 
</I>&gt;&gt;&gt;<i> bump ssl_step2 all ssl_bump splice all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,No_Compression sslproxy_cipher
</I>&gt;&gt;&gt;<i> ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:
</I>&gt;&gt;&gt;<i> !aNULL
</I>&gt;&gt;&gt;<i> :!eNULL
</I>&gt;&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Openssl info
</I>&gt;&gt;&gt;<i> --------------------------------------------------------------------
</I>&gt;&gt;&gt;<i> -
</I>&gt;&gt;&gt;<i> -
</I>&gt;&gt;&gt;<i> ------
</I>&gt;&gt;&gt;<i> --------------------------------------------------------------------
</I>&gt;&gt;&gt;<i> -
</I>&gt;&gt;&gt;<i> -
</I>&gt;&gt;&gt;<i> ------
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> openssl s_client -connect 195.115.26.58:443 -showcerts
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> CONNECTED(00000003)
</I>&gt;&gt;&gt;<i> depth=2 C = US, O = &quot;VeriSign, Inc.&quot;, OU = VeriSign Trust Network, 
</I>&gt;&gt;&gt;<i> OU = &quot;(c)
</I>&gt;&gt;&gt;<i> 2006 VeriSign, Inc. - For authorized use only&quot;, CN = VeriSign Class 
</I>&gt;&gt;&gt;<i> 3 Public Primary Certification Authority - G5 verify return:1
</I>&gt;&gt;&gt;<i> depth=1 C = US, O = Symantec Corporation, OU = Symantec Trust 
</I>&gt;&gt;&gt;<i> Network, CN = Symantec Class 3 Secure Server CA - G4 verify return:1
</I>&gt;&gt;&gt;<i> depth=0 C = FR, ST = Seine Saint Denis, L = ST DENIS, O = 
</I>&gt;&gt;&gt;<i> ASSOCIATION FRANCAISE DE NORMALISATION, OU = ASSOCIATION FRANCAISE 
</I>&gt;&gt;&gt;<i> DE NORMALISATION, CN = www.boutique.afnor.org verify return:1
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i> Certificate chain
</I>&gt;&gt;&gt;<i>  0 s:/C=FR/ST=Seine Saint Denis/L=ST DENIS/O=ASSOCIATION FRANCAISE 
</I>&gt;&gt;&gt;<i> DE NORMALISATION/OU=ASSOCIATION FRANCAISE DE 
</I>&gt;&gt;&gt;<i> NORMALISATION/CN=www.boutique.afnor.org
</I>&gt;&gt;&gt;<i>    i:/C=US/O=Symantec Corporation/OU=Symantec Trust 
</I>&gt;&gt;&gt;<i> Network/CN=Symantec Class 3 Secure Server CA - G4 -----BEGIN
</I>&gt;&gt;&gt;<i> CERTIFICATE----- ../..
</I>&gt;&gt;&gt;<i> -----END CERTIFICATE-----
</I>&gt;&gt;&gt;<i>  1 s:/C=US/O=Symantec Corporation/OU=Symantec Trust 
</I>&gt;&gt;&gt;<i> Network/CN=Symantec Class 3 Secure Server CA - G4
</I>&gt;&gt;&gt;<i>    i:/C=US/O=VeriSign, Inc./OU=VeriSign Trust Network/OU=(c) 2006 
</I>&gt;&gt;&gt;<i> VeriSign, Inc. - For authorized use only/CN=VeriSign Class 3 Public 
</I>&gt;&gt;&gt;<i> Primary Certification Authority - G5 -----BEGIN CERTIFICATE----- ../..
</I>&gt;&gt;&gt;<i> -----END CERTIFICATE-----
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i> Server certificate
</I>&gt;&gt;&gt;<i> subject=/C=FR/ST=Seine Saint Denis/L=ST DENIS/O=ASSOCIATION 
</I>&gt;&gt;&gt;<i> FRANCAISE DE NORMALISATION/OU=ASSOCIATION FRANCAISE DE 
</I>&gt;&gt;&gt;<i> NORMALISATION/CN=www.boutique.afnor.org
</I>&gt;&gt;&gt;<i> issuer=/C=US/O=Symantec Corporation/OU=Symantec Trust 
</I>&gt;&gt;&gt;<i> Network/CN=Symantec Class 3 Secure Server CA - G4
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i> No client certificate CA names sent
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i> SSL handshake has read 3105 bytes and written 616 bytes
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i> New, TLSv1/SSLv3, Cipher is AES128-SHA Server public key is 2048 bit 
</I>&gt;&gt;&gt;<i> Secure Renegotiation IS supported
</I>&gt;&gt;&gt;<i> Compression: NONE
</I>&gt;&gt;&gt;<i> Expansion: NONE
</I>&gt;&gt;&gt;<i> SSL-Session:
</I>&gt;&gt;&gt;<i>     Protocol  : TLSv1
</I>&gt;&gt;&gt;<i>     Cipher    : AES128-SHA
</I>&gt;&gt;&gt;<i>     Session-ID:
</I>&gt;&gt;&gt;<i> 833B0000A2346F50C5AAFC6B5188B4EBD9304CD25411BECFF0713F8D76C65D9D
</I>&gt;&gt;&gt;<i>     Session-ID-ctx:
</I>&gt;&gt;&gt;<i>     Master-Key:
</I>&gt;&gt;&gt;<i> D2DF6C62264D03D7D44AF44EB8C0B1B7AD0E650D34DF6EBEB1CBEBFE4F30CB9C6F50
</I>&gt;&gt;&gt;<i> 8
</I>&gt;&gt;&gt;<i> 0
</I>&gt;&gt;&gt;<i> AA94F5
</I>&gt;&gt;&gt;<i> D6B5955DD8DF06608416
</I>&gt;&gt;&gt;<i>     Key-Arg   : None
</I>&gt;&gt;&gt;<i>     PSK identity: None
</I>&gt;&gt;&gt;<i>     PSK identity hint: None
</I>&gt;&gt;&gt;<i>     SRP username: None
</I>&gt;&gt;&gt;<i>     Start Time: 1493311275
</I>&gt;&gt;&gt;<i>     Timeout   : 300 (sec)
</I>&gt;&gt;&gt;<i>     Verify return code: 0 (ok)
</I>&gt;&gt;&gt;<i> ---
</I>&gt;&gt;&gt;<i> read:errno=0
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Bugs to the Future
</I>&gt;&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Bugs to the Future
</I>&gt;<i>
</I>
--
Bugs to the Future


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015086.html">[squid-users] 3.5.25: (71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</A></li>
	<LI>Next message (by thread): <A HREF="015093.html">[squid-users] 3.5.25: (71) Protocol error (TLS code:	SQUID_ERR_SSL_HANDSHAKE)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15092">[ date ]</a>
              <a href="thread.html#15092">[ thread ]</a>
              <a href="subject.html#15092">[ subject ]</a>
              <a href="author.html#15092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
