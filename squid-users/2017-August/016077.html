<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How squid sends sni to icap server?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20squid%20sends%20sni%20to%20icap%20server%3F&In-Reply-To=%3Cfdba4819-3e3e-cdff-507e-d1fb56656404%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016073.html">
   <LINK REL="Next"  HREF="016082.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How squid sends sni to icap server?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20squid%20sends%20sni%20to%20icap%20server%3F&In-Reply-To=%3Cfdba4819-3e3e-cdff-507e-d1fb56656404%40treenet.co.nz%3E"
       TITLE="[squid-users] How squid sends sni to icap server?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug  4 13:47:40 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016073.html">[squid-users] How squid sends sni to icap server?
</A></li>
        <LI>Next message (by thread): <A HREF="016082.html">[squid-users] How squid sends sni to icap server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16077">[ date ]</a>
              <a href="thread.html#16077">[ thread ]</a>
              <a href="subject.html#16077">[ subject ]</a>
              <a href="author.html#16077">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/08/17 19:11, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">lucas.alvaro at laposte.net</A> wrote:
&gt;<i> Hi everyone,
</I>&gt;<i> I have a transparent proxy squid 3.5.26 with C-ICAP  and here are the 
</I>&gt;<i> important lines:
</I>&gt;<i> &quot;
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_send_client_username on
</I>&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://localhost:1344/echo">icap://localhost:1344/echo</A> 
</I>&gt;<i> bypass=off
</I>&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;<i> icap_service service_avi_resp respmod_precache 
</I>&gt;<i> <A HREF="icap://localhost:1344/echo">icap://localhost:1344/echo</A> bypass=off
</I>&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;<i> 
</I>&gt;<i> #url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;<i> cert=/etc/squid/ssl_cert/myCA.pem \
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> #acl step1 at_step SslBump1
</I>&gt;<i> #acl step2 at_step SslBump2
</I>&gt;<i> #acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump bump all
</I>
NP: Peeking at step 2 precludes bumping.

&gt;<i> logformat squid %ssl::&gt;sni
</I>
Please do not redefine the built-in format name &quot;squid&quot;. Use a custom 
name for custom formats.


&gt;<i> adaptation_meta X-SNI &quot;%ssl::&gt;sni&quot; all   #or connect
</I>&gt;<i> #request_header_add X-SNI &quot;%ssl::&gt;sni&quot; all
</I>&gt;<i> &quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So i want to create an icap service like squidclamav but it must check 
</I>&gt;<i> SNI not URLs.
</I>
Any particular reason why?
  SNI has almost nothing to do with the HTTP messages (plural). It is 
simply the name of the next-hop server (or proxy) they should be 
delivered to on their way around the web.

I thought squidclamav was an antivirus, not a URL blocklist checker.


&gt;<i> 
</I>&gt;<i> I peek all the steps to get sni and in the squid access log, sni is 
</I>&gt;<i> printed .
</I>&gt;<i> I read that adaptation_meta can send anything from squid to icap but 
</I>&gt;<i> clearly i use it incorretly: i can't see sni on icap access log or in 
</I>&gt;<i> icap headers.
</I>
Your usage appears to be correct. I think there is no SNI being received 
by Squid.


&gt;<i> Does adaptation_meta create a icap headers ?
</I>
It does.

&gt;<i> Or should i use 
</I>&gt;<i> add_request_headers?
</I>
No, that would add HTTP headers to the outgoing messages (to server or 
to client).

&gt;<i> 
</I>&gt;<i> I know that squid can create a 2nd fake connect with sni but here again 
</I>&gt;<i> icap just print the same connect 2 times
</I>&gt;<i> 
</I>
That is correct, however SNI is not always sent by clients. Squid can 
only use what it is given.

If there is an SNI in that particular clientHello you have hit a bug in 
Squid.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016073.html">[squid-users] How squid sends sni to icap server?
</A></li>
	<LI>Next message (by thread): <A HREF="016082.html">[squid-users] How squid sends sni to icap server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16077">[ date ]</a>
              <a href="thread.html#16077">[ thread ]</a>
              <a href="subject.html#16077">[ subject ]</a>
              <a href="author.html#16077">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
