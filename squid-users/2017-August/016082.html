<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How squid sends sni to icap server?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20squid%20sends%20sni%20to%20icap%20server%3F&In-Reply-To=%3C1845922744.1330711.1502050273070.JavaMail.zimbra%40laposte.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016077.html">
   <LINK REL="Next"  HREF="016085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How squid sends sni to icap server?</H1>
    <B>lucas.alvaro at laposte.net</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20squid%20sends%20sni%20to%20icap%20server%3F&In-Reply-To=%3C1845922744.1330711.1502050273070.JavaMail.zimbra%40laposte.net%3E"
       TITLE="[squid-users] How squid sends sni to icap server?">lucas.alvaro at laposte.net
       </A><BR>
    <I>Sun Aug  6 20:11:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016077.html">[squid-users] How squid sends sni to icap server?
</A></li>
        <LI>Next message (by thread): <A HREF="016085.html">[squid-users] How squid sends sni to icap server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16082">[ date ]</a>
              <a href="thread.html#16082">[ thread ]</a>
              <a href="subject.html#16082">[ subject ]</a>
              <a href="author.html#16082">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;&gt;<i> Hi everyone, 
</I>&gt;&gt;<i> I have a transparent proxy squid 3.5.26 with C-ICAP and here are the 
</I>&gt;&gt;<i> important lines: 
</I>&gt;&gt;<i> &quot; 
</I>&gt;&gt;<i> icap_enable on 
</I>&gt;&gt;<i> icap_send_client_ip on 
</I>&gt;&gt;<i> icap_send_client_username on 
</I>&gt;&gt;<i> icap_client_username_header X-Authenticated-User 
</I>&gt;&gt;<i> icap_preview_enable on 
</I>&gt;&gt;<i> icap_preview_size 1024 
</I>&gt;&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://localhost:1344/echo">icap://localhost:1344/echo</A> 
</I>&gt;&gt;<i> bypass=off 
</I>&gt;&gt;<i> adaptation_access service_avi_req allow all 
</I>&gt;&gt;<i> icap_service service_avi_resp respmod_precache 
</I>&gt;&gt;<i> <A HREF="icap://localhost:1344/echo">icap://localhost:1344/echo</A> bypass=off 
</I>&gt;&gt;<i> adaptation_access service_avi_resp allow all 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 3128 
</I>&gt;&gt;<i> http_port 3129 intercept 
</I>&gt;&gt;<i> https_port 3130 intercept ssl-bump \ 
</I>&gt;&gt;<i> cert=/etc/squid/ssl_cert/myCA.pem \ 
</I>&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>&gt;&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #acl step1 at_step SslBump1 
</I>&gt;&gt;<i> #acl step2 at_step SslBump2 
</I>&gt;&gt;<i> #acl step3 at_step SslBump3 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek all 
</I>&gt;&gt;<i> ssl_bump bump all 
</I>&gt;<i> 
</I>&gt;<i>NP: Peeking at step 2 precludes bumping. 
</I>&gt;<i> 
</I>&gt;&gt;<i> logformat squid %ssl::&gt;sni 
</I>&gt;<i> 
</I>&gt;<i>Please do not redefine the built-in format name &quot;squid&quot;. Use a custom 
</I>&gt;<i>name for custom formats. 
</I>&gt;<i> 
</I>
Ok it will be done 

&gt;<i> 
</I>&gt;&gt;<i> adaptation_meta X-SNI &quot;%ssl::&gt;sni&quot; all #or connect 
</I>&gt;&gt;<i> #request_header_add X-SNI &quot;%ssl::&gt;sni&quot; all 
</I>&gt;&gt;<i> &quot; 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> So i want to create an icap service like squidclamav but it must check 
</I>&gt;&gt;<i> SNI not URLs. 
</I>&gt;<i> 
</I>&gt;<i>Any particular reason why? 
</I>&gt;<i> SNI has almost nothing to do with the HTTP messages (plural). It is 
</I>&gt;<i> simply the name of the next-hop server (or proxy) they should be 
</I>&gt;<i> delivered to on their way around the web. 
</I>&gt;<i> 
</I>&gt;<i>I thought squidclamav was an antivirus, not a URL blocklist checker. 
</I>&gt;<i> 
</I>You're right: squidclamav is an antivirus but there are much more services, actually he can check url and match them to blacklist or whitelist. 
I don't want to decrypt https trafic but i want to know where the client is trying to connect. I thought SNI was the only way to know the server name and the domain without decrypting anything. 

Final goal is to blacklist for exemple google and when sni indicates www.google.com, c-icap denies the access. 

&gt;<i> 
</I>&gt;&gt;<i> I peek all the steps to get sni and in the squid access log, sni is 
</I>&gt;&gt;<i> printed . 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I read that adaptation_meta can send anything from squid to icap but 
</I>&gt;&gt;<i> clearly i use it incorretly: i can't see sni on icap access log or in 
</I>&gt;&gt;<i> icap headers. 
</I>&gt;<i> 
</I>&gt;<i> Your usage appears to be correct. I think there is no SNI being received 
</I>&gt;<i> by Squid. 
</I>
That's problematic because in my squid access log there are &quot;www.youtube.com&quot; &quot;www.google.com&quot;, that's exactly what i'm tryng to pass to c-icap. Seems like squid receives the sni. 

&gt;&gt;<i> Does adaptation_meta create a icap headers ? 
</I>&gt;<i> 
</I>&gt;<i>It does. 
</I>&gt;<i> 
</I>&gt;&gt;<i> Or should i use 
</I>&gt;&gt;<i> add_request_headers? 
</I>&gt;<i> 
</I>&gt;<i>No, that would add HTTP headers to the outgoing messages (to server or 
</I>&gt;<i>to client). 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I know that squid can create a 2nd fake connect with sni but here again 
</I>&gt;&gt;<i> icap just print the same connect 2 times 
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>That is correct, however SNI is not always sent by clients. Squid can 
</I>&gt;<i>only use what it is given. 
</I>&gt;<i> 
</I>&gt;<i>If there is an SNI in that particular clientHello you have hit a bug in 
</I>&gt;<i>Squid. 
</I>&gt;<i> 
</I>&gt;<i>Amos 
</I>
Thanks Amos for the reply. 

&gt;<i>________ ______________________________________ 
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170806/e1479fcd/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170806/e1479fcd/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016077.html">[squid-users] How squid sends sni to icap server?
</A></li>
	<LI>Next message (by thread): <A HREF="016085.html">[squid-users] How squid sends sni to icap server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16082">[ date ]</a>
              <a href="thread.html#16082">[ thread ]</a>
              <a href="subject.html#16082">[ subject ]</a>
              <a href="author.html#16082">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
