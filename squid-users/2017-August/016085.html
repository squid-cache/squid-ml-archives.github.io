<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How squid sends sni to icap server?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20squid%20sends%20sni%20to%20icap%20server%3F&In-Reply-To=%3Ce1cd5027-a1ff-b9db-6e1a-925419b7eeca%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016082.html">
   <LINK REL="Next"  HREF="016074.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How squid sends sni to icap server?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20squid%20sends%20sni%20to%20icap%20server%3F&In-Reply-To=%3Ce1cd5027-a1ff-b9db-6e1a-925419b7eeca%40treenet.co.nz%3E"
       TITLE="[squid-users] How squid sends sni to icap server?">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Aug  7 10:04:30 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016082.html">[squid-users] How squid sends sni to icap server?
</A></li>
        <LI>Next message (by thread): <A HREF="016074.html">[squid-users] How do i implement an ACL for longer duration?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16085">[ date ]</a>
              <a href="thread.html#16085">[ thread ]</a>
              <a href="subject.html#16085">[ subject ]</a>
              <a href="author.html#16085">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/08/17 08:11, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">lucas.alvaro at laposte.net</A> wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;&gt; adaptation_meta X-SNI &quot;%ssl::&gt;sni&quot; all   #or connect
</I>&gt;<i>  &gt;&gt; #request_header_add X-SNI &quot;%ssl::&gt;sni&quot; all
</I>&gt;<i>  &gt;&gt; &quot;
</I>&gt;<i>  &gt;&gt;
</I>&gt;<i>  &gt;&gt;
</I>&gt;<i>  &gt;&gt; So i want to create an icap service like squidclamav but it must check
</I>&gt;<i>  &gt;&gt; SNI not URLs.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;Any particular reason why?
</I>&gt;<i>  &gt; SNI has almost nothing to do with the HTTP messages (plural). It is
</I>&gt;<i>  &gt; simply the name of the next-hop server (or proxy) they should be
</I>&gt;<i>  &gt; delivered to on their way around the web.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;I thought squidclamav was an antivirus, not a URL blocklist checker.
</I>&gt;<i>  &gt;
</I>&gt;<i> You're right: squidclamav is an antivirus but there are much more 
</I>&gt;<i> services, actually he can check url and match them to blacklist or 
</I>&gt;<i> whitelist.
</I>&gt;<i> I don't want to decrypt https trafic but i want to know where the client 
</I>&gt;<i> is trying to connect. I thought SNI was the only way to know the server 
</I>&gt;<i> name and the domain without decrypting anything.
</I>
Sort of yes, and sort of no. SNI is the name of the server the client 
wants to connect to. But it is not necessarily of any relation to the 
HTTPS message URL-domain. It could be any of the many names each server 
has pointing to it. eg. a private/internal hostname or a virtual-host 
domain. The HTTPS message may go to that same name, or to any of the 
servers other ones.
  With HTTP/2 becoming more popular the Alt-Svc / ALTSVC feature is 
getting more traction. Where the SNI can be expected to contain the 
alternative servers name and the HTTPS message URL has the exact 
domain/URL wanted from that server.

A slightly more accurate value is the ServerHello cert SubjectAltName 
field which lists the names the server is publicly advertising itself to 
be. That is also available without decrypting using a peek/stare at 
step2 of SSL-Bump.
  BUT, that field is more accurate because it can and often does contain 
a whole list of the servers various names including wildcard sub-domains 
- which reflects the reality of what a &quot;site&quot; actually looks like. 
Despite many of us humans thinking a site/domain is a singular thing, it 
is actually a messy collection of pieces.

These details are all part of why ssl::server_name exists separate from 
the more familiar dstdomain ACL type.

IMHO if you want your service to cope well with virtual hosting etc 
sending it both the SNI and the full SubjectAltName set of values would 
be best. Then it can decide whether any of those details is needing a 
block or safe to allow.


&gt;<i> 
</I>&gt;<i> Final goal is to blacklist for exemple google and when sni indicates 
</I>&gt;<i> www.google.com, c-icap denies the access.
</I>&gt;<i> 
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;&gt; I peek all the steps to get sni and in the squid access log, sni is
</I>&gt;<i>  &gt;&gt; printed .
</I>&gt;<i>  &gt;&gt;
</I>&gt;<i>  &gt;&gt; I read that adaptation_meta can send anything from squid to icap but
</I>&gt;<i>  &gt;&gt; clearly i use it incorretly: i can't see sni on icap access log or in
</I>&gt;<i>  &gt;&gt; icap headers.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Your usage appears to be correct. I think there is no SNI being received
</I>&gt;<i>  &gt; by Squid.
</I>&gt;<i> 
</I>&gt;<i> That's problematic because in my squid access log there are 
</I>&gt;<i> &quot;www.youtube.com&quot; &quot;www.google.com&quot;, that's exactly what i'm tryng to 
</I>&gt;<i> pass to c-icap. Seems like squid receives the sni.
</I>
FWIW; Squid gets the values from:
  a) CONNECT tunnel request-target, or
  b) SNI, or
  c) server cert SubjectAltName, or
  d) decrypted HTTPS message URL, or
  e) reverse-DNS of the TCP dst-IP address.
In that order AFAIK. So if any of the non-SNI details becomes available 
Squid can log a name.

That said I do think you may be hitting a bug in Squid SNI handling, its 
not perfect yet, particularly in the Squid-3.x code. So a traffic 
analysis with wireshake or similar would be useful at this point to 
check and confirm whether SNI is given or one of those others happening.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016082.html">[squid-users] How squid sends sni to icap server?
</A></li>
	<LI>Next message (by thread): <A HREF="016074.html">[squid-users] How do i implement an ACL for longer duration?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16085">[ date ]</a>
              <a href="thread.html#16085">[ thread ]</a>
              <a href="subject.html#16085">[ subject ]</a>
              <a href="author.html#16085">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
