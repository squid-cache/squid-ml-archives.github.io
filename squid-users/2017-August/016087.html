<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Portal Splash Pages example on squid 3.3.13
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Portal%20Splash%20Pages%20example%20on%20squid%203.3.13&In-Reply-To=%3C7317197e-3035-cf9b-b905-da4963dfd09f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016072.html">
   <LINK REL="Next"  HREF="016073.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Portal Splash Pages example on squid 3.3.13</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Portal%20Splash%20Pages%20example%20on%20squid%203.3.13&In-Reply-To=%3C7317197e-3035-cf9b-b905-da4963dfd09f%40treenet.co.nz%3E"
       TITLE="[squid-users] Portal Splash Pages example on squid 3.3.13">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Aug  7 11:36:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016072.html">[squid-users] Portal Splash Pages example on squid 3.3.13
</A></li>
        <LI>Next message (by thread): <A HREF="016073.html">[squid-users] How squid sends sni to icap server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16087">[ date ]</a>
              <a href="thread.html#16087">[ thread ]</a>
              <a href="subject.html#16087">[ subject ]</a>
              <a href="author.html#16087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/08/17 16:56, mm wrote:
&gt;<i> hi, i m also trying to configure squid proxy server in my ubuntu machine and
</I>&gt;<i> using version 3.3.8. i have used the same example as mentioned in your post.
</I>&gt;<i> but i am getting the following error :
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: -D command-line option is obsolete.
</I>
Your init script should not be using the -D option any more. Check that 
you are using the proper one from Ubuntu. If you are, then don't worry 
about this warning - it will disappear on a future upgrade of the init 
script (IIRC in Xenial).


&gt;<i> 2017/08/04 10:14:05| aclIpParseIpData: WARNING: Netmask masks away part of
</I>&gt;<i> the specified IP in '10.0.2.0/16'
</I>&gt;<i> 2017/08/04 10:14:05| aclIpParseIpData: WARNING: Netmask masks away part of
</I>&gt;<i> the specified IP in '10.0.3.0/16'
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: (B) '10.0.0.0/16' is a subnetwork of (A)
</I>&gt;<i> '10.0.0.0/16'
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: because of this '10.0.0.0/16' is ignored to
</I>&gt;<i> keep splay tree searching predictable
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: You should probably remove '10.0.0.0/16' from
</I>&gt;<i> the ACL named 'localnet'
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: (B) '10.0.0.0/16' is a subnetwork of (A)
</I>&gt;<i> '10.0.0.0/8'
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: because of this '10.0.0.0/8' is ignored to
</I>&gt;<i> keep splay tree searching predictable
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: You should probably remove '10.0.0.0/16' from
</I>&gt;<i> the ACL named 'localnet'
</I>
All the above warnings seem to be from two problems.

1) I think you have left the default localnet ACL definition in while 
also adding your LAN 10.0.*.0/16 ranges.

2) the /16 on 10.0.2.0 and 10.0.3.0 masks away the '2' and '3' portion. 
Leaving these entries both as 10.0.0.0/16.

There are several ways to fix these:

either,
  mask the 10.0.x.0 ranges as the /24 they are:

   acl localnet src 10.0.2.0/24 10.0.3.0/24

or,
  specify the start-end of the sub-subnet range within the /16 which you 
are using for your LAN:

   acl localnet src 10.0.2.0-10.0.3.255/16

or,
  list the whole /16 (what Squid is currently assuming you meant to do):

   acl localnet src 10.0.0.0/16

or,
  leave the default Squid definition for RFC 1918 ranges provided and 
not configure your specific RFC 1918 sub-ranges.

If you choose anything but the last option, remove the default localnet 
definition specifying all of 10/8 as localnet, and probably the other 
IPv4 ranges as well. The IPv6 ranges you will need to look into and make 
a decision about.


&gt;<i> 2017/08/04 10:14:05| Starting Squid Cache version 3.3.8 for
</I>&gt;<i> x86_64-pc-linux-gnu...
</I>&gt;<i> 2017/08/04 10:14:05| Process ID 3891
</I>&gt;<i> 2017/08/04 10:14:05| Process Roles: master worker
</I>&gt;<i> 2017/08/04 10:14:05| With 65536 file descriptors available
</I>&gt;<i> 2017/08/04 10:14:05| Initializing IP Cache...
</I>&gt;<i> 2017/08/04 10:14:05| DNS Socket created at [::], FD 5
</I>&gt;<i> 2017/08/04 10:14:05| DNS Socket created at 0.0.0.0, FD 6
</I>&gt;<i> 2017/08/04 10:14:05| Warning: Could not find any nameservers. Trying to use
</I>&gt;<i> localhost
</I>&gt;<i> 2017/08/04 10:14:05| Please check your /etc/resolv.conf file
</I>&gt;<i> 2017/08/04 10:14:05| or use the 'dns_nameservers' option in squid.conf.
</I>

That one is a semi-serious issue on Ubuntu. resolv.conf not being setup 
properly with &quot;nameserver ...&quot; entries will break a huge amount of things.

If it is unset because your network connection is dynamic and currently 
offline, then you WILL need to run &quot;squid -k reconfigure&quot; each time it 
gets connected and changes resolv.conf contents.

NOTE: avoid &quot;service squid reload&quot; from upstart (and later systemd) - 
that way leads to some bad troubles with Squid-3.


&gt;<i> 2017/08/04 10:14:05| helperOpenServers: Starting 5/5 'ext_session_acl'
</I>&gt;<i> processes
</I>&gt;<i> 2017/08/04 10:14:05| Logfile: opening log daemon:/var/log/squid3/access.log
</I>&gt;<i> 2017/08/04 10:14:05| Logfile Daemon: opening log /var/log/squid3/access.log
</I>&gt;<i> 2017/08/04 10:14:05| Local cache digest enabled; rebuild/rewrite every
</I>&gt;<i> 3600/3600 sec
</I>&gt;<i> 2017/08/04 10:14:05| Store logging disabled
</I>&gt;<i> 2017/08/04 10:14:05| Swap maxSize 0 + 262144 KB, estimated 20164 objects
</I>&gt;<i> 2017/08/04 10:14:05| Target number of buckets: 1008
</I>&gt;<i> 2017/08/04 10:14:05| Using 8192 Store buckets
</I>&gt;<i> 2017/08/04 10:14:05| Max Mem  size: 262144 KB
</I>&gt;<i> 2017/08/04 10:14:05| Max Swap size: 0 KB
</I>&gt;<i> 2017/08/04 10:14:05| Using Least Load store dir selection
</I>&gt;<i> 2017/08/04 10:14:05| chdir: /var/spool/squid: (2) No such file or directory
</I>&gt;<i> 2017/08/04 10:14:05| Current Directory is /home/misha
</I>&gt;<i> 2017/08/04 10:14:05| Loaded Icons.
</I>&gt;<i> 2017/08/04 10:14:05| HTCP Disabled.
</I>&gt;<i> 2017/08/04 10:14:05| Pinger socket opened on FD 21
</I>&gt;<i> 2017/08/04 10:14:05| Configuring Parent 10.0.0.2/3128/0
</I>&gt;<i> 2017/08/04 10:14:05| Squid plugin modules loaded: 0
</I>&gt;<i> 2017/08/04 10:14:05| Adaptation support is off.
</I>&gt;<i> 2017/08/04 10:14:05| Accepting HTTP Socket connections at local=[::]:3128
</I>&gt;<i> remote=[::] FD 19 flags=9
</I>&gt;<i> 2017/08/04 10:14:05| WARNING: session #2 exited
</I>&gt;<i> 2017/08/04 10:14:05| Too few session processes are running (need 1/5)
</I>&gt;<i> 2017/08/04 10:14:05| Closing HTTP port [::]:3128
</I>&gt;<i> 2017/08/04 10:14:05| storeDirWriteCleanLogs: Starting...
</I>&gt;<i> 2017/08/04 10:14:05|   Finished.  Wrote 0 entries.
</I>&gt;<i> 2017/08/04 10:14:05|   Took 0.00 seconds (  0.00 entries/sec).
</I>&gt;<i> FATAL: The session helpers are crashing too rapidly, need help!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My squid.conf file is as follows:
</I>&gt;<i> acl localnet src 10.0.2.0/16
</I>&gt;<i> acl localnet src 10.0.3.0/16
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8 # RFC1918 possible internal network
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 3128
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> ## addition for splash page active##
</I>&gt;<i> external_acl_type session ipv4 concurrency=100 ttl=3 %SRC
</I>&gt;<i> /usr/lib/squid/ext_session_acl -T 60 -b /var/lib/squid/session.db
</I>&gt;<i> acl session_login external session LOGIN
</I>&gt;<i> acl session_is_active external session
</I>&gt;<i> acl clicked_login_url url_regex -i
</I>&gt;<i> ^<A HREF="https://www.drdo.gov.in/drdo/English/index.jsp$">https://www.drdo.gov.in/drdo/English/index.jsp$</A>
</I>&gt;<i> http_access allow clicked_login_url session_login
</I>&gt;<i> http_access deny !session_is_active
</I>&gt;<i> deny_info 511:/etc/squid3/splash.html session_is_active
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Pls tell me what going wrong??
</I>&gt;<i> 
</I>

First massive problem is the helpers existing. They should not be doing 
that until Squid kills them on reconfigure or shutdown.

Check the helpers session DB (/var/lib/squid/session.db) has been 
properly initialized and the helpers are able to both read and write to 
it when run by Squid with its low-privilege user account - on Ubuntu 
that should be the user account &quot;proxy&quot;.



Second major problem (not causing you problem yet, but it will) is that 
you placed the splash page config *after* the &quot;http_access deny all&quot; 
line. So none of it will actually ever do anything.

The lines where it says:
   http_access allow localnet
   http_access allow localhost

are in a section of the config for local policy rules. As you might 
expect the default policy is to let localnet clients and localhost use 
the proxy.
You can freely replace or add to those two lines with any settings you like.

FWIW: that is a bit clearer in the 3.5 default config file. You can 
replace the 3.3 config with the 3.5 updated version if you want:
  &lt;<A HREF="https://wiki.squid-cache.org/Squid-3.5#Squid-3.5_default_config">https://wiki.squid-cache.org/Squid-3.5#Squid-3.5_default_config</A>&gt;

To use the splash page stuff remove the &quot;allow localnet&quot; line and paste 
the splash config just below where it says &quot;INSERT YOUR OWN RULE(S) HERE&quot;


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016072.html">[squid-users] Portal Splash Pages example on squid 3.3.13
</A></li>
	<LI>Next message (by thread): <A HREF="016073.html">[squid-users] How squid sends sni to icap server?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16087">[ date ]</a>
              <a href="thread.html#16087">[ thread ]</a>
              <a href="subject.html#16087">[ subject ]</a>
              <a href="author.html#16087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
