<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Simple ACL help for Kerberos authenticated sessions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Simple%20ACL%20help%20for%20Kerberos%20authenticated%20sessions&In-Reply-To=%3Comd2ec%24ojp%241%40blaine.gmane.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016175.html">
   <LINK REL="Next"  HREF="016099.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Simple ACL help for Kerberos authenticated sessions</H1>
    <B>Markus Moeller</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Simple%20ACL%20help%20for%20Kerberos%20authenticated%20sessions&In-Reply-To=%3Comd2ec%24ojp%241%40blaine.gmane.org%3E"
       TITLE="[squid-users] Simple ACL help for Kerberos authenticated sessions">huaraz at moeller.plus.com
       </A><BR>
    <I>Tue Aug  8 19:11:33 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016175.html">[squid-users] wiki.squid-cache.org SSL configuration problem ...
</A></li>
        <LI>Next message (by thread): <A HREF="016099.html">[squid-users] kernel: Out of memory: Kill	process (squid)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16098">[ date ]</a>
              <a href="thread.html#16098">[ thread ]</a>
              <a href="subject.html#16098">[ subject ]</a>
              <a href="author.html#16098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

    When using the latest squid 4 release you can use  %note{group} to get 
the group information from the Negotiate Kerberos helper to transfer the PAC 
group SIDs to the external ACL helper.

squid.conf

...
external_acl_type test_acl ipv4 %LOGIN %note{group} 
/opt/squid-trunk/sbin/test_acl
acl squid_allow external test_acl
...

The helper script will initially look for the objectsid of the group 
SQUID_ALLOW (i.e. it will be only called when the helper is started and 
never again - good for performance).  After that the SIDs from the Kerberos 
PAC information is compared with the previously retrieved SID from AD.


#!/bin/bash
#
# GET SID for Group
#
export KRB5CCNAME=/tmp/squid_krb5cc
kinit -kt /etc/squid/squid.keytab HTTP/opensuse42.suse.home
SID=`ldapsearch -LLL -Ygssapi -H <A HREF="ldap://dc1.samba.home:389">ldap://dc1.samba.home:389</A> -s sub -b 
&quot;DC=samba,DC=home&quot; &quot;(CN=SQUID_ALLOW)&quot; objectsid 2&gt;&amp;1 | awk '{ if ( $0 
~/^object/ ) print $2}'`

(&gt;&amp;2 echo &quot;`date +&quot;%Y/%m/%d %H:%M:%S&quot;`| test_ACL: SID=$SID&quot;)

#
# Loop over input
#
while [ 1 == 1 ] ; do
  read input
  found=0
  user=`echo $input | awk '{ print $1 }'`
  groups=`echo $input | awk '{ print $2 }'`
  (&gt;&amp;2 echo &quot;`date +&quot;%Y/%m/%d %H:%M:%S&quot;`| test_ACL: user=$user&quot;)
  (&gt;&amp;2 echo &quot;`date +&quot;%Y/%m/%d %H:%M:%S&quot;`| test_ACL: groups=$groups&quot;)
  if [ -n &quot;$groups&quot; ]; then
    while read group; do
      if [ &quot;$group&quot; == &quot;$SID&quot; ]; then
        (&gt;&amp;2 echo &quot;`date +&quot;%Y/%m/%d %H:%M:%S&quot;`| test_ACL: matched group: 
$group&quot;)
        found=1
        echo &quot;OK&quot;
      fi
    done &lt;&lt;&lt; &quot;$(echo $groups | tr , &quot;\n&quot; )&quot;
    if [ $found -eq 0 ]; then
      echo &quot;ERR&quot;
    fi
  else
    if [ $found -eq 0 ]; then
      echo &quot;ERR&quot;
    fi
  fi
done

Example log from the cache.log file


2017/08/08 20:02:02 kid1| helperOpenServers: Starting 0/5 'test_acl' 
processes
2017/08/08 20:02:02 kid1| helperOpenServers: No 'test_acl' processes needed.
2017/08/08 20:02:23 kid1| Starting new test_acl helpers...
2017/08/08 20:02:23 kid1| helperOpenServers: Starting 1/5 'test_acl' 
processes
2017/08/08 20:02:24| test_ACL: SID=AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVUwQAAA==
2017/08/08 20:02:24| test_ACL: user=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Administrator at SAMBA.HOME</A>
2017/08/08 20:02:24| test_ACL: 
groups=AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVCAIAAA==,AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVPAIAAA==,AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVBwIAAA==,AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVBgIAAA==,AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVAAIAAA==,AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVUwQAAA==
2017/08/08 20:02:24| test_ACL: matched group: 
AQUAAAAAAAUVAAAAjxbSIudxUpznEbHVUwQAAA==


Regards
Markus 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016175.html">[squid-users] wiki.squid-cache.org SSL configuration problem ...
</A></li>
	<LI>Next message (by thread): <A HREF="016099.html">[squid-users] kernel: Out of memory: Kill	process (squid)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16098">[ date ]</a>
              <a href="thread.html#16098">[ thread ]</a>
              <a href="subject.html#16098">[ subject ]</a>
              <a href="author.html#16098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
