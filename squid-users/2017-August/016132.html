<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Crash: every 19 hours: kernel: Out of memory: Kill process (squid)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Crash%3A%20every%2019%20hours%3A%20kernel%3A%20Out%20of%20memory%3A%0A%20Kill%20process%20%28squid%29&In-Reply-To=%3C89638057A560FB458C01C197F81C7F5D18A8A0D8%40PACERS.amscan.corp%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016131.html">
   <LINK REL="Next"  HREF="016126.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Crash: every 19 hours: kernel: Out of memory: Kill process (squid)</H1>
    <B>Cherukuri, Naresh</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Crash%3A%20every%2019%20hours%3A%20kernel%3A%20Out%20of%20memory%3A%0A%20Kill%20process%20%28squid%29&In-Reply-To=%3C89638057A560FB458C01C197F81C7F5D18A8A0D8%40PACERS.amscan.corp%3E"
       TITLE="[squid-users] Crash: every 19 hours: kernel: Out of memory: Kill process (squid)">ncherukuri at partycity.com
       </A><BR>
    <I>Fri Aug 11 17:30:02 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016131.html">[squid-users] Crash: every 19 hours: kernel: Out of memory: Kill process (squid)
</A></li>
        <LI>Next message (by thread): <A HREF="016126.html">[squid-users] Crash: every 19 hours: kernel: Out of memory:	Kill	process (squid)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16132">[ date ]</a>
              <a href="thread.html#16132">[ thread ]</a>
              <a href="subject.html#16132">[ subject ]</a>
              <a href="author.html#16132">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank You Amos. Appreciate your help!

Thanks &amp; Regards,
Naresh

-----Original Message-----
From: Amos Jeffries [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>] 
Sent: Friday, August 11, 2017 12:50 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Cc: Cherukuri, Naresh
Subject: Re: [squid-users] Crash: every 19 hours: kernel: Out of memory: Kill process (squid)

On 12/08/17 01:13, Cherukuri, Naresh wrote:
&gt;<i> Amos,
</I>&gt;<i> 
</I>&gt;<i> Please find below my squid conf and access logs and memory output in MB. 
</I>&gt;<i> Appreciate any help.
</I>&gt;<i> 
</I>&gt;<i> Memory Info:
</I>&gt;<i> 
</I>&gt;<i> [root@******prod ~]# free -m
</I>&gt;<i> 
</I>&gt;<i>               total       used       free     shared    buffers     cached
</I>&gt;<i> 
</I>&gt;<i> Mem:         11845       4194       7651         41        190       1418
</I>&gt;<i> 
</I>&gt;<i> -/+ buffers/cache:       2585       9260
</I>&gt;<i> 
</I>&gt;<i> Swap:        25551        408      25143
</I>&gt;<i> 
</I>&gt;<i> Squidconf:
</I>&gt;<i> 
</I>&gt;<i> [root@******prod squid]# more squid.conf
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> max_filedesc 4096
</I>
Ouch. Squid requires between 2 and 6 sockets (FD) per client connection and clients tend to make upwards of 8 connections per domain being contacted (dozens per web page loaded). While HTTP/1.1 improvements can reduce that average a lot 4K FD cannot serve 7K clients well.

The above number should be at least 4x the expected client count to cope with load, at least 8x would be better for peak times.


&gt;<i> 
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> 
</I>&gt;<i> visible_hostname ******prod
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 10
</I>&gt;<i> 
</I>&gt;<i> access_log /cache/access.log
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 172.16.0.0/16
</I>&gt;<i> 
</I>&gt;<i> acl backoffice_users src 10.136.0.0/13
</I>&gt;<i> 
</I>&gt;<i> acl h****_backoffice_users src 10.142.0.0/15
</I>&gt;<i> 
</I>&gt;<i> acl re****_users src 10.128.0.0/13
</I>&gt;<i> 
</I>&gt;<i> acl hcity_r*****_users src 10.134.0.0/15
</I>&gt;<i> 
</I>
So you are immediately confusing &quot;users&quot; with &quot;clients&quot;. They are 
different, and at the Squid layer of networking the difference starts to 
matter.

For example; are you aware that automatic software and devices without 
any user logged in can still perform network transactions through the 
proxy? usually it is not a problem, but if you are thinking of only 
*users* utilizing the proxy you could be in for a major surprise.


&gt;<i> acl par**** url_regex par****
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 21         # ftp
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 70         # gopher
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 210                # wais
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> &gt; #acl Safe_ports port 280                # http-mgmt
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 488                # gss-http
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 591                # filemaker
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 777                # multiling http
</I>&gt;<i> 
</I>
NP: &quot;Safe_ports&quot; is meant to block HTTP connections made to ports whose 
defined protocols are known to be dangerous for HTTP messages to go to. 
Those protocols are so similar they can be confused with HTTP messages 
and things go badly wrong.

By doing the above you are making the default security rules (if you 
re-enable them) decide that any web API using a non-80 port is 
prohibited to all your clients.
eg. services like <A HREF="http://pc-sep.pcwhq.par****.net:8014/">http://pc-sep.pcwhq.par****.net:8014/</A> in your logs.


The above change to the default http_access security rules behaviour is 
probably why you had to move your custom config to the top of the 
http_access list - thus bypassing everything making use of the above 
ports definitions.


&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl backoffice_allowed_sites url_regex &quot;/etc/squid/backoffice_allowed_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> acl h***_backoffice_allowed_sites url_regex 
</I>&gt;<i> &quot;/etc/squid/backoffice_allowed_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> acl backoffice_blocked_sites url_regex &quot;/etc/squid/backoffice_blocklist&quot;
</I>&gt;<i> 
</I>&gt;<i> acl h***_backoffice_blocked_sites url_regex 
</I>&gt;<i> &quot;/etc/squid/backoffice_blocklist&quot;
</I>&gt;<i> 
</I>&gt;<i> acl re****_allowed_sites url_regex &quot;/etc/squid/re****_allowed_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> acl h****_reg****_allowed_sites url_regex 
</I>&gt;<i> &quot;/etc/squid/h***_reg*****_allowed_sites&quot;
</I>
Are all these URLs *actually* needing regex? regex is the second slowest 
and most memory consuming type of ACL Squid provides.

If you can reduce that to just domain names (which can have wildcard 
subdomains), the dstdomain ACL type would improve both memory and 
performance a fair bit.


&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet reg***_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access deny backoffice_users backoffice_blocked_sites
</I>&gt;<i> 
</I>&gt;<i> http_access deny h***_backoffice_users backoffice_blocked_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow backoffice_users backoffice_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow h***_backoffice_users backoffice_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow reg****_users reg****_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow h***_reg****_users h***_reg****_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> no_cache deny par****
</I>&gt;<i> 
</I>
&quot;no_cache&quot; has not existed for many years. Even &quot;cache&quot; directive is now 
deprecated.

Most likely you want to use &quot;store_miss deny ...&quot; to prevent caching of 
objects.



&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
&quot;deny all&quot; ... so none of the below security protections will work.

Your custom http_access lines should be down ....

&gt;<i> #http_access allow manager localhost
</I>&gt;<i> 
</I>&gt;<i> #http_access deny manager
</I>&gt;<i> 
</I>
(sure, manager report access can be moved or removed. In fact current 
recommendation is to place it after the CONNECT rule below.

BUT, be aware that removing it *allows* all clients to access the Squid 
management interfaces. Probably not what you intended with the above. 
Only sysadmin should need that access.
)

&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> 
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access  allow CONNECT SSL_ports
</I>
Oh boy. You are lucky these were disabled by the above &quot;deny all&quot;.

The default config rule was specifically crafted to prevent anonymous 
tunneling to send arbitrary bytes to arbitrary ports with no proxy 
control possible. Only HTTPS (port 443) is safe enough to deliver by 
default.

Other ports can be permitted if you need by adding to the SSL_Ports ACL. 
Absolutely DO NOT change that to an &quot;allow CONNECT&quot; like above.

&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> 
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> 
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> 
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>
... Your custom http_access lines should be down here. After the basic 
security protections.


&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> 
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> 
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> 
</I>&gt;<i> #http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump \
</I>&gt;<i> 
</I>&gt;<i> key=/etc/squid/pc****sslcerts/pc*****prod.pkey \
</I>&gt;<i> 
</I>&gt;<i> cert=/etc/squid/pc******sslcerts/pc*****prod.crt \
</I>&gt;<i> 
</I>
cert= before key=. The most recent Squid will complain loudly, and may 
not start if there is no cert to associate with the key.

&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>
You should also add the option sslflags=NO_DEFAULT_CA here.

This lack is probably a bit part of your memory problem as OpenSSL grabs 
a huge amount of memory per client connection (ouch!) to store the 
&quot;globally trusted CA&quot; certificates - which are pointless on that type of 
connection and never used in your setup.


&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> 
</I>&gt;<i> #ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump backoffice_users !localnet !h***_backoffice_users 
</I>&gt;<i> !reg****_users !h***_reg***_users !par***
</I>&gt;<i> 
</I>
Outwardly that may look reasonable, but it can be simplified a fair bit.

eg. A message sent by client whose IP is in the range 10.136.0.0/13 
cannot simultaneously be sent using an IP in the range 172.16.0.0/16 or 
10.128.0.0/13.

You only need to exclude (with '!') when the excluded ACL can match 
things that would otherwise be caught by the other ACLs in the list. For 
example the h****_backoffice_users is a subset of backoffice_users, and 
the par*** ACL matches a wholly different criteria than src-IP.



&gt;<i> #sslproxy_capath /etc/ssl/certs
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
Just no. Remove the above three lines. Then fix any TLS/SSL issues you 
find in a proper way - which will be different per-problem, and 
worthwhile fixing.

Since 3.2 Squid has been able to mimic errors in the fake certs it 
generates so silencing them is more harmful than good.

If there are errors that actually cannot be fixed AND happen to be safe 
for a proxy to hide from the end-user [be very sure of that first], then 
set only that error into an &quot;sslproxy_cert_error allow ...&quot; rule. Leave 
all other errors going on through to the client software, often they are 
better able to cope with it cleanly than the proxy can.


and for the log;

All these 403 look like the relevant URLs are not in your *_sites ACL 
definitions.

&gt;<i> 
</I>&gt;<i> 1502424001.504      0 10.138.142.6 TCP_DENIED/403 4175 GET 
</I>&gt;<i> <A HREF="http://update.scansoft.com/GetCertificate.asp?">http://update.scansoft.com/GetCertificate.asp?</A> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> 1502424001.533    329 10.140.230.6 TAG_NONE/200 0 CONNECT 
</I>&gt;<i> watson.telemetry.microsoft.com:443 - HIER_DIRECT/65.55.252.202 -
</I>&gt;<i> 
</I>&gt;<i> 1502424001.543      0 10.141.80.6 TCP_DENIED/403 4167 GET 
</I>&gt;<i> <A HREF="http://update.scansoft.com/Version.asp?">http://update.scansoft.com/Version.asp?</A> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> 1502424001.546    331 10.140.230.6 TAG_NONE/200 0 CONNECT 
</I>&gt;<i> watson.telemetry.microsoft.com:443 - HIER_DIRECT/65.55.252.202 -
</I>&gt;<i> 
</I>&gt;<i> 1502424001.551  29923 10.130.27.24 TCP_MISS_ABORTED/000 0 GET 
</I>&gt;<i> <A HREF="http://pc-sep.pcwhq.par****.net:8014/secars/secars.dll?">http://pc-sep.pcwhq.par****.net:8014/secars/secars.dll?</A> - 
</I>&gt;<i> HIER_DIRECT/10.1.2.35 -
</I>&gt;<i> 
</I>
That is a little more worrying, your web server at 10.1.2.35 appears not 
to be producing a response for at least 30sec.



&gt;<i> 
</I>&gt;<i> Cachelog errors I am seeing daily:
</I>&gt;<i> 
</I>&gt;<i> Error negotiating SSL connection on FD 26: error:140A1175:SSL 
</I>&gt;<i> routines:SSL_BYTES_TO_CIPHER_LIST:inappropriate fallback (1/-1)
</I>&gt;<i> 
</I>&gt;<i> Error negotiating SSL connection on FD 1175: error:14094416:SSL 
</I>&gt;<i> routines:SSL3_READ_BYTES:sslv3 alert certificate unknown (1/0)
</I>&gt;<i> 
</I>
First thing to do is ensure that your OpenSSL library is up to date. 
That should resolve most cipher and TLS protocol related issues.


Second thing is to ensure that the qa-certificates package (or whatever 
your OS calls it) is kept up to date. It changes every few weeks. 
Squid-3.x cannot download CA certs on demand so this is particularly 
important, and you may need to configure the 
sslproxy_foreign_intermediate_certs directive with additional and 
intermediate CA - only as needed and after checking them though.




&gt;<i> 2017/08/02 09:01:02 kid1| Error negotiating SSL on FD 989: 
</I>&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/-1/104) ##Very rare i found 
</I>&gt;<i> few not frequently
</I>&gt;<i> 
</I>
These opaque error codes tends to be non-TLS being pushed into port 443. 
It varies based on what software your clients are running.



&gt;<i> 2017/08/02 09:01:43 kid1| Queue overload, rejecting # too many times
</I>&gt;<i> 
</I>&gt;<i> 2017/08/02 09:01:45 kid1| Error negotiating SSL connection on FD 1749: 
</I>&gt;<i> (104) Connection reset by peer ## too many times
</I>&gt;<i> 
</I>&gt;<i> 2017/08/02 10:12:58 kid1| WARNING: Closing client connection due to 
</I>&gt;<i> lifetime timeout ## only one
</I>&gt;<i> 
</I>&gt;<i> 2017/08/07 22:37:56 kid1| comm_open: socket failure: (24) Too many open 
</I>&gt;<i> files
</I>
Either lack of FD or your OS has set a per-process open FD limit far too 
low for what Squid requires. Either HDD disk files or network socket 
limits result in the above message.

&gt;<i> 
</I>&gt;<i> 2017/08/07 22:39:37 kid1| WARNING: Error Pages Missing Language: en
</I>&gt;<i> 
</I>&gt;<i> 2017/08/07 22:39:37 kid1| '/usr/share/squid/errors/en-us/ERR_DNS_FAIL': 
</I>&gt;<i> (24) Too many open files
</I>&gt;<i> 
</I>&gt;<i> 2017/08/07 22:39:37 kid1| WARNING: Error Pages Missing Language: en-us
</I>&gt;<i> 
</I>
Your system appears to be missing the Squid langpack for error page 
localization. Or if you have one it needs updating to match the error 
pages your Squid version uses.
&lt;<A HREF="http://www.squid-cache.org/Versions/langpack/">http://www.squid-cache.org/Versions/langpack/</A>&gt;


&gt;<i> 2017/08/07 22:01:42 kid1| WARNING: All 32/32 ssl_crtd processes are busy.
</I>&gt;<i> 
</I>&gt;<i> 2017/08/07 22:01:42 kid1| WARNING: 32 pending requests queued
</I>&gt;<i> 
</I>&gt;<i> 2017/08/07 22:01:42 kid1| WARNING: Consider increasing the number of 
</I>&gt;<i> ssl_crtd processes in your config file.
</I>
As Squid said, you can try increasing the crtd processes being run.

Though the above says 32 running and your squid.conf sslcrtd_children 
directive says maximum of 8 to be run.


Alternatively, since you are bumping you may want to try Squid-4. The 
SSL-Bump code and behaviour is quite a bit better in the latest version 
even though it is in beta still.


&gt;<i> 
</I>&gt;<i> 2017/08/11 00:58:56 kid1| WARNING: Closing client connection due to 
</I>&gt;<i> lifetime timeout
</I>&gt;<i> 
</I>&gt;<i> 2017/08/09 12:55:45 kid1| WARNING! Your cache is running out of 
</I>&gt;<i> filedescriptors
</I>&gt;<i> 
</I>

Yes, well. I covered that already, the above just confirms it.


Amos
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016131.html">[squid-users] Crash: every 19 hours: kernel: Out of memory: Kill process (squid)
</A></li>
	<LI>Next message (by thread): <A HREF="016126.html">[squid-users] Crash: every 19 hours: kernel: Out of memory:	Kill	process (squid)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16132">[ date ]</a>
              <a href="thread.html#16132">[ thread ]</a>
              <a href="subject.html#16132">[ subject ]</a>
              <a href="author.html#16132">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
