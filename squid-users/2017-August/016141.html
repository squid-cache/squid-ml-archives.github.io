<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need help to solve problem with Squid 3.5.26 SSL Bump setting &amp; iptables rules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20to%20solve%20problem%20with%20Squid%203.5.26%20SSL%0A%20Bump%20setting%20%26%20iptables%20rules&In-Reply-To=%3CCAMwDxM27pWN5t3nQpmwFrrUF_8Rg1aqyF3FQh22dQX-_kzu_1Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016066.html">
   <LINK REL="Next"  HREF="016067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need help to solve problem with Squid 3.5.26 SSL Bump setting &amp; iptables rules</H1>
    <B>Arsalan Hussain</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20to%20solve%20problem%20with%20Squid%203.5.26%20SSL%0A%20Bump%20setting%20%26%20iptables%20rules&In-Reply-To=%3CCAMwDxM27pWN5t3nQpmwFrrUF_8Rg1aqyF3FQh22dQX-_kzu_1Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Need help to solve problem with Squid 3.5.26 SSL Bump setting &amp; iptables rules">arsalan at preston.edu.pk
       </A><BR>
    <I>Wed Aug 16 08:42:08 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016066.html">[squid-users] Need help to solve problem with Squid 3.5.26 SSL	Bump setting &amp; iptables rules
</A></li>
        <LI>Next message (by thread): <A HREF="016067.html">[squid-users] never_direct allow all causing 'ERROR 500: Internal	Server Error'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16141">[ date ]</a>
              <a href="thread.html#16141">[ thread ]</a>
              <a href="subject.html#16141">[ subject ]</a>
              <a href="author.html#16141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Eliezer

i had created new iptables configuration and it works fine for an hour
(attached)

both transparent proxy and with setting proxy clients accessing internet
through squid

but after every hour the service gets crash or unstable. and need to
restart squid and iptables services to work

i found the following error in access.log when service gets disturb. I
don't know the reason and such traffic what it is about and how to resolve
it. when we restart server, the services again start fine and internet
works.

1502858587.658 114260 192.168.2.162 TAG_NONE/503 0 CONNECT
dc.services.visualstudio.com:443 - HIER_NONE/- -
1502858587.658 114260 192.168.2.162 TAG_NONE/503 0 CONNECT
dc.services.visualstudio.com:443 - HIER_NONE/- -
1502858587.658 114258 192.168.5.1 TAG_NONE/503 0 CONNECT
update.googleapis.com:443 - HIER_NONE/- -
1502858587.658 114252 192.168.2.125 TAG_NONE/503 0 CONNECT
update.googleapis.com:443 - HIER_NONE/- -
1502858587.658 114256 192.168.2.188 TAG_NONE/503 0 CONNECT
en.wikibooks.org:443 - HIER_NONE/- -
1502858587.658 114256 192.168.2.188 TAG_NONE/503 0 CONNECT
en.wikibooks.org:443 - HIER_NONE/- -
1502858587.658 114256 192.168.2.188 TAG_NONE/503 0 CONNECT
en.wikibooks.org:443 - HIER_NONE/- -
1502858587.658 114256 192.168.2.188 TAG_NONE/503 0 CONNECT
en.wikibooks.org:443 - HIER_NONE/-



On Tue, Aug 1, 2017 at 5:17 PM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
wrote:

&gt;<i> Hey,
</I>&gt;<i>
</I>&gt;<i> The iptables rules doesn't make any sense:
</I>&gt;<i> IPTABLES SETTING
</I>&gt;<i>
</I>&gt;<i> # Generated by iptables-save v1.4.7 on Mon Jul 31 05:43:29 2017
</I>&gt;<i> *filter
</I>&gt;<i> :INPUT ACCEPT [0:0]
</I>&gt;<i> :FORWARD ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [8330155:414444635]
</I>&gt;<i> -A INPUT -i eth1 -j ACCEPT
</I>&gt;<i> -A INPUT -p tcp -m tcp --dport 3128 -j ACCEPT
</I>&gt;<i> -A INPUT -i lo -j ACCEPT
</I>&gt;<i> -A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3129
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3130
</I>&gt;<i> -A INPUT -j DROP
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Mon Jul 31 05:43:29 2017
</I>&gt;<i>
</I>&gt;<i> There is no PREROUTING in the filter table...
</I>&gt;<i> Take a peek at:
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/">http://wiki.squid-cache.org/ConfigExamples/Intercept/</A>
</I>&gt;<i> LinuxRedirect#iptables_configuration
</I>&gt;<i>
</I>&gt;<i> and also I suggest you to use intercept ports such as:
</I>&gt;<i> 13128 (for http, port 80)
</I>&gt;<i> 13129 ( for https, port 443)
</I>&gt;<i>
</I>&gt;<i> And not port 3130.
</I>&gt;<i>
</I>&gt;<i> Let me know if it helps with something.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> <A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;<i> Behalf Of Arsalan Hussain
</I>&gt;<i> Sent: Tuesday, August 1, 2017 12:45
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] Need help to solve problem with Squid 3.5.26 SSL
</I>&gt;<i> Bump setting &amp; iptables rules
</I>&gt;<i>
</I>&gt;<i> Dear all,
</I>&gt;<i> i have configured squid 3.5.26 SSL bump on CENTOS 6.2 to share internet
</I>&gt;<i> and delay pools to control bandwidth (my configuration files attached)
</I>&gt;<i>
</I>&gt;<i> Problem what i facing and not understanding the issue.
</I>&gt;<i>
</I>&gt;<i> 1- clients who send request-  proxy setting working fine with this
</I>&gt;<i> directive http_port 3128
</I>&gt;<i>  -  Delay pools working fine, internet browsing to all clients using proxy
</I>&gt;<i> is working.
</I>&gt;<i>
</I>&gt;<i> 2- When transparent proxy clients sent http request via iptables ...
</I>&gt;<i> REDIRECT.
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> OR
</I>&gt;<i> When transparent proxy clients sent https request via iptables ...
</I>&gt;<i> REDIRECT.
</I>&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.pem
</I>&gt;<i> I observed the problem in both cases when client sent request through
</I>&gt;<i> IPTABLES Squid service got failed. When i stop iptables and start squid
</I>&gt;<i> then it start working.
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3129
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3130
</I>&gt;<i>
</I>&gt;<i> 3-  my objective to setup squid.
</I>&gt;<i>      *  Internet sharing to Proxy setting configured clients.
</I>&gt;<i>      *  Internet sharing to Proxy Transparent clients (Those request
</I>&gt;<i> directed to server from ip route 0.0.0.0 0.0.0.0 Proxy-IP from CISCO
</I>&gt;<i> Network for HTTP and HTTPS Requests without configuring proxy setting
</I>&gt;<i> (coming from wireless).
</I>&gt;<i>      *  delay pools for HTTP and HTTPS both browsing for proxy &amp;
</I>&gt;<i> transparent clients.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Kindly if somebody help me to fix my problems and if share any setting
</I>&gt;<i> which works. I had added ssl bump certificate because the service was
</I>&gt;<i> crashing again and again without any reason after a few days or sometime on
</I>&gt;<i> same day.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> With Regards,
</I>&gt;<i>
</I>&gt;<i> Arsalan Hussain
</I>&gt;<i> If you don't fight for what you want, don't cry for what you lose.
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
With Regards,


*Arsalan Hussain*
*Assistant Director, Networks &amp; Information System*

*PRESTON UNIVERSITY*
Add: Plot: 85, Street No: 3, Sector H-8/1, Islamabad, Pakistan
Cell: +92-322-5018611
UAN: (51) 111-707-808 (Ext: 443)
*Don't expect to see a change if you don't make one.*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170816/074e043f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170816/074e043f/attachment.htm</A>&gt;
-------------- next part --------------
# Generated by iptables-save v1.4.7 on Mon Apr 10 06:06:53 2017


*filter
:<i>
</I>INPUT DROP [0:0]
:<i>
</I>FORWARD ACCEPT [0:0]:
OUTPUT ACCEPT [0:0]:
-A INPUT -i lo -j ACCEPT 

-A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT 

-A INPUT -i eth1 -j ACCEPT 


-A FORWARD -i eth1 -j ACCEPT 

-A OUTPUT -o lo -j ACCEPT 

-A OUTPUT -o eth1 -j ACCEPT 

COMMIT
# 

Completed on Mon Apr 10 06:06:53 2017
# 
Generated by iptables-save v1.4.7 on Mon Apr 10 06:06:53 2017

*nat
:<i>
</I>PREROUTING ACCEPT [96:4818]
:<i>POSTROUTING ACCEPT [1:108]
</I>:<i>OUTPUT ACCEPT [1:108]
</I>
-A PREROUTING -i eth1 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.4.12:3129 

-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3129
-A POSTROUTING -o eth0 -j MASQUERADE 

COMMIT


# Completed on Mon Apr 10 06:06:53 2017
# Generated by iptables-save v1.4.7 on Mon Apr 10 06:06:53 2017

*mangle
:<i>PREROUTING ACCEPT 
</I>[169:10596]

:<i>INPUT ACCEPT [164:10396]
</I>:<i>
</I>FORWARD ACCEPT [0:0]
:<i>
</I>OUTPUT ACCEPT [138:8328]
:<i>
</I>POSTROUTING ACCEPT [138:8328]
COMMIT
# Completed on Mon Apr 10 06:06:53 2017
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Iptables rule new.png
Type: image/png
Size: 28055 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170816/074e043f/attachment.png">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170816/074e043f/attachment.png</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016066.html">[squid-users] Need help to solve problem with Squid 3.5.26 SSL	Bump setting &amp; iptables rules
</A></li>
	<LI>Next message (by thread): <A HREF="016067.html">[squid-users] never_direct allow all causing 'ERROR 500: Internal	Server Error'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16141">[ date ]</a>
              <a href="thread.html#16141">[ thread ]</a>
              <a href="subject.html#16141">[ subject ]</a>
              <a href="author.html#16141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
