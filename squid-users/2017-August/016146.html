<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Intermittent 409 Error to google.com
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intermittent%20409%20Error%20to%20google.com&In-Reply-To=%3C68a58024-2e3d-a474-36d1-8344601a21f0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016145.html">
   <LINK REL="Next"  HREF="016147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Intermittent 409 Error to google.com</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intermittent%20409%20Error%20to%20google.com&In-Reply-To=%3C68a58024-2e3d-a474-36d1-8344601a21f0%40treenet.co.nz%3E"
       TITLE="[squid-users] Intermittent 409 Error to google.com">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Aug 17 09:06:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016145.html">[squid-users] Intermittent 409 Error to google.com
</A></li>
        <LI>Next message (by thread): <A HREF="016147.html">[squid-users] Memory leak (was: Squid 3.x never_direct and DNS	requests problem.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16146">[ date ]</a>
              <a href="thread.html#16146">[ thread ]</a>
              <a href="subject.html#16146">[ subject ]</a>
              <a href="author.html#16146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/08/17 20:18, hoje wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I have setup a squid server (squid-3.5.26-20170702-r14182) to filter
</I>&gt;<i> http/https. It was working fine with up to 90 users except one thing. Few
</I>&gt;<i> PCs  would not be able connect to https sites (e.g google,yahoo,facebook)
</I>&gt;<i> intermittently. By clearing SSL State in user PCs (Windows-&gt;Control
</I>&gt;<i> Panel-&gt;Internet Properties) , it helps sometime (sometime not). Please
</I>&gt;<i> advice. Thank you.
</I>
This is &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt;. 
Google domains have issues due to their large numbers of DNS entries and 
rotating in and out of view. The workarounds listed at the bottom of 
that page may be of some use to reduce the problem, but unfortunately it 
is not yet completely resolvable.


There are also some improvements you can make to the config below.

&gt;<i> 
</I>&gt;<i> my squid setup
</I>&gt;<i> ----------------
</I>&gt;<i> (WAN)---(router)---(linux+bridge+squid)---(user)
</I>&gt;<i> 
</I>&gt;<i> e.g access.log
</I>&gt;<i> ---------------
</I>&gt;<i> 1502955689.139      0 10.40.21.24 TAG_NONE/409 4088 CONNECT
</I>&gt;<i> www.google.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> my squid.conf
</I>&gt;<i> ---------------
</I>&gt;<i> max_filedesc 65535
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> request_timeout 5 minutes
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access allow localnet manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 0.0.0.0:3128 intercept
</I>&gt;<i> http_port 0.0.0.0:3130
</I>&gt;<i> https_port 0.0.0.0:3129 intercept ssl-bump connection-auth=off
</I>&gt;<i> cert=/etc/squid/squidCA.pem
</I>
Add the option sslflags=NO_DEFAULT_CA

&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Remove these 3 lines. They are either old hacks no longer necessary, or 
outright wrong for use.

You may see some TLS/SSL errors occuring after removing. Look into those 
issues carefully and use an appropriate fix for the problems you see. 
The above is not a fix.

&gt;<i> 
</I>&gt;<i> acl test ssl::server_name &quot;/etc/squid/test.txt&quot;
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump terminate test
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> cache_dir ufs /var/spool/squid 15360 16 256
</I>&gt;<i> cache_swap_low 87
</I>&gt;<i> cache_swap_high 90
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard
</I>&gt;<i> redirect_program /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>
Replace both the above lines with this line (mind the wrap):

  url_rewrite_program /usr/bin/squidGuard  -c 
/etc/squidguard/squidGuard.conf


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016145.html">[squid-users] Intermittent 409 Error to google.com
</A></li>
	<LI>Next message (by thread): <A HREF="016147.html">[squid-users] Memory leak (was: Squid 3.x never_direct and DNS	requests problem.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16146">[ date ]</a>
              <a href="thread.html#16146">[ thread ]</a>
              <a href="subject.html#16146">[ subject ]</a>
              <a href="author.html#16146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
