<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20client--%3Eiptables--%3Esquid-proxy-%3Eanother-proxy&In-Reply-To=%3CCAD8MJvA3AKZsaNzJshiymV4ZmtpV70oKWz9gTpYrRo-ZfXc_HA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016180.html">
   <LINK REL="Next"  HREF="016161.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy</H1>
    <B>Diogenes S. Jesus</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20client--%3Eiptables--%3Esquid-proxy-%3Eanother-proxy&In-Reply-To=%3CCAD8MJvA3AKZsaNzJshiymV4ZmtpV70oKWz9gTpYrRo-ZfXc_HA%40mail.gmail.com%3E"
       TITLE="[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy">splash at gmail.com
       </A><BR>
    <I>Sun Aug 20 02:38:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016180.html">[squid-users] Content Adaptation with HTTPs
</A></li>
        <LI>Next message (by thread): <A HREF="016161.html">[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16158">[ date ]</a>
              <a href="thread.html#16158">[ thread ]</a>
              <a href="subject.html#16158">[ subject ]</a>
              <a href="author.html#16158">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>For those looking into this topic, I was able to make it work on 3.5.
The trick is to have &quot;ssl_bump splice all&quot;.
My upstream proxy is 10.1.7.7:3128.
This is all in Ubuntu 16.04 - however the squid package was rebuilt due to
lack of --with-openssl and --enable-ssl (there are several guides on the
internet on how to rebuild a package, I used this one
&lt;<A HREF="https://docs.diladele.com/administrator_guide_4_0/system_configuration/https_filtering/recompile_squid.html">https://docs.diladele.com/administrator_guide_4_0/system_configuration/https_filtering/recompile_squid.html</A>&gt;
as reference, there are also third-party .debs if you trust them).

* squid.conf:
-----------------------
acl localhost src 127.0.0.0/8
acl localnet src 192.168.100.0/24 192.168.101.0/24 172.16.0.0/12
acl SSL_ports port 443
acl Safe_ports port 80 # http
acl Safe_ports port 443 # https
acl CONNECT method CONNECT

http_access allow  localhost localnet
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny all

http_port 3128 accel vhost allow-direct

ssl_bump splice all
https_port 3129 ssl-bump intercept cert=/etc/squid/ssl_cert/myca.pem

cache_peer 10.1.7.7 parent 3128 0 no-query no-digest
never_direct allow all

shutdown_lifetime 2 seconds

* iptables (PRE-ROUTING required if you're using e.g. docker - your
containers will also not need proxy config):
-----------------------
iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 3129
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 3128
iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner proxy --dport 80 -j
REDIRECT --to-port 3128
iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner proxy --dport 443
-j REDIRECT --to-port 3129


Cheers


On Tue, Jun 13, 2017 at 9:35 AM, Madonna, A. (spir-it) &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">A.Madonna at rechtspraak.nl</A>&gt; wrote:

&gt;<i> Hello Jeryl,
</I>&gt;<i>
</I>&gt;<i> If you look on the mailing list we and many before us have this problem.
</I>&gt;<i>
</I>&gt;<i> Client ----&gt; Squid proxy ----&gt; Parent proxy ----&gt; Internets (http / HTTPS)
</I>&gt;<i>
</I>&gt;<i> As already stated by 1 of the developers before, the code simply does not
</I>&gt;<i> exist to handle this. cache_peer can't do a &quot;HTTP CONNECT&quot;, simulating the
</I>&gt;<i> first client connection with a parent proxy.
</I>&gt;<i>
</I>&gt;<i> This has been so for at least the last 5+ years.
</I>&gt;<i>
</I>&gt;<i> We are now looking into a solution where we put something between the
</I>&gt;<i> squid and the parent proxy which can provide a &quot;HTTP CONNECT&quot; in
</I>&gt;<i> combination with ssl_bump preserving the original SNI(server name
</I>&gt;<i> indication).
</I>&gt;<i>
</I>&gt;<i> Client ----&gt; Squid proxy ----&gt; &quot;HTTP CONNECT&quot; solution----&gt;Parent proxy
</I>&gt;<i> ----&gt; Internets (http / HTTPS)
</I>&gt;<i>
</I>&gt;<i> Kind regards,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Oorspronkelijk bericht-----
</I>&gt;<i> Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;<i> Namens Amos Jeffries
</I>&gt;<i> Verzonden: dinsdag 13 juni 2017 5:41
</I>&gt;<i> Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Onderwerp: Re: [squid-users] client--&gt;iptables--&gt;squid-
</I>&gt;<i> proxy-&gt;another-proxy
</I>&gt;<i>
</I>&gt;<i> On 13/06/17 08:33, JerylCook wrote:
</I>&gt;<i> &gt; I've been stuck on this for a few days :P...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   I 'thought' I had a fairly good understanding of squid + ssl_bump
</I>&gt;<i> &gt; but not so sure.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In a nutshell i am having an issue linking a second proxy server via
</I>&gt;<i> &gt; cache_peer.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; we have 2 boxes.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *Configuration:*
</I>&gt;<i> &gt; 1 box, has iptables configured to send all outbound traffic to
</I>&gt;<i> &gt; 10.0.0.1:8999 which is the second box's squid server and port(8999)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2nd box, has squid running on 8999, we have another server running on
</I>&gt;<i> 8998.
</I>&gt;<i> &gt; both proxy servers are using the same 'CA'.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; https 10.0.0.1:8999 transparent ssl-bump generate-host-certificates=on.
</I>&gt;<i> ....
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_peer 10.0.0.1:8998 8998 0 ssl default no-query no-digest
</I>&gt;<i> &gt; sslflags=DONT_VERIFY_PEER....
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; use-case:
</I>&gt;<i> &gt; wget <A HREF="https://facebook.com">https://facebook.com</A> --ca-cert=/dat/sharedCa.cer  , on box 1
</I>&gt;<i> &gt; through iptables..
</I>&gt;<i> &gt; 1. squid on box 2 generates and signs a certificate with
</I>&gt;<i> &gt; CN=facebook.com for the client
</I>&gt;<i>
</I>&gt;<i> That sounds a little suspicious to me. FB have a more complicated CN in
</I>&gt;<i> their real certs. You omitted your ssl_bump rules, so the type of bumping
</I>&gt;<i> and details available are unknown - but I suspect they may not be doing
</I>&gt;<i> what you expect in that case.
</I>&gt;<i>
</I>&gt;<i> &gt; 2. client trusts the CA and cert.
</I>&gt;<i>
</I>&gt;<i> Which if the three CA involved? they need to trust the one being used by
</I>&gt;<i> the frontend Squid cert generator.
</I>&gt;<i>   Only frontend Squid needs to trust the backend peer CA. And likewise,
</I>&gt;<i> only the backend peer needs to trust the origin CA.
</I>&gt;<i>
</I>&gt;<i> &gt; 3.we want squid to send this proxied https request to the second proxy
</I>&gt;<i> &gt; server on :8998. this proxy server is set to generate impersonation
</I>&gt;<i> &gt; certs as well using the same rootCAKey that squid uses...
</I>&gt;<i>
</I>&gt;<i> This is where the current behaviour is lacking AFAIK. SSL-Bump assumes the
</I>&gt;<i> client (frontend Squid) is either sending a CONNECT request to get the
</I>&gt;<i> server details from, or that it is working with intercepted TLS rather than
</I>&gt;<i> a TLS explicit proxy connection. So the backend behaviour is still very
</I>&gt;<i> much just receive a request for <A HREF="https://">https://</A> URL and do the serve TLS thing -
</I>&gt;<i> no mimicing on its client connection (AFAIK).
</I>&gt;<i>
</I>&gt;<i> &gt; however, we keep getting
</I>&gt;<i> &gt; &quot;Failed to establish a secure connection, SQUID_ERR_SSL_HANDSHAKE&quot;,
</I>&gt;<i> &gt; Handshake with SSL Server failed: error:140770FC:SSL routines
</I>&gt;<i> &gt; SSL23_GET_SERVER_HELLO: unknown protocol&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Does squid 3.5.20 support PROXY Protocol in cache_peer if you need to
</I>&gt;<i> &gt; link a second proxy? or is my configuration messed up.
</I>&gt;<i>
</I>&gt;<i> Squid only supports receiving PROXY Protocol on the http_port directive.
</I>&gt;<i> Not yet sending to a cache_peer. Though I don't see any relevance to PROXY
</I>&gt;<i> Protocol in anything you have described about your configuration.
</I>&gt;<i>
</I>&gt;<i> If the peer is sending an error back to Squid when it gets TLS instead of
</I>&gt;<i> PROXY intro octets that would explain the SSL errors. It also would if the
</I>&gt;<i> peer was sending back HTTP messages instead of TLS (HTTPS), which is a more
</I>&gt;<i> common problem when the peer is an older Squid.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> SSL-Bump is supported to cache_peer when the peer connection is a TLS/SSL
</I>&gt;<i> connection. Though be aware that the &quot;server&quot; frontend Squid mimics would
</I>&gt;<i> then be the backend peer's certificate, not the origin server.
</I>&gt;<i>
</I>&gt;<i> Also, avoid DONT_VERIFY_PEER, it is really doing more harm than anything
</I>&gt;<i> useful. Since this is a peer you know about you should also know its CA in
</I>&gt;<i> advance. So use &quot;sslflags=NO_DEFAULT_CA sslcafile=...&quot; and Squid can do all
</I>&gt;<i> the security checks just fine regardless of whether its a custom CA or not.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> ________________________________
</I>&gt;<i>
</I>&gt;<i> Informatie van de Raad voor de rechtspraak, de rechtbanken, de
</I>&gt;<i> gerechtshoven en de bijzondere colleges vindt u op www.rechtspraak.nl.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


-- 

--------

Diogenes S. de Jesus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170820/4a166727/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170820/4a166727/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016180.html">[squid-users] Content Adaptation with HTTPs
</A></li>
	<LI>Next message (by thread): <A HREF="016161.html">[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16158">[ date ]</a>
              <a href="thread.html#16158">[ thread ]</a>
              <a href="subject.html#16158">[ subject ]</a>
              <a href="author.html#16158">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
