<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Reverse Proxy and WebDAV caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Reverse%20Proxy%20and%20WebDAV%20caching&In-Reply-To=%3Ca4148264-0a92-4032-31d1-0a6a46da072c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016203.html">
   <LINK REL="Next"  HREF="016210.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Reverse Proxy and WebDAV caching</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Reverse%20Proxy%20and%20WebDAV%20caching&In-Reply-To=%3Ca4148264-0a92-4032-31d1-0a6a46da072c%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Reverse Proxy and WebDAV caching">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 25 09:18:32 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016203.html">[squid-users] Squid Reverse Proxy and WebDAV caching
</A></li>
        <LI>Next message (by thread): <A HREF="016210.html">[squid-users] Squid Reverse Proxy and WebDAV caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16207">[ date ]</a>
              <a href="thread.html#16207">[ thread ]</a>
              <a href="subject.html#16207">[ subject ]</a>
              <a href="author.html#16207">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/08/17 20:18, Olivier MARCHETTA wrote:
&gt;<i> Hello Amos,
</I>&gt;<i> 
</I>&gt;<i> Thank you for your help.
</I>&gt;<i> I have probably misconfigured the refresh_pattern in my config file.
</I>&gt;<i> Below more information.
</I>&gt;<i> My squid conf file:
</I>&gt;<i> 
</I>&gt;<i> ---------------------------------------------------------------------
</I>&gt;<i> http_port 10.10.10.10:3128
</I>
You said this was a reverse-proxy. This config file is for a 
forward/explicit proxy.

A reverse-proxy with the role you stated earlier would be configured with:

   http_port 3128
   http_port 80 accel
   https_port 443 accel cert=.. key=...
   cache_peer tenant.sharepoint.com parent 80 0 originserver
   acl SP dstdomain tenant.sharepoint.com
   cache_peer_access tenant.sharepoint.com allow SP
   http_access allow SP


&gt;<i> icp_port 0
</I>&gt;<i> digest_generation off
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> pid_filename /var/run/squid/squid.pid
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group proxy
</I>&gt;<i> error_default_language en
</I>&gt;<i> icon_directory /usr/local/etc/squid/icons
</I>&gt;<i> visible_hostname pfSense Firewall
</I>
As the name of the directive above indicates it is supposed to be a 
*hostname*. More specifically it is the publicly visible FQDN of the 
Squid server. It will be used in error pages URLs for fetching the icons 
etc.

&quot;<A HREF="http://pfsense">http://pfsense</A> Firewall/&quot; is a pretty funny URL for Squid.



&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">pfsense at mycomp.cloud</A>
</I>&gt;<i> access_log /var/squid/logs/access.log
</I>&gt;<i> cache_log /var/squid/logs/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> netdb_filename /var/squid/logs/netdb.state
</I>&gt;<i> pinger_enable on
</I>&gt;<i> pinger_program /usr/local/libexec/squid/pinger
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 7
</I>&gt;<i> debug_options rotate=7
</I>&gt;<i> shutdown_lifetime 3 seconds
</I>&gt;<i> # Allow local network(s) on interface(s)
</I>&gt;<i> acl localnet src  10.10.10.0/24
</I>&gt;<i> forwarded_for on
</I>&gt;<i> uri_whitespace strip
</I>&gt;<i> 
</I>&gt;<i> cache_mem 128 MB
</I>&gt;<i> maximum_object_size_in_memory 20 MB
</I>&gt;<i> memory_replacement_policy heap GDSF
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 20 MB
</I>&gt;<i> cache_dir ufs /var/squid/cache 300 16 256
</I>&gt;<i> offline_mode on
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> cache allow all
</I>
NP: its pretty pointless to configure things to their default values. 
You can simplify your config quite a lot by removing many of the above 
lines.

&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>
Please re-read the above sentence from your squid.conf.

Order is important. &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/OrderIsImportant">https://wiki.squid-cache.org/SquidFaq/OrderIsImportant</A>&gt;

&gt;<i> refresh_pattern ^ftp:    1440  20%  10080
</I>&gt;<i> refresh_pattern ^gopher:  1440  0%  1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0  0%  0
</I>&gt;<i> refresh_pattern .    0  20%  4320
</I>&gt;<i> refresh_pattern -i \.jpg$ 30 50% 4320 ignore-reload ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.pdf$ 30 50% 4320 ignore-reload ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.docx$ 30 50% 4320 ignore-reload ignore-no-cache ignore-no-store ignore-private
</I>

Also,

&gt;<i> 
</I>&gt;<i> #Remote proxies
</I>&gt;<i> 
</I>&gt;<i> # Setup some default acls
</I>&gt;<i> # ACLs all, manager, localhost, and to_localhost are predefined.
</I>&gt;<i> acl allsrc src all
</I>
I suggest you double-check anywhere you are using the &quot;allsrc&quot; ACL. If 
it is not explicitly being used as a name to attach a deny_info to then 
it is a pointless waste of memory to redefine like this - just use the 
built-in 'all' ACL name.


&gt;<i> acl safeports port 21 70 80 210 280 443 488 563 591 631 777 901 4443 3128 3129 1025-65535
</I>
NP: with the 1025-65535 set of ports listed you don't need to have 
explicit entries for those ports higher than 1025.

Also, since this was apparently a reverse-proxy for HTTP and the log 
seems to show HTTPS as well - it will not be receiving any of those 
ports on URLs other than 80 and 443.


&gt;<i> acl sslports port 443 563 4443
</I>&gt;<i> ---------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Squid access log:
</I>&gt;<i> ---------------------------------------------------------------------
</I>&gt;<i> Date   IP   Status   Address   User   Destination
</I>&gt;<i> 24.08.2017 12:42:18   10.10.10.100   TCP_MISS/200   <A HREF="https://tenant.sharepoint.com/sites/Marketing/Shared%20Documents/picture.jpg">https://tenant.sharepoint.com/sites/Marketing/Shared%20Documents/picture.jpg</A>
</I>&gt;<i> 24.08.2017 12:42:17   10.10.10.100   TCP_MISS/200   <A HREF="https://tenant.sharepoint.com/sites/Marketing/Shared%20Documents/large1.pdf">https://tenant.sharepoint.com/sites/Marketing/Shared%20Documents/large1.pdf</A>
</I>&gt;<i> 24.08.2017 12:42:16   10.10.10.100   TCP_MISS/200   <A HREF="https://tenant.sharepoint.com/sites/Marketing/Shared%20Documents/large1.docx">https://tenant.sharepoint.com/sites/Marketing/Shared%20Documents/large1.docx</A>
</I>&gt;<i> ---------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The cache manager info:
</I>&gt;<i> ---------------------------------------------------------------------
</I>&gt;<i> Cache information for squid:
</I>&gt;<i>     Hits as % of all requests:   5min: 0.0%, 60min: 0.0%
</I>&gt;<i>     Hits as % of bytes sent:   5min: 0.0%, 60min: 0.0%
</I>&gt;<i>     Memory hits as % of hit requests:   5min: 0.0%, 60min: 0.0%
</I>&gt;<i>     Disk hits as % of hit requests:   5min: 0.0%, 60min: 0.0%
</I>&gt;<i>     Storage Swap size:   0 KB
</I>&gt;<i>     Storage Swap capacity:    0.0% used, 100.0% free
</I>&gt;<i>     Storage Mem size:   216 KB
</I>&gt;<i>     Storage Mem capacity:    0.2% used, 99.8% free
</I>&gt;<i>     Mean Object Size:   0.00 KB
</I>&gt;<i> ---------------------------------------------------------------------
</I>&gt;<i> 
</I>
Okay, not much caching. You got that debug trace?

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016203.html">[squid-users] Squid Reverse Proxy and WebDAV caching
</A></li>
	<LI>Next message (by thread): <A HREF="016210.html">[squid-users] Squid Reverse Proxy and WebDAV caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16207">[ date ]</a>
              <a href="thread.html#16207">[ thread ]</a>
              <a href="subject.html#16207">[ subject ]</a>
              <a href="author.html#16207">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
