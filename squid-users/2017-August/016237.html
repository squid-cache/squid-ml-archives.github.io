<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20problem&In-Reply-To=%3C642256d3-c15c-9512-87ee-72a04826661d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016231.html">
   <LINK REL="Next"  HREF="016242.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl problem</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20problem&In-Reply-To=%3C642256d3-c15c-9512-87ee-72a04826661d%40treenet.co.nz%3E"
       TITLE="[squid-users] acl problem">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug 29 19:37:55 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016231.html">[squid-users] acl problem
</A></li>
        <LI>Next message (by thread): <A HREF="016242.html">[squid-users] Your cache is running out of filedescriptors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16237">[ date ]</a>
              <a href="thread.html#16237">[ thread ]</a>
              <a href="subject.html#16237">[ subject ]</a>
              <a href="author.html#16237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/08/17 03:12, Alex Guti&#233;rrez Mart&#237;nez wrote:
&gt;<i> Hello community, I just installed squid 3.3.8 on ubuntu 14.04. The use 
</I>&gt;<i> of this software is only providing the Internet to my users. But 
</I>&gt;<i> something is wrong with my setup. I must clarify that I use as an 
</I>&gt;<i> authentication system the Ldap plug-in that comes with squid.
</I>&gt;<i> The problem is that some acl, although apparently well written, are not 
</I>&gt;<i> working the way I expect. Specifically those blocking social sites and 
</I>&gt;<i> prohibited sites.
</I>
Ah, there are no rules blocking social and advertising sites.
You have some rules *allowing* access to various groups, then some 
blanket denial of everything else.

The problem is actually your allow rule not doing what you seem to 
expect of them. Specifically the first one.

...
&gt;<i> acl basic_ldap_auth proxy_auth REQUIRED
</I>&gt;<i> http_access allow basic_ldap_auth
</I>
Anyone who can login is allowed to use this proxy. End of story for 
authenticated users.

Note that the &quot;REQUIRED&quot; value in the ACL does not mean proxy access 
requires credentials. It means that the ACL will non-match unless a 
valid login is given. The &quot;allow&quot; action in turn then means a non-match 
simply skips that line.

Anyone who sends invalid credentials to the proxy _will_ fly straight 
past this first access control without being challenged, anyone lacking 
credentials entirely *might* be challenged to supply some depending on 
what ACL types your later rules use.


Overall &quot;allow&quot; is a very unreliable way to do authentication security.
Instead you should start with denying clients who cannot supply valid 
logins. Like so:

   http_access deny !basic_ldap_auth

... then do the group checks etc which rely on those credentials.


&gt;<i> #http_access deny all
</I>&gt;<i> ########################################################
</I>&gt;<i> #restricciones selectivas#
</I>&gt;<i> ########################################################
</I>&gt;<i> acl dmz src 172.16.4.0/27
</I>&gt;<i> acl navegacion src 192.168.9.0/24
</I>&gt;<i> acl full external Group InternetFull
</I>&gt;<i> acl limitado external Group InternetLimitado
</I>&gt;<i> acl sociales dstdomain -n &quot;/etc/squid3/bloqueo/sociales&quot;
</I>&gt;<i> acl extensiones urlpath_regex -i &quot;/etc/squid3/bloqueo/listaextensiones&quot;
</I>
... but no valid credentials means no group. These cannot match right 
now and so get skipped.

While it may have appeared that these allow lines were working, it was 
in fact the earlier &quot;allow basic_ldap_auth&quot; line letting users in the 
group &quot;full&quot; (and any other group) through.


&gt;<i> http_access allow full sociales
</I>&gt;<i> http_access allow full limitado navegacion
</I>&gt;<i> http_access allow full dmz
</I>&gt;<i> ########################################################
</I>&gt;<i> #restricciones obligadas#
</I>&gt;<i> ########################################################
</I>&gt;<i> #acl blacklist url_regex -i &quot;/etc/squid3/listanegra&quot;
</I>&gt;<i> #http_access deny blacklist
</I>&gt;<i> acl bl7 dstdomain -n &quot;/etc/squid3/bloqueo/correos&quot;
</I>&gt;<i> http_access allow full !limitado bl7
</I>

Here you have a bunch of stuff being denied based on group. BUT, the 
last thing is &quot;deny all&quot; with no possibility of allow from here on down. 
So all these slow checking group and regex ACLs are pretty pointless, 
even if the group checks could work with invalid logins.

If any request reaches this spot of the access list it is going to be 
denied. So &quot;deny all&quot; is sufficient, no need to do all the following 
complex stuff first.


&gt;<i> acl bl1 url_regex -i &quot;/etc/squid3/bloqueo/porno&quot;
</I>&gt;<i> http_access deny bl1
</I>&gt;<i> acl bl2 url_regex -i &quot;/etc/squid3/bloqueo/android&quot;
</I>&gt;<i> http_access deny bl2
</I>&gt;<i> acl bl3 url_regex -i &quot;/etc/squid3/bloqueo/prox1&quot;
</I>&gt;<i> http_access deny bl3
</I>&gt;<i> acl bl4 url_regex -i &quot;/etc/squid3/bloqueo/prox2&quot;
</I>&gt;<i> http_access deny bl4
</I>&gt;<i> acl bl5 url_regex -i &quot;/etc/squid3/bloqueo/prox3&quot;
</I>&gt;<i> http_access deny bl5
</I>&gt;<i> acl bl6 url_regex -i &quot;/etc/squid3/bloqueo/prox4&quot;
</I>&gt;<i> http_access deny bl6
</I>&gt;<i> #acl ladmin src &quot;/etc/squid3/ladmin&quot;
</I>&gt;<i> http_access deny all
</I>

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016231.html">[squid-users] acl problem
</A></li>
	<LI>Next message (by thread): <A HREF="016242.html">[squid-users] Your cache is running out of filedescriptors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16237">[ date ]</a>
              <a href="thread.html#16237">[ thread ]</a>
              <a href="subject.html#16237">[ subject ]</a>
              <a href="author.html#16237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
