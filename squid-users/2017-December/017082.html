<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Block a web just for a group inside another group, or how?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Block%20a%20web%20just%20for%20a%20group%20inside%20another%20group%2C%20or%20how%3F&In-Reply-To=%3Ce2a0fb83-263d-80b6-d099-781ccc3ea06b%40bgs.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017077.html">
   <LINK REL="Next"  HREF="017083.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Block a web just for a group inside another group, or how?</H1>
    <B>Bgs</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Block%20a%20web%20just%20for%20a%20group%20inside%20another%20group%2C%20or%20how%3F&In-Reply-To=%3Ce2a0fb83-263d-80b6-d099-781ccc3ea06b%40bgs.hu%3E"
       TITLE="[squid-users] Block a web just for a group inside another group, or how?">bgs at bgs.hu
       </A><BR>
    <I>Tue Dec  5 12:14:39 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017077.html">[squid-users] Block a web just for a group inside another group, or how?
</A></li>
        <LI>Next message (by thread): <A HREF="017083.html">[squid-users] net::err_cert_common_name_invalid just in squid page with dstdomain block
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17082">[ date ]</a>
              <a href="thread.html#17082">[ thread ]</a>
              <a href="subject.html#17082">[ subject ]</a>
              <a href="author.html#17082">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
 &#160;Hi,

In general, the basic idea is this:

ACLs:

LARGEGROUP (eg. all users)
SMALLGROUP (subset of LARGEGROUP you want to further filter)

SMALLBLACKLIST (site list for SMALLGROUP)

http_access deny SMALLGROUP SMALLBLACKLIST
http_access allow LARGEGROUP [whatever]
http_access deny all

You could technically do this too:

http_access allow SMALLGROUP !SMALLBLACKLIST [whatever]
http_access allow LARGEGROUP !SMALLGROUP [whatever]
http_access deny all

But it's more difficult to follow and maintain. (For instance, you need 
to specify the 'whatever' logic twice, instead of once. Also, if 
'whatever' is achieved on multiple lines, things are further complicated.)

When handling exceptions, handle them first, then the more general ones.

Cheers,
Bgs


On 04/12/2017 20:51, erdosain9 wrote:
&gt;<i> Hi to all.
</I>&gt;<i> I want to block web.whatsapp.com in some users.
</I>&gt;<i> But i already have those users in other group.
</I>&gt;<i> I suppose this is not a problem if i put the acl in some order... but its
</I>&gt;<i> not working.
</I>&gt;<i>
</I>&gt;<i> For example, i have group
</I>&gt;<i> I-FULL: user1, user2, user3
</I>&gt;<i>
</I>&gt;<i> I-RESTRINGIDOS: user1
</I>&gt;<i>
</I>&gt;<i> This is my config file
</I>&gt;<i>
</I>&gt;<i> ####GRUPOS DE IP
</I>&gt;<i> acl sin_autenticacion src &quot;/etc/squid/listas/sin_autenticacion.lst&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ###Kerberos Auth with ActiveDirectory###
</I>&gt;<i> auth_param negotiate program /lib64/squid/negotiate_kerberos_auth -s
</I>&gt;<i> HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid.domain.lan at DOMAIN.LAN</A>
</I>&gt;<i> auth_param negotiate children 35 startup=0 idle=1
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i>
</I>&gt;<i> external_acl_type i-restringidos %LOGIN
</I>&gt;<i> /usr/lib64/squid/ext_kerberos_ldap_group_acl -g <A HREF="https://lists.squid-cache.org/listinfo/squid-users">i-restringidos at DOMAIN.LAN</A>
</I>&gt;<i> external_acl_type i-full %LOGIN /usr/lib64/squid/ext_kerberos_ldap_group_acl
</I>&gt;<i> -g <A HREF="https://lists.squid-cache.org/listinfo/squid-users">i-full at DOMAIN.LAN</A>
</I>&gt;<i> external_acl_type i-limitado %LOGIN
</I>&gt;<i> /usr/lib64/squid/ext_kerberos_ldap_group_acl -g <A HREF="https://lists.squid-cache.org/listinfo/squid-users">i-limitado at DOMAIN.LAN</A>
</I>&gt;<i>
</I>&gt;<i> #GRUPOS
</I>&gt;<i> acl i-restringidos external i-restringidos
</I>&gt;<i> acl i-full external i-full
</I>&gt;<i> acl i-limitado external i-limitado
</I>&gt;<i>
</I>&gt;<i> ####Bloquea Publicidad ( <A HREF="http://pgl.yoyo.org/adservers/">http://pgl.yoyo.org/adservers/</A> )
</I>&gt;<i> acl ads dstdom_regex &quot;/etc/squid/listas/ad_block.lst&quot;
</I>&gt;<i> http_access deny ads
</I>&gt;<i> #deny_info TCP_RESET ads
</I>&gt;<i>
</I>&gt;<i> ####Streaming
</I>&gt;<i> acl youtube url_regex -i \.flv$
</I>&gt;<i> acl youtube url_regex -i \.mp4$
</I>&gt;<i> acl youtube url_regex -i watch?
</I>&gt;<i> acl youtube url_regex -i youtube
</I>&gt;<i> acl facebook url_regex -i facebook
</I>&gt;<i> acl facebook url_regex -i fbcdn\.net\/v\/(.*\.mp4)\?
</I>&gt;<i> acl facebook url_regex -i fbcdn\.net\/v\/(.*\.jpg)\?
</I>&gt;<i> acl facebook url_regex -i akamaihd\.net\/v\/(.*\.mp4)\?
</I>&gt;<i> acl facebook url_regex -i akamaihd\.net\/v\/(.*\.jpg)\?
</I>&gt;<i>
</I>&gt;<i> ##Dominios denegados
</I>&gt;<i> *acl restringidos dstdomain &quot;/etc/squid/listas/restringidos.lst&quot; (here is
</I>&gt;<i> .whatsapp.com)
</I>&gt;<i> *acl dominios_denegados dstdomain &quot;/etc/squid/listas/dominios_denegados.lst&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #Puertos
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 4443
</I>&gt;<i> acl SSL_ports port 8443
</I>&gt;<i> acl SSL_ports port 8080
</I>&gt;<i> acl SSL_ports port 20000
</I>&gt;<i> acl SSL_ports port 10000
</I>&gt;<i> acl SSL_ports port 2083
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 631         # httpCUPS
</I>&gt;<i> acl Safe_ports port 85
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 4443        # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 8443        # httpsalt
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl Safe_ports port 8080        # edesur y otros
</I>&gt;<i> acl Safe_ports port 2199	# radio
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow sin_autenticacion
</I>&gt;<i> *http_access allow i-restringidos !restringidos
</I>&gt;<i> *http_access allow i-limitado !dominios_denegados
</I>&gt;<i> *http_access allow i-full !dominios_denegados
</I>&gt;<i> *http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 127.0.0.1:3128
</I>&gt;<i> http_port 192.168.1.215:3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myca.pem
</I>&gt;<i> key=/etc/squid/ssl_cert/myca.pem
</I>&gt;<i>
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i>
</I>&gt;<i> acl excludeSSL ssl::server_name_regex &quot;/etc/squid/listas/excluidosSSL.lst&quot;
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice excludeSSL
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> #tcp_outgoing_address
</I>&gt;<i>
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> cache_dir diskd /var/spool/squid 15000 16 256
</I>&gt;<i> cache_mem 500 MB
</I>&gt;<i> #maximum_object_size_in_memory 1 MB
</I>&gt;<i>
</I>&gt;<i> cache_swap_low 70
</I>&gt;<i> cache_swap_high 85
</I>&gt;<i>
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #Your refresh_pattern
</I>&gt;<i> refresh_pattern -i \.jpg$ 30 0% 30 ignore-no-cache ignore-no-store
</I>&gt;<i> ignore-private
</I>&gt;<i> refresh_pattern -i ^http:\/\/www\.google\.com\/$ 0 20% 360 override-expire
</I>&gt;<i> override-lastmod ignore-reload ignore-no-cache ignore-no-store
</I>&gt;<i> reload-into-ims ignore-must-revalidate
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i>
</I>&gt;<i> ###ACTIVAR EN CASO DE &quot;Connection reset by peer&quot; EN MUCHOS HOST
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>&gt;<i>
</I>&gt;<i> request_header_access From deny all
</I>&gt;<i> request_header_access Server deny all
</I>&gt;<i> request_header_access WWW-Authenticate deny all
</I>&gt;<i> request_header_access Link deny all
</I>&gt;<i> request_header_access Cache-Control deny all
</I>&gt;<i> request_header_access Proxy-Connection deny all
</I>&gt;<i> request_header_access X-Cache deny all
</I>&gt;<i> request_header_access X-Cache-Lookup deny all
</I>&gt;<i> request_header_access Via deny all
</I>&gt;<i> request_header_access X-Forwarded-For deny all
</I>&gt;<i> request_header_access Pragma deny all
</I>&gt;<i> request_header_access Keep-Alive deny all
</I>&gt;<i>
</I>&gt;<i> ###
</I>&gt;<i>
</I>&gt;<i> #Pools para ancho de banda
</I>&gt;<i> delay_pools 5
</I>&gt;<i>
</I>&gt;<i> #Ancho de Youtube
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 1000000/1000000 10000/100000
</I>&gt;<i> delay_access 1 allow i-limitado youtube !facebook
</I>&gt;<i> delay_access 1 deny all
</I>&gt;<i>
</I>&gt;<i> #Ancho de Facebook
</I>&gt;<i> delay_class 2 2
</I>&gt;<i> delay_parameters 2 1000000/1000000 50000/256000
</I>&gt;<i> delay_access 2 allow i-limitado facebook !youtube
</I>&gt;<i> delay_access 2 deny all
</I>&gt;<i>
</I>&gt;<i> #Ancho de banda YOUTUBE FULL
</I>&gt;<i> delay_class 3 1
</I>&gt;<i> delay_parameters 3 1000000/1000000
</I>&gt;<i> delay_access 3 allow i-full youtube !facebook
</I>&gt;<i> delay_access 3 deny all
</I>&gt;<i>
</I>&gt;<i> #Ancho de banda LIMITADO
</I>&gt;<i> delay_class 4 2
</I>&gt;<i> delay_parameters 4 4000000/4000000 100000/500000
</I>&gt;<i> delay_access 4 allow i-limitado !youtube !facebook
</I>&gt;<i> delay_access 4 deny all
</I>&gt;<i>
</I>&gt;<i> #Ancho de banda FULL
</I>&gt;<i> delay_class 5 2
</I>&gt;<i> delay_parameters 5 4000000/4000000 500000/1000000
</I>&gt;<i> delay_access 5 allow i-full !youtube !facebook
</I>&gt;<i> delay_access 5 deny all
</I>&gt;<i>
</I>&gt;<i> dns_nameservers 192.168.1.10 192.168.1.22
</I>&gt;<i> visible_hostname squid.domain.lan
</I>&gt;<i>
</I>&gt;<i> # try connecting to first 25 ips of a domain name
</I>&gt;<i> forward_max_tries 25
</I>&gt;<i>
</I>&gt;<i> # fix some ipv6 errors (recommended to comment out)
</I>&gt;<i> dns_v4_first on
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Can somebody give me a hand??
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017077.html">[squid-users] Block a web just for a group inside another group, or how?
</A></li>
	<LI>Next message (by thread): <A HREF="017083.html">[squid-users] net::err_cert_common_name_invalid just in squid page with dstdomain block
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17082">[ date ]</a>
              <a href="thread.html#17082">[ thread ]</a>
              <a href="subject.html#17082">[ subject ]</a>
              <a href="author.html#17082">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
