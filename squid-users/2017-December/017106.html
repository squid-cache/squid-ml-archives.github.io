<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL TAG_NONE/503 errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20TAG_NONE/503%20errors&In-Reply-To=%3C0ED074EB-141F-42C6-B332-9AE8F9F92813%40data-core.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017105.html">
   <LINK REL="Next"  HREF="017107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL TAG_NONE/503 errors</H1>
    <B>Enrico Heine</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20TAG_NONE/503%20errors&In-Reply-To=%3C0ED074EB-141F-42C6-B332-9AE8F9F92813%40data-core.org%3E"
       TITLE="[squid-users] SSL TAG_NONE/503 errors">flashdown at data-core.org
       </A><BR>
    <I>Wed Dec  6 17:51:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017105.html">[squid-users] SSL TAG_NONE/503 errors
</A></li>
        <LI>Next message (by thread): <A HREF="017107.html">[squid-users] SSL TAG_NONE/503 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17106">[ date ]</a>
              <a href="thread.html#17106">[ thread ]</a>
              <a href="subject.html#17106">[ subject ]</a>
              <a href="author.html#17106">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Can you confirm that squid is able to resolve these hostnames? If not try browsing to them without https and check if squid gives you an error message.

Did you check the cache.log as well?

Br Enrico

Am 6. Dezember 2017 17:38:24 MEZ schrieb Hugo Saavedra &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hugo.saavedra.oteiza at gmail.com</A>&gt;:
&gt;<i>Hi All,
</I>&gt;<i>
</I>&gt;<i>We have the following setup of a transparent squid box:
</I>&gt;<i>OS: CentOS release 6.9 (Final)
</I>&gt;<i>Squid Cache: Version 3.5.26-20170625-r14174
</I>&gt;<i>Compile options:
</I>&gt;<i>   '--with-included-ltdl' '--enable-icap-client'
</I>&gt;<i>'--enable-delay-pools' '--with-openssl' '--enable-ssl-crtd'
</I>&gt;<i>'--enable-icmp' '--enable-snmp' '--prefix=/usr'
</I>&gt;<i>'--includedir=/usr/include' '--datadir=/usr/share'
</I>&gt;<i>'--bindir=/usr/sbin' '--libexecdir=/usr/lib/squid'
</I>&gt;<i>'--localstatedir=/var' '--sysconfdir=/etc/squid'
</I>&gt;<i>--enable-ltdl-convenience
</I>&gt;<i>
</I>&gt;<i>Endpoints are redirected to the Squid box using a policy route for
</I>&gt;<i>TCP80/443 on a Fortigate firewall. All http/80 traffic works well. We
</I>&gt;<i>are using ssl bump for ssl, but there is an strange behavior, some
</I>&gt;<i>websites opens well, but some ones breaks and getting TAG_NONE/503
</I>&gt;<i>errors in the access log:
</I>&gt;<i>
</I>&gt;<i>1512561423.930      1 192.168.1.108 TAG_NONE/503 31435 POST
</I>&gt;<i><A HREF="https://api.chatlio.com/v1/p/visitor/session/new">https://api.chatlio.com/v1/p/visitor/session/new</A> - HIER_NONE/-
</I>&gt;<i>text/html
</I>&gt;<i>1512562220.870      1 192.168.1.158 TAG_NONE/503 12386 GET
</I>&gt;<i><A HREF="https://tile-service.weather.microsoft.com/es-CL/livetile/front/-33.44,-70.65?">https://tile-service.weather.microsoft.com/es-CL/livetile/front/-33.44,-70.65?</A>
</I>&gt;<i>- HIER_NONE/- text/html
</I>&gt;<i>1512562220.870      1 192.168.1.158 TAG_NONE/503 12386 GET
</I>&gt;<i><A HREF="https://service.weather.microsoft.com/appex/DesktopTile/Badge?">https://service.weather.microsoft.com/appex/DesktopTile/Badge?</A> -
</I>&gt;<i>HIER_NONE/- text/html
</I>&gt;<i>1512566858.355    186 192.168.1.104 TAG_NONE/503 31436 GET
</I>&gt;<i><A HREF="https://www.mercantil.com/empresa/reac-importadora-spa/estaci%C3%B3n-central/300469639/esp">https://www.mercantil.com/empresa/reac-importadora-spa/estaci%C3%B3n-central/300469639/esp</A>
</I>&gt;<i>- HIER_NONE/- text/html
</I>&gt;<i>
</I>&gt;<i>In the same time-range, other websites loads well
</I>&gt;<i>
</I>&gt;<i>1512561134.548    306 192.168.1.112 TCP_MISS/302 572 GET
</I>&gt;<i><A HREF="https://loadm.exelator.com/load/?">https://loadm.exelator.com/load/?</A> - ORIGINAL_DST/63.251.252.12
</I>&gt;<i>image/gif
</I>&gt;<i>1512561139.701    216 192.168.1.148 TCP_MISS/200 386 POST
</I>&gt;<i><A HREF="https://cloud-ecs.gravityzone.bitdefender.com/hydra-">https://cloud-ecs.gravityzone.bitdefender.com/hydra-</A>
</I>&gt;<i>ORIGINAL_DST/107.20.215.8 application/json
</I>&gt;<i>1512561142.180     13 192.168.1.112 TCP_MISS/200 419 GET
</I>&gt;<i><A HREF="https://www.facebook.com/tr/?">https://www.facebook.com/tr/?</A> - ORIGINAL_DST/179.60.193.35 image/gif
</I>&gt;<i>1512561142.410    243 192.168.1.112 TCP_MISS/200 286 GET
</I>&gt;<i><A HREF="https://bam.nr-data.net/1/ef1706da28?">https://bam.nr-data.net/1/ef1706da28?</A> - ORIGINAL_DST/162.247.242.21
</I>&gt;<i>text/javascript
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>IPTABLES CONFIGURATION
</I>&gt;<i>=======================
</I>&gt;<i># PREROUTING INTERCEPT PBR
</I>&gt;<i>
</I>&gt;<i>*nat
</I>&gt;:<i>PREROUTING ACCEPT [0:0]
</I>&gt;:<i>POSTROUTING ACCEPT [0:0]
</I>&gt;:<i>OUTPUT ACCEPT [0:0]
</I>&gt;<i>-A PREROUTING -i eth0 -p tcp -m tcp --dport 8080 -j REDIRECT --to-ports
</I>&gt;<i>3128
</I>&gt;<i>-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports
</I>&gt;<i>3128
</I>&gt;<i>-A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports
</I>&gt;<i>3129
</I>&gt;<i>COMMIT
</I>&gt;<i>
</I>&gt;<i>*filter
</I>&gt;:<i>INPUT ACCEPT [0:0]
</I>&gt;:<i>FORWARD ACCEPT [0:0]
</I>&gt;:<i>OUTPUT ACCEPT [0:0]
</I>&gt;<i>
</I>&gt;<i>#WEB
</I>&gt;<i>-A INPUT -m state --state NEW,RELATED,ESTABLISHED -m tcp -p tcp
</I>&gt;<i>--dport 80 -j ACCEPT
</I>&gt;<i>-A INPUT -m state --state NEW,RELATED,ESTABLISHED -m tcp -p tcp
</I>&gt;<i>--dport 443 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i>-A INPUT -m state --state NEW,RELATED,ESTABLISHED -m tcp -p tcp
</I>&gt;<i>--dport 3128 -j ACCEPT
</I>&gt;<i>-A INPUT -m state --state NEW,RELATED,ESTABLISHED -m tcp -p tcp
</I>&gt;<i>--dport 3129 -j ACCEPT
</I>&gt;<i>-A INPUT -m state --state NEW,RELATED,ESTABLISHED -m tcp -p tcp
</I>&gt;<i>--dport 3130 -j ACCEPT
</I>&gt;<i>-A INPUT -m state --state NEW,RELATED,ESTABLISHED -m tcp -p tcp
</I>&gt;<i>--dport 3131 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i>#default
</I>&gt;<i>-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</I>&gt;<i>-A INPUT -p icmp -j ACCEPT
</I>&gt;<i>-A INPUT -i lo -j ACCEPT
</I>&gt;<i>-A INPUT -j REJECT --reject-with icmp-host-prohibited
</I>&gt;<i>-A FORWARD -j REJECT --reject-with icmp-host-prohibited
</I>&gt;<i>COMMIT
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>SQUID CONFIGURATION
</I>&gt;<i>====================
</I>&gt;<i>
</I>&gt;<i>#WHITE LIST
</I>&gt;<i>acl exclWL url_regex &quot;/etc/squid/white_url.squid&quot;
</I>&gt;<i>acl neoWL url_regex &quot;/etc/squid/neowl.squid&quot;
</I>&gt;<i>http_access allow exclWL
</I>&gt;<i>http_access allow neoWL
</I>&gt;<i>cache deny exclWL
</I>&gt;<i>cache deny neoWL
</I>&gt;<i>always_direct allow exclWL
</I>&gt;<i>always_direct allow neoWL
</I>&gt;<i>
</I>&gt;<i>#Malicious URLs
</I>&gt;<i>acl dom url_regex &quot;/etc/squid/dom.squid&quot;
</I>&gt;<i>acl cc url_regex &quot;/etc/squid/cc.squid&quot;
</I>&gt;<i>http_access deny dom
</I>&gt;<i>http_access deny cc
</I>&gt;<i>
</I>&gt;<i>#BLACK LIST
</I>&gt;<i>acl exclBL url_regex &quot;/etc/squid/black_url.squid&quot;
</I>&gt;<i>acl neoBL url_regex &quot;/etc/squid/neobl.squid&quot;
</I>&gt;<i>http_access deny exclBL
</I>&gt;<i>http_access deny neoBL
</I>&gt;<i>
</I>&gt;<i>#ACLS BASE
</I>&gt;<i>acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i>acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i>acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i>acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i>acl localnet src fe80::/10      # RFC 4291 link-local (directly
</I>&gt;<i>plugged) machines
</I>&gt;<i>acl SSL_ports port 443
</I>&gt;<i>acl SSL_ports port 3129
</I>&gt;<i>acl Safe_ports port 80          # http
</I>&gt;<i>acl Safe_ports port 21          # ftp
</I>&gt;<i>acl Safe_ports port 443         # https
</I>&gt;<i>acl Safe_ports port 70          # gopher
</I>&gt;<i>acl Safe_ports port 210         # wais
</I>&gt;<i>acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i>acl Safe_ports port 280         # http-mgmt
</I>&gt;<i>acl Safe_ports port 488         # gss-http
</I>&gt;<i>acl Safe_ports port 591         # filemaker
</I>&gt;<i>acl Safe_ports port 777         # multiling http
</I>&gt;<i>acl CONNECT method CONNECT
</I>&gt;<i>acl HTTPS proto HTTPS
</I>&gt;<i>
</I>&gt;<i>include /etc/squid/acls_whitelist.conf
</I>&gt;<i>acl useragent browser &quot;/etc/squid/useragent.squid&quot;
</I>&gt;<i>range_offset_limit 0 !useragent
</I>&gt;<i>minimum_object_size 0 bytes
</I>&gt;<i>maximum_object_size 3 GB
</I>&gt;<i>quick_abort_min -1
</I>&gt;<i>delay_pools 1
</I>&gt;<i>delay_class 1 1
</I>&gt;<i>delay_parameters 1 128000/128000
</I>&gt;<i>delay_access 1 deny SSL_ports
</I>&gt;<i>delay_access 1 allow !useragent
</I>&gt;<i>delay_access 1 deny all
</I>&gt;<i>
</I>&gt;<i>#cache conf
</I>&gt;<i>max_filedescriptors 24576
</I>&gt;<i>memory_cache_mode disk
</I>&gt;<i>cache_mem 0 MB
</I>&gt;<i>cache allow all
</I>&gt;<i>minimum_object_size 0 bytes
</I>&gt;<i>maximum_object_size 20 MB
</I>&gt;<i>sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i>connect_timeout 8 seconds
</I>&gt;<i>
</I>&gt;<i>http_access deny !Safe_ports
</I>&gt;<i>http_access deny CONNECT !SSL_ports
</I>&gt;<i>http_access allow localhost manager
</I>&gt;<i>http_access deny manager
</I>&gt;<i>http_access allow localnet
</I>&gt;<i>http_access allow localhost
</I>&gt;<i>http_access deny all
</I>&gt;<i>reply_header_access Alternate-Protocol deny all
</I>&gt;<i>
</I>&gt;<i>http_port 3130
</I>&gt;<i>http_port 3131 ssl-bump cert=/etc/squid/ssl_cert/SIC.pem
</I>&gt;<i>generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i>http_port 3128 intercept
</I>&gt;<i>https_port 3129 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i>dynamic_cert_mem_cache_size=16MB cert=/etc/squid/ssl_cert/SIC.pem
</I>&gt;<i>
</I>&gt;<i>cache_dir ufs /var/cache/squid 9000 16 256
</I>&gt;<i>cache_store_log /var/log/squid/store.log
</I>&gt;<i>cache_effective_user squid
</I>&gt;<i>visible_hostname Proxy
</I>&gt;<i>
</I>&gt;<i>refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i>refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i>refresh_pattern -i (/cgi-bin/|\?) 2     20%     10
</I>&gt;<i>refresh_pattern .               2       20%     10      ignore-reload
</I>&gt;<i>override-expire ignore-no-cache ignore-no-store store-stale
</I>&gt;<i>ignore-private ignore-must-revalidate ignore-auth
</I>&gt;<i>refresh_pattern -i
</I>&gt;<i>\.(dmg|msi|deb|rpm|exe|zip|tar|tgz|ram|rar|bin|ppt|doc|tiff|pdf)$ 1
</I>&gt;<i>20% 4 override-expire ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i>reload-into-ims
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>#SSL BUMP
</I>&gt;<i>include /etc/squid/ssl.conf
</I>&gt;<i>
</I>&gt;<i>#LOGGING
</I>&gt;<i>access_log /var/log/squid/access.log
</I>&gt;<i>access_log /var/log/squid/access_c2.log cc
</I>&gt;<i>access_log /var/log/squid/access_c2.log dom
</I>&gt;<i>access_log /var/log/squid/splc.log excludeSSL
</I>&gt;<i>cache_log /dev/null
</I>&gt;<i>coredump_dir /var/cache/squid
</I>&gt;<i>
</I>&gt;<i>#ICAP
</I>&gt;<i>icap_enable on
</I>&gt;<i>icap_send_client_ip on
</I>&gt;<i>icap_send_client_username on
</I>&gt;<i>icap_client_username_header X-Authenticated-User
</I>&gt;<i>icap_service service_req reqmod_precache bypass=1
</I>&gt;<i><A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i>adaptation_access service_req allow useragent
</I>&gt;<i>icap_service service_resp respmod_precache bypass=1
</I>&gt;<i><A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i>adaptation_access service_resp allow useragent
</I>&gt;<i>
</I>&gt;<i>#X FORWARDED FOR
</I>&gt;<i>forwarded_for on
</I>&gt;<i>
</I>&gt;<i>SSL.conf
</I>&gt;<i>=======
</I>&gt;<i>
</I>&gt;<i>sslproxy_foreign_intermediate_certs /etc/squid/intermediate_ca.pem
</I>&gt;<i>sslproxy_cafile /etc/squid/intermediate_ca.pem
</I>&gt;<i>sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 16MB
</I>&gt;<i>sslcrtd_children 16 startup=5 idle=1
</I>&gt;<i>
</I>&gt;<i>acl FakeCert ssl::server_name .apple.com
</I>&gt;<i>acl FakeCert ssl::server_name .icloud.com
</I>&gt;<i>acl FakeCert ssl::server_name .mzstatic.com
</I>&gt;<i>acl FakeCert ssl::server_name .dropbox.com
</I>&gt;<i>acl ssl_step1 at_step SslBump1
</I>&gt;<i>acl ssl_step2 at_step SslBump2
</I>&gt;<i>acl ssl_step3 at_step SslBump3
</I>&gt;<i>
</I>&gt;<i>ssl_bump peek ssl_step1
</I>&gt;<i>ssl_bump splice GlobalWhitelistDSTNet
</I>&gt;<i>ssl_bump splice GlobalWhitelistDomainsRx
</I>&gt;<i>ssl_bump splice GlobalWhitelistDomains
</I>&gt;<i>ssl_bump splice FakeCert
</I>&gt;<i>ssl_bump bump ssl_step2 all
</I>&gt;<i>ssl_bump splice all
</I>&gt;<i>sslproxy_options NO_SSLv2,NO_SSLv3,No_Compression
</I>&gt;<i>sslproxy_cipher
</I>&gt;<i>ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL
</I>&gt;<i>sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i>sslproxy_cert_error allow all
</I>&gt;<i>sslproxy_cert_error deny all
</I>&gt;<i>
</I>&gt;<i>acls_whitelist.conf
</I>&gt;<i>=============
</I>&gt;<i>
</I>&gt;<i>acl WindowsUpdates dstdomain officecdn.microsoft.com
</I>&gt;<i>acl WindowsUpdates dstdomain windowsupdate.microsoft.com
</I>&gt;<i>acl WindowsUpdates dstdomain ntservicepack.microsoft.com
</I>&gt;<i>acl WindowsUpdates dstdomain download.microsoft.com
</I>&gt;<i>acl WindowsUpdates dstdomain .windowsupdate.com
</I>&gt;<i>acl WindowsUpdates dstdomain .windowsupdate.net
</I>&gt;<i>acl WindowsUpdates dstdomain .update.microsoft.com
</I>&gt;<i>acl WindowsUpdates dstdomain .mp.microsoft.com
</I>&gt;<i>acl WindowsUpdates dstdomain .ws.microsoft.com
</I>&gt;<i>acl GlobalWhitelistDomains dstdomain
</I>&gt;<i>&quot;/etc/squid/acls_whitelist.dstdomain.conf&quot;
</I>&gt;<i>acl GlobalWhitelistDSTNet dst &quot;/etc/squid/acls_whitelist.dst.conf&quot;
</I>&gt;<i>acl GlobalWhitelistDomainsRx dstdom_regex -i
</I>&gt;<i>&quot;/etc/squid/acls_whitelist.dstdom_regex.conf&quot;
</I>&gt;<i>acl GlobalWhitelistBrowsers browser -i
</I>&gt;<i>&quot;/etc/squid/acls_whitelist.browser.conf&quot;
</I>&gt;<i>http_access allow GlobalWhitelistDomains
</I>&gt;<i>url_rewrite_access deny GlobalWhitelistDomains
</I>&gt;<i>http_access allow GlobalWhitelistDSTNet
</I>&gt;<i>url_rewrite_access deny GlobalWhitelistDSTNet
</I>&gt;<i>http_access allow GlobalWhitelistDomainsRx
</I>&gt;<i>url_rewrite_access deny GlobalWhitelistDomainsRx
</I>&gt;<i>http_access allow GlobalWhitelistBrowsers
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Any one with the same TAG_NONE/503 error, please help!?
</I>&gt;<i>
</I>&gt;<i>Regards,
</I>&gt;<i>Hugo
</I>&gt;<i>_______________________________________________
</I>&gt;<i>squid-users mailing list
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i><A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
Diese Nachricht wurde von meinem Android-Ger&#228;t mit K-9 Mail gesendet.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171206/76130600/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171206/76130600/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017105.html">[squid-users] SSL TAG_NONE/503 errors
</A></li>
	<LI>Next message (by thread): <A HREF="017107.html">[squid-users] SSL TAG_NONE/503 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17106">[ date ]</a>
              <a href="thread.html#17106">[ thread ]</a>
              <a href="subject.html#17106">[ subject ]</a>
              <a href="author.html#17106">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
