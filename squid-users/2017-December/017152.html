<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL3_GET_SERVER_CERTIFICATE failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL3_GET_SERVER_CERTIFICATE%20failed&In-Reply-To=%3C8465a21e-a41d-3fa3-22ba-36b51630d7f8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017151.html">
   <LINK REL="Next"  HREF="017153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL3_GET_SERVER_CERTIFICATE failed</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL3_GET_SERVER_CERTIFICATE%20failed&In-Reply-To=%3C8465a21e-a41d-3fa3-22ba-36b51630d7f8%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL3_GET_SERVER_CERTIFICATE failed">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Dec 11 02:24:09 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017151.html">[squid-users] SSL3_GET_SERVER_CERTIFICATE failed
</A></li>
        <LI>Next message (by thread): <A HREF="017153.html">[squid-users] SSL3_GET_SERVER_CERTIFICATE failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17152">[ date ]</a>
              <a href="thread.html#17152">[ thread ]</a>
              <a href="subject.html#17152">[ subject ]</a>
              <a href="author.html#17152">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/12/17 14:06, G~D~Lunatic wrote:
&gt;<i> my squid is a transparent proxy.
</I>
You have an interception proxy. It is modifying the TCP/IP packets with 
NAT and the TLS handshakes with SSL-Bump stare+bump.
&lt;<A HREF="https://tools.ietf.org/html/rfc3040#section-2.1">https://tools.ietf.org/html/rfc3040#section-2.1</A>&gt;
&lt;<A HREF="https://tools.ietf.org/html/rfc3040#section-2.5">https://tools.ietf.org/html/rfc3040#section-2.5</A>&gt;

To be properly a &quot;transparent proxy&quot; requires use of TPROXY interception 
on the http_port and peek+splice on the ssl_bump.


&gt;<i> when i use WeChat client upload file or picture, it failed.
</I>
Please explain &quot;it failed&quot;.
  What does the client receive ?
  What is received when it does not fail ?

Please also be aware that securely written App's use &quot;certificate 
pinning&quot; or similar mechanisms to ensure their traffic is not 
intercepted / bump'ed. There is nothing Squid can do about those - they 
*will* fail if bumping is attempted.


&gt;<i> the access.log shows that
</I>&gt;<i> 1512953345.798&#160;&#160;&#160;&#160; 75 192.168.51.15 TAG_NONE/200 0 CONNECT 
</I>&gt;<i> 111.206.23.97:443 - ORIGINAL_DST/111.206.23.97 -
</I>
The above is a TCP connection reaching SSL-Bump step2 bump'ing. No TLS 
SNI was provided by the client.


&gt;<i> 1512953345.805&#160;&#160;&#160;&#160;&#160; 0 192.168.51.15 TAG_NONE/503 4380 POST 
</I>&gt;<i> <A HREF="https://msg.71.am/v5/ypt/hcdn_multicurl">https://msg.71.am/v5/ypt/hcdn_multicurl</A> - HIER_NONE/- text/html
</I>
The above looks like Squid delivering an error about something going 
wrong in the TLS handshake. IIRC Alex already mentioned to you that 
Squid bump's these TLS handshakes with invalid certs to deliver errors 
in a way that Browsers will display.

It may or may not be related to the earlier CONNECT line. Details of the 
error are found within the encrypted 503 response itself, not logged.


The below are all different TCP connections being stare'd at step1.


&gt;<i> 1512953349.713&#160;&#160;&#160;&#160; 10 192.168.51.15 TAG_NONE/200 0 CONNECT 
</I>&gt;<i> 101.226.152.108:443 - HIER_NONE/- -
</I>&gt;<i> 1512953350.931&#160;&#160;&#160;&#160; 10 192.168.51.15 TAG_NONE/200 0 CONNECT 
</I>&gt;<i> 123.151.76.49:443 - HIER_NONE/- -
</I>&gt;<i> 1512953354.059&#160;&#160;&#160;&#160; 11 192.168.51.15 TAG_NONE/200 0 CONNECT 
</I>&gt;<i> 123.151.76.49:443 - HIER_NONE/- -
</I>&gt;<i> 
</I>&gt;<i> i used wireshark catch the package, Encrypted Alert was shown.
</I>&gt;<i> i want to know where the problem or how i can do.
</I>
The only int of a problem is that 503 being generated by Squid due to 
something unknown. No details of what might be causing that are visible 
in any of the info you provided.


&gt;<i> Here is my configure
</I>&gt;<i> 
</I>&gt;<i> https_port 192.168.51.200:3129 intercept ssl-bump connection-auth=off 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>&gt;<i> cert=/usr/local/squid/ssl_cert/myCA.pem 
</I>&gt;<i> key=/usr/local/squid/ssl_cert/myCA.pem options=NO_SSLv3,NO_SSLv2
</I>&gt;<i> 
</I>
When cert= and key= are the same file, you do not have to configure the 
key= option.

The dynamic_cert_mem_cache_size=4MB is the default value, no need to 
configure defaults explicitly like that.

One test to try is removing that options= setting. If the problem goes 
away then the client TLS handshake is requiring SSL. Use of that 
protocol is bad, but still sometimes unavoidable.


&gt;<i> 
</I>&gt;<i> acl broken_sites ssl::server_name matchweb.sports.qq.com
</I>&gt;<i> acl ssl_step1 at_step SslBump1
</I>&gt;<i> acl ssl_step2 at_step SslBump2
</I>&gt;<i> acl ssl_step3 at_step SslBump3
</I>&gt;<i> ssl_bump splice broken_sites
</I>&gt;<i> #ssl_bump splice all
</I>&gt;<i> ssl_bump stare ssl_step1
</I>&gt;<i> ssl_bump bump ssl_step2
</I>&gt;<i> ssl_bump terminate ssl_step3
</I>&gt;<i> 
</I>
The absence of a stare at step2 prohibits the ability of Squid to mimic 
server details in the TLS handshake it delivers to the client. Without 
mimic the chances of TLS failure get *much* greater.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017151.html">[squid-users] SSL3_GET_SERVER_CERTIFICATE failed
</A></li>
	<LI>Next message (by thread): <A HREF="017153.html">[squid-users] SSL3_GET_SERVER_CERTIFICATE failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17152">[ date ]</a>
              <a href="thread.html#17152">[ thread ]</a>
              <a href="subject.html#17152">[ subject ]</a>
              <a href="author.html#17152">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
