<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid asking for authentication repeatedly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20asking%20for%20authentication%20repeatedly&In-Reply-To=%3C37faddcb-b809-9d30-5fd5-503b64f529f8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017173.html">
   <LINK REL="Next"  HREF="017211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid asking for authentication repeatedly</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20asking%20for%20authentication%20repeatedly&In-Reply-To=%3C37faddcb-b809-9d30-5fd5-503b64f529f8%40treenet.co.nz%3E"
       TITLE="[squid-users] squid asking for authentication repeatedly">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Dec 12 16:30:39 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017173.html">[squid-users] squid asking for authentication repeatedly
</A></li>
        <LI>Next message (by thread): <A HREF="017211.html">[squid-users] squid asking for authentication repeatedly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17179">[ date ]</a>
              <a href="thread.html#17179">[ thread ]</a>
              <a href="subject.html#17179">[ subject ]</a>
              <a href="author.html#17179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/12/17 04:10, Paul Hackmann wrote:
&gt;<i> Amos,
</I>&gt;<i> 
</I>&gt;<i> The squid version is 3.1.19.
</I>
Please upgrade. There have been a *lot* of authentication related issues 
that got solved in the years since that version was released. IIRC 
several involved nasty things like the looping you described.

All current OS distributions have more recent Squid versions available. 
Or worst-case custom building is not very hard.


&gt;<i>&#160; The network is set up with a 192.168.0.X 
</I>&gt;<i> network on the lan side, and a 192.168.1.x network on the internet 
</I>&gt;<i> side.&#160; Both ports 3120 and 4120 require authentication,
</I>

NOTE: port 4120 is an intercepted port. HTTP Proxy Authentication on 
traffic arriving there is prohibited, since the HTTP traffic syntax is 
origin-form.

However that said, your config displayed below contradicts what you 
wrote above. Port 41290 traffic does *not* use authentication - the only 
restriction on port 4120 traffic is that it be going to one of the 
whitelisted domains. Period. There is absolutely no restriction on what 
happens or can be done when going to those domains.



&gt;<i> but port 4120 is 
</I>&gt;<i> meant to be restricted to only the whitelisted sites which are in a 
</I>&gt;<i> separate file.&#160; Port 3120 allows access to any site.&#160; The browser 
</I>&gt;<i> causing trouble is configured for port 3120, not 4120.&#160; Here is my 
</I>&gt;<i> squid.conf file:
</I>&gt;<i> 
</I>...
&gt;<i> 
</I>&gt;<i> #not sure what this line does
</I>&gt;<i> acl manager url_regex -i ^cache_<A HREF="object://">object://</A> +i 
</I>&gt;<i> ^https?://[^/]+/squid-internal-mgr/
</I>&gt;<i> 
</I>
The above line defines an ACL which matches requests for Squids internal 
cache management reports. For both the Squid-2+ and Squid-3.4+ 
management APIs.

Your Squid version requires this to be configured. Current releases 
provide it as a built-in default ACL so you don't need to track or fix 
its definition changes during upgrade.

...
&gt;<i> http_access allow CONNECT localnet
</I>
Bad. All LAN clients are allowed to open arbitrary TCP connections 
(CONNECT tunnels) through the proxy *to anywhere* absolutely zero 
restrictions.

The entire point of the &quot;deny CONNECT !SSL_ports&quot; and other default 
security rules is to prohibit attackers and infected LAN clients from 
using the proxy to spread nasty traffic around.

To be useful those default security measure must be placed *first* in 
the http_access ordering and written exactly as provided in the default 
installation. Your own rules should be applied to the traffic which gets 
past those basic precautions.


&gt;<i> http_access deny deny_websites
</I>&gt;<i> http_access allow allowed_clients ncsa_users
</I>&gt;<i> http_access deny !allowed_clients
</I>&gt;<i> #http_access allow ncsa_users
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> #http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> If the conf file is a mess, or has some problems, feel free to say so, 
</I>&gt;<i> as I don't know what all of the directives in it are for.&#160; I marked a 
</I>&gt;<i> couple of lines I don't understand.&#160; I would be happy for it to be 
</I>&gt;<i> optimized more if anyone has ideas.
</I>&gt;<i> 
</I>
I recommend you write your http_access something like so:


  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports
  http_access allow manager localhost
  http_access deny manager

  # domains in deny_websites are DENIED for everybody.
  http_access deny deny_websites

  # domains in whitelist are ALLOWED for everybody
  http_access allow whitelist

  # port 4120 traffic is restricted to the above whitelisted domains
  http_access deny portX

  # otherwise; for port 3120 traffic ...

  # only specific clients with whitelisted IPs can use the proxy ...
  http_access deny !allowed_clients

  # ... and must also login
  http_access deny !ncsa_users

  http_access allow localnet

  http_access deny all


If the above still has the looping issue then I think the problem is 
related to how the Browser is using its TCP connections.

Some Browsers used to open many parallel TCP connections and start 
requesting stuff immediately. But their internal credential handling 
seemed not to cope with the parallelism, treating the 2nd through Nth 
auth challenges as a sign that the 1st connections credentials were invalid.

This was particularly bad for any Browsers configured to auto-load many 
tabs on startup. I've not heard of it happening in quite a while though, 
so it may be fixed in current Browsers. Or maybe they just handle tabs 
differently that does not trigger so easily.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017173.html">[squid-users] squid asking for authentication repeatedly
</A></li>
	<LI>Next message (by thread): <A HREF="017211.html">[squid-users] squid asking for authentication repeatedly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17179">[ date ]</a>
              <a href="thread.html#17179">[ thread ]</a>
              <a href="subject.html#17179">[ subject ]</a>
              <a href="author.html#17179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
