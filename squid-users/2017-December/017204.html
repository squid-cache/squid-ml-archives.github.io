<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP_MISS_ABORTED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS_ABORTED&In-Reply-To=%3C6573abf7-b7bb-bfbb-a651-b3a92e8c2507%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017190.html">
   <LINK REL="Next"  HREF="017216.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP_MISS_ABORTED</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS_ABORTED&In-Reply-To=%3C6573abf7-b7bb-bfbb-a651-b3a92e8c2507%40treenet.co.nz%3E"
       TITLE="[squid-users] TCP_MISS_ABORTED">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 13 18:04:30 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017190.html">[squid-users] TCP_MISS_ABORTED
</A></li>
        <LI>Next message (by thread): <A HREF="017216.html">[squid-users] TCP_MISS_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17204">[ date ]</a>
              <a href="thread.html#17204">[ thread ]</a>
              <a href="subject.html#17204">[ subject ]</a>
              <a href="author.html#17204">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/12/17 20:30, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A> wrote:
&gt;<i> Hi, All
</I>&gt;<i>  &#160; &#160; I used httpclient to imitate a request to squid , but the response 
</I>&gt;<i> page had not stored by squid although response&#160;header is&#160;200. I had 
</I>&gt;<i> tried many times with three different pages . only one can be stored by 
</I>&gt;<i> the squid cache. and the others must need to send requset by brower then 
</I>&gt;<i> they were cached. &#160;I had checked the access.log , it show me like this.
</I>&gt;<i> 1513148548.653&#160;&#160;&#160;9172&#160;10.112.4.54&#160;TCP_MISS_ABORTED/200&#160;106197&#160;GET&#160;<A HREF="http://youlun.lvmama.com/ship_front/youlun/1012487&#160;-&#160;FIRSTUP_PARENT/10.112.4.54&#160;text/html">http://youlun.lvmama.com/ship_front/youlun/1012487&#160;-&#160;FIRSTUP_PARENT/10.112.4.54&#160;text/html</A>
</I>&gt;<i> 
</I>&gt;<i> do you know what's wrong of my squid.conf ? need your help !\
</I>
There seem to be many things. But none of them have much to do with te 
above.

What the above says is that a client at 10.112.4.54 requested 
<A HREF="http://youlun.lvmama.com/ship_front/youlun/1012487">http://youlun.lvmama.com/ship_front/youlun/1012487</A> and disconnected 
after 9 seconds.

The fact that ~100KB of traffic happened in that transaction implies 
that everything was going okay for a while at least. So there is no 
visible problem with Squid in that log entry. The ABORTED simply means 
one of the endpoints (probably the client) decided to disconnect early.



Back to your squid.conf;




&gt;<i>  &#160; &#160; below is my squid.conf
</I>&gt;<i> acl&#160;gsrc&#160;src&#160;10.112.4.54&#160;10.113.10.191
</I>&gt;<i> acl&#160;gdst&#160;dst&#160;10.112.4.54&#160;10.113.10.191
</I>&gt;<i> http_access&#160;allow&#160;gsrc
</I>&gt;<i> http_access&#160;allow&#160;gdst
</I>
What is the above supposed to mean?

&gt;<i> 
</I>&gt;<i> acl&#160;localnet&#160;src&#160;10.0.0.0/8&#160;&#160;&#160;&#160;&#160;#&#160;RFC1918&#160;possible&#160;internal&#160;network
</I>&gt;<i> acl&#160;localnet&#160;src&#160;172.16.0.0/12&#160;&#160;#&#160;RFC1918&#160;possible&#160;internal&#160;network
</I>&gt;<i> acl&#160;localnet&#160;src&#160;192.168.0.0/16&#160;#&#160;RFC1918&#160;possible&#160;internal&#160;network
</I>&gt;<i> acl&#160;localnet&#160;src&#160;fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;RFC&#160;4193&#160;local&#160;private&#160;network&#160;range
</I>&gt;<i> acl&#160;localnet&#160;src&#160;fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;#&#160;RFC&#160;4291&#160;link-local&#160;(directly&#160;plugged)&#160;machines
</I>&gt;<i> 
</I>&gt;<i> acl&#160;purge&#160;method&#160;PURGE
</I>&gt;<i> acl&#160;clientServers&#160;src&#160;10.112.4.54
</I>&gt;<i> http_access&#160;allow&#160;purge&#160;clientServers
</I>&gt;<i> http_access&#160;deny&#160;purge
</I>&gt;<i> 
</I>&gt;<i> acl&#160;gat&#160;method&#160;GET
</I>&gt;<i> acl&#160;clientS&#160;src&#160;10.112.4.54&#160;10.113.10.190
</I>&gt;<i> http_access&#160;allow&#160;gat&#160;clientS
</I>&gt;<i> #http_access&#160;deny&#160;gat
</I>
The localnet ACL defines 10.*/8 as allowed and your rules below specify 
that all localnet traffic is allowed.

So the above four lines of config seem pointless.


You have configured the machines 10.112.4.54 and 10.113.10.190 as your 
cache_peer servers. So why are they listed as &quot;src&quot; ?

In a reverse-proxy &quot;src&quot; is the IP of a client requesting a URL.

&quot;dst&quot; is the destination server - as determined by DNS records for the 
URL domain being fetched. In a reverse-proxy those DNS records should 
hold the proxies own IP address. So dst-IP is rarely ever useful and are 
downright dangerous to make use of in the reverse-proxy.



&gt;<i> 
</I>&gt;<i> acl&#160;SSL_ports&#160;port&#160;443
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;http
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;ftp
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;https
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;gopher
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wais
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;1025-65535&#160;&#160;#&#160;unregistered&#160;ports
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;http-mgmt
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;gss-http
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;filemaker
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;multiling&#160;http
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;3130&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;icp
</I>&gt;<i> acl&#160;Safe_ports&#160;port&#160;3128
</I>&gt;<i> acl&#160;CONNECT&#160;method&#160;CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;deny&#160;!Safe_ports
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;deny&#160;CONNECT&#160;!SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;allow&#160;localhost&#160;manager
</I>&gt;<i> http_access&#160;deny&#160;manager
</I>&gt;<i> 
</I>
As the default config file says:

&quot;
#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
&quot;


&gt;<i> http_access&#160;allow&#160;localnet
</I>&gt;<i> http_access&#160;allow&#160;localhost
</I>&gt;<i> 
</I>&gt;<i> http_port&#160;80&#160;accel&#160;defaultsite=youlun.lvmama.com&#160;no-vhost
</I>&gt;<i> 
</I>&gt;<i> cache_dir&#160;aufs&#160;/var/spool/squid&#160;8198&#160;16&#160;256
</I>&gt;<i> cache_mem&#160;5120&#160;MB
</I>&gt;<i> cache_swap_low&#160;90
</I>&gt;<i> cache_swap_high&#160;95
</I>&gt;<i> cache_mgr&#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A>
</I>&gt;<i> 
</I>&gt;<i> visible_hostname&#160;cache190
</I>&gt;<i> 
</I>
So the domain name Squid announces to your clients is &quot;cache190&quot; as in 
<A HREF="http://cache190/ship_front/youlun/1012487.">http://cache190/ship_front/youlun/1012487.</A>


&gt;<i> coredump_dir&#160;&#160;/var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> via&#160;off
</I>
At least while debugging peering issues set &quot;via on&quot;. Only turn it off 
if you really have to and *after* you have a fully working proxy hierarchy.


&gt;<i> maximum_object_size&#160;500&#160;KB
</I>&gt;<i> 
</I>&gt;<i> icp_port&#160;3130
</I>&gt;<i> icp_access&#160;allow&#160;all
</I>&gt;<i> icp_query_timeout&#160;2000
</I>&gt;<i> 
</I>&gt;<i> cache_peer&#160;10.112.4.54&#160;parent&#160;8090&#160;0&#160;no-query&#160;originserver&#160;name=youlun
</I>&gt;<i> acl&#160;mysites&#160;dstdomain&#160;youlun.lvmama.com
</I>&gt;<i> http_access&#160;allow&#160;mysites
</I>&gt;<i> cache_peer_access&#160;youlun&#160;allow&#160;all
</I>&gt;<i> cache_peer_access&#160;youlun&#160;deny&#160;all
</I>
The default for cache_peer_access is to allow. No need to specify that 
&quot;allow all&quot;. What you need to do to allow everything to reach that peer 
server is *not* specify &quot;deny all&quot;.

Though the normal thing is to use an ACL (eg your &quot;mysites&quot; one) to 
allow the domains an origin server is known to supply and to deny other 
things. Since it is not even worth trying that peer for things it is not 
known to be capable of serving.

So:
   http_access allow mysites
   cache_peer_access youlun allow mysites
   cache_peer_access youlun deny all


Also be aware that all of this peer and http_access config needs to be 
located up where it says &quot; INSERT YOUR OWN RULE(S) HERE &quot; etc.



&gt;<i> 
</I>&gt;<i> refresh_pattern&#160;-i&#160;.*/youlun/([0-9]+)&#160;1440&#160;100%&#160;10080&#160;ignore-no-store&#160;ignore-must-revalidate&#160;store-stale&#160;ignore-reload
</I>&gt;<i> 
</I>
Why? if your server is not producing correct cacheability headers then 
everyone trying to use your site will be having problems. &quot;Fixing&quot; it 
for only your proxy by ignoring required things is the worst possible 
action to take.

Your proxy is a reverse-proxy (aka CDN), it advertises its Surrogate 
abilities to the origin server so your proxy cache can be given custom 
values different from the general public. If you need


&gt;<i> refresh_pattern&#160;^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1440&#160;&#160;&#160;&#160;20%&#160;&#160;&#160;&#160;&#160;10080
</I>&gt;<i> refresh_pattern&#160;^gopher:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1440&#160;&#160;&#160;&#160;0%&#160;&#160;&#160;&#160;&#160;&#160;1440
</I>&gt;<i> refresh_pattern&#160;-i&#160;(/cgi-bin/|\?)&#160;0&#160;&#160;&#160;&#160;&#160;0%&#160;&#160;&#160;&#160;&#160;&#160;0
</I>&gt;<i> refresh_pattern&#160;.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;0&#160;&#160;&#160;&#160;&#160;&#160;&#160;20%&#160;&#160;&#160;&#160;&#160;4320
</I>&gt;<i> 
</I>&gt;<i> cache_log&#160;/var/log/squid/cache.log
</I>&gt;<i> cache_access_log&#160;/var/log/squid/access.log
</I>
The directive name is &quot;access_log&quot;

&gt;<i> cache_store_log&#160;/var/log/squid/store.log
</I>&gt;<i> 
</I>&gt;<i> log_icp_queries&#160;off
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;allow&#160;all
</I>
Do not do that &quot;allow all&quot;.

&gt;<i> http_access&#160;deny&#160;all
</I>&gt;<i> 
</I>

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017190.html">[squid-users] TCP_MISS_ABORTED
</A></li>
	<LI>Next message (by thread): <A HREF="017216.html">[squid-users] TCP_MISS_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17204">[ date ]</a>
              <a href="thread.html#17204">[ thread ]</a>
              <a href="subject.html#17204">[ subject ]</a>
              <a href="author.html#17204">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
