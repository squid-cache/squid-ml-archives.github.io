<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid asking for authentication repeatedly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20asking%20for%20authentication%20repeatedly&In-Reply-To=%3CCADQL5rOVmb0AwKK-%2BE4vsRHx1Tbo2oOkhae7V0k%3DT9q_ZEbgFQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017179.html">
   <LINK REL="Next"  HREF="017214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid asking for authentication repeatedly</H1>
    <B>Paul Hackmann</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20asking%20for%20authentication%20repeatedly&In-Reply-To=%3CCADQL5rOVmb0AwKK-%2BE4vsRHx1Tbo2oOkhae7V0k%3DT9q_ZEbgFQ%40mail.gmail.com%3E"
       TITLE="[squid-users] squid asking for authentication repeatedly">phackmann at gmail.com
       </A><BR>
    <I>Wed Dec 13 22:32:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017179.html">[squid-users] squid asking for authentication repeatedly
</A></li>
        <LI>Next message (by thread): <A HREF="017214.html">[squid-users] squid asking for authentication repeatedly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17211">[ date ]</a>
              <a href="thread.html#17211">[ thread ]</a>
              <a href="subject.html#17211">[ subject ]</a>
              <a href="author.html#17211">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Amos,

I will do an update to the most recent version and see if that helps.  It
was one of those situations where if it ain't broke, don't fix it.  And up
until now, it has worked very well.

You are right, I had brain fade about port 4120.  It should NOT ask for
authentication ever, and only connect to whitelisted sites, which is what I
want.

I've made the changes you recommended to the conf file.  So far, everything
seems to be working as I expect it to.  Thank you!

One more question if you don't mind.  I am trying to add some ip addresses
as whitelisted for port 4120.  I guess I can't add those to the whitelist
file, because it's formatting doesn't work with IP addresses?  I read that
you can add them into the conf file.  I've created the following acl line:

acl 8x8 dst 8.5.248.0/23 8.28.0.0/22 63.209.12.0/24 162.221.236.0/23
162.221.238.0/23 192.84.16.0/22

and I tried to add 8x8 to the the http_access line:

http_access allow whitelist 8x8

but when I did that, the 4120 port started asking for authentication, which
is wrong. Can you tell me how to open those ip address ranges for port 4120?

Thanks very much
PH

On Tue, Dec 12, 2017 at 10:30 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i> On 13/12/17 04:10, Paul Hackmann wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The squid version is 3.1.19.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Please upgrade. There have been a *lot* of authentication related issues
</I>&gt;<i> that got solved in the years since that version was released. IIRC several
</I>&gt;<i> involved nasty things like the looping you described.
</I>&gt;<i>
</I>&gt;<i> All current OS distributions have more recent Squid versions available. Or
</I>&gt;<i> worst-case custom building is not very hard.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   The network is set up with a 192.168.0.X network on the lan side, and a
</I>&gt;&gt;<i> 192.168.1.x network on the internet side.  Both ports 3120 and 4120 require
</I>&gt;&gt;<i> authentication,
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> NOTE: port 4120 is an intercepted port. HTTP Proxy Authentication on
</I>&gt;<i> traffic arriving there is prohibited, since the HTTP traffic syntax is
</I>&gt;<i> origin-form.
</I>&gt;<i>
</I>&gt;<i> However that said, your config displayed below contradicts what you wrote
</I>&gt;<i> above. Port 41290 traffic does *not* use authentication - the only
</I>&gt;<i> restriction on port 4120 traffic is that it be going to one of the
</I>&gt;<i> whitelisted domains. Period. There is absolutely no restriction on what
</I>&gt;<i> happens or can be done when going to those domains.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> but port 4120 is meant to be restricted to only the whitelisted sites
</I>&gt;&gt;<i> which are in a separate file.  Port 3120 allows access to any site.  The
</I>&gt;&gt;<i> browser causing trouble is configured for port 3120, not 4120.  Here is my
</I>&gt;&gt;<i> squid.conf file:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ...
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #not sure what this line does
</I>&gt;&gt;<i> acl manager url_regex -i ^cache_<A HREF="object://">object://</A> +i
</I>&gt;&gt;<i> ^https?://[^/]+/squid-internal-mgr/
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> The above line defines an ACL which matches requests for Squids internal
</I>&gt;<i> cache management reports. For both the Squid-2+ and Squid-3.4+ management
</I>&gt;<i> APIs.
</I>&gt;<i>
</I>&gt;<i> Your Squid version requires this to be configured. Current releases
</I>&gt;<i> provide it as a built-in default ACL so you don't need to track or fix its
</I>&gt;<i> definition changes during upgrade.
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow CONNECT localnet
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Bad. All LAN clients are allowed to open arbitrary TCP connections
</I>&gt;<i> (CONNECT tunnels) through the proxy *to anywhere* absolutely zero
</I>&gt;<i> restrictions.
</I>&gt;<i>
</I>&gt;<i> The entire point of the &quot;deny CONNECT !SSL_ports&quot; and other default
</I>&gt;<i> security rules is to prohibit attackers and infected LAN clients from using
</I>&gt;<i> the proxy to spread nasty traffic around.
</I>&gt;<i>
</I>&gt;<i> To be useful those default security measure must be placed *first* in the
</I>&gt;<i> http_access ordering and written exactly as provided in the default
</I>&gt;<i> installation. Your own rules should be applied to the traffic which gets
</I>&gt;<i> past those basic precautions.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> http_access deny deny_websites
</I>&gt;&gt;<i> http_access allow allowed_clients ncsa_users
</I>&gt;&gt;<i> http_access deny !allowed_clients
</I>&gt;&gt;<i> #http_access allow ncsa_users
</I>&gt;&gt;<i> http_access allow manager localhost
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> #http_access allow localnet
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If the conf file is a mess, or has some problems, feel free to say so, as
</I>&gt;&gt;<i> I don't know what all of the directives in it are for.  I marked a couple
</I>&gt;&gt;<i> of lines I don't understand.  I would be happy for it to be optimized more
</I>&gt;&gt;<i> if anyone has ideas.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> I recommend you write your http_access something like so:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  http_access deny !Safe_ports
</I>&gt;<i>  http_access deny CONNECT !SSL_ports
</I>&gt;<i>  http_access allow manager localhost
</I>&gt;<i>  http_access deny manager
</I>&gt;<i>
</I>&gt;<i>  # domains in deny_websites are DENIED for everybody.
</I>&gt;<i>  http_access deny deny_websites
</I>&gt;<i>
</I>&gt;<i>  # domains in whitelist are ALLOWED for everybody
</I>&gt;<i>  http_access allow whitelist
</I>&gt;<i>
</I>&gt;<i>  # port 4120 traffic is restricted to the above whitelisted domains
</I>&gt;<i>  http_access deny portX
</I>&gt;<i>
</I>&gt;<i>  # otherwise; for port 3120 traffic ...
</I>&gt;<i>
</I>&gt;<i>  # only specific clients with whitelisted IPs can use the proxy ...
</I>&gt;<i>  http_access deny !allowed_clients
</I>&gt;<i>
</I>&gt;<i>  # ... and must also login
</I>&gt;<i>  http_access deny !ncsa_users
</I>&gt;<i>
</I>&gt;<i>  http_access allow localnet
</I>&gt;<i>
</I>&gt;<i>  http_access deny all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If the above still has the looping issue then I think the problem is
</I>&gt;<i> related to how the Browser is using its TCP connections.
</I>&gt;<i>
</I>&gt;<i> Some Browsers used to open many parallel TCP connections and start
</I>&gt;<i> requesting stuff immediately. But their internal credential handling seemed
</I>&gt;<i> not to cope with the parallelism, treating the 2nd through Nth auth
</I>&gt;<i> challenges as a sign that the 1st connections credentials were invalid.
</I>&gt;<i>
</I>&gt;<i> This was particularly bad for any Browsers configured to auto-load many
</I>&gt;<i> tabs on startup. I've not heard of it happening in quite a while though, so
</I>&gt;<i> it may be fixed in current Browsers. Or maybe they just handle tabs
</I>&gt;<i> differently that does not trigger so easily.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171213/35e3c218/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171213/35e3c218/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017179.html">[squid-users] squid asking for authentication repeatedly
</A></li>
	<LI>Next message (by thread): <A HREF="017214.html">[squid-users] squid asking for authentication repeatedly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17211">[ date ]</a>
              <a href="thread.html#17211">[ thread ]</a>
              <a href="subject.html#17211">[ subject ]</a>
              <a href="author.html#17211">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
