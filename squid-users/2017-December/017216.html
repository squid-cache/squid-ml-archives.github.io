<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP_MISS_ABORTED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS_ABORTED&In-Reply-To=%3C2017121411483493862453%40lvmama.com%3E%2B5A775B3C1BFA7129">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017204.html">
   <LINK REL="Next"  HREF="017218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP_MISS_ABORTED</H1>
    <B>zhongzhe at lvmama.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS_ABORTED&In-Reply-To=%3C2017121411483493862453%40lvmama.com%3E%2B5A775B3C1BFA7129"
       TITLE="[squid-users] TCP_MISS_ABORTED">zhongzhe at lvmama.com
       </A><BR>
    <I>Thu Dec 14 03:48:35 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017204.html">[squid-users] TCP_MISS_ABORTED
</A></li>
        <LI>Next message (by thread): <A HREF="017218.html">[squid-users] TCP_MISS_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17216">[ date ]</a>
              <a href="thread.html#17216">[ thread ]</a>
              <a href="subject.html#17216">[ subject ]</a>
              <a href="author.html#17216">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Amos
    Thanks a lot for your reply.  In my conf, squid is not only a reverse-proxy server, but also a cache server. And that is important to me.  In fact , it does't normally for my product environment.  10.112.4.54 is the apache server(been agent by squid) , and my request is also sent by it(such as browser request and mimetic of httpclient request by java).  10.113.10.191 is the peer squid server, And is closed now. 10.113.10.190, as you see, is the
current  reverse-proxy server. 
    Whole proceess like this:
        10.112.4.54(browser)  send request   10.113.10.190 if not cached, forward the requset to apache server   10.112.4.54(apache server)  return the response page to browser  10.112.4.54(browser)
                                                                                            if cached, return the page                                             10.112.4.54(browser)

&gt;<i>      below is my squid.conf
</I>&gt;<i> acl gsrc src 10.112.4.54 10.113.10.191
</I>&gt;<i> acl gdst dst 10.112.4.54 10.113.10.191
</I>&gt;<i> http_access allow gsrc
</I>&gt;<i> http_access allow gdst
</I> 
&gt;&gt;<i>What is the above supposed to mean?
</I>
&gt;<i>
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl clientServers src 10.112.4.54
</I>&gt;<i> http_access allow purge clientServers
</I>&gt;<i> http_access deny purge
</I>&gt;<i>
</I>&gt;<i> acl gat method GET
</I>&gt;<i> acl clientS src 10.112.4.54 10.113.10.190
</I>&gt;<i> http_access allow gat clientS
</I>&gt;<i> #http_access deny gat
</I> 
&gt;&gt;<i>The localnet ACL defines 10.*/8 as allowed and your rules below specify
</I>&gt;&gt;<i>that all localnet traffic is allowed.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>So the above four lines of config seem pointless.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>You have configured the machines 10.112.4.54 and 10.113.10.190 as your
</I>&gt;&gt;<i>cache_peer servers. So why are they listed as &quot;src&quot; ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>In a reverse-proxy &quot;src&quot; is the IP of a client requesting a URL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>&quot;dst&quot; is the destination server - as determined by DNS records for the
</I>&gt;&gt;<i>URL domain being fetched. In a reverse-proxy those DNS records should
</I>&gt;&gt;<i>hold the proxies own IP address. So dst-IP is rarely ever useful and are
</I>&gt;&gt;<i>downright dangerous to make use of in the reverse-proxy.
</I> 

ICP requset cannot sent to peer server at first. So I add it to try to solve it .  
 



&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl Safe_ports port 3130        # icp
</I>&gt;<i> acl Safe_ports port 3128
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>
As the default config file says:
&quot;
#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
&quot;

thanks a lot, I'll delete the needless port info. 
 


&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> http_port 80 accel defaultsite=youlun.lvmama.com no-vhost
</I>&gt;<i>
</I>&gt;<i> cache_dir aufs /var/spool/squid 8198 16 256
</I>&gt;<i> cache_mem 5120 MB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A>
</I>&gt;<i>
</I>&gt;<i> visible_hostname cache190
</I>&gt;<i>
</I>
So the domain name Squid announces to your clients is &quot;cache190&quot; as in
<A HREF="http://cache190/ship_front/youlun/1012487.">http://cache190/ship_front/youlun/1012487.</A>
 

I think my domain name is youlun.lvmama.com. cache190 is just a individual name to distinguish with squid server 10.113.10.191.
 




&gt;<i> coredump_dir  /var/spool/squid
</I>&gt;<i>
</I>&gt;<i> via off
</I> 
At least while debugging peering issues set &quot;via on&quot;. Only turn it off
if you really have to and *after* you have a fully working proxy hierarchy.
 

agree with your.
 


&gt;<i> maximum_object_size 500 KB
</I>&gt;<i>
</I>&gt;<i> icp_port 3130
</I>&gt;<i> icp_access allow all
</I>&gt;<i> icp_query_timeout 2000
</I>&gt;<i>
</I>&gt;<i> cache_peer 10.112.4.54 parent 8090 0 no-query originserver name=youlun
</I>&gt;<i> acl mysites dstdomain youlun.lvmama.com
</I>&gt;<i> http_access allow mysites
</I>&gt;<i> cache_peer_access youlun allow all
</I>&gt;<i> cache_peer_access youlun deny all
</I> 
The default for cache_peer_access is to allow. No need to specify that
&quot;allow all&quot;. What you need to do to allow everything to reach that peer
server is *not* specify &quot;deny all&quot;.
 
Though the normal thing is to use an ACL (eg your &quot;mysites&quot; one) to
allow the domains an origin server is known to supply and to deny other
things. Since it is not even worth trying that peer for things it is not
known to be capable of serving.
 
So:
   http_access allow mysites
   cache_peer_access youlun allow mysites
   cache_peer_access youlun deny all
 
 
Also be aware that all of this peer and http_access config needs to be
located up where it says &quot; INSERT YOUR OWN RULE(S) HERE &quot; etc.
 
 
Thanks , I had delete it.

 
&gt;<i>
</I>&gt;<i> refresh_pattern -i .*/youlun/([0-9]+) 1440 100% 10080 ignore-no-store ignore-must-revalidate store-stale ignore-reload
</I>&gt;<i>
</I> 
Why? if your server is not producing correct cacheability headers then
everyone trying to use your site will be having problems. &quot;Fixing&quot; it
for only your proxy by ignoring required things is the worst possible
action to take.
 
Your proxy is a reverse-proxy (aka CDN), it advertises its Surrogate
abilities to the origin server so your proxy cache can be given custom
values different from the general public. If you need
 

I want to squid server response a cache page to the request if it's exit .

 
&gt;<i> refresh_pattern ^ftp:          1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i>
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_access_log /var/log/squid/access.log
</I> 
The directive name is &quot;access_log&quot;

Changed.
 
&gt;<i> cache_store_log /var/log/squid/store.log
</I>&gt;<i>
</I>&gt;<i> log_icp_queries off
</I>&gt;<i>
</I>&gt;<i> http_access allow all
</I> 
Do not do that &quot;allow all&quot;.
 
Been deleted.

&gt;<i> http_access deny all
</I>


<A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A>
 
From: Amos Jeffries
Date: 2017-12-14 02:04
To: squid-users
Subject: Re: [squid-users] TCP_MISS_ABORTED
On 13/12/17 20:30, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A> wrote:
&gt;<i> Hi, All
</I>&gt;<i>      I used httpclient to imitate a request to squid , but the response 
</I>&gt;<i> page had not stored by squid although response header is 200. I had 
</I>&gt;<i> tried many times with three different pages . only one can be stored by 
</I>&gt;<i> the squid cache. and the others must need to send requset by brower then 
</I>&gt;<i> they were cached.  I had checked the access.log , it show me like this.
</I>&gt;<i> 1513148548.653   9172 10.112.4.54 TCP_MISS_ABORTED/200 106197 GET <A HREF="http://youlun.lvmama.com/ship_front/youlun/1012487">http://youlun.lvmama.com/ship_front/youlun/1012487</A> - FIRSTUP_PARENT/10.112.4.54 text/html
</I>&gt;<i> 
</I>&gt;<i> do you know what's wrong of my squid.conf ? need your help !\
</I> 
There seem to be many things. But none of them have much to do with te 
above.
 
What the above says is that a client at 10.112.4.54 requested 
<A HREF="http://youlun.lvmama.com/ship_front/youlun/1012487">http://youlun.lvmama.com/ship_front/youlun/1012487</A> and disconnected 
after 9 seconds.
 
The fact that ~100KB of traffic happened in that transaction implies 
that everything was going okay for a while at least. So there is no 
visible problem with Squid in that log entry. The ABORTED simply means 
one of the endpoints (probably the client) decided to disconnect early.
 
 
 
Back to your squid.conf;
 
 
 
 
&gt;<i>      below is my squid.conf
</I>&gt;<i> acl gsrc src 10.112.4.54 10.113.10.191
</I>&gt;<i> acl gdst dst 10.112.4.54 10.113.10.191
</I>&gt;<i> http_access allow gsrc
</I>&gt;<i> http_access allow gdst
</I> 
What is the above supposed to mean?
 
&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl clientServers src 10.112.4.54
</I>&gt;<i> http_access allow purge clientServers
</I>&gt;<i> http_access deny purge
</I>&gt;<i> 
</I>&gt;<i> acl gat method GET
</I>&gt;<i> acl clientS src 10.112.4.54 10.113.10.190
</I>&gt;<i> http_access allow gat clientS
</I>&gt;<i> #http_access deny gat
</I> 
The localnet ACL defines 10.*/8 as allowed and your rules below specify 
that all localnet traffic is allowed.
 
So the above four lines of config seem pointless.
 
 
You have configured the machines 10.112.4.54 and 10.113.10.190 as your 
cache_peer servers. So why are they listed as &quot;src&quot; ?
 
In a reverse-proxy &quot;src&quot; is the IP of a client requesting a URL.
 
&quot;dst&quot; is the destination server - as determined by DNS records for the 
URL domain being fetched. In a reverse-proxy those DNS records should 
hold the proxies own IP address. So dst-IP is rarely ever useful and are 
downright dangerous to make use of in the reverse-proxy.
 
 
 
&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl Safe_ports port 3130        # icp
</I>&gt;<i> acl Safe_ports port 3128
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I> 
As the default config file says:
 
&quot;
#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
&quot;
 
 
&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_port 80 accel defaultsite=youlun.lvmama.com no-vhost
</I>&gt;<i> 
</I>&gt;<i> cache_dir aufs /var/spool/squid 8198 16 256
</I>&gt;<i> cache_mem 5120 MB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A>
</I>&gt;<i> 
</I>&gt;<i> visible_hostname cache190
</I>&gt;<i> 
</I> 
So the domain name Squid announces to your clients is &quot;cache190&quot; as in 
<A HREF="http://cache190/ship_front/youlun/1012487.">http://cache190/ship_front/youlun/1012487.</A>
 
 
&gt;<i> coredump_dir  /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> via off
</I> 
At least while debugging peering issues set &quot;via on&quot;. Only turn it off 
if you really have to and *after* you have a fully working proxy hierarchy.
 
 
&gt;<i> maximum_object_size 500 KB
</I>&gt;<i> 
</I>&gt;<i> icp_port 3130
</I>&gt;<i> icp_access allow all
</I>&gt;<i> icp_query_timeout 2000
</I>&gt;<i> 
</I>&gt;<i> cache_peer 10.112.4.54 parent 8090 0 no-query originserver name=youlun
</I>&gt;<i> acl mysites dstdomain youlun.lvmama.com
</I>&gt;<i> http_access allow mysites
</I>&gt;<i> cache_peer_access youlun allow all
</I>&gt;<i> cache_peer_access youlun deny all
</I> 
The default for cache_peer_access is to allow. No need to specify that 
&quot;allow all&quot;. What you need to do to allow everything to reach that peer 
server is *not* specify &quot;deny all&quot;.
 
Though the normal thing is to use an ACL (eg your &quot;mysites&quot; one) to 
allow the domains an origin server is known to supply and to deny other 
things. Since it is not even worth trying that peer for things it is not 
known to be capable of serving.
 
So:
   http_access allow mysites
   cache_peer_access youlun allow mysites
   cache_peer_access youlun deny all
 
 
Also be aware that all of this peer and http_access config needs to be 
located up where it says &quot; INSERT YOUR OWN RULE(S) HERE &quot; etc.
 
 
 
&gt;<i> 
</I>&gt;<i> refresh_pattern -i .*/youlun/([0-9]+) 1440 100% 10080 ignore-no-store ignore-must-revalidate store-stale ignore-reload
</I>&gt;<i> 
</I> 
Why? if your server is not producing correct cacheability headers then 
everyone trying to use your site will be having problems. &quot;Fixing&quot; it 
for only your proxy by ignoring required things is the worst possible 
action to take.
 
Your proxy is a reverse-proxy (aka CDN), it advertises its Surrogate 
abilities to the origin server so your proxy cache can be given custom 
values different from the general public. If you need
 
 
&gt;<i> refresh_pattern ^ftp:          1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_access_log /var/log/squid/access.log
</I> 
The directive name is &quot;access_log&quot;
 
&gt;<i> cache_store_log /var/log/squid/store.log
</I>&gt;<i> 
</I>&gt;<i> log_icp_queries off
</I>&gt;<i> 
</I>&gt;<i> http_access allow all
</I> 
Do not do that &quot;allow all&quot;.
 
&gt;<i> http_access deny all
</I>&gt;<i> 
</I> 
 
Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171214/00ddc906/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171214/00ddc906/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017204.html">[squid-users] TCP_MISS_ABORTED
</A></li>
	<LI>Next message (by thread): <A HREF="017218.html">[squid-users] TCP_MISS_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17216">[ date ]</a>
              <a href="thread.html#17216">[ thread ]</a>
              <a href="subject.html#17216">[ subject ]</a>
              <a href="author.html#17216">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
