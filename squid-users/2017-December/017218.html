<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP_MISS_ABORTED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS_ABORTED&In-Reply-To=%3Ce15b4e5b-e49a-398b-caa9-c03c2215ffa5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017216.html">
   <LINK REL="Next"  HREF="017193.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP_MISS_ABORTED</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_MISS_ABORTED&In-Reply-To=%3Ce15b4e5b-e49a-398b-caa9-c03c2215ffa5%40treenet.co.nz%3E"
       TITLE="[squid-users] TCP_MISS_ABORTED">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 14 05:31:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017216.html">[squid-users] TCP_MISS_ABORTED
</A></li>
        <LI>Next message (by thread): <A HREF="017193.html">[squid-users] Warning in Cache.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17218">[ date ]</a>
              <a href="thread.html#17218">[ thread ]</a>
              <a href="subject.html#17218">[ subject ]</a>
              <a href="author.html#17218">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/12/17 16:48, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A> wrote:
&gt;<i> Hi, Amos
</I>&gt;<i>  &#160; &#160; Thanks a lot for your reply. &#160;In my conf, squid is not only a 
</I>&gt;<i> reverse-proxy server, but also a cache server. And that is important to 
</I>&gt;<i> me.
</I>
Sure. Those two functions of proxying are independent of each other.

* Anything going through a caching proxy is cached regardless of how it 
arrived or where it will end up in the network.

* The reverse-proxy is all about how traffic is routed when it goes over 
network connections.


One thing to be aware of when testing with a Browser is that Browsers 
also cache, and they usually get the same instructions as the proxy gets 
and the can lead to an illusion in the visible behaviour:

It goes like this:

1)  When the browser makes its first request, the object is not stored 
in either browser nor proxy caches. So they both MISS and the 
transaction fetches from the origin server.

2) when the object eventually becomes stale in the Browser cache is 
fetches or revalidates against teh proxy copy.

*** Since the test Browser and the proxy got the content at identical 
times it also becomes stale in the proxy cache at the same time it went 
stale in the browser cache.

3) the proxy content (now also stale) gets MISS or REFRESH since the 
origin server needs to be contacted again.

As you can see the proxy *is* caching between steps #1 and #2. But you 
may not ever see it HIT in the testing unless you are careful to clear 
the browser cache between every test lookup so that the browser and 
proxy cache contents becomes different.

In production this is not usually a problem since multiple users cause 
the proxy content to be updated irregularly. But it can still happen in 
some situations with low number of clients all with very different 
browsing habits.




&gt;<i> &#160;In fact , it does't normally for my product environment. 
</I>&gt;<i> 10.112.4.54 is the apache server(been agent by squid) , and my request 
</I>&gt;<i> is also sent by it(such as browser request and mimetic of httpclient 
</I>&gt;<i> request by java).
</I>&gt;<i> 10.113.10.191 is the peer squid server, And is closed 
</I>&gt;<i> now. 10.113.10.190, as you see,&#160;is the
</I>&gt;<i> current reverse-proxy server.
</I>&gt;<i>  &#160; &#160; Whole proceess like this:
</I>&gt;<i> 10.112.4.54(browser) _send request_//10.113.10.190 _if not cached, 
</I>
Small mistake there. Browser uses DNS to find out where 
yourdomain.example.com IP address is - DNS tells it 10.113.10.190.
  The Browser contacts 10.113.10.190 and asks for 
<A HREF="http://youlun.lvmama.com/something.">http://youlun.lvmama.com/something.</A>

The proxy receives that URL and sees the dstdomain == 
&quot;youlun.lvmama.com&quot; as a reason to send it on to the origin server OR 
the cache. Whichever is faster - local RAM and disk by definition being 
faster to access than networking to another machine.

NP: the above is important for your requested process. Since it should 
now be clear that a reverse-proxy http_access permissions do not need 
anything about who the client is (src-IP), or where the domain is hosted 
(dst-IP).


&gt;<i> forward the requset to apache server_10.112.4.54(apache server)_return 
</I>&gt;<i> the response page to browser_ 10.112.4.54(browser)
</I>&gt;<i> _if cached, return the page_10.112.4.54(browser)
</I>
I see. In which case there are more problems with your config than I 
initially thought.

&gt;<i> 
</I>&gt;<i>  &gt;&#160; &#160; &#160; below is my squid.conf
</I>&gt;<i>  &gt; acl&#160;gsrc&#160;src&#160;10.112.4.54&#160;10.113.10.191
</I>&gt;<i>  &gt; acl&#160;gdst&#160;dst&#160;10.112.4.54&#160;10.113.10.191
</I>&gt;<i>  &gt; http_access&#160;allow&#160;gsrc
</I>&gt;<i>  &gt; http_access&#160;allow&#160;gdst
</I>&gt;<i>  &gt;&gt;What is the above supposed to mean?
</I>
For your desired process. Do not do the above at all. Remove them 
completely.

&gt;<i> 
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; acl&#160;localnet&#160;src&#160;10.0.0.0/8&#160;&#160;&#160;&#160;&#160;#&#160;RFC1918&#160;possible&#160;internal&#160;network
</I>&gt;<i>  &gt; acl&#160;localnet&#160;src&#160;172.16.0.0/12&#160;&#160;#&#160;RFC1918&#160;possible&#160;internal&#160;network
</I>&gt;<i>  &gt; acl&#160;localnet&#160;src&#160;192.168.0.0/16&#160;#&#160;RFC1918&#160;possible&#160;internal&#160;network
</I>&gt;<i>  &gt; acl&#160;localnet&#160;src&#160;fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;RFC&#160;4193&#160;local&#160;private&#160;network&#160;range
</I>&gt;<i>  &gt; 
</I>&gt;<i> acl&#160;localnet&#160;src&#160;fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;#&#160;RFC&#160;4291&#160;link-local&#160;(directly&#160;plugged)&#160;machines
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; acl&#160;purge&#160;method&#160;PURGE
</I>&gt;<i>  &gt; acl&#160;clientServers&#160;src&#160;10.112.4.54
</I>&gt;<i>  &gt; http_access&#160;allow&#160;purge&#160;clientServers
</I>&gt;<i>  &gt; http_access&#160;deny&#160;purge
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; acl&#160;gat&#160;method&#160;GET
</I>&gt;<i>  &gt; acl&#160;clientS&#160;src&#160;10.112.4.54&#160;10.113.10.190
</I>&gt;<i>  &gt; http_access&#160;allow&#160;gat&#160;clientS
</I>&gt;<i>  &gt; #http_access&#160;deny&#160;gat
</I>&gt;<i>  &gt;&gt;The localnet ACL defines 10.*/8 as allowed and your rules below specify
</I>&gt;<i>  &gt;&gt;that all localnet traffic is allowed.
</I>&gt;<i>  &gt;&gt;
</I>&gt;<i>  &gt;&gt;So the above four lines of config seem pointless.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>You have configured the machines 10.112.4.54 and 10.113.10.190 as your
</I>&gt;&gt;&gt;<i>cache_peer servers. So why are they listed as &quot;src&quot; ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>In a reverse-proxy &quot;src&quot; is the IP of a client requesting a URL.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>&quot;dst&quot; is the destination server - as determined by DNS records for the
</I>&gt;&gt;&gt;<i>URL domain being fetched. In a reverse-proxy those DNS records should
</I>&gt;&gt;&gt;<i>hold the proxies own IP address. So dst-IP is rarely ever useful and are
</I>&gt;&gt;&gt;<i>downright dangerous to make use of in the reverse-proxy.
</I>&gt;<i> 
</I>&gt;<i> ICP requset cannot sent to peer server at first. So I add it to try to 
</I>&gt;<i> solve it .
</I>&gt;<i> 
</I>
The above has nothing to do with ICP. It is some ACLs being used to 
control *HTTP* request messages arriving into the proxy. It is deciding 
whether Squid processes that request *at all*, or rejects the client 
with a 403.

For your desired process. Do not do those gat or clientS ACL checks at 
all. Remove them completely and the http_access lines they are used in.



&gt;<i> 
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; acl&#160;SSL_ports&#160;port&#160;443
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;http
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;ftp
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;https
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;gopher
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wais
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;1025-65535&#160;&#160;#&#160;unregistered&#160;ports
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;http-mgmt
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;gss-http
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;filemaker
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;multiling&#160;http
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;3130&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;icp
</I>&gt;<i>  &gt; acl&#160;Safe_ports&#160;port&#160;3128
</I>&gt;<i>  &gt; acl&#160;CONNECT&#160;method&#160;CONNECT
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; http_access&#160;deny&#160;!Safe_ports
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; http_access&#160;deny&#160;CONNECT&#160;!SSL_ports
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; http_access&#160;allow&#160;localhost&#160;manager
</I>&gt;<i>  &gt; http_access&#160;deny&#160;manager
</I>&gt;<i>  &gt;
</I>&gt;<i> 
</I>&gt;<i> As the default config file says:
</I>&gt;<i> &quot;
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> &quot;
</I>&gt;<i> 
</I>&gt;<i> thanks a lot, I'll delete the needless port info.
</I>&gt;<i> 
</I>
Port info? I did not mention removing any of that.

Whether you should edit Safe_ports or SSL_ports values is determined by 
whether you want the proxy to be exclusively a reverse-proxy (with 
caching), or to be both a reverse-proxy AND a forward/explicit proxy 
(both with caching).

TO be exclusively a reverse-proxy it is find to remove all by port 80 
(and maybe 443) ports from those ACL definitions.

To retain forward-propxy behaviour you do need the default config lines. 
And may even have to add extra ports depending on what the Browsers and 
clients need access to.

What I was trying to point out was that your custom http_access rules 
should all be there. Maybe with the extra custom things like your 
cache_peer_* rules.


For your desired process. The only thing you need to have is the 
cache_peer* and http_access reverse-proxy lines right here in this 
potsition of squid.conf. That is *all* of it.


&gt;<i> 
</I>&gt;<i>  &gt; http_access&#160;allow&#160;localnet
</I>&gt;<i>  &gt; http_access&#160;allow&#160;localhost
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; http_port&#160;80&#160;accel&#160;defaultsite=youlun.lvmama.com&#160;no-vhost
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; cache_dir&#160;aufs&#160;/var/spool/squid&#160;8198&#160;16&#160;256
</I>&gt;<i>  &gt; cache_mem&#160;5120&#160;MB
</I>&gt;<i>  &gt; cache_swap_low&#160;90
</I>&gt;<i>  &gt; cache_swap_high&#160;95
</I>&gt;<i>  &gt; cache_mgr&#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">zhongzhe at lvmama.com</A>
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; visible_hostname&#160;cache190
</I>&gt;<i>  &gt;
</I>&gt;<i> 
</I>&gt;<i> So the domain name Squid announces to your clients is &quot;cache190&quot; as in
</I>&gt;<i> <A HREF="http://cache190/ship_front/youlun/1012487.">http://cache190/ship_front/youlun/1012487.</A>
</I>&gt;<i> 
</I>&gt;<i> I think my domain name is youlun.lvmama.com. cache190 is just a 
</I>&gt;<i> individual name to distinguish with squid server 10.113.10.191.
</I>&gt;<i> 
</I>
Fine, but it should in any case be a FQDN which can be publicly resolved 
by a lookup in DNS. Current Squid versions should all be able to 
auto-detect what their machines unique hostname is. So usually no need 
to set these at all.

The visible_hostname (note the word &quot;visible&quot;) is what Squid places in 
any URLs it has to auto-generate and send to clients. Since this is a 
reverse-proxy it is sort of best to set the *public* name to be the 
served domain name (eg &quot;visible_hostname youlun.lvmama.com&quot;) and use 
unique_hostname to set the proxies unique FQDN.


&gt;<i> 
</I>&gt;<i>  &gt; coredump_dir&#160;&#160;/var/spool/squid
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; via&#160;off
</I>&gt;<i> At least while debugging peering issues set &quot;via on&quot;. Only turn it off
</I>&gt;<i> if you really have to and *after* you have a fully working proxy hierarchy.
</I>&gt;<i> 
</I>&gt;<i> agree with your.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  &gt; maximum_object_size&#160;500&#160;KB
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; icp_port&#160;3130
</I>&gt;<i>  &gt; icp_access&#160;allow&#160;all
</I>&gt;<i>  &gt; icp_query_timeout&#160;2000
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; cache_peer&#160;10.112.4.54&#160;parent&#160;8090&#160;0&#160;no-query&#160;originserver&#160;name=youlun
</I>&gt;<i>  &gt; acl&#160;mysites&#160;dstdomain&#160;youlun.lvmama.com
</I>&gt;<i>  &gt; http_access&#160;allow&#160;mysites
</I>&gt;<i>  &gt; cache_peer_access&#160;youlun&#160;allow&#160;all
</I>&gt;<i>  &gt; cache_peer_access&#160;youlun&#160;deny&#160;all
</I>&gt;<i> The default for cache_peer_access is to allow. No need to specify that
</I>&gt;<i> &quot;allow all&quot;. What you need to do to allow everything to reach that peer
</I>&gt;<i> server is *not* specify &quot;deny all&quot;.
</I>&gt;<i> Though the normal thing is to use an ACL (eg your &quot;mysites&quot; one) to
</I>&gt;<i> allow the domains an origin server is known to supply and to deny other
</I>&gt;<i> things. Since it is not even worth trying that peer for things it is not
</I>&gt;<i> known to be capable of serving.
</I>&gt;<i> So:
</I>&gt;<i>  &#160;&#160; http_access allow mysites
</I>&gt;<i>  &#160;&#160; cache_peer_access youlun allow mysites
</I>&gt;<i>  &#160;&#160; cache_peer_access youlun deny all
</I>&gt;<i> Also be aware that all of this peer and http_access config needs to be
</I>&gt;<i> located up where it says &quot; INSERT YOUR OWN RULE(S) HERE &quot; etc.
</I>&gt;<i> Thanks , I had delete it.
</I>&gt;<i> 
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; 
</I>&gt;<i> refresh_pattern&#160;-i&#160;.*/youlun/([0-9]+)&#160;1440&#160;100%&#160;10080&#160;ignore-no-store&#160;ignore-must-revalidate&#160;store-stale&#160;ignore-reload
</I>&gt;<i>  &gt;
</I>&gt;<i> Why? if your server is not producing correct cacheability headers then
</I>&gt;<i> everyone trying to use your site will be having problems. &quot;Fixing&quot; it
</I>&gt;<i> for only your proxy by ignoring required things is the worst possible
</I>&gt;<i> action to take.
</I>&gt;<i> Your proxy is a reverse-proxy (aka CDN), it advertises its Surrogate
</I>&gt;<i> abilities to the origin server so your proxy cache can be given custom
</I>&gt;<i> values different from the general public. If you need
</I>&gt;<i> 
</I>&gt;<i> I want to squid server response a cache page to the request if it's exit .
</I>
Squid caches by default the refresh_pattern below indicate 4320 minutes 
(1 week) storage time _unless_ the server tells Squid anything more 
specific (can be longer or shorter).

That said current Squid cache in memory instead of on-disk unless you 
configure a cache_dir line to say where that disk cache should be put.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017216.html">[squid-users] TCP_MISS_ABORTED
</A></li>
	<LI>Next message (by thread): <A HREF="017193.html">[squid-users] Warning in Cache.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17218">[ date ]</a>
              <a href="thread.html#17218">[ thread ]</a>
              <a href="subject.html#17218">[ subject ]</a>
              <a href="author.html#17218">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
