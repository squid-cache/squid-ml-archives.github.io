<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] irregular traffic when using proxy, not if NATed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20irregular%20traffic%20when%20using%20proxy%2C%20not%20if%20NATed&In-Reply-To=%3C5a550973-4947-9df6-055d-e61772f7aff8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014376.html">
   <LINK REL="Next"  HREF="014324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] irregular traffic when using proxy, not if NATed</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20irregular%20traffic%20when%20using%20proxy%2C%20not%20if%20NATed&In-Reply-To=%3C5a550973-4947-9df6-055d-e61772f7aff8%40treenet.co.nz%3E"
       TITLE="[squid-users] irregular traffic when using proxy, not if NATed">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb  1 14:15:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014376.html">[squid-users] heart beet between squid peers
</A></li>
        <LI>Next message (by thread): <A HREF="014324.html">[squid-users] transparent http and https filter with white-list only
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14323">[ date ]</a>
              <a href="thread.html#14323">[ thread ]</a>
              <a href="subject.html#14323">[ subject ]</a>
              <a href="author.html#14323">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/01/2017 6:10 a.m., le dahut wrote:
&gt;<i> Hello.
</I>&gt;<i> 
</I>&gt;<i> On certain upload websites, the traffic monitor shows an irregular
</I>&gt;<i> traffic when uploading through squid, while uploading NATed (not using
</I>&gt;<i> squid) gives a regular traffic.
</I>&gt;<i> 
</I>&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Can you help me find out why ?
</I>&gt;<i> 
</I>
The first thing that comes to my mind is that this type of bunching in
the traffic graph is a sign of buffer bloat. Simply by using Squid you
are adding two buffers in each direction for the traffic as the client
and server connections are buffered separately. Bloat related problems
show up worst for CONNECT tunnels and uploads in Squid.

Your config shows the Squid buffers to be the default 16-64KB each
though so not exactly overly bloated on a transfer of 1 MB/s for ~30sec
straight. Could be compounding an underlying problem though.

The other thing that comes to mind is a bug in mem_node handling for
large objects. Any transfer that can fill a 1MB/s pipe for ~30sec is in
the range of objects which will start to see effects of Squid searching
memory for the next block of data to send or memory to read into.


To track down the actual reason you will need to figure out what Squid
is doing during the transfer. You do that with debug_options.

Some info on profiling Squid is mentioned at:
 &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidProfiling">http://wiki.squid-cache.org/SquidFaq/SquidProfiling</A>&gt;

If you can replicate the problem on a machine that is not under a lot of
traffic load at the time you could use debug_options directive to raise
the debug level - &quot;debug_options rotate=1 ALL,6&quot; should give a lot of
info about whats happening.


I recommend that if you can please upgrade to the later 3.5.23 package
that is available for Ubuntu in 16.04 Xenial or later. There are quite a
few performance related issues that have been resolved in the .12
release. Not having to figure it out at all would be nice if possible.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014376.html">[squid-users] heart beet between squid peers
</A></li>
	<LI>Next message (by thread): <A HREF="014324.html">[squid-users] transparent http and https filter with white-list only
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14323">[ date ]</a>
              <a href="thread.html#14323">[ thread ]</a>
              <a href="subject.html#14323">[ subject ]</a>
              <a href="author.html#14323">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
