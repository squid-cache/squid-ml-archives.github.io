<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] transparent http and https filter with white-list only
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20http%20and%20https%20filter%20with%20white-list%0A%20only&In-Reply-To=%3C1d01efe0-83f8-2a91-c0ac-fd8ef769276f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014323.html">
   <LINK REL="Next"  HREF="014338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] transparent http and https filter with white-list only</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20http%20and%20https%20filter%20with%20white-list%0A%20only&In-Reply-To=%3C1d01efe0-83f8-2a91-c0ac-fd8ef769276f%40treenet.co.nz%3E"
       TITLE="[squid-users] transparent http and https filter with white-list only">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb  1 14:46:44 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014323.html">[squid-users] irregular traffic when using proxy, not if NATed
</A></li>
        <LI>Next message (by thread): <A HREF="014338.html">[squid-users] transparent http and https filter with white-list only
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14324">[ date ]</a>
              <a href="thread.html#14324">[ thread ]</a>
              <a href="subject.html#14324">[ subject ]</a>
              <a href="author.html#14324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/01/2017 12:36 a.m., Sergey Klusov wrote:
&gt;<i> Hello. I'm trying to get working transparent setup allowing only certain
</I>&gt;<i> domains and have problem that in order to allow https &quot;ssl_bump splice
</I>&gt;<i> allowed_domains&quot; i have to &quot;http_access allow all&quot;, thus allowing all
</I>&gt;<i> other http traffic through. Otherwise https traffic is not allowed at all.
</I>&gt;<i> 
</I>&gt;<i> Here is my config:
</I>&gt;<i> 
</I>
Some comments inline to improve it.

Also, what version of Squid are you using?
 I will assume that you are following the best practice advice and using
at least 3.5.19.  If not, please try to upgrade.


&gt;<i> =======config=======
</I>&gt;<i> http_port 10.96.243.1:3128 intercept options=NO_SSLv3:NO_SSLv2
</I>&gt;<i> http_port 10.96.243.1:3130 options=NO_SSLv3:NO_SSLv2
</I>
Setting SSL-related options on http_port's is not useful when they are
not doing SSL-Bump.

&gt;<i> https_port 10.96.243.1:3129 intercept ssl-bump
</I>&gt;<i> options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off
</I>&gt;<i> cert=/etc/squid/squidCA.pem
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl http_allow dstdomain &quot;/etc/squid/http_allow_domains.txt&quot;
</I>&gt;<i> acl https_allow ssl::server_name &quot;/etc/squid/https_allow_domains.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Not good. Remember this is a security protocol you are playing around with.

Both of the above lines hide critical details you need to figure out
what is going wrong. They can be useful as a spot-check (only!) to
figure out if the problem is related to cert verification or something
else. But DO NOT use them for regular traffic, not even testing traffic.

You may find that there are certain _specific_ errors that you need to
let through. Add the appropriate flags, SSL options, ACLs checks
sslproxy_cert_error lines for those as needed, dont just ignore all
possible errors like above does.

&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice https_allow
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>
Looks okay. Just to be clear you understand that:
 The above means that the TLS/SSL is spliced only if the client SNI
contains a domain in your whitelist.
 All other traffic will be terminated ... maybe with an HTTP error page.


&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access allow all http_allow
</I>&gt;<i> http_access allow all https_allow
</I>
The ssl::server_name ACL will not work outside of the ssl_bump
directive. Delete the above line.


Also, I am not seeing is any line which permits the raw-IP CONNECT
message which your Squid processes first to decide whether ssl_bump will
be applied to the intercepted TCP connections.

 That is why the &quot;allow all&quot; makes things &quot;work&quot;. It lets those CONNECT
request through.

You can read the details about how bumping happens at
&lt;<A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps">http://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps</A>&gt;
 The CONNECT request mentioned in step 1.ii is your problem.

To fix it in a very targeted way add these lines (mind the wrap sorry):

 acl rawIP dstdom_regex
^(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(\[([0-9a-f]+)?:([0-9a-f:]+)?:([0-9a-f]+|0-9\.]+)?\])):443$

 acl bumpPort myportname 10.96.243.1:3129

 http_access allow CONNECT bumpPort rawIP


&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>&gt;<i> 
</I>
That always_direct line is not useful. Remove it.

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014323.html">[squid-users] irregular traffic when using proxy, not if NATed
</A></li>
	<LI>Next message (by thread): <A HREF="014338.html">[squid-users] transparent http and https filter with white-list only
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14324">[ date ]</a>
              <a href="thread.html#14324">[ thread ]</a>
              <a href="subject.html#14324">[ subject ]</a>
              <a href="author.html#14324">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
