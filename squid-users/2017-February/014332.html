<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3C3a990a52-6b57-a4b3-c7d0-9d683828faea%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014336.html">
   <LINK REL="Next"  HREF="014333.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3C3a990a52-6b57-a4b3-c7d0-9d683828faea%40treenet.co.nz%3E"
       TITLE="[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb  1 16:19:20 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014336.html">[squid-users] Not all html objects are being cached
</A></li>
        <LI>Next message (by thread): <A HREF="014333.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14332">[ date ]</a>
              <a href="thread.html#14332">[ thread ]</a>
              <a href="subject.html#14332">[ subject ]</a>
              <a href="author.html#14332">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/01/2017 9:31 p.m., Vieri wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----- Original Message ----- From: Alex Rousskov
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> It's interesting to note that the following actually DOES give
</I>&gt;&gt;&gt;<i> more information (unsupported
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> protocol):&gt;
</I>&gt;&gt;<i> * If the server sent nothing, then Curl gave you potentially
</I>&gt;&gt;<i> incorrect information (i.e., Curl is just _guessing_ what went
</I>&gt;&gt;<i> wrong).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I never tried telling Squid to use TLS 1.1 ONLY so I never got to see
</I>&gt;<i> Squid's log when using that protocol. I'm supposing I would have seen
</I>&gt;<i> the same thing in Squid as I've seen it with CURL. So I'm sure Squid
</I>&gt;<i> would log useful information for the sys admin but... (see below).
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Maybe if Squid gets an SSL negotiation error with no apparent
</I>&gt;&gt;&gt;<i> reason then it might need to retry connecting by being more
</I>&gt;&gt;&gt;<i> explicit, just like in my cURL and openssl binary examples
</I>&gt;&gt;&gt;<i> above.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Sorry, I do not know what &quot;retry connecting by being more
</I>&gt;&gt;<i> explicit&quot; means. AFAICT, neither Curl nor s_client tried
</I>&gt;&gt;<i> reconnecting in your examples. Also, an appropriate default for a
</I>&gt;&gt;<i> command-line client is often a bad default for a proxy. It is
</I>&gt;&gt;<i> complicated.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Let me rephrase my point but please keep in mind that I have no idea
</I>&gt;<i> how Squid actually behaves.
</I>
Let me pause you right there.  What you describe is essentially how the
TLS protocol handshake is actually performed.

&gt;<i> Simply put, when Squid tries to connect
</I>&gt;<i> for the first time, it will probably (I'm guessing here) try the most
</I>&gt;<i> secure protcol known today (ie. TSL 1.2), or let OpenSSL decide by
</I>&gt;<i> default which is probably the same.
</I>
That is exactly what happens.

&gt;<i> In my case, the server replies
</I>&gt;<i> nothing. That would be like running:
</I>&gt;<i> 
</I>&gt;<i> # curl -k -v <A HREF="https://10.215.144.21">https://10.215.144.21</A> or # openssl s_client -connect
</I>&gt;<i> 10.215.144.21:443
</I>&gt;<i> 
</I>&gt;<i> They give me the same information as Squid's log... almost nothing.
</I>&gt;<i> 
</I>&gt;<i> So my point is, if that first connection fails and gives me nothing
</I>&gt;<i> for TLS 1.2 (or whatever the default is), two things can happen:
</I>&gt;<i> either the remote site is failing or it isn't supporting the
</I>&gt;<i> protocol. Why not &quot;try again&quot; but this time by being more specific?
</I>
Several reasons.

Reason #1 is that the TLS protocol is a security protocol for securing a
single 'hop' (just one TCP connection). So ideally TLS details would not
be remembered at all, it's a dangerous thing in security to remember
details in the middleware.


Reason #2 is that Squid has passed on the 'terminate' signal to the
client (curl).

As far as Squid is concerned, there is no &quot;again&quot; connection. There is a
connection, which fails. The end.

There is a connection. Which fails. The end.

There is a connection. Which fails. The end.

 ... and so on. These connections may be from the same client, or
different ones. May be to same or different servers. They are
independent of each other and only TCP at this point.

The TLS setup/handshake parts never get far enough for there to be
anything to remember. Except that TCP connection failed.

Well, Squid does remember that and tries a different IP next time. Until
it runs out of IPs, then it resets its bad-ID memory with a new DNS
lookup and the cycle begins again.


NP: if you are interested you can see the GOOD/BAD flags on IPs in the
ipcache cache manager report (squidclient mgr:ipcache).


&gt;<i> It would be like doing something like this:
</I>&gt;<i> 
</I>&gt;<i> # openssl s_client -connect 10.215.144.21:443 || openssl s_client
</I>&gt;<i> -connect 10.215.144.21:443 -tls1_1 || openssl s_client -connect
</I>&gt;<i> 10.215.144.21:443 -tls1
</I>&gt;<i> 
</I>
Which brings us to reason #3; downgrade attacks.

You may have heard of the POODLE attack. It is basically a middleware
(like Squid) forcing the other endpoint(s) to re-try with lower TLS
versions until a version is reached and cipher selected that the
attacker can decrypt or steal the keys from.

Squid (mostly) avoids the whole class of vulnerabilities by leaving the
fallback decisions to the client whenever it can.

Since the curl command only did the one request, that is all that
happened. No retry.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014336.html">[squid-users] Not all html objects are being cached
</A></li>
	<LI>Next message (by thread): <A HREF="014333.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14332">[ date ]</a>
              <a href="thread.html#14332">[ thread ]</a>
              <a href="subject.html#14332">[ subject ]</a>
              <a href="author.html#14332">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
