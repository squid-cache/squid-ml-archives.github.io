<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-users Digest, Vol 30, Issue 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-users%20Digest%2C%20Vol%2030%2C%20Issue%203&In-Reply-To=%3Ca5e8d7e6-f928-173b-c6a0-d1149c35c2ef%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014353.html">
   <LINK REL="Next"  HREF="014360.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-users Digest, Vol 30, Issue 3</H1>
    <B>Sergey Klusov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-users%20Digest%2C%20Vol%2030%2C%20Issue%203&In-Reply-To=%3Ca5e8d7e6-f928-173b-c6a0-d1149c35c2ef%40gmail.com%3E"
       TITLE="[squid-users] squid-users Digest, Vol 30, Issue 3">snklusov at gmail.com
       </A><BR>
    <I>Thu Feb  2 12:22:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014353.html">[squid-users] can I authenticate client based on their certificate
</A></li>
        <LI>Next message (by thread): <A HREF="014360.html">[squid-users] squid-users Digest, Vol 30, Issue 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14356">[ date ]</a>
              <a href="thread.html#14356">[ thread ]</a>
              <a href="subject.html#14356">[ subject ]</a>
              <a href="author.html#14356">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> Date: Thu, 2 Feb 2017 03:46:44 +1300
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] transparent http and https filter with
</I>&gt;<i> 	white-list only
</I>&gt;<i> Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">1d01efe0-83f8-2a91-c0ac-fd8ef769276f at treenet.co.nz</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=utf-8
</I>&gt;<i>
</I>&gt;<i> On 28/01/2017 12:36 a.m., Sergey Klusov wrote:
</I>&gt;&gt;<i> Hello. I'm trying to get working transparent setup allowing only certain
</I>&gt;&gt;<i> domains and have problem that in order to allow https &quot;ssl_bump splice
</I>&gt;&gt;<i> allowed_domains&quot; i have to &quot;http_access allow all&quot;, thus allowing all
</I>&gt;&gt;<i> other http traffic through. Otherwise https traffic is not allowed at all.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is my config:
</I>&gt;&gt;<i>
</I>&gt;<i> Some comments inline to improve it.
</I>&gt;<i>
</I>&gt;<i> Also, what version of Squid are you using?
</I>&gt;<i>   I will assume that you are following the best practice advice and using
</I>&gt;<i> at least 3.5.19.  If not, please try to upgrade.
</I>just installed from centos7 repo, using yum
Squid Cache: Version 3.5.20

&gt;<i>
</I>&gt;&gt;<i> =======config=======
</I>&gt;&gt;<i> http_port 10.96.243.1:3128 intercept options=NO_SSLv3:NO_SSLv2
</I>&gt;&gt;<i> http_port 10.96.243.1:3130 options=NO_SSLv3:NO_SSLv2
</I>&gt;<i> Setting SSL-related options on http_port's is not useful when they are
</I>&gt;<i> not doing SSL-Bump.
</I>
ok. just copy-pasted from some internet site about ssl_bump

&gt;<i>
</I>&gt;&gt;<i> https_port 10.96.243.1:3129 intercept ssl-bump
</I>&gt;&gt;<i> options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off
</I>&gt;&gt;<i> cert=/etc/squid/squidCA.pem
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl http_allow dstdomain &quot;/etc/squid/http_allow_domains.txt&quot;
</I>&gt;&gt;<i> acl https_allow ssl::server_name &quot;/etc/squid/https_allow_domains.txt&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> Not good. Remember this is a security protocol you are playing around with.
</I>&gt;<i>
</I>&gt;<i> Both of the above lines hide critical details you need to figure out
</I>&gt;<i> what is going wrong. They can be useful as a spot-check (only!) to
</I>&gt;<i> figure out if the problem is related to cert verification or something
</I>&gt;<i> else. But DO NOT use them for regular traffic, not even testing traffic.
</I>&gt;<i>
</I>&gt;<i> You may find that there are certain _specific_ errors that you need to
</I>&gt;<i> let through. Add the appropriate flags, SSL options, ACLs checks
</I>&gt;<i> sslproxy_cert_error lines for those as needed, dont just ignore all
</I>&gt;<i> possible errors like above does.
</I>
this setup only purpose is to just allow clients to connect only to 
small set of certain sites
i suppose client's browser will do all checks?

&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump splice https_allow
</I>&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;<i>
</I>&gt;<i> Looks okay. Just to be clear you understand that:
</I>&gt;<i>   The above means that the TLS/SSL is spliced only if the client SNI
</I>&gt;<i> contains a domain in your whitelist.
</I>&gt;<i>   All other traffic will be terminated ... maybe with an HTTP error page.
</I>That's all i need. In fact i would prefer to not use squid at all for 
that purpose, but can't find any good free DPI solution.

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> cache deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow all http_allow
</I>&gt;&gt;<i> http_access allow all https_allow
</I>&gt;<i> The ssl::server_name ACL will not work outside of the ssl_bump
</I>&gt;<i> directive. Delete the above line.
</I>Ok

&gt;<i>
</I>&gt;<i> Also, I am not seeing is any line which permits the raw-IP CONNECT
</I>&gt;<i> message which your Squid processes first to decide whether ssl_bump will
</I>&gt;<i> be applied to the intercepted TCP connections.
</I>&gt;<i>
</I>&gt;<i>   That is why the &quot;allow all&quot; makes things &quot;work&quot;. It lets those CONNECT
</I>&gt;<i> request through.
</I>&gt;<i>
</I>&gt;<i> You can read the details about how bumping happens at
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps">http://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps</A>&gt;
</I>&gt;<i>   The CONNECT request mentioned in step 1.ii is your problem.
</I>&gt;<i>
</I>&gt;<i> To fix it in a very targeted way add these lines (mind the wrap sorry):
</I>&gt;<i>
</I>&gt;<i>   acl rawIP dstdom_regex
</I>&gt;<i> ^(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(\[([0-9a-f]+)?:([0-9a-f:]+)?:([0-9a-f]+|0-9\.]+)?\])):443$
</I>&gt;<i>
</I>&gt;<i>   acl bumpPort myportname 10.96.243.1:3129
</I>&gt;<i>
</I>&gt;<i>   http_access allow CONNECT bumpPort rawIP
</I>
i've worked around like this:

acl http_proto proto http
http_access allow !http

but will try your variant too
thanks.

&gt;<i>
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> always_direct allow all
</I>&gt;&gt;<i>
</I>&gt;<i> That always_direct line is not useful. Remove it.
</I>ok


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014353.html">[squid-users] can I authenticate client based on their certificate
</A></li>
	<LI>Next message (by thread): <A HREF="014360.html">[squid-users] squid-users Digest, Vol 30, Issue 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14356">[ date ]</a>
              <a href="thread.html#14356">[ thread ]</a>
              <a href="subject.html#14356">[ subject ]</a>
              <a href="author.html#14356">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
