<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-users Digest, Vol 30, Issue 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-users%20Digest%2C%20Vol%2030%2C%20Issue%203&In-Reply-To=%3C1389108c-962b-39b1-3c65-ca4d760bfde0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014356.html">
   <LINK REL="Next"  HREF="014359.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-users Digest, Vol 30, Issue 3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-users%20Digest%2C%20Vol%2030%2C%20Issue%203&In-Reply-To=%3C1389108c-962b-39b1-3c65-ca4d760bfde0%40treenet.co.nz%3E"
       TITLE="[squid-users] squid-users Digest, Vol 30, Issue 3">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb  2 13:08:40 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014356.html">[squid-users] squid-users Digest, Vol 30, Issue 3
</A></li>
        <LI>Next message (by thread): <A HREF="014359.html">[squid-users] renegotiation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14360">[ date ]</a>
              <a href="thread.html#14360">[ thread ]</a>
              <a href="subject.html#14360">[ subject ]</a>
              <a href="author.html#14360">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/02/2017 1:22 a.m., Sergey Klusov wrote:
&gt;<i> 
</I>&gt;&gt;<i> Date: Thu, 2 Feb 2017 03:46:44 +1300
</I>&gt;&gt;<i> From: Amos Jeffries
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 28/01/2017 12:36 a.m., Sergey Klusov wrote:
</I>&gt;&gt;&gt;<i> Hello. I'm trying to get working transparent setup allowing only certain
</I>&gt;&gt;&gt;<i> domains and have problem that in order to allow https &quot;ssl_bump splice
</I>&gt;&gt;&gt;<i> allowed_domains&quot; i have to &quot;http_access allow all&quot;, thus allowing all
</I>&gt;&gt;&gt;<i> other http traffic through. Otherwise https traffic is not allowed at
</I>&gt;&gt;&gt;<i> all.
</I>&gt;&gt;&gt;<i>
</I>
...
&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;<i> Not good. Remember this is a security protocol you are playing around
</I>&gt;&gt;<i> with.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Both of the above lines hide critical details you need to figure out
</I>&gt;&gt;<i> what is going wrong. They can be useful as a spot-check (only!) to
</I>&gt;&gt;<i> figure out if the problem is related to cert verification or something
</I>&gt;&gt;<i> else. But DO NOT use them for regular traffic, not even testing traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You may find that there are certain _specific_ errors that you need to
</I>&gt;&gt;<i> let through. Add the appropriate flags, SSL options, ACLs checks
</I>&gt;&gt;<i> sslproxy_cert_error lines for those as needed, dont just ignore all
</I>&gt;&gt;<i> possible errors like above does.
</I>&gt;<i> 
</I>&gt;<i> this setup only purpose is to just allow clients to connect only to
</I>&gt;<i> small set of certain sites
</I>&gt;<i> i suppose client's browser will do all checks?
</I>
What the browser sees is the stuff inside the spliced connections. Which
does not go near these sslproxy_* directives.

sslproxy_* are for Squid&lt;-&gt;Internet connections. Errors here will never
get seen by any browser and in your setup will probably be from wrongly
bump'ed traffic, so you better be aware of those problems.

...
&gt;&gt;<i>
</I>&gt;&gt;<i> To fix it in a very targeted way add these lines (mind the wrap sorry):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl rawIP dstdom_regex
</I>&gt;&gt;<i> ^(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(\[([0-9a-f]+)?:([0-9a-f:]+)?:([0-9a-f]+|0-9\.]+)?\])):443$
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl bumpPort myportname 10.96.243.1:3129
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access allow CONNECT bumpPort rawIP
</I>&gt;<i> 
</I>&gt;<i> i've worked around like this:
</I>&gt;<i> 
</I>&gt;<i> acl http_proto proto http
</I>&gt;<i> http_access allow !http
</I>&gt;<i> 
</I>&gt;<i> but will try your variant too
</I>&gt;<i> thanks.
</I>
FYI: my ACLs were being very strict. Ensuring only allow for CONNECT
requests which are coming from the port with ssl-bump, and also going to
port 443 (HTTPS).

Just allowing all non-<A HREF="http://">http://</A> URLs through the proxy is not much better
than 'allow all'.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014356.html">[squid-users] squid-users Digest, Vol 30, Issue 3
</A></li>
	<LI>Next message (by thread): <A HREF="014359.html">[squid-users] renegotiation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14360">[ date ]</a>
              <a href="thread.html#14360">[ thread ]</a>
              <a href="subject.html#14360">[ subject ]</a>
              <a href="author.html#14360">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
