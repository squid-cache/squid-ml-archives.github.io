<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL dst handled differently in intercept after rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20dst%20handled%20differently%20in%20intercept%20after%20rewrite&In-Reply-To=%3CCA%2B%2BFD2N4ORi1NSusWeOFturFpi-BqDK4Qy0wj6EJbJFjvyzbjg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014494.html">
   <LINK REL="Next"  HREF="014463.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL dst handled differently in intercept after rewrite</H1>
    <B>Craig Gowing</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20dst%20handled%20differently%20in%20intercept%20after%20rewrite&In-Reply-To=%3CCA%2B%2BFD2N4ORi1NSusWeOFturFpi-BqDK4Qy0wj6EJbJFjvyzbjg%40mail.gmail.com%3E"
       TITLE="[squid-users] ACL dst handled differently in intercept after rewrite">craig.gowing at appliansys.com
       </A><BR>
    <I>Tue Feb 14 17:27:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014494.html">[squid-users] Squid on separate box and it can't see packets
</A></li>
        <LI>Next message (by thread): <A HREF="014463.html">[squid-users] ACL dst handled differently in intercept after rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14454">[ date ]</a>
              <a href="thread.html#14454">[ thread ]</a>
              <a href="subject.html#14454">[ subject ]</a>
              <a href="author.html#14454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I've got a squid server running which allows direct proxy and also can
intercept traffic:

http_port 10.0.0.1:3128
http_port 10.0.0.1:3129 intercept

---

There is a URL rewriter which allows the incoming requests (this is just an
example, I don't really allow all):

url_rewrite_access allow all
url_rewrite_program /usr/bin/myrewriter

---

This rewriter will rewrite some URLs to a host on the same network, with
the intention that the request should not be cached by squid, eg
<A HREF="http://example.net/somefile.bin">http://example.net/somefile.bin</A> -&gt; <A HREF="http://10.0.0.2/example.net/somefile.bin">http://10.0.0.2/example.net/somefile.bin</A>
So a cache_deny directive is used for this:

acl local_store dst 10.0.0.2
cache deny local_store

---

Now when requesting this URL using a defined proxy the ACL matches and the
request is not cached. If using intercept the ACL does not match and it
does get cached (which caused some storage duplication on the network)
The debug info shows the following:

Proxy:
curl -x &quot;10.0.0.1:3128&quot; &quot;<A HREF="http://example.net/somefile.bin">http://example.net/somefile.bin</A>&quot; &gt; /dev/null
Ip.cc(95) aclIpAddrNetworkCompare: aclIpAddrNetworkCompare: compare:
10.0.0.2/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff] (10.0.0.2)  vs
10.0.0.2-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]

Intercept:
curl &quot;<A HREF="http://example.net/somefile.bin">http://example.net/somefile.bin</A>&quot; &gt; /dev/null # Intercepted on the NAT
tables
Ip.cc(95) aclIpAddrNetworkCompare: aclIpAddrNetworkCompare: compare:
93.184.216.34:80/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff] (93.184.216.34:80)
 vs 10.0.0.2-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]

This seems to show that the ACL is processed at a different stage for the
two different modes. Now I'm wondering if this is intentional and I
shouldn't be using the 'dst' ACL here, or should it be more consistant and
give the same result regardless?

I have a solution to use the 'url_regex' ACL instead which seems consistant
between the two modes, but it may slightly affect performance.

I couldn't find a huge amount of info on what order the ACLs are processed,
so if anybody could let me know what the expected behaviour should be that
would be much appreciated.

Thanks,
Craig
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170214/c33cd7ab/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170214/c33cd7ab/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014494.html">[squid-users] Squid on separate box and it can't see packets
</A></li>
	<LI>Next message (by thread): <A HREF="014463.html">[squid-users] ACL dst handled differently in intercept after rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14454">[ date ]</a>
              <a href="thread.html#14454">[ thread ]</a>
              <a href="subject.html#14454">[ subject ]</a>
              <a href="author.html#14454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
