<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Basic HTTPS filtering via CONNECT in Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Basic%20HTTPS%20filtering%20via%20CONNECT%20in%20Squid&In-Reply-To=%3CCABUhpQW_M9pCzC4CzbXmyhRo_djNFMgOyDJT0_uzQSsKcDZ9jw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014441.html">
   <LINK REL="Next"  HREF="014384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Basic HTTPS filtering via CONNECT in Squid</H1>
    <B>Varun Singh</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Basic%20HTTPS%20filtering%20via%20CONNECT%20in%20Squid&In-Reply-To=%3CCABUhpQW_M9pCzC4CzbXmyhRo_djNFMgOyDJT0_uzQSsKcDZ9jw%40mail.gmail.com%3E"
       TITLE="[squid-users] Basic HTTPS filtering via CONNECT in Squid">varun.singh at gslab.com
       </A><BR>
    <I>Wed Feb 15 07:21:35 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014441.html">[squid-users] Basic HTTPS filtering via CONNECT in Squid
</A></li>
        <LI>Next message (by thread): <A HREF="014384.html">[squid-users] HTTPS sites specifics URL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14456">[ date ]</a>
              <a href="thread.html#14456">[ thread ]</a>
              <a href="subject.html#14456">[ subject ]</a>
              <a href="author.html#14456">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Feb 13, 2017 at 12:04 PM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hey Varun,
</I>&gt;<i>
</I>&gt;<i> Filtering content based on the URL level\layer of the connection is not possible without SSL-bump.
</I>&gt;<i> There for you must use for some aspect of the connections SSL-bump.
</I>&gt;<i> However you can selectively choose which destinations would be bumped and which are not.
</I>&gt;<i> Most of the current browsers supports SNI which allows squid in some degree to decide if to fully bump the connection to the URL level or to decide to only proxy the connection in the TCP level.
</I>&gt;<i> As simple as it sounds URL level filtering requires full SSL-bump and TCP and basic TLS level filtering will not require you to fully utilize SSL-bump but will require you to fully setup squid for SSL-bump.
</I>&gt;<i>
</I>&gt;<i> This is the place to clarify that SNI based filtering is not 100% bullet proof and it could be exploited to override in a way your basic SNI based SSL level filtering.
</I>&gt;<i>
</I>&gt;<i> Do you have specific sites that you want to filter in the URL level or just globally?
</I>&gt;<i> The answer to the above question will guide us towards what might be the right path for your solution(which could be full SSL-BUMP or partial).
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> <A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Varun Singh
</I>&gt;<i> Sent: Monday, February 13, 2017 5:37 AM
</I>&gt;<i> To: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Basic HTTPS filtering via CONNECT in Squid
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Feb 12, 2017 5:43 PM, &quot;Amos Jeffries&quot; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> On 12/02/2017 11:51 p.m., Varun Singh wrote:
</I>&gt;<i> &gt; On Feb 12, 2017 2:21 PM, &quot;Amos Jeffries&quot; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 12/02/2017 7:40 p.m., Varun Singh wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The answer points to installing a CA on client.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The question was about how to get browsers talking TLS *directly to a
</I>&gt;<i> &gt; Squid reverse-proxy*. Your Ubuntu package is not capable of that and you
</I>&gt;<i> &gt; are not using a reverse-proxy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Does this mean even if I don't want Squid-in-the-middle approach, my
</I>&gt;<i> &gt;&gt; clients would still have to install a certificate?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; No. It is irrelevant to yrou sitation.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You began this thread with a simple question:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hi,
</I>&gt;<i> &gt;&gt; I have a Squid 3 installed on Ubuntu 16.04. It works perfectly as an
</I>&gt;<i> &gt;&gt; HTTP proxy server in transparent mode.
</I>&gt;<i> &gt;&gt; I wanted to know whether it can be configured to run as HTTPS proxy
</I>&gt;<i> &gt;&gt; server without ssl-bump i.e. without 'man in the middle attack'
</I>&gt;<i> &gt;&gt; technique.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Everything you have been asking about since then is various ways to do
</I>&gt;<i> &gt; parts of the SSL-bump process. Which does not fit very well with the
</I>&gt;<i> &gt; &quot;without ssl-bump&quot; requirement.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Simply put; if you are not going to SSL-Bump then you can discard any
</I>&gt;<i> &gt; thoughts of doing things with the HTTPS messages or port 443 traffic.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If you have changed your mind and want to use SSL-Bump now, please
</I>&gt;<i> &gt; re-describe what you want to actually happen now.
</I>&gt;<i> &gt;
</I>&gt;<i> You have not described what you want to happen. Just asked how to do
</I>&gt;<i> this unknown thing...
</I>&gt;<i>
</I>&gt;<i> I want to implement a URL filter using proxy server. My clients will use this server either from their web-browsers or via strongSwan IPSec VPN server. If they use the proxy server via VPN server, their VPN profile will have HTTP and HTTPS proxy server configuration.
</I>&gt;<i>
</I>&gt;<i> This proxy server will filter HTTP and HTTPS websites based on ACL provided. For security reasons, I want to avoid using SSL-bump.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt; Simply put, my question has three parts:
</I>&gt;<i> &gt; 1. Can Squid be configured as an HTTPS proxy server without SSL-Bump?
</I>&gt;<i>
</I>&gt;<i> * The term &quot;HTTPS&quot; is a generic term used to simultaneously describe two
</I>&gt;<i> completely different traffic syntaxes (CONNECT tunnels, and port 443 TLS).
</I>&gt;<i>
</I>&gt;<i> * There are three proxy operating &quot;modes&quot; which may receive each of
</I>&gt;<i> those types of traffic (explicit/forward, intercept/tproxy, and
</I>&gt;<i> reverse/CDN/accel).
</I>&gt;<i>
</I>&gt;<i> * For each type of traffic one mode is invalid, leaving 2x2= 4 different
</I>&gt;<i> sets of operations all called &quot;proxying HTTPS&quot;.
</I>&gt;<i>
</I>&gt;<i> This means the combinations are:
</I>&gt;<i> #1 CONNECT - explicit/forward
</I>&gt;<i> #2 443 TLS - explicit/forward
</I>&gt;<i>
</I>&gt;<i> #3 CONNECT - intercept/tproxy
</I>&gt;<i> #4 443 TLS - intercept/tproxy
</I>&gt;<i>
</I>&gt;<i> #5 CONNECT - reverse/CDN/accel
</I>&gt;<i> #6 443 TLS - reverse/CDN/accel
</I>&gt;<i>
</I>&gt;<i> One of modes in each type is invalid. So, from Squid's HTTPS feature page, looks like my scenario falls either in #1 or #3.
</I>&gt;<i>
</I>&gt;<i> * all 4 of those ways may be done with or without SSL-Bump feature.
</I>&gt;<i>
</I>&gt;<i> When not using SSL-Bump 2 of the ways of &quot;proxying HTTPS&quot; will work, 2
</I>&gt;<i> will not.
</I>&gt;<i>
</I>&gt;<i> When using SSL-Bump the non-working ways of &quot;proxying HTTPS&quot; will start
</I>&gt;<i> working, and the working ways will have an extra permutation of splice
</I>&gt;<i> vs bump operation that can happen. Extending the possibilities to be 6
</I>&gt;<i> ways of &quot;proxying HTTPS&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So the answer(s) to your first question are:
</I>&gt;<i>
</I>&gt;<i> yes, no.  yes, no.  no, yes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2. If yes, then what other configurations have to performed other than
</I>&gt;<i> &gt; &quot;https_port XXXX&quot;?
</I>&gt;<i> For the cases where the #1 answer was &quot;yes&quot; and not &quot;no&quot;.
</I>&gt;<i>
</I>&gt;<i> a) An explicit/forward or intercept proxy not using ssl-bump and
</I>&gt;<i> receiving CONNECT requests does not need any special configuration to
</I>&gt;<i> &quot;proxy HTTPS&quot;. The proxy will simply enact the requested opaque tunnel
</I>&gt;<i> in accordance to HTTP rules.
</I>&gt;<i>
</I>&gt;<i> So this means other than specifying &quot;https_port XXXX&quot; no other config is needed.
</I>&gt;<i> When I setup Squid with just &quot;https_port xxxx&quot; and configured Firefox to use my proxy server for HTTP and HTTPS, it worked fine for HTTP but for HTTPS it gave &quot;Proxy server rejected connection&quot;.
</I>&gt;<i>
</I>&gt;<i> So either something is wrong in my squid.conf or my assumption is incorrect that my scenario falls in #1 or #3.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> b) A reverse proxy requires the 'accel' mode flag, and the cert= option
</I>&gt;<i> must load the cert for the domain you are hosting on that port, and the
</I>&gt;<i> key= option must load the private key for that certificate.
</I>&gt;<i>
</I>&gt;<i> c) all other modes will not work without SSL-Bump feature.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 3. In this configuration, can Squid filter HTTPS requests from ACL?
</I>&gt;<i> &gt;
</I>&gt;<i> That depends on the meaning of &quot;this&quot;. There are 3 different
</I>&gt;<i> configurations in the answer to #2.
</I>&gt;<i>
</I>&gt;<i> For (2a) - no. Only the CONNECT request can be filterd.
</I>&gt;<i>
</I>&gt;<i> From below links it looks like destination IP Address or hostname of a CONNECT request is same as HTTPS request. Is that correct?
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://en.m.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling">https://en.m.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling</A>
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://stackoverflow.com/a/11698002/548403">http://stackoverflow.com/a/11698002/548403</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For (2b) - yes. BUT, notice that it requires private key data for certs.
</I>&gt;<i> This configuration is only usable when _you own the domain_ which the
</I>&gt;<i> client is visiting.
</I>&gt;<i>
</I>&gt;<i> For (2c) - SSL-Bump feature is the mechanism which enables <A HREF="https://">https://</A>
</I>&gt;<i> filtering for all traffic modes other than that described by (2b).
</I>&gt;<i> Without using that feature - no.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Do you understand now why every path you have tried ends up with how-tos
</I>&gt;<i> for configuring SSL-Bump?
</I>&gt;<i>
</I>&gt;<i> Yes, thanks for the elaborate explanation.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
Thanks for your reply Eliezer. As I understand, if I want to filter
HTTPS websites based on only hostname/IP-Address, I will still have to
configure SSL-bump. However, I may not have to use the complete
feature in order to do so. Moreover, I can choose which website to
apply SSL-bump to.
Am I correct in my assumptions?


&gt;<i> This is the place to clarify that SNI based filtering is not 100% bullet proof and it could be exploited to override in a way your basic SNI based SSL level filtering.
</I>
The SNI solution may work with web-browsers but my solution is also
targeting clients connecting via to proxy via VPN. I think SNI won't
work in that case. Is that right?

&gt;<i>
</I>&gt;<i> Do you have specific sites that you want to filter in the URL level or just globally?
</I>
I have a list of URL regexes. I have to filter HTTPS websites whose
URLs match the regex pattern.

&gt;<i> The answer to the above question will guide us towards what might be the right path for your solution(which could be full SSL-BUMP or partial).
</I>


-- 
Thanks,
Varun

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014441.html">[squid-users] Basic HTTPS filtering via CONNECT in Squid
</A></li>
	<LI>Next message (by thread): <A HREF="014384.html">[squid-users] HTTPS sites specifics URL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14456">[ date ]</a>
              <a href="thread.html#14456">[ thread ]</a>
              <a href="subject.html#14456">[ subject ]</a>
              <a href="author.html#14456">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
