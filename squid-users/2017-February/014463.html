<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL dst handled differently in intercept after rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20dst%20handled%20differently%20in%20intercept%20after%0A%20rewrite&In-Reply-To=%3C2bc4b30f-45c9-bc8b-daa8-47a644a5f9be%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014454.html">
   <LINK REL="Next"  HREF="014457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL dst handled differently in intercept after rewrite</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20dst%20handled%20differently%20in%20intercept%20after%0A%20rewrite&In-Reply-To=%3C2bc4b30f-45c9-bc8b-daa8-47a644a5f9be%40treenet.co.nz%3E"
       TITLE="[squid-users] ACL dst handled differently in intercept after rewrite">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 17 13:21:17 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014454.html">[squid-users] ACL dst handled differently in intercept after rewrite
</A></li>
        <LI>Next message (by thread): <A HREF="014457.html">[squid-users] question about : NOTICE: Authentication not	applicable onintercepted requests.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14463">[ date ]</a>
              <a href="thread.html#14463">[ thread ]</a>
              <a href="subject.html#14463">[ subject ]</a>
              <a href="author.html#14463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/02/2017 6:27 a.m., Craig Gowing wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I've got a squid server running which allows direct proxy and also can
</I>&gt;<i> intercept traffic:
</I>&gt;<i> 
</I>&gt;<i> http_port 10.0.0.1:3128
</I>&gt;<i> http_port 10.0.0.1:3129 intercept
</I>&gt;<i> 
</I>&gt;<i> ---
</I>&gt;<i> 
</I>&gt;<i> There is a URL rewriter which allows the incoming requests (this is just an
</I>&gt;<i> example, I don't really allow all):
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_access allow all
</I>&gt;<i> url_rewrite_program /usr/bin/myrewriter
</I>&gt;<i> 
</I>&gt;<i> ---
</I>&gt;<i> 
</I>&gt;<i> This rewriter will rewrite some URLs to a host on the same network, with
</I>&gt;<i> the intention that the request should not be cached by squid, eg
</I>&gt;<i> <A HREF="http://example.net/somefile.bin">http://example.net/somefile.bin</A> -&gt; <A HREF="http://10.0.0.2/example.net/somefile.bin">http://10.0.0.2/example.net/somefile.bin</A>
</I>&gt;<i> So a cache_deny directive is used for this:
</I>&gt;<i> 
</I>&gt;<i> acl local_store dst 10.0.0.2
</I>&gt;<i> cache deny local_store
</I>&gt;<i> 
</I>&gt;<i> ---
</I>&gt;<i> 
</I>&gt;<i> Now when requesting this URL using a defined proxy ...
</I>
Where the client sends a URL and expects the proxy to perform DNS
lookups. The destination is any one of a set of IPs returned by DNS from
a lookup performed by Squid.

&gt;<i> ... the ACL matches and the request is not cached.
</I>
&gt;<i> If using intercept ...
</I>
Where the destination is a specific IP address provided by the NAT
system on the machine Squid is running on. It was selected by the client
from a DNS lookup from that clients machine.

&gt;<i> ... the ACL does not match and it
</I>&gt;<i> does get cached (which caused some storage duplication on the network)
</I>&gt;<i> The debug info shows the following:
</I>&gt;<i> 
</I>&gt;<i> Proxy:
</I>&gt;<i> curl -x &quot;10.0.0.1:3128&quot; &quot;<A HREF="http://example.net/somefile.bin">http://example.net/somefile.bin</A>&quot; &gt; /dev/null
</I>&gt;<i> Ip.cc(95) aclIpAddrNetworkCompare: aclIpAddrNetworkCompare: compare:
</I>&gt;<i> 10.0.0.2/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff] (10.0.0.2)  vs
</I>&gt;<i> 10.0.0.2-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]
</I>&gt;<i> 
</I>&gt;<i> Intercept:
</I>&gt;<i> curl &quot;<A HREF="http://example.net/somefile.bin">http://example.net/somefile.bin</A>&quot; &gt; /dev/null # Intercepted on the NAT
</I>&gt;<i> tables
</I>&gt;<i> Ip.cc(95) aclIpAddrNetworkCompare: aclIpAddrNetworkCompare: compare:
</I>&gt;<i> 93.184.216.34:80/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff] (93.184.216.34:80)
</I>&gt;<i>  vs 10.0.0.2-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]
</I>&gt;<i> 
</I>&gt;<i> This seems to show that the ACL is processed at a different stage for the
</I>&gt;<i> two different modes. Now I'm wondering if this is intentional and I
</I>&gt;<i> shouldn't be using the 'dst' ACL here, or should it be more consistant and
</I>&gt;<i> give the same result regardless?
</I>
It is intentional.

A NAT intercept proxy has a single specific dst-IP selected by the
client from a DNS lookup done before anythign got near to Squid.

An explicit-proxy has a whole set of potential dst-IPs found from
looking up the URL domain name (after URL rewriter changes) - any one of
which can match.

The URL-rewriter is doing exactly that. Re-writing the *URL*, not the
destination the client was attempting to reach.


&gt;<i> 
</I>&gt;<i> I have a solution to use the 'url_regex' ACL instead which seems consistant
</I>&gt;<i> between the two modes, but it may slightly affect performance.
</I>
Why not use dstdomain ACL? it was designed for matching the domain name
which is being requested by the client.


In fact whats the point of the rewriter pre-pending a raw-IP address in
the first place?

&gt;<i> 
</I>&gt;<i> I couldn't find a huge amount of info on what order the ACLs are processed,
</I>&gt;<i> so if anybody could let me know what the expected behaviour should be that
</I>&gt;<i> would be much appreciated.
</I>&gt;<i> 
</I>
&lt;<A HREF="http://wiki.squid-cache.org/ProgrammingGuide/Architecture#Transaction_Processing">http://wiki.squid-cache.org/ProgrammingGuide/Architecture#Transaction_Processing</A>&gt;
is the best we have other than the code itself.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014454.html">[squid-users] ACL dst handled differently in intercept after rewrite
</A></li>
	<LI>Next message (by thread): <A HREF="014457.html">[squid-users] question about : NOTICE: Authentication not	applicable onintercepted requests.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14463">[ date ]</a>
              <a href="thread.html#14463">[ thread ]</a>
              <a href="subject.html#14463">[ subject ]</a>
              <a href="author.html#14463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
