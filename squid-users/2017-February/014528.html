<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-Bump%3A%20NAT/TPROXY%20lookup%20failed%20to%20locate%0A%20original%20IPs&In-Reply-To=%3CCAPhcQuJCeKZYSwmefsAxsFx7kHCWCkOg6kkmgH-WE4Sz2%3DsXAA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014527.html">
   <LINK REL="Next"  HREF="014529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs</H1>
    <B>Test User</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-Bump%3A%20NAT/TPROXY%20lookup%20failed%20to%20locate%0A%20original%20IPs&In-Reply-To=%3CCAPhcQuJCeKZYSwmefsAxsFx7kHCWCkOg6kkmgH-WE4Sz2%3DsXAA%40mail.gmail.com%3E"
       TITLE="[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs">tuser6485 at gmail.com
       </A><BR>
    <I>Mon Feb 27 05:41:08 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014527.html">[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate	original IPs
</A></li>
        <LI>Next message (by thread): <A HREF="014529.html">[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14528">[ date ]</a>
              <a href="thread.html#14528">[ thread ]</a>
              <a href="subject.html#14528">[ subject ]</a>
              <a href="author.html#14528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Feb 27, 2017 at 2:53 AM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
&gt;<i> Let me know if you need some help..
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Eliezer Croitoru
</I>&gt;<i> Sent: Sunday, February 26, 2017 8:51 PM
</I>&gt;<i> To: 'Test User' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tuser6485 at gmail.com</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</I>&gt;<i>
</I>&gt;<i> Hey Michael,
</I>&gt;<i>
</I>&gt;<i> The details you attached explained pretty well the cause for the issues you have described.
</I>&gt;<i> What you will need to do in order to make this setup to work can be done in more then one way.
</I>&gt;<i> For a sysadmin the simplest way is to create a VPN or some kind of a tunnel between the AWS instance to the local router.
</I>&gt;<i> I am almost sure that you can use haproxy to do a local tproxy or interception that will forward the traffic to the remote squid with the PROXY protocol keeping original source and original destination visible to the remote squid.
</I>&gt;<i>
</I>&gt;<i> The choice will depend on both:
</I>&gt;<i> - your skills and will to dig some time about couple subjects
</I>&gt;<i> - The availability of static IP addresses(both local and AWS).
</I>&gt;<i> - The OS on both sides
</I>&gt;<i>
</I>&gt;<i> I believe that the next haproxy settings can be used as a compromise to a tunnel:
</I>&gt;<i> <A HREF="http://ngtech.co.il/paste/1605/">http://ngtech.co.il/paste/1605/</A>
</I>&gt;<i> And some tproxy route and iptables rules ..
</I>&gt;<i> With a squid.conf which will be similar to:
</I>&gt;<i> acl frontend src 100.0.0.1
</I>&gt;<i> proxy_protocol_access allow frontend
</I>&gt;<i> http_port 3127
</I>&gt;<i> http_port 3128 require-proxy-header ... ssl-bump settings
</I>&gt;<i> ##END of example
</I>&gt;<i>
</I>&gt;<i> However I do still believe that the more secure way would be to use some kind of vpn tunnel like OpenVPN between the local router to the remote AWS instance.
</I>&gt;<i>
</I>&gt;<i> All The Bests,
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Test User [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tuser6485 at gmail.com</A>]
</I>&gt;<i> Sent: Sunday, February 26, 2017 8:38 AM
</I>&gt;<i> To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</I>&gt;<i>
</I>&gt;<i> On Sun, Feb 26, 2017 at 10:40 AM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;&gt;<i> Hey Michael,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You will need to clear out couple things for us.
</I>&gt;&gt;<i> First we will need one of the next ouputs or both:
</I>&gt;&gt;<i> iptables-save
</I>&gt;&gt;<i> iptables -L -nv
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And then clear out where is this proxy sittings and the network structure.
</I>&gt;&gt;<i> It's not clear if the squid box is the router or a machine somewhere on AWS.
</I>&gt;&gt;<i> If you wish to pass traffic from a local router to a one on AWS you will need to create a tunnel like using OpenVPN or a similar solution and to use some routing rules to pass the traffic from the local LAN to AWS without removing the original destination address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When more details on the setup will be available it will be much simpler to understand what is the root for some of the issues you are having.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All The Bests,
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;<i> Linux System Administrator
</I>&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Test User
</I>&gt;&gt;<i> Sent: Friday, February 24, 2017 8:52 AM
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> Sorry I am asking this question again. I am trying to setup HTTPS
</I>&gt;&gt;<i> proxy using ssl-bump. I have followed
</I>&gt;&gt;<i> steps mentioned in:
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit">http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Following are Squid setup details:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid Cache: Version 3.5.12
</I>&gt;&gt;<i> Service Name: squid
</I>&gt;&gt;<i> Ubuntu linux
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr'
</I>&gt;&gt;<i> '--includedir=${prefix}/include' '--mandir=${prefix}/share/man'
</I>&gt;&gt;<i> '--infodir=${prefix}/share/info' '--sysconfdir=/etc'
</I>&gt;&gt;<i> '--localstatedir=/var' '--libexecdir=${prefix}/lib/squid3'
</I>&gt;&gt;<i> '--srcdir=.' '--disable-maintainer-mode'
</I>&gt;&gt;<i> '--disable-dependency-tracking' '--disable-silent-rules'
</I>&gt;&gt;<i> 'BUILDCXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat
</I>&gt;&gt;<i> -Werror=format-security -Wl,-Bsymbolic-functions -fPIE -pie
</I>&gt;&gt;<i> -Wl,-z,relro -Wl,-z,now' '--datadir=/usr/share/squid'
</I>&gt;&gt;<i> '--sysconfdir=/etc/squid' '--libexecdir=/usr/lib/squid'
</I>&gt;&gt;<i> '--mandir=/usr/share/man' '--enable-inline' '--disable-arch-native'
</I>&gt;&gt;<i> '--enable-async-io=8' '--enable-storeio=ufs,aufs,diskd,rock'
</I>&gt;&gt;<i> '--enable-removal-policies=lru,heap' '--enable-delay-pools'
</I>&gt;&gt;<i> '--enable-cache-digests' '--enable-icap-client'
</I>&gt;&gt;<i> '--enable-follow-x-forwarded-for'
</I>&gt;&gt;<i> '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'
</I>&gt;&gt;<i> '--enable-auth-digest=file,LDAP'
</I>&gt;&gt;<i> '--enable-auth-negotiate=kerberos,wrapper'
</I>&gt;&gt;<i> '--enable-auth-ntlm=fake,smb_lm'
</I>&gt;&gt;<i> '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group'
</I>&gt;&gt;<i> '--enable-url-rewrite-helpers=fake' '--enable-eui' '--enable-esi'
</I>&gt;&gt;<i> '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--with-openssl'
</I>&gt;&gt;<i> '--enable-ssl-crtd' '--disable-translation'
</I>&gt;&gt;<i> '--with-swapdir=/var/spool/squid' '--with-logdir=/var/log/squid'
</I>&gt;&gt;<i> '--with-pidfile=/var/run/squid.pid' '--with-filedescriptors=65536'
</I>&gt;&gt;<i> '--with-large-files' '--with-default-user=proxy'
</I>&gt;&gt;<i> '--enable-build-info=Ubuntu linux' '--enable-linux-netfilter'
</I>&gt;&gt;<i> 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2 -fPIE
</I>&gt;&gt;<i> -fstack-protector-strong -Wformat -Werror=format-security -Wall'
</I>&gt;&gt;<i> 'LDFLAGS=-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now'
</I>&gt;&gt;<i> 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE
</I>&gt;&gt;<i> -fstack-protector-strong -Wformat -Werror=format-security'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Following is my squid.conf file:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80 # http
</I>&gt;&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443 # https
</I>&gt;&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> http_access allow all
</I>&gt;&gt;<i> http_port 3128 ssl-bump \
</I>&gt;&gt;<i>   cert=/etc/squid/ssl_cert/squidCA.pem \
</I>&gt;&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on \
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/squidCA.pem \
</I>&gt;&gt;<i> dhparams=/etc/squid/ssl_cert/dhparam.pem
</I>&gt;&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i> sslproxy_cipher
</I>&gt;&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/spool/squid3_ssldb -M 4MB
</I>&gt;&gt;<i> debug_options ALL,1 3,5 4,5 11,5 17,5 23,5 46,5 78,5 rotate=1
</I>&gt;&gt;<i> coredump_dir /var/spool/squid
</I>&gt;&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I get no errors while starting Squid. Following are the logs when Squid starts:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| Set Current Directory to /var/spool/squid
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| Starting Squid Cache version 3.5.12 for
</I>&gt;&gt;<i> x86_64-pc-linux-gnu...
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| Service Name: squid
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| Process ID 26236
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| Process Roles: worker
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| With 65535 file descriptors available
</I>&gt;&gt;<i> 2017/02/23 09:59:53 kid1| Initializing IP Cache...
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| 78,2| dns_internal.cc(1525) dnsInit:
</I>&gt;&gt;<i> idnsInit: attempt open DNS socket to: [::]
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| 78,2| dns_internal.cc(1534) dnsInit:
</I>&gt;&gt;<i> idnsInit: attempt open DNS socket to: 0.0.0.0
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| DNS Socket created at [::], FD 6
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| DNS Socket created at 0.0.0.0, FD 7
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| Adding nameserver 172.31.0.2 from /etc/resolv.conf
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| 78,3| dns_internal.cc(321)
</I>&gt;&gt;<i> idnsAddNameserver: idnsAddNameserver: Added nameserver #0
</I>&gt;&gt;<i> (172.31.0.2:53)
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| Adding domain
</I>&gt;&gt;<i> ap-south-1.compute.internal from /etc/resolv.conf
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| 78,3| dns_internal.cc(350)
</I>&gt;&gt;<i> idnsAddPathComponent: idnsAddPathComponent: Added domain #0:
</I>&gt;&gt;<i> ap-south-1.compute.internal
</I>&gt;&gt;<i> 2017/02/23 09:59:53.756 kid1| helperOpenServers: Starting 5/32
</I>&gt;&gt;<i> 'ssl_crtd' processes
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,2| Format.cc(64) parse: got
</I>&gt;&gt;<i> definition '%&gt;a/%&gt;A %un %&gt;rm myip=%la myport=%lp'
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> possible 1C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> possible 1C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,2| Format.cc(64) parse: got
</I>&gt;&gt;<i> definition '%&gt;a/%&gt;A %un %&gt;rm myip=%la myport=%lp'
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> possible 1C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> possible 1C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> possible Misc token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> possible 2C token
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| Logfile: opening log
</I>&gt;&gt;<i> daemon:/var/log/squid/access.log
</I>&gt;&gt;<i> 2017/02/23 09:59:53.775 kid1| Logfile Daemon: opening log
</I>&gt;&gt;<i> /var/log/squid/access.log
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| 23,5| url.cc(43) urlInitialize:
</I>&gt;&gt;<i> urlInitialize: Initializing...
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Local cache digest enabled;
</I>&gt;&gt;<i> rebuild/rewrite every 3600/3600 sec
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Store logging disabled
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Swap maxSize 0 + 262144 KB, estimated
</I>&gt;&gt;<i> 20164 objects
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Target number of buckets: 1008
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Using 8192 Store buckets
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Max Mem  size: 262144 KB
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Max Swap size: 0 KB
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Using Least Load store dir selection
</I>&gt;&gt;<i> 2017/02/23 09:59:53.779 kid1| Set Current Directory to /var/spool/squid
</I>&gt;&gt;<i> 2017/02/23 09:59:53.785 kid1| 23,3| url.cc(357) urlParse: urlParse:
</I>&gt;&gt;<i> Split URL '<A HREF="http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/image.png">http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/image.png</A>'
</I>&gt;&gt;<i> into proto='http', host='ip-172-31-25-235', port='3128',
</I>&gt;&gt;<i> path='/squid-internal-static/icons/silk/image.png'
</I>&gt;&gt;<i> 2017/02/23 09:59:53.785 kid1| 23,3| url.cc(357) urlParse: urlParse:
</I>&gt;&gt;<i> Split URL '<A HREF="http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/page_white_text.png">http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/page_white_text.png</A>'
</I>&gt;&gt;<i> into proto='http', host='ip-172-31-25-235', port='3128',
</I>&gt;&gt;<i> path='/squid-internal-static/icons/silk/page_white_text.png'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ****several urlParse logs like above. Removing them to shorten the
</I>&gt;&gt;<i> email. Further logs below...****
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| Finished loading MIME types and icons.
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| HTCP Disabled.
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| Pinger socket opened on FD 25
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| Squid plugin modules loaded: 0
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| Adaptation support is off.
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| Accepting SSL bumped HTTP Socket
</I>&gt;&gt;<i> connections at local=[::]:3128 remote=[::] FD 22 flags=9
</I>&gt;&gt;<i> 2017/02/23 09:59:53.815 kid1| Accepting NAT intercepted SSL bumped
</I>&gt;&gt;<i> HTTPS Socket connections at local=[::]:3129 remote=[::] FD 23 flags=41
</I>&gt;&gt;<i> 2017/02/23 09:59:53| pinger: Initialising ICMP pinger ...
</I>&gt;&gt;<i> 2017/02/23 09:59:53| pinger: ICMP socket opened.
</I>&gt;&gt;<i> 2017/02/23 09:59:53| pinger: ICMPv6 socket opened
</I>&gt;&gt;<i> 2017/02/23 09:59:54 kid1| storeLateRelease: released 0 objects
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tested this setup by providing proxy details to Firefox. Firefox was
</I>&gt;&gt;<i> able to show HTTP websites but when I tried to open an HTTPS website I
</I>&gt;&gt;<i> got following error:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2017/02/23 11:00:50 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;&gt;<i> local=172.31.25.235:3129 remote=182.72.78.122:50655 FD 7 flags=33:
</I>&gt;&gt;<i> (92) Protocol not available
</I>&gt;&gt;<i> 2017/02/23 11:00:50 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> original IPs on local=172.31.25.235:3129 remote=182.72.78.122:50655 FD
</I>&gt;&gt;<i> 7 flags=33
</I>&gt;&gt;<i> 2017/02/23 11:00:50 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;&gt;<i> local=172.31.25.235:3129 remote=182.72.78.122:50656 FD 7 flags=33:
</I>&gt;&gt;<i> (92) Protocol not available
</I>&gt;&gt;<i> 2017/02/23 11:00:50 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> original IPs on local=172.31.25.235:3129 remote=182.72.78.122:50656 FD
</I>&gt;&gt;<i> 7 flags=33
</I>&gt;&gt;<i> 2017/02/23 11:00:50 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;&gt;<i> local=172.31.25.235:3129 remote=182.72.78.122:50657 FD 7 flags=33:
</I>&gt;&gt;<i> (92) Protocol not available
</I>&gt;&gt;<i> 2017/02/23 11:00:50 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> original IPs on local=172.31.25.235:3129 remote=182.72.78.122:50657 FD
</I>&gt;&gt;<i> 7 flags=33
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I googled this error and found this mail thread which had similar problems:
</I>&gt;&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/NAT-TPROXY-lookup-failed-to-locate-original-IPs-td4675464.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/NAT-TPROXY-lookup-failed-to-locate-original-IPs-td4675464.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I found this link from the above thread. I modified the steps for
</I>&gt;&gt;<i> HTTPS from the below link:
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now my sysctl.conf is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> net.ipv4.conf.all.rp_filter=0
</I>&gt;&gt;<i> net.ipv4.ip_forward = 1
</I>&gt;&gt;<i> net.ipv4.conf.default.rp_filter = 0
</I>&gt;&gt;<i> net.ipv4.conf.default.accept_source_route = 0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My iptables -t nat -L result:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain PREROUTING (policy ACCEPT)
</I>&gt;&gt;<i> target     prot opt source               destination
</I>&gt;&gt;<i> ACCEPT     tcp  --  ec2-35-154-101-8.ap-south-1.compute.amazonaws.com
</I>&gt;&gt;<i> anywhere             tcp dpt:https
</I>&gt;&gt;<i> DNAT       tcp  --  anywhere             anywhere             tcp
</I>&gt;&gt;<i> dpt:https to:35.154.101.8:3129
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain INPUT (policy ACCEPT)
</I>&gt;&gt;<i> target     prot opt source               destination
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain OUTPUT (policy ACCEPT)
</I>&gt;&gt;<i> target     prot opt source               destination
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Chain POSTROUTING (policy ACCEPT)
</I>&gt;&gt;<i> target     prot opt source               destination
</I>&gt;&gt;<i> MASQUERADE  all  --  anywhere             anywhere
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Once this was done, I tried to hit HTTPS website from Firefox and now
</I>&gt;&gt;<i> I get connection timeout error. Nothing shows in syslog, access.log or
</I>&gt;&gt;<i> cache.log. Could you please help me resolve this.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Michael
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks for replying Eliezer. Following are the outputs you asked:
</I>&gt;<i>
</I>&gt;<i> 1. iptables-save:
</I>&gt;<i>
</I>&gt;<i> # Generated by iptables-save v1.6.0 on Sun Feb 26 06:28:46 2017
</I>&gt;<i> *filter
</I>&gt;<i> :INPUT ACCEPT [171:12090]
</I>&gt;<i> :FORWARD ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [106:15187]
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Sun Feb 26 06:28:46 2017
</I>&gt;<i> # Generated by iptables-save v1.6.0 on Sun Feb 26 06:28:46 2017
</I>&gt;<i> *mangle
</I>&gt;<i> :PREROUTING ACCEPT [89003:74850371]
</I>&gt;<i> :INPUT ACCEPT [88973:74849159]
</I>&gt;<i> :FORWARD ACCEPT [30:1212]
</I>&gt;<i> :OUTPUT ACCEPT [76710:51478183]
</I>&gt;<i> :POSTROUTING ACCEPT [76740:51479395]
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 3129 -j DROP
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Sun Feb 26 06:28:46 2017
</I>&gt;<i> # Generated by iptables-save v1.6.0 on Sun Feb 26 06:28:46 2017
</I>&gt;<i> *nat
</I>&gt;<i> :PREROUTING ACCEPT [7766:436942]
</I>&gt;<i> :INPUT ACCEPT [7766:436942]
</I>&gt;<i> :OUTPUT ACCEPT [952:102330]
</I>&gt;<i> :POSTROUTING ACCEPT [0:0]
</I>&gt;<i> -A PREROUTING -s 35.154.101.8/32 -p tcp -m tcp --dport 443 -j ACCEPT
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 443 -j DNAT --to-destination
</I>&gt;<i> 35.154.101.8:3129
</I>&gt;<i> -A POSTROUTING -j MASQUERADE
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Sun Feb 26 06:28:46 2017
</I>&gt;<i>
</I>&gt;<i> 2. Also pasting sudo iptables -L -nv:
</I>&gt;<i>
</I>&gt;<i> Chain INPUT (policy ACCEPT 216 packets, 16058 bytes)
</I>&gt;<i>  pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>
</I>&gt;<i> Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
</I>&gt;<i>  pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>
</I>&gt;<i> Chain OUTPUT (policy ACCEPT 161 packets, 24629 bytes)
</I>&gt;<i>  pkts bytes target     prot opt in     out     source               destination
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> And then clear out where is this proxy sittings and the network structure.
</I>&gt;&gt;<i> It's not clear if the squid box is the router or a machine somewhere on AWS.
</I>&gt;<i>
</I>&gt;<i> [Michael] This proxy is installed on an AWS instance.
</I>&gt;<i>
</I>&gt;&gt;<i> If you wish to pass traffic from a local router to a one on AWS you will need to create a tunnel like using OpenVPN or a similar solution and to use some routing rules to pass the traffic from the local LAN to AWS without removing the original destination address.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> [Michael] Does this mean, to make ssl-bump work, I will have to setup
</I>&gt;<i> a VPN server and configure the VPN clients to use this proxy via VPN
</I>&gt;<i> server?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Michael.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


Thanks for replying Eliezer. Your advice is much appreciated.

&gt;<i> The details you attached explained pretty well the cause for the issues you have described.
</I>&gt;<i> What you will need to do in order to make this setup to work can be done in more then one way.
</I>&gt;<i> For a sysadmin the simplest way is to create a VPN or some kind of a tunnel between the AWS instance to the local router.
</I>&gt;<i> I am almost sure that you can use haproxy to do a local tproxy or interception that will forward the traffic to the remote squid with the PROXY protocol keeping original source and original destination visible to the remote squid.
</I>&gt;<i>
</I>&gt;<i> The choice will depend on both:
</I>&gt;<i> - your skills and will to dig some time about couple subjects
</I>&gt;<i> - The availability of static IP addresses(both local and AWS).
</I>&gt;<i> - The OS on both sides
</I>
[Michael] Actually, my original setup involves a VPN server. I wasn't
using it because I wanted to setup ssl-bump with simplest possible
settings. My actual setup involves:

1. strongSwan IPSec VPN server
2. Squid Proxy server
3. Clients will be IPSec VPN clients. I can specify the IP address and
port of HTTPS Proxy server in IPSec VPN client itself.

In the above setup described, will I have to do something extra to
make ssl-bump work?

Thanks,
Michael.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014527.html">[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate	original IPs
</A></li>
	<LI>Next message (by thread): <A HREF="014529.html">[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14528">[ date ]</a>
              <a href="thread.html#14528">[ thread ]</a>
              <a href="subject.html#14528">[ subject ]</a>
              <a href="author.html#14528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
