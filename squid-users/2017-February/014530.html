<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-Bump%3A%20NAT/TPROXY%20lookup%20failed%20to%20locate%0A%20original%20IPs&In-Reply-To=%3CCAPhcQuLPzV%3DPEMdn0_1_%2BWuZXSeS2v7VSk7thQ%3DszcLHcGnZKA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014529.html">
   <LINK REL="Next"  HREF="014509.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs</H1>
    <B>Test User</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL-Bump%3A%20NAT/TPROXY%20lookup%20failed%20to%20locate%0A%20original%20IPs&In-Reply-To=%3CCAPhcQuLPzV%3DPEMdn0_1_%2BWuZXSeS2v7VSk7thQ%3DszcLHcGnZKA%40mail.gmail.com%3E"
       TITLE="[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs">tuser6485 at gmail.com
       </A><BR>
    <I>Mon Feb 27 05:50:32 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014529.html">[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</A></li>
        <LI>Next message (by thread): <A HREF="014509.html">[squid-users] My Squid stop working WITHOUT any reason.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14530">[ date ]</a>
              <a href="thread.html#14530">[ thread ]</a>
              <a href="subject.html#14530">[ subject ]</a>
              <a href="author.html#14530">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Feb 27, 2017 at 11:14 AM, Odhiambo Washington
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">odhiambo at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 27 February 2017 at 08:41, Test User &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tuser6485 at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Feb 27, 2017 at 2:53 AM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Let me know if you need some help..
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Eliezer
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ----
</I>&gt;&gt;<i> &gt; Eliezer Croitoru
</I>&gt;&gt;<i> &gt; Linux System Administrator
</I>&gt;&gt;<i> &gt; Mobile: +972-5-28704261
</I>&gt;&gt;<i> &gt; Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; -----Original Message-----
</I>&gt;&gt;<i> &gt; From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;&gt;<i> &gt; Behalf Of Eliezer Croitoru
</I>&gt;&gt;<i> &gt; Sent: Sunday, February 26, 2017 8:51 PM
</I>&gt;&gt;<i> &gt; To: 'Test User' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tuser6485 at gmail.com</A>&gt;
</I>&gt;&gt;<i> &gt; Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt; Subject: Re: [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> &gt; original IPs
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Hey Michael,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The details you attached explained pretty well the cause for the issues
</I>&gt;&gt;<i> &gt; you have described.
</I>&gt;&gt;<i> &gt; What you will need to do in order to make this setup to work can be done
</I>&gt;&gt;<i> &gt; in more then one way.
</I>&gt;&gt;<i> &gt; For a sysadmin the simplest way is to create a VPN or some kind of a
</I>&gt;&gt;<i> &gt; tunnel between the AWS instance to the local router.
</I>&gt;&gt;<i> &gt; I am almost sure that you can use haproxy to do a local tproxy or
</I>&gt;&gt;<i> &gt; interception that will forward the traffic to the remote squid with the
</I>&gt;&gt;<i> &gt; PROXY protocol keeping original source and original destination visible to
</I>&gt;&gt;<i> &gt; the remote squid.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The choice will depend on both:
</I>&gt;&gt;<i> &gt; - your skills and will to dig some time about couple subjects
</I>&gt;&gt;<i> &gt; - The availability of static IP addresses(both local and AWS).
</I>&gt;&gt;<i> &gt; - The OS on both sides
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I believe that the next haproxy settings can be used as a compromise to
</I>&gt;&gt;<i> &gt; a tunnel:
</I>&gt;&gt;<i> &gt; <A HREF="http://ngtech.co.il/paste/1605/">http://ngtech.co.il/paste/1605/</A>
</I>&gt;&gt;<i> &gt; And some tproxy route and iptables rules ..
</I>&gt;&gt;<i> &gt; With a squid.conf which will be similar to:
</I>&gt;&gt;<i> &gt; acl frontend src 100.0.0.1
</I>&gt;&gt;<i> &gt; proxy_protocol_access allow frontend
</I>&gt;&gt;<i> &gt; http_port 3127
</I>&gt;&gt;<i> &gt; http_port 3128 require-proxy-header ... ssl-bump settings
</I>&gt;&gt;<i> &gt; ##END of example
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; However I do still believe that the more secure way would be to use some
</I>&gt;&gt;<i> &gt; kind of vpn tunnel like OpenVPN between the local router to the remote AWS
</I>&gt;&gt;<i> &gt; instance.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; All The Bests,
</I>&gt;&gt;<i> &gt; Eliezer
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ----
</I>&gt;&gt;<i> &gt; Eliezer Croitoru
</I>&gt;&gt;<i> &gt; Linux System Administrator
</I>&gt;&gt;<i> &gt; Mobile: +972-5-28704261
</I>&gt;&gt;<i> &gt; Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; -----Original Message-----
</I>&gt;&gt;<i> &gt; From: Test User [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">tuser6485 at gmail.com</A>]
</I>&gt;&gt;<i> &gt; Sent: Sunday, February 26, 2017 8:38 AM
</I>&gt;&gt;<i> &gt; To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;&gt;<i> &gt; Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt; Subject: Re: [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> &gt; original IPs
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On Sun, Feb 26, 2017 at 10:40 AM, Eliezer Croitoru
</I>&gt;&gt;<i> &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;&gt; Hey Michael,
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; You will need to clear out couple things for us.
</I>&gt;&gt;<i> &gt;&gt; First we will need one of the next ouputs or both:
</I>&gt;&gt;<i> &gt;&gt; iptables-save
</I>&gt;&gt;<i> &gt;&gt; iptables -L -nv
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; And then clear out where is this proxy sittings and the network
</I>&gt;&gt;<i> &gt;&gt; structure.
</I>&gt;&gt;<i> &gt;&gt; It's not clear if the squid box is the router or a machine somewhere on
</I>&gt;&gt;<i> &gt;&gt; AWS.
</I>&gt;&gt;<i> &gt;&gt; If you wish to pass traffic from a local router to a one on AWS you
</I>&gt;&gt;<i> &gt;&gt; will need to create a tunnel like using OpenVPN or a similar solution and to
</I>&gt;&gt;<i> &gt;&gt; use some routing rules to pass the traffic from the local LAN to AWS without
</I>&gt;&gt;<i> &gt;&gt; removing the original destination address.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; When more details on the setup will be available it will be much
</I>&gt;&gt;<i> &gt;&gt; simpler to understand what is the root for some of the issues you are
</I>&gt;&gt;<i> &gt;&gt; having.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; All The Bests,
</I>&gt;&gt;<i> &gt;&gt; Eliezer
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; ----
</I>&gt;&gt;<i> &gt;&gt; Eliezer Croitoru
</I>&gt;&gt;<i> &gt;&gt; Linux System Administrator
</I>&gt;&gt;<i> &gt;&gt; Mobile: +972-5-28704261
</I>&gt;&gt;<i> &gt;&gt; Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; -----Original Message-----
</I>&gt;&gt;<i> &gt;&gt; From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;&gt;<i> &gt;&gt; Behalf Of Test User
</I>&gt;&gt;<i> &gt;&gt; Sent: Friday, February 24, 2017 8:52 AM
</I>&gt;&gt;<i> &gt;&gt; To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt;&gt; Subject: [squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> &gt;&gt; original IPs
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Hi,
</I>&gt;&gt;<i> &gt;&gt; Sorry I am asking this question again. I am trying to setup HTTPS
</I>&gt;&gt;<i> &gt;&gt; proxy using ssl-bump. I have followed
</I>&gt;&gt;<i> &gt;&gt; steps mentioned in:
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit">http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Following are Squid setup details:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Squid Cache: Version 3.5.12
</I>&gt;&gt;<i> &gt;&gt; Service Name: squid
</I>&gt;&gt;<i> &gt;&gt; Ubuntu linux
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr'
</I>&gt;&gt;<i> &gt;&gt; '--includedir=${prefix}/include' '--mandir=${prefix}/share/man'
</I>&gt;&gt;<i> &gt;&gt; '--infodir=${prefix}/share/info' '--sysconfdir=/etc'
</I>&gt;&gt;<i> &gt;&gt; '--localstatedir=/var' '--libexecdir=${prefix}/lib/squid3'
</I>&gt;&gt;<i> &gt;&gt; '--srcdir=.' '--disable-maintainer-mode'
</I>&gt;&gt;<i> &gt;&gt; '--disable-dependency-tracking' '--disable-silent-rules'
</I>&gt;&gt;<i> &gt;&gt; 'BUILDCXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat
</I>&gt;&gt;<i> &gt;&gt; -Werror=format-security -Wl,-Bsymbolic-functions -fPIE -pie
</I>&gt;&gt;<i> &gt;&gt; -Wl,-z,relro -Wl,-z,now' '--datadir=/usr/share/squid'
</I>&gt;&gt;<i> &gt;&gt; '--sysconfdir=/etc/squid' '--libexecdir=/usr/lib/squid'
</I>&gt;&gt;<i> &gt;&gt; '--mandir=/usr/share/man' '--enable-inline' '--disable-arch-native'
</I>&gt;&gt;<i> &gt;&gt; '--enable-async-io=8' '--enable-storeio=ufs,aufs,diskd,rock'
</I>&gt;&gt;<i> &gt;&gt; '--enable-removal-policies=lru,heap' '--enable-delay-pools'
</I>&gt;&gt;<i> &gt;&gt; '--enable-cache-digests' '--enable-icap-client'
</I>&gt;&gt;<i> &gt;&gt; '--enable-follow-x-forwarded-for'
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'
</I>&gt;&gt;<i> &gt;&gt; '--enable-auth-digest=file,LDAP'
</I>&gt;&gt;<i> &gt;&gt; '--enable-auth-negotiate=kerberos,wrapper'
</I>&gt;&gt;<i> &gt;&gt; '--enable-auth-ntlm=fake,smb_lm'
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group'
</I>&gt;&gt;<i> &gt;&gt; '--enable-url-rewrite-helpers=fake' '--enable-eui' '--enable-esi'
</I>&gt;&gt;<i> &gt;&gt; '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--with-openssl'
</I>&gt;&gt;<i> &gt;&gt; '--enable-ssl-crtd' '--disable-translation'
</I>&gt;&gt;<i> &gt;&gt; '--with-swapdir=/var/spool/squid' '--with-logdir=/var/log/squid'
</I>&gt;&gt;<i> &gt;&gt; '--with-pidfile=/var/run/squid.pid' '--with-filedescriptors=65536'
</I>&gt;&gt;<i> &gt;&gt; '--with-large-files' '--with-default-user=proxy'
</I>&gt;&gt;<i> &gt;&gt; '--enable-build-info=Ubuntu linux' '--enable-linux-netfilter'
</I>&gt;&gt;<i> &gt;&gt; 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2 -fPIE
</I>&gt;&gt;<i> &gt;&gt; -fstack-protector-strong -Wformat -Werror=format-security -Wall'
</I>&gt;&gt;<i> &gt;&gt; 'LDFLAGS=-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now'
</I>&gt;&gt;<i> &gt;&gt; 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE
</I>&gt;&gt;<i> &gt;&gt; -fstack-protector-strong -Wformat -Werror=format-security'
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Following is my squid.conf file:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; acl SSL_ports port 443
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 80 # http
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 21 # ftp
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 443 # https
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 70 # gopher
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 210 # wais
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 280 # http-mgmt
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 488 # gss-http
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 591 # filemaker
</I>&gt;&gt;<i> &gt;&gt; acl Safe_ports port 777 # multiling http
</I>&gt;&gt;<i> &gt;&gt; acl CONNECT method CONNECT
</I>&gt;&gt;<i> &gt;&gt; acl step1 at_step SslBump1
</I>&gt;&gt;<i> &gt;&gt; http_access deny !Safe_ports
</I>&gt;&gt;<i> &gt;&gt; http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> &gt;&gt; http_access allow localhost manager
</I>&gt;&gt;<i> &gt;&gt; http_access deny manager
</I>&gt;&gt;<i> &gt;&gt; http_access allow localhost
</I>&gt;&gt;<i> &gt;&gt; http_access allow all
</I>&gt;&gt;<i> &gt;&gt; http_port 3128 ssl-bump \
</I>&gt;&gt;<i> &gt;&gt;   cert=/etc/squid/ssl_cert/squidCA.pem \
</I>&gt;&gt;<i> &gt;&gt;   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> &gt;&gt; https_port 3129 intercept ssl-bump generate-host-certificates=on \
</I>&gt;&gt;<i> &gt;&gt; dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/squidCA.pem \
</I>&gt;&gt;<i> &gt;&gt; dhparams=/etc/squid/ssl_cert/dhparam.pem
</I>&gt;&gt;<i> &gt;&gt; sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i> &gt;&gt; sslproxy_cipher
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;&gt;<i> &gt;&gt; sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/spool/squid3_ssldb -M
</I>&gt;&gt;<i> &gt;&gt; 4MB
</I>&gt;&gt;<i> &gt;&gt; debug_options ALL,1 3,5 4,5 11,5 17,5 23,5 46,5 78,5 rotate=1
</I>&gt;&gt;<i> &gt;&gt; coredump_dir /var/spool/squid
</I>&gt;&gt;<i> &gt;&gt; refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;&gt;<i> &gt;&gt; refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;&gt;<i> &gt;&gt; refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;&gt;<i> &gt;&gt; refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;&gt;<i> &gt;&gt; refresh_pattern . 0 20% 4320
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I get no errors while starting Squid. Following are the logs when Squid
</I>&gt;&gt;<i> &gt;&gt; starts:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| Set Current Directory to /var/spool/squid
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| Starting Squid Cache version 3.5.12 for
</I>&gt;&gt;<i> &gt;&gt; x86_64-pc-linux-gnu...
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| Service Name: squid
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| Process ID 26236
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| Process Roles: worker
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| With 65535 file descriptors available
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53 kid1| Initializing IP Cache...
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| 78,2| dns_internal.cc(1525) dnsInit:
</I>&gt;&gt;<i> &gt;&gt; idnsInit: attempt open DNS socket to: [::]
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| 78,2| dns_internal.cc(1534) dnsInit:
</I>&gt;&gt;<i> &gt;&gt; idnsInit: attempt open DNS socket to: 0.0.0.0
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| DNS Socket created at [::], FD 6
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| DNS Socket created at 0.0.0.0, FD 7
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| Adding nameserver 172.31.0.2 from
</I>&gt;&gt;<i> &gt;&gt; /etc/resolv.conf
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| 78,3| dns_internal.cc(321)
</I>&gt;&gt;<i> &gt;&gt; idnsAddNameserver: idnsAddNameserver: Added nameserver #0
</I>&gt;&gt;<i> &gt;&gt; (172.31.0.2:53)
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| Adding domain
</I>&gt;&gt;<i> &gt;&gt; ap-south-1.compute.internal from /etc/resolv.conf
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| 78,3| dns_internal.cc(350)
</I>&gt;&gt;<i> &gt;&gt; idnsAddPathComponent: idnsAddPathComponent: Added domain #0:
</I>&gt;&gt;<i> &gt;&gt; ap-south-1.compute.internal
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.756 kid1| helperOpenServers: Starting 5/32
</I>&gt;&gt;<i> &gt;&gt; 'ssl_crtd' processes
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,2| Format.cc(64) parse: got
</I>&gt;&gt;<i> &gt;&gt; definition '%&gt;a/%&gt;A %un %&gt;rm myip=%la myport=%lp'
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 1C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 1C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,2| Format.cc(64) parse: got
</I>&gt;&gt;<i> &gt;&gt; definition '%&gt;a/%&gt;A %un %&gt;rm myip=%la myport=%lp'
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 1C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(389) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 1C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(380) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible Misc token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| 46,5| Token.cc(384) parse: scan for
</I>&gt;&gt;<i> &gt;&gt; possible 2C token
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| Logfile: opening log
</I>&gt;&gt;<i> &gt;&gt; daemon:/var/log/squid/access.log
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.775 kid1| Logfile Daemon: opening log
</I>&gt;&gt;<i> &gt;&gt; /var/log/squid/access.log
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| 23,5| url.cc(43) urlInitialize:
</I>&gt;&gt;<i> &gt;&gt; urlInitialize: Initializing...
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Local cache digest enabled;
</I>&gt;&gt;<i> &gt;&gt; rebuild/rewrite every 3600/3600 sec
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Store logging disabled
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Swap maxSize 0 + 262144 KB, estimated
</I>&gt;&gt;<i> &gt;&gt; 20164 objects
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Target number of buckets: 1008
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Using 8192 Store buckets
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Max Mem  size: 262144 KB
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Max Swap size: 0 KB
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Using Least Load store dir selection
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.779 kid1| Set Current Directory to /var/spool/squid
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.785 kid1| 23,3| url.cc(357) urlParse: urlParse:
</I>&gt;&gt;<i> &gt;&gt; Split URL
</I>&gt;&gt;<i> &gt;&gt; '<A HREF="http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/image.png">http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/image.png</A>'
</I>&gt;&gt;<i> &gt;&gt; into proto='http', host='ip-172-31-25-235', port='3128',
</I>&gt;&gt;<i> &gt;&gt; path='/squid-internal-static/icons/silk/image.png'
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.785 kid1| 23,3| url.cc(357) urlParse: urlParse:
</I>&gt;&gt;<i> &gt;&gt; Split URL
</I>&gt;&gt;<i> &gt;&gt; '<A HREF="http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/page_white_text.png">http://ip-172-31-25-235:3128/squid-internal-static/icons/silk/page_white_text.png</A>'
</I>&gt;&gt;<i> &gt;&gt; into proto='http', host='ip-172-31-25-235', port='3128',
</I>&gt;&gt;<i> &gt;&gt; path='/squid-internal-static/icons/silk/page_white_text.png'
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; ****several urlParse logs like above. Removing them to shorten the
</I>&gt;&gt;<i> &gt;&gt; email. Further logs below...****
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| Finished loading MIME types and icons.
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| HTCP Disabled.
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| Pinger socket opened on FD 25
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| Squid plugin modules loaded: 0
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| Adaptation support is off.
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| Accepting SSL bumped HTTP Socket
</I>&gt;&gt;<i> &gt;&gt; connections at local=[::]:3128 remote=[::] FD 22 flags=9
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53.815 kid1| Accepting NAT intercepted SSL bumped
</I>&gt;&gt;<i> &gt;&gt; HTTPS Socket connections at local=[::]:3129 remote=[::] FD 23 flags=41
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53| pinger: Initialising ICMP pinger ...
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53| pinger: ICMP socket opened.
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:53| pinger: ICMPv6 socket opened
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 09:59:54 kid1| storeLateRelease: released 0 objects
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I tested this setup by providing proxy details to Firefox. Firefox was
</I>&gt;&gt;<i> &gt;&gt; able to show HTTP websites but when I tried to open an HTTPS website I
</I>&gt;&gt;<i> &gt;&gt; got following error:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 11:00:50 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;&gt;<i> &gt;&gt; local=172.31.25.235:3129 remote=182.72.78.122:50655 FD 7 flags=33:
</I>&gt;&gt;<i> &gt;&gt; (92) Protocol not available
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 11:00:50 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> &gt;&gt; original IPs on local=172.31.25.235:3129 remote=182.72.78.122:50655 FD
</I>&gt;&gt;<i> &gt;&gt; 7 flags=33
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 11:00:50 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;&gt;<i> &gt;&gt; local=172.31.25.235:3129 remote=182.72.78.122:50656 FD 7 flags=33:
</I>&gt;&gt;<i> &gt;&gt; (92) Protocol not available
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 11:00:50 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> &gt;&gt; original IPs on local=172.31.25.235:3129 remote=182.72.78.122:50656 FD
</I>&gt;&gt;<i> &gt;&gt; 7 flags=33
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 11:00:50 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;&gt;<i> &gt;&gt; local=172.31.25.235:3129 remote=182.72.78.122:50657 FD 7 flags=33:
</I>&gt;&gt;<i> &gt;&gt; (92) Protocol not available
</I>&gt;&gt;<i> &gt;&gt; 2017/02/23 11:00:50 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;&gt;<i> &gt;&gt; original IPs on local=172.31.25.235:3129 remote=182.72.78.122:50657 FD
</I>&gt;&gt;<i> &gt;&gt; 7 flags=33
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I googled this error and found this mail thread which had similar
</I>&gt;&gt;<i> &gt;&gt; problems:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/NAT-TPROXY-lookup-failed-to-locate-original-IPs-td4675464.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/NAT-TPROXY-lookup-failed-to-locate-original-IPs-td4675464.html</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I found this link from the above thread. I modified the steps for
</I>&gt;&gt;<i> &gt;&gt; HTTPS from the below link:
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Now my sysctl.conf is:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; net.ipv4.conf.all.rp_filter=0
</I>&gt;&gt;<i> &gt;&gt; net.ipv4.ip_forward = 1
</I>&gt;&gt;<i> &gt;&gt; net.ipv4.conf.default.rp_filter = 0
</I>&gt;&gt;<i> &gt;&gt; net.ipv4.conf.default.accept_source_route = 0
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; My iptables -t nat -L result:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Chain PREROUTING (policy ACCEPT)
</I>&gt;&gt;<i> &gt;&gt; target     prot opt source               destination
</I>&gt;&gt;<i> &gt;&gt; ACCEPT     tcp  --  ec2-35-154-101-8.ap-south-1.compute.amazonaws.com
</I>&gt;&gt;<i> &gt;&gt; anywhere             tcp dpt:https
</I>&gt;&gt;<i> &gt;&gt; DNAT       tcp  --  anywhere             anywhere             tcp
</I>&gt;&gt;<i> &gt;&gt; dpt:https to:35.154.101.8:3129
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Chain INPUT (policy ACCEPT)
</I>&gt;&gt;<i> &gt;&gt; target     prot opt source               destination
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Chain OUTPUT (policy ACCEPT)
</I>&gt;&gt;<i> &gt;&gt; target     prot opt source               destination
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Chain POSTROUTING (policy ACCEPT)
</I>&gt;&gt;<i> &gt;&gt; target     prot opt source               destination
</I>&gt;&gt;<i> &gt;&gt; MASQUERADE  all  --  anywhere             anywhere
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Once this was done, I tried to hit HTTPS website from Firefox and now
</I>&gt;&gt;<i> &gt;&gt; I get connection timeout error. Nothing shows in syslog, access.log or
</I>&gt;&gt;<i> &gt;&gt; cache.log. Could you please help me resolve this.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Thanks,
</I>&gt;&gt;<i> &gt;&gt; Michael
</I>&gt;&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;&gt;<i> &gt;&gt; squid-users mailing list
</I>&gt;&gt;<i> &gt;&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Thanks for replying Eliezer. Following are the outputs you asked:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 1. iptables-save:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; # Generated by iptables-save v1.6.0 on Sun Feb 26 06:28:46 2017
</I>&gt;&gt;<i> &gt; *filter
</I>&gt;&gt;<i> &gt; :INPUT ACCEPT [171:12090]
</I>&gt;&gt;<i> &gt; :FORWARD ACCEPT [0:0]
</I>&gt;&gt;<i> &gt; :OUTPUT ACCEPT [106:15187]
</I>&gt;&gt;<i> &gt; COMMIT
</I>&gt;&gt;<i> &gt; # Completed on Sun Feb 26 06:28:46 2017
</I>&gt;&gt;<i> &gt; # Generated by iptables-save v1.6.0 on Sun Feb 26 06:28:46 2017
</I>&gt;&gt;<i> &gt; *mangle
</I>&gt;&gt;<i> &gt; :PREROUTING ACCEPT [89003:74850371]
</I>&gt;&gt;<i> &gt; :INPUT ACCEPT [88973:74849159]
</I>&gt;&gt;<i> &gt; :FORWARD ACCEPT [30:1212]
</I>&gt;&gt;<i> &gt; :OUTPUT ACCEPT [76710:51478183]
</I>&gt;&gt;<i> &gt; :POSTROUTING ACCEPT [76740:51479395]
</I>&gt;&gt;<i> &gt; -A PREROUTING -p tcp -m tcp --dport 3129 -j DROP
</I>&gt;&gt;<i> &gt; COMMIT
</I>&gt;&gt;<i> &gt; # Completed on Sun Feb 26 06:28:46 2017
</I>&gt;&gt;<i> &gt; # Generated by iptables-save v1.6.0 on Sun Feb 26 06:28:46 2017
</I>&gt;&gt;<i> &gt; *nat
</I>&gt;&gt;<i> &gt; :PREROUTING ACCEPT [7766:436942]
</I>&gt;&gt;<i> &gt; :INPUT ACCEPT [7766:436942]
</I>&gt;&gt;<i> &gt; :OUTPUT ACCEPT [952:102330]
</I>&gt;&gt;<i> &gt; :POSTROUTING ACCEPT [0:0]
</I>&gt;&gt;<i> &gt; -A PREROUTING -s 35.154.101.8/32 -p tcp -m tcp --dport 443 -j ACCEPT
</I>&gt;&gt;<i> &gt; -A PREROUTING -p tcp -m tcp --dport 443 -j DNAT --to-destination
</I>&gt;&gt;<i> &gt; 35.154.101.8:3129
</I>&gt;&gt;<i> &gt; -A POSTROUTING -j MASQUERADE
</I>&gt;&gt;<i> &gt; COMMIT
</I>&gt;&gt;<i> &gt; # Completed on Sun Feb 26 06:28:46 2017
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; 2. Also pasting sudo iptables -L -nv:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Chain INPUT (policy ACCEPT 216 packets, 16058 bytes)
</I>&gt;&gt;<i> &gt;  pkts bytes target     prot opt in     out     source
</I>&gt;&gt;<i> &gt; destination
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
</I>&gt;&gt;<i> &gt;  pkts bytes target     prot opt in     out     source
</I>&gt;&gt;<i> &gt; destination
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Chain OUTPUT (policy ACCEPT 161 packets, 24629 bytes)
</I>&gt;&gt;<i> &gt;  pkts bytes target     prot opt in     out     source
</I>&gt;&gt;<i> &gt; destination
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; And then clear out where is this proxy sittings and the network
</I>&gt;&gt;<i> &gt;&gt; structure.
</I>&gt;&gt;<i> &gt;&gt; It's not clear if the squid box is the router or a machine somewhere on
</I>&gt;&gt;<i> &gt;&gt; AWS.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; [Michael] This proxy is installed on an AWS instance.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; If you wish to pass traffic from a local router to a one on AWS you
</I>&gt;&gt;<i> &gt;&gt; will need to create a tunnel like using OpenVPN or a similar solution and to
</I>&gt;&gt;<i> &gt;&gt; use some routing rules to pass the traffic from the local LAN to AWS without
</I>&gt;&gt;<i> &gt;&gt; removing the original destination address.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; [Michael] Does this mean, to make ssl-bump work, I will have to setup
</I>&gt;&gt;<i> &gt; a VPN server and configure the VPN clients to use this proxy via VPN
</I>&gt;&gt;<i> &gt; server?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Thanks,
</I>&gt;&gt;<i> &gt; Michael.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; squid-users mailing list
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for replying Eliezer. Your advice is much appreciated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; The details you attached explained pretty well the cause for the issues
</I>&gt;&gt;<i> &gt; you have described.
</I>&gt;&gt;<i> &gt; What you will need to do in order to make this setup to work can be done
</I>&gt;&gt;<i> &gt; in more then one way.
</I>&gt;&gt;<i> &gt; For a sysadmin the simplest way is to create a VPN or some kind of a
</I>&gt;&gt;<i> &gt; tunnel between the AWS instance to the local router.
</I>&gt;&gt;<i> &gt; I am almost sure that you can use haproxy to do a local tproxy or
</I>&gt;&gt;<i> &gt; interception that will forward the traffic to the remote squid with the
</I>&gt;&gt;<i> &gt; PROXY protocol keeping original source and original destination visible to
</I>&gt;&gt;<i> &gt; the remote squid.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The choice will depend on both:
</I>&gt;&gt;<i> &gt; - your skills and will to dig some time about couple subjects
</I>&gt;&gt;<i> &gt; - The availability of static IP addresses(both local and AWS).
</I>&gt;&gt;<i> &gt; - The OS on both sides
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [Michael] Actually, my original setup involves a VPN server. I wasn't
</I>&gt;&gt;<i> using it because I wanted to setup ssl-bump with simplest possible
</I>&gt;&gt;<i> settings. My actual setup involves:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. strongSwan IPSec VPN server
</I>&gt;&gt;<i> 2. Squid Proxy server
</I>&gt;&gt;<i> 3. Clients will be IPSec VPN clients. I can specify the IP address and
</I>&gt;&gt;<i> port of HTTPS Proxy server in IPSec VPN client itself.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In the above setup described, will I have to do something extra to
</I>&gt;&gt;<i> make ssl-bump work?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Michael.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What is the benefit of ssl-bump in this scenario?
</I>
Using ssl-bump, I will be able to filter HTTPS traffic based on either
HTTPS URL or content.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Best regards,
</I>&gt;<i> Odhiambo WASHINGTON,
</I>&gt;<i> Nairobi,KE
</I>&gt;<i> +254 7 3200 0004/+254 7 2274 3223
</I>&gt;<i> &quot;Oh, the cruft.&quot;
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014529.html">[squid-users] SSL-Bump: NAT/TPROXY lookup failed to locate original IPs
</A></li>
	<LI>Next message (by thread): <A HREF="014509.html">[squid-users] My Squid stop working WITHOUT any reason.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14530">[ date ]</a>
              <a href="thread.html#14530">[ thread ]</a>
              <a href="subject.html#14530">[ subject ]</a>
              <a href="author.html#14530">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
