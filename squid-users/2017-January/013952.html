<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.22%20Bug%20when%20using%20Mimetype%20Detection%3F%0A%09rep_mime_type&In-Reply-To=%3C65faf969c6c36b178491b5f319db2e40%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013948.html">
   <LINK REL="Next"  HREF="014021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.22%20Bug%20when%20using%20Mimetype%20Detection%3F%0A%09rep_mime_type&In-Reply-To=%3C65faf969c6c36b178491b5f319db2e40%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan  3 08:07:57 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013948.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type
</A></li>
        <LI>Next message (by thread): <A HREF="014021.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13952">[ date ]</a>
              <a href="thread.html#13952">[ thread ]</a>
              <a href="subject.html#13952">[ subject ]</a>
              <a href="author.html#13952">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2017-01-03 07:33, Flashdown wrote:
&gt;<i> Hello together,
</I>&gt;<i> 
</I>&gt;<i> with Squid 3.5.22 I have switched from using a url-regex to Mime Type
</I>&gt;<i> Detection, which seemed to work nicely until now... :/
</I>&gt;<i> 
</I>
The thing to be very wary of with this change is that when reply 
blocking the request does still make it through to the server and any 
processing done there still happens.

With things like ticketing systems that means the tickets and any auth 
related token creating has actually happened, even if the client is 
prevented from being told what the created token was.

That is a major difference from URL based blocking, which would reject 
before any server contact.


&gt;<i> OS: Debian Stretch 4.8.0-1-amd64 #1 SMP Debian 4.8.7-1 (2016-11-13)
</I>&gt;<i> x86_64 GNU/Linux
</I>&gt;<i> 
</I>

I really advise going to 3.5.23. Several major issues about sending 
wrong replies on certain occasions were fixed there. New .deb should be 
available by now to fix that.



&gt;<i> I faced the following Situation:
</I>&gt;<i> 
</I>&gt;<i> When I globally deny specific mimetypes using a blockfile, then it
</I>&gt;<i> performs as it should, so only mime types I defined in the block file
</I>&gt;<i> are getting blocked, so far so good.
</I>&gt;<i> 
</I>&gt;<i> When I do an exception for a group I belong to like unblocking
</I>&gt;<i> application/octet-stream, then I can download files, so the exception
</I>&gt;<i> works in the first place.
</I>&gt;<i> acl mime_IT rep_mime_type application/octet-stream
</I>&gt;<i> http_reply_access allow IT mime_IT
</I>&gt;<i> 
</I>&gt;<i> Normally internal targets are excluded from the Proxy using Proxy
</I>&gt;<i> Exception lists. But I do not get these settings automatically, so my
</I>&gt;<i> browser did not contain this exception so I was able to discover the
</I>&gt;<i> following behavior:
</I>&gt;<i> 
</I>&gt;<i> The Issue is occuring when browsing to an internal OTRS Web Server via
</I>&gt;<i> FQDN (It's a web ticket system) through the proxy I get &quot;Access
</I>&gt;<i> Denied&quot; from the Proxy on all requests. But when browsing to an online
</I>&gt;<i> OTRS Demo site with the same OTRS version like this one:
</I>&gt;<i> <A HREF="http://itsm-demo.otrs.com/otrs/index.pl">http://itsm-demo.otrs.com/otrs/index.pl</A> then it works. When I now try
</I>&gt;<i> again to access the internal OTRS Server through the proxy it works.
</I>&gt;<i> That's strange, when I now force reload (CTRL+F5 in Firefox) the
</I>&gt;<i> internal OTRS Ticketsystems webpage, I get the &quot;access denied&quot; again.
</I>&gt;<i> 
</I>
How is the auth happening between the users and the proxy to find out 
what the groups are?
  The reply checks may be interferring with the auth replies.


&gt;<i> When I remove the exception from the global block list for the group I
</I>&gt;<i> belong to,- here it's IT- then this issue does not occur and the
</I>&gt;<i> website is accessible like it should.
</I>&gt;<i> So I just need to comment out these lines:
</I>&gt;<i> #acl mime_IT rep_mime_type application/octet-stream
</I>&gt;<i> #http_reply_access allow IT mime_IT
</I>&gt;<i> 
</I>&gt;<i> When I add text/html &amp; application/xml to the global block exception,
</I>&gt;<i> then this error does not occur anymore.
</I>&gt;<i> acl mime_IT rep_mime_type application/octet-stream text/html 
</I>&gt;<i> application/xml
</I>&gt;<i> http_reply_access allow IT mime_IT
</I>&gt;<i> 
</I>&gt;<i> So currently I can workaround the issue in 3 different ways:
</I>&gt;<i> 1. Do not create a global mimetype block exception for groups I belong 
</I>&gt;<i> to
</I>&gt;<i> 2. Browse to the start page of an Online Demo OTRS Site and then
</I>&gt;<i> reload the internal Website
</I>&gt;<i> 3. Add text/html &amp; application/xml to my exception even if these
</I>&gt;<i> Mimetypes are not part of the global block list, so they are not
</I>&gt;<i> supposed to be blocked. (I just looked at the internal website and it
</I>&gt;<i> just uses text/html and application/xml on the start page (Login Page)
</I>&gt;<i> so I added them to the exception list for my group and it worked)
</I>&gt;<i> 
</I>&gt;<i> Conclusion: When having a global mime type block and unblocking a
</I>&gt;<i> specific mime type for a specific group, then this group will most
</I>&gt;<i> propably face issues with mime types that are not supposed to be
</I>&gt;<i> blocked. So in case of errors, I need to unblock not blocked mimetypes
</I>&gt;<i> ,too.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My Squid config for mime type blocking:
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> ## Define Default MIMETYPE ERROR Message and global block access list
</I>&gt;<i> acl block_mimetypes rep_mime_type &quot;/etc/squid/mimetype_blacklist.acl&quot;
</I>&gt;<i> deny_info ERR_BLOCKED_FILES block_mimetypes
</I>&gt;<i> 
</I>&gt;<i> # Configure Execptions
</I>&gt;<i> acl mime_IT rep_mime_type application/octet-stream
</I>&gt;<i> http_reply_access allow IT mime_IT
</I>&gt;<i> 
</I>&gt;<i> acl mime_SpecialGroup rep_mime_type application/octet-stream
</I>&gt;<i> http_reply_access allow SpecialGroup mime_SpecialGroup
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #Applying Global MimeType Block
</I>&gt;<i> http_reply_access deny block_mimetypes
</I>
Any other http_reply_access rules? the implicit-default behaviour may be 
having an effect if there are.


&gt;<i> ---------------------------------------
</I>&gt;<i> Squid main config:
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> http_port 8080 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=16MB cert=/*********************
</I>&gt;<i> ssl_bump splice localhost
</I>&gt;<i> ssl_bump splice SSL_Exclude
</I>
These splice rules may be related to the issue. Any connection that gets 
spliced may be used by other requests without squid being aware of them.

&gt;<i> ssl_bump bump all
</I>&gt;<i> sslproxy_cert_error allow SSL_TrustedSites
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Contents of mimetype_blacklist.acl:
</I>&gt;<i> ---------------------------------------
</I>
That looks okay to me, just remember that it is a regex pattern. So if a 
type entered there matches a sub-string it can block unexpectedly. That 
includes sub-strings in the type parameters.


&gt;<i> 1483381150.095    186 10.3.101.23 TCP_DENIED_REPLY/403 4493 GET
</I>&gt;<i> <A HREF="http://otrs-server.**.**.com/otrs/index.pl">http://otrs-server.**.**.com/otrs/index.pl</A> - HIER_DIRECT/10.2.1.107
</I>&gt;<i> text/html
</I>&gt;<i> 1483381150.118      3 10.3.101.23 TCP_DENIED_REPLY/403 4451 GET
</I>&gt;<i> <A HREF="http://*****-proxy.**.**.com:8080/squid-internal-static/icons/SN.png">http://*****-proxy.**.**.com:8080/squid-internal-static/icons/SN.png</A> -
</I>&gt;<i> HIER_NONE/- text/html
</I>
FWIW: the text/html is the type of the HTML error page being delivered 
for the 403 response. The content-type for the original response payload 
which was blocked is not logged.

You can debug with &quot;debug_options 11,2&quot; to get a cache.log trace of what 
messages are happening and what the original server response headers 
were.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013948.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type
</A></li>
	<LI>Next message (by thread): <A HREF="014021.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13952">[ date ]</a>
              <a href="thread.html#13952">[ thread ]</a>
              <a href="subject.html#13952">[ subject ]</a>
              <a href="author.html#13952">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
