<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Websocket Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Websocket%20Issue&In-Reply-To=%3C62f2172bf3a18cc1f2effca6744ba3ce%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013949.html">
   <LINK REL="Next"  HREF="013950.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Websocket Issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Websocket%20Issue&In-Reply-To=%3C62f2172bf3a18cc1f2effca6744ba3ce%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Websocket Issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan  3 08:47:14 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013949.html">[squid-users] Squid Websocket Issue
</A></li>
        <LI>Next message (by thread): <A HREF="013950.html">[squid-users] Squid Websocket Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13953">[ date ]</a>
              <a href="thread.html#13953">[ thread ]</a>
              <a href="subject.html#13953">[ subject ]</a>
              <a href="author.html#13953">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2017-01-03 05:49, Hardik Dangar wrote:
&gt;<i> Hey Eliezer,
</I>&gt;<i> 
</I>&gt;<i> The issue was with whatsapp web socket was not working, here is
</I>&gt;<i> detailed information about issue
</I>&gt;<i> ------------
</I>&gt;<i> 
</I>&gt;<i> Here is some information about my squid version,
</I>&gt;<i> 
</I>&gt;<i> Squid Cache: Version 3.5.22-20161115-r14113
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:  '--prefix=/usr' '--localstatedir=/var/squid'
</I>&gt;<i> '--libexecdir=/lib/squid' '--srcdir=.' '--datadir=/share/squid'
</I>&gt;<i> '--sysconfdir=/etc/squid' '--with-default-user=proxy'
</I>&gt;<i> '--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid'
</I>&gt;<i> '--with-openssl' '--enable-ssl-crtd' '--enable-inline'
</I>&gt;<i> '--disable-arch-native' '--enable-async-io=8'
</I>&gt;<i> '--enable-storeio=ufs,aufs,diskd,rock'
</I>&gt;<i> '--enable-removal-policies=lru,heap' '--enable-delay-pools'
</I>&gt;<i> '--enable-follow-x-forwarded-for' '--enable-url-rewrite-helpers=fake'
</I>&gt;<i> '--enable-ecap'
</I>&gt;<i> 
</I>&gt;<i> My squid config file is located at, <A HREF="http://pastebin.com/raw/LvDxEF4x">http://pastebin.com/raw/LvDxEF4x</A>
</I>&gt;<i> 
</I>&gt;<i> Now the issue is whenever someone requests a page which contains web
</I>&gt;<i> socket requests response is always bad request.
</I>&gt;<i> Here is an example,
</I>&gt;<i> 
</I>&gt;<i> Request URL:<A HREF="wss://w4.web.whatsapp.com/ws">wss://w4.web.whatsapp.com/ws</A> [1]
</I>&gt;<i> Request Method:GET
</I>&gt;<i> Status Code:400 Bad Request
</I>&gt;<i> 
</I>&gt;<i> Response Headers
</I>&gt;<i> #################
</I>&gt;<i> Connection:keep-alive
</I>&gt;<i> Date:Sat, 17 Dec 2016 09:05:36 GMT
</I>&gt;<i> Transfer-Encoding:chunked
</I>&gt;<i> X-Cache:MISS from Proxy
</I>&gt;<i> 
</I>&gt;<i> Request Headers
</I>&gt;<i> #################
</I>&gt;<i> Accept-Encoding:gzip, deflate, sdch, br
</I>&gt;<i> Accept-Language:en-US,en;q=0.8
</I>&gt;<i> Cache-Control:no-cache
</I>&gt;<i> Connection:Upgrade
</I>&gt;<i> Host:w4.web.whatsapp.com [2]
</I>&gt;<i> Origin:<A HREF="https://web.whatsapp.com">https://web.whatsapp.com</A>
</I>&gt;<i> Pragma:no-cache
</I>&gt;<i> Sec-WebSocket-Extensions:permessage-deflate; client_max_window_bits
</I>&gt;<i> Sec-WebSocket-Key:kzrB2ZcMHDAqvjDNXnjL/w==
</I>&gt;<i> Sec-WebSocket-Version:13
</I>&gt;<i> Upgrade:websocket
</I>&gt;<i> User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML,
</I>&gt;<i> like Gecko) Chrome/55.0.2883.75 Safari/537.36
</I>&gt;<i> 
</I>&gt;<i> My question is how we can work with web socket requests in squid or if
</I>&gt;<i> not by pass them squid. My squid instance is in interception mode and
</I>&gt;<i> requests are intercepted at instance via iptables and forwarded to
</I>&gt;<i> squid using below rules,
</I>
WebSockets has several ways to initiate connections:

1) native WebSocket port
  - requires any intermediary has native Websocket support

2) CONNECT tunnel (maybe with Upgrade)
  - requires only that the intermediary has HTTP CONNECT support

3) GET request with Upgrade
  - requires that the intermediary has both HTTP Upgrade and WebSockets 
native support


Squid supports method #2.

The transaction you are showing as broken is mechanism #3. Both the 
Upgrade and WebSockets support requirements are not existing in Squid.

That particular request going through a non-WebSockets proxy is supposed 
to be passed to the server as a regular GET request (without Upgrade). 
Exactly what Squid does. The server itself is producing the 400 response 
instead of using alternative things like HTTP long-polling in place of 
WebSockets. That is its choice, nothing to do with Squid and a perfectly 
valid choice on the servers part.

If WhatsApp tried the supported #2 mechanism it would work through 
Squid.


&gt;<i> 
</I>&gt;<i> ----------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> SOLUTION TO ABOVE PROBLEM WAS,
</I>&gt;<i> 
</I>
... to splice instead of bump.

&gt;<i> 
</I>&gt;<i> So basically websockets are connected as normal https request( i think
</I>&gt;<i> this is a very nature of Web sockets and define somewhere in web
</I>&gt;<i> socket standards).
</I>
No, that is the nature of HTTPS when not being bump'ed. Squid is not 
involved in the encrypted request when splicing. So it does not matter 
if it really is HTTPS or actually encrypted WebSockets.

The HTTPS goes through Squid as a CONNECT tunnel. Which for WebSockets 
is connection method #2 above - which is supported and works.


I think your problem is that you are expecting unrealistic things from 
decrypted HTTPS. *HTTPS* being the critical word there. Bumping decrypts 
HTTPS, it does not decrypt other protocols - including WebSockets.

Since the WhatsApp traffic is/was intercepted the client software has no 
knowledge of the proxy existing so it is not realistic to expect it to 
attempt the CONNECT method, even as a failover.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013949.html">[squid-users] Squid Websocket Issue
</A></li>
	<LI>Next message (by thread): <A HREF="013950.html">[squid-users] Squid Websocket Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13953">[ date ]</a>
              <a href="thread.html#13953">[ thread ]</a>
              <a href="subject.html#13953">[ subject ]</a>
              <a href="author.html#13953">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
