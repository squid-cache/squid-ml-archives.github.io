<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Intercept mode failing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intercept%20mode%20failing&In-Reply-To=%3C7b1625ee1afa6f7572724198d3c4d28e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013962.html">
   <LINK REL="Next"  HREF="013970.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Intercept mode failing</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intercept%20mode%20failing&In-Reply-To=%3C7b1625ee1afa6f7572724198d3c4d28e%40treenet.co.nz%3E"
       TITLE="[squid-users] Intercept mode failing">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan  3 11:39:38 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013962.html">[squid-users] Intercept mode failing
</A></li>
        <LI>Next message (by thread): <A HREF="013970.html">[squid-users] Intercept mode failing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13966">[ date ]</a>
              <a href="thread.html#13966">[ thread ]</a>
              <a href="subject.html#13966">[ subject ]</a>
              <a href="author.html#13966">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2017-01-03 23:53, Hoggins! wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> (answering to both Amos and Antony here, you got the same questioning 
</I>&gt;<i> ;) )
</I>&gt;<i> 
</I>&gt;<i> Le 03/01/2017 &#224; 11:45, Amos Jeffries a &#233;crit :
</I>&gt;&gt;<i> On 2017-01-03 23:13, Hoggins! wrote:
</I>&gt;&gt;&gt;<i> Okay, I get that.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Le 03/01/2017 &#224; 10:33, Antony Stone a &#233;crit :
</I>&gt;&gt;&gt;&gt;<i> No - you must do the NAT (or REDIRECT) rule *on the Squid server*.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Well, my Squid server is not on the same network as my clients, so I
</I>&gt;&gt;&gt;<i> need something else than just a REDIRECT on the Squid itself.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> That does not matter when the DNAT or REDIRECT is done on the Squid
</I>&gt;&gt;<i> machine.
</I>&gt;<i> 
</I>&gt;<i> OK, I'll have a deeper look into that, indeed I'm not familiar with 
</I>&gt;<i> what
</I>&gt;<i> REDIRECT *exactly* does.
</I>&gt;<i> 
</I>
It does the same as DNAT, but using the machines &quot;primary&quot; IP address 
instead of one you configure. Usually that means the first IP assigned 
to eth0 or equivalent first interface.

DNAT is best if you want a specific fixed IP:port for Squid to receive 
on.

REDIRECT is best if you want the proxy to be plug-n-play on any network. 
squid.conf and iptables not needing IP address, just a port number.


&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> If you need to use policy routing to get the packets to the Squid
</I>&gt;&gt;&gt;&gt;<i> machine in
</I>&gt;&gt;&gt;&gt;<i> the first place, that's okay, but this *must* be packet routing, not
</I>&gt;&gt;&gt;&gt;<i> address
</I>&gt;&gt;&gt;&gt;<i> translation
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Policy routing was my first choice, but there is one important detail 
</I>&gt;&gt;&gt;<i> in
</I>&gt;&gt;&gt;<i> my setup : between my gateway (192.168.22.10) and my Squid
</I>&gt;&gt;&gt;<i> (192.168.55.3), there's an IPSec tunnel. My gateway does not have a
</I>&gt;&gt;&gt;<i> link-local route to 192.168.55.3 so I can't add the default route to 
</I>&gt;&gt;&gt;<i> it
</I>&gt;&gt;&gt;<i> inside a routing table (I get &quot;Network is unreachable&quot;, which is
</I>&gt;&gt;&gt;<i> expected).
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> So I guess I'm stuck.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> So how did the packets get to the Squid machine after your DNAT ?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The route does not have to be link-local. Any type of route will do so
</I>&gt;&gt;<i> long as all the routers handling the packets know which way to pass
</I>&gt;&gt;<i> them, and the dst-IP address is not changed.
</I>&gt;<i> 
</I>&gt;<i> Well, xfrm routing is a lot different than &quot;classic&quot; routing, I learnt
</I>&gt;<i> it the hard way. DNAT *will* work whereas policy routing won't if I
</I>&gt;<i> don't explicitly declare all my subnets in my IPSec tunnel
</I>&gt;<i> configuration. Got a big discussion about that on StrongSwan's
</I>&gt;<i> mailing-list, and I believe this sums it up pretty nicely :
</I>&gt;<i> <A HREF="http://xkr47.outerspace.dyndns.org/netfilter/packet_flow/packet_flow9.png">http://xkr47.outerspace.dyndns.org/netfilter/packet_flow/packet_flow9.png</A>
</I>
Looks like a simplified version of the netfilter devs official diagram 
to me. So all the required decision points are present and should be 
configurable.

&gt;<i> 
</I>&gt;<i> Anyway, yes, if I try to add a route by :
</I>&gt;<i>     ip route add default via &lt;IP ADDRESS&gt; table 123
</I>&gt;<i> 
</I>&gt;<i> &lt;IP ADDRESS&gt; *has* to be directly reachable. Or it has to be in the
</I>&gt;<i> routing table somehow. But the routing table handling the tunnelled
</I>&gt;<i> packets is not managed by iproute2.
</I>
It should &quot;simply&quot; be one of the tables with a value other than &quot;123&quot;. 
But that should not be a consideration as editing it is not necessary. 
This &quot;123&quot; routing is only relevant *before* packets enter the tunnel, 
since it is what tells the OS to send packets to the tunnel.

IIRC the routing table for HTTP traffic (your '123' table) should 
indicate the tunnel as the gateway &lt;IP ADDRESS&gt;. I don't recall whether 
that gw was needing to be the local or the remote tunnel endpoint though 
sorry, been too long since I set one of these up.

&gt;<i> 
</I>&gt;<i> So as I can't do otherwise, I'm going to experiment a bit more with the
</I>&gt;<i> REDIRECT + DNAT between the gateway and the Squid server.
</I>&gt;<i> 
</I>
I think you are misinterpreting that diagram in regards to the policy 
routing setup.

What we have on the squid wiki on &quot;Policy Routing&quot; makes packets follow 
this path;

  * the PREROUTING &quot;mangle&quot; table sets marks on packets to be delivered 
to Squid.

  * those packets go through the &quot;FORWARD&quot; to that gateway in 
'123'/'proxy' table.
   (in our wiki that is the &quot;ip rule add fwmark 2 table ...&quot; part).

  * after POSTROUTING the packets destined to a tunnel gateway are 
diverted at that last-minute decision point after &quot;QoS egress&quot; so they 
go back to &quot;OUTPUT&quot; which is where the tunnel related things are done to 
it.

Note that for the machine where the tunnel leads *from*, all that 
matters is routing the packets into the tunnel. Once packets are 
encapsulated by the tunnel they simply go through it to the other end. 
The receiving machine does whatever it needs to after the packets leave 
the tunnel.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013962.html">[squid-users] Intercept mode failing
</A></li>
	<LI>Next message (by thread): <A HREF="013970.html">[squid-users] Intercept mode failing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13966">[ date ]</a>
              <a href="thread.html#13966">[ thread ]</a>
              <a href="subject.html#13966">[ subject ]</a>
              <a href="author.html#13966">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
