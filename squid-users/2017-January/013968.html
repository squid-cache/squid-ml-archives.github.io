<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Intercept mode failing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intercept%20mode%20failing&In-Reply-To=%3C003801d265c0%24656d8c10%243048a430%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013973.html">
   <LINK REL="Next"  HREF="013969.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Intercept mode failing</H1>
    <B>Eliezer  Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intercept%20mode%20failing&In-Reply-To=%3C003801d265c0%24656d8c10%243048a430%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Intercept mode failing">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Jan  3 12:53:35 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013973.html">[squid-users] Intercept mode failing
</A></li>
        <LI>Next message (by thread): <A HREF="013969.html">[squid-users] Intercept mode failing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13968">[ date ]</a>
              <a href="thread.html#13968">[ thread ]</a>
              <a href="subject.html#13968">[ subject ]</a>
              <a href="author.html#13968">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

There is also another option.
You can open a tunnel (IPIP, GRE, OTHER) between the proxy and the router to make it possible to directly route traffic to the proxy.

If you need some help with it let me know.

Eliezer 

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Hoggins!
Sent: Tuesday, January 3, 2017 12:54 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Intercept mode failing

Hello,

(answering to both Amos and Antony here, you got the same questioning ;) )

Le 03/01/2017 &#224; 11:45, Amos Jeffries a &#233;crit :
&gt;<i> On 2017-01-03 23:13, Hoggins! wrote:
</I>&gt;&gt;<i> Okay, I get that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Le 03/01/2017 &#224; 10:33, Antony Stone a &#233;crit :
</I>&gt;&gt;&gt;<i> No - you must do the NAT (or REDIRECT) rule *on the Squid server*.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, my Squid server is not on the same network as my clients, so I 
</I>&gt;&gt;<i> need something else than just a REDIRECT on the Squid itself.
</I>&gt;<i>
</I>&gt;<i> That does not matter when the DNAT or REDIRECT is done on the Squid 
</I>&gt;<i> machine.
</I>
OK, I'll have a deeper look into that, indeed I'm not familiar with what REDIRECT *exactly* does.

&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If you need to use policy routing to get the packets to the Squid 
</I>&gt;&gt;&gt;<i> machine in the first place, that's okay, but this *must* be packet 
</I>&gt;&gt;&gt;<i> routing, not address translation
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Policy routing was my first choice, but there is one important detail 
</I>&gt;&gt;<i> in my setup : between my gateway (192.168.22.10) and my Squid 
</I>&gt;&gt;<i> (192.168.55.3), there's an IPSec tunnel. My gateway does not have a 
</I>&gt;&gt;<i> link-local route to 192.168.55.3 so I can't add the default route to 
</I>&gt;&gt;<i> it inside a routing table (I get &quot;Network is unreachable&quot;, which is 
</I>&gt;&gt;<i> expected).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So I guess I'm stuck.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So how did the packets get to the Squid machine after your DNAT ?
</I>&gt;<i>
</I>&gt;<i> The route does not have to be link-local. Any type of route will do so 
</I>&gt;<i> long as all the routers handling the packets know which way to pass 
</I>&gt;<i> them, and the dst-IP address is not changed.
</I>
Well, xfrm routing is a lot different than &quot;classic&quot; routing, I learnt it the hard way. DNAT *will* work whereas policy routing won't if I don't explicitly declare all my subnets in my IPSec tunnel configuration. Got a big discussion about that on StrongSwan's mailing-list, and I believe this sums it up pretty nicely :
<A HREF="http://xkr47.outerspace.dyndns.org/netfilter/packet_flow/packet_flow9.png">http://xkr47.outerspace.dyndns.org/netfilter/packet_flow/packet_flow9.png</A>

Anyway, yes, if I try to add a route by :
    ip route add default via &lt;IP ADDRESS&gt; table 123

&lt;IP ADDRESS&gt; *has* to be directly reachable. Or it has to be in the routing table somehow. But the routing table handling the tunnelled packets is not managed by iproute2.

So as I can't do otherwise, I'm going to experiment a bit more with the REDIRECT + DNAT between the gateway and the Squid server.

Thanks for your help !

&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013973.html">[squid-users] Intercept mode failing
</A></li>
	<LI>Next message (by thread): <A HREF="013969.html">[squid-users] Intercept mode failing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13968">[ date ]</a>
              <a href="thread.html#13968">[ thread ]</a>
              <a href="subject.html#13968">[ subject ]</a>
              <a href="author.html#13968">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
