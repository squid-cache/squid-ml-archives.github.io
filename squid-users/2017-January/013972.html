<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%09server%20name&In-Reply-To=%3C23AF2CA5-EEF8-4C56-84EC-FD800718D76B%40finito.me.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013978.html">
   <LINK REL="Next"  HREF="013974.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name</H1>
    <B>Mark Hoare</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%09server%20name&In-Reply-To=%3C23AF2CA5-EEF8-4C56-84EC-FD800718D76B%40finito.me.uk%3E"
       TITLE="[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name">mark_squid at finito.me.uk
       </A><BR>
    <I>Tue Jan  3 14:27:57 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013978.html">[squid-users] problem authentication ntlm with squid 3.5.21
</A></li>
        <LI>Next message (by thread): <A HREF="013974.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13972">[ date ]</a>
              <a href="thread.html#13972">[ thread ]</a>
              <a href="subject.html#13972">[ subject ]</a>
              <a href="author.html#13972">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry, should have included squid version details in original post:

Squid Cache: Version 3.5.20
Service Name: squid
configure options:  '--build=x86_64-redhat-linux-gnu' '--host=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr' '--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin' '--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include' '--libdir=/usr/lib64' '--libexecdir=/usr/libexec' '--sharedstatedir=/var/lib' '--mandir=/usr/share/man' '--infodir=/usr/share/info' '--disable-strict-error-checking' '--exec_prefix=/usr' '--libexecdir=/usr/lib64/squid' '--localstatedir=/var' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-logdir=$(localstatedir)/log/squid' '--with-pidfile=$(localstatedir)/run/squid.pid' '--disable-dependency-tracking' '--enable-eui' '--enable-follow-x-forwarded-for' '--enable-auth' '--enable-auth-basic=DB,LDAP,MSNT-multi-domain,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB,SMB_LM,getpwnam' '--enable-auth-ntlm=smb_lm,fake' '--enable-auth-digest=file,LDAP,eDirectory' '--enable-auth-negotiate=kerberos' '--enable-external-acl-helpers=file_userip,LDAP_group,time_quota,session,unix_group,wbinfo_group' '--enable-cache-digests' '--enable-cachemgr-hostname=localhost' '--enable-delay-pools' '--enable-epoll' '--enable-ident-lookups' '--enable-linux-netfilter' '--enable-removal-policies=heap,lru' '--enable-snmp' '--enable-ssl-crtd' '--enable-storeio=aufs,diskd,ufs' '--enable-wccpv2' '--enable-esi' '--enable-ecap' '--with-aio' '--with-default-user=squid' '--with-dl' '--with-openssl' '--with-pthreads' '--disable-arch-native' '--disable-icap-client' 'build_alias=x86_64-redhat-linux-gnu' 'host_alias=x86_64-redhat-linux-gnu' 'CFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic -fpie' 'LDFLAGS=-Wl,-z,relro  -pie -Wl,-z,relro -Wl,-z,now' 'CXXFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic -fpie' 'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig&#8217;

Cheers

Mark

&gt;<i> On 31 Dec 2016, at 14:37, Mark Hoare &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mark_squid at finito.me.uk</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I&#8217;m trying to setup policy based routing on a gateway device pointing at a remote squid server to do transparent HTTP &amp; HTTPS proxying with ssl_bump (peek &amp; splice)
</I>&gt;<i> 
</I>&gt;<i> After quite a bit of pain getting policy based routing working on the gateway and local port redirection on the squid server, everything appears to be working except the access log still refers to the destination IP address in the TCP_TUNNEL rather than the SNI/TLS server name.
</I>&gt;<i> 
</I>&gt;<i> By increasing the debug level I can see that the SNI/TLS details are definitely being obtained during the request processing but for some reason they are not ending up in the access log.
</I>&gt;<i> 
</I>&gt;<i> Extract from cache log:
</I>&gt;&gt;<i> 2016/12/31 14:18:01.966 kid1| 83,7| bio.cc(1110) parseV3Hello: Found server name: www.ssllabs.com
</I>&gt;&gt;<i> 2016/12/31 14:18:02.351 kid1| 83,5| support.cc(259) ssl_verify_cb: SSL Certificate signature OK: /C=US/ST=California/L=Redwood City/O=Qualys, Inc./CN=ssllabs.com
</I>&gt;&gt;<i> 2016/12/31 14:18:02.351 kid1| 83,4| support.cc(213) check_domain: Verifying server domain www.ssllabs.com to certificate name/subjectAltName ssllabs.com
</I>&gt;&gt;<i> 2016/12/31 14:18:02.351 kid1| 83,4| support.cc(213) check_domain: Verifying server domain www.ssllabs.com to certificate name/subjectAltName *.ssllabs.com
</I>&gt;&gt;<i> 2016/12/31 14:18:02.383 kid1| 83,5| PeerConnector.cc(307) serverCertificateVerified: HTTPS server CN: ssllabs.com bumped: local=&lt;squid IP removed&gt;:57790 remote=64.41.200.100:443 FD 14 flags=1
</I>&gt;<i> 
</I>&gt;<i> Extract from access log:
</I>&gt;&gt;<i> 1483193882.790    870 &lt;local ip removed&gt; TCP_TUNNEL/200 5620 CONNECT 64.41.200.100:443 - ORIGINAL_DST/64.41.200.100 -
</I>&gt;<i> 
</I>&gt;<i> From the output above I would have expected some of the server name info to get into the access log.
</I>&gt;<i> 
</I>&gt;<i> Squid config below:
</I>&gt;&gt;<i> debug_options ALL,7
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 3128
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> https_port 3130 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 3131 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> cache_dir ufs /var/spool/squid 200 16 256
</I>&gt;&gt;<i> coredump_dir /var/spool/squid
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
</I>&gt;&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl Safe_ports port 80		# http
</I>&gt;&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;&gt;<i> acl Safe_ports port 443		# https
</I>&gt;&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> always_direct allow all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any suggestions gratefully received.
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Mark
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013978.html">[squid-users] problem authentication ntlm with squid 3.5.21
</A></li>
	<LI>Next message (by thread): <A HREF="013974.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13972">[ date ]</a>
              <a href="thread.html#13972">[ thread ]</a>
              <a href="subject.html#13972">[ subject ]</a>
              <a href="author.html#13972">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
