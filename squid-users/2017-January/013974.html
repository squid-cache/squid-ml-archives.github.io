<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%0A%09than%09server%20name&In-Reply-To=%3C002c01d26612%2477f3b330%2467db1990%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013972.html">
   <LINK REL="Next"  HREF="013975.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name</H1>
    <B>Eliezer  Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%0A%09than%09server%20name&In-Reply-To=%3C002c01d26612%2477f3b330%2467db1990%24%40ngtech.co.il%3E"
       TITLE="[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Jan  3 22:41:05 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013972.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
</A></li>
        <LI>Next message (by thread): <A HREF="013975.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13974">[ date ]</a>
              <a href="thread.html#13974">[ thread ]</a>
              <a href="subject.html#13974">[ subject ]</a>
              <a href="author.html#13974">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Mark,

Squid in intercept or tproxy mode will know one thing about the tunnel\connection: IP+port.
Since you are using:
&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>
The connections will always be spliced and you will never see any url.(are you expecting only the SNI or also the url?)
I do not know but there might be a code that can report the SNI if exists in the logs.
Alex is better then me in this but I believe it should be possible as an addition to the IP+PORT and not replacing them.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Mark Hoare
Sent: Saturday, December 31, 2016 4:38 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] ssl_bump - peek &amp; splice logging IP rather than server name

Hi,

I&#8217;m trying to setup policy based routing on a gateway device pointing at a remote squid server to do transparent HTTP &amp; HTTPS proxying with ssl_bump (peek &amp; splice)

After quite a bit of pain getting policy based routing working on the gateway and local port redirection on the squid server, everything appears to be working except the access log still refers to the destination IP address in the TCP_TUNNEL rather than the SNI/TLS server name.

By increasing the debug level I can see that the SNI/TLS details are definitely being obtained during the request processing but for some reason they are not ending up in the access log.

Extract from cache log:
&gt;<i> 2016/12/31 14:18:01.966 kid1| 83,7| bio.cc(1110) parseV3Hello: Found server name: www.ssllabs.com
</I>&gt;<i> 2016/12/31 14:18:02.351 kid1| 83,5| support.cc(259) ssl_verify_cb: SSL Certificate signature OK: /C=US/ST=California/L=Redwood City/O=Qualys, Inc./CN=ssllabs.com
</I>&gt;<i> 2016/12/31 14:18:02.351 kid1| 83,4| support.cc(213) check_domain: Verifying server domain www.ssllabs.com to certificate name/subjectAltName ssllabs.com
</I>&gt;<i> 2016/12/31 14:18:02.351 kid1| 83,4| support.cc(213) check_domain: Verifying server domain www.ssllabs.com to certificate name/subjectAltName *.ssllabs.com
</I>&gt;<i> 2016/12/31 14:18:02.383 kid1| 83,5| PeerConnector.cc(307) serverCertificateVerified: HTTPS server CN: ssllabs.com bumped: local=&lt;squid IP removed&gt;:57790 remote=64.41.200.100:443 FD 14 flags=1
</I>
Extract from access log:
&gt;<i> 1483193882.790    870 &lt;local ip removed&gt; TCP_TUNNEL/200 5620 CONNECT 64.41.200.100:443 - ORIGINAL_DST/64.41.200.100 -
</I>
&gt;<i>From the output above I would have expected some of the server name info to get into the access log.
</I>
Squid config below:
&gt;<i> debug_options ALL,7
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> https_port 3130 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> http_port 3131 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> cache_dir ufs /var/spool/squid 200 16 256
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>

Any suggestions gratefully received.

Thanks

Mark
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013972.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
</A></li>
	<LI>Next message (by thread): <A HREF="013975.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13974">[ date ]</a>
              <a href="thread.html#13974">[ thread ]</a>
              <a href="subject.html#13974">[ subject ]</a>
              <a href="author.html#13974">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
