<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%20server%20name&In-Reply-To=%3Ccd02ce1f-736c-3d5d-ef77-1febddfd7b16%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013974.html">
   <LINK REL="Next"  HREF="014254.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%20server%20name&In-Reply-To=%3Ccd02ce1f-736c-3d5d-ef77-1febddfd7b16%40measurement-factory.com%3E"
       TITLE="[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan  3 23:10:16 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013974.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
</A></li>
        <LI>Next message (by thread): <A HREF="014254.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13975">[ date ]</a>
              <a href="thread.html#13975">[ thread ]</a>
              <a href="subject.html#13975">[ subject ]</a>
              <a href="author.html#13975">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/03/2017 03:41 PM, Eliezer  Croitoru wrote:

&gt;<i> Squid in intercept or tproxy mode will know one thing about the tunnel\connection: IP+port.
</I>
... and SSL handshake information when peeking or staring at client/server.


&gt;<i> Since you are using:
</I>&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;<i> ssl_bump splice all
</I>
&gt;<i> The connections will always be spliced and you will never see any
</I>&gt;<i> url.(are you expecting only the SNI or also the url?)
</I>
AFAICT, Mark is expecting Squid to log one of the server names, not the
HTTP request URL.


&gt;<i> I do not know but there might be a code that can report the SNI if exists in the logs.
</I>
According to squid.conf.documented, the following logformat %code is
supported in modern Squids:

&gt;<i> ssl::&gt;sni       SSL client SNI sent to Squid. Available only
</I>&gt;<i>                 after the peek, stare, or splice SSL bumping
</I>&gt;<i>                 actions.
</I>
This %code is not in the default access.log line format, naturally.

Squid can also analyze CN and other server certificate fields, but there
is no code to log them IIRC.


Please note that the intercepted server IP address, the client-supplied
SNI name, the server-supplied common name (CN), the server-supplied
alternative names, and the host info in the encrypted client HTTP
request, may all be different.

Given the variety of information sources that might supply different
information, it is not clear to me whether %ru should be based on SNI
information when both TCP-level and SNI information is available. Or
should it be based on CN? Or perhaps on CN _unless_ SNI matches one of
the alternative names?? This is a complicated issue; even the smart
server_name ACL needs parameters to clarify what &quot;server name(s)&quot; the
admin really wants to use/trust...

According to Mark's email, %ru uses TCP-level info. We could either
change %ru to use the &quot;latest&quot; info (like the server_name ACL does) or
add a new logformat code that does that while leaving the old %ru and
friends alone. Given the complexity of the issue, the latter may be a
better approach.


HTH,

Alex.

&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Mark Hoare
</I>&gt;<i> Sent: Saturday, December 31, 2016 4:38 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</I>
&gt;<i> Extract from access log:
</I>&gt;&gt;<i> 1483193882.790    870 &lt;local ip removed&gt; TCP_TUNNEL/200 5620 CONNECT 64.41.200.100:443 - ORIGINAL_DST/64.41.200.100 -
</I>
&gt;<i> From the output above I would have expected some of the server name info to get into the access log.
</I>
&gt;&gt;<i> http_port 3128
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 3130 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3131 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>
&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;<i> ssl_bump splice all
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013974.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
</A></li>
	<LI>Next message (by thread): <A HREF="014254.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13975">[ date ]</a>
              <a href="thread.html#13975">[ thread ]</a>
              <a href="subject.html#13975">[ subject ]</a>
              <a href="author.html#13975">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
