<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.22%20Bug%20when%20using%20Mimetype%20Detection%3F%0A%20rep_mime_type&In-Reply-To=%3Cdeaf1dc121c9bce2ffa26e9b039d433c%40data-core.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013952.html">
   <LINK REL="Next"  HREF="014023.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type</H1>
    <B>Flashdown</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.22%20Bug%20when%20using%20Mimetype%20Detection%3F%0A%20rep_mime_type&In-Reply-To=%3Cdeaf1dc121c9bce2ffa26e9b039d433c%40data-core.org%3E"
       TITLE="[squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type">flashdown at data-core.org
       </A><BR>
    <I>Mon Jan  9 14:31:04 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013952.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type
</A></li>
        <LI>Next message (by thread): <A HREF="014023.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14021">[ date ]</a>
              <a href="thread.html#14021">[ thread ]</a>
              <a href="subject.html#14021">[ subject ]</a>
              <a href="author.html#14021">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

sry that my reply took that long.

I've tested with Squid 3.5.23 on Debian Stretch and the issue is still 
present. Also I was able to create the same issue with the Online OTRS 
Demo website as I had with our internal one.

I did run it with the debug options you gave me. Since you requested 
more info about my config, I stripped a lot out and made sure the issue 
is still the same. XXXXXXXXXXXX indicates that I replaced the whole line 
with XXX.. to ensure no sensitive data is leaked.

So I found out when allowing an IP without authentication and without 
group membership before the real auth is required for everything else, 
then the issue is triggered when Mimetype detection is used. I could'nt 
find a way to avoid the issue. unless I remove the http_access line for 
the target that should be accessible without authentication and without 
group membership. Or I remove the Mimetype Detection lines or better the 
exception for my group.

I hope you can confirm this as a bug or tell me what I made wrong.

This archiv includes: a small squid.conf, cache.log and access.log
<A HREF="https://data-core.org/debug_issue.zip">https://data-core.org/debug_issue.zip</A>

Hope you can bring light into the dark :)

Best regards,
Enrico


Am 2017-01-03 09:07, schrieb Amos Jeffries:
&gt;<i> On 2017-01-03 07:33, Flashdown wrote:
</I>&gt;&gt;<i> Hello together,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> with Squid 3.5.22 I have switched from using a url-regex to Mime Type
</I>&gt;&gt;<i> Detection, which seemed to work nicely until now... :/
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The thing to be very wary of with this change is that when reply
</I>&gt;<i> blocking the request does still make it through to the server and any
</I>&gt;<i> processing done there still happens.
</I>&gt;<i> 
</I>&gt;<i> With things like ticketing systems that means the tickets and any auth
</I>&gt;<i> related token creating has actually happened, even if the client is
</I>&gt;<i> prevented from being told what the created token was.
</I>&gt;<i> 
</I>&gt;<i> That is a major difference from URL based blocking, which would reject
</I>&gt;<i> before any server contact.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> OS: Debian Stretch 4.8.0-1-amd64 #1 SMP Debian 4.8.7-1 (2016-11-13)
</I>&gt;&gt;<i> x86_64 GNU/Linux
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I really advise going to 3.5.23. Several major issues about sending
</I>&gt;<i> wrong replies on certain occasions were fixed there. New .deb should
</I>&gt;<i> be available by now to fix that.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I faced the following Situation:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> When I globally deny specific mimetypes using a blockfile, then it
</I>&gt;&gt;<i> performs as it should, so only mime types I defined in the block file
</I>&gt;&gt;<i> are getting blocked, so far so good.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> When I do an exception for a group I belong to like unblocking
</I>&gt;&gt;<i> application/octet-stream, then I can download files, so the exception
</I>&gt;&gt;<i> works in the first place.
</I>&gt;&gt;<i> acl mime_IT rep_mime_type application/octet-stream
</I>&gt;&gt;<i> http_reply_access allow IT mime_IT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Normally internal targets are excluded from the Proxy using Proxy
</I>&gt;&gt;<i> Exception lists. But I do not get these settings automatically, so my
</I>&gt;&gt;<i> browser did not contain this exception so I was able to discover the
</I>&gt;&gt;<i> following behavior:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The Issue is occuring when browsing to an internal OTRS Web Server via
</I>&gt;&gt;<i> FQDN (It's a web ticket system) through the proxy I get &quot;Access
</I>&gt;&gt;<i> Denied&quot; from the Proxy on all requests. But when browsing to an online
</I>&gt;&gt;<i> OTRS Demo site with the same OTRS version like this one:
</I>&gt;&gt;<i> <A HREF="http://itsm-demo.otrs.com/otrs/index.pl">http://itsm-demo.otrs.com/otrs/index.pl</A> then it works. When I now try
</I>&gt;&gt;<i> again to access the internal OTRS Server through the proxy it works.
</I>&gt;&gt;<i> That's strange, when I now force reload (CTRL+F5 in Firefox) the
</I>&gt;&gt;<i> internal OTRS Ticketsystems webpage, I get the &quot;access denied&quot; again.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> How is the auth happening between the users and the proxy to find out
</I>&gt;<i> what the groups are?
</I>&gt;<i>  The reply checks may be interferring with the auth replies.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> When I remove the exception from the global block list for the group I
</I>&gt;&gt;<i> belong to,- here it's IT- then this issue does not occur and the
</I>&gt;&gt;<i> website is accessible like it should.
</I>&gt;&gt;<i> So I just need to comment out these lines:
</I>&gt;&gt;<i> #acl mime_IT rep_mime_type application/octet-stream
</I>&gt;&gt;<i> #http_reply_access allow IT mime_IT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> When I add text/html &amp; application/xml to the global block exception,
</I>&gt;&gt;<i> then this error does not occur anymore.
</I>&gt;&gt;<i> acl mime_IT rep_mime_type application/octet-stream text/html 
</I>&gt;&gt;<i> application/xml
</I>&gt;&gt;<i> http_reply_access allow IT mime_IT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> So currently I can workaround the issue in 3 different ways:
</I>&gt;&gt;<i> 1. Do not create a global mimetype block exception for groups I belong 
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> 2. Browse to the start page of an Online Demo OTRS Site and then
</I>&gt;&gt;<i> reload the internal Website
</I>&gt;&gt;<i> 3. Add text/html &amp; application/xml to my exception even if these
</I>&gt;&gt;<i> Mimetypes are not part of the global block list, so they are not
</I>&gt;&gt;<i> supposed to be blocked. (I just looked at the internal website and it
</I>&gt;&gt;<i> just uses text/html and application/xml on the start page (Login Page)
</I>&gt;&gt;<i> so I added them to the exception list for my group and it worked)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Conclusion: When having a global mime type block and unblocking a
</I>&gt;&gt;<i> specific mime type for a specific group, then this group will most
</I>&gt;&gt;<i> propably face issues with mime types that are not supposed to be
</I>&gt;&gt;<i> blocked. So in case of errors, I need to unblock not blocked mimetypes
</I>&gt;&gt;<i> ,too.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> My Squid config for mime type blocking:
</I>&gt;&gt;<i> ---------------------------------------
</I>&gt;&gt;<i> ## Define Default MIMETYPE ERROR Message and global block access list
</I>&gt;&gt;<i> acl block_mimetypes rep_mime_type &quot;/etc/squid/mimetype_blacklist.acl&quot;
</I>&gt;&gt;<i> deny_info ERR_BLOCKED_FILES block_mimetypes
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Configure Execptions
</I>&gt;&gt;<i> acl mime_IT rep_mime_type application/octet-stream
</I>&gt;&gt;<i> http_reply_access allow IT mime_IT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl mime_SpecialGroup rep_mime_type application/octet-stream
</I>&gt;&gt;<i> http_reply_access allow SpecialGroup mime_SpecialGroup
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #Applying Global MimeType Block
</I>&gt;&gt;<i> http_reply_access deny block_mimetypes
</I>&gt;<i> 
</I>&gt;<i> Any other http_reply_access rules? the implicit-default behaviour may
</I>&gt;<i> be having an effect if there are.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> ---------------------------------------
</I>&gt;&gt;<i> Squid main config:
</I>&gt;&gt;<i> ---------------------------------------
</I>&gt;&gt;<i> http_port 8080 ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=16MB cert=/*********************
</I>&gt;&gt;<i> ssl_bump splice localhost
</I>&gt;&gt;<i> ssl_bump splice SSL_Exclude
</I>&gt;<i> 
</I>&gt;<i> These splice rules may be related to the issue. Any connection that
</I>&gt;<i> gets spliced may be used by other requests without squid being aware
</I>&gt;<i> of them.
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i> sslproxy_cert_error allow SSL_TrustedSites
</I>&gt;&gt;<i> sslproxy_cert_error deny all
</I>&gt;&gt;<i> ---------------------------------------
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Contents of mimetype_blacklist.acl:
</I>&gt;&gt;<i> ---------------------------------------
</I>&gt;<i> 
</I>&gt;<i> That looks okay to me, just remember that it is a regex pattern. So if
</I>&gt;<i> a type entered there matches a sub-string it can block unexpectedly.
</I>&gt;<i> That includes sub-strings in the type parameters.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 1483381150.095    186 10.3.101.23 TCP_DENIED_REPLY/403 4493 GET
</I>&gt;&gt;<i> <A HREF="http://otrs-server.**.**.com/otrs/index.pl">http://otrs-server.**.**.com/otrs/index.pl</A> - HIER_DIRECT/10.2.1.107
</I>&gt;&gt;<i> text/html
</I>&gt;&gt;<i> 1483381150.118      3 10.3.101.23 TCP_DENIED_REPLY/403 4451 GET
</I>&gt;&gt;<i> <A HREF="http://*****-proxy.**.**.com:8080/squid-internal-static/icons/SN.png">http://*****-proxy.**.**.com:8080/squid-internal-static/icons/SN.png</A> -
</I>&gt;&gt;<i> HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> FWIW: the text/html is the type of the HTML error page being delivered
</I>&gt;<i> for the 403 response. The content-type for the original response
</I>&gt;<i> payload which was blocked is not logged.
</I>&gt;<i> 
</I>&gt;<i> You can debug with &quot;debug_options 11,2&quot; to get a cache.log trace of
</I>&gt;<i> what messages are happening and what the original server response
</I>&gt;<i> headers were.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013952.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection?	rep_mime_type
</A></li>
	<LI>Next message (by thread): <A HREF="014023.html">[squid-users] Squid 3.5.22 Bug when using Mimetype Detection? rep_mime_type
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14021">[ date ]</a>
              <a href="thread.html#14021">[ thread ]</a>
              <a href="subject.html#14021">[ subject ]</a>
              <a href="author.html#14021">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
