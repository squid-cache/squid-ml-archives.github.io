<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERR_CANNOT_FORWARD%20with%20Squid%20%2B%20Privoxy&In-Reply-To=%3Ce18fd2e1-693e-4e26-57c9-7722e0d938b9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014030.html">
   <LINK REL="Next"  HREF="014044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERR_CANNOT_FORWARD%20with%20Squid%20%2B%20Privoxy&In-Reply-To=%3Ce18fd2e1-693e-4e26-57c9-7722e0d938b9%40treenet.co.nz%3E"
       TITLE="[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 11 14:23:37 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014030.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
        <LI>Next message (by thread): <A HREF="014044.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14038">[ date ]</a>
              <a href="thread.html#14038">[ thread ]</a>
              <a href="subject.html#14038">[ subject ]</a>
              <a href="author.html#14038">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/01/2017 2:26 p.m., Stepan Bujnak wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I've been trying to configure intercepting proxy with privoxy as a
</I>&gt;<i> cache_peer. This is my Squid configuration:
</I>&gt;<i> 
</I>&gt;<i> acl all src all
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports  port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT    method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #http_access deny !Safe_ports
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> # stop squid taking forever to restart.
</I>&gt;<i> shutdown_lifetime 3 second
</I>&gt;<i> 
</I>&gt;<i> client_dst_passthru off
</I>&gt;<i> host_verify_strict off
</I>
Please pay attention to the docs for these options. Specifically how it
says host_verify_strict has no effect on intercepted traffic. Also how
it says client_dst_passthru has no effect when the Host verify process
detects an origin mismatch (eg 'fails').


&gt;<i> 
</I>&gt;<i> # IMPORTANT! squid requires at least one forward-proxy port configured
</I>&gt;<i> #            <A HREF="http://wiki.squid-cache.org/KnowledgeBase/NoForwardProxyPorts">http://wiki.squid-cache.org/KnowledgeBase/NoForwardProxyPorts</A>
</I>&gt;<i> http_port 0.0.0.0:3127
</I>&gt;<i> http_port 0.0.0.0:3128 intercept
</I>&gt;<i> https_port 0.0.0.0:3129 intercept ssl-bump
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/etc/squid/ssl_certs/squid.pem
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M
</I>&gt;<i> 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>
So what you have configured is Server-first bumping.

All clients will be presented with the Privoxy SSL certificate as if
Privoxy (at 127.0.0.1:8118) was the authoritative web server for the
HTTPS website being fetched.

&quot;What could go wrong?&quot; as the saying goes. A better question would be
what could possibly go _right_ in that setup. Very few websites will
work, and only where the TLS was completely broken in the first place.


&gt;<i> 
</I>&gt;<i> cache_peer 127.0.0.1 parent 8118 7 no-query default no-digest
</I>&gt;<i> no-netdb-exchange proxy-only ssl
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> cache_mem 8 MB
</I>&gt;<i> maximum_object_size_in_memory 32 KB
</I>&gt;<i> 
</I>&gt;<i> # Disable the Via and X-Forwarded-For field from the request header to avoid
</I>&gt;<i> # leaking the use of a proxy and client ip address
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for off
</I>
The above injects &quot;X-Forwarded-For: unknown&quot; into the traffic. Squid has
long ago moved past the point where that was the only choice.

Use &quot;forwarded_for transparent&quot; instead for privacy. Then you can remove
the following two lines as well...

&gt;<i> follow_x_forwarded_for deny all
</I>&gt;<i> request_header_access X-Forwarded-For deny all
</I>&gt;<i> 
</I>&gt;<i> #cache_dir ufs /var/spool/squid 1024 16 256
</I>&gt;<i> #coredump_dir /var/cache/squid
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Now when making a request, privoxy prints out following:
</I>&gt;<i> 
</I>&gt;<i> 2017-01-11 00:36:51.420 7fe4872a4700 Connect: Accepted connection from
</I>&gt;<i> 127.0.0.1 on socket 4
</I>&gt;<i> 2017-01-11 00:36:51.421 7fe4872a4700 Received: from socket 4:
</I>&gt;<i> \x16\x03\x01\x010\x01\x00\x01,\x03\x03xfOz\xc3\xc2\xf8\xf6\xc4\x972Y\xe5w\xf0\xd7\x98\xb5\xd3\x99\xfb\x97P%\x0aX\x1f\xefs\x91\xc6d\x00\x00\xaa\xc00\xc0,\xc0(\xc0$\xc0\x14\xc0\x0a\x00\xa5\x00\xa3\x00\xa1\x00\x9f\x00k\x00j\x00i\x00h\x009\x008\x007\x006\x00\x88\x00\x87\x00\x86\x00\x85\xc02\xc0.\xc0*\xc0&amp;\xc0\x0f\xc0\x05\x00\x9d\x00=\x005\x00\x84\xc0/\xc0+\xc0'\xc0#\xc0\x13\xc0\x09\x00\xa4\x00\xa2\x00\xa0\x00\x9e\x00g\x00@\x00?\x00&gt;\x003\x002\x001\x000\x00\x9a\x00\x99\x00\x98\x00\x97\x00E\x00D\x00C\x00B\xc01\xc0-\xc0)\xc0%\xc0\x0e\xc0\x04\x00\x9c\x00&lt;\x00/\x00\x96\x00A\xc0\x11\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\xc0\x12\xc0\x08\x00\x16\x00\x13\x00\x10\x00\x0d\xc0\x0d\xc0\x03\x00\x0a\x00\xff\x01\x00\x00Y\x00\x0b\x00\x04\x03\x00\x01\x02\x00\x0a\x00\x1c\x00\x1a\x00\x17\x00\x19\x00\x1c\x00\x1b\x00\x18\x00\x1a\x00\x16\x00\x0e\x00\x0d\x00\x0b\x00\x0c\x00\x09\x00\x0a\x00#\x00\x00\x00\x0d\x00
</I>&gt;<i> \x00\x1e\x06\x01\x06\x02\x06\x03\x05\x01\x05\x02\x05\x03\x04\x01\x04\x02\x04\x03\x03\x01\x03\x02\x03\x03\x02\x01\x02\x02\x02\x03\x00\x0f\x00\x01\x013t\x00\x00
</I>&gt;<i> 2017-01-11 00:37:21.450 7fe4872a4700 Connect: The client side of the
</I>&gt;<i> connection on socket 4 got closed without sending a complete request
</I>&gt;<i> line.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It seems like the bumped request is missing the CONNECT line and
</I>&gt;<i> privoxy gets confused.
</I>
There is no CONNECT.

You configured Squid to SSL-Bump the HTTPS traffic. That means the
CONNECT gets absorbed by Squid and the TLS protocol to the client gets
terminated, and a new TLS connection is opened to the Privoxy to fetch
the server certificate (or not as this case shows).

The connection is native TLS between Squid and privoxy. As configured by
the 'ssl' option on cache_peer. Since Privoxy cannot handle TLS that
fails, and you get the forwarding error.

And before you ask, no Squid-3 will not send SSL-Bump'ed traffic through
a peer without that 'ssl' option. Squid-4 has some improvements for
non-HTTPS traffic, but still not to the point of Squid generating peer
CONNECT messages after bumping HTTPS.


&gt;<i> 
</I>&gt;<i> As a result, the client receives ERR_CANNOT_FORWARD. Could someone
</I>&gt;<i> point me to the right direction? Thank you.
</I>
Your best hope is to recreate in squid.conf settings the privacy
operations you are using privoxy for. Then remove privoxy from the chain
of proxies.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014030.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
	<LI>Next message (by thread): <A HREF="014044.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14038">[ date ]</a>
              <a href="thread.html#14038">[ thread ]</a>
              <a href="subject.html#14038">[ subject ]</a>
              <a href="author.html#14038">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
