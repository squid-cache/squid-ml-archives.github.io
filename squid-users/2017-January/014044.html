<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERR_CANNOT_FORWARD%20with%20Squid%20%2B%20Privoxy&In-Reply-To=%3CCA%2B0ge-TOEkfO-tePJ0FbQksPRHj3w2BNvtfFzPFgKVR6gFr1pQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014038.html">
   <LINK REL="Next"  HREF="014045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy</H1>
    <B>Stepan Bujnak</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERR_CANNOT_FORWARD%20with%20Squid%20%2B%20Privoxy&In-Reply-To=%3CCA%2B0ge-TOEkfO-tePJ0FbQksPRHj3w2BNvtfFzPFgKVR6gFr1pQ%40mail.gmail.com%3E"
       TITLE="[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy">stepan.bujnak at gmail.com
       </A><BR>
    <I>Wed Jan 11 15:56:09 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014038.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
        <LI>Next message (by thread): <A HREF="014045.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14044">[ date ]</a>
              <a href="thread.html#14044">[ thread ]</a>
              <a href="subject.html#14044">[ subject ]</a>
              <a href="author.html#14044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you very much for the reply!

On Wed, Jan 11, 2017 at 6:23 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 11/01/2017 2:26 p.m., Stepan Bujnak wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've been trying to configure intercepting proxy with privoxy as a
</I>&gt;&gt;<i> cache_peer. This is my Squid configuration:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl all src all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_ports  port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT    method CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #http_access deny !Safe_ports
</I>&gt;&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # stop squid taking forever to restart.
</I>&gt;&gt;<i> shutdown_lifetime 3 second
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> client_dst_passthru off
</I>&gt;&gt;<i> host_verify_strict off
</I>&gt;<i>
</I>&gt;<i> Please pay attention to the docs for these options. Specifically how it
</I>&gt;<i> says host_verify_strict has no effect on intercepted traffic. Also how
</I>&gt;<i> it says client_dst_passthru has no effect when the Host verify process
</I>&gt;<i> detects an origin mismatch (eg 'fails').
</I>
I figured out the origin mismatch part. Unfortunately, this is very
important to me so I had to dig into the code turn the check off.

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # IMPORTANT! squid requires at least one forward-proxy port configured
</I>&gt;&gt;<i> #            <A HREF="http://wiki.squid-cache.org/KnowledgeBase/NoForwardProxyPorts">http://wiki.squid-cache.org/KnowledgeBase/NoForwardProxyPorts</A>
</I>&gt;&gt;<i> http_port 0.0.0.0:3127
</I>&gt;&gt;<i> http_port 0.0.0.0:3128 intercept
</I>&gt;&gt;<i> https_port 0.0.0.0:3129 intercept ssl-bump
</I>&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i> cert=/etc/squid/ssl_certs/squid.pem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M
</I>&gt;&gt;<i> 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> So what you have configured is Server-first bumping.
</I>&gt;<i>
</I>&gt;<i> All clients will be presented with the Privoxy SSL certificate as if
</I>&gt;<i> Privoxy (at 127.0.0.1:8118) was the authoritative web server for the
</I>&gt;<i> HTTPS website being fetched.
</I>&gt;<i>
</I>&gt;<i> &quot;What could go wrong?&quot; as the saying goes. A better question would be
</I>&gt;<i> what could possibly go _right_ in that setup. Very few websites will
</I>&gt;<i> work, and only where the TLS was completely broken in the first place.
</I>
Would better solution be client-first configuration where client would
be presented with squid's self generated certificate, read the traffic
and then send it to the actual destination through privoxy using
CONNECT? How could that be configured?

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer 127.0.0.1 parent 8118 7 no-query default no-digest
</I>&gt;&gt;<i> no-netdb-exchange proxy-only ssl
</I>&gt;&gt;<i> never_direct allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_mem 8 MB
</I>&gt;&gt;<i> maximum_object_size_in_memory 32 KB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Disable the Via and X-Forwarded-For field from the request header to avoid
</I>&gt;&gt;<i> # leaking the use of a proxy and client ip address
</I>&gt;&gt;<i> via off
</I>&gt;&gt;<i> forwarded_for off
</I>&gt;<i>
</I>&gt;<i> The above injects &quot;X-Forwarded-For: unknown&quot; into the traffic. Squid has
</I>&gt;<i> long ago moved past the point where that was the only choice.
</I>&gt;<i>
</I>&gt;<i> Use &quot;forwarded_for transparent&quot; instead for privacy. Then you can remove
</I>&gt;<i> the following two lines as well...
</I>&gt;<i>
</I>&gt;&gt;<i> follow_x_forwarded_for deny all
</I>&gt;&gt;<i> request_header_access X-Forwarded-For deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #cache_dir ufs /var/spool/squid 1024 16 256
</I>&gt;&gt;<i> #coredump_dir /var/cache/squid
</I>&gt;&gt;<i> cache deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now when making a request, privoxy prints out following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2017-01-11 00:36:51.420 7fe4872a4700 Connect: Accepted connection from
</I>&gt;&gt;<i> 127.0.0.1 on socket 4
</I>&gt;&gt;<i> 2017-01-11 00:36:51.421 7fe4872a4700 Received: from socket 4:
</I>&gt;&gt;<i> \x16\x03\x01\x010\x01\x00\x01,\x03\x03xfOz\xc3\xc2\xf8\xf6\xc4\x972Y\xe5w\xf0\xd7\x98\xb5\xd3\x99\xfb\x97P%\x0aX\x1f\xefs\x91\xc6d\x00\x00\xaa\xc00\xc0,\xc0(\xc0$\xc0\x14\xc0\x0a\x00\xa5\x00\xa3\x00\xa1\x00\x9f\x00k\x00j\x00i\x00h\x009\x008\x007\x006\x00\x88\x00\x87\x00\x86\x00\x85\xc02\xc0.\xc0*\xc0&amp;\xc0\x0f\xc0\x05\x00\x9d\x00=\x005\x00\x84\xc0/\xc0+\xc0'\xc0#\xc0\x13\xc0\x09\x00\xa4\x00\xa2\x00\xa0\x00\x9e\x00g\x00@\x00?\x00&gt;\x003\x002\x001\x000\x00\x9a\x00\x99\x00\x98\x00\x97\x00E\x00D\x00C\x00B\xc01\xc0-\xc0)\xc0%\xc0\x0e\xc0\x04\x00\x9c\x00&lt;\x00/\x00\x96\x00A\xc0\x11\xc0\x07\xc0\x0c\xc0\x02\x00\x05\x00\x04\xc0\x12\xc0\x08\x00\x16\x00\x13\x00\x10\x00\x0d\xc0\x0d\xc0\x03\x00\x0a\x00\xff\x01\x00\x00Y\x00\x0b\x00\x04\x03\x00\x01\x02\x00\x0a\x00\x1c\x00\x1a\x00\x17\x00\x19\x00\x1c\x00\x1b\x00\x18\x00\x1a\x00\x16\x00\x0e\x00\x0d\x00\x0b\x00\x0c\x00\x09\x00\x0a\x00#\x00\x00\x00\x0d\x00
</I>&gt;&gt;<i> \x00\x1e\x06\x01\x06\x02\x06\x03\x05\x01\x05\x02\x05\x03\x04\x01\x04\x02\x04\x03\x03\x01\x03\x02\x03\x03\x02\x01\x02\x02\x02\x03\x00\x0f\x00\x01\x013t\x00\x00
</I>&gt;&gt;<i> 2017-01-11 00:37:21.450 7fe4872a4700 Connect: The client side of the
</I>&gt;&gt;<i> connection on socket 4 got closed without sending a complete request
</I>&gt;&gt;<i> line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It seems like the bumped request is missing the CONNECT line and
</I>&gt;&gt;<i> privoxy gets confused.
</I>&gt;<i>
</I>&gt;<i> There is no CONNECT.
</I>&gt;<i>
</I>&gt;<i> You configured Squid to SSL-Bump the HTTPS traffic. That means the
</I>&gt;<i> CONNECT gets absorbed by Squid and the TLS protocol to the client gets
</I>&gt;<i> terminated, and a new TLS connection is opened to the Privoxy to fetch
</I>&gt;<i> the server certificate (or not as this case shows).
</I>&gt;<i>
</I>&gt;<i> The connection is native TLS between Squid and privoxy. As configured by
</I>&gt;<i> the 'ssl' option on cache_peer. Since Privoxy cannot handle TLS that
</I>&gt;<i> fails, and you get the forwarding error.
</I>&gt;<i>
</I>&gt;<i> And before you ask, no Squid-3 will not send SSL-Bump'ed traffic through
</I>&gt;<i> a peer without that 'ssl' option. Squid-4 has some improvements for
</I>&gt;<i> non-HTTPS traffic, but still not to the point of Squid generating peer
</I>&gt;<i> CONNECT messages after bumping HTTPS.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As a result, the client receives ERR_CANNOT_FORWARD. Could someone
</I>&gt;&gt;<i> point me to the right direction? Thank you.
</I>&gt;<i>
</I>&gt;<i> Your best hope is to recreate in squid.conf settings the privacy
</I>&gt;<i> operations you are using privoxy for. Then remove privoxy from the chain
</I>&gt;<i> of proxies.
</I>
I thought about this solution, but it seems that squid cannot use
socks parent yet.

&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014038.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
	<LI>Next message (by thread): <A HREF="014045.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14044">[ date ]</a>
              <a href="thread.html#14044">[ thread ]</a>
              <a href="subject.html#14044">[ subject ]</a>
              <a href="author.html#14044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
