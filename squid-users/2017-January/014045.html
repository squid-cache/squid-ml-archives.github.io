<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERR_CANNOT_FORWARD%20with%20Squid%20%2B%20Privoxy&In-Reply-To=%3C0e92ed25-a96f-9637-d955-cb65039538d0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014044.html">
   <LINK REL="Next"  HREF="014031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERR_CANNOT_FORWARD%20with%20Squid%20%2B%20Privoxy&In-Reply-To=%3C0e92ed25-a96f-9637-d955-cb65039538d0%40treenet.co.nz%3E"
       TITLE="[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 11 16:18:58 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014044.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
        <LI>Next message (by thread): <A HREF="014031.html">[squid-users] SSL_bump and source IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14045">[ date ]</a>
              <a href="thread.html#14045">[ thread ]</a>
              <a href="subject.html#14045">[ subject ]</a>
              <a href="author.html#14045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/01/2017 4:56 a.m., Stepan Bujnak wrote:
&gt;<i> Thank you very much for the reply!
</I>&gt;<i> 
</I>&gt;<i> On Wed, Jan 11, 2017 at 6:23 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;<i> On 11/01/2017 2:26 p.m., Stepan Bujnak wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've been trying to configure intercepting proxy with privoxy as a
</I>&gt;&gt;&gt;<i> cache_peer. This is my Squid configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl all src all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl SSL_ports  port 443
</I>&gt;&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;&gt;<i> acl CONNECT    method CONNECT
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #http_access deny !Safe_ports
</I>&gt;&gt;&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;<i> http_access allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # stop squid taking forever to restart.
</I>&gt;&gt;&gt;<i> shutdown_lifetime 3 second
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> client_dst_passthru off
</I>&gt;&gt;&gt;<i> host_verify_strict off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please pay attention to the docs for these options. Specifically how it
</I>&gt;&gt;<i> says host_verify_strict has no effect on intercepted traffic. Also how
</I>&gt;&gt;<i> it says client_dst_passthru has no effect when the Host verify process
</I>&gt;&gt;<i> detects an origin mismatch (eg 'fails').
</I>&gt;<i> 
</I>&gt;<i> I figured out the origin mismatch part. Unfortunately, this is very
</I>&gt;<i> important to me so I had to dig into the code turn the check off.
</I>&gt;<i> 
</I>
Sigh. Please don't. That makes a short web script (eg a web advert) able
to hijack your proxy and use it as a base to hijack your whole network -
hiding the attacker while doing so.

There are details and some mitigations to reduce the pain listed at
&lt;<A HREF="http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">http://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt;


&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # IMPORTANT! squid requires at least one forward-proxy port configured
</I>&gt;&gt;&gt;<i> #            <A HREF="http://wiki.squid-cache.org/KnowledgeBase/NoForwardProxyPorts">http://wiki.squid-cache.org/KnowledgeBase/NoForwardProxyPorts</A>
</I>&gt;&gt;&gt;<i> http_port 0.0.0.0:3127
</I>&gt;&gt;&gt;<i> http_port 0.0.0.0:3128 intercept
</I>&gt;&gt;&gt;<i> https_port 0.0.0.0:3129 intercept ssl-bump
</I>&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;<i> cert=/etc/squid/ssl_certs/squid.pem
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M
</I>&gt;&gt;&gt;<i> 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;&gt;&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So what you have configured is Server-first bumping.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All clients will be presented with the Privoxy SSL certificate as if
</I>&gt;&gt;<i> Privoxy (at 127.0.0.1:8118) was the authoritative web server for the
</I>&gt;&gt;<i> HTTPS website being fetched.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;What could go wrong?&quot; as the saying goes. A better question would be
</I>&gt;&gt;<i> what could possibly go _right_ in that setup. Very few websites will
</I>&gt;&gt;<i> work, and only where the TLS was completely broken in the first place.
</I>&gt;<i> 
</I>&gt;<i> Would better solution be client-first configuration where client would
</I>&gt;<i> be presented with squid's self generated certificate, read the traffic
</I>&gt;<i> and then send it to the actual destination through privoxy
</I>
That can be done by making the ssl_bump directive decide to bump on
step1. It still has all the same problems as the existing config, the
issues all center around the fact that the client is not presented with
anything that looks even remotely like the real servers certificate or
TLS options. So any TLS/SSL security the client may be using is useless.

&gt;<i> using CONNECT?
</I>
No Squid is currently able to do that. Once decrypted the traffic has to
go to an HTTPS server directly (ORIGINAL_DST) or to a proxy which is
connected to using a secure channel, ie. TLS/SSL.


&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As a result, the client receives ERR_CANNOT_FORWARD. Could someone
</I>&gt;&gt;&gt;<i> point me to the right direction? Thank you.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Your best hope is to recreate in squid.conf settings the privacy
</I>&gt;&gt;<i> operations you are using privoxy for. Then remove privoxy from the chain
</I>&gt;&gt;<i> of proxies.
</I>&gt;<i> 
</I>&gt;<i> I thought about this solution, but it seems that squid cannot use
</I>&gt;<i> socks parent yet.
</I>
You should be able to send Squids outbound traffic through a regular
SOCKS tunnel/gateway if you need to. It is just configured at the OS
routing level rather than anything in squid.conf.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014044.html">[squid-users] ERR_CANNOT_FORWARD with Squid + Privoxy
</A></li>
	<LI>Next message (by thread): <A HREF="014031.html">[squid-users] SSL_bump and source IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14045">[ date ]</a>
              <a href="thread.html#14045">[ thread ]</a>
              <a href="subject.html#14045">[ subject ]</a>
              <a href="author.html#14045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
