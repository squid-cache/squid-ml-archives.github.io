<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Will%20squid%20core%20dump%20with%20worker%20threads%3F%0A%20Investigating%20squid%20crash%2C%203.5.23&In-Reply-To=%3Cf03d70e4-0c65-79f0-0a49-54cf14b19406%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014079.html">
   <LINK REL="Next"  HREF="014093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Will%20squid%20core%20dump%20with%20worker%20threads%3F%0A%20Investigating%20squid%20crash%2C%203.5.23&In-Reply-To=%3Cf03d70e4-0c65-79f0-0a49-54cf14b19406%40treenet.co.nz%3E"
       TITLE="[squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jan 14 05:37:11 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014079.html">[squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23
</A></li>
        <LI>Next message (by thread): <A HREF="014093.html">[squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14081">[ date ]</a>
              <a href="thread.html#14081">[ thread ]</a>
              <a href="subject.html#14081">[ subject ]</a>
              <a href="author.html#14081">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 14/01/2017 10:32 a.m., Jester Purtteman wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I am having period crashes of my squid server, and I am not getting core
</I>&gt;<i> dump files.  I have set &quot;workers 6&quot; in my squid.conf, and I know that
</I>&gt;<i> threads can cause trouble from reading the debugging wiki page.  I have
</I>&gt;<i> confirmed permissions on the directory I'm dumping to, so I don't *think*
</I>&gt;<i> that is the issue.
</I>
Core dumps are done by your OS when programs crash. You may need to turn
it on explicitly.
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits">http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits</A>&gt;

&gt;<i> 
</I>&gt;<i> FWIW (core dump to follow, I'll retry without workers and see what happens)
</I>&gt;<i> I am having squid crashes.  Details I have so far as are as follows:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I am running Squid-3.5.23-R14129 on a stock Ubuntu 16.04 configured with:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ./configure --prefix=/usr   --localstatedir=/var
</I>&gt;<i> --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid
</I>&gt;<i> --sysconfdir=/etc/squid   --with-default-user=proxy   --with-logdir=/var/log
</I>&gt;<i> --with-pidfile=/var/run/squid.pid --enable-linux-netfilter
</I>&gt;<i> --enable-cache-digests --enable-storeio=ufs,aufs,diskd,rock
</I>&gt;<i> --enable-async-io=30 --enable-http-violations --enable-zph-qos
</I>&gt;<i> --with-netfilter-conntrack --with-filedescriptors=65536 --with-large-files
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> About once a day it is crashing with the following line as about my only
</I>&gt;<i> lead in the cache.log:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> assertion failed: MemBuf.cc:216: &quot;0 &lt;= tailSize &amp;&amp; tailSize &lt;= cSize&quot;
</I>&gt;<i> 
</I>
This is &lt;<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4606">http://bugs.squid-cache.org/show_bug.cgi?id=4606</A>&gt;. We have
narrowed it down to something about the collapsed revalidation behaviour
that became visible after the recent security fix.

&gt;<i> 
</I>&gt;<i> From the possibly interesting-but-who-knows-maybe-unrelated-files, there is
</I>&gt;<i> one additional detail.  I had this version running on a Ubuntu 14.04 machine
</I>&gt;<i> until last week, which I had installed GCC-4.9 on (so I could test squid
</I>&gt;<i> 4.0), and that had ran stable from December 20th to January 5th without a
</I>&gt;<i> any crashes.  Then something totally outside of squid went horribly off the
</I>&gt;<i> rails.  Ubuntu dropped support for the 3.x series kernels, so I updated to
</I>&gt;<i> 4.4 (from the Ubuntu repositories) and that caused /proc/sys/net/bridge to
</I>&gt;<i> go away.  While testing an unrelated issue, I ran a script that I adapted
</I>&gt;<i> from <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxBridge">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxBridge</A> which
</I>&gt;<i> contains a dangerous couple lines I had not before contemplated:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cd /proc/sys/net/bridge/
</I>&gt;<i> for i in *
</I>&gt;<i> do
</I>&gt;<i>    echo 0 &gt; $i
</I>&gt;<i> done
</I>&gt;<i> unset i
</I>&gt;<i> 
</I>&gt;<i> When /proc/sys/net/bridge went away, the change directory failed, then the
</I>&gt;<i> script proceeded to turn everything in that directory into 0's.  OOPS!  I
</I>&gt;<i> tell this bit so that my fellow admins get a laugh at my expense, and as a
</I>&gt;<i> cautionary tale.  CHECK the status of that command before you let it do
</I>&gt;<i> other things!  As it turns out, tproxy works fine without echoing '0' at all
</I>&gt;<i> those files, but if you want to leave it on the page, may I suggest the
</I>&gt;<i> following revision to the wiki page:
</I>&gt;<i> 
</I>
Thank you. There is no need for the cd or the * to be without a fixed
path. I have updated the wiki to prevent this.

It it true that TPROXY does not require bridging, and bridging has
nothing particularly requiring TPROXY. Except that for real transparency
they are usually both wanted.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> In any event, is there a way to get a core with worker threads?  My system
</I>&gt;<i> benefits from them, so I'd rather not turn them off but I want a core dump.
</I>
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#Coredump_Location">http://wiki.squid-cache.org/SquidFaq/BugReporting#Coredump_Location</A>&gt;
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits">http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits</A>&gt;

workers are not threads. They are processes so each have their own PID
which the core file should be associated with. Also, only the individual
worker which crashed will have a core dump generated, then it should be
restarted automatically by the master process.


&gt;<i> Also let me know if there are other details that would be useful.  Adding
</I>&gt;<i> much in the way of debugging is going to be a challenge because it takes a
</I>&gt;<i> day or so to get to a crash, and I don't necessarily have the disk space to
</I>&gt;<i> hold the volume of cache log generated over that period of time (I have a
</I>&gt;<i> 60-gb log partition).  If there is some clever way of limiting cache.log and
</I>&gt;<i> causing it to round-robin or something, I'm happy to try things.  Thank you!
</I>&gt;<i> 
</I>
Using the rotate=N option on the debug_options directive will rotate
cache.log a different (usually smaller) number of times to access.log.

Or, if you use logrotate you can set it to rotate when the cache.log
gets to a certain size.
 see
&lt;<A HREF="http://stackoverflow.com/questions/20162176/centos-linux-setting-logrotate-to-maximum-file-size-for-all-logs">http://stackoverflow.com/questions/20162176/centos-linux-setting-logrotate-to-maximum-file-size-for-all-logs</A>&gt;

Or, you could also setup the cache.log to be a pipe to somewhere else
with more disk space.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014079.html">[squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23
</A></li>
	<LI>Next message (by thread): <A HREF="014093.html">[squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14081">[ date ]</a>
              <a href="thread.html#14081">[ thread ]</a>
              <a href="subject.html#14081">[ subject ]</a>
              <a href="author.html#14081">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
