<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Will%20squid%20core%20dump%20with%20worker%20threads%3F%0A%09Investigating%20squid%20crash%2C%203.5.23&In-Reply-To=%3C003201d2705a%24e34dcce0%24a9e966a0%24%40optimera.us%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014081.html">
   <LINK REL="Next"  HREF="014110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23</H1>
    <B>Jester Purtteman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Will%20squid%20core%20dump%20with%20worker%20threads%3F%0A%09Investigating%20squid%20crash%2C%203.5.23&In-Reply-To=%3C003201d2705a%24e34dcce0%24a9e966a0%24%40optimera.us%3E"
       TITLE="[squid-users] Will squid core dump with worker threads?	Investigating squid crash, 3.5.23">jester at optimera.us
       </A><BR>
    <I>Tue Jan 17 00:44:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014081.html">[squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23
</A></li>
        <LI>Next message (by thread): <A HREF="014110.html">[squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14093">[ date ]</a>
              <a href="thread.html#14093">[ thread ]</a>
              <a href="subject.html#14093">[ subject ]</a>
              <a href="author.html#14093">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;<i> Behalf Of Amos Jeffries
</I>&gt;<i> Sent: Friday, January 13, 2017 9:37 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Will squid core dump with worker threads?
</I>&gt;<i> Investigating squid crash, 3.5.23
</I>&gt;<i> 
</I>&gt;<i> On 14/01/2017 10:32 a.m., Jester Purtteman wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am having period crashes of my squid server, and I am not getting
</I>&gt;<i> &gt; core dump files.  I have set &quot;workers 6&quot; in my squid.conf, and I know
</I>&gt;<i> &gt; that threads can cause trouble from reading the debugging wiki page.
</I>&gt;<i> &gt; I have confirmed permissions on the directory I'm dumping to, so I
</I>&gt;<i> &gt; don't *think* that is the issue.
</I>&gt;<i> 
</I>&gt;<i> Core dumps are done by your OS when programs crash. You may need to
</I>&gt;<i> turn it on explicitly.
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits">http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits</A>&gt;
</I>
Will continue prodding.  I think systemd is doing something funny, because the process isn't getting the same ulimits as I am running it with somehow.  I used to get dumps and I don't anymore, and systemd is one of the big changes between how I have this setup and how it was before.
&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; FWIW (core dump to follow, I'll retry without workers and see what
</I>&gt;<i> &gt; happens) I am having squid crashes.  Details I have so far as are as follows:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am running Squid-3.5.23-R14129 on a stock Ubuntu 16.04 configured with:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ./configure --prefix=/usr   --localstatedir=/var
</I>&gt;<i> &gt; --libexecdir=/usr/lib/squid    --srcdir=.   --datadir=/usr/share/squid
</I>&gt;<i> &gt; --sysconfdir=/etc/squid   --with-default-user=proxy   --with-logdir=/var/log
</I>&gt;<i> &gt; --with-pidfile=/var/run/squid.pid --enable-linux-netfilter
</I>&gt;<i> &gt; --enable-cache-digests --enable-storeio=ufs,aufs,diskd,rock
</I>&gt;<i> &gt; --enable-async-io=30 --enable-http-violations --enable-zph-qos
</I>&gt;<i> &gt; --with-netfilter-conntrack --with-filedescriptors=65536
</I>&gt;<i> &gt; --with-large-files
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; About once a day it is crashing with the following line as about my
</I>&gt;<i> &gt; only lead in the cache.log:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; assertion failed: MemBuf.cc:216: &quot;0 &lt;= tailSize &amp;&amp; tailSize &lt;= cSize&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> This is &lt;<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4606">http://bugs.squid-cache.org/show_bug.cgi?id=4606</A>&gt;. We have
</I>&gt;<i> narrowed it down to something about the collapsed revalidation behaviour
</I>&gt;<i> that became visible after the recent security fix.
</I>
If I do not use collapsed forwarding, would it be safe to revert 3.5.22?  Crashes are happening roughly daily and I don't really want to put a &quot;babysitter&quot; script in to keep it running if I have better options.  For right now, leaving collapsed forwarding off and not applying that patch seems like a better answer.

&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; From the possibly interesting-but-who-knows-maybe-unrelated-files,
</I>&gt;<i> &gt; there is one additional detail.  I had this version running on a
</I>&gt;<i> &gt; Ubuntu 14.04 machine until last week, which I had installed GCC-4.9 on
</I>&gt;<i> &gt; (so I could test squid 4.0), and that had ran stable from December
</I>&gt;<i> &gt; 20th to January 5th without a any crashes.  Then something totally
</I>&gt;<i> &gt; outside of squid went horribly off the rails.  Ubuntu dropped support
</I>&gt;<i> &gt; for the 3.x series kernels, so I updated to
</I>&gt;<i> &gt; 4.4 (from the Ubuntu repositories) and that caused
</I>&gt;<i> &gt; /proc/sys/net/bridge to go away.  While testing an unrelated issue, I
</I>&gt;<i> &gt; ran a script that I adapted from
</I>&gt;<i> &gt; <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxBridge">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxBridge</A> which
</I>&gt;<i> contains a dangerous couple lines I had not before contemplated:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cd /proc/sys/net/bridge/
</I>&gt;<i> &gt; for i in *
</I>&gt;<i> &gt; do
</I>&gt;<i> &gt;    echo 0 &gt; $i
</I>&gt;<i> &gt; done
</I>&gt;<i> &gt; unset i
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; When /proc/sys/net/bridge went away, the change directory failed, then
</I>&gt;<i> &gt; the script proceeded to turn everything in that directory into 0's.
</I>&gt;<i> &gt; OOPS!  I tell this bit so that my fellow admins get a laugh at my
</I>&gt;<i> &gt; expense, and as a cautionary tale.  CHECK the status of that command
</I>&gt;<i> &gt; before you let it do other things!  As it turns out, tproxy works fine
</I>&gt;<i> &gt; without echoing '0' at all those files, but if you want to leave it on
</I>&gt;<i> &gt; the page, may I suggest the following revision to the wiki page:
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Thank you. There is no need for the cd or the * to be without a fixed path. I
</I>&gt;<i> have updated the wiki to prevent this.
</I>
Glad my foolish mistakes can make the world better :)

&gt;<i> 
</I>&gt;<i> It it true that TPROXY does not require bridging, and bridging has nothing
</I>&gt;<i> particularly requiring TPROXY. Except that for real transparency they are
</I>&gt;<i> usually both wanted.
</I>
I am running a TPROXY system on a bridge, and my script had the snippet in it before.  But, it kept working even after the bridging code was migrated to a module, and it kept working even when the module was not loaded.  So, what effect setting everything in that directory to 0 has is beyond my understanding, and (at least appears) to not be necessary in the latest Ubuntu at least.  So, I guess that is part of my question, is something silently broken that you know of because I am not loading the kernel module for that?

&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In any event, is there a way to get a core with worker threads?  My
</I>&gt;<i> &gt; system benefits from them, so I'd rather not turn them off but I want a
</I>&gt;<i> core dump.
</I>&gt;<i> 
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#Coredump_Location">http://wiki.squid-cache.org/SquidFaq/BugReporting#Coredump_Location</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits">http://wiki.squid-cache.org/SquidFaq/BugReporting#Resource_Limits</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> workers are not threads. They are processes so each have their own PID
</I>&gt;<i> which the core file should be associated with. Also, only the individual worker
</I>&gt;<i> which crashed will have a core dump generated, then it should be restarted
</I>&gt;<i> automatically by the master process.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Also let me know if there are other details that would be useful.
</I>&gt;<i> &gt; Adding much in the way of debugging is going to be a challenge because
</I>&gt;<i> &gt; it takes a day or so to get to a crash, and I don't necessarily have
</I>&gt;<i> &gt; the disk space to hold the volume of cache log generated over that
</I>&gt;<i> &gt; period of time (I have a 60-gb log partition).  If there is some
</I>&gt;<i> &gt; clever way of limiting cache.log and causing it to round-robin or something,
</I>&gt;<i> I'm happy to try things.  Thank you!
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Using the rotate=N option on the debug_options directive will rotate
</I>&gt;<i> cache.log a different (usually smaller) number of times to access.log.
</I>&gt;<i> 
</I>&gt;<i> Or, if you use logrotate you can set it to rotate when the cache.log gets to a
</I>&gt;<i> certain size.
</I>&gt;<i>  see
</I>&gt;<i> &lt;<A HREF="http://stackoverflow.com/questions/20162176/centos-linux-setting-">http://stackoverflow.com/questions/20162176/centos-linux-setting-</A>
</I>&gt;<i> logrotate-to-maximum-file-size-for-all-logs&gt;
</I>&gt;<i> 
</I>&gt;<i> Or, you could also setup the cache.log to be a pipe to somewhere else with
</I>&gt;<i> more disk space.
</I>
I'll dig in, thanks for the ideas.  It sounds like I don't need to work too hard on debug at this time, because it appears to be a well enough known bug.  But, it would be handy to be able to generate usable debug logs without swamping my system so I'll see what I can come up with.  Thank you again!

--Jester


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014081.html">[squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23
</A></li>
	<LI>Next message (by thread): <A HREF="014110.html">[squid-users] Will squid core dump with worker threads? Investigating squid crash, 3.5.23
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14093">[ date ]</a>
              <a href="thread.html#14093">[ thread ]</a>
              <a href="subject.html#14093">[ subject ]</a>
              <a href="author.html#14093">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
