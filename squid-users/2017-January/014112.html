<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connect strongSwan and Squid on same server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connect%20strongSwan%20and%20Squid%20on%20same%20server&In-Reply-To=%3CCABUhpQXoJMHs7NJN7JPuPqTv0BJ%2Bwq8dg6JUN_GOO5XC9jW1pA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014111.html">
   <LINK REL="Next"  HREF="014113.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connect strongSwan and Squid on same server</H1>
    <B>Varun Singh</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connect%20strongSwan%20and%20Squid%20on%20same%20server&In-Reply-To=%3CCABUhpQXoJMHs7NJN7JPuPqTv0BJ%2Bwq8dg6JUN_GOO5XC9jW1pA%40mail.gmail.com%3E"
       TITLE="[squid-users] Connect strongSwan and Squid on same server">varun.singh at gslab.com
       </A><BR>
    <I>Thu Jan 19 10:13:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014111.html">[squid-users] Connect strongSwan and Squid on same server
</A></li>
        <LI>Next message (by thread): <A HREF="014113.html">[squid-users] Users inserted incorrectly in access.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14112">[ date ]</a>
              <a href="thread.html#14112">[ thread ]</a>
              <a href="subject.html#14112">[ subject ]</a>
              <a href="author.html#14112">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Jan 19, 2017 at 2:59 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 19/01/2017 8:00 p.m., Varun Singh wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> I have installed strongSwan and Squid HTTP Proxy on the same Ubuntu
</I>&gt;&gt;<i> 16.04 server and I am trying to connect both. By connect I mean, I am
</I>&gt;&gt;<i> trying to achieve following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [VPN Client] &lt;------&gt; [VPN Server] &lt;-&gt; [Squid] &lt;------&gt; [Internet]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My objective is to connect a VPN client to VPN server and use Squid
</I>&gt;&gt;<i> for filtering out blocked Urls. strongSwan and Squid work fine on
</I>&gt;&gt;<i> their own. I can access internet when connected to VPN server and also
</I>&gt;&gt;<i> when configured HTTP Proxy without VPN.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Is the VPN acting as an interface on the client machine through which
</I>&gt;<i> trafffic is gatewayed?
</I>&gt;<i>  or as a transparent tunnel to the proxy?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> From what I understand, to achieve what I want, I am supposed to
</I>&gt;&gt;<i> redirect incoming HTTP traffic from port 80 to port using IPTables. I
</I>&gt;&gt;<i> enter following IPTables rule:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT
</I>&gt;&gt;<i> --to-port 3128
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What are the squid.conf ports configured as?
</I>&gt;<i>
</I>&gt;&gt;<i> Once I do this and try to access internet from a connected VPN client,
</I>&gt;&gt;<i> I get error. Pasting a log of /var/log/squid/access.log
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> These are explicit-proxy requests (port 3128 syntax):
</I>&gt;<i>
</I>&gt;&gt;<i> 1484738365.632      0 114.143.194.190 TCP_DENIED/403 4066 CONNECT
</I>&gt;&gt;<i> api-glb-sin.smoot.apple.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738365.642      0 114.143.194.190 TCP_DENIED/403 4870 GET
</I>&gt;&gt;<i> <A HREF="http://www.apple.com/ac/globalfooter/2.0/en_US/styles/ac-globalfooter.built.css">http://www.apple.com/ac/globalfooter/2.0/en_US/styles/ac-globalfooter.built.css</A>
</I>&gt;&gt;<i> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738365.643      0 114.143.194.190 TCP_DENIED/403 4852 GET
</I>&gt;&gt;<i> <A HREF="http://www.apple.com/ac/globalnav/2.0/en_US/styles/ac-globalnav.built.css">http://www.apple.com/ac/globalnav/2.0/en_US/styles/ac-globalnav.built.css</A>
</I>&gt;&gt;<i> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738365.731      0 114.143.194.190 TCP_DENIED/403 4753 GET
</I>&gt;&gt;<i> <A HREF="http://www.apple.com/wss/fonts/?">http://www.apple.com/wss/fonts/?</A> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738365.760      0 114.143.194.190 TCP_DENIED/403 4817 GET
</I>&gt;&gt;<i> <A HREF="http://www.apple.com/metrics/ac-analytics/1.1/scripts/ac-analytics.js">http://www.apple.com/metrics/ac-analytics/1.1/scripts/ac-analytics.js</A>
</I>&gt;&gt;<i> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738367.798      0 114.143.194.190 TCP_DENIED/403 4066 CONNECT
</I>&gt;&gt;<i> init.itunes.apple.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738367.922      0 114.143.194.190 TCP_DENIED/403 4334 GET
</I>&gt;&gt;<i> <A HREF="http://www.apple.com/apple-touch-icon-76x76-precomposed.png">http://www.apple.com/apple-touch-icon-76x76-precomposed.png</A> -
</I>&gt;&gt;<i> HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738367.963      0 114.143.194.190 TCP_DENIED/403 4025 CONNECT
</I>&gt;&gt;<i> gsp10-ssl.apple.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738368.036      0 114.143.194.190 TCP_DENIED/403 4298 GET
</I>&gt;&gt;<i> <A HREF="http://www.apple.com/apple-touch-icon-76x76.png">http://www.apple.com/apple-touch-icon-76x76.png</A> - HIER_NONE/-
</I>&gt;&gt;<i> text/html
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What you are expected by to do on Debian and Ubuntu installs is setup
</I>&gt;<i> the &quot;localnet&quot; ACL to be apropriate for your LAN. It is commented out by
</I>&gt;<i> default.
</I>&gt;<i>  Search squid.conf for &quot;#http_access allow localnet&quot; and &quot;#acl localnet&quot;
</I>&gt;<i>
</I>&gt;<i> When that is done the above should work. No NAT needed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> These are origin requests (port 80 syntax):
</I>&gt;<i>
</I>&gt;&gt;<i> 1484738858.272      0 10.99.1.1 TAG_NONE/400 4154 GET
</I>&gt;&gt;<i> /assets/com_apple_MobileAsset_SafariCloudHistoryConfiguration/com_apple_MobileAsset_SafariCloudHistoryConfiguration.xml
</I>&gt;&gt;<i> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738858.990      0 10.99.1.1 TAG_NONE/400 4004 GET
</I>&gt;&gt;<i> /us/shop/bag/status?apikey=SFX9YPYY9PPXCU9KH - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484738860.362      0 10.99.1.1 TAG_NONE/400 5350 GET
</I>&gt;&gt;<i> /b/ss/appleglobal,applehome,applestoreww,applestoreamr,applestoreus/1/H.27/s5505031635984?AQB=1&amp;ndh=1&amp;t=18%2F0%2F2017%2016%3A57%3A40%203%20-330&amp;fid=21A4DCCB11396F92-26B205C305B2B2DF&amp;pageName=apple%20-%20index%2Ftab%20%28us%29&amp;g=http%3A%2F%2Fwww.apple.com%2F&amp;cc=USD&amp;ch=www.us.homepage&amp;server=new%20approach%20ac-analytics&amp;v3=aos%3A%20us&amp;c4=D%3Dg&amp;c5=ipad&amp;c9=ios%209.3.5&amp;c19=aos%3A%20us%3A%20apple%20-%20index%2Ftab%20%28us%29&amp;c20=aos%3A%20us&amp;c25=direct%20entry&amp;c48=4&amp;c49=D%3D2C39962A85032063-4000118780008FDC&amp;v54=http%3A%2F%2Fwww.apple.com%2F&amp;h1=www.us.homepage&amp;s=768x1024&amp;c=32&amp;j=1.6&amp;v=N&amp;k=Y&amp;bw=768&amp;bh=960&amp;AQE=1
</I>&gt;&gt;<i> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484739056.258      0 10.99.1.1 TAG_NONE/400 3918 GET / - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484739056.480      0 10.99.1.1 TCP_DENIED/403 4290 GET
</I>&gt;&gt;<i> <A HREF="http://ip-172-31-9-90:3128/squid-internal-static/icons/SN.png">http://ip-172-31-9-90:3128/squid-internal-static/icons/SN.png</A> -
</I>&gt;&gt;<i> HIER_NONE/- text/html
</I>&gt;&gt;<i> 1484739057.106      0 10.99.1.1 TAG_NONE/400 3994 GET
</I>&gt;&gt;<i> /apple-touch-icon-76x76-precomposed.png - HIER_NONE/- text/html
</I>&gt;<i> &lt;snip&gt;
</I>&gt;<i>
</I>&gt;<i> Notice how both those sets of requests are reaching your proxy properly.
</I>&gt;<i> The VPN is still working just fine.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My /etc/squid/squid.conf file has only one change and that is:
</I>&gt;&gt;<i> http_access allow all
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Where? order and position is important.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You have not added the squid.conf line required for Squid to receive the
</I>&gt;<i> iptables packets from NAT.
</I>&gt;<i>   &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

Thanks. Doing the following solved the problem:
&quot;You have not added the squid.conf line required for Squid to receive the
&gt;<i> iptables packets from NAT.&quot;
</I>
I think that is why Squid was not able to infer the packets received
on port 3128.

-- 
Regards,
Varun

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014111.html">[squid-users] Connect strongSwan and Squid on same server
</A></li>
	<LI>Next message (by thread): <A HREF="014113.html">[squid-users] Users inserted incorrectly in access.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14112">[ date ]</a>
              <a href="thread.html#14112">[ thread ]</a>
              <a href="subject.html#14112">[ subject ]</a>
              <a href="author.html#14112">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
