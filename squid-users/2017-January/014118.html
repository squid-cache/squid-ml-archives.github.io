<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%20OWA&In-Reply-To=%3C1216522442.160455.1484870639800%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014117.html">
   <LINK REL="Next"  HREF="014127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA</H1>
    <B>Vieri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%20OWA&In-Reply-To=%3C1216522442.160455.1484870639800%40mail.yahoo.com%3E"
       TITLE="[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA">rentorbuy at yahoo.com
       </A><BR>
    <I>Fri Jan 20 00:03:59 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014117.html">[squid-users] Squid 3.5.23 is available - Article and new tools by	NgTech
</A></li>
        <LI>Next message (by thread): <A HREF="014127.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14118">[ date ]</a>
              <a href="thread.html#14118">[ thread ]</a>
              <a href="subject.html#14118">[ subject ]</a>
              <a href="author.html#14118">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm trying to set up Squid as a reverse proxy on a host with IP address 10.215.144.91 so that web browsers can connect to it on port 443 and request pages from an OWA server at 10.215.144.21:443.

I have this in my squid.conf:

https_port 10.215.144.91:443 accel cert=/etc/ssl/squid/owa_cert.cer key=/etc/ssl/squid/owa_key.pem defaultsite=webmail2.mydomain.org

cache_peer 10.215.144.21 parent 443 0 no-query originserver login=PASS ssl sslcert=/etc/ssl/squid/client.cer sslkey=/etc/ssl/squid/client_key.pem ssloptions=ALL sslflags=DONT_VERIFY_PEER,DONT_VERIFY_DOMAIN name=owaServer
# cache_peer 10.215.144.21 parent 80 0 no-query originserver login=PASS front-end-https=on name=owaServer

acl OWA dstdomain webmail2.mydomain.org
cache_peer_access owaServer allow OWA
never_direct allow OWA

http_access allow OWA
http_access deny all
miss_access allow OWA
miss_access deny all

Note that if I comment out the &quot;cache_peer parent 443&quot; line above and uncomment the &quot;cache_peer parent 80&quot; line then the web browser client successfully connects and can view the OWA pages after logging in.

However, the connection fails if I use 443 between squid at 10.215.144.91 and the OWA backend at 10.215.144.21. The client views a Squid error page with an SSL handshake error.

Here's the cache log when I try to connect with a client:

2017/01/20 00:10:42.284 kid1| Error negotiating SSL on FD 16: error:00000000:lib(0):func(0):reason(0) (5/0/0)
2017/01/20 00:10:42.284 kid1| TCP connection to 10.215.144.21/443 failed
2017/01/20 00:10:42.285 kid1| 5,5| comm.cc(1038) comm_remove_close_handler: comm_remove_close_handler: FD 16, AsyncCall=0x80d93a00*2
2017/01/20 00:10:42.285 kid1| 9,5| AsyncCall.cc(56) cancel: will not call Ssl::PeerConnector::commCloseHandler [call453] because comm_remove_close_handler
2017/01/20 00:10:42.285 kid1| 17,4| AsyncCall.cc(93) ScheduleCall: PeerConnector.cc(742) will call FwdState::ConnectedToPeer(0x80d8b9f0, local=10.215.144.91:55948 remote=10.215.144.21:443 FD 16 flags=1, 0x809d49a0/0x809d49a0) [call451]
2017/01/20 00:10:42.285 kid1| 93,5| AsyncJob.cc(137) callEnd: Ssl::PeerConnector::negotiateSsl() ends job [ FD 16 job42]
2017/01/20 00:10:42.285 kid1| 83,5| PeerConnector.cc(58) ~PeerConnector: Peer connector 0x80d8b590 gone
2017/01/20 00:10:42.285 kid1| 93,5| AsyncJob.cc(40) ~AsyncJob: AsyncJob destructed, this=0x80d8b5b4 type=Ssl::PeerConnector [job42]
2017/01/20 00:10:42.285 kid1| 17,4| AsyncCallQueue.cc(55) fireNext: entering FwdState::ConnectedToPeer(0x80d8b9f0, local=10.215.144.91:55948 remote=10.215.144.21:443 FD 16 flags=1, 0x809d49a0/0x809d49a0)
2017/01/20 00:10:42.285 kid1| 17,4| AsyncCall.cc(38) make: make call FwdState::ConnectedToPeer [call451]
2017/01/20 00:10:42.285 kid1| 17,3| FwdState.cc(415) fail: ERR_SECURE_CONNECT_FAIL &quot;Service Unavailable&quot;
<A HREF="https://webmail2.mydomain.org/Exchange2/">https://webmail2.mydomain.org/Exchange2/</A>
2017/01/20 00:10:42.285 kid1| TCP connection to 10.215.144.21/443 failed

I don't understand the &quot;Service Unavailable&quot; bit above.
I can connect just fine from the command line on the squid server at 10.215.144.91 as you can see below.

# wget --no-check-certificate -O -  <A HREF="https://10.215.144.21">https://10.215.144.21</A> 
--2017-01-20 00:41:10--  <A HREF="https://10.215.144.21/">https://10.215.144.21/</A>
Connecting to 10.215.144.21:443... connected.
WARNING: cannot verify 10.215.144.21's certificate, issued by '/C=xx/ST=xx/O=xx/OU=xx/CN=xxx/emailAddress=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">xx at xx.xxx</A>':
Unable to locally verify the issuer's authority.
WARNING: certificate common name 'XYZ' doesn't match requested host name '10.215.144.21'.
HTTP request sent, awaiting response... 200 OK
Length: 1546 (1.5K) [text/html]

What can I try?

Thanks,

Vieri

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014117.html">[squid-users] Squid 3.5.23 is available - Article and new tools by	NgTech
</A></li>
	<LI>Next message (by thread): <A HREF="014127.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14118">[ date ]</a>
              <a href="thread.html#14118">[ thread ]</a>
              <a href="subject.html#14118">[ subject ]</a>
              <a href="author.html#14118">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
