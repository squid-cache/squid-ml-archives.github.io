<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3Ccdea0afa-c2a2-23c4-dbac-553a565e83f7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014118.html">
   <LINK REL="Next"  HREF="014129.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3Ccdea0afa-c2a2-23c4-dbac-553a565e83f7%40treenet.co.nz%3E"
       TITLE="[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jan 20 09:13:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014118.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
        <LI>Next message (by thread): <A HREF="014129.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14127">[ date ]</a>
              <a href="thread.html#14127">[ thread ]</a>
              <a href="subject.html#14127">[ subject ]</a>
              <a href="author.html#14127">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/01/2017 1:03 p.m., Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to set up Squid as a reverse proxy on a host with IP address 10.215.144.91 so that web browsers can connect to it on port 443 and request pages from an OWA server at 10.215.144.21:443.
</I>&gt;<i> 
</I>&gt;<i> I have this in my squid.conf:
</I>&gt;<i> 
</I>&gt;<i> https_port 10.215.144.91:443 accel cert=/etc/ssl/squid/owa_cert.cer key=/etc/ssl/squid/owa_key.pem defaultsite=webmail2.mydomain.org
</I>&gt;<i> 
</I>&gt;<i> cache_peer 10.215.144.21 parent 443 0 no-query originserver login=PASS ssl sslcert=/etc/ssl/squid/client.cer sslkey=/etc/ssl/squid/client_key.pem ssloptions=ALL sslflags=DONT_VERIFY_PEER,DONT_VERIFY_DOMAIN name=owaServer
</I>&gt;<i> # cache_peer 10.215.144.21 parent 80 0 no-query originserver login=PASS front-end-https=on name=owaServer
</I>&gt;<i> 
</I>
The ssloptions and sslflags values are bad for debugging.
 * The ssloptions=ALL may be adding unknown new issues OWA does not like
from all the insecure things it turns on in Squids TLS handshake.
 * The sslflags disabling verify actions is hiding from you any issues
Squid will have with the OWA handshake security settings.

Knowing what all that hidden stuff does is important to finding the
right fixes or workarounds.



&gt;<i> acl OWA dstdomain webmail2.mydomain.org
</I>&gt;<i> cache_peer_access owaServer allow OWA
</I>&gt;<i> never_direct allow OWA
</I>&gt;<i> 
</I>&gt;<i> http_access allow OWA
</I>&gt;<i> http_access deny all
</I>&gt;<i> miss_access allow OWA
</I>&gt;<i> miss_access deny all
</I>
The miss_access is not useful. Your earlier *_access rules already
prevent the unwanted things happening.

&gt;<i> 
</I>&gt;<i> Note that if I comment out the &quot;cache_peer parent 443&quot; line above and uncomment the &quot;cache_peer parent 80&quot; line then the web browser client successfully connects and can view the OWA pages after logging in.
</I>&gt;<i> 
</I>&gt;<i> However, the connection fails if I use 443 between squid at 10.215.144.91 and the OWA backend at 10.215.144.21. The client views a Squid error page with an SSL handshake error.
</I>&gt;<i> 
</I>&gt;<i> Here's the cache log when I try to connect with a client:
</I>&gt;<i> 
</I>&gt;<i> 2017/01/20 00:10:42.284 kid1| Error negotiating SSL on FD 16: error:00000000:lib(0):func(0):reason(0) (5/0/0)
</I>&gt;<i> 2017/01/20 00:10:42.284 kid1| TCP connection to 10.215.144.21/443 failed
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 5,5| comm.cc(1038) comm_remove_close_handler: comm_remove_close_handler: FD 16, AsyncCall=0x80d93a00*2
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 9,5| AsyncCall.cc(56) cancel: will not call Ssl::PeerConnector::commCloseHandler [call453] because comm_remove_close_handler
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 17,4| AsyncCall.cc(93) ScheduleCall: PeerConnector.cc(742) will call FwdState::ConnectedToPeer(0x80d8b9f0, local=10.215.144.91:55948 remote=10.215.144.21:443 FD 16 flags=1, 0x809d49a0/0x809d49a0) [call451]
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 93,5| AsyncJob.cc(137) callEnd: Ssl::PeerConnector::negotiateSsl() ends job [ FD 16 job42]
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 83,5| PeerConnector.cc(58) ~PeerConnector: Peer connector 0x80d8b590 gone
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 93,5| AsyncJob.cc(40) ~AsyncJob: AsyncJob destructed, this=0x80d8b5b4 type=Ssl::PeerConnector [job42]
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 17,4| AsyncCallQueue.cc(55) fireNext: entering FwdState::ConnectedToPeer(0x80d8b9f0, local=10.215.144.91:55948 remote=10.215.144.21:443 FD 16 flags=1, 0x809d49a0/0x809d49a0)
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 17,4| AsyncCall.cc(38) make: make call FwdState::ConnectedToPeer [call451]
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| 17,3| FwdState.cc(415) fail: ERR_SECURE_CONNECT_FAIL &quot;Service Unavailable&quot;
</I>&gt;<i> <A HREF="https://webmail2.mydomain.org/Exchange2/">https://webmail2.mydomain.org/Exchange2/</A>
</I>&gt;<i> 2017/01/20 00:10:42.285 kid1| TCP connection to 10.215.144.21/443 failed
</I>&gt;<i> 
</I>&gt;<i> I don't understand the &quot;Service Unavailable&quot; bit above.
</I>
It is Squid telling the client it cannot proxy the request. Because the
cache_peer failed. Just one of the symptoms of whatever the problem is.

The key part is the &quot;Error negotiating SSL on FD 16:
error:00000000:lib(0):func(0):reason(0) (5/0/0)&quot;

Which is OpenSSL's very obtuse way of telling Squid &quot;an error
rhappened&quot;. With no helpful details about what error it was.

&gt;<i> I can connect just fine from the command line on the squid server at 10.215.144.91 as you can see below.
</I>&gt;<i> 
</I>&gt;<i> # wget --no-check-certificate -O -  <A HREF="https://10.215.144.21">https://10.215.144.21</A> 
</I>&gt;<i> --2017-01-20 00:41:10--  <A HREF="https://10.215.144.21/">https://10.215.144.21/</A>
</I>&gt;<i> Connecting to 10.215.144.21:443... connected.
</I>&gt;<i> WARNING: cannot verify 10.215.144.21's certificate, issued by '/C=xx/ST=xx/O=xx/OU=xx/CN=xxx/emailAddress=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">xx at xx.xxx</A>':
</I>&gt;<i> Unable to locally verify the issuer's authority.
</I>&gt;<i> WARNING: certificate common name 'XYZ' doesn't match requested host name '10.215.144.21'.
</I>
Firstly remove the ssloptions=ALL from your config.

Traffic should be able to go through at that point. But dont take that
as &quot;working&quot;, the TLS layer is not in any way secure yet.
 - if not try the front-end-https setting I mentioned earlier.

Then add a sslcafile= option to tell Squid the CA cert which signed the
OWA servers certificate.

Then remove the sslflags option. Traffic should stay working with that.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014118.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
	<LI>Next message (by thread): <A HREF="014129.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14127">[ date ]</a>
              <a href="thread.html#14127">[ thread ]</a>
              <a href="subject.html#14127">[ subject ]</a>
              <a href="author.html#14127">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
