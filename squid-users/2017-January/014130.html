<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.23 memory usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.23%20memory%20usage&In-Reply-To=%3Caf672811-ac6f-3d88-db09-6a0e3e712e79%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014120.html">
   <LINK REL="Next"  HREF="014121.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.23 memory usage</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.23%20memory%20usage&In-Reply-To=%3Caf672811-ac6f-3d88-db09-6a0e3e712e79%40treenet.co.nz%3E"
       TITLE="[squid-users] squid 3.5.23 memory usage">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jan 20 09:51:48 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014120.html">[squid-users] squid 3.5.23 memory usage
</A></li>
        <LI>Next message (by thread): <A HREF="014121.html">[squid-users] Dst and dstdomain ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14130">[ date ]</a>
              <a href="thread.html#14130">[ thread ]</a>
              <a href="subject.html#14130">[ subject ]</a>
              <a href="author.html#14130">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/01/2017 1:23 p.m., Ivan Larionov wrote:
&gt;<i> Hello.
</I>&gt;<i> 
</I>&gt;<i> I'm pretty sure this question has been asked multiple times already, but
</I>&gt;<i> after reading everything I found I still can't figure out squid memory
</I>&gt;<i> usage patterns.
</I>&gt;<i> 
</I>&gt;<i> We're currently trying to upgrade from squid 2.7 to squid 3.5 and memory
</I>&gt;<i> usage on squid 3 is much much higher compared to squid 2 with the same
</I>&gt;<i> configuration.
</I>
One thing to be aware of with this big step in versions is that 3.x has
a lot more things 64-bit enabled where 2.x was more 32-bit oriented. It
is minor in any one place, but does add up when dealing with large
numbers of objects.


&gt;<i> 
</I>&gt;<i> What do I see:
</I>&gt;<i> 
</I>&gt;<i> squid running for several days with low traffic:
</I>&gt;<i> 
</I>&gt;<i> # top
</I>&gt;<i>  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
</I>&gt;<i>  7367 squid     20   0 4780m 4.4g 5224 S  6.0 60.6 105:01.76 squid -N
</I>&gt;<i> 
</I>&gt;<i> So it uses 4.4GB resident memory. Ok, let's see important config options:
</I>&gt;<i> 
</I>&gt;<i> cache_mem 2298756 KB
</I>&gt;<i> maximum_object_size_in_memory 8 KB
</I>&gt;<i> memory_replacement_policy lru
</I>&gt;<i> cache_replacement_policy lru
</I>&gt;<i> 
</I>&gt;<i> cache_dir aufs /mnt/services/squid/cache 445644 16 256
</I>&gt;<i> 
</I>&gt;<i> minimum_object_size 64 bytes # none-zero so we dont cache mistakes
</I>&gt;<i> maximum_object_size 102400 KB
</I>&gt;<i> 
</I>&gt;<i> So we configured 2.2GB memory cache and 500GB disk cache. Disk cache is
</I>&gt;<i> quite big but current usage is only 3GB:
</I>&gt;<i> 
</I>&gt;<i> # du -sh /mnt/services/squid/cache # cache_dir
</I>&gt;<i> 3.0G  /mnt/services/squid/cache
</I>&gt;<i> 
</I>&gt;<i> Now I'm looking into this page
</I>&gt;<i> <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidMemory">http://wiki.squid-cache.org/SquidFaq/SquidMemory</A> and see:
</I>&gt;<i> 
</I>&gt;<i> 14 MB of memory per 1 GB on disk for 64-bit Squid
</I>&gt;<i> 
</I>
These wiki numbers are based on an average object size of 32KB.

By setting &quot;maximum_object_size_in_memory 8 KB&quot; you reduce that by 3x so
need to multiply the overhead per object by (3x more objects in same
space) for the cache_mem value to get a better estimate.

So,
 ... up to 100 MB of index for cache_mem
 ... up to 6 GB of index for cache_dir

Another difference is the buffers in Squid-3 are a bit bigger than those
used for Squid-2. Up to 256 KB per FD (Squid-2 stopped at 64KB).
 BUT, your pool details below show only the 16KB buffer being used much.
So I doubt it is client connections related.



&gt;<i> Which means disk cache should use ~50MB of RAM.
</I>&gt;<i> 
</I>&gt;<i> All these means we have ~2.2GB ram used for everything else except
</I>&gt;<i> cache_mem and disk cache index.
</I>
No, the index is also in that 2.2 GB which is not being used by the
cache_mem.


&gt;<i> 
</I>&gt;<i> Let's see top pools from mgr:mem:
</I>&gt;<i> 
</I>&gt;<i> Pool                  (KB)     %Tot
</I>&gt;<i> mem_node              2298833  55.082
</I>&gt;<i> Short Strings         622365   14.913
</I>&gt;<i> HttpHeaderEntry       404531   9.693
</I>&gt;<i> Long Strings          284520   6.817
</I>&gt;<i> MemObject             182288   4.368
</I>&gt;<i> HttpReply             155612   3.729
</I>&gt;<i> StoreEntry            73965    1.772
</I>&gt;<i> Medium Strings        71152    1.705
</I>&gt;<i> cbdata MemBuf (12)    35573    0.852
</I>&gt;<i> LRU policy node       30403    0.728
</I>&gt;<i> MD5 digest            11380    0.273
</I>&gt;<i> 16K Buffer            1056     0.025
</I>&gt;<i> 
</I>&gt;<i> These pools consume ~35% of total squid memory usage: Short Strings,
</I>&gt;<i> HttpHeaderEntry, Long Strings, HttpReply. Looks suspicious. On squid 2 same
</I>&gt;<i> pools use 10 times less memory.
</I>

The mem_node is the cache_mem space itself, plus active transactions data.

The StoreEntry is the index entry for each object (cache_dir, cache_mem
and in-transit).
The MemObject is the index entry for each in-memory object (cache_mem
and in-transit).
The HttpReply are those cached objects in parsed format.
The HttpHeaderEntry are all the headers in those reply objects.
The various Strings are the individual words/lines etc in those headers.

So we are under 1% values by the time we are done eliminating data
stored in cache_mem objects and active transaction data.


&gt;<i> 
</I>&gt;<i> I found a bug which looks similar to our experience:
</I>&gt;<i> <A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4084.">http://bugs.squid-cache.org/show_bug.cgi?id=4084.</A>
</I>&gt;<i> 
</I>
Since you have configured your cache_mem to be 2.2 GB and total memory
usage is 4.4 GB the report saying 55% of memory is used for mem_node
looks fine to me. 50% of 4.4 GB is your 2.2 GB cache_mem setting, and
the extra 5% is probably active transactions and maybe some nodes for
the cache_dir data.

So I dont think it is the issue I mentioned in comments 8.
That said we have not fully identified what the bug problem was.


&gt;<i> I'm attaching our config, mgr:info, mgr:mem and some system info I
</I>&gt;<i> collected.
</I>&gt;<i> 
</I>&gt;<i> Could someone say if this is normal and why it's so much different from
</I>&gt;<i> squid 2?
</I>&gt;<i> 
</I>
Well, tentatively yes. The Squid-3 numbers all looks reasonably
accurate. So there is no obvious sign of any problem from this one point
in time.

But if it worries you keep an eye on it for a week or so and see if
anything starts to skew. Graphs like Martin had in comment 5 on that bug
report would be a good indicator of whether there is a problem or just a
new &quot;normal&quot; level.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014120.html">[squid-users] squid 3.5.23 memory usage
</A></li>
	<LI>Next message (by thread): <A HREF="014121.html">[squid-users] Dst and dstdomain ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14130">[ date ]</a>
              <a href="thread.html#14130">[ thread ]</a>
              <a href="subject.html#14130">[ subject ]</a>
              <a href="author.html#14130">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
