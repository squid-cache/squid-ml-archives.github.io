<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Dst and dstdomain ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Dst%20and%20dstdomain%20ACLs&In-Reply-To=%3C1484921981.4054934.854050648.71FEFBE0%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014125.html">
   <LINK REL="Next"  HREF="014141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Dst and dstdomain ACLs</H1>
    <B>creditu at eml.cc</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Dst%20and%20dstdomain%20ACLs&In-Reply-To=%3C1484921981.4054934.854050648.71FEFBE0%40webmail.messagingengine.com%3E"
       TITLE="[squid-users] Dst and dstdomain ACLs">creditu at eml.cc
       </A><BR>
    <I>Fri Jan 20 14:19:41 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014125.html">[squid-users] Dst and dstdomain ACLs
</A></li>
        <LI>Next message (by thread): <A HREF="014141.html">[squid-users] Dst and dstdomain ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14134">[ date ]</a>
              <a href="thread.html#14134">[ thread ]</a>
              <a href="subject.html#14134">[ subject ]</a>
              <a href="author.html#14134">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jan 20, 2017, at 01:42 AM, Amos Jeffries wrote:
&gt;<i> On 20/01/2017 3:01 p.m., creditu wrote:
</I>&gt;<i> &gt; Had a question about dst and dstdomain acls.  Given the sample below:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port 192.168.100.1:80 accel defaultsite=www.example.com vhost
</I>&gt;<i> &gt; acl www dstdomain www.example.com dev.example.com
</I>&gt;<i> &gt; cache_peer 10.10.10.1 parent 80 0 no-query no-digest originserver
</I>&gt;<i> &gt; round-robin
</I>&gt;<i> &gt; cache_peer_access 10.10.10.1 allow www
</I>&gt;<i> &gt; cache_peer_access 10.10.10.1 deny all
</I>&gt;<i> &gt; .......
</I>&gt;<i> &gt; http_access allow www
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; When someone tries to access the site by specifying an IP
</I>&gt;<i> &gt; (192.168.100.1) instead of the name the client gets a standard access
</I>&gt;<i> &gt; denied squid page.
</I>&gt;<i> 
</I>&gt;<i> What is the rDNS for 192.168.100.1 ?
</I>
Shoot and thanks.  It's a rDNS issue.  We were using vport in a previous
config and it may have not been noticed because of that.

&gt;<i> 
</I>&gt;<i> The dstdomain you have configured only the exact two domains listed to
</I>&gt;<i> match.
</I>&gt;<i> 
</I>&gt;<i> &gt;  It seems that a separate acl needs to be defined for
</I>&gt;<i> &gt; when someone tries to access the site using an IP?  For instance:
</I>&gt;<i> &gt; acl dst www_ip 192.168.100.1
</I>&gt;<i> 
</I>&gt;<i> You could add the raw-IP to the www ACL:
</I>&gt;<i>  acl www dstdomain -n 192.168.100.1
</I>&gt;<i> 
</I>&gt;<i>  ... but what will 10.10.10.1 do when asked for the site hosted at
</I>&gt;<i> 192.168.100.1 ?
</I>
10.10.10.1 doesn't allow it, so might as well stop at squid. So, is the
best way be to create an ACL and deny cache peer access then do
something with deny info?  Something like:

acl dstdomain -n 192.168.100.1
cache_peer_access 10.10.10.1 deny www_ip
....
deny_info <A HREF="http://....">http://....</A> www_ip
http_access deny www_ip

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; If we wanted to pass to the backend we would need to add a extra
</I>&gt;<i> &gt; cache_peer_access statement
</I>&gt;<i> &gt;  cache_peer_access 10.10.10.1 allow www_ip
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Then add:
</I>&gt;<i> &gt; http_access allow www_ip
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Is that correct?
</I>&gt;<i> 
</I>&gt;<i> Not for matching raw-IP. The dst will match also for any domain name
</I>&gt;<i> that resolves to the IP given.
</I>&gt;<i> 
</I>&gt;<i> If you want an ACL that matches the textual representation of the raw-IP
</I>&gt;<i> you need to use dsdomain with the -n (no DNS lookup) flag, or the
</I>&gt;<i> dstdom_regex type.
</I>&gt;<i> 
</I>&gt;<i> &gt;  If we wanted to not allow IP based requests we would
</I>&gt;<i> &gt; still define the acl and use a http_access deny www_ip  and then use
</I>&gt;<i> &gt; deny_info to redirect or send a TCP Reset?
</I>&gt;<i> 
</I>&gt;<i> That is another way, and somewhat better than just accepting the raw-IP
</I>&gt;<i> URLs to the backend server.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014125.html">[squid-users] Dst and dstdomain ACLs
</A></li>
	<LI>Next message (by thread): <A HREF="014141.html">[squid-users] Dst and dstdomain ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14134">[ date ]</a>
              <a href="thread.html#14134">[ thread ]</a>
              <a href="subject.html#14134">[ subject ]</a>
              <a href="author.html#14134">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
