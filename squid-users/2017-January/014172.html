<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.x: Intermediate certificates downloader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3C03abbc4e-79a7-6388-782f-c94d3c1333c9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014170.html">
   <LINK REL="Next"  HREF="014177.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.x: Intermediate certificates downloader</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3C03abbc4e-79a7-6388-782f-c94d3c1333c9%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 4.x: Intermediate certificates downloader">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan 23 18:06:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014170.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
        <LI>Next message (by thread): <A HREF="014177.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14172">[ date ]</a>
              <a href="thread.html#14172">[ thread ]</a>
              <a href="subject.html#14172">[ subject ]</a>
              <a href="author.html#14172">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/23/2017 10:41 AM, Yuri Voinov wrote:
&gt;<i> 23.01.2017 23:31, Alex Rousskov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> On 01/23/2017 04:28 AM, Yuri wrote:
</I>&gt;&gt;&gt;<i> I.e., where downloaded certs stored, how it
</I>&gt;&gt;&gt;<i> handles, does it saves anywhere to disk?
</I>
&gt;&gt;<i> Missing certificates are fetched using HTTP[S]. Certificate responses
</I>&gt;&gt;<i> should be treated as any other HTTP[S] responses with regard to caching.
</I>&gt;&gt;<i> For example, if you have disk caching enabled and your caching rules
</I>&gt;&gt;<i> (including defaults) allow certificate response caching, then the
</I>&gt;&gt;<i> response should be cached. Similarly, the cached certificate will
</I>&gt;&gt;<i> eventually be evicted from the cache following regular cache maintenance
</I>&gt;&gt;<i> rules. When that happens, Squid will try to fetch the certificate again
</I>&gt;&gt;<i> (if it becomes needed again).
</I>
&gt;<i> I.e., fetchesd intermediate certificate stores only in memory cache for
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
</I>&gt;<i> /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> daemon, right? And never stores anywhere on disk?
</I>
No, this is incorrect -- sslcrtd_program settings are independent from
fetching missing certificates. The ssl_crtd helper is about fake
certificate generation. The helper does not use the Squid cache to cache
its results. The &quot;missing certificates&quot; features are about the virgin
server certificates that are necessary to complete/validate the server
chain but absent from the server's ServerHello response.

The only relationship between the ssl_crtd helper and fetching of the
missing certificates (that I can think of) is that the helper will mimic
the fetched certificates (in some cases). However, I am not even sure
whether the helper gets the virgin incomplete certificate chain or the
completed-by-Squid certificate chain in such cases. I only suspect that
it is the latter. @Christos, please correct me if my suspicion is wrong.


&gt;&gt;&gt;<i> 2. How this feature is related to sslproxy_foreign_intermediate_certs,
</I>&gt;&gt;&gt;<i> how it can interfere with it?
</I>&gt;&gt;<i> AFAICT by looking at the code, Squid only downloads certificates that
</I>&gt;&gt;<i> Squid is missing when trying to build a complete certificate chain for a
</I>&gt;&gt;<i> given server connection. Any sslproxy_foreign_intermediate_certs are
</I>&gt;&gt;<i> used as needed during the chain building process (i.e., they are _not_
</I>&gt;&gt;<i> &quot;missing&quot;).
</I>
&gt;<i> Ok, so, this file uses for complete chains, and it contains statically
</I>&gt;<i> added (manually) certs only, right?
</I>
Yes, the sslproxy_foreign_intermediate_certs file is maintained by the
Squid administrator. Squid does not update it.


&gt;<i> I.e., downloader should not save fetched intermediate CA's here,
</I>
Correct.


&gt;<i> which will be logically, isn't it?
</I>
I believe it is better to use the regular Squid cache for storing the
fetched missing certificates. I would not call abusing the
sslproxy_foreign_intermediate_certs file for this purpose completely
illogical, but such abuse would create more problems than it would solve
IMO. We have also considered using a dedicated storage for the fetched
missing certificates, but have decided (for many reasons) that it would
be worse than reusing the existing caching infrastructure.

FWIW, IMO, storing the generated fake certificates in the regular Squid
cache would also be better than using an OpenSSL-administered database.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014170.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
	<LI>Next message (by thread): <A HREF="014177.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14172">[ date ]</a>
              <a href="thread.html#14172">[ thread ]</a>
              <a href="subject.html#14172">[ subject ]</a>
              <a href="author.html#14172">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
