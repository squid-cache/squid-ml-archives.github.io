<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Native%20FTP%20relay%3A%20connection%20closes%20%28%3F%29%20after%0A%20%27cannot%20assign%20requested%20address%27%20error&In-Reply-To=%3C8d4fc039-bbd8-3a23-cae1-84ff43ff40e6%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014173.html">
   <LINK REL="Next"  HREF="014176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Native%20FTP%20relay%3A%20connection%20closes%20%28%3F%29%20after%0A%20%27cannot%20assign%20requested%20address%27%20error&In-Reply-To=%3C8d4fc039-bbd8-3a23-cae1-84ff43ff40e6%40measurement-factory.com%3E"
       TITLE="[squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan 23 18:41:53 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014173.html">[squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error
</A></li>
        <LI>Next message (by thread): <A HREF="014176.html">[squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14175">[ date ]</a>
              <a href="thread.html#14175">[ thread ]</a>
              <a href="subject.html#14175">[ subject ]</a>
              <a href="author.html#14175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/23/2017 11:11 AM, Alexander wrote:
&gt;<i> Actually, a PASV-handling logic looks a bit strange to me. In
</I>&gt;<i> Ftp::Server::handlePasvReply() there is a comment:
</I>&gt;<i> 
</I>&gt;<i> &quot;In interception setups, we combine remote server address with a local port
</I>&gt;<i> number and hope that traffic will be redirected to us.&quot;
</I>&gt;<i> 
</I>&gt;<i> How is it supposed to work? I do
</I>&gt;<i> not have any idea on how a traffic could be redirected to squid (redirecting
</I>&gt;<i> everything from A to B is not an option).
</I>
You should only redirect FTP traffic, of course. Sorry, I do not know
how you can identify FTP data traffic in your environment, but I am sure
there are tools that can do that in some environments (e.g., by
monitoring FTP 227 responses on the already redirected connections).
There are also some ideas for future work below in case nobody can
suggest anything better.


&gt;<i> Also, why squid needs to intercept a data connection?
</I>
For the same set of reasons Squid needs to intercept everything else --
traffic logging, blocking, and adaptation. If you want Squid to proxy a
&quot;message&quot;, Squid expects to proxy the entire &quot;message&quot;. In FTP, a single
&quot;message&quot; (from high-level point of view) is often split among two or
more connections (from TCP point of view).

Needless to say, your specific needs may differ from that general
principle. It is possible that Squid needs a knob to handle your use
case differently. However, I am pretty sure that somebody does want
Squid to do what it does know so we should not change Squid behavior to
satisfy your use case.


&gt;<i> If I hardcode one of squid's IP in handlePasvReply(), everything works fine.
</I>&gt;<i> However I am not sure if it is a correct way because a client opens a data
</I>&gt;<i> connection not to an FTP server...
</I>
I agree that mixing intercepted [control] and direct [data] connections
is a bad design in general, even if it works in your use case. In many
cases, Squid IP address is not even reachable from the client!
Hopefully, you can find a better way to handle this.

What if you can restrict the set of ports that Squid uses to accept
passive FTP data connections? That way, you can redirect only those data
connections that match those ports. This is not an ideal solution, and
Squid does not support that directly right now, but it might work in
principle.

Another option is to modify Squid to report the expected data connection
IP:ports to some helper so that you can write a script that dynamically
modifies your network redirection rules.

Others may know a better way to handle this (short of deploying an
FTP-aware L7 networking gear).


Cheers,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014173.html">[squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error
</A></li>
	<LI>Next message (by thread): <A HREF="014176.html">[squid-users] Native FTP relay: connection closes (?) after 'cannot assign requested address' error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14175">[ date ]</a>
              <a href="thread.html#14175">[ thread ]</a>
              <a href="subject.html#14175">[ subject ]</a>
              <a href="author.html#14175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
