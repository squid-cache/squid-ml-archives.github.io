<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5B3.5.23%5D%3A%20mozilla.org%20failed%20using%20SSL%0A%20transparent%20SSL23_GET_SERVER_HELLO%3Aunknown%20protocol&In-Reply-To=%3Ce82c7ae4-f16e-63ec-6191-49c57133db8c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014191.html">
   <LINK REL="Next"  HREF="014196.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5B3.5.23%5D%3A%20mozilla.org%20failed%20using%20SSL%0A%20transparent%20SSL23_GET_SERVER_HELLO%3Aunknown%20protocol&In-Reply-To=%3Ce82c7ae4-f16e-63ec-6191-49c57133db8c%40treenet.co.nz%3E"
       TITLE="[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan 24 02:04:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014191.html">[squid-users] [3.5.23]: mozilla.org failed using SSL	transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
        <LI>Next message (by thread): <A HREF="014196.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14194">[ date ]</a>
              <a href="thread.html#14194">[ thread ]</a>
              <a href="subject.html#14194">[ subject ]</a>
              <a href="author.html#14194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/01/2017 2:11 p.m., David Touzeau wrote:
&gt;<i> De :  Amos Jeffries
</I>&gt;<i> 
</I>&gt;<i> On 24/01/2017 12:28 p.m., David Touzeau wrote:
</I>&gt;&gt;<i> Same issue with <A HREF="https://www.digitalocean.com/">https://www.digitalocean.com/</A> is somebody did not
</I>&gt;&gt;<i> encounter the issue using Squid in transparent mode with SSL ??
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> The TLS / HTTP Senvironment is in the process of stabilizing, but still
</I>&gt;<i> quite volatile.
</I>&gt;<i> 
</I>&gt;<i> Since the error message says &quot;unknown protocol&quot; I suspect it is something
</I>&gt;<i> like WebSockets, HTTP/2 or SPDY which you are actually intercepting on port
</I>&gt;<i> 443. Not HTTP/1 which Squid supports.
</I>&gt;<i> 
</I>&gt;<i> Or maybe it is some non-TLS traffic that OpenSSL does not support.
</I>&gt;<i> 
</I>&gt;<i> Mozilla do cert pinning, so teh bump/intercept should probably not work
</I>&gt;<i> anyway. I'm not sure about digitalocean.
</I>&gt;<i> ------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Thanks Amos for the answer but...
</I>&gt;<i> 
</I>&gt;<i> I did not want to bump these sites, only pass trough the squid
</I>&gt;<i> port and process the request without try decrypting the protocol.
</I>
Aye. Sorry I noticed that just after pressing send.

Which means it is probably OpenSSL itself that does not know the
protocol. Could be TLS/1.3, from a big name like Mozilla port 443 is
unlikely to be non-TLS unless somebody upstream of you is doing
something funky for that specific traffic.


&gt;<i> 
</I>&gt;<i> Tried :
</I>&gt;<i> 
</I>&gt;<i> acl nossl dstdomain -i .mozilla.org
</I>&gt;<i> ssl_bump none nossl
</I>&gt;<i> acl ssl_step1 at_step SslBump1
</I>&gt;<i> acl ssl_step2 at_step SslBump2
</I>&gt;<i> acl ssl_step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek ssl_step1
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> or
</I>&gt;<i> 
</I>&gt;<i> acl nossl dst 104.16.40.2
</I>&gt;<i> ssl_bump none nossl
</I>&gt;<i> acl ssl_step1 at_step SslBump1
</I>&gt;<i> acl ssl_step2 at_step SslBump2
</I>&gt;<i> acl ssl_step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek ssl_step1
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> But squid is still unable to process the request.
</I>&gt;<i> 
</I>&gt;<i> Any workaround ?
</I>
Use 'splice' instead of 'none'. Mixing the SSL-Bump feature versions
like that is bad.

Also, what is showing up in your access.log for these transactions? The
ACL deciding not to even peek needs to correcly match the faked CONNECT
request containing only the dst-IP address.


I'm not aware of any other workaround for Squid-3. The
on_unsupported_protocol might be able to handle it in Squid-4.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014191.html">[squid-users] [3.5.23]: mozilla.org failed using SSL	transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
	<LI>Next message (by thread): <A HREF="014196.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14194">[ date ]</a>
              <a href="thread.html#14194">[ thread ]</a>
              <a href="subject.html#14194">[ subject ]</a>
              <a href="author.html#14194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
