<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5B3.5.23%5D%3A%20mozilla.org%20failed%20using%20SSL%0A%20transparent%20SSL23_GET_SERVER_HELLO%3Aunknown%20protocol&In-Reply-To=%3C32d2bc2b-e94e-5d8f-737c-eff69307e390%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014194.html">
   <LINK REL="Next"  HREF="014197.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5B3.5.23%5D%3A%20mozilla.org%20failed%20using%20SSL%0A%20transparent%20SSL23_GET_SERVER_HELLO%3Aunknown%20protocol&In-Reply-To=%3C32d2bc2b-e94e-5d8f-737c-eff69307e390%40measurement-factory.com%3E"
       TITLE="[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan 24 02:54:26 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014194.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
        <LI>Next message (by thread): <A HREF="014197.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14196">[ date ]</a>
              <a href="thread.html#14196">[ thread ]</a>
              <a href="subject.html#14196">[ subject ]</a>
              <a href="author.html#14196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/23/2017 04:28 PM, David Touzeau wrote:
&gt;<i> ssl_bump peek ssl_step1
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> sslproxy_cert_error allow all
</I>

&gt;<i> When connecting to mozilla.org using transparent, we receive this error:
</I>&gt;<i> 
</I>&gt;<i> * About to connect() to www.mozilla.org port 443 (#0)
</I>&gt;<i> *   Trying 104.16.41.2...
</I>&gt;<i> * connected
</I>&gt;<i> * Connected to www.mozilla.org (104.16.41.2) port 443 (#0)
</I>&gt;<i> * successfully set certificate verify locations:
</I>&gt;<i> *   CAfile: none
</I>&gt;<i>   CApath: /etc/ssl/certs
</I>&gt;<i> * SSLv3, TLS handshake, Client hello (1):
</I>&gt;<i> * error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol
</I>&gt;<i> * Closing connection #0
</I>&gt;<i> curl: (35) error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown
</I>&gt;<i> protocol
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> And squid access.log
</I>&gt;<i> 
</I>&gt;<i> 1485110919.564      3 192.168.1.236 TAG_NONE/403 6263 CONNECT
</I>&gt;<i> 104.16.41.2:443 - HIER_NONE/- text/html
</I>
Amos, please note that the above failing test is done using curl, not
some fancy/non-HTTP/websocket traffic from a &quot;browser&quot;.

David, you need to figure out why Squid is denying the intercepted
connection attempt (the /403 part in your access.log). Check your
http_access rules to start with. They were applied to the denied fake
CONNECT request shown above.

AFAICT, Squid denies the [fake] CONNECT without bumping the client
connection to serve a secure error message. That is _not_ what I would
expect because usually Squid bumps to serve errors, even when dealing
with non-bumping ssl_bump rules. However, I may be misinterpreting the
&quot;unknown protocol&quot; part; perhaps OpenSSL can use that phrase for an
unsupported TLS version as well? Or perhaps Squid failed to bump the
client for some reason?

Capture packets to see what Squid is sending to curl.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014194.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
	<LI>Next message (by thread): <A HREF="014197.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14196">[ date ]</a>
              <a href="thread.html#14196">[ thread ]</a>
              <a href="subject.html#14196">[ subject ]</a>
              <a href="author.html#14196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
