<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5B3.5.23%5D%3A%20mozilla.org%20failed%20using%20SSL%0A%20transparent%20SSL23_GET_SERVER_HELLO%3Aunknown%20protocol&In-Reply-To=%3Cbc98a2fe-77f4-2099-c8a1-8e1ada28309e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014197.html">
   <LINK REL="Next"  HREF="014205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5B3.5.23%5D%3A%20mozilla.org%20failed%20using%20SSL%0A%20transparent%20SSL23_GET_SERVER_HELLO%3Aunknown%20protocol&In-Reply-To=%3Cbc98a2fe-77f4-2099-c8a1-8e1ada28309e%40treenet.co.nz%3E"
       TITLE="[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan 24 06:35:29 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014197.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
        <LI>Next message (by thread): <A HREF="014205.html">[squid-users] [3.5.23]: mozilla.org failed using SSL	transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14198">[ date ]</a>
              <a href="thread.html#14198">[ thread ]</a>
              <a href="subject.html#14198">[ subject ]</a>
              <a href="author.html#14198">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On Mon, 2017-01-23 at 19:54 -0700, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 01/23/2017 04:28 PM, David Touzeau wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek ssl_step1
</I>&gt;&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> When connecting to mozilla.org using transparent, we receive this
</I>&gt;&gt;&gt;<i> error:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * About to connect() to www.mozilla.org port 443 (#0)
</I>&gt;&gt;&gt;<i> *   Trying 104.16.41.2...
</I>&gt;&gt;&gt;<i> * connected
</I>&gt;&gt;&gt;<i> * Connected to www.mozilla.org (104.16.41.2) port 443 (#0)
</I>&gt;&gt;&gt;<i> * successfully set certificate verify locations:
</I>&gt;&gt;&gt;<i> *   CAfile: none
</I>&gt;&gt;&gt;<i>   CApath: /etc/ssl/certs
</I>&gt;&gt;&gt;<i> * SSLv3, TLS handshake, Client hello (1):
</I>&gt;&gt;&gt;<i> * error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown
</I>&gt;&gt;&gt;<i> protocol
</I>&gt;&gt;&gt;<i> * Closing connection #0
</I>&gt;&gt;&gt;<i> curl: (35) error:140770FC:SSL
</I>&gt;&gt;&gt;<i> routines:SSL23_GET_SERVER_HELLO:unknown
</I>&gt;&gt;&gt;<i> protocol
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And squid access.log
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1485110919.564      3 192.168.1.236 TAG_NONE/403 6263 CONNECT
</I>&gt;&gt;&gt;<i> 104.16.41.2:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> Amos, please note that the above failing test is done using curl, not
</I>&gt;&gt;<i> some fancy/non-HTTP/websocket traffic from a &quot;browser&quot;.
</I>
Doh! Thats why its weird. The error is coming from curls OpenSSL
library, not Squid's one.


&gt;&gt;<i>
</I>&gt;&gt;<i> David, you need to figure out why Squid is denying the intercepted
</I>&gt;&gt;<i> connection attempt (the /403 part in your access.log). Check your
</I>&gt;&gt;<i> http_access rules to start with. They were applied to the denied fake
</I>&gt;&gt;<i> CONNECT request shown above.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AFAICT, Squid denies the [fake] CONNECT without bumping the client
</I>&gt;&gt;<i> connection to serve a secure error message. That is _not_ what I
</I>&gt;&gt;<i> would
</I>&gt;&gt;<i> expect because usually Squid bumps to serve errors, even when dealing
</I>&gt;&gt;<i> with non-bumping ssl_bump rules. However, I may be misinterpreting
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> &quot;unknown protocol&quot; part; perhaps OpenSSL can use that phrase for an
</I>&gt;&gt;<i> unsupported TLS version as well? Or perhaps Squid failed to bump the
</I>&gt;&gt;<i> client for some reason?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Capture packets to see what Squid is sending to curl.
</I>&gt;&gt;<i>
</I>

On 24/01/2017 4:15 p.m., James Lay wrote:
&gt;<i> Seems like pretty standard stuff:
</I>&gt;<i> Jan 23 20:09:04 (squid): 192.168.1.109 - - [23/Jan/2017:20:09:04 -0700]
</I>&gt;<i> &quot;CONNECT 104.16.40.2:443 HTTP/1.1&quot; www.mozilla.org - 200 916167
</I>&gt;<i> TCP_TUNNEL:ORIGINAL_DST
</I>&gt;<i> TLSv12	TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256	secp256r1
</I>&gt;<i> James
</I>
This is a different log trace from David's.

Here Squid is setting up a TUNNEL to the clients original dst-IP,
successfully. Any TLS funky stuff going on for this transaction is done
directly between server and client. Squid's only involvement is to peek
at the Hello messages and record them for its log.

But some of those details (ie the agreed cipher) come from the
ServerHello on successful TLS setup. So I think no errors happened in
that log entries transaction.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014197.html">[squid-users] [3.5.23]: mozilla.org failed using SSL transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
	<LI>Next message (by thread): <A HREF="014205.html">[squid-users] [3.5.23]: mozilla.org failed using SSL	transparent SSL23_GET_SERVER_HELLO:unknown protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14198">[ date ]</a>
              <a href="thread.html#14198">[ thread ]</a>
              <a href="subject.html#14198">[ subject ]</a>
              <a href="author.html#14198">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
