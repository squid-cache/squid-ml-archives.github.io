<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.x: Intermediate certificates downloader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3C42f09caf-ee99-0f5e-b187-7468b736a04d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014217.html">
   <LINK REL="Next"  HREF="014220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.x: Intermediate certificates downloader</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3C42f09caf-ee99-0f5e-b187-7468b736a04d%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 4.x: Intermediate certificates downloader">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan 24 19:10:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014217.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
        <LI>Next message (by thread): <A HREF="014220.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14219">[ date ]</a>
              <a href="thread.html#14219">[ thread ]</a>
              <a href="subject.html#14219">[ subject ]</a>
              <a href="author.html#14219">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/24/2017 11:33 AM, Yuri Voinov wrote:

&gt;&gt;<i> 1485279884.648      0 - TCP_DENIED/403 3574 GET
</I>&gt;&gt;<i> <A HREF="http://repository.certum.pl/ca.cer">http://repository.certum.pl/ca.cer</A> - HIER_NONE/- text/html;charset=utf-8
</I>

&gt;<i> http_access deny !Safe_ports
</I>
Probably does not match -- 80 is a safe port.


&gt;<i> # Instant messengers include
</I>&gt;<i> include &quot;/usr/local/squid/etc/acl.im.include&quot;
</I>
I am guessing these do not match or are irrelevant.


&gt;<i> # Deny CONNECT to other than SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
Does not match. This is a GET request.


&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>
Probably do not match. This is not a cache manager request although I
have not checked how Squid identifies those exactly.


&gt;<i> http_access deny to_localhost
</I>
Does not match. The destination is not localhost.


&gt;<i> # Allow purge from localhost
</I>&gt;<i> http_access allow PURGE localhost
</I>&gt;<i> http_access deny PURGE
</I>
Do not match. This is a GET request, not PURGE.


&gt;<i> # Block torrent files
</I>&gt;<i> acl TorrentFiles rep_mime_type mime-type application/x-bittorrent
</I>&gt;<i> http_reply_access deny TorrentFiles
</I>
Does not match. There was no response [with an application/x-bittorrent
MIME type].


&gt;<i> # Windows updates rules
</I>&gt;<i> http_access allow CONNECT wuCONNECT localnet
</I>&gt;<i> http_access allow CONNECT wuCONNECT localhost
</I>
Do not match. This is a GET request, not CONNECT.


&gt;<i> http_access allow windowsupdate localnet
</I>&gt;<i> http_access allow windowsupdate localhost
</I>
Probably do not match. The internal transaction is not associated with a
to-Squid connection coming from localnet or localhost.


&gt;<i> # Rule allowing access from local networks
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>
Probably do not match. The internal transaction is not associated with a
to-Squid connection coming from localnet or localhost.


&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>
Matches!


&gt;<i> I have no idea, what can block access.
</I>
That much was clear from the time you asked the question. I bet your
last http_access rule that denies all other connection matches, but I
would still ask Squid. Squid knows why it blocks (or does not allow)
access. There are several ways to ask Squid, including increasing
debugging verbosity when reproducing the problem, adding the matching
ACL to the error message, using custom error messages for different
http_access deny lines, etc.

These methods are not easy, pleasant, quick, or human-friendly,
unfortunately, but you are a very capable sysadmin with more than enough
Squid knowledge to find the blocking directive/ACL, especially for a
problem that can be isolated to two HTTP transactions.

Once we know what directive/ACL blocks, we may be able to figure out a
workaround, propose a bug fix, etc. For example, if my guess is correct
-- the &quot;deny all&quot; rule has matched -- then you would need to add a rule
to allow internal requests, including the ones that fetch those missing
certificates.


HTH,

Alex.


&gt;<i> 25.01.2017 0:27, Alex Rousskov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> On 01/24/2017 11:19 AM, Yuri Voinov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It is downloads directly via proxy from localhost:
</I>&gt;&gt;&gt;<i> As I understand, downloader also access via localhost, right? 
</I>&gt;&gt;<i> This is incorrect. Downloader does not have a concept of an HTTP client
</I>&gt;&gt;<i> which sends the request to Squid so &quot;via localhost&quot; or &quot;via any client
</I>&gt;&gt;<i> source address&quot; does not apply to Downloader transactions. In other
</I>&gt;&gt;<i> words, there is no client [source address] for Downloader requests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Unfortunately, I do not know exactly what effect that lack of info has
</I>&gt;&gt;<i> on what ACLs (in part because there are too many of them and because
</I>&gt;&gt;<i> lack of info is often treated inconsistently by various ACLs). Thus, I
</I>&gt;&gt;<i> continue to recommend finding out which directive/ACL denied Downloader
</I>&gt;&gt;<i> access as the first step.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 25.01.2017 0:16, Alex Rousskov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;&gt;<i> On 01/24/2017 10:48 AM, Yuri Voinov wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> It seems 4.0.17 tries to download certs but gives deny somewhere.
</I>&gt;&gt;&gt;&gt;&gt;<i> However, same URL with wget via same proxy works
</I>&gt;&gt;&gt;&gt;&gt;<i> Why?
</I>&gt;&gt;&gt;&gt;<i> Most likely, your http_access or similar rules deny internal download
</I>&gt;&gt;&gt;&gt;<i> transactions but allow external ones. This is possible, for example, if
</I>&gt;&gt;&gt;&gt;<i> your access rules use client information. Internal transactions (ESI,
</I>&gt;&gt;&gt;&gt;<i> missing certificate fetching, Cache Digests, etc.) do not have an
</I>&gt;&gt;&gt;&gt;<i> associated client.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The standard denial troubleshooting procedure applies here: Start with
</I>&gt;&gt;&gt;&gt;<i> finding out which directive/ACL denies access. I am _not_ implying that
</I>&gt;&gt;&gt;&gt;<i> this is easy to do.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014217.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
	<LI>Next message (by thread): <A HREF="014220.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14219">[ date ]</a>
              <a href="thread.html#14219">[ thread ]</a>
              <a href="subject.html#14219">[ subject ]</a>
              <a href="author.html#14219">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
