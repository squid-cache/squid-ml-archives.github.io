<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.x: Intermediate certificates downloader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3Cc1090b61-7bad-5940-c5d9-10eb829cc595%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014220.html">
   <LINK REL="Next"  HREF="014225.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.x: Intermediate certificates downloader</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3Cc1090b61-7bad-5940-c5d9-10eb829cc595%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 4.x: Intermediate certificates downloader">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan 24 20:50:11 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014220.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
        <LI>Next message (by thread): <A HREF="014225.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14224">[ date ]</a>
              <a href="thread.html#14224">[ thread ]</a>
              <a href="subject.html#14224">[ subject ]</a>
              <a href="author.html#14224">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/24/2017 12:20 PM, Yuri Voinov wrote:
&gt;<i> 25.01.2017 1:10, Alex Rousskov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i> On 01/24/2017 11:33 AM, Yuri Voinov wrote:
</I>
&gt;&gt;&gt;<i> http_access deny to_localhost
</I>
&gt;&gt;<i> Does not match. The destination is not localhost.
</I>
&gt;<i> Yes, destination is squid itself. From squid to squid.
</I>
No, not &quot;to squid&quot;: The destination of the request is
<A HREF="http://repository.certum.pl/ca.cer.">http://repository.certum.pl/ca.cer.</A>

As for the &quot;from Squid&quot; part, it is dangerous to think that way because,
in most Squid contexts, &quot;from&quot; applies to the source of the request
_received_ by Squid. In this case, there is no received request at all.

So this transaction is _not_ &quot;from Squid to Squid&quot; in a sense that some
other, regular transaction is &quot;from user X to site Y&quot;.



&gt;&gt;&gt;<i> # And finally deny all other access to this proxy
</I>&gt;&gt;&gt;<i> http_access deny all
</I>
&gt;&gt;<i> Matches!
</I>
&gt;<i> But! This is recommended final deny rule, if I omit it - squid will adds
</I>&gt;<i> it silently by default, like normal firewall!
</I>
Nobody is suggesting to omit this catch-all rule (which you have
confirmed as matching in a follow-up email, thank you). The solution is
to add a new &quot;allow&quot; rule (at least) above this last &quot;deny all&quot; one. In
other words, your configuration is missing an http_access rule to allow
internally-generated requests [to benign destinations].


&gt;<i> I don't know (on first look) special ACL rule to permit internal access
</I>&gt;<i> from squid to squid.
</I>
A short-term hack: I have seen folks successfully solving somewhat
similar problems using a localport ACL with an &quot;impossible&quot; value of
zero. Please try this hack and update this thread if it works for you:

&gt;<i> # Allow ESI, certificate fetching, Cache Digests, etc. internal requests
</I>&gt;<i> # XXX: Sooner or later, this unsupported hack will stop working!
</I>&gt;<i> acl generatedBySquid localport 0
</I>&gt;<i> http_access allow generatedBySquid
</I>

A possible long-term solution: Factory is working on adding support for
the following new ACL which may help solve this and a few other problems:

&gt;<i> 	acl aclname transaction_initiator initiator...
</I>&gt;<i> 	  # Matches transaction's initiator [fast]
</I>&gt;<i> 	  # Supported initiators are:
</I>&gt;<i> 	  #   esi: matches transactions fetching ESI resources
</I>&gt;<i> 	  #   certificate-fetching: matches transactions fetching
</I>&gt;<i> 	  #       a missing intermediate TLS certificate
</I>&gt;<i> 	  #   cache-digest: matches transactions fetching Cache Digests
</I>&gt;<i> 	  #       from a cache_peer
</I>&gt;<i> 	  #   icp: matches icp requests to peers
</I>&gt;<i> 	  #   icmp: matches icmp requests to peers
</I>&gt;<i> 	  #   asn: matches asns db requests
</I>&gt;<i> 	  #   internal: matches any of the above
</I>&gt;<i> 	  #   client: matches transactions containing an HTTP or FTP
</I>&gt;<i> 	  #       client request received at a Squid *_port
</I>&gt;<i> 	  #  all: matches all transactions
</I>&gt;<i> 	  # Multiple initiators are ORed.
</I>
Please note that these are draft specs that are subject to change. We
may not be able to support many of the initiators listed above. We will
support the certificate-fetching initiator though.


&gt;<i> It looks squid blocks own internal access to itself, but
</I>&gt;<i> permits the same request from outside.
</I>
As we discussed earlier, the destination here is not &quot;Squid itself&quot;.
Squid permits transaction with the same destination upon receiving a
request from &quot;outside&quot; because your http_access rules permit such
requests from &quot;outside&quot; while prohibiting transactions that are not
based on &quot;outside&quot; requests.

One aspect that complicates this problem in general is that we cannot
simply allow internally-initiated transactions without an explicit admin
permission because many of them, including the ones that fetch missing
certificates, may go to completely arbitrary destinations (determined by
origin servers, not users). Many admins care about where their Squid
sends requests as much as they care about where their Squid is receiving
the requests from!


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014220.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
	<LI>Next message (by thread): <A HREF="014225.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14224">[ date ]</a>
              <a href="thread.html#14224">[ thread ]</a>
              <a href="subject.html#14224">[ subject ]</a>
              <a href="author.html#14224">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
