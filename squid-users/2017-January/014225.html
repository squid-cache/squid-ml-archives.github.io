<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.x: Intermediate certificates downloader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3Cc48783fd-02ad-d9e7-f2cc-164908dd0293%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014224.html">
   <LINK REL="Next"  HREF="014226.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.x: Intermediate certificates downloader</H1>
    <B>Yuri Voinov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.x%3A%20Intermediate%20certificates%20downloader&In-Reply-To=%3Cc48783fd-02ad-d9e7-f2cc-164908dd0293%40gmail.com%3E"
       TITLE="[squid-users] Squid 4.x: Intermediate certificates downloader">yvoinov at gmail.com
       </A><BR>
    <I>Tue Jan 24 21:11:05 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014224.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
        <LI>Next message (by thread): <A HREF="014226.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14225">[ date ]</a>
              <a href="thread.html#14225">[ thread ]</a>
              <a href="subject.html#14225">[ subject ]</a>
              <a href="author.html#14225">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

25.01.2017 2:50, Alex Rousskov &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> On 01/24/2017 12:20 PM, Yuri Voinov wrote:
</I>&gt;&gt;<i> 25.01.2017 1:10, Alex Rousskov &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;<i> On 01/24/2017 11:33 AM, Yuri Voinov wrote:
</I>&gt;&gt;&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;&gt;<i> Does not match. The destination is not localhost.
</I>&gt;&gt;<i> Yes, destination is squid itself. From squid to squid.
</I>&gt;<i> No, not &quot;to squid&quot;: The destination of the request is
</I>&gt;<i> <A HREF="http://repository.certum.pl/ca.cer.">http://repository.certum.pl/ca.cer.</A>
</I>&gt;<i>
</I>&gt;<i> As for the &quot;from Squid&quot; part, it is dangerous to think that way because,
</I>&gt;<i> in most Squid contexts, &quot;from&quot; applies to the source of the request
</I>&gt;<i> _received_ by Squid. In this case, there is no received request at all.
</I>&gt;<i>
</I>&gt;<i> So this transaction is _not_ &quot;from Squid to Squid&quot; in a sense that some
</I>&gt;<i> other, regular transaction is &quot;from user X to site Y&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> # And finally deny all other access to this proxy
</I>&gt;&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i> Matches!
</I>&gt;&gt;<i> But! This is recommended final deny rule, if I omit it - squid will adds
</I>&gt;&gt;<i> it silently by default, like normal firewall!
</I>&gt;<i> Nobody is suggesting to omit this catch-all rule (which you have
</I>&gt;<i> confirmed as matching in a follow-up email, thank you). The solution is
</I>&gt;<i> to add a new &quot;allow&quot; rule (at least) above this last &quot;deny all&quot; one. In
</I>&gt;<i> other words, your configuration is missing an http_access rule to allow
</I>&gt;<i> internally-generated requests [to benign destinations].
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I don't know (on first look) special ACL rule to permit internal access
</I>&gt;&gt;<i> from squid to squid.
</I>&gt;<i> A short-term hack: I have seen folks successfully solving somewhat
</I>&gt;<i> similar problems using a localport ACL with an &quot;impossible&quot; value of
</I>&gt;<i> zero. Please try this hack and update this thread if it works for you:
</I>&gt;<i>
</I>&gt;&gt;<i> # Allow ESI, certificate fetching, Cache Digests, etc. internal requests
</I>&gt;&gt;<i> # XXX: Sooner or later, this unsupported hack will stop working!
</I>&gt;&gt;<i> acl generatedBySquid localport 0
</I>&gt;&gt;<i> http_access allow generatedBySquid
</I>Sadly, but with this hack squid dies at request:

root @ khorne /patch # wget -S <A HREF="https://yandex.com/company/">https://yandex.com/company/</A>
--2017-01-25 02:53:58--  <A HREF="https://yandex.com/company/">https://yandex.com/company/</A>
Connecting to 127.0.0.1:3128... connected.

2017/01/25 02:53:51 kid1| Accepting SSL bumped HTTP Socket connections
at local=[::]:3128 remote=[::] FD 76 flags=9
FATAL: Received Segment Violation...dying.
2017/01/25 02:54:00 kid1| Closing HTTP(S) port [::]:3126
2017/01/25 02:54:00 kid1| Closing HTTP(S) port [::]:3127
2017/01/25 02:54:00 kid1| Closing HTTP(S) port [::]:3128
2017/01/25 02:54:00 kid1| storeDirWriteCleanLogs: Starting...
2017/01/25 02:54:00 kid1|     65536 entries written so far.
2017/01/25 02:54:00 kid1|    131072 entries written so far.
2017/01/25 02:54:01 kid1|    196608 entries written so far.
2017/01/25 02:54:01 kid1|    262144 entries written so far.
2017/01/25 02:54:01 kid1|    327680 entries written so far.
2017/01/25 02:54:01 kid1|    393216 entries written so far.
2017/01/25 02:54:01 kid1|    458752 entries written so far.
2017/01/25 02:54:01 kid1|    524288 entries written so far.
2017/01/25 02:54:01 kid1|    589824 entries written so far.
2017/01/25 02:54:01 kid1|   Finished.  Wrote 622687 entries.
2017/01/25 02:54:01 kid1|   Took 0.43 seconds (1438401.76 entries/sec).
CPU Usage: 1762.455 seconds = 1490.509 user + 271.946 sys
Maximum Resident Size: 0 KB
Page faults with physical i/o: 0

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">t at 1</A> (<A HREF="https://lists.squid-cache.org/listinfo/squid-users">l at 1</A>) program terminated by signal ABRT (Abort)
0xfffffd7ffe7c362a: __lwp_kill+0x000a:  jae      __lwp_kill+0x18       
[ 0xfffffd7ffe7c3638, .+0xe ]
(dbx)
where                                                                 
current thread: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">t at 1</A>
=&gt;[1] __lwp_kill(0x1, 0x6, 0xffffffffd1df63a0, 0xfffffd7ffe7c3f1e, 0x0,
0xfffffd7ffe823c80), at 0xfffffd7ffe7c362a
  [2] _thr_kill(), at 0xfffffd7ffe7bbf23
  [3] raise(), at 0xfffffd7ffe7681c9
  [4] abort(), at 0xfffffd7ffe746bc0
  [5] death(), at 0x6f463d
  [6] __sighndlr(), at 0xfffffd7ffe7bde26
  [7] call_user_handler(), at 0xfffffd7ffe7b26f2
  [8] sigacthandler(), at 0xfffffd7ffe7b291e
  ---- called from signal handler with signal 11 (SIGSEGV) ------
  [9] Ip::Qos::doTosLocalHit(), at 0x7d800e
  [10] clientReplyContext::doGetMoreData(), at 0x5d3009
  [11] clientReplyContext::identifyFoundObject(), at 0x5d323c
  [12] clientReplyContext::created(), at 0x5d3a45
  [13] StoreEntry::getPublicByRequest(), at 0x6cae49
  [14] clientStreamRead(), at 0x5edcc4
  [15] ClientHttpRequest::httpStart(), at 0x5d917e
  [16] ClientHttpRequest::processRequest(), at 0x5db570
  [17] ClientHttpRequest::doCallouts(), at 0x5dd1be
  [18] ACLChecklist::checkCallback(), at 0x76224a
  [19] ClientHttpRequest::doCallouts(), at 0x5ddd69
  [20] ClientRequestContext::clientStoreIdDone(), at 0x5e33bf
  [21] 0x5e3810(), at 0x5e3810
  [22] ACLChecklist::checkCallback(), at 0x76224a
  [23] ClientRequestContext::clientStoreIdStart(), at 0x5d8f78
  [24] ClientHttpRequest::doCallouts(), at 0x5dda59
  [25] ClientRequestContext::clientAccessCheckDone(), at 0x5e15b4
  [26] ClientRequestContext::clientAccessCheck2(), at 0x5e2318
  [27] ClientHttpRequest::doCallouts(), at 0x5dd8ec
  [28] ClientRequestContext::clientRedirectDone(), at 0x5e296b
  [29] 0x6b35dd(), at 0x6b35dd
  [30] 0x638393(), at 0x638393
  [31] AsyncCall::make(), at 0x7c0579
  [32] AsyncCallQueue::fireNext(), at 0x7c4cf3
  [33] AsyncCallQueue::fire(), at 0x7c508a
  [34] EventLoop::runOnce(), at 0x612229
  [35] EventLoop::run(), at 0x612348
  [36] SquidMain(), at 0x683518
  [37] main(), at 0x937f3c

&gt;<i>
</I>&gt;<i> A possible long-term solution: Factory is working on adding support for
</I>&gt;<i> the following new ACL which may help solve this and a few other problems:
</I>&gt;<i>
</I>&gt;&gt;<i> 	acl aclname transaction_initiator initiator...
</I>&gt;&gt;<i> 	  # Matches transaction's initiator [fast]
</I>&gt;&gt;<i> 	  # Supported initiators are:
</I>&gt;&gt;<i> 	  #   esi: matches transactions fetching ESI resources
</I>&gt;&gt;<i> 	  #   certificate-fetching: matches transactions fetching
</I>&gt;&gt;<i> 	  #       a missing intermediate TLS certificate
</I>&gt;&gt;<i> 	  #   cache-digest: matches transactions fetching Cache Digests
</I>&gt;&gt;<i> 	  #       from a cache_peer
</I>&gt;&gt;<i> 	  #   icp: matches icp requests to peers
</I>&gt;&gt;<i> 	  #   icmp: matches icmp requests to peers
</I>&gt;&gt;<i> 	  #   asn: matches asns db requests
</I>&gt;&gt;<i> 	  #   internal: matches any of the above
</I>&gt;&gt;<i> 	  #   client: matches transactions containing an HTTP or FTP
</I>&gt;&gt;<i> 	  #       client request received at a Squid *_port
</I>&gt;&gt;<i> 	  #  all: matches all transactions
</I>&gt;&gt;<i> 	  # Multiple initiators are ORed.
</I>&gt;<i> Please note that these are draft specs that are subject to change. We
</I>&gt;<i> may not be able to support many of the initiators listed above. We will
</I>&gt;<i> support the certificate-fetching initiator though.
</I>Very good. When it will be ready to use, or, at least, to test?
&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> It looks squid blocks own internal access to itself, but
</I>&gt;&gt;<i> permits the same request from outside.
</I>&gt;<i> As we discussed earlier, the destination here is not &quot;Squid itself&quot;.
</I>&gt;<i> Squid permits transaction with the same destination upon receiving a
</I>&gt;<i> request from &quot;outside&quot; because your http_access rules permit such
</I>&gt;<i> requests from &quot;outside&quot; while prohibiting transactions that are not
</I>&gt;<i> based on &quot;outside&quot; requests.
</I>&gt;<i>
</I>&gt;<i> One aspect that complicates this problem in general is that we cannot
</I>&gt;<i> simply allow internally-initiated transactions without an explicit admin
</I>&gt;<i> permission because many of them, including the ones that fetch missing
</I>&gt;<i> certificates, may go to completely arbitrary destinations (determined by
</I>&gt;<i> origin servers, not users). Many admins care about where their Squid
</I>&gt;<i> sends requests as much as they care about where their Squid is receiving
</I>&gt;<i> the requests from!
</I>I think it's a necessary evil. As soon as we actually do attack, &quot;Man in
the middle&quot;, whether to worry about lost virginity withnon-controlled
requests? No download intermediate certificates, we return to the local
and accompanied by a certificate-based hand. Here it is necessary to
decide - to go to smart or go to beautiful.

For smart is always remains sslproxy_foreign_intermediate_certs and all
the beauties of a manual tracking certificates. As I know from personal
experience, it is very entertaining organization of unlimited personal
time for proxy administrator. No girls, just clock-around support,
seriously.

So personally I'm willing to put up with uncontrollable requests to the
certificate stores.

Anyway, always exists an alternative. Either full automated
zero-administrated proxy appliance - or, handmade day-by-day entertained
and funny support.
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0x613DEC46.asc
Type: application/pgp-keys
Size: 2437 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170125/222ffb70/attachment.key">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170125/222ffb70/attachment.key</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 473 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170125/222ffb70/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170125/222ffb70/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014224.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
	<LI>Next message (by thread): <A HREF="014226.html">[squid-users] Squid 4.x: Intermediate certificates downloader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14225">[ date ]</a>
              <a href="thread.html#14225">[ thread ]</a>
              <a href="subject.html#14225">[ subject ]</a>
              <a href="author.html#14225">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
