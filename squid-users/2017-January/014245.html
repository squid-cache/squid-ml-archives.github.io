<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3C757248455.1520252.1485425773189%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014234.html">
   <LINK REL="Next"  HREF="014249.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA</H1>
    <B>Vieri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3C757248455.1520252.1485425773189%40mail.yahoo.com%3E"
       TITLE="[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA">rentorbuy at yahoo.com
       </A><BR>
    <I>Thu Jan 26 10:16:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014234.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
        <LI>Next message (by thread): <A HREF="014249.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14245">[ date ]</a>
              <a href="thread.html#14245">[ thread ]</a>
              <a href="subject.html#14245">[ subject ]</a>
              <a href="author.html#14245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

----- Original Message -----
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
&gt;<i> If my reconstruction of the events was correct, then OpenSSL supplied as
</I>&gt;<i> much information as it could -- the &quot;unsupported TLS/SSL versions&quot; is
</I>&gt;<i> _your_ conclusion based on the information that neither Squid nor
</I>&gt;<i> OpenSSL had access to.
</I>&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm only supposing that
</I>&gt;&gt;<i> without the ssloptions I posted above, openssl will try TLS 1.2 and
</I>&gt;&gt;<i> silently fail if that doesn't succeed.
</I>&gt;<i>
</I>&gt;<i> It takes two to tango. How silent that failure is depends, in part, on
</I>&gt;<i> the server. AFAICT, your server was 100% silent about the reason behind
</I>&gt;<i> its abrupt connection closure, and OpenSSL correctly declined to
</I>&gt;<i> speculate about those reasons due to lack of info. From OpenSSL/client
</I>&gt;<i> point of view, it could have been anything from an unsupported TLS
</I>&gt;<i> version to a crashed server.
</I>

Thanks for taking the time to explain. I understand the point you make but I'm still a bit scepticle, probably due to my lack of knowledge in this domain.

I haven't read the RFCs for TLSv1*, SSLv*, etc. However, let's try to give a simple and straightforward example, just to clear things up. Suppose you (the client) meet someone (the server) and ask her/him out. That person can turn away and refuse your proposal without saying a word so you'll never know the reason. That's what you explained and I get that. However, you must &quot;obviously&quot; know what you told that person. Maybe it's not that &quot;obvious&quot; in the case of Squid &amp; OpenSSL, but I'm guessing that it should be possible for Squid to tell OpenSSL to report what it actually said to the server without the need for an admin to do a traffic dump and analysis.

Let's take this simple example into consideration where I use cURL to connect to the same MS Exchange server:

# curl -k -v <A HREF="https://10.215.144.21">https://10.215.144.21</A>
* Rebuilt URL to: <A HREF="https://10.215.144.21/">https://10.215.144.21/</A>
*   Trying 10.215.144.21...
* Connected to 10.215.144.21 (10.215.144.21) port 443 (#0)
* ALPN, offering http/1.1
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
CApath: /etc/ssl/certs
* TLSv1.2 (OUT), TLS header, Certificate Status (22):
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
* Unknown SSL protocol error in connection to 10.215.144.21:443 
* Closing connection 0
curl: (35) Unknown SSL protocol error in connection to 10.215.144.21:443

Now that's clear. cURL tried to use TLS1.2 and failed. The nasty server didn't even say hello.

It's interesting to note that the following actually DOES give more information (unsupported protocol):

# curl --tlsv1.1 -k -v <A HREF="https://10.215.144.21/">https://10.215.144.21/</A>
*   Trying 10.215.144.21...
* Connected to 10.215.144.21 (10.215.144.21) port 443 (#0)
* ALPN, offering http/1.1
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
CApath: /etc/ssl/certs
* TLSv1.1 (OUT), TLS header, Certificate Status (22):
* TLSv1.1 (OUT), TLS handshake, Client hello (1):
* error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol
* Closing connection 0
curl: (35) error:14077102:SSL routines:SSL23_GET_SERVER_HELLO:unsupported protocol


Of course, the following test succeeds:

# curl --tlsv1.0 -k -v <A HREF="https://10.215.144.21/">https://10.215.144.21/</A>
*   Trying 10.215.144.21...
* Connected to 10.215.144.21 (10.215.144.21) port 443 (#0)
* ALPN, offering http/1.1
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
CApath: /etc/ssl/certs
* TLSv1.0 (OUT), TLS header, Certificate Status (22):
* TLSv1.0 (OUT), TLS handshake, Client hello (1):
* TLSv1.0 (IN), TLS handshake, Server hello (2):
* TLSv1.0 (IN), TLS handshake, Certificate (11):
* TLSv1.0 (IN), TLS handshake, Server finished (14):
* TLSv1.0 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.0 (OUT), TLS change cipher, Client hello (1):
* TLSv1.0 (OUT), TLS handshake, Finished (20):
* TLSv1.0 (IN), TLS change cipher, Client hello (1):
* TLSv1.0 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.0 / DES-CBC3-SHA


Now with the openssl command-line client:

#  openssl s_client -connect 10.215.144.21:443 -tls1_2
CONNECTED(00000003)
3072153276:error:1409E0E5:SSL routines:ssl3_write_bytes:ssl handshake failure:s3_pkt.c:656:


#  openssl s_client -connect 10.215.144.21:443 -tls1_1
CONNECTED(00000003)
3072530108:error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number:s3_pkt.c:362:


...and it obviously works with -tls1.

I haven't looked at the source code but I guess Squid uses the OpenSSL library.

I searched the Squid log above and below these lines:

2017/01/24 17:20:28.997 kid1| 83,5| NegotiationHistory.cc(83) retrieveNegotiatedInfo: SSL connection info on FD 18 SSL version NONE/0.0 negotiated cipher 
2017/01/24 17:20:28.997 kid1| Error negotiating SSL on FD 18: error:00000000:lib(0):func(0):reason(0) (5/0/0)
2017/01/24 17:20:28.997 kid1| TCP connection to 10.215.144.21/443 failed


However, I haven't found any hint of what the client (cache_peer) tried to offer.

Maybe if Squid gets an SSL negotiation error with no apparent reason then it might need to retry connecting by being more explicit, just like in my cURL and openssl binary examples above.


I used the latest Squid 4 beta by the way.

I would have understood earlier the reason of the connection failure if Squid/OpenSSL had logged how they were actually hitting on the server.

Anyway, it's not a big deal now that I know what to do if this kind of connection issue comes back up. It could be useful to others though if the logging could be a tad more verbose or if Squid could retry connections by explictly specifying protocols (and logging them).

Thanks,

Vieri

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014234.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
	<LI>Next message (by thread): <A HREF="014249.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14245">[ date ]</a>
              <a href="thread.html#14245">[ thread ]</a>
              <a href="subject.html#14245">[ subject ]</a>
              <a href="author.html#14245">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
