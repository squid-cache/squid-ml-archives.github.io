<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3Ce13696a8-4540-bdd8-0634-902b737b82e4%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014245.html">
   <LINK REL="Next"  HREF="014263.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3Ce13696a8-4540-bdd8-0634-902b737b82e4%40measurement-factory.com%3E"
       TITLE="[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jan 26 18:18:01 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014245.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
        <LI>Next message (by thread): <A HREF="014263.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14249">[ date ]</a>
              <a href="thread.html#14249">[ thread ]</a>
              <a href="subject.html#14249">[ subject ]</a>
              <a href="author.html#14249">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/26/2017 03:16 AM, Vieri wrote:

&gt;<i> I'm guessing that it
</I>&gt;<i> should be possible for Squid to tell OpenSSL to report what it
</I>&gt;<i> actually said to the server without the need for an admin to do a
</I>&gt;<i> traffic dump and analysis.
</I>
Your are correct, but, in most cases, it is a lot easier to dump and
analyze traffic than to ask OpenSSL inside Squid to report what it
actually said. This is, in part, Squid's own fault, but OpenSSL does not
make it easy either. More on that below at (**).


&gt;<i> Let's take this simple example into consideration where I use cURL to connect to the same MS Exchange server:
</I>&gt;<i> 
</I>&gt;<i> # curl -k -v <A HREF="https://10.215.144.21">https://10.215.144.21</A>
</I>&gt;<i> * Rebuilt URL to: <A HREF="https://10.215.144.21/">https://10.215.144.21/</A>
</I>&gt;<i> *   Trying 10.215.144.21...
</I>&gt;<i> * Connected to 10.215.144.21 (10.215.144.21) port 443 (#0)
</I>&gt;<i> * ALPN, offering http/1.1
</I>&gt;<i> * Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
</I>&gt;<i> * successfully set certificate verify locations:
</I>&gt;<i> *   CAfile: /etc/ssl/certs/ca-certificates.crt
</I>&gt;<i> CApath: /etc/ssl/certs
</I>&gt;<i> * TLSv1.2 (OUT), TLS header, Certificate Status (22):
</I>&gt;<i> * TLSv1.2 (OUT), TLS handshake, Client hello (1):
</I>&gt;<i> * Unknown SSL protocol error in connection to 10.215.144.21:443 
</I>&gt;<i> * Closing connection 0
</I>&gt;<i> curl: (35) Unknown SSL protocol error in connection to 10.215.144.21:443
</I>&gt;<i> 
</I>&gt;<i> Now that's clear. cURL tried to use TLS1.2 and failed. The nasty server didn't even say hello.
</I>
Please note that the information you see above details what Curl did,
not what OpenSSL did.

(**) Squid prints many similar details as well, but because Squid
generally deals with many concurrent transactions over a long time, and
does a lot more than Curl does, those details are not as easy to
find/isolate in Squid debugging logs. You found some of them. Again,
Squid could do a lot better in this area, but nobody is working on that
right now AFAIK, and even my attempts to form consensus on how this
should be done have failed so far.


&gt;<i> It's interesting to note that the following actually DOES give more information (unsupported protocol):
</I>
* If the server sent nothing, then Curl gave you potentially incorrect
information (i.e., Curl is just _guessing_ what went wrong).

* If the server sent something, then either Squid situation was
different or I did not see that additional info in the logs you have
posted.

Based on everything I have seen so far, it is probably the former -- the
server sent nothing.


&gt;<i> I haven't looked at the source code but I guess Squid uses the OpenSSL library.
</I>
Yes, in your case, it does.


&gt;<i> However, I haven't found any hint of what the client (cache_peer) tried to offer.
</I>
Cache_peer is not the client here, but yes, see (**) above.


&gt;<i> Maybe if Squid gets an SSL negotiation error with no apparent reason
</I>&gt;<i> then it might need to retry connecting by being more explicit, just
</I>&gt;<i> like in my cURL and openssl binary examples above.
</I>
Sorry, I do not know what &quot;retry connecting by being more explicit&quot;
means. AFAICT, neither Curl nor s_client tried reconnecting in your
examples. Also, an appropriate default for a command-line client is
often a bad default for a proxy. It is complicated.


&gt;<i> I would have understood earlier the reason of the connection failure
</I>&gt;<i> if Squid/OpenSSL had logged how they were actually hitting on the
</I>&gt;<i> server.
</I>
Agreed.


&gt;<i> Anyway, it's not a big deal now that I know what to do if this kind
</I>&gt;<i> of connection issue comes back up. It could be useful to others
</I>&gt;<i> though if the logging could be a tad more verbose or if Squid could
</I>&gt;<i> retry connections by explictly specifying protocols (and logging
</I>&gt;<i> them).
</I>
Agreed in general, but the devil is in the details. Improving this is
difficult, and nobody is working on it at the moment AFAIK.

<A HREF="http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>


Cheers,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014245.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
	<LI>Next message (by thread): <A HREF="014263.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14249">[ date ]</a>
              <a href="thread.html#14249">[ thread ]</a>
              <a href="subject.html#14249">[ subject ]</a>
              <a href="author.html#14249">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
