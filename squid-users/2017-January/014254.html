<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%09server%20name&In-Reply-To=%3CCA531091-9440-4E43-AD2E-DED0C78C5109%40finito.me.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013975.html">
   <LINK REL="Next"  HREF="014255.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name</H1>
    <B>Mark Hoare</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%09server%20name&In-Reply-To=%3CCA531091-9440-4E43-AD2E-DED0C78C5109%40finito.me.uk%3E"
       TITLE="[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name">mark_squid at finito.me.uk
       </A><BR>
    <I>Thu Jan 26 22:38:39 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="013975.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
        <LI>Next message (by thread): <A HREF="014255.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14254">[ date ]</a>
              <a href="thread.html#14254">[ thread ]</a>
              <a href="subject.html#14254">[ subject ]</a>
              <a href="author.html#14254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex/Eliezer,

Thanks for you earlier comments and apologies for not responding (and saying thank you previously, squid got back-burnered unfortunately)

Getting logging working with transparent proxying was my initial step prior to looking at restricting specific sites via either ACLs or a URL rewriter (ufdbGuard, SquidGuard etc - although I don&#8217;t think SquidGuard works with SNI) 

To reiterate, my desire is to have Squid running and capable of blocking access to http and https sites primarily based on the server name requested by the client (so no need to go beyond a peek)
For HTTP requests this is obviously out of the box stuff but for HTTPS it seems more complicated.

From everything I&#8217;ve read, it looks like the following ssl_bump lines should provide access to the SNI server name requested by the client. 
	ssl_bump peek all
	ssl_bump splice all

I can&#8217;t help thinking that I must have something wrong with my config:
- Log output correctly shows 
	- SNI server name via ssl::&gt;sni 
	- Bump mode via ssl::bump_mode 
- Implies my ssl_bump config is working
- Restricting access via a squid ACL doesn&#8217;t use the SNI server name for an HTTPS request 
- Works fine for HTTP

Example ACL:
    acl blocked_sites ssl::server_name .apple.com
    http_access deny blocked_sites

Example access log output:
%ts.%03tu 	  %6tr  %&gt;a        %Ss/%03&gt;Hs 	   %&lt;st  %rm      %ru                         %ssl::&gt;sni        %ssl::bump_mode %[un  %Sh/%&lt;a                     %mt
1485468402.401  575   10.1.0.1  TCP_TUNNEL/200 592  CONNECT  23.63.86.92:443          store.apple.com  peek           -    ORIGINAL_DST/23.63.86.92  -
1485469054.633  51    10.1.0.1  TCP_DENIED/403 3962 GET      <A HREF="http://store.apple.com/">http://store.apple.com/</A>  -                -              -    HIER_NONE/-               text/html

Example cache log output:
2017/01/26 21:54:21.745 kid1| 28,5| Acl.cc(138) matches: checking blocked_sites
2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(42) match: checking '23.63.86.92'
2017/01/26 21:54:21.745 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:23.63.86.92 &lt;&gt;  .apple.com
2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(47) match: '23.63.86.92' NOT found
2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(42) match: checking 'none'
2017/01/26 21:54:21.745 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:none &lt;&gt;  .apple.com
2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(47) match: 'none' NOT found
2017/01/26 21:54:21.745 kid1| 28,3| Acl.cc(158) matches: checked: blocked_sites = 0
2017/01/26 21:54:21.745 kid1| 28,3| Acl.cc(158) matches: checked: http_access#5 = 0
2017/01/26 21:54:21.745 kid1| 28,5| Checklist.cc(400) bannedAction: Action 'ALLOWED/0is not banned

squid -v output:
Squid Cache: Version 3.5.20
Service Name: squid
configure options:  '--build=x86_64-redhat-linux-gnu' '--host=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr' '--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin' '--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include' '--libdir=/usr/lib64' '--libexecdir=/usr/libexec' '--sharedstatedir=/var/lib' '--mandir=/usr/share/man' '--infodir=/usr/share/info' '--disable-strict-error-checking' '--exec_prefix=/usr' '--libexecdir=/usr/lib64/squid' '--localstatedir=/var' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-logdir=$(localstatedir)/log/squid' '--with-pidfile=$(localstatedir)/run/squid.pid' '--disable-dependency-tracking' '--enable-eui' '--enable-follow-x-forwarded-for' '--enable-auth' '--enable-auth-basic=DB,LDAP,MSNT-multi-domain,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB,SMB_LM,getpwnam' '--enable-auth-ntlm=smb_lm,fake' '--enable-auth-digest=file,LDAP,eDirectory' '--enable-auth-negotiate=kerberos' '--enable-external-acl-helpers=file_userip,LDAP_group,time_quota,session,unix_group,wbinfo_group' '--enable-cache-digests' '--enable-cachemgr-hostname=localhost' '--enable-delay-pools' '--enable-epoll' '--enable-ident-lookups' '--enable-linux-netfilter' '--enable-removal-policies=heap,lru' '--enable-snmp' '--enable-ssl-crtd' '--enable-storeio=aufs,diskd,ufs' '--enable-wccpv2' '--enable-esi' '--enable-ecap' '--with-aio' '--with-default-user=squid' '--with-dl' '--with-openssl' '--with-pthreads' '--disable-arch-native' '--disable-icap-client' 'build_alias=x86_64-redhat-linux-gnu' 'host_alias=x86_64-redhat-linux-gnu' 'CFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic -fpie' 'LDFLAGS=-Wl,-z,relro  -pie -Wl,-z,relro -Wl,-z,now' 'CXXFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic -fpie' 'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig'

Is there anything obvious that I am missing as I&#8217;m a bit stumped now.

Thanks again

Mark

&gt;<i> On 3 Jan 2017, at 23:35, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 01/03/2017 04:11 PM, Mark Hoare wrote:
</I>&gt;<i> 
</I>
&gt;&gt;<i> I think these are hangovers from earlier syntax (ssl_bump
</I>&gt;&gt;<i> server-first all) which shouldn't be required under 3.5.
</I>&gt;<i> 
</I>
&gt;<i> Please note that the depricated server-first is a &quot;bumping&quot; (not
</I>&gt;<i> splicing!) action, and you may see a lot more information in the
</I>&gt;<i> bumping-Squid logs, naturally.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>
&gt;<i> On 3 Jan 2017, at 23:10, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 01/03/2017 03:41 PM, Eliezer  Croitoru wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Squid in intercept or tproxy mode will know one thing about the tunnel\connection: IP+port.
</I>&gt;<i> 
</I>&gt;<i> ... and SSL handshake information when peeking or staring at client/server.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Since you are using:
</I>&gt;&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;&gt;<i> The connections will always be spliced and you will never see any
</I>&gt;&gt;<i> url.(are you expecting only the SNI or also the url?)
</I>&gt;<i> 
</I>&gt;<i> AFAICT, Mark is expecting Squid to log one of the server names, not the
</I>&gt;<i> HTTP request URL.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I do not know but there might be a code that can report the SNI if exists in the logs.
</I>&gt;<i> 
</I>&gt;<i> According to squid.conf.documented, the following logformat %code is
</I>&gt;<i> supported in modern Squids:
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl::&gt;sni       SSL client SNI sent to Squid. Available only
</I>&gt;&gt;<i>                after the peek, stare, or splice SSL bumping
</I>&gt;&gt;<i>                actions.
</I>&gt;<i> 
</I>&gt;<i> This %code is not in the default access.log line format, naturally.
</I>&gt;<i> 
</I>&gt;<i> Squid can also analyze CN and other server certificate fields, but there
</I>&gt;<i> is no code to log them IIRC.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Please note that the intercepted server IP address, the client-supplied
</I>&gt;<i> SNI name, the server-supplied common name (CN), the server-supplied
</I>&gt;<i> alternative names, and the host info in the encrypted client HTTP
</I>&gt;<i> request, may all be different.
</I>&gt;<i> 
</I>&gt;<i> Given the variety of information sources that might supply different
</I>&gt;<i> information, it is not clear to me whether %ru should be based on SNI
</I>&gt;<i> information when both TCP-level and SNI information is available. Or
</I>&gt;<i> should it be based on CN? Or perhaps on CN _unless_ SNI matches one of
</I>&gt;<i> the alternative names?? This is a complicated issue; even the smart
</I>&gt;<i> server_name ACL needs parameters to clarify what &quot;server name(s)&quot; the
</I>&gt;<i> admin really wants to use/trust...
</I>&gt;<i> 
</I>&gt;<i> According to Mark's email, %ru uses TCP-level info. We could either
</I>&gt;<i> change %ru to use the &quot;latest&quot; info (like the server_name ACL does) or
</I>&gt;<i> add a new logformat code that does that while leaving the old %ru and
</I>&gt;<i> friends alone. Given the complexity of the issue, the latter may be a
</I>&gt;<i> better approach.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Mark Hoare
</I>&gt;&gt;<i> Sent: Saturday, December 31, 2016 4:38 PM
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: [squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</I>&gt;<i> 
</I>&gt;&gt;<i> Extract from access log:
</I>&gt;&gt;&gt;<i> 1483193882.790    870 &lt;local ip removed&gt; TCP_TUNNEL/200 5620 CONNECT 64.41.200.100:443 - ORIGINAL_DST/64.41.200.100 -
</I>&gt;<i> 
</I>&gt;&gt;<i> From the output above I would have expected some of the server name info to get into the access log.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> http_port 3128
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> https_port 3130 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> http_port 3131 intercept ssl-bump cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170126/08be0150/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170126/08be0150/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="013975.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
	<LI>Next message (by thread): <A HREF="014255.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14254">[ date ]</a>
              <a href="thread.html#14254">[ thread ]</a>
              <a href="subject.html#14254">[ subject ]</a>
              <a href="author.html#14254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
