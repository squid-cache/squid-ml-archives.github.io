<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%09server%20name&In-Reply-To=%3C017d01d27844%24252a15b0%246f7e4110%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014255.html">
   <LINK REL="Next"  HREF="013976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name</H1>
    <B>Eliezer  Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20-%20peek%20%26%20splice%20logging%20IP%20rather%20than%0A%09server%20name&In-Reply-To=%3C017d01d27844%24252a15b0%246f7e4110%24%40ngtech.co.il%3E"
       TITLE="[squid-users] ssl_bump - peek &amp; splice logging IP rather than	server name">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Jan 27 02:22:02 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014255.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
        <LI>Next message (by thread): <A HREF="013976.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14257">[ date ]</a>
              <a href="thread.html#14257">[ thread ]</a>
              <a href="subject.html#14257">[ subject ]</a>
              <a href="author.html#14257">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Is it stock REDHAT or CentOS or Other?
You can use the RPM's of squid I am building which are quite generic and works very well.
I have just released 3.5.23 and 4.0.17.
I have built it both for RH and CentOS:
<A HREF="http://wiki.squid-cache.org/KnowledgeBase/CentOS#Squid-3.5">http://wiki.squid-cache.org/KnowledgeBase/CentOS#Squid-3.5</A>
And you can take a peek and browse at:
<A HREF="http://www1.ngtech.co.il/repo/">http://www1.ngtech.co.il/repo/</A>
If what you are running is not there let me know and I will try to build a binary for it.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Alex Rousskov
Sent: Friday, January 27, 2017 1:57 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] ssl_bump - peek &amp; splice logging IP rather than server name

On 01/26/2017 03:38 PM, Mark Hoare wrote:

&gt;<i> To reiterate, my desire is to have Squid running and capable of 
</I>&gt;<i> blocking access to http and https sites primarily based on the server 
</I>&gt;<i> name requested by the client (so no need to go beyond a peek)
</I>
... or even beyond a peek at the client.


&gt;<i> From everything I&#8217;ve read, it looks like the following ssl_bump lines 
</I>&gt;<i> should provide access to the SNI server name requested by the client.
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>
Yes, but you are also telling Squid to peek at the server certificate.
If you want to avoid doing that, then replace &quot;peek all&quot; with &quot;peek step1&quot; while providing the right step1 ACL. The SNI-based denial you want should happen earlier anyway, but if you do peek at the server certificate, then you may also deny later, based on server-supplied information (e.g., when SNI was missing or was not matching). Whether more denials based on server info is a good thing is your decision.


&gt;<i> I can&#8217;t help thinking that I must have something wrong with my config:
</I>&gt;<i> - Log output correctly shows
</I>&gt;<i> - SNI server name via ssl::&gt;sni
</I>&gt;<i> - Bump mode via ssl::bump_mode
</I>&gt;<i> - Implies my ssl_bump config is working
</I>&gt;<i> - Works fine for HTTP
</I>
Great!


&gt;<i> - Restricting access via a squid ACL doesn&#8217;t use the SNI server name 
</I>&gt;<i> for an HTTPS request
</I>
You may be right, but not for the reasons you think. The output you have shown does not necessarily confirm any problems.


&gt;<i> Example ACL:
</I>&gt;<i>     acl blocked_sites ssl::server_name .apple.com
</I>&gt;<i>     http_access deny blocked_sites
</I>
Please note that your Squid version is missing a critical ssl::server_name fix detailed below.


&gt;<i> Example access log output:
</I>&gt;<i> %ts.%03tu   %6tr  %&gt;a        %Ss/%03&gt;Hs    %&lt;st  %rm      %ru
</I>&gt;<i>     %ssl::&gt;sni       %ssl::bump_mode %[un  %Sh/%&lt;a %mt
</I>
&gt;<i> 1485468402.401  575   10.1.0.1  TCP_TUNNEL/200 592  CONNECT 23.63.86.92:443
</I>&gt;<i>     store.apple.com  peek -   ORIGINAL_DST/23.63.86.92  -
</I>
&gt;<i> 1485469054.633  51    10.1.0.1  TCP_DENIED/403 3962 GET <A HREF="http://store.apple.com/">http://store.apple.com/</A>
</I>&gt;<i>     -                -    -   HIER_NONE/-               text/html
</I>
The above shows that Squid peeked and denied access. To serve the error page to the client, Squid bumped the client connection first and then denied the first encrypted HTTP request. This is normal/expected.


&gt;<i> Example cache log output:
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,5| Acl.cc(138) matches: checking 
</I>&gt;<i> blocked_sites
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(42) match: checking '23.63.86.92'
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,7| ServerName.cc(32) 
</I>&gt;<i> aclHostDomainCompare: Match:23.63.86.92 &lt;&gt; .apple.com
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(47) match: 
</I>&gt;<i> '23.63.86.92' NOT found
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(42) match: checking 'none'
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,7| ServerName.cc(32) 
</I>&gt;<i> aclHostDomainCompare: Match:none &lt;&gt; .apple.com
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,3| ServerName.cc(47) match: 'none' 
</I>&gt;<i> NOT found
</I>&gt;<i> 2017/01/26 21:54:21.745 kid1| 28,5| Checklist.cc(400) bannedAction: 
</I>&gt;<i> Action 'ALLOWED/0is not banned
</I>
If the above was for step1 checks, then it makes sense: The access was not banned based on TCP level information. Proceed to step2 (extract SNI and test again). There should be more checks like the above, and then Squid decided to deny access. However, the timing of that decision and the sources of information used for that decision may change after the ssl::server_name fix mentioned below.


&gt;<i> Squid Cache: Version 3.5.20
</I>
You are missing the following server_name fix (among other things):

&gt;<i> revno: 14110
</I>&gt;<i> branch nick: 3.5
</I>&gt;<i> timestamp: Mon 2016-11-14 23:51:24 +1300
</I>&gt;<i> message:
</I>&gt;<i>   Fix ssl::server_name ACL badly broken since inception.
</I>&gt;<i>   
</I>&gt;<i>   The original server_name code mishandled all SNI checks and some rare
</I>&gt;<i>   host checks:
</I>&gt;<i>   
</I>&gt;<i>   * The SNI-derived value was pointing to an already freed memory storage.
</I>&gt;<i>   * Missing host-derived values were not detected (host() is never nil).
</I>&gt;<i>   * Mismatches were re-checked with an undocumented &quot;none&quot; value
</I>&gt;<i>     instead of being treated as mismatches.
</I>&gt;<i>   
</I>&gt;<i>   Same for ssl::server_name_regex.
</I>&gt;<i>   
</I>&gt;<i>   Also set SNI for more server-first and client-first transactions.
</I>&gt;<i>   
</I>&gt;<i>   This is a Measurement Factory project.
</I>
The first rule of SslBumping: Use the latest code.


HTH,

Alex.
P.S. Please avoid HTMLifying your emails, especially when quoting logs.



&gt;&gt;<i> On 3 Jan 2017, at 23:35, Alex Rousskov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 01/03/2017 04:11 PM, Mark Hoare wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think these are hangovers from earlier syntax (ssl_bump 
</I>&gt;&gt;&gt;<i> server-first all) which shouldn't be required under 3.5.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please note that the depricated server-first is a &quot;bumping&quot; (not
</I>&gt;&gt;<i> splicing!) action, and you may see a lot more information in the 
</I>&gt;&gt;<i> bumping-Squid logs, naturally.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> On 3 Jan 2017, at 23:10, Alex Rousskov 
</I>&gt;&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A> 
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 01/03/2017 03:41 PM, Eliezer  Croitoru wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid in intercept or tproxy mode will know one thing about the
</I>&gt;&gt;&gt;<i> tunnel\connection: IP+port.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ... and SSL handshake information when peeking or staring at 
</I>&gt;&gt;<i> client/server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Since you are using:
</I>&gt;&gt;&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The connections will always be spliced and you will never see any 
</I>&gt;&gt;&gt;<i> url.(are you expecting only the SNI or also the url?)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AFAICT, Mark is expecting Squid to log one of the server names, not 
</I>&gt;&gt;<i> the HTTP request URL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I do not know but there might be a code that can report the SNI if 
</I>&gt;&gt;&gt;<i> exists in the logs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> According to squid.conf.documented, the following logformat %code is 
</I>&gt;&gt;<i> supported in modern Squids:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl::&gt;sni       SSL client SNI sent to Squid. Available only
</I>&gt;&gt;&gt;<i>                after the peek, stare, or splice SSL bumping
</I>&gt;&gt;&gt;<i>                actions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This %code is not in the default access.log line format, naturally.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid can also analyze CN and other server certificate fields, but 
</I>&gt;&gt;<i> there is no code to log them IIRC.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please note that the intercepted server IP address, the 
</I>&gt;&gt;<i> client-supplied SNI name, the server-supplied common name (CN), the 
</I>&gt;&gt;<i> server-supplied alternative names, and the host info in the encrypted 
</I>&gt;&gt;<i> client HTTP request, may all be different.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Given the variety of information sources that might supply different 
</I>&gt;&gt;<i> information, it is not clear to me whether %ru should be based on SNI 
</I>&gt;&gt;<i> information when both TCP-level and SNI information is available. Or 
</I>&gt;&gt;<i> should it be based on CN? Or perhaps on CN _unless_ SNI matches one 
</I>&gt;&gt;<i> of the alternative names?? This is a complicated issue; even the 
</I>&gt;&gt;<i> smart server_name ACL needs parameters to clarify what &quot;server 
</I>&gt;&gt;<i> name(s)&quot; the admin really wants to use/trust...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> According to Mark's email, %ru uses TCP-level info. We could either 
</I>&gt;&gt;<i> change %ru to use the &quot;latest&quot; info (like the server_name ACL does) 
</I>&gt;&gt;<i> or add a new logformat code that does that while leaving the old %ru 
</I>&gt;&gt;<i> and friends alone. Given the complexity of the issue, the latter may 
</I>&gt;&gt;<i> be a better approach.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;&gt;&gt;<i> On Behalf Of Mark Hoare
</I>&gt;&gt;&gt;<i> Sent: Saturday, December 31, 2016 4:38 PM
</I>&gt;&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> 
</I>&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i> Subject: [squid-users] ssl_bump - peek &amp; splice logging IP rather 
</I>&gt;&gt;&gt;<i> than server name
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Extract from access log:
</I>&gt;&gt;&gt;&gt;<i> 1483193882.790    870 &lt;local ip removed&gt; TCP_TUNNEL/200 5620 CONNECT
</I>&gt;&gt;&gt;&gt;<i> 64.41.200.100:443 - ORIGINAL_DST/64.41.200.100 -
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> From the output above I would have expected some of the server name 
</I>&gt;&gt;&gt;<i> info to get into the access log.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> http_port 3128
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> https_port 3130 intercept ssl-bump
</I>&gt;&gt;&gt;&gt;<i> cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on 
</I>&gt;&gt;&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> http_port 3131 intercept ssl-bump
</I>&gt;&gt;&gt;&gt;<i> cert=/etc/squid/ssl_cert/squidCA.pem generate-host-certificates=on 
</I>&gt;&gt;&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014255.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather than server name
</A></li>
	<LI>Next message (by thread): <A HREF="013976.html">[squid-users] ssl_bump - peek &amp; splice logging IP rather	than	server name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14257">[ date ]</a>
              <a href="thread.html#14257">[ thread ]</a>
              <a href="subject.html#14257">[ subject ]</a>
              <a href="author.html#14257">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
