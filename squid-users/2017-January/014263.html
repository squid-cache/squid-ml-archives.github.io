<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3C1426807003.2339496.1485505865203%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014249.html">
   <LINK REL="Next"  HREF="014136.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA</H1>
    <B>Vieri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20reverse%20proxy%20%28accelerator%29%20for%20MS%20Exchange%0A%20OWA&In-Reply-To=%3C1426807003.2339496.1485505865203%40mail.yahoo.com%3E"
       TITLE="[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA">rentorbuy at yahoo.com
       </A><BR>
    <I>Fri Jan 27 08:31:05 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014249.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
        <LI>Next message (by thread): <A HREF="014136.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14263">[ date ]</a>
              <a href="thread.html#14263">[ thread ]</a>
              <a href="subject.html#14263">[ subject ]</a>
              <a href="author.html#14263">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>



----- Original Message -----
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;

&gt;&gt;<i> It's interesting to note that the following actually DOES give more information (unsupported 
</I>
&gt;&gt;<i> protocol):&gt;
</I>&gt;<i> * If the server sent nothing, then Curl gave you potentially incorrect
</I>&gt;<i> information (i.e., Curl is just _guessing_ what went wrong).
</I>

I never tried telling Squid to use TLS 1.1 ONLY so I never got to see Squid's log when using that protocol. I'm supposing I would have seen the same thing in Squid as I've seen it with CURL.
So I'm sure Squid would log useful information for the sys admin but... (see below).

&gt;&gt;<i> Maybe if Squid gets an SSL negotiation error with no apparent reason
</I>&gt;&gt;<i> then it might need to retry connecting by being more explicit, just
</I>&gt;&gt;<i> like in my cURL and openssl binary examples above.
</I>&gt;<i>
</I>&gt;<i> Sorry, I do not know what &quot;retry connecting by being more explicit&quot;
</I>&gt;<i> means. AFAICT, neither Curl nor s_client tried reconnecting in your
</I>&gt;<i> examples. Also, an appropriate default for a command-line client is
</I>&gt;<i> often a bad default for a proxy. It is complicated.
</I>

Let me rephrase my point but please keep in mind that I have no idea how Squid actually behaves. Simply put, when Squid tries to connect for the first time, it will probably (I'm guessing here) try the most secure protcol known today (ie. TSL 1.2), or let OpenSSL decide by default which is probably the same. In my case, the server replies nothing. That would be like running:

# curl -k -v <A HREF="https://10.215.144.21">https://10.215.144.21</A>
or
# openssl s_client -connect 10.215.144.21:443

They give me the same information as Squid's log... almost nothing.

So my point is, if that first connection fails and gives me nothing for TLS 1.2 (or whatever the default is), two things can happen: either the remote site is failing or it isn't supporting the protocol. Why not &quot;try again&quot; but this time by being more specific? It would be like doing something like this:

# openssl s_client -connect 10.215.144.21:443 || openssl s_client -connect 10.215.144.21:443 -tls1_1 || openssl s_client -connect 10.215.144.21:443 -tls1
 

Of course, this shouldn't be done each and every time it tries to connect because it would probably give performance issues. If Squid successfully connects with TSL 1.0 then it could &quot;remember&quot; that for later connections to the same peer. It could also forget it after a sensible timeout, in case the remote peer starts supporting a safer protocol.

&gt;<i> Agreed in general, but the devil is in the details. Improving this is
</I>&gt;<i> difficult, and nobody is working on it at the moment AFAIK.
</I>

I can imagine it must be difficult...


Instead of improving the source code, maybe a FAQ or some doc related to &quot;squid error negotiating SSL&quot; which would describe what to try when the error message is a mere &quot;handshake failure&quot;. In the end, it's as simple as setting ssloptions correctly (in my case, NO_SSLv3,NO_SSLv2,NO_TLSv1_2,NO_TLSv1_1). I know there could be many other reasons for such a failure but at least that would be a good starting point.


Or even better... if Squid detects an SSL handshake failure with no extra info like in my case, can't it simply log an extra string that would look something like &quot;Failed to negotiate SSL for unknown reason. Try setting ssloptions (cache_peer) or options (https_port) with a combination of NO_SSLv2 NO_SSLv3 
NO_TLSv1 NO_TLSv1_1 NO_TLSv1_2. Find out which SSL protocol is supported by the remote peer. If the connection still fails then you will need to analyze traffic with the peer to find out the reason.&quot;

In my case, that would have been enough info in Squid's log to fix the issue.

Thanks again.

Vieri

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014249.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
	<LI>Next message (by thread): <A HREF="014136.html">[squid-users] squid reverse proxy (accelerator) for MS Exchange OWA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14263">[ date ]</a>
              <a href="thread.html#14263">[ thread ]</a>
              <a href="subject.html#14263">[ subject ]</a>
              <a href="author.html#14263">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
