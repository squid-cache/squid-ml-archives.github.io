<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Clarity on sending intercepted HTTPS traffic upstream	to a cache_peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%20upstream%0A%09to%20a%20cache_peer&In-Reply-To=%3C43c4ec96-c100-149e-d2c2-78cceb4ce530%40charlie.is%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014266.html">
   <LINK REL="Next"  HREF="014284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Clarity on sending intercepted HTTPS traffic upstream	to a cache_peer</H1>
    <B>Charlie Orford</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%20upstream%0A%09to%20a%20cache_peer&In-Reply-To=%3C43c4ec96-c100-149e-d2c2-78cceb4ce530%40charlie.is%3E"
       TITLE="[squid-users] Clarity on sending intercepted HTTPS traffic upstream	to a cache_peer">charlie at charlie.is
       </A><BR>
    <I>Fri Jan 27 18:24:17 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014266.html">[squid-users] transparent http and https filter with white-list only
</A></li>
        <LI>Next message (by thread): <A HREF="014284.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14283">[ date ]</a>
              <a href="thread.html#14283">[ thread ]</a>
              <a href="subject.html#14283">[ subject ]</a>
              <a href="author.html#14283">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi list

We're using squid 3.5.23 and trying to achieve the following:

client https request (not proxy aware) -&gt; squid1 (https NAT intercept) 
-&gt; upstream squid2 (configured as a cache_peer in squid1) -&gt; origin 
server (e.g. www.google.com)

Amos mentioned in this thread 
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-March/009468.html">http://lists.squid-cache.org/pipermail/squid-users/2016-March/009468.html</A> 
that:

 &gt; Squid can:
 &gt;
 &gt;  A) relay CONNECT message from client to any upstream proxy.
 &gt;
 &gt;  B) generate CONNECT message on arriving intercepted HTTPS and relay
 &gt; that to upstream proxy *IF* (and only if) ssl_bump selects the 'splice'
 &gt; action.
 &gt;
 &gt;  C) relay <A HREF="https://">https://</A> URLs to an upstream TLS proxy.
 &gt;
 &gt;
 &gt; That is all at present.
 &gt;
 &gt; Squid cannot (yet) generate CONNECT messages to try and fetch TLS
 &gt; details via a non-TLS cache_peer. If you are able to sponsor that
 &gt; enhancement work patches are welcome, or sponsorship $$ to help pay
 &gt; persons working on these things (Christos / measurement-factory) are
 &gt; also welcome.

Option B seems to cover what we need i.e. squid1 wraps arriving 
intercepted HTTPS traffic in a CONNECT and sends it upstream to squid2 
which in turn tunnels it to the origin server. Unfortunately, we can't 
get it to work: as soon as squid1 receives a client HTTPS request it 
exits with &quot;assertion failed: PeerConnector.cc:116: &quot;peer-&gt;use_ssl&quot;&quot; in 
cache.log

Relevant config for squid1:
######################################
acl localnet src 10.100.0.0/24
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
acl Blocked_domains dstdomain &quot;/etc/squid3/blocked.domains.acl&quot;
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
acl MITM_TRAFFIC myportname MITM_port

http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny to_localhost
http_access deny Blocked_domains
http_access allow localhost
http_access allow localnet
http_access deny all
http_reply_access allow all

https_port 8443 ssl-bump intercept cert=/etc/squid3/root_ca.combined.pem 
generate-host-certificates=on dynamic_cert_mem_cache_size=8MB 
name=MITM_port
sslcrtd_program /usr/lib/squid3/ssl_crtd -s /var/lib/squid3/ssl_db -M 4MB

ssl_bump peek all
ssl_bump splice all

nonhierarchical_direct off
never_direct allow all
prefer_direct off
cache_peer 192.168.0.1 parent 3128 0 no-query no-digest 
no-netdb-exchange name=WWW_GATEWAY


Relevant config for squid2:
######################################
acl localnet src 192.168.0.0/24
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

http_port 3128

http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny to_localhost
http_access allow localnet
http_access deny all

http_reply_access allow all


Is what we want to do currently achievable with the latest 3.5 branch or 
have we misunderstood what Amos was stating (some of his posts about ssl 
interception and cache_peer support can be fairly cryptic)?

If it is achievable, does the cache_peer link itself also need to be 
encrypted (via the ssl flag) to make it work?

Thanks,
Charlie



-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170127/de795d81/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170127/de795d81/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014266.html">[squid-users] transparent http and https filter with white-list only
</A></li>
	<LI>Next message (by thread): <A HREF="014284.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14283">[ date ]</a>
              <a href="thread.html#14283">[ thread ]</a>
              <a href="subject.html#14283">[ subject ]</a>
              <a href="author.html#14283">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
