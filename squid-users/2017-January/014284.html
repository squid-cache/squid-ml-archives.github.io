<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%0A%20upstream%20to%20a%20cache_peer&In-Reply-To=%3C69ed2073-eb71-c535-fb44-9911f9c35973%40charlie.is%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014283.html">
   <LINK REL="Next"  HREF="014285.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer</H1>
    <B>Charlie Orford</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%0A%20upstream%20to%20a%20cache_peer&In-Reply-To=%3C69ed2073-eb71-c535-fb44-9911f9c35973%40charlie.is%3E"
       TITLE="[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer">charlie at charlie.is
       </A><BR>
    <I>Fri Jan 27 23:04:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014283.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream	to a cache_peer
</A></li>
        <LI>Next message (by thread): <A HREF="014285.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14284">[ date ]</a>
              <a href="thread.html#14284">[ thread ]</a>
              <a href="subject.html#14284">[ subject ]</a>
              <a href="author.html#14284">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>To follow up:

Adding ssl to the cache_peer directive on squid1 (and changing squid2 so 
it listens for connections on an https_port) gets us a little further 
but still doesn't work.

Clients get a SQUID_X509_V_ERR_DOMAIN_MISMATCH error (because the 
auto-generated cert squid1 gives to the client contains the domain of 
the cache_peer *not* the ultimate origin server).

The above is with the following ssl_bump directives set in squid1's config:

ssl_bump peek step1
ssl_bump peek step2
ssl_bump splice step3

A post from another user on this list seems to suggest they successfully 
got squid to do what we want 
(<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2015-November/007955.html">http://lists.squid-cache.org/pipermail/squid-users/2015-November/007955.html</A>) 
but when emulating their setup (i.e. peeking at step1, staring at step2 
and then bumping at step3) we get the same 
SQUID_X509_V_ERR_DOMAIN_MISMATCH error.

Setting sslflags=DONT_VERIFY_DOMAIN on the cache_peer directive has no 
effect.

Connecting to squid1 with a proxy aware client (on a standard http_port 
with the ssl-bump flag set but no intercept) also results in the same 
problem.

Where are we going wrong?

Charlie

On 27/01/2017 18:24, Charlie Orford wrote:
&gt;<i> Hi list
</I>&gt;<i>
</I>&gt;<i> We're using squid 3.5.23 and trying to achieve the following:
</I>&gt;<i>
</I>&gt;<i> client https request (not proxy aware) -&gt; squid1 (https NAT intercept) 
</I>&gt;<i> -&gt; upstream squid2 (configured as a cache_peer in squid1) -&gt; origin 
</I>&gt;<i> server (e.g. www.google.com)
</I>&gt;<i>
</I>&gt;<i> Amos mentioned in this thread 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-March/009468.html">http://lists.squid-cache.org/pipermail/squid-users/2016-March/009468.html</A> 
</I>&gt;<i> that:
</I>&gt;<i>
</I>&gt;<i> &gt; Squid can:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  A) relay CONNECT message from client to any upstream proxy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  B) generate CONNECT message on arriving intercepted HTTPS and relay
</I>&gt;<i> &gt; that to upstream proxy *IF* (and only if) ssl_bump selects the 'splice'
</I>&gt;<i> &gt; action.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  C) relay <A HREF="https://">https://</A> URLs to an upstream TLS proxy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; That is all at present.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Squid cannot (yet) generate CONNECT messages to try and fetch TLS
</I>&gt;<i> &gt; details via a non-TLS cache_peer. If you are able to sponsor that
</I>&gt;<i> &gt; enhancement work patches are welcome, or sponsorship $$ to help pay
</I>&gt;<i> &gt; persons working on these things (Christos / measurement-factory) are
</I>&gt;<i> &gt; also welcome.
</I>&gt;<i>
</I>&gt;<i> Option B seems to cover what we need i.e. squid1 wraps arriving 
</I>&gt;<i> intercepted HTTPS traffic in a CONNECT and sends it upstream to squid2 
</I>&gt;<i> which in turn tunnels it to the origin server. Unfortunately, we can't 
</I>&gt;<i> get it to work: as soon as squid1 receives a client HTTPS request it 
</I>&gt;<i> exits with &quot;assertion failed: PeerConnector.cc:116: &quot;peer-&gt;use_ssl&quot;&quot; 
</I>&gt;<i> in cache.log
</I>&gt;<i>
</I>&gt;<i> Relevant config for squid1:
</I>&gt;<i> ######################################
</I>&gt;<i> acl localnet src 10.100.0.0/24
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl Blocked_domains dstdomain &quot;/etc/squid3/blocked.domains.acl&quot;
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> acl MITM_TRAFFIC myportname MITM_port
</I>&gt;<i>
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> http_access deny Blocked_domains
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i>
</I>&gt;<i> https_port 8443 ssl-bump intercept 
</I>&gt;<i> cert=/etc/squid3/root_ca.combined.pem generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=8MB name=MITM_port
</I>&gt;<i> sslcrtd_program /usr/lib/squid3/ssl_crtd -s /var/lib/squid3/ssl_db -M 4MB
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> nonhierarchical_direct off
</I>&gt;<i> never_direct allow all
</I>&gt;<i> prefer_direct off
</I>&gt;<i> cache_peer 192.168.0.1 parent 3128 0 no-query no-digest 
</I>&gt;<i> no-netdb-exchange name=WWW_GATEWAY
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Relevant config for squid2:
</I>&gt;<i> ######################################
</I>&gt;<i> acl localnet src 192.168.0.0/24
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> http_port 3128
</I>&gt;<i>
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Is what we want to do currently achievable with the latest 3.5 branch 
</I>&gt;<i> or have we misunderstood what Amos was stating (some of his posts 
</I>&gt;<i> about ssl interception and cache_peer support can be fairly cryptic)?
</I>&gt;<i>
</I>&gt;<i> If it is achievable, does the cache_peer link itself also need to be 
</I>&gt;<i> encrypted (via the ssl flag) to make it work?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Charlie
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170127/2c9ea6e6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170127/2c9ea6e6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014283.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream	to a cache_peer
</A></li>
	<LI>Next message (by thread): <A HREF="014285.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14284">[ date ]</a>
              <a href="thread.html#14284">[ thread ]</a>
              <a href="subject.html#14284">[ subject ]</a>
              <a href="author.html#14284">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
