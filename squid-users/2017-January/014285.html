<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%0A%20upstream%20to%20a%20cache_peer&In-Reply-To=%3C5cee91b5-3ca7-eb45-07f1-5152233ee58b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014284.html">
   <LINK REL="Next"  HREF="014286.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%0A%20upstream%20to%20a%20cache_peer&In-Reply-To=%3C5cee91b5-3ca7-eb45-07f1-5152233ee58b%40measurement-factory.com%3E"
       TITLE="[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jan 27 23:43:04 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014284.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
        <LI>Next message (by thread): <A HREF="014286.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14285">[ date ]</a>
              <a href="thread.html#14285">[ thread ]</a>
              <a href="subject.html#14285">[ subject ]</a>
              <a href="author.html#14285">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/27/2017 04:04 PM, Charlie Orford wrote:

&gt;<i> Clients get a SQUID_X509_V_ERR_DOMAIN_MISMATCH error (because the
</I>&gt;<i> auto-generated cert squid1 gives to the client contains the domain of
</I>&gt;<i> the cache_peer *not* the ultimate origin server).
</I>
Under normal circumstances, Squid should generate no certificates in
your setup AFAICT.


&gt;<i> The above is with the following ssl_bump directives set in squid1's config:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump peek step2
</I>&gt;<i> ssl_bump splice step3
</I>
In other words:

  ssl_bump peek all
  ssl_bump splice all

Why not just do this instead:

  ssl_bump splice all

I have not tested this, but I do not understand why you want a
three-step SslBump to blindly forward an SSL connection to a peer. I
would use the minimal number of steps possible: one if it works or two
if I have to because of some Squid bugs/missing features.

When everything goes OK, Squid should generate no certificates in either
case, but with three-step SslBump, there are a lot more opportunities
for Squid to detect problems and want to send an error response to the
client. To send an error message, Squid bumps the connection to the
client (which does require fake certificate generation).

Finally, I do not know whether Squid is capable of peeking at the origin
server through a peer, but I doubt it is. If my guess is correct, then
three-step splicing will not work for you because during step3 your
Squid will already be talking to the origin server rather than a
cache_peer (or will fail because it cannot do that).


&gt;<i> A post from another user on this list seems to suggest they successfully
</I>&gt;<i> got squid to do what we want
</I>&gt;<i> (<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2015-November/007955.html">http://lists.squid-cache.org/pipermail/squid-users/2015-November/007955.html</A>)
</I>&gt;<i> but when emulating their setup (i.e. peeking at step1, staring at step2
</I>&gt;<i> and then bumping at step3) we get the same
</I>&gt;<i> SQUID_X509_V_ERR_DOMAIN_MISMATCH error.
</I>
I suggest the following order:

  1. Decide whether your Squid should bump or splice.
  2. Find the configuration that does what you decided in #1.

So far, you have given no reasons to warrant bumping so I assume you do
not need or want to bump anything. Thus, you should ignore any
configurations that contain &quot;stare&quot;, &quot;bump&quot;, or deprecated &quot;*-first&quot;
ssl_bump actions.


HTH,

Alex.


&gt;<i> On 27/01/2017 18:24, Charlie Orford wrote:
</I>&gt;&gt;<i> Hi list
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We're using squid 3.5.23 and trying to achieve the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> client https request (not proxy aware) -&gt; squid1 (https NAT intercept)
</I>&gt;&gt;<i> -&gt; upstream squid2 (configured as a cache_peer in squid1) -&gt; origin
</I>&gt;&gt;<i> server (e.g. www.google.com)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos mentioned in this thread
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-March/009468.html">http://lists.squid-cache.org/pipermail/squid-users/2016-March/009468.html</A>
</I>&gt;&gt;<i> that:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Squid can:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;  A) relay CONNECT message from client to any upstream proxy.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;  B) generate CONNECT message on arriving intercepted HTTPS and relay
</I>&gt;&gt;<i> &gt; that to upstream proxy *IF* (and only if) ssl_bump selects the 'splice'
</I>&gt;&gt;<i> &gt; action.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;  C) relay <A HREF="https://">https://</A> URLs to an upstream TLS proxy.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; That is all at present.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Squid cannot (yet) generate CONNECT messages to try and fetch TLS
</I>&gt;&gt;<i> &gt; details via a non-TLS cache_peer. If you are able to sponsor that
</I>&gt;&gt;<i> &gt; enhancement work patches are welcome, or sponsorship $$ to help pay
</I>&gt;&gt;<i> &gt; persons working on these things (Christos / measurement-factory) are
</I>&gt;&gt;<i> &gt; also welcome.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Option B seems to cover what we need i.e. squid1 wraps arriving
</I>&gt;&gt;<i> intercepted HTTPS traffic in a CONNECT and sends it upstream to squid2
</I>&gt;&gt;<i> which in turn tunnels it to the origin server. Unfortunately, we can't
</I>&gt;&gt;<i> get it to work: as soon as squid1 receives a client HTTPS request it
</I>&gt;&gt;<i> exits with &quot;assertion failed: PeerConnector.cc:116: &quot;peer-&gt;use_ssl&quot;&quot;
</I>&gt;&gt;<i> in cache.log
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Relevant config for squid1:
</I>&gt;&gt;<i> ######################################
</I>&gt;&gt;<i> acl localnet src 10.100.0.0/24
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> acl Blocked_domains dstdomain &quot;/etc/squid3/blocked.domains.acl&quot;
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i> acl MITM_TRAFFIC myportname MITM_port
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow manager localhost
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;<i> http_access deny Blocked_domains
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> http_reply_access allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 8443 ssl-bump intercept
</I>&gt;&gt;<i> cert=/etc/squid3/root_ca.combined.pem generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=8MB name=MITM_port
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid3/ssl_crtd -s /var/lib/squid3/ssl_db -M 4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek all
</I>&gt;&gt;<i> ssl_bump splice all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> nonhierarchical_direct off
</I>&gt;&gt;<i> never_direct allow all
</I>&gt;&gt;<i> prefer_direct off
</I>&gt;&gt;<i> cache_peer 192.168.0.1 parent 3128 0 no-query no-digest
</I>&gt;&gt;<i> no-netdb-exchange name=WWW_GATEWAY
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Relevant config for squid2:
</I>&gt;&gt;<i> ######################################
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/24
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3128
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow manager localhost
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_reply_access allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is what we want to do currently achievable with the latest 3.5 branch
</I>&gt;&gt;<i> or have we misunderstood what Amos was stating (some of his posts
</I>&gt;&gt;<i> about ssl interception and cache_peer support can be fairly cryptic)?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If it is achievable, does the cache_peer link itself also need to be
</I>&gt;&gt;<i> encrypted (via the ssl flag) to make it work?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Charlie
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014284.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
	<LI>Next message (by thread): <A HREF="014286.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14285">[ date ]</a>
              <a href="thread.html#14285">[ thread ]</a>
              <a href="subject.html#14285">[ subject ]</a>
              <a href="author.html#14285">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
