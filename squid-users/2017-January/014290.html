<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%0A%20upstream%20to%20a%20cache_peer&In-Reply-To=%3C0534e50e-ff0a-9538-3e36-a02085970760%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014287.html">
   <LINK REL="Next"  HREF="014292.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarity%20on%20sending%20intercepted%20HTTPS%20traffic%0A%20upstream%20to%20a%20cache_peer&In-Reply-To=%3C0534e50e-ff0a-9538-3e36-a02085970760%40measurement-factory.com%3E"
       TITLE="[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Jan 28 17:47:00 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014287.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
        <LI>Next message (by thread): <A HREF="014292.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14290">[ date ]</a>
              <a href="thread.html#14290">[ thread ]</a>
              <a href="subject.html#14290">[ subject ]</a>
              <a href="author.html#14290">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/27/2017 05:32 PM, Charlie Orford wrote:
&gt;<i> Obviously it makes no sense
</I>&gt;<i> intercepting ssl traffic if we're going to splice everything.
</I>
It actually does make a lot of sense in many environments, but not
necessarily yours.


&gt;<i> Our design goal is: intercept and bump local client https traffic on
</I>&gt;<i> squid1 (so we can filter certain urls, cache content etc.) and then
</I>&gt;<i> forward the request on to the origin server via an upstream squid2
</I>&gt;<i> (which has internet access).
</I>
Understood. Squid can be enhanced to do what you want. There is nothing
fundamentally impossible in what you are describing AFAICT. We need to
add an insecure peer connector, and then using that connector code on
the regular request forwarding path. The low-level code to do that
already exists in tunnel.cc, but needs to be refactored/moved. This is
an architecturally challenging work, but it is certainly doable.

After those Squid modifications, in the simplest case (ignoring that you
cannot bump some sites and that you may not want to bump some of the
clients either), your squid1 configuration would be something like this:

  ssl_bump stare all
  ssl_bump bump all

Your squid2 will not do SslBump. In fact, to achieve the stated goal,
squid2 does not need to support SSL at all -- it can blindly forward
[encrypted] traffic from squid1 to the internet.

Your next steps to make the above happen are outlined at
<A HREF="http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>


&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2015-November/007955.html">http://lists.squid-cache.org/pipermail/squid-users/2015-November/007955.html</A>
</I>&gt;<i> seems to have successfully done this but I can't replicate it.
</I>
The configuration posted at the above URL is broken because it does not
tell Squid what to do after step1. If it did work, it was a bug like,
for example, bug 3209. Most likely, Squid just spliced everything (as
you suspect). Ignore that email. To learn why that configuration makes
no sense, study <A HREF="http://wiki.squid-cache.org/Features/SslPeekAndSplice">http://wiki.squid-cache.org/Features/SslPeekAndSplice</A>


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014287.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
	<LI>Next message (by thread): <A HREF="014292.html">[squid-users] Clarity on sending intercepted HTTPS traffic upstream to a cache_peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14290">[ date ]</a>
              <a href="thread.html#14290">[ thread ]</a>
              <a href="subject.html#14290">[ subject ]</a>
              <a href="author.html#14290">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
