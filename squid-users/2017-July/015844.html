<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%20after%0A%20upgrade%20from%20v2%20to%20v3&In-Reply-To=%3Cf418e53a-ed5f-e4db-9654-2aa31ad83c57%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015837.html">
   <LINK REL="Next"  HREF="015846.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%20after%0A%20upgrade%20from%20v2%20to%20v3&In-Reply-To=%3Cf418e53a-ed5f-e4db-9654-2aa31ad83c57%40treenet.co.nz%3E"
       TITLE="[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul  7 08:10:30 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015837.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
        <LI>Next message (by thread): <A HREF="015846.html">[squid-users] Huge amount of time_wait connections after	upgrade from v2 to v3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15844">[ date ]</a>
              <a href="thread.html#15844">[ thread ]</a>
              <a href="subject.html#15844">[ subject ]</a>
              <a href="author.html#15844">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/07/17 13:55, Ivan Larionov wrote:
&gt;<i> Hi. Sorry that I'm answering to the old thread. I was on vacation and 
</I>&gt;<i> didn't have a chance to test the proposed solution.
</I>&gt;<i> 
</I>&gt;<i> Dieter, yes, I'm on the old CentOS 6 based OS (Amazon Linux) but with a 
</I>&gt;<i> new kernel 4.9.27.
</I>&gt;<i> 
</I>&gt;<i> Amos, thank you for the suggestions about configure flags and squid 
</I>&gt;<i> config options, I fixed all issues you pointed to.
</I>&gt;<i> 
</I>&gt;<i> Unfortunately following workarounds didn't help:
</I>&gt;<i> 
</I>&gt;<i> * client_idle_pconn_timeout 30 seconds
</I>&gt;<i> * half_closed_clients on
</I>&gt;<i> * client_persistent_connections off
</I>&gt;<i> * server_persistent_connections off
</I>&gt;<i> 
</I>
TIME_WAIT is a sign that Squid is following the normal TCP process for 
closing connections, and doing so before the remote endpoint closes.

Disabling persistent connections increases the number of connections 
going through that process. So you definitely want those settings ON to 
reduce the WAIT states.

If the remote end is the one doing the closure, then you will see less 
TIME_WAIT, but CLOSE_WAIT will increase instead. The trick is in finding 
the right balance of timeouts on both client and server idle pconn to 
get the minimum of total WAIT states. That is network dependent.

Generally though forward/explicit and intercept proxies want 
client_idle_pconn_timeout to be shorter than server_idle_pconn_timeout. 
Reverse proxy want the opposite.



&gt;<i> However I assumed that this is a bug and that I can find older version 
</I>&gt;<i> which worked fine. I started testing from 3.1.x all the way to 3.5.26 
</I>&gt;<i> and this is what I found:
</I>&gt;<i> 
</I>&gt;<i> * All versions until 3.5.21 work fine. There no issues with huge amount 
</I>&gt;<i> of TIME_WAIT connections under load.
</I>&gt;<i> * 3.5.20 is the latest stable version.
</I>&gt;<i> * 3.5.21 is the first broken version.
</I>&gt;<i> * 3.5.23, 3.5.25, 3.5.26 are broken as well.
</I>&gt;<i> 
</I>&gt;<i> This effectively means that bug is somewhere in between 3.5.20 and 3.5.21.
</I>&gt;<i> 
</I>&gt;<i> I hope this helps and I hope you'll be able to find an issue. If you can 
</I>&gt;<i> create a bug report based on this information and post it here it would 
</I>&gt;<i> be awesome.
</I>
The changes in 3.5.21 were fixes to some common crashes and better 
caching behaviour. So I expect at least some of the change is due to 
higher traffic throughput on proxies previously restricted by those 
problems.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015837.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
	<LI>Next message (by thread): <A HREF="015846.html">[squid-users] Huge amount of time_wait connections after	upgrade from v2 to v3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15844">[ date ]</a>
              <a href="thread.html#15844">[ thread ]</a>
              <a href="subject.html#15844">[ subject ]</a>
              <a href="author.html#15844">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
