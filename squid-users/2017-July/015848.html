<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Huge amount of time_wait connections	after	upgrade from v2 to v3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%0A%09after%09upgrade%20from%20v2%20to%20v3&In-Reply-To=%3C010101d2f72c%243ff66620%24bfe33260%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015846.html">
   <LINK REL="Next"  HREF="015850.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Huge amount of time_wait connections	after	upgrade from v2 to v3</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%0A%09after%09upgrade%20from%20v2%20to%20v3&In-Reply-To=%3C010101d2f72c%243ff66620%24bfe33260%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Huge amount of time_wait connections	after	upgrade from v2 to v3">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Jul  7 14:20:56 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015846.html">[squid-users] Huge amount of time_wait connections after	upgrade from v2 to v3
</A></li>
        <LI>Next message (by thread): <A HREF="015850.html">[squid-users] Huge amount of time_wait connections	after	upgrade from v2 to v3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15848">[ date ]</a>
              <a href="thread.html#15848">[ thread ]</a>
              <a href="subject.html#15848">[ subject ]</a>
              <a href="author.html#15848">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Ivan,

How do you run these tests?
With what application &quot;ab&quot; ?

Thanks,
Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Ivan Larionov
Sent: Friday, July 7, 2017 17:07
To: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Huge amount of time_wait connections after upgrade from v2 to v3

Thank you for the fast reply.

&gt;<i> On Jul 7, 2017, at 01:10, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 07/07/17 13:55, Ivan Larionov wrote:
</I>&gt;&gt;<i> Hi. Sorry that I'm answering to the old thread. I was on vacation and didn't have a chance to test the proposed solution.
</I>&gt;&gt;<i> Dieter, yes, I'm on the old CentOS 6 based OS (Amazon Linux) but with a new kernel 4.9.27.
</I>&gt;&gt;<i> Amos, thank you for the suggestions about configure flags and squid config options, I fixed all issues you pointed to.
</I>&gt;&gt;<i> Unfortunately following workarounds didn't help:
</I>&gt;&gt;<i> * client_idle_pconn_timeout 30 seconds
</I>&gt;&gt;<i> * half_closed_clients on
</I>&gt;&gt;<i> * client_persistent_connections off
</I>&gt;&gt;<i> * server_persistent_connections off
</I>&gt;<i> 
</I>&gt;<i> TIME_WAIT is a sign that Squid is following the normal TCP process for closing connections, and doing so before the remote endpoint closes.
</I>&gt;<i> 
</I>&gt;<i> Disabling persistent connections increases the number of connections going through that process. So you definitely want those settings ON to reduce the WAIT states.
</I>&gt;<i> 
</I>
I understand that. I just wrote that I tried this options and they had no effect. They didn't increase nor decrease number of TIME_WAIT connections. I removed them when I started testing older versions.

&gt;<i> If the remote end is the one doing the closure, then you will see less TIME_WAIT, but CLOSE_WAIT will increase instead. The trick is in finding the right balance of timeouts on both client and server idle pconn to get the minimum of total WAIT states. That is network dependent.
</I>&gt;<i> 
</I>&gt;<i> Generally though forward/explicit and intercept proxies want client_idle_pconn_timeout to be shorter than server_idle_pconn_timeout. Reverse proxy want the opposite.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> However I assumed that this is a bug and that I can find older version which worked fine. I started testing from 3.1.x all the way to 3.5.26 and this is what I found:
</I>&gt;&gt;<i> * All versions until 3.5.21 work fine. There no issues with huge amount of TIME_WAIT connections under load.
</I>&gt;&gt;<i> * 3.5.20 is the latest stable version.
</I>&gt;&gt;<i> * 3.5.21 is the first broken version.
</I>&gt;&gt;<i> * 3.5.23, 3.5.25, 3.5.26 are broken as well.
</I>&gt;&gt;<i> This effectively means that bug is somewhere in between 3.5.20 and 3.5.21.
</I>&gt;&gt;<i> I hope this helps and I hope you'll be able to find an issue. If you can create a bug report based on this information and post it here it would be awesome.
</I>&gt;<i> 
</I>&gt;<i> The changes in 3.5.21 were fixes to some common crashes and better caching behaviour. So I expect at least some of the change is due to higher traffic throughput on proxies previously restricted by those problems.
</I>&gt;<i> 
</I>
I can't imagine how throughput increase could result in 500 times more TIME_WAIT connections count.

In our prod environment when we updated from 2.7.x to 3.5.25 we saw increase from 100 to 10000. This is 100x.

When I was load testing different versions yesterday I was always sending the same amount of RPS to them. Update from 3.5.20 to 3.5.21 resulted in jump from 20 to 10000 TIME_WAIT count. This is 500x.

I know that time_wait is fine in general. Until you have too many of them.

&gt;<i> Amos
</I>_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015846.html">[squid-users] Huge amount of time_wait connections after	upgrade from v2 to v3
</A></li>
	<LI>Next message (by thread): <A HREF="015850.html">[squid-users] Huge amount of time_wait connections	after	upgrade from v2 to v3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15848">[ date ]</a>
              <a href="thread.html#15848">[ thread ]</a>
              <a href="subject.html#15848">[ subject ]</a>
              <a href="author.html#15848">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
