<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%20after%0A%20upgrade%20from%20v2%20to%20v3&In-Reply-To=%3CCAHvB88wSq6%3DnT6FPNdbopiAxfiZhz5zqOAvfa4_aoiYmAq8QKQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015855.html">
   <LINK REL="Next"  HREF="015936.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%20after%0A%20upgrade%20from%20v2%20to%20v3&In-Reply-To=%3CCAHvB88wSq6%3DnT6FPNdbopiAxfiZhz5zqOAvfa4_aoiYmAq8QKQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3">xeron.oskom at gmail.com
       </A><BR>
    <I>Sat Jul  8 16:51:50 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015855.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
        <LI>Next message (by thread): <A HREF="015936.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15856">[ date ]</a>
              <a href="thread.html#15856">[ thread ]</a>
              <a href="subject.html#15856">[ subject ]</a>
              <a href="author.html#15856">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>RPS didn't change. Throughput didn't change. Our prod load is 200-700 RPS
per server (changes during the day) and my load test load was constant 470
RPS.

Clients didn't change. Doesn't matter if they use HTTP 1.1 or 1.0, because
the only thing which changed is squid version. And as I figured out, it's
not actually about 2.7 to 3.5 update, it's all about difference between
3.5.20 and 3.5.21.

I'm sorry but anything you say about throughput doesn't make any sense.
Load pattern didn't change. Squid still handles the same amount of requests.

I think I'm going to load test every patch applied to 3.5.21 from this
page:
<A HREF="http://www.squid-cache.org/Versions/v3/3.5/changesets/SQUID_3_5_21.html">http://www.squid-cache.org/Versions/v3/3.5/changesets/SQUID_3_5_21.html</A> so
I'll be able to point to exact change which introduced this behavior. I'll
try to do it during the weekend or may be on Monday.

On Sat, Jul 8, 2017 at 5:46 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 08/07/17 02:06, Ivan Larionov wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Thank you for the fast reply.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Jul 7, 2017, at 01:10, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 07/07/17 13:55, Ivan Larionov wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;
</I>&gt;<i>
</I>&gt;&gt;<i> However I assumed that this is a bug and that I can find older version
</I>&gt;&gt;&gt;&gt;<i> which worked fine. I started testing from 3.1.x all the way to 3.5.26 and
</I>&gt;&gt;&gt;&gt;<i> this is what I found:
</I>&gt;&gt;&gt;&gt;<i> * All versions until 3.5.21 work fine. There no issues with huge amount
</I>&gt;&gt;&gt;&gt;<i> of TIME_WAIT connections under load.
</I>&gt;&gt;&gt;&gt;<i> * 3.5.20 is the latest stable version.
</I>&gt;&gt;&gt;&gt;<i> * 3.5.21 is the first broken version.
</I>&gt;&gt;&gt;&gt;<i> * 3.5.23, 3.5.25, 3.5.26 are broken as well.
</I>&gt;&gt;&gt;&gt;<i> This effectively means that bug is somewhere in between 3.5.20 and
</I>&gt;&gt;&gt;&gt;<i> 3.5.21.
</I>&gt;&gt;&gt;&gt;<i> I hope this helps and I hope you'll be able to find an issue. If you
</I>&gt;&gt;&gt;&gt;<i> can create a bug report based on this information and post it here it would
</I>&gt;&gt;&gt;&gt;<i> be awesome.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The changes in 3.5.21 were fixes to some common crashes and better
</I>&gt;&gt;&gt;<i> caching behaviour. So I expect at least some of the change is due to higher
</I>&gt;&gt;&gt;<i> traffic throughput on proxies previously restricted by those problems.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> I can't imagine how throughput increase could result in 500 times more
</I>&gt;&gt;<i> TIME_WAIT connections count.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> More requests per second generally means more TCP connections churning.
</I>&gt;<i>
</I>&gt;<i> Also when going from Squid-2 to Squid-3 there is a change from HTTP/1.0 to
</I>&gt;<i> HTTP/1.1 and the accompanying switch from MISS to near-HIT revalidations.
</I>&gt;<i> Revalidations usually only have headers without payload so the same
</I>&gt;<i> bytes/sec can contain orders more magnitude of those than MISS - which is
</I>&gt;<i> the point of having them.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In our prod environment when we updated from 2.7.x to 3.5.25 we saw
</I>&gt;&gt;<i> increase from 100 to 10000. This is 100x.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Compared to what RPS change? Given the above traffic change this may be
</I>&gt;<i> reasonable for a v2 to v3 jump. Or own very rough tests on old hardware lab
</I>&gt;<i> tests have shown rates for Squid-2 at ~900 RPS and Squid-3 at around 1900
</I>&gt;<i> RPS.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> When I was load testing different versions yesterday I was always sending
</I>&gt;&gt;<i> the same amount of RPS to them. Update from 3.5.20 to 3.5.21 resulted in
</I>&gt;&gt;<i> jump from 20 to 10000 TIME_WAIT count. This is 500x.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know that time_wait is fine in general. Until you have too many of them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> At this point I'd check that your testing software supports HTTP/1.1
</I>&gt;<i> pipelines. It may be giving you worst-case results with per-message TCP
</I>&gt;<i> churn rather than what will occur normally (pipelines of N requests per TCP
</I>&gt;<i> connection).
</I>&gt;<i> Though seeing such a jump between Squid-3 releases is worrying.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>


-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170708/32dfc8a6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170708/32dfc8a6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015855.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
	<LI>Next message (by thread): <A HREF="015936.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15856">[ date ]</a>
              <a href="thread.html#15856">[ thread ]</a>
              <a href="subject.html#15856">[ subject ]</a>
              <a href="author.html#15856">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
