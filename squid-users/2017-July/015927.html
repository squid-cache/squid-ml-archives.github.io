<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Proxy Server ssl-bump blocking Web Socket	connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Proxy%20Server%20ssl-bump%20blocking%20Web%20Socket%0A%09connections&In-Reply-To=%3CHE1PR0501MB278009D2F9031E87CD899A8DD1AD0%40HE1PR0501MB2780.eurprd05.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016035.html">
   <LINK REL="Next"  HREF="015928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Proxy Server ssl-bump blocking Web Socket	connections</H1>
    <B>Max Ashton</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Proxy%20Server%20ssl-bump%20blocking%20Web%20Socket%0A%09connections&In-Reply-To=%3CHE1PR0501MB278009D2F9031E87CD899A8DD1AD0%40HE1PR0501MB2780.eurprd05.prod.outlook.com%3E"
       TITLE="[squid-users] Squid Proxy Server ssl-bump blocking Web Socket	connections">max at jjoplc.com
       </A><BR>
    <I>Fri Jul 14 15:11:54 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016035.html">[squid-users] What would be the maximum ufs\aufs cache_dir	objects?
</A></li>
        <LI>Next message (by thread): <A HREF="015928.html">[squid-users] Squid Proxy Server ssl-bump blocking Web Socket connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15927">[ date ]</a>
              <a href="thread.html#15927">[ thread ]</a>
              <a href="subject.html#15927">[ subject ]</a>
              <a href="author.html#15927">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear squid-users,

I have just set up Squid Server 3.5.26 on Ubuntu 16.04.2 LTS configured with SSL-bump. Http and Https is working fine but any web services that requires Web Sockets fails with the error:

WebSocket connection to '<A HREF="ws://speedtest.b4rn.org.uk:8080/ws">ws://speedtest.b4rn.org.uk:8080/ws</A>' failed: Error during WebSocket handshake: net::ERR_CONNECTION_RESET

For example, a broadband speed test.

&gt;<i>From the mail list archive I found a post relating to whatsapp web sockets, sadly the suggested configuration did not work for me.
</I>
I have added the following lines to my squid configuration in an attempt to force a direct connection and prevent SSL caching for web socket connections.

#Temporarily allow all connections for debugging http_access allow all

acl bump-bypass dstdomain 192.168.0.245 .speedtest.net # URL's contains ws, most web socket urls do, allowing all for testing acl ssl-web-sockets SSL::server_name_regex \/ws

ssl_bump step1 at_step SslBump1
ssl_bump peek step1
ssl_bump splice bump-bypass ssl-web-sockets tcp-web-sockets

#I Read that there was a bug in bump that required !explicity #for splice to work for web sockets ssl_bump bump !ssl-web-sockets all

#just bump all doesn't work either
#ssl_bump bump all

If I disable ssl-bump  and don't decrypt encrypted traffic (http_port 3128 instead of http_port 3128 ssl-bump ...) everything works fine.

How can I configure squid to allow web socket connections?

Thanks

Kind Regards
Max 

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016035.html">[squid-users] What would be the maximum ufs\aufs cache_dir	objects?
</A></li>
	<LI>Next message (by thread): <A HREF="015928.html">[squid-users] Squid Proxy Server ssl-bump blocking Web Socket connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15927">[ date ]</a>
              <a href="thread.html#15927">[ thread ]</a>
              <a href="subject.html#15927">[ subject ]</a>
              <a href="author.html#15927">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
