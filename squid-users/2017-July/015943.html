<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] What would be the maximum ufs\aufs cache_dir	objects?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20would%20be%20the%20maximum%20ufs%5Caufs%20cache_dir%0A%09objects%3F&In-Reply-To=%3C0e4e01d2ff22%24e99f5530%24bcddff90%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015934.html">
   <LINK REL="Next"  HREF="015976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] What would be the maximum ufs\aufs cache_dir	objects?</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20would%20be%20the%20maximum%20ufs%5Caufs%20cache_dir%0A%09objects%3F&In-Reply-To=%3C0e4e01d2ff22%24e99f5530%24bcddff90%24%40ngtech.co.il%3E"
       TITLE="[squid-users] What would be the maximum ufs\aufs cache_dir	objects?">eliezer at ngtech.co.il
       </A><BR>
    <I>Mon Jul 17 17:34:15 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015934.html">[squid-users] What would be the maximum ufs\aufs cache_dir objects?
</A></li>
        <LI>Next message (by thread): <A HREF="015976.html">[squid-users] What would be the maximum ufs\aufs cache_dir objects?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15943">[ date ]</a>
              <a href="thread.html#15943">[ thread ]</a>
              <a href="subject.html#15943">[ subject ]</a>
              <a href="author.html#15943">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So basically from I understand the limit of the AUFS\UFS cache_dir is at:
16,777,215 Objects.
So for a very loaded system it might be pretty &quot;small&quot;.

I have asked since:
I have seen the mongodb ecap adapter that stores chunks and I didn't liked it.
In the other way I wrote a cache_dir in GoLang which I am using for the windows updates caching proxy and for now it's surpassing the AUFS\UFS limits.

Based on the success of the Windows Updates Cache proxy which strives to cache only public objects, I was thinking about writing something similar for a more global usage.
The basic constrain on what would be cached is only If the object has Cache-Control &quot;public&quot;.
The first step would be an ICAP service (respmod) which will log requests and response and will decide what GET results are worthy of later fetch.
Squid currently does things on-the-fly while the client transaction is fetched by the client.
For an effective cache I believe we can compromise on another approach which relays or statistics.
The first rule is: Not everything worth caching!!!
Then after understanding and configuring this we can move on to fetch *Public* only objects when they get a high repeated downloads.
This is actually how google cache and other similar cache systems work.
They first let traffic reach the &quot;DB&quot; or &quot;DATASTORE&quot; if it's the first time seen.
Then after more the a specific threshold they object is being fetched by the cache system without any connection to the transaction which the clients consume.
It might not be the most effective caching &quot;method&quot; for specific very loaded systems or specific big files and *very* high cost up-stream connections but for many it will be fine.
And the actual logic and implementation can be each of couple algorithms like LRU as the default and couple others as an option.

I believe that this logic will be good for specific systems and will remove all sort of weird store\cache_dir limitations.
I already have a ready to use system which I named &quot;YouTube-Store&quot; that allows the admin to download and serve specific YouTube videos to a local web-service.
It can be utilized together with an external_acl helper that will redirect clients to a special page that hosts cached\stored video with an option to bypass the cached version.

I hope to publish this system soon under BSD license.

Thanks,
Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Alex Rousskov
Sent: Friday, July 14, 2017 20:49
To: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] What would be the maximum ufs\aufs cache_dir objects?

On 07/14/2017 10:47 AM, Amos Jeffries wrote:

&gt;<i> One UFS cache_dir can hold a maximum of (2^27)-1 safely. 
</I>
You probably meant to say (2^25)-1 but the actual number is (2^24)-1
because the sfileno is signed. This is why you get 16'777'215 (a.k.a.
0xFFFFFF) as the actual limit.


&gt;<i> The index hash entries are stored as a 32-bit bitmask (sfileno) - with 5
</I>&gt;<i> bits for cache_dir ID and 27 bits for hash of the file details.
</I>
The cache index entries are hashed on their keys, not file numbers (of
any kind). The index entry is using 25 bits for the file number, but
IIRC, those 25 bits are never merged/combined with the 7 bits of the
cache_dir ID in any meaningful way.


Alex.

&gt;<i> typedef signed_int32_t sfileno;&gt;     sfileno swap_filen:25; // keep in sync with SwapFilenMax
</I>&gt;<i>     sdirno swap_dirn:7;
</I>&gt;<i> enum { SwapFilenMax = 0xFFFFFF }; // keep in sync with StoreEntry::swap_filen
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015934.html">[squid-users] What would be the maximum ufs\aufs cache_dir objects?
</A></li>
	<LI>Next message (by thread): <A HREF="015976.html">[squid-users] What would be the maximum ufs\aufs cache_dir objects?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15943">[ date ]</a>
              <a href="thread.html#15943">[ thread ]</a>
              <a href="subject.html#15943">[ subject ]</a>
              <a href="author.html#15943">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
