<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Packets logged as blocked even Firewall	(IPtables) accepts them ...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Packets%20logged%20as%20blocked%20even%20Firewall%0A%09%28IPtables%29%20accepts%20them%20...&In-Reply-To=%3C16d701d300c7%24e5eaf970%24b1c0ec50%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015987.html">
   <LINK REL="Next"  HREF="015956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Packets logged as blocked even Firewall	(IPtables) accepts them ...</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Packets%20logged%20as%20blocked%20even%20Firewall%0A%09%28IPtables%29%20accepts%20them%20...&In-Reply-To=%3C16d701d300c7%24e5eaf970%24b1c0ec50%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Packets logged as blocked even Firewall	(IPtables) accepts them ...">eliezer at ngtech.co.il
       </A><BR>
    <I>Wed Jul 19 19:47:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015987.html">[squid-users] Packets logged as blocked even Firewall (IPtables) accepts them ...
</A></li>
        <LI>Next message (by thread): <A HREF="015956.html">[squid-users] Problem with login to website by Squid web proxy	3.5.20 on Centos 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15988">[ date ]</a>
              <a href="thread.html#15988">[ thread ]</a>
              <a href="subject.html#15988">[ subject ]</a>
              <a href="author.html#15988">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Walter,

Something is still missing to me about the network and network interfaces.
I need the output of:
ip a
brctl show br0

And try to apply the next iptables rules to see if it works OK for you:
<A HREF="http://ngtech.co.il/paste/1782/raw/">http://ngtech.co.il/paste/1782/raw/</A>

&gt;<i>From what I understand the proxy is just another machine in the network so the I do not understand what for the br0 and what is eth1...
</I>If eth1 is under br0 you should not apply any rules on the eth1 and remove any ip address from eth1.
Also the FORWARD rules should not be required unless you are using the squid machine as a Gateway and from your description it's not the goal so a simple DROP all should be fine.
Also if you have followed some tutorial to setup your iptables and\or squid It will help me to see these since for squid as far as I know you don't need:
-A INPUT -d 224.0.0.0/4 -j ACCEPT

Or similar rules.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: Walter H. [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Walter.H at mathemainzel.info</A>] 
Sent: Wednesday, July 19, 2017 21:38
To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Packets logged as blocked even Firewall (IPtables) accepts them ...

Hello Eliezer,

it is just this:

# Generated by iptables-save v1.4.7 on Wed Jul 19 20:25:22 2017
*filter
:<i>INPUT DROP [0:0]
</I>:<i>FORWARD DROP [0:0]
</I>:<i>OUTPUT DROP [0:0]
</I>-A INPUT -d 224.0.0.0/4 -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -i br0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i br0 -p udp -m udp --sport 67:68 --dport 67:68 -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 53 -m state --state NEW -j ACCEPT
-A INPUT -i br0 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 22 -m state --state NEW -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 80 -m state --state NEW -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 443 -m state --state NEW -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 3128 -m state --state NEW -j ACCEPT
-A INPUT -i eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i br0 -p icmp -j ACCEPT
-A INPUT -i eth1 -p icmp -m limit --limit 2/sec --limit-burst 4 -j ACCEPT
-A INPUT -i br0 -p udp -m udp --sport 32769:65535 --dport 33434:33523 -j 
ACCEPT
-A INPUT -i eth1 -p udp -m udp --sport 32769:65535 --dport 33434:33523 
-j ACCEPT
-A INPUT -j LOG --log-prefix &quot;IP[IN]: &quot; --log-level 7
-A FORWARD -i br0 -o eth1 -p udp -m udp --dport 3478 -j REJECT 
--reject-with icmp-port-unreachable
-A FORWARD -i br0 -o eth1 -p udp -m udp --dport 3544 -j REJECT 
--reject-with icmp-port-unreachable
-A FORWARD -j LOG --log-prefix &quot;IP[FWD]: &quot; --log-level 7
-A OUTPUT -d 224.0.0.0/4 -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -o br0 -j ACCEPT
-A OUTPUT -o eth1 -j ACCEPT
-A OUTPUT -j LOG --log-prefix &quot;IP[OUT]: &quot; --log-level 7
COMMIT
# Completed on Wed Jul 19 20:25:22 2017

Walter

On 19.07.2017 20:03, Eliezer Croitoru wrote:
&gt;<i> Hey Walter,
</I>&gt;<i>
</I>&gt;<i> Can you please paste the output of &quot;iptables-save&quot; for me?
</I>&gt;<i> It's easier for me to read plain iptables-save then iptables -Lnv or any other format.
</I>&gt;<i> Then I would be able to send you a file that you can just pull into iptables-restore which should work.
</I>&gt;<i>
</I>&gt;<i> And just to clear out my doubts on the scenario:
</I>&gt;<i> Is the RST packets coming from the gateway(192.168.0.1) but for request from the local proxy(192.168.0.10).
</I>&gt;<i> To eliminate couple things, can you test the next rule on the GW:
</I>&gt;<i> Iptables -I INPUT -s 192.168.0.10 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> And see if it changes anything at all?
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Walter H.
</I>&gt;<i> Sent: Tuesday, July 18, 2017 15:29
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] Packets logged as blocked even Firewall (IPtables) accepts them ...
</I>&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> my Router Box runs a CentOS 6, with the EPEL squid34 RPM package
</I>&gt;<i>
</I>&gt;<i> this the iptables
</I>&gt;<i> &lt;BEGIN /etc/sysconfig/iptables&gt;
</I>&gt;<i> *filter
</I>&gt;<i> :INPUT DROP [0:0]
</I>&gt;<i> :FORWARD DROP [0:0]
</I>&gt;<i> :OUTPUT DROP [0:0]
</I>&gt;<i>
</I>&gt;<i> # Allow multicast
</I>&gt;<i> -A INPUT -d 224.0.0.0/4 -j ACCEPT
</I>&gt;<i> -A OUTPUT -d 224.0.0.0/4 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Allow anything on the local link
</I>&gt;<i> -A INPUT -i lo -j ACCEPT
</I>&gt;<i> -A OUTPUT -o lo -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Allow anything out on LAN
</I>&gt;<i> -A OUTPUT -o br0 -j ACCEPT
</I>&gt;<i> # Allow established, related packets back in -A INPUT -i br0 -m state --state ESTABLISHED,RELATED -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Enable DHCP for LAN
</I>&gt;<i> -A INPUT -i br0 -m udp -p udp --sport 67:68 --dport 67:68 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Enable DNS-Cache for LAN
</I>&gt;<i> -A INPUT -i br0 -m tcp -p tcp --dport 53 -m state --state NEW -j ACCEPT -A INPUT -i br0 -m udp -p udp --dport 53 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Enable SSH from LAN
</I>&gt;<i> -A INPUT -i br0 -m tcp -p tcp --dport 22 -m state --state NEW -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Enable HTTP/HTTPS from LAN (some gui interface) -A INPUT -i br0 -m tcp -p tcp --dport 80 -m state --state NEW -j ACCEPT -A INPUT -i br0 -m tcp -p tcp --dport 443 -m state --state NEW -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Enable Squid-Proxy from LAN
</I>&gt;<i> -A INPUT -i br0 -m tcp -p tcp --dport 3128 -m state --state NEW -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Block STUN
</I>&gt;<i> -A FORWARD -i br0 -o eth1 -m udp -p udp --dport 3478 -j REJECT # Block TEREDO -A FORWARD -i br0 -o eth1 -m udp -p udp --dport 3544 -j REJECT
</I>&gt;<i>
</I>&gt;<i> # Allow Forwarding to WAN interface
</I>&gt;<i> -A FORWARD -i br0 -o eth1 -j ACCEPT
</I>&gt;<i> # Allow established, related packets back through -A FORWARD -i eth1 -o br0 -m state --state ESTABLISHED,RELATED -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Only the lan is allowed to ping me without restriction -A INPUT -i br0 -p icmp -j ACCEPT # Else only pings with restricted icmp are allowed -A INPUT -i eth1 -p icmp -m limit --limit 2/sec --limit-burst 4 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Enable TRACEroute to me from LAN
</I>&gt;<i> -A INPUT -i br0 -p udp --sport 32769:65535 --dport 33434:33523 -j ACCEPT # Enable TRACEroute to me from internet -A INPUT -i eth1 -p udp --sport 32769:65535 --dport 33434:33523 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> # Log all other
</I>&gt;<i> -A INPUT -j LOG --log-prefix &quot;IP[IN]: &quot; --log-level 7 -A FORWARD -j LOG  --log-prefix &quot;IP[FWD]: &quot; --log-level 7 -A OUTPUT -j LOG  --log-prefix &quot;IP[OUT]: &quot; --log-level 7
</I>&gt;<i>
</I>&gt;<i> COMMIT
</I>&gt;<i> &lt;END /etc/sysconfig/iptables&gt;
</I>&gt;<i>
</I>&gt;<i> and these are logged entries:
</I>&gt;<i> (only partial, as they are many)
</I>&gt;<i>
</I>&gt;<i> &lt;BEGIN dmesg&gt;
</I>&gt;<i> [17-Jul-2017; 19:49:13.590130] IP[IN]: IN=br0 OUT=
</I>&gt;<i> MAC=24:01:00:00:01:24:24:00:08:01:05:24:08:00 SRC=192.168.0.10
</I>&gt;<i> DST=192.168.0.1 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP
</I>&gt;<i> SPT=54916 DPT=3128 WINDOW=0 RES=0x00 RST URGP=0 [17-Jul-2017; 19:49:13.590236] IP[IN]: IN=br0 OUT=
</I>&gt;<i> MAC=24:01:00:00:01:24:24:00:08:01:05:24:08:00 SRC=192.168.0.10
</I>&gt;<i> DST=192.168.0.1 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP
</I>&gt;<i> SPT=54916 DPT=3128 WINDOW=0 RES=0x00 RST URGP=0 [18-Jul-2017; 13:02:19.162684] IP[IN]: IN=br0 OUT=
</I>&gt;<i> MAC=24:01:00:00:01:24:24:ff:ff:ff:ff:24:08:00 SRC=192.168.0.2
</I>&gt;<i> DST=192.168.0.1 LEN=40 TOS=0x00 PREC=0x00 TTL=128 ID=28792 DF PROTO=TCP
</I>&gt;<i> SPT=1219 DPT=3128 WINDOW=65125 RES=0x00 ACK FIN URGP=0 [18-Jul-2017; 13:02:19.593099] IP[IN]: IN=br0 OUT=
</I>&gt;<i> MAC=24:01:00:00:01:24:24:ff:ff:ff:ff:24:08:00 SRC=192.168.0.2
</I>&gt;<i> DST=192.168.0.1 LEN=109 TOS=0x00 PREC=0x00 TTL=128 ID=28797 DF PROTO=TCP
</I>&gt;<i> SPT=1219 DPT=3128 WINDOW=65125 RES=0x00 ACK PSH FIN URGP=0&lt;END dmesg&gt;
</I>&gt;<i>
</I>&gt;<i> 192.168.0.1  is the router itself
</I>&gt;<i> 192.168.0.10  is a VM running another squid, using the router box as parent proxy
</I>&gt;<i> 192.168.0.2   is my windows box
</I>&gt;<i>
</I>&gt;<i> why are these packets blocked?
</I>&gt;<i>
</I>&gt;<i> by the way the router box has of course more interfaces a br0 (LAN) and eth1 (WAN), where can I ensure that squid only listens to the LAN IP?
</I>&gt;<i>
</I>&gt;<i> &lt;BEGIN squid.conf&gt;
</I>&gt;<i> acl localnet src 192.168.0.0/24
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80                # http
</I>&gt;<i> acl Safe_ports port 21                # ftp
</I>&gt;<i> acl Safe_ports port 443                # https
</I>&gt;<i> acl Safe_ports port 70                # gopher
</I>&gt;<i> acl Safe_ports port 1025-65535        # unregistered ports
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> # And finally deny all other access to this proxy http_access deny all
</I>&gt;<i>
</I>&gt;<i> # and finally allow by default
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i>
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128
</I>&gt;<i>
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> cache_dir ufs /var/spool/squid 16400 16 256
</I>&gt;<i>
</I>&gt;<i> # Leave coredumps in the first cache dir coredump_dir /var/spool/squid
</I>&gt;<i>
</I>&gt;<i> acl crl-mime rep_mime_type application/x-pkcs7-crl no_cache deny crl-mime
</I>&gt;<i>
</I>&gt;<i> icon_directory /usr/share/squid/icons
</I>&gt;<i> error_directory /etc/squid/errors
</I>&gt;<i>
</I>&gt;<i> logformat combined %&gt;A %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %Ss:%Sh access_log /var/log/squid/access.log combined
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^ftp:                1440        20%        10080
</I>&gt;<i> refresh_pattern ^gopher:        1440        0%        1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0        0%        0
</I>&gt;<i> refresh_pattern .                0        20%        4320
</I>&gt;<i> &lt;END squid.conf&gt;
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Walter
</I>&gt;<i>
</I>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015987.html">[squid-users] Packets logged as blocked even Firewall (IPtables) accepts them ...
</A></li>
	<LI>Next message (by thread): <A HREF="015956.html">[squid-users] Problem with login to website by Squid web proxy	3.5.20 on Centos 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15988">[ date ]</a>
              <a href="thread.html#15988">[ thread ]</a>
              <a href="subject.html#15988">[ subject ]</a>
              <a href="author.html#15988">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
