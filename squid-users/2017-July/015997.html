<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Version 3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Version%203.5.20&In-Reply-To=%3C18ea1407-e454-3cb5-296c-1ba05c30a653%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015981.html">
   <LINK REL="Next"  HREF="015982.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Version 3.5.20</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Version%203.5.20&In-Reply-To=%3C18ea1407-e454-3cb5-296c-1ba05c30a653%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Version 3.5.20">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 20 00:42:35 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015981.html">[squid-users] Squid Version 3.5.20
</A></li>
        <LI>Next message (by thread): <A HREF="015982.html">[squid-users] Squid Version 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15997">[ date ]</a>
              <a href="thread.html#15997">[ thread ]</a>
              <a href="subject.html#15997">[ subject ]</a>
              <a href="author.html#15997">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>pPS: please respond to the list, responding to people on-list directly 
and cc'ing the list makes the thread view and web forum view all screwed up.

Below is a free audit of your config lines. I suspect  know where your 
problem is, but will followup in the tread where Yuri is posting rather 
than this detatched side-posting.


On 20/07/17 05:36, Cherukuri, Naresh wrote:&gt;
&gt;<i> *From:*Cherukuri, Naresh
</I>&gt;<i> *Sent:* Wednesday, July 19, 2017 9:46 AM
</I>&gt;<i> 
</I>&gt;<i> Hi All,
</I>&gt;<i> 
</I>&gt;<i> I installed Squid version 3.5.20 on RHEL 7 and generated self-signed CA 
</I>&gt;<i> certificates,  My users are complaining about certificate errors. When I 
</I>&gt;<i> looked at cache.log I see so many error messages like below. Below is my 
</I>&gt;<i> squid.conf file. Any ideas how to address below errors.
</I>&gt;<i> 
</I>&gt;<i> Squid.conf:
</I>&gt;<i> 
</I>&gt;<i> max_filedesc 4096
</I>&gt;<i> 
</I>
The directive name should be max_filedescriptors.


&gt;<i> visible_hostname pctysqd2prod
</I>&gt;<i> 
</I>
That directive should contain a FQDN, not just a host name.

&gt;<i> logfile_rotate 10
</I>&gt;<i> 
</I>&gt;<i> access_log stdio:/var/log/squid/access.log squid
</I>&gt;<i> 
</I>
Above are default values, no need to configure in Squid-3+.

&gt;<i> acl localnet src 172.16.0.0/16
</I>&gt;<i> 
</I>&gt;<i> acl backoffice_users src 10.136.0.0/13
</I>&gt;<i> 
</I>&gt;<i> acl hcity_backoffice_users src 10.142.0.0/15
</I>&gt;<i> 
</I>&gt;<i> acl register_users src 10.128.0.0/13
</I>&gt;<i> 
</I>&gt;<i> acl hcity_register_users src 10.134.0.0/15
</I>&gt;<i> 
</I>
If your localnet / LAN ranges are only 172.16/16 what are 10/8 addresses 
doing contacting your proxy?


&gt;<i> acl partycity url_regex partycity
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 21         # ftp
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 70         # gopher
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 210                # wais
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 280                # http-mgmt
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 488                # gss-http
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 591                # filemaker
</I>&gt;<i> 
</I>&gt;<i> #acl Safe_ports port 777                # multiling http
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #acl allowed_sites {dst|dstdomain|dstdom_regex|url_regex) &quot;/path/to/file&quot;
</I>&gt;<i> 
</I>&gt;<i> acl backoffice_allowed_sites url_regex &quot;/etc/squid/backoffice_allowed_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> acl hcity_backoffice_allowed_sites url_regex 
</I>&gt;<i> &quot;/etc/squid/backoffice_allowed_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> acl backoffice_blocked_sites url_regex &quot;/etc/squid/backoffice_blocklist&quot;
</I>&gt;<i> 
</I>&gt;<i> acl hcity_backoffice_blocked_sites url_regex 
</I>&gt;<i> &quot;/etc/squid/backoffice_blocklist&quot;
</I>&gt;<i> 
</I>&gt;<i> acl register_allowed_sites url_regex &quot;/etc/squid/register_allowed_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> acl hcity_register_allowed_sites url_regex 
</I>&gt;<i> &quot;/etc/squid/hcity_register_allowed_sites&quot;
</I>
Hmm, the word &quot;sites&quot; in all these ACL names indicates that you are 
trying to match whole domains / websites - not just a few URLs within 
those sites that happen to match a regex.
  To match a domain use dstdomain, it is MUCH faster than regex.


&gt;<i> 
</I>&gt;<i> http_access allow localnet register_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access deny backoffice_users backoffice_blocked_sites
</I>&gt;<i> 
</I>&gt;<i> http_access deny hcity_backoffice_users backoffice_blocked_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow backoffice_users backoffice_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow hcity_backoffice_users backoffice_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow register_users register_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> http_access allow hcity_register_users hcity_register_allowed_sites
</I>&gt;<i> 
</I>&gt;<i> no_cache deny partycity
</I>
The directive name is &quot;cache&quot;. Also...

Since Squid-3.5 if you actually want to prevent caching of those 
partycity URLs please use &quot;store_miss deny partycity&quot; instead.

If you want to *allow* the partycity URLs to cache, you need not 
configure cache / no_cache / store_miss.


&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
Nothing below this lines will have any effect at all. Sadly you have 
move the most critical security controls down below here.


&gt;<i> #http_access allow manager localhost
</I>&gt;<i> 
</I>&gt;<i> #http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> 
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access  allow CONNECT SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> 
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> 
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> 
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> 
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> 
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> 
</I>&gt;<i> #http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>
All your http_access rules should be in here around the localnet and 
localhost allow lines. Then you can also remove the above &quot;deny all&quot; 
line and make the one below do what it is supposed to do.

&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump \
</I>&gt;<i> 
</I>&gt;<i> key=/etc/squid/pctysquid2sslcerts/pctysquid2prod.pkey \
</I>&gt;<i> 
</I>&gt;<i> cert=/etc/squid/pctysquid2sslcerts/pctysquid2prod.crt \
</I>&gt;<i> 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>
Okay so TLS ClientHello gets peeked at, then everything gets bumped.

Fine, but be aware that any sites or client Apps using cert pinning (eg. 
chrome when contacting Google, mobile apps calling their home site, 
etc). will completely cease to work through your proxy.

Also, no ssl_bump lines below this one will do anything.


&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
Please remove the above completely from your config. It is all based on 
temporary hacks from Squid-3.0 era or complete wrong misunderstanding 
about how TLS works.

You should expect that change to show *more* errors than you are seeing 
right now. Those are problems that do need fixing rather than just 
hiding from your logs (they still screw people over, just not logged).

You may find that you have to &quot;sslproxy_cert_error allow&quot; for some 
errors, but *ONLY* allow specific ones as needed - do not allow anything 
to happen silently like above does.


Cheers
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015981.html">[squid-users] Squid Version 3.5.20
</A></li>
	<LI>Next message (by thread): <A HREF="015982.html">[squid-users] Squid Version 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15997">[ date ]</a>
              <a href="thread.html#15997">[ thread ]</a>
              <a href="subject.html#15997">[ subject ]</a>
              <a href="author.html#15997">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
