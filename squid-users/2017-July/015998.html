<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Version 3.5.20 Any Ideas
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Version%203.5.20%20Any%20Ideas&In-Reply-To=%3C95daaf62-11e1-283f-8c24-81f53323626f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015994.html">
   <LINK REL="Next"  HREF="016015.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Version 3.5.20 Any Ideas</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Version%203.5.20%20Any%20Ideas&In-Reply-To=%3C95daaf62-11e1-283f-8c24-81f53323626f%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Version 3.5.20 Any Ideas">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 20 00:55:09 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015994.html">[squid-users] Squid Version 3.5.20 Any Ideas
</A></li>
        <LI>Next message (by thread): <A HREF="016015.html">[squid-users] Squid Version 3.5.20 Any Ideas
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15998">[ date ]</a>
              <a href="thread.html#15998">[ thread ]</a>
              <a href="subject.html#15998">[ subject ]</a>
              <a href="author.html#15998">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/07/17 09:10, Yuri wrote:
&gt;<i> Aha,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 20.07.2017 3:04, Cherukuri, Naresh &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yuri,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am sorry I didn&#8217;t get you I already installed certificate on all 
</I>&gt;&gt;<i> clients(trusted root certificate authorities). You want me install 
</I>&gt;&gt;<i> proxy public key also on clients, if so were should I put the proxy 
</I>&gt;&gt;<i> public key. Below is my squid.conf file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid.conf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> key=/etc/squid/pctysquid2sslcerts/pctysquid2prod.pkey \ proxy ca 
</I>&gt;&gt;<i> public key??
</I>&gt;&gt;<i>
</I>&gt;<i> This is proxy private key AFAIK.
</I>
Correct. It should be the proxy private key. If the public key is put in 
there and startup actually succeeds I'm not sure what broken runtime 
errors will occur - nothing good anyhow.

Also, note that cert= parameter should be configured *before* the key= 
parameter so Squid loads them from the right place. The very latest 
releases (v4+) will fail to start if the ordering is wrong, so best to 
prepare for that now.


I suspect that part of the problem here is what is being configured in 
that cert= parameter. For SSL-Bump ports in current Squid it needs to 
contains the self-signed *CA* certificate that Squid is using to 
generate other certs from, the key= being the private key of that CA cert.

If you generate a regular proxy cert and load it there (like normal 
proxy cert= would use) the bumping process will get all broken.


The ConfigExample page Yuri linked to earlier had the exact and full 
process to follow for setting up the multiple different certs, keys and 
file types involved with SSL-Bump.


&gt;&gt;<i>
</I>&gt;&gt;<i> cert=/etc/squid/pctysquid2sslcerts/pctysquid2prod.crt \(installed 
</I>&gt;&gt;<i> certificate on IE all clients as a trusted root certificate authorities)
</I>&gt;&gt;<i>
</I>&gt;<i> Yes, if it installed into clients - this is ok.
</I>&gt;<i> 
</I>&gt;<i> So. The only reason I can see - proxy can't see OpenSSL CA's bundle.
</I>&gt;<i> 
</I>&gt;<i> To make it work you should add to your squid's config one of this:
</I>&gt;<i> 
</I>&gt;<i> #  TAG: sslproxy_cafile
</I>&gt;<i> #    file containing CA certificates to use when verifying server
</I>&gt;<i> #    certificates while proxying <A HREF="https://">https://</A> URLs
</I>&gt;<i> #Default:
</I>&gt;<i> # none
</I>&gt;<i> 
</I>&gt;<i> #  TAG: sslproxy_capath
</I>&gt;<i> #    directory containing CA certificates to use when verifying
</I>&gt;<i> #    server certificates while proxying <A HREF="https://">https://</A> URLs
</I>&gt;<i> #Default:
</I>&gt;<i> # none
</I>
Er, those are for Squid-&gt;server connections. You were correct about the 
errors referring to client-&gt;Squid connections, so these are irrelevant.

If anything, the  cafile= parameter of the ssl-bump port might be 
needed. Then it should point at the same CA's found in the cert= 
parameter (bit weird, but that is bugs in the SSL-Bump config design).

FTR: those particular errors occur when Squid accepts a connection from 
a client, begins the TLS handshake and the client suddenly disconnects 
before the handshake is complete.
  The &quot;certificate unknown&quot; seems to be saying that either 1) the client 
sent a client-cert to Squid and OpenSSL did not accept it, or 2) that 
the client did not accept the auto-generated cert Squid sent.

If (1) is happening it s because the browser was not correctly 
configured with the self-signed CA public cert.

If (2) is happening, then probably the cert=, key=, cafile= parameters 
on the ssl-bump port are not configured right, OR browser was not 
correctly configured with the self-signed CA public cert.

Or, maybe bugs in that particular Squid release SSL-Bump code. We are 
constantly fixing them and 3.5.20 is now a whole year behind with 
SSL-Bump fixes - many of them rather major behaviour fixes.


==&gt; Best Practice to follow with SSL-Bump is that when having *any* 
problems with the SSL-Bump process try the latest Squid release first 
before spending time trying to figure it out.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015994.html">[squid-users] Squid Version 3.5.20 Any Ideas
</A></li>
	<LI>Next message (by thread): <A HREF="016015.html">[squid-users] Squid Version 3.5.20 Any Ideas
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15998">[ date ]</a>
              <a href="thread.html#15998">[ thread ]</a>
              <a href="subject.html#15998">[ subject ]</a>
              <a href="author.html#15998">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
