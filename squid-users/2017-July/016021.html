<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid box for two networks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20box%20for%20two%20networks&In-Reply-To=%3C03eb01d30196%24e402fe80%24ac08fb80%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016029.html">
   <LINK REL="Next"  HREF="015954.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid box for two networks</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20box%20for%20two%20networks&In-Reply-To=%3C03eb01d30196%24e402fe80%24ac08fb80%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Squid box for two networks">eliezer at ngtech.co.il
       </A><BR>
    <I>Thu Jul 20 20:29:30 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016029.html">[squid-users] Squid box for two networks
</A></li>
        <LI>Next message (by thread): <A HREF="015954.html">[squid-users] Packets logged as blocked even Firewall (IPtables)	accepts them ...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16021">[ date ]</a>
              <a href="thread.html#16021">[ thread ]</a>
              <a href="subject.html#16021">[ subject ]</a>
              <a href="author.html#16021">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>First take joseph advice.
This is the right way of doing things.
And since I have here couple MikroTik devices sitting I took one to create the same scenario that you have and the full configuration can be seen at:
<A HREF="http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MikroTik-Route-To-Intercept-Squid">http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MikroTik-Route-To-Intercept-Squid</A>

And on my site at:
<A HREF="http://ngtech.co.il/paste/1786/raw/">http://ngtech.co.il/paste/1786/raw/</A>

Technically since the px is on the same segment as the MikroTik it's better to accept traffic(in both the mangle and the filter tables) by the mac address of the px rather then the ip but for your case the ip should play fine with the combination of the interface which the traffic from the px flows in\at.
When it will all work for you as expected I will add this scenario with your network diagram as an example to the wiki(if it's fine with you that the project will use the diagram..).

Thanks,
Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Pablo Ruben Maldonado
Sent: Thursday, July 20, 2017 21:51
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid box for two networks

Hi Eliezer, thanks for you reply.

I'm marking and routing traffic to port 80 from my lan's <A HREF="http://192.168.110.0/24">http://192.168.110.0/24</A> (Work!) and <A HREF="http://192.168.115.0/24">http://192.168.115.0/24</A> (Fail!). The mark line in Mangle is:

add action=mark-connection chain=prerouting comment=&quot;TCP 80: Tr\E1fico HTTP de\
    sde la red WIFI. Se marca la conexi\F3n para QoS y Policy Routing. Ser\E1 \
    routeado hacia Proxy03&quot; !connection-bytes !connection-limit \
    connection-mark=no-mark !connection-nat-state !connection-rate \
    !connection-state !connection-type !content disabled=no !dscp \
    !dst-address !dst-address-list !dst-address-type !dst-limit dst-port=80 \
    !fragment !hotspot !icmp-options !in-bridge-port in-interface=eth4-wifi \
    !ingress-priority !ipsec-policy !ipv4-options !layer7-protocol !limit \
    log=no log-prefix=&quot;&quot; new-connection-mark=conn_proxy !nth !out-bridge-port \
    !out-interface !p2p !packet-mark !packet-size passthrough=yes \
    !per-connection-classifier !port !priority protocol=tcp !psd !random \
    !routing-mark !routing-table src-address=<A HREF="http://192.168.115.0/24">http://192.168.115.0/24</A> !src-address-list \
    !src-address-type !src-mac-address !src-port !tcp-flags !tcp-mss !time \
    !ttl

The packet mark and route lines:

add action=mark-packet chain=prerouting comment=\
    &quot;TCP 80: Se marca el paquete para Queue Tree (Up)&quot; !connection-bytes \
    !connection-limit connection-mark=conn_proxy !connection-nat-state \
    !connection-rate !connection-state !connection-type !content disabled=no \
    !dscp !dst-address !dst-address-list !dst-address-type !dst-limit \
    !dst-port !fragment !hotspot !icmp-options !in-bridge-port !in-interface \
    !ingress-priority !ipsec-policy !ipv4-options !layer7-protocol !limit \
    log=no log-prefix=&quot;&quot; new-packet-mark=up_tcp_80_pkt !nth !out-bridge-port \
    !out-interface !p2p !packet-mark !packet-size passthrough=yes \
    !per-connection-classifier !port !priority !protocol !psd !random \
    !routing-mark !routing-table !src-address !src-address-list \
    !src-address-type !src-mac-address !src-port !tcp-flags !tcp-mss time=\
    0s-1d,sun,mon,tue,wed,thu,fri,sat !ttl
add action=mark-routing chain=prerouting comment=\
    &quot;TCP 80: Se ejecuta el Policy Routing hacia Proxy03&quot; !connection-bytes \
    !connection-limit !connection-mark !connection-nat-state !connection-rate \
    !connection-state !connection-type !content disabled=no !dscp \
    !dst-address dst-address-list=!clientslist !dst-address-type !dst-limit \
    !dst-port !fragment !hotspot !icmp-options !in-bridge-port !in-interface \
    !ingress-priority !ipsec-policy !ipv4-options !layer7-protocol !limit \
    log=no log-prefix=&quot;&quot; new-routing-mark=route_toproxy03 !nth \
    !out-bridge-port !out-interface !p2p packet-mark=up_tcp_80_pkt \
    !packet-size passthrough=no !per-connection-classifier !port !priority \
    !protocol !psd !random !routing-mark !routing-table !src-address \
    !src-address-list !src-address-type !src-mac-address !src-port !tcp-flags \
    !tcp-mss !time !ttl

Thanks

On Thu, Jul 20, 2017 at 2:11 PM, Eliezer Croitoru &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
Hey Pablo,

I am working as a tech support for MikroTik devices and the tcpdump dumps are leaving couple things unknown.
Can you share the MikroTik rules PBR rules you are using?
Are you using any kind of connection marking and tracking in the mix or just plain source based routing?
I am pretty sure that the issue is in the reverse path and not backwards.
If you can export your MikroTik configuration I might be able to try and help you find the right rules if these are wrong.
Also make sure that the squid box has reverse path filtering disabled using:
<A HREF="http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Set_Reverse_Path_Filter_machine_globally_script">http://wiki.squid-cache.org/EliezerCroitoru/Drafts/MwanLB#Set_Reverse_Path_Filter_machine_globally_script</A>

And also take a peek at:
<A HREF="http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2#Linux_and_Squid_Configuration">http://wiki.squid-cache.org/ConfigExamples/UbuntuTproxy4Wccp2#Linux_and_Squid_Configuration</A>

I planned to add into the wiki an article\tutorial how to setup squid with MikroTik since there are more than a dozen of articles\tutorials that just do not do it the right way.

Eliezer

* you can send me the configuration privately if these are sensitive

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: squid-users [mailto:mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Pablo Ruben Maldonado
Sent: Thursday, July 20, 2017 16:41
To: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid box for two networks

The packets are routing using a mark and later routing rules inside my principal router (Mikrotik). Attach images with examples of packets arriving to Squid box.

On Thu, Jul 20, 2017 at 10:27 AM, Antony Stone &lt;mailto:mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Antony.Stone at squid.open.source.it</A>&gt; wrote:
On Thursday 20 July 2017 at 14:08:27, Pablo Ruben Maldonado wrote:

&gt;<i> Hi, i add information missing in original post. Thanks for assistance:
</I>&gt;<i>
</I>&gt;<i> The Squid Box has setup for Intercept Mode. Iptables rules here:
</I>&gt;<i>
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3128
</I>&gt;<i> -A PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3129
</I>
How are you routing the packets from the firewall to Squid?

&gt;<i> The config paste in <A HREF="https://pastebin.com/Witg3cG1">https://pastebin.com/Witg3cG1</A>
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> On Mon, Jul 17, 2017 at 5:31 PM, Pablo Ruben Maldonado &lt;
</I>&gt;<i>
</I>&gt;<i> mailto:mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">pablo.ruben.maldonado at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hello, I have a squid box 3.5 working without problems for the lan
</I>&gt;<i> &gt; <A HREF="http://192.168.110.0/24">http://192.168.110.0/24</A> for several months. Now I want setup to another lan
</I>&gt;<i> &gt; <A HREF="http://192.168.115.0/24">http://192.168.115.0/24</A> but I cannot. Tcpdump inform me that the packages come
</I>&gt;<i> &gt; to squid box. But in Squid's log I do not see anything. Can they give me
</I>&gt;<i> &gt; some tip?
</I>
Can you give us any examples of packets as seen by tcpdump on the Squid box:

a) from <A HREF="http://192.168.110.0/24">http://192.168.110.0/24</A>

b) from <A HREF="http://192.168.115.0/24">http://192.168.115.0/24</A>


Antony.

--
BASIC is to computer languages what Roman numerals are to arithmetic.

                                                   Please reply to the list;
                                                         please *don't* CC me.
_______________________________________________
squid-users mailing list
mailto:mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016029.html">[squid-users] Squid box for two networks
</A></li>
	<LI>Next message (by thread): <A HREF="015954.html">[squid-users] Packets logged as blocked even Firewall (IPtables)	accepts them ...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16021">[ date ]</a>
              <a href="thread.html#16021">[ thread ]</a>
              <a href="subject.html#16021">[ subject ]</a>
              <a href="author.html#16021">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
