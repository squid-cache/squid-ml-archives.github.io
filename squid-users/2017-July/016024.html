<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as gateway
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20gateway&In-Reply-To=%3Cb0bb8266-7f7d-bd89-13b5-e1a096444653%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016023.html">
   <LINK REL="Next"  HREF="016025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as gateway</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20gateway&In-Reply-To=%3Cb0bb8266-7f7d-bd89-13b5-e1a096444653%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid as gateway">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 21 13:18:52 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016023.html">[squid-users] Squid as gateway
</A></li>
        <LI>Next message (by thread): <A HREF="016025.html">[squid-users] Squid as gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16024">[ date ]</a>
              <a href="thread.html#16024">[ thread ]</a>
              <a href="subject.html#16024">[ subject ]</a>
              <a href="author.html#16024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/07/17 07:07, erdosain9 wrote:
&gt;<i> Hi, and thank you all.
</I>&gt;<i> 
</I>&gt;<i> Well this is the diagram.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> INTERNET
</I>&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> FIREWALL (10.1.158.1/24)
</I>&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> SQUID (2 interfaces) 10.1.158.2/24
</I>&gt;<i>                                  192.168.1.20/24
</I>
This machine called SQUID need to be configured as a router.

You mentioned the GW route for the device below, but what are the two GW 
routes (10/8 gw ??? , and 192.168/16 gw ???) this SQUID machine should have?


&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> ROUTERWIFI( WAN----static ip 192.168.1.40/24 gw 192.168.1.20) LAN
</I>&gt;<i> 192.168.0.1/24)
</I>
That looks okay.

But double-check that this machine is *NOT* performing NAT on any of the 
outgoing packets sent to 192.168.1.20.


&gt;<i> 
</I>&gt;<i> squid config:
</I>&gt;<i> 
</I>&gt;<i> acl red1 src 192.168.1.0/24
</I>
That permits the ROUTERWIFI machine to send traffic from itself (only) 
to Squid. Such traffic should be an extreme rarity - usually just you 
testing HTTP connectivity from that machine manually.

This Squid should be expecting to receive traffic from 192.168.0.0/24 
machines. If you do not change this I expect you will start to see 
DENIED lines being logged by Squid when you fix the packet arrival problem.


&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 8443
</I>&gt;<i> acl SSL_ports port 8080
</I>&gt;<i> acl SSL_ports port 20000
</I>&gt;<i> acl SSL_ports port 10000
</I>&gt;<i> acl SSL_ports port 2083
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 631         # httpCUPS
</I>&gt;<i> acl Safe_ports port 85
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 8443        # httpsalt
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl Safe_ports port 8080        # edesur y otros
</I>
NP: those 8080 and 8443 are included in the 1025-65535 entry above.

&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow red1
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 192.168.1.20:3128
</I>&gt;<i> http_port 192.168.1.20:3129 intercept
</I>
You should not have to specify any IP address here.
eg.
   http_port 3128
   http_port 3129 intercept

Squid will then be able to receive the NAT'd traffic no matter what 
system NAT rules contain.


&gt;<i> 
</I>...
&gt;<i> #Your refresh_pattern
</I>&gt;<i> refresh_pattern -i \.jpg$ 30 0% 30 ignore-no-cache ignore-no-store
</I>&gt;<i> ignore-private
</I>
NP: ignore-no-cache is no longer existing.

SECURITY WARNING: using ignore-no-store for images will cache Captcha 
images, user avatar icons, personal content from private accounts (think 
snapchat and facebook photos type of stuff).
  ignore-private is not so bad in the latest Squid releases as it used 
to be, but it will not cause much of a HIT ratio increase over default 
behaviour either.


&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 8.8.8.8 8.8.4.4
</I>
Use of 8.8.8.8 and 8.8.4.4 in a Squid which is intercepting traffic 
causes a lot of problems - mostly in the form of &quot;Host verify&quot; security 
alerts and major reduction in HTTP traffic caching.

To work around those problems you need a local DNS server which both 
your client machines and Squid use for recursive resolving. That DNS 
server can use 8.8.8.8 and 8.8.4.4 as its upstream forwarders if you 
actually still need it - having your own local resolver pretty much 
obsoletes all the benefits 8.8.8.8 claim to provide.


&gt;<i> 
</I>&gt;<i> -----------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> I probe this, nothing work..............
</I>&gt;<i> ---------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -s 192.168.1.20 -p tcp --dport 80 -j ACCEPT
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination
</I>&gt;<i> 192.168.1.20:3129
</I>&gt;<i> iptables -t nat -A POSTROUTING -j MASQUERADE
</I>&gt;<i> iptables -t mangle -A PREROUTING -p tcp --dport 3129 -j DROP
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -s 192.168.1.20 -p tcp --dport 80 -j ACCEPT
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3129
</I>&gt;<i> iptables -t nat -A POSTROUTING -j MASQUERADE
</I>&gt;<i> iptables -t mangle -A PREROUTING -p tcp --dport 3129 -j DROP
</I>&gt;<i> 
</I>&gt;<i> -----------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> 
</I>
Both of those look fine for the NAT rules on SQUID box - they only do 
the NAT part, not any of the packet routing.

The problem I think is in the routing setup on the SQUID machine, and 
maybe the ROUTERWIFI.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016023.html">[squid-users] Squid as gateway
</A></li>
	<LI>Next message (by thread): <A HREF="016025.html">[squid-users] Squid as gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16024">[ date ]</a>
              <a href="thread.html#16024">[ thread ]</a>
              <a href="subject.html#16024">[ subject ]</a>
              <a href="author.html#16024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
