<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as gateway
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20gateway&In-Reply-To=%3C06df01d3023a%24f91ea450%24eb5becf0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016026.html">
   <LINK REL="Next"  HREF="016028.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as gateway</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20gateway&In-Reply-To=%3C06df01d3023a%24f91ea450%24eb5becf0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Squid as gateway">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Jul 21 16:04:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016026.html">[squid-users] Squid as gateway
</A></li>
        <LI>Next message (by thread): <A HREF="016028.html">[squid-users] Squid as gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16027">[ date ]</a>
              <a href="thread.html#16027">[ thread ]</a>
              <a href="subject.html#16027">[ subject ]</a>
              <a href="author.html#16027">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

Let's split the scenario into two different issues.
- interception
- routing

Since the squidbox is a router you need to first enable it to be a router and also to do NAT for DNS and other services to work.
Means that the MASQUARADE rule is fine but you should limit it only to the specific outgoing interface of the WAN side ie: ens192

And you should define the right iptables rules of the intercept ie:
This is wrong:
pkts bytes target     prot opt in     out     source              
destination         
    0     0 ACCEPT     tcp  --  *      *       192.168.1.20       0.0.0.0/0           
tcp dpt:80
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0           
0.0.0.0/0            tcp dpt:80 to:192.168.1.20:3129


Please post using a send the complete &quot;iptables-save&quot;
So I would be able to see what I'm suspecting.
Technically what you shoul have in the nat table is the next rule:
iptables -t nat -A PREROUTING -I ens192 -p tcp --dport 80 -j REDIRECT --to-port 3129

Then you can try to see using &quot; watch -d iptables -t nat -L -nv&quot; if the rules are being &quot;hit&quot; by the counter.
If the rule doesn't catch the traffic it should be accounted at the POLICY ACCEPT rule.

Let me know if it helps,
Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of erdosain9
Sent: Friday, July 21, 2017 17:19
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid as gateway

Hi, and thanks

The ROUTERWIFI is a TpLink TL-WR940N.... i dont see in this router any Nat
option :-(

This is the router table of the SquidBox

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use
Iface
0.0.0.0         10.1.158.1      0.0.0.0         UG    0      0        0
ens192
10.1.158.0      0.0.0.0         255.255.255.0   U     0      0        0
ens192
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0
ens160
169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0
ens192
192.168.0.0     192.168.1.40    255.255.255.0   UG    0      0        0
ens160
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0
ens160
192.168.2.0     192.168.1.1     255.255.255.0   UG    0      0        0
ens160
192.168.6.0     192.168.1.1     255.255.255.0   UG    0      0        0
ens160

If i enable ipv4 forwarding in SquidBox, the clients of the ROUTERWIFI can
access internet, so i think the router table it's ok.... the clients can go
to internet but just because ipv4 forwarding is enable (the squid service is
not getting anything, i dont see nothing in the access.log...) if i disable
ipv4 forwarding the clients dont go anyway.

This is iptables

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ~]# iptables -nvL -t nat
Chain PREROUTING (policy ACCEPT 383 packets, 42336 bytes)
 pkts bytes target     prot opt in     out     source              
destination         
    0     0 ACCEPT     tcp  --  *      *       192.168.1.20       0.0.0.0/0           
tcp dpt:80
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0           
0.0.0.0/0            tcp dpt:80 to:192.168.1.20:3129

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source              
destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source              
destination         

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source              
destination         
    0     0 MASQUERADE  all  --  *      *       0.0.0.0/0           
0.0.0.0/0 



--
View this message in context: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-as-gateway-tp4683022p4683200.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-as-gateway-tp4683022p4683200.html</A>
Sent from the Squid - Users mailing list archive at Nabble.com.
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016026.html">[squid-users] Squid as gateway
</A></li>
	<LI>Next message (by thread): <A HREF="016028.html">[squid-users] Squid as gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16027">[ date ]</a>
              <a href="thread.html#16027">[ thread ]</a>
              <a href="subject.html#16027">[ subject ]</a>
              <a href="author.html#16027">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
