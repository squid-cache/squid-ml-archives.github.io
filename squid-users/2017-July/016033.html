<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3C688b3f4f-c479-9750-56f5-5e6072c4359b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016031.html">
   <LINK REL="Next"  HREF="016040.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3C688b3f4f-c479-9750-56f5-5e6072c4359b%40treenet.co.nz%3E"
       TITLE="[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 26 04:42:06 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016031.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="016040.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16033">[ date ]</a>
              <a href="thread.html#16033">[ thread ]</a>
              <a href="subject.html#16033">[ subject ]</a>
              <a href="author.html#16033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/07/17 10:56, Lei Wen wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I am setting up a transparent proxy that is doing whitelist work, and at 
</I>&gt;<i> the same time, doing the cache work.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The whitelist works fine, HTTP cache verifed work cause I see 
</I>&gt;<i> TCP_MEM_HIT using this squid.conf, but don't see any HTTPS MEM HIT 
</I>&gt;<i> related log, every time seems a new connection.
</I>

Nod. HIT and REFRESH log entries show cache usage. Squid versions with 
SSL-Bump support are more likely to show REFRESH.


&gt;<i> 
</I>&gt;<i> For HTTPS traffic, I am getting TCP_TUNNEL/200 all the time, the 
</I>&gt;<i> question is, how can I tell that a HTTPS traffic is actually using 
</I>&gt;<i> cache, or in this case, it's not using cache at all for HTTPS. I am 
</I>&gt;<i> using forward-proxy port in cache_peer.
</I>
That TUNNEL shows SSL-Bump splice action happening, or SSL-Bump not even 
being considered (ie traffic received in your Squids' port 3130 and 3128).


&gt;<i> 
</I>&gt;<i> I understand that there is logformat to make access.log show hostname 
</I>&gt;<i> instead of ip, but this should not effect the MEM HIT log, right?
</I>&gt;<i> 
</I>&gt;<i> Meanwhile, I am also trying to setup the sibling cache cluster, not sure 
</I>&gt;<i> if this related to HTTPS cache, I am also getting TCP_DENIED/403 
</I>&gt;<i> for squid-internal-dynamic/netdb - HIER_NONE/- text/html. I do see 
</I>&gt;<i> sibling hit for HTTP site.
</I>&gt;<i> 
</I>
You have configured splice or terminate. No bumping / decryption will 
ever happen, so the cache is never even considered for use.


&gt;<i> And my squid.conf
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 3130
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> 
</I>&gt;<i> acl allowed_http_sites dstdomain &quot;/etc/squid3/whitelist.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access allow allowed_http_sites
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> https_port 3129 cert=/etc/squid3/squid.crt key=/etc/squid3/squid.key 
</I>&gt;<i> ssl-bump intercept generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> 
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> 
</I>
There are now almost no restrictions on port 443. Anyone can get through 
it so long as they claim to be contacting one of the allowed_https_sites 
(a the HTTP CONNECT level, not the TLS is unrestricted).
That includes traffic in the ports 3130 and 3128 which are not 
considered for ssl_bump processing.



&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid3/ssl_sites.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> #sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /lib/squid3/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> 
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step2 allowed_https_sites
</I>
dstdomain ACL is not reliable in ssl_bump. It uses the HTTP URI domain 
from the previous CONNECT instead of the actual TLS details.
Use ssl::server_name ACL type instead.

&gt;<i> 
</I>&gt;<i> ssl_bump splice step3 allowed_https_sites
</I>&gt;<i> 
</I>&gt;<i> ssl_bump terminate step2 all
</I>
So what happens when the server TLS cert reveals it is not actually 
serving up one of the allowed_https_sites? nothing, the traffic is 
allowed through.


Note the terminate line only gets used at step2 (ie. based on client SNI 
claims alone). The peek at step2 has precluded / prohibited bump from 
happening at step3, which only leaves splice as being possible.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016031.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="016040.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16033">[ date ]</a>
              <a href="thread.html#16033">[ thread ]</a>
              <a href="subject.html#16033">[ subject ]</a>
              <a href="author.html#16033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
