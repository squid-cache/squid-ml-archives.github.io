<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Delay_pools problem in Squid 3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay_pools%20problem%20in%20Squid%203.5.20&In-Reply-To=%3C4add0902-bac9-98bb-bc27-067de05be028%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016032.html">
   <LINK REL="Next"  HREF="016036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Delay_pools problem in Squid 3.5.20</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay_pools%20problem%20in%20Squid%203.5.20&In-Reply-To=%3C4add0902-bac9-98bb-bc27-067de05be028%40treenet.co.nz%3E"
       TITLE="[squid-users] Delay_pools problem in Squid 3.5.20">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 26 05:35:50 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016032.html">[squid-users] Delay_pools problem in Squid 3.5.20
</A></li>
        <LI>Next message (by thread): <A HREF="016036.html">[squid-users] Cache poisoning vulnerability 3.5.23
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16034">[ date ]</a>
              <a href="thread.html#16034">[ thread ]</a>
              <a href="subject.html#16034">[ subject ]</a>
              <a href="author.html#16034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/07/17 13:49, Alex Tang wrote:
&gt;<i> Dear All,
</I>&gt;<i> 
</I>&gt;<i> I had installed a squid 3.5.20 on Centos7. I'm also setting up a 
</I>&gt;<i> delay_pools and cache_peer function on this squid server .
</I>&gt;<i> 
</I>&gt;<i> but I don't know why delay_pools function not working now. before I 
</I>&gt;<i> tested is OK and I can limit user download less then 512 kb. but now, 
</I>&gt;<i> all user download is over 512kb and can't control. I tried reboot the 
</I>&gt;<i> squid or use the other delay_pools command to try to test which part has 
</I>&gt;<i> problem to cause the delay_pools problem. I've checked my config file 
</I>&gt;<i> seem OK (this is my first time to install and use squid proxy server) , 
</I>&gt;<i> would you mind tell me is it my config problem or squid bug (maybe)
</I>&gt;<i> 
</I>
What do you mean exactly by &quot;before I tested is OK&quot;. The same Squid 
version? the same config file?



&gt;<i> here is my full config file.
</I>&gt;<i> 
</I>&gt;<i> ====================================================
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> acl localnet src 10.0.0.0/8 &lt;<A HREF="http://10.0.0.0/8">http://10.0.0.0/8</A>&gt;# RFC1918 possible 
</I>&gt;<i> internal network
</I>&gt;<i> acl localnet src 111.11.0.0/12 &lt;<A HREF="http://111.11.0.0/12">http://111.11.0.0/12</A>&gt;# RFC1918 possible 
</I>&gt;<i> internal network
</I>&gt;<i> acl localnet src 11.123.0.0/16 &lt;<A HREF="http://11.123.0.0/16">http://11.123.0.0/16</A>&gt;# RFC1918 possible 
</I>&gt;<i> internal network
</I>
Ah, 111/8 and 11/8 are not RFC 1918 network ranges. If you have been 
assigned those ranges and are using them internally that is fine, but 
remove the RFC1918 comment to avoid confusing anyone about them.


&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) 
</I>&gt;<i> machines
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443 563
</I>&gt;<i> acl Safe_ports port 80# http
</I>&gt;<i> acl Safe_ports port 21# ftp
</I>&gt;<i> #acl Safe_ports port 443# https
</I>&gt;<i> acl Safe_ports port 70# gopher
</I>&gt;<i> acl Safe_ports port 210# wais
</I>&gt;<i> #acl Safe_ports port 1025-65535# unregistered ports
</I>&gt;<i> acl Safe_ports port 280# http-mgmt
</I>&gt;<i> acl Safe_ports port 488# gss-http
</I>&gt;<i> acl Safe_ports port 591# filemaker
</I>&gt;<i> acl Safe_ports port 777# multiling http
</I>&gt;<i> #acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> #http_access allow !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> #http_access allow CONNECT !SSL_ports
</I>&gt;<i> 
</I>
Do not do the above commenting-out of those lines. They are the basic 
security protection against certain types of DoS and attacks on your 
proxy. Which is also why they should always be first.


&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> icp_port 3130
</I> &gt;
&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> #refresh_pattern ^ftp:144020%10080
</I>&gt;<i> #refresh_pattern ^gopher:14400%1440
</I>&gt;<i> #refresh_pattern -i (/cgi-bin/|\?) 00%0
</I>&gt;<i> #refresh_pattern .020%4320
</I>
The above refresh_pattern lines are tuned specifically for HTTP/1.1 
required behaviour with dynamic content. If you are caching I highly 
recommend leaving them active. If you are not using caching they are 
irrelevant.

&gt;<i> 
</I>&gt;<i> http_port 8000 name=port_8000
</I>&gt;<i> http_port 8001 name=port_8001
</I>&gt;<i> 
</I>&gt;<i> nonhierarchical_direct off
</I>&gt;<i> 
</I>&gt;<i> acl port_8000_acl myportname port_8000
</I>&gt;<i> acl port_8001_acl myportname port_8001
</I>&gt;<i> 
</I>&gt;<i> always_direct deny port_8000_acl
</I>&gt;<i> always_direct deny port_8001_acl
</I>&gt;<i> 
</I>&gt;<i> never_direct allow port_8000_acl
</I>&gt;<i> never_direct allow port_8001_acl
</I>&gt;<i> 
</I>
The above are redundant. always_direct overrides never_direct. The 
normal practice is to use only never_direct to forbid use of DNS 
identified origin servers and leave the cache_peer as an available routing.


&gt;<i> # 8000
</I>&gt;<i> cache_peer xxx.xxxx.com parent 8000 3130 weight=20 
</I>&gt;<i> no-digest no-query name=proxy8000
</I>&gt;<i> cache_peer_access proxy8000 allow port_8000_acl
</I>&gt;<i> cache_peer_access proxy8000 deny all
</I>&gt;<i> 
</I>&gt;<i> # 8001
</I>&gt;<i> cache_peer xxx.xxxx.com parent 8001 3130 weight=20 
</I>&gt;<i> no-digest no-query name=proxy8001
</I>&gt;<i> cache_peer_access proxy8001 allow port_8001_acl
</I>&gt;<i> cache_peer_access proxy8001 deny all
</I>&gt;<i> 
</I>&gt;<i> cache_mem 100 MB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl work_day time MTWHFAS 09:00-18:30
</I>&gt;<i> acl BBHK src 11.123.0.0/16
</I>&gt;<i> delay_pools 1
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 -1/-1 512000/512000
</I>&gt;<i> delay_access 1 allow work_day
</I>&gt;<i> delay_access 1 allow BBHK
</I>

Three things to be careful about. I order them here based on the 
likelihood that they are your problem:

  1) the work_day times are in 'local time', according to whatever the 
local wall-clock of your Squid machine is set to.

   This local time detail can catch people out if the production proxy 
is set to use UTC as its local time, or is hosted in another timezone 
(ie cloud service).

  2) delay pools operate by limiting Squid-&gt;server connection traffic. 
That means that cache HITs are not delayed. Also, HTTP/1.1 revalidations 
use very much less server connection bytes compared to client connection 
bytes. So the delay may have the appearance of not working, even when 
working perfectly.
   For proper bandwidth shaping it is best to use your system QoS 
functionality, not Squid delay pools. Especially given your criteria 
does not actually use any HTTP layer details to classify the traffic for 
delay.



  3) these lines form an OR condition. The BBHK are *always* delayed, 
and so is every client during the work_day times.

Check carefully where (from what client IPs to what proxy IPs), how, and 
when your previous working tests were done compared to the current 
non-working situation.


  4) the delay pools measure traffic in Bytes (KB or kB) not bits (Kb or 
kb). KB/sec limits are 8x larger than kb/sec.

I assume your &quot;kb&quot; word was just sloppy typing. But if you did mean bits 
this could be affecting your measurement results.


&gt;<i> 
</I>&gt;<i> acl QUERY urlpath_regex cgi-bin \?
</I>&gt;<i> no_cache deny QUERY
</I>
The above is a misconfiguration in Squid-3. The refresh_pattern which 
you commented out are the correct way to prevent broken dynamic content 
caching.

&gt;<i> maximum_object_size 2048 KB
</I>&gt;<i> ipcache_size 1024
</I>&gt;<i> ipcache_low 90
</I>&gt;<i> ipcache_high 95
</I>&gt;<i> fqdncache_size 1024
</I>&gt;<i> logformat squid      %ts.%03tu %6tr %&gt;A %Ss/%03&gt;Hs %&lt;st %rm %ru %[un 
</I>&gt;<i> %Sh/%&lt;a %mt
</I>
Please do not re-define the &quot;squid&quot; format name. Current Squid releases 
will ignore your definition, and the log will not end up with what you 
want in it (the real built-in format does not have the exact output in 
some cases as those %-codes perform).
  Either use the built-in format (removing those above line), or use a 
different format name for your custom format.


&gt;<i> cache_access_log /var/log/squid/access.log
</I>
cache_access_log is long ago deprecated.

Use access_log instead, like so:
  access_log stdio:/var/log/access.log

or for better performance:
  access_log daemon:/var/log/access.log


&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> pid_filename /var/run/squid.pid
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 30
</I>&gt;<i> auth_param basic program /usr/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 30
</I>&gt;<i> auth_param basic realm Squid proxy-caching web server
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> request_body_max_size 15 MB
</I>&gt;<i> 
</I>
NTLM plus delay pools. Ouch.

&gt;<i> 
</I>&gt;<i> acl AuthorizedUsers proxy_auth REQUIRED
</I>&gt;<i> acl shockwaveplayer browser Shockwave
</I>&gt;<i> acl Java browser Java/1.4 Java/1.5 Java/1.6
</I>&gt;<i> acl BBhknet src &quot;/etc/squid/ACL/allow_net&quot;
</I>&gt;<i> acl allow_ip src &quot;/etc/squid/ACL/allow_ip&quot;
</I>&gt;<i> #acl deny_ip src &quot;/etc/squid/ACL/deny_ip&quot;
</I>&gt;<i> #acl DenyUsers proxy_auth &quot;/etc/squid/ACL/deny_users&quot;
</I>&gt;<i> acl allow_pattern dstdom_regex &quot;/etc/squid/ACL/allow_domain&quot;
</I>&gt;<i> 
</I>&gt;<i> acl allow_sites url_regex &quot;/etc/squid/ACL/allow_url&quot;
</I>&gt;<i> #http_access allow allow_sites
</I>&gt;<i> 
</I>&gt;<i> acl deny_site url_regex &quot;/etc/squid/ACL/deny_url&quot;
</I>&gt;<i> #http_access deny deny_site
</I>&gt;<i> 
</I>&gt;<i> acl deny_pattern dstdom_regex &quot;/etc/squid/ACL/deny_domain&quot;
</I>&gt;<i> #http_access deny deny_pattern
</I>&gt;<i> 
</I>&gt;<i> acl deny_domain dstdom_regex &quot;/etc/squid/ACL/deny_domain&quot;
</I>&gt;<i> acl deny_url url_regex &quot;/etc/squid/ACL/deny_url&quot;
</I>&gt;<i> 
</I>&gt;<i> acl fwdurl dstdomain .salesforce.com &lt;<A HREF="http://salesforce.com">http://salesforce.com</A>&gt; .force.com 
</I>&gt;<i> &lt;<A HREF="http://force.com">http://force.com</A>&gt;
</I>&gt;<i> never_direct allow fwdurl
</I>&gt;<i> 
</I>&gt;<i> acl fwdhkpurl dstdomain &quot;/etc/squid/ACL/fwdhkpdomain&quot;
</I>&gt;<i> never_direct allow fwdhkpurl
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access allow fwdurl
</I>&gt;<i> http_access allow fwdhkpurl
</I>
Note: The fwdurl and fwdhkpurl ACL are the same type, and used together 
for exactly the same things. You can simplify your config by merging 
them into one ACL name like so:
  acl fwdurl dstdomain .salesforce.com .force.com
  acl fwdurl dstdomain &quot;/etc/squid/ACL/fwdhkpdomain&quot;

then removing the *_access lines using fwdhkpurl.


&gt;<i> http_access allow shockwaveplayer
</I>&gt;<i> http_access allow Java
</I>&gt;<i> http_access allow allow_ip
</I>&gt;<i> http_access allow allow_pattern
</I>&gt;<i> http_access allow allow_sites
</I>&gt;<i> http_access deny deny_domain
</I>&gt;<i> http_access allow BBhknet
</I>&gt;<i> http_access allow BBHK
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i> icp_access allow all
</I>&gt;<i> miss_access allow all
</I>&gt;<i> cache_mgr BBHK Network Admin Email &gt; cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> visible_hostname proxy6.hkg.xerox.com
</I>&gt;<i> max_filedesc 4096
</I>&gt;<i> never_direct allow all
</I>&gt;<i> error_directory /usr/share/squid/errors/English
</I>&gt;<i> coredump_dir /var/spool/squid
</I>
Most of the above are default config settings. You can simplify your 
config by removing the default lines.

squid -k parse should give you a lot of hints about improvements as 
well. That is always being improved, so a quick -k parse after upgrades 
is recommended best practice.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016032.html">[squid-users] Delay_pools problem in Squid 3.5.20
</A></li>
	<LI>Next message (by thread): <A HREF="016036.html">[squid-users] Cache poisoning vulnerability 3.5.23
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16034">[ date ]</a>
              <a href="thread.html#16034">[ thread ]</a>
              <a href="subject.html#16034">[ subject ]</a>
              <a href="author.html#16034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
