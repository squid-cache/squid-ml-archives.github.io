<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3CCAPu9cN7PWEzC436UPK%3DNiYK0eLX%3D6Bce8q7YYTy8_J8XJ-_4uw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016033.html">
   <LINK REL="Next"  HREF="016041.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump</H1>
    <B>Lei Wen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3CCAPu9cN7PWEzC436UPK%3DNiYK0eLX%3D6Bce8q7YYTy8_J8XJ-_4uw%40mail.gmail.com%3E"
       TITLE="[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump">leiwen14 at gmail.com
       </A><BR>
    <I>Wed Jul 26 21:54:04 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016033.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="016041.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16040">[ date ]</a>
              <a href="thread.html#16040">[ thread ]</a>
              <a href="subject.html#16040">[ subject ]</a>
              <a href="author.html#16040">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Thanks a lot.
It is my splice thing is blocking proxy in the middle, after using stare
instead of peek, seems work though, terminal in this case is not blocking
proxy in the middle?

I made some change on my squid.conf, it work for http/https caching and
http/https whitelist.
It is working for http sibling cache as well, but has some issue with
https/ssl sibling cache.
in cache_peer, which port number should I use as forward-proxy port?
3130/3128/3129?

I am trying to set up a sibling cache pool, there is no parent or gateway
sort of thing in this hierarchy.
Each instance can have their own whitelist, but they share the same cache
pool.
On each instance host, squid is actually doing it's whitelist and caching
job for a container group on the same host.


http_port 3130

http_port 3128 intercept
acl allowed_http_sites dstdomain &quot;/etc/squid3/whitelist.txt&quot;
http_access allow allowed_http_sites

https_port 3129 cert=/etc/squid3/squid.crt key=/etc/squid3/squid.key
ssl-bump intercept generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB
acl SSL_port port 443
http_access allow SSL_port
acl allowed_https_sites ssl::server_name &quot;/etc/squid3/ssl_sites.txt&quot;

http_access deny all

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump stare step1 all
ssl_bump stare step2 allowed_https_sites
#ssl_bump bump step3
ssl_bump terminate step2 all

icp_port 3131
icp_access allow all
cache_peer 10.0.8.48 sibling 3130 3131 proxy-only



Thanks,
Lei

On Tue, Jul 25, 2017 at 9:42 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 26/07/17 10:56, Lei Wen wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am setting up a transparent proxy that is doing whitelist work, and at
</I>&gt;&gt;<i> the same time, doing the cache work.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The whitelist works fine, HTTP cache verifed work cause I see TCP_MEM_HIT
</I>&gt;&gt;<i> using this squid.conf, but don't see any HTTPS MEM HIT related log, every
</I>&gt;&gt;<i> time seems a new connection.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Nod. HIT and REFRESH log entries show cache usage. Squid versions with
</I>&gt;<i> SSL-Bump support are more likely to show REFRESH.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> For HTTPS traffic, I am getting TCP_TUNNEL/200 all the time, the question
</I>&gt;&gt;<i> is, how can I tell that a HTTPS traffic is actually using cache, or in this
</I>&gt;&gt;<i> case, it's not using cache at all for HTTPS. I am using forward-proxy port
</I>&gt;&gt;<i> in cache_peer.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That TUNNEL shows SSL-Bump splice action happening, or SSL-Bump not even
</I>&gt;<i> being considered (ie traffic received in your Squids' port 3130 and 3128).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I understand that there is logformat to make access.log show hostname
</I>&gt;&gt;<i> instead of ip, but this should not effect the MEM HIT log, right?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Meanwhile, I am also trying to setup the sibling cache cluster, not sure
</I>&gt;&gt;<i> if this related to HTTPS cache, I am also getting TCP_DENIED/403 for
</I>&gt;&gt;<i> squid-internal-dynamic/netdb - HIER_NONE/- text/html. I do see sibling hit
</I>&gt;&gt;<i> for HTTP site.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> You have configured splice or terminate. No bumping / decryption will ever
</I>&gt;<i> happen, so the cache is never even considered for use.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And my squid.conf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Squid normally listens to port 3128
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3130
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl allowed_http_sites dstdomain &quot;/etc/squid3/whitelist.txt&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow allowed_http_sites
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 3129 cert=/etc/squid3/squid.crt key=/etc/squid3/squid.key
</I>&gt;&gt;<i> ssl-bump intercept generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_port port 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow SSL_port
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> There are now almost no restrictions on port 443. Anyone can get through
</I>&gt;<i> it so long as they claim to be contacting one of the allowed_https_sites (a
</I>&gt;<i> the HTTP CONNECT level, not the TLS is unrestricted).
</I>&gt;<i> That includes traffic in the ports 3130 and 3128 which are not considered
</I>&gt;<i> for ssl_bump processing.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid3/ssl_sites.txt&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M
</I>&gt;&gt;<i> 4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sslcrtd_program /lib/squid3/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step2 allowed_https_sites
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> dstdomain ACL is not reliable in ssl_bump. It uses the HTTP URI domain
</I>&gt;<i> from the previous CONNECT instead of the actual TLS details.
</I>&gt;<i> Use ssl::server_name ACL type instead.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ssl_bump splice step3 allowed_https_sites
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump terminate step2 all
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So what happens when the server TLS cert reveals it is not actually
</I>&gt;<i> serving up one of the allowed_https_sites? nothing, the traffic is allowed
</I>&gt;<i> through.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Note the terminate line only gets used at step2 (ie. based on client SNI
</I>&gt;<i> claims alone). The peek at step2 has precluded / prohibited bump from
</I>&gt;<i> happening at step3, which only leaves splice as being possible.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170726/291a47dd/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170726/291a47dd/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016033.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="016041.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16040">[ date ]</a>
              <a href="thread.html#16040">[ thread ]</a>
              <a href="subject.html#16040">[ subject ]</a>
              <a href="author.html#16040">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
