<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3CCAPu9cN7f478uYBs%2BdUTW%2B6v1eW_eSTM_2XftGLF_Tg9a9tLEEw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016041.html">
   <LINK REL="Next"  HREF="016051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump</H1>
    <B>Lei Wen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3CCAPu9cN7f478uYBs%2BdUTW%2B6v1eW_eSTM_2XftGLF_Tg9a9tLEEw%40mail.gmail.com%3E"
       TITLE="[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump">leiwen14 at gmail.com
       </A><BR>
    <I>Thu Jul 27 22:32:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016041.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="016051.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16049">[ date ]</a>
              <a href="thread.html#16049">[ thread ]</a>
              <a href="subject.html#16049">[ subject ]</a>
              <a href="author.html#16049">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

*Squid does not support relaying decrypted <A HREF="https://">https://</A> requests over an
&gt;<i> insecure connection. So HTTP cache_peer connections will be refused.*
</I>
Do you mean HTTPS cache_peer connections will be refused?


*Also, when TLS cache_peer is used Squid is unable to tell the difference
&gt;<i> between the peer TLS server details an origin. So any server-cert forging
</I>&gt;<i> uses the cache_peer's server cert instead of the origin.*
</I>&gt;<i>
</I>I am using the same cert on every host, so it doesn't matter if it picks
the peer's cert. Besides, I have all sibling relation in this pool, only
parent will start the request for peer, right?



&gt;<i> *In Squid-3.5 (and v4) explicit/forward proxy it is best not to use
</I>&gt;<i> cache_peer for decrypted content. The most working way for now is to let it
</I>&gt;<i> go 'DIRECT' and repeat the intercept at the peer.*
</I>
Which directive do you mean by 'DIRECT' as a replacement of cache_peer?


My setup doesn't have many layers like a CARP cluster, it's just a squid
host pool, and they are all siblings with each other, no
parent/frontend/backend concept, each squid host is also a container host,
all containers on different host are doing similar job, so they can share
cache between different hosts. This is our initial idea for this project if
you know there are better hierarchy and can give me some suggest I am
really appreciate.



Thanks,
Lei


On Wed, Jul 26, 2017 at 3:30 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 27/07/17 09:54, Lei Wen wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks a lot.
</I>&gt;&gt;<i> It is my splice thing is blocking proxy in the middle,
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sort of, yes.
</I>&gt;<i>
</I>&gt;<i> after using stare instead of peek, seems work though, terminal in this
</I>&gt;&gt;<i> case is not blocking proxy in the middle?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Not sure what you are asking there. Squid *is* the proxy in the middle, so
</I>&gt;<i> terminate does a TCP close().
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I made some change on my squid.conf, it work for http/https caching and
</I>&gt;&gt;<i> http/https whitelist.
</I>&gt;&gt;<i> It is working for http sibling cache as well, but has some issue with
</I>&gt;&gt;<i> https/ssl sibling cache.
</I>&gt;&gt;<i> in cache_peer, which port number should I use as forward-proxy port?
</I>&gt;&gt;<i> 3130/3128/3129?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Squid does not support relaying decrypted <A HREF="https://">https://</A> requests over an
</I>&gt;<i> insecure connection. So HTTP cache_peer connections will be refused.
</I>&gt;<i>
</I>&gt;<i> Also, when TLS cache_peer is used Squid is unable to tell the difference
</I>&gt;<i> between the peer TLS server details an origin. So any server-cert forging
</I>&gt;<i> uses the cache_peer's server cert instead of the origin.
</I>&gt;<i>
</I>&gt;<i> In Squid-3.5 (and v4) explicit/forward proxy it is best not to use
</I>&gt;<i> cache_peer for decrypted content. The most working way for now is to let it
</I>&gt;<i> go 'DIRECT' and repeat the intercept at the peer.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I am trying to set up a sibling cache pool, there is no parent or gateway
</I>&gt;&gt;<i> sort of thing in this hierarchy.
</I>&gt;&gt;<i> Each instance can have their own whitelist, but they share the same cache
</I>&gt;&gt;<i> pool.
</I>&gt;&gt;<i> On each instance host, squid is actually doing it's whitelist and caching
</I>&gt;&gt;<i> job for a container group on the same host.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Are you trying to describe something like a CARP hierarchy?
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster">http://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster</A>&gt;
</I>&gt;<i>
</I>&gt;<i> They suffer from the above problem. There is no good solution for that in
</I>&gt;<i> current Squid versions which do SSL-Bump.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i> ssl_bump stare step1 all
</I>&gt;&gt;<i> ssl_bump stare step2 allowed_https_sites
</I>&gt;&gt;<i> #ssl_bump bump step3
</I>&gt;&gt;<i> ssl_bump terminate step2 all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Up to you, but I would do this:
</I>&gt;<i>
</I>&gt;<i>  ssl_bump peek step1
</I>&gt;<i>
</I>&gt;<i>  ssl_bump stare step2 allowed_https_sites
</I>&gt;<i>  ssl_bump terminate step2
</I>&gt;<i>
</I>&gt;<i>  # decrypt with server-cert forging
</I>&gt;<i>  ssl_bump bump step3
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That peek at step1 allows Squid can splice if things to badly at the step2
</I>&gt;<i> staring. A peek at step1 will not prevent a step3 bump.
</I>&gt;<i>
</I>&gt;<i> And the explicit line with 'bump' ensures that Squid actually does a bump,
</I>&gt;<i> the default behaviour is a little bit too variable depending on what bugs
</I>&gt;<i> are present in the SSL-Bump code.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170727/56ea2859/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170727/56ea2859/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016041.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="016051.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16049">[ date ]</a>
              <a href="thread.html#16049">[ thread ]</a>
              <a href="subject.html#16049">[ subject ]</a>
              <a href="author.html#16049">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
