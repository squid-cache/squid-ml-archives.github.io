<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3C8b776e55-b5a1-dcbb-e859-a69250069d7d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016049.html">
   <LINK REL="Next"  HREF="016063.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3C8b776e55-b5a1-dcbb-e859-a69250069d7d%40treenet.co.nz%3E"
       TITLE="[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 28 03:36:51 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016049.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="016063.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16051">[ date ]</a>
              <a href="thread.html#16051">[ thread ]</a>
              <a href="subject.html#16051">[ subject ]</a>
              <a href="author.html#16051">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/07/17 10:32, Lei Wen wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i>     /Squid does not support relaying decrypted <A HREF="https://">https://</A> requests over an
</I>&gt;<i>     insecure connection. So HTTP cache_peer connections will be refused./
</I>&gt;<i> 
</I>&gt;<i> Do you mean HTTPS cache_peer connections will be refused?
</I>
No, I mean un-encrypted cache_peer connections will be refused.

Encrypted peers might be used, BUT the peer cert is used for the 
fake-cert generation. Usually the end user then encounters 'invalid 
cert' problems. One also has to be very careful not to introduce other 
MITM or downgrade vulnerabilities on the connections to those peers.


&gt;<i> 
</I>&gt;<i>     /Also, when TLS cache_peer is used Squid is unable to tell the
</I>&gt;<i>     difference between the peer TLS server details an origin. So any
</I>&gt;<i>     server-cert forging uses the cache_peer's server cert instead of the
</I>&gt;<i>     origin./
</I>&gt;<i> 
</I>&gt;<i> I am using the same cert on every host, so it doesn't matter if it picks 
</I>&gt;<i> the peer's cert. Besides, I have all sibling relation in this pool, only 
</I>&gt;<i> parent will start the request for peer, right?
</I>
No, any sibling may pass the request on to any other. If the first proxy 
to handle a request thinks that a peer has the response and that peer in 
fact does not, it may be passed on to a third sibling, etc.


It does not matter if the certs on the proxies are identical or not. The 
SSL-Bump is ideally not sending that particular cert to the clients. It 
is generating a fake cert specific for each HTTPS domain being visited - 
based on that domains real official cert.
To do that Squid expected to receive that origin servers cert on its 
next-hop connection.


&gt;<i> 
</I>&gt;<i>     /In Squid-3.5 (and v4) explicit/forward proxy it is best not to use
</I>&gt;<i>     cache_peer for decrypted content. The most working way for now is to
</I>&gt;<i>     let it go 'DIRECT' and repeat the intercept at the peer./
</I>&gt;<i> 
</I>&gt;<i> Which directive do you mean by 'DIRECT' as a replacement of cache_peer?
</I>&gt;<i> 
</I>
&quot;DIRECT&quot; in caching hierarchy, means the proxy handling the request uses 
DNS records to identify the origin server and goes directly to that (not 
through a cache_peer).


&gt;<i> 
</I>&gt;<i> My setup doesn't have many layers like a CARP cluster, it's just a squid 
</I>&gt;<i> host pool, and they are all siblings with each other, no 
</I>&gt;<i> parent/frontend/backend concept, each squid host is also a container 
</I>&gt;<i> host, all containers on different host are doing similar job, so they 
</I>&gt;<i> can share cache between different hosts. This is our initial idea for 
</I>&gt;<i> this project if you know there are better hierarchy and can give me some 
</I>&gt;<i> suggest I am really appreciate.
</I>
Okay, understood.

You might be able to get a sort-of workable situation with the following 
parameters. I'd still expect a lot of annoying problems though.


  cache_peer sibling.example.com sibling 3128 3130 \
    ssl sslcafile=/path/to/ca.pem \
    sslflags=NO_DEFAULT_CA ssloptions=NO_SSLv3


The /path/to/ca.pem should contain the public cert of the CA used to 
sign the peers cert. Do this whether it is a self-signed CA or a public 
Trusted CA.

[avoid the DONT_VERIFY_* settings, they are deadly].


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016049.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="016063.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16051">[ date ]</a>
              <a href="thread.html#16051">[ thread ]</a>
              <a href="subject.html#16051">[ subject ]</a>
              <a href="author.html#16051">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
