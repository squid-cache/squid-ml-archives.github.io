<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL options on different http_port resolving into a single config for all ports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20options%20on%20different%20http_port%20resolving%20into%0A%20a%20single%20config%20for%20all%20ports&In-Reply-To=%3C9613cbed-bfc2-d093-83a9-450eb29b9a5e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016058.html">
   <LINK REL="Next"  HREF="016045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL options on different http_port resolving into a single config for all ports</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20options%20on%20different%20http_port%20resolving%20into%0A%20a%20single%20config%20for%20all%20ports&In-Reply-To=%3C9613cbed-bfc2-d093-83a9-450eb29b9a5e%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL options on different http_port resolving into a single config for all ports">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jul 31 13:08:11 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016058.html">[squid-users] SSL options on different http_port resolving into a single config for all ports
</A></li>
        <LI>Next message (by thread): <A HREF="016045.html">[squid-users] Kerberos access denied and reauthentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16061">[ date ]</a>
              <a href="thread.html#16061">[ thread ]</a>
              <a href="subject.html#16061">[ subject ]</a>
              <a href="author.html#16061">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/07/17 19:27, Wahaj Ali wrote:
&gt;<i> Thanks for the reply, Amos. A few follow up questions:
</I>&gt;<i> 
</I>&gt;<i> 1) Setting dynamic_cert_mem_cache_size=0 does solve the issue. However, 
</I>&gt;<i> I fail to understand why caching the cert allows the connection to 
</I>&gt;<i> continue on SSLv3, on a port that I've disabled it. Isn't cert exchange 
</I>&gt;<i> done after the protocol has been selected. I don't think curl is 
</I>&gt;<i> rejecting the cert, but rather the ssl connection fails to establish 
</I>&gt;<i> before the cert exchange, since I also tried with the following command, 
</I>&gt;<i> which ignores cert errors:
</I>&gt;<i> &gt; curl -k -vv -x <A HREF="https://127.0.0.1:3128">https://127.0.0.1:3128</A> <A HREF="https://uatmail02.cimb.com">https://uatmail02.cimb.com</A> -ssl3
</I>&gt;<i> 
</I>
Are you referring to the -k ?

That option disables security validation procedures for the cert keys - 
like Squid's DONT_VERIFY_PEER option. That is all.

It cannot prevent OpenSSL *parsing* the cert and rejecting it on grounds 
that TLS-only things are being used on an SSLv3 connection, or SSL 
things are being on a TLS-only connection.


&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at madmin-VirtualBox</A>:/home/madmin/# curl -k -vv -x 
</I>&gt;<i> <A HREF="https://127.0.0.1:3128">https://127.0.0.1:3128</A> <A HREF="https://uatmail02.cimb.com">https://uatmail02.cimb.com</A> -ssl3
</I>&gt;<i> * About to connect() to proxy 127.0.0.1 port 3128 (#0)
</I>&gt;<i> *   Trying 127.0.0.1... connected
</I>&gt;<i> * Establish HTTP proxy tunnel to uatmail02.cimb.com:443
</I>&gt;<i>  &gt; CONNECT uatmail02.cimb.com:443 HTTP/1.1
</I>&gt;<i>  &gt; Host: uatmail02.cimb.com:443
</I>&gt;<i>  &gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 
</I>&gt;<i> OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3
</I>&gt;<i>  &gt; Proxy-Connection: Keep-Alive
</I>&gt;<i>  &gt;
</I>&gt;<i> &lt; HTTP/1.1 200 Connection established
</I>&gt;<i> &lt;
</I>&gt;<i> * Proxy replied OK to CONNECT request
</I>&gt;<i> * successfully set certificate verify locations:
</I>&gt;<i> *   CAfile: none
</I>&gt;<i>    CApath: /etc/ssl/certs
</I>&gt;<i> * SSLv3, TLS handshake, Client hello (1):
</I>
The protocol version is decided here. By the server - based partially on 
what framing syntax that ClientHello used, and partially on what the 
client indicates it can support.

If the protocol itself could not be agreed to the server would terminate 
and I'd expect curl to either show an alert received now, or complain 
about early closure.


&gt;<i> * SSLv3, TLS alert, Server hello (2):
</I>
Here curl is receiving the ServerHello - which contains the cert and the 
servers chosen cyphers etc.


&gt;<i> * error:14094410:SSL routines:SSL3_READ_BYTES:sslv3 alert handshake failure &gt; * Closing connection #0
</I>
So, curl is aborting willingly when processing that cert etc.

That &quot;error:&quot; line is produced by OpenSSL, not curl.

It might also abort due to cipher or extension issues, but IIRC the 
messages OpenSSL prints there explicitly contain the words cipher or 
extension respectively.


&gt;<i> 
</I>&gt;<i> 2) You mentioned &quot;leaving port 443 for encrypted connections&quot;, can you 
</I>&gt;<i> please elaborate on why it might be problematic to use &quot;http_port&quot; 
</I>&gt;<i> directive - i.e. have both plain-text and SSL connections?
</I>&gt;<i> 
</I>
Because of problems like the one you are clearly showing by the way you 
worded that question. As if you think SSL connections are arriving at 
that port.

  ... it *does not* accept SSL connections.

The octet values for TLS and plain-text messages are incompatible. They 
can be interpreted by either one - with various results which are 
different to how they are supposed to be handled, and usually not nice 
results.


The &quot;http_&quot; part of the directive name indicates what protocol the 
parser attached to that port accepts. In this case plain-text HTTP. 
There are a few other protocols that can arrive there but they do so by 
using the plain-text HTTP syntax.


To receive port 443 traffic use the https_port. The &quot;https_&quot; part of 
that directive name means the bytes arriving to that port get shuffled 
through a TLS parser (eg OpenSSL) before going to the HTTP parser.

If you were thinking that ssl-bump option on the port made it accept 
SSL/TLS connections you would be wrong. SSL-Bump on an http_port is 
about applying a TLS parser *after* the HTTP parser - and only for the 
payload of plain-text HTTP CONNECT messages.


Other plain-text protocols which Squid supports that don't use the 
message HTTP-syntax have to use different port directives. For example; 
ftp_port directive for native FTP protocol.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016058.html">[squid-users] SSL options on different http_port resolving into a single config for all ports
</A></li>
	<LI>Next message (by thread): <A HREF="016045.html">[squid-users] Kerberos access denied and reauthentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16061">[ date ]</a>
              <a href="thread.html#16061">[ thread ]</a>
              <a href="subject.html#16061">[ subject ]</a>
              <a href="author.html#16061">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
