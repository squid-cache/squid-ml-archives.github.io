<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3CCAPu9cN60whmvwGOe53hqF8DHs4pjjepvwtEm%2BErzdZ0d%3D%2BNzbA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016051.html">
   <LINK REL="Next"  HREF="016032.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump</H1>
    <B>Lei Wen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20tell%20HTTPS%20traffic%20is%20using%20cache%20from%0A%20access.log%20in%203.5.x%20when%20using%20ssl_bump&In-Reply-To=%3CCAPu9cN60whmvwGOe53hqF8DHs4pjjepvwtEm%2BErzdZ0d%3D%2BNzbA%40mail.gmail.com%3E"
       TITLE="[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump">leiwen14 at gmail.com
       </A><BR>
    <I>Mon Jul 31 23:32:13 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016051.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="016032.html">[squid-users] Delay_pools problem in Squid 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16063">[ date ]</a>
              <a href="thread.html#16063">[ thread ]</a>
              <a href="subject.html#16063">[ subject ]</a>
              <a href="author.html#16063">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

I tried your suggestion tried to tuned with some other options, no matter
what I've done, seems HTTPS traffic will not look at sibling cache? it only
look into it's own cache if there are only siblings in the group?


Thanks,
Lei

On Thu, Jul 27, 2017 at 8:36 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 28/07/17 10:32, Lei Wen wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     /Squid does not support relaying decrypted <A HREF="https://">https://</A> requests over an
</I>&gt;&gt;<i>     insecure connection. So HTTP cache_peer connections will be refused./
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you mean HTTPS cache_peer connections will be refused?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No, I mean un-encrypted cache_peer connections will be refused.
</I>&gt;<i>
</I>&gt;<i> Encrypted peers might be used, BUT the peer cert is used for the fake-cert
</I>&gt;<i> generation. Usually the end user then encounters 'invalid cert' problems.
</I>&gt;<i> One also has to be very careful not to introduce other MITM or downgrade
</I>&gt;<i> vulnerabilities on the connections to those peers.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>     /Also, when TLS cache_peer is used Squid is unable to tell the
</I>&gt;&gt;<i>     difference between the peer TLS server details an origin. So any
</I>&gt;&gt;<i>     server-cert forging uses the cache_peer's server cert instead of the
</I>&gt;&gt;<i>     origin./
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am using the same cert on every host, so it doesn't matter if it picks
</I>&gt;&gt;<i> the peer's cert. Besides, I have all sibling relation in this pool, only
</I>&gt;&gt;<i> parent will start the request for peer, right?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No, any sibling may pass the request on to any other. If the first proxy
</I>&gt;<i> to handle a request thinks that a peer has the response and that peer in
</I>&gt;<i> fact does not, it may be passed on to a third sibling, etc.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It does not matter if the certs on the proxies are identical or not. The
</I>&gt;<i> SSL-Bump is ideally not sending that particular cert to the clients. It is
</I>&gt;<i> generating a fake cert specific for each HTTPS domain being visited - based
</I>&gt;<i> on that domains real official cert.
</I>&gt;<i> To do that Squid expected to receive that origin servers cert on its
</I>&gt;<i> next-hop connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>     /In Squid-3.5 (and v4) explicit/forward proxy it is best not to use
</I>&gt;&gt;<i>     cache_peer for decrypted content. The most working way for now is to
</I>&gt;&gt;<i>     let it go 'DIRECT' and repeat the intercept at the peer./
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Which directive do you mean by 'DIRECT' as a replacement of cache_peer?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> &quot;DIRECT&quot; in caching hierarchy, means the proxy handling the request uses
</I>&gt;<i> DNS records to identify the origin server and goes directly to that (not
</I>&gt;<i> through a cache_peer).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> My setup doesn't have many layers like a CARP cluster, it's just a squid
</I>&gt;&gt;<i> host pool, and they are all siblings with each other, no
</I>&gt;&gt;<i> parent/frontend/backend concept, each squid host is also a container host,
</I>&gt;&gt;<i> all containers on different host are doing similar job, so they can share
</I>&gt;&gt;<i> cache between different hosts. This is our initial idea for this project if
</I>&gt;&gt;<i> you know there are better hierarchy and can give me some suggest I am
</I>&gt;&gt;<i> really appreciate.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Okay, understood.
</I>&gt;<i>
</I>&gt;<i> You might be able to get a sort-of workable situation with the following
</I>&gt;<i> parameters. I'd still expect a lot of annoying problems though.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  cache_peer sibling.example.com sibling 3128 3130 \
</I>&gt;<i>    ssl sslcafile=/path/to/ca.pem \
</I>&gt;<i>    sslflags=NO_DEFAULT_CA ssloptions=NO_SSLv3
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The /path/to/ca.pem should contain the public cert of the CA used to sign
</I>&gt;<i> the peers cert. Do this whether it is a self-signed CA or a public Trusted
</I>&gt;<i> CA.
</I>&gt;<i>
</I>&gt;<i> [avoid the DONT_VERIFY_* settings, they are deadly].
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170731/f2785794/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170731/f2785794/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016051.html">[squid-users] How to tell HTTPS traffic is using cache from access.log in 3.5.x when using ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="016032.html">[squid-users] Delay_pools problem in Squid 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16063">[ date ]</a>
              <a href="thread.html#16063">[ thread ]</a>
              <a href="subject.html#16063">[ subject ]</a>
              <a href="author.html#16063">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
