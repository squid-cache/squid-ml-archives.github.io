<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help troubleshooting proxy&lt;--&gt;client https
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20troubleshooting%20proxy%3C--%3Eclient%20https&In-Reply-To=%3CCA%2B8Eki3DcvqkXaH7S_eWo-SgUP%2BKP5a5qZsUViruAesMsr9POg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015493.html">
   <LINK REL="Next"  HREF="015496.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help troubleshooting proxy&lt;--&gt;client https</H1>
    <B>Masha Lifshin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20troubleshooting%20proxy%3C--%3Eclient%20https&In-Reply-To=%3CCA%2B8Eki3DcvqkXaH7S_eWo-SgUP%2BKP5a5qZsUViruAesMsr9POg%40mail.gmail.com%3E"
       TITLE="[squid-users] Help troubleshooting proxy&lt;--&gt;client https">mlifshin at phantomdesign.com
       </A><BR>
    <I>Thu Jun  1 02:15:12 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015493.html">[squid-users] Help troubleshooting proxy&lt;--&gt;client https
</A></li>
        <LI>Next message (by thread): <A HREF="015496.html">[squid-users] Help troubleshooting proxy&lt;--&gt;client https
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15494">[ date ]</a>
              <a href="thread.html#15494">[ thread ]</a>
              <a href="subject.html#15494">[ subject ]</a>
              <a href="author.html#15494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you, very helpful.  Some more clarifying questions for you.

Sorry for the imprecise language, I mean not interception but rather
accepting connections to that port.  Our browsers will be explicitly
configured to connect our proxy, so I believe that is not interception?

If we want to only allow encrypted traffic between the browser and proxy,
does that mean we'd only want to use the following line from your example?

# HTTPS proxy; clients establish TLS connections to 31443 (your item #1)
https_port 31443 ssl-bump ...

Once a handshake is done and tls connection is established here, would it
be possible to have all http and https traffic from the browser go through
31443?  So squid would not need to have ports 80 and 443 open?

Thank you,
-Masha


On Wed, May 31, 2017 at 5:10 PM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 05/31/2017 02:42 PM, Masha Lifshin wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; What I am trying to achieve is
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 1. an https connection between the client and squid proxy, as well as
</I>&gt;<i>
</I>&gt;<i> &gt; 2. listen on port 80 for http traffic,
</I>&gt;<i>
</I>&gt;<i> &gt; 3. on port 443 for ssl traffic, and
</I>&gt;<i>
</I>&gt;<i> &gt; 4. apply ssl-bump to the ssl traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If I parsed your query correctly, and by &quot;listen&quot; you mean &quot;intercept&quot;,
</I>&gt;<i> and you want to apply SslBump to proxied SSL traffic on all ports, then
</I>&gt;<i> it looks like you will need three ports, each doing ssl-bump. In other
</I>&gt;<i> words, instead of
</I>&gt;<i>
</I>&gt;<i> &gt; http_port 80 ssl-bump cert=some.cert.pem ...
</I>&gt;<i> &gt; https_port 443 cert=other.cert.pem ...
</I>&gt;<i>
</I>&gt;<i> You will need something like this:
</I>&gt;<i>
</I>&gt;<i> # HTTPS proxy; clients establish TLS connections to 31443 (your item #1)
</I>&gt;<i> https_port 31443 ssl-bump ...
</I>&gt;<i>
</I>&gt;<i> # HTTP-intercepting proxy (your item #2)
</I>&gt;<i> http_port 80 intercept ssl-bump ...
</I>&gt;<i>
</I>&gt;<i> # SSL-intercepting proxy (your item #3)
</I>&gt;<i> https_port 443 intercept ssl-bump ...
</I>&gt;<i>
</I>&gt;<i> You may need &quot;tproxy&quot; instead of &quot;intercept&quot;, depending on how you are
</I>&gt;<i> intercepting/forwarding traffic.
</I>&gt;<i>
</I>&gt;<i> The actual port numbers do no matter.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Also wondering what, if any, are the security issues with using port 80
</I>&gt;<i> &gt; for the http traffic?
</I>&gt;<i>
</I>&gt;<i> Anybody with access to that traffic will be able to easily see
</I>&gt;<i> everything and, with a monumental effort, potentially occasionally
</I>&gt;<i> modify unencrypted traffic, including plain CONNECT requests that
</I>&gt;<i> establish secure channels.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Fri, May 26, 2017 at 7:19 AM, Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 05/26/2017 12:00 AM, Masha Lifshin wrote:
</I>&gt;<i> &gt;     &gt; I have added an https_port directive
</I>&gt;<i> &gt;     &gt; to squid.conf, but it must be misconfigured.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; http_port 172.30.0.67:443 &lt;<A HREF="http://172.30.0.67:443">http://172.30.0.67:443</A>&gt; ...
</I>&gt;<i> &gt;     &gt; https_port 172.30.0.67:443 &lt;<A HREF="http://172.30.0.67:443">http://172.30.0.67:443</A>&gt; ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     You are right -- your Squid is misconfigured. You cannot use the same
</I>&gt;<i> &gt;     address for two ports. Unfortunately, Squid thinks that port binding
</I>&gt;<i> &gt;     errors are a minor inconvenience and continues running after logging
</I>&gt;<i> an
</I>&gt;<i> &gt;     error message (that looks like many other benign error messages).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Changing one of the ports will solve the &quot;same address&quot; problem
</I>&gt;<i> &gt;     described above.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Do not use port 443 for http_port. It makes triage extremely
</I>&gt;<i> confusing
</I>&gt;<i> &gt;     because port 443 usually implies SSL. Consider using port 3128
</I>&gt;<i> instead.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170531/de5006a8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170531/de5006a8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015493.html">[squid-users] Help troubleshooting proxy&lt;--&gt;client https
</A></li>
	<LI>Next message (by thread): <A HREF="015496.html">[squid-users] Help troubleshooting proxy&lt;--&gt;client https
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15494">[ date ]</a>
              <a href="thread.html#15494">[ thread ]</a>
              <a href="subject.html#15494">[ subject ]</a>
              <a href="author.html#15494">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
