<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid ssl bump and Adobe Connect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20ssl%20bump%20and%20Adobe%20Connect&In-Reply-To=%3C8d9d84ad-0560-3d44-700b-a82707ffd355%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015533.html">
   <LINK REL="Next"  HREF="015623.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid ssl bump and Adobe Connect</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20ssl%20bump%20and%20Adobe%20Connect&In-Reply-To=%3C8d9d84ad-0560-3d44-700b-a82707ffd355%40treenet.co.nz%3E"
       TITLE="[squid-users] squid ssl bump and Adobe Connect">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun  6 12:02:22 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015533.html">[squid-users] squid ssl bump and Adobe Connect
</A></li>
        <LI>Next message (by thread): <A HREF="015623.html">[squid-users] [squid-announce] Squid 4.0.20 beta is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15537">[ date ]</a>
              <a href="thread.html#15537">[ thread ]</a>
              <a href="subject.html#15537">[ subject ]</a>
              <a href="author.html#15537">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/06/17 18:08, Vieri wrote:
&gt;<i> ________________________________
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;<i> 1496665088.143      6 10.215.145.187 TAG_NONE/400 4428 NONE error:invalid-request - HIER_NONE/-
</I>&gt;&gt;&gt;<i> text/html&gt;
</I>&gt;&gt;<i> I recommend finding the place in the debugging cache.log where Squid
</I>&gt;&gt;<i> generates the above error response and then going backwards to find the
</I>&gt;&gt;<i> cause.
</I>&gt;<i> OK Alex, got it.
</I>&gt;<i> In the meantime, I searched for the events around the time this happened.
</I>&gt;<i> BTW as a side question I'd like to know if I can change the timestamp in cache.log so it can print the unixtime as in access.log.
</I>&gt;<i>
</I>&gt;<i> In any case, here's the relevant part:
</I>&gt;<i>
</I>&gt;<i> [Mon Jun  5 14:18:08 2017].143      6 10.215.145.187 TAG_NONE/400 4428 NONE error:invalid-request - HIER_NONE/- text/html
</I>&gt;<i>
</I>&gt;<i> cache.log within 14:18:08:
</I>
&lt;snip&gt;
&gt;<i> 2017/06/05 14:18:08.129 kid1| 83,2| client_side.cc(3796) clientNegotiateSSL: clientNegotiateSSL: New session 0x80e80e30 on FD 29 (10.215.145.187:54815)
</I>&gt;<i> 2017/06/05 14:18:08.129 kid1| 83,3| client_side.cc(3800) clientNegotiateSSL: clientNegotiateSSL: FD 29 negotiated cipher AES128-SHA
</I>&gt;<i> 2017/06/05 14:18:08.129 kid1| 83,5| client_side.cc(3816) clientNegotiateSSL: clientNegotiateSSL: FD 29 has no certificate.
</I>&gt;<i> 2017/06/05 14:18:08.129 kid1| 33,4| client_side.cc(231) readSomeData: local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17: reading request...
</I>&gt;<i> 2017/06/05 14:18:08.129 kid1| 33,5| AsyncCall.cc(26) AsyncCall: The AsyncCall ConnStateData::clientReadRequest constructed, this=0x80e80578 [call2567]
</I>&gt;<i> 2017/06/05 14:18:08.129 kid1| 5,5| Read.cc(58) comm_read_base: comm_read, queueing read for local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17; asynCall 0x80e80578*1
</I>&gt;<i> 2017/06/05 14:18:08.129 kid1| 5,5| ModEpoll.cc(116) SetSelect: FD 29, type=1, handler=1, client_data=0x808b48b8, timeout=0
</I>&gt;<i> 2017/06/05 14:18:08.135 kid1| 5,3| IoCallback.cc(116) finish: called for local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17 (0, 0)
</I>&gt;<i> 2017/06/05 14:18:08.135 kid1| 33,5| AsyncCall.cc(93) ScheduleCall: IoCallback.cc(135) will call ConnStateData::clientReadRequest(local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17, data=0x80e07e00) [call2567]
</I>&gt;<i> 2017/06/05 14:18:08.135 kid1| 33,5| AsyncCallQueue.cc(55) fireNext: entering ConnStateData::clientReadRequest(local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17, data=0x80e07e00)
</I>&gt;<i> 2017/06/05 14:18:08.135 kid1| 33,5| AsyncCall.cc(38) make: make call ConnStateData::clientReadRequest [call2567]
</I>&gt;<i> 2017/06/05 14:18:08.135 kid1| 33,5| AsyncJob.cc(123) callStart: Http::Server status in: [ job56]
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 33,5| client_side.cc(3251) clientReadRequest: local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 83,5| bio.cc(118) read: FD 29 read 5 &lt;= 5
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 83,5| bio.cc(118) read: FD 29 read 1568 &lt;= 1568
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 83,2| support.cc(1364) ssl_read_method: SSL FD 29 is pending
</I>
FD 29 went through SSL-Bump processing and was bump'ed. An HTTPS request 
message is now expected to arrive.

&gt;<i> 2017/06/05 14:18:08.136 kid1| 5,3| Read.cc(91) ReadNow: local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17, size 66, retval 66, errno 0
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 33,5| client_side.cc(3200) clientParseRequests: local=46.51.187.18:443 remote=10.215.145.187 FD 29 flags=17: attempting to parse
</I>
... 66 bytes arrive ...

&gt;<i> 2017/06/05 14:18:08.136 kid1| 74,5| HttpParser.cc(37) reset: Request buffer is
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 74,5| HttpParser.cc(47) parseRequestFirstLine: parsing possible request:
</I>&gt;<i> 2017/06/05 14:18:08.136 kid1| 74,5| HttpParser.cc(257) HttpParserParseReqLine: Parser: retval -1: from 0-&gt;4: method 0-&gt;-1; url -1-&gt;-1; version -1-&gt;-1 (0/0)
</I>
The first 4 bytes were ones which cannot exist at the start if any HTTP 
message - so the protocol being bumped on port 443 was not HTTPS.

Squid then proceeds to generate and send the invalid-request error 
response to this non-HTTPS over port 443.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015533.html">[squid-users] squid ssl bump and Adobe Connect
</A></li>
	<LI>Next message (by thread): <A HREF="015623.html">[squid-users] [squid-announce] Squid 4.0.20 beta is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15537">[ date ]</a>
              <a href="thread.html#15537">[ thread ]</a>
              <a href="subject.html#15537">[ subject ]</a>
              <a href="author.html#15537">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
