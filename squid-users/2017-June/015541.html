<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid issue of caching the m3u8 file
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20issue%20of%20caching%20the%20m3u8%20file&In-Reply-To=%3CCAEip7fwgrViUQA2vCM4Q5BXE5HmhKS373o%3DFV%3DzToE9HLw9uuw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015531.html">
   <LINK REL="Next"  HREF="015552.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid issue of caching the m3u8 file</H1>
    <B>LIU Yaning</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20issue%20of%20caching%20the%20m3u8%20file&In-Reply-To=%3CCAEip7fwgrViUQA2vCM4Q5BXE5HmhKS373o%3DFV%3DzToE9HLw9uuw%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid issue of caching the m3u8 file">lyningg at gmail.com
       </A><BR>
    <I>Tue Jun  6 13:33:22 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015531.html">[squid-users] Squid issue of caching the m3u8 file
</A></li>
        <LI>Next message (by thread): <A HREF="015552.html">[squid-users] Squid issue of caching the m3u8 file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15541">[ date ]</a>
              <a href="thread.html#15541">[ thread ]</a>
              <a href="subject.html#15541">[ subject ]</a>
              <a href="author.html#15541">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Amos,

Thanks a lot for your explanation and suggestion. I added the &quot;store-stale&quot;
to the refresh_pattern rule as:
refresh_pattern -i \.(ts|m3u8)$ 120 90% 1000 override-expire override-lastmod
ignore-no-cache ignore-no-store store-stale

However, I have checked the access.log, I am still getting TCP_Miss.
1496754869.963 13 192.168.0.100 TCP_MISS/200 16636 GET
<A HREF="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8">http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8</A>
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg">http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg</A>&gt;
-
HIER_DIRECT/95.101.182.201
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q">http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q</A>&gt;
 application/x-mpegURL
1496754870.605 4 192.168.0.100 TCP_MISS/200 16636 GET
<A HREF="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8">http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8</A>
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg">http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg</A>&gt;
-
HIER_DIRECT/95.101.182.201
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q">http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q</A>&gt;
 application/x-mpegURL
1496754871.194 15 192.168.0.100 TCP_MISS/200 16636 GET
<A HREF="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8">http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8</A>
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg">http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg</A>&gt;
-
HIER_DIRECT/95.101.182.201
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q">http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q</A>&gt;
 application/x-mpegURL
1496754871.715 4 192.168.0.100 TCP_MISS/200 16636 GET
<A HREF="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8">http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8</A>
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg">http://www.google.com/url?q=http%3A%2F%2Fqthttp.apple.com.edgesuite.net%2F1010qwoeiuryfg%2F0150_vod.m3u8&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHpiHy55EMeBIaMGhgEKRHanTrXxg</A>&gt;
-
HIER_DIRECT/95.101.182.201
&lt;<A HREF="http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q">http://www.google.com/url?q=http%3A%2F%2F95.101.182.201&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE9ZWXH7sOJgbqIA--MJwxobSp76Q</A>&gt;
 application/x-mpegURL

If I understand well, TCP_MISS/200 shows the content is not cached by
Squid. Could you please help me to see if anything I did wrong to make
.m3u8 not cached by Squid?


Date: Tue, 6 Jun 2017 14:08:11 +1200
From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid issue of caching the m3u8 file
Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">5af5e6e9-4880-f58e-106b-9f11dd0a4a7b at treenet.co.nz</A>&gt;
Content-Type: text/plain; charset=utf-8; format=flowed

On 05/06/17 23:54, LIU Yaning wrote:
&gt;<i> Dear All,
</I>&gt;<i>
</I>&gt;<i> I would like to cache the .m3u8 file to be able to provide offline
</I>&gt;<i> caching service by Squid. The played HLS video streaming is the link
</I>&gt;<i> as below:
</I>&gt;<i> <A HREF="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8">http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8</A>
</I>&gt;<i> &lt;<A HREF="http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8">http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/0150_vod.m3u8</A>&gt;
</I>&gt;<i> However, the .m3u8 file is not be cached probably because it is
</I>&gt;<i> mentioned as a no-cache, no-store, max-age=0 in the &quot;Cache-Control&quot; in
</I>&gt;<i> the HTTP header.
</I>Nope. Only the CC:no-store is preventing caching. The other headers
simply put boundaries on what is to be done with the content in the
cache. In particular the &quot;no-cache&quot;, max-age=0 and Expires values mean
it has to be revalidated (REFRESH in your access.log) before any future
uses - probably because of that Set-Cookie needing to be changed for
different end-users.
&gt;<i>
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i>
</I>&gt;<i> Server: Apache
</I>&gt;<i>
</I>&gt;<i> ETag: &quot;1d7168b4f49e75f76f3182f24bf075f6:1299516751&quot;
</I>&gt;<i>
</I>&gt;<i> Last-Modified: Mon, 07 Mar 2011 16:52:31 GMT
</I>&gt;<i>
</I>&gt;<i> Expires: Fri, 02 Jun 2017 14:26:52 GMT
</I>&gt;<i>
</I>&gt;<i> Cache-Control: max-age=0, no-cache, no-store
</I>&gt;<i>
</I>&gt;<i> Pragma: no-cache
</I>&gt;<i>
</I>&gt;<i> Date: Fri, 02 Jun 2017 14:26:52 GMT
</I>&gt;<i>
</I>&gt;<i> Content-Length: 16046
</I>&gt;<i>
</I>&gt;<i> Set-Cookie: AKID=77F9F1316ECCE780566608C5E514DE0A;expires=Fri, 26 Aug
</I>&gt;<i> 2016 00:01:00 GMT; path=/; domain=qthttp.apple.com.edgesuite.net
</I>&gt;<i> &lt;<A HREF="http://qthttp.apple.com.edgesuite.net/">http://qthttp.apple.com.edgesuite.net/</A>&gt;
</I>&gt;<i>
</I>&gt;<i> Content-Type: application/x-mpegURL
</I>&gt;<i>
</I>&gt;<i> Access-Control-Allow-Origin: *
</I>&gt;<i>
</I>&gt;<i> I added a new rule for .m3u8 file in squid.conf, however, it is still
</I>&gt;<i> not working.
</I>&gt;<i>
</I>&gt;<i> refresh_pattern -i \.(ts|m3u8)$ 120 90% 1000 override-expire
</I>&gt;<i> override-lastmod ignore-no-cache ignore-no-store
</I>&gt;<i>
</I>&gt;<i> Does anyone know how to allow Squid caching the .m3u8 file? Thanks a
</I>&gt;<i> lot in advance.
</I>What makes you think it is not caching? The ignore-no-store alone should
be sufficient to allow current Squid versions to cache that object. You
could perhapse add &quot;store-stale&quot; option on that config line. Which
should make Squid cache object containing an Expires header with current
or past values. refresh_pattern settings do not affect that cacheable vs
non-cacheable decision. The no-cache header tells Squid the object needs
revalidating before every use. However, be aware the tool at redbot.org
tells me that this URL is badly broken in how it is using the ETag and
Vary headers - in a way which can break the revalidation when these
things are cached. Some of your clients may see very broken behaviour
accessing this object unless you follow the no-store requirement or the
server stops its broken ETag behaviour. PS. if you are using a Squid
version much older than 3.5.24 I recommend an upgrade. With an urgency
increasing the older your Squid is. Amos



-- 
Best Regards,
--
Yaning.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170606/5cf5752a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170606/5cf5752a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015531.html">[squid-users] Squid issue of caching the m3u8 file
</A></li>
	<LI>Next message (by thread): <A HREF="015552.html">[squid-users] Squid issue of caching the m3u8 file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15541">[ date ]</a>
              <a href="thread.html#15541">[ thread ]</a>
              <a href="subject.html#15541">[ subject ]</a>
              <a href="author.html#15541">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
