<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%20after%0A%20upgrade%20from%20v2%20to%20v3&In-Reply-To=%3Cca593b00-8727-c816-8169-d6c528c51d93%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015555.html">
   <LINK REL="Next"  HREF="015554.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Huge%20amount%20of%20time_wait%20connections%20after%0A%20upgrade%20from%20v2%20to%20v3&In-Reply-To=%3Cca593b00-8727-c816-8169-d6c528c51d93%40treenet.co.nz%3E"
       TITLE="[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jun  7 11:34:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015555.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
        <LI>Next message (by thread): <A HREF="015554.html">[squid-users] CacheManager::ParseUrl: action 'digestauthenticator'	not found
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15560">[ date ]</a>
              <a href="thread.html#15560">[ thread ]</a>
              <a href="subject.html#15560">[ subject ]</a>
              <a href="author.html#15560">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/06/17 12:13, Ivan Larionov wrote:
&gt;<i> Hi!
</I>&gt;<i>
</I>&gt;<i> We recently updated from squid v2 to v3 and now see huge increase in 
</I>&gt;<i> connections in TIME_WAIT state on our squid servers (verified that 
</I>&gt;<i> this is clients connections).
</I>
The biggest change between 2.7 and 3.5 in this area is that 2.7 was 
HTTP/1.0 which closed TCP connections after each request by default, and 
3.5 is HTTP/1.1 which does not. So connections are more likely to 
persist until they hit some TCP timeout then enter the slow TIME_WAIT 
process.

There were also some other bugs identified in older 3.5 releases which 
increased the TIME_WAIT specifically. I thought those were almost all 
fixed by now, but YMMV whether you hit the remaining issues.
  A workaround it to set 
&lt;<A HREF="http://www.squid-cache.org/Doc/config/client_idle_pconn_timeout/">http://www.squid-cache.org/Doc/config/client_idle_pconn_timeout/</A>&gt; to a 
shorter value than the default  2min. eg you might want it to be 30sec 
or so.



&gt;<i>
</I>&gt;<i> See versions and amount of such connections under the same load with 
</I>&gt;<i> the same configs (except some incompatible stuff):
</I>&gt;<i>
</I>&gt;<i> squid 2.7.STABLE9
</I>&gt;<i>
</I>&gt;<i> configure options:  '--program-prefix=' '--prefix=/usr' 
</I>&gt;<i> '--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin' 
</I>&gt;<i> '--sysconfdir=/etc' '--includedir=/usr/include' '--libdir=/usr/lib' 
</I>&gt;<i> '--libexecdir=/usr/libexec' '--sharedstatedir=/usr/com' 
</I>&gt;<i> '--mandir=/usr/share/man' '--infodir=/usr/share/info' 
</I>&gt;<i> '--exec_prefix=/usr' '--bindir=/usr/sbin' 
</I>&gt;<i> '--libexecdir=/usr/lib/squid' '--localstatedir=/var' 
</I>&gt;<i> '--datadir=/usr/share' '--sysconfdir=/etc/squid' '--enable-epoll' 
</I>&gt;<i> '--enable-removal-policies=heap,lru' '--enable-storeio=aufs' 
</I>&gt;<i> '--enable-delay-pools' '--with-pthreads' '--enable-cache-digests' 
</I>&gt;<i> '--enable-useragent-log' '--enable-referer-log' '--with-large-files' 
</I>&gt;<i> '--with-maxfd=16384' '--enable-err-languages=English'
</I>&gt;<i>
</I>&gt;<i> # netstat -tn | grep TIME_WAIT | grep 3128 | wc -l
</I>&gt;<i> 95
</I>&gt;<i>
</I>&gt;<i> squid 3.5.25
</I>&gt;<i>
</I>&gt;<i> configure options:  '--program-prefix=' '--prefix=/usr' 
</I>&gt;<i> '--exec-prefix=/usr' '--bindir=/usr/sbin' '--sbindir=/usr/sbin' 
</I>&gt;<i> '--sysconfdir=/etc/squid' '--libdir=/usr/lib' 
</I>&gt;<i> '--libexecdir=/usr/lib/squid' '--includedir=/usr/include' 
</I>&gt;<i> '--datadir=/usr/share' '--sharedstatedir=/usr/com' 
</I>&gt;<i> '--localstatedir=/var' '--mandir=/usr/share/man' 
</I>&gt;<i> '--infodir=/usr/share/info' '--enable-epoll' 
</I>&gt;<i> '--enable-removal-policies=heap,lru' '--enable-storeio=aufs' 
</I>&gt;<i> '--enable-delay-pools' '--with-pthreads' '--enable-cache-digests' 
</I>&gt;<i> '--enable-useragent-log' '--enable-referer-log' '--with-large-files' 
</I>&gt;<i> '--with-maxfd=16384' '--enable-err-languages=English' '--enable-htcp'
</I>
FYI, these options are not doing anything for Squid-3:
   '--enable-useragent-log' '--enable-referer-log' 
'--enable-err-languages=English'


&gt;<i>
</I>&gt;<i> # netstat -tn | grep TIME_WAIT | grep 3128 | wc -l
</I>&gt;<i> 11277
</I>&gt;<i>
</I>&gt;<i> Config:
</I>&gt;<i>
</I>&gt;<i> http_port 0.0.0.0:3128 &lt;<A HREF="http://0.0.0.0:3128">http://0.0.0.0:3128</A>&gt;
</I>&gt;<i>
</I>&gt;<i> acl localnet src 10.0.0.0/8 &lt;<A HREF="http://10.0.0.0/8">http://10.0.0.0/8</A>&gt;     # RFC1918 possible 
</I>&gt;<i> internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12 &lt;<A HREF="http://172.16.0.0/12">http://172.16.0.0/12</A>&gt;  # RFC1918 
</I>&gt;<i> possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt; # RFC1918 
</I>&gt;<i> possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly 
</I>&gt;<i> plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i>
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i>
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> ### START CUSTOM
</I>&gt;<i> acl Purge_method method PURGE
</I>&gt;<i>
</I>&gt;<i> # Allow localhost to selectively flush the cache
</I>&gt;<i> http_access allow localhost Purge_method
</I>&gt;<i> http_access deny Purge_method
</I>&gt;<i> ### END CUSTOM
</I>&gt;<i>
</I>&gt;<i> ### ALLOW ACCESS TO ALL PORTS
</I>&gt;<i> # http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> ### START CUSTOM
</I>&gt;<i> # Disable icp
</I>&gt;<i> icp_port 0
</I>&gt;<i> # Allow ICP queries from local networks only
</I>&gt;<i> icp_access allow localnet
</I>&gt;<i> icp_access allow localhost
</I>&gt;<i> icp_access deny all
</I>&gt;<i>
</I>&gt;<i> # Disable htcp
</I>&gt;<i> htcp_port 0
</I>&gt;<i> # Allow HTCP queries from local networks only
</I>&gt;<i> htcp_access allow localnet
</I>&gt;<i> htcp_access allow localhost
</I>&gt;<i> htcp_access deny all
</I>
FYI: setting icp_access and htcp_access is pointless when the relevant 
port is 0. That port 0 disables the entire component.

&gt;<i>
</I>&gt;<i> # Check for custom request header
</I>&gt;<i> acl custom_acl req_header x-use-custom-proxy -i true
</I>&gt;<i> # Check for x-use-new-proxy request header
</I>&gt;<i> acl custom_new_acl req_header x-use-new-proxy -i true
</I>&gt;<i>
</I>&gt;<i> # first_proxy
</I>&gt;<i> cache_peer 127.0.0.1 parent 18070 0 no-query no-digest name=first_proxy
</I>&gt;<i> cache_peer_access first_proxy deny custom_acl
</I>&gt;<i> cache_peer_access first_proxy deny custom_new_acl
</I>&gt;<i>
</I>&gt;<i> # second_proxy
</I>&gt;<i> cache_peer 127.0.0.1 parent 18079 0 no-query no-digest name=second_proxy
</I>&gt;<i> cache_peer_access second_proxy allow custom_acl
</I>&gt;<i> cache_peer_access second_proxy allow custom_new_acl
</I>&gt;<i> cache_peer_access second_proxy deny all
</I>&gt;<i>
</I>&gt;<i> never_direct allow all
</I>&gt;<i>
</I>&gt;<i> cache_mem 4620591 KB
</I>&gt;<i> maximum_object_size_in_memory 8 KB
</I>&gt;<i> memory_replacement_policy heap LRU
</I>&gt;<i> cache_replacement_policy heap LRU
</I>&gt;<i>
</I>&gt;<i> cache_dir aufs /mnt/services/squid/cache 891289 16 256
</I>&gt;<i>
</I>&gt;<i> minimum_object_size 64 bytes # none-zero so we dont cache mistakes
</I>&gt;<i> maximum_object_size 102400 KB
</I>&gt;<i>
</I>&gt;<i> logformat combined %&gt;a %ui %un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st %tr 
</I>&gt;<i> &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %Ss:%Sh
</I>&gt;<i> logformat squid %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt
</I>
Please do not re-define these formats. If you want to use the default 
format they are defined internally by Squid3, if you want any 
customizations use a different format name.

&gt;<i>
</I>&gt;<i> access_log stdio:/var/log/squid/access.log combined
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i>
</I>&gt;<i> client_db off
</I>&gt;<i>
</I>&gt;<i> pid_filename /var/run/squid.pid
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> coredump_dir /var/cache
</I>&gt;<i> ### END CUSTOM
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> # refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>
Please do not remove that cgi-bin pattern. It is there to protect the 
cache against servers with broken/ancient CGI engines. It is designed 
explicitly so modern dynamic sites that provide proper cacheability 
headers can still be stored. So no harm and only benefits from in 
leaving it there.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015555.html">[squid-users] Huge amount of time_wait connections after upgrade from v2 to v3
</A></li>
	<LI>Next message (by thread): <A HREF="015554.html">[squid-users] CacheManager::ParseUrl: action 'digestauthenticator'	not found
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15560">[ date ]</a>
              <a href="thread.html#15560">[ thread ]</a>
              <a href="subject.html#15560">[ subject ]</a>
              <a href="author.html#15560">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
