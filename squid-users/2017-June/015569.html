<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on bridge mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5%20ssl-bump%20intercept%20TCP_DENIED/200%20on%0A%20bridge%20mode&In-Reply-To=%3Cf36e4969-a9d4-8e01-b99f-362d84e53e02%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015557.html">
   <LINK REL="Next"  HREF="015575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on bridge mode</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5%20ssl-bump%20intercept%20TCP_DENIED/200%20on%0A%20bridge%20mode&In-Reply-To=%3Cf36e4969-a9d4-8e01-b99f-362d84e53e02%40measurement-factory.com%3E"
       TITLE="[squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on bridge mode">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jun  7 14:32:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015557.html">[squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on	bridge mode
</A></li>
        <LI>Next message (by thread): <A HREF="015575.html">[squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on	bridge mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15569">[ date ]</a>
              <a href="thread.html#15569">[ thread ]</a>
              <a href="subject.html#15569">[ subject ]</a>
              <a href="author.html#15569">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/07/2017 03:37 AM, Jason Chiu wrote:

&gt;<i> 1495699856.074      0 192.168.95.81 TCP_DENIED/200 0 CONNECT 127.0.0.1:3129
</I>
&gt;<i> *Need to adjust which part of the settings?*
</I>
If that connection is really trying to connect to 127.0.0.1:3129 from
Squid point of view, then your interception setup is probably deficient.
Intercepted to-port 443 connections should be seen by Squid as going to
port 443 (while being received at Squid port 3129). Interception is not
(or should not be) just port redirection. This has nothing to do with
Squid configuration though.

Once you fix interception (or if you refuse to fix it), if Squid is
denying access, then you should adjust your http_access rules. Your
rules must allow fake CONNECT request that represent intercepted HTTPS
connections. For example, the above TCP_DENIED line is probably logged
because your current interception setup triggers this (correct) rule:

&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>

And yes, it might have &quot;worked&quot; in the past because earlier Squids were
doing fewer checks that they should be doing.

Alex.


&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> #cache_dir ufs /var/squid/cache/squid 100 16 256
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/squid/cache/squid
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> #http_port 3129 ssl-bump cert=/usr/local/squid/ssl_cert/myCA.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> https_port 3129 intercept ssl-bump cert=/usr/local/squid/ssl_cert/myCA.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> # sslcrtd
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/squid/ssl_db -M
</I>&gt;<i> 10MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> 
</I>&gt;<i> # sslproxy setting
</I>&gt;<i> sslproxy_capath /var/squid/ssl_db/certs
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,NO_TLSv1,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> #sslproxy_cipher
</I>&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_cert_adapt setValidAfter all
</I>&gt;<i> 
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>&gt;<i> ----------------------------------------
</I>&gt;<i> pf.conf
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> #internal interface
</I>&gt;<i> int_if = '{em1}'
</I>&gt;<i> 
</I>&gt;<i> # Normalization: reassemble fragments resolve or reduce traffic ambiguities.
</I>&gt;<i> scrub in all
</I>&gt;<i> set skip on lo0
</I>&gt;<i> 
</I>&gt;<i> #sslTP rdr setting
</I>&gt;<i> rdr_from = 'any'
</I>&gt;<i> rdr_to = 'any;
</I>&gt;<i> rdr on $int_if inet proto tcp from $rdr_from to $rdr_to port 443 -&gt;
</I>&gt;<i> 127.0.0.1 port 3129
</I>&gt;<i> pass in all no state
</I>&gt;<i> pass out all no state
</I>&gt;<i> pass in quick on $int_if route-to lo0 inet proto tcp from $rdr_from to any
</I>&gt;<i> keep state
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> View this message in context: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/squid-3-5-ssl-bump-intercept-TCP-DENIED-200-on-bridge-mode-tp4682712.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/squid-3-5-ssl-bump-intercept-TCP-DENIED-200-on-bridge-mode-tp4682712.html</A>
</I>&gt;<i> Sent from the Squid - Users mailing list archive at Nabble.com.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015557.html">[squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on	bridge mode
</A></li>
	<LI>Next message (by thread): <A HREF="015575.html">[squid-users] squid 3.5 ssl-bump intercept TCP_DENIED/200 on	bridge mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15569">[ date ]</a>
              <a href="thread.html#15569">[ thread ]</a>
              <a href="subject.html#15569">[ subject ]</a>
              <a href="author.html#15569">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
