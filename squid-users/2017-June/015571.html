<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache peer help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20peer%20help&In-Reply-To=%3C65c3699721d44d77bec274dae9c00b93%40UPF-BORN-MBX.crg.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015551.html">
   <LINK REL="Next"  HREF="015573.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache peer help</H1>
    <B>Alejandro Delgado Moreno</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20peer%20help&In-Reply-To=%3C65c3699721d44d77bec274dae9c00b93%40UPF-BORN-MBX.crg.es%3E"
       TITLE="[squid-users] Cache peer help">alex.delgado at crg.eu
       </A><BR>
    <I>Thu Jun  8 07:51:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015551.html">[squid-users] Cache peer help
</A></li>
        <LI>Next message (by thread): <A HREF="015573.html">[squid-users] Cache peer help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15571">[ date ]</a>
              <a href="thread.html#15571">[ thread ]</a>
              <a href="subject.html#15571">[ subject ]</a>
              <a href="author.html#15571">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Here is the squid.conf file:

acl localnet src 172.16.0.0/16

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT


acl journals dstdomain &quot;/etc/squid/UPF_LIST.txt&quot;

cache_peer proxy-inst.upf.edu parent 9090 0 no-query no-digest default

cache_peer_access proxy-inst.upf.edu allow journals
always_direct allow journals


# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS

# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 8881

coredump_dir /var/spool/squid

# Add any of your own refresh_pattern entries above these.
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


And this is an extract of the log:

[Thu Jun  8 09:47:15 2017].269     57 172.18.2.45 TCP_MISS/200 874 POST <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> - HIER_DIRECT/216.58.204.142 application/ocsp-response
[Thu Jun  8 09:47:16 2017].128     57 172.18.2.45 TCP_MISS/200 874 POST <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> - HIER_DIRECT/216.58.204.142 application/ocsp-response
[Thu Jun  8 09:47:16 2017].331     56 172.18.2.45 TCP_MISS/200 874 POST <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> - HIER_DIRECT/216.58.204.142 application/ocsp-response
[Thu Jun  8 09:47:20 2017].258    111 172.18.2.45 TCP_MISS/200 967 POST <A HREF="http://ocsp.usertrust.com/">http://ocsp.usertrust.com/</A> - HIER_DIRECT/178.255.83.1 application/ocsp-response
[Thu Jun  8 09:47:21 2017].250     56 172.18.2.45 TCP_MISS/200 874 POST <A HREF="http://clients1.google.com/ocsp">http://clients1.google.com/ocsp</A> - HIER_DIRECT/216.58.204.142 application/ocsp-response
[Thu Jun  8 09:47:21 2017].459     47 172.18.2.45 TCP_MISS/200 924 POST <A HREF="http://ocsp.digicert.com/">http://ocsp.digicert.com/</A> - HIER_DIRECT/93.184.220.29 application/ocsp-response
[Thu Jun  8 09:47:23 2017].744    185 172.18.2.45 TCP_MISS/302 615 GET <A HREF="http://wos.fecyt.es/">http://wos.fecyt.es/</A> - HIER_DIRECT/185.79.129.106 text/html
[Thu Jun  8 09:47:24 2017].005    104 172.18.2.45 TCP_MISS/200 2067 POST <A HREF="http://ss.symcd.com/">http://ss.symcd.com/</A> - HIER_DIRECT/23.37.171.27 application/ocsp-response
[Thu Jun  8 09:47:25 2017].902   5105 172.18.2.45 TCP_TUNNEL/200 5792 CONNECT www.recursoscientificos.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:27 2017].980     65 172.18.2.45 TCP_MISS/200 924 POST <A HREF="http://ocsp.digicert.com/">http://ocsp.digicert.com/</A> - HIER_DIRECT/93.184.220.29 application/ocsp-response
[Thu Jun  8 09:47:28 2017].394    211 172.18.2.45 TCP_MISS/200 488 GET <A HREF="http://detectportal.firefox.com/success.txt">http://detectportal.firefox.com/success.txt</A> - HIER_DIRECT/88.221.254.202 text/plain
[Thu Jun  8 09:47:28 2017].786     46 172.18.2.45 TCP_MISS/200 924 POST <A HREF="http://ocsp.digicert.com/">http://ocsp.digicert.com/</A> - HIER_DIRECT/93.184.220.29 application/ocsp-response
[Thu Jun  8 09:47:28 2017].809   8785 172.18.2.45 TCP_TUNNEL/200 54093 CONNECT www.recursoscientificos.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:30 2017].094   5079 172.18.2.45 TCP_TUNNEL/200 333 CONNECT idp.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:30 2017].094   5079 172.18.2.45 TCP_TUNNEL/200 331 CONNECT idp.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:30 2017].120   5106 172.18.2.45 TCP_TUNNEL/200 331 CONNECT idp.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:30 2017].144   5130 172.18.2.45 TCP_TUNNEL/200 332 CONNECT idp.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:30 2017].147   5133 172.18.2.45 TCP_TUNNEL/200 333 CONNECT idp.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -
[Thu Jun  8 09:47:30 2017].374   6567 172.18.2.45 TCP_TUNNEL/200 108115 CONNECT idp.fecyt.es:443 - HIER_DIRECT/185.79.129.106 -

As you can see, always is going direct, but when going to idp.fecyt.es should be going through the peer, as the file UPF_LIST.txt has:

<A HREF="https://idp.fecyt.es">https://idp.fecyt.es</A>
<A HREF="https://idp.fecyt.es/">https://idp.fecyt.es/</A>
<A HREF="https://idp.fecyt.es/*">https://idp.fecyt.es/*</A>
 
among other lines.

Regards,

-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: martes, 6 de junio de 2017 18:18
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Cache peer help

On 07/06/17 02:24, Alejandro Delgado Moreno wrote:
&gt;<i> Sorry for this mistake,
</I>&gt;<i>
</I>&gt;<i> It's:
</I>&gt;<i>
</I>&gt;<i> acl journals dstdomain &quot;/etc/squid/xx_LIST.txt&quot;
</I>&gt;<i>
</I>&gt;<i>   cache_peer xxx.xxx.xxx.xxx parent 9090 0 no-query no-digest default
</I>&gt;<i>
</I>&gt;<i>   cache_peer_access xxx.xxx.xxx.xxx allow journals
</I>&gt;<i>
</I>&gt;<i> and it's the same, in both lines.
</I>
Okay then the issue is something else, those lines in isolation are correct for allowing traffic to use that peer, but there are many other things that may make other routes either required or preferred.

So what is the rest of your squid.conf and can you provide a sample of the access.log for the traffic going wrong?

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015551.html">[squid-users] Cache peer help
</A></li>
	<LI>Next message (by thread): <A HREF="015573.html">[squid-users] Cache peer help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15571">[ date ]</a>
              <a href="thread.html#15571">[ thread ]</a>
              <a href="subject.html#15571">[ subject ]</a>
              <a href="author.html#15571">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
