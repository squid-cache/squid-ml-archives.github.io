<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] source spoofing without tproxy?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3Ce40c77cc-c58c-d3a1-f194-93a255c8cb30%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015601.html">
   <LINK REL="Next"  HREF="015607.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] source spoofing without tproxy?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3Ce40c77cc-c58c-d3a1-f194-93a255c8cb30%40treenet.co.nz%3E"
       TITLE="[squid-users] source spoofing without tproxy?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 13 04:50:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015601.html">[squid-users] source spoofing without tproxy?
</A></li>
        <LI>Next message (by thread): <A HREF="015607.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15605">[ date ]</a>
              <a href="thread.html#15605">[ thread ]</a>
              <a href="subject.html#15605">[ subject ]</a>
              <a href="author.html#15605">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/06/17 13:48, David Kewley wrote:
&gt;<i> I want my clients to explicitly address squid as a proxy (not use 
</I>&gt;<i> tproxy), but have squid spoof the source addresses in the forwarded 
</I>&gt;<i> connection, so that further hops know the original source address from 
</I>&gt;<i> the IPv4 headers.
</I>&gt;<i>
</I>&gt;<i> I could find no indication that anyone else has done this, and when I 
</I>&gt;<i> tried various things, I could not get it working.
</I>&gt;<i>
</I>&gt;<i> Is this possible today? If not, is it worth considering as a future 
</I>&gt;<i> feature? Or am I overlooking a reason that this cannot work even in 
</I>&gt;<i> theory?
</I>
It is not possible.

No, it is a terrible idea.

It is prohibited by the OS kernel as part of the anti-malware 
protections, in this case to prevent the local machine being used to 
attack its surrounding network nodes. And by Squid to make it harder to 
use Squid as viral payload and damage the brand reputation.


Also, HTTP contains multiplexing and persistent connections. So there is 
no particular relation between one incoming/client connection and the 
outgoing/server connection(s) the traffic from that client goes out on. 
Added to that, a client request may generate multiple outgoing requests 
of various types, or Squid may itself generate traffic for its own needs 
without any client interaction.

So doing this just degrades the proxy performance. And not in a small 
way - intercepted traffic pinning everything as this would need comes 
out about 10% nominal (90% reduction), and at the extreme end proxies 
with NTLM going through to an origin see only 1% of nominal performance. 
Nominal for me being what I clocked a big clients network doing in 
real-world traffic a few years back: ~20000 requests per second a few 
years back (Squid Project got approx 2x that in controlled lab tests).

&gt;<i>
</I>&gt;<i> I got the nearly-equivalent functionality working for reverse proxying 
</I>&gt;<i> using nginx, but so far I've found no way to do it with forward 
</I>&gt;<i> proxying. Nginx doesn't do https forward proxying (no handling of 
</I>&gt;<i> CONNECT).
</I>
So Nginx can be used to attack networks from inside. Good no know we now 
have to watch out for that in viral payloads too.

&gt;<i>
</I>&gt;<i> If squid can't do what I'm looking for today, I would welcome pointers 
</I>&gt;<i> to other possible approaches.
</I>
Squid supports X-Forwarded-For fully - it was invented by Squid devs 
back in the day, and Squid is still the authoritative implementation for 
how it is supposed to work. As an old feature just about all other HTTP 
server and intermediary software have support for that too so you should 
have no issue pulling the data out at the receiving end, or in HTTP 
processing DPI software / firewalls etc. It is sent on all outgoing 
Squid messages unless you explicitly configure something else to happen 
with the forwarded_for directive.
  &lt;<A HREF="http://www.squid-cache.org/Doc/config/forwarded_for/">http://www.squid-cache.org/Doc/config/forwarded_for/</A>&gt;


There is also newer HTTP &quot;Forwarded&quot; header which supercedes 
X-Forwarded-For and some very newly written servers might only support 
that. Squid lacks the built-in support for that directive so its no good 
on received traffic. But if you have to it can be sent to an upstream 
server fine with the request_header_add directive, like so:
   request_header_add Forwarded for=%&gt;a


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015601.html">[squid-users] source spoofing without tproxy?
</A></li>
	<LI>Next message (by thread): <A HREF="015607.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15605">[ date ]</a>
              <a href="thread.html#15605">[ thread ]</a>
              <a href="subject.html#15605">[ subject ]</a>
              <a href="author.html#15605">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
