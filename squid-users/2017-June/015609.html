<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20client--%3Eiptables--%3Esquid-proxy-%3Eanother-proxy&In-Reply-To=%3Cf6d464cd87cf4fb98380e988eb57e95e%40rechtspraak.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015602.html">
   <LINK REL="Next"  HREF="015601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy</H1>
    <B>Madonna, A. (spir-it)</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20client--%3Eiptables--%3Esquid-proxy-%3Eanother-proxy&In-Reply-To=%3Cf6d464cd87cf4fb98380e988eb57e95e%40rechtspraak.nl%3E"
       TITLE="[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy">A.Madonna at rechtspraak.nl
       </A><BR>
    <I>Tue Jun 13 07:35:29 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015602.html">[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy
</A></li>
        <LI>Next message (by thread): <A HREF="015601.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15609">[ date ]</a>
              <a href="thread.html#15609">[ thread ]</a>
              <a href="subject.html#15609">[ subject ]</a>
              <a href="author.html#15609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Jeryl,

If you look on the mailing list we and many before us have this problem.

Client ----&gt; Squid proxy ----&gt; Parent proxy ----&gt; Internets (http / HTTPS)

As already stated by 1 of the developers before, the code simply does not exist to handle this. cache_peer can't do a &quot;HTTP CONNECT&quot;, simulating the first client connection with a parent proxy.

This has been so for at least the last 5+ years.

We are now looking into a solution where we put something between the squid and the parent proxy which can provide a &quot;HTTP CONNECT&quot; in combination with ssl_bump preserving the original SNI(server name indication).

Client ----&gt; Squid proxy ----&gt; &quot;HTTP CONNECT&quot; solution----&gt;Parent proxy ----&gt; Internets (http / HTTPS)

Kind regards,



-----Oorspronkelijk bericht-----
Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Amos Jeffries
Verzonden: dinsdag 13 juni 2017 5:41
Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Onderwerp: Re: [squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy

On 13/06/17 08:33, JerylCook wrote:
&gt;<i> I've been stuck on this for a few days :P...
</I>&gt;<i>
</I>&gt;<i>   I 'thought' I had a fairly good understanding of squid + ssl_bump
</I>&gt;<i> but not so sure.
</I>&gt;<i>
</I>&gt;<i> In a nutshell i am having an issue linking a second proxy server via
</I>&gt;<i> cache_peer.
</I>&gt;<i>
</I>&gt;<i> we have 2 boxes.
</I>&gt;<i>
</I>&gt;<i> *Configuration:*
</I>&gt;<i> 1 box, has iptables configured to send all outbound traffic to
</I>&gt;<i> 10.0.0.1:8999 which is the second box's squid server and port(8999)
</I>&gt;<i>
</I>&gt;<i> 2nd box, has squid running on 8999, we have another server running on 8998.
</I>&gt;<i> both proxy servers are using the same 'CA'.
</I>&gt;<i>
</I>&gt;<i> https 10.0.0.1:8999 transparent ssl-bump generate-host-certificates=on.....
</I>&gt;<i>
</I>&gt;<i> cache_peer 10.0.0.1:8998 8998 0 ssl default no-query no-digest
</I>&gt;<i> sslflags=DONT_VERIFY_PEER....
</I>&gt;<i>
</I>&gt;<i> use-case:
</I>&gt;<i> wget <A HREF="https://facebook.com">https://facebook.com</A> --ca-cert=/dat/sharedCa.cer  , on box 1
</I>&gt;<i> through iptables..
</I>&gt;<i> 1. squid on box 2 generates and signs a certificate with
</I>&gt;<i> CN=facebook.com for the client
</I>
That sounds a little suspicious to me. FB have a more complicated CN in their real certs. You omitted your ssl_bump rules, so the type of bumping and details available are unknown - but I suspect they may not be doing what you expect in that case.

&gt;<i> 2. client trusts the CA and cert.
</I>
Which if the three CA involved? they need to trust the one being used by the frontend Squid cert generator.
  Only frontend Squid needs to trust the backend peer CA. And likewise, only the backend peer needs to trust the origin CA.

&gt;<i> 3.we want squid to send this proxied https request to the second proxy
</I>&gt;<i> server on :8998. this proxy server is set to generate impersonation
</I>&gt;<i> certs as well using the same rootCAKey that squid uses...
</I>
This is where the current behaviour is lacking AFAIK. SSL-Bump assumes the client (frontend Squid) is either sending a CONNECT request to get the server details from, or that it is working with intercepted TLS rather than a TLS explicit proxy connection. So the backend behaviour is still very much just receive a request for <A HREF="https://">https://</A> URL and do the serve TLS thing - no mimicing on its client connection (AFAIK).

&gt;<i> however, we keep getting
</I>&gt;<i> &quot;Failed to establish a secure connection, SQUID_ERR_SSL_HANDSHAKE&quot;,
</I>&gt;<i> Handshake with SSL Server failed: error:140770FC:SSL routines
</I>&gt;<i> SSL23_GET_SERVER_HELLO: unknown protocol&quot;
</I>&gt;<i>
</I>&gt;<i> Does squid 3.5.20 support PROXY Protocol in cache_peer if you need to
</I>&gt;<i> link a second proxy? or is my configuration messed up.
</I>
Squid only supports receiving PROXY Protocol on the http_port directive.
Not yet sending to a cache_peer. Though I don't see any relevance to PROXY Protocol in anything you have described about your configuration.

If the peer is sending an error back to Squid when it gets TLS instead of PROXY intro octets that would explain the SSL errors. It also would if the peer was sending back HTTP messages instead of TLS (HTTPS), which is a more common problem when the peer is an older Squid.


SSL-Bump is supported to cache_peer when the peer connection is a TLS/SSL connection. Though be aware that the &quot;server&quot; frontend Squid mimics would then be the backend peer's certificate, not the origin server.

Also, avoid DONT_VERIFY_PEER, it is really doing more harm than anything useful. Since this is a peer you know about you should also know its CA in advance. So use &quot;sslflags=NO_DEFAULT_CA sslcafile=...&quot; and Squid can do all the security checks just fine regardless of whether its a custom CA or not.

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

________________________________

Informatie van de Raad voor de rechtspraak, de rechtbanken, de gerechtshoven en de bijzondere colleges vindt u op www.rechtspraak.nl.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015602.html">[squid-users] client--&gt;iptables--&gt;squid-proxy-&gt;another-proxy
</A></li>
	<LI>Next message (by thread): <A HREF="015601.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15609">[ date ]</a>
              <a href="thread.html#15609">[ thread ]</a>
              <a href="subject.html#15609">[ subject ]</a>
              <a href="author.html#15609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
