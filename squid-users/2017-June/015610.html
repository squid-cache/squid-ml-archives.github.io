<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] source spoofing without tproxy?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3Cb2003801-7c31-ea31-62cc-fb0ebb2e99a4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015608.html">
   <LINK REL="Next"  HREF="015633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] source spoofing without tproxy?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3Cb2003801-7c31-ea31-62cc-fb0ebb2e99a4%40treenet.co.nz%3E"
       TITLE="[squid-users] source spoofing without tproxy?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 13 09:49:15 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015608.html">[squid-users] source spoofing without tproxy?
</A></li>
        <LI>Next message (by thread): <A HREF="015633.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15610">[ date ]</a>
              <a href="thread.html#15610">[ thread ]</a>
              <a href="subject.html#15610">[ subject ]</a>
              <a href="author.html#15610">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/06/17 19:34, Matus UHLAR - fantomas wrote:
&gt;&gt;<i> On 13/06/17 13:48, David Kewley wrote:
</I>&gt;&gt;&gt;<i> I want my clients to explicitly address squid as a proxy (not use 
</I>&gt;&gt;&gt;<i> tproxy), but have squid spoof the source addresses in the forwarded 
</I>&gt;&gt;&gt;<i> connection, so that further hops know the original source address 
</I>&gt;&gt;&gt;<i> from the IPv4 headers.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I could find no indication that anyone else has done this, and when 
</I>&gt;&gt;&gt;<i> I tried various things, I could not get it working.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is this possible today? If not, is it worth considering as a future 
</I>&gt;&gt;&gt;<i> feature? Or am I overlooking a reason that this cannot work even in 
</I>&gt;&gt;&gt;<i> theory?
</I>&gt;<i>
</I>&gt;<i> On 13.06.17 16:50, Amos Jeffries wrote:
</I>&gt;&gt;<i> It is not possible.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No, it is a terrible idea.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It is prohibited by the OS kernel as part of the anti-malware 
</I>&gt;&gt;<i> protections, in this case to prevent the local machine being used to 
</I>&gt;&gt;<i> attack its surrounding network nodes. And by Squid to make it harder 
</I>&gt;&gt;<i> to use Squid as viral payload and damage the brand reputation.
</I>&gt;<i>
</I>&gt;<i> For me to fully understand (I was curious about this some time ago), 
</I>&gt;<i> it is
</I>&gt;<i> allowed to fake clients' IPs when intercepting their connections, but not
</I>&gt;<i> when connections are done to proxy server directly?
</I>
Yes.

&gt;<i> What's the difference that makes it more terrible than spoofing IPs of
</I>&gt;<i> intercepted connections?
</I>
If you take a close look at the packets you should see the incoming ones 
as (client-IP:server-IP:server-port) and outgoing from Squid has 
identical (client-IP:server-IP:server-port). Only the src-port differs.
  - As far as the rest of the network is concerned Squid is acting as if 
it were a TCP router. The kernel is also configured as a router in order 
to do TPROXY, so the whole environment except for the proxy and a few 
rules in the networking stack is setup for routing.


By comparison, without TPROXY the incoming packets have 
(client-IP:client-port:squid-IP:squid-port) and the server connection 
packets would have (client-IP:random-port:server-IP:server-port). The 
machine is setup as a server host, not a router. Which is where Ingress 
and Egress Filtering both stomp on it hard for using other machines IPs.


PS. if you spoof (with or without TPROXY) and have not implemented 
BCP-38 ingress filtering (AND its equivalent egress filtering) on your 
network then you are part of the DoS attack system, guaranteed, whether 
you know it or not. Very likely you will _not_ be aware of it because 
all the information you can log or gather from TCP is spoofed (duh!) and 
appears to be your own innocent clients doing things that clients tend 
to do (NTP lookups? DNS lookups? sending email? using HTTP? sure no harm 
there ... unless it wasn't them).

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015608.html">[squid-users] source spoofing without tproxy?
</A></li>
	<LI>Next message (by thread): <A HREF="015633.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15610">[ date ]</a>
              <a href="thread.html#15610">[ thread ]</a>
              <a href="subject.html#15610">[ subject ]</a>
              <a href="author.html#15610">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
