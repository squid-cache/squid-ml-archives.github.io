<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] source spoofing without tproxy?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3Cbbd1961a-f491-85a0-a9c3-c82c704900da%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015607.html">
   <LINK REL="Next"  HREF="015614.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] source spoofing without tproxy?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3Cbbd1961a-f491-85a0-a9c3-c82c704900da%40treenet.co.nz%3E"
       TITLE="[squid-users] source spoofing without tproxy?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 13 10:15:49 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015607.html">[squid-users] source spoofing without tproxy?
</A></li>
        <LI>Next message (by thread): <A HREF="015614.html">[squid-users] Negotiate Kerberos Auth - BH Invalid request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15611">[ date ]</a>
              <a href="thread.html#15611">[ thread ]</a>
              <a href="subject.html#15611">[ subject ]</a>
              <a href="author.html#15611">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/06/17 18:14, David Kewley wrote:
&gt;<i> Thanks for your reply, Amos.
</I>&gt;<i>
</I>&gt;<i> On Mon, Jun 12, 2017 at 9:50 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     On 13/06/17 13:48, David Kewley wrote:
</I>&gt;<i>
</I>&gt;<i>         I want my clients to explicitly address squid as a proxy (not
</I>&gt;<i>         use tproxy), but have squid spoof the source addresses in the
</I>&gt;<i>         forwarded connection, so that further hops know the original
</I>&gt;<i>         source address from the IPv4 headers.
</I>&gt;<i>
</I>&gt;<i>         I could find no indication that anyone else has done this, and
</I>&gt;<i>         when I tried various things, I could not get it working.
</I>&gt;<i>
</I>&gt;<i>         Is this possible today? If not, is it worth considering as a
</I>&gt;<i>         future feature? Or am I overlooking a reason that this cannot
</I>&gt;<i>         work even in theory?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     It is not possible.
</I>&gt;<i>
</I>&gt;<i>     No, it is a terrible idea.
</I>&gt;<i>
</I>&gt;<i>     It is prohibited by the OS kernel as part of the anti-malware
</I>&gt;<i>     protections, in this case to prevent the local machine being used
</I>&gt;<i>     to attack its surrounding network nodes. And by Squid to make it
</I>&gt;<i>     harder to use Squid as viral payload and damage the brand reputation.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What exactly is the &quot;it&quot; that you're saying is prohibited by the OS 
</I>&gt;<i> kernel? Source spoofing alone, or something else?
</I>
The &quot;it&quot; that was the subject of your question &quot;it&quot; - spoofing.
&gt;<i>
</I>&gt;<i>     Also, HTTP contains multiplexing and persistent connections. So
</I>&gt;<i>     there is no particular relation between one incoming/client
</I>&gt;<i>     connection and the outgoing/server connection(s) the traffic from
</I>&gt;<i>     that client goes out on. Added to that, a client request may
</I>&gt;<i>     generate multiple outgoing requests of various types, or Squid may
</I>&gt;<i>     itself generate traffic for its own needs without any client
</I>&gt;<i>     interaction.
</I>&gt;<i>
</I>&gt;<i>     So doing this just degrades the proxy performance. And not in a
</I>&gt;<i>     small way - intercepted traffic pinning everything as this would
</I>&gt;<i>     need comes out about 10% nominal (90% reduction), and at the
</I>&gt;<i>     extreme end proxies with NTLM going through to an origin see only
</I>&gt;<i>     1% of nominal performance. Nominal for me being what I clocked a
</I>&gt;<i>     big clients network doing in real-world traffic a few years back:
</I>&gt;<i>     ~20000 requests per second a few years back (Squid Project got
</I>&gt;<i>     approx 2x that in controlled lab tests).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Good to know there are strong performance implications, thanks. I 
</I>&gt;<i> don't understand these systems deeply enough to have anticipated this, 
</I>&gt;<i> so I appreciate the heads-up. Too many systems to learn, too quickly...
</I>&gt;<i>
</I>&gt;<i>         I got the nearly-equivalent functionality working for reverse
</I>&gt;<i>         proxying using nginx, but so far I've found no way to do it
</I>&gt;<i>         with forward proxying. Nginx doesn't do https forward proxying
</I>&gt;<i>         (no handling of CONNECT).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     So Nginx can be used to attack networks from inside. Good no know
</I>&gt;<i>     we now have to watch out for that in viral payloads too.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &quot;Can be used to attack&quot; because of source spoofing, or something else?
</I>&gt;<i>
</I>
Directly because of source spoofing, or equivalent if you got it sending 
from any non-local IP address. &quot;local&quot; meaning an IP address explicitly 
assigned for use by the machine the proxy runs on.

This might be of help if you are not already aware of the risks and 
issues involved with spoofing and handling of non-local IPs; 
&lt;<A HREF="http://www.bcp38.info/">http://www.bcp38.info/</A>&gt;


&gt;<i>         If squid can't do what I'm looking for today, I would welcome
</I>&gt;<i>         pointers to other possible approaches.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Squid supports X-Forwarded-For fully - it was invented by Squid
</I>&gt;<i>     devs back in the day, and Squid is still the authoritative
</I>&gt;<i>     implementation for how it is supposed to work. As an old feature
</I>&gt;<i>     just about all other HTTP server and intermediary software have
</I>&gt;<i>     support for that too so you should have no issue pulling the data
</I>&gt;<i>     out at the receiving end, or in HTTP processing DPI software /
</I>&gt;<i>     firewalls etc. It is sent on all outgoing Squid messages unless
</I>&gt;<i>     you explicitly configure something else to happen with the
</I>&gt;<i>     forwarded_for directive.
</I>&gt;<i>      &lt;<A HREF="http://www.squid-cache.org/Doc/config/forwarded_for/">http://www.squid-cache.org/Doc/config/forwarded_for/</A>
</I>&gt;<i>     &lt;<A HREF="http://www.squid-cache.org/Doc/config/forwarded_for/">http://www.squid-cache.org/Doc/config/forwarded_for/</A>&gt;&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'll ask the team managing the next-hop device to evaluate that 
</I>&gt;<i> possibility; it looks to me from the docs like it might work. Thanks 
</I>&gt;<i> for the suggestion.
</I>&gt;<i>
</I>&gt;<i> David
</I>
That would be best if it works.

I came up with a bodgy workaround using NAT after sending the earlier 
mail. So if there is no other way than delivering the client-IP on the 
packets there is still something that might be done. But, that would 
still run up against HTTP multiplexing and also add all sorts of NAT 
related issues as well. So only a last resort really.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015607.html">[squid-users] source spoofing without tproxy?
</A></li>
	<LI>Next message (by thread): <A HREF="015614.html">[squid-users] Negotiate Kerberos Auth - BH Invalid request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15611">[ date ]</a>
              <a href="thread.html#15611">[ thread ]</a>
              <a href="subject.html#15611">[ subject ]</a>
              <a href="author.html#15611">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
