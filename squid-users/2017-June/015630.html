<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] source spoofing without tproxy?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3CCAHKjJqiDi%3DMObezZore05Hhy7gOm9NFJt6ZWx0ab0qGo0dUVmA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015615.html">
   <LINK REL="Next"  HREF="015631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] source spoofing without tproxy?</H1>
    <B>David Kewley</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20source%20spoofing%20without%20tproxy%3F&In-Reply-To=%3CCAHKjJqiDi%3DMObezZore05Hhy7gOm9NFJt6ZWx0ab0qGo0dUVmA%40mail.gmail.com%3E"
       TITLE="[squid-users] source spoofing without tproxy?">dkewley at uci.edu
       </A><BR>
    <I>Tue Jun 13 20:41:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015615.html">[squid-users] Negotiate Kerberos Auth - BH Invalid request
</A></li>
        <LI>Next message (by thread): <A HREF="015631.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15630">[ date ]</a>
              <a href="thread.html#15630">[ thread ]</a>
              <a href="subject.html#15630">[ subject ]</a>
              <a href="author.html#15630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Jun 13, 2017 at 3:15 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 13/06/17 18:14, David Kewley wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> This might be of help if you are not already aware of the risks and
</I>&gt;&gt;<i> issues involved with spoofing and handling of non-local IPs; &lt;
</I>&gt;&gt;<i> <A HREF="http://www.bcp38.info/">http://www.bcp38.info/</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>I was aware of at least most of those issues, though I'm not an expert on
them. So the reference is useful, thanks.

Our squid server will only accept connections from its internal IP spaces,
and I only wanted it to spoof the actual client source IPs to make
downstream decision making easier based on the IP headers (but
X-Forwarded-For might be sufficient, as you pointed out). Also the actual
egress point to the internet is a NAT device that always uses its external
IP as the source IP. So I see zero risk of us leaking foreign spoofed
source IP addresses.

I will take a look at our ingress filtering to make sure we're rejecting
external inbound packets claiming to be from our internal network.

Do you see anything obvious I'm missing around what I should do for BCP38?

I'm taking seriously your warning about a significant performance impact.
I'll be curious to see if similar issues impact our nginx reverse proxies
that spoof the original source IP in the proxied connection. Makes sense it
might.

    Squid supports X-Forwarded-For fully - it was invented by Squid
&gt;&gt;<i>     devs back in the day, and Squid is still the authoritative
</I>&gt;&gt;<i>     implementation for how it is supposed to work. As an old feature
</I>&gt;&gt;<i>     just about all other HTTP server and intermediary software have
</I>&gt;&gt;<i>     support for that too so you should have no issue pulling the data
</I>&gt;&gt;<i>     out at the receiving end, or in HTTP processing DPI software /
</I>&gt;&gt;<i>     firewalls etc. It is sent on all outgoing Squid messages unless
</I>&gt;&gt;<i>     you explicitly configure something else to happen with the
</I>&gt;&gt;<i>     forwarded_for directive.
</I>&gt;&gt;<i>      &lt;<A HREF="http://www.squid-cache.org/Doc/config/forwarded_for/">http://www.squid-cache.org/Doc/config/forwarded_for/</A>
</I>&gt;&gt;<i>     &lt;<A HREF="http://www.squid-cache.org/Doc/config/forwarded_for/">http://www.squid-cache.org/Doc/config/forwarded_for/</A>&gt;&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'll ask the team managing the next-hop device to evaluate that
</I>&gt;&gt;<i> possibility; it looks to me from the docs like it might work. Thanks for
</I>&gt;&gt;<i> the suggestion.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That would be best if it works.
</I>&gt;<i>
</I>&gt;<i> I came up with a bodgy workaround using NAT after sending the earlier
</I>&gt;<i> mail. So if there is no other way than delivering the client-IP on the
</I>&gt;<i> packets there is still something that might be done. But, that would still
</I>&gt;<i> run up against HTTP multiplexing and also add all sorts of NAT related
</I>&gt;<i> issues as well. So only a last resort really.
</I>

Thanks! I'll come back to you if I think that might be useful. For now I'll
proceed with using squid in a more normal fashion, and work with the owners
of our next-hop-device about using X-Forwarded-For for any decision making.

I will proceed assuming that squid will never support the sort of spoofing
I was hoping for (since it would probably simplify things greatly for us),
even though I believe in our design that spoofing would have been safe.

David
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170613/1970d282/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170613/1970d282/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015615.html">[squid-users] Negotiate Kerberos Auth - BH Invalid request
</A></li>
	<LI>Next message (by thread): <A HREF="015631.html">[squid-users] source spoofing without tproxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15630">[ date ]</a>
              <a href="thread.html#15630">[ thread ]</a>
              <a href="subject.html#15630">[ subject ]</a>
              <a href="author.html#15630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
