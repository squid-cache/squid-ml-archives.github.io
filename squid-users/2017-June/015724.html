<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid reject self-signed SSL certificate of ICAP server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20reject%20self-signed%20SSL%20certificate%20of%20ICAP%0A%20server&In-Reply-To=%3C6452fd04-d550-2ff9-e084-f9ab479e487a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015723.html">
   <LINK REL="Next"  HREF="015725.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid reject self-signed SSL certificate of ICAP server</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20reject%20self-signed%20SSL%20certificate%20of%20ICAP%0A%20server&In-Reply-To=%3C6452fd04-d550-2ff9-e084-f9ab479e487a%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid reject self-signed SSL certificate of ICAP server">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun 22 13:33:02 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015723.html">[squid-users] Squid reject self-signed SSL certificate of ICAP	server
</A></li>
        <LI>Next message (by thread): <A HREF="015725.html">[squid-users] Header order in squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15724">[ date ]</a>
              <a href="thread.html#15724">[ thread ]</a>
              <a href="subject.html#15724">[ subject ]</a>
              <a href="author.html#15724">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/06/17 21:23, Nikita wrote:
&gt;<i> 
</I>&gt;<i> 2017-06-21 19:46 GMT+03:00 Alex Rousskov:
</I>&gt;<i> 
</I>&gt;<i>     On 06/21/2017 10:15 AM, Nikita wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; Is it possible to allow self-signed SSL certificates for ICAP server
</I>&gt;<i>     &gt; connections somehow?
</I>&gt;<i> 
</I>&gt;<i>     Can you configure your OpenSSL library (or equivalent) to trust the ICAP
</I>&gt;<i>     server certificate? Squid deletages most of the certificate validation
</I>&gt;<i>     work to OpenSSL (or equivalent).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Probably worth a try, but generally it is undesirable in my case to 
</I>&gt;<i> modify global OpenSSL config.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; There is tls-flags=DONT_VERIFY_PEER flag, but in this case Squid
</I>&gt;<i>     &gt; don't send it's own certificate to ICAP server
</I>&gt;<i> 
</I>&gt;<i>     Why do you think tls-flags=DONT_VERIFY_PEER only works if Squid sends
</I>&gt;<i>     its own certificate? The two actions (from-peer certificate validation
</I>&gt;<i>     and sending of a certificate to a peer) seem unrelated to me.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In my case for some unknown reasons Squid don't send its own certificate 
</I>&gt;<i> to ICAP server, probably because of DONT_VERIFY_PEER flag, but not sure 
</I>&gt;<i> here. BIO_do_handshake fails with &quot;no certificate returned&quot; on ICAP 
</I>&gt;<i> server side despite the fact that squid certificate was specified via 
</I>&gt;<i> tls-cert and tls-key options of icap_service config directive and ICAP 
</I>&gt;<i> server was configured to request client certificate. It seems need to 
</I>&gt;<i> investigate Squid source code in more detail to find some answers, 
</I>&gt;<i> thanks for advices.
</I>

What DONT_VERIFY_PEER does is prevent Squid checking any of the TLS 
server details that ensure it is actually talking to the ICAP server you 
configured it to use. As Alex said it does not directly prevent Squid 
code from sending a client cert, but it *does* allow your Squid traffic 
to be diverted to a completely irrelevant ICAP server and you will never 
know.

It is quite possible the behaviour you are seeing is simply because 
Squid is not even connected to the ICAP server you are trying to test with.

I hope this clarifies why I strongly recommend people erase the 
DONT_VERIFY_PEER option from their configs, and get things going without 
it. It is not a useful debugging tool, let along production setting.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015723.html">[squid-users] Squid reject self-signed SSL certificate of ICAP	server
</A></li>
	<LI>Next message (by thread): <A HREF="015725.html">[squid-users] Header order in squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15724">[ date ]</a>
              <a href="thread.html#15724">[ thread ]</a>
              <a href="subject.html#15724">[ subject ]</a>
              <a href="author.html#15724">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
