<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Header order in squid proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Header%20order%20in%20squid%20proxy&In-Reply-To=%3CCALSaDe0TD%3DsctLfc8xP_URsfRyvSo1cNm6p9%2BTdsohi2sgXkhg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015726.html">
   <LINK REL="Next"  HREF="015728.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Header order in squid proxy</H1>
    <B>Sonya Roy</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Header%20order%20in%20squid%20proxy&In-Reply-To=%3CCALSaDe0TD%3DsctLfc8xP_URsfRyvSo1cNm6p9%2BTdsohi2sgXkhg%40mail.gmail.com%3E"
       TITLE="[squid-users] Header order in squid proxy">sonyaroy75 at gmail.com
       </A><BR>
    <I>Thu Jun 22 18:54:25 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015726.html">[squid-users] Header order in squid proxy
</A></li>
        <LI>Next message (by thread): <A HREF="015728.html">[squid-users] Header order in squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15727">[ date ]</a>
              <a href="thread.html#15727">[ thread ]</a>
              <a href="subject.html#15727">[ subject ]</a>
              <a href="author.html#15727">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The sites I am talking about check the User-Agent header and makes sure the
user-agent is for a well-known browser, i.e. a browser that they support.
And any browser like Firefox, Chrome, Safari, Edge for example, sends the
headers in a certain order and the order depends on the browser. And this
header order for well-known headers like Accept, Accept-Language,
Accept-Encoding, Content-Length, Host, Connection, Referer, Cookie, etc.
And they match the order of the received request with the standard header
order for the browser for that user-agent.

This detects bots like a poorly written bot(i.e ones that don't consider
this header order) using python requests or in any language for that matter
where the requests are handled using a low level http requests library.

So, keeping the header order sent from the client intact would prevent them
from dropping proxied requests(ones that use squid). I know for a fact that
they don't intend to block proxies.

Could you point me in the direction to where I should look for in the
source code of squid? the part that handles the header data sent from the
client.

With regards,
Sonya Roy.

On Fri, Jun 23, 2017 at 12:02 AM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 06/22/2017 11:49 AM, Sonya Roy wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I noticed that squid changes the header order received from the client
</I>&gt;<i> &gt; before sending it to the origin server.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I assume this is because squid parses the header data and adds some
</I>&gt;<i> &gt; headers depending on the config file and then recreates the header data.
</I>&gt;<i>
</I>&gt;<i> IIRC, modern Squids change a header field position when the received
</I>&gt;<i> field is deleted and then added back. This is typical for hop-by-hop
</I>&gt;<i> headers such as Connection, but there are other reasons for Squid to
</I>&gt;<i> delete and add a header field. When the value of the added field is the
</I>&gt;<i> same as the value of the removed field, such pointless &quot;editing&quot; looks
</I>&gt;<i> like mindless &quot;reordering&quot; to the outside observer.
</I>&gt;<i>
</I>&gt;<i> The two actions (field deletion and addition) may happen in a single
</I>&gt;<i> piece of code or may be separated by lots of code and even time.
</I>&gt;<i> Preventing pointless editing in the former cases is straightforward, but
</I>&gt;<i> the latter cases are difficult to handle. Correct avoidance of pointless
</I>&gt;<i> editing may improve performance and, if it does, can be considered a
</I>&gt;<i> useful optimization on its own, regardless of your use case.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Is there any way to prevent this?
</I>&gt;<i>
</I>&gt;<i> Not without changing Squid code (or adding more proxies). However,
</I>&gt;<i> before we even talk about code changes, we should clarify the problem we
</I>&gt;<i> are dealing with. The questions below will guide you.
</I>&gt;<i>
</I>&gt;<i> It is probably much easier to ensure some fixed field send order
</I>&gt;<i> (regardless of the received order) than to preserve the received order.
</I>&gt;<i> Will a fixed order (e.g., always alphabetical) address your use case?
</I>&gt;<i> This feature will hurt performance, but you might be able to convince
</I>&gt;<i> others to accept it if you have a very compelling/specific/detailed use
</I>&gt;<i> case because it can be disabled by default.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I am asking because some sites detect bots using the header order and
</I>&gt;<i> &gt; they drop any such connection. So they unintentionally block squid
</I>&gt;<i> &gt; proxies even if its not being used by a bot.
</I>&gt;<i>
</I>&gt;<i> Are you implying that bots often change header field order between their
</I>&gt;<i> requests? Or that bots often use a different (fixed) header field order
</I>&gt;<i> than the (fixed) field order used by non-bots? Preserving received order
</I>&gt;<i> may help in the former case but not in the latter case.
</I>&gt;<i>
</I>&gt;<i> Also, do those blocking sites pay attention to all headers or just
</I>&gt;<i> end-to-end headers?
</I>&gt;<i>
</I>&gt;<i> Please note that there are many other ways to detect a proxy so if a
</I>&gt;<i> site wants to block proxies rather than bots, then it is probably
</I>&gt;<i> pointless to fight it (or, at least, the Squid Project should not).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170623/43740d9e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170623/43740d9e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015726.html">[squid-users] Header order in squid proxy
</A></li>
	<LI>Next message (by thread): <A HREF="015728.html">[squid-users] Header order in squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15727">[ date ]</a>
              <a href="thread.html#15727">[ thread ]</a>
              <a href="subject.html#15727">[ subject ]</a>
              <a href="author.html#15727">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
