<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid caching bad objects
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20caching%20bad%20objects&In-Reply-To=%3Ca494df2a-eb3d-acd4-ea08-2bc615348c45%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015740.html">
   <LINK REL="Next"  HREF="015756.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid caching bad objects</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20caching%20bad%20objects&In-Reply-To=%3Ca494df2a-eb3d-acd4-ea08-2bc615348c45%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid caching bad objects">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jun 26 17:06:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015740.html">[squid-users] Squid caching bad objects
</A></li>
        <LI>Next message (by thread): <A HREF="015756.html">[squid-users] Squid caching bad objects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15741">[ date ]</a>
              <a href="thread.html#15741">[ thread ]</a>
              <a href="subject.html#15741">[ subject ]</a>
              <a href="author.html#15741">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/26/2017 10:11 AM, Razor Cross wrote:

&gt;<i> We are using squid 3.5. for our server. Recently we have noticed that
</I>&gt;<i> squid is caching incomplete objects in case of chunked response.
</I>&gt;<i> 
</I>&gt;<i> We have gone through the squid code. It looks likes squid is caching
</I>&gt;<i> incomplete response in case of EOF from the server even though it does
</I>&gt;<i> not receive the last empty chunk.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  if (eof) // already reached EOF
</I>&gt;<i>         return COMPLETE_NONPERSISTENT_MSG;
</I>
You are looking at the wrong code. HttpStateData::persistentConnStatus()
and related *_MSG codes do not determine whether the entire object was
received. They determine whether

(a) Squid should expect more response bytes and

(b) The connection can be kept open if no more response bytes are expected.

The COMPLETE_NONPERSISTENT_MSG return value is correct here (I am
ignoring the sad fact that we are abusing the word &quot;complete&quot; to cover
both whole and truncated responses).


&gt;<i> Is this expected? Because of this problem, our server ends up serving
</I>&gt;<i> bad objects to the user.
</I>
What you describe sounds like a bug, but the exact code you are quoting
is not responsible for that bug. I di not study this in detail, but I
suspect that the COMPLETE_NONPERSISTENT_MSG case in
HttpStateData::processReplyBody() should be changed to call
StoreEntry::lengthWentBad(&quot;missing last-chunk&quot;) when lastChunk is false
and HttpStateData::flags.chunked is true.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015740.html">[squid-users] Squid caching bad objects
</A></li>
	<LI>Next message (by thread): <A HREF="015756.html">[squid-users] Squid caching bad objects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15741">[ date ]</a>
              <a href="thread.html#15741">[ thread ]</a>
              <a href="subject.html#15741">[ subject ]</a>
              <a href="author.html#15741">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
