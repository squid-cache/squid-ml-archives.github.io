<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.2%3D%3D%3E%20HTTPS%20FATAL%3A%20The%20ssl_crtd%20helpers%0A%09are%20crashing%20too%20rapidly%2C%20need%20help%21&In-Reply-To=%3CBF13D4F4-ABE5-4A60-87C6-11FB66A02686%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014590.html">
   <LINK REL="Next"  HREF="014685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!</H1>
    <B>Guy Helmer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.2%3D%3D%3E%20HTTPS%20FATAL%3A%20The%20ssl_crtd%20helpers%0A%09are%20crashing%20too%20rapidly%2C%20need%20help%21&In-Reply-To=%3CBF13D4F4-ABE5-4A60-87C6-11FB66A02686%40gmail.com%3E"
       TITLE="[squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!">guy.helmer at gmail.com
       </A><BR>
    <I>Mon Mar  6 14:33:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014590.html">[squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!
</A></li>
        <LI>Next message (by thread): <A HREF="014685.html">[squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14597">[ date ]</a>
              <a href="thread.html#14597">[ thread ]</a>
              <a href="subject.html#14597">[ subject ]</a>
              <a href="author.html#14597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, all,

A couple of years ago, I wrote a perl script that ran a specified number of ssl_crtd processes with simultaneous requests to expose the problem and test the resolution. I&#8217;ve attached it below in case it would help test/diagnose the situation. It has hard-coded paths at the top of the script that would need to be updated for any particular test environment, and its testing certificate directory would need to be prepared in advance just as for a regular instance of squid running ssl_crtd.

I initially investigated the problem and helped improve the database file locking problem by changing the locking protocol from lockf() to flock(). I haven&#8217;t seen the problem occur on FreeBSD since the flock() changes went in. However, when I last looked at the code, some operating systems were still configured to use lockf() locking which does not function as needed due to its unintuitive POSIX / X/Open semantics: the first close() on the locked file (even via a different file descriptor) releases the lock. MacOS&#8217;s man page notes &quot;File locks are released on first close by the locking process of any file descriptor for the file&#8221;.  There are situations in the ssl_crtd code where the database file is open using multiple file descriptors simultaneously, and close() calls occur that would cause read/write hazards due to loss of the lockf() lock.

My $0.02,
Guy


&gt;<i> On Mar 4, 2017, at 11:36 AM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hey Alex,
</I>&gt;<i> 
</I>&gt;<i> I still believe that an upgrade will improve since it's hard for me to imagine that only two admins are having trouble with it.
</I>&gt;<i> What will scare me is that If indeed many admins are having such issues and they do not ask or report about these.
</I>&gt;<i> I hope that with this thread we will be one step smarter and one step closer to a satisfying solution rather then the currently used options.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>] 
</I>&gt;<i> Sent: Friday, March 3, 2017 5:56 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers are crashing too rapidly, need help!
</I>&gt;<i> 
</I>&gt;<i> On 03/03/2017 06:17 AM, Eliezer Croitoru wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> one of the options is to fence the ssl_crtd with some kind of lock
</I>&gt;&gt;<i> mechanism for the DB rebuild time.
</I>&gt;<i> 
</I>&gt;<i> ssl_crtd already has a lock mechanism. If that mechanism is buggy, it
</I>&gt;<i> needs to be fixed, but it does not make sense to add another one.
</I>&gt;<i> 
</I>&gt;<i> There is still a lot of room for improvements, of course. For example,
</I>&gt;<i> compared to a log-monitoring watchdog mentioned by Yuri:
</I>&gt;<i> 
</I>&gt;<i> * Teaching ssl_crtd to run a sysadmin-provided script on database
</I>&gt;<i> failures will allow the sysadmin to handle such failures almost
</I>&gt;<i> transparently to the users and may reduce configuration headaches
</I>&gt;<i> associated with ssl_crtd message text changes.
</I>&gt;<i> 
</I>&gt;<i> * Teaching Squid to run a sysadmin-provided script on helper crashes
</I>&gt;<i> will allow the sysadmin to handle such failures more transparently to
</I>&gt;<i> the users and may reduce configuration headaches associated with helper
</I>&gt;<i> message text changes.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: stress-sslcrtd.perl
Type: application/octet-stream
Size: 3288 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170306/9560821f/attachment.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170306/9560821f/attachment.obj</A>&gt;
-------------- next part --------------


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014590.html">[squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!
</A></li>
	<LI>Next message (by thread): <A HREF="014685.html">[squid-users] squid 3.5.2==&gt; HTTPS FATAL: The ssl_crtd helpers	are crashing too rapidly, need help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14597">[ date ]</a>
              <a href="thread.html#14597">[ thread ]</a>
              <a href="subject.html#14597">[ subject ]</a>
              <a href="author.html#14597">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
