<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ssl bump tunneling connection by using Common Name
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl%20bump%20tunneling%20connection%20by%20using%20Common%20Name&In-Reply-To=%3C002301d29698%247149c0e0%2453dd42a0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014598.html">
   <LINK REL="Next"  HREF="014613.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ssl bump tunneling connection by using Common Name</H1>
    <B>Eliezer  Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ssl%20bump%20tunneling%20connection%20by%20using%20Common%20Name&In-Reply-To=%3C002301d29698%247149c0e0%2453dd42a0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Ssl bump tunneling connection by using Common Name">eliezer at ngtech.co.il
       </A><BR>
    <I>Mon Mar  6 16:41:02 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014598.html">[squid-users] Ssl bump tunneling connection by using Common Name
</A></li>
        <LI>Next message (by thread): <A HREF="014613.html">[squid-users] Ssl bump tunneling connection by using Common Name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14599">[ date ]</a>
              <a href="thread.html#14599">[ thread ]</a>
              <a href="subject.html#14599">[ subject ]</a>
              <a href="author.html#14599">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

There was something about it but I believe it's only on squid version 4.0.X.
The other options for such a thing is to use an external_acl helper that will try to initiate a connection to the destination host (like what is done in the happy eyeballs) to and to inspect the certificate to match a specific criteria.
I was working on such a helper a year ago but stopped touch it since there was something I didn't expected.
I can try to dig in my repository and see if I find the helper.

Let me know if to bother with it.

Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Hanoch Hanoch K
Sent: Monday, March 6, 2017 3:47 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] Ssl bump tunneling connection by using Common Name

Greetings

We're using Squid 3.5.19 with ssl bump,
and we want to tunnel (not bump) applications such as skype, that use pinned ssl,
so we defined an acl for splicing skype's ssl_server_name.

However skype's client app uses client certificates that don't have SNI.
The only way to identify skype is its Common Name: *.<A HREF="http://dc.trouter.io/">http://dc.trouter.io/</A>

But the Common Name is available only in step3 of ssl bump,
where tunneling the connection is no longer possible (as documented in peek and splice step3 docs).
What we get is bumping.

Is there a way we can tunnel an acl based on Common Name?

ty


http_port 3127
http_port 3128 intercept
https_port 3129 ssl-bump intercept generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
always_direct allow all
acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex -i (microsoft|msn|windows|update|<A HREF="http://skype.com/|http://go.trouter.io/|http://secure.adnxs.compipe.skype.com/|http://skype-m.hotmail.com/|http://mobile.pipe.aria.microsoft.com/|http://edge.skype.com/|http://api.cc.skype.com/|http://a.config.skype.com/|http://clientlogin.cdn.skype.com/|.http://dc.trouter.io/|http://ui.skype.com/|http://apps.skype.com/|http://registrar-rr.prod.registrar.skype.com/|http://secure.skypeassets.com/|http://c1.skype.com/">http://skype.com/|http://go.trouter.io/|http://secure.adnxs.compipe.skype.com/|http://skype-m.hotmail.com/|http://mobile.pipe.aria.microsoft.com/|http://edge.skype.com/|http://api.cc.skype.com/|http://a.config.skype.com/|http://clientlogin.cdn.skype.com/|.http://dc.trouter.io/|http://ui.skype.com/|http://apps.skype.com/|http://registrar-rr.prod.registrar.skype.com/|http://secure.skypeassets.com/|http://c1.skype.com/</A>)
ssl_bump splice NoSSLIntercept
ssl_bump peek DiscoverSNIHost
ssl_bump bump all

sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER
sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
sslcrtd_children 5



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014598.html">[squid-users] Ssl bump tunneling connection by using Common Name
</A></li>
	<LI>Next message (by thread): <A HREF="014613.html">[squid-users] Ssl bump tunneling connection by using Common Name
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14599">[ date ]</a>
              <a href="thread.html#14599">[ thread ]</a>
              <a href="subject.html#14599">[ subject ]</a>
              <a href="author.html#14599">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
