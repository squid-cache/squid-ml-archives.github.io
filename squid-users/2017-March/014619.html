<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ext_wbinfo_group_acl is not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ext_wbinfo_group_acl%20is%20not%20working&In-Reply-To=%3C4ef48a6a-df57-09b9-2a84-39c7b9ee6c0c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014602.html">
   <LINK REL="Next"  HREF="014768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ext_wbinfo_group_acl is not working</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ext_wbinfo_group_acl%20is%20not%20working&In-Reply-To=%3C4ef48a6a-df57-09b9-2a84-39c7b9ee6c0c%40treenet.co.nz%3E"
       TITLE="[squid-users] ext_wbinfo_group_acl is not working">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Mar  9 14:46:00 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014602.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
        <LI>Next message (by thread): <A HREF="014768.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14619">[ date ]</a>
              <a href="thread.html#14619">[ thread ]</a>
              <a href="subject.html#14619">[ subject ]</a>
              <a href="author.html#14619">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/03/2017 2:35 a.m., Ver&#243;nica Ovando wrote:
&gt;<i> Hi, everybody!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have my Squid 3.4.8 running in Debian Jessie. It has been working with Active Directory authentication for more than a year without any kind of problem. But since a couple of weeks ago, suddenly, it stopped authenticate users, asking for credentials (username and pass) and they are not able to browse. I am getting this messages in /var/log/cache.log:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2017/03/04 12:04:25.806 kid1| WARNING: external ACL 'Grupos_AD' queue overload. Request rejected 'user1 it_group'.
</I>&gt;<i> 
</I>
This means that your AD is not keeping up with the traffic through your
proxy.
Since your Squid has children=100 it will queue up to 200 transactions
waiting for the helper before this message is shown.


Dis cache.log have anything else from the external helper? you have
debug mode enabled (-d) so it should be reporting if there are any
issues with AD other than simply slowness.


&gt;<i> 
</I>&gt;<i> After some research I found this thread <A HREF="http://www.squid-cache.org/mail-archive/squid-users/200902/0386.html">http://www.squid-cache.org/mail-archive/squid-users/200902/0386.html</A> and followed the suggestions posted by Amos. But nothing happened.
</I>&gt;<i> 
</I>&gt;<i> I tried rejoining the server to domain. Everything was fine in that way: wbinfo -u, wbinfo -g and wbinfo -P correctly returns all the users, groups and information of the domain.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> After restart Squid service, I noticed that neither helper ext_wbinfo_group_acl nor pinger are started:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 12:04:01 [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A> ]# systemctl status squid3.service -l
</I>
NOTE: do not trust systemd information about Squid-3. The two are not
compatible and systemd often says incorrect things because it makes
incorrect assumptions about the squid process(es). Especially if there
has been a process crash and auto-restart at any point during Squid
operation.


&gt;<i> &#9679; squid3.service - LSB: Squid HTTP Proxy version 3.x
</I>&gt;<i>    Loaded: loaded (/etc/init.d/squid3)
</I>&gt;<i>    Active: active (running) since s&#225;b 2017-03-04 12:04:01 ART; 3s ago
</I>&gt;<i>   Process: 4537 ExecStop=/etc/init.d/squid3 stop (code=exited, status=0/SUCCESS)
</I>&gt;<i>   Process: 4560 ExecStart=/etc/init.d/squid3 start (code=exited, status=0/SUCCESS)
</I>&gt;<i>    CGroup: /system.slice/squid3.service
</I>&gt;<i>            &#9500;&#9472;4593 /usr/sbin/squid3 -YC -f /etc/squid3/squid.conf
</I>&gt;<i>            &#9500;&#9472;4595 (squid-1) -YC -f /etc/squid3/squid.conf
</I>&gt;<i>            &#9492;&#9472;4596 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i> mar 04 12:04:01 server.mydomain.com squid3[4560]: Starting Squid HTTP Proxy 3.x: squid3
</I>&gt;<i> 2017/03/04 12:04:01| WARNING: external_acl_type option children=N has been deprecated in favor of children-max=N and children-startup=N
</I>
Please note the warning and update your config file.

&gt;<i> mar 04 12:04:01 server.mydomain.com squid3[4593]: Squid Parent: will start 1 kids
</I>&gt;<i> mar 04 12:04:01 server.mydomain.com squid3[4593]: Squid Parent: (squid-1) process 4595 started
</I>&gt;<i> mar 04 12:04:01 server.mydomain.com squid3[4560]: .
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 12:04:30 [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A> ]# ps fax | grep ext_wbinfo_group_acl
</I>&gt;<i>  1418 pts/0    S+     0:00              \_ grep ext_wbinfo_group_acl
</I>&gt;<i> 
</I>&gt;<i> If I run echo &quot;mydomain\user1 it_group&quot; | /usr/lib/squid3/ext_wbinfo_group_acl -d, it returns
</I>&gt;<i> 
</I>&gt;<i> Debugging mode ON.
</I>&gt;<i> Got mydomain\user1 it_group from squid
</I>&gt;<i> User:  -mydomain\user1-
</I>&gt;<i> Group: -it_group-
</I>&gt;<i> SID:   -S-1-5-21-2290000000-711000000-3300000000-3949-
</I>&gt;<i> GID:   -10006-
</I>&gt;<i> Sending OK to squid
</I>&gt;<i> OK
</I>&gt;<i> 
</I>&gt;<i> What it's a good, because that user belongs to that group. If I change the group name, it returns an ERR.
</I>&gt;<i> 
</I>&gt;<i> Here is my squid.conf:
</I>&gt;<i> 
</I>&gt;<i> #===========================================================================
</I>&gt;<i> http_port 3128
</I>&gt;<i> visible_hostname proxy.squid
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">server at proxy.com</A>
</I>&gt;<i> cache_effective_user proxy
</I>&gt;<i> error_directory /usr/share/squid3/errors/es
</I>&gt;<i> err_page_stylesheet /etc/squid3/estilo.css
</I>&gt;<i> 
</I>&gt;<i> ####################################################
</I>&gt;<i> #******************************Ports*************************************#
</I>&gt;<i> ####################################################
</I>&gt;<i> 
</I>&gt;<i> #acl manager proto cache_object
</I>&gt;<i> #acl all src 0.0.0.0/0.0.0.0
</I>&gt;<i> #acl localhost src 127.0.0.1/32
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl Safe_ports port 70 #prot gopher
</I>&gt;<i> acl Safe_ports port 210 #whais
</I>&gt;<i> acl Safe_ports port 280 #http-mgmt
</I>&gt;<i> acl Safe_ports port 488 #gss-http
</I>&gt;<i> acl Safe_ports port 591 #filemaker
</I>&gt;<i> acl Safe_ports port 8080
</I>&gt;<i> acl Safe_ports port 2481
</I>&gt;<i> acl Safe_ports port 20010
</I>&gt;<i> acl Safe_ports port 777 #multi http
</I>&gt;<i> #acl purge method PURGE
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl_uses_indirect_client on
</I>&gt;<i> delay_pool_uses_indirect_client on
</I>&gt;<i> log_uses_indirect_client on
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ##############################################################
</I>&gt;<i> #*******************Active Directory HELPERS**************************#
</I>&gt;<i> ##############################################################
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i> auth_param ntlm children 100
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 100
</I>&gt;<i> auth_param basic realm Servidor proxy-cache
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #######################################################################
</I>&gt;<i> #****************************ACL******************************************#
</I>&gt;<i> ###########################################################################
</I>&gt;<i> 
</I>&gt;<i> #---------------------------ACL Active Directory------------------------#
</I>&gt;<i> external_acl_type Grupos_AD ttl=10 negative_ttl=10 children=100 %LOGIN /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i> acl it_group external Grupos_AD it_group
</I>&gt;<i> 
</I>&gt;<i> ------------------Acceso s&#243;lo a usuarios autenticados--------------------#
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> 
</I>&gt;<i> #-----------------------------Grupo *it_group*----------------------------#
</I>&gt;<i> http_access allow it_group allow
</I>
What is this extra &quot;allow&quot; on the end of the line for?

I dont see any ACL named &quot;allow&quot; in the above config. So that may be
preventing Squid from restarting, which would confuse systemd.


&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> #http_access allow purge localhost
</I>&gt;<i> #http_access deny purge
</I>
Please move the below two lines up to be the very first http_access
lines in your config. Part of their purpose is to protect against some
DoS conditions which can cause exactly this type of overload on headers.

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_PORTS
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> dead_peer_timeout 20 seconds
</I>&gt;<i> strip_query_terms on
</I>&gt;<i> debug_options ALL,1 33,2 28,9
</I>&gt;<i> coredump_dir /var/spool/squid3
</I>&gt;<i> ftp_passive on
</I>&gt;<i> ftp_sanitycheck off
</I>&gt;<i> ftp_telnet_protocol off
</I>&gt;<i> read_ahead_gap 1 MB
</I>&gt;<i> positive_dns_ttl 6 hours
</I>&gt;<i> forward_max_tries 25
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ############################################################################
</I>&gt;<i> #*************************Log********************************#
</I>&gt;<i> ############################################################################
</I>&gt;<i> 
</I>&gt;<i> logformat squid %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt
</I>&gt;<i> cache_access_log /var/log/squid3/access.log
</I>&gt;<i> cache_log /var/log/squid3/cache.log
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i> 
</I>&gt;<i> ############################################################################
</I>&gt;<i> #******************Cache and memory***************************#
</I>&gt;<i> ############################################################################
</I>&gt;<i> 
</I>&gt;<i> cache_mem 1024 MB
</I>&gt;<i> maximum_object_size_in_memory 1024 KB
</I>&gt;<i> memory_cache_mode always
</I>&gt;<i> cache_dir aufs /var/spool/squid3 15000 16 256
</I>&gt;<i> maximum_object_size 96 MB
</I>&gt;<i> minimum_object_size 10 KB
</I>&gt;<i> #cache_replacement_policy heap LFUDA
</I>&gt;<i> cache_replacement_policy heap GDSF
</I>&gt;<i> memory_replacement_policy heap GDSF
</I>&gt;<i> #memory_replacement_policy lru
</I>&gt;<i> cache_store_log none
</I>&gt;<i> #log_fqdn off
</I>&gt;<i> log_icp_queries off
</I>&gt;<i> buffered_logs off
</I>&gt;<i> #emulate_httpd_log off
</I>&gt;<i> redirect_rewrites_host_header off
</I>&gt;<i> cache_swap_low 80
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> #===========================================================================
</I>&gt;<i> 
</I>&gt;<i> It is really weird, I really don't know how to solve this. I hope my explanation was clear.
</I>&gt;<i> 
</I>&gt;<i> For testing purposes, I have another Squid working with the same AD server, and it is going fine: the helper and pinger are executed as you can see here:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at debian-test-server</A>:/etc/squid3# systemctl status squid3.service
</I>&gt;<i> &#9679; squid3.service - LSB: Squid HTTP Proxy version 3.x
</I>&gt;<i>    Loaded: loaded (/etc/init.d/squid3)
</I>&gt;<i>    Active: active (running) since lun 2017-02-13 07:35:01 ART; 2 weeks 5 days ago
</I>&gt;<i>   Process: 570 ExecStart=/etc/init.d/squid3 start (code=exited, status=0/SUCCESS)
</I>&gt;<i>    CGroup: /system.slice/squid3.service
</I>&gt;<i>            &#9500;&#9472; 1017 /usr/sbin/squid3 -YC -f /etc/squid3/squid.conf
</I>&gt;<i>            &#9500;&#9472; 1020 (squid-1) -YC -f /etc/squid3/squid.conf
</I>&gt;<i>            &#9500;&#9472; 1945 /usr/bin/perl -w /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i>            &#9500;&#9472; 1968 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1969 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1970 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1971 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1972 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1973 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1974 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472; 1993 /usr/bin/perl -w /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i>            &#9500;&#9472; 2029 /usr/bin/perl -w /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i>            &#9500;&#9472;63477 (pinger)
</I>&gt;<i>            &#9500;&#9472;63478 (ntlm_auth) --helper-protocol=squid-2.5-ntlmssp --DOMAIN=MYDOMAIN
</I>&gt;<i>            &#9500;&#9472;63479 (ntlm_auth) --helper-protocol=squid-2.5-basic
</I>&gt;<i>            &#9492;&#9472;63480 /usr/bin/perl -w /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i> 
</I>
As configured your Squid should be starting exactly 100 of each - no
more, no less. I suspect from both these traces that you dont actually
need 100 of each helper running, or systemd is confused already.

The current Squid versions can auto-start helpers as needed. See the
auth_param and external_acl_type documentation for the max=, startup=
and idle= options. That may help a little, or at least allow you to
configure higher max limits to cope with slow AD periods.



Another possibility is converting to the LDAP group lookup instead of
using the wbinfo tool to do lookups. I know that LDAP does not suffer
from wbind connection limits, which might be part of your issue.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014602.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
	<LI>Next message (by thread): <A HREF="014768.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14619">[ date ]</a>
              <a href="thread.html#14619">[ thread ]</a>
              <a href="subject.html#14619">[ subject ]</a>
              <a href="author.html#14619">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
