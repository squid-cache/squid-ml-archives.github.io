<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] kerb auth groups KV note acl config
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerb%20auth%20groups%20KV%20note%20acl%20config&In-Reply-To=%3C2197768425D7F5479A0FFB3FEC212F7FF5D9FA95%40aesmail.surcouf.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014722.html">
   <LINK REL="Next"  HREF="014726.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] kerb auth groups KV note acl config</H1>
    <B>Mike Surcouf</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20kerb%20auth%20groups%20KV%20note%20acl%20config&In-Reply-To=%3C2197768425D7F5479A0FFB3FEC212F7FF5D9FA95%40aesmail.surcouf.local%3E"
       TITLE="[squid-users] kerb auth groups KV note acl config">mikes at surcouf.co.uk
       </A><BR>
    <I>Thu Mar 16 10:12:42 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014722.html">[squid-users] kerb auth groups KV note acl config
</A></li>
        <LI>Next message (by thread): <A HREF="014726.html">[squid-users] kerb auth groups KV note acl config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14724">[ date ]</a>
              <a href="thread.html#14724">[ thread ]</a>
              <a href="subject.html#14724">[ subject ]</a>
              <a href="author.html#14724">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>@Amos

Thanks for this

so to recap if I currently have

auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth
auth_param negotiate children 20
auth_param negotiate keep_alive on

external_acl_type InternetAccessBanking %LOGIN /usr/lib64/squid/ext_kerberos_ldap_group_acl -u <A HREF="ldaps://aesdc02.surcouf.local:636">ldaps://aesdc02.surcouf.local:636</A> -b cn=SSSUsers,dc=surcouf,dc=local  -g InternetAccessBanking

I could replace it by

auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth
auth_param negotiate children 20
auth_param negotiate keep_alive

acl InternetAccessBanking note group S-1-5-21-123456789-123456789-123456789-1234


Note where S-1-5-21-123456789-123456789-123456789-1234 is the SID for the group InternetAccessBanking


-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: 16 March 2017 09:24
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] kerb auth groups KV note acl config

On 15/03/2017 10:18 p.m., Mike Surcouf wrote:
&gt;<i> This is bulleted as a new feature for v4.
</I>&gt;<i> Yet there is no way to test this without a quick reply letting me know the basic usage.
</I>&gt;<i> Anyone  got a snippet on how this is setup 
</I>&gt;<i> 
</I>
[ For TL;DR skip to the end of this mail. All this is first block is
just describing how it works. ]


This should be doable with Squid-3.4+ or at least 3.5. It requires only
the note ACL in squid plus a helper that sends group= response annotations.

It is marked as v4 becasue that is where the first helper with such
support is bundled. You can run that helper with older Squid, for
example by downloading Markus lastest release and building your own helper.


An auth helper which supports it does not needs anything configured by
you. It will &quot;just work&quot; (or not if it lacks annotation support). That
part is just a matter of finding out / ensuring your auth helper
provides the group kv-pairs. The usual command-line tests can probably
show that.

The auth helper by Markus should be producing a set of group=X
annotations automatically, one for each group the user is a member of.
Where the X is what AD calls a &quot;SID&quot; value representing a unique ID for
each group.


After those are received by Squid the note ACL type can be used in
squid.conf to match any of them quickly without an external helper
lookup for the group details. That enables reliable group ACLs anywhere
in squid.conf where they were previously at the mercy of external helper
result timeouts.


In absence of that input from the auth helper, an external_acl_type
helper or *any* helper really :-) can also send the same annotations to
Squid - with the same note ACL config later.

In its current form this is obviously most useful if you know the SID
that group names map to and can configure the note ACL appropriately. I
am hopeful that other helpers may be able to produce named groups or
such. But the values are likely to be specific to whatever the auth
system can provide.


For group lookup and comparison by name (the 'old' way) you can still
use an external helper. As I understand it AD requires two lookups; one
to find the users SID memberships and one to find the group name-&gt;SID
mapping for the group(s) being checked - then compare. The first is not
needed if the SID (%note{group}) is passed to the helper instead of
username (%LOGIN).
 This part does require v4, and has not been much tested to see where
the %note format code works for external_acl_type helpers (and where
not). YMMV.

IIRC Markus was waiting on support for %note{group} format code on
external_acl_type config lines. But that happened a long while back now.



&gt;<i> -----Original Message-----
</I>&gt;<i> From: Mike Surcouf
</I>&gt;<i> 
</I>&gt;<i> Outputting the groups as KV pairs in AD environments  on auth seems like a great performance enhancement and will allow me to ditch my ldap lookups.
</I>&gt;<i> Is there any docs on how to set this up?
</I>&gt;<i> Even looking at the source I can't seem to work it out.
</I>&gt;<i> I would like to test and potentially contribute to the DOCS although I am only a git user and bazaar would be new to me so I may just post my experience in this thread.
</I>&gt;<i> 
</I>&gt;<i> From what I can see I need to setup a note acl but I am unsure of the key names etc.
</I>
Correct. The key name is &quot;group&quot; ;-)


&gt;<i> 
</I>&gt;<i> A short example would be great.
</I>&gt;<i> 
</I>
As far as I am aware it should look like this:

  acl blah note group SID-12345-762576257263
  request_max_size 1 MB blah

Maybe also the -m flag on the ACL definition if recent changes merged
the group notes into a list.

HTH
Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014722.html">[squid-users] kerb auth groups KV note acl config
</A></li>
	<LI>Next message (by thread): <A HREF="014726.html">[squid-users] kerb auth groups KV note acl config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14724">[ date ]</a>
              <a href="thread.html#14724">[ thread ]</a>
              <a href="subject.html#14724">[ subject ]</a>
              <a href="author.html#14724">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
