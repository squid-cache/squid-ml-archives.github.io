<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Transparent/intercept Issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Transparent/intercept%20Issues&In-Reply-To=%3C201703211212.01346.Antony.Stone%40squid.open.source.it%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014766.html">
   <LINK REL="Next"  HREF="014795.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Transparent/intercept Issues</H1>
    <B>Antony Stone</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Transparent/intercept%20Issues&In-Reply-To=%3C201703211212.01346.Antony.Stone%40squid.open.source.it%3E"
       TITLE="[squid-users] Squid Transparent/intercept Issues">Antony.Stone at squid.open.source.it
       </A><BR>
    <I>Tue Mar 21 11:12:01 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014766.html">[squid-users] Squid Transparent/intercept Issues
</A></li>
        <LI>Next message (by thread): <A HREF="014795.html">[squid-users] Squid Transparent/intercept Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14767">[ date ]</a>
              <a href="thread.html#14767">[ thread ]</a>
              <a href="subject.html#14767">[ subject ]</a>
              <a href="author.html#14767">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tuesday 21 March 2017 at 12:00:05, christian brendan wrote:

&gt;<i> &gt; Today's Topics:
</I>&gt;<i> &gt;    1. Re: Squid Transparent/intercept Issues (Antony Stone)
</I>&gt;<i> &gt;    2. Re: SMP and AUFS (Matus UHLAR - fantomas)
</I>&gt;<i> &gt;    3. Re: SMP and AUFS (Alex Rousskov)
</I>&gt;<i> &gt;    4. Re: squid workers question (Alex Rousskov)
</I>&gt;<i> &gt;    5. Re: squid workers question (Matus UHLAR - fantomas)
</I>&gt;<i> &gt;    6. Re: SSL Bump issues (Alex Rousskov)
</I>&gt;<i> &gt;    7. blocking or allowing specific youtube videos (Sohan Wijetunga)
</I>
Please edit your reply when responding to a digest email, deleting everything 
not specific to your question.

&gt;<i> &gt; Date: Mon, 20 Mar 2017 16:56:17 +0100
</I>&gt;<i> &gt; From: Antony Stone
</I>&gt;<i> &gt; To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; Subject: Re: [squid-users] Squid Transparent/intercept Issues
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Monday 20 March 2017 at 16:26:40, christian brendan wrote:
</I>&gt;<i> &gt; &gt; Hello Everyone,
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Squid Cache: Version 3.5.20
</I>&gt;<i> &gt; &gt; OS: CentOS 7
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; I have used squid for quite some times non transparently and it works,
</I>&gt;<i> &gt; &gt; problem kicks in when: http_port 3128 transparent is enabled.
</I>&gt;<i> &gt; &gt; Access denied error page shows up when transparent is enabled
</I>&gt;<i> &gt; &gt; ERRORThe requested URL could not be retrieved
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; How are you getting the packets to the Squid server for interception?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Is the Squid server in the default route between your clients and the
</I>&gt;<i> &gt; Internet, or are you redirecting the packets to the Squid server somehow?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Please give *details* of how you are intercepting and sending the packets
</I>&gt;<i> &gt; to Squid (eg: iptables rules, and which machine/s the rules are running
</I>&gt;<i> &gt; on).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Antony.
</I>
&gt;<i> &#8203;@Antony.Stone
</I>&gt;<i> 1. &#8203;I am using mikrotik routerboard to redirect traffic, with this rule:
</I>&gt;<i> dd action=dst-nat chain=dstnat comment=&quot;Redirect port 80 to SquidProxy&quot;
</I>&gt;<i> dst-port=80 protocol=tcp \ src-address=10.24.7.100 to-addresses=10.24.7.101
</I>&gt;<i> to-ports=3128
</I>
Okay, so there's your problem, then.

You must not use DSTNAT on a separate router to send packets to Squid for 
intercept.

(This used to work in older versions of Squid, but does not work any more and 
is documented on the wiki, for example at
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A> )

Note the wording: &quot;NOTE: This configuration is given for use on the squid box.&quot;  
That means the NAT rules *must* be running on the Squid box itself and not (in 
your case) on the Mikrotik router.

&gt;<i> 3.&#8203; It is not in default route, packets is been redirected.
</I>
In that case you need to use policy routing to get the packets *unchanged* to 
the Squid box - see the above link, and also
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A>

&gt;<i> &#8203;4. There is no iptable rules, firewall is disabled for this test.
</I>
You have to have a REDIRECT rule on the machine running Squid to get it to see 
the packets (once they are no longer being DNATted).

Please try to follow the guidelines at
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A> and 
<A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A> and 
then come back to us with details of what you've tried, if there are still 
problems.


Regards,


Antony.

-- 
A user interface is like a joke.
If you have to explain it, it didn't work.

                                                   Please reply to the list;
                                                         please *don't* CC me.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014766.html">[squid-users] Squid Transparent/intercept Issues
</A></li>
	<LI>Next message (by thread): <A HREF="014795.html">[squid-users] Squid Transparent/intercept Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14767">[ date ]</a>
              <a href="thread.html#14767">[ thread ]</a>
              <a href="subject.html#14767">[ subject ]</a>
              <a href="author.html#14767">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
