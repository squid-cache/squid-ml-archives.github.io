<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Assistance with WCCPv2 Setup with Cisco Router
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Assistance%20with%20WCCPv2%20Setup%20with%20Cisco%20Router&In-Reply-To=%3CYTOPR01MB04766B2AE6D78BBE5022DD0CDF3D0%40YTOPR01MB0476.CANPRD01.PROD.OUTLOOK.COM%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014777.html">
   <LINK REL="Next"  HREF="014780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Assistance with WCCPv2 Setup with Cisco Router</H1>
    <B>Waldon, Cooper</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Assistance%20with%20WCCPv2%20Setup%20with%20Cisco%20Router&In-Reply-To=%3CYTOPR01MB04766B2AE6D78BBE5022DD0CDF3D0%40YTOPR01MB0476.CANPRD01.PROD.OUTLOOK.COM%3E"
       TITLE="[squid-users] Assistance with WCCPv2 Setup with Cisco Router">cwaldon at otn.ca
       </A><BR>
    <I>Tue Mar 21 19:04:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014777.html">[squid-users] squid-users Digest, Vol 31, Issue 61
</A></li>
        <LI>Next message (by thread): <A HREF="014780.html">[squid-users] Assistance with WCCPv2 Setup with Cisco Router
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14779">[ date ]</a>
              <a href="thread.html#14779">[ thread ]</a>
              <a href="subject.html#14779">[ subject ]</a>
              <a href="author.html#14779">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello All,

I'm trying to set up a transparent proxy for http and https using Cisco Routers and Squid.  I have followed the configuration examples that are listed under the wccp2 overview section (<A HREF="http://wiki.squid-cache.org/Features/Wccp2">http://wiki.squid-cache.org/Features/Wccp2</A>) of the squid wiki but I'm still having some issues.

I have a little lab set up with a Cisco 7200 Router and a VM with CentOS running the proxy.

The &quot;WAN&quot; IP of the Router is 192.168.0.23.  The IP of the Squid Proxy is 192.168.0.24 and both have the default gateway of 192.168.0.1 which is the &quot;ISP&quot;

The Client is sitting on a LAN behind the Router in the 10.10.10.0/24 subnet and is also sitting behind nat.

I believe that the router and proxy are communicating properly based on the information in the show ip wccp command on the router as it shows clients and routers as well as showing that packets are being forwarded:

R3#show ip wccp
Global WCCP information:
    Router information:
        Router Identifier:                   192.168.0.23
        Configured source-interface:         GigabitEthernet5/0

    Service Identifier: web-cache
        Protocol Version:                    2.00
        Number of Service Group Clients:     1
        Number of Service Group Routers:     1
        Total Packets Redirected:            1079
          Process:                           0
          CEF:                               1079
        Service mode:                        Open
        Service Access-list:                 -none-
        Total Packets Dropped Closed:        0
        Redirect access-list:                100
        Total Packets Denied Redirect:       0
        Total Packets Unassigned:            0
        Group access-list:                   10
        Total Messages Denied to Group:      0
        Total Authentication failures:       0
        Total GRE Bypassed Packets Received: 0
          Process:                           0
          CEF:                               0
       GRE tunnel interface:                Tunnel1

    Service Identifier: 70
        Protocol Version:                    2.00
        Number of Service Group Clients:     1
        Number of Service Group Routers:     1
        Total Packets Redirected:            500
          Process:                           0
          CEF:                               500
        Service mode:                        Open
        Service Access-list:                 -none-
        Total Packets Dropped Closed:        0
        Redirect access-list:                100
        Total Packets Denied Redirect:       0
        Total Packets Unassigned:            0
        Group access-list:                   10
        Total Messages Denied to Group:      0
        Total Authentication failures:       0
        Total GRE Bypassed Packets Received: 0
          Process:                           0
          CEF:                               0
        GRE tunnel interface:                Tunnel0

Here is the relevant squid wccp configuration:

----Output removed----
# Squid normally listens to port 3128
http_port 3128
http_port 0.0.0.0:3129

# WCCPv2 Parameters
wccp2_router 192.168.0.23
wccp2_forwarding_method 1
wccp2_return_method 1
wccp2_assignment_method hash
wccp2_service standard 0
wccp2_service dynamic 70
wccp2_service_info 70 protocol=tcp flags=dst_ip_hash,src_ip_alt_hash,src_port_alt_hash priority=231 ports=443

---Output remove----

I think that the issue lies with the iptables configuration as I do not see any packets been processed in the nat table.  I have tried a few different methods such as:

iptables -t nat -A PREROUTING -i wccp0 -p tcp -dport 80 -j REDIRECT -to-port 3129
iptables -t nat -A PREROUTING -i wccp0 -p tcp -dport 443 -j REDIRECT -to-port 3129
iptables -t nat -A POSTROUTING -j MASQUERADE

or

iptables -t nat -A PREROUTING -p tcp -dport 80 -j DNAT -to-destination 192.168.0.24:3129
iptables -t nat -A PREROUTING -p tcp -dport 443 -j DNAT -to-destination 192.168.0.24:3129
iptables -t nat -A POSTROUTING -j MASQUERADE

I have also tried adding ACCEPT commands to the PREROUTING zone just in case the proxy is dropping the packets right away but that also doesn't work.

The proxy functions perfectly when the client is configured to use a proxy so there doesn't appear to be any issues with routing or anything like that, it's just the transparent proxying that isn't working.

If anyone has any suggestions of what I could try that would be greatly appreciated.  Let me know if anything is unclear or if you need further clarification.

Thank you,
Cooper Waldon


Cooper Waldon l Network Engineer l OTN l 416-446-4110 x 4473 l www.otn.ca&lt;<A HREF="http://www.otn.ca/">http://www.otn.ca/</A>&gt; | Service Desk 1-855-654-0888 x2

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170321/d8f6bbb7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170321/d8f6bbb7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014777.html">[squid-users] squid-users Digest, Vol 31, Issue 61
</A></li>
	<LI>Next message (by thread): <A HREF="014780.html">[squid-users] Assistance with WCCPv2 Setup with Cisco Router
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14779">[ date ]</a>
              <a href="thread.html#14779">[ thread ]</a>
              <a href="subject.html#14779">[ subject ]</a>
              <a href="author.html#14779">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
