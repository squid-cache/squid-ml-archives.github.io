<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ext_wbinfo_group_acl is not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ext_wbinfo_group_acl%20is%20not%20working&In-Reply-To=%3C5910078c-9383-6a99-e878-57846bd77b7b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014768.html">
   <LINK REL="Next"  HREF="014648.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ext_wbinfo_group_acl is not working</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ext_wbinfo_group_acl%20is%20not%20working&In-Reply-To=%3C5910078c-9383-6a99-e878-57846bd77b7b%40treenet.co.nz%3E"
       TITLE="[squid-users] ext_wbinfo_group_acl is not working">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar 22 03:23:21 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014768.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
        <LI>Next message (by thread): <A HREF="014648.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14793">[ date ]</a>
              <a href="thread.html#14793">[ thread ]</a>
              <a href="subject.html#14793">[ subject ]</a>
              <a href="author.html#14793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/03/2017 1:04 a.m., Ver&#243;nica Ovando wrote:
&gt;&gt;&gt;<i> Hi, everybody!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have my Squid 3.4.8 running in Debian Jessie. It has been working with Active Directory authentication for more than a year without any kind of problem. But since a couple of weeks ago, suddenly, it stopped authenticate users, asking for credentials (username and pass) and they are not able to browse. I am getting this messages in /var/log/cache.log:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2017/03/04 12:04:25.806 kid1| WARNING: external ACL 'Grupos_AD' queue overload. Request rejected 'user1 it_group'.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This means that your AD is not keeping up with the traffic through your
</I>&gt;&gt;<i> proxy.
</I>&gt;&gt;<i> Since your Squid has children=100 it will queue up to 200 transactions
</I>&gt;&gt;<i> waiting for the helper before this message is shown.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Dis cache.log have anything else from the external helper? you have
</I>&gt;&gt;<i> debug mode enabled (-d) so it should be reporting if there are any
</I>&gt;&gt;<i> issues with AD other than simply slowness.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Yes. I found this:
</I>&gt;<i> 14:53:48 [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at server</A> squid3]# tail -f /var/log/squid3/cache.log | grep helper
</I>&gt;<i> 2017/03/16 14:54:19.527 kid1| Acl.cc(62) AuthenticateAcl: returning 2 sending credentials to helper.
</I>&gt;<i> 2017/03/16 14:54:19.532 kid1| Acl.cc(62) AuthenticateAcl: returning 2 sending credentials to helper.
</I>&gt;<i> 2017/03/16 14:54:20.743 kid1| Acl.cc(62) AuthenticateAcl: returning 2 sending credentials to helper.
</I>&gt;<i> 
</I>&gt;<i> And this:
</I>&gt;<i> 2017/03/16 14:53:47.887 kid1| Acl.cc(118) FindByName: ACL::FindByName 'it_group'
</I>&gt;<i> 2017/03/16 14:53:47.887 kid1| Gadgets.cc(71) aclGetDenyInfoPage: got called for it_group
</I>&gt;<i> 2017/03/16 14:53:48.028 kid1| Acl.cc(157) matches: checking it_group
</I>&gt;<i> 2017/03/16 14:53:48.028 kid1| Acl.cc(177) matches: checked: it_group = -1
</I>&gt;<i> 2017/03/16 14:53:48.028 kid1| Gadgets.cc(103) aclIsProxyAuth: aclIsProxyAuth: called for it_group
</I>&gt;<i> 2017/03/16 14:53:48.028 kid1| Acl.cc(118) FindByName: ACL::FindByName 'it_group'
</I>&gt;<i> 
</I>
Hmm. These lines are still from Squid itself. Note the &quot;kid&quot; portion of
the line entry is only produced by Squid.
I'm not sure about debug on the Samba helper, but debug lines from
helpers will usually show up either no timestamp, maybe with a different
timestamp format, and maybe the helpers binary name where the kid part is.

Anyhow, the above lines seem to indicate the group checking it being
done. Or at least started. Which matches what you said earlier, they are
starting but may be overloading.


&lt;snip&gt;
&gt;&gt;<i>
</I>&gt;&gt;<i> The current Squid versions can auto-start helpers as needed. See the
</I>&gt;&gt;<i> auth_param and external_acl_type documentation for the max=, startup=
</I>&gt;&gt;<i> and idle= options. That may help a little, or at least allow you to
</I>&gt;&gt;<i> configure higher max limits to cope with slow AD periods.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I tried with those params but nothing happens. The helper doesn't  auto-start.
</I>&gt;<i> external_acl_type Grupos_AD ttl=10 children-max=10 children-startup=10 children-idle=10 %LOGIN /usr/lib/squid3/ext_wbinfo_group_acl -d
</I>&gt;<i> 
</I>&gt;<i> And as suggested in the Squid wiki <A HREF="http://www.squid-cache.org/Doc/config/auth_param/,">http://www.squid-cache.org/Doc/config/auth_param/,</A> I used this values for:
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --DOMAIN=RENTAS
</I>&gt;<i> auth_param ntlm children 20 startup=0 idle=1
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 5 startup=5 idle=1
</I>&gt;<i> auth_param basic realm DPR-proxy
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> 
</I>&gt;&gt;<i> Another possibility is converting to the LDAP group lookup instead of
</I>&gt;&gt;<i> using the wbinfo tool to do lookups. I know that LDAP does not suffer
</I>&gt;&gt;<i>from wbind connection limits, which might be part of your issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;<i> Please Amos provide me further guidance. Cannot find a solution to this. Thanks!
</I>
I'm stuck myself now. The info you ave been able to provide does not
seem to contain any useful clues about what the problem might be other
than just the helper queue overloading. It has been a long time since I
went near the Windows stuff so memory has paged out sorry :-(.

Maybe raising the helpers max limit? with these 5 and 10 helper limits I
would expect Squid to only be able to handle 20-150 requests per second.
I usually advice using a limit of ~200 helpers for NTLM related things,
a bit more if you have a busy proxy. The point of the new
max/startup/idle feature is that you can set the startup value low and a
much higher maximum.


One other thing that might help is; with that starup=0 you should not
see any NTLM auth helpers immediately after starting Squid. The first
ntlm_auth helper is only started (from idle=1) when the first HTTP
request that needs credential checking is received. Your checks will
need to take that into consideration.
 (I suspect systemd may not be able to track helpers which are started
after the initial startup process is completed.)

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014768.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
	<LI>Next message (by thread): <A HREF="014648.html">[squid-users] ext_wbinfo_group_acl is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14793">[ date ]</a>
              <a href="thread.html#14793">[ thread ]</a>
              <a href="subject.html#14793">[ subject ]</a>
              <a href="author.html#14793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
