<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache-Peer - Negotiate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache-Peer%20-%20Negotiate&In-Reply-To=%3C93be607c-16b9-2d0f-6844-818bc597610f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014769.html">
   <LINK REL="Next"  HREF="014771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache-Peer - Negotiate</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache-Peer%20-%20Negotiate&In-Reply-To=%3C93be607c-16b9-2d0f-6844-818bc597610f%40treenet.co.nz%3E"
       TITLE="[squid-users] Cache-Peer - Negotiate">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar 22 03:53:28 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="014769.html">[squid-users] Cache-Peer - Negotiate
</A></li>
        <LI>Next message (by thread): <A HREF="014771.html">[squid-users] Load balance on two internet connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14794">[ date ]</a>
              <a href="thread.html#14794">[ thread ]</a>
              <a href="subject.html#14794">[ subject ]</a>
              <a href="author.html#14794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/03/2017 1:26 a.m., Hareesh wrote:
&gt;<i> Hi,
</I>&gt;<i> I am trying to setup Squid as a local HTTP child proxy to a parent/corporate Cisco Ironport WSA proxy. I need help in setting up authentication(Negotiate) to be done automatically from any client who is trying to access internet through the child proxy. So here is what I did.
</I>&gt;<i>    
</I>&gt;<i>    - Installed Squid on Windows machine with the installable given by Diladele v 3.5.24. Configured the service to run with an account (domain\account1) that has admin rights to that machine.   
</I>&gt;<i> 
</I>&gt;<i>    - Got a keytab file for the account and host from our AD Admins. Here is the command run to get the keytab file.   
</I>&gt;<i> 
</I>&gt;<i>             ktpass /princ HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">server1.subdomain.domain.com at SUBDOMAIN.DOMAIN.COM</A>/mapuser domain\account1 /crypto all  /pass &lt;password_for_account1&gt; /ptypeKRB5_NT_PRINCIPAL /out account.keytab
</I>&gt;<i>    
</I>&gt;<i>    - Copied that keytab file into etc\squid folder of my Windows installation of Squid.   
</I>&gt;<i> 
</I>&gt;<i>    -    
</I>&gt;<i> 
</I>&gt;<i>    - Set the following configuration in squid.conf.   
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128cache_peer &lt;parent_proxy_Ip&gt; parent 80 0 no-query default proxy-only login=NEGOTIATE
</I>&gt;<i> http_access allow allnever_direct allow allicp_access deny all
</I>&gt;<i> dns_nameservers &lt;DNS_IP1&gt;  &lt;DNS_IP2&gt; 127.0.0.1
</I>&gt;<i> My objective is **any allowed client** irrespective of Unix/Windows/domain/non-domain users should be able to reach to internet.
</I>
The non-domain users will bite you. Guaranteed. Not being part of the
domain means no credentials, which means no authentication can be performed.

Apart from that either the Negotiate works or it does not. That is
entirely dependent on whether the client has working credentials - which
is outside of Squid control. The particular client OS may reflect
whether that OS has working Kerberos credentials available, but that is
as far as OS comes into the equation.


&gt;<i> I will set up ACL to specify the IP addresses to use this proxy later. But for now, I am getting a 407 error from any machine trying to use this proxy. I am not sure what is going wrong. Please advise.
</I>
407 is entirely expected with secure types of authentication. No sane
client will broacast its credentials aross the network without first
being informed that they are necessary - and what type/scheme they have
to be. That takes the form of a 407 or 401.

What is expected is that the client handles that silently and re-tries
immediately with the required credentials. No further 407 *on that TCP
connection*.

The per-TCP connection detail is important. If you have persistent
connections enabled in the proxy you can expect some 407's then abunch
of authenticated traffic without any.

Browsers can open 8 connections _per tab_ on startup each of which has
to be authenticated separately. Other software usually only 1, but can
open ~4. This can result in a burst of 407's on first contact between
any particualr user and the proxy. It should stabilize quickly though,
and all happen quietly without the user being involved.



&gt;<i> I was looking at this link as well.
</I>&gt;<i> Squid - Users - Parent proxy with authentication
</I>&gt;<i> 
</I>&gt;<i>   
</I>&gt;<i> |  
</I>&gt;<i> |   
</I>&gt;<i> |   
</I>&gt;<i> |   |    |
</I>&gt;<i> 
</I>&gt;<i>    |
</I>&gt;<i> 
</I>&gt;<i>   |
</I>&gt;<i> |  
</I>&gt;<i> |   |  
</I>&gt;<i> Squid - Users - Parent proxy with authentication
</I>&gt;<i>  Parent proxy with authentication. Hello, can someone please tell me, what my my cache_peer line must look like, ...  |   |
</I>&gt;<i> 
</I>&gt;<i>   |
</I>&gt;<i> 
</I>&gt;<i>   |
</I>&gt;<i> 
</I>
I think you have the sequence reversed. It should be:

 user/client -&gt; Squid -&gt; Cisco -&gt; Interwebs


The config line you have:
  cache_peer &lt;parent_proxy_Ip&gt; parent 80 0 no-query default proxy-only
login=NEGOTIATE

... tells Squid to login *as itself* to the upstream proxy.

That is fine if you want the users to login to Squid (or not for the
non-domain ones), and everything going through the upstream proxy to be
authenticated and logged against the Squid account.
 If so, then add the auth_param lines to verify the credentials Squid is
gettign from users.

For passing through the Negotiate credentials client-to-Cisco, you
should use &quot;login=PASSTHRU connection-auth=on&quot;. Squid itself does not
participate in the authentication, so does not need any keytabs etc
setup for those clients.

However, as I mentioned above the non-domain users will bite you. They
dont have credentials so cannot authenticate at all.

With a bit of config trickery, you could use that line with
login=NEGOTIATE to send the Squid proxy account keytab details to get
them through the upstream.

The config trick is how to detect whether the client is off-domain
(dedicated http_port with myportname ACL?) then use cache_peer_access to
split that off-domain traffic through the login=NEGOTIATE peer while
on-domain goes through the login=PASSTHRU peer.

PS. this is just theoretcical config so YMMV.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="014769.html">[squid-users] Cache-Peer - Negotiate
</A></li>
	<LI>Next message (by thread): <A HREF="014771.html">[squid-users] Load balance on two internet connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14794">[ date ]</a>
              <a href="thread.html#14794">[ thread ]</a>
              <a href="subject.html#14794">[ subject ]</a>
              <a href="author.html#14794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
