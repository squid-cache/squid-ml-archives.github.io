<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid proxy without name resolution for internet adresses behind parent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20without%20name%20resolution%20for%20internet%0A%20adresses%20behind%20parent%20proxy&In-Reply-To=%3C90f3e28b-99eb-b6d9-7382-d168f549bce6%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="015154.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid proxy without name resolution for internet adresses behind parent proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20without%20name%20resolution%20for%20internet%0A%20adresses%20behind%20parent%20proxy&In-Reply-To=%3C90f3e28b-99eb-b6d9-7382-d168f549bce6%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid proxy without name resolution for internet adresses behind parent proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May  1 02:44:15 UTC 2017</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="015154.html">[squid-users] Squid proxy without name resolution for internet adresses behind parent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15107">[ date ]</a>
              <a href="thread.html#15107">[ thread ]</a>
              <a href="subject.html#15107">[ subject ]</a>
              <a href="author.html#15107">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/04/17 18:50, Eliezer Croitoru wrote:
&gt;<i> Can you try to add the next to your squid.conf:
</I>&gt;<i> dns_v4_first on
</I>&gt;<i>
</I>&gt;<i> and see if it helps?
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> * <A HREF="http://www.squid-cache.org/Doc/config/dns_v4_first/">http://www.squid-cache.org/Doc/config/dns_v4_first/</A>
</I>
Just to clarify: if that solves your problem then you need to fix IPV6 
handling in your network. Squid-2 is IPv4-only, and a Squid-3 trying to 
connect to it on a properly working IPv6-enabled network should failover 
very fast to the parents IPv4 address(es). Any delay caused by IPv6 in 
that process indicated ICMP/ICMPv6 failures - usually in the path-MTU 
discovery or tunnel MSS settings.


Additional to that test - make sure the child proxy has:

  nonhierarchical_direct off

that will ensure that CONNECT/PUT/POST etc traffic is sent through the 
parent proxy and never tries to resolve.

You can also check that host_verify_strict is *not* in your child 
squid.conf. If that is set to &quot;on&quot; it will force Squid to resolve to do 
the verify checks. Likewise Squid-3 will need to resolve public names if 
it ever receives intercepted traffic, but thankfully your setup seems to 
avoiding that.


Assuming your local servers are using .local as the internal domain. If 
not make this whatever your internal TLD is:

  acl local dstdomain .local
  never_diirect allow !local


The cache_peer name to the parent can be hostname instead of an internal 
IP, but does need to be the internal name in this network. That will 
simplify management and also make the Squid-3 ready to cope with IPv6 
parents when your network migrates for that.

Not having dns_nameservers configured means Squid is using the machines 
system-wide DNS settings. Those do need to be set somehow, since at the 
very least Squid needs to resolve names for the parent proxies and any 
internal traffic that happens to get to it. I would make sure that has 
the internal DNS server details there to handle those lookups traffic.


If the problem remains after all that, tracking down what exactly the 
timeout value is would be helpful. The various things that can hang have 
different timeouts. And worst case a debug log with ALL,6 might be 
needed to find the exact cause of delay, but be aware that could be a 
huge log.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="015154.html">[squid-users] Squid proxy without name resolution for internet adresses behind parent proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15107">[ date ]</a>
              <a href="thread.html#15107">[ thread ]</a>
              <a href="subject.html#15107">[ subject ]</a>
              <a href="author.html#15107">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
