<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Can I use squid to reverse proxy https (without	making it a man-in-the-middle)?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Can%20I%20use%20squid%20to%20reverse%20proxy%20https%20%28without%0A%09making%20it%20a%20man-in-the-middle%29%3F&In-Reply-To=%3CCACc-My3U5MJO%3DUcbTzmCQs%3DwFJKPEYrV0CUzrLRV5-3R2YWqkg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015167.html">
   <LINK REL="Next"  HREF="015169.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Can I use squid to reverse proxy https (without	making it a man-in-the-middle)?</H1>
    <B>Stefan Blachmann</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Can%20I%20use%20squid%20to%20reverse%20proxy%20https%20%28without%0A%09making%20it%20a%20man-in-the-middle%29%3F&In-Reply-To=%3CCACc-My3U5MJO%3DUcbTzmCQs%3DwFJKPEYrV0CUzrLRV5-3R2YWqkg%40mail.gmail.com%3E"
       TITLE="[squid-users] Can I use squid to reverse proxy https (without	making it a man-in-the-middle)?">sblachmann at gmail.com
       </A><BR>
    <I>Mon May  8 04:19:33 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015167.html">[squid-users] Can I use squid to reverse proxy https (without	making it a man-in-the-middle)?
</A></li>
        <LI>Next message (by thread): <A HREF="015169.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15195">[ date ]</a>
              <a href="thread.html#15195">[ thread ]</a>
              <a href="subject.html#15195">[ subject ]</a>
              <a href="author.html#15195">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>With squid, it apparently seems impossible to just pass through SSL
traffic to the HTTPS servers without breaking privacy. The same seems
to be valid for some other &quot;proxies&quot; like nginx when being used as
reverse proxy.

So my solution to the problem was to discard squid and switch to haproxy.

Maybe I am not the only one who wants a proxy which can _actually_ do
SNI, i.e. use the clear-text domain name to just pass through to the
appropriate server, _without_ having to intercept and encrypt the
data.
I think my very simple haproxy.conf is quite self-explanatory, so I
attach it in the following to possibly help others who have similar
needs:

global
  maxconn 2000
  user haproxy
  group haproxy

defaults
  timeout client 30s
  timeout server 30s
  timeout connect 10s

frontend ft_http
  bind 10.0.0.10:80
  mode http
  acl http_sitewithssl_de hdr(host) -i sitewithssl.de
  acl http_sitewithssl_de_www hdr(host) -i www.sitewithssl.de
  acl http_anothersitewithoutssl_de hdr(host) -i anothersitewithoutssl.de
  acl http_anothersitewithoutssl_de_www hdr(host) -i
www.anothersitewithoutssl.de
  use_backend backend_sitewithssl_de_http if http_sitewithssl_de
  use_backend backend_sitewithssl_de_http if http_sitewithssl_de_www
  use_backend backend_anothersitewithoutssl_de_http if
http_anothersitewithoutssl_de
  use_backend backend_anothersitewithoutssl_de_http if
http_anothersitewithoutssl_de_www

frontend ft_https
  bind 10.0.0.10:443
  mode tcp
  acl https_sitewithssl_de req_ssl_sni -i sitewithssl.de
  acl https_sitewithssl_de_www req_ssl_sni -i www.sitewithssl.de
  use_backend backend_sitewithssl_de_https if https_sitewithssl_de
  use_backend backend_sitewithssl_de_https if https_sitewithssl_de_www

backend backend_anothersitewithoutssl_de_http
  mode http
  server server_anothersitewithoutssl_de_http 10.0.0.8:80

backend backend_sitewithssl_de_http
  mode http
  server server_sitewithssl_de_http 10.0.0.9:80

backend backend_sitewithssl_de_https
  mode tcp
  server server_sitewithssl_de_https 10.0.0.9:443



On 5/4/17, Stefan Blachmann &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">sblachmann at gmail.com</A>&gt; wrote:
&gt;<i> I am using squid 3.5.23 for no-caching reverse proxying http to
</I>&gt;<i> backend web servers.
</I>&gt;<i> I want to do the same with https.
</I>&gt;<i>
</I>&gt;<i> If I try to make cache_peer, acl, http_access and cache_peer_access
</I>&gt;<i> for port 443 in addition to port 80, the connection attempt fails with
</I>&gt;<i> browser complaining about error code: SSL_ERROR_RX_RECORD_TOO_LONG. In
</I>&gt;<i> squid access log then there is a complaint about &quot;invalid request&quot;.
</I>&gt;<i>
</I>&gt;<i> Is there a way to configure squid to just pass through https traffic
</I>&gt;<i> to https backends? Just like it does with http?
</I>&gt;<i> That is, _without_ needing to give squid access to the certificates and
</I>&gt;<i> keys?
</I>&gt;<i>
</I>&gt;<i> (I ask because all instructions I found in the web are
</I>&gt;<i> privacy-breaking decrypting Mitm interception instructions. And I do
</I>&gt;<i> _not_ want to do it this way!)
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015167.html">[squid-users] Can I use squid to reverse proxy https (without	making it a man-in-the-middle)?
</A></li>
	<LI>Next message (by thread): <A HREF="015169.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15195">[ date ]</a>
              <a href="thread.html#15195">[ thread ]</a>
              <a href="subject.html#15195">[ subject ]</a>
              <a href="author.html#15195">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
