<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid - using NTLM for SSO
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20-%20using%20NTLM%20for%20SSO&In-Reply-To=%3C5a2a2508-b8f4-dd98-2246-b31874de1c8b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015211.html">
   <LINK REL="Next"  HREF="015213.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid - using NTLM for SSO</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20-%20using%20NTLM%20for%20SSO&In-Reply-To=%3C5a2a2508-b8f4-dd98-2246-b31874de1c8b%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid - using NTLM for SSO">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 10 06:23:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015211.html">[squid-users] Squid - using NTLM for SSO
</A></li>
        <LI>Next message (by thread): <A HREF="015213.html">[squid-users] Windows Updates a Caching Stub zone,	A windows updates store.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15212">[ date ]</a>
              <a href="thread.html#15212">[ thread ]</a>
              <a href="subject.html#15212">[ subject ]</a>
              <a href="author.html#15212">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/05/17 12:16, Dijxie wrote:
&gt;<i>
</I>&gt;&gt;<i> Hello list,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I need your help with a Squid-Proxy (3.5) NTLM Auth, the aim is to 
</I>&gt;&gt;<i> use SSO for my windows clients.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My Windows-Clients are using Active-Directory running on a Samba4-PDC.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I set up ldap basic auth in a developer environment, now I want to 
</I>&gt;&gt;<i> achieve SSO. (using NTLM?)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Documentation on 
</I>&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm</A> doesn't 
</I>&gt;&gt;<i> really help me enough (on my knowledge about squid and forms of 
</I>&gt;&gt;<i> authentication/samba).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Tests:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -&gt; testing Kerberos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm able to obtain (kinit) tickets and list them (klist)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# kinit Administrator
</I>&gt;&gt;<i> Password for <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Administrator at X-XXX.LOCAL</A>:
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# klist
</I>&gt;&gt;<i> Ticket cache: FILE:/tmp/krb5cc_0
</I>&gt;&gt;<i> Default principal: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Administrator at X-XXX.LOCAL</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Valid starting       Expires              Service principal
</I>&gt;&gt;<i> 2017-05-09 08:43:25  2017-05-09 18:43:25 krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">X-XXX.LOCAL at X-XXX.LOCAL</A>
</I>&gt;&gt;<i>     renew until 2017-05-10 08:43:21
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -&gt; testing Samba:
</I>&gt;&gt;<i> I joined my domain X-XXX.
</I>&gt;&gt;<i> Test support for ntlm:
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# wbinfo -a testuser%xxxxxxxxxxx
</I>&gt;&gt;<i> plaintext password authentication succeeded
</I>&gt;&gt;<i> challenge/response password authentication succeeded
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# wbinfo -a testuser%xxxxxxxxxxx
</I>&gt;&gt;<i> plaintext password authentication succeeded
</I>&gt;&gt;<i> challenge/response password authentication succeeded
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# wbinfo -t
</I>&gt;&gt;<i> checking the trust secret for domain X-XXX via RPC calls succeeded
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# wbinfo -g
</I>&gt;&gt;<i> X-XXX\cert publishers
</I>&gt;&gt;<i> ...negotiate_wrapper
</I>&gt;&gt;<i> X-XXX\webusers
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -&gt; Testing NTLM-helper:
</I>&gt;&gt;<i> Now here's my problem.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# /usr/bin/ntlm_auth 
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-ntlmssp --username=testuser 
</I>&gt;&gt;<i> --password=xxxxxxxxxxx
</I>&gt;&gt;<i> x-xxx\testuserxxxxxxxxxxx
</I>&gt;&gt;<i> SPNEGO request [testuser xxxxxxxxxxx] invalid prefix
</I>&gt;&gt;<i> BH SPNEGO request invalid prefix
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at xxx-testproxy01</A>:~# /usr/bin/ntlm_auth 
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-basic --username=testuser 
</I>&gt;&gt;<i> --password=xxxxxxxxxxx
</I>&gt;&gt;<i> x-xxx\testuser xxxxxxxxxxx
</I>&gt;&gt;<i> OK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What is ntlmssp? I read both helpers on tutorials. If I need both, 
</I>&gt;&gt;<i> why do I need both?
</I>&gt;&gt;<i> My squid is starting how it should, logs are looking normal, PopUp 
</I>&gt;&gt;<i> for authentication appears aswell, but I can't log in. I shoudn't 
</I>&gt;&gt;<i> need to authenticate in the first place because it should use SSO.
</I>&gt;&gt;<i> What is missing/faulty?
</I>&gt;&gt;<i> The rest of squid is basic stuff:mail/u/0/
</I>&gt;&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth 
</I>&gt;&gt;<i> &#8211;helper-protocol=squid-2.5-ntlmssp --username=testuser 
</I>&gt;&gt;<i> --password=Passme123
</I>&gt;&gt;<i> auth_param ntlm children 10
</I>&gt;&gt;<i> auth_param basic program /usr/bin/ntlm_auth 
</I>&gt;&gt;<i> &#8211;helper-protocol=squid-2.5-basic --username=testuser --password=Passme123
</I>&gt;&gt;<i> auth_param basic children 5
</I>&gt;&gt;<i> auth_param basic realm Proxy Server
</I>&gt;&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;&gt;<i> auth_param basic casesensitive off
</I>&gt;&gt;<i> authenticate_cache_garbage_interval 10 seconds
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny !auth
</I>&gt;&gt;<i> http_access allow auth
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> url_rewrite_program /usr/bin/squidGuard -c 
</I>&gt;&gt;<i> /etc/squidguard/squidGuard.conf
</I>&gt;&gt;<i> url_rewrite_children 5
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does anyone know further? Thanks in advance.
</I>&gt;&gt;<i> - Kevin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 1. There is no point in testing kerberos (kinit) when you're going to 
</I>&gt;<i> use ntlm_auth helper; squid has it's spnego helper, 'negotiate_wrapper 
</I>&gt;<i> ', which is capable doing negotiation between kerberos and NTLM.  Just 
</I>&gt;<i> look for squid-helpers package for your OS; if it's not in OS repo, 
</I>&gt;<i> check <A HREF="http://ngtech.co.il/repo/">http://ngtech.co.il/repo/</A> - Eliezer is doing really good job here.
</I>&gt;<i>
</I>&gt;<i> If kerberos is working in your environment, I would use 
</I>&gt;<i> negotiate_wrapper or negotiate_kerberos_auth.  Good thing about 
</I>&gt;<i> negotiate_wrapper is -d switch, which is giving you a good portion of 
</I>&gt;<i> debug info in cache.log
</I>&gt;<i>
</I>&gt;<i> Really, NTLM is bitchy and it is not primary protocol even in MS 
</I>&gt;<i> systems since 2003/XP. If you can fulfill kerberos' requirements in 
</I>&gt;<i> your environment,  I would go into kerberos, not NTLM.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2. My guess is that you have problem with access to 
</I>&gt;<i> windbind_priviledged pipe; can you perform usr/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --username=testuser 
</I>&gt;<i> --password=...et cetera witch ptrace? There is still a mess with 
</I>&gt;<i> winbind's pipe location; /var/run/samba vs /var/lib/samba, perharps 
</I>&gt;<i> you need some symlinking, ptrace can give you a clue.
</I>&gt;<i>
</I>
The *full* setup related to Squid and winbind permissions is detailed at 
&lt;<A HREF="http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm#winbind_privileged_pipe_permissions">http://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm#winbind_privileged_pipe_permissions</A>&gt; 
- pay particular attention to the three notes. Do ONLY what is 
specifically mentioned there, any other permissions fiddling done will 
only screw things up.


&gt;<i>
</I>&gt;<i> 3. Sometimes - just sometimes - passing --domain=DOMAIN_NAME to 
</I>&gt;<i> /usr/bin/ntlm_auth resolves cosmic issues. Sometimes it's 
</I>&gt;<i> DOMAIN\username vs just username in --username.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Last thing is error message: &quot;BH SPNEGO request invalid prefix&quot;.  It 
</I>&gt;<i> is strange, at least for me. SPNEGO reply is rather kerberos or 
</I>&gt;<i> negotiate reply; not ntlm_auth. What distro are you using?
</I>&gt;<i>
</I>
That output happened because Kevin passed the clear text (Basic auth) 
username/password to the helper when it was running in NTLM mode.  As 
you may notice the exact same input works fine when the helper is run in 
Basic mode.

When the helper is run with --helper-protocol=squid-2.5-ntlmssp the 
input it is expecting is the base64 encoded NTLMSSP object as found in 
the HTTP request headers. Squid does *not* decode the received header 
before sending it to the helper. The helper will respond with the crypto 
hunk to be sent to the client.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015211.html">[squid-users] Squid - using NTLM for SSO
</A></li>
	<LI>Next message (by thread): <A HREF="015213.html">[squid-users] Windows Updates a Caching Stub zone,	A windows updates store.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15212">[ date ]</a>
              <a href="thread.html#15212">[ thread ]</a>
              <a href="subject.html#15212">[ subject ]</a>
              <a href="author.html#15212">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
