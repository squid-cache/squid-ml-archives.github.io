<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ICAP Persistent Connections vs Retries (with code	review)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20Persistent%20Connections%20vs%20Retries%20%28with%20code%0A%09review%29&In-Reply-To=%3CCAEK0aNvmxU1h_Tj-Qu46NO2fSvZhRcKtpPmSkar%2B4-vG3BjmbQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015269.html">
   <LINK REL="Next"  HREF="015231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ICAP Persistent Connections vs Retries (with code	review)</H1>
    <B>Juan Ram&#237;rez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20Persistent%20Connections%20vs%20Retries%20%28with%20code%0A%09review%29&In-Reply-To=%3CCAEK0aNvmxU1h_Tj-Qu46NO2fSvZhRcKtpPmSkar%2B4-vG3BjmbQ%40mail.gmail.com%3E"
       TITLE="[squid-users] ICAP Persistent Connections vs Retries (with code	review)">jramirez.uy at gmail.com
       </A><BR>
    <I>Fri May 12 00:49:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015269.html">[squid-users] WARNING: All 20/20	negotiateauthenticator	processes are busy.
</A></li>
        <LI>Next message (by thread): <A HREF="015231.html">[squid-users] ICAP Persistent Connections vs Retries (with code review)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15229">[ date ]</a>
              <a href="thread.html#15229">[ thread ]</a>
              <a href="subject.html#15229">[ subject ]</a>
              <a href="author.html#15229">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Mi name is Juan, I am a Software Engineer from Uruguay. I think this
message is more suited to the squid-dev mailing list due to the
developer-oriented nature of the message but, given that the development
list is for people who actually contributes code to Squid, I chose to post
here.

I started using Squid a few days ago in order to test its
content-adaptation capabilities. The plan was to test the ICAP
implementation first and then maybe try the eCAP API as well.

In order to test ICAP, I based my code in the open source PYICAP project, I
also ran some tests using the C-ICAP server.

It came to my attention that, even when persistent connections is enabled,
Squid closes the ICAP connection everytime a new request arrives, like this:

1. A new request arrives
2. Squid creates a connection to the ICAP server
3. Content is adapted and returned to the client
4. Squid returns the connection to the connection pool
5. A new requests arrives
6. Squid closes the active connection
7. Squid opens a new connection to the ICAP server

Note: I am using only the RESPMOD method.

This tests was performed using Squid 3.5.x. I downloaded the last available
tarball (squid-4.0.19), and run the same test, which gave the same results.

So I started digging into the source code and found something interesting:

File:
    /src/adaptation/icap/ServiceRep.cc
Function:
    Adaptation::Icap::ServiceRep::getConnection(bool retriableXact, bool
&amp;reused)

Code:
    if (retriableXact)
        connection = theIdleConns-&gt;pop();
    else {
        theIdleConns-&gt;closeN(1);
    }

The connection is taken from the set of idle connections  ONLY if
retriableXact is set to true.

File:
    /src/adaptation/icap/Xaction.cc
Function:
    Adaptation::Icap::Xaction::openConnection()

Xaction uses the member variable 'isRetriable' as parameter for
ServiceRep::getConnection.

The function Xaction::disableRetries() is called from a lot of places, but
in my test case was called only two times (per request):

   1. In the function Adaptation::Icap::Xaction::noteCommRead, when
Comm::ReadNow returns Comm::OK.

   2. In the function Adaptation::Icap::Xaction::closeConnection,
because reuseConnection is set to true.

I am not sure if Xaction objects are reusable, it seems that they are
because setting isRetriable to false is affecting the way connections are
reused.

Anyway, I think the concept of retriability shuld not be confused with the
concept of reusability, but I haven't gone deep enough in order to ensure
that.

I appreciate your comments on this. Don't hesitate to contact me should any
additional information be needed.


-- 
Juan
:<i>wq
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170511/7cfcdb0c/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170511/7cfcdb0c/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015269.html">[squid-users] WARNING: All 20/20	negotiateauthenticator	processes are busy.
</A></li>
	<LI>Next message (by thread): <A HREF="015231.html">[squid-users] ICAP Persistent Connections vs Retries (with code review)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15229">[ date ]</a>
              <a href="thread.html#15229">[ thread ]</a>
              <a href="subject.html#15229">[ subject ]</a>
              <a href="author.html#15229">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
