<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] (no subject)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%28no%20subject%29&In-Reply-To=%3C6e91c07f-6511-2cd3-9cb9-9e425b7a90e5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015234.html">
   <LINK REL="Next"  HREF="015239.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] (no subject)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%28no%20subject%29&In-Reply-To=%3C6e91c07f-6511-2cd3-9cb9-9e425b7a90e5%40treenet.co.nz%3E"
       TITLE="[squid-users] (no subject)">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 12 12:16:45 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015234.html">[squid-users] (no subject)
</A></li>
        <LI>Next message (by thread): <A HREF="015239.html">[squid-users] (no subject)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15235">[ date ]</a>
              <a href="thread.html#15235">[ thread ]</a>
              <a href="subject.html#15235">[ subject ]</a>
              <a href="author.html#15235">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/05/17 22:31, chiasa.men wrote:
&gt;<i> Am Sonntag, 23. April 2017, 17:57:52 CEST schrieb Amos Jeffries:
</I>&gt;&gt;<i> On 23/04/17 23:25, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">chiasa.men at web.de</A> wrote:
</I>&gt;&gt;&gt;<i> Hello
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> my squid.conf looks like that:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> https_port 3128 accel cert=/cert.pem key=/cert.key
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> defaultsite=ww1.example.com vhost
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl server20_domains dstdomain ww1.example.com ww2.example.com
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow server20_domains
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer server20 parent 443 0 no-query originserver name=server20
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> login=PASSTHRU ssl sslversion=6
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer_access server20 allow server20_domains
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer_access server20 deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The idea was to send ww1 and ww2 to server20 which is hosting an apache
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> webservice for both sites.
</I>&gt;&gt;<i> That looks fine.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> You can see that approximately after 5s the timeout happens. Is it a
</I>&gt;&gt;&gt;<i> message
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> to worry about? (it is just &quot;info&quot; labled) Why does it occur?
</I>&gt;&gt;<i> Unknown. This is an Apache problem. The Squid portion of things appears
</I>&gt;&gt;<i> to be working if I'm reading that weird  access.log correctly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;<i> Acutally it's not. The problem seemed to be the
</I>&gt;<i> server_persistent_connections setting in squid.conf.
</I>&gt;<i> By default set to on it tries to keep the cache_peer connection. Apache on the
</I>&gt;<i> other site hit the KeepAliveTimeout which was set to 5 seconds by default.
</I>&gt;<i> server_persistent_connections off in squid.conf
</I>
So Squid is told (by Apache) that the connection is to be kept open / 
persistent and then Apache closes it very quickly afterward. That is an 
explicit configured problem, but still Apache endpoint is the cause of 
the issues you are having here.

It is not a bug or error for either software, since that is one of the 
behaviours explicitly allowed by HTTP. But for you its being a problem.


&gt;<i> It set server_persistent_connections to off and the problem disappeared.
</I>&gt;<i> Is there any downside of this setting?
</I>
1) Every single HTTP request sent to any upstream server has to go 
through a full TCP connection handshake process, then a TCP shutdown 
process afterwards.

2) TCP socket cannot be used for a second connection until the kernel 
has confirmed both endpoints are not going to send anything on it. Which 
may be up to 15min.

Between them these can cause a 50ms extra latency on every request, with 
a limit of just over 70 requests per second through the proxy to any 
given server - compared to the several tens of thousands Squid can 
normally handle and under 1ms latency that is quite bad.


The efficient solution is to have long persistence on the connections 
between your CDN frontend (Squid) and the backend origins (Apache). You 
can make the timeout much shorter on the Squid client connections.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015234.html">[squid-users] (no subject)
</A></li>
	<LI>Next message (by thread): <A HREF="015239.html">[squid-users] (no subject)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15235">[ date ]</a>
              <a href="thread.html#15235">[ thread ]</a>
              <a href="subject.html#15235">[ subject ]</a>
              <a href="author.html#15235">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
