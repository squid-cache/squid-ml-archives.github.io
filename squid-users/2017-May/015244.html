<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ICAP Persistent Connections vs Retries (with code review)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20Persistent%20Connections%20vs%20Retries%20%28with%20code%0A%20review%29&In-Reply-To=%3Cb7c09a72-efa9-e8e9-c3d1-c7bc2252b8d7%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015243.html">
   <LINK REL="Next"  HREF="015253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ICAP Persistent Connections vs Retries (with code review)</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ICAP%20Persistent%20Connections%20vs%20Retries%20%28with%20code%0A%20review%29&In-Reply-To=%3Cb7c09a72-efa9-e8e9-c3d1-c7bc2252b8d7%40measurement-factory.com%3E"
       TITLE="[squid-users] ICAP Persistent Connections vs Retries (with code review)">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri May 12 21:29:46 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015243.html">[squid-users] ICAP Persistent Connections vs Retries (with code	review)
</A></li>
        <LI>Next message (by thread): <A HREF="015253.html">[squid-users] ICAP Persistent Connections vs Retries (with code	review)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15244">[ date ]</a>
              <a href="thread.html#15244">[ thread ]</a>
              <a href="subject.html#15244">[ subject ]</a>
              <a href="author.html#15244">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/12/2017 01:17 PM, Juan Ram&#237;rez wrote:

&gt;<i> I still don't understand whether it is possible to reuse ICAP
</I>&gt;<i> connections for cases other than retries.
</I>
You are implying that idle persistent connections are used for retries.
They are not (or, at least, should not be). Idle persistent connections
are used for new requests that can be retried.

I am deleting most of my carefully written answers and skipping most of
your email until the place where you discovered problems without your
earlier statements/questions :-(.


&gt;<i> * Why does the size of the payload affect the way connections are reused
</I>
Because to resend the request, Squid has to have the payload to send.
Thus, to resend a 10GB request, Squid has to buffer a 10GB request.
Squid does not want to do that for, hopefully, obvious reasons.


&gt;<i> * Does Squid need a finer control on this matter in order to ensure
</I>&gt;<i> connection reusability is not affected by the size of the payload?
</I>
No. Connection reusability is affected by the size of the payload. It is
the unavoidable consequence of combining finite memory with potentially
infinite response sizes.


&gt;<i> I understand much more now than when I started writing this message.
</I>
FWIW, you would save some of us a lot of time if you do not send
portions that you later (but in the same email!) discovered to be
incorrect or irrelevant. This mailing list is not a blog; somebody may
actually be reading and responding to what you write.


&gt;<i> + I am not sure if it needs finer control, but the fact that is closing
</I>&gt;<i> connections in advance seems dangerous.
</I>
There is no danger in a client closing an idle connection.


&gt;<i> + It also seems dangerous to me this protection mechanism given the fact
</I>&gt;<i> that opening/closing TCP connections everytime can become a bottleneck.
</I>
There is some performance overhead, but not danger. High quality
optimizations are welcomed.


&gt;<i> I disabled the call to `theIdleConns-&gt;closeN(1);` 
</I>&gt;<i> Do you think there would be any issues with this change?
</I>
Yes, I do:

* In some environments, your patched Squid is likely to open too many
connections, violating various OS limits and/or admin expectations.

* In some environments, your patched Squid is likely to stop servicing
requests after hitting one of the open connection limits, unable to open
a new connection for an (unretriable) transaction, with a connection
pool full of idle connections.

The code you do not like was added because Squid was experiencing such
problems in some real-world environments (both HTTP and ICAP). It _can_
be improved, and quality patches are welcomed, but it should not be
disabled (in the official version).


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015243.html">[squid-users] ICAP Persistent Connections vs Retries (with code	review)
</A></li>
	<LI>Next message (by thread): <A HREF="015253.html">[squid-users] ICAP Persistent Connections vs Retries (with code	review)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15244">[ date ]</a>
              <a href="thread.html#15244">[ thread ]</a>
              <a href="subject.html#15244">[ subject ]</a>
              <a href="author.html#15244">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
