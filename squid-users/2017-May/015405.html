<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%20to%0A%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3CSC1PR80MB194973E5AE33EB788BFB08C5D0FE0%40SC1PR80MB1949.lamprd80.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015420.html">
   <LINK REL="Next"  HREF="015412.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept</H1>
    <B>Rogerio Coelho</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%20to%0A%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3CSC1PR80MB194973E5AE33EB788BFB08C5D0FE0%40SC1PR80MB1949.lamprd80.prod.outlook.com%3E"
       TITLE="[squid-users] New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept">rogerio.coelho at gruporbs.com.br
       </A><BR>
    <I>Wed May 24 20:02:37 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015420.html">[squid-users] New Member - Just testing mail list
</A></li>
        <LI>Next message (by thread): <A HREF="015412.html">[squid-users] New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15405">[ date ]</a>
              <a href="thread.html#15405">[ thread ]</a>
              <a href="subject.html#15405">[ subject ]</a>
              <a href="author.html#15405">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Squid Jedi&#180;s,

I am just a little stuck tryng to replace an old Squid 3.1.23 Server on Centos 6 that i use to redirect local web access to port 80 on linux servers to Squid Server.

On my Squid 3.1.23 Server on Centos 6 i use http_port 3128 transparent mode and on my Linux servers clients i use iptables to redirect Web traffic as below ( this config works ):

Squid Server 3.1.23 :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> squid]# cat squid.conf | egrep -v &quot;^#|^$&quot;
acl default_ip req_header x-forward -i &quot;/ipt/SQUID/default/ip&quot;
acl default_url dstdom_regex -i &quot;/ipt/SQUID/default/url&quot;
acl default_ip2 srcdom_regex -i &quot;/ipt/SQUID/default/ip&quot;
http_access allow default_ip default_url
acl endereco  req_header x-forward -i &quot;/ipt/SQUID/libera/ip&quot;
http_access allow endereco
acl all_ip req_header x-forward -i &quot;/ipt/SQUID/all/ip&quot;
acl all_url dstdom_regex -i &quot;/ipt/SQUID/all/url&quot;
acl all_ip2 srcdom_regex -i &quot;/ipt/SQUID/all/ip&quot;
http_access allow all_url
acl all src all
acl manager proto cache_object
acl from_localhost src 127.0.0.1/255.255.255.255
acl to_localhost dst 127.0.0.0/8
acl SSL_ports port 443
acl GIT_PORT port 9418         # git
acl CONNECT method CONNECT
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 21 # ftp
acl GIT_PORT2 port 9418 # git
http_access allow manager from_localhost
http_access deny manager
http_access allow GIT_PORT2
http_access deny !Safe_ports
http_access allow CONNECT GIT_PORT
http_access deny CONNECT !SSL_ports
http_access deny to_localhost
http_access allow from_localhost
http_access deny all
http_port 3128 transparent
https_port 3129 transparent intercept cert=/ipt/SQUID/https/squid.crt key=/ipt/SQUID/https/squid.key
hierarchy_stoplist cgi-bin ?
emulate_httpd_log on
logformat squid %tg %6tr %&gt;a %{x-forward}&gt;h %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt
access_log /var/log/squid/access.log squid
access_log syslog:local0.info  squid
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log
mime_table /etc/squid/mime.conf
pid_filename /var/run/squid.pid
acl QUERY urlpath_regex .*
cache deny QUERY
acl apache rep_header Server ^Apache
acl FS_TESTE srcdom_regex -i &quot;/ipt/SQUID/puppet/ip2&quot;
cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">tecnologiaseguranca at gruporbs.com.br</A>
cache_effective_user squid
cache_effective_group squid
coredump_dir /var/spool/squid
maximum_object_size 0 KB
minimum_object_size 0 KB
no_cache deny all
deny_info 172.20.63.73 webapp_ip

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 46M packets, 3068M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 4581K packets, 276M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 4581K packets, 276M bytes)
 pkts bytes target     prot opt in     out     source               destination
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> ~]#

Linux Server Clients ( Centos 5, 6 e 7 ) :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# cat proxy2.sh
#!/bin/bash

IPTBIN=$(which iptables)

$IPTBIN -t nat -F
$IPTBIN -t nat -X

#SQUID
$IPTBIN -A OUTPUT -s 10.240.68.68 -p tcp --sport 3128 -j ACCEPT

#PROXY
$IPTBIN -t nat -N PROXYSQUID
$IPTBIN -t nat -A OUTPUT -p tcp --dport 80 -j PROXYSQUID
$IPTBIN -t nat -A OUTPUT -p tcp --dport 443 -j PROXYSQUID
$IPTBIN -t nat -A PROXYSQUID -d 192.168.0.0/16 -j RETURN
$IPTBIN -t nat -A PROXYSQUID -d 189.76.144.0/20 -j RETURN
$IPTBIN -t nat -A PROXYSQUID -d 189.76.156.190 -j RETURN
$IPTBIN -t nat -A PROXYSQUID -d 172.16.0.0/12 -j RETURN
$IPTBIN -t nat -A PROXYSQUID -d 10.0.0.0/8 -j RETURN
$IPTBIN -t nat -A PROXYSQUID -p tcp -j DNAT --to-destination=10.240.68.68:3128


[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 58M packets, 4835M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:443

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           to:10.240.68.68:3128
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# curl -v www.google.com
* About to connect() to www.google.com port 80
*   Trying 216.58.222.68... * connected
* Connected to www.google.com (216.58.222.68) port 80
&gt;<i> GET / HTTP/1.1
</I>User-Agent: curl/7.12.1 (i686-redhat-linux-gnu) libcurl/7.12.1 OpenSSL/0.9.7a zlib/1.2.1.2 libidn/0.5.6
Host: www.google.com
Pragma: no-cache
Accept: */*

&lt; HTTP/1.0 302 Moved Temporarily
&lt; Location: <A HREF="http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag">http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag</A>
&lt; Cache-Control: private
&lt; Content-Type: text/html; charset=UTF-8
&lt; P3P: CP=&quot;This is not a P3P policy! See <A HREF="https://www.google.com/support/accounts/answer/151657?hl=en">https://www.google.com/support/accounts/answer/151657?hl=en</A> for more info.&quot;
&lt; Date: Thu, 18 May 2017 17:38:30 GMT
&lt; Server: gws
&lt; Content-Length: 262
&lt; X-XSS-Protection: 1; mode=block
&lt; X-Frame-Options: SAMEORIGIN
&lt; Set-Cookie: NID=103=Vdks002SayhLjRhSWr_ETgZR2-0Hngh7ci-McE8fBhw6vDhAENt6JxWkTKtPKWen7HL-KYjiSNg9lwXnjSCejhv1va4yIUhPpMDYZ-mK4uDb9FQldR1zp3Y1RiOwx4jX; expires=Fri, 17-Nov-2017 17:38:30 GMT; path=/; domain=.google.com; HttpOnly
&lt; X-Cache: MISS from leli.rbs.com.br
&lt; X-Cache-Lookup: MISS from leli.rbs.com.br:3128
&lt; Via: 1.0 leli.rbs.com.br (squid/3.1.23)
* HTTP/1.0 connection set to keep alive!
&lt; Connection: keep-alive
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;<A HREF="http://www.google.com.br/?gws_rd=cr&amp;amp;ei=FtwdWdaDMYm0wQSWwZ24Ag">http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag</A>&quot;&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
* Connection #0 to host www.google.com left intact
* Closing connection #0
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 58M packets, 4835M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination
    1    60 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:443

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    1    60 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           to:10.240.68.68:3128
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]#

On my new Squid Server running 3.5.20 on Centos 7 a try to use in many different ways but have no success.

I will send my steps on a new reply email in few minutes because the email size.

Sorry about all this log of information.



Rog&#233;rio Ceni Coelho
Engenheiro de Infraestrutura - Infrastructure Engineer
Diretoria de TI e Telecom - Grupo RBS
Fone: +55 (51) 3218-6983
Celular: +55 (51) 8186-2933 Claro
Celular: +55 (51) 8050-4225 Vivo
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rogerio.coelho at gruporbs.com.br</A>
<A HREF="http://www.gruporbs.com.br">http://www.gruporbs.com.br</A>



Esta mensagem e quaisquer anexos s&#227;o exclusivamente para o uso da parte endere&#231;ada e poder&#227;o conter dados privilegiados e confidenciais. Caso o leitor da mensagem n&#227;o seja a parte a quem ela foi endere&#231;ada, nem um representante autorizado da mesma, ficar&#225; notificado, por meio desta, que qualquer divulga&#231;&#227;o desta comunica&#231;&#227;o &#233; estritamente proibida. Se esta comunica&#231;&#227;o for recebida erroneamente, por favor, notifique-nos disto imediatamente por e-mail e delete a mensagem  e quaisquer anexos a ela de seu sistema.



O Grupo RBS pauta sua atua&#231;&#227;o por seu C&#243;digo de &#201;tica e Conduta, em conformidade com a Legisla&#231;&#227;o Brasileira. Qualquer situa&#231;&#227;o irregular deve ser informada via Canal de &#201;tica pelo site <A HREF="https://www.contatoseguro.com.br/gruporbs">https://www.contatoseguro.com.br/gruporbs</A> ou 0800 602 1831. Este e-mail e seus anexos podem conter informa&#231;&#245;es confidenciais. Se voc&#234; recebeu esta mensagem por engano, por favor apague-a e notifique o remetente imediatamente.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015420.html">[squid-users] New Member - Just testing mail list
</A></li>
	<LI>Next message (by thread): <A HREF="015412.html">[squid-users] New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15405">[ date ]</a>
              <a href="thread.html#15405">[ thread ]</a>
              <a href="subject.html#15405">[ subject ]</a>
              <a href="author.html#15405">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
