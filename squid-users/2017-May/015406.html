<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RES%3A%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%20to%0A%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3CSC1PR80MB194956E6A7A30F4ECFD508A6D0FE0%40SC1PR80MB1949.lamprd80.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015414.html">
   <LINK REL="Next"  HREF="015407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept</H1>
    <B>Rogerio Coelho</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RES%3A%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%20to%0A%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3CSC1PR80MB194956E6A7A30F4ECFD508A6D0FE0%40SC1PR80MB1949.lamprd80.prod.outlook.com%3E"
       TITLE="[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept">rogerio.coelho at gruporbs.com.br
       </A><BR>
    <I>Wed May 24 20:12:15 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015414.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
        <LI>Next message (by thread): <A HREF="015407.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15406">[ date ]</a>
              <a href="thread.html#15406">[ thread ]</a>
              <a href="subject.html#15406">[ subject ]</a>
              <a href="author.html#15406">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On my new Squid Server running 3.5.20 on Centos 7 a try to use in many different ways.

When i use wget or firefox using http_proxy conf web access go ok. But when i try to access web using iptables redirect from Linux Server i got bad request / Invalid URL.

When i use http_port 3329 intercept mode i got forbbiden.

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# yum install squid -y
Loaded plugins: fastestmirror
base                                                                                                                                                      | 3.6 kB  00:00:00
epel/x86_64/metalink                                                                                                                                      |  38 kB  00:00:00
epel                                                                                                                                                      | 4.3 kB  00:00:00
extras                                                                                                                                                    | 3.4 kB  00:00:00
updates                                                                                                                                                   | 3.4 kB  00:00:00
zabbix                                                                                                                                                    |  951 B  00:00:00
zabbix-non-supported                                                                                                                                      |  951 B  00:00:00
(1/2): epel/x86_64/updateinfo                                                                                                                             | 798 kB  00:00:05
(2/2): epel/x86_64/primary_db                                                                                                                             | 4.7 MB  00:00:25
Loading mirror speeds from cached hostfile
 * base: centos.brnet.net.br
 * epel: mirror.globo.com
 * extras: centos.brnet.net.br
 * updates: centos.xpg.com.br
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package squid.x86_64 7:3.5.20-2.el7_3.3 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

=================================================================================================================================================================================
 Package                               Arch                                   Version                                              Repository                               Size
=================================================================================================================================================================================
Installing:
 squid                                 x86_64                                 7:3.5.20-2.el7_3.3                                   updates                                 3.1 M

Transaction Summary
=================================================================================================================================================================================
Install  1 Package

Total download size: 3.1 M
Installed size: 10 M
Downloading packages:
squid-3.5.20-2.el7_3.3.x86_64.rpm                                                                                                                         | 3.1 MB  00:00:02
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : 7:squid-3.5.20-2.el7_3.3.x86_64                                                                                                                               1/1
  Verifying  : 7:squid-3.5.20-2.el7_3.3.x86_64                                                                                                                               1/1

Installed:
  squid.x86_64 7:3.5.20-2.el7_3.3

Complete!
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl enable squid
Created symlink from /etc/systemd/system/multi-user.target.wants/squid.service to /usr/lib/systemd/system/squid.service.
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl start squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# cat /var/log/squid/cache.log
2017/05/18 14:59:57 kid1| Set Current Directory to /var/spool/squid
2017/05/18 14:59:57 kid1| Starting Squid Cache version 3.5.20 for x86_64-redhat-linux-gnu...
2017/05/18 14:59:57 kid1| Service Name: squid
2017/05/18 14:59:57 kid1| Process ID 3051
2017/05/18 14:59:57 kid1| Process Roles: worker
2017/05/18 14:59:57 kid1| With 16384 file descriptors available
2017/05/18 14:59:57 kid1| Initializing IP Cache...
2017/05/18 14:59:57 kid1| DNS Socket created at [::], FD 6
2017/05/18 14:59:57 kid1| DNS Socket created at 0.0.0.0, FD 8
2017/05/18 14:59:57 kid1| Adding domain RBS.NET from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Adding domain rbs.com.br from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Adding nameserver 10.236.68.62 from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Adding nameserver 10.1.1.40 from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Logfile: opening log daemon:/var/log/squid/access.log
2017/05/18 14:59:57 kid1| Logfile Daemon: opening log /var/log/squid/access.log
2017/05/18 14:59:57 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2017/05/18 14:59:57 kid1| Store logging disabled
2017/05/18 14:59:57 kid1| Swap maxSize 0 + 262144 KB, estimated 20164 objects
2017/05/18 14:59:57 kid1| Target number of buckets: 1008
2017/05/18 14:59:57 kid1| Using 8192 Store buckets
2017/05/18 14:59:57 kid1| Max Mem  size: 262144 KB
2017/05/18 14:59:57 kid1| Max Swap size: 0 KB
2017/05/18 14:59:57 kid1| Using Least Load store dir selection
2017/05/18 14:59:57 kid1| Set Current Directory to /var/spool/squid
2017/05/18 14:59:57 kid1| Finished loading MIME types and icons.
2017/05/18 14:59:57 kid1| HTCP Disabled.
2017/05/18 14:59:57 kid1| Squid plugin modules loaded: 0
2017/05/18 14:59:57 kid1| Adaptation support is off.
2017/05/18 14:59:57 kid1| Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 11 flags=9
2017/05/18 14:59:58 kid1| storeLateRelease: released 0 objects

Linux Server Client ( Centos 7 ) ( Same Network of Squid Server ) :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# /mnt/bin/Linux/proxy3520.sh
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 32 packets, 2146 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 7 packets, 528 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            to:10.240.64.11:3128

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> -e use_proxy=yes -e http_proxy=10.240.64.11:3128
--2017-05-18 15:03:18--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
Connecting to 10.240.64.11:3128... connected.
Proxy request sent, awaiting response... 200 OK
Length: 11416 (11K) [application/x-redhat-package-manager]
Saving to: &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482;

100%[=======================================================================================================================================&gt;] 11,416      --.-K/s   in 0s

2017-05-18 15:03:18 (297 MB/s) - &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482; saved [11416/11416]

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
--2017-05-18 15:03:27--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
Resolving repo.zabbix.com (repo.zabbix.com)... 162.243.159.138
Connecting to repo.zabbix.com (repo.zabbix.com)|162.243.159.138|:80... connected.
HTTP request sent, awaiting response... 400 Bad Request
2017-05-18 15:03:27 ERROR 400: Bad Request.

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# curl -v <A HREF="http://www.google.com">http://www.google.com</A>
* About to connect() to www.google.com port 80 (#0)
*   Trying 216.58.222.68...
* Connected to www.google.com (216.58.222.68) port 80 (#0)
&gt;<i> GET / HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.29.0
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&lt; HTTP/1.1 400 Bad Request
&lt; Server: squid/3.5.20
&lt; Mime-Version: 1.0
&lt; Date: Thu, 18 May 2017 18:03:37 GMT
&lt; Content-Type: text/html;charset=utf-8
&lt; Content-Length: 3556
&lt; X-Squid-Error: ERR_INVALID_URL 0
&lt; Vary: Accept-Language
&lt; Content-Language: en
&lt; X-Cache: MISS from prd-rbs-squid01-poa.rbs.com.br
&lt; X-Cache-Lookup: NONE from prd-rbs-squid01-poa.rbs.com.br:3128
&lt; Via: 1.1 prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)
&lt; Connection: close
&lt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/strict.dtd">http://www.w3.org/TR/html4/strict.dtd</A>&quot;&gt;
&lt;html&gt;&lt;head&gt;
&lt;meta type=&quot;copyright&quot; content=&quot;Copyright (C) 1996-2016 The Squid Software Foundation and contributors&quot;&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;
&lt;title&gt;ERROR: The requested URL could not be retrieved&lt;/title&gt;
&lt;style type=&quot;text/css&quot;&gt;&lt;!--
 /*
 * Copyright (C) 1996-2016 The Squid Software Foundation and contributors
 *
 * Squid software is distributed under GPLv2+ license and includes
 * contributions from numerous individuals and organizations.
 * Please see the COPYING and CONTRIBUTORS files for details.
 */

/*
 Stylesheet for Squid Error pages
 Adapted from design by Free CSS Templates
 <A HREF="http://www.freecsstemplates.org">http://www.freecsstemplates.org</A>
 Released for free under a Creative Commons Attribution 2.5 License
*/

/* Page basics */
* {
        font-family: verdana, sans-serif;
}

html body {
        margin: 0;
        padding: 0;
        background: #efefef;
        font-size: 12px;
        color: #1e1e1e;
}

/* Page displayed title area */
#titles {
        margin-left: 15px;
        padding: 10px;
        padding-left: 100px;
        background: url('/squid-internal-static/icons/SN.png') no-repeat left;
}

/* initial title */
#titles h1 {
        color: #000000;
}
#titles h2 {
        color: #000000;
}

/* special event: FTP success page titles */
#titles ftpsuccess {
        background-color:#00ff00;
        width:100%;
}

/* Page displayed body content area */
#content {
        padding: 10px;
        background: #ffffff;
}

/* General text */
p {
}

/* error brief description */
#error p {
}

/* some data which may have caused the problem */
#data {
}

/* the error message received from the system or other software */
#sysmsg {
}

pre {
    font-family:sans-serif;
}

/* special event: FTP / Gopher directory listing */
#dirmsg {
    font-family: courier;
    color: black;
    font-size: 10pt;
}
#dirlisting {
    margin-left: 2%;
    margin-right: 2%;
}
#dirlisting tr.entry td.icon,td.filename,td.size,td.date {
    border-bottom: groove;
}
#dirlisting td.size {
    width: 50px;
    text-align: right;
    padding-right: 5px;
}

/* horizontal lines */
hr {
        margin: 0;
}

/* page displayed footer area */
#footer {
        font-size: 9px;
        padding-left: 10px;
}


body
:<i>lang(fa) { direction: rtl; font-size: 100%; font-family: Tahoma, Roya, sans-serif; float: right; }
</I>:<i>lang(he) { direction: rtl; }
</I> --&gt;&lt;/style&gt;
&lt;/head&gt;&lt;body id=ERR_INVALID_URL&gt;
&lt;div id=&quot;titles&quot;&gt;
&lt;h1&gt;ERROR&lt;/h1&gt;
&lt;h2&gt;The requested URL could not be retrieved&lt;/h2&gt;
&lt;/div&gt;
&lt;hr&gt;

&lt;div id=&quot;content&quot;&gt;
&lt;p&gt;The following error was encountered while trying to retrieve the URL: &lt;a href=&quot;/&quot;&gt;/&lt;/a&gt;&lt;/p&gt;

&lt;blockquote id=&quot;error&quot;&gt;
&lt;p&gt;&lt;b&gt;Invalid URL&lt;/b&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Some aspect of the requested URL is incorrect.&lt;/p&gt;

&lt;p&gt;Some possible problems are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Missing or incorrect access protocol (should be &lt;q&gt;<A HREF="http://&lt;/q">http://&lt;/q</A>&gt; or similar)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Missing hostname&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Illegal double-escape in the URL-Path&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Illegal character in hostname; underscores are not allowed.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Your cache administrator is &lt;a href=&quot;mailto:root?subject=CacheErrorInfo%20-%20ERR_INVALID_URL&amp;body=CacheHost%3A%20prd-rbs-squid01-poa.rbs.com.br%0D%0AErrPage%3A%20ERR_INVALID_URL%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Thu,%2018%20May%202017%2018%3A03%3A37%20GMT%0D%0A%0D%0AClientIP%3A%2010.240.64.12%0D%0A%0D%0AHTTP%20Request%3A%0D%0A%0D%0A%0D%0A&quot;&gt;root&lt;/a&gt;.&lt;/p&gt;
&lt;br&gt;
&lt;/div&gt;

&lt;hr&gt;
&lt;div id=&quot;footer&quot;&gt;
&lt;p&gt;Generated Thu, 18 May 2017 18:03:37 GMT by prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)&lt;/p&gt;
&lt;!-- ERR_INVALID_URL --&gt;
&lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;
* Closing connection 0
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]#

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# tail -f /var/log/squid/access.log



1495130446.581    439 10.240.64.12 TCP_MISS/200 11869 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_DIRECT/162.243.159.138 application/x-redhat-package-manager
1495130598.008      0 10.240.64.12 TCP_MEM_HIT/200 11877 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_NONE/- application/x-redhat-package-manager
1495130607.437      0 10.240.64.12 TAG_NONE/400 4111 GET /zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm - HIER_NONE/- text/html
1495130617.581      0 10.240.64.12 TAG_NONE/400 3991 GET / - HIER_NONE/- text/html

I will send more on reply to this email because of the size of this email.

Rog&#233;rio Ceni Coelho
Engenheiro de Infraestrutura &#8211; Infrastructure Engineer
Diretoria de TI e Telecom - Grupo RBS
Fone: +55 (51) 3218-6983
Celular: +55 (51) 8186-2933 Claro
Celular: +55 (51) 8050-4225 Vivo
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rogerio.coelho at gruporbs.com.br</A>
<A HREF="http://www.gruporbs.com.br">http://www.gruporbs.com.br</A>



Esta mensagem e quaisquer anexos s&#227;o exclusivamente para o uso da parte endere&#231;ada e poder&#227;o conter dados privilegiados e confidenciais. Caso o leitor da mensagem n&#227;o seja a parte a quem ela foi endere&#231;ada, nem um representante autorizado da mesma, ficar&#225; notificado, por meio desta, que qualquer divulga&#231;&#227;o desta comunica&#231;&#227;o &#233; estritamente proibida. Se esta comunica&#231;&#227;o for recebida erroneamente, por favor, notifique-nos disto imediatamente por e-mail e delete a mensagem  e quaisquer anexos a ela de seu sistema.



-----Mensagem original-----
De: Rogerio Coelho
Enviada em: quarta-feira, 24 de maio de 2017 17:03
Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Assunto: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept

Hi Squid Jedi&#180;s,

I am just a little stuck tryng to replace an old Squid 3.1.23 Server on Centos 6 that i use to redirect local web access to port 80 on linux servers to Squid Server.

On my Squid 3.1.23 Server on Centos 6 i use http_port 3128 transparent mode and on my Linux servers clients i use iptables to redirect Web traffic as below ( this config works ):

Squid Server 3.1.23 :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> squid]# cat squid.conf | egrep -v &quot;^#|^$&quot;
acl default_ip req_header x-forward -i &quot;/ipt/SQUID/default/ip&quot;
acl default_url dstdom_regex -i &quot;/ipt/SQUID/default/url&quot;
acl default_ip2 srcdom_regex -i &quot;/ipt/SQUID/default/ip&quot;
http_access allow default_ip default_url acl endereco  req_header x-forward -i &quot;/ipt/SQUID/libera/ip&quot;
http_access allow endereco
acl all_ip req_header x-forward -i &quot;/ipt/SQUID/all/ip&quot;
acl all_url dstdom_regex -i &quot;/ipt/SQUID/all/url&quot;
acl all_ip2 srcdom_regex -i &quot;/ipt/SQUID/all/ip&quot;
http_access allow all_url
acl all src all
acl manager proto cache_object
acl from_localhost src 127.0.0.1/255.255.255.255 acl to_localhost dst 127.0.0.0/8 acl SSL_ports port 443
acl GIT_PORT port 9418         # git
acl CONNECT method CONNECT
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 21 # ftp
acl GIT_PORT2 port 9418 # git
http_access allow manager from_localhost http_access deny manager http_access allow GIT_PORT2 http_access deny !Safe_ports http_access allow CONNECT GIT_PORT http_access deny CONNECT !SSL_ports http_access deny to_localhost http_access allow from_localhost http_access deny all http_port 3128 transparent https_port 3129 transparent intercept cert=/ipt/SQUID/https/squid.crt key=/ipt/SQUID/https/squid.key hierarchy_stoplist cgi-bin ?
emulate_httpd_log on
logformat squid %tg %6tr %&gt;a %{x-forward}&gt;h %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt access_log /var/log/squid/access.log squid access_log syslog:local0.info  squid cache_log /var/log/squid/cache.log cache_store_log /var/log/squid/store.log mime_table /etc/squid/mime.conf pid_filename /var/run/squid.pid acl QUERY urlpath_regex .* cache deny QUERY acl apache rep_header Server ^Apache acl FS_TESTE srcdom_regex -i &quot;/ipt/SQUID/puppet/ip2&quot;
cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">tecnologiaseguranca at gruporbs.com.br</A>
cache_effective_user squid
cache_effective_group squid
coredump_dir /var/spool/squid
maximum_object_size 0 KB
minimum_object_size 0 KB
no_cache deny all
deny_info 172.20.63.73 webapp_ip

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 46M packets, 3068M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 4581K packets, 276M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 4581K packets, 276M bytes)
 pkts bytes target     prot opt in     out     source               destination
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> ~]#

Linux Server Clients ( Centos 5, 6 e 7 ) :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# cat proxy2.sh
#!/bin/bash

IPTBIN=$(which iptables)

$IPTBIN -t nat -F
$IPTBIN -t nat -X

#SQUID
$IPTBIN -A OUTPUT -s 10.240.68.68 -p tcp --sport 3128 -j ACCEPT

#PROXY
$IPTBIN -t nat -N PROXYSQUID
$IPTBIN -t nat -A OUTPUT -p tcp --dport 80 -j PROXYSQUID $IPTBIN -t nat -A OUTPUT -p tcp --dport 443 -j PROXYSQUID $IPTBIN -t nat -A PROXYSQUID -d 192.168.0.0/16 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 189.76.144.0/20 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 189.76.156.190 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 172.16.0.0/12 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 10.0.0.0/8 -j RETURN $IPTBIN -t nat -A PROXYSQUID -p tcp -j DNAT --to-destination=10.240.68.68:3128


[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# iptables -L -n -v -t nat Chain PREROUTING (policy ACCEPT 58M packets, 4835M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:443

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           to:10.240.68.68:3128
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# curl -v www.google.com
* About to connect() to www.google.com port 80
*   Trying 216.58.222.68... * connected
* Connected to www.google.com (216.58.222.68) port 80
&gt;<i> GET / HTTP/1.1
</I>User-Agent: curl/7.12.1 (i686-redhat-linux-gnu) libcurl/7.12.1 OpenSSL/0.9.7a zlib/1.2.1.2 libidn/0.5.6
Host: www.google.com
Pragma: no-cache
Accept: */*

&lt; HTTP/1.0 302 Moved Temporarily
&lt; Location: <A HREF="http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag">http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag</A>
&lt; Cache-Control: private
&lt; Content-Type: text/html; charset=UTF-8 &lt; P3P: CP=&quot;This is not a P3P policy! See <A HREF="https://www.google.com/support/accounts/answer/151657?hl=en">https://www.google.com/support/accounts/answer/151657?hl=en</A> for more info.&quot;
&lt; Date: Thu, 18 May 2017 17:38:30 GMT
&lt; Server: gws
&lt; Content-Length: 262
&lt; X-XSS-Protection: 1; mode=block
&lt; X-Frame-Options: SAMEORIGIN
&lt; Set-Cookie: NID=103=Vdks002SayhLjRhSWr_ETgZR2-0Hngh7ci-McE8fBhw6vDhAENt6JxWkTKtPKWen7HL-KYjiSNg9lwXnjSCejhv1va4yIUhPpMDYZ-mK4uDb9FQldR1zp3Y1RiOwx4jX; expires=Fri, 17-Nov-2017 17:38:30 GMT; path=/; domain=.google.com; HttpOnly &lt; X-Cache: MISS from leli.rbs.com.br &lt; X-Cache-Lookup: MISS from leli.rbs.com.br:3128 &lt; Via: 1.0 leli.rbs.com.br (squid/3.1.23)
* HTTP/1.0 connection set to keep alive!
&lt; Connection: keep-alive
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;<A HREF="http://www.google.com.br/?gws_rd=cr&amp;amp;ei=FtwdWdaDMYm0wQSWwZ24Ag">http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag</A>&quot;&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
* Connection #0 to host www.google.com left intact
* Closing connection #0
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# iptables -L -n -v -t nat Chain PREROUTING (policy ACCEPT 58M packets, 4835M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination
    1    60 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:443

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    1    60 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           to:10.240.68.68:3128
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]#

On my new Squid Server running 3.5.20 on Centos 7 a try to use in many different ways but have no success.

I will send my steps on a new reply email in few minutes because the email size.

Sorry about all this log of information.



Rog&#233;rio Ceni Coelho
Engenheiro de Infraestrutura &#8211; Infrastructure Engineer Diretoria de TI e Telecom - Grupo RBS
Fone: +55 (51) 3218-6983
Celular: +55 (51) 8186-2933 Claro
Celular: +55 (51) 8050-4225 Vivo
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rogerio.coelho at gruporbs.com.br</A>
<A HREF="http://www.gruporbs.com.br">http://www.gruporbs.com.br</A>



Esta mensagem e quaisquer anexos s&#227;o exclusivamente para o uso da parte endere&#231;ada e poder&#227;o conter dados privilegiados e confidenciais. Caso o leitor da mensagem n&#227;o seja a parte a quem ela foi endere&#231;ada, nem um representante autorizado da mesma, ficar&#225; notificado, por meio desta, que qualquer divulga&#231;&#227;o desta comunica&#231;&#227;o &#233; estritamente proibida. Se esta comunica&#231;&#227;o for recebida erroneamente, por favor, notifique-nos disto imediatamente por e-mail e delete a mensagem  e quaisquer anexos a ela de seu sistema.



O Grupo RBS pauta sua atua&#231;&#227;o por seu C&#243;digo de &#201;tica e Conduta, em conformidade com a Legisla&#231;&#227;o Brasileira. Qualquer situa&#231;&#227;o irregular deve ser informada via Canal de &#201;tica pelo site <A HREF="https://www.contatoseguro.com.br/gruporbs">https://www.contatoseguro.com.br/gruporbs</A> ou 0800 602 1831. Este e-mail e seus anexos podem conter informa&#231;&#245;es confidenciais. Se voc&#234; recebeu esta mensagem por engano, por favor apague-a e notifique o remetente imediatamente.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015414.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
	<LI>Next message (by thread): <A HREF="015407.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15406">[ date ]</a>
              <a href="thread.html#15406">[ thread ]</a>
              <a href="subject.html#15406">[ subject ]</a>
              <a href="author.html#15406">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
