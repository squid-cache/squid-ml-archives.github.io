<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RES%3A%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%20to%0A%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3CSC1PR80MB19499C09E5D9F768548EED20D0FE0%40SC1PR80MB1949.lamprd80.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015406.html">
   <LINK REL="Next"  HREF="015416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept</H1>
    <B>Rogerio Coelho</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RES%3A%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%20to%0A%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3CSC1PR80MB19499C09E5D9F768548EED20D0FE0%40SC1PR80MB1949.lamprd80.prod.outlook.com%3E"
       TITLE="[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept">rogerio.coelho at gruporbs.com.br
       </A><BR>
    <I>Wed May 24 20:16:59 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015406.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
        <LI>Next message (by thread): <A HREF="015416.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15407">[ date ]</a>
              <a href="thread.html#15407">[ thread ]</a>
              <a href="subject.html#15407">[ subject ]</a>
              <a href="author.html#15407">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Using intercept mode with 3129 port :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# cat /etc/squid/squid.conf | egrep -v &quot;^#|^$&quot;
acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
acl SSL_ports port 443
acl Safe_ports port 80          # http
&#8230;
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_port 3128
http_port 3129 intercept
cache_dir ufs /var/spool/squid 100 16 256
coredump_dir /var/spool/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]#

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl restart squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# systemctl start squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# cat cache.log
2017/05/18 15:22:29 kid1| Set Current Directory to /var/spool/squid
2017/05/18 15:22:29 kid1| Starting Squid Cache version 3.5.20 for x86_64-redhat-linux-gnu...
2017/05/18 15:22:29 kid1| Service Name: squid
2017/05/18 15:22:29 kid1| Process ID 6592
2017/05/18 15:22:29 kid1| Process Roles: worker
2017/05/18 15:22:29 kid1| With 16384 file descriptors available
2017/05/18 15:22:29 kid1| Initializing IP Cache...
2017/05/18 15:22:29 kid1| DNS Socket created at [::], FD 6
2017/05/18 15:22:29 kid1| DNS Socket created at 0.0.0.0, FD 8
2017/05/18 15:22:29 kid1| Adding domain RBS.NET from /etc/resolv.conf
2017/05/18 15:22:29 kid1| Adding domain rbs.com.br from /etc/resolv.conf
2017/05/18 15:22:29 kid1| Adding nameserver 10.236.68.62 from /etc/resolv.conf
2017/05/18 15:22:29 kid1| Adding nameserver 10.1.1.40 from /etc/resolv.conf
2017/05/18 15:22:29 kid1| Logfile: opening log daemon:/var/log/squid/access.log
2017/05/18 15:22:29 kid1| Logfile Daemon: opening log /var/log/squid/access.log
2017/05/18 15:22:29 kid1| Unlinkd pipe opened on FD 14
2017/05/18 15:22:29 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2017/05/18 15:22:29 kid1| Store logging disabled
2017/05/18 15:22:29 kid1| Swap maxSize 102400 + 262144 KB, estimated 28041 objects
2017/05/18 15:22:29 kid1| Target number of buckets: 1402
2017/05/18 15:22:29 kid1| Using 8192 Store buckets
2017/05/18 15:22:29 kid1| Max Mem  size: 262144 KB
2017/05/18 15:22:29 kid1| Max Swap size: 102400 KB
2017/05/18 15:22:29 kid1| Rebuilding storage in /var/spool/squid (dirty log)
2017/05/18 15:22:29 kid1| Using Least Load store dir selection
2017/05/18 15:22:29 kid1| Set Current Directory to /var/spool/squid
2017/05/18 15:22:29 kid1| Finished loading MIME types and icons.
2017/05/18 15:22:29 kid1| HTCP Disabled.
2017/05/18 15:22:29 kid1| Squid plugin modules loaded: 0
2017/05/18 15:22:29 kid1| Adaptation support is off.
2017/05/18 15:22:29 kid1| Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 17 flags=9
2017/05/18 15:22:29 kid1| Accepting NAT intercepted HTTP Socket connections at local=[::]:3129 remote=[::] FD 18 flags=41
2017/05/18 15:22:29 kid1| Done reading /var/spool/squid swaplog (3 entries)
2017/05/18 15:22:29 kid1| Finished rebuilding storage from disk.
2017/05/18 15:22:29 kid1|         2 Entries scanned
2017/05/18 15:22:29 kid1|         0 Invalid entries.
2017/05/18 15:22:29 kid1|         0 With invalid flags.
2017/05/18 15:22:29 kid1|         1 Objects loaded.
2017/05/18 15:22:29 kid1|         0 Objects expired.
2017/05/18 15:22:29 kid1|         0 Objects cancelled.
2017/05/18 15:22:29 kid1|         0 Duplicate URLs purged.
2017/05/18 15:22:29 kid1|         1 Swapfile clashes avoided.
2017/05/18 15:22:29 kid1|   Took 0.01 seconds ( 91.36 objects/sec).
2017/05/18 15:22:29 kid1| Beginning Validation Procedure
2017/05/18 15:22:29 kid1|   Completed Validation Procedure
2017/05/18 15:22:29 kid1|   Validated 1 Entries
2017/05/18 15:22:29 kid1|   store_swap_size = 12.00 KB
2017/05/18 15:22:30 kid1| storeLateRelease: released 0 objects

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# netstat -nap | grep -i squid
tcp6       0      0 :::3128                 :::*                    LISTEN      6592/(squid-1)
tcp6       0      0 :::3129                 :::*                    LISTEN      6592/(squid-1)
udp        0      0 0.0.0.0:50868           0.0.0.0:*                           6592/(squid-1)
udp6       0      0 :::55754                :::*                                6592/(squid-1)
unix  3      [ ]         STREAM     CONNECTED     73819    6592/(squid-1)
unix  2      [ ]         DGRAM                    72824    6590/squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]#

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# /mnt/bin/Linux/proxy3520_3129.sh
&#8230;
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 27 packets, 1754 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 4 packets, 240 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 1 packets, 76 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443

Chain POSTROUTING (policy ACCEPT 1 packets, 76 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            to:10.240.64.11:3129
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# rm zabbix-release-3.0-1.el7.noarch.rpm*
rm: remove regular file &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482;? y
rm: remove regular file &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm.1&#226;&#8364;&#8482;? y
rm: remove regular file &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm.2&#226;&#8364;&#8482;? y
rm: remove regular file &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm.3&#226;&#8364;&#8482;? y
&#8230;
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> -e use_proxy=yes -e http_proxy=10.240.64.11:3128
--2017-05-18 15:23:57--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
&#8230;
Connecting to 10.240.64.11:3128... connected.
Proxy request sent, awaiting response... 200 OK
Length: 11416 (11K) [application/x-redhat-package-manager]
Saving to: &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482;

100%[=======================================================================================================================================&gt;] 11,416      --.-K/s   in 0s

2017-05-18 15:23:58 (194 MB/s) - &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482; saved [11416/11416]
&#8230;

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
--2017-05-18 15:24:16--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
&#8230;
Resolving repo.zabbix.com (repo.zabbix.com)... 162.243.159.138
Connecting to repo.zabbix.com (repo.zabbix.com)|162.243.159.138|:80... connected.
HTTP request sent, awaiting response... 403 Forbidden
2017-05-18 15:24:16 ERROR 403: Forbidden.
&#8230;

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# curl -v <A HREF="http://www.google.com">http://www.google.com</A>
* About to connect() to www.google.com port 80 (#0)
*   Trying 216.58.222.68...
* Connected to www.google.com (216.58.222.68) port 80 (#0)
&gt;<i> GET / HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.29.0
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&lt; HTTP/1.1 403 Forbidden
&lt; Server: squid/3.5.20
&lt; Mime-Version: 1.0
&lt; Date: Thu, 18 May 2017 18:24:23 GMT
&lt; Content-Type: text/html;charset=utf-8
&lt; Content-Length: 3707
&lt; X-Squid-Error: ERR_ACCESS_DENIED 0
&#8230;
&lt; Vary: Accept-Language
&lt; Content-Language: en
&lt; X-Cache: MISS from prd-rbs-squid01-poa.rbs.com.br
&lt; X-Cache-Lookup: MISS from prd-rbs-squid01-poa.rbs.com.br:3128
&lt; X-Cache: MISS from prd-rbs-squid01-poa.rbs.com.br
&lt; X-Cache-Lookup: MISS from prd-rbs-squid01-poa.rbs.com.br:3128
&lt; Via: 1.1 prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20), 1.1 prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)
&lt; Connection: keep-alive
&#8230;
&lt;/head&gt;&lt;body id=ERR_ACCESS_DENIED&gt;
&#8230;
&lt;div id=&quot;titles&quot;&gt;
&lt;h1&gt;ERROR&lt;/h1&gt;
&lt;h2&gt;The requested URL could not be retrieved&lt;/h2&gt;
&lt;/div&gt;
&lt;hr&gt;

&lt;div id=&quot;content&quot;&gt;
&lt;p&gt;The following error was encountered while trying to retrieve the URL: &lt;a href=&quot;<A HREF="http://www.google.com/">http://www.google.com/</A>&quot;&gt;<A HREF="http://www.google.com/&lt;/a">http://www.google.com/&lt;/a</A>&gt;&lt;/p&gt;

&lt;blockquote id=&quot;error&quot;&gt;
&lt;p&gt;&lt;b&gt;Access Denied.&lt;/b&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Access control configuration prevents your request from being allowed at this time. Please contact your service provider if you feel this is incorrect.&lt;/p&gt;

&lt;p&gt;Your cache administrator is &lt;a href=&quot;mailto:root?subject=CacheErrorInfo%20-%20ERR_ACCESS_DENIED&amp;body=CacheHost%3A%20prd-rbs-squid01-poa.rbs.com.br%0D%0AErrPage%3A%20ERR_ACCESS_DENIED%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Thu,%2018%20May%202017%2018%3A24%3A23%20GMT%0D%0A%0D%0AClientIP%3A%2010.240.64.11%0D%0A%0D%0AHTTP%20Request%3A%0D%0AGET%20%2F%20HTTP%2F1.1%0AUser-Agent%3A%20curl%2F7.29.0%0D%0AAccept%3A%20*%2F*%0D%0AVia%3A%201.1%20prd-rbs-squid01-poa.rbs.com.br%20(squid%2F3.5.20)%0D%0AX-Forwarded-For%3A%2010.240.64.12%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20keep-alive%0D%0AHost%3A%20www.google.com%0D%0A%0D%0A%0D%0A&quot;&gt;root&lt;/a&gt;.&lt;/p&gt;
&#8230;
&lt;br&gt;
&lt;/div&gt;

&lt;hr&gt;
&lt;div id=&quot;footer&quot;&gt;
&lt;p&gt;Generated Thu, 18 May 2017 18:24:23 GMT by prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)&lt;/p&gt;
&lt;!-- ERR_ACCESS_DENIED --&gt;
&lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;
&#8230;
* Connection #0 to host www.google.com left intact
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]#
&#8230;
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 238 packets, 21830 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 48 packets, 4956 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 4 packets, 257 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
    2   120 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
&#8230;
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443

Chain POSTROUTING (policy ACCEPT 6 packets, 377 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    2   120 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            to:10.240.64.11:3129
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]#

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# tail -f /var/log/squid/access.log
1495131838.333    470 10.240.64.12 TCP_SWAPFAIL_MISS/200 11868 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_DIRECT/162.243.159.138 application/x-redhat-package-manager

1495131856.340      0 10.240.64.11 TCP_MISS/403 4352 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_NONE/- text/html
1495131856.340      0 10.240.64.12 TCP_MISS/403 4517 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - ORIGINAL_DST/10.240.64.11 text/html
1495131863.177      0 10.240.64.11 TCP_MISS/403 4147 GET <A HREF="http://www.google.com/">http://www.google.com/</A> - HIER_NONE/- text/html
1495131863.177      3 10.240.64.12 TCP_MISS/403 4312 GET <A HREF="http://www.google.com/">http://www.google.com/</A> - ORIGINAL_DST/10.240.64.11 text/html





When i add iptables nat rules on Squid Server i get Service Unavailable / ERR_CONNECT_FAIL 111 .

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 11682 packets, 1002K bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 2631 packets, 243K bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 150 packets, 11353 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 150 packets, 11353 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# cat /root/squid.sh
#!/bin/bash

echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward
echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/default/rp_filter
echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/default/accept_source_route

iptables -F -t nat
iptables -X -t nat

# your proxy IP
SQUIDIP=10.240.64.11

# your proxy listening port
SQUIDPORT=3129

iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination $SQUIDIP:$SQUIDPORT
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -t mangle -A PREROUTING -p tcp --dport $SQUIDPORT -j DROP
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# /root/squid.sh
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 13 packets, 1777 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     tcp  --  *      *       10.240.64.11         0.0.0.0/0            tcp dpt:80
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.240.64.11:3129

Chain INPUT (policy ACCEPT 6 packets, 885 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# netstat -nap | grep -i squid
tcp6       0      0 :::3128                 :::*                    LISTEN      6592/(squid-1)
tcp6       0      0 :::3129                 :::*                    LISTEN      6592/(squid-1)
udp        0      0 0.0.0.0:50868           0.0.0.0:*                           6592/(squid-1)
udp6       0      0 :::55754                :::*                                6592/(squid-1)
unix  3      [ ]         STREAM     CONNECTED     73819    6592/(squid-1)
unix  2      [ ]         DGRAM                    72824    6590/squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl stop squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# rm /var/log/squid/* -f
&#8230;
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl start squid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# cat /var/log/squid/cache.log
2017/05/18 15:34:48 kid1| Set Current Directory to /var/spool/squid
2017/05/18 15:34:48 kid1| Starting Squid Cache version 3.5.20 for x86_64-redhat-linux-gnu...
2017/05/18 15:34:48 kid1| Service Name: squid
2017/05/18 15:34:48 kid1| Process ID 8435
2017/05/18 15:34:48 kid1| Process Roles: worker
2017/05/18 15:34:48 kid1| With 16384 file descriptors available
2017/05/18 15:34:48 kid1| Initializing IP Cache...
2017/05/18 15:34:48 kid1| DNS Socket created at [::], FD 6
2017/05/18 15:34:48 kid1| DNS Socket created at 0.0.0.0, FD 8
2017/05/18 15:34:48 kid1| Adding domain RBS.NET from /etc/resolv.conf
2017/05/18 15:34:48 kid1| Adding domain rbs.com.br from /etc/resolv.conf
2017/05/18 15:34:48 kid1| Adding nameserver 10.236.68.62 from /etc/resolv.conf
2017/05/18 15:34:48 kid1| Adding nameserver 10.1.1.40 from /etc/resolv.conf
2017/05/18 15:34:48 kid1| Logfile: opening log daemon:/var/log/squid/access.log
2017/05/18 15:34:48 kid1| Logfile Daemon: opening log /var/log/squid/access.log
2017/05/18 15:34:48 kid1| Unlinkd pipe opened on FD 14
2017/05/18 15:34:48 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2017/05/18 15:34:48 kid1| Store logging disabled
2017/05/18 15:34:48 kid1| Swap maxSize 102400 + 262144 KB, estimated 28041 objects
2017/05/18 15:34:48 kid1| Target number of buckets: 1402
2017/05/18 15:34:48 kid1| Using 8192 Store buckets
2017/05/18 15:34:48 kid1| Max Mem  size: 262144 KB
2017/05/18 15:34:48 kid1| Max Swap size: 102400 KB
2017/05/18 15:34:48 kid1| Rebuilding storage in /var/spool/squid (dirty log)
2017/05/18 15:34:48 kid1| Using Least Load store dir selection
2017/05/18 15:34:48 kid1| Set Current Directory to /var/spool/squid
2017/05/18 15:34:48 kid1| Finished loading MIME types and icons.
2017/05/18 15:34:48 kid1| HTCP Disabled.
2017/05/18 15:34:48 kid1| Squid plugin modules loaded: 0
2017/05/18 15:34:48 kid1| Adaptation support is off.
2017/05/18 15:34:48 kid1| Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 17 flags=9
2017/05/18 15:34:48 kid1| Accepting NAT intercepted HTTP Socket connections at local=[::]:3129 remote=[::] FD 18 flags=41
2017/05/18 15:34:48 kid1| Done reading /var/spool/squid swaplog (4 entries)
2017/05/18 15:34:48 kid1| Finished rebuilding storage from disk.
2017/05/18 15:34:48 kid1|         2 Entries scanned
2017/05/18 15:34:48 kid1|         0 Invalid entries.
2017/05/18 15:34:48 kid1|         0 With invalid flags.
2017/05/18 15:34:48 kid1|         1 Objects loaded.
2017/05/18 15:34:48 kid1|         0 Objects expired.
2017/05/18 15:34:48 kid1|         0 Objects cancelled.
2017/05/18 15:34:48 kid1|         0 Duplicate URLs purged.
2017/05/18 15:34:48 kid1|         1 Swapfile clashes avoided.
2017/05/18 15:34:48 kid1|   Took 0.01 seconds ( 91.74 objects/sec).
2017/05/18 15:34:48 kid1| Beginning Validation Procedure
2017/05/18 15:34:48 kid1|   Completed Validation Procedure
2017/05/18 15:34:48 kid1|   Validated 1 Entries
2017/05/18 15:34:48 kid1|   store_swap_size = 12.00 KB
2017/05/18 15:34:49 kid1| storeLateRelease: released 0 objects


[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# /mnt/bin/Linux/proxy3520_80.sh
&#8230;
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 8 packets, 594 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 1 packets, 76 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443

Chain POSTROUTING (policy ACCEPT 1 packets, 76 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            to:10.240.64.11:80
&#8230;

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> -e use_proxy=yes -e http_proxy=10.240.64.11:3128
--2017-05-18 15:35:16--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
&#8230;
Connecting to 10.240.64.11:3128... connected.
Proxy request sent, awaiting response... 200 OK
Length: 11416 (11K) [application/x-redhat-package-manager]
Saving to: &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm.1&#226;&#8364;&#8482;
&#8230;

100%[=======================================================================================================================================&gt;] 11,416      --.-K/s   in 0s

2017-05-18 15:35:16 (193 MB/s) - &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm.1&#226;&#8364;&#8482; saved [11416/11416]
&#8230;

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
--2017-05-18 15:35:25--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
&#8230;
Resolving repo.zabbix.com (repo.zabbix.com)... 162.243.159.138
Connecting to repo.zabbix.com (repo.zabbix.com)|162.243.159.138|:80... connected.
HTTP request sent, awaiting response... 503 Service Unavailable
2017-05-18 15:35:25 ERROR 503: Service Unavailable.
&#8230;

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# curl -v <A HREF="http://www.google.com">http://www.google.com</A>
* About to connect() to www.google.com port 80 (#0)
*   Trying 216.58.222.68...
* Connected to www.google.com (216.58.222.68) port 80 (#0)
&gt;<i> GET / HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.29.0
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&lt; HTTP/1.1 503 Service Unavailable
&lt; Server: squid/3.5.20
&lt; Mime-Version: 1.0
&lt; Date: Thu, 18 May 2017 18:35:42 GMT
&lt; Content-Type: text/html;charset=utf-8
&lt; Content-Length: 3586
&lt; X-Squid-Error: ERR_CONNECT_FAIL 111
&#8230;
&lt; Vary: Accept-Language
&lt; Content-Language: en
&lt; X-Cache: MISS from prd-rbs-squid01-poa.rbs.com.br
&lt; X-Cache-Lookup: MISS from prd-rbs-squid01-poa.rbs.com.br:3128
&lt; Via: 1.1 prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)
&lt; Connection: keep-alive
&#8230;
&lt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/strict.dtd">http://www.w3.org/TR/html4/strict.dtd</A>&quot;&gt;
&lt;html&gt;&lt;head&gt;
&lt;meta type=&quot;copyright&quot; content=&quot;Copyright (C) 1996-2016 The Squid Software Foundation and contributors&quot;&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=utf-8&quot;&gt;
&#8230;
&lt;/head&gt;&lt;body id=ERR_CONNECT_FAIL&gt;
&#8230;
&lt;div id=&quot;titles&quot;&gt;
&lt;h1&gt;ERROR&lt;/h1&gt;
&lt;h2&gt;The requested URL could not be retrieved&lt;/h2&gt;
&lt;/div&gt;
&lt;hr&gt;

&lt;div id=&quot;content&quot;&gt;
&lt;p&gt;The following error was encountered while trying to retrieve the URL: &lt;a href=&quot;<A HREF="http://www.google.com/">http://www.google.com/</A>&quot;&gt;<A HREF="http://www.google.com/&lt;/a">http://www.google.com/&lt;/a</A>&gt;&lt;/p&gt;

&lt;blockquote id=&quot;error&quot;&gt;
&lt;p&gt;&lt;b&gt;Connection to 10.240.64.11 failed.&lt;/b&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p id=&quot;sysmsg&quot;&gt;The system returned: &lt;i&gt;(111) Connection refused&lt;/i&gt;&lt;/p&gt;

&lt;p&gt;The remote host or network may be down. Please try the request again.&lt;/p&gt;

&lt;p&gt;Your cache administrator is &lt;a href=&quot;mailto:root?subject=CacheErrorInfo%20-%20ERR_CONNECT_FAIL&amp;body=CacheHost%3A%20prd-rbs-squid01-poa.rbs.com.br%0D%0AErrPage%3A%20ERR_CONNECT_FAIL%0D%0AErr%3A%20(111)%20Connection%20refused%0D%0ATimeStamp%3A%20Thu,%2018%20May%202017%2018%3A35%3A42%20GMT%0D%0A%0D%0AClientIP%3A%2010.240.64.12%0D%0AServerIP%3A%20www.google.com%0D%0A%0D%0AHTTP%20Request%3A%0D%0AGET%20%2F%20HTTP%2F1.1%0AUser-Agent%3A%20curl%2F7.29.0%0D%0AAccept%3A%20*%2F*%0D%0AHost%3A%20www.google.com%0D%0A%0D%0A%0D%0A&quot;&gt;root&lt;/a&gt;.&lt;/p&gt;
&#8230;

&lt;br&gt;
&lt;/div&gt;

&lt;hr&gt;
&lt;div id=&quot;footer&quot;&gt;
&lt;p&gt;Generated Thu, 18 May 2017 18:35:42 GMT by prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)&lt;/p&gt;
&lt;!-- ERR_CONNECT_FAIL --&gt;
&lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;
&#8230;
* Connection #0 to host www.google.com left intact
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# telnet 10.240.64.11 80
Trying 10.240.64.11...
Connected to 10.240.64.11.
Escape character is '^]'.
www.google.com.br
&#8230;
HTTP/1.1 400 Bad Request
Server: squid/3.5.20
Mime-Version: 1.0
Date: Thu, 18 May 2017 18:36:12 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 4083
X-Squid-Error: ERR_INVALID_REQ 0
&#8230;
&lt;/head&gt;&lt;body id=ERR_INVALID_REQ&gt;
&#8230;
&lt;div id=&quot;titles&quot;&gt;
&lt;h1&gt;ERROR&lt;/h1&gt;
&lt;h2&gt;The requested URL could not be retrieved&lt;/h2&gt;
&lt;/div&gt;
&lt;hr&gt;

&lt;div id=&quot;content&quot;&gt;
&lt;p&gt;&lt;b&gt;Invalid Request&lt;/b&gt; error was encountered while trying to process the request:&lt;/p&gt;

&lt;blockquote id=&quot;data&quot;&gt;
&lt;pre&gt;www.google.com.br
&lt;/pre&gt;
&lt;/blockquote&gt;
&#8230;

&lt;p&gt;Some possible problems are:&lt;/p&gt;
&lt;ul&gt;
&lt;li id=&quot;missing-method&quot;&gt;&lt;p&gt;Missing or unknown request method.&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;missing-url&quot;&gt;&lt;p&gt;Missing URL.&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;missing-protocol&quot;&gt;&lt;p&gt;Missing HTTP Identifier (HTTP/1.0).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Request is too large.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Content-Length missing for POST or PUT requests.&lt;/p&gt;&lt;/li&gt;
&#8230;
&lt;li&gt;&lt;p&gt;Illegal character in hostname; underscores are not allowed.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;HTTP/1.1 &lt;q&gt;Expect:&lt;/q&gt; feature is being asked from an HTTP/1.0 software.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Your cache administrator is &lt;a href=&quot;mailto:root?subject=CacheErrorInfo%20-%20ERR_INVALID_REQ&amp;body=CacheHost%3A%20prd-rbs-squid01-poa.rbs.com.br%0D%0AErrPage%3A%20ERR_INVALID_REQ%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Thu,%2018%20May%202017%2018%3A36%3A12%20GMT%0D%0A%0D%0AClientIP%3A%2010.240.64.12%0D%0A%0D%0AHTTP%20Request%3A%0D%0A%0D%0A%0D%0A&quot;&gt;root&lt;/a&gt;.&lt;/p&gt;
&lt;br&gt;
&lt;/div&gt;

&lt;script language=&quot;javascript&quot;&gt;
if ('[unknown method]' != '[unknown method]') document.getElementById('missing-method').style.display = 'none';
if ('error:invalid-request' != '[no URL]') document.getElementById('missing-url').style.display = 'none';
if ('[unknown protocol]' != '[unknown protocol]') document.getElementById('missing-protocol').style.display = 'none';
&lt;/script&gt;

&lt;hr&gt;
&lt;div id=&quot;footer&quot;&gt;
&lt;p&gt;Generated Thu, 18 May 2017 18:36:12 GMT by prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)&lt;/p&gt;
&lt;!-- ERR_INVALID_REQ --&gt;
&lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;
Connection closed by foreign host.
&#8230;
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]#


[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# tail -f /var/log/squid/access.log



1495132516.589    414 10.240.64.12 TCP_SWAPFAIL_MISS/200 11868 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_DIRECT/162.243.159.138 application/x-redhat-package-manager
1495132525.592      1 10.240.64.12 TCP_MISS/503 4275 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - ORIGINAL_DST/10.240.64.11 text/html
1495132542.412      4 10.240.64.12 TCP_MISS/503 4037 GET <A HREF="http://www.google.com/">http://www.google.com/</A> - ORIGINAL_DST/10.240.64.11 text/html
1495132572.097      0 10.240.64.12 TAG_NONE/400 4518 NONE error:invalid-request - HIER_NONE/- text/html
^[[A^[[A^C
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]#
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]#
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]#
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 1302 packets, 114K bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     tcp  --  *      *       10.240.64.11         0.0.0.0/0            tcp dpt:80
    3   180 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.240.64.11:3129

Chain INPUT (policy ACCEPT 300 packets, 26683 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 14 packets, 983 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
&#8230;
 pkts bytes target     prot opt in     out     source               destination
   14   983 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]#

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# curl -v <A HREF="http://www.google.com">http://www.google.com</A>
&#8230;
* About to connect() to www.google.com port 80 (#0)
*   Trying 172.217.30.4...
* Connected to www.google.com (172.217.30.4) port 80 (#0)
&#8230;
&gt;<i> GET / HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.29.0
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&lt; HTTP/1.1 302 Found
&lt; Location: <A HREF="http://www.google.com.br/?gws_rd=cr&amp;ei=wuodWZinJcmZwgTciKb4Bg">http://www.google.com.br/?gws_rd=cr&amp;ei=wuodWZinJcmZwgTciKb4Bg</A>
&#8230;
&lt; Cache-Control: private
&lt; Content-Type: text/html; charset=UTF-8
&lt; P3P: CP=&quot;This is not a P3P policy! See <A HREF="https://www.google.com/support/accounts/answer/151657?hl=en">https://www.google.com/support/accounts/answer/151657?hl=en</A> for more info.&quot;
&lt; Date: Thu, 18 May 2017 18:41:06 GMT
&#8230;
&lt; Server: gws
&lt; Content-Length: 262
&lt; X-XSS-Protection: 1; mode=block
&lt; X-Frame-Options: SAMEORIGIN
&lt; Set-Cookie: NID=103=WzsmeICIbXNm_Pvj9tvsdijmqA-NgEXXDYt9Oiso971cJhOyXiM3GEjVwZNUxKs4QorVs9P_07jwWkPk6LhbODbhNPdchdTiTpMXh_ZIFpRKDPERbxD3w46bOVl_CngR; expires=Fri, 17-Nov-2017 18:41:06 GMT; path=/; domain=.google.com; HttpOnly
&#8230;
&lt;
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;<A HREF="http://www.google.com.br/?gws_rd=cr&amp;amp;ei=wuodWZinJcmZwgTciKb4Bg">http://www.google.com.br/?gws_rd=cr&amp;ei=wuodWZinJcmZwgTciKb4Bg</A>&quot;&gt;here&lt;/A&gt;.
&#8230;


I am missing something on this ... Please help !!!

Thanks.



Rog&#233;rio Ceni Coelho
Engenheiro de Infraestrutura &#8211; Infrastructure Engineer
Diretoria de TI e Telecom - Grupo RBS
Fone: +55 (51) 3218-6983
Celular: +55 (51) 8186-2933 Claro
Celular: +55 (51) 8050-4225 Vivo
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rogerio.coelho at gruporbs.com.br</A>
<A HREF="http://www.gruporbs.com.br">http://www.gruporbs.com.br</A>



Esta mensagem e quaisquer anexos s&#227;o exclusivamente para o uso da parte endere&#231;ada e poder&#227;o conter dados privilegiados e confidenciais. Caso o leitor da mensagem n&#227;o seja a parte a quem ela foi endere&#231;ada, nem um representante autorizado da mesma, ficar&#225; notificado, por meio desta, que qualquer divulga&#231;&#227;o desta comunica&#231;&#227;o &#233; estritamente proibida. Se esta comunica&#231;&#227;o for recebida erroneamente, por favor, notifique-nos disto imediatamente por e-mail e delete a mensagem  e quaisquer anexos a ela de seu sistema.



-----Mensagem original-----
De: Rogerio Coelho
Enviada em: quarta-feira, 24 de maio de 2017 17:11
Para: '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Assunto: RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept

On my new Squid Server running 3.5.20 on Centos 7 a try to use in many different ways.

When i use wget or firefox using http_proxy conf web access go ok. But when i try to access web using iptables redirect from Linux Server i got bad request / Invalid URL.

When i use http_port 3329 intercept mode i got forbbiden.

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# yum install squid -y Loaded plugins: fastestmirror
base                                                                                                                                                      | 3.6 kB  00:00:00
epel/x86_64/metalink                                                                                                                                      |  38 kB  00:00:00
epel                                                                                                                                                      | 4.3 kB  00:00:00
extras                                                                                                                                                    | 3.4 kB  00:00:00
updates                                                                                                                                                   | 3.4 kB  00:00:00
zabbix                                                                                                                                                    |  951 B  00:00:00
zabbix-non-supported                                                                                                                                      |  951 B  00:00:00
(1/2): epel/x86_64/updateinfo                                                                                                                             | 798 kB  00:00:05
(2/2): epel/x86_64/primary_db                                                                                                                             | 4.7 MB  00:00:25
Loading mirror speeds from cached hostfile
 * base: centos.brnet.net.br
 * epel: mirror.globo.com
 * extras: centos.brnet.net.br
 * updates: centos.xpg.com.br
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package squid.x86_64 7:3.5.20-2.el7_3.3 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

=================================================================================================================================================================================
 Package                               Arch                                   Version                                              Repository                               Size
=================================================================================================================================================================================
Installing:
 squid                                 x86_64                                 7:3.5.20-2.el7_3.3                                   updates                                 3.1 M

Transaction Summary
=================================================================================================================================================================================
Install  1 Package

Total download size: 3.1 M
Installed size: 10 M
Downloading packages:
squid-3.5.20-2.el7_3.3.x86_64.rpm                                                                                                                         | 3.1 MB  00:00:02
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : 7:squid-3.5.20-2.el7_3.3.x86_64                                                                                                                               1/1
  Verifying  : 7:squid-3.5.20-2.el7_3.3.x86_64                                                                                                                               1/1

Installed:
  squid.x86_64 7:3.5.20-2.el7_3.3

Complete!
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl enable squid Created symlink from /etc/systemd/system/multi-user.target.wants/squid.service to /usr/lib/systemd/system/squid.service.
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl start squid [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# cat /var/log/squid/cache.log
2017/05/18 14:59:57 kid1| Set Current Directory to /var/spool/squid
2017/05/18 14:59:57 kid1| Starting Squid Cache version 3.5.20 for x86_64-redhat-linux-gnu...
2017/05/18 14:59:57 kid1| Service Name: squid
2017/05/18 14:59:57 kid1| Process ID 3051
2017/05/18 14:59:57 kid1| Process Roles: worker
2017/05/18 14:59:57 kid1| With 16384 file descriptors available
2017/05/18 14:59:57 kid1| Initializing IP Cache...
2017/05/18 14:59:57 kid1| DNS Socket created at [::], FD 6
2017/05/18 14:59:57 kid1| DNS Socket created at 0.0.0.0, FD 8
2017/05/18 14:59:57 kid1| Adding domain RBS.NET from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Adding domain rbs.com.br from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Adding nameserver 10.236.68.62 from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Adding nameserver 10.1.1.40 from /etc/resolv.conf
2017/05/18 14:59:57 kid1| Logfile: opening log daemon:/var/log/squid/access.log
2017/05/18 14:59:57 kid1| Logfile Daemon: opening log /var/log/squid/access.log
2017/05/18 14:59:57 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2017/05/18 14:59:57 kid1| Store logging disabled
2017/05/18 14:59:57 kid1| Swap maxSize 0 + 262144 KB, estimated 20164 objects
2017/05/18 14:59:57 kid1| Target number of buckets: 1008
2017/05/18 14:59:57 kid1| Using 8192 Store buckets
2017/05/18 14:59:57 kid1| Max Mem  size: 262144 KB
2017/05/18 14:59:57 kid1| Max Swap size: 0 KB
2017/05/18 14:59:57 kid1| Using Least Load store dir selection
2017/05/18 14:59:57 kid1| Set Current Directory to /var/spool/squid
2017/05/18 14:59:57 kid1| Finished loading MIME types and icons.
2017/05/18 14:59:57 kid1| HTCP Disabled.
2017/05/18 14:59:57 kid1| Squid plugin modules loaded: 0
2017/05/18 14:59:57 kid1| Adaptation support is off.
2017/05/18 14:59:57 kid1| Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 11 flags=9
2017/05/18 14:59:58 kid1| storeLateRelease: released 0 objects

Linux Server Client ( Centos 7 ) ( Same Network of Squid Server ) :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# /mnt/bin/Linux/proxy3520.sh [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# iptables -L -n -v -t nat Chain PREROUTING (policy ACCEPT 32 packets, 2146 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 7 packets, 528 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            to:10.240.64.11:3128

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> -e use_proxy=yes -e http_proxy=10.240.64.11:3128
--2017-05-18 15:03:18--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
Connecting to 10.240.64.11:3128... connected.
Proxy request sent, awaiting response... 200 OK
Length: 11416 (11K) [application/x-redhat-package-manager]
Saving to: &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482;

100%[=======================================================================================================================================&gt;] 11,416      --.-K/s   in 0s

2017-05-18 15:03:18 (297 MB/s) - &#226;&#8364;&#732;zabbix-release-3.0-1.el7.noarch.rpm&#226;&#8364;&#8482; saved [11416/11416]

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# wget <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
--2017-05-18 15:03:27--  <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A>
Resolving repo.zabbix.com (repo.zabbix.com)... 162.243.159.138 Connecting to repo.zabbix.com (repo.zabbix.com)|162.243.159.138|:80... connected.
HTTP request sent, awaiting response... 400 Bad Request
2017-05-18 15:03:27 ERROR 400: Bad Request.

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]# curl -v <A HREF="http://www.google.com">http://www.google.com</A>
* About to connect() to www.google.com port 80 (#0)
*   Trying 216.58.222.68...
* Connected to www.google.com (216.58.222.68) port 80 (#0)
&gt;<i> GET / HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.29.0
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&lt; HTTP/1.1 400 Bad Request
&lt; Server: squid/3.5.20
&lt; Mime-Version: 1.0
&lt; Date: Thu, 18 May 2017 18:03:37 GMT
&lt; Content-Type: text/html;charset=utf-8
&lt; Content-Length: 3556
&lt; X-Squid-Error: ERR_INVALID_URL 0
&lt; Vary: Accept-Language
&lt; Content-Language: en
&lt; X-Cache: MISS from prd-rbs-squid01-poa.rbs.com.br &lt; X-Cache-Lookup: NONE from prd-rbs-squid01-poa.rbs.com.br:3128
&lt; Via: 1.1 prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20) &lt; Connection: close &lt; &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/strict.dtd">http://www.w3.org/TR/html4/strict.dtd</A>&quot;&gt;
&lt;html&gt;&lt;head&gt;
&lt;meta type=&quot;copyright&quot; content=&quot;Copyright (C) 1996-2016 The Squid Software Foundation and contributors&quot;&gt; &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;
&lt;title&gt;ERROR: The requested URL could not be retrieved&lt;/title&gt; &lt;style type=&quot;text/css&quot;&gt;&lt;!--
 /*
 * Copyright (C) 1996-2016 The Squid Software Foundation and contributors
 *
 * Squid software is distributed under GPLv2+ license and includes
 * contributions from numerous individuals and organizations.
 * Please see the COPYING and CONTRIBUTORS files for details.
 */

/*
 Stylesheet for Squid Error pages
 Adapted from design by Free CSS Templates  <A HREF="http://www.freecsstemplates.org">http://www.freecsstemplates.org</A>  Released for free under a Creative Commons Attribution 2.5 License */

/* Page basics */
* {
        font-family: verdana, sans-serif; }

html body {
        margin: 0;
        padding: 0;
        background: #efefef;
        font-size: 12px;
        color: #1e1e1e;
}

/* Page displayed title area */
#titles {
        margin-left: 15px;
        padding: 10px;
        padding-left: 100px;
        background: url('/squid-internal-static/icons/SN.png') no-repeat left; }

/* initial title */
#titles h1 {
        color: #000000;
}
#titles h2 {
        color: #000000;
}

/* special event: FTP success page titles */ #titles ftpsuccess {
        background-color:#00ff00;
        width:100%;
}

/* Page displayed body content area */
#content {
        padding: 10px;
        background: #ffffff;
}

/* General text */
p {
}

/* error brief description */
#error p {
}

/* some data which may have caused the problem */ #data { }

/* the error message received from the system or other software */ #sysmsg { }

pre {
    font-family:sans-serif;
}

/* special event: FTP / Gopher directory listing */ #dirmsg {
    font-family: courier;
    color: black;
    font-size: 10pt;
}
#dirlisting {
    margin-left: 2%;
    margin-right: 2%;
}
#dirlisting tr.entry td.icon,td.filename,td.size,td.date {
    border-bottom: groove;
}
#dirlisting td.size {
    width: 50px;
    text-align: right;
    padding-right: 5px;
}

/* horizontal lines */
hr {
        margin: 0;
}

/* page displayed footer area */
#footer {
        font-size: 9px;
        padding-left: 10px;
}


body
:<i>lang(fa) { direction: rtl; font-size: 100%; font-family: Tahoma, Roya, sans-serif; float: right; }
</I>:<i>lang(he) { direction: rtl; }
</I> --&gt;&lt;/style&gt;
&lt;/head&gt;&lt;body id=ERR_INVALID_URL&gt;
&lt;div id=&quot;titles&quot;&gt;
&lt;h1&gt;ERROR&lt;/h1&gt;
&lt;h2&gt;The requested URL could not be retrieved&lt;/h2&gt; &lt;/div&gt; &lt;hr&gt;

&lt;div id=&quot;content&quot;&gt;
&lt;p&gt;The following error was encountered while trying to retrieve the URL: &lt;a href=&quot;/&quot;&gt;/&lt;/a&gt;&lt;/p&gt;

&lt;blockquote id=&quot;error&quot;&gt;
&lt;p&gt;&lt;b&gt;Invalid URL&lt;/b&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Some aspect of the requested URL is incorrect.&lt;/p&gt;

&lt;p&gt;Some possible problems are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Missing or incorrect access protocol (should be &lt;q&gt;<A HREF="http://&lt;/q">http://&lt;/q</A>&gt; or similar)&lt;/p&gt;&lt;/li&gt; &lt;li&gt;&lt;p&gt;Missing hostname&lt;/p&gt;&lt;/li&gt; &lt;li&gt;&lt;p&gt;Illegal double-escape in the URL-Path&lt;/p&gt;&lt;/li&gt; &lt;li&gt;&lt;p&gt;Illegal character in hostname; underscores are not allowed.&lt;/p&gt;&lt;/li&gt; &lt;/ul&gt;

&lt;p&gt;Your cache administrator is &lt;a href=&quot;mailto:root?subject=CacheErrorInfo%20-%20ERR_INVALID_URL&amp;body=CacheHost%3A%20prd-rbs-squid01-poa.rbs.com.br%0D%0AErrPage%3A%20ERR_INVALID_URL%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Thu,%2018%20May%202017%2018%3A03%3A37%20GMT%0D%0A%0D%0AClientIP%3A%2010.240.64.12%0D%0A%0D%0AHTTP%20Request%3A%0D%0A%0D%0A%0D%0A&quot;&gt;root&lt;/a&gt;.&lt;/p&gt;
&lt;br&gt;
&lt;/div&gt;

&lt;hr&gt;
&lt;div id=&quot;footer&quot;&gt;
&lt;p&gt;Generated Thu, 18 May 2017 18:03:37 GMT by prd-rbs-squid01-poa.rbs.com.br (squid/3.5.20)&lt;/p&gt;
&lt;!-- ERR_INVALID_URL --&gt;
&lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;
* Closing connection 0
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid02-poa</A> ~]#

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# tail -f /var/log/squid/access.log



1495130446.581    439 10.240.64.12 TCP_MISS/200 11869 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_DIRECT/162.243.159.138 application/x-redhat-package-manager
1495130598.008      0 10.240.64.12 TCP_MEM_HIT/200 11877 GET <A HREF="http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm">http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm</A> - HIER_NONE/- application/x-redhat-package-manager
1495130607.437      0 10.240.64.12 TAG_NONE/400 4111 GET /zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm - HIER_NONE/- text/html
1495130617.581      0 10.240.64.12 TAG_NONE/400 3991 GET / - HIER_NONE/- text/html

I will send more on reply to this email because of the size of this email.

Rog&#233;rio Ceni Coelho
Engenheiro de Infraestrutura &#8211; Infrastructure Engineer Diretoria de TI e Telecom - Grupo RBS
Fone: +55 (51) 3218-6983
Celular: +55 (51) 8186-2933 Claro
Celular: +55 (51) 8050-4225 Vivo
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rogerio.coelho at gruporbs.com.br</A>
<A HREF="http://www.gruporbs.com.br">http://www.gruporbs.com.br</A>



Esta mensagem e quaisquer anexos s&#227;o exclusivamente para o uso da parte endere&#231;ada e poder&#227;o conter dados privilegiados e confidenciais. Caso o leitor da mensagem n&#227;o seja a parte a quem ela foi endere&#231;ada, nem um representante autorizado da mesma, ficar&#225; notificado, por meio desta, que qualquer divulga&#231;&#227;o desta comunica&#231;&#227;o &#233; estritamente proibida. Se esta comunica&#231;&#227;o for recebida erroneamente, por favor, notifique-nos disto imediatamente por e-mail e delete a mensagem  e quaisquer anexos a ela de seu sistema.



-----Mensagem original-----
De: Rogerio Coelho
Enviada em: quarta-feira, 24 de maio de 2017 17:03
Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Assunto: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept

Hi Squid Jedi&#180;s,

I am just a little stuck tryng to replace an old Squid 3.1.23 Server on Centos 6 that i use to redirect local web access to port 80 on linux servers to Squid Server.

On my Squid 3.1.23 Server on Centos 6 i use http_port 3128 transparent mode and on my Linux servers clients i use iptables to redirect Web traffic as below ( this config works ):

Squid Server 3.1.23 :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> squid]# cat squid.conf | egrep -v &quot;^#|^$&quot;
acl default_ip req_header x-forward -i &quot;/ipt/SQUID/default/ip&quot;
acl default_url dstdom_regex -i &quot;/ipt/SQUID/default/url&quot;
acl default_ip2 srcdom_regex -i &quot;/ipt/SQUID/default/ip&quot;
http_access allow default_ip default_url acl endereco  req_header x-forward -i &quot;/ipt/SQUID/libera/ip&quot;
http_access allow endereco
acl all_ip req_header x-forward -i &quot;/ipt/SQUID/all/ip&quot;
acl all_url dstdom_regex -i &quot;/ipt/SQUID/all/url&quot;
acl all_ip2 srcdom_regex -i &quot;/ipt/SQUID/all/ip&quot;
http_access allow all_url
acl all src all
acl manager proto cache_object
acl from_localhost src 127.0.0.1/255.255.255.255 acl to_localhost dst 127.0.0.0/8 acl SSL_ports port 443
acl GIT_PORT port 9418         # git
acl CONNECT method CONNECT
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 21 # ftp
acl GIT_PORT2 port 9418 # git
http_access allow manager from_localhost http_access deny manager http_access allow GIT_PORT2 http_access deny !Safe_ports http_access allow CONNECT GIT_PORT http_access deny CONNECT !SSL_ports http_access deny to_localhost http_access allow from_localhost http_access deny all http_port 3128 transparent https_port 3129 transparent intercept cert=/ipt/SQUID/https/squid.crt key=/ipt/SQUID/https/squid.key hierarchy_stoplist cgi-bin ?
emulate_httpd_log on
logformat squid %tg %6tr %&gt;a %{x-forward}&gt;h %Ss/%03&gt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt access_log /var/log/squid/access.log squid access_log syslog:local0.info  squid cache_log /var/log/squid/cache.log cache_store_log /var/log/squid/store.log mime_table /etc/squid/mime.conf pid_filename /var/run/squid.pid acl QUERY urlpath_regex .* cache deny QUERY acl apache rep_header Server ^Apache acl FS_TESTE srcdom_regex -i &quot;/ipt/SQUID/puppet/ip2&quot;
cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">tecnologiaseguranca at gruporbs.com.br</A>
cache_effective_user squid
cache_effective_group squid
coredump_dir /var/spool/squid
maximum_object_size 0 KB
minimum_object_size 0 KB
no_cache deny all
deny_info 172.20.63.73 webapp_ip

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> ~]# iptables -L -n -v -t nat
Chain PREROUTING (policy ACCEPT 46M packets, 3068M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 4581K packets, 276M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 4581K packets, 276M bytes)
 pkts bytes target     prot opt in     out     source               destination
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at leli</A> ~]#

Linux Server Clients ( Centos 5, 6 e 7 ) :

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# cat proxy2.sh
#!/bin/bash

IPTBIN=$(which iptables)

$IPTBIN -t nat -F
$IPTBIN -t nat -X

#SQUID
$IPTBIN -A OUTPUT -s 10.240.68.68 -p tcp --sport 3128 -j ACCEPT

#PROXY
$IPTBIN -t nat -N PROXYSQUID
$IPTBIN -t nat -A OUTPUT -p tcp --dport 80 -j PROXYSQUID $IPTBIN -t nat -A OUTPUT -p tcp --dport 443 -j PROXYSQUID $IPTBIN -t nat -A PROXYSQUID -d 192.168.0.0/16 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 189.76.144.0/20 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 189.76.156.190 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 172.16.0.0/12 -j RETURN $IPTBIN -t nat -A PROXYSQUID -d 10.0.0.0/8 -j RETURN $IPTBIN -t nat -A PROXYSQUID -p tcp -j DNAT --to-destination=10.240.68.68:3128


[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# iptables -L -n -v -t nat Chain PREROUTING (policy ACCEPT 58M packets, 4835M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:443

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           to:10.240.68.68:3128
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# curl -v www.google.com
* About to connect() to www.google.com port 80
*   Trying 216.58.222.68... * connected
* Connected to www.google.com (216.58.222.68) port 80
&gt;<i> GET / HTTP/1.1
</I>User-Agent: curl/7.12.1 (i686-redhat-linux-gnu) libcurl/7.12.1 OpenSSL/0.9.7a zlib/1.2.1.2 libidn/0.5.6
Host: www.google.com
Pragma: no-cache
Accept: */*

&lt; HTTP/1.0 302 Moved Temporarily
&lt; Location: <A HREF="http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag">http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag</A>
&lt; Cache-Control: private
&lt; Content-Type: text/html; charset=UTF-8 &lt; P3P: CP=&quot;This is not a P3P policy! See <A HREF="https://www.google.com/support/accounts/answer/151657?hl=en">https://www.google.com/support/accounts/answer/151657?hl=en</A> for more info.&quot;
&lt; Date: Thu, 18 May 2017 17:38:30 GMT
&lt; Server: gws
&lt; Content-Length: 262
&lt; X-XSS-Protection: 1; mode=block
&lt; X-Frame-Options: SAMEORIGIN
&lt; Set-Cookie: NID=103=Vdks002SayhLjRhSWr_ETgZR2-0Hngh7ci-McE8fBhw6vDhAENt6JxWkTKtPKWen7HL-KYjiSNg9lwXnjSCejhv1va4yIUhPpMDYZ-mK4uDb9FQldR1zp3Y1RiOwx4jX; expires=Fri, 17-Nov-2017 17:38:30 GMT; path=/; domain=.google.com; HttpOnly &lt; X-Cache: MISS from leli.rbs.com.br &lt; X-Cache-Lookup: MISS from leli.rbs.com.br:3128 &lt; Via: 1.0 leli.rbs.com.br (squid/3.1.23)
* HTTP/1.0 connection set to keep alive!
&lt; Connection: keep-alive
&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;
&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;302 Moved&lt;/H1&gt;
The document has moved
&lt;A HREF=&quot;<A HREF="http://www.google.com.br/?gws_rd=cr&amp;amp;ei=FtwdWdaDMYm0wQSWwZ24Ag">http://www.google.com.br/?gws_rd=cr&amp;ei=FtwdWdaDMYm0wQSWwZ24Ag</A>&quot;&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;
* Connection #0 to host www.google.com left intact
* Closing connection #0
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]# iptables -L -n -v -t nat Chain PREROUTING (policy ACCEPT 58M packets, 4835M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 2487K packets, 184M bytes)
 pkts bytes target     prot opt in     out     source               destination
    1    60 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
    0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:443

Chain PROXYSQUID (2 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
    0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
    0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
    0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
    1    60 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           to:10.240.68.68:3128
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at montana</A> rules]#

On my new Squid Server running 3.5.20 on Centos 7 a try to use in many different ways but have no success.

I will send my steps on a new reply email in few minutes because the email size.

Sorry about all this log of information.



Rog&#233;rio Ceni Coelho
Engenheiro de Infraestrutura &#8211; Infrastructure Engineer Diretoria de TI e Telecom - Grupo RBS
Fone: +55 (51) 3218-6983
Celular: +55 (51) 8186-2933 Claro
Celular: +55 (51) 8050-4225 Vivo
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rogerio.coelho at gruporbs.com.br</A>
<A HREF="http://www.gruporbs.com.br">http://www.gruporbs.com.br</A>



Esta mensagem e quaisquer anexos s&#227;o exclusivamente para o uso da parte endere&#231;ada e poder&#227;o conter dados privilegiados e confidenciais. Caso o leitor da mensagem n&#227;o seja a parte a quem ela foi endere&#231;ada, nem um representante autorizado da mesma, ficar&#225; notificado, por meio desta, que qualquer divulga&#231;&#227;o desta comunica&#231;&#227;o &#233; estritamente proibida. Se esta comunica&#231;&#227;o for recebida erroneamente, por favor, notifique-nos disto imediatamente por e-mail e delete a mensagem  e quaisquer anexos a ela de seu sistema.



O Grupo RBS pauta sua atua&#231;&#227;o por seu C&#243;digo de &#201;tica e Conduta, em conformidade com a Legisla&#231;&#227;o Brasileira. Qualquer situa&#231;&#227;o irregular deve ser informada via Canal de &#201;tica pelo site <A HREF="https://www.contatoseguro.com.br/gruporbs">https://www.contatoseguro.com.br/gruporbs</A> ou 0800 602 1831. Este e-mail e seus anexos podem conter informa&#231;&#245;es confidenciais. Se voc&#234; recebeu esta mensagem por engano, por favor apague-a e notifique o remetente imediatamente.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015406.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
	<LI>Next message (by thread): <A HREF="015416.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15407">[ date ]</a>
              <a href="thread.html#15407">[ thread ]</a>
              <a href="subject.html#15407">[ subject ]</a>
              <a href="author.html#15407">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
