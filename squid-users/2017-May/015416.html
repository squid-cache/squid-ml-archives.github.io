<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RES%3A%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%0A%20to%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3C348ff774-79ba-71d9-5aaf-f74ba416ac10%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015407.html">
   <LINK REL="Next"  HREF="015411.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20RES%3A%20New%20Squid%20Server%203.5.20%20on%20Centos%207%20-%20Trying%0A%20to%20redirect%20local%20web%20access%20to%20Port%2080%20on%20Linux%20Servers%20with%20iptables%20to%0A%20Squid%20Server%20with%20http_port%20intercept&In-Reply-To=%3C348ff774-79ba-71d9-5aaf-f74ba416ac10%40treenet.co.nz%3E"
       TITLE="[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 24 21:47:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015407.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
        <LI>Next message (by thread): <A HREF="015411.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15416">[ date ]</a>
              <a href="thread.html#15416">[ thread ]</a>
              <a href="subject.html#15416">[ subject ]</a>
              <a href="author.html#15416">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/05/17 08:16, Rogerio Coelho wrote:
&gt;<i> Using intercept mode with 3129 port :
</I>&gt;<i>
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# cat /etc/squid/squid.conf | egrep -v &quot;^#|^$&quot;
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> &#8230;
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> cache_dir ufs /var/spool/squid 100 16 256
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]#
</I>&gt;<i>
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> ~]# systemctl restart squid
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# systemctl start squid
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at prd-rbs-squid01-poa</A> squid]# cat cache.log
</I>
&gt;<i> 2017/05/18 15:22:29 kid1| Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 17 flags=9
</I>&gt;<i> 2017/05/18 15:22:29 kid1| Accepting NAT intercepted HTTP Socket connections at local=[::]:3129 remote=[::] FD 18 flags=41
</I>

&gt;<i> &#8230;
</I>&gt;<i>   pkts bytes target     prot opt in     out     source               destination
</I>&gt;<i>      0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
</I>&gt;<i>      0     0 PROXYSQUID  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443
</I>&gt;<i>
</I>&gt;<i> Chain POSTROUTING (policy ACCEPT 1 packets, 76 bytes)
</I>&gt;<i> &#8230;
</I>&gt;<i>   pkts bytes target     prot opt in     out     source               destination
</I>&gt;<i>
</I>&gt;<i> Chain PROXYSQUID (2 references)
</I>&gt;<i>   pkts bytes target     prot opt in     out     source               destination
</I>&gt;<i>      0     0 RETURN     all  --  *      *       0.0.0.0/0            192.168.0.0/16
</I>&gt;<i>      0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.144.0/20
</I>&gt;<i>      0     0 RETURN     all  --  *      *       0.0.0.0/0            189.76.156.190
</I>&gt;<i>      0     0 RETURN     all  --  *      *       0.0.0.0/0            172.16.0.0/12
</I>&gt;<i>      0     0 RETURN     all  --  *      *       0.0.0.0/0            10.0.0.0/8
</I>&gt;<i>      0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            to:10.240.64.11:3129
</I>
Two problems visible.

* One you have not yet encountered is that these iptables rules are 
directing port 80 and 443 to the same Squid receiving port. These two 
ports also have very different traffic from each other, more so than 
port 3128 vs 80 and Squid again requires separate receiving port for the 
intercepted port 443 traffic.

To fix this it needs an &quot;http_port ... intercept&quot; line for port-80, and 
a &quot;https_port ... intercept cert=...&quot; line for port-443. Note the extra &quot;s&quot;.


* The second is your current problem; the NAT rules are on a different 
machine to Squid.

Squid uses the kernel NAT state directly to ensure that the traffic is 
going where it was intended to by the client (the ORIGINAL_DST). So it 
cannot work if that needed piece of kernel memory is on another machine.

To fix this you need to use routing to get the TCP packets to the 
relevant Squid machine and do the iptables DNAT (or REDIRECT target) there.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015407.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
	<LI>Next message (by thread): <A HREF="015411.html">[squid-users] RES: New Squid Server 3.5.20 on Centos 7 - Trying to redirect local web access to Port 80 on Linux Servers with iptables to Squid Server with http_port intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15416">[ date ]</a>
              <a href="thread.html#15416">[ thread ]</a>
              <a href="subject.html#15416">[ subject ]</a>
              <a href="author.html#15416">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
