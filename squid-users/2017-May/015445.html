<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid TPROXY issues with Google sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TPROXY%20issues%20with%20Google%20sites&In-Reply-To=%3Cf00f4540-6a5b-ffa3-aa3d-8a4e33d366a4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015442.html">
   <LINK REL="Next"  HREF="015451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid TPROXY issues with Google sites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TPROXY%20issues%20with%20Google%20sites&In-Reply-To=%3Cf00f4540-6a5b-ffa3-aa3d-8a4e33d366a4%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid TPROXY issues with Google sites">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 26 17:00:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015442.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
        <LI>Next message (by thread): <A HREF="015451.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15445">[ date ]</a>
              <a href="thread.html#15445">[ thread ]</a>
              <a href="subject.html#15445">[ subject ]</a>
              <a href="author.html#15445">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/05/17 03:44, Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'd like to block access to Google Mail but allow it to Google Drive. I also need to intercept Google Drive traffic (https) and scan its content via c-icap modules for threats (with clamav and other tools which would block potentially harmful files).
</I>&gt;<i>
</I>&gt;<i> I've failed so far.
</I>&gt;<i>
</I>&gt;<i> I added mail.google.com to a custom file named &quot;denied.domains&quot; and loaded as denied_domains ACL in Squid. I know that in TLS traffic there are only IP addresses, so I created the &quot;server_name&quot; ACL as seen below.
</I>
Erm, not quite. The raw-IP having to be dealt with comes from the use of 
TPROXY (or NAT), not TLS. It is used when Squid is deciding whether to 
permit the traffic on the TCP connection to be processed.

Once the TLS is received (by &quot;peek&quot;) the TLS SNI (if any) becomes available.


&gt;<i> [...]
</I>&gt;<i> acl denied_domains dstdomain &quot;/usr/local/share/proxy-settings/denied.domains&quot;
</I>&gt;<i> http_access deny denied_domains !allowed_groups !allowed_ips
</I>&gt;<i> http_access deny CONNECT denied_domains !allowed_groups !allowed_ips
</I>&gt;<i> [...]
</I>&gt;<i> reply_header_access Alternate-Protocol deny all
</I>&gt;<i> acl AllowTroublesome ssl::server_name .google.com .gmail.com
</I>&gt;<i> acl DenyTroublesome ssl::server_name mail.google.com
</I>&gt;<i> http_access deny DenyTroublesome
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice AllowTroublesome
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> First of all, I was expecting that if a client tried to open <A HREF="https://mail.google.com,">https://mail.google.com,</A> the connection would be blocked by Squid (DenyTroublesome ACL). It isn't. Why?
</I>
Any of the http_access lines you omitted from the config snippet might 
be letting it through. Order is important, and knowing the whole 
http_access sequence (and more) is just as important to correctly answer 
a question such as this. So take the below with a grain of salt, I am 
assuming nothing else in your config has subtle effects on the 
processing outcome.

There are several things that can lead to it;

* Google servers do have working rDNS. So raw-IP becomes a server 
hostname for dstdomain ACL to match.
  - the rDNS is within *.1e1.net so will not match your list shown, but 
it is enough to possibly evade your IP rules.

* If no provides access control lines match Squid inverted the action on 
the last one and does that.
   - yours are all deny, so the implicit action there is &quot;allow all&quot;

* &quot;ssl_bump peek all&quot; fetches the TLS SNI server name for 
ssl::server_name ACL to match.
  - so by the time Squid gets to processing the AllowTroublesome it 
already knows the client is trying to reach a *.google.com domain.

&gt;<i> Second, I am unable to scan content since Squid is splicing all Google traffic. However, if I &quot;bump AllowTroublesome&quot;, I can enter my username in <A HREF="https://accounts.google.com,">https://accounts.google.com,</A> but trying to access to the next step (user password) fails with an unreported error.
</I>&gt;<i>
</I>&gt;<i> Any suggestions?
</I>
The rest of your related squid.conf is needed for that, including 
details of the files includes into the ACLs. In particular it is not 
clear what this &quot;unreported error&quot; is or why it happens.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015442.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
	<LI>Next message (by thread): <A HREF="015451.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15445">[ date ]</a>
              <a href="thread.html#15445">[ thread ]</a>
              <a href="subject.html#15445">[ subject ]</a>
              <a href="author.html#15445">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
