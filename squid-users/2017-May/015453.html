<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid TPROXY issues with Google sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TPROXY%20issues%20with%20Google%20sites&In-Reply-To=%3C4f6e6441-cda6-c7fc-0cee-1d32e0822671%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015451.html">
   <LINK REL="Next"  HREF="015457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid TPROXY issues with Google sites</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TPROXY%20issues%20with%20Google%20sites&In-Reply-To=%3C4f6e6441-cda6-c7fc-0cee-1d32e0822671%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid TPROXY issues with Google sites">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat May 27 01:53:22 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015451.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
        <LI>Next message (by thread): <A HREF="015457.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15453">[ date ]</a>
              <a href="thread.html#15453">[ thread ]</a>
              <a href="subject.html#15453">[ subject ]</a>
              <a href="author.html#15453">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/26/2017 05:22 PM, Vieri wrote:

&gt;<i> If I have this:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice AllowTroublesome
</I>&gt;<i> ssl_bump bump all
</I>
... then you have a configuration that does not make sense because one
cannot bump after peeking at step2. Your configuration is equivalent to

  * if the current step is 1 or 2, then peek
  * if AllowTroublesome during step 3, then splice
  * otherwise, do the impossible

which, bugs notwithstanding, is equivalent to

  ssl_bump peek all
  ssl_bump splice all

If the above does not block anything then your http_access rules allow
all CONNECTs (and you never get beyond CONNECTs because you do not bump).


&gt;<i> If I replace the above snippet with this:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump all
</I>
This configuration makes sense (but it may not do what you want).

If you want to be able to make a &quot;splice or bump&quot; decision, then you
have to make it during step2:

  ssl_bump peek step1
  ssl_bump splice AllowTroublesome
  ssl_bump bump all


&gt;<i> If I had an http_access rule that allowed the transaction to take
</I>&gt;<i> place then I would expect it to happen regardless of the ssl_bump
</I>&gt;<i> directive.
</I>
Your expectations are wrong. SslBump directives expose http_access rules
to more (or fewer) transactions. For example, the &quot;splice all&quot;
configuration does not expose http_access rules to any GET requests.


&gt;<i> Alex, you mention the SSLPeekAndSplice web page. I'll try to sum it
</I>&gt;<i> up in just a few lines
</I>
The SslBump feature is too complex to sum it up in just a few lines
unless those lines are something like &quot;do not use it without fully
understanding it&quot;. Once you learn the basics of SSL handshake, which
Squid steps look at what parts of the handshake, and what the essential
difference between peeking and staring is, then SslBump becomes less of
black magic. Without that knowledge, it is a dark mystery.


&gt;<i> - peek implies splice which means you can't do content analysis (as
</I>&gt;<i> in scan for threats via c-icap modules)
</I>
Wrong. Peeking at step1 does not preclude future bumping. Peeking at
step2 precludes future bumping. If you peek at step2, then you have to
splice or terminate at step3.


&gt;<i> - stare implies bump which means you can do content analysis
</I>
Wrong for similar/symmetrical reasons.


&gt;<i> - you don't need to stare, you can just bump
</I>
Wrong in many cases -- usually you _do_ need to stare (or peek) at least
at step1, but YMMV.


&gt;<i> - you need to stare before bump if you want the clients to accept a
</I>&gt;<i> certificate with domain names instead of IP addresses
</I>
Misleading. You need to stare or peek to get more information, including
the server domain name. That information comes from either the client or
the server, depending on the step. That information is used to generate
a fake certificate. The more info Squid has, the better it can
fake/mimic the true certificate, but learning more information restricts
the set of ssl_bump actions.


&gt;<i> - you can bump first by ACLs and then splice the rest
</I>
If you mean that ssl_bump rules may start with &quot;bump&quot; rules and end with
&quot;splice&quot; rules, then this is true, but the reverse is also true, and the
rules may contain a mixture of many actions.


&gt;<i> - you can bump after peek but only if you do that at SslBump1
</I>
Too vague to be generally useful. You can bump after peeking at step1.
You cannot bump after peeking at step2.


&gt;<i> the &quot;Bump All Sites Except Banks&quot; example where the next
</I>&gt;<i> phrase contradicts the title by saying that the requests to non-banks
</I>&gt;<i> won't be bumped.
</I>
Correct! The example, the title, and the warning were written by
different people. One of them is right. If you know how SslBump works,
you know which part is correct. At that time, please feel free to
propose changes to fix the wiki page. Hundreds of folks receive SslBump
help on this mailing list, but only one of them took the pains to
improve the page afterwards (thank you again, Marcus Kool!). Parts of
that page still need a lot of work.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015451.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
	<LI>Next message (by thread): <A HREF="015457.html">[squid-users] Squid TPROXY issues with Google sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15453">[ date ]</a>
              <a href="thread.html#15453">[ thread ]</a>
              <a href="subject.html#15453">[ subject ]</a>
              <a href="author.html#15453">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
