<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to intercept ssl_bump transparent NAT https websites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20intercept%20ssl_bump%20transparent%20NAT%20https%0A%20websites&In-Reply-To=%3C93f53090-4c66-62fa-cf38-daeeb33ebf42%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015463.html">
   <LINK REL="Next"  HREF="015478.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to intercept ssl_bump transparent NAT https websites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20intercept%20ssl_bump%20transparent%20NAT%20https%0A%20websites&In-Reply-To=%3C93f53090-4c66-62fa-cf38-daeeb33ebf42%40treenet.co.nz%3E"
       TITLE="[squid-users] How to intercept ssl_bump transparent NAT https websites">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun May 28 22:03:49 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="015463.html">[squid-users] How to intercept ssl_bump transparent NAT https	websites
</A></li>
        <LI>Next message (by thread): <A HREF="015478.html">[squid-users] How to intercept ssl_bump transparent NAT	httpswebsites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15467">[ date ]</a>
              <a href="thread.html#15467">[ thread ]</a>
              <a href="subject.html#15467">[ subject ]</a>
              <a href="author.html#15467">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/05/17 07:52, Andi wrote:
&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i>     I installed Squid 3.5.25 at debian with libecap3 too.
</I>&gt;<i>
</I>&gt;<i>     Now my old squid.conf file for v3.48 not work anymore for
</I>&gt;<i>     redirected https websites.
</I>&gt;<i>     I get SSL_ERROR_RX_RECORD_TOO_LONG in Firefox.
</I>&gt;<i>     I redirected them before by Shorewall and it worked with v3.48
</I>&gt;<i>     #SQUID-PORTS
</I>&gt;<i>     REDIRECT    loc    3140 tcp    https    - !192.168.1.254
</I>&gt;<i>     REDIRECT    loc    3139 tcp    www    - !192.168.1.254
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     If I change https_port to http_port and remove the intercept
</I>&gt;<i>     option for ssl_bump it works with expicit configured clients for
</I>&gt;<i>     that port even for gmail website too.
</I>&gt;<i>     What I need to change to make squid 3.5 work transparently  ?
</I>&gt;<i>
</I>
SSL_ERROR_RX_RECORD_TOO_LONG is apparently what gets displayed if the 
response coming back from an attempted TLS/SSL connection is not TLS/SSL 
protocol. Such as Squid responding with an HTTP error message, or 
something like that happening.


Your below config has port 3128 for explicit-proxy traffic, port 3139 
for intercepted port 80 traffic, and 3140 for intercepted port 443 traffic.

Your log startup confirms that:

 &gt; 2017/05/28 16:07:55.701| Accepting HTTP Socket connections at 
local=0.0.0.0:3138 remote=[::] FD 28 flags=9
 &gt; 2017/05/28 16:07:55.702| Accepting NAT intercepted HTTP Socket 
connections at local=0.0.0.0:3139 remote=[::] FD 29 flags=41
 &gt; 2017/05/28 16:07:55.702| Accepting NAT intercepted SSL bumped HTTPS 
Socket connections at local=0.0.0.0:3140 remote=[::] FD 30 flags=41


The first thing I would check is that the shorewall definitions of 
&quot;https&quot; and &quot;www&quot; are actually 80 and 443 respectively.

Then try to find out what Squid is sending to Firefox that would result 
in that particular error. I suspect either ICAP or SquidGuard is trying 
to change or produce a plan-text response to the initial CONNECT 
messages Squid uses internally for the SSL-Bump steps.



NP: the &quot;abandoning&quot; messages in cache.log are nothing to worry about 
when you are ssl-bump'ing with Squid-3, it is just an annoying 
side-effect of how SSL-Bump takes the connection away from the normal 
CONNECT tunnel handling code. IIRC it has been fixed in Squid-4 along 
with a lot of similar little PITA things.

PS. I've highlighted some improvements you can make to the config below. 
They are not related to your problem though.

&gt;<i>     squid -v
</I>&gt;<i>     Squid Cache: Version 3.5.25
</I>&gt;<i>     Service Name: squid
</I>&gt;<i>     configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr'
</I>&gt;<i>     '--localstatedir=/var/squid' '--libexecdir=/lib/squid'
</I>&gt;<i>     '--srcdir=.' '--datadir=/share/squid' '--sysconfdir=/etc/squid'
</I>&gt;<i>     '--disable-ipv6' '--with-default-user=proxy'
</I>&gt;<i>     '--with-logdir=/var/log/squid35'
</I>&gt;<i>     '--with-pidfile=/var/run/squid35.pid' '--with-openssl'
</I>&gt;<i>     '--enable-ssl-crtd' '--infodir=/share/info'
</I>&gt;<i>     '--includedir=/include' '--mandir=/usr/share/man'
</I>&gt;<i>     '--enable-inline' '--disable-arch-native'
</I>&gt;<i>     '--disable-maintainer-mode' '--disable-dependency-tracking'
</I>&gt;<i>     '--disable-silent-rules' '--enable-async-io=8'
</I>&gt;<i>     '--enable-storeio=ufs,aufs,diskd,rock'
</I>&gt;<i>     '--enable-removal-policies=lru,heap' '--enable-delay-pools'
</I>&gt;<i>     '--enable-cache-digests' '--enable-icap-client'
</I>&gt;<i>     '--enable-follow-x-forwarded-for'
</I>&gt;<i>     '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'
</I>&gt;<i>     '--enable-auth-digest=file,LDAP'
</I>&gt;<i>     '--enable-auth-negotiate=kerberos,wrapper'
</I>&gt;<i>     '--enable-auth-ntlm=fake,smb_lm'
</I>&gt;<i>     '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group'
</I>&gt;<i>     '--enable-url-rewrite-helpers=fake' '--enable-eui' '--enable-esi'
</I>&gt;<i>     '--enable-icmp' '--enable-zph-qos' '--enable-ecap'
</I>&gt;<i>     '--disable-translation' '--with-filedescriptors=65536'
</I>&gt;<i>     '--with-large-files' '--enable-linux-netfilter' 'CFLAGS=-g -O2
</I>&gt;<i>     -fPIE -fstack-protector-strong -Wformat -Werror=format-security
</I>&gt;<i>     -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now'
</I>&gt;<i>     'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE
</I>&gt;<i>     -fstack-protector-strong -Wformat -Werror=format-security'
</I>&gt;<i>     'build_alias=x86_64-linux-gnu'
</I>&gt;<i>
</I>&gt;<i>     cat /etc/squid/squid.conf:
</I>&gt;<i>     debug_options ALL,6
</I>&gt;<i>     #0 26,2 83,2 33,2 17,2 44,2
</I>&gt;<i>     logformat datetime  %tl %6tr CLIENT:%&gt;a = = %Ss %&lt;Hs %rm=%&gt;ru
</I>&gt;<i>     --%[un %Sh/%&lt;a %mt
</I>&gt;<i>     access_log  /var/log/squid35/access.log datetime
</I>&gt;<i>     forwarded_for on
</I>&gt;<i>     error_directory /usr/share/squid/errors/de-de/
</I>&gt;<i>
</I>
Have you altered or otherwise touched the files in that directory?
If not I suggest using this instead:

   error_default_language de-de
&lt;<A HREF="http://master.squid-cache.org/Doc/config/error_default_language/">http://master.squid-cache.org/Doc/config/error_default_language/</A>&gt;

&gt;<i>     acl localnet src 192.168.1.0/24
</I>&gt;<i>     acl SSL_ports port 443
</I>&gt;<i>     acl Safe_ports port 80          # http
</I>&gt;<i>     acl Safe_ports port 21          # ftp
</I>&gt;<i>     acl Safe_ports port 443         # https
</I>&gt;<i>     acl Safe_ports port 70          # gopher
</I>&gt;<i>     acl Safe_ports port 210         # wais
</I>&gt;<i>     acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i>     acl Safe_ports port 280         # http-mgmt
</I>&gt;<i>     acl Safe_ports port 488         # gss-http
</I>&gt;<i>     acl Safe_ports port 591         # filemaker
</I>&gt;<i>     acl Safe_ports port 777         # multiling http
</I>&gt;<i>     acl CONNECT method CONNECT
</I>&gt;<i>     http_access deny !Safe_ports
</I>&gt;<i>     http_access deny CONNECT !SSL_ports
</I>&gt;<i>     http_access allow localhost manager
</I>&gt;<i>     http_access deny manager
</I>&gt;<i>     http_access deny to_localhost
</I>&gt;<i>     http_access allow localnet
</I>&gt;<i>     http_access allow localhost
</I>&gt;<i>     http_reply_access allow all
</I>&gt;<i>
</I>
No need to explicitly &quot;allow all&quot; for replies. That happens anyway. That 
directive is mostly useful to deny things.


&gt;<i>     http_access deny all
</I>&gt;<i>     icp_access allow localnet
</I>&gt;<i>     icp_access deny all
</I>&gt;<i>     ### NEW for v3.5x SSL-Bump ###
</I>&gt;<i>     always_direct allow all
</I>&gt;<i>
</I>
That &quot;always_direct&quot; was a hack to workaround a bug in the first 
ssl-bump code. It is long since irrelevant. I recommend removing it.

&gt;<i>     acl step1 at_step SslBump1
</I>&gt;<i>     acl step2 at_step SslBump2
</I>&gt;<i>     acl step3 at_step SslBump3
</I>&gt;<i>     ssl_bump splice localhost
</I>&gt;<i>     #acl exclude_sites ssl::server_name_regex -i
</I>&gt;<i>     &quot;/var/lib/squidguard/db/BL/whitelist-ssl/whitelist.destdomainlist&quot;
</I>&gt;<i>     ssl_bump peek step1 all
</I>&gt;<i>     #ssl_bump splice exclude_sites
</I>&gt;<i>     ssl_bump stare step2 all
</I>&gt;<i>
</I>
You don't need the &quot;all&quot; on the above lines. The &quot;step2 all&quot; is both 
unnecessary and adds confusion since that line does *not* apply to all 
step2 traffic - some was spliced instead by the previous line.

&gt;<i>     ssl_bump bump all
</I>&gt;<i>     #############################
</I>&gt;<i>     http_port 0.0.0.0:3138
</I>&gt;<i>     http_port 0.0.0.0:3139 intercept
</I>&gt;<i>     sslproxy_cert_adapt setCommonName ssl::certDomainMismatch
</I>&gt;<i>     https_port 0.0.0.0:3140 intercept ssl-bump
</I>&gt;<i>     generate-host-certificates=on dynamic_cert_mem_cache_size=16MB
</I>&gt;<i>     cert=/etc/squid/myca.pem
</I>&gt;<i>     sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;<i>     sslproxy_capath /etc/ssl/certs
</I>&gt;<i>     ##sslproxy_cafile /etc/ssl/certs/ca-certificates.crt
</I>&gt;<i>     sslcrtd_program /bin/ssl_crtd -s /var/spool/squid_ssldb -M 16MB
</I>&gt;<i>     sslcrtd_children 10
</I>&gt;<i>     cache_dir ufs /etc/squid/ssl_db 100 16 256
</I>&gt;<i>
</I>
Why are you storing all cacheable *HTTP* objects into /etc/squid/ssl_db ?
  especially since your SSL certificate store is /var/spool/squid_ssldb ?

&gt;<i>     cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at mainrouter</A>
</I>&gt;<i>     visible_hostname xxx
</I>&gt;<i>     httpd_suppress_version_string on
</I>&gt;<i>     coredump_dir /var/spool/squid
</I>&gt;<i>     refresh_pattern ^ftp: 1440    20%     10080
</I>&gt;<i>     refresh_pattern ^gopher: 1440    0%      1440
</I>&gt;<i>     refresh_pattern -i (/cgi-bin/|\?) 0 0%      0
</I>&gt;<i>     refresh_pattern                0       20%     4320
</I>&gt;<i>     cache_effective_user proxy
</I>&gt;<i>
</I>
You built this proxy with --with-default-user=proxy , which sets the 
default value of cache_effective_user to &quot;proxy&quot;, no need to repeat that 
in squid.conf.

&gt;<i>     icap_enable on
</I>&gt;<i>     icap_send_client_ip on
</I>&gt;<i>     icap_send_client_username on
</I>&gt;<i>     icap_client_username_encode off
</I>&gt;<i>     icap_client_username_header X-Authenticated-User
</I>&gt;<i>     icap_preview_enable on
</I>&gt;<i>     icap_preview_size 1024
</I>&gt;<i>     icap_service service_req reqmod_precache bypass=0
</I>&gt;<i>     <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i>     icap_service service_resp respmod_precache bypass=0
</I>&gt;<i>     <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;<i>     adaptation_access service_req allow all
</I>&gt;<i>     adaptation_access service_resp allow all
</I>&gt;<i>     redirect_program /usr/bin/squidGuard -c
</I>&gt;<i>     /etc/squidguard/squidGuard.conf
</I>&gt;<i>     cache_effective_group proxy
</I>&gt;<i>
</I>
There should be no need for that cache_effective_group directive to be 
used. Simply check and limit the groups the cache_effective_user account 
is a member of.

&gt;<i>     dns_nameservers 8.8.8.8
</I>&gt;<i>
</I>
Using that DNS service directly in Squid is particularly nasty. Each DNS 
query usually hits a different server in their farm and thus gets 
different set of response IP addresses. I strongly recommend that you 
setup some local DNS recursive resolver that both the clients and Squid 
can use. That resolver can of course pass its traffic to 8.8.8.8 if you 
actually need to.



Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="015463.html">[squid-users] How to intercept ssl_bump transparent NAT https	websites
</A></li>
	<LI>Next message (by thread): <A HREF="015478.html">[squid-users] How to intercept ssl_bump transparent NAT	httpswebsites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15467">[ date ]</a>
              <a href="thread.html#15467">[ thread ]</a>
              <a href="subject.html#15467">[ subject ]</a>
              <a href="author.html#15467">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
