<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] can't block streaming
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20block%20streaming&In-Reply-To=%3C4c084243-8480-9d8b-6caf-ff6c9d503b3a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016786.html">
   <LINK REL="Next"  HREF="016811.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] can't block streaming</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20block%20streaming&In-Reply-To=%3C4c084243-8480-9d8b-6caf-ff6c9d503b3a%40treenet.co.nz%3E"
       TITLE="[squid-users] can't block streaming">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov  1 12:52:28 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016786.html">[squid-users] Using HTTP headers in a store ID helper -- possible?
</A></li>
        <LI>Next message (by thread): <A HREF="016811.html">[squid-users] can't block streaming
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16787">[ date ]</a>
              <a href="thread.html#16787">[ thread ]</a>
              <a href="subject.html#16787">[ subject ]</a>
              <a href="author.html#16787">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/11/17 21:54, Vacheslav wrote:
&gt;<i> Thanks for your time,
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Amos Jeffries
</I>&gt;<i> Sent: Tuesday, October 31, 2017 5:45 PM
</I>&gt;<i> 
</I>&gt;<i> On 31/10/17 22:05, Vacheslav wrote:
</I>&gt;&gt;<i> Peace,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tired searching and debugging but I couldn&#8217;t find a solution,
</I>&gt;&gt;<i> whatever I do youtube keeps working.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is my configuration:
</I>&gt;<i> ...
</I>&gt;&gt;<i> # Media Streams
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ## MediaPlayer MMS Protocol
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl media rep_mime_type mms
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl mediapr url_regex dvrplayer mediastream ^<A HREF="mms://">mms://</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ## (Squid does not yet handle the URI as a known proto type.)
</I>&gt;<i> 
</I>&gt;&gt;<i> Unsupported URI schemes should result in the client receiving an HTTP error page instead of Squid handling the traffic.
</I>&gt;<i> 
</I>&gt;&gt;<i> Which also explains your problems: the Browser is either not using the proxy at all for this traffic, or sending the traffic through a CONNECT tunnel that is allowed to be created for other reasons.
</I>&gt;<i> 
</I>&gt;<i> Well I tried unchecking automatically detect proxy settings. There are 2 network cards on the squid, one with a gateway, the same  is used as the proxy ip port 3128 and youtube is not in the bypass proxylist. I tried using opera, the same result.
</I>
Things like YT do not have to be on any bypass list to avoid the proxy. 
It just has to have a URL scheme for some protocol the browser detects 
as not able to go through the HTTP-only proxy. eg &quot;mms:&quot;

Since <A HREF="mms://">mms://</A> means a non-HTTP protocol and it is not commonly supported 
by HTTP proxies, the browsers usually send it directly to the mms 
protocol port(s) AFAIK.


&gt;<i> What do you mean by a connect tunnel?
</I>
Things like this:

&quot;
  CONNECT r1---sn-ntqe6n76.googlevideo.com:443 HTTP/1.1

  ... non-HTTP data stream.
&quot;

Which tells Squid to open a TCP connection to the named server and port. 
That is how a YouTube video I'm watching right now is currently going 
through a test Squid. The browser of course shows it as a GET request 
for some https: URI, but the proxy only sees that CONNECT.

To see what is inside that particular port 443 tunnel one has to use 
SSL_Bump feature to decrypt the HTTPS protocol that is supposed to be on 
that port.


&gt;<i> ...
</I>&gt;<i> 
</I>&gt;&gt;<i> # We strongly recommend the following be uncommented to protect
</I>&gt;&gt;<i> innocent
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #http_access deny to_localhost
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Deny all blocked extension
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> error_directory /usr/share/squid/errors/en
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> deny_info ERR_BLOCKED_FILES blockfiles
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny blockfiles
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> Please read the above line, and consider all the custom rules you placed above it.
</I>&gt;<i> I moved the below text to under
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> 
</I>&gt;<i> http_access deny mediapr
</I>&gt;<i> http_access deny mediapr1
</I>&gt;<i> http_access deny mediapr2
</I>&gt;<i> http_access deny mediapr3
</I>&gt;<i> http_reply_access deny media
</I>&gt;<i> ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #url_rewrite_program /usr/sbin/squidGuard
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #url_rewrite_children 5
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #debug_options ALL,1 33,2 28,9
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And where must I place the before last 2 lines in order for squid
</I>&gt;&gt;<i> guard to work?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> Right there where they are in your config will do.
</I>&gt;<i> 
</I>&gt;&gt;<i> What do you expect SquidGuard to do?
</I>&gt;<i> 
</I>&gt;<i> At first, I thought squid guard is needed to block file extension, then I discovered that it blocks urls so it is not a bad idea to block porn sites and porn search terms.
</I>
Ah, I see. Well, if you are new to it I advise to try using squid.conf 
ACLs first. Sending things to helpers is quite I/O and memory intensive 
and most of what SG does can be done better by modern Squid.

Also, SquidGuard specifically is very outdated software and no longer 
maintained. If you have to do access control in a helper at all it is 
better to use the external_acl_type interface and other helpers that 
meet the more specific need.


&gt;<i> 
</I>&gt;&gt;<i> If Squid itself cannot identify any URLs with &quot;<A HREF="mms://">mms://</A>&quot; scheme there is no hope of SG being passed the non-existent URLs.
</I>&gt;<i> 
</I>&gt;<i> This I didn't digest!
</I>&gt;<i> 
</I>
See above with the CONNECT example. *If* the request is actually going 
through the proxy, the URI as far as Squid can see would be something 
like &quot;r1---sn-ntqe6n76.googlevideo.com:443&quot;, or maybe just a raw-IP and 
port.

So what Squid can pass the URI helper is only that origin-form URI, not 
the encrypted (if HTTPS) or tunneled (if non-HTTP/HTTPS) absolute-URI 
stuff where the scheme is.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016786.html">[squid-users] Using HTTP headers in a store ID helper -- possible?
</A></li>
	<LI>Next message (by thread): <A HREF="016811.html">[squid-users] can't block streaming
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16787">[ date ]</a>
              <a href="thread.html#16787">[ thread ]</a>
              <a href="subject.html#16787">[ subject ]</a>
              <a href="author.html#16787">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
