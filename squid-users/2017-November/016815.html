<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5 ICAP Problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%20ICAP%20Problems&In-Reply-To=%3Cdaa7ff32f506df9a3945574b6acf5e8d%40data-core.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016814.html">
   <LINK REL="Next"  HREF="016816.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5 ICAP Problems</H1>
    <B>Flashdown</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%20ICAP%20Problems&In-Reply-To=%3Cdaa7ff32f506df9a3945574b6acf5e8d%40data-core.org%3E"
       TITLE="[squid-users] Squid 3.5 ICAP Problems">flashdown at data-core.org
       </A><BR>
    <I>Fri Nov  3 14:16:11 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016814.html">[squid-users] Squid 3.5 ICAP Problems
</A></li>
        <LI>Next message (by thread): <A HREF="016816.html">[squid-users] Squid 3.5 ICAP Problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16815">[ date ]</a>
              <a href="thread.html#16815">[ thread ]</a>
              <a href="subject.html#16815">[ subject ]</a>
              <a href="author.html#16815">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Guys,

I also have a long term issue with C-ICAP on many servers in different 
countries.

It looks like an ICAP Queue overload happening within squid. Since after 
taking a lot time in order to fine tune and debug the C-ICAP Service and 
the clamav-daemon in order to ensure that it can handle the high load 
and is configured properly, the ICAP suspended, down and UP messages 
dissappeared entirely in the cache.log, which I had after some days, 
then some weeks (after tuning the ICAP Server even more) occuring and 
after some messages the performance become steady slow until squid 
service is restarted. So now I have fixed the C-ICAP Server that is 
using squidclamav as C-ICAP Module for in-stream scanning. 
<A HREF="http://squidclamav.darold.net/,">http://squidclamav.darold.net/,</A> So I no longer can see any C-ICAP DOWN 
and UP Messages anymore. Which tells me that C-ICAP seems to always have 
enough workers to take the load.

So as I said now after finalizing my C-ICAP Server fine tuning, 
reconfiguration and debugging. I have no more ICAP Up and down messages 
and now after some weeks squid became slow again. When restarting the 
squid service all works fine again until some day in some weeks where it 
becomes slow again until service restart.

So I guess I need to set the right debug options for you guys, but that 
would create a very big log file since it takes days or weeks until this 
issue is happening. Any suggestions on what you think how I can do 
debugging in the best way?


BTW: I hope I do not mix up issues here, but it seems to be related to 
my issue that I am face since I was moving to a newer Version back in 
the old days then squid 3.5.12 &lt;- somewhere there this story started for 
me. Unsure if it was exactliy starting with this version, some versions 
later or some earlier. But well it definitely was not happening on 
3.5.10 or earlier, so here I can cut it a  bit. So the issue was 
definitely introduced somewhere between 3.5.11 until 3.5.18. But as I 
said now I can at least fully outline the C-ICAP Server, which the cache 
log confirms by not showing any down, suspended and up messages any 
more.

I believe when I enforce a service restart once in the night, I will 
never see this issue of slow performance caused by the C-ICAP Module 
within squid anymore.

Best regards,
Enrico/Flashdown



Am 2017-11-03 12:54, schrieb Eliezer Croitoru:
&gt;<i> I'm not sure but after testing with telnet  or\and nc you can try to
</I>&gt;<i> verify the open files limits on the system which might cause this
</I>&gt;<i> issue.
</I>&gt;<i> To identify how many connections are opened to the service you can use
</I>&gt;<i> netstat or ss tools.
</I>&gt;<i> netstat -ntp
</I>&gt;<i> 
</I>&gt;<i> and a similar on ss.
</I>&gt;<i> 
</I>&gt;<i> Also it's a good practice to put an ICAP periodic(2-20 seconds
</I>&gt;<i> apparat) with an OPTIONS request to make sure that the service is
</I>&gt;<i> alive.
</I>&gt;<i> If you want my testing script let me know.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>]
</I>&gt;<i> On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Thursday, November 2, 2017 19:22
</I>&gt;<i> To: Stephen Stark &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">logic4life at gmail.com</A>&gt;; 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Squid 3.5 ICAP Problems
</I>&gt;<i> 
</I>&gt;<i> On 11/02/2017 10:29 AM, Stephen Stark wrote:
</I>&gt;&gt;<i> Adaptation::Icap::Xaction::noteCommConnected(local=[::]
</I>&gt;&gt;<i> remote=127.0.0.1:1344 flags=1, errno=101, ...
</I>&gt;<i> 
</I>&gt;<i> The logs you have provided do not show where/why exactly the TCP
</I>&gt;<i> connection to the ICAP service fails, but error number 101 is probably
</I>&gt;<i> &quot;network unreachable&quot;. This is unusual but not impossible for
</I>&gt;<i> localhost traffic. The next step depends on the failure cause. There
</I>&gt;<i> are at least two major cases to consider:
</I>&gt;<i> 
</I>&gt;<i> A) If Squid sends packets to 127.0.0.1:1344, then you can easily
</I>&gt;<i> reproduce the problem using something like &quot;telnet&quot; or &quot;nc&quot; on the
</I>&gt;<i> Squid box command line. Just make sure you use the right _source_ IP
</I>&gt;<i> address for the connection! It has to be the same source IP address
</I>&gt;<i> that Squid is using. It might not be 127.0.0.1. Running that command
</I>&gt;<i> as Squid user might also be important if the Squid box have some fancy
</I>&gt;<i> user-specific networking restrictions.
</I>&gt;<i> 
</I>&gt;<i> B) If Squid does not send packets to 127.0.0.1:1344, then one can
</I>&gt;<i> figure out what goes wrong by studying relevant ALL,9 logs. You may
</I>&gt;<i> also want to address other errors or warnings Squid logs to cache.log
</I>&gt;<i> (if any).
</I>&gt;<i> 
</I>&gt;<i> You can determine whether Squid sends packets to 127.0.0.1:1344 by
</I>&gt;<i> collecting a packet trace (for all Squid box interfaces!) and/or
</I>&gt;<i> running strace (for the Squid worker process).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016814.html">[squid-users] Squid 3.5 ICAP Problems
</A></li>
	<LI>Next message (by thread): <A HREF="016816.html">[squid-users] Squid 3.5 ICAP Problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16815">[ date ]</a>
              <a href="thread.html#16815">[ thread ]</a>
              <a href="subject.html#16815">[ subject ]</a>
              <a href="author.html#16815">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
