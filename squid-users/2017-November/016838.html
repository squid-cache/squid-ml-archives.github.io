<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C96e5ae3d-6dc6-fca3-7c70-b038ecf16ddf%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016836.html">
   <LINK REL="Next"  HREF="016854.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C96e5ae3d-6dc6-fca3-7c70-b038ecf16ddf%40treenet.co.nz%3E"
       TITLE="[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov  8 04:23:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016836.html">[squid-users] Non intrusive sslbump for whitelisting (asked	many times but..)
</A></li>
        <LI>Next message (by thread): <A HREF="016854.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16838">[ date ]</a>
              <a href="thread.html#16838">[ thread ]</a>
              <a href="subject.html#16838">[ subject ]</a>
              <a href="author.html#16838">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/11/17 12:18, A. Benz wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ## Intro
</I>&gt;<i> 
</I>&gt;<i> I read many blogs and emails on this list related to what I'm trying to 
</I>&gt;<i> do, but most go into bumping or do things that are not as simple as I'm 
</I>&gt;<i> trying to achieve.
</I>&gt;<i> 
</I>&gt;<i> I have an extremely slow line, with very high latency in a remote 
</I>&gt;<i> location. About 14 people are sharing this line. Nowadays with all the 
</I>&gt;<i> mobile apps trying to sync and such, the line stalls to unusable all the 
</I>&gt;<i> time.
</I>&gt;<i> 
</I>&gt;<i> I tried doing filters with firewall or dns level, but those are not 
</I>&gt;<i> effective. In the end I figured squid might be my best option.
</I>&gt;<i> 
</I>&gt;<i> ## End intro
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have squid 3.5.27 running under LEDE (OpenWrt fork), ie its 
</I>&gt;<i> cross-compiled for a MIPS based SoC (mediatek mt7621). I mention this 
</I>&gt;<i> because you will see some options in the config file that won't make 
</I>&gt;<i> sense otherwise.
</I>&gt;<i> 
</I>
NP: That should not be making much difference to the squid.conf 
settings. The worst limitations such devices impose are things that 
should be solved by OS settings outside of squid.conf. eg the cache.log 
going to a pipe for remote logging instead of a filename, and 
system-level FD limits.


&gt;<i> It works great, here's what I'm trying to achieve: Allow access only to 
</I>&gt;<i> a pre-defined list of websites (whitelist). http is straightforward, but 
</I>&gt;<i> if the connection is https all I need to know is domain, if its allowed, 
</I>&gt;<i> let it pass, otherwise terminate.
</I>&gt;<i> 
</I>&gt;<i> this setup is working as intended with the config attached below, 
</I>&gt;<i> however the issue I'm facing is that some servers are &quot;loadbalanced&quot;, 
</I>&gt;<i> this would give me the forgery error, eg:
</I>&gt;<i> 
</I>&gt;<i> &quot;SECURITY ALERT: Host header forgery detected on....&quot;
</I>&gt;<i> 
</I>
The workarounds and gotcha's listed at 
&lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are the 
best you can hope for there. The most successful all-round solution is 
to increase EDNS0 capabilities.


&gt;<i> Here's a specific example, there's a corporate domain for webmail 
</I>&gt;<i> access, and some loadbalance config makes use of different IPs, I think 
</I>&gt;<i> this is what triggers the error. My question is, can I just ignore this 
</I>&gt;<i> error somehow and allow the connection? From what I gather this 
</I>&gt;<i> connection is cut by squid before it reaches the client..
</I>
Squid default behaviour is to allow the connection only to the same 
IP:port the client was connecting to. If that is not working your 
network configuration is screwed up. Specifically your routing or NAT.

NAT of the dst-IP:port *MUST NOT* happen on any device between the 
client machine and the proxy machine. Squid needs access directly to the 
kernel NAT records of the device doing that NAT operation. So it can 
only happen on the Squid device.
  You must *route* the packets unchanged to the Squid device (possibly 
over a tunnel if necessary).


&gt;<i> 
</I>&gt;<i> Also if there's anything else obviously wrong with my setup please let 
</I>&gt;<i> me know.
</I>&gt;<i> 
</I>&gt;<i> Many thanks.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Here's my config:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ### squid.conf begin
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;<i> 
</I>&gt;<i> acl ssl_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl safe_ports port 80
</I>&gt;<i> acl safe_ports port 443
</I>&gt;<i> acl connect method connect
</I>
NP: the default above ACL names are case-sensitive and some of them 
involve built-in default values which you are preventing having any 
effect by using custom lower-case ACL names.


&gt;<i> acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;<i> acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> http_port 3129
</I>
Port 3128 is registered for forward-proxy traffic. Ideally you would 
have those lines reversed like so:

  http_port 3128
  http_port 3129 intercept

... with the corresponding NAT change for the intercept port.

Also, to have your SSL-Bump whitelists applied to forward-proxy CONNECT 
traffic you should have ssl-bump settings on that 3128 forward-proxy 
port matching those on the port 3130 line.


&gt;<i> 
</I>&gt;<i> http_access deny !safe_ports
</I>&gt;<i> http_access deny connect !ssl_ports
</I>
&gt;<i> http_access allow ssl_ports
</I>
Rather than allowing unlimited access to anyone on the Internet to use 
your limited bandwidth outbound connection for access to port 443 you 
should be using the localnet ACL that restricts use of the proxy to 
people on your LAN - those 14 clients you mentioned sharing the line.

[NP: It is not possible in this setup to determine what remote users are 
abusing your proxy. All traffic logs from your firewall etc will show 
Squid as the client, not the remote [ab]user. Squid access.log records 
you are sending to /dev/null is the *only* record of such activities.]


To make your whitelists have any effect replace the above &quot;allow 
ssl_ports&quot; line with a &quot;deny !localnet&quot; line.

If that change causes issues then your whitelists are incorrect / 
incomplete. You then need the (currently discarded) access.log and/or 
cache.log data to solve the issue properly.


&gt;<i> http_access allow http_whitelist
</I>&gt;<i> http_access allow ips_whitelist
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;<i>  &#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;<i>  &#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice https_whitelist
</I>&gt;<i> ssl_bump splice ips_whitelist
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>
That seems fine. The problem is not part of this _config_. If you are 
having any SSL-Bump issues please try a build of the latest Squid-4. It 
may be related to bugs in Squid-3 SSL-Bump or modern TLS things Squid-3 
cannot cope with - there is a growing list of those.

&gt;<i> 
</I>&gt;<i> cache deny all
</I>
In the latest Squid-3 use &quot;store_miss deny all&quot; instead of the above.

&gt;<i> access_log none
</I>
The above is fine if you are certain of the squid.conf working 100% 
properly. But since you are debugging issues you may need those 
transaction details.

NP: access.log can be logged to syslog or a TCP pipe by Squid. To 
deliver the log content externally for normal audit purposes instead of 
using space on the device.

&gt;<i> cache_log /dev/null
</I>
You *need* the information logged here. By default only the most 
operationally critical errors are recorded.

NP: the cache.log can usually be a Unix-pipe delivering data to a remote 
server if the local machine is constrained.

&gt;<i> cache_store_log stdio:/dev/null
</I>
Above line is *actively* harmful. The Squid-3 default is not to waste 
cycles logging *unless* you enter something like the above in 
squid.conf. The above makes Squid allocate device resources to logging 
that data to /dev/null.

&gt;<i> logfile_rotate 0
</I>&gt;<i> 
</I>&gt;<i> logfile_daemon /dev/null
</I>
/dev/null is not a valid application filename.

Build your Squid with --disable-logfile-daemon.

&gt;<i> coredump_dir /tmp/squid
</I>&gt;<i> visible_hostname main_Firewall
</I>
The *visible* hostname is the domain delivered to clients and denied 
parties in the URLs to fetch error message data and FTP icons from 
Squid. It needs to be a valid FQDN.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016836.html">[squid-users] Non intrusive sslbump for whitelisting (asked	many times but..)
</A></li>
	<LI>Next message (by thread): <A HREF="016854.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16838">[ date ]</a>
              <a href="thread.html#16838">[ thread ]</a>
              <a href="subject.html#16838">[ subject ]</a>
              <a href="author.html#16838">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
