<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program and ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20and%20ACLs&In-Reply-To=%3Ca2a261d8-a1bf-d811-6a50-928957fb9d93%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016841.html">
   <LINK REL="Next"  HREF="016846.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program and ACLs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20and%20ACLs&In-Reply-To=%3Ca2a261d8-a1bf-d811-6a50-928957fb9d93%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program and ACLs">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov  8 10:43:44 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016841.html">[squid-users] url_rewrite_program and ACLs
</A></li>
        <LI>Next message (by thread): <A HREF="016846.html">[squid-users] url_rewrite_program and ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16844">[ date ]</a>
              <a href="thread.html#16844">[ thread ]</a>
              <a href="subject.html#16844">[ subject ]</a>
              <a href="author.html#16844">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/11/17 22:21, Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm not sure I understand how url_rewrite_program works.
</I>&gt;<i> 
</I>
Squid takes the URI from an HTTP request it is servicing and delivers it 
to the helper. The helper delivers a new URI back to Squid (or not). 
Squid then generates an entirely new HTTP request to use for server 
contact instead of the client one. Squid delivers the server response to 
that other request as the answer to the clients original request.

At no point is Squid doing any denial based on the URL-rewrite program.


&gt;<i> In the example below I'm trying to allow traffic from CLIENT_IP_ADDR to SERVER_DOMAIN_ADDR where CLIENT_IP_ADDR is in the allowed_ips ACL, and SERVER_DOMAIN_ADDR is in the allowed_domains ACL (I know it's redundant, but it's just an example).
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet !restricted_ips allowed_domains
</I>&gt;<i> http_access allow localnet !restricted_ips allowed_ips
</I>&gt;<i> http_reply_access allow localnet !restricted_ips allowed_ips
</I>&gt;<i> http_reply_access allow localnet !restricted_ips allowed_domains
</I>&gt;<i> 
</I>&gt;<i> [...]
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard
</I>&gt;<i> url_rewrite_children 80 startup=10 idle=3
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>

The http_access lines are checked to determine whether a client request 
is allowed to be serviced. So the transaction can be allowed or denied here.

If allowed to process, eventually the transaction checks the 
url_rewrite_access lines to determine whether the helper is involved 
with adapting the transaction. Their default is &quot;allow&quot;.

If the helper is used, the URL replacement may (or not) be given by SG 
at that point. Its decisions are determined by its own config, not Squid.

The http_reply_access determines whether the server response is allowed 
to be delivered. In this case the response is coming from your SG's 
localhost server.

&gt;<i> 
</I>&gt;<i> The problem is that the browser on the CLIENT_IP_ADDR displays the &quot;redirect&quot; page defined in squidGuard when trying to access SERVER_DOMAIN_ADDR.
</I>&gt;<i>  &gt; I could configure the allowed_domains and allowed_ips ACLs within 
</I>squidGuard itself, but shouldn't the Squid rule prevail anyway?
&gt;<i> Is the redirection done regardless of what precedes in squid.conf?
</I>
The directive purposes matter. squid.conf url_rewrite_access determines 
whether the helper is used. If those directives 'deny' the helper being 
used, OR if the helper returns a no-change result (empty line or ERR) 
there is no rewrite done.

PS. You do not need SG at all for access control and it is a lot simpler 
and faster to drop the helper part of things entirely. Especially in 
cases like this example.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016841.html">[squid-users] url_rewrite_program and ACLs
</A></li>
	<LI>Next message (by thread): <A HREF="016846.html">[squid-users] url_rewrite_program and ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16844">[ date ]</a>
              <a href="thread.html#16844">[ thread ]</a>
              <a href="subject.html#16844">[ subject ]</a>
              <a href="author.html#16844">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
