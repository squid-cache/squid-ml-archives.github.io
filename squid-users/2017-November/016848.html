<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID memory error after vm.swappines changed from 60 to 10
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20memory%20error%20after%20vm.swappines%20changed%0A%20from%2060%20to%2010&In-Reply-To=%3Cdaf2a3ca-d5bd-f84c-0182-099f845c4e61%40urlfilterdb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016843.html">
   <LINK REL="Next"  HREF="016865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID memory error after vm.swappines changed from 60 to 10</H1>
    <B>Marcus Kool</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20memory%20error%20after%20vm.swappines%20changed%0A%20from%2060%20to%2010&In-Reply-To=%3Cdaf2a3ca-d5bd-f84c-0182-099f845c4e61%40urlfilterdb.com%3E"
       TITLE="[squid-users] SQUID memory error after vm.swappines changed from 60 to 10">marcus.kool at urlfilterdb.com
       </A><BR>
    <I>Wed Nov  8 14:48:52 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016843.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
        <LI>Next message (by thread): <A HREF="016865.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16848">[ date ]</a>
              <a href="thread.html#16848">[ thread ]</a>
              <a href="subject.html#16848">[ subject ]</a>
              <a href="author.html#16848">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 08/11/17 11:36, Bike dernikov1 wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> We stumbled on ufdbGuard, but licence/price was problem, we didn't
</I>&gt;<i> read documentation carefully.
</I>yes, ufdbguard is free.

&gt;<i> We will definitely try ufdbGuard, but we are now in process of moving
</I>&gt;<i> squid/squidguard to production, so we can't test on production (angry
</I>&gt;<i> users, Internet must work :)).
</I>&gt;<i> 
</I>&gt;<i> Memory compsumption:squid use largest part of memory  (12GB now,
</I>&gt;<i> second proces use 300MB memory), 14GB used by all process. So squid
</I>&gt;<i> use over 80% of total used memory.
</I>&gt;<i> So no there are not any problematic process. But we changed swappiness
</I>&gt;<i> settings.
</I>Did you monitor Squid for growth (it can start with 12 GB and grow slowly) ?

Squid cannot fork and higher swappiness increases the amount of memory that the OS can use to copy processes.
It makes me think that you have the memory overcommit set to 2 (no overcommit).
What is the output of the following command ?
    sysctl  -a | grep overcommit

&gt;<i> Advice for some settings:
</I>&gt;<i> We have absolute max peak of  2500 users which user squid (of 2800),
</I>&gt;<i> what are recomended settings for:
</I>&gt;<i> negotiate_kerberos_children start/idle
</I>&gt;<i> squidguard helpers.
</I>
I have little experience with kerberos, but most likely this is not the issue.
When Squid cannot fork the helpers, helper settings do not matter much.

For 2500 users you probably need 32-64 squidguard helpers.

Marcus

&gt;<i> Thanks for help,
</I>&gt;<i> 
</I>&gt;<i> On Wed, Nov 8, 2017 at 10:53 AM, Marcus Kool
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">marcus.kool at urlfilterdb.com</A>&gt; wrote:
</I>&gt;&gt;<i> There is definitely a problem with available memory because Squid cannot
</I>&gt;&gt;<i> fork.
</I>&gt;&gt;<i> So start with looking at how much memory Squid and its helpers use.
</I>&gt;&gt;<i> Do do have other processes on this system that consume a lot of memory ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also note that ufdbGuard uses less memory that squidGuard.
</I>&gt;&gt;<i> If there are 30 helpers squidguard uses 300% more memory than ufdbGuard.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Look at the wiki for more information about memory usage:
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidMemory">https://wiki.squid-cache.org/SquidFaq/SquidMemory</A>   (currently has an
</I>&gt;&gt;<i> expired certificate but it is safe to go ahead)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Marcus
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 08/11/17 07:26, Bike dernikov1 wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi, I hope that someone can explain what happened, why squid stopped
</I>&gt;&gt;&gt;<i> working.
</I>&gt;&gt;&gt;<i> The problem is related to  memory/swap handling.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After we changed vm.swappiness parameter from 60 to 10 (tuning
</I>&gt;&gt;&gt;<i> attempt, to lower a disk usage, because we have only 4 disks in a
</I>&gt;&gt;&gt;<i> RAID10, so disk subsystem  is a weak link), we got a lot of errors in
</I>&gt;&gt;&gt;<i> cache.log.
</I>&gt;&gt;&gt;<i> The problems started after scheduled logrotate after  2AM.
</I>&gt;&gt;&gt;<i> Squid ran out of memory, auth helpers stopped working.
</I>&gt;&gt;&gt;<i> It's weird because we didn't disable swap, but behavior is like we did.
</I>&gt;&gt;&gt;<i> After an error, we increased parameter from 10 to 40.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The server has 24GB DDR3 memory,  disk swap set to 24GB, 12 CPU (24HT
</I>&gt;&gt;&gt;<i> cores).
</I>&gt;&gt;&gt;<i> We have 2800 users, using  kerberos authentication, squidguard for
</I>&gt;&gt;&gt;<i> filtering, ldap authorization.
</I>&gt;&gt;&gt;<i> When problem appeared memory was still 3GB free (free column), ram
</I>&gt;&gt;&gt;<i> (caching) was filled to 15GB, so 21 GB ram filled, 3GB free.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks for help,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> errors from cache.log.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:27| Set Current Directory to /var/log/squid/
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1| storeDirWriteCleanLogs: Starting...
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1|   Finished.  Wrote 0 entries.
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1|   Took 0.00 seconds (  0.00 entries/sec).
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1| logfileRotate: daemon:/var/log/squid/access.log
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1| logfileRotate: daemon:/var/log/squid/access.log
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| Pinger socket opened on FD 30
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| helperOpenServers: Starting 1/1000
</I>&gt;&gt;&gt;<i> 'squidGuard' processes
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run '/usr/bin/squidGuard'
</I>&gt;&gt;&gt;<i> process.
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| helperOpenServers: Starting 300/3000
</I>&gt;&gt;&gt;<i> 'negotiate_kerberos_auth' processes
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run
</I>&gt;&gt;&gt;<i> '/usr/lib/squid/negotiate_kerberos_auth' process.
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run
</I>&gt;&gt;&gt;<i> '/usr/lib/squid/negotiate_kerberos_auth' process.
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run
</I>&gt;&gt;&gt;<i> '/usr/lib/squid/negotiate_kerberos_auth' process.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> external ACL 'memberof' queue overload. Using stale result.
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016843.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
	<LI>Next message (by thread): <A HREF="016865.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16848">[ date ]</a>
              <a href="thread.html#16848">[ thread ]</a>
              <a href="subject.html#16848">[ subject ]</a>
              <a href="author.html#16848">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
