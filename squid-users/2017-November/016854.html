<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C75c1764d-1923-f6c0-1896-2c64d1190779%40bk.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016838.html">
   <LINK REL="Next"  HREF="016871.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)</H1>
    <B>A. Benz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C75c1764d-1923-f6c0-1896-2c64d1190779%40bk.ru%3E"
       TITLE="[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)">ash.benz at bk.ru
       </A><BR>
    <I>Wed Nov  8 22:34:01 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016838.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
        <LI>Next message (by thread): <A HREF="016871.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16854">[ date ]</a>
              <a href="thread.html#16854">[ thread ]</a>
              <a href="subject.html#16854">[ subject ]</a>
              <a href="author.html#16854">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Many thanks for your detailed reply.

I have modified the config following your comments, before you see the 
new config (attached below), pls let me know your thoughts on the following:

1.

 &gt; The workarounds and gotcha's listed at
 &gt; &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are the
 &gt; best you can hope for there. The most successful all-round solution is
 &gt; to increase EDNS0 capabilities.

My particular case is a single server only, a corporate email server. 
This server is publicly accessible from internet (and has a valid signed 
SSL cert), now, on the remote location, there's a VPN setup that 
redirects access to the mail server to a private IP, eg 10.x.x.x (and 
this differs depending on loadbalance decision).

Without squid, I can connect to webmail, but with squid I get the 
forgery error. Does the EDNS0 fix this? See its almost working exactly 
as I need now, except for access to this single domain.. so if there's a 
workaround (even if it requires a recompile) to ignore this single 
domain do let me know.


2.

 &gt; NAT of the dst-IP:port *MUST NOT* happen on any device between the
 &gt; client machine and the proxy machine. Squid needs access directly to the
 &gt; kernel NAT records of the device doing that NAT operation. So it can
 &gt; only happen on the Squid device.
 &gt;   You must *route* the packets unchanged to the Squid device (possibly
 &gt; over a tunnel if necessary).

It happens on the same device (LEDE/OpenWrt router where squid is 
running), so the router is configured to intercept http (80) and https 
(443) traffic and redirect it to squid's ports:
80 ---&gt; 3129
443 --&gt; 3130


3.

 &gt; Rather than allowing unlimited access to anyone on the Internet to use
 &gt; your limited bandwidth outbound connection for access to port 443 you
 &gt; should be using the localnet ACL that restricts use of the proxy to
 &gt; people on your LAN - those 14 clients you mentioned sharing the line.
 &gt;
 &gt; [NP: It is not possible in this setup to determine what remote users are
 &gt; abusing your proxy. All traffic logs from your firewall etc will show
 &gt; Squid as the client, not the remote [ab]user. Squid access.log records
 &gt; you are sending to /dev/null is the *only* record of such activities.]
 &gt;
 &gt;

I think I didn't word my earlier email properly, apologies for not being 
clear. No one from the internet has access to squid, the listening ports 
are not open to public, only accessible from LAN.

With abuse I meant the 14 users.. you know nowadays with mobiles/tablets 
and all the apps and syncing, I only allow ports 443 and 80 (and those 
are intercepted and forwarded to squid). All other ports are blocked.
The bandwidth available is extremely scarce and hence why I'm setting 
this up.


4.

 &gt; To make your whitelists have any effect replace the above &quot;allow
 &gt; ssl_ports&quot; line with a &quot;deny !localnet&quot; line.

When I do this, it doesn't work anymore. I get &quot;Your connection is not 
secure&quot; from firefox, and since google has HSTS, I can't &quot;ignore and 
proceed&quot;. The squid access log shows (not .google.com is in whitelist.txt):

1510180110.096      0 192.168.1.178 TCP_DENIED/200 0 CONNECT 
108.177.14.103:443 - HIER_NONE/- -

Once I switch back to &quot;allow SSL_ports&quot; I can connect (squid splices' 
the connection, no complaints from firefox).


5.

I followed your comments about the config changes: changed acls to match 
original config in upper case. Swapped  the port numbers, but about 
having my ssl-bump match on 3129, pls check my new one see if I did it 
right.


## begin squid.conf


acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

acl SSL_ports port 443

acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT
acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;


http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow SSL_ports
# http_access deny !localnet
http_access allow http_whitelist
http_access allow ips_whitelist
http_access deny all

http_port 3128 ssl-bump \
	cert=/etc/squid/myCA.pem \
	generate-host-certificates=off dynamic_cert_mem_cache_size=4MB

https_port 3130 intercept ssl-bump \
	cert=/etc/squid/myCA.pem \
	generate-host-certificates=off dynamic_cert_mem_cache_size=4MB

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump splice https_whitelist
ssl_bump splice ips_whitelist
ssl_bump terminate all


refresh_pattern ^ftp: 1440 20% 10080
refresh_pattern ^gopher: 1440 0% 1440
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern . 0 20% 4320

store_miss deny all
cache_log /tmp/squid/squid.log
access_log /tmp/squid/access.log
logfile_rotate 0

logfile_daemon /usr/bin/logger
http_port 3129 intercept
coredump_dir /tmp/squid
visible_hostname LEDE.lan
pinger_enable off
mime_table /tmp/squid/mime.conf
sslcrtd_program /usr/lib/squid/ssl_crtd -s /tmp/squid/ssldb -M 4MB

## end config

Many thanks!


Regards,
A. Benz

On 11/08/17 12:23, Amos Jeffries wrote:
&gt;<i> On 08/11/17 12:18, A. Benz wrote:
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ## Intro
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I read many blogs and emails on this list related to what I'm trying 
</I>&gt;&gt;<i> to do, but most go into bumping or do things that are not as simple as 
</I>&gt;&gt;<i> I'm trying to achieve.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have an extremely slow line, with very high latency in a remote 
</I>&gt;&gt;<i> location. About 14 people are sharing this line. Nowadays with all the 
</I>&gt;&gt;<i> mobile apps trying to sync and such, the line stalls to unusable all 
</I>&gt;&gt;<i> the time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried doing filters with firewall or dns level, but those are not 
</I>&gt;&gt;<i> effective. In the end I figured squid might be my best option.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ## End intro
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have squid 3.5.27 running under LEDE (OpenWrt fork), ie its 
</I>&gt;&gt;<i> cross-compiled for a MIPS based SoC (mediatek mt7621). I mention this 
</I>&gt;&gt;<i> because you will see some options in the config file that won't make 
</I>&gt;&gt;<i> sense otherwise.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> NP: That should not be making much difference to the squid.conf 
</I>&gt;<i> settings. The worst limitations such devices impose are things that 
</I>&gt;<i> should be solved by OS settings outside of squid.conf. eg the cache.log 
</I>&gt;<i> going to a pipe for remote logging instead of a filename, and 
</I>&gt;<i> system-level FD limits.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> It works great, here's what I'm trying to achieve: Allow access only 
</I>&gt;&gt;<i> to a pre-defined list of websites (whitelist). http is 
</I>&gt;&gt;<i> straightforward, but if the connection is https all I need to know is 
</I>&gt;&gt;<i> domain, if its allowed, let it pass, otherwise terminate.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> this setup is working as intended with the config attached below, 
</I>&gt;&gt;<i> however the issue I'm facing is that some servers are &quot;loadbalanced&quot;, 
</I>&gt;&gt;<i> this would give me the forgery error, eg:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;SECURITY ALERT: Host header forgery detected on....&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> The workarounds and gotcha's listed at 
</I>&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are the 
</I>&gt;<i> best you can hope for there. The most successful all-round solution is 
</I>&gt;<i> to increase EDNS0 capabilities.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Here's a specific example, there's a corporate domain for webmail 
</I>&gt;&gt;<i> access, and some loadbalance config makes use of different IPs, I 
</I>&gt;&gt;<i> think this is what triggers the error. My question is, can I just 
</I>&gt;&gt;<i> ignore this error somehow and allow the connection? From what I gather 
</I>&gt;&gt;<i> this connection is cut by squid before it reaches the client..
</I>&gt;<i> 
</I>&gt;<i> Squid default behaviour is to allow the connection only to the same 
</I>&gt;<i> IP:port the client was connecting to. If that is not working your 
</I>&gt;<i> network configuration is screwed up. Specifically your routing or NAT.
</I>&gt;<i> 
</I>&gt;<i> NAT of the dst-IP:port *MUST NOT* happen on any device between the 
</I>&gt;<i> client machine and the proxy machine. Squid needs access directly to the 
</I>&gt;<i> kernel NAT records of the device doing that NAT operation. So it can 
</I>&gt;<i> only happen on the Squid device.
</I>&gt;<i>  &#160;You must *route* the packets unchanged to the Squid device (possibly 
</I>&gt;<i> over a tunnel if necessary).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also if there's anything else obviously wrong with my setup please let 
</I>&gt;&gt;<i> me know.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Many thanks.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here's my config:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ### squid.conf begin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl ssl_ports port 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl safe_ports port 80
</I>&gt;&gt;<i> acl safe_ports port 443
</I>&gt;&gt;<i> acl connect method connect
</I>&gt;<i> 
</I>&gt;<i> NP: the default above ACL names are case-sensitive and some of them 
</I>&gt;<i> involve built-in default values which you are preventing having any 
</I>&gt;<i> effect by using custom lower-case ACL names.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;<i> acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;<i> http_port 3129
</I>&gt;<i> 
</I>&gt;<i> Port 3128 is registered for forward-proxy traffic. Ideally you would 
</I>&gt;<i> have those lines reversed like so:
</I>&gt;<i> 
</I>&gt;<i>  &#160;http_port 3128
</I>&gt;<i>  &#160;http_port 3129 intercept
</I>&gt;<i> 
</I>&gt;<i> ... with the corresponding NAT change for the intercept port.
</I>&gt;<i> 
</I>&gt;<i> Also, to have your SSL-Bump whitelists applied to forward-proxy CONNECT 
</I>&gt;<i> traffic you should have ssl-bump settings on that 3128 forward-proxy 
</I>&gt;<i> port matching those on the port 3130 line.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny !safe_ports
</I>&gt;&gt;<i> http_access deny connect !ssl_ports
</I>&gt;<i> 
</I>&gt;&gt;<i> http_access allow ssl_ports
</I>&gt;<i> 
</I>&gt;<i> Rather than allowing unlimited access to anyone on the Internet to use 
</I>&gt;<i> your limited bandwidth outbound connection for access to port 443 you 
</I>&gt;<i> should be using the localnet ACL that restricts use of the proxy to 
</I>&gt;<i> people on your LAN - those 14 clients you mentioned sharing the line.
</I>&gt;<i> 
</I>&gt;<i> [NP: It is not possible in this setup to determine what remote users are 
</I>&gt;<i> abusing your proxy. All traffic logs from your firewall etc will show 
</I>&gt;<i> Squid as the client, not the remote [ab]user. Squid access.log records 
</I>&gt;<i> you are sending to /dev/null is the *only* record of such activities.]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> To make your whitelists have any effect replace the above &quot;allow 
</I>&gt;<i> ssl_ports&quot; line with a &quot;deny !localnet&quot; line.
</I>&gt;<i> 
</I>&gt;<i> If that change causes issues then your whitelists are incorrect / 
</I>&gt;<i> incomplete. You then need the (currently discarded) access.log and/or 
</I>&gt;<i> cache.log data to solve the issue properly.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> http_access allow http_whitelist
</I>&gt;&gt;<i> http_access allow ips_whitelist
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;<i> ssl_bump splice https_whitelist
</I>&gt;&gt;<i> ssl_bump splice ips_whitelist
</I>&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> That seems fine. The problem is not part of this _config_. If you are 
</I>&gt;<i> having any SSL-Bump issues please try a build of the latest Squid-4. It 
</I>&gt;<i> may be related to bugs in Squid-3 SSL-Bump or modern TLS things Squid-3 
</I>&gt;<i> cannot cope with - there is a growing list of those.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> In the latest Squid-3 use &quot;store_miss deny all&quot; instead of the above.
</I>&gt;<i> 
</I>&gt;&gt;<i> access_log none
</I>&gt;<i> 
</I>&gt;<i> The above is fine if you are certain of the squid.conf working 100% 
</I>&gt;<i> properly. But since you are debugging issues you may need those 
</I>&gt;<i> transaction details.
</I>&gt;<i> 
</I>&gt;<i> NP: access.log can be logged to syslog or a TCP pipe by Squid. To 
</I>&gt;<i> deliver the log content externally for normal audit purposes instead of 
</I>&gt;<i> using space on the device.
</I>&gt;<i> 
</I>&gt;&gt;<i> cache_log /dev/null
</I>&gt;<i> 
</I>&gt;<i> You *need* the information logged here. By default only the most 
</I>&gt;<i> operationally critical errors are recorded.
</I>&gt;<i> 
</I>&gt;<i> NP: the cache.log can usually be a Unix-pipe delivering data to a remote 
</I>&gt;<i> server if the local machine is constrained.
</I>&gt;<i> 
</I>&gt;&gt;<i> cache_store_log stdio:/dev/null
</I>&gt;<i> 
</I>&gt;<i> Above line is *actively* harmful. The Squid-3 default is not to waste 
</I>&gt;<i> cycles logging *unless* you enter something like the above in 
</I>&gt;<i> squid.conf. The above makes Squid allocate device resources to logging 
</I>&gt;<i> that data to /dev/null.
</I>&gt;<i> 
</I>&gt;&gt;<i> logfile_rotate 0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> logfile_daemon /dev/null
</I>&gt;<i> 
</I>&gt;<i> /dev/null is not a valid application filename.
</I>&gt;<i> 
</I>&gt;<i> Build your Squid with --disable-logfile-daemon.
</I>&gt;<i> 
</I>&gt;&gt;<i> coredump_dir /tmp/squid
</I>&gt;&gt;<i> visible_hostname main_Firewall
</I>&gt;<i> 
</I>&gt;<i> The *visible* hostname is the domain delivered to clients and denied 
</I>&gt;<i> parties in the URLs to fetch error message data and FTP icons from 
</I>&gt;<i> Squid. It needs to be a valid FQDN.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016838.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
	<LI>Next message (by thread): <A HREF="016871.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16854">[ date ]</a>
              <a href="thread.html#16854">[ thread ]</a>
              <a href="subject.html#16854">[ subject ]</a>
              <a href="author.html#16854">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
