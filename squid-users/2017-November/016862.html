<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program and ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20and%20ACLs&In-Reply-To=%3Ce89c27ac-b147-426e-e220-2c566b5e7586%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016859.html">
   <LINK REL="Next"  HREF="016864.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program and ACLs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20and%20ACLs&In-Reply-To=%3Ce89c27ac-b147-426e-e220-2c566b5e7586%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program and ACLs">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov  9 10:09:40 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016859.html">[squid-users] url_rewrite_program and ACLs
</A></li>
        <LI>Next message (by thread): <A HREF="016864.html">[squid-users] url_rewrite_program and ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16862">[ date ]</a>
              <a href="thread.html#16862">[ thread ]</a>
              <a href="subject.html#16862">[ subject ]</a>
              <a href="author.html#16862">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/11/17 20:51, Vieri wrote:
&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> From: Amos Jeffries
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl foo ...
</I>&gt;&gt;<i>   http_access deny foo
</I>&gt;&gt;<i>   deny_info 302:<A HREF="http://example.com/">http://example.com/</A> foo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In Squid-3.2+ the deny_info URL portion can use logformat macros for
</I>&gt;&gt;<i> dynamic redirection - like the &quot;rew&quot; substitutions only changing
</I>&gt;&gt;<i> portions of the URL.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I was already using deny_info like this:
</I>&gt;<i> 
</I>&gt;<i> deny_info <A HREF="http://squidserver/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_domains">http://squidserver/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_domains</A> denied_domains
</I>&gt;<i> 
</I>&gt;<i> I was wondering how to do an immediate redirect without doing it from my custom php script. Now I see.
</I>&gt;<i> 
</I>&gt;<i> I guess I'll have trouble redirecting https sites though... (TLS/SSL trust issues)
</I>
The proper HTTP *redirect* with 3xx statsu code has no problems there. 
Since the redirect is simply telling the client to connect elsewhere.

It is re-writing the URL which encounters cert problems because the 
server gets secretly changed from what the client &quot;knows&quot; it is 
connected to mid-way along the connection.

If you are redirecting <A HREF="https://">https://</A> URLs to a <A HREF="http://">http://</A> location they may 
still warn about insecure content. But that is not a cert issue, just 
the browser scare tactics for pushing its &quot;TLS-Everywhere&quot; policy on 
your users.


&gt;<i> 
</I>&gt;<i> I don't know if I can &quot;cleanly&quot; redirect from an HTTPS to an HTTP site (ie. so the user's browser doesn't show a &quot;can't open page&quot; message of some sort...).
</I>&gt;<i> 
</I>&gt;<i> You mention that I can avoid using SG, ufdbGuard, or any other redirector/helper for access control. The problem I see when trying to use huge plain text blacklists within Squid directly is that it takes a LOT of time for the proxy cache to start up as it populates the ACLs.
</I>&gt;<i> I can't afford to wait for Squid to do that before serving client requests. I'd rather &quot;allow everything&quot; until the ACLs are populated than have users wait for so long.
</I>&gt;<i> Am I missing something? Is there a way to tell Squid to process the ACLs &quot;in the background&quot;, but start handling requests immediately. If so, is it also possible to tell squid in which order to process the ACLs, ie. first process the allowed_domains ACL, and then the denied_domains ACLs? (is ordering in squid.conf enough?)
</I>
Darn. You have the one case that calls for keeping the helper :-(

You can still move the ACLs that load in a reasonable times into 
squid.conf and leave the others in SG/ufdbguard. Using 
url_rewrite_access to restrict which transactions the helper gets 
involved with. That will reduce its latency impact on lie traffic, but 
still cause much the same memory related (non-)issues as now.

&gt;<i> 
</I>&gt;<i> I'm saying this because I've sometimes had the need to restart Squid during the worst time of the day (peak working hours). That usually happens when I have an issue with too many open file descriptors (working on it). Stopping it cleanly takes up to 2-3 minutes. If I had to wait several more minutes for Squid to start again because it re-populates huge blacklist ACLs then I think they'd hang me for it.
</I>&gt;<i> 
</I>
One thing that may also help you there while you figure out what those 
FD issues are caused by:

If you run &quot;squid -k shutdown&quot; once it signals a slow graceful shutdown 
of Squid. Which will take a *minimum* of the time configured in 
shutdown_lifetime directive (default 30sec) to wait for existing clients 
to finish up and disconnect.

Running &quot;squid -k shutdown&quot; a _second_ time sends the running proxy a 
signal to immediately skip to the processing as if the shutdown_lifetime 
had already been reached.

The shutdown time with two sequential calls should be only the time 
needed to close all the open FD connections, shutdown helpers and 
release however much memory Squid is using. All that happens in just a 
few seconds normally, but I'm not sure if &quot;normal&quot; matches your FD 
overload case. Will definitely be faster than waiting for the graceful 
shutdown anyhow.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016859.html">[squid-users] url_rewrite_program and ACLs
</A></li>
	<LI>Next message (by thread): <A HREF="016864.html">[squid-users] url_rewrite_program and ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16862">[ date ]</a>
              <a href="thread.html#16862">[ thread ]</a>
              <a href="subject.html#16862">[ subject ]</a>
              <a href="author.html#16862">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
