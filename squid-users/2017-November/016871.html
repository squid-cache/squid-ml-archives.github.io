<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C7a55ca37-23d0-a0f3-6397-2a772f91745f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016854.html">
   <LINK REL="Next"  HREF="016877.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C7a55ca37-23d0-a0f3-6397-2a772f91745f%40treenet.co.nz%3E"
       TITLE="[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov  9 19:30:39 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016854.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
        <LI>Next message (by thread): <A HREF="016877.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16871">[ date ]</a>
              <a href="thread.html#16871">[ thread ]</a>
              <a href="subject.html#16871">[ subject ]</a>
              <a href="author.html#16871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/11/17 11:34, A. Benz wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Many thanks for your detailed reply.
</I>&gt;<i> 
</I>&gt;<i> I have modified the config following your comments, before you see the 
</I>&gt;<i> new config (attached below), pls let me know your thoughts on the 
</I>&gt;<i> following:
</I>&gt;<i> 
</I>&gt;<i> 1.
</I>&gt;<i> 
</I>&gt;<i>  &gt; The workarounds and gotcha's listed at
</I>&gt;<i>  &gt; &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are the
</I>&gt;<i>  &gt; best you can hope for there. The most successful all-round solution is
</I>&gt;<i>  &gt; to increase EDNS0 capabilities.
</I>&gt;<i> 
</I>&gt;<i> My particular case is a single server only, a corporate email server. 
</I>&gt;<i> This server is publicly accessible from internet (and has a valid signed 
</I>&gt;<i> SSL cert), now, on the remote location, there's a VPN setup that 
</I>&gt;<i> redirects access to the mail server to a private IP, eg 10.x.x.x (and 
</I>&gt;<i> this differs depending on loadbalance decision).
</I>
Do you mean the VPN exit point has that 10/8 IP address? or that the 
traffic from the client is altered to be going to that IP before it 
reaches Squid?

The latter is broken because it destroys the original dst-IP values on 
the TCP connection. Which Squid needs to setup the server connection.


&gt;<i> 
</I>&gt;<i> Without squid, I can connect to webmail, but with squid I get the 
</I>&gt;<i> forgery error. Does the EDNS0 fix this? See its almost working exactly 
</I>&gt;<i> as I need now, except for access to this single domain.. so if there's a 
</I>&gt;<i> workaround (even if it requires a recompile) to ignore this single 
</I>&gt;<i> domain do let me know.
</I>&gt;<i> 
</I>
EDNS0 fixes problems with services that load balance by rotating the IP 
addresses delivered in response to A/AAAA queries, possibly omitting 
some records if the final few don't fit. That results in Squid getting 
different IPs occasionally than the one the client is using. EDNS0 
extends the available DNS response packet size to fit all the records so 
Squid can see them all even when a large set is rotating.

There are a few major hosting providers that have that behaviour in 
their DNS. If you have not hit it yet you are very lucky.


&gt;<i> 
</I>&gt;<i> 2.
</I>&gt;<i> 
</I>&gt;<i>  &gt; NAT of the dst-IP:port *MUST NOT* happen on any device between the
</I>&gt;<i>  &gt; client machine and the proxy machine. Squid needs access directly to the
</I>&gt;<i>  &gt; kernel NAT records of the device doing that NAT operation. So it can
</I>&gt;<i>  &gt; only happen on the Squid device.
</I>&gt;<i>  &gt;&#160;&#160; You must *route* the packets unchanged to the Squid device (possibly
</I>&gt;<i>  &gt; over a tunnel if necessary).
</I>&gt;<i> 
</I>&gt;<i> It happens on the same device (LEDE/OpenWrt router where squid is 
</I>&gt;<i> running), so the router is configured to intercept http (80) and https 
</I>&gt;<i> (443) traffic and redirect it to squid's ports:
</I>&gt;<i> 80 ---&gt; 3129
</I>&gt;<i> 443 --&gt; 3130
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 3.
</I>&gt;<i> 
</I>&gt;<i>  &gt; Rather than allowing unlimited access to anyone on the Internet to use
</I>&gt;<i>  &gt; your limited bandwidth outbound connection for access to port 443 you
</I>&gt;<i>  &gt; should be using the localnet ACL that restricts use of the proxy to
</I>&gt;<i>  &gt; people on your LAN - those 14 clients you mentioned sharing the line.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; [NP: It is not possible in this setup to determine what remote users are
</I>&gt;<i>  &gt; abusing your proxy. All traffic logs from your firewall etc will show
</I>&gt;<i>  &gt; Squid as the client, not the remote [ab]user. Squid access.log records
</I>&gt;<i>  &gt; you are sending to /dev/null is the *only* record of such activities.]
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i> 
</I>&gt;<i> I think I didn't word my earlier email properly, apologies for not being 
</I>&gt;<i> clear. No one from the internet has access to squid, the listening ports 
</I>&gt;<i> are not open to public, only accessible from LAN.
</I>
If for any reason those firewall rules change in unexpected ways or 
don't block something you expect to be blocked this may leave a security 
hole open. It does not seem to be necessary really, so best to close.


&gt;<i> 
</I>&gt;<i> With abuse I meant the 14 users.. you know nowadays with mobiles/tablets 
</I>&gt;<i> and all the apps and syncing, I only allow ports 443 and 80 (and those 
</I>&gt;<i> are intercepted and forwarded to squid). All other ports are blocked.
</I>&gt;<i> The bandwidth available is extremely scarce and hence why I'm setting 
</I>&gt;<i> this up.
</I>
The point I was trying to emphasize is that your Squid is accepting 
*anything* in those port 443 connections.


&gt;<i> 
</I>&gt;<i> 4.
</I>&gt;<i> 
</I>&gt;<i>  &gt; To make your whitelists have any effect replace the above &quot;allow
</I>&gt;<i>  &gt; ssl_ports&quot; line with a &quot;deny !localnet&quot; line.
</I>&gt;<i> 
</I>&gt;<i> When I do this, it doesn't work anymore. I get &quot;Your connection is not 
</I>&gt;<i> secure&quot; from firefox, and since google has HSTS, I can't &quot;ignore and 
</I>&gt;<i> proceed&quot;. The squid access log shows (not .google.com is in whitelist.txt):
</I>
HSTS requires a header &quot;Strict-Transport-Security&quot; to be delivered from 
servers before it takes effect. You can erase that header from replies 
going through Squid with the reply_header_access directive. Current 
Squid should be doing it automatically.
There may be issues with HSTS if the header is received before the 
device connects to your network, or if it arrives over an uncontrolled 
CONNECT tunnel. But there is not much to be done about those cases.


&gt;<i> 
</I>&gt;<i> 1510180110.096&#160;&#160;&#160;&#160;&#160; 0 192.168.1.178 TCP_DENIED/200 0 CONNECT 
</I>&gt;<i> 108.177.14.103:443 - HIER_NONE/- -
</I>&gt;<i> 
</I>&gt;<i> Once I switch back to &quot;allow SSL_ports&quot; I can connect (squid splices' 
</I>&gt;<i> the connection, no complaints from firefox).
</I>&gt;<i> 
</I>
That means the server that HTTPS connection is attempting to reach is 
not on your whitelist. It is therefore one of the things you wanted to 
be blocked according to your stated policy.

  - as I mentioned earlier, if that causes any issues your whitelist is 
incomplete.


&gt;<i> 
</I>&gt;<i> 5.
</I>&gt;<i> 
</I>&gt;<i> I followed your comments about the config changes: changed acls to match 
</I>&gt;<i> original config in upper case. Swapped&#160; the port numbers, but about 
</I>&gt;<i> having my ssl-bump match on 3129, pls check my new one see if I did it 
</I>&gt;<i> right.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ## begin squid.conf
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;<i> acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow SSL_ports
</I>&gt;<i> # http_access deny !localnet
</I>&gt;<i> http_access allow http_whitelist
</I>&gt;<i> http_access allow ips_whitelist
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump \
</I>&gt;<i>  &#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;<i>  &#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;<i>  &#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;<i>  &#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice https_whitelist
</I>&gt;<i> ssl_bump splice ips_whitelist
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;<i> 
</I>&gt;<i> store_miss deny all
</I>&gt;<i> cache_log /tmp/squid/squid.log
</I>&gt;<i> access_log /tmp/squid/access.log
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i> 
</I>&gt;<i> logfile_daemon /usr/bin/logger
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> coredump_dir /tmp/squid
</I>&gt;<i> visible_hostname LEDE.lan
</I>&gt;<i> pinger_enable off
</I>&gt;<i> mime_table /tmp/squid/mime.conf
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /tmp/squid/ssldb -M 4MB
</I>&gt;<i> 
</I>&gt;<i> ## end config
</I>&gt;<i> 
</I>&gt;<i> Many thanks!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> A. Benz
</I>&gt;<i> 
</I>&gt;<i> On 11/08/17 12:23, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 08/11/17 12:18, A. Benz wrote:
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ## Intro
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I read many blogs and emails on this list related to what I'm trying 
</I>&gt;&gt;&gt;<i> to do, but most go into bumping or do things that are not as simple 
</I>&gt;&gt;&gt;<i> as I'm trying to achieve.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have an extremely slow line, with very high latency in a remote 
</I>&gt;&gt;&gt;<i> location. About 14 people are sharing this line. Nowadays with all 
</I>&gt;&gt;&gt;<i> the mobile apps trying to sync and such, the line stalls to unusable 
</I>&gt;&gt;&gt;<i> all the time.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I tried doing filters with firewall or dns level, but those are not 
</I>&gt;&gt;&gt;<i> effective. In the end I figured squid might be my best option.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ## End intro
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have squid 3.5.27 running under LEDE (OpenWrt fork), ie its 
</I>&gt;&gt;&gt;<i> cross-compiled for a MIPS based SoC (mediatek mt7621). I mention this 
</I>&gt;&gt;&gt;<i> because you will see some options in the config file that won't make 
</I>&gt;&gt;&gt;<i> sense otherwise.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: That should not be making much difference to the squid.conf 
</I>&gt;&gt;<i> settings. The worst limitations such devices impose are things that 
</I>&gt;&gt;<i> should be solved by OS settings outside of squid.conf. eg the 
</I>&gt;&gt;<i> cache.log going to a pipe for remote logging instead of a filename, 
</I>&gt;&gt;<i> and system-level FD limits.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It works great, here's what I'm trying to achieve: Allow access only 
</I>&gt;&gt;&gt;<i> to a pre-defined list of websites (whitelist). http is 
</I>&gt;&gt;&gt;<i> straightforward, but if the connection is https all I need to know is 
</I>&gt;&gt;&gt;<i> domain, if its allowed, let it pass, otherwise terminate.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> this setup is working as intended with the config attached below, 
</I>&gt;&gt;&gt;<i> however the issue I'm facing is that some servers are &quot;loadbalanced&quot;, 
</I>&gt;&gt;&gt;<i> this would give me the forgery error, eg:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &quot;SECURITY ALERT: Host header forgery detected on....&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The workarounds and gotcha's listed at 
</I>&gt;&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are the 
</I>&gt;&gt;<i> best you can hope for there. The most successful all-round solution is 
</I>&gt;&gt;<i> to increase EDNS0 capabilities.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's a specific example, there's a corporate domain for webmail 
</I>&gt;&gt;&gt;<i> access, and some loadbalance config makes use of different IPs, I 
</I>&gt;&gt;&gt;<i> think this is what triggers the error. My question is, can I just 
</I>&gt;&gt;&gt;<i> ignore this error somehow and allow the connection? From what I 
</I>&gt;&gt;&gt;<i> gather this connection is cut by squid before it reaches the client..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid default behaviour is to allow the connection only to the same 
</I>&gt;&gt;<i> IP:port the client was connecting to. If that is not working your 
</I>&gt;&gt;<i> network configuration is screwed up. Specifically your routing or NAT.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NAT of the dst-IP:port *MUST NOT* happen on any device between the 
</I>&gt;&gt;<i> client machine and the proxy machine. Squid needs access directly to 
</I>&gt;&gt;<i> the kernel NAT records of the device doing that NAT operation. So it 
</I>&gt;&gt;<i> can only happen on the Squid device.
</I>&gt;&gt;<i> &#160;&#160;You must *route* the packets unchanged to the Squid device (possibly 
</I>&gt;&gt;<i> over a tunnel if necessary).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Also if there's anything else obviously wrong with my setup please 
</I>&gt;&gt;&gt;<i> let me know.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Many thanks.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's my config:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ### squid.conf begin
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;&gt;&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;&gt;&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl ssl_ports port 443
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl safe_ports port 80
</I>&gt;&gt;&gt;<i> acl safe_ports port 443
</I>&gt;&gt;&gt;<i> acl connect method connect
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: the default above ACL names are case-sensitive and some of them 
</I>&gt;&gt;<i> involve built-in default values which you are preventing having any 
</I>&gt;&gt;<i> effect by using custom lower-case ACL names.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;&gt;<i> acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;&gt;<i> http_port 3129
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Port 3128 is registered for forward-proxy traffic. Ideally you would 
</I>&gt;&gt;<i> have those lines reversed like so:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;http_port 3128
</I>&gt;&gt;<i> &#160;&#160;http_port 3129 intercept
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ... with the corresponding NAT change for the intercept port.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, to have your SSL-Bump whitelists applied to forward-proxy 
</I>&gt;&gt;<i> CONNECT traffic you should have ssl-bump settings on that 3128 
</I>&gt;&gt;<i> forward-proxy port matching those on the port 3130 line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny !safe_ports
</I>&gt;&gt;&gt;<i> http_access deny connect !ssl_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow ssl_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Rather than allowing unlimited access to anyone on the Internet to use 
</I>&gt;&gt;<i> your limited bandwidth outbound connection for access to port 443 you 
</I>&gt;&gt;<i> should be using the localnet ACL that restricts use of the proxy to 
</I>&gt;&gt;<i> people on your LAN - those 14 clients you mentioned sharing the line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [NP: It is not possible in this setup to determine what remote users 
</I>&gt;&gt;<i> are abusing your proxy. All traffic logs from your firewall etc will 
</I>&gt;&gt;<i> show Squid as the client, not the remote [ab]user. Squid access.log 
</I>&gt;&gt;<i> records you are sending to /dev/null is the *only* record of such 
</I>&gt;&gt;<i> activities.]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To make your whitelists have any effect replace the above &quot;allow 
</I>&gt;&gt;<i> ssl_ports&quot; line with a &quot;deny !localnet&quot; line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If that change causes issues then your whitelists are incorrect / 
</I>&gt;&gt;<i> incomplete. You then need the (currently discarded) access.log and/or 
</I>&gt;&gt;<i> cache.log data to solve the issue properly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow http_whitelist
</I>&gt;&gt;&gt;<i> http_access allow ips_whitelist
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i> ssl_bump splice https_whitelist
</I>&gt;&gt;&gt;<i> ssl_bump splice ips_whitelist
</I>&gt;&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That seems fine. The problem is not part of this _config_. If you are 
</I>&gt;&gt;<i> having any SSL-Bump issues please try a build of the latest Squid-4. 
</I>&gt;&gt;<i> It may be related to bugs in Squid-3 SSL-Bump or modern TLS things 
</I>&gt;&gt;<i> Squid-3 cannot cope with - there is a growing list of those.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In the latest Squid-3 use &quot;store_miss deny all&quot; instead of the above.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> access_log none
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The above is fine if you are certain of the squid.conf working 100% 
</I>&gt;&gt;<i> properly. But since you are debugging issues you may need those 
</I>&gt;&gt;<i> transaction details.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: access.log can be logged to syslog or a TCP pipe by Squid. To 
</I>&gt;&gt;<i> deliver the log content externally for normal audit purposes instead 
</I>&gt;&gt;<i> of using space on the device.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_log /dev/null
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You *need* the information logged here. By default only the most 
</I>&gt;&gt;<i> operationally critical errors are recorded.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NP: the cache.log can usually be a Unix-pipe delivering data to a 
</I>&gt;&gt;<i> remote server if the local machine is constrained.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_store_log stdio:/dev/null
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Above line is *actively* harmful. The Squid-3 default is not to waste 
</I>&gt;&gt;<i> cycles logging *unless* you enter something like the above in 
</I>&gt;&gt;<i> squid.conf. The above makes Squid allocate device resources to logging 
</I>&gt;&gt;<i> that data to /dev/null.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> logfile_rotate 0
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> logfile_daemon /dev/null
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /dev/null is not a valid application filename.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Build your Squid with --disable-logfile-daemon.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> coredump_dir /tmp/squid
</I>&gt;&gt;&gt;<i> visible_hostname main_Firewall
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The *visible* hostname is the domain delivered to clients and denied 
</I>&gt;&gt;<i> parties in the URLs to fetch error message data and FTP icons from 
</I>&gt;&gt;<i> Squid. It needs to be a valid FQDN.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016854.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
	<LI>Next message (by thread): <A HREF="016877.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16871">[ date ]</a>
              <a href="thread.html#16871">[ thread ]</a>
              <a href="subject.html#16871">[ subject ]</a>
              <a href="author.html#16871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
