<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program and ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20and%20ACLs&In-Reply-To=%3Cb0bd560b-081d-ec7b-261b-d92c1d479f98%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016864.html">
   <LINK REL="Next"  HREF="016876.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program and ACLs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%20and%20ACLs&In-Reply-To=%3Cb0bd560b-081d-ec7b-261b-d92c1d479f98%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program and ACLs">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Nov 10 00:17:18 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016864.html">[squid-users] url_rewrite_program and ACLs
</A></li>
        <LI>Next message (by thread): <A HREF="016876.html">[squid-users] url_rewrite_program and ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16874">[ date ]</a>
              <a href="thread.html#16874">[ thread ]</a>
              <a href="subject.html#16874">[ subject ]</a>
              <a href="author.html#16874">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/11/17 00:39, Vieri wrote:
&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Darn. You have the one case that calls for keeping the helper :-(
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can still move the ACLs that load in a reasonable times into
</I>&gt;&gt;<i> squid.conf and leave the others in SG/ufdbguard. Using
</I>&gt;&gt;<i> url_rewrite_access to restrict which transactions the helper gets
</I>&gt;&gt;<i> involved with. That will reduce its latency impact on lie traffic, but
</I>&gt;&gt;<i> still cause much the same memory related (non-)issues as now.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> That's exactly what I'm doing right now...
</I>&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;&gt;<i> Running &quot;squid -k shutdown&quot; a _second_ time sends the running proxy a
</I>&gt;&gt;<i> signal to immediately skip to the processing as if the shutdown_lifetime
</I>&gt;&gt;<i> had already been reached.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks for that double-shutdown signal trick. I'll have to try that asap.
</I>&gt;<i> 
</I>&gt;<i> I'm making progress (sort of) on the FD (non-)issues I'm having.
</I>&gt;<i> 
</I>&gt;<i> I'll try to post back to Alex asap.
</I>&gt;<i> 
</I>&gt;<i> I have a custom perl script that does MySQL lookups for blacklisted sites (lots of them - so I can't use ACLs within squid.conf). I define that helper with external_acl_type.
</I>&gt;<i> 
</I>&gt;<i> Yesterday I changed my squid.conf by disabling this helper, and used squidGuard instead.
</I>&gt;<i> I noticed a huge improvement.
</I>
Hmm that is suspicious. AFAIK SquidGuards' one remaining useful feature 
is how it loads large lists into memory in big chunks then processes 
after its technically already processing traffic from Squid - whereas 
Squid loads the files line by line, which is slower initially. Once 
loaded there is no difference in the lookup algorithms, and the SQL DB 
storage should be no different to how SG does it.

I would compare your custom script to the ext_sql_session_acl.pl.in 
script we bundle with current Squid.
  If yours lacks concurrency channel-ID I highly recommend adding that 
behaviour.
  If the DB is designed to store the protocol scheme, domain[:port] and 
path?query portions of URLs in separate columns it will be more 
efficient to pass those parameters as separate (%PROTO %DST %PORT %PATH) 
to the helper instead of just %URI.

The overheads in Squid of using external_acl_type helper interface 
should be slightly less than the url_rewrite_program for SG. The SQL DB 
data loading is about the same or better than what SG does AFAIK.


&gt;<i> 
</I>&gt;<i> I took this snapshot yesterday:
</I>&gt;<i> 
</I>&gt;<i> 15:25 08/11/2017:
</I>&gt;<i> 
</I>&gt;<i> File descriptor usage for squid:
</I>&gt;<i> Maximum number of file descriptors: 65536
</I>&gt;<i> Largest file desc currently in use: 2730
</I>&gt;<i> Number of file desc currently in use: 1838
</I>&gt;<i> Files queued for open: 0
</I>&gt;<i> Available number of file descriptors: 63698
</I>&gt;<i> Reserved number of file descriptors: 100
</I>&gt;<i> Store Disk files open: 0
</I>&gt;<i> 
</I>&gt;<i> Today I took another peak and found:
</I>&gt;<i> 
</I>&gt;<i> Thu Nov 9 12:19:05 CET 2017:
</I>&gt;<i> 
</I>&gt;<i> File descriptor usage for squid:
</I>&gt;<i> Maximum number of file descriptors: 65536
</I>&gt;<i> Largest file desc currently in use: 6980
</I>&gt;<i> Number of file desc currently in use: 6627
</I>&gt;<i> Files queued for open: 0
</I>&gt;<i> Available number of file descriptors: 58909
</I>&gt;<i> Reserved number of file descriptors: 100
</I>&gt;<i> Store Disk files open: 0
</I>&gt;<i> 
</I>&gt;<i> The FDs are still increasing steadily, but a LOT less.
</I>&gt;<i> 
</I>&gt;<i> On the other hand, the &quot;free&quot; RAM went from 2GB yesterday to just 275MB today:
</I>&gt;<i> 
</I>
Ouch, but kind of expected with those FD number increase. Each client 
connection will use about 3 FD, and two of them will use ~70KB each and 
the third will use some multiple of your avg object size.

Which reminds me ... Are you using SSL-Bump? if so ensure that you have 
configured &quot;sslflags=NO_DEFAULT_CA&quot; on the port lines. The default 
Trusted CA set can add a huge amount of useless memory to each client 
connection, which can add up to many GB quite quickly.


&gt;<i> # free --mega
</I>&gt;<i> total used free shared buff/cache available
</I>&gt;<i> Mem: 32865 8685 275 157 23904 23683
</I>&gt;<i> Swap: 37036 286 36750
</I>&gt;<i> 
</I>&gt;<i> Used swap is still low enough (unchanged actually), so I guess I don't need to worry about it.
</I>
Nod, until the RAM runs out entirely, then problems are definitely to be 
expected and that sounds like it is your problem now.

FYI: The first side-effect of RAM swapping is that Squid starts slowing 
down on completed transactions - memory cache hits slow by 3-6 orders of 
magnitude when swapping in/out from disk, and any I/O buffers swapped 
out get 1+ speed penalties for the swap I/O time.
  That all leads to more active client connections overlapping their 
active periods (thus more FD usage total), and also clients start 
opening more connections to get better service from parallel fetches. So 
FD usage gets growth from two directions simultaneously.
  Which is all in a feedback loop since that extra memory pressure from 
more FD slows all transactions even further ... until the machine goes 
crunch. Maybe a literal crunch - I actually physically blew up a test 
machine (fire and smoke puring out the back!) measuring the effects of 
RAID on a overloaded proxy about a decade ago.


&gt;<i> 
</I>&gt;<i> However, I'm bound to have issues when the &quot;free&quot; mem reaches 0... and I bet it will eventually.
</I>&gt;<i> That's when the double-shutdown trick will kick in.
</I>&gt;<i> 
</I>&gt;<i> I'll review the perl helper code, or maybe just switch to ufdbGuard.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> Vieri
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016864.html">[squid-users] url_rewrite_program and ACLs
</A></li>
	<LI>Next message (by thread): <A HREF="016876.html">[squid-users] url_rewrite_program and ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16874">[ date ]</a>
              <a href="thread.html#16874">[ thread ]</a>
              <a href="subject.html#16874">[ subject ]</a>
              <a href="author.html#16874">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
