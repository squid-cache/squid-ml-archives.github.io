<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C4563ade7-9bdf-0237-bf8e-2ac6842bdc25%40bk.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016871.html">
   <LINK REL="Next"  HREF="016883.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)</H1>
    <B>A. Benz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C4563ade7-9bdf-0237-bf8e-2ac6842bdc25%40bk.ru%3E"
       TITLE="[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)">ash.benz at bk.ru
       </A><BR>
    <I>Fri Nov 10 12:05:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016871.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
        <LI>Next message (by thread): <A HREF="016883.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16877">[ date ]</a>
              <a href="thread.html#16877">[ thread ]</a>
              <a href="subject.html#16877">[ subject ]</a>
              <a href="author.html#16877">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Thanks for your continued support.

1.

&gt;<i> Do you mean the VPN exit point has that 10/8 IP address? or that the 
</I>&gt;<i> traffic from the client is altered to be going to that IP before it 
</I>&gt;<i> reaches Squid?
</I>&gt;<i>
</I>&gt;<i> The latter is broken because it destroys the original dst-IP values on 
</I>&gt;<i> the TCP connection. Which Squid needs to setup the server connection. 
</I>
Let me put it as an example:

 From the normal internet: mail.amosprivateserver.org &gt; publicly 
accessible IP.

 From my place: mail.amosprivateserver.org &gt; 10.x.x.x (corporate 
network, accessible only from within the place).

Anyways no worries about this! I decided to make an exception in the 
redirect rule, so that if the outgoing traffic matches the IP 10.x.x.x 
then the firewall will not redirect the traffic to squid and instead 
establish a connection directly.

This is not ideal, but it works.


2.

&gt;<i> If for any reason those firewall rules change in unexpected ways or 
</I>&gt;<i> don't block something you expect to be blocked this may leave a 
</I>&gt;<i> security hole open. It does not seem to be necessary really, so best 
</I>&gt;<i> to close. 
</I>
But if I put the lines you told me:

# http_access allow SSL_ports (commented out as you advised)
http_access deny !localnet

Then I can't get any https work per my whitelist (google for example 
complains of HSTS..etc) There must be another thing messed up in my 
config then?


3.

&gt;<i> The point I was trying to emphasize is that your Squid is accepting 
</I>&gt;<i> *anything* in those port 443 connections. 
</I>&gt;<i>
</I>&gt;<i> HSTS requires a header &quot;Strict-Transport-Security&quot; to be delivered 
</I>&gt;<i> from servers before it takes effect. You can erase that header from 
</I>&gt;<i> replies going through Squid with the reply_header_access directive. 
</I>&gt;<i> Current Squid should be doing it automatically.
</I>&gt;<i> There may be issues with HSTS if the header is received before the 
</I>&gt;<i> device connects to your network, or if it arrives over an uncontrolled 
</I>&gt;<i> CONNECT tunnel. But there is not much to be done about those cases. 
</I>I'm not sure I follow (please bare with me!), see I'm simply trying to 
prevent abuse by only allowing connections to whats in whitelist, is my 
approach in my current config doing that? If there's a better way please 
tell me. This is going over a satellite connection with extremely poor 
latency and bandwidth, so Squid's job is to stop the connections from 
reaching out, and only allowing whats in whitelist.


4.

&gt;<i> That means the server that HTTPS connection is attempting to reach is 
</I>&gt;<i> not on your whitelist. It is therefore one of the things you wanted to 
</I>&gt;<i> be blocked according to your stated policy.
</I>&gt;<i>
</I>&gt;<i> &#160;- as I mentioned earlier, if that causes any issues your whitelist is 
</I>&gt;<i> incomplete. 
</I>But it is, eg whitelist.txt has .google.com, shouldn't google.com be 
accessible then (without complaining about HSTS, since I'm splicing?). 
Note if I reverse the commented out lines, as below, then it works:

http_access allow SSL_ports
# http_access deny !localnet (now it works).


As I mentioned no worries about the forgery error as I'm simply adding 
an exception for that to circumvent squid, now I simply need to polish 
up my squid.conf to only allow whats in whitelist (while not consuming 
any unnecessary bandwidth).


Latest version below:

### begin squid.conf

acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

acl SSL_ports port 443

acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT
acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;


http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow SSL_ports
# http_access deny !localnet
http_access allow http_whitelist
http_access allow ips_whitelist
http_access deny all

http_port 3128 ssl-bump \
 &#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
 &#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB

https_port 3130 intercept ssl-bump \
 &#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
 &#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump splice https_whitelist
ssl_bump splice ips_whitelist
ssl_bump terminate all


refresh_pattern ^ftp: 1440 20% 10080
refresh_pattern ^gopher: 1440 0% 1440
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern . 0 20% 4320

store_miss deny all
cache_log /tmp/squid/squid.log
access_log /tmp/squid/access.log
logfile_rotate 0

logfile_daemon /usr/bin/logger
http_port 3129 intercept
coredump_dir /tmp/squid
visible_hostname LEDE.lan
pinger_enable off
mime_table /tmp/squid/mime.conf
sslcrtd_program /usr/lib/squid/ssl_crtd -s /tmp/squid/ssldb -M 4MB

## end config

Regards,
A. Benz

On 11/10/17 03:30, Amos Jeffries wrote:
&gt;<i> On 09/11/17 11:34, A. Benz wrote:
</I>&gt;&gt;<i> Hi Amos,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Many thanks for your detailed reply.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have modified the config following your comments, before you see 
</I>&gt;&gt;<i> the new config (attached below), pls let me know your thoughts on the 
</I>&gt;&gt;<i> following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&gt; The workarounds and gotcha's listed at
</I>&gt;&gt;<i> &#160;&gt; &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are 
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> &#160;&gt; best you can hope for there. The most successful all-round 
</I>&gt;&gt;<i> solution is
</I>&gt;&gt;<i> &#160;&gt; to increase EDNS0 capabilities.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My particular case is a single server only, a corporate email server. 
</I>&gt;&gt;<i> This server is publicly accessible from internet (and has a valid 
</I>&gt;&gt;<i> signed SSL cert), now, on the remote location, there's a VPN setup 
</I>&gt;&gt;<i> that redirects access to the mail server to a private IP, eg 10.x.x.x 
</I>&gt;&gt;<i> (and this differs depending on loadbalance decision).
</I>&gt;<i>
</I>&gt;<i> Do you mean the VPN exit point has that 10/8 IP address? or that the 
</I>&gt;<i> traffic from the client is altered to be going to that IP before it 
</I>&gt;<i> reaches Squid?
</I>&gt;<i>
</I>&gt;<i> The latter is broken because it destroys the original dst-IP values on 
</I>&gt;<i> the TCP connection. Which Squid needs to setup the server connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Without squid, I can connect to webmail, but with squid I get the 
</I>&gt;&gt;<i> forgery error. Does the EDNS0 fix this? See its almost working 
</I>&gt;&gt;<i> exactly as I need now, except for access to this single domain.. so 
</I>&gt;&gt;<i> if there's a workaround (even if it requires a recompile) to ignore 
</I>&gt;&gt;<i> this single domain do let me know.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> EDNS0 fixes problems with services that load balance by rotating the 
</I>&gt;<i> IP addresses delivered in response to A/AAAA queries, possibly 
</I>&gt;<i> omitting some records if the final few don't fit. That results in 
</I>&gt;<i> Squid getting different IPs occasionally than the one the client is 
</I>&gt;<i> using. EDNS0 extends the available DNS response packet size to fit all 
</I>&gt;<i> the records so Squid can see them all even when a large set is rotating.
</I>&gt;<i>
</I>&gt;<i> There are a few major hosting providers that have that behaviour in 
</I>&gt;<i> their DNS. If you have not hit it yet you are very lucky.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&gt; NAT of the dst-IP:port *MUST NOT* happen on any device between the
</I>&gt;&gt;<i> &#160;&gt; client machine and the proxy machine. Squid needs access directly 
</I>&gt;&gt;<i> to the
</I>&gt;&gt;<i> &#160;&gt; kernel NAT records of the device doing that NAT operation. So it can
</I>&gt;&gt;<i> &#160;&gt; only happen on the Squid device.
</I>&gt;&gt;<i> &#160;&gt;&#160;&#160; You must *route* the packets unchanged to the Squid device 
</I>&gt;&gt;<i> (possibly
</I>&gt;&gt;<i> &#160;&gt; over a tunnel if necessary).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It happens on the same device (LEDE/OpenWrt router where squid is 
</I>&gt;&gt;<i> running), so the router is configured to intercept http (80) and 
</I>&gt;&gt;<i> https (443) traffic and redirect it to squid's ports:
</I>&gt;&gt;<i> 80 ---&gt; 3129
</I>&gt;&gt;<i> 443 --&gt; 3130
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&gt; Rather than allowing unlimited access to anyone on the Internet to 
</I>&gt;&gt;<i> use
</I>&gt;&gt;<i> &#160;&gt; your limited bandwidth outbound connection for access to port 443 you
</I>&gt;&gt;<i> &#160;&gt; should be using the localnet ACL that restricts use of the proxy to
</I>&gt;&gt;<i> &#160;&gt; people on your LAN - those 14 clients you mentioned sharing the line.
</I>&gt;&gt;<i> &#160;&gt;
</I>&gt;&gt;<i> &#160;&gt; [NP: It is not possible in this setup to determine what remote 
</I>&gt;&gt;<i> users are
</I>&gt;&gt;<i> &#160;&gt; abusing your proxy. All traffic logs from your firewall etc will show
</I>&gt;&gt;<i> &#160;&gt; Squid as the client, not the remote [ab]user. Squid access.log 
</I>&gt;&gt;<i> records
</I>&gt;&gt;<i> &#160;&gt; you are sending to /dev/null is the *only* record of such 
</I>&gt;&gt;<i> activities.]
</I>&gt;&gt;<i> &#160;&gt;
</I>&gt;&gt;<i> &#160;&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think I didn't word my earlier email properly, apologies for not 
</I>&gt;&gt;<i> being clear. No one from the internet has access to squid, the 
</I>&gt;&gt;<i> listening ports are not open to public, only accessible from LAN.
</I>&gt;<i>
</I>&gt;<i> If for any reason those firewall rules change in unexpected ways or 
</I>&gt;<i> don't block something you expect to be blocked this may leave a 
</I>&gt;<i> security hole open. It does not seem to be necessary really, so best 
</I>&gt;<i> to close.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> With abuse I meant the 14 users.. you know nowadays with 
</I>&gt;&gt;<i> mobiles/tablets and all the apps and syncing, I only allow ports 443 
</I>&gt;&gt;<i> and 80 (and those are intercepted and forwarded to squid). All other 
</I>&gt;&gt;<i> ports are blocked.
</I>&gt;&gt;<i> The bandwidth available is extremely scarce and hence why I'm setting 
</I>&gt;&gt;<i> this up.
</I>&gt;<i>
</I>&gt;<i> The point I was trying to emphasize is that your Squid is accepting 
</I>&gt;<i> *anything* in those port 443 connections.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&gt; To make your whitelists have any effect replace the above &quot;allow
</I>&gt;&gt;<i> &#160;&gt; ssl_ports&quot; line with a &quot;deny !localnet&quot; line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When I do this, it doesn't work anymore. I get &quot;Your connection is 
</I>&gt;&gt;<i> not secure&quot; from firefox, and since google has HSTS, I can't &quot;ignore 
</I>&gt;&gt;<i> and proceed&quot;. The squid access log shows (not .google.com is in 
</I>&gt;&gt;<i> whitelist.txt):
</I>&gt;<i>
</I>&gt;<i> HSTS requires a header &quot;Strict-Transport-Security&quot; to be delivered 
</I>&gt;<i> from servers before it takes effect. You can erase that header from 
</I>&gt;<i> replies going through Squid with the reply_header_access directive. 
</I>&gt;<i> Current Squid should be doing it automatically.
</I>&gt;<i> There may be issues with HSTS if the header is received before the 
</I>&gt;<i> device connects to your network, or if it arrives over an uncontrolled 
</I>&gt;<i> CONNECT tunnel. But there is not much to be done about those cases.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1510180110.096&#160;&#160;&#160;&#160;&#160; 0 192.168.1.178 TCP_DENIED/200 0 CONNECT 
</I>&gt;&gt;<i> 108.177.14.103:443 - HIER_NONE/- -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Once I switch back to &quot;allow SSL_ports&quot; I can connect (squid splices' 
</I>&gt;&gt;<i> the connection, no complaints from firefox).
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That means the server that HTTPS connection is attempting to reach is 
</I>&gt;<i> not on your whitelist. It is therefore one of the things you wanted to 
</I>&gt;<i> be blocked according to your stated policy.
</I>&gt;<i>
</I>&gt;<i> &#160;- as I mentioned earlier, if that causes any issues your whitelist is 
</I>&gt;<i> incomplete.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 5.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I followed your comments about the config changes: changed acls to 
</I>&gt;&gt;<i> match original config in upper case. Swapped&#160; the port numbers, but 
</I>&gt;&gt;<i> about having my ssl-bump match on 3129, pls check my new one see if I 
</I>&gt;&gt;<i> did it right.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ## begin squid.conf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl Safe_ports port 80
</I>&gt;&gt;<i> acl Safe_ports port 443
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;<i> acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access allow SSL_ports
</I>&gt;&gt;<i> # http_access deny !localnet
</I>&gt;&gt;<i> http_access allow http_whitelist
</I>&gt;&gt;<i> http_access allow ips_whitelist
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 3128 ssl-bump \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;<i> ssl_bump splice https_whitelist
</I>&gt;&gt;<i> ssl_bump splice ips_whitelist
</I>&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> store_miss deny all
</I>&gt;&gt;<i> cache_log /tmp/squid/squid.log
</I>&gt;&gt;<i> access_log /tmp/squid/access.log
</I>&gt;&gt;<i> logfile_rotate 0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> logfile_daemon /usr/bin/logger
</I>&gt;&gt;<i> http_port 3129 intercept
</I>&gt;&gt;<i> coredump_dir /tmp/squid
</I>&gt;&gt;<i> visible_hostname LEDE.lan
</I>&gt;&gt;<i> pinger_enable off
</I>&gt;&gt;<i> mime_table /tmp/squid/mime.conf
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /tmp/squid/ssldb -M 4MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ## end config
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Many thanks!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i> A. Benz
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 11/08/17 12:23, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 08/11/17 12:18, A. Benz wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ## Intro
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I read many blogs and emails on this list related to what I'm 
</I>&gt;&gt;&gt;&gt;<i> trying to do, but most go into bumping or do things that are not as 
</I>&gt;&gt;&gt;&gt;<i> simple as I'm trying to achieve.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I have an extremely slow line, with very high latency in a remote 
</I>&gt;&gt;&gt;&gt;<i> location. About 14 people are sharing this line. Nowadays with all 
</I>&gt;&gt;&gt;&gt;<i> the mobile apps trying to sync and such, the line stalls to 
</I>&gt;&gt;&gt;&gt;<i> unusable all the time.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I tried doing filters with firewall or dns level, but those are not 
</I>&gt;&gt;&gt;&gt;<i> effective. In the end I figured squid might be my best option.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ## End intro
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I have squid 3.5.27 running under LEDE (OpenWrt fork), ie its 
</I>&gt;&gt;&gt;&gt;<i> cross-compiled for a MIPS based SoC (mediatek mt7621). I mention 
</I>&gt;&gt;&gt;&gt;<i> this because you will see some options in the config file that 
</I>&gt;&gt;&gt;&gt;<i> won't make sense otherwise.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NP: That should not be making much difference to the squid.conf 
</I>&gt;&gt;&gt;<i> settings. The worst limitations such devices impose are things that 
</I>&gt;&gt;&gt;<i> should be solved by OS settings outside of squid.conf. eg the 
</I>&gt;&gt;&gt;<i> cache.log going to a pipe for remote logging instead of a filename, 
</I>&gt;&gt;&gt;<i> and system-level FD limits.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It works great, here's what I'm trying to achieve: Allow access 
</I>&gt;&gt;&gt;&gt;<i> only to a pre-defined list of websites (whitelist). http is 
</I>&gt;&gt;&gt;&gt;<i> straightforward, but if the connection is https all I need to know 
</I>&gt;&gt;&gt;&gt;<i> is domain, if its allowed, let it pass, otherwise terminate.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> this setup is working as intended with the config attached below, 
</I>&gt;&gt;&gt;&gt;<i> however the issue I'm facing is that some servers are 
</I>&gt;&gt;&gt;&gt;<i> &quot;loadbalanced&quot;, this would give me the forgery error, eg:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> &quot;SECURITY ALERT: Host header forgery detected on....&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The workarounds and gotcha's listed at 
</I>&gt;&gt;&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt; are 
</I>&gt;&gt;&gt;<i> the best you can hope for there. The most successful all-round 
</I>&gt;&gt;&gt;<i> solution is to increase EDNS0 capabilities.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Here's a specific example, there's a corporate domain for webmail 
</I>&gt;&gt;&gt;&gt;<i> access, and some loadbalance config makes use of different IPs, I 
</I>&gt;&gt;&gt;&gt;<i> think this is what triggers the error. My question is, can I just 
</I>&gt;&gt;&gt;&gt;<i> ignore this error somehow and allow the connection? From what I 
</I>&gt;&gt;&gt;&gt;<i> gather this connection is cut by squid before it reaches the client..
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid default behaviour is to allow the connection only to the same 
</I>&gt;&gt;&gt;<i> IP:port the client was connecting to. If that is not working your 
</I>&gt;&gt;&gt;<i> network configuration is screwed up. Specifically your routing or NAT.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NAT of the dst-IP:port *MUST NOT* happen on any device between the 
</I>&gt;&gt;&gt;<i> client machine and the proxy machine. Squid needs access directly to 
</I>&gt;&gt;&gt;<i> the kernel NAT records of the device doing that NAT operation. So it 
</I>&gt;&gt;&gt;<i> can only happen on the Squid device.
</I>&gt;&gt;&gt;<i> &#160;&#160;You must *route* the packets unchanged to the Squid device 
</I>&gt;&gt;&gt;<i> (possibly over a tunnel if necessary).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Also if there's anything else obviously wrong with my setup please 
</I>&gt;&gt;&gt;&gt;<i> let me know.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Many thanks.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Here's my config:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ### squid.conf begin
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;&gt;&gt;&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;&gt;&gt;&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> acl ssl_ports port 443
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> acl safe_ports port 80
</I>&gt;&gt;&gt;&gt;<i> acl safe_ports port 443
</I>&gt;&gt;&gt;&gt;<i> acl connect method connect
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NP: the default above ACL names are case-sensitive and some of them 
</I>&gt;&gt;&gt;<i> involve built-in default values which you are preventing having any 
</I>&gt;&gt;&gt;<i> effect by using custom lower-case ACL names.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> acl http_whitelist dstdomain &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;&gt;&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;&gt;&gt;&gt;<i> acl ips_whitelist dst &quot;/etc/squid/ips.txt&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> http_port 3128 intercept
</I>&gt;&gt;&gt;&gt;<i> http_port 3129
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Port 3128 is registered for forward-proxy traffic. Ideally you would 
</I>&gt;&gt;&gt;<i> have those lines reversed like so:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;http_port 3128
</I>&gt;&gt;&gt;<i> &#160;&#160;http_port 3129 intercept
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ... with the corresponding NAT change for the intercept port.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Also, to have your SSL-Bump whitelists applied to forward-proxy 
</I>&gt;&gt;&gt;<i> CONNECT traffic you should have ssl-bump settings on that 3128 
</I>&gt;&gt;&gt;<i> forward-proxy port matching those on the port 3130 line.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> http_access deny !safe_ports
</I>&gt;&gt;&gt;&gt;<i> http_access deny connect !ssl_ports
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> http_access allow ssl_ports
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Rather than allowing unlimited access to anyone on the Internet to 
</I>&gt;&gt;&gt;<i> use your limited bandwidth outbound connection for access to port 
</I>&gt;&gt;&gt;<i> 443 you should be using the localnet ACL that restricts use of the 
</I>&gt;&gt;&gt;<i> proxy to people on your LAN - those 14 clients you mentioned sharing 
</I>&gt;&gt;&gt;<i> the line.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [NP: It is not possible in this setup to determine what remote users 
</I>&gt;&gt;&gt;<i> are abusing your proxy. All traffic logs from your firewall etc will 
</I>&gt;&gt;&gt;<i> show Squid as the client, not the remote [ab]user. Squid access.log 
</I>&gt;&gt;&gt;<i> records you are sending to /dev/null is the *only* record of such 
</I>&gt;&gt;&gt;<i> activities.]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> To make your whitelists have any effect replace the above &quot;allow 
</I>&gt;&gt;&gt;<i> ssl_ports&quot; line with a &quot;deny !localnet&quot; line.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If that change causes issues then your whitelists are incorrect / 
</I>&gt;&gt;&gt;<i> incomplete. You then need the (currently discarded) access.log 
</I>&gt;&gt;&gt;<i> and/or cache.log data to solve the issue properly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> http_access allow http_whitelist
</I>&gt;&gt;&gt;&gt;<i> http_access allow ips_whitelist
</I>&gt;&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;cert=/etc/squid/myCA.pem \
</I>&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;generate-host-certificates=off dynamic_cert_mem_cache_size=4MB
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;&gt;<i> ssl_bump splice https_whitelist
</I>&gt;&gt;&gt;&gt;<i> ssl_bump splice ips_whitelist
</I>&gt;&gt;&gt;&gt;<i> ssl_bump terminate all
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That seems fine. The problem is not part of this _config_. If you 
</I>&gt;&gt;&gt;<i> are having any SSL-Bump issues please try a build of the latest 
</I>&gt;&gt;&gt;<i> Squid-4. It may be related to bugs in Squid-3 SSL-Bump or modern TLS 
</I>&gt;&gt;&gt;<i> things Squid-3 cannot cope with - there is a growing list of those.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> cache deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In the latest Squid-3 use &quot;store_miss deny all&quot; instead of the above.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> access_log none
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The above is fine if you are certain of the squid.conf working 100% 
</I>&gt;&gt;&gt;<i> properly. But since you are debugging issues you may need those 
</I>&gt;&gt;&gt;<i> transaction details.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NP: access.log can be logged to syslog or a TCP pipe by Squid. To 
</I>&gt;&gt;&gt;<i> deliver the log content externally for normal audit purposes instead 
</I>&gt;&gt;&gt;<i> of using space on the device.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> cache_log /dev/null
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> You *need* the information logged here. By default only the most 
</I>&gt;&gt;&gt;<i> operationally critical errors are recorded.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> NP: the cache.log can usually be a Unix-pipe delivering data to a 
</I>&gt;&gt;&gt;<i> remote server if the local machine is constrained.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> cache_store_log stdio:/dev/null
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Above line is *actively* harmful. The Squid-3 default is not to 
</I>&gt;&gt;&gt;<i> waste cycles logging *unless* you enter something like the above in 
</I>&gt;&gt;&gt;<i> squid.conf. The above makes Squid allocate device resources to 
</I>&gt;&gt;&gt;<i> logging that data to /dev/null.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> logfile_rotate 0
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> logfile_daemon /dev/null
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> /dev/null is not a valid application filename.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Build your Squid with --disable-logfile-daemon.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> coredump_dir /tmp/squid
</I>&gt;&gt;&gt;&gt;<i> visible_hostname main_Firewall
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The *visible* hostname is the domain delivered to clients and denied 
</I>&gt;&gt;&gt;<i> parties in the URLs to fetch error message data and FTP icons from 
</I>&gt;&gt;&gt;<i> Squid. It needs to be a valid FQDN.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171110/4573beb0/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171110/4573beb0/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016871.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
	<LI>Next message (by thread): <A HREF="016883.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16877">[ date ]</a>
              <a href="thread.html#16877">[ thread ]</a>
              <a href="subject.html#16877">[ subject ]</a>
              <a href="author.html#16877">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
