<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID memory error after vm.swappines changed from 60 to 10
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20memory%20error%20after%20vm.swappines%20changed%0A%20from%2060%20to%2010&In-Reply-To=%3CCAAPixKjhfEEXeoY7GHRCo%3D2Pmc3s0HqQkGPWTEH5LOYCfD3YCQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016870.html">
   <LINK REL="Next"  HREF="016881.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID memory error after vm.swappines changed from 60 to 10</H1>
    <B>Bike dernikov1</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20memory%20error%20after%20vm.swappines%20changed%0A%20from%2060%20to%2010&In-Reply-To=%3CCAAPixKjhfEEXeoY7GHRCo%3D2Pmc3s0HqQkGPWTEH5LOYCfD3YCQ%40mail.gmail.com%3E"
       TITLE="[squid-users] SQUID memory error after vm.swappines changed from 60 to 10">dernikov1 at gmail.com
       </A><BR>
    <I>Fri Nov 10 14:11:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016870.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
        <LI>Next message (by thread): <A HREF="016881.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16879">[ date ]</a>
              <a href="thread.html#16879">[ thread ]</a>
              <a href="subject.html#16879">[ subject ]</a>
              <a href="author.html#16879">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Nov 9, 2017 at 5:13 PM, Marcus Kool &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">marcus.kool at urlfilterdb.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 09/11/17 11:04, Bike dernikov1 wrote:
</I>&gt;<i> [snip]
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Memory compsumption:squid use largest part of memory  (12GB now,
</I>&gt;&gt;&gt;&gt;<i> second proces use 300MB memory), 14GB used by all process. So squid
</I>&gt;&gt;&gt;&gt;<i> use over 80% of total used memory.
</I>&gt;&gt;&gt;&gt;<i> So no there are not any problematic process. But we changed swappiness
</I>&gt;&gt;&gt;&gt;<i> settings.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Did you monitor Squid for growth (it can start with 12 GB and grow
</I>&gt;&gt;&gt;<i> slowly) ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes we are monitoring continuosly.
</I>&gt;&gt;<i> Now:
</I>&gt;&gt;<i> Output from free -m.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>             total       used    free   shared  buff/cache  available
</I>&gt;&gt;<i> Mem:  24101     20507  256    146      3337         3034
</I>&gt;&gt;<i> Swap: 24561      5040   19521
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> vm.swappiness=40
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Memory by process:
</I>&gt;&gt;<i> squid  Virt       RES   SHR  MEM%
</I>&gt;&gt;<i>             22,9G  18.7   8164   79,6
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hmm. Squid grew from 12 GB to 18.7 GB (23 GB virtual).
</I>
Today problem appeared again after logrotate at 2.56AM.
Used memory was at peek 23,7GB.
Before logrorate started, cached was at 2GB, buffer at 1,5GB.
After logrorate started cache jumped to 3.7GB and buffer unchanged at 1,5GB.

Fork errors stopped after 1 minute. At 2:57.
cache memory dropped by 500MB  to 3.2GB and continued at same level
till morning, buffer  same at 1.5GB.

After 4 at 3:00 minutes new WARNING appeared. external ACL queue
overload. Using stale results.

We have night shift and they told us that Internet worked ok.

After restart at around 7.00AM used memory dropped from 22 GB to 7GB,
cache and buffer remain at same levels.

&gt;<i> With vm.swappiness=40 Linux starts to page out parts of processes when they
</I>&gt;<i> occupy more than 60% of the memory.
</I>&gt;<i> This is a potential bottleneck and I would have also decreased vm.swappiness
</I>&gt;<i> to 10 as you did.
</I>&gt;<i>
</I>&gt;<i> My guess is that Squid starts too many helpers in a short time frame and
</I>&gt;<i> that because of paging there are too many forks in progress simultaneously
</I>&gt;<i> which causes the memory exhaustion.
</I>
We are now testing with 100 helpers for negotiate_kerberos_auth.
vm.swappiness returned to 60.

&gt;<i> I suggest to reduce the memory cache of Squid by 50% and set vm.swappiness
</I>&gt;<i> to 20.
</I>
Squid cache memory is set at 14GB reduced from 16GB from 20GB  in two turns.

&gt;<i> And then observe:
</I>&gt;<i> - total memory use
</I>&gt;<i> - total swap usage (should be lower than the 5 GB that you have now)
</I>&gt;<i> - number of helper processes that are started in short time frames
</I>&gt;<i> And then in small steps increase the memory cache and maybe further reduce
</I>&gt;<i> vm.swappiness to 10.
</I>
If we survive with actual setup, we will continue with reducing as you suggest.
Last extreme will be swap disable swappof but just for test with 6
eyes on monitoring :)

&gt;&gt;<i> squidguard two process  300MB boths,.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> CPU 0.33 0.37 0.43
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid cannot fork and higher swappiness increases the amount of memory
</I>&gt;&gt;&gt;<i> that
</I>&gt;&gt;&gt;<i> the OS can use to copy processes.
</I>&gt;&gt;&gt;<i> It makes me think that you have the memory overcommit set to 2 (no
</I>&gt;&gt;&gt;<i> overcommit).
</I>&gt;&gt;&gt;<i> What is the output of the following command ?
</I>&gt;&gt;&gt;<i>     sysctl  -a | grep overcommit
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Command output:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> vm.nr_overcommit_hugepages = 0
</I>&gt;&gt;<i> vm.overcommit_kbytes = 0
</I>&gt;&gt;<i> vm.overcommit_memory = 0
</I>&gt;&gt;<i> vm.overcommit_ratio = 50
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cat /proc/sys/vm/overcommit_memory
</I>&gt;&gt;<i> 0
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The overcommit settings look fine.
</I>
At least something right :)

&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Advice for some settings:
</I>&gt;&gt;&gt;&gt;<i> We have absolute max peak of  2500 users which user squid (of 2800),
</I>&gt;&gt;&gt;&gt;<i> what are recomended settings for:
</I>&gt;&gt;&gt;&gt;<i> negotiate_kerberos_children start/idle
</I>&gt;&gt;&gt;&gt;<i> squidguard helpers.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have little experience with kerberos, but most likely this is not the
</I>&gt;&gt;&gt;<i> issue.
</I>&gt;&gt;&gt;<i> When Squid cannot fork the helpers, helper settings do not matter much.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> For 2500 users you probably need 32-64 squidguard helpers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can you confirm: For 2500 users:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> url_rewrite children X (squidguard)  32-64 will be ok ? We have set
</I>&gt;&gt;<i> much larger number.
</I>
Squidguard url_rewrite children was set to 64.

&gt;<i> Did I understand it correctly that earlier in this reply you said that there
</I>&gt;<i> are two squidguard processes (300 MB each).
</I>
Yes (first two process in htop, two rewrite childrens) others was on 0.0%.

&gt;<i> ufdbGuard is faster than squidGuard and has multithreaded helpers.
</I>&gt;<i> ufdbGuard needs less helpers than squidGuard.
</I>&gt;<i> If you have a much larger number than 64 url rewrite helpers than I suggest
</I>&gt;<i> to switch to ufdbGuard as soon as possible since the memory usage is then at
</I>&gt;<i> least 600% less.
</I>
UfdbGuard have few strong features. Development, kerberos,
concurency/multitreading.
As i wrote, if we read documentation slower we wouldn't
Do ufdbGuard supoort ldap secure auth ? We tried ldap secure with
squidguard without success.

&gt;&gt;<i> For  helper:
</I>&gt;&gt;<i> negotitate_kerberos_auth
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> auth_param negotiate children X startup Y idle Z. What X, Y, Z are
</I>&gt;&gt;<i> best for our user number ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We disabled kerberos replay cache because of disk performance (4 SAS
</I>&gt;&gt;<i> DISK  15K, RAID 10) (iowait jumped high, and CPU load jumped to min
</I>&gt;&gt;<i> 40 max 200).
</I>&gt;&gt;<i> We don't use disk caching.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for help,
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Marcus
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thanks for help,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Wed, Nov 8, 2017 at 10:53 AM, Marcus Kool
</I>&gt;&gt;&gt;&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">marcus.kool at urlfilterdb.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> There is definitely a problem with available memory because Squid
</I>&gt;&gt;&gt;&gt;&gt;<i> cannot
</I>&gt;&gt;&gt;&gt;&gt;<i> fork.
</I>&gt;&gt;&gt;&gt;&gt;<i> So start with looking at how much memory Squid and its helpers use.
</I>&gt;&gt;&gt;&gt;&gt;<i> Do do have other processes on this system that consume a lot of memory
</I>&gt;&gt;&gt;&gt;&gt;<i> ?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Also note that ufdbGuard uses less memory that squidGuard.
</I>&gt;&gt;&gt;&gt;&gt;<i> If there are 30 helpers squidguard uses 300% more memory than
</I>&gt;&gt;&gt;&gt;&gt;<i> ufdbGuard.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Look at the wiki for more information about memory usage:
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidMemory">https://wiki.squid-cache.org/SquidFaq/SquidMemory</A>   (currently has an
</I>&gt;&gt;&gt;&gt;&gt;<i> expired certificate but it is safe to go ahead)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Marcus
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 08/11/17 07:26, Bike dernikov1 wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Hi, I hope that someone can explain what happened, why squid stopped
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> working.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The problem is related to  memory/swap handling.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> After we changed vm.swappiness parameter from 60 to 10 (tuning
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> attempt, to lower a disk usage, because we have only 4 disks in a
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> RAID10, so disk subsystem  is a weak link), we got a lot of errors in
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> cache.log.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The problems started after scheduled logrotate after  2AM.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Squid ran out of memory, auth helpers stopped working.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> It's weird because we didn't disable swap, but behavior is like we
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> did.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> After an error, we increased parameter from 10 to 40.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The server has 24GB DDR3 memory,  disk swap set to 24GB, 12 CPU (24HT
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> cores).
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> We have 2800 users, using  kerberos authentication, squidguard for
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> filtering, ldap authorization.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> When problem appeared memory was still 3GB free (free column), ram
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> (caching) was filled to 15GB, so 21 GB ram filled, 3GB free.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Thanks for help,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> errors from cache.log.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:27| Set Current Directory to /var/log/squid/
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1| storeDirWriteCleanLogs: Starting...
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1|   Finished.  Wrote 0 entries.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1|   Took 0.00 seconds (  0.00 entries/sec).
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1| logfileRotate:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> daemon:/var/log/squid/access.log
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:27 kid1| logfileRotate:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> daemon:/var/log/squid/access.log
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| Pinger socket opened on FD 30
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| helperOpenServers: Starting 1/1000
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 'squidGuard' processes
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run '/usr/bin/squidGuard'
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> process.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| helperOpenServers: Starting 300/3000
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 'negotiate_kerberos_auth' processes
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> '/usr/lib/squid/negotiate_kerberos_auth' process.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> '/usr/lib/squid/negotiate_kerberos_auth' process.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| ipcCreate: fork: (12) Cannot allocate memory
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2017/11/08 02:55:28 kid1| WARNING: Cannot run
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> '/usr/lib/squid/negotiate_kerberos_auth' process.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> external ACL 'memberof' queue overload. Using stale result.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016870.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
	<LI>Next message (by thread): <A HREF="016881.html">[squid-users] SQUID memory error after vm.swappines changed from 60 to 10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16879">[ date ]</a>
              <a href="thread.html#16879">[ thread ]</a>
              <a href="subject.html#16879">[ subject ]</a>
              <a href="author.html#16879">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
