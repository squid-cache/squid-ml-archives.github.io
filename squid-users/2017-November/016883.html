<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C0de1efc3-3587-1584-0d32-735974f39600%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016877.html">
   <LINK REL="Next"  HREF="016884.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non%20intrusive%20sslbump%20for%20whitelisting%20%28asked%0A%20many%20times%20but..%29&In-Reply-To=%3C0de1efc3-3587-1584-0d32-735974f39600%40treenet.co.nz%3E"
       TITLE="[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Nov 11 01:03:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016877.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
        <LI>Next message (by thread): <A HREF="016884.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16883">[ date ]</a>
              <a href="thread.html#16883">[ thread ]</a>
              <a href="subject.html#16883">[ subject ]</a>
              <a href="author.html#16883">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/11/17 01:05, A. Benz wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Thanks for your continued support.
</I>&gt;<i> 
</I>&gt;<i> 1.
</I>&gt;<i> 
</I>&gt;&gt;<i> Do you mean the VPN exit point has that 10/8 IP address? or that the 
</I>&gt;&gt;<i> traffic from the client is altered to be going to that IP before it 
</I>&gt;&gt;<i> reaches Squid?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The latter is broken because it destroys the original dst-IP values on 
</I>&gt;&gt;<i> the TCP connection. Which Squid needs to setup the server connection. 
</I>&gt;<i> 
</I>&gt;<i> Let me put it as an example:
</I>&gt;<i> 
</I>&gt;<i>  From the normal internet: mail.amosprivateserver.org &gt; publicly 
</I>&gt;<i> accessible IP.
</I>&gt;<i> 
</I>&gt;<i>  From my place: mail.amosprivateserver.org &gt; 10.x.x.x (corporate 
</I>&gt;<i> network, accessible only from within the place).
</I>&gt;<i> 
</I>&gt;<i> Anyways no worries about this! I decided to make an exception in the 
</I>&gt;<i> redirect rule, so that if the outgoing traffic matches the IP 10.x.x.x 
</I>&gt;<i> then the firewall will not redirect the traffic to squid and instead 
</I>&gt;<i> establish a connection directly.
</I>&gt;<i> 
</I>&gt;<i> This is not ideal, but it works.
</I>&gt;<i> 
</I>
Or have Squid relay everything through the same server(s) and
the server do the distinguishing between traffic and just relay 
everythign to the same


&gt;<i> 
</I>&gt;<i> 2.
</I>&gt;<i> 
</I>&gt;&gt;<i> If for any reason those firewall rules change in unexpected ways or 
</I>&gt;&gt;<i> don't block something you expect to be blocked this may leave a 
</I>&gt;&gt;<i> security hole open. It does not seem to be necessary really, so best 
</I>&gt;&gt;<i> to close. 
</I>&gt;<i> 
</I>&gt;<i> But if I put the lines you told me:
</I>&gt;<i> 
</I>&gt;<i> # http_access allow SSL_ports (commented out as you advised)
</I>&gt;<i> http_access deny !localnet
</I>&gt;<i> 
</I>&gt;<i> Then I can't get any https work per my whitelist (google for example 
</I>&gt;<i> complains of HSTS..etc) There must be another thing messed up in my 
</I>&gt;<i> config then?
</I>&gt;<i> 
</I>
Seems so.

&gt;<i> 
</I>&gt;<i> 3.
</I>&gt;<i> 
</I>&gt;&gt;<i> The point I was trying to emphasize is that your Squid is accepting 
</I>&gt;&gt;<i> *anything* in those port 443 connections. 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HSTS requires a header &quot;Strict-Transport-Security&quot; to be delivered 
</I>&gt;&gt;<i> from servers before it takes effect. You can erase that header from 
</I>&gt;&gt;<i> replies going through Squid with the reply_header_access directive. 
</I>&gt;&gt;<i> Current Squid should be doing it automatically.
</I>&gt;&gt;<i> There may be issues with HSTS if the header is received before the 
</I>&gt;&gt;<i> device connects to your network, or if it arrives over an uncontrolled 
</I>&gt;&gt;<i> CONNECT tunnel. But there is not much to be done about those cases. 
</I>&gt;<i> I'm not sure I follow (please bare with me!), see I'm simply trying to 
</I>&gt;<i> prevent abuse by only allowing connections to whats in whitelist, is my 
</I>&gt;<i> approach in my current config doing that? If there's a better way please 
</I>&gt;<i> tell me. This is going over a satellite connection with extremely poor 
</I>&gt;<i> latency and bandwidth, so Squid's job is to stop the connections from 
</I>&gt;<i> reaching out, and only allowing whats in whitelist.
</I>&gt;<i> 
</I>
HSTS is enabled on if the client receives a header called 
&quot;Strict-Transport-Security&quot;. And only for a time indicated by the header 
itself.

So removing that header prevents HSTS being turned on in the client.

However the client can receive that header via any one of several 
different protocols (eg. HTTP/2, SPDY, QUIC, and HTTPS if you are 
splicing any of it). So preventing HSTS breaking things randomly 
requires they be blocked and only the filtered traffic allowed.

&gt;<i> 
</I>&gt;<i> 4.
</I>&gt;<i> 
</I>&gt;&gt;<i> That means the server that HTTPS connection is attempting to reach is 
</I>&gt;&gt;<i> not on your whitelist. It is therefore one of the things you wanted to 
</I>&gt;&gt;<i> be blocked according to your stated policy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;- as I mentioned earlier, if that causes any issues your whitelist is 
</I>&gt;&gt;<i> incomplete. 
</I>&gt;<i> But it is, eg whitelist.txt has .google.com, shouldn't google.com be 
</I>&gt;<i> accessible then (without complaining about HSTS, since I'm splicing?). 
</I>

Splicing allows traffic to go through without the HSTS header removal. 
So the above (3) issues from HSTS maybe still happening.


As a general rule of thumb, if you are splicing a domain never bump it 
and if you are wanting to bump it never splice it nor allow any other 
ways to reach it except through the bumping proxy.

It is technically possible to transition a domain from being 
spliced/relayed to bumped, but it can be a painful process involving a 
lot of unavoidable TLS related &quot;errors&quot; for clients during the 
transition timeout dictated by the HSTS header and/or similar things.


As to the whitelist 'not working'. Earlier you posted a access.log entry 
that contained:

  1510180110.096      0 192.168.1.178 TCP_DENIED/200 0 CONNECT
    108.177.14.103:443 - HIER_NONE/- -

Note how that IP address is *not* a domain in *.google.com.
Even its reverse-DNS does not match *.google.com.

Googles rDNS server names are in *.1e100.net domain, not *.google.com. 
They also have a lot of other service name crossovers like &quot;YouTube&quot; 
actually being *.googlevideos.com, and gmail actually being 
docs.google.com sometimes (heh!).


To access any service with SSL-Bump your whitelist needs to allow its 
public domain name(s), reverse-DNS server name(s), and maybe also raw-IP 
address(s). That goes for any service, not just Google's.


And ... that rule of thumb I mention above applies to the entire bunch 
as a collective service. That is where major corps like Google cause 
headaches simply by having so many inter-related pieces with crossover 
like gmail and youtube domains vs the 1e100.net reverse-DNS.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016877.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
	<LI>Next message (by thread): <A HREF="016884.html">[squid-users] Non intrusive sslbump for whitelisting (asked many times but..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16883">[ date ]</a>
              <a href="thread.html#16883">[ thread ]</a>
              <a href="subject.html#16883">[ subject ]</a>
              <a href="author.html#16883">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
