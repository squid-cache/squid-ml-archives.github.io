<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 4.0.21 Ssl bump access denied
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%204.0.21%20Ssl%20bump%20access%20denied&In-Reply-To=%3CCADYcWGT6Aq7zzZo4CGxymCBo31jzJA_Jwh1d%3DRzG3UhgGAZ0KQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016887.html">
   <LINK REL="Next"  HREF="016889.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 4.0.21 Ssl bump access denied</H1>
    <B>snable snable</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%204.0.21%20Ssl%20bump%20access%20denied&In-Reply-To=%3CCADYcWGT6Aq7zzZo4CGxymCBo31jzJA_Jwh1d%3DRzG3UhgGAZ0KQ%40mail.gmail.com%3E"
       TITLE="[squid-users] 4.0.21 Ssl bump access denied">thesnable at gmail.com
       </A><BR>
    <I>Sun Nov 12 12:25:00 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016887.html">[squid-users] 4.0.21 Ssl bump access denied
</A></li>
        <LI>Next message (by thread): <A HREF="016889.html">[squid-users] 4.0.21 Ssl bump access denied
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16888">[ date ]</a>
              <a href="thread.html#16888">[ thread ]</a>
              <a href="subject.html#16888">[ subject ]</a>
              <a href="author.html#16888">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Access.log brings for www.heise.de on https

NECT 192.168.1.222:443 - HIER_NONE/- -
1510489280.731      2 192.168.1.200 NONE/200 0 CO
NNECT 192.168.1.222:443 - HIER_NONE/- -
1510489280.836      1 192.168.1.200 TCP_MISS/503
4691 GET <A HREF="https://www.heise.de/">https://www.heise.de/</A> - ORIGINAL_DST/192
.168.1.222 text/html
1510489280.892      1 192.168.1.200 TCP_MISS/503
4703 GET <A HREF="https://www.heise.de/favicon.ico">https://www.heise.de/favicon.ico</A> - ORIGI
NAL_DST/192.168.1.222 text/html
1510489283.136      2 192.168.1.200 NONE/200 0 CO
NNECT 192.168.1.222:443 - HIER_NONE/- -
1510489283.224      1 192.168.1.200 TCP_MISS/503


Am 12.11.2017 12:46 schrieb &quot;snable snable&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">thesnable at gmail.com</A>&gt;:



hey

thanks:

i post in detail

i have an openwrt box. clients are attached there to the 192.168.2.0/24
network via nat. i attached the router as a wan device on my 192.168.1.0/24
with 192.168.1.254 as my internet gateway.

i have a squidbox  with squid 4 running on ports 3128 and 3129 and 3130.
 i forward the traffic from the openwrt via:


iptables -t mangle -A PREROUTING -j ACCEPT -p tcp
 --dport 80 -s 192.168.1.222
iptables -t mangle -A PREROUTING -j MARK --set-ma
rk 3 -p tcp --dport 80
iptables -t mangle -A PREROUTING -j ACCEPT -p tcp
 --dport 443 -s 192.168.1.222
iptables -t mangle -A PREROUTING -j MARK --set-ma
rk 3 -p tcp --dport 443
ip rule add fwmark 3 table 2
ip route add default via 192.168.1.222 dev eth0.2
 table 2

on the squid box redirected it via

iptables -A PREROUTING -t nat -i eth0 -p tcp --dp
ort 443 -j REDIRECT --to-port 3129

iptables -A PREROUTING -t nat -i eth0 -p tcp --dp
ort 80 -j REDIRECT --to-port 3128


http works fine


https brings:

ERRORThe requested URL could not be retrieved
------------------------------

The following error was encountered while trying to retrieve the URL:
<A HREF="https://192.168.1.222/*">https://192.168.1.222/*</A>

*Connection to 192.168.1.222 failed.*

The system returned: *(111) Connection refused*

The remote host or network may be down. Please try the request again.

Your cache administrator is webmaster
&lt;webmaster?subject=CacheErrorInfo%20-%20ERR_CONNECT_FAIL&amp;body=CacheHost%3A%20raspberrypi%0D%0AErrPage%3A%20ERR_CONNECT_FAIL%0D%0AErr%3A%20%28111%29%20Connection%20refused%0D%0ATimeStamp%3A%20Sun,%2012%20Nov%202017%2011%3A44%3A04%20GMT%0D%0A%0D%0AClientIP%3A%20192.168.1.200%0D%0AServerIP%3A%20192.168.1.222%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%2F%20HTTP%2F1.1%0AHost%3A%20192.168.1.222%0D%0A%0D%0A%0D%0A&gt;
.




i had this working a while ago but i forget how.


Am 08.11.2017 05:32 schrieb &quot;Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:

&gt;<i> On 08/11/17 04:52, snable snable wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> i forward from.my openwrt router the traffic for 443 and 80 to my squid
</I>&gt;&gt;<i> box to port 3129 and 3128
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> What do you mean by &quot;forward&quot; ?
</I>&gt;<i>
</I>&gt;<i> Any dst-IP:port NAT operation *MUST* only happen on the Squid device
</I>&gt;<i> itself or _later_ down the traffic path. Traffic must be *routed* to that
</I>&gt;<i> Squid device.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171112/6a23c335/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171112/6a23c335/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016887.html">[squid-users] 4.0.21 Ssl bump access denied
</A></li>
	<LI>Next message (by thread): <A HREF="016889.html">[squid-users] 4.0.21 Ssl bump access denied
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16888">[ date ]</a>
              <a href="thread.html#16888">[ thread ]</a>
              <a href="subject.html#16888">[ subject ]</a>
              <a href="author.html#16888">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
