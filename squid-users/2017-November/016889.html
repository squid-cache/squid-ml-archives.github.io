<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 4.0.21 Ssl bump access denied
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%204.0.21%20Ssl%20bump%20access%20denied&In-Reply-To=%3C189607aa-58c1-83ba-2653-6b052fbe8efc%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016888.html">
   <LINK REL="Next"  HREF="016827.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 4.0.21 Ssl bump access denied</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%204.0.21%20Ssl%20bump%20access%20denied&In-Reply-To=%3C189607aa-58c1-83ba-2653-6b052fbe8efc%40treenet.co.nz%3E"
       TITLE="[squid-users] 4.0.21 Ssl bump access denied">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Nov 13 04:04:49 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016888.html">[squid-users] 4.0.21 Ssl bump access denied
</A></li>
        <LI>Next message (by thread): <A HREF="016827.html">[squid-users] ERR_ICAP_FAILURE unless squid reconfigure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16889">[ date ]</a>
              <a href="thread.html#16889">[ thread ]</a>
              <a href="subject.html#16889">[ subject ]</a>
              <a href="author.html#16889">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/11/17 01:25, snable snable wrote:
&gt;<i> Access.log brings for www.heise.de on https
</I>&gt;<i> 
</I>&gt;<i> NECT 192.168.1.222:443 &lt;<A HREF="http://192.168.1.222:443">http://192.168.1.222:443</A>&gt; - HIER_NONE/- -
</I>&gt;<i> 1510489280.731&#160; &#160; &#160; 2 192.168.1.200 NONE/200 0 CO
</I>&gt;<i> NNECT 192.168.1.222:443 &lt;<A HREF="http://192.168.1.222:443">http://192.168.1.222:443</A>&gt; - HIER_NONE/- -
</I>&gt;<i> 1510489280.836&#160; &#160; &#160; 1 192.168.1.200 TCP_MISS/503
</I>&gt;<i> 4691 GET <A HREF="https://www.heise.de/">https://www.heise.de/</A> - ORIGINAL_DST/192
</I>&gt;<i> .168.1.222 text/html
</I>

ORIGINAL_DST is the server IP your system NAT tables say the client is 
connecting to.

So the above means the NAT system is intercepting the client at 
192.168.1.200 connecting to the webserver at 192.168.1.222:443.


&gt;<i> 
</I>&gt;<i> Am 12.11.2017 12:46 schrieb &quot;snable snable&quot; wrote:
</I>&gt;<i> 
</I>&gt;<i>         hey
</I>&gt;<i> 
</I>&gt;<i>         thanks:
</I>&gt;<i> 
</I>&gt;<i>         i post in detail
</I>&gt;<i> 
</I>&gt;<i>         i have an openwrt box. clients are attached there to the
</I>&gt;<i>         192.168.2.0/24 &lt;<A HREF="http://192.168.2.0/24">http://192.168.2.0/24</A>&gt; network via nat. i
</I>&gt;<i>         attached the router as a wan device on my 192.168.1.0/24
</I>&gt;<i>         &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; with 192.168.1.254 as my internet gateway.
</I>&gt;<i> 
</I>&gt;<i>         i have a squidbox&#160; with squid 4 running on ports 3128 and 3129
</I>&gt;<i>         and 3130.
</I>&gt;<i>          &#160;i forward the traffic from the openwrt via:
</I>&gt;<i> 
</I>&gt;<i>         iptables -t mangle -A PREROUTING -j ACCEPT -p tcp
</I>&gt;<i>          &#160;--dport 80 -s 192.168.1.222
</I>&gt;<i>         iptables -t mangle -A PREROUTING -j MARK --set-ma
</I>&gt;<i>         rk 3 -p tcp --dport 80
</I>&gt;<i>         iptables -t mangle -A PREROUTING -j ACCEPT -p tcp
</I>&gt;<i>          &#160;--dport 443 -s 192.168.1.222
</I>&gt;<i>         iptables -t mangle -A PREROUTING -j MARK --set-ma
</I>&gt;<i>         rk 3 -p tcp --dport 443
</I>&gt;<i>         ip rule add fwmark 3 table 2
</I>&gt;<i>         ip route add default via 192.168.1.222 dev eth0.2
</I>&gt;<i>          &#160;table 2
</I>&gt;<i> 
</I>&gt;<i>         on the squid box redirected it via
</I>&gt;<i> 
</I>&gt;<i>         iptables -A PREROUTING -t nat -i eth0 -p tcp --dp
</I>&gt;<i>         ort 443 -j REDIRECT --to-port 3129
</I>&gt;<i>         iptables -A PREROUTING -t nat -i eth0 -p tcp --dp
</I>&gt;<i>         ort 80 -j REDIRECT --to-port 3128
</I>&gt;<i> 
</I>
There are no rules above preventing the NAT system intercepting the 
Squid outbound traffic.

Please see the iptables rules documented at: 
&lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;.

-j ACCEPT in the *mangle* table only means iptables does not do your 
MARKing. It has no effect on these NAT table operations.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016888.html">[squid-users] 4.0.21 Ssl bump access denied
</A></li>
	<LI>Next message (by thread): <A HREF="016827.html">[squid-users] ERR_ICAP_FAILURE unless squid reconfigure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16889">[ date ]</a>
              <a href="thread.html#16889">[ thread ]</a>
              <a href="subject.html#16889">[ subject ]</a>
              <a href="author.html#16889">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
