<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 3.5.27 . https website
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.27%20.%20https%20website&In-Reply-To=%3Cf2c05d8f-2184-0622-83a0-5c481c13a064%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016944.html">
   <LINK REL="Next"  HREF="016952.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 3.5.27 . https website</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%203.5.27%20.%20https%20website&In-Reply-To=%3Cf2c05d8f-2184-0622-83a0-5c481c13a064%40treenet.co.nz%3E"
       TITLE="[squid-users] squid 3.5.27 . https website">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Nov 17 04:13:40 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016944.html">[squid-users] squid 3.5.27 . https website
</A></li>
        <LI>Next message (by thread): <A HREF="016952.html">[squid-users] forward proxy to reverse proxy to app
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16951">[ date ]</a>
              <a href="thread.html#16951">[ thread ]</a>
              <a href="subject.html#16951">[ subject ]</a>
              <a href="author.html#16951">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/11/17 15:32, G~D~Lunatic wrote:
&gt;<i> i use squid 3.5.27 as a transparent proxy.
</I>
Small correction: You have configured NAT interception proxy with 
SSL-Bump'ing. Not truly transparent.
  There are some vital differences. Most specific to your case is that 
interception proxies do alter the traffic in significant ways (not 
transparently relay as-is).


&gt;<i> With the proxy , i access 
</I>&gt;<i> some https websites like www.hupu.com. But the 
</I>&gt;<i> webpage does not show correctly.&#160; There are some websizes similar such 
</I>&gt;<i> as <A HREF="https://www.zhihu.com,">https://www.zhihu.com,</A> <A HREF="https://www.jd.com/.">https://www.jd.com/.</A> So i want to know where problem is or how to 
</I>&gt;<i> deal with it.
</I>&gt;<i> 
</I>&gt;<i> The webpage remind like&quot; &#160; s1.hdslb.com used an invalid security 
</I>&gt;<i> certificate. This certificate is valid for the following domain names 
</I>&gt;<i> only: * .zhaopin.com, * .zhaopin.cn, * .dpfile.com, * .cdn.myqcloud.com, 
</I>&gt;<i> * .sogoucdn. SSL error code: SSL_ERROR_BAD_CERT_DOMAIN&#160; &quot;
</I>&gt;<i> 
</I>&gt;<i> how can i send a screenshot to explain?
</I>&gt;<i> Here is my configure
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160; # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12&#160; # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly plugged) 
</I>&gt;<i> machines
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http
</I>&gt;<i> acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp
</I>&gt;<i> acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https
</I>&gt;<i> acl Safe_ports port 70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gopher
</I>&gt;<i> acl Safe_ports port 210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # wais
</I>&gt;<i> acl Safe_ports port 1025-65535&#160; # unregistered ports
</I>&gt;<i> acl Safe_ports port 280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt
</I>&gt;<i> acl Safe_ports port 488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gss-http
</I>&gt;<i> acl Safe_ports port 591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # filemaker
</I>&gt;<i> acl Safe_ports port 777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow all
</I>
*Extremely* unsafe configuration. This proxy is now an &quot;open proxy&quot;. 
Anybody can abuse it for any use whatsoever.

Combined with how you have disabled below recording of all TLS traffic 
problems (and thus hacking attempts) and do server-first bumping of 
clients what you end up with is a remarkably dangerous piece of software 
whose most useful property is being a way to attack your network. :-(



&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> acl NCACHE method GET
</I>&gt;<i> no_cache deny NCACHE
</I>
&quot;no_cache&quot; is an deprecated directive. It was removed because it 
confused people. Delete the &quot;no_&quot; prefix.


Also, most other methods are not cacheable. So why not do it the simple way?

  cache deny all
or
  store_miss deny all


&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> request_header_access Via deny all #hide squid header
</I>&gt;<i> request_header_access X-Forwarded-For deny all #hide squid header
</I>&gt;<i> #request_timeout 2 minutes #client request timeout
</I>&gt;<i> 
</I>
The above is a very slow and nasty way to perform:

  via off
  forwarded_for delete


Though if you want to be transparent, use these instead:
  via off
  forwarded_for transparent


&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3120
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> 
</I>&gt;<i> https_port 192.168.51.115:3129 intercept ssl-bump connection-auth=off 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>&gt;<i> cert=/usr/local/squid/ssl_cert/myCA.pem 
</I>&gt;<i> key=/usr/local/squid/ssl_cert/myCA.pem
</I>&gt;<i> always_direct allow all
</I>
The use of &quot;always_direct allow all&quot; is a now useless workaround for a 
long ago fixed bug. No version of Squid available in any distro today 
needs it.


&gt;<i> ssl_bump server-first all
</I>&gt;<i> acl ssl_step1 at_step SslBump1
</I>&gt;<i> acl ssl_step2 at_step SslBump2
</I>&gt;<i> acl ssl_step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek ssl_step1
</I>&gt;<i> ssl_bump splice all
</I>
You are mixing up rules from multiple different versions of the SSL-Bump 
feature.

&quot;server-first&quot; is equivalent to:

  ssl_bump peek ssl_step1
  ssl_bump bump all

It overrides all the ssl_bump lines following it.


&gt;<i> 
</I>&gt;<i> sslproxy_version 0
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Remove all three of the above lines. You may then be able to see what is 
going on if the errors are in the TLS layer.

All these lines do is hide errors and network abuse from *you*, the 
admin. Not your clients or users - they will still get errors.


I think your problem is that the bumping done by &quot;server-first&quot; is 
clashing with several modern TLS features that sites use. You will not 
be able to see which problem it is though until you re-enable recording 
and display of TLS issues.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016944.html">[squid-users] squid 3.5.27 . https website
</A></li>
	<LI>Next message (by thread): <A HREF="016952.html">[squid-users] forward proxy to reverse proxy to app
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16951">[ date ]</a>
              <a href="thread.html#16951">[ thread ]</a>
              <a href="subject.html#16951">[ subject ]</a>
              <a href="author.html#16951">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
