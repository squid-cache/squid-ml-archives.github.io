<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] block user agent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3Cb9db7cbf-2591-c04c-7fb0-220da8db1509%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016959.html">
   <LINK REL="Next"  HREF="016961.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] block user agent</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3Cb9db7cbf-2591-c04c-7fb0-220da8db1509%40gmail.com%3E"
       TITLE="[squid-users] block user agent">yvoinov at gmail.com
       </A><BR>
    <I>Fri Nov 17 15:29:54 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016959.html">[squid-users] block user agent
</A></li>
        <LI>Next message (by thread): <A HREF="016961.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16960">[ date ]</a>
              <a href="thread.html#16960">[ thread ]</a>
              <a href="subject.html#16960">[ subject ]</a>
              <a href="author.html#16960">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

17.11.2017 21:27, Vieri &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> ________________________________
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> 1. Your &quot;works&quot; and &quot;does not work&quot; setups currently differ in at least
</I>&gt;&gt;<i> three variables: user agent name, slash after the user agent name, and
</I>&gt;&gt;<i> acl negation in http_access. Find out which single variable is
</I>&gt;&gt;<i> responsible for the breakage by eliminating all other differences.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Post two ALL,2 cache.logs, each containing a single transaction, one
</I>&gt;&gt;<i> for the &quot;works&quot; case and one for the &quot;does not work&quot; case polished as
</I>&gt;&gt;<i> discussed in #1.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I can't really do anything about #1 except maybe leave out the forward slash.
</I>&gt;<i> That's because my 2 examples are trying to achieve the opposite.
</I>&gt;<i> Let me just rephrase everything so it's crystal clear.
</I>&gt;<i>
</I>&gt;<i> My goal is to deny all client traffic from browsers that DO NOT have a specific user-agent string. So this is a negated statement. One of the things I can't do in Squid is define an ACL with a negated lookahead such as (?!useragentname).
</I>I hope you listen about browser extensions for UA spoofing?
&gt;<i>
</I>&gt;<i> So I set up two examples.
</I>&gt;<i>
</I>&gt;<i> Common to both:
</I>&gt;<i>
</I>&gt;<i> acl allowed_useragent browser MyAllowedUAstring
</I>&gt;<i> acl denied_useragent browser MyDeniedUAstring
</I>&gt;<i>
</I>&gt;<i> # example 1:
</I>&gt;<i> http_access deny denied_useragent
</I>&gt;<i> http_reply_access deny denied_useragent
</I>&gt;<i> deny_info <A HREF="http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent</A> denied_useragent
</I>&gt;<i>
</I>&gt;<i> I then run this from my test client:
</I>&gt;<i>
</I>&gt;<i> # curl --insecure --user-agent MyAllowedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; works as expected (I see the web site). I guess you don't need to see cache.log here.
</I>&gt;<i>
</I>&gt;<i> Now I run this:
</I>&gt;<i>
</I>&gt;<i> # curl --insecure --user-agent MyDeniedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; works as expected (I'm denied access and I see Squid's error page).
</I>&gt;<i> I guess there's no need for the full log here either. It boils down to this anyway:
</I>&gt;<i> 2017/11/17 13:24:26.937 kid1| 28,2| RegexData.cc(73) match: aclRegexData::match: match '(MyDeniedUAstring)' found in 'MyDeniedUAstring'
</I>&gt;<i> 2017/11/17 13:24:26.937 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is DENIED; last ACL checked: denied_useragent
</I>&gt;<i>
</I>&gt;<i> I'm done with example 1. That's because I cannot make a consistent list of all user agents I want to actively block. Instead, I want to &quot;deny everyone except one or two&quot;.
</I>&gt;<i>
</I>&gt;<i> Also, since negative lookaheads are not supported in regular expressions, I change my example 1 to:
</I>&gt;<i>
</I>&gt;<i> # example 2:
</I>&gt;<i> http_access deny !allowed_useragent
</I>&gt;<i> http_reply_access deny !allowed_useragent
</I>&gt;<i> deny_info <A HREF="http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent</A> allowed_useragent
</I>&gt;<i>
</I>&gt;<i> Then I run this from the client:
</I>&gt;<i>
</I>&gt;<i> # curl --insecure --user-agent MyAllowedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; I was expecting to be allowed access since Squid denies &quot;everything that's not&quot; MyAllowedUAstring. Well, at least I should have passed the &quot;deny&quot; line in example 2.
</I>&gt;<i> However, I'm being blocked right there. This is the full log:
</I>&gt;<i>
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 88
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 5,2| TcpAcceptor.cc(295) acceptNext: connection on local=[::]:3229 remote=[::] FD 88 flags=25
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 33,2| client_side.cc(3943) httpsSslBumpAccessCheckDone: sslBump needed for local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17 method 4
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> CONNECT 89.16.167.134:443 HTTP/1.1
</I>&gt;<i> Host: 89.16.167.134:443
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request CONNECT 89.16.167.134:443 is DENIED; last ACL checked: allowed_useragent
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:42.226 kid1| 83,2| client_side.cc(3843) clientNegotiateSSL: clientNegotiateSSL: New session 0x125e030 on FD 8 (10.215.144.48:65262)
</I>&gt;<i> 2017/11/17 13:30:42.226 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:42.226 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET / HTTP/1.1
</I>&gt;<i> Host: www.gentoo.org
</I>&gt;<i> User-Agent: MyAllowedUAstring
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 28,2| RegexData.cc(73) match: aclRegexData::match: match '(MyAllowedUAstring)' found in 'MyAllowedUAstring'
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 88,2| client_side_reply.cc(2073) processReplyAccessResult: The reply for GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is ALLOWED, because it matched denied_mimetypes_rep
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 11,2| client_side.cc(1409) sendStartOfMessage: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 11,2| client_side.cc(1410) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 307 Temporary Redirect
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Fri, 17 Nov 2017 12:30:42 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Location: <A HREF="http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=89.16.167.134&amp;i=10.215.144.48&amp;M=CONNECT&amp;o=&amp;R=/&amp;T=Fri,%2017%20Nov%202017%2012%3A30%3A42%20GMT&amp;U=https%3A%2F%2F89.16.167.134%2F*&amp;u=89.16.167.134%3A443&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=89.16.167.134&amp;i=10.215.144.48&amp;M=CONNECT&amp;o=&amp;R=/&amp;T=Fri,%2017%20Nov%202017%2012%3A30%3A42%20GMT&amp;U=https%3A%2F%2F89.16.167.134%2F*&amp;u=89.16.167.134%3A443&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent</A>
</I>&gt;<i> X-Squid-Error: 403 Access Denied
</I>&gt;<i> X-Cache: MISS from proxy-server1
</I>&gt;<i> X-Cache-Lookup: NONE from proxy-server1:3227
</I>&gt;<i> Connection: close
</I>&gt;<i>
</I>&gt;<i> Note that I have these defaults in my squid conf file:
</I>&gt;<i>
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> Let's try another one:
</I>&gt;<i>
</I>&gt;<i> # curl --insecure --user-agent MyDeniedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; This is as expected, I guess.
</I>&gt;<i>
</I>&gt;<i> Full log:
</I>&gt;<i>
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 88
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 5,2| TcpAcceptor.cc(295) acceptNext: connection on local=[::]:3229 remote=[::] FD 88 flags=25
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 33,2| client_side.cc(3943) httpsSslBumpAccessCheckDone: sslBump needed for local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17 method 4
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> CONNECT 89.16.167.134:443 HTTP/1.1
</I>&gt;<i> Host: 89.16.167.134:443
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request CONNECT 89.16.167.134:443 is DENIED; last ACL checked: allowed_useragent
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:10.365 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:10.385 kid1| 83,2| client_side.cc(3843) clientNegotiateSSL: clientNegotiateSSL: New session 0xdbdc70 on FD 8 (10.215.144.48:65237)
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET / HTTP/1.1
</I>&gt;<i> Host: www.gentoo.org
</I>&gt;<i> User-Agent: MyDeniedUAstring
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 88,2| client_side_reply.cc(2073) processReplyAccessResult: The reply for GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is DENIED, because it matched allowed_useragent
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 88,2| client_side_reply.cc(2073) processReplyAccessResult: The reply for GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is ALLOWED, because it matched allowed_useragent
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 11,2| client_side.cc(1409) sendStartOfMessage: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:10.386 kid1| 11,2| client_side.cc(1410) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 302 Found
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Fri, 17 Nov 2017 12:30:10 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Location: <A HREF="http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=www.gentoo.org&amp;i=10.215.144.48&amp;M=GET&amp;o=&amp;R=/&amp;T=Fri,%2017%20Nov%202017%2012%3A30%3A10%20GMT&amp;U=https%3A%2F%2Fwww.gentoo.org%2F&amp;u=https%3A%2F%2Fwww.gentoo.org%2F&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=www.gentoo.org&amp;i=10.215.144.48&amp;M=GET&amp;o=&amp;R=/&amp;T=Fri,%2017%20Nov%202017%2012%3A30%3A10%20GMT&amp;U=https%3A%2F%2Fwww.gentoo.org%2F&amp;u=https%3A%2F%2Fwww.gentoo.org%2F&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent</A>
</I>&gt;<i> X-Squid-Error: 403 Access Denied
</I>&gt;<i> X-Cache: MISS from proxy-server1
</I>&gt;<i> X-Cache-Lookup: NONE from proxy-server1:3227
</I>&gt;<i> Connection: close
</I>&gt;<i>
</I>&gt;<i> Now for plain HTTP with example 2.
</I>&gt;<i>
</I>&gt;<i> # curl --user-agent MyDeniedUAstring <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A>
</I>&gt;<i> -&gt; As expected. It blocks access.
</I>&gt;<i>
</I>&gt;<i> Full log:
</I>&gt;<i>
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 85
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 5,2| TcpAcceptor.cc(295) acceptNext: connection on local=[::]:3228 remote=[::] FD 85 flags=25
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=66.39.46.122:80 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET /index.php HTTP/1.1
</I>&gt;<i> Host: www.fltk.org
</I>&gt;<i> User-Agent: MyDeniedUAstring
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request GET <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A> is DENIED; last ACL checked: allowed_useragent
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 88,2| client_side_reply.cc(2073) processReplyAccessResult: The reply for GET <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A> is ALLOWED, because it matched allowed_useragent
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 11,2| client_side.cc(1409) sendStartOfMessage: HTTP Client local=66.39.46.122:80 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 15:56:52.648 kid1| 11,2| client_side.cc(1410) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 302 Found
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Fri, 17 Nov 2017 14:56:52 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Location: <A HREF="http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=www.fltk.org&amp;i=10.215.144.48&amp;M=GET&amp;o=&amp;R=/index.php&amp;T=Fri,%2017%20Nov%202017%2014%3A56%3A52%20GMT&amp;U=http%3A%2F%2Fwww.fltk.org%2Findex.php&amp;u=http%3A%2F%2Fwww.fltk.org%2Findex.php&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=www.fltk.org&amp;i=10.215.144.48&amp;M=GET&amp;o=&amp;R=/index.php&amp;T=Fri,%2017%20Nov%202017%2014%3A56%3A52%20GMT&amp;U=http%3A%2F%2Fwww.fltk.org%2Findex.php&amp;u=http%3A%2F%2Fwww.fltk.org%2Findex.php&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent</A>
</I>&gt;<i> X-Squid-Error: 403 Access Denied
</I>&gt;<i> X-Cache: MISS from proxy-server1
</I>&gt;<i> X-Cache-Lookup: NONE from proxy-server1:3227
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i> However, now comes the interesting part.
</I>&gt;<i>
</I>&gt;<i> # curl --user-agent MyAllowedUAstring <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A>
</I>&gt;<i> -&gt; works as expected (I see the web site). 
</I>&gt;<i>
</I>&gt;<i> Full log:
</I>&gt;<i>
</I>&gt;<i> 2017/11/17 15:55:23.550 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 85
</I>&gt;<i> 2017/11/17 15:55:23.550 kid1| 5,2| TcpAcceptor.cc(295) acceptNext: connection on local=[::]:3228 remote=[::] FD 85 flags=25
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=66.39.46.122:80 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET /index.php HTTP/1.1
</I>&gt;<i> Host: www.fltk.org
</I>&gt;<i> User-Agent: MyAllowedUAstring
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 28,2| RegexData.cc(73) match: aclRegexData::match: match '(MyAllowedUAstring)' found in 'MyAllowedUAstring'
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 82,2| external_acl.cc(805) aclMatchExternal: bllookup(&quot;http www.fltk.org 80 /index.php&quot;) = lookup needed
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 82,2| external_acl.cc(808) aclMatchExternal: &quot;http www.fltk.org 80 /index.php&quot;: queueing a call.
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 82,2| external_acl.cc(1444) Start: fg lookup in 'bllookup' for 'http www.fltk.org 80 /index.php'
</I>&gt;<i> 2017/11/17 15:55:23.551 kid1| 82,2| external_acl.cc(811) aclMatchExternal: &quot;http www.fltk.org 80 /index.php&quot;: return -1.
</I>&gt;<i> 2017/11/17 15:55:23.553 kid1| 82,2| external_acl.cc(1372) externalAclHandleReply: reply={result=OK, notes={message: www.fltk.org site not found in blacklist; }}
</I>&gt;<i> 2017/11/17 15:55:23.553 kid1| 82,2| external_acl.cc(1288) external_acl_cache_add: external_acl_cache_add: Adding 'http www.fltk.org 80 /index.php' = ALLOWED
</I>&gt;<i> 2017/11/17 15:55:23.553 kid1| 82,2| external_acl.cc(841) aclMatchExternal: bllookup = ALLOWED
</I>&gt;<i> 2017/11/17 15:55:23.553 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request GET <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A> is ALLOWED; last ACL checked: bl_lookup
</I>&gt;<i> 2017/11/17 15:55:23.553 kid1| 85,2| client_side_request.cc(721) clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i> 2017/11/17 15:55:23.553 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request GET <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A> is ALLOWED; last ACL checked: bl_lookup
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 88,2| client_side_reply.cc(593) cacheHit: clientProcessHit: Vary detected!
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 17,2| FwdState.cc(133) FwdState: Forwarding client request local=66.39.46.122:80 remote=10.215.144.48 FD 8 flags=17, url=<A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A>
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 44,2| peer_select.cc(280) peerSelectDnsPaths: Found sources for '<A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A>'
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 44,2| peer_select.cc(281) peerSelectDnsPaths:   always_direct = DENIED
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 44,2| peer_select.cc(282) peerSelectDnsPaths:    never_direct = DENIED
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 44,2| peer_select.cc(288) peerSelectDnsPaths:    ORIGINAL_DST = local=10.215.144.48 remote=66.39.46.122:80 flags=25
</I>&gt;<i> 2017/11/17 15:55:23.554 kid1| 44,2| peer_select.cc(295) peerSelectDnsPaths:        timedout = 0
</I>&gt;<i> 2017/11/17 15:55:23.708 kid1| 11,2| http.cc(2229) sendRequest: HTTP Server local=10.215.144.48:35373 remote=66.39.46.122:80 FD 13 flags=25
</I>&gt;<i> 2017/11/17 15:55:23.708 kid1| 11,2| http.cc(2230) sendRequest: HTTP Server REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET /index.php HTTP/1.1
</I>&gt;<i> User-Agent: MyAllowedUAstring
</I>&gt;<i> Accept: */*
</I>&gt;<i> Host: www.fltk.org
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 15:55:23.884 kid1| ctx: enter level  0: '<A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A>'
</I>&gt;<i> 2017/11/17 15:55:23.884 kid1| 11,2| http.cc(719) processReplyHeader: HTTP Server local=10.215.144.48:35373 remote=66.39.46.122:80 FD 13 flags=25
</I>&gt;<i> 2017/11/17 15:55:23.884 kid1| 11,2| http.cc(720) processReplyHeader: HTTP Server REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Fri, 17 Nov 2017 14:55:23 GMT
</I>&gt;<i> Server: Apache/2.4.29
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Keep-Alive: timeout=5, max=100
</I>&gt;<i> Connection: Keep-Alive
</I>&gt;<i> Transfer-Encoding: chunked
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i>
</I>&gt;<i> 3a02
</I>&gt;<i> &lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd">http://www.w3.org/TR/html4/loose.dtd</A>&quot;&gt;
</I>&gt;<i> &lt;html&gt;
</I>&gt;<i> &lt;head&gt;
</I>&gt;<i> &lt;title&gt;Fast Light Toolkit - Fast Light Toolkit (FLTK)&lt;/title&gt;
</I>&gt;<i> &lt;meta http-equiv='Pragma' content='no-cache'&gt;
</I>&gt;<i> &lt;meta http-equiv='Content-Type' content='text/html; charset=utf-8'&gt;
</I>&gt;<i> &lt;link rel='stylesheet' type='text/css' href='fltk.css'&gt;
</I>&gt;<i> &lt;link rel='alternate' title='FLTK RSS' type='application/rss+xml' href='index.rss'&gt;
</I>&gt;<i> &lt;link rel='shortcut icon' href='favicon.ico' type='image/x-icon'&gt;
</I>&gt;<i> &lt;meta name='keywords' content='gui toolkit,c++,linux,unix,macos x,x11,windows'&gt;
</I>&gt;<i> &lt;/head&gt;
</I>&gt;<i> &lt;body&gt;
</I>&gt;<i> &lt;table width='100%' border='0' cellspacing='0' cellpadding='0' summary='Page'&gt;
</I>&gt;<i> &lt;tr class='header'&gt;&lt;td valign='top' width='15' rowspan='2'&gt;&lt;a href='index.php'&gt;&lt;img src='images/top-left.gif' width='15' height='70' border='0' alt=''&gt;&lt;/a&gt;&lt;/td&gt;&lt;td valign='top' width='224' rowspan='2'&gt;&lt;a href='index.php'&gt;&lt;img src='images/top-middle.gif' width='224' height='70' border='0' alt=''&gt;&lt;/a&gt;&lt;/td&gt;&lt;td width='100%' height='40'&gt;&lt;h1&gt;Fast Light Toolkit&lt;/h1&gt; &lt;/td&gt;&lt;td align='right' nowrap&gt;
</I>&gt;<i> &lt;table cellpadding=0 cellspacing=0 border=0&gt;&lt;tr&gt;&lt;td valign=top nowrap&gt;
</I>&gt;<i> &lt;a href=fltk-rss.xml&gt;&lt;img src=images/rss-fee
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 15:55:23.885 kid1| ctx: exit level  0
</I>&gt;<i> 2017/11/17 15:55:23.885 kid1| 23,2| url.cc(407) urlParse: urlParse: URI has whitespace: {<A HREF="icap://127.0.0.1:1344/clamav">icap://127.0.0.1:1344/clamav</A> ICAP/1.0
</I>&gt;<i> }
</I>&gt;<i> 2017/11/17 15:55:24.038 kid1| 28,2| RegexData.cc(73) match: aclRegexData::match: match '(MyAllowedUAstring)' found in 'MyAllowedUAstring'
</I>&gt;<i> 2017/11/17 15:55:24.038 kid1| 88,2| client_side_reply.cc(2073) processReplyAccessResult: The reply for GET <A HREF="http://www.fltk.org/index.php">http://www.fltk.org/index.php</A> is ALLOWED, because it matched denied_mimetypes_rep
</I>&gt;<i> 2017/11/17 15:55:24.038 kid1| 11,2| client_side.cc(1409) sendStartOfMessage: HTTP Client local=66.39.46.122:80 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 15:55:24.038 kid1| 11,2| client_side.cc(1410) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Fri, 17 Nov 2017 14:55:23 GMT
</I>&gt;<i> Server: Apache/2.4.29
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i> Vary: Accept-Encoding
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i> Via: ICAP/1.0 proxy-server1.hospitalmanacor.org (C-ICAP/0.5.2 SquidClamav/Antivirus service )
</I>&gt;<i> X-Cache: MISS from proxy-server1
</I>&gt;<i> X-Cache-Lookup: MISS from proxy-server1:3227
</I>&gt;<i> Transfer-Encoding: chunked
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i> How can I modify my example 2 settings so this access control works the same way with both http and https in an ssl-bumped environment.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Vieri
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
**************************
* C++: Bug to the future *
**************************


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 648 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171117/e436875c/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171117/e436875c/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016959.html">[squid-users] block user agent
</A></li>
	<LI>Next message (by thread): <A HREF="016961.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16960">[ date ]</a>
              <a href="thread.html#16960">[ thread ]</a>
              <a href="subject.html#16960">[ subject ]</a>
              <a href="author.html#16960">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
