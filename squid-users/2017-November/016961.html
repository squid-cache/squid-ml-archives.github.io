<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] block user agent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C8edbcf42-bc37-a63b-8be0-daf088770108%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016960.html">
   <LINK REL="Next"  HREF="016977.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] block user agent</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C8edbcf42-bc37-a63b-8be0-daf088770108%40measurement-factory.com%3E"
       TITLE="[squid-users] block user agent">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Nov 17 16:25:20 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016960.html">[squid-users] block user agent
</A></li>
        <LI>Next message (by thread): <A HREF="016977.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16961">[ date ]</a>
              <a href="thread.html#16961">[ thread ]</a>
              <a href="subject.html#16961">[ subject ]</a>
              <a href="author.html#16961">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/17/2017 08:27 AM, Vieri wrote:
&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> 1. Your &quot;works&quot; and &quot;does not work&quot; setups currently differ in at least
</I>&gt;&gt;<i> three variables: user agent name, slash after the user agent name, and
</I>&gt;&gt;<i> acl negation in http_access. Find out which single variable is
</I>&gt;&gt;<i> responsible for the breakage by eliminating all other differences.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Post two ALL,2 cache.logs, each containing a single transaction, one
</I>&gt;&gt;<i> for the &quot;works&quot; case and one for the &quot;does not work&quot; case polished as
</I>&gt;&gt;<i> discussed in #1.
</I>
&gt;<i> I can't really do anything about #1 except maybe leave out the forward slash.
</I>&gt;<i> That's because my 2 examples are trying to achieve the opposite.
</I>
You may be conflating two very different goals:

  A) Understanding why Squid does X.
  B) Configuring Squid to do what you want.

My response was focused on the former. Once you understand, you can
probably accomplish the latter on your own.

To understand why two similar setups act differently, I would reduce the
number of different variables until you find the variable that explains
the difference. Yes, none of the tested reduced setups may do what you
want your production Squid to do, but that should not matter for now.
You are after understanding.

The usual alternative to the above approach is trying random
configurations until you think Squid works the way you want it to work.
Usually, Squid still does not do what you think it does, but your test
cases do not expose the difference.


&gt;<i> My goal is to deny all client traffic from browsers that DO NOT have
</I>&gt;<i> a specific user-agent string. So this is a negated statement.
</I>
There is no need to use negation for that. If the goodAgents ACL matches
requests with &quot;specific user-agent string&quot;, then you can do this:

  http_access allow goodAgents
  http_access deny all

As you can see, there is no ACL negation or negative ACLs.


&gt;<i> Common to both:
</I>&gt;<i> 
</I>&gt;<i> acl allowed_useragent browser MyAllowedUAstring
</I>&gt;<i> acl denied_useragent browser MyDeniedUAstring
</I>&gt;<i> 
</I>&gt;<i> # example 1:
</I>&gt;<i> http_access deny denied_useragent
</I>&gt;<i> http_reply_access deny denied_useragent
</I>
If you want to block access to the origin server, do not use
http_reply_access. Use http_access.


&gt;<i> # example 2:
</I>&gt;<i> http_access deny !allowed_useragent
</I>&gt;<i> http_reply_access deny !allowed_useragent
</I>&gt;<i> 
</I>&gt;<i> Then I run this from the client:
</I>&gt;<i> 
</I>&gt;<i> # curl --insecure --user-agent MyAllowedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; I was expecting to be allowed access since Squid denies &quot;everything that's not&quot; MyAllowedUAstring. Well, at least I should have passed the &quot;deny&quot; line in example 2.
</I>&gt;<i> However, I'm being blocked right there.
</I>
&gt;<i> ---------
</I>&gt;<i> CONNECT 89.16.167.134:443 HTTP/1.1
</I>&gt;<i> Host: 89.16.167.134:443
</I>&gt;<i> ----------
</I>&gt;<i> clientAccessCheckDone: The request CONNECT 89.16.167.134:443 is DENIED; last ACL checked: allowed_useragent
</I>

As you can see, your CONNECT request was denied (because it lacks the
User-Agent header). The rest does not matter much (for now), but Squid
bumps the connection to serve the error page in response to the first
bumped HTTP request (regardless of what that first bumped HTTP request
looks like).

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016960.html">[squid-users] block user agent
</A></li>
	<LI>Next message (by thread): <A HREF="016977.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16961">[ date ]</a>
              <a href="thread.html#16961">[ thread ]</a>
              <a href="subject.html#16961">[ subject ]</a>
              <a href="author.html#16961">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
