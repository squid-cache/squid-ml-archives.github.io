<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] block user agent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C90faeb83-b69a-3f8c-9eb4-b5010a57c0ee%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017003.html">
   <LINK REL="Next"  HREF="016910.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] block user agent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C90faeb83-b69a-3f8c-9eb4-b5010a57c0ee%40treenet.co.nz%3E"
       TITLE="[squid-users] block user agent">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Nov 17 16:30:39 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017003.html">[squid-users] block user agent
</A></li>
        <LI>Next message (by thread): <A HREF="016910.html">[squid-users] Is it possible to apply squid delay pools on	users/groups from AD ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16962">[ date ]</a>
              <a href="thread.html#16962">[ thread ]</a>
              <a href="subject.html#16962">[ subject ]</a>
              <a href="author.html#16962">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 18/11/17 04:27, Vieri wrote:
&gt;<i> ________________________________
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> 1. Your &quot;works&quot; and &quot;does not work&quot; setups currently differ in at least
</I>&gt;&gt;<i> three variables: user agent name, slash after the user agent name, and
</I>&gt;&gt;<i> acl negation in http_access. Find out which single variable is
</I>&gt;&gt;<i> responsible for the breakage by eliminating all other differences.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Post two ALL,2 cache.logs, each containing a single transaction, one
</I>&gt;&gt;<i> for the &quot;works&quot; case and one for the &quot;does not work&quot; case polished as
</I>&gt;&gt;<i> discussed in #1.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I can't really do anything about #1 except maybe leave out the forward slash.
</I>&gt;<i> That's because my 2 examples are trying to achieve the opposite.
</I>&gt;<i> Let me just rephrase everything so it's crystal clear.
</I>&gt;<i> 
</I>&gt;<i> My goal is to deny all client traffic from browsers that DO NOT have a specific user-agent string. So this is a negated statement. One of the things I can't do in Squid is define an ACL with a negated lookahead such as (?!useragentname).
</I>&gt;<i> 
</I>&gt;<i> So I set up two examples.
</I>&gt;<i> 
</I>&gt;<i> Common to both:
</I>&gt;<i> 
</I>&gt;<i> acl allowed_useragent browser MyAllowedUAstring
</I>&gt;<i> acl denied_useragent browser MyDeniedUAstring
</I>&gt;<i> 
</I>&gt;<i> # example 1:
</I>&gt;<i> http_access deny denied_useragent
</I>&gt;<i> http_reply_access deny denied_useragent
</I>&gt;<i> deny_info <A HREF="http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent</A> denied_useragent
</I>&gt;<i> 
</I>&gt;<i> I then run this from my test client:
</I>&gt;<i> 
</I>&gt;<i> # curl --insecure --user-agent MyAllowedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; works as expected (I see the web site). I guess you don't need to see cache.log here.
</I>&gt;<i> 
</I>&gt;<i> Now I run this:
</I>&gt;<i> 
</I>&gt;<i> # curl --insecure --user-agent MyDeniedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; works as expected (I'm denied access and I see Squid's error page).
</I>&gt;<i> I guess there's no need for the full log here either. It boils down to this anyway:
</I>&gt;<i> 2017/11/17 13:24:26.937 kid1| 28,2| RegexData.cc(73) match: aclRegexData::match: match '(MyDeniedUAstring)' found in 'MyDeniedUAstring'
</I>&gt;<i> 2017/11/17 13:24:26.937 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is DENIED; last ACL checked: denied_useragent
</I>&gt;<i> 
</I>&gt;<i> I'm done with example 1. That's because I cannot make a consistent list of all user agents I want to actively block. Instead, I want to &quot;deny everyone except one or two&quot;.
</I>&gt;<i> 
</I>&gt;<i> Also, since negative lookaheads are not supported in regular expressions, I change my example 1 to:
</I>&gt;<i> 
</I>&gt;<i> # example 2:
</I>&gt;<i> http_access deny !allowed_useragent
</I>&gt;<i> http_reply_access deny !allowed_useragent
</I>&gt;<i> deny_info <A HREF="http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=%a&amp;B=%B&amp;e=%e&amp;E=%E&amp;H=%H&amp;i=%i&amp;M=%M&amp;o=%o&amp;R=%R&amp;T=%T&amp;U=%U&amp;u=%u&amp;w=%w&amp;x=%x&amp;acl=denied_useragent</A> allowed_useragent
</I>&gt;<i> 
</I>&gt;<i> Then I run this from the client:
</I>&gt;<i> 
</I>&gt;<i> # curl --insecure --user-agent MyAllowedUAstring <A HREF="https://www.gentoo.org">https://www.gentoo.org</A>
</I>&gt;<i> -&gt; I was expecting to be allowed access since Squid denies &quot;everything that's not&quot; MyAllowedUAstring. Well, at least I should have passed the &quot;deny&quot; line in example 2.
</I>&gt;<i> However, I'm being blocked right there. This is the full log:
</I>&gt;<i> 
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 88
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 5,2| TcpAcceptor.cc(295) acceptNext: connection on local=[::]:3229 remote=[::] FD 88 flags=25
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 33,2| client_side.cc(3943) httpsSslBumpAccessCheckDone: sslBump needed for local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17 method 4
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> CONNECT 89.16.167.134:443 HTTP/1.1
</I>&gt;<i> Host: 89.16.167.134:443
</I>&gt;<i> 
</I>
This is the CONNECT request generated internally by Squid for the 
bumping process.


&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 85,2| client_side_request.cc(745) clientAccessCheckDone: The request CONNECT 89.16.167.134:443 is DENIED; last ACL checked: allowed_useragent
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:42.216 kid1| 20,2| store.cc(996) checkCachable: StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/17 13:30:42.226 kid1| 83,2| client_side.cc(3843) clientNegotiateSSL: clientNegotiateSSL: New session 0x125e030 on FD 8 (10.215.144.48:65262)
</I>&gt;<i> 2017/11/17 13:30:42.226 kid1| 11,2| client_side.cc(2372) parseHttpRequest: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:42.226 kid1| 11,2| client_side.cc(2373) parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET / HTTP/1.1
</I>&gt;<i> Host: www.gentoo.org
</I>&gt;<i> User-Agent: MyAllowedUAstring
</I>&gt;<i> Accept: */*
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 28,2| RegexData.cc(73) match: aclRegexData::match: match '(MyAllowedUAstring)' found in 'MyAllowedUAstring'
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 88,2| client_side_reply.cc(2073) processReplyAccessResult: The reply for GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is ALLOWED, because it matched denied_mimetypes_rep
</I>
Please notice the above text and what ACL it is talking about.

Hint: it is NOT the one you are talking about testing.


&gt;<i> 2017/11/17 13:30:42.227 kid1| 11,2| client_side.cc(1409) sendStartOfMessage: HTTP Client local=89.16.167.134:443 remote=10.215.144.48 FD 8 flags=17
</I>&gt;<i> 2017/11/17 13:30:42.227 kid1| 11,2| client_side.cc(1410) sendStartOfMessage: HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 307 Temporary Redirect
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Fri, 17 Nov 2017 12:30:42 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Location: <A HREF="http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=89.16.167.134&amp;i=10.215.144.48&amp;M=CONNECT&amp;o=&amp;R=/&amp;T=Fri,%2017%20Nov%202017%2012%3A30%3A42%20GMT&amp;U=https%3A%2F%2F89.16.167.134%2F*&amp;u=89.16.167.134%3A443&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent">http://proxy-server1/proxy-error/?a=-&amp;B=&amp;e=0&amp;E=%5BNo%20Error%5D&amp;H=89.16.167.134&amp;i=10.215.144.48&amp;M=CONNECT&amp;o=&amp;R=/&amp;T=Fri,%2017%20Nov%202017%2012%3A30%3A42%20GMT&amp;U=https%3A%2F%2F89.16.167.134%2F*&amp;u=89.16.167.134%3A443&amp;w=IT%40mydomain.org&amp;x=&amp;acl=denied_useragent</A>
</I>&gt;<i> X-Squid-Error: 403 Access Denied
</I>&gt;<i> X-Cache: MISS from proxy-server1
</I>&gt;<i> X-Cache-Lookup: NONE from proxy-server1:3227
</I>&gt;<i> Connection: close
</I>
This is the denial &quot;error&quot; response generated by Squid.

...
&gt;<i> 
</I>&gt;<i> How can I modify my example 2 settings so this access control works the same way with both http and https in an ssl-bumped environment.
</I>
It already does. The environment is what is different.

You are looking at Squid generated messages and trying to get them 
replaced with other Squid generated messages simply because they are 
generated by Squid not some arbitrary UA.


If you could replace that Squid generated message with another Squid 
generated message, and replace that Squid generated message with another 
Squid generated message, and replace that Squid generated message with 
another Squid generated message, and replace that Squid generated 
message with another Squid generated message, .... until the machine 
crashes or client gives up waiting and closes the connection.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017003.html">[squid-users] block user agent
</A></li>
	<LI>Next message (by thread): <A HREF="016910.html">[squid-users] Is it possible to apply squid delay pools on	users/groups from AD ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16962">[ date ]</a>
              <a href="thread.html#16962">[ thread ]</a>
              <a href="subject.html#16962">[ subject ]</a>
              <a href="author.html#16962">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
