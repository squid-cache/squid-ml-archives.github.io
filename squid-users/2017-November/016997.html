<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] block user agent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C84a81f25-baf9-0255-6465-391248c556c5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016994.html">
   <LINK REL="Next"  HREF="017001.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] block user agent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C84a81f25-baf9-0255-6465-391248c556c5%40treenet.co.nz%3E"
       TITLE="[squid-users] block user agent">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 21 16:54:09 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016994.html">[squid-users] block user agent
</A></li>
        <LI>Next message (by thread): <A HREF="017001.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16997">[ date ]</a>
              <a href="thread.html#16997">[ thread ]</a>
              <a href="subject.html#16997">[ subject ]</a>
              <a href="author.html#16997">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/11/17 23:06, Vieri wrote:
&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> From: Amos Jeffries
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    http_access allow goodAgents !baddomains (AND)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   If the first line matches the allow happens.
</I>&gt;&gt;<i>   otherwise deny happens
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ie. goodAgents are only allowed to non-baddomains. All non-goodAgents
</I>&gt;&gt;<i> are denied to everything.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  From this I deduce that in my case I cannot use &quot;http_access allow goodAgents&quot;, but I need to go for &quot;http_access deny !goodAgents&quot; so I can continue on evaluating the rest of my http_access rules.
</I>&gt;&gt;<i> Allowing them all the way through Squid is bad. But that is not what is
</I>&gt;&gt;<i> needed here. ssl_bump rules get applied after the CONNECT is accepted
</I>&gt;&gt;<i> *in* for proxy processing and they decide what happens to the tunneled
</I>&gt;&gt;<i> data based on what is found there.
</I>&gt;&gt;<i>    If bumping is decided the TLS gets removed and the messages inside
</I>&gt;&gt;<i> individually go through the http_access process.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> You lost me there. Here's what I did today.
</I>&gt;<i> 
</I>&gt;<i> I took your advice (and Alex's), and renamed my ACL labels. Unfortunately, I'm still a little confused :-(.
</I>&gt;<i> 
</I>
[ snipping the log traces to keep the mail relatively small ]
&gt;<i> 
</I>&gt;<i> It seems that Squid decides to ALLOW, right?
</I>
Look at the &quot;markFinished&quot; lines for the outcome of each set of access 
controls outcomes. The lines leading up to those details which ACL tests 
are performed and which *_access lines they were on.


Ignoring the first few quoted lines which are for some earlier 
ssl-bumped transaction I see:

* http_access line #9 DENIED an HTTP request.

* access_log is ALLOWED to record something. Probably unrelated traffic.

* http_reply_access line #9 ALLOWED a reply to be delivered, then

* access_log is ALLOWED to log something.


&gt;<i> 
</I>&gt;<i> Isn't the message &quot;The request CONNECT 89.16.167.134:443 is DENIED&quot; what I should be concentrating on?
</I>&gt;<i> Isn't that the root cause?
</I>
Yes, that line is the outcome. The cause of the denial is what ACL 
check(s) led to it.

Specifically in these log lines:

   matches: checked: interceptedssl = 1
   match: aclIpMatchIp: '10.215.144.48' found
   matches: checked: localnet = 1
   matches: checked: !localnet = 0
   matches: checked: http_access#8 = 0

   matches: checked: good_useragents = 0
   matches: checked: !good_useragents = 1
   match: aclIpMatchIp: '10.215.144.48' NOT found
   matches: checked: src_ips_with_any_useragent = 0
   matches: checked: !src_ips_with_any_useragent = 1
   matches: checked: http_access#9 = 1
   matches: checked: http_access = 1

Which strangely do not seem to match your squid.conf details. These are 
the 8th and 9th http_access lines in the squid.conf which is used by the 
running proxy.
But in your quoted squid.conf they are lines #4 and #5.


  http_access deny interceptedssl !localnet
   - it was interceptedssl from localnet
   - so not a match due to !localnet

  http_access deny !good_useragents !src_ips_with_any_useragent
   - it has no UA, and
   - it is not listed n that IP whitelist.
   - the NOT condition (!) on both of those make the whole line a match.


&gt;<i> In another message, you mentioned that I should notice that Squid reports another ACL name (in this case, after the name change, it's &quot;bad_replied_mimetypes&quot;).
</I>&gt;<i> In any case, the message &quot;The reply for GET <A HREF="https://www.gentoo.org/">https://www.gentoo.org/</A> is ALLOWED&quot; means that Squid should ALLOW, right?
</I>
No, it means that *reply* is allowed.

A reply *might* be from a server, or from cache, or a 403 denial error 
page generated by Squid, or one of the deny_info redirects you have 
configured to happen - like that one in the &quot;HTTP Client REPLY&quot; in the 
second log trace.



&gt;<i> However, why do I get a 307 redirect to a deny_info page (where incidentally the URL refers to bad_useragents, not bad_replied_mimetypes)?
</I>
Because the CONNECT _request_ was denied and that redirect _reply_ is 
what a deny_info with a URL generates when its associated ACL causes a 
denial.

bad_useragents was the ACL checking the *request* which triggered that 
redirect to happen.

bad_replied_mimetypes was just the last ACL tested to see if that 
redirect was allowed to be delivered to the client.


If we assume that the two log traces actually line up then 
bad_replied_mimetypes is actually irrelevant because the 
http_reply_access result is actually &quot;NO match found, last action DENIED 
so returning ALLOWED&quot;


&gt;<i> 
</I>&gt;<i> I can't seem to clear this out and make it work without adding &quot;http_access allow CONNECT SSL_ports&quot; right before checking for the useragent.
</I>

If you place that after the default &quot;deny CONNECT !SSL_ports&quot;, and 
before your UA checks, AND if you are using ssl_bump on the allowed 
tunnels then you can relatively safely use &quot;allow CONNECT&quot;.

Just be careful that the CONNECT allowed by that are always handled 
safely by the ssl_bump rules you have.
  Meaning that you either bump or terminate traffic you are not sure is 
okay, splice if you are reasonably sure, etc. it is a balancing effort 
between &quot;splice as much as possible&quot; and &quot;terminate if unsure of the 
traffic&quot; advice.


Just FYI you would be a huge amount better off dropping the UA 
fingerprinting. It's a _really_ simplistic idea about the HTTP world, 
and it is partly because of that overly-simplistic nature and depending 
on unreliable values that you are having so much more trouble than 
normal admin face.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016994.html">[squid-users] block user agent
</A></li>
	<LI>Next message (by thread): <A HREF="017001.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16997">[ date ]</a>
              <a href="thread.html#16997">[ thread ]</a>
              <a href="subject.html#16997">[ subject ]</a>
              <a href="author.html#16997">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
