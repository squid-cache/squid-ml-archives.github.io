<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] parent peer timeout (Amos Jeffries)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20parent%20peer%20timeout%20%28Amos%20Jeffries%29&In-Reply-To=%3Cdbc9fea5-36ed-df06-90ad-7ad4ce951b0e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016996.html">
   <LINK REL="Next"  HREF="017000.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] parent peer timeout (Amos Jeffries)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20parent%20peer%20timeout%20%28Amos%20Jeffries%29&In-Reply-To=%3Cdbc9fea5-36ed-df06-90ad-7ad4ce951b0e%40treenet.co.nz%3E"
       TITLE="[squid-users] parent peer timeout (Amos Jeffries)">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov 21 17:15:49 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016996.html">[squid-users] parent peer timeout (Amos Jeffries)
</A></li>
        <LI>Next message (by thread): <A HREF="017000.html">[squid-users] Lots of &quot;BUG 3279: HTTP reply without Date:&quot; after update to squid-5.0.0-20171117-r4d27d0a
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16999">[ date ]</a>
              <a href="thread.html#16999">[ thread ]</a>
              <a href="subject.html#16999">[ subject ]</a>
              <a href="author.html#16999">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/11/17 05:00, Ignacio Freyre wrote:
&gt;<i> Hi Amos, thanks for taking the time to analize this.
</I>&gt;<i> 
</I>&gt;&gt;<i> Are you actually terminating the peer, or just simulating it some other way?
</I>&gt;<i> My method of testing is shutting down the service on the parent &quot;192.168.1.1&quot; with &quot;/etc/init.d/squid stop&quot;, whith this in place there are no remaining active connections, and no new ones are being established, all I see is tcp RST responses.
</I>
Ah, add to your tests a check to see when that process actually stops. 
It is quite likely that a long portion of those 2 minutes is the peer 
doing its slow graceful shutdown procedure - during which time it will 
stay LIVE and not DEAD.

You may also want to monitor the TCP state of the connections from Squid 
to the peer. Termination by the endpoint may not immediately trigger 
full connection closure all the way into Squid. So there is a bit of 
delay there as well until Squid picks up on the change.

The best way to shutdown Squid is with the &quot;squid -k shutdown&quot; command. 
Use it twice in a row for quick shutdown. First use initiates shutdown, 
second one skips the process to the end of the graceful delay.


&gt;<i> It seems there is a TCP timer that is not configurable, because of the time it takes to notice the dead peer:
</I>&gt;&gt;<i> 2017/11/20 22:55:02| Ready to serve requests.
</I>&gt;&gt;<i> 2017/11/20 22:55:03| storeLateRelease: released 0 objects
</I>&gt;&gt;<i> 2017/11/20 22:56:55| TCP connection to 192.168.1.1/3128 failed
</I>&gt;&gt;<i> 2017/11/20 22:56:55| TCP connection to 192.168.1.1/3128 failed
</I>&gt;&gt;<i> 2017/11/20 22:56:55| Detected DEAD Parent: 192.168.1.1
</I>&gt;<i> My objective is to configure dead peer detection based only in TCP connection, can this be achieved?
</I>
Yes, by the means you already configured.

Also ICMP is not optional. Ensure you have it working in your network. 
TCP connect errors are sent using ICMP from the network router(s) to 
Squid in just nanoseconds instead of whole seconds of waiting times. 
That should make the connect-timeout= setting mostly irrelevant.


&gt;<i> 
</I>&gt;<i> Do I need to allow a specific type of traffic with &quot;cache_peer_access&quot; statements so dead peer detection happens?, if I comment those lines, dead peer detection works, but I need to enable it so i can filter what traffic those parent peers accept.
</I>&gt;<i> 
</I>
What you configured should have been fine.

The issue is just that by relying only on the TCP/HTTP traffic for 
detection, reducing traffic sent to the peer also reduces its chances to 
detect failures. YMMV as to whether that is a good thing or not.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016996.html">[squid-users] parent peer timeout (Amos Jeffries)
</A></li>
	<LI>Next message (by thread): <A HREF="017000.html">[squid-users] Lots of &quot;BUG 3279: HTTP reply without Date:&quot; after update to squid-5.0.0-20171117-r4d27d0a
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16999">[ date ]</a>
              <a href="thread.html#16999">[ thread ]</a>
              <a href="subject.html#16999">[ subject ]</a>
              <a href="author.html#16999">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
