<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] block user agent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C1355260125.127820.1511347728876%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016997.html">
   <LINK REL="Next"  HREF="017003.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] block user agent</H1>
    <B>Vieri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20block%20user%20agent&In-Reply-To=%3C1355260125.127820.1511347728876%40mail.yahoo.com%3E"
       TITLE="[squid-users] block user agent">rentorbuy at yahoo.com
       </A><BR>
    <I>Wed Nov 22 10:48:48 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016997.html">[squid-users] block user agent
</A></li>
        <LI>Next message (by thread): <A HREF="017003.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17001">[ date ]</a>
              <a href="thread.html#17001">[ thread ]</a>
              <a href="subject.html#17001">[ subject ]</a>
              <a href="author.html#17001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>________________________________
From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
&gt;<i>
</I>&gt;<i> If you place that after the default &quot;deny CONNECT !SSL_ports&quot;, and 
</I>&gt;<i> before your UA checks, AND if you are using ssl_bump on the allowed 
</I>&gt;<i> tunnels then you can relatively safely use &quot;allow CONNECT&quot;.
</I>&gt;<i> 
</I>&gt;<i> Just be careful that the CONNECT allowed by that are always handled 
</I>&gt;<i> safely by the ssl_bump rules you have.
</I>&gt;<i>   Meaning that you either bump or terminate traffic you are not sure is 
</I>&gt;<i> okay, splice if you are reasonably sure, etc. it is a balancing effort 
</I>&gt;<i> between &quot;splice as much as possible&quot; and &quot;terminate if unsure of the 
</I>&gt;<i> traffic&quot; advice.
</I>

As you say, I placed &quot;allow CONNECT&quot; after the default &quot;deny CONNECT !SSL_ports&quot;, and before my UA checks. I'm also using:
ssl_bump stare all
ssl_bump bump all


Considering the following (taken from previous e-mail):

http_access deny intercepted !localnet
http_access deny interceptedssl !localnet
http_access deny explicit !ORG_all
http_access deny explicit SSL_ports

Would it be &quot;safer&quot; or &quot;indifferent&quot; to use the following right before the UA checks?

http_access allow CONNECT interceptedssl SSL_ports


&gt;<i> Just FYI you would be a huge amount better off dropping the UA 
</I>&gt;<i> fingerprinting. It's a _really_ simplistic idea about the HTTP world, 
</I>&gt;<i> and it is partly because of that overly-simplistic nature and depending 
</I>&gt;<i> on unreliable values that you are having so much more trouble than 
</I>&gt;<i> normal admin face.
</I>

I'm aware that UA checks are not fully reliable, but in a big corporate environment it can reveal a lot of interested information.

I also know that some HTTP clients mimic others' user-agent strings or substrings. They can even sometimes dynamically change them.

However, in my particular case I could define a custom UA for our corporate browser allowed to go through Squid. For instance, Firefox can easily do that. Other browsers such as Edge seem not to.
In any case, it is not my intention to do so long-term. In short-term I found out that:

1) Squid logic *can* be understood :-)

2) some hosts may have HTTP clients that should be blocked even though the rest of the Squid rules were not programmed for that (so I couldn't know about it). A simple example: we may allow traffic to all microsoft sites, but some software may not necessarily be well installed/configured. I found that Microsoft Office may connect to an MS site to download or update software with a utility/service called 
OfficeClickToRun. Of course, generic rules in Squid.conf already blocked unauthorized downloads according to mimetypes or filetypes. However, some clients could be whitelisted and allowed to download (eg. from all MS sites). In this case, I would not necessarily want OfficeClickToRun to update. That could be done by identifying the dst domains, but they could change in time, and in any case would require more digging into. 


Adobe has similar http client behavior.


Anyway, it's informative to say the least, and can be used to improve the rest of the &quot;standard&quot; squid acl access rules.

I was also thinking of using custom HTTP headers such as X-MyCustomHeader: Whatever instead of UA strings. Custom headers can easily be added in Firefox, and other browsers such as Edge also seem to support that.

Anyway, I had a great time fiddling with Squid.
Thank you for your assistance.

Vieri

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016997.html">[squid-users] block user agent
</A></li>
	<LI>Next message (by thread): <A HREF="017003.html">[squid-users] block user agent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17001">[ date ]</a>
              <a href="thread.html#17001">[ thread ]</a>
              <a href="subject.html#17001">[ subject ]</a>
              <a href="author.html#17001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
