<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20%5BSquid-3.5.20%5DSquid%20transparent%20proxy%0A%20http/https%20without%20client%20site%20config&In-Reply-To=%3Cead14327-92a2-c89e-1782-6c1b489216d2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017019.html">
   <LINK REL="Next"  HREF="017026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20%5BSquid-3.5.20%5DSquid%20transparent%20proxy%0A%20http/https%20without%20client%20site%20config&In-Reply-To=%3Cead14327-92a2-c89e-1782-6c1b489216d2%40treenet.co.nz%3E"
       TITLE="[squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Nov 25 11:17:24 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017019.html">[squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config
</A></li>
        <LI>Next message (by thread): <A HREF="017026.html">[squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17021">[ date ]</a>
              <a href="thread.html#17021">[ thread ]</a>
              <a href="subject.html#17021">[ subject ]</a>
              <a href="author.html#17021">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/11/17 19:40, minh h&#432;ng &#273;&#7895; ho&#224;ng wrote:
&gt;<i> Dear Amos, thank you so much for your quickly reply .
</I>&gt;<i> I have tried to replace my SSL config with your suggestion. But my squid 
</I>&gt;<i> get a error like this in cache.log:
</I>&gt;<i> 
</I>&gt;<i> 2017/11/25 13:21:49 kid1| SECURITY ALERT: Host header forgery detected 
</I>&gt;<i> on local=216.58.199.110:443 
</I>&gt;<i> remote=172.18.18.15:55704 FD 13 flags=33 
</I>&gt;<i> (local IP does not match any domain IP)
</I>
...
&gt;<i> 
</I>&gt;<i> So i can't access www.facebook.com. It's error 
</I>&gt;<i> on my browser : *ERR_SSL_PROTOCOL_ERROR*
</I>&gt;<i> *
</I>

&gt;<i> *
</I>&gt;<i> I find out the same issue in this discussion : 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-June/011014.html">http://lists.squid-cache.org/pipermail/squid-users/2016-June/011014.html</A>
</I>&gt;<i> 
</I>
The more complete info about that problem, the things to avoid, and the 
workarounds that help reduce it can be found at 
&lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt;

Be aware that there is no full solution yet. The latest Squid-4 and 
Squid-5 functionality is getting closer to coping with these services, 
but still not complete.


&gt;<i> And then i try to make my squid becomes a cache DNS itself using 
</I>&gt;<i> Unbound. But look like it does'nt work . I get same error before install 
</I>&gt;<i> cache DNS.
</I>
Not just the Squid machine but *all* the clients going through your 
Squid also have to be using the same DNS resolver for that workaround. 
Any of them using other resolvers (eg 8.8.8.8 or similar services) 
*will* hit these errors.


&gt;<i> Here is my DNS test on my Squid:
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A> ~]# nslookup google.com 
</I>&gt;<i> Server:127.0.0.1
</I>&gt;<i> Address:127.0.0.1#53
</I>&gt;<i> 
</I>&gt;<i> Non-authoritative answer:
</I>&gt;<i> Name:google.com
</I>&gt;<i> Address: 216.58.203.46
</I>&gt;<i> 
</I>
&quot;google.com&quot; is not your problem. The domain names in the log are:

  apis.google.com    != 216.58.199.110
  www.google.com.vn  != 172.217.25.3
  www.facebook.com   != 157.240.13.35

Also, be aware that the problem is extremely temporary. It can change 
between failed and working in any random millisecond. So testing even a 
few seconds later often shows different results.


&gt;<i> And this is my dns config in squid.config :
</I>&gt;<i> 
</I>&gt;<i> # --------- DNS AND IP CACHES [4341]
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 127.0.0.1
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> #original_dst off
</I>&gt;<i> client_dst_passthru off
</I>
The above setting is rejecting clients when the host verify fails.
TO let traffic through the proxy when host-verify fails set it back to 
the default &quot;client_dst_passthru on&quot;.

The Host verify failure is most dangerous when cached - so that is 
always prohibited. But upstream routing is difficult for Squid to 
determine - thus that config option. It is left up to you whether you 
risk your clients getting infected by that mechanism - Squid just 
minimizes the damage and risk by limiting it to the one client making 
the suspicious request.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017019.html">[squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config
</A></li>
	<LI>Next message (by thread): <A HREF="017026.html">[squid-users] Fwd: [Squid-3.5.20]Squid transparent proxy http/https without client site config
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17021">[ date ]</a>
              <a href="thread.html#17021">[ thread ]</a>
              <a href="subject.html#17021">[ subject ]</a>
              <a href="author.html#17021">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
