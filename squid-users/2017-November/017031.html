<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward_max_tries 1 has no effect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3CCAHvB88wx%3DyjJyKrrQojEAF4Cz1RsR3pdrvYZCB2mWMDv58tttw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017012.html">
   <LINK REL="Next"  HREF="017034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward_max_tries 1 has no effect</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3CCAHvB88wx%3DyjJyKrrQojEAF4Cz1RsR3pdrvYZCB2mWMDv58tttw%40mail.gmail.com%3E"
       TITLE="[squid-users] forward_max_tries 1 has no effect">xeron.oskom at gmail.com
       </A><BR>
    <I>Tue Nov 28 00:19:52 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017012.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
        <LI>Next message (by thread): <A HREF="017034.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17031">[ date ]</a>
              <a href="thread.html#17031">[ thread ]</a>
              <a href="subject.html#17031">[ subject ]</a>
              <a href="author.html#17031">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think I found part of the config which triggers the retry.

======

# Check for newproxy request header
acl newproxy_acl req_header x-use-newproxy -i true

# proxy
cache_peer 127.0.0.1 parent 18070 0 no-query no-digest no-netdb-exchange
name=proxy
cache_peer_access proxy deny newproxy_acl

# newproxy
cache_peer 127.0.0.1 parent 18079 0 no-query no-digest no-netdb-exchange
name=newproxy
cache_peer_access newproxy allow newproxy_acl
cache_peer_access newproxy deny all

never_direct allow all

======

I see retries only when squid config has 2 parents. If I comment out
everything related to &quot;newproxy&quot; I can't reproduce this behavior anymore.

BUT

My test request could only be forwarded to &quot;proxy&quot; since it doesn't have
&quot;x-use-newproxy&quot; header.

Which results in the following:

squid has 2 parents
request could only be forwarded to the 1st parent due to ACL
parent doesn't respond and closes the TCP connection
squid retries with the same parent ignoring &quot;forward_max_tries 1&quot;

I also want to clarify some facts which make me think that it could be a
bug.

1. There're no issues with TCP connection. Squid successfully connects to
parent and sends an HTTP request.
2. Parent ACKs HTTP request and then correctly closes the connection with
FIN,ACK after 40 seconds. There're no TCP timeouts/reconnects involved. The
only issue here is that parent doesn't send any HTTP response.
3. forward_max_tries is set to 1 to make sure squid won't retry. Parent
handles the retry so we don't want squid to make any additional retries.

Also see
<A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F</A>

&gt;<i> Squid does not try to re-forward a request if at least one of the
</I>following conditions is true:
&gt;<i> &#8230;
</I>&gt;<i> The number of forwarding attempts exceeded forward_max_tries. For
</I>example, if you set forward_max_tries to 1 (one), then no requests will be
re-forwarded.
&gt;<i> &#8230;
</I>&gt;<i> Squid has no alternative destinations to try. Please note that
</I>alternative destinations may include multiple next hop IP addresses and
multiple peers.
&gt;<i> &#8230;
</I>
Another part of config which may or may not be related (this is to increase
the amount of local ports to use):

# 33% of traffic per local IP
acl third random 1/3
acl half random 1/2
tcp_outgoing_address 127.0.0.2 third
tcp_outgoing_address 127.0.0.3 half
tcp_outgoing_address 127.0.0.4

Logs:

ALL,2 (includes 44,2):

2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(220) doAccept: New connection
on FD 15
2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(295) acceptNext: connection on
local=0.0.0.0:3128 remote=[::] FD 15 flags=9
2017/11/27 15:53:40.543| 11,2| client_side.cc(2372) parseHttpRequest: HTTP
Client local=127.0.0.1:3128 remote=127.0.0.1:53798 FD 45 flags=1
2017/11/27 15:53:40.543| 11,2| client_side.cc(2373) parseHttpRequest: HTTP
Client REQUEST:
---------
GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
Host: HOST:12345
User-Agent: curl/7.51.0
Accept: */*
Proxy-Connection: Keep-Alive


----------
2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED; last
ACL checked: localhost
2017/11/27 15:53:40.543| 85,2| client_side_request.cc(721)
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED; last
ACL checked: localhost
2017/11/27 15:53:40.543| 17,2| FwdState.cc(133) FwdState: Forwarding client
request local=127.0.0.1:3128 remote=127.0.0.1:53798 FD 45 flags=1, url=
<A HREF="http://HOST:12345/">http://HOST:12345/</A>
2017/11/27 15:53:40.543| 44,2| peer_select.cc(258) peerSelectDnsPaths: Find
IP destination for: <A HREF="http://HOST:12345/">http://HOST:12345/</A>' via 127.0.0.1
2017/11/27 15:53:40.543| 44,2| peer_select.cc(280) peerSelectDnsPaths:
Found sources for '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
2017/11/27 15:53:40.543| 44,2| peer_select.cc(281) peerSelectDnsPaths:
 always_direct = DENIED
2017/11/27 15:53:40.543| 44,2| peer_select.cc(282) peerSelectDnsPaths:
never_direct = ALLOWED
2017/11/27 15:53:40.543| 44,2| peer_select.cc(292) peerSelectDnsPaths:
cache_peer = local=127.0.0.3 remote=127.0.0.1:18070 flags=1
2017/11/27 15:53:40.543| 44,2| peer_select.cc(295) peerSelectDnsPaths:
  timedout = 0
2017/11/27 15:53:40.543| 11,2| http.cc(2229) sendRequest: HTTP Server local=
127.0.0.3:57091 remote=127.0.0.1:18070 FD 40 flags=1
2017/11/27 15:53:40.543| 11,2| http.cc(2230) sendRequest: HTTP Server
REQUEST:
---------
GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
User-Agent: curl/7.51.0
Accept: */*
Host: HOST:12345
Cache-Control: max-age=259200
Connection: keep-alive


----------

[SKIPPED 40 seconds until parent closes TCP connection with FIN,ACK]

2017/11/27 15:54:20.627| 11,2| http.cc(1299) continueAfterParsingHeader:
WARNING: HTTP: Invalid Response: No object data received for
<A HREF="http://HOST:12345/">http://HOST:12345/</A> AKA HOST/
2017/11/27 15:54:20.627| 17,2| FwdState.cc(655)
handleUnregisteredServerEnd: self=0x3e31838*2 err=0x409b338
<A HREF="http://HOST:12345/">http://HOST:12345/</A>
2017/11/27 15:54:20.627| 11,2| http.cc(2229) sendRequest: HTTP Server local=
127.0.0.3:41355 remote=127.0.0.1:18070 FD 40 flags=1
2017/11/27 15:54:20.627| 11,2| http.cc(2230) sendRequest: HTTP Server
REQUEST:
---------
GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
User-Agent: curl/7.51.0
Accept: */*
Host: HOST:12345
Cache-Control: max-age=259200
Connection: keep-alive


----------

[SKIPPED 40 seconds again until parent closes TCP connection with FIN,ACK]

2017/11/27 15:55:00.728| ctx: enter level  0: '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
2017/11/27 15:55:00.728| 11,2| http.cc(719) processReplyHeader: HTTP Server
local=127.0.0.3:41355 remote=127.0.0.1:18070 FD 40 flags=1
2017/11/27 15:55:00.728| 11,2| http.cc(720) processReplyHeader: HTTP Server
REPLY:
---------
HTTP/1.0 502 Bad Gateway
Cache-Control: no-cache
Connection: close
Content-Type: text/html

&lt;html&gt;&lt;body&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;
The server returned an invalid or incomplete response.
&lt;/body&gt;&lt;/html&gt;

----------
2017/11/27 15:55:00.728| ctx: exit level  0
2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2017/11/27 15:55:00.728| 88,2| client_side_reply.cc(2073)
processReplyAccessResult: The reply for GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED,
because it matched (access_log stdio:/var/log/squid/access.log line)
2017/11/27 15:55:00.728| 11,2| client_side.cc(1409) sendStartOfMessage:
HTTP Client local=127.0.0.1:3128 remote=127.0.0.1:53798 FD 45 flags=1
2017/11/27 15:55:00.728| 11,2| client_side.cc(1410) sendStartOfMessage:
HTTP Client REPLY:
---------
HTTP/1.1 502 Bad Gateway
Date: Mon, 27 Nov 2017 23:54:20 GMT
Cache-Control: no-cache
Content-Type: text/html
X-Cache: MISS from ip-172-23-18-130
X-Cache-Lookup: MISS from ip-172-23-18-130:3128
Transfer-Encoding: chunked
Connection: keep-alive


----------


On Thu, Nov 23, 2017 at 11:43 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
wrote:

&gt;<i>
</I>&gt;<i> On 24/11/17 10:03, Ivan Larionov wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Nov 23, 2017, at 12:32 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;&gt;<i> wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 23/11/17 14:20, Ivan Larionov wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Hello.
</I>&gt;&gt;&gt;&gt;<i> We have an issue with squid when it tries to re-forward / retry failed
</I>&gt;&gt;&gt;&gt;<i> request even when forward_max_tries is set to 1. The situation when it
</I>&gt;&gt;&gt;&gt;<i> happens is when there's no response, parent just closes the connection.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It doesn't happen 100% times. Sometimes squid returns 502 after the 1st
</I>&gt;&gt;&gt;&gt;<i> try, sometimes it retries once. Also I haven't seen more than 1 retry.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Please enable debug_options 44,2 to see what destinations your Squid is
</I>&gt;&gt;&gt;<i> actually finding.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'll check this on Monday.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> max_forward_tries is just a rough cap on the number of server names
</I>&gt;&gt;&gt;<i> which can be found when generating that list. The actual destinations count
</I>&gt;&gt;&gt;<i> can exceed it if one or more of the servers happens to have multiple IPs to
</I>&gt;&gt;&gt;<i> try.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The overall transaction can involve retries if one of the other layers
</I>&gt;&gt;&gt;<i> (TCP or HTTP) contains retry semantics to a single server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Could it be a bug? We'd really like to disable these retries.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Why are trying to break HTTP?
</I>&gt;&gt;&gt;<i> What is the actual problem you are trying to resolve here?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Why do you think I'm trying to break HTTP?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> squid forwards the request to parent but parent misbehaves and just
</I>&gt;&gt;<i> closes the connection after 40 seconds. I'm trying to prevent retry of
</I>&gt;&gt;<i> request in such situation. Why squid retries if I never asked him to do it
</I>&gt;&gt;<i> and specifically said &quot;forward_max_tries 1&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And this is not a connection failure, squid successfully establishes the
</I>&gt;&gt;<i> connection and sends the request, parent ACKs it, just never responses back
</I>&gt;&gt;<i> and proactively closes the connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> This is not misbehaviour on the part of either Squid nor the parent.
</I>&gt;<i> &lt;<A HREF="https://tools.ietf.org/html/rfc7230#section-6.3.1">https://tools.ietf.org/html/rfc7230#section-6.3.1</A>&gt;
</I>&gt;<i> &quot;Connections can be closed at any time, with or without intention.&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As has been discussed in other threads recently there are servers out
</I>&gt;<i> there starting to greylist TCP connections, closing the first one some time
</I>&gt;<i> *after* SYN+ACK regardless of what the proxy sends and accepting any
</I>&gt;<i> followup connection attempts.
</I>&gt;<i>
</I>&gt;<i> NP: That can result in exactly the behaviour you describe from the peer as
</I>&gt;<i> Squid does not wait for a FIN to arrive before sending its upstream HTTP
</I>&gt;<i> request - Squid will &quot;randomly&quot; get a FIN or a RST depending on whether the
</I>&gt;<i> FIN or the DATA packet wins the race into the Squid machines TCP stack. FIN
</I>&gt;<i> and RST have different retry properties which might explain your &quot;sometimes
</I>&gt;<i> retries&quot; behaviour.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Also, TCP connections fail quite often for many other reasons anyway.
</I>&gt;<i> Anything from power fluctuations at a router to BGP switching the packet
</I>&gt;<i> route dropping packets. They are most often a short-term situation which is
</I>&gt;<i> resolved by the time the repeat is attempted.
</I>&gt;<i>
</I>&gt;<i> What you are trying to do will result in Squid being unable to cope with
</I>&gt;<i> any of these transitory restrictions from the TCP environment and force the
</I>&gt;<i> client to receive a terminal error page.
</I>&gt;<i>  That will greatly slow down detection and recovery from the slightly
</I>&gt;<i> longer-lived TCP issues in Squid itself and may result in N other clients
</I>&gt;<i> also unnecessarily receiving the same error response as bad connection
</I>&gt;<i> attempts gets spread between many clients (all getting errors) instead of
</I>&gt;<i> isolated to the one/few who hit it when the issue initially occurs.
</I>&gt;<i>
</I>&gt;<i> Expanding the retries to large numbers (ie the recent default change to
</I>&gt;<i> 25), or to low numbers (eg the old default of 5) are reasonable things to
</I>&gt;<i> do depending on the network stability to your upstreams. But going all the
</I>&gt;<i> way to 0 retries is guaranteed to lead to more client visible problems than
</I>&gt;<i> necessary.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All that asside I phrased it as a question because you might have had a
</I>&gt;<i> good reason for increasing the visible failure rates.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> We're already fixing parent behavior, but still want to disable retries on
</I>&gt;&gt;<i> squid side.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Since you describe this as peer misbehaviour, then treating it to Squids
</I>&gt;<i> normal TCP failure recovery is the best behaviour. Retry is the intended
</I>&gt;<i> correct behaviour for a proxy to perform on any non-idempotent requests. In
</I>&gt;<i> your case up to a value of 1 retry before declaring non-temporary route
</I>&gt;<i> failure.
</I>&gt;<i>
</I>&gt;<i> NP: idempotent vs non-idempotent may be another reason behind the observed
</I>&gt;<i> behaviour of retry happening only sometimes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If you are doing this due to overall latency/delay on the affected client
</I>&gt;<i> traffic you would be better off reducing the timeouts involved (cache_peer
</I>&gt;<i> connect-timeout= parameter AFAICS) than aiming at a retry count of 0.
</I>&gt;<i> Perhapse also requiring a few standby=N persistent connections to be
</I>&gt;<i> maintained if the peer is HTTP/1.1 capable.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>


-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171127/889e8d27/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171127/889e8d27/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017012.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
	<LI>Next message (by thread): <A HREF="017034.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17031">[ date ]</a>
              <a href="thread.html#17031">[ thread ]</a>
              <a href="subject.html#17031">[ subject ]</a>
              <a href="author.html#17031">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
