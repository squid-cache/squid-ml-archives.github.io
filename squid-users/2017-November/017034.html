<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward_max_tries 1 has no effect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3C4e0b3811-2965-32d7-fe70-a6987ced93f8%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017031.html">
   <LINK REL="Next"  HREF="017035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward_max_tries 1 has no effect</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3C4e0b3811-2965-32d7-fe70-a6987ced93f8%40measurement-factory.com%3E"
       TITLE="[squid-users] forward_max_tries 1 has no effect">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov 28 15:32:53 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017031.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
        <LI>Next message (by thread): <A HREF="017035.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17034">[ date ]</a>
              <a href="thread.html#17034">[ thread ]</a>
              <a href="subject.html#17034">[ subject ]</a>
              <a href="author.html#17034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/27/2017 05:19 PM, Ivan Larionov wrote:

&gt;<i> I see retries only when squid config has 2 parents. If I comment out
</I>&gt;<i> everything related to &quot;newproxy&quot; I can't reproduce this behavior anymore.
</I>
The posted logs are not detailed enough to confirm or deny that IMO, but
I suspect that you are dealing with at least one bug.


&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F</A>
</I>&gt;<i> 
</I>&gt;&gt;<i> Squid does not try to re-forward a request if at least one of the following conditions is true:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The number of forwarding attempts exceeded forward_max_tries. For
</I>&gt;&gt;<i> example, if you set forward_max_tries to 1 (one), then no requests
</I>&gt;&gt;<i> will be re-forwarded.
</I>

AFAICT, there is an off-by-one bug in Squid that violates the above:

&gt;<i>     if (n_tries &gt; Config.forward_max_tries)
</I>&gt;<i>         return false;
</I>
The n_tries counter is incremented before Squid makes a request
forwarding attempt. With n_tries and Config.forward_max_tries both set
to 1, the quoted FwdState::checkRetry() code will not prevent
re-forwarding. There is a similar problem in FwdState::reforward(). This
reasoning needs confirmation/testing.

Please note that simply changing the &quot;&gt;&quot; operator to &quot;&gt;=&quot; may break
other things in a difficult-to-detect-by-simple-tests ways. The correct
fix may be more complex than it looks and may involve making policy
decisions regarding forward_max_tries meaning. The best fix would remove
checkRetry() and reforward() duplication. This code is difficult to work
with; many related code names are misleading.


&gt;&gt;<i> Squid has no alternative destinations to try. Please note that
</I>&gt;&gt;<i> alternative destinations may include multiple next hop IP addresses
</I>&gt;&gt;<i> and multiple peers.
</I>
The fact that Squid sends two requests to the same peer with only one
peer address selected suggests that Squid is retrying a failed
persistent connection rather than re-forwarding after receiving a bad
response. Again, the logs are not detailed enough to distinguish the two
cases. I can only see that a single peer/destination address was
selected (not two), which is correct/expected behavior. I cannot see
what happened next with sufficient detail.

Going forward, you have several options, including:

A. Post a link to compressed ALL,7+ logs to confirm bug(s).
B. Fix the broken condition(s) in FwdState. See above.

HTH,

Alex.


&gt;<i> 2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 15
</I>&gt;<i> 2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(295) acceptNext: connection
</I>&gt;<i> on local=0.0.0.0:3128 &lt;<A HREF="http://0.0.0.0:3128">http://0.0.0.0:3128</A>&gt; remote=[::] FD 15 flags=9
</I>&gt;<i> 2017/11/27 15:53:40.543| 11,2| client_side.cc(2372) parseHttpRequest:
</I>&gt;<i> HTTP Client local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1
</I>&gt;<i> 2017/11/27 15:53:40.543| 11,2| client_side.cc(2373) parseHttpRequest:
</I>&gt;<i> HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i> Host: HOST:12345
</I>&gt;<i> User-Agent: curl/7.51.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
</I>&gt;<i> clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED;
</I>&gt;<i> last ACL checked: localhost
</I>&gt;<i> 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(721)
</I>&gt;<i> clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i> 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
</I>&gt;<i> clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED;
</I>&gt;<i> last ACL checked: localhost
</I>&gt;<i> 2017/11/27 15:53:40.543| 17,2| FwdState.cc(133) FwdState: Forwarding
</I>&gt;<i> client request local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1,
</I>&gt;<i> url=<A HREF="http://HOST:12345/">http://HOST:12345/</A>
</I>&gt;<i> 2017/11/27 15:53:40.543| 44,2| peer_select.cc(258) peerSelectDnsPaths:
</I>&gt;<i> Find IP destination for: <A HREF="http://HOST:12345/">http://HOST:12345/</A>' via 127.0.0.1
</I>&gt;<i> 2017/11/27 15:53:40.543| 44,2| peer_select.cc(280) peerSelectDnsPaths:
</I>&gt;<i> Found sources for '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
</I>&gt;<i> 2017/11/27 15:53:40.543| 44,2| peer_select.cc(281) peerSelectDnsPaths:&#160;
</I>&gt;<i> &#160;always_direct = DENIED
</I>&gt;<i> 2017/11/27 15:53:40.543| 44,2| peer_select.cc(282) peerSelectDnsPaths:&#160;
</I>&gt;<i> &#160; never_direct = ALLOWED
</I>&gt;<i> 2017/11/27 15:53:40.543| 44,2| peer_select.cc(292) peerSelectDnsPaths:&#160;
</I>&gt;<i> &#160; &#160; cache_peer = local=127.0.0.3 remote=127.0.0.1:18070
</I>&gt;<i> &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; flags=1
</I>&gt;<i> 2017/11/27 15:53:40.543| 44,2| peer_select.cc(295) peerSelectDnsPaths:&#160;
</I>&gt;<i> &#160; &#160; &#160; timedout = 0
</I>&gt;<i> 2017/11/27 15:53:40.543| 11,2| http.cc(2229) sendRequest: HTTP Server
</I>&gt;<i> local=127.0.0.3:57091 &lt;<A HREF="http://127.0.0.3:57091">http://127.0.0.3:57091</A>&gt; remote=127.0.0.1:18070
</I>&gt;<i> &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i> 2017/11/27 15:53:40.543| 11,2| http.cc(2230) sendRequest: HTTP Server
</I>&gt;<i> REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.51.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Host: HOST:12345
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 
</I>&gt;<i> [SKIPPED 40 seconds until parent closes TCP connection with FIN,ACK]
</I>&gt;<i> 
</I>&gt;<i> 2017/11/27 15:54:20.627| 11,2| http.cc(1299) continueAfterParsingHeader:
</I>&gt;<i> WARNING: HTTP: Invalid Response: No object data received for
</I>&gt;<i> <A HREF="http://HOST:12345/">http://HOST:12345/</A> AKA HOST/
</I>&gt;<i> 2017/11/27 15:54:20.627| 17,2| FwdState.cc(655)
</I>&gt;<i> handleUnregisteredServerEnd: self=0x3e31838*2 err=0x409b338
</I>&gt;<i> <A HREF="http://HOST:12345/">http://HOST:12345/</A>
</I>&gt;<i> 2017/11/27 15:54:20.627| 11,2| http.cc(2229) sendRequest: HTTP Server
</I>&gt;<i> local=127.0.0.3:41355 &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt; remote=127.0.0.1:18070
</I>&gt;<i> &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i> 2017/11/27 15:54:20.627| 11,2| http.cc(2230) sendRequest: HTTP Server
</I>&gt;<i> REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.51.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Host: HOST:12345
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 
</I>&gt;<i> [SKIPPED 40 seconds again until parent closes TCP connection with FIN,ACK]
</I>&gt;<i> 
</I>&gt;<i> 2017/11/27 15:55:00.728| ctx: enter level&#160; 0: '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
</I>&gt;<i> 2017/11/27 15:55:00.728| 11,2| http.cc(719) processReplyHeader: HTTP
</I>&gt;<i> Server local=127.0.0.3:41355 &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt;
</I>&gt;<i> remote=127.0.0.1:18070 &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i> 2017/11/27 15:55:00.728| 11,2| http.cc(720) processReplyHeader: HTTP
</I>&gt;<i> Server REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.0 502 Bad Gateway
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i> Connection: close
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i> 
</I>&gt;<i> &lt;html&gt;&lt;body&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;
</I>&gt;<i> The server returned an invalid or incomplete response.
</I>&gt;<i> &lt;/body&gt;&lt;/html&gt;
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2017/11/27 15:55:00.728| ctx: exit level&#160; 0
</I>&gt;<i> 2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
</I>&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
</I>&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> 2017/11/27 15:55:00.728| 88,2| client_side_reply.cc(2073)
</I>&gt;<i> processReplyAccessResult: The reply for GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is
</I>&gt;<i> ALLOWED, because it matched (access_log stdio:/var/log/squid/access.log
</I>&gt;<i> line)
</I>&gt;<i> 2017/11/27 15:55:00.728| 11,2| client_side.cc(1409) sendStartOfMessage:
</I>&gt;<i> HTTP Client local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1
</I>&gt;<i> 2017/11/27 15:55:00.728| 11,2| client_side.cc(1410) sendStartOfMessage:
</I>&gt;<i> HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 502 Bad Gateway
</I>&gt;<i> Date: Mon, 27 Nov 2017 23:54:20 GMT
</I>&gt;<i> Cache-Control: no-cache
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i> X-Cache: MISS from ip-172-23-18-130
</I>&gt;<i> X-Cache-Lookup: MISS from ip-172-23-18-130:3128
</I>&gt;<i> Transfer-Encoding: chunked
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017031.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
	<LI>Next message (by thread): <A HREF="017035.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17034">[ date ]</a>
              <a href="thread.html#17034">[ thread ]</a>
              <a href="subject.html#17034">[ subject ]</a>
              <a href="author.html#17034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
