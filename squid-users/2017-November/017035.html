<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward_max_tries 1 has no effect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3CCAHvB88yEgcfYNrLYDENCXm2me%3Djguqgj-9FB9KdtiJV9catORQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017034.html">
   <LINK REL="Next"  HREF="017036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward_max_tries 1 has no effect</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3CCAHvB88yEgcfYNrLYDENCXm2me%3Djguqgj-9FB9KdtiJV9catORQ%40mail.gmail.com%3E"
       TITLE="[squid-users] forward_max_tries 1 has no effect">xeron.oskom at gmail.com
       </A><BR>
    <I>Tue Nov 28 21:27:44 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017034.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
        <LI>Next message (by thread): <A HREF="017036.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17035">[ date ]</a>
              <a href="thread.html#17035">[ thread ]</a>
              <a href="subject.html#17035">[ subject ]</a>
              <a href="author.html#17035">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Alex, this is very helpful.

Another interesting fact is that I can't reproduce this issue if squid has
no other traffic except my testing requests. But it's easy to reproduce
when server has other traffic.

The problem is that with other traffic I can't provide the whole log file
with debug ALL,7 enabled because it has other requests.

So I tried to select only parts related to my test request (this is ALL,7):

<A HREF="https://www.dropbox.com/s/udzeipeerf5o38t/squid_retry_logs.tgz?dl=1">https://www.dropbox.com/s/udzeipeerf5o38t/squid_retry_logs.tgz?dl=1</A>


On Tue, Nov 28, 2017 at 7:32 AM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 11/27/2017 05:19 PM, Ivan Larionov wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I see retries only when squid config has 2 parents. If I comment out
</I>&gt;<i> &gt; everything related to &quot;newproxy&quot; I can't reproduce this behavior anymore.
</I>&gt;<i>
</I>&gt;<i> The posted logs are not detailed enough to confirm or deny that IMO, but
</I>&gt;<i> I suspect that you are dealing with at least one bug.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When</A>_
</I>&gt;<i> does_Squid_re-forward_a_client_request.3F
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Squid does not try to re-forward a request if at least one of the
</I>&gt;<i> following conditions is true:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The number of forwarding attempts exceeded forward_max_tries. For
</I>&gt;<i> &gt;&gt; example, if you set forward_max_tries to 1 (one), then no requests
</I>&gt;<i> &gt;&gt; will be re-forwarded.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> AFAICT, there is an off-by-one bug in Squid that violates the above:
</I>&gt;<i>
</I>&gt;<i> &gt;     if (n_tries &gt; Config.forward_max_tries)
</I>&gt;<i> &gt;         return false;
</I>&gt;<i>
</I>&gt;<i> The n_tries counter is incremented before Squid makes a request
</I>&gt;<i> forwarding attempt. With n_tries and Config.forward_max_tries both set
</I>&gt;<i> to 1, the quoted FwdState::checkRetry() code will not prevent
</I>&gt;<i> re-forwarding. There is a similar problem in FwdState::reforward(). This
</I>&gt;<i> reasoning needs confirmation/testing.
</I>&gt;<i>
</I>&gt;<i> Please note that simply changing the &quot;&gt;&quot; operator to &quot;&gt;=&quot; may break
</I>&gt;<i> other things in a difficult-to-detect-by-simple-tests ways. The correct
</I>&gt;<i> fix may be more complex than it looks and may involve making policy
</I>&gt;<i> decisions regarding forward_max_tries meaning. The best fix would remove
</I>&gt;<i> checkRetry() and reforward() duplication. This code is difficult to work
</I>&gt;<i> with; many related code names are misleading.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Squid has no alternative destinations to try. Please note that
</I>&gt;<i> &gt;&gt; alternative destinations may include multiple next hop IP addresses
</I>&gt;<i> &gt;&gt; and multiple peers.
</I>&gt;<i>
</I>&gt;<i> The fact that Squid sends two requests to the same peer with only one
</I>&gt;<i> peer address selected suggests that Squid is retrying a failed
</I>&gt;<i> persistent connection rather than re-forwarding after receiving a bad
</I>&gt;<i> response. Again, the logs are not detailed enough to distinguish the two
</I>&gt;<i> cases. I can only see that a single peer/destination address was
</I>&gt;<i> selected (not two), which is correct/expected behavior. I cannot see
</I>&gt;<i> what happened next with sufficient detail.
</I>&gt;<i>
</I>&gt;<i> Going forward, you have several options, including:
</I>&gt;<i>
</I>&gt;<i> A. Post a link to compressed ALL,7+ logs to confirm bug(s).
</I>&gt;<i> B. Fix the broken condition(s) in FwdState. See above.
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(220) doAccept: New
</I>&gt;<i> connection on FD 15
</I>&gt;<i> &gt; 2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(295) acceptNext: connection
</I>&gt;<i> &gt; on local=0.0.0.0:3128 &lt;<A HREF="http://0.0.0.0:3128">http://0.0.0.0:3128</A>&gt; remote=[::] FD 15 flags=9
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 11,2| client_side.cc(2372) parseHttpRequest:
</I>&gt;<i> &gt; HTTP Client local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> &gt; remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 11,2| client_side.cc(2373) parseHttpRequest:
</I>&gt;<i> &gt; HTTP Client REQUEST:
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i> &gt; Host: HOST:12345
</I>&gt;<i> &gt; User-Agent: curl/7.51.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Proxy-Connection: Keep-Alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----------
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
</I>&gt;<i> &gt; clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED;
</I>&gt;<i> &gt; last ACL checked: localhost
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(721)
</I>&gt;<i> &gt; clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
</I>&gt;<i> &gt; clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED;
</I>&gt;<i> &gt; last ACL checked: localhost
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 17,2| FwdState.cc(133) FwdState: Forwarding
</I>&gt;<i> &gt; client request local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> &gt; remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1,
</I>&gt;<i> &gt; url=<A HREF="http://HOST:12345/">http://HOST:12345/</A>
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(258) peerSelectDnsPaths:
</I>&gt;<i> &gt; Find IP destination for: <A HREF="http://HOST:12345/">http://HOST:12345/</A>' via 127.0.0.1
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(280) peerSelectDnsPaths:
</I>&gt;<i> &gt; Found sources for '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(281) peerSelectDnsPaths:
</I>&gt;<i> &gt;  always_direct = DENIED
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(282) peerSelectDnsPaths:
</I>&gt;<i> &gt;   never_direct = ALLOWED
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(292) peerSelectDnsPaths:
</I>&gt;<i> &gt;     cache_peer = local=127.0.0.3 remote=127.0.0.1:18070
</I>&gt;<i> &gt; &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; flags=1
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(295) peerSelectDnsPaths:
</I>&gt;<i> &gt;       timedout = 0
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 11,2| http.cc(2229) sendRequest: HTTP Server
</I>&gt;<i> &gt; local=127.0.0.3:57091 &lt;<A HREF="http://127.0.0.3:57091">http://127.0.0.3:57091</A>&gt; remote=127.0.0.1:18070
</I>&gt;<i> &gt; &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i> &gt; 2017/11/27 15:53:40.543| 11,2| http.cc(2230) sendRequest: HTTP Server
</I>&gt;<i> &gt; REQUEST:
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i> &gt; User-Agent: curl/7.51.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Host: HOST:12345
</I>&gt;<i> &gt; Cache-Control: max-age=259200
</I>&gt;<i> &gt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [SKIPPED 40 seconds until parent closes TCP connection with FIN,ACK]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2017/11/27 15:54:20.627| 11,2| http.cc(1299) continueAfterParsingHeader:
</I>&gt;<i> &gt; WARNING: HTTP: Invalid Response: No object data received for
</I>&gt;<i> &gt; <A HREF="http://HOST:12345/">http://HOST:12345/</A> AKA HOST/
</I>&gt;<i> &gt; 2017/11/27 15:54:20.627| 17,2| FwdState.cc(655)
</I>&gt;<i> &gt; handleUnregisteredServerEnd: self=0x3e31838*2 err=0x409b338
</I>&gt;<i> &gt; <A HREF="http://HOST:12345/">http://HOST:12345/</A>
</I>&gt;<i> &gt; 2017/11/27 15:54:20.627| 11,2| http.cc(2229) sendRequest: HTTP Server
</I>&gt;<i> &gt; local=127.0.0.3:41355 &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt; remote=127.0.0.1:18070
</I>&gt;<i> &gt; &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i> &gt; 2017/11/27 15:54:20.627| 11,2| http.cc(2230) sendRequest: HTTP Server
</I>&gt;<i> &gt; REQUEST:
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i> &gt; User-Agent: curl/7.51.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Host: HOST:12345
</I>&gt;<i> &gt; Cache-Control: max-age=259200
</I>&gt;<i> &gt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [SKIPPED 40 seconds again until parent closes TCP connection with
</I>&gt;<i> FIN,ACK]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| ctx: enter level  0: '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 11,2| http.cc(719) processReplyHeader: HTTP
</I>&gt;<i> &gt; Server local=127.0.0.3:41355 &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt;
</I>&gt;<i> &gt; remote=127.0.0.1:18070 &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 11,2| http.cc(720) processReplyHeader: HTTP
</I>&gt;<i> &gt; Server REPLY:
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; HTTP/1.0 502 Bad Gateway
</I>&gt;<i> &gt; Cache-Control: no-cache
</I>&gt;<i> &gt; Connection: close
</I>&gt;<i> &gt; Content-Type: text/html
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt;html&gt;&lt;body&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;
</I>&gt;<i> &gt; The server returned an invalid or incomplete response.
</I>&gt;<i> &gt; &lt;/body&gt;&lt;/html&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----------
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| ctx: exit level  0
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
</I>&gt;<i> &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
</I>&gt;<i> &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 88,2| client_side_reply.cc(2073)
</I>&gt;<i> &gt; processReplyAccessResult: The reply for GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is
</I>&gt;<i> &gt; ALLOWED, because it matched (access_log stdio:/var/log/squid/access.log
</I>&gt;<i> &gt; line)
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 11,2| client_side.cc(1409) sendStartOfMessage:
</I>&gt;<i> &gt; HTTP Client local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> &gt; remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1
</I>&gt;<i> &gt; 2017/11/27 15:55:00.728| 11,2| client_side.cc(1410) sendStartOfMessage:
</I>&gt;<i> &gt; HTTP Client REPLY:
</I>&gt;<i> &gt; ---------
</I>&gt;<i> &gt; HTTP/1.1 502 Bad Gateway
</I>&gt;<i> &gt; Date: Mon, 27 Nov 2017 23:54:20 GMT
</I>&gt;<i> &gt; Cache-Control: no-cache
</I>&gt;<i> &gt; Content-Type: text/html
</I>&gt;<i> &gt; X-Cache: MISS from ip-172-23-18-130
</I>&gt;<i> &gt; X-Cache-Lookup: MISS from ip-172-23-18-130:3128
</I>&gt;<i> &gt; Transfer-Encoding: chunked
</I>&gt;<i> &gt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----------
</I>&gt;<i>
</I>


-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171128/f98dfef6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171128/f98dfef6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017034.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
	<LI>Next message (by thread): <A HREF="017036.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17035">[ date ]</a>
              <a href="thread.html#17035">[ thread ]</a>
              <a href="subject.html#17035">[ subject ]</a>
              <a href="author.html#17035">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
