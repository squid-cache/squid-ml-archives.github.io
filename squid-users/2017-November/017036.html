<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward_max_tries 1 has no effect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3C20b1fce2-6677-fd06-2bf1-4e74f05e214c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017035.html">
   <LINK REL="Next"  HREF="017041.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward_max_tries 1 has no effect</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward_max_tries%201%20has%20no%20effect&In-Reply-To=%3C20b1fce2-6677-fd06-2bf1-4e74f05e214c%40measurement-factory.com%3E"
       TITLE="[squid-users] forward_max_tries 1 has no effect">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 29 03:12:40 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017035.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
        <LI>Next message (by thread): <A HREF="017041.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17036">[ date ]</a>
              <a href="thread.html#17036">[ thread ]</a>
              <a href="subject.html#17036">[ subject ]</a>
              <a href="author.html#17036">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/28/2017 02:27 PM, Ivan Larionov wrote:

&gt;<i> Another interesting fact is that I can't reproduce this issue if squid
</I>&gt;<i> has no other traffic except my testing requests. But it's easy to
</I>&gt;<i> reproduce when server has other traffic.
</I>
I did not check your logs carefully, but I believe that (when things do
not work the way you expect) your Squid is retrying a failed persistent
connection (rather than re-forwarding the request after receiving a bad
response). See the &quot;pconn race happened&quot; line below:

&gt;<i> 1_retry.log:2017/11/28 12:55:12.731| 17,3| FwdState.cc(416) fail: ERR_ZERO_SIZE_OBJECT &quot;Bad Gateway&quot;
</I>&gt;<i> 1_retry.log:2017/11/28 12:55:12.731| 17,5| FwdState.cc(430) fail: pconn race happened
</I>&gt;<i> 1_retry.log:2017/11/28 12:55:12.731| 93,5| AsyncJob.cc(84) mustStop: HttpStateData will stop, reason: HttpStateData::continueAfterParsingHeader
</I>&gt;<i> 1_retry.log:2017/11/28 12:55:12.731| 17,3| FwdState.cc(618) retryOrBail: re-forwarding (1 tries, 40 secs)
</I>&gt;<i> 1_retry.log:2017/11/28 12:55:12.731| 17,4| FwdState.cc(621) retryOrBail: retrying the same destination
</I>

Assuming you tested with forward_max_tries set to 1, the retryOrBail
lines above confirm the off-by-one problem I was describing in my
previous response.

AFAICT, compensating by setting forward_max_tries to zero will _not_
work (for reasons unrelated to the problem at hand).


FWIW, your current options include those outlined at
<A HREF="http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>


Alex.


&gt;<i> On Tue, Nov 28, 2017 at 7:32 AM, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 11/27/2017 05:19 PM, Ivan Larionov wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; I see retries only when squid config has 2 parents. If I comment out
</I>&gt;<i>     &gt; everything related to &quot;newproxy&quot; I can't reproduce this behavior anymore.
</I>&gt;<i> 
</I>&gt;<i>     The posted logs are not detailed enough to confirm or deny that IMO, but
</I>&gt;<i>     I suspect that you are dealing with at least one bug.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; <A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F</A>
</I>&gt;<i>     &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F</A>&gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&gt; Squid does not try to re-forward a request if at least one of the following conditions is true:
</I>&gt;<i>     &gt;&gt;
</I>&gt;<i>     &gt;&gt; The number of forwarding attempts exceeded forward_max_tries. For
</I>&gt;<i>     &gt;&gt; example, if you set forward_max_tries to 1 (one), then no requests
</I>&gt;<i>     &gt;&gt; will be re-forwarded.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     AFAICT, there is an off-by-one bug in Squid that violates the above:
</I>&gt;<i> 
</I>&gt;<i>     &gt;&#160; &#160; &#160;if (n_tries &gt; Config.forward_max_tries)
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;return false;
</I>&gt;<i> 
</I>&gt;<i>     The n_tries counter is incremented before Squid makes a request
</I>&gt;<i>     forwarding attempt. With n_tries and Config.forward_max_tries both set
</I>&gt;<i>     to 1, the quoted FwdState::checkRetry() code will not prevent
</I>&gt;<i>     re-forwarding. There is a similar problem in FwdState::reforward(). This
</I>&gt;<i>     reasoning needs confirmation/testing.
</I>&gt;<i> 
</I>&gt;<i>     Please note that simply changing the &quot;&gt;&quot; operator to &quot;&gt;=&quot; may break
</I>&gt;<i>     other things in a difficult-to-detect-by-simple-tests ways. The correct
</I>&gt;<i>     fix may be more complex than it looks and may involve making policy
</I>&gt;<i>     decisions regarding forward_max_tries meaning. The best fix would remove
</I>&gt;<i>     checkRetry() and reforward() duplication. This code is difficult to work
</I>&gt;<i>     with; many related code names are misleading.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt;&gt; Squid has no alternative destinations to try. Please note that
</I>&gt;<i>     &gt;&gt; alternative destinations may include multiple next hop IP addresses
</I>&gt;<i>     &gt;&gt; and multiple peers.
</I>&gt;<i> 
</I>&gt;<i>     The fact that Squid sends two requests to the same peer with only one
</I>&gt;<i>     peer address selected suggests that Squid is retrying a failed
</I>&gt;<i>     persistent connection rather than re-forwarding after receiving a bad
</I>&gt;<i>     response. Again, the logs are not detailed enough to distinguish the two
</I>&gt;<i>     cases. I can only see that a single peer/destination address was
</I>&gt;<i>     selected (not two), which is correct/expected behavior. I cannot see
</I>&gt;<i>     what happened next with sufficient detail.
</I>&gt;<i> 
</I>&gt;<i>     Going forward, you have several options, including:
</I>&gt;<i> 
</I>&gt;<i>     A. Post a link to compressed ALL,7+ logs to confirm bug(s).
</I>&gt;<i>     B. Fix the broken condition(s) in FwdState. See above.
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(220) doAccept: New connection on FD 15
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.542| 5,2| TcpAcceptor.cc(295) acceptNext: connection
</I>&gt;<i>     &gt; on local=0.0.0.0:3128 &lt;<A HREF="http://0.0.0.0:3128">http://0.0.0.0:3128</A>&gt; &lt;<A HREF="http://0.0.0.0:3128">http://0.0.0.0:3128</A>&gt;
</I>&gt;<i>     remote=[::] FD 15 flags=9
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 11,2| client_side.cc(2372) parseHttpRequest:
</I>&gt;<i>     &gt; HTTP Client local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &gt; remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 11,2| client_side.cc(2373) parseHttpRequest:
</I>&gt;<i>     &gt; HTTP Client REQUEST:
</I>&gt;<i>     &gt; ---------
</I>&gt;<i>     &gt; GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i>     &gt; Host: HOST:12345
</I>&gt;<i>     &gt; User-Agent: curl/7.51.0
</I>&gt;<i>     &gt; Accept: */*
</I>&gt;<i>     &gt; Proxy-Connection: Keep-Alive
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; ----------
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
</I>&gt;<i>     &gt; clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED;
</I>&gt;<i>     &gt; last ACL checked: localhost
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(721)
</I>&gt;<i>     &gt; clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 85,2| client_side_request.cc(745)
</I>&gt;<i>     &gt; clientAccessCheckDone: The request GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is ALLOWED;
</I>&gt;<i>     &gt; last ACL checked: localhost
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 17,2| FwdState.cc(133) FwdState: Forwarding
</I>&gt;<i>     &gt; client request local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &gt; remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1,
</I>&gt;<i>     &gt; url=<A HREF="http://HOST:12345/">http://HOST:12345/</A>
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(258) peerSelectDnsPaths:
</I>&gt;<i>     &gt; Find IP destination for: <A HREF="http://HOST:12345/">http://HOST:12345/</A>' via 127.0.0.1
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(280) peerSelectDnsPaths:
</I>&gt;<i>     &gt; Found sources for '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(281) peerSelectDnsPaths:&#160;
</I>&gt;<i>     &gt; &#160;always_direct = DENIED
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(282) peerSelectDnsPaths:&#160;
</I>&gt;<i>     &gt; &#160; never_direct = ALLOWED
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(292) peerSelectDnsPaths:&#160;
</I>&gt;<i>     &gt; &#160; &#160; cache_peer = local=127.0.0.3 remote=127.0.0.1:18070 &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt;
</I>&gt;<i>     &gt; &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; flags=1
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 44,2| peer_select.cc(295) peerSelectDnsPaths:&#160;
</I>&gt;<i>     &gt; &#160; &#160; &#160; timedout = 0
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 11,2| http.cc(2229) sendRequest: HTTP Server
</I>&gt;<i>     &gt; local=127.0.0.3:57091 &lt;<A HREF="http://127.0.0.3:57091">http://127.0.0.3:57091</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.3:57091">http://127.0.0.3:57091</A>&gt; remote=127.0.0.1:18070 &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt;
</I>&gt;<i>     &gt; &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i>     &gt; 2017/11/27 15:53:40.543| 11,2| http.cc(2230) sendRequest: HTTP Server
</I>&gt;<i>     &gt; REQUEST:
</I>&gt;<i>     &gt; ---------
</I>&gt;<i>     &gt; GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i>     &gt; User-Agent: curl/7.51.0
</I>&gt;<i>     &gt; Accept: */*
</I>&gt;<i>     &gt; Host: HOST:12345
</I>&gt;<i>     &gt; Cache-Control: max-age=259200
</I>&gt;<i>     &gt; Connection: keep-alive
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; ----------
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; [SKIPPED 40 seconds until parent closes TCP connection with FIN,ACK]
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; 2017/11/27 15:54:20.627| 11,2| http.cc(1299) continueAfterParsingHeader:
</I>&gt;<i>     &gt; WARNING: HTTP: Invalid Response: No object data received for
</I>&gt;<i>     &gt; <A HREF="http://HOST:12345/">http://HOST:12345/</A> AKA HOST/
</I>&gt;<i>     &gt; 2017/11/27 15:54:20.627| 17,2| FwdState.cc(655)
</I>&gt;<i>     &gt; handleUnregisteredServerEnd: self=0x3e31838*2 err=0x409b338
</I>&gt;<i>     &gt; <A HREF="http://HOST:12345/">http://HOST:12345/</A>
</I>&gt;<i>     &gt; 2017/11/27 15:54:20.627| 11,2| http.cc(2229) sendRequest: HTTP Server
</I>&gt;<i>     &gt; local=127.0.0.3:41355 &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt; remote=127.0.0.1:18070 &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt;
</I>&gt;<i>     &gt; &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i>     &gt; 2017/11/27 15:54:20.627| 11,2| http.cc(2230) sendRequest: HTTP Server
</I>&gt;<i>     &gt; REQUEST:
</I>&gt;<i>     &gt; ---------
</I>&gt;<i>     &gt; GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> HTTP/1.1
</I>&gt;<i>     &gt; User-Agent: curl/7.51.0
</I>&gt;<i>     &gt; Accept: */*
</I>&gt;<i>     &gt; Host: HOST:12345
</I>&gt;<i>     &gt; Cache-Control: max-age=259200
</I>&gt;<i>     &gt; Connection: keep-alive
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; ----------
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; [SKIPPED 40 seconds again until parent closes TCP connection with FIN,ACK]
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| ctx: enter level&#160; 0: '<A HREF="http://HOST:12345/">http://HOST:12345/</A>'
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 11,2| http.cc(719) processReplyHeader: HTTP
</I>&gt;<i>     &gt; Server local=127.0.0.3:41355 &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.3:41355">http://127.0.0.3:41355</A>&gt;
</I>&gt;<i>     &gt; remote=127.0.0.1:18070 &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:18070">http://127.0.0.1:18070</A>&gt; FD 40 flags=1
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 11,2| http.cc(720) processReplyHeader: HTTP
</I>&gt;<i>     &gt; Server REPLY:
</I>&gt;<i>     &gt; ---------
</I>&gt;<i>     &gt; HTTP/1.0 502 Bad Gateway
</I>&gt;<i>     &gt; Cache-Control: no-cache
</I>&gt;<i>     &gt; Connection: close
</I>&gt;<i>     &gt; Content-Type: text/html
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; &lt;html&gt;&lt;body&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;
</I>&gt;<i>     &gt; The server returned an invalid or incomplete response.
</I>&gt;<i>     &gt; &lt;/body&gt;&lt;/html&gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; ----------
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| ctx: exit level&#160; 0
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
</I>&gt;<i>     &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 20,2| store.cc(996) checkCachable:
</I>&gt;<i>     &gt; StoreEntry::checkCachable: NO: not cachable
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 88,2| client_side_reply.cc(2073)
</I>&gt;<i>     &gt; processReplyAccessResult: The reply for GET <A HREF="http://HOST:12345/">http://HOST:12345/</A> is
</I>&gt;<i>     &gt; ALLOWED, because it matched (access_log stdio:/var/log/squid/access.log
</I>&gt;<i>     &gt; line)
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 11,2| client_side.cc(1409) sendStartOfMessage:
</I>&gt;<i>     &gt; HTTP Client local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &gt; remote=127.0.0.1:53798 &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://127.0.0.1:53798">http://127.0.0.1:53798</A>&gt; FD 45 flags=1
</I>&gt;<i>     &gt; 2017/11/27 15:55:00.728| 11,2| client_side.cc(1410)
</I>&gt;<i>     sendStartOfMessage:
</I>&gt;<i>     &gt; HTTP Client REPLY:
</I>&gt;<i>     &gt; ---------
</I>&gt;<i>     &gt; HTTP/1.1 502 Bad Gateway
</I>&gt;<i>     &gt; Date: Mon, 27 Nov 2017 23:54:20 GMT
</I>&gt;<i>     &gt; Cache-Control: no-cache
</I>&gt;<i>     &gt; Content-Type: text/html
</I>&gt;<i>     &gt; X-Cache: MISS from ip-172-23-18-130
</I>&gt;<i>     &gt; X-Cache-Lookup: MISS from ip-172-23-18-130:3128
</I>&gt;<i>     &gt; Transfer-Encoding: chunked
</I>&gt;<i>     &gt; Connection: keep-alive
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; ----------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> With best regards, Ivan Larionov.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017035.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
	<LI>Next message (by thread): <A HREF="017041.html">[squid-users] forward_max_tries 1 has no effect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17036">[ date ]</a>
              <a href="thread.html#17036">[ thread ]</a>
              <a href="subject.html#17036">[ subject ]</a>
              <a href="author.html#17036">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
