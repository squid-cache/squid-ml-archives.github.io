<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Working peek/splice no longer functioning on some sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%20sites&In-Reply-To=%3C7e3e81c9-0949-9f16-f1f8-7efc052dae78%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017029.html">
   <LINK REL="Next"  HREF="017027.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Working peek/splice no longer functioning on some sites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%20sites&In-Reply-To=%3C7e3e81c9-0949-9f16-f1f8-7efc052dae78%40treenet.co.nz%3E"
       TITLE="[squid-users] Working peek/splice no longer functioning on some sites">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Nov 29 14:29:26 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017029.html">[squid-users] Working peek/splice no longer functioning on some sites
</A></li>
        <LI>Next message (by thread): <A HREF="017027.html">[squid-users] filtering HTTPS sites with transparent child Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17039">[ date ]</a>
              <a href="thread.html#17039">[ thread ]</a>
              <a href="subject.html#17039">[ subject ]</a>
              <a href="author.html#17039">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/11/17 03:50, James Lay wrote:
&gt;<i> On Sun, 2017-11-26 at 09:50 +0200, Alex K wrote:
</I>&gt;&gt;<i> Perhaps an alternative is to peek only on step1:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> acl allowed_https_sites ssl::server_name_regex 
</I>&gt;&gt;<i> &quot;/opt/etc/squid/http_url.txt&quot;
</I>&gt;&gt;<i> ssl_bump splice allowed_https_sites
</I>&gt;&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>&gt;<i> Hrmm...wouldn't that negate the ability to read the cert on step2?
</I>&gt;<i> 
</I>
Yes it would.

&gt;<i> In layman's terms I'm thinking:
</I>&gt;<i> &quot;peek at step1&quot;
</I>&gt;<i> &quot;splice acl allow matched sni's&quot;
</I>&gt;<i> &quot;peek at step2&quot;
</I>&gt;<i> &quot;splice acl allow'd matched certs&quot;
</I>&gt;<i> &quot;terminate the rest&quot;
</I>&gt;<i> 
</I>&gt;<i> Would that work Amos?
</I>&gt;<i> 
</I>
This is essentially what I suggested at the beginning.

Placing splice action and your ACLs on the first ssl_bump line ensures 
that at each step if enough details are known to splice it will happen.

The second line being &quot;peek all&quot; make peek happen at every step for 
which it is possible (step 1 and step 2 - not step 3).

&quot;terminate all&quot; being last makes it happen for &quot;all the rest&quot;, aka step 
3 if Squid gets that far without splicing.


The only difference is that my suggested way would also allow splicing 
the CONNECT if it happens to be presented with a host name in the 
authority-URI. Which cannot happen on your proxy unless your port 3128 
happens to be intercepting traffic between clients and another proxy.


BTW please do not use port 3128 for intercept. It is officially 
registered for HTTP proxy traffic and so qualifies as &quot;well known&quot;.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017029.html">[squid-users] Working peek/splice no longer functioning on some sites
</A></li>
	<LI>Next message (by thread): <A HREF="017027.html">[squid-users] filtering HTTPS sites with transparent child Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17039">[ date ]</a>
              <a href="thread.html#17039">[ thread ]</a>
              <a href="subject.html#17039">[ subject ]</a>
              <a href="author.html#17039">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
