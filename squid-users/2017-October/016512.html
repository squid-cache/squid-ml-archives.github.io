<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump Failures with Google and Wikipedia	[SOLVED]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Failures%20with%20Google%20and%20Wikipedia%0A%09%5BSOLVED%5D&In-Reply-To=%3CCA%2BekxPUfSwf4mgMwYaEsmR4-vO5jSq4dF%2BRX7nYujrk9V5BVPw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016536.html">
   <LINK REL="Next"  HREF="016518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump Failures with Google and Wikipedia	[SOLVED]</H1>
    <B>Jeffrey Merkey</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Failures%20with%20Google%20and%20Wikipedia%0A%09%5BSOLVED%5D&In-Reply-To=%3CCA%2BekxPUfSwf4mgMwYaEsmR4-vO5jSq4dF%2BRX7nYujrk9V5BVPw%40mail.gmail.com%3E"
       TITLE="[squid-users] SSL Bump Failures with Google and Wikipedia	[SOLVED]">jeffmerkey at gmail.com
       </A><BR>
    <I>Sun Oct  1 03:12:08 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016536.html">[squid-users] Content injection
</A></li>
        <LI>Next message (by thread): <A HREF="016518.html">[squid-users] SSL Bump Failures with Google and Wikipedia	[SOLVED]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16512">[ date ]</a>
              <a href="thread.html#16512">[ thread ]</a>
              <a href="subject.html#16512">[ subject ]</a>
              <a href="author.html#16512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/30/17, Rafael Akchurin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt; wrote:
&gt;<i> Hello Jeff,
</I>&gt;<i>
</I>&gt;<i> Do not forget Google and YouTube are now using brotli encoding extensively,
</I>&gt;<i> not only gzip.
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i>
</I>&gt;&gt;<i> Op 30 sep. 2017 om 23:49 heeft Jeffrey Merkey &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jeffmerkey at gmail.com</A>&gt; het
</I>&gt;&gt;<i> volgende geschreven:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 9/30/17, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> Hey Jeffrey,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What happens when you disable the next icap service this way:
</I>&gt;&gt;&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/cherokee">icap://127.0.0.1:1344/cherokee</A> bypass=0
</I>&gt;&gt;&gt;<i> adaptation_access service_avi_resp deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is it still the same?
</I>&gt;&gt;&gt;<i> What I suspect is that the requests are defined to accept gzip
</I>&gt;&gt;&gt;<i> compressed
</I>&gt;&gt;&gt;<i> objects and the icap service is not &quot;gnuzip&quot; them which results in what
</I>&gt;&gt;&gt;<i> you
</I>&gt;&gt;&gt;<i> see.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> To make sure that squid is not at fault here try to disable both icap
</I>&gt;&gt;&gt;<i> services and then add then one at a time and see which of this triangle
</I>&gt;&gt;&gt;<i> is
</I>&gt;&gt;&gt;<i> giving you trouble.
</I>&gt;&gt;&gt;<i> I enhanced an ICAP library which is written in GoLang at:
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/elico/icap">https://github.com/elico/icap</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And I have couple examples on how to work with http requests and
</I>&gt;&gt;&gt;<i> responses
</I>&gt;&gt;&gt;<i> at:
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/andybalholm/redwood/">https://github.com/andybalholm/redwood/</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/andybalholm/redwood/search?utf8=%E2%9C%93&amp;q=gzip&amp;type=">https://github.com/andybalholm/redwood/search?utf8=%E2%9C%93&amp;q=gzip&amp;type=</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Let me know if you need help finding out the issue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> All The Bests,
</I>&gt;&gt;&gt;<i> Eliezer
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ----
</I>&gt;&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;&gt;<i> Linux System Administrator
</I>&gt;&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;&gt;&gt;<i> Behalf Of Jeffrey Merkey
</I>&gt;&gt;&gt;<i> Sent: Saturday, September 30, 2017 23:28
</I>&gt;&gt;&gt;<i> To: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i> Subject: [squid-users] SSL Bump Failures with Google and Wikipedia
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hello All,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have been working with the squid server and icap and I have been
</I>&gt;&gt;&gt;<i> running into problems with content cached from google and wikipedia.
</I>&gt;&gt;&gt;<i> Some sites using https, such as Centos.org work perfectly with ssl
</I>&gt;&gt;&gt;<i> bumping and I get the decrypted content as html and it's readable.
</I>&gt;&gt;&gt;<i> Other sites, such as google and wikipedia return what looks like
</I>&gt;&gt;&gt;<i> encrypted traffic, or perhaps mime encoded data, I am not sure which.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Are there cases where squid will default to direct mode and not
</I>&gt;&gt;&gt;<i> decrypt the traffic?  I am using the latest squid server 3.5.27.  I
</I>&gt;&gt;&gt;<i> really would like to get this working with google and wikipedia.  I
</I>&gt;&gt;&gt;<i> reviewed the page source code from the browser viewer and it looks
</I>&gt;&gt;&gt;<i> nothing like the data I am getting via the icap server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any assistance would be greatly appreciated.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The config I am using is:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> # Recommended minimum configuration:
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;&gt;&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;&gt;&gt;<i> # should be allowed
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl localnet src 127.0.0.1
</I>&gt;&gt;&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;&gt;&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;&gt;&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;&gt;&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;&gt;&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly
</I>&gt;&gt;&gt;<i> plugged) machines
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;&gt;&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;&gt;&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;&gt;&gt;<i> #http_access deny to_localhost
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;&gt;&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;&gt;&gt;<i> # from where browsing should be allowed
</I>&gt;&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # And finally deny all other access to this proxy
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Squid normally listens to port 3128
</I>&gt;&gt;&gt;<i> #http_port 3128
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;&gt;&gt;<i> #cache_dir ufs /usr/local/squid/var/cache/squid 100 16 256
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;&gt;&gt;<i> coredump_dir /usr/local/squid/var/cache/squid
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;&gt;&gt;<i> #
</I>&gt;&gt;&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;&gt;&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;&gt;&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;&gt;&gt;<i> http_port 3129
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # SSL Bump Config
</I>&gt;&gt;&gt;<i> always_direct allow all
</I>&gt;&gt;&gt;<i> ssl_bump server-first all
</I>&gt;&gt;&gt;<i> sslproxy_cert_error deny all
</I>&gt;&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db
</I>&gt;&gt;&gt;<i> -M 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # For squid 3.5.x
</I>&gt;&gt;&gt;<i> #sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M
</I>&gt;&gt;&gt;<i> 4MB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # For squid 4.x
</I>&gt;&gt;&gt;<i> # sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
</I>&gt;&gt;&gt;<i> /var/lib/ssl_db -M 4MB
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_enable on
</I>&gt;&gt;&gt;<i> icap_send_client_ip on
</I>&gt;&gt;&gt;<i> icap_send_client_username on
</I>&gt;&gt;&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;&gt;<i> icap_preview_size 1024
</I>&gt;&gt;&gt;<i> icap_service service_avi_req reqmod_precache
</I>&gt;&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/request">icap://127.0.0.1:1344/request</A>
</I>&gt;&gt;&gt;<i> bypass=1
</I>&gt;&gt;&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/cherokee">icap://127.0.0.1:1344/cherokee</A> bypass=0
</I>&gt;&gt;&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Jeff
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, you certainly hit the nail on the head.  I added the following
</I>&gt;&gt;<i> code to check the content being sent to the icap server from squid,
</I>&gt;&gt;<i> and here is what I found when I check the headers being sent from the
</I>&gt;&gt;<i> remote web server:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Code to check for content type and encoding received by the icap
</I>&gt;&gt;<i> server added to c-icap:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    hdrs = ci_http_response_headers(req);
</I>&gt;&gt;<i>    content_type = ci_headers_value(hdrs, &quot;Content-Type&quot;);
</I>&gt;&gt;<i>    if (content_type)
</I>&gt;&gt;<i>       ci_debug_printf(1,&quot;srv_cherokee:  content-type: %s\n&quot;,
</I>&gt;&gt;<i>                       content_type);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    content_encoding = ci_headers_value(hdrs, &quot;Content-Encoding&quot;);
</I>&gt;&gt;<i>    if (content_encoding)
</I>&gt;&gt;<i>       ci_debug_printf(1,&quot;srv_cherokee:  content-encoding: %s\n&quot;,
</I>&gt;&gt;<i>                       content_encoding);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And the output from scanned pages sent over from squid:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> srv_cherokee:  init request 0x7f3dbc008eb0
</I>&gt;&gt;<i> pool hits:1 allocations: 1
</I>&gt;&gt;<i> Allocating from objects pool object 5
</I>&gt;&gt;<i> pool hits:1 allocations: 1
</I>&gt;&gt;<i> Geting buffer from pool 4096:1
</I>&gt;&gt;<i> Requested service: cherokee
</I>&gt;&gt;<i> Read preview data if there are and process request
</I>&gt;&gt;<i> srv_cherokee:  content-type: text/html; charset=utf-8
</I>&gt;&gt;<i> srv_cherokee:  content-encoding: gzip         &lt;-- As you stated, I am
</I>&gt;&gt;<i> getting gzipped data
</I>&gt;&gt;<i> srv_cherokee:  we expect to read :-1 body data
</I>&gt;&gt;<i> Allow 204...
</I>&gt;&gt;<i> Preview handler return allow 204 response
</I>&gt;&gt;<i> srv_cherokee:  release request 0x7f3dbc008eb0
</I>&gt;&gt;<i> Store buffer to long pool 4096:1
</I>&gt;&gt;<i> Storing to objects pool object 5
</I>&gt;&gt;<i> Log request to access log file /var/log/i-cap_access.log
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Wikipedia  at <A HREF="https://en.wikipedia.org/wiki/HTTP_compression">https://en.wikipedia.org/wiki/HTTP_compression</A> describes
</I>&gt;&gt;<i> the process as:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot; ...
</I>&gt;&gt;<i>   Compression scheme negotiation[edit]
</I>&gt;&gt;<i>   In most cases, excluding the SDCH, the negotiation is done in two
</I>&gt;&gt;<i> steps, described in
</I>&gt;&gt;<i>   RFC 2616:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   1. The web client advertises which compression schemes it supports
</I>&gt;&gt;<i> by including a list
</I>&gt;&gt;<i>   of tokens in the HTTP request. For Content-Encoding, the list in a
</I>&gt;&gt;<i> field called Accept -
</I>&gt;&gt;<i>   Encoding; for Transfer-Encoding, the field is called TE.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   GET /encrypted-area HTTP/1.1
</I>&gt;&gt;<i>   Host: www.example.com
</I>&gt;&gt;<i>   Accept-Encoding: gzip, deflate
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   2. If the server supports one or more compression schemes, the
</I>&gt;&gt;<i> outgoing data may be
</I>&gt;&gt;<i>   compressed by one or more methods supported by both parties. If
</I>&gt;&gt;<i> this is the case, the
</I>&gt;&gt;<i>   server will add a Content-Encoding or Transfer-Encoding field in
</I>&gt;&gt;<i> the HTTP response with
</I>&gt;&gt;<i>   the used schemes, separated by commas.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   HTTP/1.1 200 OK
</I>&gt;&gt;<i>   Date: mon, 26 June 2016 22:38:34 GMT
</I>&gt;&gt;<i>   Server: Apache/1.3.3.7 (Unix)  (Red-Hat/Linux)
</I>&gt;&gt;<i>   Last-Modified: Wed, 08 Jan 2003 23:11:55 GMT
</I>&gt;&gt;<i>   Accept-Ranges: bytes
</I>&gt;&gt;<i>   Content-Length: 438
</I>&gt;&gt;<i>   Connection: close
</I>&gt;&gt;<i>   Content-Type: text/html; charset=UTF-8
</I>&gt;&gt;<i>   Content-Encoding: gzip
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   The web server is by no means obligated to use any compression method &#8211;
</I>&gt;&gt;<i> this
</I>&gt;&gt;<i>   depends on the internal settings of the web server and also may
</I>&gt;&gt;<i> depend on the internal
</I>&gt;&gt;<i>   architecture of the website in question.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   In case of SDCH a dictionary negotiation is also required, which
</I>&gt;&gt;<i> may involve additional
</I>&gt;&gt;<i>   steps, like downloading a proper dictionary from .
</I>&gt;&gt;<i> ..&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, it looks like it is a feature of the browser.  So, is it possible
</I>&gt;&gt;<i> to have squid gunzip the data or configure the browser not to send the
</I>&gt;&gt;<i> header  to remove &quot;Accept-Encoding: gzip, deflate&quot; from the request
</I>&gt;&gt;<i> sent to the remote server telling it to gzip the data?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jeff
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
Well,

After reviewing this problem and all of the great technical
information folks provided, I have it working and I figured out the
best way to deal with this transparently allowing squid to remotely
spoof the server side with modified request headers.

Compile squid with the flags:

--enable-http-violation

then add the following to the squid.conf file:

# disable remote html data compression by replacing HTTP request headers
# requires squid build option --enable-http-violations
request_header_access Accept-Encoding deny all
request_header_replace Accept-Encoding *;q=0

Then tell squid to strip all Accept-Encoding request headers and
substitute the string &quot; *;q=0 &quot; which tells the server not to send any
compressed data.  I tested this with chrome which was configured to
always send Acccept-Encoding:gzip,deflate and all of the C-ICAP data I
am seeing is plain text html, which is what I wanted.

So adding those two header instructions transparently spoofs the
remote server into always sending uncompressed data.  I did note that
google has some nonsense going on with chrome (mozilla does not do
this) so that even if chrome request headers have been spoofed by
squid specifying no gzip or deflate, the google servers will still
send a content-encoding:gzip response header on any responses which do
not contain any data (???), which is clearly a bug of some sort on
HTTP responses .

The browser treats the data as plain text and works correctly, even
though it gets a content-encoding:gzip header.  It only seems to do
this on HTTP header only payload request/responses which have no body
text.   Responses which actually contain body data are missing the
content-encoding header, which is what I wanted to see happen.

So to summarize, the above changes will enable squid to filter and
spoof Accept-Encoding: HTTP requests to tell the server to always send
uncompressed data, and from my testing it works transparently on
Chrome and Mozilla, with C-ICAP getting the uncompressed, unencrypted
data it needs.

Jeff

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016536.html">[squid-users] Content injection
</A></li>
	<LI>Next message (by thread): <A HREF="016518.html">[squid-users] SSL Bump Failures with Google and Wikipedia	[SOLVED]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16512">[ date ]</a>
              <a href="thread.html#16512">[ thread ]</a>
              <a href="subject.html#16512">[ subject ]</a>
              <a href="author.html#16512">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
