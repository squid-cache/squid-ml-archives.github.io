<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IP_FREEBIND or IP_TRANSPARENT support?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IP_FREEBIND%20or%20IP_TRANSPARENT%20support%3F&In-Reply-To=%3C076801d33bf1%249b74b330%24d25e1990%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016546.html">
   <LINK REL="Next"  HREF="016540.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IP_FREEBIND or IP_TRANSPARENT support?</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IP_FREEBIND%20or%20IP_TRANSPARENT%20support%3F&In-Reply-To=%3C076801d33bf1%249b74b330%24d25e1990%24%40ngtech.co.il%3E"
       TITLE="[squid-users] IP_FREEBIND or IP_TRANSPARENT support?">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Oct  3 02:45:00 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016546.html">[squid-users] IP_FREEBIND or IP_TRANSPARENT support?
</A></li>
        <LI>Next message (by thread): <A HREF="016540.html">[squid-users] squid and kernel options
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16547">[ date ]</a>
              <a href="thread.html#16547">[ thread ]</a>
              <a href="subject.html#16547">[ subject ]</a>
              <a href="author.html#16547">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have just started reading the SF post the 10 time.
I really didn&#8217;t understood what was the requirement and what or why the FREEBIND was offered.

And Amos, in intercept\transparent mode there is no way to select the outgoing addresses but not for a tproxy setup.
Also I do not think that squid should handle a /64 for outgoing traffic based on non-automated\non-coded solution.

If tproxy does the job then why use a specific outgoing ip?
If it's for NAT then I can offer a &quot;simple&quot; solution to this whole thing but it involves haproxy proxy protocol.

We can use a tproxy listener\proxy\loadbalancer that will forward a &quot;src&quot; and a &quot;destination&quot; ip:port pair into a proxy protocol aware port.
Then the proxy aware protocol port will open a tproxy connection based on the source IP and whatever destination it will choose based on regular squid logic.
The LB proxy can loadbalance traffic over several &quot;http_port ip:port ...options&quot; to avoid the limit of ip::port-&gt;ip:port on lo.
The example would be something like:
http_port 127.0.0.2:13128 
http_port 127.0.0.3:13128
http_port 127.0.0.4:13128
...

And the LB proxy will bind automatically(the OS choice..) the right ip:port that will be used for the connection between the LB proxy to the squid ip:port.

It will require from squid to support two things:
- To be able to parse and interpret PROXY protocol V2
- To be able to spoof the outgoing ip address using tproxy based on the PROXY protocol V2 supplied source address

What do you think Amos?
If there is some interest in such a thing then it would be pretty simple to craft.

Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Amos Jeffries
Sent: Tuesday, October 3, 2017 05:19
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] IP_FREEBIND or IP_TRANSPARENT support?

On 03/10/17 07:44, xpro6000 wrote:
&gt;<i> If one were to assign a whole /64 block of IPv6 IPs to a NIC on Linux 
</I>&gt;<i> then they would use the &quot;ip route add local&quot; method instead of adding 
</I>&gt;<i> each IP in the /etc/network/interfaces file.
</I>&gt;<i> 
</I>&gt;<i>  From the testing I have done the IPs that were assigned with the &quot;ip 
</I>&gt;<i> route add local&quot; don't work with Squid and the main reason for this is 
</I>&gt;<i> because Squid does not use IP_FREEBIND or IP_TRANSPARENT option on the 
</I>&gt;<i> socket connection.
</I>

Any machine can be setup to *route* traffic (ip route add ...). That is 
a very different proposition to assigning those IPs as belonging to that 
machine (ip addr add ...).

IP_TRANSPARENT is the spoofing part of the TPROXYv4 feature and is used 
by Squid when TPROXY is setup.


&gt;<i> 
</I>&gt;<i> You can read more about it here
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://serverfault.com/a/591435/141509">https://serverfault.com/a/591435/141509</A>
</I>&gt;<i> 
</I>
That whole SF entry is all kinds of mixed up. It is basically saying 
that to &quot;assign a whole range&quot; one has to *spoof* the IPs in that range. 
Which is a very wrong thing to do.

The list of 'ip addr add' settings in the original interfaces file is 
correct for what the person was wanting (and you?), though I'm not sure 
if there is another place to do them. I do the same but in a trigger 
script called from the interfaces file instead of listing them all in 
that file directly.

&gt;<i> 
</I>&gt;<i> Is there any option in the config file that enables this option?
</I>&gt;<i> 
</I>
Not for Squid.

Squid prefers the OS to select the IP which is used, though for a small 
number of IPs you can use tcp_outgoing_addr to tell the OS that any 
specific one of the set *assigned* to the machine should be used on 
server connections.

Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016546.html">[squid-users] IP_FREEBIND or IP_TRANSPARENT support?
</A></li>
	<LI>Next message (by thread): <A HREF="016540.html">[squid-users] squid and kernel options
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16547">[ date ]</a>
              <a href="thread.html#16547">[ thread ]</a>
              <a href="subject.html#16547">[ subject ]</a>
              <a href="author.html#16547">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
