<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20http_port%20intercept%3A%20squid%203.1.20%20VS%203.5.23.&In-Reply-To=%3C201710041341.41462.Antony.Stone%40squid.open.source.it%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016560.html">
   <LINK REL="Next"  HREF="016562.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.</H1>
    <B>Antony Stone</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20http_port%20intercept%3A%20squid%203.1.20%20VS%203.5.23.&In-Reply-To=%3C201710041341.41462.Antony.Stone%40squid.open.source.it%3E"
       TITLE="[squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.">Antony.Stone at squid.open.source.it
       </A><BR>
    <I>Wed Oct  4 11:41:41 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016560.html">[squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.
</A></li>
        <LI>Next message (by thread): <A HREF="016562.html">[squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16561">[ date ]</a>
              <a href="thread.html#16561">[ thread ]</a>
              <a href="subject.html#16561">[ subject ]</a>
              <a href="author.html#16561">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday 04 October 2017 at 13:30:52, Thomas Martin wrote:

&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm having trouble to make Squid 3.5.23 work like Squid 3.1.20 does.
</I>&gt;<i> 
</I>&gt;<i> Here is my setup:
</I>&gt;<i>   &lt;clients&gt;     |                  &lt;router&gt;                      |
</I>&gt;<i> &lt;squid proxy&gt;
</I>&gt;<i> 10.0.0.Y/24    | 10.0.0.254/24 &lt;-&gt; 10.100.0.254/24 |   10.100.0.100/24
</I>
&gt;<i> - &lt;router&gt; is:
</I>&gt;<i> -- obviously forwarding packets,
</I>&gt;<i> -- owning the ADSL,
</I>&gt;<i> -- doing the transparent redirection of &lt;clients&gt; to &lt;squid proxy&gt; using
</I>&gt;<i> NAT: -A PREROUTING -s 10.100.0.100 -i dmz -p tcp -m state --state NEW -m
</I>&gt;<i> tcp --dport 80 -j ACCEPT
</I>&gt;<i> -A PREROUTING -s 10.0.0.Y/32 -p tcp -m state --state NEW -m tcp
</I>&gt;<i> --dport 80 -j DNAT --to-destination 10.100.0.100:3128
</I>
That's your problem.

You're no longer allowed to do the DNAT (or REDIRECT) on anything other than 
the machine running Squid itself.

See <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A> and 
note the emphasis &quot;This configuration is given for use on the squid box.&quot;

See <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute">https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute</A> 
for how to get the packets correctly from the router to the separate Squid 
server.

In summary, you need to do policy routing (or any other method at your 
disposal) to get the packets from the clients to be sent to the Squid server 
*without* changing their destination address (so, DNAT isn't allowed), and 
then on the Squid server you use REDIRECT to send them to the Squid listening 
socket.


Regards,

Antony.

-- 
<A HREF="https://tools.ietf.org/html/rfc6890">https://tools.ietf.org/html/rfc6890</A> - providing 16 million IPv4 addresses for 
talking to yourself.

                                                   Please reply to the list;
                                                         please *don't* CC me.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016560.html">[squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.
</A></li>
	<LI>Next message (by thread): <A HREF="016562.html">[squid-users] http_port intercept: squid 3.1.20 VS 3.5.23.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16561">[ date ]</a>
              <a href="thread.html#16561">[ thread ]</a>
              <a href="subject.html#16561">[ subject ]</a>
              <a href="author.html#16561">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
