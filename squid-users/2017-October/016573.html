<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Pages sometimes load as a mess of random (?) symbols
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Pages%20sometimes%20load%20as%20a%20mess%20of%20random%20%28%3F%29%0A%20symbols&In-Reply-To=%3Cb289ed33-cd21-23b6-132a-79123716d2f8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016572.html">
   <LINK REL="Next"  HREF="016576.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Pages sometimes load as a mess of random (?) symbols</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Pages%20sometimes%20load%20as%20a%20mess%20of%20random%20%28%3F%29%0A%20symbols&In-Reply-To=%3Cb289ed33-cd21-23b6-132a-79123716d2f8%40treenet.co.nz%3E"
       TITLE="[squid-users] Pages sometimes load as a mess of random (?) symbols">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct  5 07:39:02 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016572.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
        <LI>Next message (by thread): <A HREF="016576.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16573">[ date ]</a>
              <a href="thread.html#16573">[ thread ]</a>
              <a href="subject.html#16573">[ subject ]</a>
              <a href="author.html#16573">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/10/17 19:42, Grey wrote:
&gt;<i> Sorry for not including enough informatio nin the first place.
</I>&gt;<i> 
</I>&gt;<i> 1. Here's my config, keep in mind it's a test server that will eventually
</I>&gt;<i> replace the one (not updated) we're using right now so the configuration is
</I>&gt;<i> kinda bare-bones:
</I>&gt;<i> 
</I>&gt;<i> ### TESTSQUID1 ###
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> pinger_enable off
</I>&gt;<i> netdb_filename none
</I>&gt;<i> 
</I>&gt;<i> error_default_language it
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">helpdesk at test.it</A>
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -r -d
</I>&gt;<i> auth_param negotiate children 150
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> 
</I>&gt;<i> external_acl_type ProxyUser children-max=75 %LOGIN
</I>&gt;<i> /usr/lib/squid/ext_kerberos_ldap_group_acl -g <A HREF="https://lists.squid-cache.org/listinfo/squid-users">INTERNET at TEST.LOCAL</A> -D
</I>&gt;<i> TEST.LOCAL -S testldap
</I>&gt;<i> acl ProxyUser external ProxyUser
</I>&gt;<i> 
</I>&gt;<i> acl AUTH proxy_auth REQUIRED
</I>&gt;<i> http_access deny !AUTH all
</I>
So two problems.
1) 'all' here means clients with incorrect OR missing auth credentials 
do not get challenged for working credentials. Since any sane client 
security system will not present credentials until told they are 
necessary the above should rightfully prevent *any* secure clients from 
using this proxy.

2) your custom config lines should be placed below the default security 
settings. This is especially important for ACLs like auth which involve 
a lot of background work. The default settings are there to block things 
like DoS or attacks that can be trivially and quickly denied, and to do 
so with minimal CPU expense.

&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports all
</I>&gt;<i> http_access deny CONNECT !SSL_ports all
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager all
</I>&gt;<i> http_access allow localhost all
</I>
If you place the &quot;allow localhost&quot; above the &quot;deny manager&quot; you can 
remove one extra line of checks.

&gt;<i> 
</I>&gt;<i> acl destsquid dstdomain .testquid1 .testsquid2
</I>&gt;<i> http_access allow destsquid all
</I>
The 'all' ACL is a pointless waste of CPU cycles on all of the lines above.

&gt;<i> 
</I>&gt;<i> http_access allow ProxyUser all
</I>The 'all' ACL here *might* prevent unauthenticated clients from being 
challenged for credentials like the 'deny !AUTH' line did. But YMMV. It 
either does that or is pointless.

The current 3.5 provides the %un format code which should not generate 
an auth challenge. That should eliminate the need for the all-hack here.


&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_send_client_username on
</I>&gt;<i> icap_client_username_encode off
</I>&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i> icap_service service_req reqmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://testicap:1344/REQ-Service">icap://testicap:1344/REQ-Service</A>
</I>&gt;<i> adaptation_access service_req allow all
</I>&gt;<i> icap_service service_resp respmod_precache bypass=0
</I>&gt;<i> <A HREF="icap://testicap:1344/resp">icap://testicap:1344/resp</A>
</I>&gt;<i> adaptation_access service_resp allow all
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> 2. This is the access log when first loading the page:
</I>&gt;<i> 
</I>&gt;<i> 1507185342.611      0 99.99.99.99 TCP_DENIED/407 5179 GET
</I>&gt;<i> <A HREF="http://www.tomshardware.com/">http://www.tomshardware.com/</A> - HIER_NONE/- text/html
</I>&gt;<i> 1507185344.121   1473 99.99.99.99 TCP_MISS/200 48225 GET
</I>&gt;<i> <A HREF="http://www.tomshardware.com/">http://www.tomshardware.com/</A> testuser HIER_DIRECT/23.40.112.227 text/html
</I>&gt;<i> 
</I>&gt;<i> And this is the one after reloading:
</I>&gt;<i> 
</I>
By &quot;reloading&quot; do you mean:

  * using a testing tool that sends an identical repeat request? or
  * clicking + pressing enter in a browser address bar? or
  * pressing the browser reload button? or
  * pressing the force-refresh (F5) button? or
  * holding shift while doing any of the above?

Only the first two above methods will perform a clean HTTP test request. 
The others all deliver cache controls to force specific cache behaviour 
which void the test results.


&gt;<i> 1507185356.932    187 99.99.99.99 TCP_MISS/200 47858 GET
</I>&gt;<i> <A HREF="http://www.tomshardware.com/">http://www.tomshardware.com/</A> testuser HIER_DIRECT/23.40.112.227 text/html
</I>&gt;<i> 1507185357.425      0 99.99.99.99 TCP_DENIED/407 4440 GET
</I>&gt;<i> <A HREF="http://platform.twitter.com/widgets.js">http://platform.twitter.com/widgets.js</A> - HIER_NONE/- text/html
</I>&gt;<i> 1507185357.482     13 99.99.99.99 TCP_MISS/200 2019 GET
</I>&gt;<i> <A HREF="http://www.tomshardware.com/medias/favicon/favicon-32x32.png?">http://www.tomshardware.com/medias/favicon/favicon-32x32.png?</A> testuser
</I>&gt;<i> HIER_DIRECT/23.40.112.227 image/png
</I>&gt;<i> 1507185357.548     61 99.99.99.99 TCP_REFRESH_UNMODIFIED/304 516 GET
</I>&gt;<i> <A HREF="http://platform.twitter.com/widgets.js">http://platform.twitter.com/widgets.js</A> testuser HIER_DIRECT/199.96.57.6 -
</I>&gt;<i> 1507185357.565      0 99.99.99.99 TCP_DENIED/407 4178 CONNECT
</I>&gt;<i> www.tomshardware.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1507185357.924      0 99.99.99.99 TCP_DENIED/407 4190 CONNECT
</I>&gt;<i> syndication.twitter.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> 3. The result of the test at redbot
</I>&gt;<i> (<A HREF="https://redbot.org/?uri=http%3A%2F%2Fwww.tomshardware.com%2F">https://redbot.org/?uri=http%3A%2F%2Fwww.tomshardware.com%2F</A> if you want to
</I>&gt;<i> check it yourself) is:
</I>&gt;<i> 
</I>&gt;<i> General
</I>&gt;<i> The Pragma header is deprecated.
</I>&gt;<i> The Content-Length header is correct.
</I>&gt;<i> Content Negotiation (Content Negotiation response )
</I>&gt;<i> The resource doesn't send Vary consistently.
</I>
  ^^ this one is what I meant. There are several side effects of this - 
mostly just annoying MISS behaviours, but sometimes the wrong 
content-type can end up being associated with a cached object and things 
appear as you described the problem

Also, IIRC NginX (which appears to be the server for that site) was 
known to have several bugs that led to these types of broken 
content-type behaviour some years back. I'm not sure if that ever got fixed.


&gt;<i> The response body is different when content negotiation happens.
</I>&gt;<i> Content negotiation for gzip compression is supported, saving 86%.
</I>&gt;<i> Caching
</I>&gt;<i> Pragma: no-cache is a request directive, not a response directive.
</I>&gt;<i> This response can't be stored by a cache.
</I>&gt;<i> 
</I>&gt;<i> So it indeed seems that this could be the problem, right? Anything I can do
</I>&gt;<i> on my end to resolve/mitigate it?
</I>

I see that the server is already sending out &quot;Cache-Control: no-store&quot; 
so the problem is not your Squid but something upstream. Just make sure 
you do not override that no-store for these sites and your proxy will 
continue not to be adding problems.

It may be the ICAP service mangling the response type from gzip to 
text/plain incorrectly (ie without actually unzipping), or removing the 
relevant cache-controls.

Or equally likely; a proxy upstream force-caching, thus making itself 
*and* yours run afoul of the Vary issue. This is where I suspect the 
NginX or some hidden intermediary.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016572.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
	<LI>Next message (by thread): <A HREF="016576.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16573">[ date ]</a>
              <a href="thread.html#16573">[ thread ]</a>
              <a href="subject.html#16573">[ subject ]</a>
              <a href="author.html#16573">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
