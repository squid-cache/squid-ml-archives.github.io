<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Enable tproxy in Squid 3.5 running on Debian 9
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Enable%20tproxy%20in%20Squid%203.5%20running%20on%20Debian%209&In-Reply-To=%3Cbc173936-0f34-aec9-e3fb-28ffacb6fe4a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016571.html">
   <LINK REL="Next"  HREF="016580.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Enable tproxy in Squid 3.5 running on Debian 9</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Enable%20tproxy%20in%20Squid%203.5%20running%20on%20Debian%209&In-Reply-To=%3Cbc173936-0f34-aec9-e3fb-28ffacb6fe4a%40treenet.co.nz%3E"
       TITLE="[squid-users] Enable tproxy in Squid 3.5 running on Debian 9">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct  5 07:49:20 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016571.html">[squid-users] Enable tproxy in Squid 3.5 running on Debian 9
</A></li>
        <LI>Next message (by thread): <A HREF="016580.html">[squid-users] Enable tproxy in Squid 3.5 running on Debian 9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16574">[ date ]</a>
              <a href="thread.html#16574">[ thread ]</a>
              <a href="subject.html#16574">[ subject ]</a>
              <a href="author.html#16574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/10/17 15:01, xpro6000 wrote:
&gt;<i> I'm trying to setup tproxy with Squid 3.5 for the purpose of having the 
</I>&gt;<i> same outgoing ip as the connecting ip. (I have thousands of IPs and I 
</I>&gt;<i> can not add them one by one)
</I>&gt;<i> 
</I>&gt;<i> I started with a fresh install of Debian 9, installed Squid by
</I>&gt;<i> 
</I>&gt;<i> apt install squid
</I>&gt;<i> 
</I>&gt;<i> then I added
</I>&gt;<i> 
</I>&gt;<i> http_port 3129 tproxy
</I>&gt;<i> 
</I>&gt;<i> to squid.conf
</I>&gt;<i> 
</I>&gt;<i> I then ran the following commands for iptables
</I>&gt;<i> 
</I>&gt;<i> iptables -t mangle -N DIVERT
</I>&gt;<i> iptables -t mangle -A DIVERT -j MARK --set-mark 1
</I>&gt;<i> iptables -t mangle -A DIVERT -j ACCEPT
</I>&gt;<i> 
</I>&gt;<i> iptables&#160; -t mangle -A PREROUTING -p tcp -m socket -j DIVERT
</I>&gt;<i> 
</I>&gt;<i> iptables&#160; -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY 
</I>&gt;<i> --tproxy-mark 0x1/0x1 --on-port 3129
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I can use the proxy with no problems on port 3128, but on Firefox I get 
</I>&gt;<i> a message &quot;The proxy server is refusing connections&quot; when I set the 
</I>&gt;<i> proxy to port 3129. Did I miss any steps or am I doing something wrong?
</I>
You missed the fact that TPROXY is an MITM operation. You *cannot* setup 
the browser to use the proxy directly to its tproxy port. You have to 
route the packets to the proxy machine without any explicit browser or 
client configuration.

Only the Squid machine bits (and thus behaviour) are different with 
TPROXY vs NAT interception.

...
&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow all
</I>
Do not do &quot;allow all&quot; like this. Setup the localnet ACL to your LAN 
range(s) properly and only allow those clients through the proxy.

Then you can use the recommended default:
  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports
  http_access allow localhost
  http_access deny manager
  http_access allow localnet
  http_access deny all

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016571.html">[squid-users] Enable tproxy in Squid 3.5 running on Debian 9
</A></li>
	<LI>Next message (by thread): <A HREF="016580.html">[squid-users] Enable tproxy in Squid 3.5 running on Debian 9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16574">[ date ]</a>
              <a href="thread.html#16574">[ thread ]</a>
              <a href="subject.html#16574">[ subject ]</a>
              <a href="author.html#16574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
