<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Enable tproxy in Squid 3.5 running on Debian 9
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Enable%20tproxy%20in%20Squid%203.5%20running%20on%20Debian%209&In-Reply-To=%3C067201d33e3a%24bc6b72e0%24354258a0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016582.html">
   <LINK REL="Next"  HREF="016575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Enable tproxy in Squid 3.5 running on Debian 9</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Enable%20tproxy%20in%20Squid%203.5%20running%20on%20Debian%209&In-Reply-To=%3C067201d33e3a%24bc6b72e0%24354258a0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Enable tproxy in Squid 3.5 running on Debian 9">eliezer at ngtech.co.il
       </A><BR>
    <I>Fri Oct  6 00:33:31 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016582.html">[squid-users] Enable tproxy in Squid 3.5 running on Debian 9
</A></li>
        <LI>Next message (by thread): <A HREF="016575.html">[squid-users] New Squid 3.5 reconfigure causes service down
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16584">[ date ]</a>
              <a href="thread.html#16584">[ thread ]</a>
              <a href="subject.html#16584">[ subject ]</a>
              <a href="author.html#16584">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

Can you clarify the network topology of your setup?
Also is squid another machine on lan and you are using another router or squid sits in the a DMZ?
Can you add ip addresses of:
- client machine
- squid
- router of this network?

Thanks,
Eliezer

----
<A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of xpro6000
Sent: Thursday, October 5, 2017 19:54
To: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Enable tproxy in Squid 3.5 running on Debian 9

I'm back to square one then, and it looks like there is no way to tell Squid to use the same connecting ip for the outgoing ip, which is what I need.

On Thu, Oct 5, 2017 at 3:49 AM, Amos Jeffries &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
On 05/10/17 15:01, xpro6000 wrote:
I'm trying to setup tproxy with Squid 3.5 for the purpose of having the same outgoing ip as the connecting ip. (I have thousands of IPs and I can not add them one by one)

I started with a fresh install of Debian 9, installed Squid by

apt install squid

then I added

http_port 3129 tproxy

to squid.conf

I then ran the following commands for iptables

iptables -t mangle -N DIVERT
iptables -t mangle -A DIVERT -j MARK --set-mark 1
iptables -t mangle -A DIVERT -j ACCEPT

iptables  -t mangle -A PREROUTING -p tcp -m socket -j DIVERT

iptables  -t mangle -A PREROUTING -p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129


I can use the proxy with no problems on port 3128, but on Firefox I get a message &quot;The proxy server is refusing connections&quot; when I set the proxy to port 3129. Did I miss any steps or am I doing something wrong?

You missed the fact that TPROXY is an MITM operation. You *cannot* setup the browser to use the proxy directly to its tproxy port. You have to route the packets to the proxy machine without any explicit browser or client configuration.

Only the Squid machine bits (and thus behaviour) are different with TPROXY vs NAT interception.

...
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localhost
http_access allow all

Do not do &quot;allow all&quot; like this. Setup the localnet ACL to your LAN range(s) properly and only allow those clients through the proxy.

Then you can use the recommended default:
 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports
 http_access allow localhost
 http_access deny manager
 http_access allow localnet
 http_access deny all

Amos
_______________________________________________
squid-users mailing list
mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016582.html">[squid-users] Enable tproxy in Squid 3.5 running on Debian 9
</A></li>
	<LI>Next message (by thread): <A HREF="016575.html">[squid-users] New Squid 3.5 reconfigure causes service down
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16584">[ date ]</a>
              <a href="thread.html#16584">[ thread ]</a>
              <a href="subject.html#16584">[ subject ]</a>
              <a href="author.html#16584">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
