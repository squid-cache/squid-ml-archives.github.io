<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Pages sometimes load as a mess of random (?) symbols
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Pages%20sometimes%20load%20as%20a%20mess%20of%20random%20%28%3F%29%0A%20symbols&In-Reply-To=%3C2cfb661e-28f2-1931-9890-f2e2f72f02f5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016576.html">
   <LINK REL="Next"  HREF="016597.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Pages sometimes load as a mess of random (?) symbols</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Pages%20sometimes%20load%20as%20a%20mess%20of%20random%20%28%3F%29%0A%20symbols&In-Reply-To=%3C2cfb661e-28f2-1931-9890-f2e2f72f02f5%40treenet.co.nz%3E"
       TITLE="[squid-users] Pages sometimes load as a mess of random (?) symbols">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct  6 07:12:18 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016576.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
        <LI>Next message (by thread): <A HREF="016597.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16590">[ date ]</a>
              <a href="thread.html#16590">[ thread ]</a>
              <a href="subject.html#16590">[ subject ]</a>
              <a href="author.html#16590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/10/17 22:32, Grey wrote:
&gt;<i> Firstly, thanks a lot for taking the time to check my configuration and
</I>&gt;<i> provide such detailed suggestions; I think I've followed all of them and
</I>&gt;<i> fixed the problems you pointed out.
</I>&gt;<i> We have a Windows domain and all those &quot;all&quot; directives where inherited from
</I>&gt;<i> our old proxy server (running Squid verson 3.1.20) and were used to let
</I>&gt;<i> domain users not receive any popups asking for credentials, while at the
</I>&gt;<i> same time presenting those credentials requests to non-domain users; if I'm
</I>&gt;<i> understanding your comments correctly I can safely remove them and get the
</I>&gt;<i> same result, am I right?
</I>
Most of the 'all' uses were pointless even in the old config. Only the 
ones on the lines with AUTH and ProxyUsers ACLs had any effect on popups.


As for your requirement;

If you think about it Squid has zero ways to identify on-domain vs 
off-domain users until *after* the user has logged in. Any on-domain 
user who sends invalid or no credentials is indistinguishable from a 
off-domain user sending invalid or no credentials.

So the config hack did not actually do what you were wanting in the 
first place. It just suppresses login challenges for *everybody* without 
credentials - as it was designed to do.


Popups are a feature of the client agent being used (aka Browser). The 
browser may choose to do it at any time for any reason, though the 
popular ones usually only do so if it cannot automatically locate any 
credentials to send in response to a challenge.

Whatever was working was due to some other behaviour which may change at 
any time regardless of the all hack use. Mostly likely by on-domain 
clients sending their credentials up front before any need was mentioned 
by the proxy.

FYI: The clients sending their users credentials without a challenge is 
*very bad* security practice since they will broadcast those credentials 
to anything they connect, not just your proxy.


&gt;<i> We were having an issue with authentication too, where domain users
</I>&gt;<i> sometimes received a popup asking for credentials (shouldn't happen since I
</I>&gt;<i> have only enabled kerberos auth) and would need to click &quot;Cancel&quot; and reload
</I>&gt;<i> the page to resume browsing correctly; could the presence of all those &quot;all&quot;
</I>&gt;<i> directives have caused that too in your opinion?
</I>

The all-hack was preventing Squid from telling the browser what it 
needed to login. So the popups themselves were caused by some other 
reason unrelated to Squid.

That said, the absence of proper instructions from Squid probably was 
involved with the horrible need to cancel and reload the page. The 
normal behaviour would have been either silent re-try with other 
automatic credentials or a popup that user could login with successfully.


FWIW: It is true that Kerberos tends to have popups less often than 
NTLM. But that is just a side-effect of Kerberos being far more 
efficient and less fragile than NTLM with its relatively static keytab 
value - the NTLM equivalent of keytab is generated fresh on every single 
TCP connection with a client connection to the DC, which takes up time 
and can be interfered with. So the chance of problems leading to a popup 
in Kerberos are far lower, but not gone completely.



&gt;<i> 
</I>&gt;<i> The new configuration should result in this if I didn't miss/misunderstand
</I>&gt;<i> anything (I've addedd a whitelist rule that I missed earlier):
</I>&gt;<i> 
</I>&gt;<i> ### TESTSQUID1 ###
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> pinger_enable off
</I>&gt;<i> netdb_filename none
</I>&gt;<i> 
</I>&gt;<i> error_default_language it
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">helpdesk at test.it</A>
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -r -d
</I>&gt;<i> auth_param negotiate children 150
</I>&gt;<i> auth_param negotiate children 150 startup=20 idle=10
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> 
</I>&gt;<i> external_acl_type ProxyUser children-max=75 %LOGIN
</I>&gt;<i> /usr/lib/squid/ext_kerberos_ldap_group_acl -g <A HREF="https://lists.squid-cache.org/listinfo/squid-users">INTERNET at TEST.LOCAL</A> -D
</I>&gt;<i> TEST.LOCAL -S testldap
</I>&gt;<i> acl ProxyUser external ProxyUser
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> acl destsquid dstdomain .testsquid1 .testsquid2
</I>&gt;<i> http_access allow destsquid
</I>&gt;<i> 
</I>&gt;<i> acl siti_whitelist dstdomain &quot;/etc/squid/siti_whitelist&quot;
</I>&gt;<i> 
</I>
It should be obvious, but just so that it is clearly stated:

Anything which is allowed or denied regardless of user auth (eg the 
whitelist?) should be done in an http_access line above the &quot;deny !AUTH&quot; 
line.


&gt;<i> acl AUTH proxy_auth REQUIRED
</I>&gt;<i> http_access deny !AUTH
</I>&gt;<i> 
</I>&gt;<i> http_access allow siti_whitelist
</I>&gt;<i> http_access allow ProxyUser
</I>
If you get unwanted popups after this config update, you can try adding 
the all-hack back onto the above line.

&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_send_client_username on
</I>&gt;<i> icap_client_username_encode off
</I>&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i> icap_service service_req reqmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://testicap:1344/REQ-Service">icap://testicap:1344/REQ-Service</A>
</I>&gt;<i> adaptation_access service_req allow all
</I>&gt;<i> icap_service service_resp respmod_precache bypass=0
</I>&gt;<i> <A HREF="icap://testicap:1344/resp">icap://testicap:1344/resp</A>
</I>&gt;<i> adaptation_access service_resp allow all
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> Getting back to the main problem, i've set &quot;icap_enable off&quot; and reloaded
</I>&gt;<i> Squid, then tried again and got the same problem; since we're not using any
</I>&gt;<i> cache parent and Squid isn't using ICAP at the moment, can I assume there's
</I>&gt;<i> nothing else I can do and just have to ignore the problem?
</I>&gt;<i> The thing that bugs me is that only Chrome seems to be having this
</I>&gt;<i> particular problem... could this even be something linked to a bug or a
</I>&gt;<i> simple behaviour difference between Chrome and IE/Firefox?
</I>&gt;<i> Thanks again for all your patience :)
</I>
There is one other thing you can do. That is to enable &quot;debug_options 
11,2&quot; for a while and run a test fetching with both browsers.

Squid-3.5 with that debug setting should log the HTTP request headers in 
their on-wire format so you can compare what is going on in both client 
and server connections for both browsers vs what the browsers think they 
received.

That might give you some clues about things to workaround it. Just make 
sure that workarounds are done as conservatively as possible so as not 
to break other sites in other annoying ways.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016576.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
	<LI>Next message (by thread): <A HREF="016597.html">[squid-users] Pages sometimes load as a mess of random (?)	symbols
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16590">[ date ]</a>
              <a href="thread.html#16590">[ thread ]</a>
              <a href="subject.html#16590">[ subject ]</a>
              <a href="author.html#16590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
