<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as Transparent Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20Transparent%20Proxy&In-Reply-To=%3Cbe171b91-0e47-3b2f-2464-bac77eba9df0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016606.html">
   <LINK REL="Next"  HREF="016611.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as Transparent Proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20Transparent%20Proxy&In-Reply-To=%3Cbe171b91-0e47-3b2f-2464-bac77eba9df0%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid as Transparent Proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct 10 11:26:47 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016606.html">[squid-users] Squid as Transparent Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="016611.html">[squid-users] Private root certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16607">[ date ]</a>
              <a href="thread.html#16607">[ thread ]</a>
              <a href="subject.html#16607">[ subject ]</a>
              <a href="author.html#16607">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/10/17 21:19, davide.motti wrote:
&gt;<i> Hi to everybody,
</I>&gt;<i> 
</I>&gt;<i> Last week I've set up Squid as transparent Proxy and everything seems to
</I>&gt;<i> work fine, it cache HTTP and HTTPS connections without any problem.
</I>&gt;<i> 
</I>&gt;<i> The only think that &quot;worries&quot; me is that if I put the &quot;intercept&quot; flag
</I>&gt;<i> on the http_port and on the https port I'm not able to connect to any
</I>&gt;<i> site, but if I put off the &quot;intercept&quot; flag the I connect to all sites
</I>&gt;<i> in transparent mode (no settings on the client's browser).
</I>
The configuration you have is not a &quot;transparent proxy&quot; unless you have 
the tproxy or intercept flags in squid.conf port lines. They are what 
tells Squid to do the MITM &quot;transparent&quot; things.

Also, you do not have any https_port in this config. So port 443 traffic 
cannot be received, no matter how it gets to Squid.

&gt;<i> 
</I>&gt;<i> So I'm running Squid-3.5.27 on Ubuntu Server 16.04 LTS and it was so
</I>&gt;<i> compiled:
</I>&gt;<i> 
</I>&gt;<i> ./configure --build=x86_64-linux-gnu --prefix=/usr --localstatedir=/var
</I>&gt;<i> --libexecdir=${prefix}/lib/squid --datadir=${prefix}/share/squid
</I>&gt;<i> --sysconfdir=/etc/squid --mandir=/usr/share/man
</I>&gt;<i> --with-swapdir=/var/spool/squid --with-default-user=proxy
</I>&gt;<i> --with-logdir=/var/log/squid --with-pidfile=/var/run/squid.pid
</I>&gt;<i> --with-open-ssl=/etc/ssl/openssl.cnf --with-filedescriptors=65536
</I>&gt;<i> --enable-ssl-crtd --enable-linux-netfilter.
</I>&gt;<i> 
</I>&gt;<i> The main squid.config file:
</I>&gt;<i> 
</I>&gt;<i> http_port
</I>&gt;<i> 3128
</I>&gt;<i> http_port 192.168.21.111:3129
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.21.111:13130 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myRCA.pem
</I>&gt;<i>                       
</I>&gt;<i>                       
</I>&gt;<i>                       
</I>&gt;<i> acl debian src 192.168.7.112
</I>&gt;<i> acl debian src fe80::a2ce:c8ff:fe1e:bfb8
</I>&gt;<i> acl localhost src 127.0.0.0/32
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 70
</I>&gt;<i> acl Safe_ports port 3128
</I>&gt;<i> acl Safe_ports port 3129
</I>&gt;<i> acl Safe_ports port 403
</I>&gt;<i> acl Safe_ports port 409
</I>&gt;<i> acl Safe_ports port 210
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 1025-65535
</I>&gt;<i> acl Safe_ports port 280
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 488
</I>&gt;<i> acl Safe_ports port 591
</I>&gt;<i> acl Safe_ports port 777
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> # HTTP ACCESS
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>                                                               
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access allow debian
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> visible_hostname 20150604-004.intern.modomoto.de
</I>&gt;<i>                                                                                    
</I>&gt;<i> 
</I>&gt;<i>                                                                                    
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i>                                                                                    
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> sslproxy_options ALL
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
The above 5 lines disable *all* security that TLS has to offer. Chances 
of your network being &quot; p0wned &quot; are quite high.

This is also possibly why the intercept *appears* to work.


&gt;<i> sslcrtd_program /lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 10
</I>&gt;<i> 
</I>&gt;<i> Squid iptables rules:
</I>&gt;<i> 
</I>&gt;<i> # Generated by iptables-save v1.6.0 on Mon Sep 25 09:34:12 2017
</I>&gt;<i> *mangle
</I>&gt;<i> 
</I>&gt;<i> :PREROUTING ACCEPT [41705:23328287]
</I>&gt;<i> :INPUT ACCEPT [40269:23242848]
</I>&gt;<i> :FORWARD ACCEPT [6:2262]
</I>&gt;<i> 
</I>&gt;<i> :OUTPUT ACCEPT [32950:6122247]
</I>&gt;<i> :POSTROUTING ACCEPT [33060:6138510]
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Mon Sep 25 09:34:12 2017
</I>&gt;<i> # Generated by iptables-save v1.6.0 on Mon Sep 25 09:34:12 2017
</I>&gt;<i> *nat
</I>&gt;<i> 
</I>&gt;<i> :PREROUTING ACCEPT [2731:496529]
</I>&gt;<i> :INPUT ACCEPT [1440:370186]
</I>&gt;<i> :OUTPUT ACCEPT [3278:202202]
</I>&gt;<i> :POSTROUTING ACCEPT [41:2041]
</I>&gt;<i> -A PREROUTING -s $CLIENT_IP -p tcp -m tcp --dport 80 -j DNAT
</I>&gt;<i> --to-destination
</I>&gt;<i>  &#160;$SQUID_IP:$HTTP_SQUID_PORT
</I>&gt;<i> 
</I>&gt;<i> -A PREROUTING -i $CLIENT_INTERF -p tcp -m tcp --dport 80 -j REDIRECT
</I>&gt;<i> --to-ports $HTTP_SQUID_PORT
</I>&gt;<i>                                                                                 
</I>&gt;<i> 
</I>&gt;<i> -A PREROUTING -s $SQUID_IP -p tcp -m tcp --dport 443 -j DNAT
</I>&gt;<i> --to-destination $SQUID_IP:$HTTPS_SQUID_PORT
</I>&gt;<i> -A PREROUTING -i $CLIENT_INTERF -p tcp -m tcp --dport 443 -j REDIRECT
</I>&gt;<i> --to-ports
</I>&gt;<i> $HTTP_CLIENT_PORT
</I>&gt;<i> 
</I>&gt;<i> -A POSTROUTING -o $CLIENT_INTERF -j MASQUERADE
</I>&gt;<i> 
</I>...


Why are you looping port 443 traffic outbound from Squid back into its 
receiving port?

And you have replaced most of the other important details with variable 
names. You have three HTTP ports (with various IPs) and zero HTTPS ports 
in squid.conf so its not even clear what these variables are referring 
to by name.

Please replace your iptables rules with the ones listed at 
&lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;

&gt;<i> 
</I>&gt;<i> My client act as his own router and his iptables rules are the followings:
</I>&gt;<i> 
</I>
REDIRECT/DNAT erases the destination IP Squid is connecting to when in 
&quot;transparent&quot; intercept mode. This is what you MUST NOT have any NAT 
between the client browser and Squid machine. Packets MUST be routed 
instead (possibly through a tunnel, but still routed).

&gt;<i> 
</I>&gt;<i> As I told the intercept mode works without the &quot;intercept flag&quot; on the
</I>&gt;<i> http_port directive: I would like just to know if it's normal or I miss
</I>&gt;<i> something in my config.
</I>&gt;<i> 
</I>
That is not normal, and not good at all. It hints that; a) the client is 
somehow sending proxy-format HTTP traffic over port 80/443 where only 
origin-format is permitted, or b) the proxy has been hacked to disable 
the CVE-2009-0801 hijacking protections.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016606.html">[squid-users] Squid as Transparent Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="016611.html">[squid-users] Private root certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16607">[ date ]</a>
              <a href="thread.html#16607">[ thread ]</a>
              <a href="subject.html#16607">[ subject ]</a>
              <a href="author.html#16607">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
