<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid not failing over to secondary DNS host
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20failing%20over%20to%20secondary%20DNS%20host&In-Reply-To=%3CCAEq3_te%2BixhoCwrTQEtxuqUuZfLHMTYwRWwUad%3D_Q1%2BxZbGOUg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016630.html">
   <LINK REL="Next"  HREF="016649.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid not failing over to secondary DNS host</H1>
    <B>Geoffrey</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20failing%20over%20to%20secondary%20DNS%20host&In-Reply-To=%3CCAEq3_te%2BixhoCwrTQEtxuqUuZfLHMTYwRWwUad%3D_Q1%2BxZbGOUg%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid not failing over to secondary DNS host">geoffmaha at gmail.com
       </A><BR>
    <I>Thu Oct 12 05:44:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016630.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
        <LI>Next message (by thread): <A HREF="016649.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16631">[ date ]</a>
              <a href="thread.html#16631">[ thread ]</a>
              <a href="subject.html#16631">[ subject ]</a>
              <a href="author.html#16631">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your reply Amos.

I just realised I left out some info in the original email that was
pertinent. :)


&gt;<i>How are you determining that exactly?
</I>&gt;<i> squid logs? DNS logs? firewall counters? packet traces?
</I>
Quite simply by trial and error and monitoring the results of taking
the 2 DNS/DCs offline/online, and using the cachemgr report.

EG. here is the report after I loaded one page and then took the
primary DNS offline, then continued to browse to two more pages. The
latter two pages did not load and the cachemgr report seems to verify
that squid is not using the secondary dns server at all (primary dns
server having 27 queries to 9 replies and the secondary getting none).


<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at websafetyv51</A>:~# squidclient mgr:idns
HTTP/1.1 200 OK
Server: squid/3.5.23
Mime-Version: 1.0
Date: Thu, 12 Oct 2017 05:30:12 GMT
Content-Type: text/plain;charset=utf-8
Expires: Thu, 12 Oct 2017 05:30:12 GMT
Last-Modified: Thu, 12 Oct 2017 05:30:12 GMT
X-Cache: MISS from websafetyv51.localdom.local
X-Cache-Lookup: MISS from websafetyv51.localdom.local:3128
Via: 1.1 websafetyv51.localdom.local (squid/3.5.23)
Connection: close

Internal DNS Statistics:

The Queue:
                       DELAY SINCE
  ID   SIZE SENDS FIRST SEND LAST SEND M FQDN
------ ---- ----- ---------- --------- - ----

DNS jumbo-grams: not working

Nameservers:
IP ADDRESS                                     # QUERIES # REPLIES Type
---------------------------------------------- --------- --------- --------
192.168.100.249                                      27         9 recurse
192.168.100.248                                       0         0 recurse

Rcode Matrix:
RCODE ATTEMPT1 ATTEMPT2 ATTEMPT3 PROBLEM
    0     1550        0        0 : Success
    1        0        0        0 : Packet Format Error
    2        0        0        0 : DNS Server Failure
    3        4        0        0 : Non-Existent Domain
    4        0        0        0 : Not Implemented
    5        0        0        0 : Query Refused
    6        0        0        0 : Name Exists when it should not
    7        0        0        0 : RR Set Exists when it should not
    8        0        0        0 : RR Set that should exist does not
    9        0        0        0 : Server Not Authoritative for zone
   10        0        0        0 : Name not contained in zone
   16        0        0        0 : Bad OPT Version or TSIG Signature Failure

Search list:
localdom.local


Squid version: Squid Object Cache: Version 3.5.23
Ubuntu server: &quot;Ubuntu 16.04.3 LTS&quot;

Cheers
Geoffrey



On 12 October 2017 at 15:53, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 12/10/17 15:04, Geoffrey wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hello folks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am finding that Squid will not use the secondary DNS if the first
</I>&gt;&gt;<i> one is taken offline. In this case the primary DNS is not able to
</I>&gt;&gt;<i> respond because I have taken it offline, and therefore the secondary
</I>&gt;&gt;<i> DNS should be queried by squid, but is not.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> How are you determining that exactly?
</I>&gt;<i>  squid logs? DNS logs? firewall counters? packet traces?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I have 2 Windows recursive DNS servers; 192.168.100.249 and
</I>&gt;&gt;<i> 192.168.100.248, that are statically specified in /etc/resolv.conf. I
</I>&gt;&gt;<i> am authenticating against AD using i) Kerberos and ii) NTLM.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This looks like it is a Squid internal dns client response rather than
</I>&gt;&gt;<i> operating system. While 192.168.100.249 is offline, all other queries
</I>&gt;&gt;<i> done by command-line queries work OK which indicates the system is
</I>&gt;&gt;<i> using the secondary DNS server fine&#8230; just not Squid!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What we want to happen of course is that if the primary
</I>&gt;&gt;<i> (192.168.100.249) is down or it cannot contact root DNS servers, then
</I>&gt;&gt;<i> it contacts the secondary nameserver specified on the LAN (as per the
</I>&gt;&gt;<i> configuration in resolv.conf) and resolves the name.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *Squid is SUCCESSFULLY reading resolv.conf as proved in cache.log after
</I>&gt;&gt;<i> reload
</I>&gt;&gt;<i> *Setting dns resolvers directly in the squid config file with
</I>&gt;&gt;<i> 'dns_nameservers' does not resolve the issue as the symptom is
</I>&gt;&gt;<i> identical
</I>&gt;&gt;<i> *modified squid dns timeouts to a low value (less than 10 secs) for
</I>&gt;&gt;<i> testing but made no difference
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Many thanks for any ideas you may have.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What does the cachemgr &quot;idns&quot; report say?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> command line:
</I>&gt;<i>   squidclient mgr:idns
</I>&gt;<i>
</I>&gt;<i> or URL:
</I>&gt;<i>   <A HREF="http://$(visible_hostname">http://$(visible_hostname</A>):3128/squid-internal-mgr/idns
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016630.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
	<LI>Next message (by thread): <A HREF="016649.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16631">[ date ]</a>
              <a href="thread.html#16631">[ thread ]</a>
              <a href="subject.html#16631">[ subject ]</a>
              <a href="author.html#16631">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
