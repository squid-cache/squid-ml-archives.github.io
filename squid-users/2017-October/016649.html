<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid not failing over to secondary DNS host
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20failing%20over%20to%20secondary%20DNS%20host&In-Reply-To=%3C9a596135-d65d-889c-bd6f-2c3b4a9b9007%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016631.html">
   <LINK REL="Next"  HREF="016660.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid not failing over to secondary DNS host</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20failing%20over%20to%20secondary%20DNS%20host&In-Reply-To=%3C9a596135-d65d-889c-bd6f-2c3b4a9b9007%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid not failing over to secondary DNS host">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Oct 14 09:47:38 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016631.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
        <LI>Next message (by thread): <A HREF="016660.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16649">[ date ]</a>
              <a href="thread.html#16649">[ thread ]</a>
              <a href="subject.html#16649">[ subject ]</a>
              <a href="author.html#16649">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/10/17 18:44, Geoffrey wrote:
&gt;<i> Thanks for your reply Amos.
</I>&gt;<i> 
</I>&gt;<i> I just realised I left out some info in the original email that was
</I>&gt;<i> pertinent. :)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> How are you determining that exactly?
</I>&gt;&gt;<i> squid logs? DNS logs? firewall counters? packet traces?
</I>&gt;<i> 
</I>&gt;<i> Quite simply by trial and error and monitoring the results of taking
</I>&gt;<i> the 2 DNS/DCs offline/online, and using the cachemgr report.
</I>&gt;<i> 
</I>&gt;<i> EG. here is the report after I loaded one page and then took the
</I>&gt;<i> primary DNS offline, then continued to browse to two more pages. The
</I>&gt;<i> latter two pages did not load and the cachemgr report seems to verify
</I>&gt;<i> that squid is not using the secondary dns server at all (primary dns
</I>&gt;<i> server having 27 queries to 9 replies and the secondary getting none).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at websafetyv51</A>:~# squidclient mgr:idns
</I>&gt;<i> Date: Thu, 12 Oct 2017 05:30:12 GMT
</I> &gt; Via: 1.1 websafetyv51.localdom.local (squid/3.5.23)
...
&gt;<i> 
</I>&gt;<i> Internal DNS Statistics:
</I>&gt;<i> 
</I>&gt;<i> The Queue:
</I>&gt;<i>                         DELAY SINCE
</I>&gt;<i>    ID   SIZE SENDS FIRST SEND LAST SEND M FQDN
</I>&gt;<i> ------ ---- ----- ---------- --------- - ----
</I>&gt;<i> 
</I>&gt;<i> DNS jumbo-grams: not working
</I>&gt;<i> 
</I>&gt;<i> Nameservers:
</I>&gt;<i> IP ADDRESS                                     # QUERIES # REPLIES Type
</I>&gt;<i> ---------------------------------------------- --------- --------- --------
</I>&gt;<i> 192.168.100.249                                      27         9 recurse
</I>&gt;<i> 192.168.100.248                                       0         0 recurse
</I>&gt;<i> 
</I>&gt;<i> Rcode Matrix:
</I>&gt;<i> RCODE ATTEMPT1 ATTEMPT2 ATTEMPT3 PROBLEM
</I>&gt;<i>      0     1550        0        0 : Success
</I>...

That is a bit odd. Also the fact that ~1550 queries are not showing up 
in the nameserver counters.

Do you have ICMP and ICMPv6 working in your network? If not that is 
probably part of the issue.

Are you using DROP rules or policies in your firewalls? that can also 
lead to missing packets like this.

Are you able to perform some more careful tests?
  * restart Squid with both resolvers active and take snapshots of that 
report periodically across the test. It will need sufficient time after 
shutting down the first resolver for any packet or query TTLs to expire.


If you could also check whether either resolver is responding using 
alternative IP addresses it would help clarify what is going on.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016631.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
	<LI>Next message (by thread): <A HREF="016660.html">[squid-users] Squid not failing over to secondary DNS host
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16649">[ date ]</a>
              <a href="thread.html#16649">[ thread ]</a>
              <a href="subject.html#16649">[ subject ]</a>
              <a href="author.html#16649">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
