<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid slow down after awhile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20slow%20down%20after%20awhile&In-Reply-To=%3C4f640157-235d-d58e-25b6-63cd79bbf2ca%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016650.html">
   <LINK REL="Next"  HREF="016640.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid slow down after awhile</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20slow%20down%20after%20awhile&In-Reply-To=%3C4f640157-235d-d58e-25b6-63cd79bbf2ca%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid slow down after awhile">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Oct 14 20:27:44 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016650.html">[squid-users] Squid slow down after awhile
</A></li>
        <LI>Next message (by thread): <A HREF="016640.html">[squid-users] I need help to compile squid with ssldump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16651">[ date ]</a>
              <a href="thread.html#16651">[ thread ]</a>
              <a href="subject.html#16651">[ subject ]</a>
              <a href="author.html#16651">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/10/17 05:20, masoud mazarei wrote:
&gt;<i> i sent you an pcap file which shows the problem.
</I>&gt;<i> my client ip is 172.22.127.1 and target host is&#160;&#160;94.182.227.21.
</I>&gt;<i> squid machine mac is&#160;e4:11:5b:ea:30:c2.
</I>&gt;<i> filter pcap file in wireshark by filter &quot;ip.host==94.182.227.21&quot; you 
</I>&gt;<i> will see that the first SYN packet arrived in No.304 and relative time 
</I>&gt;<i> 6.637173 but first packet which goes out from cache machine as client by 
</I>&gt;<i> squid happend in No.371 and relative time 45.013691
</I>
That kind of indicates the problem is either in how long the client 
takes to deliver the HTTP request to Squid, or DNS lookups to find the 
destination(s).

&gt;<i> what is happend in (6.637173 - 45.013691) duration.?
</I>
For a transparent proxy these things have happened between SYN on 
client&lt;-&gt;Squid and SYN on Squid&lt;-&gt;server:


* NAT/TPROXY record lookups for client connection state

* wait for the client to send its HTTP request.
  - with happy eyeballs there may be a large wait between the SYN and 
first data sent by client for ~50% of connections.

* parsing of that HTTP request message.

* DNS lookup(s) for Host header verification

* http_access checks

* Adaptation hooks (ICAP / eCAP), if any

* URL re-writer lookups, if any

* HTTP 'cache' directive ACL checks

* HTTP cache lookup

* DNS lookups to find destination, if any
  - this should be very fast since the Host verify results should be 
cached. But if any of the above took longer than DNS TTL new lookups may 
be required - naturally increasing the delay further.

* Destination selection

* TCP server connection(s) setup
  - if you are only looking at IPv4 packets you may be missing multiple 
SYN packets for IPv6 servers before the first IPv4 SYN packet appears.


The points above with sub-notes are the ones most likely to be delayed 
for seconds. You may be seeing one particular source of the problem, or 
multiple adding together. 45 sec seems an unusual number. Most of the 
timeouts in Squid and networking are multiples of 30 sec.



&gt;<i> which debug level will help me to know what is happend in background?
</I>&gt;<i> i enabled
</I>&gt;<i> &quot;debug_options 5,3 6,3 46,3 11,3 19,3 55,3 58,3&quot;
</I>&gt;<i> BUT there is no valuable data to solve this problem.
</I>&gt;<i> 
</I>
You may need an ALL,6 trace then to see if there are any clues in odd 
places. As verbose as it is the debugging in Squid is far from complete 
so for some of these delay issues there no specific lines to look for 
mention and we have to go by relative timing of things.

The durations between actions on the list of points above should narrow 
down a bit better what to look at.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016650.html">[squid-users] Squid slow down after awhile
</A></li>
	<LI>Next message (by thread): <A HREF="016640.html">[squid-users] I need help to compile squid with ssldump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16651">[ date ]</a>
              <a href="thread.html#16651">[ thread ]</a>
              <a href="subject.html#16651">[ subject ]</a>
              <a href="author.html#16651">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
