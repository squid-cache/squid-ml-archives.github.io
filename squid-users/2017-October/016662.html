<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Question about: ext_session_acl Splash/Portal solution.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Question%20about%3A%20ext_session_acl%20Splash/Portal%0A%20solution.&In-Reply-To=%3C244ce742-2bcf-f601-2b80-ab077828c243%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016655.html">
   <LINK REL="Next"  HREF="016670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Question about: ext_session_acl Splash/Portal solution.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Question%20about%3A%20ext_session_acl%20Splash/Portal%0A%20solution.&In-Reply-To=%3C244ce742-2bcf-f601-2b80-ab077828c243%40treenet.co.nz%3E"
       TITLE="[squid-users] Question about: ext_session_acl Splash/Portal solution.">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Oct 16 14:59:28 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016655.html">[squid-users] Question about: ext_session_acl Splash/Portal solution.
</A></li>
        <LI>Next message (by thread): <A HREF="016670.html">[squid-users] Question about: ext_session_acl Splash/Portal solution.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16662">[ date ]</a>
              <a href="thread.html#16662">[ thread ]</a>
              <a href="subject.html#16662">[ subject ]</a>
              <a href="author.html#16662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/10/17 07:17, Klaus Tachtler wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> after a little bit more testing, of course I must agree with you, it 
</I>&gt;<i> doesn't work as expected.
</I>&gt;<i> 
</I>&gt;<i> Please can you give me another advice? Where is my fault?
</I>&gt;<i> 
</I>&gt;<i> I tried to use the *ACTIVE* example from the squid documentation and 
</I>&gt;<i> modified it a little bit on 3 parts of the code, BUT a LOOP are still 
</I>&gt;<i> there!
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash#Squid_Configuration_File_-_Active_Mode">https://wiki.squid-cache.org/ConfigExamples/Portal/Splash#Squid_Configuration_File_-_Active_Mode</A> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --- code ---
</I>&gt;<i> 
</I>&gt;<i> # Set up the session helper in active mode. Mind the wrap - this is one 
</I>&gt;<i> line: - *MODIFIED* - (all in one line)
</I>&gt;<i> external_acl_type session concurrency=100 ttl=3 negative_ttl=0 
</I>&gt;<i> children-max=1 %LOGIN /usr/lib64/squid/ext_session_acl -a -T 60 -b 
</I>&gt;<i> /var/lib/squid/sessions/
</I>&gt;<i> 
</I>&gt;<i> # Pass the LOGIN command to the session helper with this ACL
</I>&gt;<i> acl session_login external session LOGIN
</I>&gt;<i> 
</I>&gt;<i> # Normal session ACL as per simple example
</I>&gt;<i> acl session_is_active external session
</I>&gt;<i> 
</I>&gt;<i> # ACL to match URL - *MODIFIED* -
</I>&gt;<i> acl clicked_login_url url_regex -i <A HREF="http://my.pages.net/html/accept.php">http://my.pages.net/html/accept.php</A>
</I>&gt;<i> 
</I>&gt;<i> # First check for the login URL. If present, login session
</I>&gt;<i> http_access allow clicked_login_url session_login
</I>&gt;<i> 
</I>&gt;<i> # If we get here, URL not present, so renew session or deny request.
</I>&gt;<i> http_access deny !session_is_active
</I>&gt;<i> 
</I>&gt;<i> # Deny page to display - *MODIFIED* - NOT using a template with 
</I>&gt;<i> HTML-Code 511!
</I>&gt;<i> deny_info <A HREF="http://my.pages.net/html/splash.php?url=%u">http://my.pages.net/html/splash.php?url=%u</A> session_is_active
</I>

Please double-check the cacheing related headers on both your custom 
URLs are set to make them non-cacheable. 302 is a weak substitute for 
511 semantics, and requires caching headers to clearly and explicitly 
prevent caching *and* to be followed by the client or the system can 
breaks badly (which is why 511 was created).


Which exact version of Squid are you using? some of the early v4 had 
issues with the format parameter changes which broke the active session 
mode for a while.


Also, be aware that since the helper API is *only* using %LOGIN if any 
visitor happens to send a request for the clicked_login_url without 
credentials attached they will make a logged-in session for anonymous 
access and the proxy becomes an 'open proxy' for any subsequent client 
requests from *anywhere* for 63 seconds. Things like that are why %SRC 
is usually used to make a session depend on things not as easily under 
client control - such as src-IP.


If those don't work I'm stuck as well. The wiki config examples are ones 
I used myself for many years before I moved to the sql_session helper.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016655.html">[squid-users] Question about: ext_session_acl Splash/Portal solution.
</A></li>
	<LI>Next message (by thread): <A HREF="016670.html">[squid-users] Question about: ext_session_acl Splash/Portal solution.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16662">[ date ]</a>
              <a href="thread.html#16662">[ thread ]</a>
              <a href="subject.html#16662">[ subject ]</a>
              <a href="author.html#16662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
