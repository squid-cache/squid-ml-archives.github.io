<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.20 and 3.1.23 getting re-started with bogus &quot;FATAL: Bungled&quot; acls
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.20%20and%203.1.23%20getting%20re-started%20with%0A%20bogus%20%22FATAL%3A%20Bungled%22%20acls&In-Reply-To=%3CCAH%2BmwvpMp91qO0_u_wtoMt4uYoXT52aVejzckkDS%2BXsZtapULQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016681.html">
   <LINK REL="Next"  HREF="016699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.20 and 3.1.23 getting re-started with bogus &quot;FATAL: Bungled&quot; acls</H1>
    <B>Francisco Amaro</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.20%20and%203.1.23%20getting%20re-started%20with%0A%20bogus%20%22FATAL%3A%20Bungled%22%20acls&In-Reply-To=%3CCAH%2BmwvpMp91qO0_u_wtoMt4uYoXT52aVejzckkDS%2BXsZtapULQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 3.5.20 and 3.1.23 getting re-started with bogus &quot;FATAL: Bungled&quot; acls">famaro at gmail.com
       </A><BR>
    <I>Wed Oct 18 14:33:50 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016681.html">[squid-users] Squid 3.5.20 and 3.1.23 getting re-started with	bogus &quot;FATAL: Bungled&quot; acls
</A></li>
        <LI>Next message (by thread): <A HREF="016699.html">[squid-users] Squid 3.5.20 and 3.1.23 getting re-started with bogus &quot;FATAL: Bungled&quot; acls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16685">[ date ]</a>
              <a href="thread.html#16685">[ thread ]</a>
              <a href="subject.html#16685">[ subject ]</a>
              <a href="author.html#16685">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

So, we've been (slowly) investigating this issue these past days, and have
reached some conclusions.

a) First, and sorry for not being clear on that, this only happens on
&quot;squid reload&quot;, not on full stop/start cycles.
A full start cycle does not give this error, that's why we are pretty sure
the issue is not a bungled ACL, per se.

b) Besides that, it only happens when the proxy has some load on it, we
have been unable to reproduce this on
our test machines, since they do not have a significant load. We've been
postponing our ACL's changes for
early morning/lunch-hour these past days, and we didn't have had a FATAL
error since last week.

c) Although we don't have non US-ASCII on the ACL's themselves, we have a
lot of them on comments, so
I've stripped down all the comments of the ACL's files and tried that on
our test bed, it didn't generare any
kind of errors, but since they do not have some load on it, we are not sure
if it was the comments stripping
or the lack of load on the server...

So, we are now searching for an &quot;easy&quot; way of generating traffic on a squid
server, so we can, at least, be
able to reproduce the error, so we can try the different solutions....








2017-10-18 1:06 GMT+01:00 Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;:

&gt;<i> Are you validating your config files before committing them??
</I>&gt;<i> If you have about 100 clients this is the first thing to do...
</I>&gt;<i> Either run a asciii validation script for the whole file(I can write it if
</I>&gt;<i> you really need it) or maintain two configuration testing node (CentOS 6+7).
</I>&gt;<i> You don't even need to apply the configurations into the a running squid,
</I>&gt;<i> you just need to run a command like &quot;squid -kparse -f
</I>&gt;<i> /etc/squid/squid.conf&quot; and it will tell you what's wrong.
</I>&gt;<i>
</I>&gt;<i> Let me know if you need more help.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> * CC me since I'm not watching the list daily these days.
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> <A HREF="http://ngtech.co.il/lmgtfy/">http://ngtech.co.il/lmgtfy/</A>
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;<i> Behalf Of Francisco Amaro
</I>&gt;<i> Sent: Thursday, October 12, 2017 19:25
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] Squid 3.5.20 and 3.1.23 getting re-started with
</I>&gt;<i> bogus &quot;FATAL: Bungled&quot; acls
</I>&gt;<i>
</I>&gt;<i> Hello all,
</I>&gt;<i>
</I>&gt;<i> We are running stock CentOS 6 and CentOS 7 Squid builds, patched to the
</I>&gt;<i> latest version, 3.1.23 and 3.5.20.
</I>&gt;<i> We have several machines, running on separate locations, with an ACL file
</I>&gt;<i> unique to all, that get's pushed to all machines using an homemade script.
</I>&gt;<i> So local configuration (interfaces, cache locations, etc) is one file, and
</I>&gt;<i> the bulk of the ACL's are included on
</I>&gt;<i> a separate file, that is the same on all servers.
</I>&gt;<i>
</I>&gt;<i> For some time now, but getting more frequent on the last couple of weeks,
</I>&gt;<i> we have been getting errors on our cache.log about bogus ACL's, forcing a
</I>&gt;<i> squid restart. This happens on configuration reloads, which we do very
</I>&gt;<i> frequently,  maybe 10-20 times a day.
</I>&gt;<i>
</I>&gt;<i> On CentOS 6, the most frequent error is :
</I>&gt;<i>
</I>&gt;<i> FATAL: Bungled (null) line 203: icap_retry deny all
</I>&gt;<i>
</I>&gt;<i> We do not use icap_retry, it is missing from the config file, but this
</I>&gt;<i> seems to be fixed on 3.2.4:
</I>&gt;<i>
</I>&gt;<i> Changes to squid-3.2.4 (03 Dec 2012):
</I>&gt;<i> - Remove 'Bungled' warning on missing component directives
</I>&gt;<i>
</I>&gt;<i> On CentOS 7, the most frequent error is :
</I>&gt;<i>
</I>&gt;<i> FATAL: Bungled (null) line 3: sslproxy_cert_sign signTrusted all
</I>&gt;<i>
</I>&gt;<i> Now this one even has a bug entry, and was fixed on 3.3.5:
</I>&gt;<i>
</I>&gt;<i> Changes to squid-3.3.5 (20 May 2013):
</I>&gt;<i> - Bug 3744: squid terminated: FATAL: Bungled (null) line 3:
</I>&gt;<i> sslproxy_cert_sign signTrusted all
</I>&gt;<i>
</I>&gt;<i> But we are still seeing it on 3.5.20...
</I>&gt;<i>
</I>&gt;<i> Now what is even more weird is that besides that, we are getting what seem
</I>&gt;<i> complete random bogus entries, like this ones:
</I>&gt;<i>
</I>&gt;<i> FATAL: Bungled /etc/squid/squid_acls line 11796: acl xyz_allow_url
</I>&gt;<i> FATAL: Bungled /etc/squid/squid_acls line 10905: acl abc_url108 dstdomai
</I>&gt;<i>
</I>&gt;<i> FATAL: Bungled squid_acls line 10033: http_access allow def_
</I>&gt;<i> FATAL: Bungled squid_acls line 9605: http_access allow ms_src_teste ms_t
</I>&gt;<i> FATAL: Bungled squid_acls line 11025: http_access allow xpto
</I>&gt;<i>
</I>&gt;<i> The problem is that these lines are 100% correct , they are not &quot;bungled&quot;
</I>&gt;<i> at all,  it seems the parser as some issue with it.
</I>&gt;<i>
</I>&gt;<i> Each time we get an error like this, Squid does a full restart, and that
</I>&gt;<i> on CentOS 6 is time consuming, maybe 2-3 minutes, time enough for our users
</I>&gt;<i> reaching for the Helpdesk tickets... On CentOS 7, since the restart is very
</I>&gt;<i> fast, we do not have many complaints...
</I>&gt;<i>
</I>&gt;<i> Our ACL file is currently 7500 lines, mostly comprising of dstdomain and
</I>&gt;<i> url_regex entries. We support a lot of costumers (about 100) and each one
</I>&gt;<i> has a specific configuration. Mostly have while lists, and there are a  few
</I>&gt;<i> blacklists in the middle... so, not very big in terms of line numbers, but
</I>&gt;<i> somewhat  complex regarding site/VLAN entries...
</I>&gt;<i>
</I>&gt;<i> For security/privacy reasons I cannot share my complete configuration,
</I>&gt;<i> namely the ACL's part, since they contain client information, but I am able
</I>&gt;<i> to get detailed logging and/or redacted information...
</I>&gt;<i>
</I>&gt;<i> So... anyone has any clue what is happenning ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Francisco Amaro
</I>&gt;<i> Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">famaro at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Francisco Amaro
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">famaro at gmail.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20171018/a61e417a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20171018/a61e417a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016681.html">[squid-users] Squid 3.5.20 and 3.1.23 getting re-started with	bogus &quot;FATAL: Bungled&quot; acls
</A></li>
	<LI>Next message (by thread): <A HREF="016699.html">[squid-users] Squid 3.5.20 and 3.1.23 getting re-started with bogus &quot;FATAL: Bungled&quot; acls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16685">[ date ]</a>
              <a href="thread.html#16685">[ thread ]</a>
              <a href="subject.html#16685">[ subject ]</a>
              <a href="author.html#16685">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
