<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid doesn't reload webpage like other clients do
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20doesn%27t%20reload%20webpage%20like%20other%20clients%20do&In-Reply-To=%3C98941ab1-fc1d-8d2a-b1bf-41ab834d7be9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016759.html">
   <LINK REL="Next"  HREF="016771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid doesn't reload webpage like other clients do</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20doesn%27t%20reload%20webpage%20like%20other%20clients%20do&In-Reply-To=%3C98941ab1-fc1d-8d2a-b1bf-41ab834d7be9%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid doesn't reload webpage like other clients do">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct 31 08:51:36 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016759.html">[squid-users] Squid doesn't reload webpage like other clients do
</A></li>
        <LI>Next message (by thread): <A HREF="016771.html">[squid-users] Squid doesn't reload webpage like other clients do
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16764">[ date ]</a>
              <a href="thread.html#16764">[ thread ]</a>
              <a href="subject.html#16764">[ subject ]</a>
              <a href="author.html#16764">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/10/17 05:22, Alex Rousskov wrote:
&gt;<i> On 10/30/2017 03:51 AM, Troiano Alessio wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I've squid 3.5.20 running on RHEL 7.4. I have a problem to access
</I>&gt;&gt;<i> some websites, for example www.nato.int. This website apply an
</I>&gt;&gt;<i> Anti-DDoS system that reset the first connection after the TCP 3-way
</I>&gt;&gt;<i> handshake (SYN/SYN-ACK/ACK/RST-ACK). All subsequent TCP connections
</I>&gt;&gt;<i> are accepted. The website administrator say's it is by design.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> When I browse the site with squid proxy the browser receive an &quot;Empty
</I>&gt;&gt;<i> Response&quot; squid error page (HTTP error code 502 Bad Gateway) and
</I>&gt;&gt;<i> doesn't do the automatic retry:
</I>&gt;<i> 
</I>&gt;<i> This is by design as well :-).
</I>&gt;<i> 
</I>&gt;<i> We can change Squid behavior to retry connection resets, but I am sure
</I>&gt;<i> that some folks will not like the new behavior because in _their_ use
</I>&gt;<i> cases a retry is wasteful and/or painful. IMHO, the new behavior should
</I>&gt;<i> be controlled by a configuration directive, possibly an ACL-driven one.
</I>&gt;<i> &gt; Quality patches implementing the above feature should be welcomed IMO.
</I>&gt;<i> The tip of the relevant code is probably in ERR_ZERO_SIZE_OBJECT
</I>&gt;<i> handling inside FwdState::fail(). There is a similar code that handles
</I>&gt;<i> persistent connection races there already, but the zero-size reply code
</I>&gt;<i> may need a new dedicated FwdState flag to prevent infinite retry loops
</I>&gt;<i> when the origin server is broken (a much more typical use case than the
</I>&gt;<i> weird attempt at DDoS mitigation that you have described above).
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at soc-pe-nagios01</A> ~]# wget www.nato.int -e use_proxy=yes -e http_proxy=172.31.1.67:8080
</I>&gt;&gt;<i> --2017-10-30 10:41:09--  <A HREF="http://www.nato.int/">http://www.nato.int/</A>
</I>&gt;&gt;<i> Connecting to 172.31.1.67:8080... connected.
</I>&gt;&gt;<i> Proxy request sent, awaiting response... 502 Bad Gateway
</I>&gt;&gt;<i> 2017-10-30 10:41:09 ERROR 502: Bad Gateway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can't find an RFC that confirm if browser and proxyes should try a page reload, or if squid has an option to do that.
</I>
FWIW: what Squid is seeing is that the TCP is *successful*, then the 
HTTP request delivery gets a TCP RST. This is indistinguishable from the 
many broken IP/VPN tunnel, path-MTU and NAT errors that occur all over 
the Internet on a regular basis.


That operational state (HTTP underway) also means RFC 7230 is the 
relevant place to look for behaviour requirements. Section 6.3.1 says:

Browsers requirement:
&quot;
   a client MAY open a
    new connection and automatically retransmit an aborted sequence of
    requests if all of those requests have idempotent methods (Section
    4.2.2 of [RFC7231]).
&quot;

Squid requirement:
&quot;
   A proxy MUST NOT automatically retry non-idempotent requests.
&quot;

So it depends entirely on what type of HTTP request was being performed. 
If it was CONNECT, POST or similar then retry is forbidden.

Squid should already be re-trying for GET requests and similar. If it is 
not then that can be treated as a bug. Alex already pointed out the code 
place to look at for retry handling. The 'Method' class in Squid 
provides an isIdempotent() accessor that can be used to check whether 
the request is retriable or not.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016759.html">[squid-users] Squid doesn't reload webpage like other clients do
</A></li>
	<LI>Next message (by thread): <A HREF="016771.html">[squid-users] Squid doesn't reload webpage like other clients do
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16764">[ date ]</a>
              <a href="thread.html#16764">[ thread ]</a>
              <a href="subject.html#16764">[ subject ]</a>
              <a href="author.html#16764">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
