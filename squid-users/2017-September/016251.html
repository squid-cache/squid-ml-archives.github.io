<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl problem (Amos Jeffries)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20problem%20%28Amos%20Jeffries%29&In-Reply-To=%3Cd1b2f054-e37b-934a-4e82-f37cfa2c4039%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="016252.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl problem (Amos Jeffries)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20problem%20%28Amos%20Jeffries%29&In-Reply-To=%3Cd1b2f054-e37b-934a-4e82-f37cfa2c4039%40treenet.co.nz%3E"
       TITLE="[squid-users] acl problem (Amos Jeffries)">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep  1 02:36:13 UTC 2017</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="016252.html">[squid-users] Recompiling Squid3 for Mips hardware,	enabling captive portal?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16251">[ date ]</a>
              <a href="thread.html#16251">[ thread ]</a>
              <a href="subject.html#16251">[ subject ]</a>
              <a href="author.html#16251">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/09/17 00:44, Alex Guti&#233;rrez Mart&#237;nez wrote:
&gt;<i> Thanks for answering Mr. Jeffries, I just applied his recommendations, I 
</I>&gt;<i> changed the &quot;allow basic_ldap_auth&quot; rule to &quot;deny! Basic_ldap_auth&quot;,
</I>
Good.

&gt;<i> I 
</I>&gt;<i> also left the acl names denied and removed their respective &quot;acl deny 
</I>&gt;<i> rule&quot; and the rule &quot;http_access deny I left it on the last line.
</I>
Hmm. I assume you are referring to the commenting out of the needless 
denies I mentioned. That looks okay now.

&gt;<i> Although I did not give problems the &quot;squid3 -k parse&quot;. But the link to 
</I>&gt;<i> the ldap suddenly stopped working, searching at 
</I>&gt;<i> &quot;<A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A>&quot; I saw that I had to change the 
</I>&gt;<i> parameter &quot;external_acl_type Group&quot; to &quot;external_acl_type ldap_group&quot; .
</I>
No, you can use any name you like for that parameter.

The first parameter of the external_acl_type directive is just a custom 
name / label to refer to that particular external helper in the acl 
lines later.

For example:

  external_acl_type foo ...

  acl ... external foo ...


&gt;<i> The Ldap user password has not change and there are other applications 
</I>&gt;<i> that are using the ldap correctly at this time, any sugestions?
</I>&gt;<i> 
</I>
I see you also changed the rules giving permission for 'full' group to 
access the proxy. That change broke a few things.


&gt;<i> Here is a copy of my current configuration file
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #Escondemos la version del squid
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> #nombre que queremos que muestre el squid como nuestro host
</I>&gt;<i> visible_hostname Hermes
</I>&gt;<i> #no permitimos que nada pase por nuestro proxy
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for off
</I>&gt;<i> follow_x_forwarded_for deny all
</I>&gt;<i> #puertos que permitiremos
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>
You have another set of rules at the bottom of the config for manager 
access. These rules let sqstat etc through without logging in, the ones 
at the bottom require login.

If you need sqstat etc to login, then remove these manger lines.

If you need sqstat etc to get through without login. Then:
  * remove the above lines, and
  * move the sqstat rules from the bottom of the config up to just below 
the CONNECT rule below here.

&gt;<i> # Permitimos los puertos inseguros
</I>&gt;<i> http_access allow !Safe_ports
</I>&gt;<i> http_access allow CONNECT !SSL_ports
</I>
The above rules are supposed to be _preventing_ hacking attacks through 
your proxy. The default lines were very carefully designed to add that 
protection without overriding your local policies.
  The change to make the above use &quot;allow&quot; lets anybody through the 
proxy without any control (ouch).

Please return that to the default:
  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports


Your rules for 'manger' ACL should go somewhere after these rules. (That 
Best Practice has changed recently, so the 3.3 default config does not 
do it right.)


&gt;<i> debug_options ALL,9
</I>&gt;<i> ########################################################
</I>&gt;<i> #auth ldap#
</I>&gt;<i> ########################################################
</I>&gt;<i> auth_param basic program /usr/lib/squid3/basic_ldap_auth -P&#160; -R -b 
</I>&gt;<i> &quot;dc=empresa,dc=cuba,dc=cu&quot; -D cn=ldap,ou=squid,dc=empresa,dc=cuba,dc=cu 
</I>&gt;<i> -W /etc/squid3/clave.txt -f sAMAccountName=%s -v 3 -s sub -h 172.16.4.10
</I>&gt;<i> external_acl_type Group %LOGIN /usr/lib/squid3/ext_ldap_group_acl -R -b 
</I>&gt;<i> &quot;dc=empresa,dc=cuba,dc=cu&quot; -D 
</I>&gt;<i> cn=cn=ldap,ou=squid,dc=empresa,dc=cuba,dc=cu -W /etc/squid3/clave.txt -f 
</I>&gt;<i> &quot;(&amp;(objectclass=user)(sAMAccountName=%u) 
</I>&gt;<i> (memberof=cn=%g,dc=empresa,dc=cuba,dc=cu))&quot; -h 172.16.4.10
</I>
Is there actually a space in the middle of that -f parameter string?
I'm not very familiar with LDAP syntax, but the other configs I have 
seen using it do not have a space there.

NP: If it helps Squid understands line wrapping in squid.conf. Just add 
a '\' as the last character and some whitespace at the beginning of the 
next line. That can help avoid email wrap problems.


&gt;<i> #######################################################
</I>&gt;<i> #auth que no funcionan y deben arreglarse
</I>&gt;<i> ##########################################################
</I>&gt;<i> auth_param basic children 10
</I>&gt;<i> auth_param basic realm hermes.empresa.cuba.cu
</I>&gt;<i> auth_param basic credentialsttl 2 hour
</I>&gt;<i> acl basic_ldap_auth proxy_auth REQUIRED
</I>
&gt;<i> http_access deny !basic_ldap_auth
</I>&gt;<i> #http_access deny all
</I>&gt;<i> ########################################################
</I>&gt;<i> #restricciones selectivas#
</I>&gt;<i> ########################################################
</I>&gt;<i> acl dmz src 172.16.4.0/27
</I>&gt;<i> acl navegacion src 192.168.9.0/24
</I>&gt;<i> acl full external Group InternetFull
</I>&gt;<i> acl limitado external Group InternetLimitado
</I>&gt;<i> acl sociales dstdomain -n &quot;/etc/squid3/bloqueo/sociales&quot;
</I>&gt;<i> acl extensiones urlpath_regex -i &quot;/etc/squid3/bloqueo/listaextensiones&quot;
</I>&gt;<i> http_access deny !full sociales
</I>&gt;<i> http_access deny !full !limitado navegacion
</I>&gt;<i> http_access deny !full dmz
</I>

These extra changes are adding some new problems.

Earlier you had some allow lines to let the 'full' group use the proxy. 
They were okay [assuming that was what you wanted], only the way they 
interacted with the login ACL was broken.

You do need some allow lines to tell Squid what to allow for logged in 
users. The order you need for best use of authentication is this:

  # rules for things that do not require authentication
  http_access allow/deny ...

  # require authentication to happen
  http_access deny !login

  # rules for authenticated users
  http_access allow/deny ...

  # prevent any other / unexpected access of the proxy
  http_access deny all


It may help if you write out your policy in human language statements. 
Being as simple as you can. Each statement will then usually be an 
http_access line and you can shuffle the order around until the config 
file 'reads' correctly to both you/us and Squid.

Note: if you find yourself writing 'except' or 'unless' that means there 
are probably going to be multiple http_access lines to match your policy 
statement, with the exception ones being ordered first.


For example reading your current rules:

 &gt; http_access deny !full sociales

* &quot;everyone not in group full are denied access to sociales domains&quot;

 &gt; http_access deny !full !limitado navegacion

* &quot;everyone not in group full and not in group limitado and on a 
navegacion machine are denied&quot;

  -&gt; see how this is very clumsy to write in human language. That 
probably means a mistake and things could be simpler.

 &gt; http_access deny !full dmz

* &quot;everyone not in group full and coming from dmz are denied&quot;


It is usually better to design in a way that avoids so many '!' / not 
statements. That is both easier for us humans to read and understand, 
and usually faster for Squid to process - especially when it has to 
pause the transaction and wait for a helper response on each ACL test.

eg. from what you have mentioned so far I think you want to end up with 
something like this:

  # ... some rules for anything 'full' group are denied ?

  # otherwise, 'full' group are allowed though unrestricted
  http_access allow full

  # ... things denied to everyone outside the 'full' group
  http_access deny dmz
  http_access deny sociales

  # ... navegacion are allowed if their user is in 'limitado' group
  #     (except to 'sociales' domains)
  http_access allow navegacion limitado

  # no more things are allowed
  http_access deny all



&gt;<i> ########################################################
</I>&gt;<i> #restricciones obligadas#
</I>&gt;<i> ########################################################
</I>&gt;<i> #acl blacklist url_regex -i &quot;/etc/squid3/listanegra&quot;
</I>&gt;<i> #http_access deny blacklist
</I>&gt;<i> acl bl7 dstdomain -n &quot;/etc/squid3/bloqueo/correos&quot;
</I>&gt;<i> #http_access allow full !limitado bl7
</I>&gt;<i> acl bl1 url_regex -i &quot;/etc/squid3/bloqueo/porno&quot;
</I>&gt;<i> #http_access deny bl1
</I>&gt;<i> acl bl2 url_regex -i &quot;/etc/squid3/bloqueo/android&quot;
</I>&gt;<i> #http_access deny bl2
</I>&gt;<i> acl bl3 url_regex -i &quot;/etc/squid3/bloqueo/prox1&quot;
</I>&gt;<i> #http_access deny bl3
</I>&gt;<i> acl bl4 url_regex -i &quot;/etc/squid3/bloqueo/prox2&quot;
</I>&gt;<i> #http_access deny bl4
</I>&gt;<i> acl bl5 url_regex -i &quot;/etc/squid3/bloqueo/prox3&quot;
</I>&gt;<i> #http_access deny bl5
</I>&gt;<i> acl bl6 url_regex -i &quot;/etc/squid3/bloqueo/prox4&quot;
</I>&gt;<i> #http_access deny bl6
</I>&gt;<i> #acl ladmin src &quot;/etc/squid3/ladmin&quot;
</I>

&gt;<i> #########################################################################
</I>&gt;<i> #proxy_padre #
</I>&gt;<i> #########################################################################
</I>&gt;<i> cache_peer 172.16.1.24 parent 8000 0
</I>&gt;<i> #nunca permitimos conexiones directas, siempre a traves del proxy
</I>&gt;<i> never_direct allow all
</I>&gt;<i> #######################################################################
</I>&gt;<i> # puerto en que el proxy nos escuchara
</I>&gt;<i> http_port 3128
</I>&gt;<i> ###############################################################################
</I>&gt;<i> maximum_object_size 100 MB
</I>&gt;<i> cache_dir aufs /var/cache/squid3 1024000 16 256
</I>&gt;<i> cache_mem 128 MB
</I>&gt;<i> cache_store_log /var/cache/squid3/cache_store.log
</I>&gt;<i> coredump_dir /var/cache/squid3/dump
</I>&gt;<i> #minimum_expiry_time 600 seconds
</I>&gt;<i> ############################
</I>&gt;<i> client_db off
</I>&gt;<i> offline_mode off
</I>&gt;<i> cache_swap_low 5
</I>&gt;<i> cache_swap_high 10
</I>&gt;<i> cache_replacement_policy heap GDSF
</I>&gt;<i> maximum_object_size_in_memory 256 KB
</I>&gt;<i> chunked_request_body_max_size 4096 KB
</I>&gt;<i> half_closed_clients off
</I>&gt;<i> quick_abort_min 2 KB
</I>&gt;<i> ############################
</I>&gt;<i> # establecemos los archivos de volcado en /var/cache/squid3/
</I>&gt;<i> coredump_dir /var/cache/squid3/
</I>&gt;<i> ###############################################################################
</I>&gt;<i> #Establecemos los patrones de refrescamiento de la cache #
</I>&gt;<i> #patron de refrescamiento -- tipo de archivo -- tiempo del objeto -- %de 
</I>&gt;<i> refrescamiento -- tiempo #
</I>&gt;<i> #1440 minutos equivalen a 24 horas #
</I>&gt;<i> ###############################################################################
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i .(gif|png|jpg|jpeg|ico)$ 10080 20% 43200 
</I>&gt;<i> override-expire ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i .(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 43200 20% 
</I>&gt;<i> 432000 override-expire ignore-no-store ignore-private
</I>&gt;<i> #refresh_pattern -i (/cgi-bin/|?) 0 0% 0
</I>&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;<i> max_filedescriptors 3200
</I>&gt;<i> ##cuanto el squid intenta cachear en mi nombre
</I>&gt;<i> read_ahead_gap 256 KB
</I>&gt;<i> #################
</I>&gt;<i> #sqstat
</I>&gt;<i> #################
</I>&gt;<i> #acl manager proto cache_object
</I>&gt;<i> # replace 10.0.0.1 with your webserver IP
</I>&gt;<i> acl webserver src 172.16.4.25/27
</I>&gt;<i> http_access allow manager webserver
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> ###############################################################################
</I>&gt;<i> #Delay#
</I>&gt;<i> ###############################################################################
</I>&gt;<i> client_delay_initial_bucket_level 60
</I>&gt;<i> delay_initial_bucket_level 75
</I>&gt;<i> delay_pools 2
</I>&gt;<i> memory_pools off
</I>&gt;<i> 
</I>&gt;<i> #Canal 1 extensiones.
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 16384/32768 8192/16384
</I>&gt;<i> delay_access 1 allow sociales extensiones
</I>&gt;<i> delay_access 1 deny all
</I>&gt;<i> 
</I>&gt;<i> #Canal 2 para usuarios.
</I>&gt;<i> delay_class 2 2
</I>&gt;<i> delay_parameters 2 65536/65536 32768/32768
</I>&gt;<i> delay_access 2 allow navegacion
</I>&gt;<i> delay_access 2 deny all
</I>&gt;<i> http_access deny all
</I>&gt;<i> #end of line
</I>&gt;<i> ####################################################################################
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> PD: Please forgive my english, it's no my native language.
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Saludos Cordiales
</I>&gt;<i> 
</I>&gt;<i> Lic. Alex Guti&#233;rrez Mart&#237;nez
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="016252.html">[squid-users] Recompiling Squid3 for Mips hardware,	enabling captive portal?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16251">[ date ]</a>
              <a href="thread.html#16251">[ thread ]</a>
              <a href="subject.html#16251">[ subject ]</a>
              <a href="author.html#16251">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
