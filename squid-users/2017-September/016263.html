<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid with quota limit using external helper problem !
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20quota%20limit%20using%20external%20helper%0A%20problem%20%21&In-Reply-To=%3C47a5c10e-ae64-e366-d6bc-f494836da3a4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016262.html">
   <LINK REL="Next"  HREF="016267.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid with quota limit using external helper problem !</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20quota%20limit%20using%20external%20helper%0A%20problem%20%21&In-Reply-To=%3C47a5c10e-ae64-e366-d6bc-f494836da3a4%40treenet.co.nz%3E"
       TITLE="[squid-users] squid with quota limit using external helper problem !">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep  4 05:10:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016262.html">[squid-users] squid with quota limit using external helper problem !
</A></li>
        <LI>Next message (by thread): <A HREF="016267.html">[squid-users] squid with quota limit using external helper	problem !
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16263">[ date ]</a>
              <a href="thread.html#16263">[ thread ]</a>
              <a href="subject.html#16263">[ subject ]</a>
              <a href="author.html#16263">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/09/17 07:49, --Ahmad-- wrote:
&gt;<i> Hello squid folks .
</I>&gt;<i> 
</I>&gt;<i> I&#8217;m trying to use squid external helper to get quote to ips or users.
</I>&gt;<i> 
</I>&gt;<i> I&#8217;m following the wiki :
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://www.mikealeonetti.com/wiki/index.php?title=Squid_Arms_and_Tentacles:_Bandwidth_quotas">http://www.mikealeonetti.com/wiki/index.php?title=Squid_Arms_and_Tentacles:_Bandwidth_quotas</A>
</I>&gt;<i> 
</I>&gt;<i> i have done everything my side on squid .
</I>&gt;<i> 
</I>&gt;<i> i have tested the connection :
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A>:~# /usr/local/bin/bandwidth_calculate 
</I>&gt;<i> /etc/squid/bandwidth_rules
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A>:~#
</I>&gt;<i> 
</I>&gt;<i> no errors above !
</I>&gt;<i> 
</I>&gt;<i> #######################################
</I>&gt;<i> 
</I>&gt;<i> the issue I&#8217;m not sure if I&#8217;m using squid config file integration 
</I>&gt;<i> correctly .
</I>&gt;<i> 
</I>&gt;<i> here is my squid.conf file :
</I>&gt;<i> 
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> acl localnet src all
</I>
You have defined your LAN to be the entire Internet. Don't do that.

Define localnet to be your actual network ranges.

Use the provided 'all' ACL to refer to things that are allowed/denied to 
everyone online. Most of the time 'all' is unnecessary.

If you expect clients from the general web to access your proxy and some 
access control to apply to them, then simply do not limit those access 
controls with the 'localnet' ACL.


&gt;<i> auth_param basic program /lib/squid/basic_ncsa_auth &#160;/etc/squid/squid_user
</I>&gt;<i> acl ncsa_users proxy_auth REQUIRED
</I>&gt;<i> auth_param basic children 1000
</I>
How many users do expect exactly?

Squid de-duplicated overlapping Basic auth logins so one user can login 
multiple times at once (ie login bursts when a Browser starts up) with 
only one query sent to the auth helper. NCSA is also extremely fast lookups.

If you bumped that up because of the WARNING logged, then please change 
your practices to fix ERRORs before WARNINGs.
* WARNINGs are logged for things Squid can workaround but needs help to 
fix properly,
* ERRORs are things Squid cannot do anything about and need your attention,
* FATALs are things that are absolutely critical to fix if you are going 
to use Squid at all.


&gt;<i> external_acl_type bandwidth_check ttl=60 %SRC /usr/local/bin/bandwidth_check
</I>
The ttl= parameter needs to be 0 for accurate bandwidth results. With 
the above the helper is only checked once per minute, not on every request.
Keep in mind that you are only controlling whether new requests can 
start, and once started they will complete. So regular re-checking is 
required to minimize overages.

NP: negative_ttl= control how often Squid re-checks results from the 
helper once users go over their quota. This is the option that you will 
want to tune with non-0 values to reduce helper load, but also keep it 
low enough not to block clients for too long after their quota renews.


&gt;<i> acl bandwidth_auth external bandwidth_check
</I>&gt;<i> http_access allow localnet bandwidth_auth
</I>&gt;<i> http_access deny &#160;localnet !bandwidth_auth
</I>
The wiki is documenting the above two rules as *alternatives*. I suggest 
you go back and read their descriptions, then pick the one that does 
what you need.


&gt;<i> ###################################################
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> ###########################################
</I>&gt;<i> http_access allow ncsa_users
</I>
This will only login users that broadcast their credentials. It will not 
require credentials from clients, and none of your below rules require 
login to have happened.

Best practice for authentication is to place the rules applying to 
non-authenticate clients first, then have:

   http_access deny !ncsa_users

... then to follow that with any rules applying to authenticated clients.


&gt;<i> ############################
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 &#160; &#160; &#160; &#160; &#160;# http
</I>&gt;<i> acl Safe_ports port 21 &#160; &#160; &#160; &#160; &#160;# ftp
</I>&gt;<i> acl Safe_ports port 443 &#160; &#160; &#160; &#160; # https
</I>&gt;<i> acl Safe_ports port 70 &#160; &#160; &#160; &#160; &#160;# gopher
</I>&gt;<i> acl Safe_ports port 210 &#160; &#160; &#160; &#160; # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 &#160;# unregistered ports
</I>&gt;<i> acl Safe_ports port 280 &#160; &#160; &#160; &#160; # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 &#160; &#160; &#160; &#160; # gss-http
</I>&gt;<i> acl Safe_ports port 591 &#160; &#160; &#160; &#160; # filemaker
</I>&gt;<i> acl Safe_ports port 777 &#160; &#160; &#160; &#160; # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
These Safe_ports and CONNECT rule need to be *above* all of your custom 
rules. Otherwise they will have zero ability to protect your proxy 
against the DoS and hijacking attacks they are supposed to prevent.

&lt;snip&gt;
&gt;<i> 
</I>&gt;<i> here is errors i get :
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2017/09/03 19:32:38 kid1| WARNING: external ACL 'bandwidth_check' queue 
</I>&gt;<i> overload. Request rejected '11.13.209.12'.
</I>&gt;<i> 2017/09/03 19:38:31 kid1| WARNING: external ACL 'bandwidth_check' queue 
</I>&gt;<i> overload. Request rejected '11.13.209.12'.
</I>&gt;<i> 2017/09/03 19:44:46 kid1| WARNING: external ACL 'bandwidth_check' queue 
</I>&gt;<i> overload. Request rejected '148.161.111.42'.
</I>&gt;<i> 2017/09/03 19:44:47 kid1| WARNING: external ACL 'bandwidth_check' queue 
</I>&gt;<i> overload. Request rejected '148.161.111.42&#8217;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> but I&#8217;m sure 100 % that the ips above not blacklisted bec i check them 
</I>&gt;<i> over the helper :
</I>
Please re-read the WARNING message.

IPs are *not* being rejected because they are listed. They are being 
rejected because the helper lookup queue is overloaded and no OK is 
received.

&gt;<i> 
</I>&gt;<i> here is squid when it run :
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A>:~# tailf /var/log/squid/cache.log
</I>&gt;<i> 2017/09/03 19:32:33 kid1| ERROR: Failed to create helper child read FD: 
</I>&gt;<i> TCP [::1]
</I>
Fix that ERROR. The WARNING's about the helper and ACL checking are all 
side effects of there not actually being a helper running.

There are several ways to do that:

1) fix the helpers IPv6 support. It seems not to have any, or if it does 
is somehow still only using the IPv4-only address of localhost. Squid is 
trying to contact it over an IPv6-v4-mapped address for localhost.


2) add the 'ipv4' option to your external_acl_type, to make Squid 
temporarily be IPv4-only when talking to this helper.

While (2) is very tempting and easy, you will probably find that an 
IPv4-only helper like this has errors when it gets told the IP address 
of an IPv6 client. So (1) is the better option and I see the wiki page 
author goes on about being happy to fix problem with their helper - just 
get in touch.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016262.html">[squid-users] squid with quota limit using external helper problem !
</A></li>
	<LI>Next message (by thread): <A HREF="016267.html">[squid-users] squid with quota limit using external helper	problem !
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16263">[ date ]</a>
              <a href="thread.html#16263">[ thread ]</a>
              <a href="subject.html#16263">[ subject ]</a>
              <a href="author.html#16263">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
