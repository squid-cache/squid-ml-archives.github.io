<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid with quota limit using external helper	problem !
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20quota%20limit%20using%20external%20helper%0A%09problem%20%21&In-Reply-To=%3CAED32C3A-FE19-48C6-B0D9-6803D88DF0EA%40netstream.ps%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016263.html">
   <LINK REL="Next"  HREF="016271.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid with quota limit using external helper	problem !</H1>
    <B>--Ahmad--</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20with%20quota%20limit%20using%20external%20helper%0A%09problem%20%21&In-Reply-To=%3CAED32C3A-FE19-48C6-B0D9-6803D88DF0EA%40netstream.ps%3E"
       TITLE="[squid-users] squid with quota limit using external helper	problem !">ahmed.zaeem at netstream.ps
       </A><BR>
    <I>Mon Sep  4 09:38:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016263.html">[squid-users] squid with quota limit using external helper problem !
</A></li>
        <LI>Next message (by thread): <A HREF="016271.html">[squid-users] squid with quota limit using external helper problem !
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16267">[ date ]</a>
              <a href="thread.html#16267">[ thread ]</a>
              <a href="subject.html#16267">[ subject ]</a>
              <a href="author.html#16267">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi amos , thanks for the kind response .

i denied to rebuild squid without IPV6 support and seems now no error in helper .


i just curious to know about the auth directors in squid how should i arrange it :

acl localnet src all

auth_param basic program /lib/squid/basic_ncsa_auth  /etc/squid/squid_user
acl ncsa_users proxy_auth REQUIRED
auth_param basic children 1000

external_acl_type bandwidth_check ttl=0 %SRC /usr/local/bin/bandwidth_check
acl bandwidth_auth external bandwidth_check
http_access allow localnet bandwidth_auth
http_access deny  localnet !bandwidth_auth
###################################################
http_access allow ncsa_users


is above correct sequence to block any user exceeded quota ?
also should i use  
external_acl_type bandwidth_check ttl=0 %SRC /usr/local/bin/bandwidth_check

or

external_acl_type bandwidth_check ttl=0 %SRC %LOGIN /usr/local/bin/bandwidth_check

or 

external_acl_type bandwidth_check ttl=0  %EXT_USER /usr/local/bin/bandwidth_check


thanks amos in advance 
&gt;<i> On Sep 4, 2017, at 8:10 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 04/09/17 07:49, --Ahmad-- wrote:
</I>&gt;&gt;<i> Hello squid folks .
</I>&gt;&gt;<i> I&#8217;m trying to use squid external helper to get quote to ips or users.
</I>&gt;&gt;<i> I&#8217;m following the wiki :
</I>&gt;&gt;<i> <A HREF="http://www.mikealeonetti.com/wiki/index.php?title=Squid_Arms_and_Tentacles:_Bandwidth_quotas">http://www.mikealeonetti.com/wiki/index.php?title=Squid_Arms_and_Tentacles:_Bandwidth_quotas</A>
</I>&gt;&gt;<i> i have done everything my side on squid .
</I>&gt;&gt;<i> i have tested the connection :
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A>:~# /usr/local/bin/bandwidth_calculate /etc/squid/bandwidth_rules
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A>:~#
</I>&gt;&gt;<i> no errors above !
</I>&gt;&gt;<i> #######################################
</I>&gt;&gt;<i> the issue I&#8217;m not sure if I&#8217;m using squid config file integration correctly .
</I>&gt;&gt;<i> here is my squid.conf file :
</I>&gt;&gt;<i> dns_v4_first on
</I>&gt;&gt;<i> acl localnet src all
</I>&gt;<i> 
</I>&gt;<i> You have defined your LAN to be the entire Internet. Don't do that.
</I>&gt;<i> 
</I>&gt;<i> Define localnet to be your actual network ranges.
</I>&gt;<i> 
</I>&gt;<i> Use the provided 'all' ACL to refer to things that are allowed/denied to everyone online. Most of the time 'all' is unnecessary.
</I>&gt;<i> 
</I>&gt;<i> If you expect clients from the general web to access your proxy and some access control to apply to them, then simply do not limit those access controls with the 'localnet' ACL.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> auth_param basic program /lib/squid/basic_ncsa_auth  /etc/squid/squid_user
</I>&gt;&gt;<i> acl ncsa_users proxy_auth REQUIRED
</I>&gt;&gt;<i> auth_param basic children 1000
</I>&gt;<i> 
</I>&gt;<i> How many users do expect exactly?
</I>&gt;<i> 
</I>&gt;<i> Squid de-duplicated overlapping Basic auth logins so one user can login multiple times at once (ie login bursts when a Browser starts up) with only one query sent to the auth helper. NCSA is also extremely fast lookups.
</I>&gt;<i> 
</I>&gt;<i> If you bumped that up because of the WARNING logged, then please change your practices to fix ERRORs before WARNINGs.
</I>&gt;<i> * WARNINGs are logged for things Squid can workaround but needs help to fix properly,
</I>&gt;<i> * ERRORs are things Squid cannot do anything about and need your attention,
</I>&gt;<i> * FATALs are things that are absolutely critical to fix if you are going to use Squid at all.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> external_acl_type bandwidth_check ttl=60 %SRC /usr/local/bin/bandwidth_check
</I>&gt;<i> 
</I>&gt;<i> The ttl= parameter needs to be 0 for accurate bandwidth results. With the above the helper is only checked once per minute, not on every request.
</I>&gt;<i> Keep in mind that you are only controlling whether new requests can start, and once started they will complete. So regular re-checking is required to minimize overages.
</I>&gt;<i> 
</I>&gt;<i> NP: negative_ttl= control how often Squid re-checks results from the helper once users go over their quota. This is the option that you will want to tune with non-0 values to reduce helper load, but also keep it low enough not to block clients for too long after their quota renews.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> acl bandwidth_auth external bandwidth_check
</I>&gt;&gt;<i> http_access allow localnet bandwidth_auth
</I>&gt;&gt;<i> http_access deny  localnet !bandwidth_auth
</I>&gt;<i> 
</I>&gt;<i> The wiki is documenting the above two rules as *alternatives*. I suggest you go back and read their descriptions, then pick the one that does what you need.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> ###################################################
</I>&gt;&gt;<i> cache_effective_user squid
</I>&gt;&gt;<i> cache_effective_group squid
</I>&gt;&gt;<i> ###########################################
</I>&gt;&gt;<i> http_access allow ncsa_users
</I>&gt;<i> 
</I>&gt;<i> This will only login users that broadcast their credentials. It will not require credentials from clients, and none of your below rules require login to have happened.
</I>&gt;<i> 
</I>&gt;<i> Best practice for authentication is to place the rules applying to non-authenticate clients first, then have:
</I>&gt;<i> 
</I>&gt;<i>  http_access deny !ncsa_users
</I>&gt;<i> 
</I>&gt;<i> ... then to follow that with any rules applying to authenticated clients.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> ############################
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> These Safe_ports and CONNECT rule need to be *above* all of your custom rules. Otherwise they will have zero ability to protect your proxy against the DoS and hijacking attacks they are supposed to prevent.
</I>&gt;<i> 
</I>&gt;<i> &lt;snip&gt;
</I>&gt;&gt;<i> here is errors i get :
</I>&gt;&gt;<i> 2017/09/03 19:32:38 kid1| WARNING: external ACL 'bandwidth_check' queue overload. Request rejected '11.13.209.12'.
</I>&gt;&gt;<i> 2017/09/03 19:38:31 kid1| WARNING: external ACL 'bandwidth_check' queue overload. Request rejected '11.13.209.12'.
</I>&gt;&gt;<i> 2017/09/03 19:44:46 kid1| WARNING: external ACL 'bandwidth_check' queue overload. Request rejected '148.161.111.42'.
</I>&gt;&gt;<i> 2017/09/03 19:44:47 kid1| WARNING: external ACL 'bandwidth_check' queue overload. Request rejected '148.161.111.42&#8217;.
</I>&gt;&gt;<i> but I&#8217;m sure 100 % that the ips above not blacklisted bec i check them over the helper :
</I>&gt;<i> 
</I>&gt;<i> Please re-read the WARNING message.
</I>&gt;<i> 
</I>&gt;<i> IPs are *not* being rejected because they are listed. They are being rejected because the helper lookup queue is overloaded and no OK is received.
</I>&gt;<i> 
</I>&gt;&gt;<i> here is squid when it run :
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at localhost</A>:~# tailf /var/log/squid/cache.log
</I>&gt;&gt;<i> 2017/09/03 19:32:33 kid1| ERROR: Failed to create helper child read FD: TCP [::1]
</I>&gt;<i> 
</I>&gt;<i> Fix that ERROR. The WARNING's about the helper and ACL checking are all side effects of there not actually being a helper running.
</I>&gt;<i> 
</I>&gt;<i> There are several ways to do that:
</I>&gt;<i> 
</I>&gt;<i> 1) fix the helpers IPv6 support. It seems not to have any, or if it does is somehow still only using the IPv4-only address of localhost. Squid is trying to contact it over an IPv6-v4-mapped address for localhost.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2) add the 'ipv4' option to your external_acl_type, to make Squid temporarily be IPv4-only when talking to this helper.
</I>&gt;<i> 
</I>&gt;<i> While (2) is very tempting and easy, you will probably find that an IPv4-only helper like this has errors when it gets told the IP address of an IPv6 client. So (1) is the better option and I see the wiki page author goes on about being happy to fix problem with their helper - just get in touch.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170904/c521352d/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170904/c521352d/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016263.html">[squid-users] squid with quota limit using external helper problem !
</A></li>
	<LI>Next message (by thread): <A HREF="016271.html">[squid-users] squid with quota limit using external helper problem !
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16267">[ date ]</a>
              <a href="thread.html#16267">[ thread ]</a>
              <a href="subject.html#16267">[ subject ]</a>
              <a href="author.html#16267">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
