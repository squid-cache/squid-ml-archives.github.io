<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache config
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20config&In-Reply-To=%3C2a19c613-5cce-b7e4-90e1-9c1b8da25cfe%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016286.html">
   <LINK REL="Next"  HREF="016294.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache config</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache%20config&In-Reply-To=%3C2a19c613-5cce-b7e4-90e1-9c1b8da25cfe%40treenet.co.nz%3E"
       TITLE="[squid-users] cache config">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep  7 11:01:15 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016286.html">[squid-users] cache config
</A></li>
        <LI>Next message (by thread): <A HREF="016294.html">[squid-users] ipcCreate: fork: (12) Cannot allocate memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16291">[ date ]</a>
              <a href="thread.html#16291">[ thread ]</a>
              <a href="subject.html#16291">[ subject ]</a>
              <a href="author.html#16291">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/09/17 01:26, Alex Guti&#233;rrez Mart&#237;nez wrote:
&gt;<i> Hi everyone, i have 100 GB on my cache partition, but squid only use 1.5 
</I>&gt;<i> GB. My internet connection its incredibly slow, any advice on how 
</I>&gt;<i> optimize my connection will be appreciated.
</I>&gt;<i> 
</I>
You are missing details of;
* what Squid version you are using (squid -v output), and
* how much traffic is going through the proxy, and
* roughly how many users this cache is servicing, and
* what HIT rates you are currently achieving, and
* what (the 'info' cache manager report - &quot;squidclient mgr:info&quot; or 
cachemgr.cgi page or <A HREF="http://example.local:3128/squid-internal-mgr/info">http://example.local:3128/squid-internal-mgr/info</A>)


Some things to keep in mind (in no particular order):

* A proxy cache is best for large numbers of clients. The fewer users 
exist the more likely the data is being cached on the client machine 
itself (eg in Browser caches) - an aggregating proxy cache will not 
store much of it unless their traffic is significantly different AND the 
proxy cache is larger than the client caches. As user count grows the 
per-user differences build up and proxy shows more caching benefits.

* Some traffic is simply not cacheable. Cacheability is determined by 
the type of domains and sites being contacted, what they do etc. 
Sometimes traffic is simply not cacheable.

* Caches take time to fill up, the fill rate decreases exponentially. 
Each new object added requires that it has not already been used before. 
It is very likely that your users only visited a small number of sites 
and thus only a small amount of content actually is being used. Again 
the more clients use the proxy the more data differences grow the cache.
  Have you given it enough time for more than a few GB of HTTP traffic 
to go through the proxy?

* HTTPS is not cacheable in its encrypted form. As the Internet drive 
towards HTTPS grows increasingly less content is cacheable without 
performing an MITM on the traffic.


* a 64-bit build of Squid is needed to operate well with more than a few 
GB of data. 'Large file' support does not help much as the size of 
individual files is not he problem, size counters for cache management 
need to be 64-bit.
  1.5GB looks suspiciously like the 32-bit numerical wrap happening.


&gt;<i> This is the configuration of my cache.
</I>&gt;<i> 
</I>&gt;<i> maximum_object_size 300 MB
</I>&gt;<i> cache_dir aufs /var/cache/squid3 1024000 16 256
</I>
The above cache uses just under 1 TB of disk space, not 100 GB.

Try 97280 for a 100GB disk. That is 97% of the drive of cache and 3% bit 
for OS use and temporary oversize object storage.


&gt;<i> cache_mem 256 MB
</I>&gt;<i> cache_store_log /var/cache/squid3/cache_store.log
</I>&gt;<i> coredump_dir /var/cache/squid3/dump
</I>&gt;<i> minimum_expiry_time 600 seconds
</I>
This maybe part of your problem. The larger this value is the more 
likely that dynamic content will *not* be cached.

It is checking whether objects are fresh or stale 600sec in the future 
and only caching the ones that will be fresh at that time. Which is very 
unlikely to be true for any dynamic content.

My recommendation is to remove this from your config file or configure 
it a bit smaller than the default 60sec - but not too much smaller.


&gt;<i> cache_swap_low 87
</I>&gt;<i> cache_swap_high 90
</I>
Raise these back to the default 90-95% thresholds for data purging.
You can do that by removing the directives entirely.

NP: the closer these are to 100% the more cache will be able to be 
filled during normal use. But also the more work Squid will do when 
purging to make space for new stuff - which can slow down all 
transactions underway is one of the transactions need a lot of space.
  It is a slow job tuning these properly and requires the cache to be 
relatively full first.

Remove the duplicate ones below anyway.

&gt;<i> ############################
</I>&gt;<i> client_db off
</I>&gt;<i> offline_mode off
</I>&gt;<i> cache_swap_low 87
</I>&gt;<i> cache_swap_high 90
</I>&gt;<i> cache_replacement_policy heap GDSF
</I>&gt;<i> maximum_object_size_in_memory 128 KB
</I>&gt;<i> chunked_request_body_max_size 4096 KB
</I>&gt;<i> half_closed_clients off
</I>&gt;<i> ############################
</I>&gt;<i> # establecemos los archivos de volcado en /var/cache/squid3/
</I>&gt;<i> coredump_dir /var/cache/squid3/
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 10080 90% 43200 
</I>&gt;<i> override-expire ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 43200 90% 
</I>&gt;<i> 432000 override-expire ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i 
</I>&gt;<i> \.(deb|rpm|exe|zip|tar|tgz|ram|rar|bin|ppt|doc|tiff|pdf)$ 10080 90% 
</I>&gt;<i> 43200 override-expire ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.index.(html|htm)$ 0 40% 10080
</I>&gt;<i> refresh_pattern -i \.(html|htm|css|js)$ 1440 40% 40320
</I>&gt;<i> refresh_pattern . 0 40% 40320
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016286.html">[squid-users] cache config
</A></li>
	<LI>Next message (by thread): <A HREF="016294.html">[squid-users] ipcCreate: fork: (12) Cannot allocate memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16291">[ date ]</a>
              <a href="thread.html#16291">[ thread ]</a>
              <a href="subject.html#16291">[ subject ]</a>
              <a href="author.html#16291">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
