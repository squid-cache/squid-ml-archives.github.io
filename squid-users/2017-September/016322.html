<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid cache takes a break
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20cache%20takes%20a%20break&In-Reply-To=%3C1349ed09-a160-3dce-9a13-cb55e162b2a0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016320.html">
   <LINK REL="Next"  HREF="016347.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid cache takes a break</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20cache%20takes%20a%20break&In-Reply-To=%3C1349ed09-a160-3dce-9a13-cb55e162b2a0%40treenet.co.nz%3E"
       TITLE="[squid-users] squid cache takes a break">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 11 13:34:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016320.html">[squid-users] squid cache takes a break
</A></li>
        <LI>Next message (by thread): <A HREF="016347.html">[squid-users] squid cache takes a break
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16322">[ date ]</a>
              <a href="thread.html#16322">[ thread ]</a>
              <a href="subject.html#16322">[ subject ]</a>
              <a href="author.html#16322">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/09/17 20:49, Vieri wrote:
&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> From: Amos Jeffries
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> a) start fewer helpers at a time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> b) reduce cache_mem.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> c) add concurrency support to the helpers.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So I decreased the startup, idle, cache_mem values:
</I>&gt;<i> 
</I>&gt;<i> # egrep 'startup=|idle=' squid.conf
</I>&gt;<i> external_acl_type bllookup ttl=86400 negative_ttl=86400 children-max=80 children-startup=10 children-idle=3 %URI /opt/custom/scripts/run/scripts/firewall/squid_url_lookup.pl [...]
</I>&gt;<i> sslcrtd_children 128 startup=10 idle=3
</I>&gt;<i> 
</I>&gt;<i> # grep cache_mem squid.conf
</I>&gt;<i> cache_mem 64 MB
</I>&gt;<i> 
</I>&gt;<i> I also set debug_options to &quot;ALL,1 5,9 50,6 51,3 54,9&quot;.
</I>&gt;<i> 
</I>&gt;<i> As far as concurrency is concerned, I never programmed a helper to support this feature.
</I>&gt;<i> If it were to be done in Perl, do you know by any chance if it would require Perl6 &quot;promises&quot; with await/start function calls?
</I>&gt;<i> 
</I>
Don't know the answer to that one sorry. But ...

&gt;<i> Currently, my &quot;bllookup&quot; helper is a simple Perl5 script which reads from standard input like so:
</I>&gt;<i> 
</I>&gt;<i> while( &lt;STDIN&gt; )
</I>&gt;<i> {
</I>&gt;<i> [...lookup URI in a MySQL database and reply accordingly to Squid...]
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> It does not handle the channel-ID field.
</I>
That is all it needs to do to begin with; parse off the numeric value 
from the input line and send it back as prefix on the output line. The 
helper does not need threading or anything particularly special for the 
minimal support.

&gt;<i> 
</I>&gt;<i> I haven't found many Squid concurrency-enabled helper examples out there.
</I>&gt;<i> 
</I>
Nod.

&gt;<i> By the way, I see that Squid defaults to IPv6 for helper communications. I suppose it wouldn't make any real difference if I tried &quot;ipv4&quot; with &quot;external_acl_type&quot;.
</I>
If the helper is running at all without it, then no.

&gt;<i> If I don't get any new info next time Squid slows down to a crawl, I'll probably try ipv4 just for kicks.
</I>&gt;<i> 
</I>&gt;<i> What I still don't get is how long it takes for Squid to get back to work after I do a complete restart (after thoroughly killing all related processes, including helpers). I'm talking more than 5 minutes here...
</I>&gt;<i> If I ever get the same issue again, I understand that I can:
</I>&gt;<i> 
</I>&gt;<i> - stop squid &amp; eventually kill all apparently stalled processes
</I>&gt;<i> 
</I>&gt;<i> - modify squid.conf, and decrease or comment out all *startup= and *idle= options
</I>&gt;<i> 
</I>&gt;<i> - start squid
</I>&gt;<i> 
</I>&gt;<i> At this point, I should expect Squid to be up and serving within a reasonable amount of time, even if I may get squid warnings later on asking me to increase those values.
</I>&gt;<i> Or maybe not, because the Linux kernel might be busy cleaning up the swap space anyway?
</I>
Something along those lines, though the disk cache related things can 
sometimes take a surprisingly long time to complete. It's hard to tell 
these possibilities apart without a trace of some kind to provide clues 
about what is going on during the pause.

&gt;<i> 
</I>&gt;<i> One last thing. I'm running squid 3.5.26. I'll try to upgrade to 3.5.27 asap.
</I>&gt;<i> 
</I>
Nod.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016320.html">[squid-users] squid cache takes a break
</A></li>
	<LI>Next message (by thread): <A HREF="016347.html">[squid-users] squid cache takes a break
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16322">[ date ]</a>
              <a href="thread.html#16322">[ thread ]</a>
              <a href="subject.html#16322">[ subject ]</a>
              <a href="author.html#16322">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
