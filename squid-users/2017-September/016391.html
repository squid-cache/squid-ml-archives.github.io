<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] very slow squid response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20very%20slow%20squid%20response&In-Reply-To=%3CCANqMsrBp00APixTLDMZUg7-1s%2B6-1WOzM9tw8WUrOXRWYSjW3w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016388.html">
   <LINK REL="Next"  HREF="016399.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] very slow squid response</H1>
    <B>Iraj Norouzi</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20very%20slow%20squid%20response&In-Reply-To=%3CCANqMsrBp00APixTLDMZUg7-1s%2B6-1WOzM9tw8WUrOXRWYSjW3w%40mail.gmail.com%3E"
       TITLE="[squid-users] very slow squid response">zeutech at gmail.com
       </A><BR>
    <I>Tue Sep 19 11:54:54 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016388.html">[squid-users] very slow squid response
</A></li>
        <LI>Next message (by thread): <A HREF="016399.html">[squid-users] very slow squid response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16391">[ date ]</a>
              <a href="thread.html#16391">[ thread ]</a>
              <a href="subject.html#16391">[ subject ]</a>
              <a href="author.html#16391">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi Antony
thanks for you reply
&gt;<i> i setup squid on ubuntu and centos
</I>
Why both?
because of test and because i not get the result

&gt;<i> with tproxy and wccp for 6 gb/s traffic
</I>
What hardware are you using for that sort of traffic flow?
i use hp DL360 with 2 6 core processor with 3 GHZ and 64 GB RAM and 1 TB HDD

&gt;<i> but when i try to test squid with 40 mb/s traffic
</I>
How are you generating &quot;40 mb/s traffic&quot;?  I'm assuming that your Internet
connection is 6Gbps as stated above, so how are you restricting this down to
40Mbps for testing?
i redirect one class of ip address with 40 mb/s traffic for test of squid
and i am going decide to redirect whole of traffic to squid after getting
fast browsing

&gt;<i> it response very slow
</I>
Numbers please.
websites load at 2 or 1 second by direct browsing and load at 10 second or
not load by squid

&gt;<i> while when i use direct browsing i can browse websites very fast
</I>
Is the direct traffic still being routed through the Squid server (you say
you're using tproxy, so I assume this is an intercept machine with the
traffic
going through it between client and server)?
no, HTTP traffic redirect to squid by wccp and access-list config on Cisco
ip wccp 80 redirect-list wccp
ip wccp 90 redirect-list wccp_to_inside

ip access-list extended wccp
 remark Permit http access from clients
 permit tcp x.x.x.x 0.0.0.255 any eq www
 deny   ip any any
ip access-list extended wccp_to_inside
 permit tcp any eq www x.x.x.x 0.0.0.255
 deny   ip any any

&gt;<i> i used tcpdump for tracing connections arrive time and there was no
</I>problem,

Arrival time where?  From the origin server to Squid?  From Squid to the
client?  What are you actually measuring?
yes, arriving source packets from clients to squid interface,by time that i
push enter on browser address bar and getting packets on tcpdump immediately

&gt;<i> i used watch -d for tracing packets match by iptables rules and it was ok,
</I>
Please be more specific - what did you measure and what does &quot;OK&quot; mean?
i add rule to iptables for tracing one website packets and i saw them on
kern.log that matched with the rule, so if you need please tell me to send
commands that i used.

ip rule add fwmark 1 lookup 100ip route add local 0.0.0.0/0 dev
enp3s0f0 table 100

iptables -t mangle -A PREROUTING -d $LOCALIP -j ACCEPTiptables -t
mangle -N DIVERTiptables -t mangle -A DIVERT -j MARK --set-mark
1iptables -t mangle -A DIVERT -j ACCEPTiptables -t mangle -A
PREROUTING -p tcp -m socket -j DIVERTiptables -t mangle -A PREROUTING
-p tcp --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129

watch -d iptables -t mangle -vnL

Did you compare with and without Squid in place to see what differs?
no, as i told when i browsing directly it is well and packets not coming to
squid and exit from cisco to internet and arrive to clients from cisco and
because of traffic on cisco i can't enable debugging on it but when i
browse from squid i get latency so i suppose the problem is squid or server
that squid running on it

&gt;<i> i also used iptables trace command for tracing matching iptables rules,
</I>&gt;<i> there was no problem except i had latency on arriving packets on iptables
</I>&gt;<i> rule while tcpdump captured packets fast, it happened when my browsing was
</I>&gt;<i> so slow, at some times that my browsing was fast there was no latency on
</I>&gt;<i> iptables trace log.
</I>
That description is too vague to know exactly what you were measuring and
what
results you got.

iptables -t raw -A PREROUTING -s x.x.x.x -j TRACE

iptables -t raw -A OUTPUT -s x.x.x.x -j TRACE

tailf /var/log/kern.log

tcpdump -e -i enp3s0f0 -d x.x.x.x dst port 80

tcpdump -e -i enp3s0f0 -s x.x.x.x src port 80



&gt;<i> i also used tcp and linux enhancement configurations
</I>
Details?
net.core.wmem_default=524288
net.core.wmem_max=16777216
net.core.rmem_default=524288
net.core.rmem_max=16777216
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_rmem = 66560 524288 16777216
net.ipv4.tcp_wmem = 66560 524288 16777216
net.core.somaxconn=4000
net.ipv4.tcp_timestamps=0
net.ipv4.tcp_sack=0
net.ipv4.tcp_fin_timeout=20
net.ipv4.ip_local_port_range=10240 65000
net.ipv4.tcp_keepalive_time = 900
net.ipv4.tcp_keepalive_intvl = 900
net.ipv4.tcp_keepalive_probes = 9
net.core.somaxconn = 5000
net.core.netdev_max_backlog = 8000
net.ipv4.tcp_max_syn_backlog = 8096
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1

&gt;<i> but nothing happened.
</I>&gt;<i> wccp send packets very well and tcpdump show capturing packets too but
</I>&gt;<i> browsing with squid is very slow.
</I>
Firstly, please define &quot;slow&quot; - do you mean it takes a long time for new web
pages / images / etc to appear (but once they start, they arrive quickly)
browse in 10 second or not browsing, webpages that i browse for first time
or i browse for multiple times
, or do you mean that a continuous stream of data (a &quot;download&quot;) arrives
more
slowly when going through Squid than going direct (and if so, what are the
different speeds)?
no just browsing,

Secondly, what are you trying to achieve with Squid - what is its purpose in
your network?
caching pages and their objects for better internet browsing by clients and
save bandwith.

squid.conf
dns_v4_first on
acl fanava_net src x.x.x.x/32 &lt;<A HREF="http://89.221.82.161/32">http://89.221.82.161/32</A>&gt; # Fanava First
clients range to cache
acl Safe_ports port 80 # http
acl Safe_ports port 280 # http-mgmt
acl Safe_ports port 488 # gss-http
acl Safe_ports port 777 # multiling http
acl CONNECT method CONNECT
http_access allow localhost manager
http_access deny manager
http_access allow localhost
http_access allow fanava_net
http_access deny all
http_port 0.0.0.0:3128
http_port 0.0.0.0:3129 tproxy
cache_mem 50 GB
maximum_object_size_in_memory 100 MB
minimum_object_size 2 KB
maximum_object_size 6 GB
#cache_dir ufs /var/spool/squid 1024000 256 512
cache_swap_low 90
cache_swap_high 92
coredump_dir /var/spool/squid
# Image files
refresh_pattern -i \.(png|gif|jpg|jpeg|bmp|tif|tiff)$ 10080 90% 43200
# Compressed files
refresh_pattern -i \.(zip|rar|tar|gz|tgz|z|arj|lha|lzh|iso|deb|rpm)$ 10080
90% 43200
# Binary files
refresh_pattern -i \.(exe|msi)$ 10080 90% 43200
# Multimedia files
refresh_pattern -i \.(mp3|wav|mid|midi|ram|avi|wmv|mpg|mpeg|mp4|swf|flv|)$
10080 90% 43200
# Document files
refresh_pattern -i \.(pdf|ps|doc|ppt|xls|pps)$ 10080 90% 43200
# HTML patterns
refresh_pattern -i \.index.(html|htm)$ 0 40% 10080
refresh_pattern -i \.default.(html|htm)$ 0 40% 10080
refresh_pattern -i \.(html|htm|css|js)$ 1440 40% 40320
# Default patterns
refresh_pattern ^ftp: 1440 20% 10080
refresh_pattern ^gopher: 1440 0% 1440
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern . 0 20% 4320
refresh_pattern (Release|Packages(.gz)*)$ 0 20% 2880
cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">zeutech at gmail.com</A>
wccp2_router x.x.x.x
wccp_version 2
wccp2_rebuild_wait on
wccp2_forwarding_method 2
wccp2_return_method 2
wccp2_service dynamic 80
wccp2_service_info 80 protocol=tcp flags=src_ip_hash priority=240 ports=80
wccp2_service dynamic 90
wccp2_service_info 90 protocol=tcp flags=dst_ip_hash,ports_source
priority=240 ports=80


*Regards,Iraj Norouzi*


On Tue, Sep 19, 2017 at 3:04 PM, Antony Stone &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Antony.Stone at squid.open.source.it</A>&gt; wrote:

&gt;<i> On Tuesday 19 September 2017 at 11:18:34, Iraj Norouzi wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; hi everybody
</I>&gt;<i> &gt; i setup squid on ubuntu and centos
</I>&gt;<i>
</I>&gt;<i> Why both?
</I>&gt;<i>
</I>&gt;<i> &gt; with tproxy and wccp for 6 gb/s traffic
</I>&gt;<i>
</I>&gt;<i> What hardware are you using for that sort of traffic flow?
</I>&gt;<i>
</I>&gt;<i> &gt; but when i try to test squid with 40 mb/s traffic
</I>&gt;<i>
</I>&gt;<i> How are you generating &quot;40 mb/s traffic&quot;?  I'm assuming that your Internet
</I>&gt;<i> connection is 6Gbps as stated above, so how are you restricting this down
</I>&gt;<i> to
</I>&gt;<i> 40Mbps for testing?
</I>&gt;<i>
</I>&gt;<i> &gt; it response very slow
</I>&gt;<i>
</I>&gt;<i> Numbers please.
</I>&gt;<i>
</I>&gt;<i> &gt; while when i use direct browsing i can browse websites very fast
</I>&gt;<i>
</I>&gt;<i> Is the direct traffic still being routed through the Squid server (you say
</I>&gt;<i> you're using tproxy, so I assume this is an intercept machine with the
</I>&gt;<i> traffic
</I>&gt;<i> going through it between client and server)?
</I>&gt;<i>
</I>&gt;<i> &gt; i used tcpdump for tracing connections arrive time and there was no
</I>&gt;<i> problem,
</I>&gt;<i>
</I>&gt;<i> Arrival time where?  From the origin server to Squid?  From Squid to the
</I>&gt;<i> client?  What are you actually measuring?
</I>&gt;<i>
</I>&gt;<i> &gt; i used watch -d for tracing packets match by iptables rules and it was
</I>&gt;<i> ok,
</I>&gt;<i>
</I>&gt;<i> Please be more specific - what did you measure and what does &quot;OK&quot; mean?
</I>&gt;<i>
</I>&gt;<i> Did you compare with and without Squid in place to see what differs?
</I>&gt;<i>
</I>&gt;<i> &gt; i also used iptables trace command for tracing matching iptables rules,
</I>&gt;<i> &gt; there was no problem except i had latency on arriving packets on iptables
</I>&gt;<i> &gt; rule while tcpdump captured packets fast, it happened when my browsing
</I>&gt;<i> was
</I>&gt;<i> &gt; so slow, at some times that my browsing was fast there was no latency on
</I>&gt;<i> &gt; iptables trace log.
</I>&gt;<i>
</I>&gt;<i> That description is too vague to know exactly what you were measuring and
</I>&gt;<i> what
</I>&gt;<i> results you got.
</I>&gt;<i>
</I>&gt;<i> &gt; i also used tcp and linux enhancement configurations
</I>&gt;<i>
</I>&gt;<i> Details?
</I>&gt;<i>
</I>&gt;<i> &gt; but nothing happened.
</I>&gt;<i> &gt; wccp send packets very well and tcpdump show capturing packets too but
</I>&gt;<i> &gt; browsing with squid is very slow.
</I>&gt;<i>
</I>&gt;<i> Firstly, please define &quot;slow&quot; - do you mean it takes a long time for new
</I>&gt;<i> web
</I>&gt;<i> pages / images / etc to appear (but once they start, they arrive quickly),
</I>&gt;<i> or
</I>&gt;<i> do you mean that a continuous stream of data (a &quot;download&quot;) arrives more
</I>&gt;<i> slowly when going through Squid than going direct (and if so, what are the
</I>&gt;<i> different speeds)?
</I>&gt;<i>
</I>&gt;<i> Secondly, what are you trying to achieve with Squid - what is its purpose
</I>&gt;<i> in
</I>&gt;<i> your network?
</I>&gt;<i>
</I>&gt;<i> &gt; please help me.
</I>&gt;<i>
</I>&gt;<i> Please help us - give us more details about the hardware you're running
</I>&gt;<i> this
</I>&gt;<i> on, the version of Squid you're using, what WCCP routing / filtering you're
</I>&gt;<i> doing, the measurements you've made and the results you got.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Antony.
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> We all get the same amount of time - twenty-four hours per day.
</I>&gt;<i> How you use it is up to you.
</I>&gt;<i>
</I>&gt;<i>                                                    Please reply to the
</I>&gt;<i> list;
</I>&gt;<i>                                                          please *don't* CC
</I>&gt;<i> me.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20170919/33a30762/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20170919/33a30762/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016388.html">[squid-users] very slow squid response
</A></li>
	<LI>Next message (by thread): <A HREF="016399.html">[squid-users] very slow squid response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16391">[ date ]</a>
              <a href="thread.html#16391">[ thread ]</a>
              <a href="subject.html#16391">[ subject ]</a>
              <a href="author.html#16391">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
