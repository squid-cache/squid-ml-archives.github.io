<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] very slow squid response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20very%20slow%20squid%20response&In-Reply-To=%3C8e688a15-cd29-4fdc-c1c0-335d5887f24e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016391.html">
   <LINK REL="Next"  HREF="016389.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] very slow squid response</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20very%20slow%20squid%20response&In-Reply-To=%3C8e688a15-cd29-4fdc-c1c0-335d5887f24e%40treenet.co.nz%3E"
       TITLE="[squid-users] very slow squid response">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep 19 15:02:23 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016391.html">[squid-users] very slow squid response
</A></li>
        <LI>Next message (by thread): <A HREF="016389.html">[squid-users] Fwd: Re:  very slow squid response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16399">[ date ]</a>
              <a href="thread.html#16399">[ thread ]</a>
              <a href="subject.html#16399">[ subject ]</a>
              <a href="author.html#16399">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/09/17 23:54, Iraj Norouzi wrote:
&gt;<i> hi Antony
</I>&gt;<i> thanks for you reply
</I>&gt;&gt;<i> i setup squid on ubuntu and centos
</I>&gt;<i> 
</I>&gt;<i> Why both?
</I>&gt;<i> because of test and because i not get the result
</I>&gt;<i> 
</I>&gt;&gt;<i> with tproxy and wccp for 6 gb/s traffic
</I>&gt;<i> 
</I>&gt;<i> What hardware are you using for that sort of traffic flow?
</I>&gt;<i> i use hp DL360 with 2 6 core processor with 3 GHZ and 64 GB RAM and 1 TB HDD
</I>&gt;<i> 
</I>&gt;&gt;<i> but when i try to test squid with 40 mb/s traffic
</I>&gt;<i> 
</I>&gt;<i> How are you generating &quot;40 mb/s traffic&quot;?&#160; I'm assuming that your Internet
</I>&gt;<i> connection is 6Gbps as stated above, so how are you restricting this down to
</I>&gt;<i> 40Mbps for testing?
</I>&gt;<i> i redirect one class of ip address with 40 mb/s traffic for test of 
</I>&gt;<i> squid and i am going decide to redirect whole of traffic to squid after 
</I>&gt;<i> getting fast browsing
</I>&gt;<i> 
</I>
Squid is designed to optimize and reduce *bandwidth*. &quot;fast browsing&quot; is 
just a nice side effect of caching. It is a mistake to think that Squid 
will always produce faster browsing.

This is especially true during the initial cache warm-up period where 
DNS and HTTP objects are being fetched for the first time. Speed can 
only come from future fetches being reduced by the cache.

So when you are testing for speed with real traffic make sure there has 
been at least a few hrs for the caches to warm up.

Since you are testing with RAM-only caching right now be aware that 
every time you restart Squid *all* its caches (for all data types) get 
erased back to &quot;cold&quot;/empty.


&gt;&gt;<i> it response very slow
</I>&gt;<i> 
</I>&gt;<i> Numbers please.
</I>&gt;<i> websites load at 2 or 1 second by direct browsing and load at 10 second 
</I>&gt;<i> or not load by squid
</I>&gt;<i> 
</I>&gt;&gt;<i> while when i use direct browsing i can browse websites very fast
</I>&gt;<i> 
</I>&gt;<i> Is the direct traffic still being routed through the Squid server (you say
</I>&gt;<i> you're using tproxy, so I assume this is an intercept machine with the 
</I>&gt;<i> traffic
</I>&gt;<i> going through it between client and server)?
</I>&gt;<i> no, HTTP traffic redirect to squid by wccp and access-list config on Cisco
</I>
Cisco is tunneling the packets with WCCP to the Squid machine, which is 
intercepting the traffic with TPROXY.

So actually &quot;yes&quot;, if not something would be terribly broken in your 
WCCP and TPROXY setup.


&gt;<i> ip wccp 80 redirect-list wccp
</I>&gt;<i> ip wccp 90 redirect-list wccp_to_inside
</I>&gt;<i> 
</I>&gt;<i> ip access-list extended wccp
</I>&gt;<i>  &#160;remark Permit http access from clients
</I>&gt;<i>  &#160;permit tcp x.x.x.x 0.0.0.255 any eq www
</I>&gt;<i>  &#160;deny &#160; ip any any
</I>&gt;<i> ip access-list extended wccp_to_inside
</I>&gt;<i>  &#160;permit tcp any eq www x.x.x.x 0.0.0.255
</I>&gt;<i>  &#160;deny &#160; ip any any
</I>&gt;<i> 
</I>&gt;&gt;<i> i used tcpdump for tracing connections arrive time and there was no problem,
</I>&gt;<i> 
</I>&gt;<i> Arrival time where?&#160; From the origin server to Squid?&#160; From Squid to the
</I>&gt;<i> client?&#160; What are you actually measuring?
</I>&gt;<i> yes, arriving source packets from clients to squid interface,by time 
</I>&gt;<i> that i push enter on browser address bar and getting packets on tcpdump 
</I>&gt;<i> immediately
</I>
Packets arriving at Squid from the client is only the first ~1% of 
things that are going on. It would be a big problem if they took 
anything more than a few ms to arrive.

Once the packets arrive there are DNS lookups to do. Delay in DNS 
lookups is the most common cause of overall delays.

Then there is HTTP processing to find a source for the response. If the 
request has never been seen before that means a fair amount of logic to 
select potential upstream servers and attempt connections to them (maybe 
several or even all of them).

Then the server request has to be generated, and wait for a response.
Only when that server response comes back can stuff for the client 
response start to happen.

When the cache is involved the total time could be under 1ms, or 
somewhat around 50ms. If there are lots of server things to do the time 
can be hundreds of ms.


&gt;<i> 
</I>&gt;&gt;<i> i used watch -d for tracing packets match by iptables rules and it was ok,
</I>&gt;<i> 
</I>&gt;<i> Please be more specific - what did you measure and what does &quot;OK&quot; mean?
</I>&gt;<i> i add rule to iptables for tracing one website packets and i saw them on 
</I>&gt;<i> kern.log that matched with the rule, so if you need please tell me to 
</I>&gt;<i> send commands that i used.
</I>
Which packets. As I detailed above, there are a minimum of 2 TCP 
connections involved with delivering a MISS object (client-&gt;Squid, and 
Squid-&gt;server) potentially many more if there are network issues 
connecting to server(s).


&gt;<i> 
</I>&gt;<i> ip rule add fwmark 1 lookup 100 ip route add local 0.0.0.0/0 
</I>&gt;<i> &lt;<A HREF="http://0.0.0.0/0">http://0.0.0.0/0</A>&gt; dev enp3s0f0 table 100
</I>&gt;<i> 
</I>&gt;<i> iptables -t mangle -A PREROUTING -d $LOCALIP -j ACCEPT
</I>
You also need a rule before the above one which blocks traffic to
   &quot;-d $LOCALIP -p 3129 -j REJECT&quot;

&gt;<i> iptables -t 
</I>&gt;<i> mangle -N DIVERT iptables -t mangle -A DIVERT -j MARK --set-mark 1 
</I>&gt;<i> iptables -t mangle -A DIVERT -j ACCEPT iptables -t mangle -A PREROUTING 
</I>&gt;<i> -p tcp -m socket -j DIVERT iptables -t mangle -A PREROUTING -p tcp 
</I>&gt;<i> --dport 80 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 3129
</I>&gt;<i> 
</I>&gt;<i> watch -d iptables -t mangle -vnL
</I>&gt;<i> 
</I>&gt;<i> Did you compare with and without Squid in place to see what differs?
</I>&gt;<i> no, as i told when i browsing directly it is well and packets not coming 
</I>&gt;<i> to squid and exit from cisco to internet and arrive to clients from 
</I>&gt;<i> cisco and because of traffic on cisco i can't enable debugging on it but 
</I>&gt;<i> when i browse from squid i get latency so i suppose the problem is squid 
</I>&gt;<i> or server that squid running on it
</I>
Your test is incomplete.

To eliminate WCCP and routing issues being the cause of problems you 
need to compare:

A) normal browsing without WCCP  or TPROXY.

B) normal browsing with WCCP tunneling traffic to the Squid machine (no 
Squid running and no TPROXY).

C) normal browsing with WCCP tunneling traffic to the Squid machine 
where TPROXY diverts the traffic into Squid.

If things work any slower at test (B) than test (A) your problem is the 
WCCP + Squid machine setup, not Squid itself.


&gt;<i> 
</I>&gt;&gt;<i> i also used iptables trace command for tracing matching iptables rules,
</I>&gt;&gt;<i> there was no problem except i had latency on arriving packets on iptables
</I>&gt;&gt;<i> rule while tcpdump captured packets fast, it happened when my browsing was
</I>&gt;&gt;<i> so slow, at some times that my browsing was fast there was no latency on
</I>&gt;&gt;<i> iptables trace log.
</I>&gt;<i> 
</I>&gt;<i> That description is too vague to know exactly what you were measuring 
</I>&gt;<i> and what
</I>&gt;<i> results you got.
</I>&gt;<i> 
</I>&gt;<i> iptables -t raw -A PREROUTING -s x.x.x.x -j TRACE
</I>&gt;<i> 
</I>&gt;<i> iptables -t raw -A OUTPUT -s x.x.x.x -j TRACE
</I>&gt;<i> 
</I>&gt;<i> tailf /var/log/kern.log
</I>&gt;<i> 
</I>&gt;<i> tcpdump -e -i enp3s0f0 -d x.x.x.x dst port 80
</I>&gt;<i> 
</I>&gt;<i> tcpdump -e -i enp3s0f0 -s x.x.x.x src port 80
</I>&gt;<i> 
</I>
&quot;and what results you got&quot; ?


&gt;&gt;<i> i also used tcp and linux enhancement configurations
</I>&gt;<i> 
</I>&gt;<i> Details?
</I>&gt;<i> net.core.wmem_default=524288
</I>&gt;<i> net.core.wmem_max=16777216
</I>&gt;<i> net.core.rmem_default=524288
</I>&gt;<i> net.core.rmem_max=16777216
</I>&gt;<i> net.ipv4.tcp_window_scaling = 1
</I>&gt;<i> net.ipv4.tcp_rmem = 66560 524288 16777216
</I>&gt;<i> net.ipv4.tcp_wmem = 66560 524288 16777216
</I>&gt;<i> net.core.somaxconn=4000
</I>&gt;<i> net.ipv4.tcp_timestamps=0
</I>&gt;<i> net.ipv4.tcp_sack=0
</I>&gt;<i> net.ipv4.tcp_fin_timeout=20
</I>&gt;<i> net.ipv4.ip_local_port_range=10240 65000
</I>&gt;<i> net.ipv4.tcp_keepalive_time = 900
</I>&gt;<i> net.ipv4.tcp_keepalive_intvl = 900
</I>&gt;<i> net.ipv4.tcp_keepalive_probes = 9
</I>&gt;<i> net.core.somaxconn = 5000
</I>&gt;<i> net.core.netdev_max_backlog = 8000
</I>&gt;<i> net.ipv4.tcp_max_syn_backlog = 8096
</I>&gt;<i> net.ipv4.tcp_slow_start_after_idle = 0
</I>&gt;<i> net.ipv4.tcp_tw_reuse = 1
</I>&gt;<i> 
</I>

Okay, so no improvement with those means they were not useful, please 
ensure they are back at defaults so as not to add problems to other 
experimental changes.


&gt;&gt;<i> but nothing happened.
</I>&gt;&gt;<i> wccp send packets very well and tcpdump show capturing packets too but
</I>&gt;&gt;<i> browsing with squid is very slow.
</I>&gt;<i> 
</I>&gt;<i> Firstly, please define &quot;slow&quot; - do you mean it takes a long time for new web
</I>&gt;<i> pages / images / etc to appear (but once they start, they arrive quickly)
</I>
 &gt;&gt; Iraj:
&gt;<i> browse in 10 second or not browsing, webpages that i browse for first 
</I>&gt;<i> time or i browse for multiple times
</I>
For that sort of delay:

* check the DNS response times for lookups made by the Squid machine. 
The details of Squid's lookups can be found in the &quot;idns&quot; cache manager 
report.

*


 &gt;&gt; Antony:
&gt;<i> , or do you mean that a continuous stream of data (a &quot;download&quot;) arrives 
</I>&gt;<i> more
</I>&gt;<i> slowly when going through Squid than going direct (and if so, what are the
</I>&gt;<i> different speeds)?
</I>
 &gt;&gt; Iraj:
&gt;<i> no just browsing,
</I>&gt;<i> 
</I>
 &gt;&gt; Antony:
&gt;<i> Secondly, what are you trying to achieve with Squid - what is its purpose in
</I>&gt;<i> your network?
</I>
 &gt;&gt; Iraj:
&gt;<i> caching pages and their objects for better internet browsing by clients 
</I>&gt;<i> and save bandwith.
</I>&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> acl fanava_net src x.x.x.x/32
</I>&gt;<i> acl Safe_ports port 80# http
</I>&gt;<i> acl Safe_ports port 280# http-mgmt
</I>&gt;<i> acl Safe_ports port 488# gss-http
</I>&gt;<i> acl Safe_ports port 777# multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow fanava_net
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 0.0.0.0:3128
</I>&gt;<i> http_port 0.0.0.0:3129 tproxy
</I>&gt;<i> cache_mem 50 GB
</I>
Does this machine actually have at least 52 GB of free RAM for Squid to use?

&gt;<i> maximum_object_size_in_memory 100 MB
</I>&gt;<i> minimum_object_size 2 KB
</I>&gt;<i> maximum_object_size 6 GB
</I>&gt;<i> #cache_dir ufs /var/spool/squid 1024000 256 512
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 92
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> # Image files
</I>&gt;<i> refresh_pattern -i \.(png|gif|jpg|jpeg|bmp|tif|tiff)$ 10080 90% 43200
</I>&gt;<i> # Compressed files
</I>&gt;<i> refresh_pattern -i \.(zip|rar|tar|gz|tgz|z|arj|lha|lzh|iso|deb|rpm)$ 
</I>&gt;<i> 10080 90% 43200
</I>&gt;<i> # Binary files
</I>&gt;<i> refresh_pattern -i \.(exe|msi)$ 10080 90% 43200
</I>&gt;<i> # Multimedia files
</I>&gt;<i> refresh_pattern -i 
</I>&gt;<i> \.(mp3|wav|mid|midi|ram|avi|wmv|mpg|mpeg|mp4|swf|flv|)$ 10080 90% 43200
</I>&gt;<i> # Document files
</I>&gt;<i> refresh_pattern -i \.(pdf|ps|doc|ppt|xls|pps)$ 10080 90% 43200
</I>&gt;<i> # HTML patterns
</I>&gt;<i> refresh_pattern -i \.index.(html|htm)$ 0 40% 10080
</I>&gt;<i> refresh_pattern -i \.default.(html|htm)$ 0 40% 10080
</I>&gt;<i> refresh_pattern -i \.(html|htm|css|js)$ 1440 40% 40320
</I>&gt;<i> # Default patterns
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> refresh_pattern . 0 20% 4320  # Fanava First 
</I>&gt;<i> clients range to cache
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$ 0 20% 2880
</I>&gt;<i> cache_mgr ******
</I>&gt;<i> wccp2_router x.x.x.x
</I>&gt;<i> wccp_version 2
</I>&gt;<i> wccp2_rebuild_wait on
</I>&gt;<i> wccp2_forwarding_method 2
</I>&gt;<i> wccp2_return_method 2
</I>&gt;<i> wccp2_service dynamic 80
</I>&gt;<i> wccp2_service_info 80 protocol=tcp flags=src_ip_hash priority=240 ports=80
</I>&gt;<i> wccp2_service dynamic 90
</I>&gt;<i> wccp2_service_info 90 protocol=tcp flags=dst_ip_hash,ports_source 
</I>&gt;<i> priority=240 ports=80
</I>&gt;<i> 
</I>&gt;<i> *Regards,
</I>&gt;<i> Iraj Norouzi*
</I>&gt;<i> 
</I>
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016391.html">[squid-users] very slow squid response
</A></li>
	<LI>Next message (by thread): <A HREF="016389.html">[squid-users] Fwd: Re:  very slow squid response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16399">[ date ]</a>
              <a href="thread.html#16399">[ thread ]</a>
              <a href="subject.html#16399">[ subject ]</a>
              <a href="author.html#16399">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
