<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bug: Missing MemObject::storeId value
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bug%3A%20Missing%20MemObject%3A%3AstoreId%20value&In-Reply-To=%3CCANAZdzWzHOqBCP8Put405Xv6i2R1incmv7q6yykY%3D8cqJm4Niw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016434.html">
   <LINK REL="Next"  HREF="016451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bug: Missing MemObject::storeId value</H1>
    <B>Aaron Turner</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bug%3A%20Missing%20MemObject%3A%3AstoreId%20value&In-Reply-To=%3CCANAZdzWzHOqBCP8Put405Xv6i2R1incmv7q6yykY%3D8cqJm4Niw%40mail.gmail.com%3E"
       TITLE="[squid-users] Bug: Missing MemObject::storeId value">synfinatic at gmail.com
       </A><BR>
    <I>Tue Sep 26 04:57:11 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016434.html">[squid-users] Bug: Missing MemObject::storeId value
</A></li>
        <LI>Next message (by thread): <A HREF="016451.html">[squid-users] Bug: Missing MemObject::storeId value
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16435">[ date ]</a>
              <a href="thread.html#16435">[ thread ]</a>
              <a href="subject.html#16435">[ subject ]</a>
              <a href="author.html#16435">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yeah, sounds like I need to prove that ssl-bump is not eating memory
before I start worrying about caching.    Then slowly add features
until I find the smoking gun and focus on that.

I'm curious, does anyone have a suggestion of what modern high traffic
volume squid deployments look like? Seems like lots of the suggestions
are a bit out dated.  I'm trying to go with the KISS principle and not
do any fancy ICP/etc or multi-layer proxy config since that seems much
more difficult to deploy and benchmark.  Instead we're using haproxy
to have cache affinity across systems.  Obviously this may result in
some hot spotting, but it seems like we'll need enough servers that
hopefully the pain will be distributed.

The reason I'm looking at squid is that I've got a small server farm
of ~850 web clients which will be making ~10M page requests/day.
Right now I'm estimating about 50% of my traffic is SSL so bumping SSL
connections is pretty important.

--
Aaron Turner
<A HREF="https://synfin.net/">https://synfin.net/</A>         Twitter: @synfinatic
My father once told me that respect for the truth comes close to being
the basis for all morality.  &quot;Something cannot emerge from nothing,&quot;
he said.  This is profound thinking if you understand how unstable
&quot;the truth&quot; can be.  -- Frank Herbert, Dune


On Mon, Sep 25, 2017 at 9:21 PM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
&gt;<i> Hey Aaron,
</I>&gt;<i>
</I>&gt;<i> Consider the comments from Amos and Alex first before moving forward.
</I>&gt;<i> And again we need to clear out the current doubt's for both you and us.
</I>&gt;<i> We don't know if the issue is related to rock cache_dir or to squid-cache in general.
</I>&gt;<i> Currently for SMP aware caches the best disk cache is rock but you need to understand that the situation is that disk cache is a second level of caching and not the main goal.
</I>&gt;<i> You first need to make sure that squid works for you and then to make sure rock works good enough for you.
</I>&gt;<i> Also take into account that you actually &quot;all in&quot; for disk caching and it's not clear if you even need all this cache.
</I>&gt;<i> Before you decide that the disk cache is for you and that you really need it start low and aim higher, then in small steps move forward.
</I>&gt;<i> Start with a simple squid with ssl-bump without caching at all, then when you see it's stable enough from basic memory perspective for a period of 24 to 72 hours.
</I>&gt;<i> Then and only then when you see it's stable enough for you and the machine can take the load try to see if adding memory cache into the picture makes sense.
</I>&gt;<i> Check squid with it's default settings of cache_object sizes and try to analyze the cache logs to verify what are the most hot sites and objects that in use of your cache.
</I>&gt;<i> Only when you will have a clear view what is the demand from your cache proxy service you should consider moving forward to start investigating the usage of disk cache(with default cache object sizes).
</I>&gt;<i> Take into account that there is a possibility that squid will write object to the disk cache but will not use then and this is a very good reason to first test and analyze before going all in or out with squid.
</I>&gt;<i> Also start with a small disk cache(10GB max) and only after verifying that indeed the setup is working good enough try to find the right memory and disk cache utilization for your setup.
</I>&gt;<i>
</I>&gt;<i> The above is my recommended recipe for a good and smooth start with squid in production environment.
</I>&gt;<i> You are not the first and probably not the last to receive this recommendation and I believe that some articles and resources that can be fetched from the Internet can miss-lead a Linux system administrator expectation from squid-cache or any cache.
</I>&gt;<i>
</I>&gt;<i> Please test Squid-Cache one step at a time and do not get tempted to try to &quot;cache all&quot; since it's practically not possible.
</I>&gt;<i> Update us as you move forward with your tests.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Aaron Turner [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">synfinatic at gmail.com</A>]
</I>&gt;<i> Sent: Monday, September 25, 2017 22:57
</I>&gt;<i> To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Bug: Missing MemObject::storeId value
</I>&gt;<i>
</I>&gt;<i> So is v4 stable?  I was the impression it was beta?  That said, if v4
</I>&gt;<i> has better memory tuning options then I'm all ears.  Right now I'm
</I>&gt;<i> fighting OOM errors (and the kernel OOM reaper) under sustained load.
</I>&gt;<i> I've come to realize 6GB is way way too much for my 14GB RAM systems,
</I>&gt;<i> but finding even 1GB is too much since each squid process is exceeding
</I>&gt;<i> 4GB.  About to try 500MB now.
</I>&gt;<i>
</I>&gt;<i> I can disable rock cache, but I need some disk cache- is there a better option?
</I>&gt;<i>
</I>&gt;<i> As for haproxy, I actually don't care about the client IP... I'm
</I>&gt;<i> running haproxy locally on the servers where the clients reside.
</I>&gt;<i> Mostly I'm using it for squid failover and cache affinity so I don't
</I>&gt;<i> have to make all my caches peers of each other.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Aaron Turner
</I>&gt;<i> <A HREF="https://synfin.net/">https://synfin.net/</A>         Twitter: @synfinatic
</I>&gt;<i> My father once told me that respect for the truth comes close to being
</I>&gt;<i> the basis for all morality.  &quot;Something cannot emerge from nothing,&quot;
</I>&gt;<i> he said.  This is profound thinking if you understand how unstable
</I>&gt;<i> &quot;the truth&quot; can be.  -- Frank Herbert, Dune
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 25, 2017 at 11:45 AM, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;&gt;<i> Hey Aaron,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Just to clear out the doubt's, what happen when you use squid-cache without rock cache_dir? Is the problem appearing again?
</I>&gt;&gt;<i> Also, there is a possibility of a bug which is related to squid ssl-bump termination code on 3.5.X.
</I>&gt;&gt;<i> Testing 4.0.21 would be the best to understand if the issue is 3.5 local or if it was fixed in 4.X+ but, from my memory I think you will need to adapt your squid.conf ssl_bump configurations.
</I>&gt;&gt;<i> You can get the latest beta and stable binaries from my repo and the beta repo details are at:
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/action/edit/KnowledgeBase/CentOS#Squid_Beta_release">https://wiki.squid-cache.org/action/edit/KnowledgeBase/CentOS#Squid_Beta_release</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, since you are using haproxy in front of squid I would suggest you to use the proxy protocol(v1) which is the best way to pass the source ip addresses to the proxy.
</I>&gt;&gt;<i> I have tested squid to work with the proxy protocol v1 but yet to test v2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All The Bests,
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;<i> Linux System Administrator
</I>&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Aaron Turner
</I>&gt;&gt;<i> Sent: Saturday, September 23, 2017 02:19
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: [squid-users] Bug: Missing MemObject::storeId value
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Version: 3.5.26 on CentOS 7.3 on AWS EC2 m3.xlarge and 2x 100GB EBS
</I>&gt;&gt;<i> volumes for rock cache.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Doing some basic system tests and we're seeing a bunch of errors like:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| Bug: Missing MemObject::storeId value
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| mem_hdr: 0x7f169d0a2a70 nodes.start() 0x7f169c6cc9d0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| mem_hdr: 0x7f169d0a2a70 nodes.finish() 0x7f169dae4e40
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;start_ping: 0.000000
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;inmem_hi: 20209
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;inmem_lo: 0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;nclients: 0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;reply: 0x7f167ee60db0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;request: 0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;logUri:
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;storeId:
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| Bug: Missing MemObject::storeId value
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| mem_hdr: 0x7f16a0388760 nodes.start() 0x7f16a6a4a500
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| mem_hdr: 0x7f16a0388760 nodes.finish() 0x7f16a6a4a4d0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;start_ping: 0.000000
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;inmem_hi: 50265
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;inmem_lo: 0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;nclients: 0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;reply: 0x7f169f83d7d0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;request: 0
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;logUri:
</I>&gt;&gt;<i> 2017/09/22 22:43:15 kid1| MemObject-&gt;storeId:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did some googling and seems like a lot of comments about this with
</I>&gt;&gt;<i> Rock (we're using) and ICP/HTCP (not using).  Curious if this the same
</I>&gt;&gt;<i> bug or something new?  Are there config changes we can make to prevent
</I>&gt;&gt;<i> this (perhaps switching away from rock cache??)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We have a bunch of clients behind haproxy which is load balancing to
</I>&gt;&gt;<i> 4x Squid.  Config of the squids is as:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> external_acl_type client_ip_map_0 %&gt;ha{Our-Client}
</I>&gt;&gt;<i> /usr/lib64/squid/user_loadbalance.py 0 4
</I>&gt;&gt;<i> external_acl_type client_ip_map_1 %&gt;ha{Our-Client}
</I>&gt;&gt;<i> /usr/lib64/squid/user_loadbalance.py 1 4
</I>&gt;&gt;<i> external_acl_type client_ip_map_2 %&gt;ha{Our-Client}
</I>&gt;&gt;<i> /usr/lib64/squid/user_loadbalance.py 2 4
</I>&gt;&gt;<i> external_acl_type client_ip_map_3 %&gt;ha{Our-Client}
</I>&gt;&gt;<i> /usr/lib64/squid/user_loadbalance.py 3 4
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl client_group_0 external client_ip_map_0
</I>&gt;&gt;<i> acl client_group_1 external client_ip_map_1
</I>&gt;&gt;<i> acl client_group_2 external client_ip_map_2
</I>&gt;&gt;<i> acl client_group_3 external client_ip_map_3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow client_group_0
</I>&gt;&gt;<i> http_access allow client_group_1
</I>&gt;&gt;<i> http_access allow client_group_2
</I>&gt;&gt;<i> http_access allow client_group_3
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> tcp_outgoing_address 10.93.2.41 client_group_0
</I>&gt;&gt;<i> tcp_outgoing_address 10.93.2.76 client_group_1
</I>&gt;&gt;<i> tcp_outgoing_address 10.93.2.198 client_group_2
</I>&gt;&gt;<i> tcp_outgoing_address 10.93.3.178 client_group_3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_dir rock /var/lib/squid/cache1 51200
</I>&gt;&gt;<i> cache_dir rock /var/lib/squid/cache2 51200
</I>&gt;&gt;<i> coredump_dir /var/spool/squid
</I>&gt;&gt;<i> maximum_object_size_in_memory 8 MB
</I>&gt;&gt;<i> maximum_object_size 8 MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_mem 6 GB
</I>&gt;&gt;<i> memory_cache_shared on
</I>&gt;&gt;<i> workers 4
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> refresh_pattern . 0 100% 30
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port squid0001:3128 ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=400MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;&gt;<i> http_port localhost:3128
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> request_header_access Our-Client deny all
</I>&gt;&gt;<i> request_header_access Via deny all
</I>&gt;&gt;<i> forwarded_for delete
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> visible_hostname squid0001.lab.company.com
</I>&gt;&gt;<i> logformat adttest %tg %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %&gt;ru %[un %Sh/%&lt;a %mt %ea
</I>&gt;&gt;<i> access_log daemon:/var/log/squid/access.${process_number}.log adttest
</I>&gt;&gt;<i> icon_directory /usr/share/squid/icons
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;&gt;<i> sslcrtd_children 32 startup=2 idle=2
</I>&gt;&gt;<i> sslproxy_session_cache_size 100 MB
</I>&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Aaron Turner
</I>&gt;&gt;<i> <A HREF="https://synfin.net/">https://synfin.net/</A>         Twitter: @synfinatic
</I>&gt;&gt;<i> My father once told me that respect for the truth comes close to being
</I>&gt;&gt;<i> the basis for all morality.  &quot;Something cannot emerge from nothing,&quot;
</I>&gt;&gt;<i> he said.  This is profound thinking if you understand how unstable
</I>&gt;&gt;<i> &quot;the truth&quot; can be.  -- Frank Herbert, Dune
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016434.html">[squid-users] Bug: Missing MemObject::storeId value
</A></li>
	<LI>Next message (by thread): <A HREF="016451.html">[squid-users] Bug: Missing MemObject::storeId value
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16435">[ date ]</a>
              <a href="thread.html#16435">[ thread ]</a>
              <a href="subject.html#16435">[ subject ]</a>
              <a href="author.html#16435">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
