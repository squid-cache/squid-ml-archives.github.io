<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache digest vs ICP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20digest%20vs%20ICP&In-Reply-To=%3C5f025eaa-364e-e742-7532-c25a9575eed6%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016459.html">
   <LINK REL="Next"  HREF="016460.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache digest vs ICP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20digest%20vs%20ICP&In-Reply-To=%3C5f025eaa-364e-e742-7532-c25a9575eed6%40measurement-factory.com%3E"
       TITLE="[squid-users] Cache digest vs ICP">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Sep 27 15:06:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016459.html">[squid-users] Cache digest vs ICP
</A></li>
        <LI>Next message (by thread): <A HREF="016460.html">[squid-users] squid release number and patches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16462">[ date ]</a>
              <a href="thread.html#16462">[ thread ]</a>
              <a href="subject.html#16462">[ subject ]</a>
              <a href="author.html#16462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/27/2017 03:46 AM, Veiko Kukk wrote:

&gt;<i> Siblings are configured with no-proxy keyword to achieve that they don't
</I>&gt;<i> cache what other siblings already have in their cache. 
</I>
I assume that by &quot;no-proxy&quot; you meant &quot;proxy-only&quot;.


&gt;<i> This is to minimize data usage costs from origin servers. 
</I>
The proxy-only option does not minimize the amount of data transmitted
between a proxy and the origin server. It reduces cache duplication
among cache peers.


&gt;<i> So far digest_generation has been set to off and only ICP has been used
</I>&gt;<i> between siblings. Mostly because digest stats had shown many rejects
</I>&gt;<i> (not containing 100% of cache objects) and documentation about digests
</I>&gt;<i> is confusing up to statements that while rebuilding digest, squid will
</I>&gt;<i> stop serving requests.
</I>
Please point me to the location of that statement. IMHO, it is not
confusing but incorrect. Non-SMP Squid stops servicing requests while
rebuilding a cache digest _chunk_, not the entire digest (unless the
digest is configured to have only one chunk, of course). The size if the
chunk is controlled by digest_rebuild_chunk_percentage.

Please note that non-SMP Squid stops servicing other requests when doing
virtually anything -- Squid is not threaded. The reason cache digests
are somewhat &quot;special&quot; in this context is because rebuilding the entire
digest may take a long time for large caches. Squid combats that by
splitting the digest rebuild process into chunks (a misleading term!),
digesting at most digest_rebuild_chunk_percentage of cached objects at a
time.

Cache Digests are not SMP aware (but should be). You may be able to work
around that limitation using SMP macros, but I have not tested that. I
do not remember whether a worker that is not configured to generate a
digest will still look it up in the cache when a peer asks for it.
Hopefully, the worker will do that lookup.


&gt;<i> Digest
</I>&gt;<i> documentation states that it's including based on refresh_pattern. It's
</I>&gt;<i> a problem because to get squid working as we want, we had to use
</I>&gt;<i> offline_mode on.
</I>
If Cache Digests do not honor offline_mode, it is a (staleness
estimation code) bug that should be reported and fixed.

Meanwhile, does refresh_pattern stop working when offline_mode is on? If
not, then can you use refresh_pattern to emulate offline_mode effects
while still using offline_mode?


&gt;<i> * What is the relationship between cache digests and ICP?
</I>
IIRC, none, except the former is checked before the latter.


&gt;<i> If they are active together, how are they used together?
</I>
I have not tested this, but Cache Digests ought to be checked first, and
if they miss, then Squid should proceed to ICP/HTCP/etc. AFAICT, a Cache
Digest miss has no effect on other peer selection algorithms.


&gt;<i> * How are objects added to digest when rebuilding? Does this include lot
</I>&gt;<i> of disk i/o like scanning all cache_dir files or is it based on
</I>&gt;<i> swap.state contents?
</I>
Objects are digested based on the in-RAM cache index. There is no disk
I/O involved until the built digest needs to be stored on disk.


&gt;<i> * How can i see which objects are listed in cache digest?
</I>
A Cache Digest does not list/store object URLs -- it cannot produce a
list of previously digested objects. The only way to find out whether
object X was digested (with some degree of certainty) is to query the
digest for that object X.

I am not aware of any command-line interface for interrogating digests,
but it is certainly possible to build one. Please note that Squid
includes both the URL and the method into the object cache key (which is
what ends up being hashed by the Cache Digests code).


&gt;<i> * Why does sibling false positive result in sending client 504 and not
</I>&gt;<i> trying next sibling or parent?&#160;CD_SIBLING_HIT/192.168.1.52
</I>&gt;<i> TCP_MISS/504. How to achieve proceeding with next cache_peer?
</I>
Sounds like bug #4223 to me:
<A HREF="http://bugs.squid-cache.org/show_bug.cgi?id=4223">http://bugs.squid-cache.org/show_bug.cgi?id=4223</A>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016459.html">[squid-users] Cache digest vs ICP
</A></li>
	<LI>Next message (by thread): <A HREF="016460.html">[squid-users] squid release number and patches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16462">[ date ]</a>
              <a href="thread.html#16462">[ thread ]</a>
              <a href="subject.html#16462">[ subject ]</a>
              <a href="author.html#16462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
