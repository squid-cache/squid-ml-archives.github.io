<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] tuning squid memory (aka avoiding the reaper)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tuning%20squid%20memory%20%28aka%20avoiding%20the%20reaper%29&In-Reply-To=%3CCANAZdzV293R30V4Eex7B99vCJz_5JQ%3D4%2BSiaGD-65GivsQzALw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016488.html">
   <LINK REL="Next"  HREF="016498.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] tuning squid memory (aka avoiding the reaper)</H1>
    <B>Aaron Turner</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tuning%20squid%20memory%20%28aka%20avoiding%20the%20reaper%29&In-Reply-To=%3CCANAZdzV293R30V4Eex7B99vCJz_5JQ%3D4%2BSiaGD-65GivsQzALw%40mail.gmail.com%3E"
       TITLE="[squid-users] tuning squid memory (aka avoiding the reaper)">synfinatic at gmail.com
       </A><BR>
    <I>Fri Sep 29 16:45:19 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016488.html">[squid-users] tuning squid memory (aka avoiding the reaper)
</A></li>
        <LI>Next message (by thread): <A HREF="016498.html">[squid-users] tuning squid memory (aka avoiding the reaper)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16494">[ date ]</a>
              <a href="thread.html#16494">[ thread ]</a>
              <a href="subject.html#16494">[ subject ]</a>
              <a href="author.html#16494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So this is smelling like a mem leak to me.  First after running for a few hours:

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 3188 squid     20   0 3586264 3.175g 1.007g R  63.4 22.2 162:59.38 squid
 3187 squid     20   0 2941332 2.585g 1.005g S  45.5 18.1 129:36.40 squid
 3190 squid     20   0 2641828 2.304g 1.001g R  41.4 16.1 109:49.08 squid
 3189 squid     20   0 2524892 2.182g 0.987g S  42.1 15.3 110:30.96 squid

I configured squid w/ 1GB mem cache, no disk cache, ssl bumping and 4
workers.  Looks like they've all pretty much mapped the 1GB which is
what I'd expect.  However, resident memory is clearly quite high
considering my config.

While this was running I was capturing the output of mgr:mem and
started looking at the numbers.  Now I'm not 100% I understand the
meanings of all the columns, but I also don't see any indication of
what is using all that resident memory.

I've grabbed a few of the mgr:mem output spanning the test and
uploaded them here since I hate sending attachments to lists:

<A HREF="https://synfin.net/misc/watch_share.tar.gz">https://synfin.net/misc/watch_share.tar.gz</A>
--
Aaron Turner
<A HREF="https://synfin.net/">https://synfin.net/</A>         Twitter: @synfinatic
My father once told me that respect for the truth comes close to being
the basis for all morality.  &quot;Something cannot emerge from nothing,&quot;
he said.  This is profound thinking if you understand how unstable
&quot;the truth&quot; can be.  -- Frank Herbert, Dune


On Thu, Sep 28, 2017 at 10:05 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i> On 29/09/17 12:35, Aaron Turner wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ok, i'll work on that.  One other thing, is that if I let it run long
</I>&gt;&gt;<i> enough, squid will crash with errors like the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FATAL: Received Bus Error...dying.
</I>&gt;&gt;<i> 2017/09/28 23:28:09 kid4| Closing HTTP port 10.93.3.4:3128
</I>&gt;&gt;<i> 2017/09/28 23:28:09 kid4| Closing HTTP port 127.0.0.1:3128
</I>&gt;&gt;<i> 2017/09/28 23:28:09 kid4| storeDirWriteCleanLogs: Starting...
</I>&gt;&gt;<i> 2017/09/28 23:28:09 kid4|   Finished.  Wrote 0 entries.
</I>&gt;&gt;<i> 2017/09/28 23:28:09 kid4|   Took 0.00 seconds (  0.00 entries/sec).
</I>&gt;&gt;<i> CPU Usage: 0.541 seconds = 0.466 user + 0.075 sys
</I>&gt;&gt;<i> Maximum Resident Size: 121440 KB
</I>&gt;&gt;<i> Page faults with physical i/o: 0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At first I thought the bus error was hardware, but it's happened on
</I>&gt;&gt;<i> two different EC2 instances now.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes &quot;Bus Error&quot; is definitely hardware. The OS kernel had an error loading
</I>&gt;<i> some data from RAM into the CPU or something along those lines.
</I>&gt;<i>
</I>&gt;<i> The only things we can do about it is check that your Squid is up to date
</I>&gt;<i> with the system environment - eg fairly recent Squid version built with the
</I>&gt;<i> OS latest compiler version against its current libc or whatever the
</I>&gt;<i> equivalents of those are for your system. If there are binary level issues
</I>&gt;<i> with the libc interfaces weird things can happen.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016488.html">[squid-users] tuning squid memory (aka avoiding the reaper)
</A></li>
	<LI>Next message (by thread): <A HREF="016498.html">[squid-users] tuning squid memory (aka avoiding the reaper)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16494">[ date ]</a>
              <a href="thread.html#16494">[ thread ]</a>
              <a href="subject.html#16494">[ subject ]</a>
              <a href="author.html#16494">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
