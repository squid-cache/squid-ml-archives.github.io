<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump Failures with Google and Wikipedia
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Failures%20with%20Google%20and%20Wikipedia&In-Reply-To=%3CCA%2BekxPUSMGNS1tr7nztMM2NaJVQgZyOLK8S%2BQZKhsoWBaR8tUA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016503.html">
   <LINK REL="Next"  HREF="016506.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump Failures with Google and Wikipedia</H1>
    <B>Jeffrey Merkey</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Failures%20with%20Google%20and%20Wikipedia&In-Reply-To=%3CCA%2BekxPUSMGNS1tr7nztMM2NaJVQgZyOLK8S%2BQZKhsoWBaR8tUA%40mail.gmail.com%3E"
       TITLE="[squid-users] SSL Bump Failures with Google and Wikipedia">jeffmerkey at gmail.com
       </A><BR>
    <I>Sat Sep 30 21:49:26 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016503.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
        <LI>Next message (by thread): <A HREF="016506.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16505">[ date ]</a>
              <a href="thread.html#16505">[ thread ]</a>
              <a href="subject.html#16505">[ subject ]</a>
              <a href="author.html#16505">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/30/17, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
&gt;<i> Hey Jeffrey,
</I>&gt;<i>
</I>&gt;<i> What happens when you disable the next icap service this way:
</I>&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/cherokee">icap://127.0.0.1:1344/cherokee</A> bypass=0
</I>&gt;<i> adaptation_access service_avi_resp deny all
</I>&gt;<i>
</I>&gt;<i> Is it still the same?
</I>&gt;<i> What I suspect is that the requests are defined to accept gzip compressed
</I>&gt;<i> objects and the icap service is not &quot;gnuzip&quot; them which results in what you
</I>&gt;<i> see.
</I>&gt;<i>
</I>&gt;<i> To make sure that squid is not at fault here try to disable both icap
</I>&gt;<i> services and then add then one at a time and see which of this triangle is
</I>&gt;<i> giving you trouble.
</I>&gt;<i> I enhanced an ICAP library which is written in GoLang at:
</I>&gt;<i> <A HREF="https://github.com/elico/icap">https://github.com/elico/icap</A>
</I>&gt;<i>
</I>&gt;<i> And I have couple examples on how to work with http requests and responses
</I>&gt;<i> at:
</I>&gt;<i> <A HREF="https://github.com/andybalholm/redwood/">https://github.com/andybalholm/redwood/</A>
</I>&gt;<i> <A HREF="https://github.com/andybalholm/redwood/search?utf8=%E2%9C%93&amp;q=gzip&amp;type=">https://github.com/andybalholm/redwood/search?utf8=%E2%9C%93&amp;q=gzip&amp;type=</A>
</I>&gt;<i>
</I>&gt;<i> Let me know if you need help finding out the issue.
</I>&gt;<i>
</I>&gt;<i> All The Bests,
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Linux System Administrator
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;<i> Behalf Of Jeffrey Merkey
</I>&gt;<i> Sent: Saturday, September 30, 2017 23:28
</I>&gt;<i> To: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> Subject: [squid-users] SSL Bump Failures with Google and Wikipedia
</I>&gt;<i>
</I>&gt;<i> Hello All,
</I>&gt;<i>
</I>&gt;<i> I have been working with the squid server and icap and I have been
</I>&gt;<i> running into problems with content cached from google and wikipedia.
</I>&gt;<i> Some sites using https, such as Centos.org work perfectly with ssl
</I>&gt;<i> bumping and I get the decrypted content as html and it's readable.
</I>&gt;<i> Other sites, such as google and wikipedia return what looks like
</I>&gt;<i> encrypted traffic, or perhaps mime encoded data, I am not sure which.
</I>&gt;<i>
</I>&gt;<i> Are there cases where squid will default to direct mode and not
</I>&gt;<i> decrypt the traffic?  I am using the latest squid server 3.5.27.  I
</I>&gt;<i> really would like to get this working with google and wikipedia.  I
</I>&gt;<i> reviewed the page source code from the browser viewer and it looks
</I>&gt;<i> nothing like the data I am getting via the icap server.
</I>&gt;<i>
</I>&gt;<i> Any assistance would be greatly appreciated.
</I>&gt;<i>
</I>&gt;<i> The config I am using is:
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i>
</I>&gt;<i> acl localnet src 127.0.0.1
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> #http_port 3128
</I>&gt;<i>
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> #cache_dir ufs /usr/local/squid/var/cache/squid 100 16 256
</I>&gt;<i>
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /usr/local/squid/var/cache/squid
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i>
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> http_port 3129
</I>&gt;<i>
</I>&gt;<i> # SSL Bump Config
</I>&gt;<i> always_direct allow all
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db
</I>&gt;<i> -M 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i>
</I>&gt;<i> # For squid 3.5.x
</I>&gt;<i> #sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M
</I>&gt;<i> 4MB
</I>&gt;<i>
</I>&gt;<i> # For squid 4.x
</I>&gt;<i> # sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
</I>&gt;<i> /var/lib/ssl_db -M 4MB
</I>&gt;<i>
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> icap_send_client_username on
</I>&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://127.0.0.1:1344/request">icap://127.0.0.1:1344/request</A>
</I>&gt;<i> bypass=1
</I>&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;<i>
</I>&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/cherokee">icap://127.0.0.1:1344/cherokee</A> bypass=0
</I>&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;<i>
</I>&gt;<i> Jeff
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
Eliezer,

Well, you certainly hit the nail on the head.  I added the following
code to check the content being sent to the icap server from squid,
and here is what I found when I check the headers being sent from the
remote web server:

Code to check for content type and encoding received by the icap
server added to c-icap:

    hdrs = ci_http_response_headers(req);
    content_type = ci_headers_value(hdrs, &quot;Content-Type&quot;);
    if (content_type)
       ci_debug_printf(1,&quot;srv_cherokee:  content-type: %s\n&quot;,
                       content_type);

    content_encoding = ci_headers_value(hdrs, &quot;Content-Encoding&quot;);
    if (content_encoding)
       ci_debug_printf(1,&quot;srv_cherokee:  content-encoding: %s\n&quot;,
                       content_encoding);

And the output from scanned pages sent over from squid:

srv_cherokee:  init request 0x7f3dbc008eb0
pool hits:1 allocations: 1
Allocating from objects pool object 5
pool hits:1 allocations: 1
Geting buffer from pool 4096:1
Requested service: cherokee
Read preview data if there are and process request
srv_cherokee:  content-type: text/html; charset=utf-8
srv_cherokee:  content-encoding: gzip         &lt;-- As you stated, I am
getting gzipped data
srv_cherokee:  we expect to read :-1 body data
Allow 204...
Preview handler return allow 204 response
srv_cherokee:  release request 0x7f3dbc008eb0
Store buffer to long pool 4096:1
Storing to objects pool object 5
Log request to access log file /var/log/i-cap_access.log


Wikipedia  at <A HREF="https://en.wikipedia.org/wiki/HTTP_compression">https://en.wikipedia.org/wiki/HTTP_compression</A> describes
the process as:

&quot; ...
   Compression scheme negotiation[edit]
   In most cases, excluding the SDCH, the negotiation is done in two
steps, described in
   RFC 2616:

   1. The web client advertises which compression schemes it supports
by including a list
   of tokens in the HTTP request. For Content-Encoding, the list in a
field called Accept -
   Encoding; for Transfer-Encoding, the field is called TE.

   GET /encrypted-area HTTP/1.1
   Host: www.example.com
   Accept-Encoding: gzip, deflate

   2. If the server supports one or more compression schemes, the
outgoing data may be
   compressed by one or more methods supported by both parties. If
this is the case, the
   server will add a Content-Encoding or Transfer-Encoding field in
the HTTP response with
   the used schemes, separated by commas.

   HTTP/1.1 200 OK
   Date: mon, 26 June 2016 22:38:34 GMT
   Server: Apache/1.3.3.7 (Unix)  (Red-Hat/Linux)
   Last-Modified: Wed, 08 Jan 2003 23:11:55 GMT
   Accept-Ranges: bytes
   Content-Length: 438
   Connection: close
   Content-Type: text/html; charset=UTF-8
   Content-Encoding: gzip

   The web server is by no means obligated to use any compression method &#8211; this
   depends on the internal settings of the web server and also may
depend on the internal
   architecture of the website in question.

   In case of SDCH a dictionary negotiation is also required, which
may involve additional
   steps, like downloading a proper dictionary from .
..&quot;


So, it looks like it is a feature of the browser.  So, is it possible
to have squid gunzip the data or configure the browser not to send the
header  to remove &quot;Accept-Encoding: gzip, deflate&quot; from the request
sent to the remote server telling it to gzip the data?

Thanks

Jeff

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016503.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
	<LI>Next message (by thread): <A HREF="016506.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16505">[ date ]</a>
              <a href="thread.html#16505">[ thread ]</a>
              <a href="subject.html#16505">[ subject ]</a>
              <a href="author.html#16505">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
