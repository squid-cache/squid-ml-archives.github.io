<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump Failures with Google and Wikipedia
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Failures%20with%20Google%20and%20Wikipedia&In-Reply-To=%3CBBEC09F5-1AB6-481E-92C4-F250C51B01D6%40diladele.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016506.html">
   <LINK REL="Next"  HREF="016508.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump Failures with Google and Wikipedia</H1>
    <B>Rafael Akchurin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20Failures%20with%20Google%20and%20Wikipedia&In-Reply-To=%3CBBEC09F5-1AB6-481E-92C4-F250C51B01D6%40diladele.com%3E"
       TITLE="[squid-users] SSL Bump Failures with Google and Wikipedia">rafael.akchurin at diladele.com
       </A><BR>
    <I>Sat Sep 30 22:16:07 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="016506.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
        <LI>Next message (by thread): <A HREF="016508.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16507">[ date ]</a>
              <a href="thread.html#16507">[ thread ]</a>
              <a href="subject.html#16507">[ subject ]</a>
              <a href="author.html#16507">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Jeff,

Do not forget Google and YouTube are now using brotli encoding extensively, not only gzip.

Best regards,
Rafael Akchurin

&gt;<i> Op 30 sep. 2017 om 23:49 heeft Jeffrey Merkey &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jeffmerkey at gmail.com</A>&gt; het volgende geschreven:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 9/30/17, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; wrote:
</I>&gt;&gt;<i> Hey Jeffrey,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> What happens when you disable the next icap service this way:
</I>&gt;&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/cherokee">icap://127.0.0.1:1344/cherokee</A> bypass=0
</I>&gt;&gt;<i> adaptation_access service_avi_resp deny all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Is it still the same?
</I>&gt;&gt;<i> What I suspect is that the requests are defined to accept gzip compressed
</I>&gt;&gt;<i> objects and the icap service is not &quot;gnuzip&quot; them which results in what you
</I>&gt;&gt;<i> see.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> To make sure that squid is not at fault here try to disable both icap
</I>&gt;&gt;<i> services and then add then one at a time and see which of this triangle is
</I>&gt;&gt;<i> giving you trouble.
</I>&gt;&gt;<i> I enhanced an ICAP library which is written in GoLang at:
</I>&gt;&gt;<i> <A HREF="https://github.com/elico/icap">https://github.com/elico/icap</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> And I have couple examples on how to work with http requests and responses
</I>&gt;&gt;<i> at:
</I>&gt;&gt;<i> <A HREF="https://github.com/andybalholm/redwood/">https://github.com/andybalholm/redwood/</A>
</I>&gt;&gt;<i> <A HREF="https://github.com/andybalholm/redwood/search?utf8=%E2%9C%93&amp;q=gzip&amp;type=">https://github.com/andybalholm/redwood/search?utf8=%E2%9C%93&amp;q=gzip&amp;type=</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Let me know if you need help finding out the issue.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> All The Bests,
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;<i> Linux System Administrator
</I>&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On
</I>&gt;&gt;<i> Behalf Of Jeffrey Merkey
</I>&gt;&gt;<i> Sent: Saturday, September 30, 2017 23:28
</I>&gt;&gt;<i> To: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> Subject: [squid-users] SSL Bump Failures with Google and Wikipedia
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Hello All,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I have been working with the squid server and icap and I have been
</I>&gt;&gt;<i> running into problems with content cached from google and wikipedia.
</I>&gt;&gt;<i> Some sites using https, such as Centos.org work perfectly with ssl
</I>&gt;&gt;<i> bumping and I get the decrypted content as html and it's readable.
</I>&gt;&gt;<i> Other sites, such as google and wikipedia return what looks like
</I>&gt;&gt;<i> encrypted traffic, or perhaps mime encoded data, I am not sure which.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Are there cases where squid will default to direct mode and not
</I>&gt;&gt;<i> decrypt the traffic?  I am using the latest squid server 3.5.27.  I
</I>&gt;&gt;<i> really would like to get this working with google and wikipedia.  I
</I>&gt;&gt;<i> reviewed the page source code from the browser viewer and it looks
</I>&gt;&gt;<i> nothing like the data I am getting via the icap server.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Any assistance would be greatly appreciated.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The config I am using is:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # Recommended minimum configuration:
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;&gt;<i> # should be allowed
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl localnet src 127.0.0.1
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly
</I>&gt;&gt;<i> plugged) machines
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;&gt;<i> #http_access deny to_localhost
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;&gt;<i> # from where browsing should be allowed
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # And finally deny all other access to this proxy
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Squid normally listens to port 3128
</I>&gt;&gt;<i> #http_port 3128
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;&gt;<i> #cache_dir ufs /usr/local/squid/var/cache/squid 100 16 256
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;&gt;<i> coredump_dir /usr/local/squid/var/cache/squid
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;&gt;<i> http_port 3129
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # SSL Bump Config
</I>&gt;&gt;<i> always_direct allow all
</I>&gt;&gt;<i> ssl_bump server-first all
</I>&gt;&gt;<i> sslproxy_cert_error deny all
</I>&gt;&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db
</I>&gt;&gt;<i> -M 4MB sslcrtd_children 8 startup=1 idle=1
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # For squid 3.5.x
</I>&gt;&gt;<i> #sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M
</I>&gt;&gt;<i> 4MB
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # For squid 4.x
</I>&gt;&gt;<i> # sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
</I>&gt;&gt;<i> /var/lib/ssl_db -M 4MB
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> icap_enable on
</I>&gt;&gt;<i> icap_send_client_ip on
</I>&gt;&gt;<i> icap_send_client_username on
</I>&gt;&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;<i> icap_preview_size 1024
</I>&gt;&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://127.0.0.1:1344/request">icap://127.0.0.1:1344/request</A>
</I>&gt;&gt;<i> bypass=1
</I>&gt;&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> icap_service service_avi_resp respmod_precache
</I>&gt;&gt;<i> <A HREF="icap://127.0.0.1:1344/cherokee">icap://127.0.0.1:1344/cherokee</A> bypass=0
</I>&gt;&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Jeff
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Eliezer,
</I>&gt;<i> 
</I>&gt;<i> Well, you certainly hit the nail on the head.  I added the following
</I>&gt;<i> code to check the content being sent to the icap server from squid,
</I>&gt;<i> and here is what I found when I check the headers being sent from the
</I>&gt;<i> remote web server:
</I>&gt;<i> 
</I>&gt;<i> Code to check for content type and encoding received by the icap
</I>&gt;<i> server added to c-icap:
</I>&gt;<i> 
</I>&gt;<i>    hdrs = ci_http_response_headers(req);
</I>&gt;<i>    content_type = ci_headers_value(hdrs, &quot;Content-Type&quot;);
</I>&gt;<i>    if (content_type)
</I>&gt;<i>       ci_debug_printf(1,&quot;srv_cherokee:  content-type: %s\n&quot;,
</I>&gt;<i>                       content_type);
</I>&gt;<i> 
</I>&gt;<i>    content_encoding = ci_headers_value(hdrs, &quot;Content-Encoding&quot;);
</I>&gt;<i>    if (content_encoding)
</I>&gt;<i>       ci_debug_printf(1,&quot;srv_cherokee:  content-encoding: %s\n&quot;,
</I>&gt;<i>                       content_encoding);
</I>&gt;<i> 
</I>&gt;<i> And the output from scanned pages sent over from squid:
</I>&gt;<i> 
</I>&gt;<i> srv_cherokee:  init request 0x7f3dbc008eb0
</I>&gt;<i> pool hits:1 allocations: 1
</I>&gt;<i> Allocating from objects pool object 5
</I>&gt;<i> pool hits:1 allocations: 1
</I>&gt;<i> Geting buffer from pool 4096:1
</I>&gt;<i> Requested service: cherokee
</I>&gt;<i> Read preview data if there are and process request
</I>&gt;<i> srv_cherokee:  content-type: text/html; charset=utf-8
</I>&gt;<i> srv_cherokee:  content-encoding: gzip         &lt;-- As you stated, I am
</I>&gt;<i> getting gzipped data
</I>&gt;<i> srv_cherokee:  we expect to read :-1 body data
</I>&gt;<i> Allow 204...
</I>&gt;<i> Preview handler return allow 204 response
</I>&gt;<i> srv_cherokee:  release request 0x7f3dbc008eb0
</I>&gt;<i> Store buffer to long pool 4096:1
</I>&gt;<i> Storing to objects pool object 5
</I>&gt;<i> Log request to access log file /var/log/i-cap_access.log
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Wikipedia  at <A HREF="https://en.wikipedia.org/wiki/HTTP_compression">https://en.wikipedia.org/wiki/HTTP_compression</A> describes
</I>&gt;<i> the process as:
</I>&gt;<i> 
</I>&gt;<i> &quot; ...
</I>&gt;<i>   Compression scheme negotiation[edit]
</I>&gt;<i>   In most cases, excluding the SDCH, the negotiation is done in two
</I>&gt;<i> steps, described in
</I>&gt;<i>   RFC 2616:
</I>&gt;<i> 
</I>&gt;<i>   1. The web client advertises which compression schemes it supports
</I>&gt;<i> by including a list
</I>&gt;<i>   of tokens in the HTTP request. For Content-Encoding, the list in a
</I>&gt;<i> field called Accept -
</I>&gt;<i>   Encoding; for Transfer-Encoding, the field is called TE.
</I>&gt;<i> 
</I>&gt;<i>   GET /encrypted-area HTTP/1.1
</I>&gt;<i>   Host: www.example.com
</I>&gt;<i>   Accept-Encoding: gzip, deflate
</I>&gt;<i> 
</I>&gt;<i>   2. If the server supports one or more compression schemes, the
</I>&gt;<i> outgoing data may be
</I>&gt;<i>   compressed by one or more methods supported by both parties. If
</I>&gt;<i> this is the case, the
</I>&gt;<i>   server will add a Content-Encoding or Transfer-Encoding field in
</I>&gt;<i> the HTTP response with
</I>&gt;<i>   the used schemes, separated by commas.
</I>&gt;<i> 
</I>&gt;<i>   HTTP/1.1 200 OK
</I>&gt;<i>   Date: mon, 26 June 2016 22:38:34 GMT
</I>&gt;<i>   Server: Apache/1.3.3.7 (Unix)  (Red-Hat/Linux)
</I>&gt;<i>   Last-Modified: Wed, 08 Jan 2003 23:11:55 GMT
</I>&gt;<i>   Accept-Ranges: bytes
</I>&gt;<i>   Content-Length: 438
</I>&gt;<i>   Connection: close
</I>&gt;<i>   Content-Type: text/html; charset=UTF-8
</I>&gt;<i>   Content-Encoding: gzip
</I>&gt;<i> 
</I>&gt;<i>   The web server is by no means obligated to use any compression method &#8211; this
</I>&gt;<i>   depends on the internal settings of the web server and also may
</I>&gt;<i> depend on the internal
</I>&gt;<i>   architecture of the website in question.
</I>&gt;<i> 
</I>&gt;<i>   In case of SDCH a dictionary negotiation is also required, which
</I>&gt;<i> may involve additional
</I>&gt;<i>   steps, like downloading a proper dictionary from .
</I>&gt;<i> ..&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So, it looks like it is a feature of the browser.  So, is it possible
</I>&gt;<i> to have squid gunzip the data or configure the browser not to send the
</I>&gt;<i> header  to remove &quot;Accept-Encoding: gzip, deflate&quot; from the request
</I>&gt;<i> sent to the remote server telling it to gzip the data?
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Jeff
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="016506.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
	<LI>Next message (by thread): <A HREF="016508.html">[squid-users] SSL Bump Failures with Google and Wikipedia
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16507">[ date ]</a>
              <a href="thread.html#16507">[ thread ]</a>
              <a href="subject.html#16507">[ subject ]</a>
              <a href="author.html#16507">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
