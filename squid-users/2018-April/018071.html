<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to configure Squid can improve the performance &#65311;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%0A%20%3D%3Futf-8%3Fq%3FHow_to_configure_Squid_can_improve_the_pe%3F%3D%0A%20%3D%3Futf-8%3Fq%3Frformance_%3DEF%3DBC%3D9F%3F%3D&In-Reply-To=%3C61834f48-d792-c5bc-9770-11ab45610281%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018070.html">
   <LINK REL="Next"  HREF="018074.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to configure Squid can improve the performance &#65311;</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%0A%20%3D%3Futf-8%3Fq%3FHow_to_configure_Squid_can_improve_the_pe%3F%3D%0A%20%3D%3Futf-8%3Fq%3Frformance_%3DEF%3DBC%3D9F%3F%3D&In-Reply-To=%3C61834f48-d792-c5bc-9770-11ab45610281%40treenet.co.nz%3E"
       TITLE="[squid-users] How to configure Squid can improve the performance &#65311;">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 11 04:02:02 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018070.html">[squid-users] How to configure Squid can improve the performance &#65311;
</A></li>
        <LI>Next message (by thread): <A HREF="018074.html">[squid-users] IP Lookup Failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18071">[ date ]</a>
              <a href="thread.html#18071">[ thread ]</a>
              <a href="subject.html#18071">[ subject ]</a>
              <a href="author.html#18071">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/04/18 13:48, &#36213; &#20426; wrote:
&gt;<i> Thanks for reading my Email.
</I>&gt;<i> 
</I>&gt;<i> I have two questions:
</I>&gt;<i> 
</I>&gt;<i> My first&#160;question is how&#160;many maximum concurrent connection and the
</I>&gt;<i> maximum new connection of squid are.
</I>&gt;<i> 
</I>

There are 64K ports on an IP address. Your Squid and machine also has a
filedescriptors (FDs) limit it is 64K by default but may be smaller (eg
on Windows it is 256). The smaller of those two numbers is the upper
limit Squid can use.

The ports number is shared between client connections, server
connections and both types of ICAP connections.

The FDs number is shared by the same things as the ports number, as well
as disk files in-use.


You can maybe increase FDs with squid.conf max_filedescriptors, or if
that does not work rebuild Squid with --max-filedescriptors= build
option. Use the ulimit tool on non-Windows machines to increase the OS
limit before starting Squid.



&gt;<i> The second question is how&#160;to configure&#160;Squid&#160;can improve&#160;&#160;the maximum
</I>&gt;<i> concurrent connection,maximum new connection and the&#160;performance .
</I>&gt;<i> 
</I>
If FD available is being your limit you can maybe increase it with
squid.conf max_filedescriptors config option. Of if that does not work
rebuild Squid with --max-filedescriptors= build option. Use the ulimit
tool on non-Windows machines to increase the OS limit before starting Squid.


&gt;<i> I used 3.5.27 version.
</I>&gt;<i> 
</I>&gt;<i> My squid.conf is:
</I>...
&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> acl NCACHE method GET
</I>&gt;<i> store_miss deny all
</I>
The &quot;store_miss deny all&quot; above will be preventing HTTP objects from
caching. That means every request will consume one extra server
connection and ICAP RESPMOD connection.
 Your Squid will need some amount of less connections if things are
caching. So you may want to remove this.


&gt;<i> via off
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128&#160;
</I>&gt;<i> https_port 192.168.XX.XXX:3129 intercept ssl-bump connection-auth=off
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/usr/local/squid/ssl_cert/myCA.pem
</I>&gt;<i> key=/usr/local/squid/ssl_cert/myCA.pem&#160; options=NO_SSLv3,NO_SSLv2
</I>
NP: If cert= and key= are in the same file like this you do not have to
configure key=.

Also, for Squid-3.* add sslflags=NO_DEFAULT_CA on the above port line.
That will free up a lot of memory in OpenSSL for other things it may be
needed for.


&gt;<i> 
</I>&gt;<i> acl ssl_step1 at_step SslBump1
</I>&gt;<i> acl ssl_step2 at_step SslBump2
</I>&gt;<i> acl ssl_step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek ssl_step1
</I>&gt;<i> ssl_bump stare ssl_step2
</I>&gt;<i> ssl_bump bump ssl_step3
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s
</I>&gt;<i> /usr/local/squid/lib/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> 
</I>
ssl_crtd is a little bit unusual for helpers in that it holds up the TLS
handshake which is somewhat critical to do fast. So it is probably best
to use more than startup=1 to reduce Squid memory usage and delays.

As a general &quot;rule of thumb&quot; look at your running proxy and see how many
helpers it is needing to start for your normal traffic. Use that as the
startup= value.



The below cache_dir, object_size, cache_mem, and cache_swap directives
are not useful while you have &quot;store_miss deny all&quot; preventing cache
storage being used.

&gt;<i> #Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> cache_dir ufs /usr/local/squid/var/cache/squid 4096 16 256
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 4096 KB
</I>&gt;<i> maximum_object_size_in_memory 4096 KB
</I>&gt;<i> 
</I>&gt;<i> ipcache_size 1024 MB
</I>&gt;<i> ipcache_low 90
</I>&gt;<i> ipcache_high 95
</I>&gt;<i> fqdncache_size 1024 MB
</I>&gt;<i> 
</I>&gt;<i> cache_mem 2048 MB
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /usr/local/squid/var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> #icap
</I>&gt;<i> icap_enable on
</I>&gt;<i> icap_preview_enable on
</I>&gt;<i> icap_preview_size 1024
</I>&gt;<i> icap_send_client_ip on
</I>&gt;<i> adaptation_meta X-Client-Port &quot;%&gt;p&quot;
</I>&gt;<i> icap_206_enable on
</I>&gt;<i> icap_persistent_connections off
</I>
The above disable of persistence on ICAP connections will be slowing
Squid down since it has to repeat TCP handshakes *twice* for every
single message through the proxy.


&gt;<i> 
</I>&gt;<i> icap_service service_req reqmod_precache 0 <A HREF="icap://192.168.XX.XXX:1344/echo">icap://192.168.XX.XXX:1344/echo</A>
</I>&gt;<i> icap_service service_res respmod_precache 1 <A HREF="icap://192.168.XX.XXX:1344/echo">icap://192.168.XX.XXX:1344/echo</A>
</I>&gt;<i> adaptation_access service_res allow all
</I>&gt;<i> adaptation_access service_req allow all
</I>&gt;<i> 
</I>
You can maybe improve ICAP connection use by tuning some traffic not to
use adaptation. For example CONNECT messages are being SSL-Bump'ed so
they are best not to be adapted.
For example:
  adaptation_access service_req deny CONNECT
  adaptation_access service_req allow all


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018070.html">[squid-users] How to configure Squid can improve the performance &#65311;
</A></li>
	<LI>Next message (by thread): <A HREF="018074.html">[squid-users] IP Lookup Failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18071">[ date ]</a>
              <a href="thread.html#18071">[ thread ]</a>
              <a href="subject.html#18071">[ subject ]</a>
              <a href="author.html#18071">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
