<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Squid - Keepalive connections issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%20-%20Keepalive%20connections%20issue&In-Reply-To=%3Cc2ad41f7-b082-ee57-fc62-db1c4d83cb66%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018141.html">
   <LINK REL="Next"  HREF="018144.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Squid - Keepalive connections issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%20-%20Keepalive%20connections%20issue&In-Reply-To=%3Cc2ad41f7-b082-ee57-fc62-db1c4d83cb66%40treenet.co.nz%3E"
       TITLE="[squid-users] Fwd: Squid - Keepalive connections issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Apr 24 10:01:04 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018141.html">[squid-users] Fwd: Squid - Keepalive connections issue
</A></li>
        <LI>Next message (by thread): <A HREF="018144.html">[squid-users] SSLBump and squid process CPU usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18143">[ date ]</a>
              <a href="thread.html#18143">[ thread ]</a>
              <a href="subject.html#18143">[ subject ]</a>
              <a href="author.html#18143">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/04/18 10:46, Vishali Somaskanthan wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I am working on opening up a persistent connection from Squid -&gt; server.
</I>&gt;<i> i have 2 questions.&#160;
</I>&gt;<i> 
</I>&gt;<i> 1. I find Squid sometimes sends a [FIN, ACK] signal to server as a
</I>&gt;<i> result of which, Squid sends RST and resets the connection. Ideally, for
</I>&gt;<i> persistent connections, this shouldn't be the case. Can somebody help me
</I>&gt;<i> in this regard? Am I missing any other config directives with respect to
</I>&gt;<i> establishing keep-alive connections?? 
</I>
You are missing the part were the server (or something) is sending FIN
to Squid. FIN ACK is the _answer_ responding to a server FIN.

Connections MAY be closed at any time for any reason. It may not even be
the server sending the FIN but some hardware, router or other software
or device along the traffic route.

RST occuring after the FIN ACK is usually a sign that some other things
along the path is probably sending the FIN - not the server itself
unless you have REALLY bad routing and latency problems.
 NP: Experience tells me to start by looking for NAT devices along the
traffic path when this happens. Replacing NAT and old routers usually
makes this type of symptom magically disappear.


&gt;<i> 
</I>&gt;<i> 2. Are there any ways to configure how many number of keep-alive
</I>&gt;<i> connections should be initiated to the server??
</I>
No. The default for keep-alive is simply &quot;all of them&quot;. Anything you can
configure will merely be a reduction in service ability.

&gt;<i> 
</I>&gt;<i> PS:&#160;
</I>&gt;<i> 1. I am using Squid 4
</I>&gt;<i> 2. I have my /server_persistent_connections on/ and
</I>&gt;<i> /client_persistent_connections on/
</I>&gt;<i> 3. Also, I enabled persistent connections for POST requests as well by
</I>&gt;<i> the following lines.
</I>&gt;<i> /acl post_req method POST PUT
</I>&gt;<i> /
</I>&gt;<i> /server_pconn_for_nonretriable allow post_req&#160;/
</I>&gt;<i> 
</I>
That is all you can do. Squid is at the mercy of client and server
software - if *they* do not also use every available HTTP mechanism to
enable keep-alive on messages then eventually they will send a message
that ends the connection. There is nothing Squid can do about that.


What you can do is work with the server to ensure *it* is doing its best
to retain persistence. Make sure that it supports HTTP/1.1 chunked
encoding, AND that it uses that encoding to prevent messages with
unknown-length payloads closing connections.

If the messages to your server are CONNECT messages, discard all hope.
The traffic ceases to even be HTTP right after the tunnel setup is
complete. Tunnels can stay open for long time, but when they are done
they are done absolutely and the entire TCP connection ends as well.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018141.html">[squid-users] Fwd: Squid - Keepalive connections issue
</A></li>
	<LI>Next message (by thread): <A HREF="018144.html">[squid-users] SSLBump and squid process CPU usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18143">[ date ]</a>
              <a href="thread.html#18143">[ thread ]</a>
              <a href="subject.html#18143">[ subject ]</a>
              <a href="author.html#18143">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
