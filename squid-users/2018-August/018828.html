<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid proxy server to log HTTPS traffic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20server%20to%20log%20HTTPS%20traffic&In-Reply-To=%3Cf368e817-5c27-b03a-696e-a31a73b4a378%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018826.html">
   <LINK REL="Next"  HREF="018836.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid proxy server to log HTTPS traffic</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20server%20to%20log%20HTTPS%20traffic&In-Reply-To=%3Cf368e817-5c27-b03a-696e-a31a73b4a378%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid proxy server to log HTTPS traffic">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Aug  2 10:44:13 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018826.html">[squid-users] Squid proxy server to log HTTPS traffic
</A></li>
        <LI>Next message (by thread): <A HREF="018836.html">[squid-users] Squid proxy server to log HTTPS traffic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18828">[ date ]</a>
              <a href="thread.html#18828">[ thread ]</a>
              <a href="subject.html#18828">[ subject ]</a>
              <a href="author.html#18828">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/08/18 19:05, Helen Rai wrote:
&gt;<i> Now what I want to do is log all the web traffic that is requested from
</I>&gt;<i> those devices which are using WiFi.
</I>&gt;<i> I have attached the configuration of squid and Mikrotik which I had done
</I>&gt;<i> for HTTP. (Please note that when I had done this for HTTP, the squid
</I>&gt;<i> wasn't configured with --enable-SSL or --enable-crtd)
</I>&gt;<i> 
</I>
Yes, those options are required to handle the TLS which is part of
HTTPS. HTTP is not encrypted. Or rather: --with-openssl is required

Since you are rebuilding it with these extra options I recommend using
the Squid-4 code from the Debian Sid repository if you can. It contains
much better handling for HTTPS traffic which will be useful later to
avoid non-HTTPS traffic arriving on port 443.


&gt;<i> I had referred some online sites to do for HTTPS but none of them
</I>&gt;<i> worked. Please help if anyone knows how to log all HTTPS request.
</I>&gt;<i> 
</I>&gt;<i> I have attached document regarding the rules applied in Mikrotik and
</I>&gt;<i> squid3 configuration for HTTP.
</I>&gt;<i> 
</I>
Okay. So first thing to do is fix some mistakes in your squid.conf

* &quot;transparent&quot; has long ago been replaced by &quot;intercept&quot;

 http_port 3127 intercept

* remove incomplete / broken config line

 #http_access deny

* remove the first two of these repeated lines:

 http_access allow localhost
 ...
 http_access allow localhost
 http_access allow localhost
 ...

* stop using &quot;localhost&quot; as the ACL name to represent Department-A.
Localhost is a reserved term in networking with a very specific meaning
(different to what you are using it for) which is also baked into Squid
default configuration settings.

Instead use an ACL which names the thing being matched. For example:

 acl Department-A src 10.0.7.0/24


* move your custom setting down below the default security http_access
rules. Those are the deny lines referring to SSL_ports and Safe_ports.

Your http_access lines should now look nice and simple, like this:


 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports

 acl test dstdomain &quot;/etc/squid3/acl/test&quot;
 http_access deny test

 acl Department-A src 10.0.7.0/24
 http_access allow Department-A

 http_access deny all


*** Your HTTP traffic should still be fully operational and doing what
you want after these changes. If not something is broken we need to fix
before continuing.


Second, add the pieces necessary for handling port 443 traffic to
squid.conf.

You *will* need to generate a self-signed CA certificate with the
signing-cert (CA) and and HTTP server properties to use SSL-Bump features.
  But that will only need to be installed on clients machine *if* you go
as far as decrypting the HTTPS traffic or producing errors for clients.
This is where Squid-4 handles TLS far more cleanly than Squid-3.5.


 # A port to receive port 443 traffic from Mikrotik
 https_port 3129 intercept ssl-bump cert=/etc/squid3/your-CA.pem

 ... note the 's' in that directive name. A typo there breaks HTTPS in
confusing ways.


 # SSL-Bump rules to peek at details for logging, then relay the traffic
 acl step1 at_step SslBump1
 ssl_bump peek step1
 ssl_bump splice all

 # Squid-4 can pass any non-HTTPS through or omit the below line to
deliver error pages signed by the your-CA.pem certificate.

  on_unsupported_protocol tunnel


Thirdly, you need to add an entry to the Raspberry Pi NAT rules. Same as
for the port 80 NAT rule that should also exist, but for port 443.

 ** at this point you should be able to test the Raspberry PI is working
for HTTPS by setting a test machine to have the R-Pi IP address as its
gateway and requesting any <A HREF="https://">https://</A> URL in a Browser, or wget, curl,
squidclient etc.


Lastly, when Squid is happily running with all that add to your Mikrotik
config a second line identical to the first one in your attachment -
except that it ends with &quot;dst-port=443&quot;.

 As soon as that line is active in your router the HTTPS traffic should
start arriving and being logged at the Squid.



Please be aware of the following details:

* Do expect to see at least half of HTTPS traffic being CONNECT with
raw-IPs and 0 bytes transferred. That is from the first step of
SSL-Bump'ing. They should be followed by another CONNECT with the TLS
SNI domain name and correct size of data transferred (one-way, to client).


* The SNI is only accurate for honest clients. It can be forged and the
real HTTPS messages be using another domain name hosted on the same
server/CDN network.
 However, to be properly sure that the traffic inside the TLS is going
to the domain the SNI claimed you will have to fully decrypt the traffic
(bump action) and that means installing your CA cert on all clients
machines. Plus configuring dynamic cert generation on the https_port line.
 Start with getting the above non-decrypt setup working before going
near bumping.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018826.html">[squid-users] Squid proxy server to log HTTPS traffic
</A></li>
	<LI>Next message (by thread): <A HREF="018836.html">[squid-users] Squid proxy server to log HTTPS traffic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18828">[ date ]</a>
              <a href="thread.html#18828">[ thread ]</a>
              <a href="subject.html#18828">[ subject ]</a>
              <a href="author.html#18828">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
