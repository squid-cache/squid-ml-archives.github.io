<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxy and TUNNEL to same cache peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxy%20and%20TUNNEL%20to%20same%20cache%20peer&In-Reply-To=%3C7d72b267-88d9-c69c-5a48-3c2a99d8b6dd%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018875.html">
   <LINK REL="Next"  HREF="018882.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxy and TUNNEL to same cache peer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxy%20and%20TUNNEL%20to%20same%20cache%20peer&In-Reply-To=%3C7d72b267-88d9-c69c-5a48-3c2a99d8b6dd%40treenet.co.nz%3E"
       TITLE="[squid-users] Reverse proxy and TUNNEL to same cache peer">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Aug  7 15:37:53 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018875.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
        <LI>Next message (by thread): <A HREF="018882.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18881">[ date ]</a>
              <a href="thread.html#18881">[ thread ]</a>
              <a href="subject.html#18881">[ subject ]</a>
              <a href="author.html#18881">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/08/18 01:04, Hariharan Sethuraman wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> We have our company proxy and this is how the topology is expected to
</I>&gt;<i> look like for the deployment:
</I>&gt;<i> 
</I>&gt;<i> Client
</I>&gt;<i> -------------------squid-host.com---------------------------company-proxy------------Internet
</I>&gt;<i> 
</I>&gt;<i> Now I need to allow reverse proxy(3128) for some request from the client
</I>&gt;<i> and tunnel (3129) as well.
</I>
This reads like you don't understand what either of those terms mean.

Your proxies port 3129 is setup for forward-proxy traffic.

&quot;tunnel&quot; is and action that can be done by clients. Also the term used
to describe the *payload* of a CONNECT message. The action a
forward-proxy performs when receiving a CONNECT is usually to setup a
tunnel CONNECT-ion for non-HTTP use.

Using port 3128 for reverse-proxy traffic is a very bad idea. That port
is a well-known port and also reserved for explicit / forward-proxy traffic.


&gt;<i> 
</I>&gt;<i> Configuration:
</I>&gt;<i> http_port 3128 accel allow-direct
</I>&gt;<i> http_port 3129
</I>&gt;<i> never_direct allow all
</I>&gt;<i> always_direct deny all
</I>&gt;<i> ...
</I>&gt;<i> cache_peer company-proxy parent 80&#160; &#160; &#160; &#160;0&#160; no-query no-digest
</I>&gt;<i> login=PASS originserver
</I>&gt;<i> url_rewrite_access allow all
</I>&gt;<i> url_rewrite_program&#160; /usr/bin/python ./rewriter_program.py
</I>&gt;<i> 
</I>&gt;<i> Usecases:
</I>&gt;<i> 
</I>&gt;<i> 1) Reverse proxy: Now I can successfully get the response for the query
</I>&gt;<i> like curl -X GET <A HREF="http://squid-host.com:3128/microsoftapi/api/something.">http://squid-host.com:3128/microsoftapi/api/something.</A>
</I>&gt;<i> Basically I rewrite URL to <A HREF="https://microsft.com/api/something">https://microsft.com/api/something</A> and
</I>&gt;<i> through company-proxy I get the response successfully from e.g.,
</I>&gt;<i> microsoft.com &lt;<A HREF="http://microsoft.com">http://microsoft.com</A>&gt;.
</I>
Re-writing message URLs across the insecure / secure boundary is a very
bad idea. All Cookies and other things in both message headers and
payload content which are tied to either the TLS or the Origin state
will be broken.

The client thinks it is talking to an insecure server, and the server
thinks it is connected to a secure client. They also have very different
ideas about the Origin scope for stateful security things - especially
when re-writing across domains like this. That means they each believe
different range of actions are valid, and that impacts on what they
expect the other agents behaviour to be in reaction to any given message.


&gt;<i> 
</I>&gt;<i> 2) Tunnel: It fails when the client do a query like curl -x
</I>&gt;<i> <A HREF="http://squid-host.com:3129">http://squid-host.com:3129</A> -X GET <A HREF="https://googlecloudapis.com/api/something">https://googlecloudapis.com/api/something</A>
</I>&gt;<i> &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i> &lt; Server: squid/3.5.20
</I>&gt;<i> &lt; Mime-Version: 1.0
</I>&gt;<i> &lt; Date: Tue, 07 Aug 2018 12:36:07 GMT
</I>&gt;<i> &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &lt; Content-Length: 3879
</I>&gt;<i> &lt; X-Squid-Error: ERR_CANNOT_FORWARD 0
</I>&gt;<i> &lt; Vary: Accept-Language
</I>&gt;<i> &lt; Content-Language: en
</I>&gt;<i> &lt;
</I>&gt;<i> * The requested URL returned error: 503
</I>&gt;<i> * CONNECT phase completed!
</I>&gt;<i> * Connection #0 to host squidhostname.com &lt;<A HREF="http://squidhostname.com">http://squidhostname.com</A>&gt;
</I>&gt;<i> left intact
</I>&gt;<i> Now, if I remove the origin server, the TUNNEL goes through and getting
</I>&gt;<i> the response but the reverse proxy fails.
</I>&gt;<i> 
</I>
Please add the --verbose option to your curl test commands to see what
is actually being sent to the proxy. Then test what your re-writer is
causing to happen on those received URI.

Note that all the re-writer does is change the URI. It does not change
the method or other request details. If it produces an invalid or
unreachable URI there is nothing Squid can do but present the client
with an error.



&gt;<i> Could you let me know how I can handle both tunneling and reverse proxy
</I>&gt;<i> through same cache peer?
</I>
Both are already supported and work without any fancy setup. I think you
are hitting something else which should become clearer when you see what
curl is actually doing.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018875.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
	<LI>Next message (by thread): <A HREF="018882.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18881">[ date ]</a>
              <a href="thread.html#18881">[ thread ]</a>
              <a href="subject.html#18881">[ subject ]</a>
              <a href="author.html#18881">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
