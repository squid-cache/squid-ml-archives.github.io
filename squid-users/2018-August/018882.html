<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxy and TUNNEL to same cache peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxy%20and%20TUNNEL%20to%20same%20cache%20peer&In-Reply-To=%3CCANfnjgJF7TDD3HOkNQsEJP5rHrJvkDKHubs1U1tb4z_wQzAosA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018881.html">
   <LINK REL="Next"  HREF="018884.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxy and TUNNEL to same cache peer</H1>
    <B>Hariharan Sethuraman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxy%20and%20TUNNEL%20to%20same%20cache%20peer&In-Reply-To=%3CCANfnjgJF7TDD3HOkNQsEJP5rHrJvkDKHubs1U1tb4z_wQzAosA%40mail.gmail.com%3E"
       TITLE="[squid-users] Reverse proxy and TUNNEL to same cache peer">srnhari at gmail.com
       </A><BR>
    <I>Tue Aug  7 16:01:27 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018881.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
        <LI>Next message (by thread): <A HREF="018884.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18882">[ date ]</a>
              <a href="thread.html#18882">[ thread ]</a>
              <a href="subject.html#18882">[ subject ]</a>
              <a href="author.html#18882">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos: yes agree that I should have told forward proxy.

When I remove the originserver option from cache_peer, the forward proxy is
working so which means the rewriter is not precluding from happening. Does
that give any clue to us?

Moreover the reverse proxy is in next hop to the client and not in
internet. Time being, we are ok to have insecure channel between client and
squid. Do you have any sample config that that uses a parent proxy to do
both forward/reverse proxy? Or do you see my config is good enough for this
requirement.

On Tue, Aug 7, 2018 at 9:07 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 08/08/18 01:04, Hariharan Sethuraman wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have our company proxy and this is how the topology is expected to
</I>&gt;<i> &gt; look like for the deployment:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Client
</I>&gt;<i> &gt; -------------------squid-host.com---------------------------
</I>&gt;<i> company-proxy------------Internet
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Now I need to allow reverse proxy(3128) for some request from the client
</I>&gt;<i> &gt; and tunnel (3129) as well.
</I>&gt;<i>
</I>&gt;<i> This reads like you don't understand what either of those terms mean.
</I>&gt;<i>
</I>&gt;<i> Your proxies port 3129 is setup for forward-proxy traffic.
</I>&gt;<i>
</I>&gt;<i> &quot;tunnel&quot; is and action that can be done by clients. Also the term used
</I>&gt;<i> to describe the *payload* of a CONNECT message. The action a
</I>&gt;<i> forward-proxy performs when receiving a CONNECT is usually to setup a
</I>&gt;<i> tunnel CONNECT-ion for non-HTTP use.
</I>&gt;<i>
</I>&gt;<i> Using port 3128 for reverse-proxy traffic is a very bad idea. That port
</I>&gt;<i> is a well-known port and also reserved for explicit / forward-proxy
</I>&gt;<i> traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Configuration:
</I>&gt;<i> &gt; http_port 3128 accel allow-direct
</I>&gt;<i> &gt; http_port 3129
</I>&gt;<i> &gt; never_direct allow all
</I>&gt;<i> &gt; always_direct deny all
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt; cache_peer company-proxy parent 80       0  no-query no-digest
</I>&gt;<i> &gt; login=PASS originserver
</I>&gt;<i> &gt; url_rewrite_access allow all
</I>&gt;<i> &gt; url_rewrite_program  /usr/bin/python ./rewriter_program.py
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Usecases:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1) Reverse proxy: Now I can successfully get the response for the query
</I>&gt;<i> &gt; like curl -X GET <A HREF="http://squid-host.com:3128/microsoftapi/api/something.">http://squid-host.com:3128/microsoftapi/api/something.</A>
</I>&gt;<i> &gt; Basically I rewrite URL to <A HREF="https://microsft.com/api/something">https://microsft.com/api/something</A> and
</I>&gt;<i> &gt; through company-proxy I get the response successfully from e.g.,
</I>&gt;<i> &gt; microsoft.com &lt;<A HREF="http://microsoft.com">http://microsoft.com</A>&gt;.
</I>&gt;<i>
</I>&gt;<i> Re-writing message URLs across the insecure / secure boundary is a very
</I>&gt;<i> bad idea. All Cookies and other things in both message headers and
</I>&gt;<i> payload content which are tied to either the TLS or the Origin state
</I>&gt;<i> will be broken.
</I>&gt;<i>
</I>&gt;<i> The client thinks it is talking to an insecure server, and the server
</I>&gt;<i> thinks it is connected to a secure client. They also have very different
</I>&gt;<i> ideas about the Origin scope for stateful security things - especially
</I>&gt;<i> when re-writing across domains like this. That means they each believe
</I>&gt;<i> different range of actions are valid, and that impacts on what they
</I>&gt;<i> expect the other agents behaviour to be in reaction to any given message.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2) Tunnel: It fails when the client do a query like curl -x
</I>&gt;<i> &gt; <A HREF="http://squid-host.com:3129">http://squid-host.com:3129</A> -X GET <A HREF="https://googlecloudapis.com/">https://googlecloudapis.com/</A>
</I>&gt;<i> api/something
</I>&gt;<i> &gt; &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i> &gt; &lt; Server: squid/3.5.20
</I>&gt;<i> &gt; &lt; Mime-Version: 1.0
</I>&gt;<i> &gt; &lt; Date: Tue, 07 Aug 2018 12:36:07 GMT
</I>&gt;<i> &gt; &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &gt; &lt; Content-Length: 3879
</I>&gt;<i> &gt; &lt; X-Squid-Error: ERR_CANNOT_FORWARD 0
</I>&gt;<i> &gt; &lt; Vary: Accept-Language
</I>&gt;<i> &gt; &lt; Content-Language: en
</I>&gt;<i> &gt; &lt;
</I>&gt;<i> &gt; * The requested URL returned error: 503
</I>&gt;<i> &gt; * CONNECT phase completed!
</I>&gt;<i> &gt; * Connection #0 to host squidhostname.com &lt;<A HREF="http://squidhostname.com">http://squidhostname.com</A>&gt;
</I>&gt;<i> &gt; left intact
</I>&gt;<i> &gt; Now, if I remove the origin server, the TUNNEL goes through and getting
</I>&gt;<i> &gt; the response but the reverse proxy fails.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Please add the --verbose option to your curl test commands to see what
</I>&gt;<i> is actually being sent to the proxy. Then test what your re-writer is
</I>&gt;<i> causing to happen on those received URI.
</I>&gt;<i>
</I>&gt;<i> Note that all the re-writer does is change the URI. It does not change
</I>&gt;<i> the method or other request details. If it produces an invalid or
</I>&gt;<i> unreachable URI there is nothing Squid can do but present the client
</I>&gt;<i> with an error.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Could you let me know how I can handle both tunneling and reverse proxy
</I>&gt;<i> &gt; through same cache peer?
</I>&gt;<i>
</I>&gt;<i> Both are already supported and work without any fancy setup. I think you
</I>&gt;<i> are hitting something else which should become clearer when you see what
</I>&gt;<i> curl is actually doing.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180807/3dcb3850/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180807/3dcb3850/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018881.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
	<LI>Next message (by thread): <A HREF="018884.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18882">[ date ]</a>
              <a href="thread.html#18882">[ thread ]</a>
              <a href="subject.html#18882">[ subject ]</a>
              <a href="author.html#18882">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
