<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid returns NONE_ABORTED/000 and high response time but the internet access itself looks okay
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20returns%20NONE_ABORTED/000%20and%20high%20response%0A%20time%20but%20the%20internet%20access%20itself%20looks%20okay&In-Reply-To=%3C09cdc9f8986843869f35c5626820a041%40mbxtoa3.winmail.deshaw.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018890.html">
   <LINK REL="Next"  HREF="018875.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid returns NONE_ABORTED/000 and high response time but the internet access itself looks okay</H1>
    <B>Ahmad, Sarfaraz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20returns%20NONE_ABORTED/000%20and%20high%20response%0A%20time%20but%20the%20internet%20access%20itself%20looks%20okay&In-Reply-To=%3C09cdc9f8986843869f35c5626820a041%40mbxtoa3.winmail.deshaw.com%3E"
       TITLE="[squid-users] Squid returns NONE_ABORTED/000 and high response time but the internet access itself looks okay">Sarfaraz.Ahmad at deshaw.com
       </A><BR>
    <I>Wed Aug  8 16:03:56 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018890.html">[squid-users] Squid returns NONE_ABORTED/000 and high response time but the internet access itself looks okay
</A></li>
        <LI>Next message (by thread): <A HREF="018875.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18903">[ date ]</a>
              <a href="thread.html#18903">[ thread ]</a>
              <a href="subject.html#18903">[ subject ]</a>
              <a href="author.html#18903">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i> As late as it can be done. How late that is depends on your SSL-Bump setup, any ICAP or other changes being made to the fake-CONNECT request, maybe even your cache contents.
</I>All I am doing is peeking at Step1 (Client SNI) and then bumping vast majority of connections, splicing very few. Caching is completely disabled.

&gt;&gt;<i> The client &quot;&lt;ip&gt;&quot; opened a TCP connection to 173.194.142.186:443 - which was intercepted and delivered to this Squid. The client disconnected after 78 seconds.
</I>This doesn't explain why I saw 20+secs for TCP in Chrome dev tools'.  From Chrome's dev tools, it looks like setting up TLS did not take long but setting up TCP surely did.

 &gt;&gt; We know that the server IP:port should be 173.194.142.186:443 because those are the details on the CONNECT message URI. Squid has not gone far enough into the processing of that message to identify that detail.
What would usually be the next step here? Could DNS be involved ?


-----Original Message-----
From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; 
Sent: Tuesday, August 7, 2018 11:14 PM
To: Ahmad, Sarfaraz &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Sarfaraz.Ahmad at deshaw.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid returns NONE_ABORTED/000 and high response time but the internet access itself looks okay

On 08/08/18 05:15, Ahmad, Sarfaraz wrote:
&gt;&gt;&gt;<i> Your guess is wrong. The TCP level setup is only between Squid and the client. It has to have completed before the TLS stuff can begin.
</I>&gt;<i> So when does Squid start setting up the TCP connection with the origin server ? After setting up a TCP connection with client and identifying it to be TLS ?
</I>
As late as it can be done. How late that is depends on your SSL-Bump setup, any ICAP or other changes being made to the fake-CONNECT request, maybe even your cache contents.

Anyhow, there is no sign of a server connection existing. So whatever is happening is one of the early parts of TLS handshake.


&gt;<i> 
</I>&gt;<i> What would this log message likely mean then ? I was reading that as 78477ms was the time it took for Squid to connect to 173.194.142.186 on port 443 and Squid and client(not the origin server) had already established a TCP connection beforehand (while it(squid) tries connecting to the remote server on port 443).
</I>&gt;<i> 1533612202.312  78477 &lt;ip&gt; NONE_ABORTED/000 0 CONNECT 
</I>&gt;<i> 173.194.142.186:443 - HIER_NONE/- -
</I>&gt;<i> 
</I>
The client &quot;&lt;ip&gt;&quot; opened a TCP connection to 173.194.142.186:443 - which was intercepted and delivered to this Squid. The client disconnected after 78 seconds.
 That is all that can be known about what did happen from this log entry.

The list of things which did not (or could not have) happen is longer:

No server connection was made.
No bytes delivered to the client.
 and a lot of other things cannot have happened.


&gt;<i> That would imply two things.
</I>&gt;<i> 1) It took a lot of time for clients to set up a TCP connection with 
</I>&gt;<i> Squid given Chrome's dev tools
</I>
The client-&gt;Squid TCP setup seems to be completed. Either Squid is waiting for TLS handshake from the client to arrive, or something is hung in the processing of the clientHello stages.

NP: the 0-bytes number in the log is how much Squid delivered to the client. There may be some bytes the client delivered to Squid which are not accounted.



&gt;<i> 2) Second, Squid took a while to establish a connection with origin server.
</I>
I don't think Squid got that far. There is no server IP following the &quot;HEIR_NONE/&quot;. The &quot;-&quot; part specifically says there is no known server IP.

We know that the server IP:port should be 173.194.142.186:443 because those are the details on the CONNECT message URI. Squid has not gone far enough into the processing of that message to identify that detail.


&gt;<i> 
</I>&gt;<i> Moreover, my ICAP settings look like this, icap_service localicap 
</I>&gt;<i> reqmod_precache <A HREF="icap://127.0.0.1:1345/reqmod">icap://127.0.0.1:1345/reqmod</A> bypass=on routing=off 
</I>&gt;<i> on-overload=wait
</I>&gt;<i> 
</I>&gt;<i> ICAP would come into the picture only after I see a GET request in the access.log, right?
</I>
ICAP should be passed any HTTP request. Since Squid is handling the CONNECT message the ICAP should be invoked for them as well. I don't recall of it actually is or not.

Also, note that at no point have I confirmed that is is ICAP being the problem (nor ruled it out). You are the one focusing on that possibility. There are other possibilities such as SSL-Bump issues, http_access delays and the like. Even client_delay_pool's may be the problem.


Amos
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018890.html">[squid-users] Squid returns NONE_ABORTED/000 and high response time but the internet access itself looks okay
</A></li>
	<LI>Next message (by thread): <A HREF="018875.html">[squid-users] Reverse proxy and TUNNEL to same cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18903">[ date ]</a>
              <a href="thread.html#18903">[ thread ]</a>
              <a href="subject.html#18903">[ subject ]</a>
              <a href="author.html#18903">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
