<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as reverse proxy for two or more webs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20reverse%20proxy%20for%20two%20or%20more%20webs&In-Reply-To=%3C53cf93d8-0b08-ce56-5467-310c1a8acd3e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018910.html">
   <LINK REL="Next"  HREF="018911.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as reverse proxy for two or more webs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20reverse%20proxy%20for%20two%20or%20more%20webs&In-Reply-To=%3C53cf93d8-0b08-ce56-5467-310c1a8acd3e%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid as reverse proxy for two or more webs">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 10 13:52:22 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018910.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
        <LI>Next message (by thread): <A HREF="018911.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18906">[ date ]</a>
              <a href="thread.html#18906">[ thread ]</a>
              <a href="subject.html#18906">[ subject ]</a>
              <a href="author.html#18906">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/08/18 01:15, erdosain9 wrote:
&gt;<i> Hi to all.
</I>&gt;<i> I was reading several tutorials and I can not find what I'm doing wrong.
</I>&gt;<i> I want to use squid to redirect to these two sites that are both within my
</I>&gt;<i> domain.
</I>&gt;<i> 
</I>&gt;<i> In my internal dns I have declared both servers, with their corresponding
</I>&gt;<i> ips, also squid.
</I>&gt;<i> 
</I>&gt;<i> reverse.mydomain.lan 192.168.1.21 (SQUID)
</I>&gt;<i> 
</I>
So &quot;reverse.mydomain.lan&quot; is the public name which your users/clients
are browsing ...


&gt;<i> php.mydomain.lan 192.168.1.223
</I>&gt;<i> ticket.mydomain.lan 192.168.1.246
</I>
.. and clients never connect to the above directly. So these domains are
never to be accessed by users/clients.

If (as I suspect) the above statements are not true, then your naming is
the first thing that is wrong.

The domain name(s) which your clients access should point to the proxy.
There can be multiple.

&gt;<i> 
</I>&gt;<i> In addition to the internal DNS, I have the / etc / hosts configured with
</I>&gt;<i> these values:
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squidReverse</A> ~]# cat /etc/hosts
</I>&gt;<i> 127.0.0.1   localhost localhost.localdomain localhost4
</I>&gt;<i> localhost4.localdomain4
</I>&gt;<i> #::1         localhost localhost.localdomain localhost6
</I>&gt;<i> localhost6.localdomain6
</I>&gt;<i> 192.168.1.21  reverse.mydomain.lan
</I>&gt;<i> 192.168.1.246 ticket.mydomain.lan 
</I>&gt;<i> 192.168.1.223 php.mydomain.lan
</I>&gt;<i> 
</I>
These entries are not required when internal DNS is properly configured.

(FYI: Current Squid versions can also use multicast-DNS for LAN servers
if you use the standardized .local TLD for internal server names. That
is not related to your problem though.)

&gt;<i> 
</I>&gt;<i> This is the configuration of the squid referring to the reverse proxy:
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.1.21:80 accel vhost
</I>&gt;<i> 
</I>&gt;<i> cache_peer 192.168.1.246 parent 80 0 proxy-only name=ticket
</I>&gt;<i> cache_peer 192.168.1.223 parent 80 0 proxy-only name=php
</I>&gt;<i> 
</I>&gt;<i> acl ticket_acl dstdomain .MYDOMAIN.lan
</I>&gt;<i> http_access allow ticket_acl
</I>&gt;<i> cache_peer_access ticket allow ticket_acl
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl php_acl dstdomain .MYDOMAIN.lan
</I>&gt;<i> http_access allow php_acl
</I>&gt;<i> cache_peer_access php allow php_acl
</I>&gt;<i> 
</I>&gt;<i> With this config when i go to reverse.mydomain.lan (from a web browser) i
</I>&gt;<i> get the ticket web, but how i can go to the second web?? php web??
</I>
Right now your ticket_acl and php_acl are exactly the same. So they are
telling Squid that both peers are providing identical content (ie both
are authoritative for anything inside *.mydomain.lan). The first of the
available peers will be used, unless it starts to overload then the
second will start receiving the traffic.


To send traffic to one of the peers and not the other you need some way
to distinguish between them.

Normally you would have the ticket.* and php.* domain names both
pointing at Squid (192.168.1.21) so your ACLs can check for and use the
domain name to identify which peer is supposed to receive it.

The cache_peer use raw-IP like you have, or a *different* server name
from DNS pointing at the particular peer which can serve the content
your ACLs let Squid send to it.

The config example you want to follow is
&lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Reverse/MultipleWebservers">https://wiki.squid-cache.org/ConfigExamples/Reverse/MultipleWebservers</A>&gt;.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018910.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
	<LI>Next message (by thread): <A HREF="018911.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18906">[ date ]</a>
              <a href="thread.html#18906">[ thread ]</a>
              <a href="subject.html#18906">[ subject ]</a>
              <a href="author.html#18906">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
