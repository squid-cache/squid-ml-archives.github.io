<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as reverse proxy for two or more webs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20reverse%20proxy%20for%20two%20or%20more%20webs&In-Reply-To=%3C1055c185-d668-6530-756d-caf5be0a13a9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018913.html">
   <LINK REL="Next"  HREF="018919.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as reverse proxy for two or more webs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20reverse%20proxy%20for%20two%20or%20more%20webs&In-Reply-To=%3C1055c185-d668-6530-756d-caf5be0a13a9%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid as reverse proxy for two or more webs">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 10 15:25:10 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018913.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
        <LI>Next message (by thread): <A HREF="018919.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18914">[ date ]</a>
              <a href="thread.html#18914">[ thread ]</a>
              <a href="subject.html#18914">[ subject ]</a>
              <a href="author.html#18914">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/08/18 02:56, erdosain9 wrote:
&gt;<i> Antony Stone wrote
</I>&gt;&gt;&gt;<i> I create two entries pointing to squid in DNS now.
</I>&gt;&gt;&gt;<i> site1.mydomain.lan
</I>&gt;&gt;&gt;<i> site2.mydomain.lan
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, both of those resolve to 192.168.1.21, right?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, the resolve to the ip of squid.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The config example you want to follow is
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Reverse/MultipleWebservers">https://wiki.squid-cache.org/ConfigExamples/Reverse/MultipleWebservers</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I read that... but i dont get what im doing wrong.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You want to follow the section:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Switching on Domains
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Using cache_peer_access: 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer ip.of.server1 parent 80 0 no-query originserver name=server_1
</I>&gt;&gt;<i> acl sites_server_1 dstdomain www.example.com example.com
</I>&gt;&gt;<i> cache_peer_access server_1 allow sites_server_1
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> this is the config now.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 192.168.1.21:80 accel vhost
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer 192.168.1.246 parent 80 0 proxy-only name=site1
</I>&gt;&gt;&gt;<i> cache_peer 192.168.1.223 parent 80 0 proxy-only name=site2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You are missing &quot;originserver&quot; at the very least.  Otherwise Squid expects
</I>&gt;&gt;<i> to 
</I>&gt;&gt;<i> find another proxy at the IP address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Oh, sorry. I try with that config too. anyway i dont know about that.
</I>&gt;&gt;<i> thanks.
</I>&gt;&gt;<i>
</I>
You are also missing the ACL parts which determine which domain goes to
which cache_peer server.


&gt;&gt;<i> ...when you requested what as a URL?
</I>&gt;&gt;<i> site1.mydomain.lan
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1533911112.071      1 192.168.6.20 TCP_MISS/500 4605 GET
</I>&gt;&gt;&gt;<i> <A HREF="http://site1.MYDOMAIN.lan/">http://site1.MYDOMAIN.lan/</A> - HIER_NONE/- text/html
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Looks like you entered &quot;site1.mydomain.lan&quot; into your browser.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yep.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Try &quot;ticket.mydomain.lan&quot; (after correcting the above config problems)
</I>&gt;&gt;<i> instead.
</I>&gt;&gt;<i>
</I>&gt;<i> Well, if if put ticket.mydomain.lan i go directly to the server i want to
</I>&gt;<i> go.
</I>&gt;<i>
</I>
This is why the domain name you want the clients to contact to be
pointing at Squid, not the origin servers.

Squid passes on the domain name it received from the client. Examples
below using your current config ...


&gt;<i> This is:
</I>&gt;<i>
</I>&gt;<i> ticket.mydomian.lan ----------------------------&gt; Server  1
</I>&gt;<i> php.mydomian.lan ------------------------------&gt; Server 2
</I>&gt;<i>
</I>&gt;<i> site1.mydomain.lan --------------------------------&gt; squid
</I>&gt;<i> site2.mydomian.lan --------------------------------&gt; squid
</I>&gt;<i>
</I>&gt;<i> for my config i expect that when squid receive site1 go to
</I>&gt;<i> ticket.mydomain.lan
</I>&gt;<i> and for site2 go to php.mydomain.lan
</I>&gt;<i>
</I>
Then site1.* and site2.* are the domains which those origin servers need
to be hosting - not ticket.* or php.*.

The request flow looks like this:

* client requests <A HREF="http://site1.mydomain.lan/">http://site1.mydomain.lan/</A> which goes to Squid because
A for that domain is Squid IP.

* Squid sends request for <A HREF="http://site1.mydomain.lan/">http://site1.mydomain.lan/</A> to server
ticket.mydomain.lan because cache_peer_access said it was allowed there.

* Server ticket.mydomain.lan receives request for
<A HREF="http://site1.mydomain.lan/">http://site1.mydomain.lan/</A> from Squid.


At no point does any URL or HTTP message contain &quot;ticket.mydomain.lan&quot;.
I think this is where you are getting confused - thinking that the
origin server names mean something when they do not.

You do *not* need a domain DNS entries to point at the origin for that
origin to provide responses for it.


This is also why you need to test the setup which will actually be used
when the proxy is made to be &quot;in production&quot;. Testing with fake domain
setup only ensures the fake domains work, the reals ones may be fatally
broken.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018913.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
	<LI>Next message (by thread): <A HREF="018919.html">[squid-users] Squid as reverse proxy for two or more webs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18914">[ date ]</a>
              <a href="thread.html#18914">[ thread ]</a>
              <a href="subject.html#18914">[ subject ]</a>
              <a href="author.html#18914">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
