<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Have%20issue%20with%20%22https_port%20ssl-bump%20intercept%22&In-Reply-To=%3C35064290-e6e6-569a-6c27-5f25624e9735%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018918.html">
   <LINK REL="Next"  HREF="018921.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Have%20issue%20with%20%22https_port%20ssl-bump%20intercept%22&In-Reply-To=%3C35064290-e6e6-569a-6c27-5f25624e9735%40measurement-factory.com%3E"
       TITLE="[squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 10 18:27:57 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018918.html">[squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="018921.html">[squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18920">[ date ]</a>
              <a href="thread.html#18920">[ thread ]</a>
              <a href="subject.html#18920">[ subject ]</a>
              <a href="author.html#18920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/10/2018 12:05 PM, pius wrote:
&gt;<i> I am getting IP address of the client instead of the domain name I requested. 
</I>
I suspect you are getting your Squid https_port address
(10.222.17.106:3130) rather than the client IP address (10.222.25.60).
Logging Squid IP instead of the intended server IP feels wrong to me,
but that is not why things do not otherwise &quot;work&quot; in your test.

Your test request is probably not getting through because your
http_access rules (or equivalent) deny the (fake) CONNECT request to
216.58.212.100 (or whatever one of the www.google.com server IPs is in
your environment). Check your access control rules while keeping in mind
that the initial (i.e. step1) fake CONNECT request on an intercepting
https_port has nothing but TCP/IP-level information.


HTH,

Alex.


&gt;<i> I am trying curl -iv <A HREF="https://www.google.com">https://www.google.com</A> from a client machine
</I>&gt;<i> (10.222.17.106). I am not getting google.com in the access log and getting
</I>&gt;<i> TCP_DENIED. Looks like traffic is blocked before checking the certificate( I
</I>&gt;<i> am not sure ). And HTTP works fine (curl -iv <A HREF="http://www.google.com">http://www.google.com</A>). I have
</I>&gt;<i> included LOG for from both requests. Please help.
</I>&gt;<i> 
</I>&gt;<i> ##############
</I>&gt;<i> HTTPS REQUEST
</I>&gt;<i> 1533917193.498      0 10.222.25.60 TCP_DENIED/200 0 CONNECT
</I>&gt;<i> 10.222.17.106:3130 - HIER_NONE/- -
</I>&gt;<i> ##############
</I>&gt;<i> HTTP REQUEST
</I>&gt;<i> 1533917208.934     35 10.222.25.60 TCP_MISS/200 11561 GET
</I>&gt;<i> <A HREF="http://www.google.com/">http://www.google.com/</A> - HIER_DIRECT/216.58.212.100 text/html 
</I>&gt;<i> ##############
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ################################################################################
</I>&gt;<i> Here is my squid.conf
</I>&gt;<i> ###############
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 0.0.0.0:3129 ssl-bump  \
</I>&gt;<i>   cert=/etc/squid/ssl_cert/cert.pem \
</I>&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> https_port 0.0.0.0:3130 ssl-bump intercept \
</I>&gt;<i>   cert=/etc/squid/ssl_cert/cert.pem \
</I>&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl ssl_exclude_domains ssl::server_name &quot;/etc/squid/exclude_domains.conf&quot;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice localhost
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice ssl_exclude_domains
</I>&gt;<i> ssl_bump stare step2 all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018918.html">[squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="018921.html">[squid-users] Have issue with &quot;https_port ssl-bump intercept&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18920">[ date ]</a>
              <a href="thread.html#18920">[ thread ]</a>
              <a href="subject.html#18920">[ subject ]</a>
              <a href="author.html#18920">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
