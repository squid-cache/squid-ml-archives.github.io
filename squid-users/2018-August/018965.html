<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] v4.2 url_rewrite Uri.cc line 371 bad URL parsing on	SSL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20v4.2%20url_rewrite%20Uri.cc%20line%20371%20bad%20URL%20parsing%20on%0A%09SSL&In-Reply-To=%3C000a01d434f3%24d2bf32b0%24783d9810%24%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018964.html">
   <LINK REL="Next"  HREF="018966.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] v4.2 url_rewrite Uri.cc line 371 bad URL parsing on	SSL</H1>
    <B>David Touzeau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20v4.2%20url_rewrite%20Uri.cc%20line%20371%20bad%20URL%20parsing%20on%0A%09SSL&In-Reply-To=%3C000a01d434f3%24d2bf32b0%24783d9810%24%40articatech.com%3E"
       TITLE="[squid-users] v4.2 url_rewrite Uri.cc line 371 bad URL parsing on	SSL">david at articatech.com
       </A><BR>
    <I>Wed Aug 15 23:58:10 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018964.html">[squid-users] What is a typical squid conf file
</A></li>
        <LI>Next message (by thread): <A HREF="018966.html">[squid-users] v4.2 url_rewrite Uri.cc line 371 bad URL parsing on SSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18965">[ date ]</a>
              <a href="thread.html#18965">[ thread ]</a>
              <a href="subject.html#18965">[ subject ]</a>
              <a href="author.html#18965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, 

 

I have written my own url_rewrite helper

 

On SSL sites, the helper answering a redirect to a remote denied php  page.

 

With HTTP, no issue but on SSL there is a different behavior

 

My helper return 

 

rewrite-url= <A HREF="https://192.168.1.122:443/myguard.php?rule-id=0">https://192.168.1.122:443/myguard.php?rule-id=0</A>
&lt;<A HREF="https://192.168.1.122:443/ufdbguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovL">https://192.168.1.122:443/ufdbguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovL</A>
zE5Mi4xNjguMS4xMjI=&amp;clientaddr=192.168.1.1&amp;clientname=192.168.1.1&amp;clientuser
=unknown&amp;clientgroup=default&amp;targetgroup=P109&amp;url=http%3A%2F%2Fwww.youporn.c
om&gt;
&amp;SquidGuardIPWeb=aHR0cDovLzE5Mi4xNjguMS4xMjI=&amp;clientaddr=192.168.1.1&amp;clientn
ame=192.168.1.1&amp;clientuser=unknown&amp;clientgroup=default&amp;targetgroup=P109&amp;url=
http%3A%2F%2Fwww.youporn.com

 

but according to debug, the Uri.cc understand : host='https', port='443',
path=''

 

In this case, squid try to connect to an https machine name and return bad
503

 

 

 

018/08/16 01:42:59.681 kid1| 84,3| Reply.cc(63) finalize: helper Result = OK

2018/08/16 01:42:59.681 kid1| 61,5| redirect.cc(83) redirectHandleReply:
reply={result=OK, notes={webfiltering: block,0,P109; status: 302;
rewrite-url:
<A HREF="https://192.168.1.122:443/myguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovLzE5">https://192.168.1.122:443/myguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovLzE5</A>
Mi4xNjguMS4xMjI=&amp;clientaddr=192.168.1.1&amp;clientname=192.168.1.1&amp;clientuser=un
known&amp;clientgroup=default&amp;targetgroup=P109&amp;url=http%3A%2F%2Fwww.youporn.com;
}}

2018/08/16 01:42:59.681 kid1| 85,5| client_side_request.cc(1197)
clientRedirectDone: 'www.youporn.com:443' result={result=OK,
notes={webfiltering: block,0,P109; status: 302; rewrite-url:
<A HREF="https://192.168.1.122:443/myguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovLzE5">https://192.168.1.122:443/myguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovLzE5</A>
Mi4xNjguMS4xMjI=&amp;clientaddr=192.168.1.1&amp;clientname=192.168.1.1&amp;clientuser=un
known&amp;clientgroup=default&amp;targetgroup=P109&amp;url=http%3A%2F%2Fwww.youporn.com;
}}

 

Here  -------------------&gt; Uri.cc did not understand correctly the returned
URL.

 

2018/08/16 01:42:59.681 kid1| 23,3| Uri.cc(371) parse: Split URL
'<A HREF="https://192.168.1.122:443/myguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovLzE">https://192.168.1.122:443/myguard.php?rule-id=0&amp;SquidGuardIPWeb=aHR0cDovLzE</A>
5Mi4xNjguMS4xMjI=&amp;clientaddr=192.168.1.1&amp;clientname=192.168.1.1&amp;clientuser=u
nknown&amp;clientgroup=default&amp;targetgroup=P109&amp;url=http%3A%2F%2Fwww.youporn.com
' into proto='', host='https', port='443', path=''

 

 

2018/08/16 01:42:59.681 kid1| 24,7| SBuf.cc(212) append: from c-string to id
SBuf346713

2018/08/16 01:42:59.681 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 0 for
SBuf346713

2018/08/16 01:42:59.681 kid1| 24,7| SBuf.cc(167) rawSpace: SBuf346713 not
growing

2018/08/16 01:42:59.681 kid1| 24,6| SBuf.cc(99) assign: SBuf346714 from
c-string, n=4294967295)

2018/08/16 01:42:59.682 kid1| 24,7| SBuf.cc(212) append: from c-string to id
SBuf346714

2018/08/16 01:42:59.682 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 0 for
SBuf346714

2018/08/16 01:42:59.682 kid1| 24,7| SBuf.cc(167) rawSpace: SBuf346714 not
growing

2018/08/16 01:42:59.682 kid1| 24,6| SBuf.cc(99) assign: SBuf346709 from
c-string, n=4294967295)

2018/08/16 01:42:59.682 kid1| 24,7| SBuf.cc(212) append: from c-string to id
SBuf346709

2018/08/16 01:42:59.682 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 0 for
SBuf346709

2018/08/16 01:42:59.682 kid1| 24,7| SBuf.cc(167) rawSpace: SBuf346709 not
growing

 

Here ------------&gt; Address.cc did not find the https machine.

2018/08/16 01:42:59.682 kid1| 14,3| Address.cc(382) lookupHostIP: Given
Non-IP 'https.domain.local': Name or service not known

 

 

Did i miss something ???

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180816/1cbe57bb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180816/1cbe57bb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018964.html">[squid-users] What is a typical squid conf file
</A></li>
	<LI>Next message (by thread): <A HREF="018966.html">[squid-users] v4.2 url_rewrite Uri.cc line 371 bad URL parsing on SSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18965">[ date ]</a>
              <a href="thread.html#18965">[ thread ]</a>
              <a href="subject.html#18965">[ subject ]</a>
              <a href="author.html#18965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
