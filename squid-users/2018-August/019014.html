<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fetch missing certificate feature of Squid_v4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fetch%20missing%20certificate%20feature%20of%20Squid_v4&In-Reply-To=%3C80770d73-d75a-32d9-eace-a0ce055c9916%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019013.html">
   <LINK REL="Next"  HREF="019016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fetch missing certificate feature of Squid_v4</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fetch%20missing%20certificate%20feature%20of%20Squid_v4&In-Reply-To=%3C80770d73-d75a-32d9-eace-a0ce055c9916%40treenet.co.nz%3E"
       TITLE="[squid-users] Fetch missing certificate feature of Squid_v4">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Aug 20 12:18:28 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019013.html">[squid-users] Fetch missing certificate feature of Squid_v4
</A></li>
        <LI>Next message (by thread): <A HREF="019016.html">[squid-users] NTLM Authentication / Centos 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19014">[ date ]</a>
              <a href="thread.html#19014">[ thread ]</a>
              <a href="subject.html#19014">[ subject ]</a>
              <a href="author.html#19014">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/08/18 9:10 PM, Christof Gerber wrote:
&gt;<i> I am wondering how to verify the feature &quot;Fetch missing certificate&quot;
</I>&gt;<i> which was added to Squid v4.
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/commit/55369ae649646901d3038c63217386174d01eb7b">https://github.com/squid-cache/squid/commit/55369ae649646901d3038c63217386174d01eb7b</A>
</I>&gt;<i> 
</I>&gt;<i> I tried to trigger the feature by requesting some domains via squid
</I>&gt;<i> which lack the intermediate certificate (e.g. www.facworld.com,
</I>&gt;<i> taas.citrix.com, karantina.genelsigorta.com).
</I>&gt;<i> 
</I>&gt;<i> Because of the following observation I believe something is not
</I>&gt;<i> working correctly:
</I>&gt;<i> 1. Curl retruns with a &quot;SSL certificate problem: Invalid certificate
</I>&gt;<i> chain&quot; in all three cases
</I>
This is the chain received by curl. Not the chain received by Squid.

To get this from curl either Squid is not even involved in any TLS with
the broken cert chain (splice, regular tunneling, not using the proxy).
Or, the CA cert chain you configured Squid to use is itself incomplete.


&gt;<i> 2. By enabling 33,5 83,5 81,5 88,3 logging and analysing the log trace
</I>&gt;<i> I get the feeling that the code of the feature is not called (-&gt;
</I>&gt;<i> missing certificate not downloaded). See the log trace in the
</I>&gt;<i> attachment
</I>
Log trace says Squid identified <A HREF="http://aia.entrust.net/l1k-chain256.cer">http://aia.entrust.net/l1k-chain256.cer</A>
as the missing CA and downloaded it. AFAICT the verification then passed
and bump proceeded to happen.

&gt;<i> 
</I>&gt;<i> I verified that these domains deliver an incomplete certificate by:
</I>&gt;<i> $ openssl s_client -connect taas.citrix.com:443 -showcerts -verify 32
</I>&gt;<i> -CApath  $path/to/root/certs/
</I>&gt;<i> Which returns &quot;Verify return code: 21 (unable to verify the first
</I>&gt;<i> certificate)&quot; for all of them
</I>&gt;<i> 
</I>&gt;<i> Question:
</I>&gt;<i> 1. How to verify that the feature is working?
</I>
AFAIK, just what you did. The problem seems to be not understanding the
log resulting.

...
2018/08/20 10:37:26.975 kid1| 83,5| PeerConnector.cc(712)
checkForMissingCertificates: SSL server sent 1 certificates
...
2018/08/20 10:37:26.976 kid1| 33,3| Downloader.cc(226) handleReply:
Object data transfer successfully complete
...
2018/08/20 10:37:27.089 kid1| 83,5| PeekingPeerConnector.cc(353)
serverCertificateVerified: HTTPS server CN: www.facworld.com bumped:
local=213.156.236.180:59365 remote=208.227.150.131:443 FD 17 flags=1
..
2018/08/20 10:37:27.091 kid1| 33,5| client_side.cc(2917)
getTlsContextFromCache: Cached SSL certificate for www.facworld.com is valid
...


&gt;<i> Am I doing something wrong?
</I>
Maybe. It only can D/L *if* the present certificate provides a URL for
its absent CA certificate. Not all types of incomplete chains have that
required info.


&gt;<i> 2. Is this feature always on or do I have to configure/enable it in Squid v4?
</I>
Always on.


&gt;<i> 
</I>&gt;<i> Squid Cache: Version v4.0-6d8f397398995c4512cb045920ee2747cc6b14f8
</I>&gt;<i> 
</I>
Uhm, Squid code at 6d8f397 self-identify as 4.2.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019013.html">[squid-users] Fetch missing certificate feature of Squid_v4
</A></li>
	<LI>Next message (by thread): <A HREF="019016.html">[squid-users] NTLM Authentication / Centos 7
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19014">[ date ]</a>
              <a href="thread.html#19014">[ thread ]</a>
              <a href="subject.html#19014">[ subject ]</a>
              <a href="author.html#19014">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
