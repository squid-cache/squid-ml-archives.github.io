<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent squid configuration problem.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20squid%20configuration%20problem.&In-Reply-To=%3Cvmime.5b7ec2f3.7527.160262a5769a3ea3%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019051.html">
   <LINK REL="Next"  HREF="019081.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent squid configuration problem.</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20squid%20configuration%20problem.&In-Reply-To=%3Cvmime.5b7ec2f3.7527.160262a5769a3ea3%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Transparent squid configuration problem.">belle at bazuin.nl
       </A><BR>
    <I>Thu Aug 23 14:21:39 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019051.html">[squid-users] Transparent squid configuration problem.
</A></li>
        <LI>Next message (by thread): <A HREF="019081.html">[squid-users] Transparent squid configuration problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19052">[ date ]</a>
              <a href="thread.html#19052">[ thread ]</a>
              <a href="subject.html#19052">[ subject ]</a>
              <a href="author.html#19052">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>If i may suggest.. 
&#160;
Use the squid version from debian sid. 
Rebuilding these to stretch isnt that hard. 
&#160;
add&#160; the sid sources, run : apt-get update
apt-get build-dep squid
apt-get source squid -b 
then create a file repo ( or http repo ) and install squid. 

or, if you dont want to rebuild them. you can get them here. 
<A HREF="http://downloads.van-belle.nl/squid/&#160;">http://downloads.van-belle.nl/squid/&#160;</A>
A squid 4.1 and 4.2 are available for Stretch im using now the 4.2 version. 
&#160;
If thats no option then have a look at <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice&#160;">https://wiki.squid-cache.org/Features/SslPeekAndSplice&#160;</A> 
See the configuration example, that a good example.&#160; 
Change &quot;bank&quot; in habr.com&#160;&#160; ;-)&#160; 
&#160;
&#160;
Greetz, 
&#160;
Louis
&#160;
Van: ??????? ????????? ????????????? [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">a.zubarev at generium.ru</A>] 
Verzonden: donderdag 23 augustus 2018 15:42
Aan: L.P.H. van Belle; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Onderwerp: RE: [squid-users] Transparent squid configuration problem.




Thank you, Louis! 

Is there some workaround? May be I can to put that?s kind of sites without filtering?



From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of L.P.H. van Belle
Sent: Thursday, August 23, 2018 4:38 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Transparent squid configuration problem.





i noticed the following :&#160;&#160;&#160; dig caa habr.com
;; ANSWER SECTION:
habr.com.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 3600&#160;&#160;&#160; IN&#160;&#160;&#160;&#160;&#160; CAA&#160;&#160;&#160;&#160; 0 iodef &quot;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">iodef at habr.com</A>&quot;
habr.com.&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 3600&#160;&#160;&#160; IN&#160;&#160;&#160;&#160;&#160; CAA&#160;&#160;&#160;&#160; 0 issue &quot;comodoca.com&quot;


So you cant bump this site, its protecting its certificates with a CAA/DANE&#160;dns record. 



Greetz, 



Louis










Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens ??????? ????????? ?????????????
Verzonden: donderdag 23 augustus 2018 15:22
Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Onderwerp: [squid-users] Transparent squid configuration problem.

Hi! I have some problems with configuration of squid.



What I need:

http/https transparent proxy server based on Debian Stretch with some blacklisted and whitelisted domains



I?ve used many tutorials and squid.wiki through installation process and it almost work! But I have the last problem.



When I tried to connect to some websites like a <A HREF="https://habr.com">https://habr.com</A> I have &#160;got HTTP ERROR 503. Ive tried to find solution at forums but no one helped me. I know the answer is simple and its here but cannt find it by myself.



Here is my squid.conf, cache.log, access.log and iptables script.



Please help! J



Squid.conf:



dns_v4_first on



acl network src 10.84.0.0/16



acl SSL_ports port 443

acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http

acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp

acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https

acl Safe_ports port 70&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gopher

acl Safe_ports port 210&#160;&#160;&#160;&#160;&#160;&#160;&#160; # wais

acl Safe_ports port 1025-65535&#160;&#160;&#160; # unregistered ports

acl Safe_ports port 280&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt

acl Safe_ports port 488&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gss-http

acl Safe_ports port 591&#160;&#160;&#160;&#160;&#160;&#160;&#160; # filemaker

acl Safe_ports port 777&#160;&#160;&#160;&#160;&#160;&#160;&#160; # multiling http

acl blacklist dstdomain &quot;/etc/squid/acls/social_networks.txt&quot; # list of blocked websites here

acl CONNECT method CONNECT



http_access deny blacklist

http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports



http_access allow all



http_port 3130



http_port 3128 intercept

https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_cert/vproxy2.pem key=/etc/squid/ssl_cert/vproxy2.pem



#always_direct allow all

ssl_bump server-first all

#sslproxy_cert_error deny all

#sslproxy_flags DONT_VERIFY_PEER



sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB

sslcrtd_children 8 startup=1 idle=1



coredump_dir /var/spool/squid



# Add any of your own refresh_pattern entries above these.

refresh_pattern ^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160; 10080

refresh_pattern ^gopher:&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160; 1440

refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160; 0%&#160;&#160;&#160; 0

refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160; 20%&#160;&#160;&#160; 4320



shutdown_lifetime 1 second



cache.log:



Maximum Resident Size: 123312 KB

Page faults with physical i/o: 7

2018/08/23 16:19:27 kid1| Logfile: closing log daemon:/var/log/squid/access.log

2018/08/23 16:19:27 kid1| Logfile Daemon: closing log daemon:/var/log/squid/access.log

2018/08/23 16:19:27 kid1| Open FD UNSTARTED&#160;&#160;&#160;&#160; 6 DNS Socket IPv6

2018/08/23 16:19:27 kid1| Open FD READ/WRITE&#160;&#160;&#160; 7 DNS Socket IPv4

2018/08/23 16:19:27 kid1| Open FD UNSTARTED&#160;&#160;&#160; 10 IPC UNIX STREAM Parent

2018/08/23 16:19:27 kid1| Squid Cache (Version 3.5.23): Exiting normally.

2018/08/23 16:19:32 kid1| Set Current Directory to /var/spool/squid

2018/08/23 16:19:32 kid1| Starting Squid Cache version 3.5.23 for x86_64-pc-linux-gnu...

2018/08/23 16:19:32 kid1| Service Name: squid

2018/08/23 16:19:32 kid1| Process ID 1209

2018/08/23 16:19:32 kid1| Process Roles: worker

2018/08/23 16:19:32 kid1| With 65535 file descriptors available

2018/08/23 16:19:32 kid1| Initializing IP Cache...

2018/08/23 16:19:32 kid1| DNS Socket created at [::], FD 6

2018/08/23 16:19:32 kid1| DNS Socket created at 0.0.0.0, FD 7

2018/08/23 16:19:32 kid1| Adding domain generium.corp from /etc/resolv.conf

2018/08/23 16:19:32 kid1| Adding nameserver 10.84.10.110 from /etc/resolv.conf

2018/08/23 16:19:32 kid1| Adding nameserver 10.83.10.120 from /etc/resolv.conf

2018/08/23 16:19:32 kid1| Logfile: opening log daemon:/var/log/squid/access.log

2018/08/23 16:19:32 kid1| Logfile Daemon: opening log /var/log/squid/access.log

2018/08/23 16:19:32 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec

2018/08/23 16:19:32 kid1| Store logging disabled

2018/08/23 16:19:32 kid1| Swap maxSize 0 + 262144 KB, estimated 20164 objects

2018/08/23 16:19:32 kid1| Target number of buckets: 1008

2018/08/23 16:19:32 kid1| Using 8192 Store buckets

2018/08/23 16:19:32 kid1| Max Mem&#160; size: 262144 KB

2018/08/23 16:19:32 kid1| Max Swap size: 0 KB

2018/08/23 16:19:32 kid1| Using Least Load store dir selection

2018/08/23 16:19:32 kid1| Set Current Directory to /var/spool/squid

2018/08/23 16:19:32 kid1| Finished loading MIME types and icons.

2018/08/23 16:19:32 kid1| HTCP Disabled.

2018/08/23 16:19:32 kid1| Pinger socket opened on FD 16

2018/08/23 16:19:32 kid1| Squid plugin modules loaded: 0

2018/08/23 16:19:32 kid1| Adaptation support is off.

2018/08/23 16:19:32 kid1| Accepting HTTP Socket connections at local=[::]:3130 remote=[::] FD 12 flags=9

2018/08/23 16:19:32 kid1| Accepting NAT intercepted HTTP Socket connections at local=[::]:3128 remote=[::] FD 13 flags=41

2018/08/23 16:19:32 kid1| Accepting NAT intercepted SSL bumped HTTPS Socket connections at local=[::]:3129 remote=[::] FD 14 flags=41

2018/08/23 16:19:32| pinger: Initialising ICMP pinger ...

2018/08/23 16:19:32| pinger: ICMP socket opened.

2018/08/23 16:19:32| pinger: ICMPv6 socket opened

2018/08/23 16:19:32| Pinger exiting.

2018/08/23 16:19:33 kid1| storeLateRelease: released 0 objects



Accesslog:



1535030545.214&#160;&#160;&#160;&#160;&#160; 0 10.84.77.52 TAG_NONE/503 382 GET <A HREF="https://habr.com/">https://habr.com/</A> - ORIGINAL_DST/178.248.237.68 text/html

1535030545.442&#160;&#160;&#160; 608 10.84.77.52 TAG_NONE/200 0 CONNECT 52.4.157.193:443 - ORIGINAL_DST/52.4.157.193 -

1535030545.442&#160;&#160;&#160; 617 10.84.77.52 TAG_NONE/200 0 CONNECT 52.204.140.44:443 - ORIGINAL_DST/52.204.140.44 -

1535030545.717&#160;&#160;&#160; 422 10.84.77.52 TAG_NONE/200 0 CONNECT 52.204.140.44:443 - ORIGINAL_DST/52.204.140.44 -

1535030545.879&#160;&#160;&#160;&#160; 36 10.84.77.52 TCP_MISS/204 415 POST <A HREF="https://www.google.ru/gen_204?">https://www.google.ru/gen_204?</A> - ORIGINAL_DST/64.233.162.94 text/html

1535030546.522&#160;&#160;&#160;&#160; 77 10.84.77.52 TAG_NONE/200 0 CONNECT 178.248.237.68:443 - ORIGINAL_DST/178.248.237.68 -

1535030546.623&#160;&#160;&#160;&#160; 95 10.84.77.52 TAG_NONE/200 0 CONNECT 178.248.237.68:443 - ORIGINAL_DST/178.248.237.68 -

1535030546.625&#160;&#160;&#160;&#160;&#160; 0 10.84.77.52 TAG_NONE/503 382 GET <A HREF="https://habr.com/">https://habr.com/</A> - ORIGINAL_DST/178.248.237.68 text/html



??????????? ? ??????????????????: ??? ??????????? ????????? ? ????? ?????????, ??????????? ? ????, ????? ????????? ???????????????? ??????????. ????????? ?????????? &#247;?? ? ???, ??? ???? ??? ????????? ?? ????????????? &#247;??, ?????????????, ??????????? ??? ??????????????? ??????????, ???????????? ? ????????? ?????????, ? ????? ????????????? ????? ???????? ?? ?????? ???? ?????????? ?????? ?????????. ???? &#247;? ???????? ??? ????????? ?? ??????, ??????????, ???????? ?? ???? ??????????? ?? ??????????? ????? ? ??????? ??? ?????????. Confidentiality notice: This e-mail transmission and any attachments included may contain confidential information. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or reliance upon the content of this e-mail is strictly prohibited. If you have received this e-mail transmission in error, please notify sender by e-mail and then delete this message from your inbox. 

??????????? ? ??????????????????: ??? ??????????? ????????? ? ????? ?????????, ??????????? ? ????, ????? ????????? ???????????????? ??????????. ????????? ?????????? &#247;?? ? ???, ??? ???? ??? ????????? ?? ????????????? &#247;??, ?????????????, ??????????? ??? ??????????????? ??????????, ???????????? ? ????????? ?????????, ? ????? ????????????? ????? ???????? ?? ?????? ???? ?????????? ?????? ?????????. ???? &#247;? ???????? ??? ????????? ?? ??????, ??????????, ???????? ?? ???? ??????????? ?? ??????????? ????? ? ??????? ??? ?????????. Confidentiality notice: This e-mail transmission and any attachments included may contain confidential information. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or reliance upon the content of this e-mail is strictly prohibited. If you have received this e-mail transmission in error, please notify sender by e-mail and then delete this message from your inbox. 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180823/d8c0466e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180823/d8c0466e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019051.html">[squid-users] Transparent squid configuration problem.
</A></li>
	<LI>Next message (by thread): <A HREF="019081.html">[squid-users] Transparent squid configuration problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19052">[ date ]</a>
              <a href="thread.html#19052">[ thread ]</a>
              <a href="subject.html#19052">[ subject ]</a>
              <a href="author.html#19052">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
