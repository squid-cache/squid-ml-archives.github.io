<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Squid-3.5.27 MITM stopped work after few minutes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid-3.5.27%20MITM%20stopped%20work%20after%20few%0A%20minutes&In-Reply-To=%3Cf54fc02d-7d18-f593-d31c-091c36c864f2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019092.html">
   <LINK REL="Next"  HREF="019094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Squid-3.5.27 MITM stopped work after few minutes</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid-3.5.27%20MITM%20stopped%20work%20after%20few%0A%20minutes&In-Reply-To=%3Cf54fc02d-7d18-f593-d31c-091c36c864f2%40treenet.co.nz%3E"
       TITLE="[squid-users] Fwd: Squid-3.5.27 MITM stopped work after few minutes">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 31 13:05:44 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019092.html">[squid-users] Fwd: Squid-3.5.27 MITM stopped work after few minutes
</A></li>
        <LI>Next message (by thread): <A HREF="019094.html">[squid-users] internet squid with https and just for domain resolution not for caching or so
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19093">[ date ]</a>
              <a href="thread.html#19093">[ thread ]</a>
              <a href="subject.html#19093">[ subject ]</a>
              <a href="author.html#19093">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/08/18 11:12 PM, &#1044;&#1077;&#1085;&#1080;&#1089; &#1057;&#1090;&#1077;&#1087;&#1072;&#1085;&#1086;&#1074; wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &#160;cache.log
</I>&gt;<i> &lt;<A HREF="https://drive.google.com/file/d/15PYj86Qv-pdiwSHV_0oLC8BsS-oCkzIV/view?usp=drive_web">https://drive.google.com/file/d/15PYj86Qv-pdiwSHV_0oLC8BsS-oCkzIV/view?usp=drive_web</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> &#160;squid.conf
</I>&gt;<i> &lt;<A HREF="https://drive.google.com/file/d/1IVT4VqIOELuAtQYd981ugpsrbaIEUp0O/view?usp=drive_web">https://drive.google.com/file/d/1IVT4VqIOELuAtQYd981ugpsrbaIEUp0O/view?usp=drive_web</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> Such problem appears on Firefox browser too.
</I>&gt;<i> 
</I>
The cache.log is not very useful because you configured Squid to not
even check any TLS/SSL problems:

 sslproxy_flags DONT_VERIFY_PEER


... and you told Squid not to bother telling you about any problems that
did come up:

  sslproxy_cert_error allow all

Please remove those lines from your config. They are both extremely bad
ideas. The problems still happen and still cause more issues - but only
your clients/users can see the nasty behaviour they cause.
 You *want* Squid to inform you about security problems. So you have a
chance to fix them before users come knocking.


Along with that your ssl_bump configuration tells Squid to peek at the
TLS clientHello and bump immediately - before any details such as server
name or server certificate features are known:

 # step 1 or step2 - only if domain is known AND matches
 ssl_bump splice noBump

 # step1 always
 ssl_bump peek step1

 # step2 always
 ssl_bump bump all

 # step3 never reached.


That is what we call client-first bumping and the behaviour you describe
as happening (certs generated when only IPs are known) is expected. That
and many other related problems are the reasons it was deprecated in
Squid-3.4 and replaced with the peek and splice feature.

If that type of bumping is what you want then the problem is something
you chose to happen. The side effects are yours.

Otherwise you need to have a rule doing &quot;stare&quot; action at step2 to get
server details before bumping - which then is at step3.
 Be aware that with stare any sites in noBump which Squid could not
identify at the step1 and step2 phases cannot be spliced but have to be
bump'd or terminate'd.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019092.html">[squid-users] Fwd: Squid-3.5.27 MITM stopped work after few minutes
</A></li>
	<LI>Next message (by thread): <A HREF="019094.html">[squid-users] internet squid with https and just for domain resolution not for caching or so
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19093">[ date ]</a>
              <a href="thread.html#19093">[ thread ]</a>
              <a href="subject.html#19093">[ subject ]</a>
              <a href="author.html#19093">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
