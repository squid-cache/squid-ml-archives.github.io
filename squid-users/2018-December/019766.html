<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Define%20and%20use%20a%20variable%20in%20squid.conf%20%28Was%3A%0A%20What%20happens%20when%20duplicate%20external_acl_type%20are%20mentioned%29&In-Reply-To=%3Cbe219af2-b737-32f6-57fb-02f2bf663052%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019765.html">
   <LINK REL="Next"  HREF="019767.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Define%20and%20use%20a%20variable%20in%20squid.conf%20%28Was%3A%0A%20What%20happens%20when%20duplicate%20external_acl_type%20are%20mentioned%29&In-Reply-To=%3Cbe219af2-b737-32f6-57fb-02f2bf663052%40treenet.co.nz%3E"
       TITLE="[squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Dec  2 13:15:42 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019765.html">[squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)
</A></li>
        <LI>Next message (by thread): <A HREF="019767.html">[squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19766">[ date ]</a>
              <a href="thread.html#19766">[ thread ]</a>
              <a href="subject.html#19766">[ subject ]</a>
              <a href="author.html#19766">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/12/18 12:41 am, Amish wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 02/12/18 3:20 pm, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 2/12/18 5:31 pm, Amish wrote:
</I>&gt;&gt;&gt;<i> On 02/12/18 9:33 am, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> To reduce long-term headaches, I think we should be strict and
</I>&gt;&gt;&gt;&gt;<i> deprecate
</I>&gt;&gt;&gt;&gt;<i> (and then prohibit) ignoring duplicated external_acl_type declarations.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I do not see any good reasons for ignoring this configuration error
</I>&gt;&gt;&gt;&gt;<i> forever. FWIW, the use case discussed in this thread is not a good
</I>&gt;&gt;&gt;&gt;<i> reason IMO because Squid configuration in question can and should be
</I>&gt;&gt;&gt;&gt;<i> easily generated (probably from a stable template) to correctly
</I>&gt;&gt;&gt;&gt;<i> accommodate the needs of the current authentication method.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thank you for your clarification.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now I am looking for alternate ways I can resolve my issue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> What is wrong with %un that makes it unusable?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It will contain username when Squid has been told a username and '-'
</I>&gt;&gt;<i> when none is known.
</I>&gt;<i> 
</I>&gt;<i> I believe you missed my reply. Here is the archive link to it:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2018-December/019759.html">http://lists.squid-cache.org/pipermail/squid-users/2018-December/019759.html</A>
</I>&gt;<i> 
</I>
Ah, yes it has not arrived here for some reason.


There are actually _up to four_ helper checks being done when %ul is
used. Performance optimizations in Squid were/are preventing them being
very visible for Basic auth type and external ACL. But the helper state
is still being checked and if any of the cache TTLs end the check may
fall through to do a full helper query.
 * Each test of the proxyuser ACL involves a check of the external
helper cache.
  - If there was no cached result with that exact pattern a fully query
is sent.
 * Each test of the cache for an external helper using %ul (aka. %LOGIN)
requires a check of the auth_param helper cache (if any).
  - If there was no cached result with that exact pattern OR if the auth
scheme does not cache results, a fully query is sent to the auth_param
helper.

With your config and %ul:

 - (1) the auth_param helper is asked to login the client and provide a
username

 then:
  - (2A) the external ACL helper is asked if &quot;user=X&quot; username is okay
 OR:
  - (2B) the external ACL helper is asked if &quot;-&quot; username is okay

 then:
  - (3) the auth_param helper is asked to login the client and provide a
username

 then:
  - (4A) the external ACL helper is asked if &quot;user=X&quot; username is okay
 OR:
  - (4B) the external ACL helper is asked if &quot;-&quot; username is okay



With your config and %un:

 - (1) the external ACL helper is asked if &quot;-&quot; username is okay,

 then:
  - (2A) the external ACL helper is asked if &quot;user=X&quot; username is okay
  OR:
  - (2B) the external ACL helper is asked if &quot;-&quot; username is okay


For optimal performance (under either setup) you need to restructure
these lines:
  http_access allow proxyuser restrictedports
  http_access allow proxyuser restrictedsites

such that the helper is not being used multiple times:

  http_access deny !proxyuser
  http_access allow restrictedports
  http_access allow restrictedsites

Or,
  acl restrictedPlaces anyof restrictedports restrictedsites
  http_access allow proxyuser restrictedPlaces

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019765.html">[squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)
</A></li>
	<LI>Next message (by thread): <A HREF="019767.html">[squid-users] Define and use a variable in squid.conf (Was: What happens when duplicate external_acl_type are mentioned)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19766">[ date ]</a>
              <a href="thread.html#19766">[ thread ]</a>
              <a href="subject.html#19766">[ subject ]</a>
              <a href="author.html#19766">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
