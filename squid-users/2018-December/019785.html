<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid4.4 - ssl_bump - deny_info / how to present a blocked message for unwanted https traffic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid4.4%20-%20ssl_bump%20-%20deny_info%20/%20how%20to%20present%0A%20a%20blocked%20message%20for%20unwanted%20https%20traffic&In-Reply-To=%3Cc358d326-7a35-faf0-5d60-218ee93412d0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019781.html">
   <LINK REL="Next"  HREF="019783.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid4.4 - ssl_bump - deny_info / how to present a blocked message for unwanted https traffic</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid4.4%20-%20ssl_bump%20-%20deny_info%20/%20how%20to%20present%0A%20a%20blocked%20message%20for%20unwanted%20https%20traffic&In-Reply-To=%3Cc358d326-7a35-faf0-5d60-218ee93412d0%40treenet.co.nz%3E"
       TITLE="[squid-users] squid4.4 - ssl_bump - deny_info / how to present a blocked message for unwanted https traffic">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  5 13:29:36 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019781.html">[squid-users] squid4.4 - ssl_bump - deny_info / how to present a blocked message for unwanted https traffic
</A></li>
        <LI>Next message (by thread): <A HREF="019783.html">[squid-users] Proxy Chaining with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19785">[ date ]</a>
              <a href="thread.html#19785">[ thread ]</a>
              <a href="subject.html#19785">[ subject ]</a>
              <a href="author.html#19785">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/12/18 8:10 pm, Andreas Moehrlein wrote:
&gt;<i> I use squid as a proxy to enable some http and https sites and redirect all other traffic to a captive portal.
</I>&gt;<i> Everything works fine, except for a redirect/deny_info for the not allowed https traffic.
</I>&gt;<i> 
</I>&gt;<i> Is there a mechanism, I can use to show a error message for https ?
</I>&gt;<i> 
</I>
The TL;DR short answer:

  No, sorry, it is effectively impossible.


The longer version:

Browsers refuse to display any messages provided by proxies in response
to a CONNECT attempt. They replace them with their own in-house
messages. Usually blaming the proxy for 'connection failure', regardless
of what actually happened.

The only way around that is for the proxy to MITM and decrypt the TLS
traffic and forge an HTTP error response to the first HTTP request it
finds in there.

Which in the scenario of a Captive Portal effectively means that it is
impossible until Browsers change their behaviour. The Browser does not
have prior setup to trust the proxy CA in order for the handshake to
complete and error message to be delivered.

If you have any ability to configure the browser for that trust, then by
definition it is not a Captive Portal situation. Use it as a regular TLS
Proxy instead and your error and/or redirection should work _relatively_
okay, most of the time, sort of.



&gt;<i> All http + https traffic is redirected to squid via iptables.
</I>&gt;<i> Deny_info works perfect for http.
</I>&gt;<i> 
</I>&gt;<i> /etc/squid/squid.conf
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl https_whitelist ssl::server_name &quot;/etc/squid/acl/general.list&quot;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice https_whitelist
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>&gt;<i> deny_info <A HREF="http://10.10.12.1:81/captureme?redirect=%u">http://10.10.12.1:81/captureme?redirect=%u</A> all
</I>&gt;<i> 
</I>
Please be aware that deny_info is the parameters on how to generate an
*HTTP* protocol response message when a &quot;deny&quot; action is initiated for
an HTTP transaction. The above line connects your parameters to the ACL
named &quot;all&quot; so denial by HTTP access control lines ending with &quot; all&quot;
(eg &quot;http_access deny all&quot;) will send a redirect to that URL.

ssl_bump terminate is different in several important ways:

 * Firstly it is not access control for an HTTP transaction - it
flow-controls the stages of a TLS protocol handshake. Thus no &quot;error
message&quot; exists in the sense you are looking for.

* Secondly it uses a &quot;terminate&quot; action not a &quot;deny&quot;. The entire
semantics and binary-layer of what is going on are critically different.
  The &quot;terminate&quot; takes the form of a TLS Alert frame of slightly more
than 4 bytes, usually followed with or embedded in a TCP FIN packet. No
HTTP at all and certainly nothing even resembling redirect possible (so
we cannot even map your intention into the TLS format).


Overall with this setup no there is no chance at all of the proxy error
message even existing let alone being sent to any User.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019781.html">[squid-users] squid4.4 - ssl_bump - deny_info / how to present a blocked message for unwanted https traffic
</A></li>
	<LI>Next message (by thread): <A HREF="019783.html">[squid-users] Proxy Chaining with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19785">[ date ]</a>
              <a href="thread.html#19785">[ thread ]</a>
              <a href="subject.html#19785">[ subject ]</a>
              <a href="author.html#19785">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
