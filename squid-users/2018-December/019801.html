<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump with HTTP Cache Peer Parent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20with%20HTTP%20Cache%20Peer%20Parent&In-Reply-To=%3C76ea091a-afbb-758b-06e5-082c05761597%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019799.html">
   <LINK REL="Next"  HREF="019804.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump with HTTP Cache Peer Parent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20with%20HTTP%20Cache%20Peer%20Parent&In-Reply-To=%3C76ea091a-afbb-758b-06e5-082c05761597%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL Bump with HTTP Cache Peer Parent">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 13 01:00:27 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019799.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
        <LI>Next message (by thread): <A HREF="019804.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19801">[ date ]</a>
              <a href="thread.html#19801">[ thread ]</a>
              <a href="subject.html#19801">[ subject ]</a>
              <a href="author.html#19801">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/12/18 12:15 pm, sam.handley wrote:
&gt;<i> I am not 100% confident what I am asking is possible but I'd love it to be
</I>&gt;<i> confirmed.
</I>&gt;<i> 
</I>&gt;<i> Here is what our setup would look like, I&#8217;ve explained a bit below:
</I>&gt;<i> 
</I>&gt;<i> DEVICE ---&gt; PRX3 (HTTPS CACHE) ---&gt; PRX2 ---&gt; PRX1 ---&gt; INTERNET
</I>&gt;<i> 
</I>&gt;<i> Our current environment is a bit behind the times and inflexible. We have a
</I>&gt;<i> local squid proxy/cache (PRX2) that we do not fully control that only caches
</I>&gt;<i> HTTP content. This proxy is downstream from another proxy which is also HTTP
</I>&gt;<i> (PRX1). Both just TUNNEL HTTPS. PRX1 is the only way out of our WAN to the
</I>&gt;<i> internet.
</I>&gt;<i> 
</I>&gt;<i> We would like to start caching HTTPS (PRX3) because these other proxies are
</I>&gt;<i> not and it is costing us bandwidth. With the config below and a direct
</I>&gt;<i> internet connection I can successfully connect and cache HTTP/S content.
</I>&gt;<i> However, this won&#8217;t work in our environment. We must go through a cache peer
</I>&gt;<i> either PRX1 or PRX2, adding either upstream proxy as a cache peer parent
</I>&gt;<i> results in either SSL errors or the request not being forwarded to the peer. 
</I>&gt;<i> 
</I>&gt;<i> I think what I need to do is TUNNEL the bumped request to PRX2 over HTTP. I
</I>&gt;<i> thought squid 4 could do this but can&#8217;t find any docs for it so it may have
</I>&gt;<i> been wishful thinking.
</I>

No official version of Squid can do that directly for decrypted
requests. Only for HTTPS which is being spliced or non-HTTP protocols
that happen to get intercepted on port 443.

There are several possibilities though:

First is unofficial Factory code that implements this feature. Available
for testing at
&lt;<A HREF="https://github.com/measurement-factory/squid/tree/SQUID-360-peering-for-SslBump">https://github.com/measurement-factory/squid/tree/SQUID-360-peering-for-SslBump</A>&gt;.


Second is that if PRX1 or PRX2 can be configured as a regular TLS proxy
- receiving proxy traffic to a https_port (or any non-Squid software'
equivalent). Then it can be used as a cache_peer with 'ssl' option(s).
This option restricts you to the dangerous client-first style bumping,
but you are already using that.


Third is that the DEVICE is set to pass <A HREF="https://">https://</A> URLs to PRX2 using
regular TCP connections and HTTP rather than TLS. That leaves the PRX3
able to relay the non-encrypted requests to a peer as-is. Whichever
upstream PRX1 or PRX2 is used will need to do the encryption part before
the traffic hits the Internet.
 Despite the use of TCP connections this is slightly better than the
client-first bumping. At least each agent in the chain is clear and
truthful about the security properties of its connections.


Fourth is a workaround using NAT interception of port 443 and two
proxies. If you setup a PRX-A doing the bump but acting as if it had a
direct network connection. The PRX-B using a https_port with &quot;intercept
ssl-bump&quot; options and doing splice on all traffic and passing the
resulting CONNECT tunnels through to the PRX1 or PRX2.


All these have actually been used by some installations at one point or
another. So there is precedent, though YMMV which works for you.
 I expect #4 can also be done as a variant with SMP workers in PRX3
instead of separate proxies - that I am not aware of anyone doing though.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019799.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
	<LI>Next message (by thread): <A HREF="019804.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19801">[ date ]</a>
              <a href="thread.html#19801">[ thread ]</a>
              <a href="subject.html#19801">[ subject ]</a>
              <a href="author.html#19801">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
