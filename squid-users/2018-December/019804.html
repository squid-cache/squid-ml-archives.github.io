<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump with HTTP Cache Peer Parent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20with%20HTTP%20Cache%20Peer%20Parent&In-Reply-To=%3C410c342c-9f6d-51fc-26e4-bf0412b77531%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019801.html">
   <LINK REL="Next"  HREF="019805.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump with HTTP Cache Peer Parent</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20with%20HTTP%20Cache%20Peer%20Parent&In-Reply-To=%3C410c342c-9f6d-51fc-26e4-bf0412b77531%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL Bump with HTTP Cache Peer Parent">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Dec 13 03:12:00 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019801.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
        <LI>Next message (by thread): <A HREF="019805.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19804">[ date ]</a>
              <a href="thread.html#19804">[ thread ]</a>
              <a href="subject.html#19804">[ subject ]</a>
              <a href="author.html#19804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>[ please keep the traffic on-list. If you want private assistance I do
consult for a small fee. ]


On 13/12/18 2:51 pm, Sam Handley wrote:
&gt;<i> On 13/12/18 12:00 pm, Amos Jeffries wrote:
</I>&gt;<i> 
</I>&gt;<i> Thank you for your reply, it seems adding in an extra step could solve it, even if not ideal.
</I>&gt;<i> Just a few questions about your suggestions./Second is that if PRX1 or PRX2 can be configured as a regular TLS proxy
</I>&gt;<i> - receiving proxy traffic to a https_port (or any non-Squid software'
</I>&gt;<i> equivalent). Then it can be used as a cache_peer with 'ssl' option(s). /Would both PRX1 and PRX2 require https_port to be configured?
</I>

It would yes. That config setting on the receiving proxy is what makes
it a &quot;TLS proxy&quot; instead of just a proxy.


&gt;<i> We have a limited ability to edit PRX2 and it does not have https_port enabled. /This option restricts you to the dangerous client-first style bumping,
</I>&gt;<i> but you are already using that. /My experience so far is that performing any kind of bump action after step1 results in the connection being TUNNELLED and not cached by PRX1.
</I>
The only thing which would result in <A HREF="https://">https://</A> traffic being cached in
PRX1 is for PRX1 to be doing the decrypt SSL-Bump itself, or acting at a
TLS proxy.

Traffic which has <A HREF="https://">https://</A> URL scheme should only ever leave Squid over
an encrypted connection. Especially when &quot;bump&quot; is happening.


&gt;<i> For example, 
</I>&gt;<i> 1.
</I>&gt;<i> ssl_bump bump step2 all #results in the connection TUNNELLING and no caching.
</I>&gt;<i> 
</I>
Your description earlier was the SSL-Bump and cache happening in PRX3.

PRX1 and PRX2 being regular proxies will see tunnels ... or nothing at all.


&gt;<i> 2.
</I>&gt;<i> ssl_bump peek step2 all
</I>&gt;<i> ssl_bump bump step3 all #results in the connection TUNNELLING and no caching.
</I>
IIRC, your lack of a Step-1 action implies tunneling.

The &quot;peek&quot; at Step-2 prohibits &quot;bump&quot; being used at Step-3. So even if
my recollection was incorrect above you get a tunnel from this step-3.


To decrypt and cache the traffic needs to be going through one of these
SSL-Bump sequences:

  bump, terminate, terminate
  peek, bump, terminate
  stare, bump, terminate
  peek, stare, bump
  stare, stare, bump

The terminate are just there as a catch-all for traffic which bump fails
for any reason. You could try splice instead of you want, but that will
also fail sometimes - terminate is the reliable one.


&gt;<i> 
</I>&gt;<i> It would be preferred to use server-first if it did indeed cache the content, can you provide a more ideal bump configuration that will still allow us to cache HTTPS.
</I>&gt;<i> 
</I>
For that set of requirements you are limited to the possibility #1, #3
or #4 from the set I wrote up earlier.

To always bump, and with server-first style you need to start with these
ssl_bump rules in PRX3:

  ssl_bump peek step1
  ssl_bump stare
  ssl_bump bump

... adding terminate or splice actions as needed for non-caching of
traffic which has issues with the bumping or you are prohibited from
decrypting.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019801.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
	<LI>Next message (by thread): <A HREF="019805.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19804">[ date ]</a>
              <a href="thread.html#19804">[ thread ]</a>
              <a href="subject.html#19804">[ subject ]</a>
              <a href="author.html#19804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
