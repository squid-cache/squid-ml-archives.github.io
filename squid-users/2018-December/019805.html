<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Bump with HTTP Cache Peer Parent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20with%20HTTP%20Cache%20Peer%20Parent&In-Reply-To=%3C9d0b5e7a-17fb-dc61-8bb5-074a5b5f30f9%40myriadworks.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019804.html">
   <LINK REL="Next"  HREF="019806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Bump with HTTP Cache Peer Parent</H1>
    <B>Sam Handley</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Bump%20with%20HTTP%20Cache%20Peer%20Parent&In-Reply-To=%3C9d0b5e7a-17fb-dc61-8bb5-074a5b5f30f9%40myriadworks.org%3E"
       TITLE="[squid-users] SSL Bump with HTTP Cache Peer Parent">sam at myriadworks.org
       </A><BR>
    <I>Thu Dec 13 05:03:16 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019804.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
        <LI>Next message (by thread): <A HREF="019806.html">[squid-users] a bit off topic. New user question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19805">[ date ]</a>
              <a href="thread.html#19805">[ thread ]</a>
              <a href="subject.html#19805">[ subject ]</a>
              <a href="author.html#19805">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 13/12/18 2:12 pm, Amos Jeffries wrote:
&gt;<i> [ please keep the traffic on-list. If you want private assistance I do
</I>&gt;<i> consult for a small fee. ]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 13/12/18 2:51 pm, Sam Handley wrote:
</I>&gt;&gt;<i> On 13/12/18 12:00 pm, Amos Jeffries wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for your reply, it seems adding in an extra step could solve it, even if not ideal.
</I>&gt;&gt;<i> Just a few questions about your suggestions./Second is that if PRX1 or PRX2 can be configured as a regular TLS proxy
</I>&gt;&gt;<i> - receiving proxy traffic to a https_port (or any non-Squid software'
</I>&gt;&gt;<i> equivalent). Then it can be used as a cache_peer with 'ssl' option(s). /Would both PRX1 and PRX2 require https_port to be configured?
</I>&gt;<i>
</I>&gt;<i> It would yes. That config setting on the receiving proxy is what makes
</I>&gt;<i> it a &quot;TLS proxy&quot; instead of just a proxy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> We have a limited ability to edit PRX2 and it does not have https_port enabled. /This option restricts you to the dangerous client-first style bumping,
</I>&gt;&gt;<i> but you are already using that. /My experience so far is that performing any kind of bump action after step1 results in the connection being TUNNELLED and not cached by PRX1.
</I>&gt;<i> The only thing which would result in <A HREF="https://">https://</A> traffic being cached in
</I>&gt;<i> PRX1 is for PRX1 to be doing the decrypt SSL-Bump itself, or acting at a
</I>&gt;<i> TLS proxy.
</I>&gt;<i>
</I>&gt;<i> Traffic which has <A HREF="https://">https://</A> URL scheme should only ever leave Squid over
</I>&gt;<i> an encrypted connection. Especially when &quot;bump&quot; is happening.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> For example,
</I>&gt;&gt;<i> 1.
</I>&gt;&gt;<i> ssl_bump bump step2 all #results in the connection TUNNELLING and no caching.
</I>&gt;&gt;<i>
</I>&gt;<i> Your description earlier was the SSL-Bump and cache happening in PRX3.
</I>&gt;<i>
</I>&gt;<i> PRX1 and PRX2 being regular proxies will see tunnels ... or nothing at all.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> 2.
</I>&gt;&gt;<i> ssl_bump peek step2 all
</I>&gt;&gt;<i> ssl_bump bump step3 all #results in the connection TUNNELLING and no caching.
</I>&gt;<i> IIRC, your lack of a Step-1 action implies tunneling.
</I>&gt;<i>
</I>&gt;<i> The &quot;peek&quot; at Step-2 prohibits &quot;bump&quot; being used at Step-3. So even if
</I>&gt;<i> my recollection was incorrect above you get a tunnel from this step-3.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> To decrypt and cache the traffic needs to be going through one of these
</I>&gt;<i> SSL-Bump sequences:
</I>&gt;<i>
</I>&gt;<i>    bump, terminate, terminate
</I>&gt;<i>    peek, bump, terminate
</I>&gt;<i>    stare, bump, terminate
</I>&gt;<i>    peek, stare, bump
</I>&gt;<i>    stare, stare, bump
</I>&gt;<i>
</I>&gt;<i> The terminate are just there as a catch-all for traffic which bump fails
</I>&gt;<i> for any reason. You could try splice instead of you want, but that will
</I>&gt;<i> also fail sometimes - terminate is the reliable one.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> It would be preferred to use server-first if it did indeed cache the content, can you provide a more ideal bump configuration that will still allow us to cache HTTPS.
</I>&gt;&gt;<i>
</I>&gt;<i> For that set of requirements you are limited to the possibility #1, #3
</I>&gt;<i> or #4 from the set I wrote up earlier.
</I>&gt;<i>
</I>&gt;<i> To always bump, and with server-first style you need to start with these
</I>&gt;<i> ssl_bump rules in PRX3:
</I>&gt;<i>
</I>&gt;<i>    ssl_bump peek step1
</I>&gt;<i>    ssl_bump stare
</I>&gt;<i>    ssl_bump bump
</I>&gt;<i>
</I>&gt;<i> ... adding terminate or splice actions as needed for non-caching of
</I>&gt;<i> traffic which has issues with the bumping or you are prohibited from
</I>&gt;<i> decrypting.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

Sorry, still figuring out how to use the mailing list. I will contact you directly about consultation.

I also may have mixed up the order of my proxies. You are absolutely right.

This seems like it might be the best approach.

   ssl_bump peek step1
   ssl_bump stare step2
   ssl_bump bump step3
   ssl_bump splice spliceACL

Re-reading your options 4 sounds like it may work the best for us. It is certainly the one I understand the most.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019804.html">[squid-users] SSL Bump with HTTP Cache Peer Parent
</A></li>
	<LI>Next message (by thread): <A HREF="019806.html">[squid-users] a bit off topic. New user question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19805">[ date ]</a>
              <a href="thread.html#19805">[ thread ]</a>
              <a href="subject.html#19805">[ subject ]</a>
              <a href="author.html#19805">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
