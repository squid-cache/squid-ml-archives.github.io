<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Multiple SSL certificates on same IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Multiple%20SSL%20certificates%20on%20same%20IP&In-Reply-To=%3C0f870713-6fa9-a7d1-d44d-e09a2274fc12%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019846.html">
   <LINK REL="Next"  HREF="019850.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Multiple SSL certificates on same IP</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Multiple%20SSL%20certificates%20on%20same%20IP&In-Reply-To=%3C0f870713-6fa9-a7d1-d44d-e09a2274fc12%40treenet.co.nz%3E"
       TITLE="[squid-users] Multiple SSL certificates on same IP">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 19 22:09:05 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019846.html">[squid-users] Multiple SSL certificates on same IP
</A></li>
        <LI>Next message (by thread): <A HREF="019850.html">[squid-users] Multiple SSL certificates on same IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19847">[ date ]</a>
              <a href="thread.html#19847">[ thread ]</a>
              <a href="subject.html#19847">[ subject ]</a>
              <a href="author.html#19847">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/12/18 9:29 am, Bruno de Paula Larini wrote:
&gt;<i> Em 19/12/2018 16:29, Patrick Chemla escreveu:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Having more than one IP on the server, create SSL certificates from
</I>&gt;&gt;<i> LetsEncrypt including each a list of some domains and sub-domains
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Create a very bing certificate to have squid using it (not the best
</I>&gt;&gt;<i> choice because domains are of different content, far one to the other)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Having squid managing all certificates on a single IP. (The best
</I>&gt;&gt;<i> because some domains have very high encryption needs, and LetsEncrypt
</I>&gt;&gt;<i> is not their preference)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Like a bottle in the sea: Is that possible, multiple certificates,
</I>&gt;&gt;<i> with squid 4.4 on a single IP?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Based on what I had researched recently, Squid still doesn't handle SNI
</I>&gt;<i> in accel mode, so you could set different, non-wildcard certificates to
</I>&gt;<i> the websites. See:
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-4-0-x-SNI-Support-td4682018.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-4-0-x-SNI-Support-td4682018.html</A>
</I>&gt;<i> But it would be nice if Amos could confirm if this information is still
</I>&gt;<i> true for 4.4.
</I>&gt;<i> 
</I>

There has been some progress in that I have now tested this behaviour
both with multiple certs in different files and sharing a PEM file.


OpenSSL definitely can use only one certificate per http(s)_port. Either
the _last_ loaded if several PEM files are loaded (each call to the
OpenSSL API *replaces* the certs loaded), or if one tries to work around
that by merging everything into a single PEM and only loading it all at
once - only the _first_ cert chain is ever used from that set.

There also does not appear to be any alternative API capable of loading
multiple certs into a single security context and having them used as
leaf certs. If anyone is aware of such a mechanism I would *greatly*
appreciate hearing about it.


On the other hand the GnuTLS mechanism can simply load as many PEM's as
one wants with a single cert chain in each - it &quot;just works&quot;. Providing
the appropriate cert chain for any requested domain in its serverHello,
or the first cert loaded if the domain has no cert at all.


FYI; there are other bugs apparently with the GnuTLS priority-string
settings (the tls-options= and tls-min-version=) which may prevent
advanced TLS tuning. And of course with GnuTLS builds one cannot yet
have a dual-purpose proxy also doing SSL-Bump on some traffic (if that
matters). So, YMMV as to whether GnuTLS is worthwhile switching to right
now.

If you do choose to switch the squid.conf for this feature in a GnuTLS
build would look like:

 https_port 443 accel \
    cert=/etc/squid/tls/default.example.com.pem \
    cert=/etc/squid/tls/example.net.pem \
    cert=/etc/squid/tls/example.org.pem \

 ... and so on with a PEM for each domain served by that port.

You should be able to reduce the list a bit by using wildcard certs for
the sub-domains, but I have not tested that possibility yet.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019846.html">[squid-users] Multiple SSL certificates on same IP
</A></li>
	<LI>Next message (by thread): <A HREF="019850.html">[squid-users] Multiple SSL certificates on same IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19847">[ date ]</a>
              <a href="thread.html#19847">[ thread ]</a>
              <a href="subject.html#19847">[ subject ]</a>
              <a href="author.html#19847">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
