<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Windows Squid built using MinGW and running, trying to get adapter linked in at run time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Windows%20Squid%20built%20using%20MinGW%20and%20running%2C%0A%20trying%20to%20get%20adapter%20linked%20in%20at%20run%20time&In-Reply-To=%3C243801846.716845.1545317214995%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019852.html">
   <LINK REL="Next"  HREF="019854.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Windows Squid built using MinGW and running, trying to get adapter linked in at run time</H1>
    <B>Russel McDonald</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Windows%20Squid%20built%20using%20MinGW%20and%20running%2C%0A%20trying%20to%20get%20adapter%20linked%20in%20at%20run%20time&In-Reply-To=%3C243801846.716845.1545317214995%40mail.yahoo.com%3E"
       TITLE="[squid-users] Windows Squid built using MinGW and running, trying to get adapter linked in at run time">russel_mcdonald at swbell.net
       </A><BR>
    <I>Thu Dec 20 14:46:54 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019852.html">[squid-users] SSL / TLS
</A></li>
        <LI>Next message (by thread): <A HREF="019854.html">[squid-users] Windows Squid built using MinGW and running, trying to get adapter linked in at run time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19851">[ date ]</a>
              <a href="thread.html#19851">[ thread ]</a>
              <a href="subject.html#19851">[ subject ]</a>
              <a href="author.html#19851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
I switched from Cygwin to building with MinGW, and after 8 squid code modifications, mostly include and define settings but one flat out access violation crash, I now have Squid proxy running and accessible via browser on Windows :)
And now I have built the ecap library, successfully rebuilt squid with --enable-ecap,&#160; and built the adapter.All good!
However I'm at the apparent crux of getting the adapter loaded at squid run time and failing.
I understand that(1) squid needs to link in the same exact ecap library binary that the adapter does so they can communicate correctly through that ecap,(2) we don't want to statically link in the adapter to squid.exe,(3) so that adapter needs to be a shared such library, but(4) building with MinGW creates a static library.&#160;
And I see a comment output during make:
&gt;<i> *** Warning: This system can not link to static lib archive
</I>&gt;<i> /usr/local/lib/libecap.la. *** I have the capability to make that
</I>&gt;<i> library automatically link in when *** you link to this library.
</I>&gt;<i> But I can only do this if you have a *** shared version of the
</I>&gt;<i> library, which you do not appear to have. *** But as you try to
</I>&gt;<i> build a module library, libtool will still create *** a static
</I>&gt;<i> module, that should work as long as the dlopening application ***
</I>&gt;<i> is linked with the -dlopen flag to resolve symbols at runtime.
</I>
So I did use this ./configure for squid, specifying the dlopen:
./configure LDFLAGS=&quot;-dlopen=C:/MinGW/src/ecap_adapter_sample-1.0.0/src/.libs/ecap_adapter_modifying.la&quot; --prefix=c:/squid&#160; --enable-ecap --enable-default-hostsfile=none --disable-strict-error-checking&#160; --enable-win32-service --disable-optimizations --enable-debug-cbdata --with-pidfile=/var/run/squid.pid --enable-delay-pools --disable-eui --with-filedescriptors=65536 --enable-removal-policies=lru,heap
my understanding further being that the dlopen will cause squid to not link in the adapter until run time even though that library is static. And since it is not a native Windows format library (not a dll) then squid has to run in a MinGW window. Correct?
Yet I still get:2018/12/19 22:57:32| Loading Squid module from 'C:/MinGW/src/ecap_adapter_sample-1.0.0/src/.libs/ecap_adapter_modifying.la'2018/12/19 22:57:32| FATAL: dying from an unhandled exception: file not foundterminate called after throwing an instance of 'TextException'&#160; what():&#160; file not found
If I change my squid.conf instead to load in .a instead of .la just as a test, I get this:2018/12/20 08:39:58| Loading Squid module from 'C:/MinGW/src/ecap_adapter_sample-1.0.0/src/.libs/ecap_adapter_modifying.a'2018/12/20 08:39:58| FATAL: dying from an unhandled exception: %1 is not a valid&#160;Win32 application.terminate called after throwing an instance of 'TextException'&#160; what():&#160; %1 is not a valid Win32 application.
So I know it's actually accessing that .la, which does exist at that location, yet still complains that &quot;file not found&quot;.Is it as well trying to link in another library that the adapter needs?
Russel

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181220/287d860e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181220/287d860e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019852.html">[squid-users] SSL / TLS
</A></li>
	<LI>Next message (by thread): <A HREF="019854.html">[squid-users] Windows Squid built using MinGW and running, trying to get adapter linked in at run time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19851">[ date ]</a>
              <a href="thread.html#19851">[ thread ]</a>
              <a href="subject.html#19851">[ subject ]</a>
              <a href="author.html#19851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
