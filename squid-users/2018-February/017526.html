<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 3.5.20 run out of my memory.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.20%20run%20out%20of%20my%20memory.&In-Reply-To=%3C006001d39fea%24f1851230%24d48f3690%24%40skno.by%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017525.html">
   <LINK REL="Next"  HREF="017532.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 3.5.20 run out of my memory.</H1>
    <B>Vacheslav</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%203.5.20%20run%20out%20of%20my%20memory.&In-Reply-To=%3C006001d39fea%24f1851230%24d48f3690%24%40skno.by%3E"
       TITLE="[squid-users] 3.5.20 run out of my memory.">m_zouhairy at skno.by
       </A><BR>
    <I>Wed Feb  7 08:09:14 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017525.html">[squid-users] 3.5.20 run out of my memory.
</A></li>
        <LI>Next message (by thread): <A HREF="017532.html">[squid-users] 3.5.20 run out of my memory.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17526">[ date ]</a>
              <a href="thread.html#17526">[ thread ]</a>
              <a href="subject.html#17526">[ subject ]</a>
              <a href="author.html#17526">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I cron those for memory, try it.
0                             */1 *   *   *          root                                       /usr/sbin/sysctl -w vm.drop_caches=3

0                             */1 *   *   *          root                                       /bin/sync &amp;&amp; /bin/echo 3 | /usr/bin/tee /proc/sys/vm/drop_cache

 

From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of minh hung d? hoang
Sent: Wednesday, February 7, 2018 9:35 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] 3.5.20 run out of my memory.

 

Dear all, i use squid 3.5.20 on ubuntu14 in TPROXY mode.

With basic config in squid.conf, but squid is run out of my server's memory.

Here is my configure option :

'--prefix=/usr' '--includedir=/usr/include' '--infodir=/usr/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--mandir=/usr/share/man' '--enable-inline' '--enable-async-io=24' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap' '--enable-gnuregex' '--enable-delay-pools' '--enable-cache-digests' '--enable-underscores' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--enable-http-violations' '--enable-ssl-crtd' '--enable-linux-netfilter' '--enable-ltdl-install' '--enable-ltdl-convenience' '--enable-x-accelerator-vary' '--disable-maintainer-mode' '--disable-dependency-tracking' '--disable-silent-rules' '--disable-translation' '--disable-ipv6' '--disable-ident-lookups' '--with-swapdir=/var/spool/squid' '--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid' '--with-aufs-threads=24' '--with-filedescriptors=65536' '--with-large-files' '--with-maxfd=65536' '--with-openssl' '--with-default-user=proxy' '--with-included-ltdl'
--------------------------------------



And i apply this patch before compile for disabling host forgery checks :

+diff -ur squid-3.5.20-orig/src/client_side_request.cc squid-3.5.20/src/client_side_request.cc
+--- squid-3.5.20-orig/src/client_side_request.cc    2016-07-01 13:37:50.000000000 +0200
++++ squid-3.5.20/src/client_side_request.cc    2017-03-10 16:48:08.920084072 +0100
+@@ -530,6 +530,10 @@
+             }
+             debugs(85, 3, HERE &lt;&lt; &quot;validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot; non-match from Host: IP &quot; &lt;&lt; ia-&gt;in_addrs[i]);
+         }
++    // disable fogery check. See <A HREF="https://code.nethesis.it/Nethesis/dev/issues/5088">https://code.nethesis.it/Nethesis/dev/issues/5088</A>
++        http-&gt;request-&gt;flags.hostVerified = true;
++        http-&gt;doCallouts();
++        return;
+     }
+     debugs(85, 3, HERE &lt;&lt; &quot;FAIL: validate IP &quot; &lt;&lt; clientConn-&gt;local &lt;&lt; &quot; possible from Host:&quot;);
+     hostHeaderVerifyFailed(&quot;local IP&quot;, &quot;any domain IP&quot;);

 

And here is my squid.conf ( i don't post my http_access for clearly view :()

###############################################################################
# Squid normally listens to port 3128
###############################################################################

https_port 3130 tproxy ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl/e1f19c0494badc8dc14e8c4c56a8b97a.dyn
http_port 3129 tproxy
http_port 3128

###############################################################################
# squid ssl_bump option
###############################################################################
acl step1 at_step SslBump1
acl block ssl::server_name &quot;/etc/squid/block_domain.txt&quot;
ssl_bump peek step1
ssl_bump terminate block
ssl_bump splice all
sslproxy_options NO_SSLv2,NO_SSLv3,No_Compression
sslproxy_cipher  ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL
sslproxy_cert_error deny all
sslproxy_foreign_intermediate_certs /etc/squid/intermediate_ca.pem

sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

###############################################################################
## LOGFILE OPTIONS
###############################################################################

mime_table /etc/squid/mime.conf
pid_filename /var/run/squid.pid

include /etc/squid/logging.conf
###############################################################################
## OPTIONS FOR TROUBLESHOOTING
###############################################################################

coredump_dir /var/spool/squid
debug_options ALL,1
cache_effective_user squid
cache_effective_group squid
###############################################################################
## PERSISTENT CONNECTION HANDLING
###############################################################################
 
detect_broken_pconn off
client_persistent_connections off
server_persistent_connections on

###############################################################################
## ERROR PAGE OPTIONS
###############################################################################
error_directory /usr/share/squid/errors/en
error_log_languages off

###############################################################################
## DNS OPTIONS
###############################################################################
check_hostnames off
hosts_file /etc/hosts
connect_retries 2
ipcache_low 90
ipcache_size 5024       # Maximum number of DNS IP cache entries.
fqdncache_size 3024     # Maximum number of FQDN cache entries.
pipeline_prefetch 100

###############################################################################
##  MISCELLANEOUS
###############################################################################

max_filedescriptors 65536

------------------------------------------------------------------------

 

The problem is my squid spent alot of memory. I have about 200 user, and my server is 4gb dram with 8gb swap dram but not enough !
             total       used       free     shared    buffers     cached
Mem:          3.8G       3.4G       503M       736K       181M       1.7G
-/+ buffers/cache:       1.5G       2.4G
Swap:         8.1G       9.3M       8.1G

There is any issue with my squid ?? How can i fix it ?

I have attach files for detail (squid.conf and squid-3.5.20-ssl-forgery.patch)

-- 

Thanks &amp; Best Regards,
--------------

&#272;&#7895; Ho&#224;ng Minh H&#432;ng

Gmail : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">hoangminhung at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hoangminhung at gmail.com</A>&gt; 

S&#272;T : 01234454115

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180207/35f27b06/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180207/35f27b06/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017525.html">[squid-users] 3.5.20 run out of my memory.
</A></li>
	<LI>Next message (by thread): <A HREF="017532.html">[squid-users] 3.5.20 run out of my memory.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17526">[ date ]</a>
              <a href="thread.html#17526">[ thread ]</a>
              <a href="subject.html#17526">[ subject ]</a>
              <a href="author.html#17526">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
