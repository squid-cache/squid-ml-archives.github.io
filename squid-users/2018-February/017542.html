<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.x or 4.x acting as a transparent http proxy	(NOT https)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%20proxy%0A%09%28NOT%20https%29&In-Reply-To=%3Ca6eea1d9-fec4-0e6e-9a33-bde8b9e9f8eb%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017540.html">
   <LINK REL="Next"  HREF="017543.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.x or 4.x acting as a transparent http proxy	(NOT https)</H1>
    <B>setuid</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%20proxy%0A%09%28NOT%20https%29&In-Reply-To=%3Ca6eea1d9-fec4-0e6e-9a33-bde8b9e9f8eb%40gmail.com%3E"
       TITLE="[squid-users] Squid 3.x or 4.x acting as a transparent http proxy	(NOT https)">setuid at gmail.com
       </A><BR>
    <I>Wed Feb  7 21:11:05 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017540.html">[squid-users] Default host_verify_strict behavior appears to have changed as of 3.5.25
</A></li>
        <LI>Next message (by thread): <A HREF="017543.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17542">[ date ]</a>
              <a href="thread.html#17542">[ thread ]</a>
              <a href="subject.html#17542">[ subject ]</a>
              <a href="author.html#17542">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'll start with the pointedly easy stuff: Squid &gt; 2.6 (tested 3.4, 3.5,
4.0 on Ubuntu Xenial, Debian Jessie, FreeSBD 11.1 using iptables, pf,
ipf, ipfilter) does not work at all, when configured as a transparent
proxy. Full stop.

I went through hundreds of posts on dozens of forums, blogs and other
resources, tried dozens and dozens of configurations suggested by those
posts, tried all 3 firewall options on BSD, tried two versions of Ubuntu
and the various versions of Squid from the apt repos, as well as those
in BSD's ports.

All of them, 100%, fail in _exactly_ the same way, no matter what my
configuration was set to. That result, is that _every single http
request I make_ when Squid is configured as a transparent proxy, results
in the following response being logged:

======================
	07/Feb/2018:15:10:59 -0500.213      0 192.168.1.1 TAG_NONE/400 3583 GET
/ - HIER_NONE/- text/html (&quot;-&quot; &quot;-&quot;)
======================

When I point a client directly at the proxy, using a browser, curl or
anything else, I see:

======================
	07/Feb/2018:15:12:56 -0500.875     82 192.168.1.1 TCP_MISS/302 333 HEAD
<A HREF="http://www.java.com/">http://www.java.com/</A> - HIER_DIRECT/www.java.com - (&quot;-&quot; &quot;curl/7.47.0&quot;)
======================

These were the same exact request against the same exact Squid instance.
If I use Squid 3.5 on Ubuntu or 3.5 and 4.0 on BSD, the logged entry is
_identical_ for every single http request I make, regardless of origin.

My Squid configuration is 100% default, identical to the generic config,
with the exception of the following lines:

======================
http_port 3128
http_port 3129 intercept
tcp_outgoing_address 192.168.1.25
debug_options ALL,9
======================

I've tried all of the obvious links, blogs and resources I could Google
up, and 100% of them fail to function as described. Most people I've
seen on the forums who attempt to get this working, throw their hands up
in defeat and end up configuring the proxy directly on every client that
needs it.

My current environment looks like this:

[ wireless router: 10.0.1.1 on LAN side, 192.168.1.1 on WAN side ]

That router has a firewall script on it that says:

======================
#!/bin/sh
PROXY_IP=192.168.2.25
PROXY_PORT=3128
LAN_IP=$(nvram get lan_ipaddr)
LAN_NET=$LAN_IP/$(nvram get lan_netmask)

iptables -t nat -A PREROUTING -i br0 -s $LAN_NET -d $LAN_NET -p tcp
--dport 80 -j ACCEPT
iptables -t nat -A PREROUTING -i br0 -s ! $PROXY_IP -p tcp --dport 80 -j
DNAT --to $PROXY_IP:$PROXY_PORT

iptables -t nat -I POSTROUTING -o br0 -s $LAN_NET -d $PROXY_IP -p tcp -j
SNAT --to $LAN_IP
iptables -I FORWARD -i br0 -o br0 -s $LAN_NET -d $PROXY_IP -p tcp
--dport $PROXY_PORT -j ACCEPT
======================

This takes every packet that hits the router on :80, and sends it to my
Squid server on .25, which mangles it and sends it back to 192.168.1.1
(router), and onward back to client who requested it.

When I was using 2.6 (without large_file support), I was using this same
exact configuration, but http_port was set to 'accel', and I didn't need
_any_ NAT/routing rules on the squid side at all. It all &quot;Just Worked(tm)&quot;.

Now I need to jump through hoops to do pf incantations of rdr/direct-to
(but direct-to and direct-reply aren't supported on FreeBSD's pf, only
OpenBSD's pf supports that syntax), and iptables PREROUTING and
POSTROUTING mojo (also fails).

Here's a list of some of the resources I've tried, with 100% failure in
every case. There are dozens more that I've lost in my browser history now.

* <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw">https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw</A>
*
<A HREF="https://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Interception_Caching_packet_redirection_for_OpenBSD_PF">https://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Interception_Caching_packet_redirection_for_OpenBSD_PF</A>
* <A HREF="https://www.benzedrine.ch/transquid.html">https://www.benzedrine.ch/transquid.html</A>
*
<A HREF="https://www.unix-experience.fr/2013/create-a-powerfull-proxy-cache-with-squid-and-openbsd-2/">https://www.unix-experience.fr/2013/create-a-powerfull-proxy-cache-with-squid-and-openbsd-2/</A>
*
<A HREF="https://www.cyberciti.biz/tips/linux-setup-transparent-proxy-squid-howto.html">https://www.cyberciti.biz/tips/linux-setup-transparent-proxy-squid-howto.html</A>
*
<A HREF="https://adilmehmoodbutt.wordpress.com/2014/02/19/how-to-install-squid3-transparent-proxy-server/">https://adilmehmoodbutt.wordpress.com/2014/02/19/how-to-install-squid3-transparent-proxy-server/</A>
* <A HREF="https://veesp.com/en/blog/how-to-setup-squid-on-ubuntu">https://veesp.com/en/blog/how-to-setup-squid-on-ubuntu</A>
* <A HREF="https://ubuntuforums.org/showthread.php?t=2210987">https://ubuntuforums.org/showthread.php?t=2210987</A>
*
<A HREF="http://ubuntuserverguide.com/2012/06/how-to-setup-squid3-as-transparent-proxy-on-ubuntu-server-12-04.html">http://ubuntuserverguide.com/2012/06/how-to-setup-squid3-as-transparent-proxy-on-ubuntu-server-12-04.html</A>
*
<A HREF="http://roberts.bplaced.net/index.php/linux-guides/centos-6-guides/proxy-server/squid-transparent-proxy-http-https">http://roberts.bplaced.net/index.php/linux-guides/centos-6-guides/proxy-server/squid-transparent-proxy-http-https</A>

I also tried asking in #squid on Freenode (dead channel), and #FreeBSD
(helpful folks there, but they too, failed to get this working).

So I'm at an impasse. Is this just 100% decoupled from the current
codebase, and doesn't work at all? Or is this really meant to be some
lengthy archaeology to find the right, working solution for getting this
configured in Linux or BSD?

It seems like with the hundreds of posts from people out there failing
to do this correctly, that there's a great opportunity here to a.) make
it work again like it did in v2.6, and b.) document the _precise steps_
required to make it function as a transparent http proxy [eg: install
foo, create file with these exact contents, execute this exact command,
test with this use case, if error message 'bar', do the following ].

Can anyone give me a hand here? I, like so many dozens of others, am
about to just give up and move past this, because it just does not work
anymore.

Help! :D

(Thanks in advance for making it this far in my plea)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017540.html">[squid-users] Default host_verify_strict behavior appears to have changed as of 3.5.25
</A></li>
	<LI>Next message (by thread): <A HREF="017543.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17542">[ date ]</a>
              <a href="thread.html#17542">[ thread ]</a>
              <a href="subject.html#17542">[ subject ]</a>
              <a href="author.html#17542">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
