<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%0A%20proxy%20%28NOT%20https%29&In-Reply-To=%3Cbf4ba597-ec37-6f72-d9f7-df15b4855039%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017543.html">
   <LINK REL="Next"  HREF="017550.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%0A%20proxy%20%28NOT%20https%29&In-Reply-To=%3Cbf4ba597-ec37-6f72-d9f7-df15b4855039%40gmail.com%3E"
       TITLE="[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)">yvoinov at gmail.com
       </A><BR>
    <I>Wed Feb  7 21:31:10 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017543.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
        <LI>Next message (by thread): <A HREF="017550.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17544">[ date ]</a>
              <a href="thread.html#17544">[ thread ]</a>
              <a href="subject.html#17544">[ subject ]</a>
              <a href="author.html#17544">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>One stupid idiotic question.

Did you build your squid with transparent NAT support?

This is mandatory prerequisite for transparent squid.

I'm not seen your configuration options for squid. Not squid.conf. Just
./configure options.


08.02.2018 03:11, setuid &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> I'll start with the pointedly easy stuff: Squid &gt; 2.6 (tested 3.4, 3.5,
</I>&gt;<i> 4.0 on Ubuntu Xenial, Debian Jessie, FreeSBD 11.1 using iptables, pf,
</I>&gt;<i> ipf, ipfilter) does not work at all, when configured as a transparent
</I>&gt;<i> proxy. Full stop.
</I>&gt;<i>
</I>&gt;<i> I went through hundreds of posts on dozens of forums, blogs and other
</I>&gt;<i> resources, tried dozens and dozens of configurations suggested by those
</I>&gt;<i> posts, tried all 3 firewall options on BSD, tried two versions of Ubuntu
</I>&gt;<i> and the various versions of Squid from the apt repos, as well as those
</I>&gt;<i> in BSD's ports.
</I>&gt;<i>
</I>&gt;<i> All of them, 100%, fail in _exactly_ the same way, no matter what my
</I>&gt;<i> configuration was set to. That result, is that _every single http
</I>&gt;<i> request I make_ when Squid is configured as a transparent proxy, results
</I>&gt;<i> in the following response being logged:
</I>&gt;<i>
</I>&gt;<i> ======================
</I>&gt;<i> 	07/Feb/2018:15:10:59 -0500.213      0 192.168.1.1 TAG_NONE/400 3583 GET
</I>&gt;<i> / - HIER_NONE/- text/html (&quot;-&quot; &quot;-&quot;)
</I>&gt;<i> ======================
</I>&gt;<i>
</I>&gt;<i> When I point a client directly at the proxy, using a browser, curl or
</I>&gt;<i> anything else, I see:
</I>&gt;<i>
</I>&gt;<i> ======================
</I>&gt;<i> 	07/Feb/2018:15:12:56 -0500.875     82 192.168.1.1 TCP_MISS/302 333 HEAD
</I>&gt;<i> <A HREF="http://www.java.com/">http://www.java.com/</A> - HIER_DIRECT/www.java.com - (&quot;-&quot; &quot;curl/7.47.0&quot;)
</I>&gt;<i> ======================
</I>&gt;<i>
</I>&gt;<i> These were the same exact request against the same exact Squid instance.
</I>&gt;<i> If I use Squid 3.5 on Ubuntu or 3.5 and 4.0 on BSD, the logged entry is
</I>&gt;<i> _identical_ for every single http request I make, regardless of origin.
</I>&gt;<i>
</I>&gt;<i> My Squid configuration is 100% default, identical to the generic config,
</I>&gt;<i> with the exception of the following lines:
</I>&gt;<i>
</I>&gt;<i> ======================
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> tcp_outgoing_address 192.168.1.25
</I>&gt;<i> debug_options ALL,9
</I>&gt;<i> ======================
</I>&gt;<i>
</I>&gt;<i> I've tried all of the obvious links, blogs and resources I could Google
</I>&gt;<i> up, and 100% of them fail to function as described. Most people I've
</I>&gt;<i> seen on the forums who attempt to get this working, throw their hands up
</I>&gt;<i> in defeat and end up configuring the proxy directly on every client that
</I>&gt;<i> needs it.
</I>&gt;<i>
</I>&gt;<i> My current environment looks like this:
</I>&gt;<i>
</I>&gt;<i> [ wireless router: 10.0.1.1 on LAN side, 192.168.1.1 on WAN side ]
</I>&gt;<i>
</I>&gt;<i> That router has a firewall script on it that says:
</I>&gt;<i>
</I>&gt;<i> ======================
</I>&gt;<i> #!/bin/sh
</I>&gt;<i> PROXY_IP=192.168.2.25
</I>&gt;<i> PROXY_PORT=3128
</I>&gt;<i> LAN_IP=$(nvram get lan_ipaddr)
</I>&gt;<i> LAN_NET=$LAN_IP/$(nvram get lan_netmask)
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -A PREROUTING -i br0 -s $LAN_NET -d $LAN_NET -p tcp
</I>&gt;<i> --dport 80 -j ACCEPT
</I>&gt;<i> iptables -t nat -A PREROUTING -i br0 -s ! $PROXY_IP -p tcp --dport 80 -j
</I>&gt;<i> DNAT --to $PROXY_IP:$PROXY_PORT
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -I POSTROUTING -o br0 -s $LAN_NET -d $PROXY_IP -p tcp -j
</I>&gt;<i> SNAT --to $LAN_IP
</I>&gt;<i> iptables -I FORWARD -i br0 -o br0 -s $LAN_NET -d $PROXY_IP -p tcp
</I>&gt;<i> --dport $PROXY_PORT -j ACCEPT
</I>&gt;<i> ======================
</I>&gt;<i>
</I>&gt;<i> This takes every packet that hits the router on :80, and sends it to my
</I>&gt;<i> Squid server on .25, which mangles it and sends it back to 192.168.1.1
</I>&gt;<i> (router), and onward back to client who requested it.
</I>&gt;<i>
</I>&gt;<i> When I was using 2.6 (without large_file support), I was using this same
</I>&gt;<i> exact configuration, but http_port was set to 'accel', and I didn't need
</I>&gt;<i> _any_ NAT/routing rules on the squid side at all. It all &quot;Just Worked(tm)&quot;.
</I>&gt;<i>
</I>&gt;<i> Now I need to jump through hoops to do pf incantations of rdr/direct-to
</I>&gt;<i> (but direct-to and direct-reply aren't supported on FreeBSD's pf, only
</I>&gt;<i> OpenBSD's pf supports that syntax), and iptables PREROUTING and
</I>&gt;<i> POSTROUTING mojo (also fails).
</I>&gt;<i>
</I>&gt;<i> Here's a list of some of the resources I've tried, with 100% failure in
</I>&gt;<i> every case. There are dozens more that I've lost in my browser history now.
</I>&gt;<i>
</I>&gt;<i> * <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw">https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Interception_Caching_packet_redirection_for_OpenBSD_PF">https://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Interception_Caching_packet_redirection_for_OpenBSD_PF</A>
</I>&gt;<i> * <A HREF="https://www.benzedrine.ch/transquid.html">https://www.benzedrine.ch/transquid.html</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="https://www.unix-experience.fr/2013/create-a-powerfull-proxy-cache-with-squid-and-openbsd-2/">https://www.unix-experience.fr/2013/create-a-powerfull-proxy-cache-with-squid-and-openbsd-2/</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="https://www.cyberciti.biz/tips/linux-setup-transparent-proxy-squid-howto.html">https://www.cyberciti.biz/tips/linux-setup-transparent-proxy-squid-howto.html</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="https://adilmehmoodbutt.wordpress.com/2014/02/19/how-to-install-squid3-transparent-proxy-server/">https://adilmehmoodbutt.wordpress.com/2014/02/19/how-to-install-squid3-transparent-proxy-server/</A>
</I>&gt;<i> * <A HREF="https://veesp.com/en/blog/how-to-setup-squid-on-ubuntu">https://veesp.com/en/blog/how-to-setup-squid-on-ubuntu</A>
</I>&gt;<i> * <A HREF="https://ubuntuforums.org/showthread.php?t=2210987">https://ubuntuforums.org/showthread.php?t=2210987</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="http://ubuntuserverguide.com/2012/06/how-to-setup-squid3-as-transparent-proxy-on-ubuntu-server-12-04.html">http://ubuntuserverguide.com/2012/06/how-to-setup-squid3-as-transparent-proxy-on-ubuntu-server-12-04.html</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="http://roberts.bplaced.net/index.php/linux-guides/centos-6-guides/proxy-server/squid-transparent-proxy-http-https">http://roberts.bplaced.net/index.php/linux-guides/centos-6-guides/proxy-server/squid-transparent-proxy-http-https</A>
</I>&gt;<i>
</I>&gt;<i> I also tried asking in #squid on Freenode (dead channel), and #FreeBSD
</I>&gt;<i> (helpful folks there, but they too, failed to get this working).
</I>&gt;<i>
</I>&gt;<i> So I'm at an impasse. Is this just 100% decoupled from the current
</I>&gt;<i> codebase, and doesn't work at all? Or is this really meant to be some
</I>&gt;<i> lengthy archaeology to find the right, working solution for getting this
</I>&gt;<i> configured in Linux or BSD?
</I>&gt;<i>
</I>&gt;<i> It seems like with the hundreds of posts from people out there failing
</I>&gt;<i> to do this correctly, that there's a great opportunity here to a.) make
</I>&gt;<i> it work again like it did in v2.6, and b.) document the _precise steps_
</I>&gt;<i> required to make it function as a transparent http proxy [eg: install
</I>&gt;<i> foo, create file with these exact contents, execute this exact command,
</I>&gt;<i> test with this use case, if error message 'bar', do the following ].
</I>&gt;<i>
</I>&gt;<i> Can anyone give me a hand here? I, like so many dozens of others, am
</I>&gt;<i> about to just give up and move past this, because it just does not work
</I>&gt;<i> anymore.
</I>&gt;<i>
</I>&gt;<i> Help! :D
</I>&gt;<i>
</I>&gt;<i> (Thanks in advance for making it this far in my plea)
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
*****************************
* C++20 : Bug to the future *
*****************************


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 659 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180208/2c3ce30d/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180208/2c3ce30d/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017543.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
	<LI>Next message (by thread): <A HREF="017550.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17544">[ date ]</a>
              <a href="thread.html#17544">[ thread ]</a>
              <a href="subject.html#17544">[ subject ]</a>
              <a href="author.html#17544">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
