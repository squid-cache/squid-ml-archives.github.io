<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%0A%20proxy%20%28NOT%20https%29&In-Reply-To=%3C0ed78436-0ec7-5bfd-edf5-55591924e79e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017555.html">
   <LINK REL="Next"  HREF="017545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%0A%20proxy%20%28NOT%20https%29&In-Reply-To=%3C0ed78436-0ec7-5bfd-edf5-55591924e79e%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb  8 03:56:56 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017555.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
        <LI>Next message (by thread): <A HREF="017545.html">[squid-users] Squid 3.x or 4.x acting as a transparent http	proxy	(NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17556">[ date ]</a>
              <a href="thread.html#17556">[ thread ]</a>
              <a href="subject.html#17556">[ subject ]</a>
              <a href="author.html#17556">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/02/18 12:44, setuid wrote:
&gt;<i> On 2/7/18 6:36 PM, Yuri wrote:
</I>&gt;&gt;<i> Did you used ipfw NAT configuration on same box with squid?
</I>&gt;<i> 
</I>&gt;<i> Yes, my ipfw configuration is:
</I>&gt;<i> 
</I>&gt;<i> $cmd 00700 deny ip from any to any dst-port 3128 via em0
</I>&gt;<i> $cmd 00800 fwd 3128 tcp from 192.168.1.25 to any dst-port 80 via em0
</I>&gt;<i> $cmd 00820 allow ip from any to any dst-port 3128 dst-ip 192.168.1.25
</I>&gt;<i> src-ip 192.168.1.1
</I>&gt;<i> $cmd add 60000 permit ip from any to any
</I>

Earlier you wrote:


&gt;<i> My Squid configuration is 100% default, identical to the generic config,
</I>&gt;<i> with the exception of the following lines:
</I>&gt;<i>
</I>&gt;<i> ======================
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> tcp_outgoing_address 192.168.1.25
</I>&gt;<i> debug_options ALL,9
</I>&gt;<i> ======================
</I>

Your IPFW rules are sending intercepted traffic to port 3128.

HTTP traffic comes in multiple flavours/types. Squid-3+ enforce the port
&quot;mode&quot; for matches the type of traffic arriving to maintain traffic
integrity in the face of security vulnerabilities relevant (or not) to
each traffic type.

This adds some natural limitations which were not previously visible in
Squid-2 which was broken, just not informing you of the problem(s).

These are:

* you MUST configure NAT on the same device / machine / VM that Squid is
running on. Squid requires access directly to the kernel NAT tables.

* you MUST only send traffic of a given type to the port with matching
&quot;mode&quot; flag.
 - explicit/forward proxy is implied when *no* more specific mode is
supplied,
 - NAT traffic requires &quot;intercept&quot; flag,
 - TPROXY traffic requires &quot;tproxy&quot; flag, and
 - interception of HTTPS traffic requires &quot;ssl-bump&quot; flag (which can be
combined with the others)



Also, were the build options displayed earlier the same ones you used
for testing *BSD and Linux systems?
 The Linux Netfilter and *BSD PF NAT systems will never work if you
disable them and permit *only* IPFW-transparent in the Squid build.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017555.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
	<LI>Next message (by thread): <A HREF="017545.html">[squid-users] Squid 3.x or 4.x acting as a transparent http	proxy	(NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17556">[ date ]</a>
              <a href="thread.html#17556">[ thread ]</a>
              <a href="subject.html#17556">[ subject ]</a>
              <a href="author.html#17556">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
