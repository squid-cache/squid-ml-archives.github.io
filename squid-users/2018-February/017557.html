<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%0A%20proxy%20%28NOT%20https%29&In-Reply-To=%3Cb8912b35-15e3-247e-81d6-2621d4a325e3%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017553.html">
   <LINK REL="Next"  HREF="017694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.x%20or%204.x%20acting%20as%20a%20transparent%20http%0A%20proxy%20%28NOT%20https%29&In-Reply-To=%3Cb8912b35-15e3-247e-81d6-2621d4a325e3%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Feb  8 08:13:18 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017553.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
        <LI>Next message (by thread): <A HREF="017694.html">[squid-users] Squid 3.x or 4.x acting as a transparent http	proxy (NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17557">[ date ]</a>
              <a href="thread.html#17557">[ thread ]</a>
              <a href="subject.html#17557">[ subject ]</a>
              <a href="author.html#17557">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 08/02/18 10:11, setuid wrote:
&gt;<i> I'll start with the pointedly easy stuff: Squid &gt; 2.6 (tested 3.4, 3.5,
</I>&gt;<i> 4.0 on Ubuntu Xenial, Debian Jessie, FreeSBD 11.1 using iptables, pf,
</I>&gt;<i> ipf, ipfilter) does not work at all, when configured as a transparent
</I>&gt;<i> proxy. Full stop.
</I>&gt;<i> 
</I>&gt;<i> I went through hundreds of posts on dozens of forums, blogs and other
</I>&gt;<i> resources, tried dozens and dozens of configurations suggested by those
</I>&gt;<i> posts, tried all 3 firewall options on BSD, tried two versions of Ubuntu
</I>&gt;<i> and the various versions of Squid from the apt repos, as well as those
</I>&gt;<i> in BSD's ports.
</I>&gt;<i> 
</I>&gt;<i> All of them, 100%, fail in _exactly_ the same way, no matter what my
</I>&gt;<i> configuration was set to. That result, is that _every single http
</I>&gt;<i> request I make_ when Squid is configured as a transparent proxy, results
</I>&gt;<i> in the following response being logged:
</I>&gt;<i> 
</I>&gt;<i> ======================
</I>&gt;<i> 	07/Feb/2018:15:10:59 -0500.213      0 192.168.1.1 TAG_NONE/400 3583 GET
</I>&gt;<i> / - HIER_NONE/- text/html (&quot;-&quot; &quot;-&quot;)
</I>&gt;<i> ======================
</I>&gt;<i> 
</I>&gt;<i> When I point a client directly at the proxy, using a browser, curl or
</I>&gt;<i> anything else, I see:
</I>&gt;<i> 
</I>&gt;<i> ======================
</I>&gt;<i> 	07/Feb/2018:15:12:56 -0500.875     82 192.168.1.1 TCP_MISS/302 333 HEAD
</I>&gt;<i> <A HREF="http://www.java.com/">http://www.java.com/</A> - HIER_DIRECT/www.java.com - (&quot;-&quot; &quot;curl/7.47.0&quot;)
</I>&gt;<i> ======================
</I>&gt;<i> 
</I>&gt;<i> These were the same exact request against the same exact Squid instance.
</I>
Lets start with the obvious then. HEAD is Not the same as GET. These are
*different* requests. Therefore something major is wrong with your
understanding of the situation.


&gt;<i> If I use Squid 3.5 on Ubuntu or 3.5 and 4.0 on BSD, the logged entry is
</I>&gt;<i> _identical_ for every single http request I make, regardless of origin.
</I>&gt;<i> 
</I>&gt;<i> My Squid configuration is 100% default, identical to the generic config,
</I>&gt;<i> with the exception of the following lines:
</I>&gt;<i> 
</I>&gt;<i> ======================
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> tcp_outgoing_address 192.168.1.25
</I>&gt;<i> debug_options ALL,9
</I>&gt;<i> ======================
</I>&gt;<i> 
</I>&gt;<i> I've tried all of the obvious links, blogs and resources I could Google
</I>&gt;<i> up, and 100% of them fail to function as described. Most people I've
</I>&gt;<i> seen on the forums who attempt to get this working, throw their hands up
</I>&gt;<i> in defeat and end up configuring the proxy directly on every client that
</I>&gt;<i> needs it.
</I>&gt;<i> 
</I>&gt;<i> My current environment looks like this:
</I>&gt;<i> 
</I>&gt;<i> [ wireless router: 10.0.1.1 on LAN side, 192.168.1.1 on WAN side ]
</I>&gt;<i> 
</I>&gt;<i> That router has a firewall script on it that says:
</I>&gt;<i> 
</I>&gt;<i> ======================
</I>&gt;<i> #!/bin/sh
</I>&gt;<i> PROXY_IP=192.168.2.25
</I>&gt;<i> PROXY_PORT=3128
</I>&gt;<i> LAN_IP=$(nvram get lan_ipaddr)
</I>&gt;<i> LAN_NET=$LAN_IP/$(nvram get lan_netmask)
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -i br0 -s $LAN_NET -d $LAN_NET -p tcp
</I>&gt;<i> --dport 80 -j ACCEPT
</I>&gt;<i> iptables -t nat -A PREROUTING -i br0 -s ! $PROXY_IP -p tcp --dport 80 -j
</I>&gt;<i> DNAT --to $PROXY_IP:$PROXY_PORT
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -I POSTROUTING -o br0 -s $LAN_NET -d $PROXY_IP -p tcp -j
</I>&gt;<i> SNAT --to $LAN_IP
</I>&gt;<i> iptables -I FORWARD -i br0 -o br0 -s $LAN_NET -d $PROXY_IP -p tcp
</I>&gt;<i> --dport $PROXY_PORT -j ACCEPT
</I>&gt;<i> ======================
</I>&gt;<i> 
</I>&gt;<i> This takes every packet that hits the router on :80, and sends it to my
</I>&gt;<i> Squid server on .25, which mangles it and sends it back to 192.168.1.1
</I>&gt;<i> (router), and onward back to client who requested it.
</I>&gt;<i> 
</I>
No. This takes HTTP (port 80 syntax) and sends it to a remote proxy
expecting explicit-proxy syntax.


&gt;<i> When I was using 2.6 (without large_file support), I was using this same
</I>&gt;<i> exact configuration, but http_port was set to 'accel', and I didn't need
</I>&gt;<i> _any_ NAT/routing rules on the squid side at all. It all &quot;Just Worked(tm)&quot;.
</I>

It also &quot;Just Worked&quot; for anyone attacking your network via
CVE-2009-0801 methods. And would provide them with an effective
invisibility cloak while doing so (original IP:ports destroyed by the NAT).
 Not exactly desirable behaviour.



&gt;<i> 
</I>&gt;<i> Now I need to jump through hoops to do pf incantations of rdr/direct-to
</I>&gt;<i> (but direct-to and direct-reply aren't supported on FreeBSD's pf, only
</I>&gt;<i> OpenBSD's pf supports that syntax), and iptables PREROUTING and
</I>&gt;<i> POSTROUTING mojo (also fails).
</I>&gt;<i> 
</I>
You need simply *route* traffic properly in the way the Internet was
designed to work. Instead of abusing NAT.

When that is done properly the NAT happens *only* as the final step to
get the traffic into the Squid process by the machine/device/VM Squid is
running on.


&gt;<i> Here's a list of some of the resources I've tried, with 100% failure in
</I>&gt;<i> every case. There are dozens more that I've lost in my browser history now.
</I>&gt;<i> 
</I>&gt;<i> * <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw">https://wiki.squid-cache.org/ConfigExamples/Intercept/Ipfw</A>
</I>&gt;<i> *
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Interception_Caching_packet_redirection_for_OpenBSD_PF">https://wiki.squid-cache.org/SquidFaq/InterceptionProxy#Interception_Caching_packet_redirection_for_OpenBSD_PF</A>
</I>
Hmm. I see that page is updated and missing quote a few things. Thanks
for bringing this to attention.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017553.html">[squid-users] Squid 3.x or 4.x acting as a transparent http proxy (NOT https)
</A></li>
	<LI>Next message (by thread): <A HREF="017694.html">[squid-users] Squid 3.x or 4.x acting as a transparent http	proxy (NOT https)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17557">[ date ]</a>
              <a href="thread.html#17557">[ thread ]</a>
              <a href="subject.html#17557">[ subject ]</a>
              <a href="author.html#17557">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
