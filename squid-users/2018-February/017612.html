<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache reference age for heap LRU/LFUDA and rock/aufs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20reference%20age%20for%20heap%20LRU/LFUDA%20and%0A%20rock/aufs&In-Reply-To=%3C3f657f87-1776-fa5e-ad39-bf251f8b63f6%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017610.html">
   <LINK REL="Next"  HREF="017580.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache reference age for heap LRU/LFUDA and rock/aufs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20reference%20age%20for%20heap%20LRU/LFUDA%20and%0A%20rock/aufs&In-Reply-To=%3C3f657f87-1776-fa5e-ad39-bf251f8b63f6%40measurement-factory.com%3E"
       TITLE="[squid-users] Cache reference age for heap LRU/LFUDA and rock/aufs">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 13 15:45:18 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017610.html">[squid-users] Cache reference age for heap LRU/LFUDA and	rock/aufs
</A></li>
        <LI>Next message (by thread): <A HREF="017580.html">[squid-users] How to hide client info?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17612">[ date ]</a>
              <a href="thread.html#17612">[ thread ]</a>
              <a href="subject.html#17612">[ subject ]</a>
              <a href="author.html#17612">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/12/2018 04:25 PM, Ivan Larionov wrote:
&gt;<i> On Fri, Feb 9, 2018 at 7:50 PM, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     please note that rock
</I>&gt;<i>     cache_dirs do not support/have/use a configurable replacement policy:
</I>&gt;<i>     Each incoming object is assigned a slot based on its key hash. With
</I>&gt;<i>     modern rock code, it is possible to remove that limitation IIRC, but
</I>&gt;<i>     nobody have done that.
</I>
&gt;<i> So what does rock do when storage is full then?
</I>
Becoming full is not a special condition for rock cache_dirs. In other
words, a rock cache_dir does not do anything special when it becomes (or
is) full.

Roughly speaking, when a rock cache_dir needs to store a new entry, it
computes its starting location by hashing the entry URL and starts
storing the entry at that location, overwriting any cached entry that
used the same starting location. Same for the shared memory cache. See
Ipc::StoreMap::openForWriting().

Rock is meant/optimized for large caches. The probability of overwriting
a valuable entry in a large cache is small -- most cached entries are
not valuable because they will never be requested again.

Needless to say, there are cases where such crude approach is harmful
(e.g., two popular entries competing for the same unlucky location and
overwriting each other). As I said, modern SMP caching code may have
enough bells and whistles to support such cases better, but the required
changes are still far from trivial, and nobody has contributed or
sponsored that improvement (yet?).


&gt;<i>     If it is important to get this right, then I would not trust replacement
</I>&gt;<i>     policy metadata with this: The corresponding code interfaces look
</I>&gt;<i>     unreliable to me, and access counts/timestamps for a ufs-based cache_dir
</I>&gt;<i>     are not updated across Squid restarts when the swap log is lost (at
</I>&gt;<i>     least).
</I>
&gt;<i> It's actually fine, we never restart squid and if it restarted by any
</I>&gt;<i> unexpected reason (host reboot, crash or w/e) we just replace the host.
</I>
FWIW, please note that my &quot;unreliable&quot; remark applies to Squids that are
never restarted. YMMV.


&gt;<i>     If there is no &quot;age&quot; ACL to use with the send_hit directive, then you
</I>&gt;<i>     may need to add one.
</I>&gt;<i> 
</I>&gt;<i> I was thinking about similar solution but this is exactly why I wasn't
</I>&gt;<i> able to use it &#8211; there seems to be no acl suitable for such task.
</I>
IMO, treating Squid feature set as a constant outside of your control
means ignoring 50% of Squid advantages (while suffering from 100% of its
drawbacks). One can add the missing pieces:

<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017610.html">[squid-users] Cache reference age for heap LRU/LFUDA and	rock/aufs
</A></li>
	<LI>Next message (by thread): <A HREF="017580.html">[squid-users] How to hide client info?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17612">[ date ]</a>
              <a href="thread.html#17612">[ thread ]</a>
              <a href="subject.html#17612">[ subject ]</a>
              <a href="author.html#17612">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
