<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Can cache_peer be localhost?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Can%20cache_peer%20be%20localhost%3F&In-Reply-To=%3C8b12ba6f-211d-9d46-933f-96425b72f40c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017631.html">
   <LINK REL="Next"  HREF="017646.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Can cache_peer be localhost?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Can%20cache_peer%20be%20localhost%3F&In-Reply-To=%3C8b12ba6f-211d-9d46-933f-96425b72f40c%40treenet.co.nz%3E"
       TITLE="[squid-users] Can cache_peer be localhost?">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Feb 17 10:17:01 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017631.html">[squid-users] Can cache_peer be localhost?
</A></li>
        <LI>Next message (by thread): <A HREF="017646.html">[squid-users] Can cache_peer be localhost?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17633">[ date ]</a>
              <a href="thread.html#17633">[ thread ]</a>
              <a href="subject.html#17633">[ subject ]</a>
              <a href="author.html#17633">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/02/18 15:05, Peng Yu wrote:
&gt;<i> Hi, I have the following configuration. When I access port 3129 and it
</I>&gt;<i> is localhost's turn in the round-robin, then the access will fail. Is
</I>&gt;<i> there a way to make it work?
</I>&gt;<i> 
</I>&gt;<i> $ grep -v '^#' squid.conf|grep -v '^$'
</I>...
&gt;<i> http_port 3128
</I>
This port receives localhost:3128 traffic.

&gt;<i> http_port 3129
</I>&gt;<i> acl port_3129_acl myportname 3129
</I>&gt;<i> cache_peer server1 parent 3128 0 round-robin no-query name=server1_3128
</I>&gt;<i> cache_peer_access server1_3128 allow port_3129_acl
</I>&gt;<i> cache_peer localhost parent 3128 0 round-robin no-query name=localhost_3128
</I>&gt;<i> cache_peer_access localhost_3128 allow port_3129_acl
</I>
Now you have an infinite forwarding loop.

 client -&gt; Squid (3129) -&gt; Squid (3128) -&gt; Squid (3128) ... repeat forever.

 Of that second 50%:  50% will go to serer1 and 50% loops back, repeat
to infinity.
 So in total 50% + 25% + 12.5% + ... of traffic goes to server1.

Can you see why this type of config is harmful?


...
&gt;<i> forwarded_for delete
</I>
... and you are deleting the X-Forwarded-For header whose purpose is in
part to show you how these loops are happening.


To answer your question it is not possible to work the way you seem to
expect, and that can be proven mathematically

Since you have two peers and round-robin each time a loop happens 50% of
traffic goes to server1, 50% loops back into this Squid.

In other words:
 50% of traffic goes to server1 on ts first time through.
 50% of traffic loops back through localhost to this Squid.

 25% of traffic goes to server1 on its second loop.
 ...

 12.5% of traffic goes to server1 on its third loop.
 ...

 and so on until 99.99999...% of traffic is going to server1, with
increasingly small amounts of traffic taking looping just one more time.

Each loop consumes 2 TCP ports and ~256KB of RAM. So if anything were
done to permit the looping to happen at some point very early the
machine would completely run out of either TCP sockets or RAM.

Those are both shared resources possibly needed by other software on the
machine. If either is consumed completely by Squid looping the OS
encounters horrible problems, up to and including the kernel crashing.


Luckily you are leaving the Via header in place which Squid uses to
block looping traffic before it causes serious damage to the machine.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017631.html">[squid-users] Can cache_peer be localhost?
</A></li>
	<LI>Next message (by thread): <A HREF="017646.html">[squid-users] Can cache_peer be localhost?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17633">[ date ]</a>
              <a href="thread.html#17633">[ thread ]</a>
              <a href="subject.html#17633">[ subject ]</a>
              <a href="author.html#17633">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
