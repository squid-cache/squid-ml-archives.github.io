<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transition from squid3.5 to squid4; ciphers don't work anymore, ERROR: Unknown TLS option SINGLE_DH_USE
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transition%20from%20squid3.5%20to%20squid4%3B%0A%20ciphers%20don%27t%20work%20anymore%2C%20ERROR%3A%20Unknown%20TLS%20option%20SINGLE_DH_USE&In-Reply-To=%3Caa2b0d2a-985c-56de-ee4d-a07e191caa90%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017643.html">
   <LINK REL="Next"  HREF="017608.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transition from squid3.5 to squid4; ciphers don't work anymore, ERROR: Unknown TLS option SINGLE_DH_USE</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transition%20from%20squid3.5%20to%20squid4%3B%0A%20ciphers%20don%27t%20work%20anymore%2C%20ERROR%3A%20Unknown%20TLS%20option%20SINGLE_DH_USE&In-Reply-To=%3Caa2b0d2a-985c-56de-ee4d-a07e191caa90%40treenet.co.nz%3E"
       TITLE="[squid-users] Transition from squid3.5 to squid4; ciphers don't work anymore, ERROR: Unknown TLS option SINGLE_DH_USE">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Feb 17 14:01:05 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017643.html">[squid-users] Transition from squid3.5 to squid4; ciphers don't work anymore, ERROR: Unknown TLS option SINGLE_DH_USE
</A></li>
        <LI>Next message (by thread): <A HREF="017608.html">[squid-users] log external ip address in squid logs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17640">[ date ]</a>
              <a href="thread.html#17640">[ thread ]</a>
              <a href="subject.html#17640">[ subject ]</a>
              <a href="author.html#17640">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/02/18 02:29, chiasa.men wrote:
&gt;<i> Hi I tried squid4.
</I>&gt;<i> 
</I>&gt;<i> Squid Cache: Version 4.0.23 
</I>&gt;<i> This binary uses OpenSSL 1.1.1-dev  xx XXX xxxx
</I>&gt;<i> 
</I>&gt;<i> Before, I used:
</I>&gt;<i> Squid Cache: Version 3.5.27 
</I>&gt;<i> This binary uses OpenSSL 1.0.2g  1 Mar 2016
</I>&gt;<i> 
</I>&gt;<i> Some of the config directives changed:
</I>&gt;<i> E.g.
</I>&gt;<i> sslproxy_options SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> -&gt;
</I>&gt;<i> tls_tls_outgoing_options options=SINGLE_DH_USE,SINGLE_ECDH_USE 
</I>&gt;<i> 
</I>&gt;<i> But that results in version 4 in the follwing errors (cache.log)
</I>&gt;<i> ERROR: Unknown TLS option SINGLE_DH_USE
</I>&gt;<i> ERROR: Unknown TLS option SINGLE_ECDH_USE
</I>&gt;<i> 
</I>&gt;<i> (same error with the same options in https_proxy)
</I>&gt;<i> 
</I>&gt;<i> Is that a problem related to the openssl version change?
</I>
Yes. Due to CVE-2016-0701 the SSL_OP_SINGLE_DH_USE option was deprecated
in OpenSSL 1.0.2f and that option enabled by default.
That means it *should* be available in all Squid using those libraries.

... but your 1.1.1-dev library appears to have had it removed entirely.

It is not listed as removed officially
(&lt;<A HREF="https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags#SSL_OP_SINGLE_DH_USE">https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags#SSL_OP_SINGLE_DH_USE</A>&gt;)
so may be related to some build option used to create the library.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In cache_peer I also have now to configure tls-cafile=/etc/ssl/certs/ca-
</I>&gt;<i> certificates.crt explicitly (I used some self signed certificates for testing - 
</I>&gt;<i> but in Squid3 I didn't need to configure that)
</I>&gt;<i> Otherwise I get: 
</I>&gt;<i> (71) Protocol error (TLS code: X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN)
</I>&gt;<i> In the reference it's stated that:
</I>&gt;<i> 	tls-default-ca[=off]
</I>&gt;<i> 			Whether to use the system Trusted CAs. Default is ON.
</I>&gt;<i> Shouldn't the tls-cafile option be unnecessary since it's trusted by default?
</I>&gt;<i> 
</I>
Yes, unless the CA is not in the system default CAs for some reason.

Some well-known companies are not trusted because of bad behaviour
getting them kicked out of the globally trusted CA registry. It might
also be related to other things in your library build.

Hard to say what exactly is going wrong without looking into that
particular cert chain which is hitting the error.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Furthermore I set Apache (the peer) to &quot;SSLCipherSuite  ECDHE-ECDSA-AES256-
</I>&gt;<i> GCM-SHA384&quot;
</I>&gt;<i> as well as cache_peer sslcipher=ECDHE-ECDSA-AES256-GCM-SHA384
</I>&gt;<i> 
</I>&gt;<i> ERROR: negotiating TLS on FD 20: error:141A90B5:SSL 
</I>&gt;<i> routines:ssl_cipher_list_to_bytes:no ciphers available (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> How can that be?
</I>&gt;<i> 
</I>
Not sure. Is the handshake actually trying to negotiate that cipher
correctly? or is one endpoint deciding it cannot support it?


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017643.html">[squid-users] Transition from squid3.5 to squid4; ciphers don't work anymore, ERROR: Unknown TLS option SINGLE_DH_USE
</A></li>
	<LI>Next message (by thread): <A HREF="017608.html">[squid-users] log external ip address in squid logs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17640">[ date ]</a>
              <a href="thread.html#17640">[ thread ]</a>
              <a href="subject.html#17640">[ subject ]</a>
              <a href="author.html#17640">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
