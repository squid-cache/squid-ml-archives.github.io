<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Forward proxy: TLS connections to server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Forward%20proxy%3A%20TLS%20connections%20to%20server&In-Reply-To=%3Caf186343-9d97-c2f5-9507-52d766a4e29d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017681.html">
   <LINK REL="Next"  HREF="017685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Forward proxy: TLS connections to server</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Forward%20proxy%3A%20TLS%20connections%20to%20server&In-Reply-To=%3Caf186343-9d97-c2f5-9507-52d766a4e29d%40treenet.co.nz%3E"
       TITLE="[squid-users] Forward proxy: TLS connections to server">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb 21 10:30:11 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017681.html">[squid-users] Forward proxy: TLS connections to server
</A></li>
        <LI>Next message (by thread): <A HREF="017685.html">[squid-users] Forward proxy: TLS connections to server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17682">[ date ]</a>
              <a href="thread.html#17682">[ thread ]</a>
              <a href="subject.html#17682">[ subject ]</a>
              <a href="author.html#17682">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/02/18 18:38, ninadmnaik wrote:
&gt;<i> Does the &quot;https_port intercept ssl-bump&quot; work only in transparent proxy
</I>&gt;<i> scenarios, where the DNAT changes have been applied?
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat</A>
</I>
The &quot;intercept&quot; mode flag alone is what means DNAT is taking place and
has to be deciphered by Squid;

 - the NAT may have other names but is still &quot;Destination NAT&quot;.

 - the particular *_port line and ssl-bump are unrelated to the NAT.


&gt;<i> 
</I>&gt;<i> Or is it possible to explicitly point to squid proxy in the client and still
</I>&gt;<i> use the &quot;https_port intercept ssl_bump&quot;?
</I>
No. Explicit proxy is a completely traffic syntax (aka &quot;mode&quot;).

Specifically the &quot;explicit proxy&quot; mode signaled by absence of a mode flag.

SSL-Bump makes no sense on an explicit-proxy https_port. Since ssl-bump
is an MITM hijack on the client traffic and by definition the TLS
(explicit) directed by the client itself to an explicit-proxy https_port
is intended explicitly for that proxy instead of any other server / origin.


&gt;<i> 
</I>&gt;<i> Here's the setup we've so far:
</I>&gt;<i> 
</I>&gt;<i> Squid 3.5.27
</I>&gt;<i> 
</I>&gt;<i> Conf file:
</I>&gt;<i> acl localnet src 127.0.0.1/32
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 5235         # xmpp over ssl
</I>&gt;<i> acl SSL_ports port 3130
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl ssl-bump_port myportname 3130
</I>&gt;<i> always_direct allow ssl-bump_port        # always direct to origin server.
</I>&gt;<i> Do not get from cache.
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>
Proxy listening on port 3128 for explicit-proxy traffic.

&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>
Proxy listening on port 3130 for NAT intercepted port 443 (HTTPS) traffic.


&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/pem.certificate/cert.pem
</I>&gt;<i> key=/pem.certificate/key.pem cafile=/etc/ssl/cert.pem
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump step2
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Proxy admin disabling all security measures offered by TLS. Free pass to
anyone abusing the network through port 443, no logging performed when
attacks happen.


Please remove the above lines and fix the problems that show up via
means other than silencing the log records.


&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd  -s
</I>&gt;<i> /usr/local/squid/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> And here's what the client is trying to do:
</I>&gt;<i> 
</I>&gt;<i> 1. sslSocket.connect(&quot;localhost&quot;, 3130);
</I>
Immediate Fail. Only the NAT system may send traffic to that port.
You should have firewall rules enforcing that restriction.

Also, the traffic must have been going directly to an origin server
before the NAT system altered it. ie traffic uses bare TLS containing
HTTP origin-form syntax.


&gt;<i> 
</I>&gt;<i> 2. sslSocket.getOutputStream.write(&quot;CONNECT fcm-xmpp.googleapis.com:5235
</I>&gt;<i> HTTP/1.1 Host: CONNECT fcm-xmpp.googleapis.com:5235&quot;);
</I>

If it is doing things right that client is doing:

 0) opening a TCP connection to the proxy, and

 1) inside that TCP connection (0) negotiating TLS to the proxy, and

 2) over that (1) it is sending an HTTP message. The explicit-proxy
request to setup an blind tunnel to some server on port 5235 . And,

 3) over that (2) it is going to send TLS to an origin server, and

 4) over that (3) it is going to send HTTP messages (aka HTTPS).


So to receive the traffic Squid requires:

A) an &quot;https_port ...&quot; to receive the TCP at (0) and explicit TLS at
(1), and

B) the &quot;ssl-bump&quot; option to decrypt the traffic at (4).


That is all. The TCP at (0) is the same, and HTTP at (2) is already in
explicit-proxy syntax, so no &quot;intercept&quot; necessary. SSL-Bump sets up
Squid to handle the (4) messages properly whatever the outcome of the
bumping attempt.

There is a special case when the traffic is NAT intercepted on it sway
to a different explicit=-proxy. In that case the dst-IP is not the
origin servers and the other things &quot;intercept&quot; causes to happen are
wrong - so do not use &quot;intercept&quot;, just ignore the NAT.


NOTE: HTTP traffic sent by a client intentionally to a proxy (eg the
CONNECT) is often described as &quot;plain-text HTTP&quot;. But as you can see
that is an oversimplification - the existence of (1) above shows how
inaccurate that word &quot;plain-text&quot; can be.
 This is why the terms &quot;explicit-proxy&quot; or &quot;forward-proxy&quot; are used. The
traffic may take the form of plain-text on TCP, or encrypted on TLS, and
literally any other reliable transport protocol. Subject only to what
the proxy software is written to receive.



&gt;<i> 
</I>&gt;<i> However, squid receives number 1 as a CONNECT. Same when I do: 'telnet
</I>&gt;<i> localhost 3130'. 
</I>
Which is different layering to the above. Telnet only does the (0) and
(2) TCP and HTTP layering. No (1) encryption step at all.

 - The &quot;http_port&quot; (no 's') directive is for traffic layering where
(1)'s TLS does not exist.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017681.html">[squid-users] Forward proxy: TLS connections to server
</A></li>
	<LI>Next message (by thread): <A HREF="017685.html">[squid-users] Forward proxy: TLS connections to server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17682">[ date ]</a>
              <a href="thread.html#17682">[ thread ]</a>
              <a href="subject.html#17682">[ subject ]</a>
              <a href="author.html#17682">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
