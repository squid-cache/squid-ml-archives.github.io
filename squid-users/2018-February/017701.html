<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] tcp_outgoing_address issue how to deny traffic to other IPs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20issue%20how%20to%20deny%20traffic%20to%0A%20other%20IPs&In-Reply-To=%3Ca1d0c74a-bf39-157a-e6b4-9adeea6618f4%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017714.html">
   <LINK REL="Next"  HREF="017699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] tcp_outgoing_address issue how to deny traffic to other IPs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20issue%20how%20to%20deny%20traffic%20to%0A%20other%20IPs&In-Reply-To=%3Ca1d0c74a-bf39-157a-e6b4-9adeea6618f4%40measurement-factory.com%3E"
       TITLE="[squid-users] tcp_outgoing_address issue how to deny traffic to other IPs">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Feb 22 22:05:32 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017714.html">[squid-users] tcp_outgoing_address issue how to deny traffic to other IPs
</A></li>
        <LI>Next message (by thread): <A HREF="017699.html">[squid-users] Kerberos authentcation failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17701">[ date ]</a>
              <a href="thread.html#17701">[ thread ]</a>
              <a href="subject.html#17701">[ subject ]</a>
              <a href="author.html#17701">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/22/2018 11:15 AM, Patrick Chemla wrote:

&gt;<i> acl Percent001 random 1/5
</I>&gt;<i> acl Percent002 random 1/5
</I>&gt;<i> acl Percent003 random 1/5
</I>&gt;<i> acl Percent004 random 1/5
</I>&gt;<i> acl Percent005 random 1/5
</I>
It is trivial to google up wrong configurations. Think about it: Giving
the same &quot;random 1/5&quot; ACL five different names does not make sense,
regardless of what you are trying to do!

As I will show below, you need 4 different ACLs instead (plus &quot;all&quot;):

  acl OneFifth  random 1/5
  acl OneFourth random 1/4
  acl OneThird  random 1/3
  acl OneHalf   random 1/2

&gt;<i> tcp_outgoing_address XX.3X.YYY.10 Percent001
</I>&gt;<i> tcp_outgoing_address XX.X3.YYY.21 Percent002
</I>&gt;<i> tcp_outgoing_address XX.5X.YYY.31 Percent003
</I>&gt;<i> tcp_outgoing_address XX.X9.YYY.34 Percent004
</I>&gt;<i> tcp_outgoing_address XX.5X.YYY.38 Percent005
</I>
... and if none of the *random* ACLs match?

You need to make sure that one of the ACLs matches. That cannot be done
with random ACLs alone. You also need to get your probabilities right:


  tcp_outgoing_address XX.3X.YYY.10 OneFifth
  tcp_outgoing_address XX.X3.YYY.21 OneFourth
  tcp_outgoing_address XX.5X.YYY.31 OneThird
  tcp_outgoing_address XX.X9.YYY.34 OneHalf
  tcp_outgoing_address XX.5X.YYY.38 all

If the above looks strange, recall that the first matching
tcp_outgoing_address rule/line wins, and the rules are tested
individually and independently in the order they appear in squid.conf.
The rest is basic probability theory, but it may also think about it in
step-by-steps terms:

1. Given that there are five possible addresses, how much traffic should
the first out of those five address receive? Obviously 1/5.

2. Now, if the first rule did not match, then there are four addresses
left. Given that there are four possible addresses, how much traffic
should the first out of those four address receive? Obviously 1/4.

...


&gt;<i> When I look at the log, or using network tcpdump analyzer, I can see
</I>&gt;<i> that there is squid outgoing traffic on this IP
</I>
Yes, AFAICT, your rules did not tell Squid to use a specific secondary
IP in 33% of cases: (1-1/5)^5 = 0.33


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017714.html">[squid-users] tcp_outgoing_address issue how to deny traffic to other IPs
</A></li>
	<LI>Next message (by thread): <A HREF="017699.html">[squid-users] Kerberos authentcation failure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17701">[ date ]</a>
              <a href="thread.html#17701">[ thread ]</a>
              <a href="subject.html#17701">[ subject ]</a>
              <a href="author.html#17701">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
