<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Block some web to a group of ip and allow the	rest.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Block%20some%20web%20to%20a%20group%20of%20ip%20and%20allow%20the%0A%09rest.&In-Reply-To=%3C07d8b464-5526-5852-f869-106137945882%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017706.html">
   <LINK REL="Next"  HREF="017707.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Block some web to a group of ip and allow the	rest.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Block%20some%20web%20to%20a%20group%20of%20ip%20and%20allow%20the%0A%09rest.&In-Reply-To=%3C07d8b464-5526-5852-f869-106137945882%40treenet.co.nz%3E"
       TITLE="[squid-users] Block some web to a group of ip and allow the	rest.">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Feb 24 10:01:07 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017706.html">[squid-users] Block some web to a group of ip and allow the rest.
</A></li>
        <LI>Next message (by thread): <A HREF="017707.html">[squid-users] Kerberos negotiate slow avg service time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17709">[ date ]</a>
              <a href="thread.html#17709">[ thread ]</a>
              <a href="subject.html#17709">[ subject ]</a>
              <a href="author.html#17709">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/02/18 04:45, erdosain9 wrote:
&gt;<i> Hi to all.
</I>&gt;<i> Im trying to block some web to a ip group. 
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ips]# cat i-restringidos.lst 
</I>&gt;<i> 192.168.1.42
</I>&gt;<i> 192.168.1.43
</I>&gt;<i> 192.168.1.44
</I>&gt;<i> 192.168.1.45
</I>&gt;<i> 192.168.1.99
</I>&gt;<i> 192.168.1.50
</I>&gt;<i> 192.168.1.128
</I>&gt;<i> 
</I>&gt;<i> This same ip group has access to all internet.
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ips]# cat prensa_isla.lst 
</I>&gt;<i> 192.168.1.42
</I>&gt;<i> 192.168.1.43
</I>&gt;<i> 192.168.1.44
</I>&gt;<i> 192.168.1.45
</I>&gt;<i> 192.168.1.99
</I>&gt;<i> 192.168.1.50
</I>&gt;<i> 192.168.1.128
</I>
If they are really the same, then it is better to use one ACL name
instead of two like that.

Using one will help you see more clearly what your config is actually
doing for those IPs, and also make it impossible to accidentally
configure something that can never happen.
 Like &quot;i-restringidos !prensa_isla&quot;.


&gt;<i> 
</I>&gt;<i> This is what i want to block
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> listas]# cat restringidos.lst 
</I>&gt;<i> .whatsapp.com
</I>&gt;<i> .facebook.com
</I>&gt;<i> .instagram.com
</I>&gt;<i> .twitter.com
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> (so i have this 2 acl whit the same ip, one for deny, the other to allow.
</I>&gt;<i> 
</I>&gt;<i> So this is my config... and it's not working. Some help?? Thanks!
</I>&gt;<i> 
</I>
That is a very complicated setup you have. Below are some
simplifications you can make to shorten it and make it easier to read
what is going on...

&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny i-restringidos restringidos
</I>
The above line does exactly what you are asking for.

The only problem that could happen is that the clients in i-restringidos
are not doing what you think they are.

Perhapse they are actually:

 a) not using your proxy to contact those sites,

and/or

 b) using a protocol that skips through the proxy.

   For example; Using SPDY, QUICK, WebSockets etc. instead of HTTP.

and/or,


 c) using a domain name (or raw IP address) not on your list.

   For example most of Facebook traffic usually comes from fbcdn.net,
&quot;Facebook.com&quot; is just the brand name and front page(s).


&gt;<i> http_access allow prensa-isla
</I>&gt;<i> http_access allow red6
</I>&gt;<i> http_access allow red2
</I>
All the below lines have !dominios_denegados. So you can add this here:

  http_access deny dominios_denegados

... then remove all the &quot;!dominios_denegados&quot;.


&gt;<i> http_access allow logistica !multimedia !peligrosos
</I>&gt;<i> http_access allow adminis
</I>
All the below lines have &quot;!peligrosos&quot;. So you can do the same again:

  http_access deny peligrosos


And again with !multimedia; ...

  http_access deny multimedia

.. leaving the remainder looking like this:

 http_access allow institucionales
 http_access allow patriysumi
 http_access allow proyecto
 http_access allow rrhh
 http_access allow programas_y_activ
 http_access allow auditoria
 http_access allow legales
 http_access allow proteccion
 http_access allow oe
 http_access deny all


&gt;<i> 
</I>&gt;<i> refresh_pattern -i \.jpg$ 30 0% 30 ignore-no-cache ignore-no-store
</I>&gt;<i> ignore-private
</I>
The ignore-no-cache parameter no longer exists. Please remove.


&gt;<i> 
</I>&gt;<i> request_header_access From deny all
</I>&gt;<i> request_header_access Server deny all
</I>&gt;<i> request_header_access WWW-Authenticate deny all
</I>&gt;<i> request_header_access Link deny all
</I>&gt;<i> request_header_access Cache-Control deny all
</I>&gt;<i> request_header_access Proxy-Connection deny all
</I>&gt;<i> request_header_access X-Cache deny all
</I>&gt;<i> request_header_access X-Cache-Lookup deny all
</I>&gt;<i> request_header_access Via deny all
</I>&gt;<i> request_header_access X-Forwarded-For deny all
</I>&gt;<i> request_header_access Pragma deny all
</I>&gt;<i> request_header_access Keep-Alive deny all
</I>
The Server, X-Cache, X-Cache-Lookup headers are not request headers.
Those lines are pointless.

The Proxy-Connection header is obsolete and automatically stripped by
all current Squid. No need to do anything for it either.

The Keep-Alive header is hop-by-hop ad stripped by Squid without havign
anyeffect.

The Pragma header is mandatory for HTTP proxies to ignore except in the
rare case of &quot;Pragma:no-cache&quot;. Current Squid are HTTP/1.1 so even that
is even more rarely mattering. ALmost all traffic will ignore this header.
 Also, these directives do not in any way affect how your Squid
interprets those headers. All it does is erase them from traffic going
to servers. Which in the case of Pragma is mandatory to pass on exactly
as received. Right now you are breaking all HTTP/1.0 caches across the
Internet between your proxy and the origin server.


&gt;<i> 
</I>&gt;<i> delay_pools 15
</I>&gt;<i> #Limitar Youtube 
</I>&gt;<i> delay_class 1 2
</I>&gt;<i> delay_parameters 1 2000000/2000000 100000/1000000
</I>
Two things about these delay rules:

 1) Youtube and Facebook are different companies and services. So
traffic going to YouTube cannot simlultaneously be going to Facebook.
That makes the Facebook part of the check pointless.


2) All of the below lines have &quot;youtube !facebook&quot;. Like with
http_access simplification you can make these rules vastly simpler by
checking for the forbidden property and rejecting based on that before
any allow rules.

So, combining the two details mentioned above. You can make this your
first rule:

  delay_access 1 deny !youtube

... then remove the &quot;youtube !facebook&quot; part from all the below lines:

&gt;<i> delay_access 1 allow adminis    youtube !facebook
</I>&gt;<i> delay_access 1 allow logistica  youtube !facebook
</I>&gt;<i> delay_access 1 allow institucionales youtube !facebook
</I>&gt;<i> delay_access 1 allow patriysumi youtube !facebook
</I>&gt;<i> delay_access 1 allow rrhh youtube !facebook
</I>&gt;<i> delay_access 1 allow proyecto youtube !facebook
</I>&gt;<i> delay_access 1 allow programas_y_activ youtube !facebook
</I>&gt;<i> delay_access 1 allow auditoria youtube !facebook
</I>&gt;<i> delay_access 1 allow legales youtube !facebook
</I>&gt;<i> delay_access 1 allow oe youtube !facebook
</I>&gt;<i> delay_access 1 allow proteccion youtube !facebook
</I>&gt;<i> delay_access 1 deny all
</I>
Then you get to decide, are there any clients allowed to use the proxy
which are not in those allow rules?

If the answer is yes, you can replace all of those allow lines with
&quot;allow all&quot; and remove the &quot;deny all&quot; line.


&gt;<i> 
</I>&gt;<i> #Limitar Facebook
</I>&gt;<i> delay_class 2 2
</I>&gt;<i> delay_parameters 2 2000000/2000000 100000/1000000
</I>&gt;<i> delay_access 2 allow adminis    facebook !youtube
</I>&gt;<i> delay_access 2 allow logistica  facebook !youtube
</I>&gt;<i> delay_access 2 allow institucionales facebook !youtube
</I>&gt;<i> delay_access 2 allow patriysumi facebook !youtube
</I>&gt;<i> delay_access 2 allow rrhh facebook !youtube
</I>&gt;<i> delay_access 2 allow proyecto facebook !youtube
</I>&gt;<i> delay_access 2 allow programas_y_activ facebook !youtube
</I>&gt;<i> delay_access 2 allow auditoria facebook !youtube
</I>&gt;<i> delay_access 2 allow legales facebook !youtube
</I>&gt;<i> delay_access 2 allow oe facebook !youtube
</I>&gt;<i> delay_access 2 allow proteccion facebook !youtube
</I>&gt;<i> delay_access 2 deny all
</I>
Same as with pool #1, but this time make your first line:

  delay_access 2 deny facebook


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017706.html">[squid-users] Block some web to a group of ip and allow the rest.
</A></li>
	<LI>Next message (by thread): <A HREF="017707.html">[squid-users] Kerberos negotiate slow avg service time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17709">[ date ]</a>
              <a href="thread.html#17709">[ thread ]</a>
              <a href="subject.html#17709">[ subject ]</a>
              <a href="author.html#17709">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
