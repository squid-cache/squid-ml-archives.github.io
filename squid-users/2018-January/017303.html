<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help with UA filtering in https connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20UA%20filtering%20in%20https%20connections&In-Reply-To=%3C20180103173834.GA18556%40fantomas.sk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017302.html">
   <LINK REL="Next"  HREF="017304.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help with UA filtering in https connections</H1>
    <B>Matus UHLAR - fantomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20UA%20filtering%20in%20https%20connections&In-Reply-To=%3C20180103173834.GA18556%40fantomas.sk%3E"
       TITLE="[squid-users] Help with UA filtering in https connections">uhlar at fantomas.sk
       </A><BR>
    <I>Wed Jan  3 17:38:34 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017302.html">[squid-users] Help with UA filtering in https connections
</A></li>
        <LI>Next message (by thread): <A HREF="017304.html">[squid-users] Help with UA filtering in https connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17303">[ date ]</a>
              <a href="thread.html#17303">[ thread ]</a>
              <a href="subject.html#17303">[ subject ]</a>
              <a href="author.html#17303">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>On 01/03/2018 05:52 AM, Matus UHLAR - fantomas wrote:
</I>&gt;&gt;<i> On 02.01.18 09:06, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 01/02/2018 07:08 AM, Matus UHLAR - fantomas wrote:
</I>&gt;&gt;&gt;&gt;<i> On 02.01.18 06:04, squidnoob wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow CONNECT safe_ports
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny CONNECT
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> the two lines above unconditionally allow CONNECT anywhere,
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> This is incorrect. The lines deny CONNECT to unsafe ports.
</I>&gt;<i>
</I>&gt;&gt;<i> Those lines unconditionally allow CONNECT requests to safe ports ANYWHERE,
</I>
On 03.01.18 08:55, Alex Rousskov wrote:
&gt;<i>Yes, or, to be more precise, they (together with ssl_bump rules) allow
</I>&gt;<i>fetching of any server certificate from a reasonable(*) port. They do
</I>&gt;<i>not allow HTTP requests to arbitrary safe ports. Only Squid-generated
</I>&gt;<i>TLS handshakes.
</I>

&gt;&gt;<i> which is apparently not what was wanted/expected.
</I>&gt;<i>
</I>&gt;<i>Why not?
</I>
because there can be many reasons to deny CONNECT request for example
destined to localhost or internal network.

in the default config, these directives are at the beginning, before
checking for allowed clients and destinations is done.

in the provided config:
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2017-December/017267.html">http://lists.squid-cache.org/pipermail/squid-users/2017-December/017267.html</A>

there are no deny directives before &quot;http_access allow SSL_port&quot;
and so it's quite possible that all clients that should not have access will
be allowed.

of course, there MAY be other directives or measures to avoid that
but I really think it's better to put &quot;deny CONNECT !SSL_ports&quot;
than allow CONNECT and later wonder why some requests are not 


&gt;&gt;<i> that in this case you can[not] deny the connect request later,
</I>&gt;<i>
</I>&gt;<i>Denying CONNECTs at step1 does not really work well in a general case
</I>&gt;<i>because, during SslBump step1, Squid does not have enough information to
</I>&gt;<i>generate the right certificate for the access denial error page.
</I>
I don't think this matters when we do have &quot;http_access deny CONNECT&quot; in
both cases.

&gt;<i>In a general case, the admin has to pick between two evils:
</I>&gt;<i>
</I>&gt;<i>* Allow TLS handshakes with arbitrary servers on TLS ports (my sketch)
</I>&gt;<i>
</I>&gt;<i>* or tell Squid to respond with error pages that the user cannot see
</I>&gt;<i>  (without bypassing browser security warnings).
</I>&gt;<i>
</I>&gt;<i>Which evil is lesser is up to the admin to decide. Needless to say,
</I>&gt;<i>there are environments where both strategies should be used, depending
</I>&gt;<i>on the transaction parameters.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>(*) We should allow CONNECTs to SSL_ports, not Safe_ports. I hope my
</I>&gt;<i>sketch did not use those ACLs.
</I>
I'm afraid you did.
+and I'm also afraid that your proposal also prevents us from disabling
CONNECTs later:

<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2017-December/017268.html">http://lists.squid-cache.org/pipermail/squid-users/2017-December/017268.html</A>

-- 
Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Atheism is a non-prophet organization. 

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017302.html">[squid-users] Help with UA filtering in https connections
</A></li>
	<LI>Next message (by thread): <A HREF="017304.html">[squid-users] Help with UA filtering in https connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17303">[ date ]</a>
              <a href="thread.html#17303">[ thread ]</a>
              <a href="subject.html#17303">[ subject ]</a>
              <a href="author.html#17303">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
