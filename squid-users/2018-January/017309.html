<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ALPN, HTTP/2 and sslbump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ALPN%2C%20HTTP/2%20and%20sslbump&In-Reply-To=%3C06a143c7-00a5-9e4c-38b2-e4079d9f12b5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017328.html">
   <LINK REL="Next"  HREF="017314.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ALPN, HTTP/2 and sslbump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ALPN%2C%20HTTP/2%20and%20sslbump&In-Reply-To=%3C06a143c7-00a5-9e4c-38b2-e4079d9f12b5%40treenet.co.nz%3E"
       TITLE="[squid-users] ALPN, HTTP/2 and sslbump">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan  3 23:40:35 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017328.html">[squid-users] ALPN, HTTP/2 and sslbump
</A></li>
        <LI>Next message (by thread): <A HREF="017314.html">[squid-users] TCP out of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17309">[ date ]</a>
              <a href="thread.html#17309">[ thread ]</a>
              <a href="subject.html#17309">[ subject ]</a>
              <a href="author.html#17309">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/01/18 11:30, brianbergstrom wrote:
&gt;<i> I am using Squid 3.5.27 and recently started having issues when I upgraded
</I>&gt;<i> from openssl 1.0.1 to 1.0.2 which I believe introduced support for h2/ALPN.
</I>&gt;<i> I have narrowed down the issue to a request that fails but succeeds with
</I>&gt;<i> curl's --no-alpn flag.
</I>&gt;<i> 
</I>&gt;<i> Here is the error message from Squid for the failure, though the request
</I>&gt;<i> ends up timing out with an EOF error.
</I>&gt;<i> Handshake with SSL server failed: error:140920E3:SSL
</I>&gt;<i> routines:ssl3_get_server_hello:parse tlsext
</I>&gt;<i> 
</I>&gt;<i> A tcpdump of the failure when curl sends ALPN which contains http/1.1 and h2
</I>&gt;<i> as its client protocols, of which the Server Hello replies and chooses h2.
</I>&gt;<i> 
</I>&gt;<i> A tcpdump of successful request with the --no-alpn flag verifies that no
</I>&gt;<i> ALPN TLS extension data is present.
</I>&gt;<i> 
</I>&gt;<i> If I understand the docs and this thread correctly, Squid should be removing
</I>&gt;<i> h2 from the ALPN in the Client Hello since Squid does not support it.  But
</I>&gt;<i> it appears to be passing it through and failing when the server chooses it.
</I>
Sort of, but not quite.

What you have configured is 'splice' - so Squid is constrained to 
delivering both the TLS handshake and the encrypted data from the client 
exactly as-is to the server. The APLN removal happens when Squid is able 
to alter the handshake - eg for the 'bump' action.

The existence of things like ALPN should not matter to Squid when 
splicing as the HTTP inside the encryption is never even looked at.

However, for the 'peek' action to succeed your OpenSSL library on the 
Squid machine does need to support the TLS features being used by both 
client and server endpoints. In this case it appears that the TLS 
extension message in TLS itself is not being parsed correctly by the 
library.


Your best options (in order of preference) are:

* update to an even more recent OpsenSSL version (1.1 etc) in hopes that 
the ALPN support is more correct than the 1.0.2 code, and/or

* move your squid.conf &quot;ssl_bump splice ...&quot; above the &quot;ssl_bump peek 
..&quot; lines so the splicing happens earlier if the client SNI details are 
sufficient to make the decision, and/or

* try an upgrade to Squid-4. We have redesigned the handshake parsing in 
that version not to depend so much on OpenSSL.

If even the latest Squid with latest OpenSSL library have the issue 
please file a bug report. It will need a copy of your config settings, 
and the tcpdump full-packet trace of the server handshake which is failing.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017328.html">[squid-users] ALPN, HTTP/2 and sslbump
</A></li>
	<LI>Next message (by thread): <A HREF="017314.html">[squid-users] TCP out of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17309">[ date ]</a>
              <a href="thread.html#17309">[ thread ]</a>
              <a href="subject.html#17309">[ subject ]</a>
              <a href="author.html#17309">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
