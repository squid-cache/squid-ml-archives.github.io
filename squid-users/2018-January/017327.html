<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP out of memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP%20out%20of%20memory&In-Reply-To=%3C6eaaa26c-5226-5f5a-02f1-a9f5df690cc9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017324.html">
   <LINK REL="Next"  HREF="017340.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP out of memory</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP%20out%20of%20memory&In-Reply-To=%3C6eaaa26c-5226-5f5a-02f1-a9f5df690cc9%40treenet.co.nz%3E"
       TITLE="[squid-users] TCP out of memory">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan  9 12:40:03 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017324.html">[squid-users] TCP out of memory
</A></li>
        <LI>Next message (by thread): <A HREF="017340.html">[squid-users] TCP out of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17327">[ date ]</a>
              <a href="thread.html#17327">[ thread ]</a>
              <a href="subject.html#17327">[ subject ]</a>
              <a href="author.html#17327">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/01/18 22:40, Vieri wrote:
&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have only taken a brief look, but so far it looks like the problematic
</I>&gt;<i> 
</I>&gt;&gt;<i> sockets are not participating in any ICAP activity.
</I>&gt;<i> 
</I>&gt;<i> Do you see that from the cache.log, or from &quot;:filedescriptors&quot;?
</I>
I went through the cache.log looking for the FD numbers mentioned to 
correlate with the filedescriptors report lines. The first dozen I found 
all seemed to be either in some clearly described state (not that 
&quot;127.0.0.1&quot; description).

My deeper look was going to make a script to do the reverse check. For 
each entry in the filedescriptors, seeing if there was any ICAP mentions 
and print where in the cache.log to look.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Both Nread and Nwrite seem to be well over 0.
</I>&gt;<i> 
</I>
That I think is really odd for sockets to port 1344 which are not having 
any ICAP protocol activity happening.


&gt;&gt;<i> That implies they &gt; are possibly TCP connections which never complete their opening
</I>&gt;&gt;<i> sequence, or at least the result of connection attempts does not make it
</I>&gt;&gt;<i> back to the ICAP code somehow.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ICAP and Squid are both on localhost. I'd like to find out why this is happening.
</I>&gt;<i> 
</I>

That is why I specifically asked for 93,* trace. The 93,* traces should 
not contains any of the HTTP traffic to Squid just the ICAP.

If you can get an 11,* trace as well separately to see if any of the 
stuck port 1344 FDs are using HTTP. There should be none. But if there 
are that could well be the problem on those ones.


&gt;<i> 
</I>&gt;<i> I believe I already posted a tcpdump trace of the ICAP traffic, but I don't know if you had a chance to take a look at it. I had a quick look, but I'm not familiar with the ICAP protocol. In any case, I probably would see a lot of OPTIONS, REQMOD, RESPMOD methods, but I don't know if I would clearly detect initial TCP issues.
</I>&gt;<i> 
</I>
You mean the trace in your &quot;TCP out of memory&quot; thread last month?
What I'm seeing in there is connections being used for ICAP, then the 
ICAP service requesting keep-alive which Squid honors. Nothing obviously 
broken.


&gt;<i> 
</I>&gt;<i> Anyway, here's a dumb question. Can't Squid &quot;tell&quot; when a TCP connection to an ICAP server has never completed correctly after x timeout, and close it down/reset it?
</I>&gt;<i> I'm using default values in squid.conf for the following:
</I>&gt;<i> connect_timeout
</I>&gt;<i> icap_connect_timeout
</I>&gt;<i> peer_connect_timeout
</I>&gt;<i> 
</I>&gt;<i> The docs say:
</I>&gt;<i> #  TAG: icap_connect_timeout
</I>&gt;<i> #       This parameter specifies how long to wait for the TCP connect to
</I>&gt;<i> #       the requested ICAP server to complete before giving up and either
</I>&gt;<i> #       terminating the HTTP transaction or bypassing the failure.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> BTW I guess it's just a typo error because instead of an &quot;HTTP transaction&quot; I should read &quot;ICAP transaction&quot;, right?
</I>
Nope. If ICAP fails for any reason and is mandatory (bypass=0) the HTTP 
transaction which is trying to use it gets broken. So the HTTP request 
(transaction) needs to be aborted with an error.
That does not necessarily mean the TCP connection used by the HTTP 
though, just the request/reply transaction.


&gt;<i> 
</I>&gt;<i> Anyway, I have &quot;bypass=0&quot; for the ICAP service so I guess it should honor connect_timeout.
</I>&gt;<i> The default is connect_timeout 1 minute.
</I>&gt;<i> 
</I>
No, icap_connect_timeout is the only one that should be relevant on 
connections to ICAP services.

connect_timeout is for HTP origin servers, and peer_connect_timeout is 
for cache_peers.


&gt;<i> 
</I>&gt;<i> With a 1-minute timeout it may be hard to see the sockets close when there's plenty of traffic, but I think I should see a substantial drop of open sockets when traffic is low (eg. at night). However, I don't see it.
</I>&gt;<i> 
</I>
If you mean the *connect_timeout, that only affects the time Squid waits 
for the outgoing TCP SYN/SYN+ACK process to complete. Persistent and 
other connections already opened have other timeouts applied depending 
on what they are being used for.

The *idle_pconn_timeout directives are more likely to result in closed 
connections for overnight etc. cases if clients do not actively end them 
anyway.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017324.html">[squid-users] TCP out of memory
</A></li>
	<LI>Next message (by thread): <A HREF="017340.html">[squid-users] TCP out of memory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17327">[ date ]</a>
              <a href="thread.html#17327">[ thread ]</a>
              <a href="subject.html#17327">[ subject ]</a>
              <a href="author.html#17327">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
