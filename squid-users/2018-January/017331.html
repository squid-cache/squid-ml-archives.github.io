<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20SSL%20Bump&In-Reply-To=%3CE6B47F15-D6FA-4655-9C46-09AC96521122%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017330.html">
   <LINK REL="Next"  HREF="017333.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and SSL Bump</H1>
    <B>Yoinier Hernandez Nieves</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20SSL%20Bump&In-Reply-To=%3CE6B47F15-D6FA-4655-9C46-09AC96521122%40gmail.com%3E"
       TITLE="[squid-users] Squid and SSL Bump">yoinier.hn at gmail.com
       </A><BR>
    <I>Tue Jan  9 21:56:28 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017330.html">[squid-users] Squid and SSL Bump
</A></li>
        <LI>Next message (by thread): <A HREF="017333.html">[squid-users] Squid and SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17331">[ date ]</a>
              <a href="thread.html#17331">[ thread ]</a>
              <a href="subject.html#17331">[ subject ]</a>
              <a href="author.html#17331">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I answer interline.

&gt;<i> El 9/01/2018, a las 4:27 p.m., Antony Stone &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Antony.Stone at squid.open.source.it</A>&gt; escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i> On Tuesday 09 January 2018 at 21:28:37, Yoinier Hernandez Nieves wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I try configure squid 3.5 on CentOS 7 with sslBump.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> But I have some problems, the first:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Some HTTPs sites can access, because squid say what I am are not
</I>&gt;&gt;<i> authenticated. And other sites, yes I can access.
</I>&gt;<i> 
</I>&gt;<i> Please give us information:
</I>&gt;<i> 
</I>&gt;<i> 1. An example of sites can you access.
</I>not https

&gt;<i> 2. An example of sites can you not access.
</I><A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> &lt;<A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A>&gt;
<A HREF="https://outlook.co.il/">https://outlook.co.il/</A> &lt;<A HREF="https://outlook.co.il/">https://outlook.co.il/</A>&gt;
<A HREF="https://www.facebook.com">https://www.facebook.com</A> &lt;<A HREF="https://www.facebook.com/">https://www.facebook.com/</A>&gt;

&gt;<i> 3. For problems, show us error messages - quote us what the remote sites tell 
</I>&gt;<i> you.
</I>Se encontr&#243; el siguiente error al intentar recuperar la direcci&#243;n URL: <A HREF="https://outlook.co.il/">https://outlook.co.il/</A> &lt;<A HREF="https://outlook.co.il/">https://outlook.co.il/</A>&gt;
Acceso Denegado a la Cach&#233;

Lo lamento, tu no est&#225;s autorizado a solicitar <A HREF="https://outlook.co.il/">https://outlook.co.il/</A> de este cach&#233; hasta que te hayas autenticado.

Please contact the cache administrator &lt;mailto:root?subject=CacheErrorInfo%20-%20ERR_CACHE_ACCESS_DENIED&amp;body=CacheHost%3A%20artemisa.conalza.co.cu%0D%0AErrPage%3A%20ERR_CACHE_ACCESS_DENIED%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Tue,%2009%20Jan%202018%2019%3A12%3A22%20GMT%0D%0A%0D%0AClientIP%3A%20172.25.100.4%0D%0A%0D%0AHTTP%20Request%3A%0D%0AGET%20%2F%20HTTP%2F1.1%0AUser-Agent%3A%20Mozilla%2F5.0%20(Macintosh%3B%20Intel%20Mac%20OS%20X%2010.12%3B%20rv%3A57.0)%20Gecko%2F20100101%20Firefox%2F57.0%0D%0AAccept%3A%20text%2Fhtml,application%2Fxhtml+xml,application%2Fxml%3Bq%3D0.9,*%2F*%3Bq%3D0.8%0D%0AAccept-Language%3A%20es-ES,es%3Bq%3D0.8,en-US%3Bq%3D0.5,en%3Bq%3D0.3%0D%0AAccept-Encoding%3A%20gzip,%20deflate,%20br%0D%0AConnection%3A%20keep-alive%0D%0AUpgrade-Insecure-Requests%3A%201%0D%0AHost%3A%20outlook.co.il%0D%0A%0D%0A%0D%0A&gt; if you have difficulties authenticating yourself.

&gt;<i> 
</I>&gt;<i> 4. Please rephrase &quot;squid say what I am are not authenticated&quot; - this is not 
</I>&gt;<i> clear - what do you mean?
</I>&gt;<i> 
</I>&gt;&gt;<i> I am authenticated.
</I>&gt;<i> 
</I>&gt;<i> To what?  Squid, or the remote site?
</I>Squid, see message in Spanish for point 3.

Other error is that
<A HREF="https://www.kiosco.bandec.cu/kiosco">https://www.kiosco.bandec.cu/kiosco</A> &lt;<A HREF="https://www.kiosco.bandec.cu/kiosco">https://www.kiosco.bandec.cu/kiosco</A>&gt;
Error negotiating SSL on FD 16: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)
The following error was encountered while trying to retrieve the URL: <A HREF="https://www.kiosco.bandec.cu/*">https://www.kiosco.bandec.cu/*</A> &lt;<A HREF="https://www.kiosco.bandec.cu/*">https://www.kiosco.bandec.cu/*</A>&gt;
Failed to establish a secure connection to 190.6.64.132

The system returned:

(71) Protocol error (TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
SSL Certficate error: certificate issuer (CA) not known: /CN=CX6.bandec.cu

This proxy and the remote host failed to negotiate a mutually acceptable security settings for handling your request. It is possible that the remote host does not support secure connections, or the proxy is not satisfied with the host security credentials.

&gt;<i> 
</I>&gt;<i> How do you know you are authenticated - what confirmation do you have?
</I>&gt;<i> 
</I>&gt;&gt;<i> Fragment of my squid.conf.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ssl_cert/ConAlza.pem
</I>&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB#
</I>&gt;&gt;<i> options=NO_SSLv3 dhparams=/etc/squid/ssl_cert/dhparam.pem sslcrtd_program
</I>&gt;&gt;<i> /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB sslproxy_options
</I>&gt;&gt;<i> NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i> authenticate_ip_ttl 60 seconds
</I>&gt;<i> 
</I>&gt;<i> That looks a bit strange (and a bit incomplete) to me, but since I'm no expert 
</I>&gt;<i> on SSL interception, I'll let someone else step in here.
</I>&gt;<i> 
</I>&gt;<i> If you can provide more information in the meantime (eg: enough to help 
</I>&gt;<i> someone else replicate your problem) that would be good.
</I>&gt;<i> 
</I>I use too dansguardians before the squid proxy.

See the logs for one petition

1515534858.355   3720 aaa.aaa.aaa.aaa TAG_NONE/200 0 CONNECT www.ssllabs.com:443 ynieves HIER_DIRECT/64.41.200.100 -
1515534858.375      0 bbb.bbb.bbb.bbb TCP_DENIED/403 4457 GET <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> ynieves HIER_NONE/- text/html
1515534858.407      0 bbb.bbb.bbb.bbb TAG_NONE/503 4952 GET <A HREF="http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png">http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png</A> ynieves HIER_DIRECT/64.41.200.100 text/html

aaa.aaa.aaa.aaa is my pc.
bbb.bbb.bbb.bbb is the dansguardians

&gt;<i> 
</I>&gt;<i> Antony.
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Wanted: telepath.   You know where to apply.
</I>&gt;<i> 
</I>&gt;<i>                                                   Please reply to the list;
</I>&gt;<i>                                                         please *don't* CC me.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180109/13c254e1/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180109/13c254e1/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017330.html">[squid-users] Squid and SSL Bump
</A></li>
	<LI>Next message (by thread): <A HREF="017333.html">[squid-users] Squid and SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17331">[ date ]</a>
              <a href="thread.html#17331">[ thread ]</a>
              <a href="subject.html#17331">[ subject ]</a>
              <a href="author.html#17331">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
