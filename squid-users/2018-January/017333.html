<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20SSL%20Bump&In-Reply-To=%3C96a99b08-b3c8-52e5-17bf-575a75a4c3c7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017331.html">
   <LINK REL="Next"  HREF="017334.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and SSL Bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20SSL%20Bump&In-Reply-To=%3C96a99b08-b3c8-52e5-17bf-575a75a4c3c7%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid and SSL Bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 10 13:47:55 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017331.html">[squid-users] Squid and SSL Bump
</A></li>
        <LI>Next message (by thread): <A HREF="017334.html">[squid-users] Squid and SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17333">[ date ]</a>
              <a href="thread.html#17333">[ thread ]</a>
              <a href="subject.html#17333">[ subject ]</a>
              <a href="author.html#17333">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/01/18 10:56, Yoinier Hernandez Nieves wrote:
&gt;<i> I answer interline.
</I>&gt;<i> 
</I>&gt;&gt;<i> El 9/01/2018, a las 4:27 p.m., Antony Stone escribi&#243;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tuesday 09 January 2018 at 21:28:37, Yoinier Hernandez Nieves wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I try configure squid 3.5 on CentOS 7 with sslBump.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But I have some problems, the first:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Some HTTPs sites can access, because squid say what I am are not
</I>&gt;&gt;&gt;<i> authenticated. And other sites, yes I can access.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please give us information:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. An example of sites can you access.
</I>&gt;<i> not https
</I>&gt;<i> 
</I>&gt;&gt;<i> 2. An example of sites can you not access.
</I>&gt;<i> <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A>
</I>&gt;<i> <A HREF="https://outlook.co.il/">https://outlook.co.il/</A>
</I>&gt;<i> <A HREF="https://www.facebook.com">https://www.facebook.com</A>
</I>&gt;<i> 
</I>&gt;&gt;<i> 3. For problems, show us error messages - quote us what the remote 
</I>&gt;&gt;<i> sites tell
</I>&gt;&gt;<i> you.
</I>&gt;<i> 
</I>&gt;<i> Se encontr&#243; el siguiente error al intentar recuperar la direcci&#243;n URL: 
</I>&gt;<i> <A HREF="https://outlook.co.il/">https://outlook.co.il/</A>
</I>&gt;<i> 
</I>&gt;<i>     *Acceso Denegado a la Cach&#233;*
</I>&gt;<i> 
</I>&gt;<i> Lo lamento, tu no est&#225;s autorizado a solicitar <A HREF="https://outlook.co.il/">https://outlook.co.il/</A> de 
</I>&gt;<i> este cach&#233; hasta que te hayas autenticado.
</I>&gt;<i> 
</I>&gt;<i> Please contact the cache administrator 
</I>&gt;<i> &lt;mailto:root?subject=CacheErrorInfo%20-%20ERR_CACHE_ACCESS_DENIED&amp;body=CacheHost%3A%20artemisa.conalza.co.cu%0D%0AErrPage%3A%20ERR_CACHE_ACCESS_DENIED%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Tue,%2009%20Jan%202018%2019%3A12%3A22%20GMT%0D%0A%0D%0AClientIP%3A%20172.25.100.4%0D%0A%0D%0AHTTP%20Request%3A%0D%0AGET%20%2F%20HTTP%2F1.1%0AUser-Agent%3A%20Mozilla%2F5.0%20(Macintosh%3B%20Intel%20Mac%20OS%20X%2010.12%3B%20rv%3A57.0)%20Gecko%2F20100101%20Firefox%2F57.0%0D%0AAccept%3A%20text%2Fhtml,application%2Fxhtml+xml,application%2Fxml%3Bq%3D0.9,*%2F*%3Bq%3D0.8%0D%0AAccept-Language%3A%20es-ES,es%3Bq%3D0.8,en-US%3Bq%3D0.5,en%3Bq%3D0.3%0D%0AAccept-Encoding%3A%20gzip,%20deflate,%20br%0D%0AConnection%3A%20keep-alive%0D%0AUpgrade-Insecure-Requests%3A%201%0D%0AHost%3A%20outlook.co.il%0D%0A%0D%0A%0D%0A&gt; 
</I>&gt;<i> if you have difficulties authenticating yourself.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4. Please rephrase &quot;squid say what I am are not authenticated&quot; - this 
</I>&gt;&gt;<i> is not
</I>&gt;&gt;<i> clear - what do you mean?
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am authenticated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To what? &#160;Squid, or the remote site?
</I>&gt;<i> Squid, see message in Spanish for point 3.
</I>&gt;<i> 
</I>
Your Squid log snippets you presented below say that the client which 
delivered a CONNECT message to Squid was authenticated. Things inside 
the tunnel encryption *cannot* be authenticated as separate things. 
Squid associates the credentials from the CONNECT tunnel for each 
request inside that tunnel.

That means that if you have any auth related config settings to the 
<A HREF="https://">https://</A> request(s) which cause those credentials to need to be 
re-checked, to timeout, or any of a multitude of other situations that 
normally occur with auth - then the bumped traffic in that bump'd tunnel 
from that point onward cannot be serviced and you will start to have 
errors. The only viable solution is to avoid authentication checks on 
the decrypted / MITM'd / SSL-Bump'd traffic.



&gt;<i> Other error is that
</I>&gt;<i> <A HREF="https://www.kiosco.bandec.cu/kiosco">https://www.kiosco.bandec.cu/kiosco</A>
</I>&gt;<i> Error negotiating SSL on FD 16: error:14090086:SSL 
</I>&gt;<i> routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> The following error was encountered while trying to retrieve the URL: 
</I>&gt;<i> <A HREF="https://www.kiosco.bandec.cu/*">https://www.kiosco.bandec.cu/*</A>
</I>&gt;<i> 
</I>&gt;<i>     *Failed to establish a secure connection to 190.6.64.132*
</I>&gt;<i> 
</I>&gt;<i> The system returned:
</I>&gt;<i> 
</I>&gt;<i>     (71) Protocol error (TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
</I>&gt;<i> 
</I>&gt;<i>     SSL Certficate error: certificate issuer (CA) not known:
</I>&gt;<i>     /CN=CX6.bandec.cu
</I>&gt;<i> 
</I>&gt;<i> This proxy and the remote host failed to negotiate a mutually acceptable 
</I>&gt;<i> security settings for handling your request. It is possible that the 
</I>&gt;<i> remote host does not support secure connections, or the proxy is not 
</I>&gt;<i> satisfied with the host security credentials.
</I>&gt;<i> 
</I>
Please read the above error message carefully. It explains exactly what 
is going wrong, and from that you should be able to find the MANY 
discussion threads that exact same error message has had in here and 
elsewhere over the past few years.

Your options are to:

* configure 
&lt;<A HREF="http://www.squid-cache.org/Doc/config/sslproxy_foreign_intermediate_certs/">http://www.squid-cache.org/Doc/config/sslproxy_foreign_intermediate_certs/</A>&gt; 
(may require a Squid-3.5 upgrade), or

* upgrade to Squid-4 which auto-downloads these things.


&gt;&gt;<i>
</I>&gt;&gt;<i> How do you know you are authenticated - what confirmation do you have?
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Fragment of my squid.conf.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ssl_cert/ConAlza.pem
</I>&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB#
</I>&gt;&gt;&gt;<i> options=NO_SSLv3 dhparams=/etc/squid/ssl_cert/dhparam.pem sslcrtd_program
</I>&gt;&gt;&gt;<i> /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB sslproxy_options
</I>&gt;&gt;&gt;<i> NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;<i> authenticate_ip_ttl 60 seconds
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That looks a bit strange (and a bit incomplete) to me, but since I'm 
</I>&gt;&gt;<i> no expert
</I>&gt;&gt;<i> on SSL interception, I'll let someone else step in here.
</I>

The authenticate_ip_ttl is irrelevant except that if the auth system 
obeys it, the result will be all persistent connections producing errors 
60 seconds after they become authenticated.


&gt;&gt;<i>
</I>&gt;&gt;<i> If you can provide more information in the meantime (eg: enough to help
</I>&gt;&gt;<i> someone else replicate your problem) that would be good.
</I>&gt;&gt;<i>
</I>&gt;<i> I use too dansguardians before the squid proxy.
</I>&gt;<i> 
</I>&gt;<i> See the logs for one petition
</I>&gt;<i> 
</I>&gt;<i> 1515534858.355 &#160; 3720 aaa.aaa.aaa.aaa TAG_NONE/200 0 CONNECT 
</I>&gt;<i> www.ssllabs.com:443 &lt;<A HREF="http://www.ssllabs.com:443">http://www.ssllabs.com:443</A>&gt; ynieves 
</I>&gt;<i> HIER_DIRECT/64.41.200.100 -
</I>&gt;<i> 1515534858.375&#160; &#160; &#160; 0 bbb.bbb.bbb.bbb TCP_DENIED/403 4457 GET 
</I>&gt;<i> <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> ynieves HIER_NONE/- 
</I>&gt;<i> text/html
</I>&gt;<i> 1515534858.407&#160; &#160; &#160; 0&#160;bbb.bbb.bbb.bbb&#160;TAG_NONE/503 4952 GET 
</I>&gt;<i> <A HREF="http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png">http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png</A> 
</I>&gt;<i> ynieves HIER_DIRECT/64.41.200.100 text/html
</I>&gt;<i> 
</I>&gt;<i> aaa.aaa.aaa.aaa is my pc.
</I>&gt;<i> bbb.bbb.bbb.bbb is the dansguardians
</I>&gt;<i> 
</I>
This is Squid delivering that above TLS error message to the 
client.Because of how browsers refuse to display errors presented by 
proxies to CONNECT requests. Squid is being forced to decrypt the HTTP 
message in the HTTPS tunnel and send the error page as a response to 
that encrypted request.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017331.html">[squid-users] Squid and SSL Bump
</A></li>
	<LI>Next message (by thread): <A HREF="017334.html">[squid-users] Squid and SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17333">[ date ]</a>
              <a href="thread.html#17333">[ thread ]</a>
              <a href="subject.html#17333">[ subject ]</a>
              <a href="author.html#17333">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
