<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and SSL Bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20SSL%20Bump&In-Reply-To=%3CEA144D48-E922-435F-8203-F72CBEE21D6F%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017333.html">
   <LINK REL="Next"  HREF="017337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and SSL Bump</H1>
    <B>Yoinier Hernandez Nieves</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20SSL%20Bump&In-Reply-To=%3CEA144D48-E922-435F-8203-F72CBEE21D6F%40gmail.com%3E"
       TITLE="[squid-users] Squid and SSL Bump">yoinier.hn at gmail.com
       </A><BR>
    <I>Wed Jan 10 20:33:31 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017333.html">[squid-users] Squid and SSL Bump
</A></li>
        <LI>Next message (by thread): <A HREF="017337.html">[squid-users] Squid and SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17334">[ date ]</a>
              <a href="thread.html#17334">[ thread ]</a>
              <a href="subject.html#17334">[ subject ]</a>
              <a href="author.html#17334">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> El 10/01/2018, a las 8:47 a.m., Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i> On 10/01/18 10:56, Yoinier Hernandez Nieves wrote:
</I>&gt;&gt;<i> I answer interline.
</I>&gt;&gt;&gt;<i> El 9/01/2018, a las 4:27 p.m., Antony Stone escribi&#243;:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Tuesday 09 January 2018 at 21:28:37, Yoinier Hernandez Nieves wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I try configure squid 3.5 on CentOS 7 with sslBump.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> But I have some problems, the first:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Some HTTPs sites can access, because squid say what I am are not
</I>&gt;&gt;&gt;&gt;<i> authenticated. And other sites, yes I can access.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Please give us information:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 1. An example of sites can you access.
</I>&gt;&gt;<i> not https
</I>&gt;&gt;&gt;<i> 2. An example of sites can you not access.
</I>&gt;&gt;<i> <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A>
</I>&gt;&gt;<i> <A HREF="https://outlook.co.il/">https://outlook.co.il/</A>
</I>&gt;&gt;<i> <A HREF="https://www.facebook.com">https://www.facebook.com</A>
</I>&gt;&gt;&gt;<i> 3. For problems, show us error messages - quote us what the remote sites tell
</I>&gt;&gt;&gt;<i> you.
</I>&gt;&gt;<i> Se encontr&#243; el siguiente error al intentar recuperar la direcci&#243;n URL: <A HREF="https://outlook.co.il/">https://outlook.co.il/</A>
</I>&gt;&gt;<i>    *Acceso Denegado a la Cach&#233;*
</I>&gt;&gt;<i> Lo lamento, tu no est&#225;s autorizado a solicitar <A HREF="https://outlook.co.il/">https://outlook.co.il/</A> de este cach&#233; hasta que te hayas autenticado.
</I>&gt;&gt;<i> Please contact the cache administrator &lt;mailto:root?subject=CacheErrorInfo%20-%20ERR_CACHE_ACCESS_DENIED&amp;body=CacheHost%3A%20artemisa.conalza.co.cu%0D%0AErrPage%3A%20ERR_CACHE_ACCESS_DENIED%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Tue,%2009%20Jan%202018%2019%3A12%3A22%20GMT%0D%0A%0D%0AClientIP%3A%20172.25.100.4%0D%0A%0D%0AHTTP%20Request%3A%0D%0AGET%20%2F%20HTTP%2F1.1%0AUser-Agent%3A%20Mozilla%2F5.0%20(Macintosh%3B%20Intel%20Mac%20OS%20X%2010.12%3B%20rv%3A57.0)%20Gecko%2F20100101%20Firefox%2F57.0%0D%0AAccept%3A%20text%2Fhtml,application%2Fxhtml+xml,application%2Fxml%3Bq%3D0.9,*%2F*%3Bq%3D0.8%0D%0AAccept-Language%3A%20es-ES,es%3Bq%3D0.8,en-US%3Bq%3D0.5,en%3Bq%3D0.3%0D%0AAccept-Encoding%3A%20gzip,%20deflate,%20br%0D%0AConnection%3A%20keep-alive%0D%0AUpgrade-Insecure-Requests%3A%201%0D%0AHost%3A%20outlook.co.il%0D%0A%0D%0A%0D%0A&gt; if you have difficulties authenticating yourself.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 4. Please rephrase &quot;squid say what I am are not authenticated&quot; - this is not
</I>&gt;&gt;&gt;<i> clear - what do you mean?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I am authenticated.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> To what?  Squid, or the remote site?
</I>&gt;&gt;<i> Squid, see message in Spanish for point 3.
</I>&gt;<i> 
</I>&gt;<i> Your Squid log snippets you presented below say that the client which delivered a CONNECT message to Squid was authenticated. Things inside the tunnel encryption *cannot* be authenticated as separate things. Squid associates the credentials from the CONNECT tunnel for each request inside that tunnel.
</I>&gt;<i> 
</I>&gt;<i> That means that if you have any auth related config settings to the <A HREF="https://">https://</A> request(s) which cause those credentials to need to be re-checked, to timeout, or any of a multitude of other situations that normally occur with auth - then the bumped traffic in that bump'd tunnel from that point onward cannot be serviced and you will start to have errors. The only viable solution is to avoid authentication checks on the decrypted / MITM'd / SSL-Bump'd traffic.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Other error is that
</I>&gt;&gt;<i> <A HREF="https://www.kiosco.bandec.cu/kiosco">https://www.kiosco.bandec.cu/kiosco</A>
</I>&gt;&gt;<i> Error negotiating SSL on FD 16: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)
</I>&gt;&gt;<i> The following error was encountered while trying to retrieve the URL: <A HREF="https://www.kiosco.bandec.cu/*">https://www.kiosco.bandec.cu/*</A>
</I>&gt;&gt;<i>    *Failed to establish a secure connection to 190.6.64.132*
</I>&gt;&gt;<i> The system returned:
</I>&gt;&gt;<i>    (71) Protocol error (TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)
</I>&gt;&gt;<i>    SSL Certficate error: certificate issuer (CA) not known:
</I>&gt;&gt;<i>    /CN=CX6.bandec.cu
</I>&gt;&gt;<i> This proxy and the remote host failed to negotiate a mutually acceptable security settings for handling your request. It is possible that the remote host does not support secure connections, or the proxy is not satisfied with the host security credentials.
</I>&gt;<i> 
</I>&gt;<i> Please read the above error message carefully. It explains exactly what is going wrong, and from that you should be able to find the MANY discussion threads that exact same error message has had in here and elsewhere over the past few years.
</I>&gt;<i> 
</I>&gt;<i> Your options are to:
</I>&gt;<i> 
</I>&gt;<i> * configure &lt;<A HREF="http://www.squid-cache.org/Doc/config/sslproxy_foreign_intermediate_certs/">http://www.squid-cache.org/Doc/config/sslproxy_foreign_intermediate_certs/</A>&gt; (may require a Squid-3.5 upgrade), or
</I>&gt;<i> 
</I>&gt;<i> * upgrade to Squid-4 which auto-downloads these things.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> How do you know you are authenticated - what confirmation do you have?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Fragment of my squid.conf.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ssl_cert/ConAlza.pem
</I>&gt;&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB#
</I>&gt;&gt;&gt;&gt;<i> options=NO_SSLv3 dhparams=/etc/squid/ssl_cert/dhparam.pem sslcrtd_program
</I>&gt;&gt;&gt;&gt;<i> /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB sslproxy_options
</I>&gt;&gt;&gt;&gt;<i> NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
</I>&gt;&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;&gt;<i> authenticate_ip_ttl 60 seconds
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> That looks a bit strange (and a bit incomplete) to me, but since I'm no expert
</I>&gt;&gt;&gt;<i> on SSL interception, I'll let someone else step in here.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The authenticate_ip_ttl is irrelevant except that if the auth system obeys it, the result will be all persistent connections producing errors 60 seconds after they become authenticated.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> If you can provide more information in the meantime (eg: enough to help
</I>&gt;&gt;&gt;<i> someone else replicate your problem) that would be good.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> I use too dansguardians before the squid proxy.
</I>&gt;&gt;<i> See the logs for one petition
</I>&gt;&gt;<i> 1515534858.355   3720 aaa.aaa.aaa.aaa TAG_NONE/200 0 CONNECT www.ssllabs.com:443 &lt;<A HREF="http://www.ssllabs.com:443">http://www.ssllabs.com:443</A>&gt; ynieves HIER_DIRECT/64.41.200.100 -
</I>&gt;&gt;<i> 1515534858.375      0 bbb.bbb.bbb.bbb TCP_DENIED/403 4457 GET <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> ynieves HIER_NONE/- text/html
</I>&gt;&gt;<i> 1515534858.407      0 bbb.bbb.bbb.bbb TAG_NONE/503 4952 GET <A HREF="http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png">http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png</A> ynieves HIER_DIRECT/64.41.200.100 text/html
</I>&gt;&gt;<i> aaa.aaa.aaa.aaa is my pc.
</I>&gt;&gt;<i> bbb.bbb.bbb.bbb is the dansguardians
</I>&gt;<i> 
</I>&gt;<i> This is Squid delivering that above TLS error message to the client.Because of how browsers refuse to display errors presented by proxies to CONNECT requests. Squid is being forced to decrypt the HTTP message in the HTTPS tunnel and send the error page as a response to that encrypted request.
</I>I try connect direct to the proxy, and this is the result

1515616366.189   1359 aaa.aaa.aaa.aaa TAG_NONE/200 0 CONNECT www.ssllabs.com:443 ynieves HIER_DIRECT/64.41.200.100 -
1515616366.207      0 aaa.aaa.aaa.aaa TCP_DENIED/403 4419 GET <A HREF="https://www.ssllabs.com/ssltest/viewMyClient.html">https://www.ssllabs.com/ssltest/viewMyClient.html</A> ynieves HIER_NONE/- text/html
1515616366.244      0 aaa.aaa.aaa.aaa TAG_NONE/503 4914 GET <A HREF="http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png">http://artemisa.conalza.co.cu:3128/squid-internal-static/icons/SN.png</A> ynieves HIER_DIRECT/64.41.200.100 text/html

How I can fix this.??

&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180110/2057be28/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180110/2057be28/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017333.html">[squid-users] Squid and SSL Bump
</A></li>
	<LI>Next message (by thread): <A HREF="017337.html">[squid-users] Squid and SSL Bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17334">[ date ]</a>
              <a href="thread.html#17334">[ thread ]</a>
              <a href="subject.html#17334">[ subject ]</a>
              <a href="author.html#17334">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
