<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to block a https website with squid 3.5.3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20block%20a%20https%20website%20with%20squid%203.5.3&In-Reply-To=%3C89c7f65d-90b2-cc22-6386-949c4fb3a0e7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017344.html">
   <LINK REL="Next"  HREF="017353.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to block a https website with squid 3.5.3</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20block%20a%20https%20website%20with%20squid%203.5.3&In-Reply-To=%3C89c7f65d-90b2-cc22-6386-949c4fb3a0e7%40treenet.co.nz%3E"
       TITLE="[squid-users] How to block a https website with squid 3.5.3">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 11 12:16:37 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017344.html">[squid-users] How to block a https website with squid 3.5.3
</A></li>
        <LI>Next message (by thread): <A HREF="017353.html">[squid-users] Performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17347">[ date ]</a>
              <a href="thread.html#17347">[ thread ]</a>
              <a href="subject.html#17347">[ subject ]</a>
              <a href="author.html#17347">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/01/18 23:39, minh h&#432;ng &#273;&#7895; ho&#224;ng wrote:
&gt;<i> Dear all, i using squid as a transparent proxy. But i can't deny a https 
</I>&gt;<i> website like
</I>&gt;<i> <A HREF="https://remitano.com">https://remitano.com</A>
</I>&gt;<i> 
</I>
The first step is to upgrade your Squid. TLS hijacking is a very 
volatile area and things are changing often 3.5.3 is a very old Squid 
release now.
  The current Squid-3 version is 3.5.27.


&gt;<i> My squid is compiled on ubuntu14 with this configure option
</I>&gt;<i> Squid Cache: Version 3.5.3
</I>&gt;<i> Service Name: squid
</I>&gt;<i> configure options:&#160; '--prefix=/usr' '--includedir=/usr/include' 
</I>&gt;<i> '--infodir=/usr/share/info' '--sysconfdir=/etc' '--localstatedir=/var' 
</I>&gt;<i> '--libexecdir=/usr/lib/squid' '--srcdir=.' '--datadir=/usr/share/squid' 
</I>&gt;<i> '--sysconfdir=/etc/squid' '--mandir=/usr/share/man' '--enable-inline' 
</I>&gt;<i> '--enable-async-io=24' '--enable-storeio=ufs,aufs,diskd,rock' 
</I>&gt;<i> '--enable-removal-policies=lru,heap' '--enable-gnuregex' 
</I>&gt;<i> '--enable-cache-digests' '--enable-underscores' '--enable-icap-client' 
</I>&gt;<i> '--enable-follow-x-forwarded-for' '--enable-eui' '--enable-esi' 
</I>&gt;<i> '--enable-icmp' '--enable-zph-qos' '--enable-http-violations' 
</I>&gt;<i> '--enable-ssl-crtd' '--enable-linux-netfilter' '--enable-ltdl-install' 
</I>&gt;<i> '--enable-ltdl-convenience' '--enable-x-accelerator-vary' 
</I>&gt;<i> '--disable-maintainer-mode' '--disable-dependency-tracking' 
</I>&gt;<i> '--disable-silent-rules' '--disable-translation' '--disable-ipv6' 
</I>&gt;<i> '--disable-ident-lookups' '--enable-delay-pools' 
</I>&gt;<i> '--with-swapdir=/var/spool/squid' '--with-logdir=/var/log/squid' 
</I>&gt;<i> '--with-pidfile=/var/run/squid.pid' '--with-aufs-threads=24' 
</I>&gt;<i> '--with-filedescriptors=65536' '--with-large-files' '--with-maxfd=65536' 
</I>&gt;<i> '--with-openssl' '--with-default-user=proxy' '--with-included-ltdl'
</I>&gt;<i> 
</I>&gt;<i> And here is my squid.conf
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 192.168.10.0/24 &lt;<A HREF="http://192.168.10.0/24">http://192.168.10.0/24</A>&gt; #LAN
</I>&gt;<i> acl localnet src 10.10.10.0/24 &lt;<A HREF="http://10.10.10.0/24">http://10.10.10.0/24</A>&gt; #WIFI
</I>&gt;<i> acl localnet src 10.10.20.0/24 &lt;<A HREF="http://10.10.20.0/24">http://10.10.20.0/24</A>&gt; #WIFI
</I>&gt;<i> acl localnet src 172.18.18.0/24 &lt;<A HREF="http://172.18.18.0/24">http://172.18.18.0/24</A>&gt; #WIFI
</I>&gt;<i> acl localnet src 172.17.0.0/16 &lt;<A HREF="http://172.17.0.0/16">http://172.17.0.0/16</A>&gt;
</I>&gt;<i> acl localnet src 10.10.1.0/24 &lt;<A HREF="http://10.10.1.0/24">http://10.10.1.0/24</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump terminate blockregexurl
</I>

TLS does not have URLs. So this will never work.


You need to use ssl::server_name ACLs instead of dstdomain for this 
directive.

ALso, maybe ssl::server_name_regex for the regex patterns *if* any are 
relevant after considering how URLs dont exist.

You are doing peek first, which should make the SNI details available 
for ssl::server_name* to use.



&gt;<i> ssl_bump terminate domain
</I>&gt;<i> ssl_bump terminate block_domain
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,No_Compression
</I>&gt;<i> sslproxy_cipher  
</I>&gt;<i> ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> sslproxy_flags&#160; DONT_VERIFY_PEER
</I>
Remove that DONT_VERIFY_PEER flag. It is only hiding problems from *you* 
the admin - while letting them still be problems for all your clients.

&gt;<i> sslproxy_cafile /etc/squid/intermediate_ca.pem
</I>&gt;<i> 
</I>
This is a bit dangerous. Any non-intermediates Ca certs in that PEM file 
will allow remote hijacking of your proxy outbound connections by 
clients of that root CA.

That said,   you already completely disabled *ALL* verify checks on the 
server certs with DONT_VERIFY_PEER - so anyone can already hijack your 
traffic without needing to go to the trouble of even having their certs 
signed. All they need is some garbage bytes that use the correct X.509 
_format_ used by certs.

After you upgrade your Squid, change that to 
sslproxy_foreign_intermediate_certs which will only load intermediate 
certs for use. If your upgraded Squid does not accept that directive it 
is still too old to use safely for SSL-Bump.



&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> 
</I>
What are the http_port and https_port lines you are using?

&gt;<i> -----------------------
</I>&gt;<i> First , i can block facebook by use this command :
</I>&gt;<i> acl facebook dstdomain .facebook.com &lt;<A HREF="http://facebook.com">http://facebook.com</A>&gt;
</I>&gt;<i> http_access deny CONNECT facebook
</I>&gt;<i> 
</I>
You can only block domains like that if;
  a) you are using explicit proxy and the client sent a CONNECT with a 
domain name, or
  b) its IP address rDNS points back to the domain you are naming in the 
ACL, or
  c) the client sends TLS SNI details *and* your ssl_bump rules make 
that detail available to Squid (eg. peek).


see 
&lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps">https://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps</A>&gt; 
for details on what SSL-Bump actually does at each step of the TLS 
handshake.

Pay particular attention to what info is available at each &quot;step&quot; - and 
also what is *not* available.



&gt;<i> But it is not effect with <A HREF="https://remitano.com">https://remitano.com</A>
</I>&gt;<i> I try to use these command but it's not work:
</I>&gt;<i> 
</I>&gt;<i> acl blockregexurl url_regex -i ^http[s]?:\/\/.*\.remitano\.com\/(/vn)
</I>&gt;<i> http_access deny blockregexurl
</I>&gt;<i> http_access deny CONNECT blockregexurl
</I>
The regex pattern is looking for an absolute-form URL which will never 
exist in any CONNECT messages, since they always use authority-form URL.

That first http_access line might work *if* you already bumped the HTTPS 
traffic. The second never will.


&gt;<i> 
</I>&gt;<i> acl block_domain dstdomain remitano.com &lt;<A HREF="http://remitano.com">http://remitano.com</A>&gt;
</I>&gt;<i> acl domain dstdomain sso.remitano.com &lt;<A HREF="http://sso.remitano.com">http://sso.remitano.com</A>&gt; 
</I>&gt;<i> socket.remitano.com &lt;<A HREF="http://socket.remitano.com">http://socket.remitano.com</A>&gt; cdn.remitano.com 
</I>&gt;<i> &lt;<A HREF="http://cdn.remitano.com">http://cdn.remitano.com</A>&gt;
</I>&gt;<i> http_access deny block_domain
</I>&gt;<i> http_access deny CONNECT block_domain
</I>&gt;<i> http_access deny domain
</I>&gt;<i> http_access deny CONNECT domain
</I>&gt;<i> 
</I>
Same issues mentioned above about the facebook dstdomain ACL as to when 
these dstdomain ACLs will match.

Except that here the &quot;deny foo&quot; lines that go first without mentioning 
CONNECT will match all the same things as the CONNECT line would - 
meaning they already block all traffic even stuff not using CONNECT 
tunnels. So the mention of CONNECT in these lines is pointless, and you 
can completely remove the lines which use it without changing the proxy 
behaviour.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017344.html">[squid-users] How to block a https website with squid 3.5.3
</A></li>
	<LI>Next message (by thread): <A HREF="017353.html">[squid-users] Performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17347">[ date ]</a>
              <a href="thread.html#17347">[ thread ]</a>
              <a href="subject.html#17347">[ subject ]</a>
              <a href="author.html#17347">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
