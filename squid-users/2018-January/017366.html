<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20doesn%27t%20cache%20objects%20in%20memory%20when%20using%0A%20SMP%20and%20shared%20memory%20cache&In-Reply-To=%3Ccf49ca6f-fd92-ed4a-57be-76c5331045d9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017365.html">
   <LINK REL="Next"  HREF="017377.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20doesn%27t%20cache%20objects%20in%20memory%20when%20using%0A%20SMP%20and%20shared%20memory%20cache&In-Reply-To=%3Ccf49ca6f-fd92-ed4a-57be-76c5331045d9%40treenet.co.nz%3E"
       TITLE="[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jan 15 15:22:36 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017365.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
        <LI>Next message (by thread): <A HREF="017377.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17366">[ date ]</a>
              <a href="thread.html#17366">[ thread ]</a>
              <a href="subject.html#17366">[ subject ]</a>
              <a href="author.html#17366">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/01/18 18:53, Ivan Larionov wrote:
&gt;<i> Hello!
</I>&gt;<i> 
</I>&gt;<i> After migrating squid from non-SMP/aufs to SMP/rock memory cache hit 
</I>&gt;<i> ratio dropped significantly. Like from 50-100% to 1-5%. And disk cache 
</I>&gt;<i> hit ratio went up from 15-50% to stable 60-65%. From the brief log file 
</I>&gt;<i> check it looks like in SMP/rock mode squid avoids using memory for small 
</I>&gt;<i> files like 1-3KB but uses it for 10KB+ files.
</I>
AIUI, SMP-mode rock operates as a fully separate process (a &quot;Disker&quot; 
kid) which delivers its results as objects already in shared memory to 
the worker process.

There should be little or no gain from that promotion process anymore - 
which would only be moving the object between memory locations. In fact 
if cache_mem were not operating as shared memory even with SMP active 
(which is possible) the promotion would be an actively bad idea as it 
prevents other workers using the object in future.

They show up as non- MEM_HIT because they are either REFRESH or stored 
in the Disker shared memory instead of the cache_mem shared memory. The 
Squid logging is not quite up to recording the slim distinction between 
which of multiple memory areas are being used.


&gt;<i> 
</I>&gt;<i> I started tracking down the issue with disabling disk cache completely 
</I>&gt;<i> and it didn't change anything, I just started to get MISS every time for 
</I>&gt;<i> the URL which was getting MEM_HIT with an old configuration. Then I 
</I>&gt;<i> changed &quot;workers 2&quot; to &quot;workers 1&quot; and started getting memory hits as 
</I>&gt;<i> before.
</I>&gt;<i> 
</I>&gt;<i> So it seems like the issue is with shared memory:
</I>&gt;<i> 
</I>&gt;<i> When squid doesn't use shared memory it works as expected. Even with 
</I>&gt;<i> multiple workers.
</I>&gt;<i> When squid uses shared memory it caches very small amount of objects.
</I>&gt;<i> 
</I>&gt;<i> Am I doing anything wrong? Which debug options should I enable to 
</I>&gt;<i> provide more information if it seems like a bug?
</I>&gt;<i> 
</I>
Are you seeing an actual performance difference? if not I would not 
worry about it.

FYI: if you really want to track this down I suggest using Squid-4 to do 
that. Squid-3 is very near the end of its support lifetime and changes 
of a deep nature do not have much chance at all of getting in there now.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017365.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
	<LI>Next message (by thread): <A HREF="017377.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17366">[ date ]</a>
              <a href="thread.html#17366">[ thread ]</a>
              <a href="subject.html#17366">[ subject ]</a>
              <a href="author.html#17366">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
