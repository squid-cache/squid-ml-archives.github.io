<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20doesn%27t%20cache%20objects%20in%20memory%20when%20using%0A%20SMP%20and%20shared%20memory%20cache&In-Reply-To=%3CCAHvB88ywPt0062F1WNPyGZne6rwPO_V-%3Dy7ZSLvVv%3D4iE6s2KA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017377.html">
   <LINK REL="Next"  HREF="017390.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache</H1>
    <B>Ivan Larionov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20doesn%27t%20cache%20objects%20in%20memory%20when%20using%0A%20SMP%20and%20shared%20memory%20cache&In-Reply-To=%3CCAHvB88ywPt0062F1WNPyGZne6rwPO_V-%3Dy7ZSLvVv%3D4iE6s2KA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache">xeron.oskom at gmail.com
       </A><BR>
    <I>Tue Jan 16 04:18:21 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017377.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
        <LI>Next message (by thread): <A HREF="017390.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17384">[ date ]</a>
              <a href="thread.html#17384">[ thread ]</a>
              <a href="subject.html#17384">[ subject ]</a>
              <a href="author.html#17384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>My disks are fast (SSD) so I didn't see performance issues but it doesn't
change the fact that memory hit ratio decreased in more than 10 times. And
with both rock and shared memory cache enabled most of the files were saved
into disk cache and not into memory cache and most of the hits were disk
hits (according to log file).

I already tried squid 4 and it works as expected.

So. Let's forget about rock because the issue I see is related to shared
memory. For my test file with only memory cache enabled:

squid 3.5.27 non-SMP - MISS first then always MEM_HIT
squid 3.5.27 SMP any amount of workers shared memory off - always MEM_HIT
after all workers handled the request once
squid 3.5.27 SMP any amount of workers shared memory on - MISS every time.
squid 4.0.22 SMP 2 workers shared memory on - MISS first then always MEM_HIT

I would like to use squid 4 in production and I probably will since looks
like SMP/shared_cache is broken in 3, but the fact that you still haven't
released it confuses me. IDK why it's still in beta/rc/whatever stage.

On Mon, Jan 15, 2018 at 7:22 AM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 15/01/18 18:53, Ivan Larionov wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After migrating squid from non-SMP/aufs to SMP/rock memory cache hit
</I>&gt;&gt;<i> ratio dropped significantly. Like from 50-100% to 1-5%. And disk cache hit
</I>&gt;&gt;<i> ratio went up from 15-50% to stable 60-65%. From the brief log file check
</I>&gt;&gt;<i> it looks like in SMP/rock mode squid avoids using memory for small files
</I>&gt;&gt;<i> like 1-3KB but uses it for 10KB+ files.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> AIUI, SMP-mode rock operates as a fully separate process (a &quot;Disker&quot; kid)
</I>&gt;<i> which delivers its results as objects already in shared memory to the
</I>&gt;<i> worker process.
</I>&gt;<i>
</I>&gt;<i> There should be little or no gain from that promotion process anymore -
</I>&gt;<i> which would only be moving the object between memory locations. In fact if
</I>&gt;<i> cache_mem were not operating as shared memory even with SMP active (which
</I>&gt;<i> is possible) the promotion would be an actively bad idea as it prevents
</I>&gt;<i> other workers using the object in future.
</I>&gt;<i>
</I>&gt;<i> They show up as non- MEM_HIT because they are either REFRESH or stored in
</I>&gt;<i> the Disker shared memory instead of the cache_mem shared memory. The Squid
</I>&gt;<i> logging is not quite up to recording the slim distinction between which of
</I>&gt;<i> multiple memory areas are being used.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I started tracking down the issue with disabling disk cache completely
</I>&gt;&gt;<i> and it didn't change anything, I just started to get MISS every time for
</I>&gt;&gt;<i> the URL which was getting MEM_HIT with an old configuration. Then I changed
</I>&gt;&gt;<i> &quot;workers 2&quot; to &quot;workers 1&quot; and started getting memory hits as before.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So it seems like the issue is with shared memory:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When squid doesn't use shared memory it works as expected. Even with
</I>&gt;&gt;<i> multiple workers.
</I>&gt;&gt;<i> When squid uses shared memory it caches very small amount of objects.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Am I doing anything wrong? Which debug options should I enable to provide
</I>&gt;&gt;<i> more information if it seems like a bug?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Are you seeing an actual performance difference? if not I would not worry
</I>&gt;<i> about it.
</I>&gt;<i>
</I>&gt;<i> FYI: if you really want to track this down I suggest using Squid-4 to do
</I>&gt;<i> that. Squid-3 is very near the end of its support lifetime and changes of a
</I>&gt;<i> deep nature do not have much chance at all of getting in there now.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>


-- 
With best regards, Ivan Larionov.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180115/f823bf60/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180115/f823bf60/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017377.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
	<LI>Next message (by thread): <A HREF="017390.html">[squid-users] squid doesn't cache objects in memory when using SMP and shared memory cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17384">[ date ]</a>
              <a href="thread.html#17384">[ thread ]</a>
              <a href="subject.html#17384">[ subject ]</a>
              <a href="author.html#17384">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
