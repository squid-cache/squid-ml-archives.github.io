<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID with two authentications methods
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20with%20two%20authentications%20methods&In-Reply-To=%3C9e65c14c30dd91b.5a5e431d%40ac-nancy-metz.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017374.html">
   <LINK REL="Next"  HREF="017392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID with two authentications methods</H1>
    <B>Colle Christophe</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20with%20two%20authentications%20methods&In-Reply-To=%3C9e65c14c30dd91b.5a5e431d%40ac-nancy-metz.fr%3E"
       TITLE="[squid-users] SQUID with two authentications methods">christophe.colle at ac-nancy-metz.fr
       </A><BR>
    <I>Tue Jan 16 17:23:25 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017374.html">[squid-users] Logging PROXY Protocol header
</A></li>
        <LI>Next message (by thread): <A HREF="017392.html">[squid-users] SQUID with two authentications methods
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17391">[ date ]</a>
              <a href="thread.html#17391">[ thread ]</a>
              <a href="subject.html#17391">[ subject ]</a>
              <a href="author.html#17391">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I want to configure SQUID with two authentications methods:

- Kerberos (to do SSO with posts in an ActiveDirectory domain)
- Basic (Open LDAP directory)

The LDAP directory contains all the &quot;official&quot; accounts of people, the AD directory contains some accounts (same identifiers as on LDAP) and generic accounts.

Everything works fine, but I would like to add an extra check: The Kerberos account must also exist in the LDAP directory in order to not allow use of generic accounts.

I managed to do that with Squid but I get this behavior:

- Account present in AD + LDAP: OK
- Account present in AD but not in LDAP: KO

Is it possible to force LDAP authentication if &quot;check_ldap&#160;&quot; fail ?


My config :


# KERBEROS
auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth
auth_param negotiate children 50 startup=5 idle=1
auth_param negotiate keep_alive on


# LDAP
auth_param basic program /usr/lib/squid/basic_ldap_auth -v 3 -b &quot;ou=official&quot; -f &quot;(uid=%s)&quot; ldap.contonso.lan:389
auth_param basic children 50 startup=5 idle=1
auth_param basic credentialsttl 1 hours




# Extra check
external_acl_type check_ldap ipv4 ttl=3600 children-max=50 %LOGIN /etc/squid/check_ldap_aca.sh




acl authenticated proxy_auth REQUIRED
acl check_ldap external check_ldap




http_access allow http port_80 check_ldap
http_access allow https port_443 check_ldap
http_access allow ftp port_21 check_ldap


http_access deny !authenticated



http_access deny all



My check_ldap_aca.sh :



#!/bin/bash


while read user 
do
 identifiant=(${user//@/ }) 


 result=$(ldapsearch -LLL -h  ldap.contonso.lan  -p 389 -D &quot;uid=usr-proxy&quot; -w *****  -b &quot;ou= official &quot; &quot; (uid=%s) &quot; uid) 
 if [ ${#result} -gt 4 ]
 then
 echo &quot;OK user=$identifiant&quot;
 else
 echo &quot;ERR user=$identifiant&quot;
 fi
done



Thank !

--
Chris
&lt;signatureafterquotedtext&gt;&lt;/signatureafterquotedtext&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180116/f50b5494/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180116/f50b5494/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017374.html">[squid-users] Logging PROXY Protocol header
</A></li>
	<LI>Next message (by thread): <A HREF="017392.html">[squid-users] SQUID with two authentications methods
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17391">[ date ]</a>
              <a href="thread.html#17391">[ thread ]</a>
              <a href="subject.html#17391">[ subject ]</a>
              <a href="author.html#17391">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
