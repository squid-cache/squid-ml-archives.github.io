<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4 and missing intermediate certs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%20and%20missing%20intermediate%20certs&In-Reply-To=%3Cda22240c-2f49-e8f9-8e70-eea9db163db1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017465.html">
   <LINK REL="Next"  HREF="017480.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4 and missing intermediate certs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%20and%20missing%20intermediate%20certs&In-Reply-To=%3Cda22240c-2f49-e8f9-8e70-eea9db163db1%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 4 and missing intermediate certs">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jan 26 17:50:50 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017465.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
        <LI>Next message (by thread): <A HREF="017480.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17468">[ date ]</a>
              <a href="thread.html#17468">[ thread ]</a>
              <a href="subject.html#17468">[ subject ]</a>
              <a href="author.html#17468">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/26/2018 02:30 AM, Alex Crow wrote:

&gt;<i> I've just set up a new SSL interception proxy using peek/splice/bump
</I>&gt;<i> using squid 4.0.22 and I'm getting SSL errors on some site indicating
</I>&gt;<i> missing intermediate certs as described here:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://blog.diladele.com/2015/04/21/fixing-x509_v_err_unable_to_get_issuer_cert_locally-on-ssl-bumping-squid/">https://blog.diladele.com/2015/04/21/fixing-x509_v_err_unable_to_get_issuer_cert_locally-on-ssl-bumping-squid/</A>
</I>&gt;<i> 
</I>&gt;<i> I have read the wiki and I see this on the SslBumpExplicit page:
</I>&gt;<i> 
</I>&gt;<i> &quot;Squid-4 &lt;<A HREF="https://wiki.squid-cache.org/Squid-4">https://wiki.squid-cache.org/Squid-4</A>&gt; is capable of
</I>&gt;<i> downloading missing intermediate CA certificates, like popular browsers do.&quot;
</I>&gt;<i> 
</I>&gt;<i> However I'm finding that I have to follow the procedure in the diladele
</I>&gt;<i> article and manually install the intermediate certs into the PKI trust
</I>&gt;<i> to work around this.
</I>

Several cases are possible here:

1. Squid is missing the root certificate used by the origin server.
Neither Squid nor browsers can fetch root certificates automatically
(for hopefully obvious reasons).

2. Squid is missing an intermediate certificate used by the origin
server, and the origin server provided no instructions on how to fetch
that missing certificate automatically. Neither Squid (for sure) nor
browsers (AFAIK) can fetch missing intermediate certificates
automatically if they are not given origin server instructions of where
to get them. Those instructions are usually given as various extension
fields in signed certificates.

3. Squid is missing an intermediate certificate used by the origin
server, the origin server provided instructions on how to fetch that
missing certificate automatically, but Squid does not understand/support
those instructions. There are several instruction formats/variants, and
Squid does not support some of them. Please consider adding that support
to Squid (requires writing code or sponsoring development).

4. Squid is missing an intermediate certificate used by the origin
server, the origin server provided instructions on how to fetch that
missing certificate automatically, Squid followed those instructions,
but something went wrong. Study detailed Squid debugging logs or post
them for analysis by others.

You need to study each error to understand which case applies to it.

To make matters worse, a combination of #1 and other cases is possible:
Sometimes, automatically fetching a missing certificate leads to
certificate validation problems that could have been avoided if Squid
had the right (and different) trusted certificate in the first place:
<A HREF="https://github.com/squid-cache/squid/commit/9ef7d9d5ddef54283cea4f1fdb7b3bbc1715755c">https://github.com/squid-cache/squid/commit/9ef7d9d5ddef54283cea4f1fdb7b3bbc1715755c</A>


I doubt Squid logs enough information (by default) to quickly and easily
distinguish the four cases for a given error -- you may need to study
the origin server certificates and Squid logs. For example, #4 should
manifest itself as access.log errors associated with failed certificate
fetching requests.


As the solution for #1-2 or workaround for #3-4, if you trust the
missing certificate, manually add it to your trust store (which is what
you were doing).


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017465.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
	<LI>Next message (by thread): <A HREF="017480.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17468">[ date ]</a>
              <a href="thread.html#17468">[ thread ]</a>
              <a href="subject.html#17468">[ subject ]</a>
              <a href="author.html#17468">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
