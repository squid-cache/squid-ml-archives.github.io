<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4 and missing intermediate certs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%20and%20missing%20intermediate%20certs&In-Reply-To=%3C2645f16c-f0ae-6816-6c06-cd6c0854c97e%40integrafin.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017468.html">
   <LINK REL="Next"  HREF="017481.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4 and missing intermediate certs</H1>
    <B>Alex Crow</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%20and%20missing%20intermediate%20certs&In-Reply-To=%3C2645f16c-f0ae-6816-6c06-cd6c0854c97e%40integrafin.co.uk%3E"
       TITLE="[squid-users] Squid 4 and missing intermediate certs">acrow at integrafin.co.uk
       </A><BR>
    <I>Mon Jan 29 09:48:50 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017468.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
        <LI>Next message (by thread): <A HREF="017481.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17480">[ date ]</a>
              <a href="thread.html#17480">[ thread ]</a>
              <a href="subject.html#17480">[ subject ]</a>
              <a href="author.html#17480">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/01/18 17:50, Alex Rousskov wrote:
&gt;<i> On 01/26/2018 02:30 AM, Alex Crow wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I've just set up a new SSL interception proxy using peek/splice/bump
</I>&gt;&gt;<i> using squid 4.0.22 and I'm getting SSL errors on some site indicating
</I>&gt;&gt;<i> missing intermediate certs as described here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://blog.diladele.com/2015/04/21/fixing-x509_v_err_unable_to_get_issuer_cert_locally-on-ssl-bumping-squid/">https://blog.diladele.com/2015/04/21/fixing-x509_v_err_unable_to_get_issuer_cert_locally-on-ssl-bumping-squid/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have read the wiki and I see this on the SslBumpExplicit page:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;Squid-4 &lt;<A HREF="https://wiki.squid-cache.org/Squid-4">https://wiki.squid-cache.org/Squid-4</A>&gt; is capable of
</I>&gt;&gt;<i> downloading missing intermediate CA certificates, like popular browsers do.&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However I'm finding that I have to follow the procedure in the diladele
</I>&gt;&gt;<i> article and manually install the intermediate certs into the PKI trust
</I>&gt;&gt;<i> to work around this.
</I>&gt;<i>
</I>&gt;<i> Several cases are possible here:
</I>&gt;<i>
</I>&gt;<i> 1. Squid is missing the root certificate used by the origin server.
</I>&gt;<i> Neither Squid nor browsers can fetch root certificates automatically
</I>&gt;<i> (for hopefully obvious reasons).
</I>&gt;<i>
</I>&gt;<i> 2. Squid is missing an intermediate certificate used by the origin
</I>&gt;<i> server, and the origin server provided no instructions on how to fetch
</I>&gt;<i> that missing certificate automatically. Neither Squid (for sure) nor
</I>&gt;<i> browsers (AFAIK) can fetch missing intermediate certificates
</I>&gt;<i> automatically if they are not given origin server instructions of where
</I>&gt;<i> to get them. Those instructions are usually given as various extension
</I>&gt;<i> fields in signed certificates.
</I>&gt;<i>
</I>&gt;<i> 3. Squid is missing an intermediate certificate used by the origin
</I>&gt;<i> server, the origin server provided instructions on how to fetch that
</I>&gt;<i> missing certificate automatically, but Squid does not understand/support
</I>&gt;<i> those instructions. There are several instruction formats/variants, and
</I>&gt;<i> Squid does not support some of them. Please consider adding that support
</I>&gt;<i> to Squid (requires writing code or sponsoring development).
</I>&gt;<i>
</I>&gt;<i> 4. Squid is missing an intermediate certificate used by the origin
</I>&gt;<i> server, the origin server provided instructions on how to fetch that
</I>&gt;<i> missing certificate automatically, Squid followed those instructions,
</I>&gt;<i> but something went wrong. Study detailed Squid debugging logs or post
</I>&gt;<i> them for analysis by others.
</I>&gt;<i>
</I>&gt;<i> You need to study each error to understand which case applies to it.
</I>&gt;<i>
</I>&gt;<i> To make matters worse, a combination of #1 and other cases is possible:
</I>&gt;<i> Sometimes, automatically fetching a missing certificate leads to
</I>&gt;<i> certificate validation problems that could have been avoided if Squid
</I>&gt;<i> had the right (and different) trusted certificate in the first place:
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/commit/9ef7d9d5ddef54283cea4f1fdb7b3bbc1715755c">https://github.com/squid-cache/squid/commit/9ef7d9d5ddef54283cea4f1fdb7b3bbc1715755c</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I doubt Squid logs enough information (by default) to quickly and easily
</I>&gt;<i> distinguish the four cases for a given error -- you may need to study
</I>&gt;<i> the origin server certificates and Squid logs. For example, #4 should
</I>&gt;<i> manifest itself as access.log errors associated with failed certificate
</I>&gt;<i> fetching requests.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As the solution for #1-2 or workaround for #3-4, if you trust the
</I>&gt;<i> missing certificate, manually add it to your trust store (which is what
</I>&gt;<i> you were doing).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>
Thanks very much Alex. I thought it might be something like that. I'm 
guessing it's most likely #3 or #4 as the site works direct from the 
browser.

Cheers

Alex
--
This message is intended only for the addressee and may contain
confidential information. Unless you are that person, you may not
disclose its contents or use it in any way and are requested to delete
the message along with any attachments and notify us immediately.
This email is not intended to, nor should it be taken to, constitute advice.
The information provided is correct to our knowledge &amp; belief and must not
be used as a substitute for obtaining tax, regulatory, investment, legal or
any other appropriate advice.

&quot;Transact&quot; is operated by Integrated Financial Arrangements Ltd.
29 Clement's Lane, London EC4N 7AE. Tel: (020) 7608 4900 Fax: (020) 7608 5300.
(Registered office: as above; Registered in England and Wales under
number: 3727592). Authorised and regulated by the Financial Conduct
Authority (entered on the Financial Services Register; no. 190856).

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017468.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
	<LI>Next message (by thread): <A HREF="017481.html">[squid-users] Squid 4 and missing intermediate certs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17480">[ date ]</a>
              <a href="thread.html#17480">[ thread ]</a>
              <a href="subject.html#17480">[ subject ]</a>
              <a href="author.html#17480">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
