<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Behavior of Squid with SSL Bump and server persistent connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Behavior%20of%20Squid%20with%20SSL%20Bump%20and%20server%0A%20persistent%20connections&In-Reply-To=%3C10988743-069b-eb83-4876-ef99981da101%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018600.html">
   <LINK REL="Next"  HREF="018614.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Behavior of Squid with SSL Bump and server persistent connections</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Behavior%20of%20Squid%20with%20SSL%20Bump%20and%20server%0A%20persistent%20connections&In-Reply-To=%3C10988743-069b-eb83-4876-ef99981da101%40measurement-factory.com%3E"
       TITLE="[squid-users] Behavior of Squid with SSL Bump and server persistent connections">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jul  3 19:57:31 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018600.html">[squid-users] Behavior of Squid with SSL Bump and server persistent connections
</A></li>
        <LI>Next message (by thread): <A HREF="018614.html">[squid-users] Behavior of Squid with SSL Bump and server persistent connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18601">[ date ]</a>
              <a href="thread.html#18601">[ thread ]</a>
              <a href="subject.html#18601">[ subject ]</a>
              <a href="author.html#18601">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/03/2018 12:02 PM, Vishali Somaskanthan wrote:

&gt;<i> Consider C1 and S1 connections were created for a HTTPs connection
</I>&gt;<i> using ssl-bump. C1 has been served and closed from the client side.
</I>
Please note that C1/S1 could serve many requests before C1 got closed.
However, let's focus on the cross-client reuse you are asking about.

There are two different cases to consider:

* ssl_bump stare step2:  In my previous email, I was talking about the
(more typical) case of staring at the client and server before bumping
the connection. In that case, Squid can keep S1 open after closing C1
only if Squid can re-mimic S1 TLS properties when C2 comes. If Squid
cannot, Squid should close S1 as non-reusable. I am not sure, but I
suspect that Squid cannot mimic properties of an already open connection
(yet). If that suspicion is accurate, then Squid should close S1.

* ssl_bump bump step2: In your configuration, clients are bumped without
mimicking server details. In that case, one can view S1 as totally
independent from C1. When C1 is closed, S1 can remain open.


&gt;<i> Now, the client initiates another HTTPS connection, C2. Since,
</I>&gt;<i> persistent connection is enabled, expectation is to see that S1 gets
</I>&gt;<i> re-used.
</I>
Same two cases as above:

* ssl_bump stare step2: The TLS properties negotiated on the C2
connection depend on the server connection properties and, if S2 is
established, may end up being different than the TLS properties of C1
(which depends on S1). To honor its configuration, when C1 comes, Squid
should either open a new S2 connection or mimic the properties of the S1
connection. Again, I suspect that Squid does not know how to do the
latter so it opens S2.

* ssl_bump bump step2: In your configuration, clients are bumped without
mimicking server details. In that case, one can view S1 as totally
independent from C1. When C2 comes, S1 can be reused.


&gt;<i> Behaviour seen now is that S2 gets created and a handshake ensues
</I>&gt;<i> between squid and server.
</I>

&gt;<i> After ~30seconds, S1 is re-used to serve the request C2.
</I>
If there are no other in-progress requests for S, then the combination
of the two seems like a bug to me: Squid (in your configuration) should
either reuse S1 right away or never reuse S1.

I am not sure which connections you capture represents, but it seems to
be missing packets for the second (client port 46550) TCP stream (no SYN
packet, for example). Without you publishing the keys for these
connections, it is not possible to see what happens at HTTP level.
Posting dedicated Squid debugging logs may be a better strategy.


HTH,

Alex.



&gt;<i> On Mon, Jul 2, 2018 at 4:57 PM, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 07/02/2018 05:34 PM, Vishali Somaskanthan wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; I am trying out SSL Bump for my connections from Squid to server and
</I>&gt;<i>     &gt; trying to put along server persistent connections as well. I would like
</I>&gt;<i>     &gt; to know how squid behaves with both of these turned on??
</I>&gt;<i> 
</I>&gt;<i>     In modern Squids, all(*) bumped SSL client HTTP requests (from client
</I>&gt;<i>     connection C) should use the corresponding bumped connection to the
</I>&gt;<i>     server (S). After the first HTTP request, if more requests arrive on
</I>&gt;<i>     connection C, and they are all regular/basic requests, then they can all
</I>&gt;<i>     go through connection S. Once HTTP rules, timeouts, or other factors
</I>&gt;<i>     prohibit connection S or connection C reuse, Squid should close both
</I>&gt;<i>     connections.
</I>&gt;<i> 
</I>&gt;<i>     Please note that I do not know whether Squid correctly forces all(*)
</I>&gt;<i>     HTTP requests on connection C to connection S, but it should. If it does
</I>&gt;<i>     not, file a bug report. Same for closing connection C when connection S
</I>&gt;<i>     becomes unusable.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I see info in the squid wiki page that SSL Bump creates fake CONNECT
</I>&gt;<i>     &gt; requests and Peeking at Step1 creates another CONNECT request. 
</I>&gt;<i> 
</I>&gt;<i>     Peeking or staring may indeed produce internal fake CONNECT requests,
</I>&gt;<i>     but they are unrelated to your question. They are used internally to
</I>&gt;<i>     handle the client TLS connection and for giving adaptation services a
</I>&gt;<i>     say in the matter. Persistency is an HTTP term that is applied to what
</I>&gt;<i>     happens _after_ the TLS connections is bumped.
</I>&gt;<i> 
</I>&gt;<i>     (Also, peeking is a part of the SslBump feature -- they are not two
</I>&gt;<i>     different actions or stages as &quot;and&quot; in your summary implies).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i>     P.S. (*) &quot;all&quot; should be interpreted as &quot;all that need a server
</I>&gt;<i>     connection&quot; here -- pure cache hits, adaptation-satisfied requests, and
</I>&gt;<i>     probably some erroneous requests (e.g., those blocked by http_access
</I>&gt;<i>     rules?) do not use the server connection.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Regards,
</I>&gt;<i> Vishali Somaskanthan
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018600.html">[squid-users] Behavior of Squid with SSL Bump and server persistent connections
</A></li>
	<LI>Next message (by thread): <A HREF="018614.html">[squid-users] Behavior of Squid with SSL Bump and server persistent connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18601">[ date ]</a>
              <a href="thread.html#18601">[ thread ]</a>
              <a href="subject.html#18601">[ subject ]</a>
              <a href="author.html#18601">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
