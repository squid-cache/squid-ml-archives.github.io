<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems with peek and slice through parent proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20peek%20and%20slice%20through%20parent%20proxy&In-Reply-To=%3C1D5EA300AD31C04CB0E5E4DA3F3D402F0109C14820%40DAGFBGWET02.wetteraukreis.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018653.html">
   <LINK REL="Next"  HREF="018658.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems with peek and slice through parent proxy</H1>
    <B>Hess, Niklas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20peek%20and%20slice%20through%20parent%20proxy&In-Reply-To=%3C1D5EA300AD31C04CB0E5E4DA3F3D402F0109C14820%40DAGFBGWET02.wetteraukreis.local%3E"
       TITLE="[squid-users] Problems with peek and slice through parent proxy">Niklas.Hess at webit-wetterau.de
       </A><BR>
    <I>Thu Jul 12 06:17:50 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018653.html">[squid-users] Problems with peek and slice through parent proxy
</A></li>
        <LI>Next message (by thread): <A HREF="018658.html">[squid-users] ERROR: Unknown TLS option clientca
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18657">[ date ]</a>
              <a href="thread.html#18657">[ thread ]</a>
              <a href="subject.html#18657">[ subject ]</a>
              <a href="author.html#18657">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello again,

Thanks for any help.

It&#180;s an forward Proxy only and my users plan to connect to a cloud in the internet.
The parent proxy, that I have to deal with, is not administrated by me or any of my colleges. (It&#180;s the ISP proxy)
I can't make any changes to the parent.

The plan is, that the proxy would decrypt the SSL traffic from the Webserver, scan it through ClamAV and then send it back to the client, encrypted with the Certificate from our internal CA.


&lt;Client&gt; - - - SSL (int) - - - &lt;Proxy&gt; - - - SSL (ext) - - - &lt;Parent&gt; - - - SSL (ext) - - - &lt;Webserver&gt;

Int = internal certificate
Ext = external (original) certificate

And I know my config is a security mess but I will correct that.
Even with your &quot;minimal&quot; config I get: &quot; assertion failed: PeerConnector.cc:116: &quot;peer-&gt;use_ssl&quot; in the cache.log
And I probably have to add the option &quot;ssl&quot; to the parent in my config, but this isn&#8217;t too because the parent wouldn&#180;t understand it.

Is there a way of doing that, without touching the parent proxy?

Thanks again for any help!
Niklas


On 12/07/18 01:43, Kedar K wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Jul 11, 2018 at 7:03 PM Hess, Niklas wrote:
</I>&gt;<i>
</I>&gt;<i>     Hello list,____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     I&#180;m setting up a Squid proxy specifically to scan the incoming
</I>&gt;<i>     traffic from a cloud platform.____
</I>&gt;<i>
</I>
Please clarify what &quot;incoming&quot; means to you. Is the cloud platform generating request messages or supplying the responses?

The HTTP definition of in/out is oriented with request flow. ie from the origin server point of view, *opposite* to what an ISP would describe it as.



&gt;<i>     ClamAV should scan the incoming traffic.____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     So far so good.____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>
May appear to be, but your displayed config is absolutely *not* &quot;all good&quot;. Details below.


&gt;<i>
</I>&gt;<i>     The cloud uses WebDAV over HTTPS, so I have to SSL-Bump the incoming
</I>&gt;<i>     traffic via Peek and Splice Feature.____
</I>&gt;<i>
</I>
Then do so. The config you show below is not peek+splice.

It is &quot;bump all&quot; which is the old client-first behaviour.


&gt;<i>     That works indeed with the CA signed internal Certificate.____
</I>&gt;<i>
</I>
Ah, if by CA you mean one of the global &quot;Trusted CA&quot;. Then you probably should not be using SSl-Bump at all. That is a feature for forward/explicit proxy to access.

Otherwise if your CA is a self-signed/generated one then of course it &quot;works&quot;. All SSL-Bump variants use that type of CA certificate.


&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     But as soon as I add a cache_peer as a &#8220;parent proxy&#8221; it does not
</I>&gt;<i>     work. (This request could not be forwarded to the origin server or
</I>&gt;<i>     to any parent caches.)____
</I>&gt;<i>
</I>&gt;<i>     I just get &#8220;FwdState.cc(813) connectStart: fwdConnectStart: Ssl
</I>&gt;<i>     bumped connections through parent proxy are not allowed&#8221; in the
</I>&gt;<i>     cache.log____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     And yes I know ssl-bump through a parent proxy is an security issue
</I>&gt;<i>     and might be unsecure, but the connection to the parent is internal,
</I>&gt;<i>     save and secure.____
</I>&gt;<i>
</I>
Don't count on that. You configured an open proxy. Anyone who can open a TCP connection to it pretty much has wide-open (and anonymized) access to all your LAN internal services.

The decision to do that, even for testing, implies a potential for holes which does not bode well.



&gt;<i>     I don&#8217;t know how, but could there be a way to &#8220;comment out&#8221; the
</I>&gt;<i>     section in fwdConnectStart source file?____
</I>&gt;<i>
</I>
You cannot comment out a *lack* of something. That is the problem here.
There is no TLS on this peer's connection, so no server-cert exists for Squid to copy/forge in what it is sending the client. More on that below.


&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     Squid Cache: Version 3.5.27____
</I>&gt;<i>
</I>&gt;<i>     Service Name: squid____
</I>&gt;<i>
</I>&gt;<i>     configure options:  '--with-openssl' '--enable-ssl-crtd'____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     Here&#180;s my &#8220;minimal&#8221; SSL-Bump config:____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     ### Start config____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     debug_options ALL,6____
</I>&gt;<i>
</I>&gt;<i>     shutdown_lifetime 1 seconds____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     http_port 8080 ssl-bump
</I>&gt;<i>     cert=/usr/local/squid/etc/ssl_cert/Squidtest.pem
</I>&gt;<i>     generate-host-certificates=on dynamic_cert_mem_cache_size=4MB____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db
</I>&gt;<i>     -M 4MB____
</I>&gt;<i>
</I>&gt;<i>     sslcrtd_children 25 startup=5 idle=10____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     cache_peer 10.106.3.66 parent 8080 0 no-query no-digest
</I>&gt;<i> name=parent____
</I>&gt;<i>
</I>
The connection to this peer is not secured. TLS (thus HTTPS) traffic is required to remain secure on outbound connections.
 Note that this does *not* mean it has to remain HTTPS - but it cannot be plain-text HTTP like the above peer connection. Currently the only security protocol cache_peer supports is TLS/SSL, so the &quot;ssl&quot; (v2.6 -
v3.5) or &quot;tls&quot; options (v4.0+) is required.

Also, the outgoing server cert is what Squid bases its forged serverHello certificate on. So there are major problems added when the cache_peer certificate is different from the origin servers one.

The ideal way to relay SSL-Bumped traffic between proxies is currently to let Squid re-encrypt it. Then to repeat the NAT intercept directing Squids outbound connections into the second proxy.

IIRC, Measurement Factory have an ongoing project adding ability for Squid to generate CONNECT messages which will make cache_peer links work better. But even so the second proxy will still have to do its own SSL-Bump on the crypted traffic, because we *have* to get the origin server cert parameters through the whole chain to the client for the TLS to work properly.


&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     never_direct allow all____
</I>&gt;<i>
</I>&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     sslproxy_cert_error allow all____
</I>&gt;<i>
</I>&gt;<i>     sslproxy_flags DONT_VERIFY_PEER____
</I>&gt;<i>
</I>
Don't do this. Ever. It actively disables all the security which is the whole point of TLS existence. Rendering any tests which you may do to check for &quot;working&quot; invalid.

The server/peer could emit random garbage bytes in a syntax layout resembling a TLS handshake and this Squid would blithely say &quot;okay&quot; and send it the clients private data. While telling the client *and you* that everything was find and working properly. So not even useful for troubleshooting.


&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> &#8203;Did you forget to copy at_step acls?
</I>&gt;<i>
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> &#8203;
</I>
That alone won't help here. &quot;acl ...&quot; lines are simply telling Squid what to test *for*, not when to test nor any action that test should result in.

What is needed is an actual policy on what needs to happen, in terms of these TLS handshake stages. From that you should be able to craft ssl_bump rules to enact that policy.

The actual minimal is:

 ssl_bump splice all

A more usual splice for troubleshooting is:

 ssl_bump peek all
 ssl_bump splice all

 - which tells Squid to look at (peek) all stages of the handshake which can be looked at, without doing any changes, then to splice (opaque
tunnel) the crypted data portion.


The minimal to decrypt is:

 acl step1 at_step SslBump1
 ssl_bump peek step1
 ssl_bump stare all
 ssl_bump bump all

- which tells Squid to look at clientHello in the TLS handshake, and look at the serverHello part while filtering out any features that prohibit bump, then decrypt the crypted portion.


&gt;<i>     __ __
</I>&gt;<i>
</I>&gt;<i>     http_access allow all____
</I>&gt;<i>
</I>
Another don't.

Please keep the default http_access lines we provide as recommended rules. Add whatever you need at the point the default config file says &quot;INSERT YOUR OWN RULE(S) HERE&quot;.

Restrictions should be based on what the LAN is (for ISP proxies), or on what domains being serviced are (for CDN / reverse-proxy).


Amos
Azubi Niklas Hess
Team Applikation-Management

Eigenbetrieb Informationstechnologie des Wetteraukreises
61169 Friedberg
Europaplatz
Geb&#228;ude B
Tel.: 06031 83-6526
Mobil:
Fax.: 06031 83-916526
www.wetteraukreis.de



Informationen zum Datenschutz erhalten sie &#252;ber unsere Datenschutzseite www.datenschutz.wetterau.de
Dies ist eine vertrauliche Nachricht und nur f&#252;r den Adressaten bestimmt. Es ist nicht erlaubt, diese Nachricht zu kopieren oder Dritten zug&#228;nglich zu machen. Sollten Sie irrt&#252;mlich diese Nachricht erhalten haben, bitte ich um Ihre Mitteilung per E-Mail oder unter der oben angegebenen Telefonnummer.

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018653.html">[squid-users] Problems with peek and slice through parent proxy
</A></li>
	<LI>Next message (by thread): <A HREF="018658.html">[squid-users] ERROR: Unknown TLS option clientca
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18657">[ date ]</a>
              <a href="thread.html#18657">[ thread ]</a>
              <a href="subject.html#18657">[ subject ]</a>
              <a href="author.html#18657">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
