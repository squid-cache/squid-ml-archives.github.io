<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] shared_memory_locking failed to mlock
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20shared_memory_locking%20failed%20to%20mlock&In-Reply-To=%3CCAK0iFYxqi3Q1yZqSFbG0RG3dbwwVsuxAEKNZ0jEHnh4Yy3DGwg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018702.html">
   <LINK REL="Next"  HREF="018704.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] shared_memory_locking failed to mlock</H1>
    <B>Gordon Hsiao</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20shared_memory_locking%20failed%20to%20mlock&In-Reply-To=%3CCAK0iFYxqi3Q1yZqSFbG0RG3dbwwVsuxAEKNZ0jEHnh4Yy3DGwg%40mail.gmail.com%3E"
       TITLE="[squid-users] shared_memory_locking failed to mlock">capcoding at gmail.com
       </A><BR>
    <I>Mon Jul 16 23:08:18 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018702.html">[squid-users] shared_memory_locking failed to mlock
</A></li>
        <LI>Next message (by thread): <A HREF="018704.html">[squid-users] shared_memory_locking failed to mlock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18703">[ date ]</a>
              <a href="thread.html#18703">[ thread ]</a>
              <a href="subject.html#18703">[ subject ]</a>
              <a href="author.html#18703">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On a x86/64bit ubuntu machine if I set 'workers 4' and run:

squid --foreground -f /etc/squid.conf 2&gt;&amp;1 |grep mlock
  mlock(0x7f2e5bfb2000, 8)                = 0
  mlock(0x7f2e5bf9f000, 73912)            = -1 ENOMEM (Cannot allocate
memory)
squid -N -f /etc/squid.conf 2&gt;&amp; |grep mlock
  mlock(0x7f8e4b7c0000, 8)                = 0
  mlock(0x7f8e4b7ad000, 73912)            = -1 ENOMEM (Cannot allocate
memory)

Note 1; -N and --foreground made no difference as long as 'workers 4' is
set, I was expecting -N will ignore &quot;worker 4&quot;, does it?

Now I set 'workers 2' and run the same two commands above and I got the
output(both are the same), which means squid started successfully:
  mlock(0x7f0c441cc000, 8)                = 0
  mlock(0x7f0c441c3000, 32852)            = 0
  mlock(0x7f0c441c2000, 52)               = 0

Note as long as &quot;workers &lt;=2&quot; I can run squid as expected and mlock the
memory. I have more than 4GB RAM free(this is a 8GB RAM laptop) and this is
a Intel i7, the mlock failure is strange.

On my target system which has 512MB RAM, even 'workers 0' won't help, I
still get :

  mlock(0x778de000, 2101212)              = -1 ENOMEM (Out of memory)

I have to disable lock-memory for now and it puzzles me why the very first
2MB mlock can fail. I strace|grep shm_get and shmat and found nothing,
instead there are lots of mmap calls, so Squid is using mmap for its shared
memory mapping, the only question is that, is this mlock file-backed-up or
is it anonymous mmaped(in this case on Linux it will use /dev/shm by
default)?

Thanks a lot,

Gordon

On Mon, Jul 16, 2018 at 11:58 AM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 07/15/2018 08:47 PM, Gordon Hsiao wrote:
</I>&gt;<i> &gt; Just upgraded squid to 4.1, however if I enabled shared_memory_locking I
</I>&gt;<i> &gt; failed to start squid:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &quot;FATAL: shared_memory_locking on but failed to
</I>&gt;<i> &gt; mlock(/squid-tls_session_cache.shm, 2101212): (12) Out of memory&quot;
</I>&gt;<i>
</I>&gt;<i> &gt; How do I know how much memory it is trying to mlock? is 2101212(~2MB)
</I>&gt;<i> &gt; the shm size of not,
</I>&gt;<i>
</I>&gt;<i> Yes, Squid tried to lock a 2101212-byte segment and failed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; any way to debug/looking-into/config this size?
</I>&gt;<i>
</I>&gt;<i> I am not sure what you mean, but please keep in mind that the failed
</I>&gt;<i> segment could be the last straw -- most of the shared memory could be
</I>&gt;<i> allocated earlier. You can observe all allocations/locks with 54,7
</I>&gt;<i> debugging. Look for &quot;mlock(&quot;.
</I>&gt;<i>
</I>&gt;<i> You can also run &quot;strace&quot; or a similar command line tool to track
</I>&gt;<i> allocations, but analyzing strace output may be more difficult than
</I>&gt;<i> looking through Squid logs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Again I disabled cache etc for a memory restricted environment, also
</I>&gt;<i> &gt; used the minimal configuration with a few enable-flags, in the meantime
</I>&gt;<i> &gt; I want to avoid memory overcommit from squid(thus mlock)
</I>&gt;<i>
</I>&gt;<i> I am glad the new code is working to prevent runtime crashes in your
</I>&gt;<i> memory-restricted environment. If studying previous mlock() calls does
</I>&gt;<i> not help, please suggest what else Squid could do not help you.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180716/7ac570c8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180716/7ac570c8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018702.html">[squid-users] shared_memory_locking failed to mlock
</A></li>
	<LI>Next message (by thread): <A HREF="018704.html">[squid-users] shared_memory_locking failed to mlock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18703">[ date ]</a>
              <a href="thread.html#18703">[ thread ]</a>
              <a href="subject.html#18703">[ subject ]</a>
              <a href="author.html#18703">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
