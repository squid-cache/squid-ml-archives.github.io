<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20ran%20out%20of%20descriptors%20due%20to%20ICAP%0A%20service/TCP%20SYNs%20%3F&In-Reply-To=%3C2243eaa3-2d71-3696-2b6b-d82d238bf309%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018706.html">
   <LINK REL="Next"  HREF="018717.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20ran%20out%20of%20descriptors%20due%20to%20ICAP%0A%20service/TCP%20SYNs%20%3F&In-Reply-To=%3C2243eaa3-2d71-3696-2b6b-d82d238bf309%40treenet.co.nz%3E"
       TITLE="[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 17 12:51:56 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018706.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP	SYNs ?
</A></li>
        <LI>Next message (by thread): <A HREF="018717.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18708">[ date ]</a>
              <a href="thread.html#18708">[ thread ]</a>
              <a href="subject.html#18708">[ subject ]</a>
              <a href="author.html#18708">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/07/18 19:17, Ahmad, Sarfaraz wrote:
&gt;<i> Can somebody please explain what could have happened here?
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> First squid(4.0.25) encountered a URL &gt; 8K bytes. I think this caused it
</I>&gt;<i> to crash.
</I>&gt;<i> 
</I>
Unless you patched the MAX_URL definition to be larger than default,
that should not happen. So is a bug IMO.

If you did patch MAX_URL, then you have encountered one of the many
hidden issues why we keep it low and
&lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4422">https://bugs.squid-cache.org/show_bug.cgi?id=4422</A>&gt; open. Any assistance
finding out where that crash occurs is VERY welcome.


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:04:13 &lt;hostname&gt; squid[9102]: parse URL too large (9697 bytes)
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:04:13 &lt;hostname&gt; squid[29254]: Squid Parent: squid-1 process
</I>&gt;<i> 9102 exited due to signal 11 with status 0
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> squid-1 was respawned by the parent squid process.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Then I see ,
</I>&gt;<i> 
</I>&gt;<i> WARNING: ICAP Max-Connections limit exceeded for service
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/reqmod.">icap://127.0.0.1:1344/reqmod.</A> Open connections now: 16, including 0 idle
</I>&gt;<i> persistent connections.
</I>&gt;<i> 
</I>&gt;<i> The newly spawned squid-1 &#160;crashes yet again. As seen below,
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:16:14 &lt;hostname&gt; squid[29254]: Squid Parent: squid-1 process
</I>&gt;<i> 10951 exited due to signal 11 with status 0
</I>&gt;<i> 
</I>&gt;<i> Logs don&#8217;t explain why squid-1 crashed here. ICAP message above is just
</I>&gt;<i> a warning.
</I>
In normal operation it is not serious, but you are already into abnormal
operation by the crashing. So not releasing sockets/FD fast enough makes
the overall problem worse.

&gt;<i>From the below log and config that this ICAP service is *optional*
</I>(bypass=on). So Squid is free to ignore its use entirely if FD run out.
That is probably why it is only listed as WARNING. But is still
consuming FDs before it gets to that state.


&gt;<i> 
</I>&gt;<i> squid-1 is respawned a second time and I see,
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:22:18 &lt;hostname&gt; squid[13123]: ERROR: negotiating TLS on FD
</I>&gt;<i> 1722: error:14090086:SSL
</I>&gt;<i> routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)
</I>&gt;<i> 
</I>
Look into why. This along with your crash are the top two issues adding
to the overall situation.
&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> There is only one icap service defined as below :
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> 
</I>&gt;<i> icap_service test_icap reqmod_precache <A HREF="icap://127.0.0.1:1344/reqmod">icap://127.0.0.1:1344/reqmod</A>
</I>&gt;<i> bypass=on routing=off on-overload=wait
</I>&gt;<i> 
</I>

&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> The open file ulimit is set to 16k. How many TCP connections would Squid
</I>&gt;<i> have opened up that it exhausted 16k file descriptors ? &#160;Some sort of
</I>&gt;<i> file descriptor leak ?
</I>
Only if your traffic is high enough to leak that fast.

More likely is a forwarding loop situation. Where one outbound server
connection consumes _infinite_ FD sockets.


&gt;<i> 
</I>&gt;<i> I am unable to connect the dots where an unresponsive ICAP service lead
</I>&gt;<i> to the proxy running out of file descriptors ? &#160;Too many TCP SYN attempts ?
</I>&gt;<i> 
</I>
That two are probably unrelated. Unless it is the ICAP socket being
looped back to Squid, or your traffic req/sec is extremely high and one
of a few ICAP connection bugs occuring (eg lack of a way to cleanly
signal connection error to ICAP).


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018706.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP	SYNs ?
</A></li>
	<LI>Next message (by thread): <A HREF="018717.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18708">[ date ]</a>
              <a href="thread.html#18708">[ thread ]</a>
              <a href="subject.html#18708">[ subject ]</a>
              <a href="author.html#18708">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
