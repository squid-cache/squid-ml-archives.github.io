<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20ran%20out%20of%20descriptors%20due%20to%20ICAP%0A%20service/TCP%20SYNs%20%3F&In-Reply-To=%3C32fb6ea566ba460db61a184cdd89888f%40mbxtoa3.winmail.deshaw.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018708.html">
   <LINK REL="Next"  HREF="018726.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?</H1>
    <B>Ahmad, Sarfaraz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20ran%20out%20of%20descriptors%20due%20to%20ICAP%0A%20service/TCP%20SYNs%20%3F&In-Reply-To=%3C32fb6ea566ba460db61a184cdd89888f%40mbxtoa3.winmail.deshaw.com%3E"
       TITLE="[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?">Sarfaraz.Ahmad at deshaw.com
       </A><BR>
    <I>Wed Jul 18 06:30:46 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018708.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
        <LI>Next message (by thread): <A HREF="018726.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18717">[ date ]</a>
              <a href="thread.html#18717">[ thread ]</a>
              <a href="subject.html#18717">[ subject ]</a>
              <a href="author.html#18717">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the reply. I haven't completely understood the revert and have a few more related questions.

I see these messages, 
Jul 17 19:21:14 proxy2.hyd.deshaw.com squid[5747]: suspending ICAP service for too many failures
Jul 17 19:21:14 proxy2.hyd.deshaw.com squid[5747]: optional ICAP service is suspended: <A HREF="icap://127.0.0.1:1344/reqmod">icap://127.0.0.1:1344/reqmod</A> [down,susp,fail11]
1)   If the ICAP service is unresponsive, Squid would not exhaust its file descriptors trying to reach the service again and again right (too many TCP SYNs for trying to connect to the ICAP service )? 



Max Connections returned by the ICAP service is 16. And given my ICAP settings, 
icap_enable on
icap_service test_icap reqmod_precache <A HREF="icap://127.0.0.1:1344/reqmod">icap://127.0.0.1:1344/reqmod</A> bypass=on routing=off on-overload=wait
On-overload is set to &quot;wait&quot;. The documentation says &quot; * wait:   wait (in a FIFO queue) for an ICAP connection slot&quot; . This means that a new TCP connection would not be attempted if max connections is reached right ? 
2)   Am I right in saying that if the ICAP service is underperforming or has failed, this won't lead a sudden increase in the open file descriptors with on-overload set to &quot;wait&quot; ?


Also I have no way to explain the &quot;connection reset by peer&quot; messages.
Jul 13 11:23:18 &lt;hostname&gt; squid[13123]: Error negotiating SSL connection on FD 1292: (104) Connection reset by peer
Jul 13 11:23:18 &lt;hostname&gt; squid[13123]: Error negotiating SSL connection on FD 1631: (104) Connection reset by peer
Jul 13 11:35:17 &lt;hostname&gt; squid[13123]: Error negotiating SSL connection on FD 1331: (104) Connection reset by peer

I have a few proxies (running in separate virtual machines). All of them went unresponsive at around the same time, leading to an outage of the internet.
I am using WCCPv2 to redirect from firewall to these proxies.  I checked the logs there and WCCP communication was not intermittent.
The logs on the proxies are bombarded with &quot; Error negotiating SSL connection on FD 1331: (104) Connection reset by peer &quot; messages. 
Since the ICAP service in not SSL-protected I think these messages mostly imply receiving TCP RSTs from remote servers. (or could it be clients somehow ?). Once I removed WCCP direction rules from the firewall, internet was back up.
This hints that something in this proxy pipeline was amiss and not with the internet link itself. I don't see any outages on that. 
I am pretty sure ACLs weren't changed and there was no forwarding loop.
What could possibly explain the connection reset by peer messages ? Even if the internet was down, that won't lead to TCP RSTs. 
I cannot tie these TCP RSTs and the incoming requests getting held up and ultimately leading to FD exhaustion.

You earlier said 
&gt;&gt;<i> In normal operation it is not serious, but you are already into abnormal operation by the crashing. So not releasing sockets/FD fast enough makes the overall problem worse.
</I>If squid-1 is crashing and getting respawned, it will have its own 16K FD limit right, I wonder how the newer squid-1 serves older requests. Can you please elaborate on &quot; So not releasing sockets/FD fast enough makes the overall problem worse.&quot; ?

Please share your thoughts.

Regards,
Sarfaraz


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Tuesday, July 17, 2018 6:22 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?

On 17/07/18 19:17, Ahmad, Sarfaraz wrote:
&gt;<i> Can somebody please explain what could have happened here?
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> First squid(4.0.25) encountered a URL &gt; 8K bytes. I think this caused 
</I>&gt;<i> it to crash.
</I>&gt;<i> 
</I>
Unless you patched the MAX_URL definition to be larger than default, that should not happen. So is a bug IMO.

If you did patch MAX_URL, then you have encountered one of the many hidden issues why we keep it low and &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4422">https://bugs.squid-cache.org/show_bug.cgi?id=4422</A>&gt; open. Any assistance finding out where that crash occurs is VERY welcome.


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:04:13 &lt;hostname&gt; squid[9102]: parse URL too large (9697 
</I>&gt;<i> bytes)
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:04:13 &lt;hostname&gt; squid[29254]: Squid Parent: squid-1 process
</I>&gt;<i> 9102 exited due to signal 11 with status 0
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> squid-1 was respawned by the parent squid process.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Then I see ,
</I>&gt;<i> 
</I>&gt;<i> WARNING: ICAP Max-Connections limit exceeded for service 
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/reqmod.">icap://127.0.0.1:1344/reqmod.</A> Open connections now: 16, including 0 
</I>&gt;<i> idle persistent connections.
</I>&gt;<i> 
</I>&gt;<i> The newly spawned squid-1 &#160;crashes yet again. As seen below,
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:16:14 &lt;hostname&gt; squid[29254]: Squid Parent: squid-1 process
</I>&gt;<i> 10951 exited due to signal 11 with status 0
</I>&gt;<i> 
</I>&gt;<i> Logs don&#8217;t explain why squid-1 crashed here. ICAP message above is 
</I>&gt;<i> just a warning.
</I>
In normal operation it is not serious, but you are already into abnormal operation by the crashing. So not releasing sockets/FD fast enough makes the overall problem worse.

From the below log and config that this ICAP service is *optional* (bypass=on). So Squid is free to ignore its use entirely if FD run out.
That is probably why it is only listed as WARNING. But is still consuming FDs before it gets to that state.


&gt;<i> 
</I>&gt;<i> squid-1 is respawned a second time and I see,
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Jul 13 11:22:18 &lt;hostname&gt; squid[13123]: ERROR: negotiating TLS on FD
</I>&gt;<i> 1722: error:14090086:SSL
</I>&gt;<i> routines:ssl3_get_server_certificate:certificate verify failed 
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>
Look into why. This along with your crash are the top two issues adding to the overall situation.
&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> There is only one icap service defined as below :
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> icap_enable on
</I>&gt;<i> 
</I>&gt;<i> icap_service test_icap reqmod_precache <A HREF="icap://127.0.0.1:1344/reqmod">icap://127.0.0.1:1344/reqmod</A> 
</I>&gt;<i> bypass=on routing=off on-overload=wait
</I>&gt;<i> 
</I>

&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> The open file ulimit is set to 16k. How many TCP connections would 
</I>&gt;<i> Squid have opened up that it exhausted 16k file descriptors ? &#160;Some 
</I>&gt;<i> sort of file descriptor leak ?
</I>
Only if your traffic is high enough to leak that fast.

More likely is a forwarding loop situation. Where one outbound server connection consumes _infinite_ FD sockets.


&gt;<i> 
</I>&gt;<i> I am unable to connect the dots where an unresponsive ICAP service 
</I>&gt;<i> lead to the proxy running out of file descriptors ? &#160;Too many TCP SYN attempts ?
</I>&gt;<i> 
</I>
That two are probably unrelated. Unless it is the ICAP socket being looped back to Squid, or your traffic req/sec is extremely high and one of a few ICAP connection bugs occuring (eg lack of a way to cleanly signal connection error to ICAP).


Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018708.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
	<LI>Next message (by thread): <A HREF="018726.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18717">[ date ]</a>
              <a href="thread.html#18717">[ thread ]</a>
              <a href="subject.html#18717">[ subject ]</a>
              <a href="author.html#18717">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
