<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20ran%20out%20of%20descriptors%20due%20to%20ICAP%0A%20service/TCP%20SYNs%20%3F&In-Reply-To=%3C2dc27d5a8752412c84e1204f206bcb00%40mbxtoa3.winmail.deshaw.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018726.html">
   <LINK REL="Next"  HREF="018713.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?</H1>
    <B>Ahmad, Sarfaraz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20ran%20out%20of%20descriptors%20due%20to%20ICAP%0A%20service/TCP%20SYNs%20%3F&In-Reply-To=%3C2dc27d5a8752412c84e1204f206bcb00%40mbxtoa3.winmail.deshaw.com%3E"
       TITLE="[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?">Sarfaraz.Ahmad at deshaw.com
       </A><BR>
    <I>Fri Jul 20 06:45:22 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018726.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
        <LI>Next message (by thread): <A HREF="018713.html">[squid-users] new ecap gzip + deflat adapter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18751">[ date ]</a>
              <a href="thread.html#18751">[ thread ]</a>
              <a href="subject.html#18751">[ subject ]</a>
              <a href="author.html#18751">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the explanation.
From your first email : 
&gt;&gt;<i> &quot;In normal operation it is not serious, but you are already into abnormal operation by the crashing. So not releasing sockets/FD fast enough makes the overall problem worse.&quot;
</I>I see that all the relevant FDs are opened by squid-1 process.  If squid-1 crashes, won't the OS clean up its file descriptors. Why would the parent Squid process be bothered with these FDs? 
I don't see how frequent crashing slows down releasing sockets/FDs.  Can you please explain how this works ? Also I am not using SMP workers.

Regards,
Sarfaraz

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Wednesday, July 18, 2018 9:23 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?

On 18/07/18 18:30, Ahmad, Sarfaraz wrote:
&gt;<i> Thanks for the reply. I haven't completely understood the revert and have a few more related questions.
</I>&gt;<i> 
</I>&gt;<i> I see these messages,
</I>&gt;<i> Jul 17 19:21:14 proxy2.hyd.deshaw.com squid[5747]: suspending ICAP 
</I>&gt;<i> service for too many failures Jul 17 19:21:14 proxy2.hyd.deshaw.com squid[5747]: optional ICAP service is suspended: <A HREF="icap://127.0.0.1:1344/reqmod">icap://127.0.0.1:1344/reqmod</A> [down,susp,fail11]
</I>&gt;<i> 1)   If the ICAP service is unresponsive, Squid would not exhaust its file descriptors trying to reach the service again and again right (too many TCP SYNs for trying to connect to the ICAP service )? 
</I>&gt;<i> 
</I>
Correct. It would not exhaust resources on *that* action. Other actions possibly resulting from that state existing are another matter entirely.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Max Connections returned by the ICAP service is 16. And given my ICAP 
</I>&gt;<i> settings, icap_enable on icap_service test_icap reqmod_precache 
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/reqmod">icap://127.0.0.1:1344/reqmod</A> bypass=on routing=off on-overload=wait
</I>&gt;<i> On-overload is set to &quot;wait&quot;. The documentation says &quot; * wait:   wait (in a FIFO queue) for an ICAP connection slot&quot; . This means that a new TCP connection would not be attempted if max connections is reached right ? 
</I>&gt;<i> 2)   Am I right in saying that if the ICAP service is underperforming or has failed, this won't lead a sudden increase in the open file descriptors with on-overload set to &quot;wait&quot; ?
</I>&gt;<i> 
</I>
No. The side effects of the ICAP service not being used determine the possible outcomes there.


&gt;<i> 
</I>&gt;<i> Also I have no way to explain the &quot;connection reset by peer&quot; messages.
</I>
Neither, given the details provided.


&gt;<i> Jul 13 11:23:18 &lt;hostname&gt; squid[13123]: Error negotiating SSL 
</I>&gt;<i> connection on FD 1292: (104) Connection reset by peer Jul 13 11:23:18 
</I>&gt;<i> &lt;hostname&gt; squid[13123]: Error negotiating SSL connection on FD 1631: 
</I>&gt;<i> (104) Connection reset by peer Jul 13 11:35:17 &lt;hostname&gt; 
</I>&gt;<i> squid[13123]: Error negotiating SSL connection on FD 1331: (104) 
</I>&gt;<i> Connection reset by peer
</I>&gt;<i> 
</I>&gt;<i> I have a few proxies (running in separate virtual machines). All of them went unresponsive at around the same time, leading to an outage of the internet.
</I>&gt;<i> I am using WCCPv2 to redirect from firewall to these proxies.  I checked the logs there and WCCP communication was not intermittent.
</I>&gt;<i> The logs on the proxies are bombarded with &quot; Error negotiating SSL connection on FD 1331: (104) Connection reset by peer &quot; messages.
</I>
A strong sign that forwarding loops are occuring, or something cut a huge number of TCP connections at once.

Although syslog recording is limited by the network traffic. So situations of high network flooding its timestamps can be very inaccurate or unordered.


&gt;<i> Since the ICAP service in not SSL-protected I think these messages mostly imply receiving TCP RSTs from remote servers. (or could it be clients somehow ?).
</I>
Yes, another reason I am thinking along the lines of forwarding loops.

&gt;<i> Once I removed WCCP direction rules from the firewall, internet was
</I>back up.
&gt;<i> This hints that something in this proxy pipeline was amiss and not with the internet link itself. I don't see any outages on that.
</I>
Nod. Keep in mind though that &quot;proxy pipeline&quot; includes the WCCP rules in the router, NAT rules on the proxy machine, proxy config, connection to/from the ICAP server, and NAT rules on the proxy machine outgoing, and WCCP rules on the router a second time.

So a lot of parts, most outside of Squid - any one of which can screw up the entire pathway.


&gt;<i> I am pretty sure ACLs weren't changed and there was no forwarding loop.
</I>&gt;<i> What could possibly explain the connection reset by peer messages ? Even if the internet was down, that won't lead to TCP RSTs. 
</I>&gt;<i> I cannot tie these TCP RSTs and the incoming requests getting held up and ultimately leading to FD exhaustion.
</I>
Too many possibilities to list here, and we do not have sufficient information. You need to track down exactly which software is generating them, and why.


&gt;<i> 
</I>&gt;<i> You earlier said
</I>&gt;&gt;&gt;<i> In normal operation it is not serious, but you are already into abnormal operation by the crashing. So not releasing sockets/FD fast enough makes the overall problem worse.
</I>&gt;<i> If squid-1 is crashing and getting respawned, it will have its own 16K FD limit right, I wonder how the newer squid-1 serves older requests. Can you please elaborate on &quot; So not releasing sockets/FD fast enough makes the overall problem worse.&quot; ?
</I>&gt;<i> 
</I>
Depending on your OS there are per-process and process group limits. The latter may be applicable if you are using SMP workers.


Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018726.html">[squid-users] Cache ran out of descriptors due to ICAP service/TCP SYNs ?
</A></li>
	<LI>Next message (by thread): <A HREF="018713.html">[squid-users] new ecap gzip + deflat adapter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18751">[ date ]</a>
              <a href="thread.html#18751">[ thread ]</a>
              <a href="subject.html#18751">[ subject ]</a>
              <a href="author.html#18751">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
