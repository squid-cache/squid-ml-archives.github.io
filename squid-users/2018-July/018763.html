<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Strange error to load http web pages in parents servers.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20error%20to%20load%20http%20web%20pages%20in%20parents%0A%20servers.&In-Reply-To=%3C91f32ea4-5f22-5cb6-9721-17b7785e2b0a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018759.html">
   <LINK REL="Next"  HREF="018770.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Strange error to load http web pages in parents servers.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20error%20to%20load%20http%20web%20pages%20in%20parents%0A%20servers.&In-Reply-To=%3C91f32ea4-5f22-5cb6-9721-17b7785e2b0a%40treenet.co.nz%3E"
       TITLE="[squid-users] Strange error to load http web pages in parents servers.">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 24 10:42:40 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018759.html">[squid-users] Strange error to load http web pages in parents	servers.
</A></li>
        <LI>Next message (by thread): <A HREF="018770.html">[squid-users] A logging only ACL?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18763">[ date ]</a>
              <a href="thread.html#18763">[ thread ]</a>
              <a href="subject.html#18763">[ subject ]</a>
              <a href="author.html#18763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/07/18 06:16, Darvin Rivera Aguilar wrote:
&gt;<i> 
</I>&gt;<i> In all Machines
</I>&gt;<i> 
</I>&gt;<i> OS: Debian
</I>&gt;<i> Version: 9.5
</I>&gt;<i> Squid Cache: Version 3.5.23
</I>&gt;<i> 
</I>&gt;<i> I have one private ip address for public squid (10.20.0.183) and two
</I>&gt;<i> parents squid: one for facebook and other for *.ch domain
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160; ----&gt; Parent1 (10.20.0.41) (Only
</I>&gt;<i> Facebook)
</I>&gt;<i> &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;|
</I>&gt;<i> Client -&gt; Public Squid (10.20.0.183) -----&gt; All other traffic
</I>&gt;<i> &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;|
</I>&gt;<i> &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160; &#160; ----&gt; Parent2 (10.20.0.42) (Only
</I>&gt;<i> *.ch domain)
</I>&gt;<i> 
</I>&gt;<i> Parent1 and parent2 configuration are the same.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Problem:
</I>&gt;<i> 
</I>&gt;<i> Browser Url: <A HREF="http://films.server.ch/Ingles/Baby">http://films.server.ch/Ingles/Baby</A> Daddy/
</I>&gt;<i> 
</I>&gt;<i> Client Error:
</I>&gt;<i> 
</I>&gt;<i> ERROR
</I>&gt;<i> The requested URL could not be retrieved
</I>&gt;<i> 
</I>&gt;<i> The following error was encountered while trying to retrieve the URL:
</I>&gt;<i> /Ingles/Baby%20Daddy/
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160; Invalid URL
</I>&gt;<i> 
</I>&gt;<i> Some aspect of the requested URL is incorrect.
</I>&gt;<i> 
</I>&gt;<i> Some possible problems are:
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160; Missing or incorrect access protocol (should be &quot;<A HREF="http://">http://</A>&quot; or similar)
</I>&gt;<i> 
</I>
That.

&gt;<i> &#160;&#160;&#160; Missing hostname
</I>&gt;<i> 
</I>
... and that.


This is an origin-form URL for use only on port 80 or 443 message types.
Not for use between proxies. So where is it coming from?

eg. Is there something like NAT at the network level diverting outbound
port 80 traffic into this Parent2 proxy?

eg. Is the public proxy receiving an HTTP message with a domain that is
not in *.ch and which resolves to the IP address of the parent2 proxy?


You can see what each of the proxies is sending and receiving by setting
&quot;debug_options 11,2&quot; in squid.conf and reloading/reconfiguring Squid.



&gt;<i> &#160;&#160;&#160; Illegal double-escape in the URL-Path
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160; Illegal character in hostname; underscores are not allowed.
</I>&gt;<i> 
</I>&gt;<i> Your cache administrator is webmaster.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Log Public Squid (10.20.0.183)
</I>&gt;<i> 1531925462.144&#160;&#160;&#160; 525 10.20.1.12 TCP_MISS/400 3875 GET
</I>&gt;<i> <A HREF="http://films.server.ch/Ingles/Baby%20Daddy/">http://films.server.ch/Ingles/Baby%20Daddy/</A> username
</I>&gt;<i> FIRSTUP_PARENT/10.20.0.42 text/html
</I>&gt;<i> 
</I>&gt;<i> Log Squid Parrent2 (10.520.0.42)
</I>&gt;<i> 1531928082.425&#160;&#160;&#160;&#160;&#160; 0 10.20.0.183 TAG_NONE/400 3586 GET
</I>&gt;<i> /Ingles/Baby%20Daddy/ - HIER_NONE/- text/html
</I>
Notice that these requests are 2620 seconds (43 minutes) apart. So they
are almost certainly not the same transaction, even though they resulted
in the same status code - it _may_ have been for different reasons.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Nota: I user parent1 for facebook and never give this error. Facebook
</I>&gt;<i> use https and the error is only in parent2 with http.
</I>&gt;<i> 
</I>&gt;<i> How the client solve this error:
</I>&gt;<i> When i push F5 in browser the the page reload with out problem,
</I>&gt;<i> sometimes i need to push 5 or 8 times F5 to page reload.
</I>&gt;<i> 
</I>&gt;<i> Parent2 Full config:
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> visible_hostname parent2.localhost
</I>&gt;<i> dns_nameservers 10.20.0.61
</I>&gt;<i> acl proxy src 0.20.0.183/32
</I>
Is that &quot;0.&quot; just a typo in your mail here? If its in the config that
could be the cause.

Otherwise I'm not seeing anything that could lead to your problem in
these two config files. The notes below are just some polishing things
you could maybe do better.


&gt;<i> http_access allow proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> cache_access_log /var/log/squid/access.log
</I>
This directive name is access_log in 3.x, no &quot;cache_&quot; part.

And it should have either &quot;stdio:&quot; or &quot;daemon:&quot; as prefix on the
filename depending on whether you expect low or high traffic volumes
(daemon is higher performance than stdio).


&gt;<i> 
</I>&gt;<i> Public Squid Basic config
</I>&gt;<i> 
</I>&gt;<i> http_port 10.20.0.183:3128
</I>&gt;<i> http_port 127.0.0.1:3128
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> 
</I>&gt;<i> #====================================================================================
</I>&gt;<i> 
</I>&gt;<i> # TAG: Recommended minimum configuration
</I>&gt;<i> #====================================================================================
</I>&gt;<i> 
</I>&gt;<i> acl port_80 port 80
</I>&gt;<i> acl port_443 port 443
</I>&gt;<i> 
</I>&gt;<i> acl Safe_method method CONNECT GET HEAD POST
</I>&gt;<i> acl CONNECT&#160;&#160;&#160;&#160; method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny !Safe_method
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> #====================================================================================
</I>&gt;<i> 
</I>&gt;<i> # TAG: PARENT
</I>&gt;<i> #====================================================================================
</I>&gt;<i> 
</I>&gt;<i> acl redir_facebook&#160;&#160;&#160;&#160;&#160; dstdom_regex&#160;&#160;&#160; -i
</I>&gt;<i> &quot;/etc/squid/acl/cache_peer_facebook&quot;
</I>&gt;<i> acl db_domain&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdom_regex&#160;&#160;&#160; -i
</I>&gt;<i> &quot;/etc/squid/acl/cache_peer_domain&quot;
</I>
You said this peer only services .ch domains.
That implies you can use something like:
  acl db_domain dstdomain .ch


&gt;<i> 
</I>&gt;<i> cache_peer 10.20.0.41 parent 3128 0 default
</I>&gt;<i> cache_peer 10.20.0.42 parent 3128 0 default
</I>&gt;<i> 
</I>
&quot;
==== PEER SELECTION METHODS ====

default

  This is a parent cache which can be used as a &quot;last-resort&quot;
  if a peer cannot be located by any of the peer-selection methods.

 *** If specified more than once, only the first is used. ***
&quot;

Given what you described the purpose of these parents to be I don't
think either of them should have &quot;default&quot; option set.


&gt;<i> cache_peer_access 10.20.0.41 allow redir_facebook
</I>&gt;<i> cache_peer_access 10.20.0.42 allow db_domain
</I>&gt;<i> 
</I>&gt;<i> never_direct allow redir_facebook
</I>&gt;<i> never_direct allow db_domain
</I>&gt;<i> 
</I>


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018759.html">[squid-users] Strange error to load http web pages in parents	servers.
</A></li>
	<LI>Next message (by thread): <A HREF="018770.html">[squid-users] A logging only ACL?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18763">[ date ]</a>
              <a href="thread.html#18763">[ thread ]</a>
              <a href="subject.html#18763">[ subject ]</a>
              <a href="author.html#18763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
