<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] server persistent connections and cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20server%20persistent%20connections%20and%20cache&In-Reply-To=%3CCABfsTT6m-%3D4mSnbez8kepDQTimtaO2p_0N9PnV6CLHYombK%2BZw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018738.html">
   <LINK REL="Next"  HREF="018778.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] server persistent connections and cache</H1>
    <B>Vishali Somaskanthan</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20server%20persistent%20connections%20and%20cache&In-Reply-To=%3CCABfsTT6m-%3D4mSnbez8kepDQTimtaO2p_0N9PnV6CLHYombK%2BZw%40mail.gmail.com%3E"
       TITLE="[squid-users] server persistent connections and cache">vishali.somaskanthan at viptela.com
       </A><BR>
    <I>Thu Jul 26 20:49:38 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018738.html">[squid-users] server persistent connections and cache
</A></li>
        <LI>Next message (by thread): <A HREF="018778.html">[squid-users] server persistent connections and cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18777">[ date ]</a>
              <a href="thread.html#18777">[ thread ]</a>
              <a href="subject.html#18777">[ subject ]</a>
              <a href="author.html#18777">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Resuming the above conversation; When looking at the cache log and the
code, I find that when peek is done at step 1 and then bumped, the
connection gets pinned after *httpsPeeked() *is called.

Log:

*2018/07/23 11:40:29.572 kid1| 17,4| AsyncCallQueue.cc(55) fireNext:
entering ConnStateData::ConnStateData::httpsPeeked(local=4.16.205.42:33596
&lt;<A HREF="http://4.16.205.42:33596">http://4.16.205.42:33596</A>&gt; remote=96.43.144.26:443
&lt;<A HREF="http://96.43.144.26:443">http://96.43.144.26:443</A>&gt;        FD 15 flags=1, request=0x559f3b1a6ed0*5)*
* 40056 2018/07/23 11:40:29.572 kid1| 17,4| AsyncCall.cc(38) make: make
call ConnStateData::ConnStateData::httpsPeeked [call261]*
* 40057 2018/07/23 11:40:29.572 kid1| 45,9| cbdata.cc(419)
cbdataReferenceValid: 0x559f3b64b4a8*
* 40058 2018/07/23 11:40:29.572 kid1| 45,9| cbdata.cc(419)
cbdataReferenceValid: 0x559f3b64b4a8*
* 40059 2018/07/23 11:40:29.572 kid1| 45,9| cbdata.cc(419)
cbdataReferenceValid: 0x559f3b64b4a8*
* 40060 2018/07/23 11:40:29.572 kid1| 45,9| cbdata.cc(419)
cbdataReferenceValid: 0x559f3b64b4a8*
* 40061 2018/07/23 11:40:29.572 kid1| 17,4| AsyncJob.cc(123) callStart:
Http1::Server status in: [ job10]*
* 40062 2018/07/23 11:40:29.572 kid1| 45,9| cbdata.cc(419)
cbdataReferenceValid: 0x559f3b64b4a8*
* 40063 2018/07/23 11:40:29.572 kid1| 33,3| Pipeline.cc(35) front: Pipeline
0x559f3b64b4f0 front 0x559f3b1a9190*2*
* 40064 2018/07/23 11:40:29.572 kid1| 33,3| Pipeline.cc(35) front: Pipeline
0x559f3b64b4f0 front 0x559f3b1a9190*3*
* 40065 2018/07/23 11:40:29.572 kid1| 33,3| client_side.cc(4089)
unpinConnection:*
* 40066 2018/07/23 11:40:29.572 kid1| 33,3| client_side.cc(3927)
pinConnection: local=4.16.205.42:33596 &lt;<A HREF="http://4.16.205.42:33596">http://4.16.205.42:33596</A>&gt;
remote=96.43.144.26:443 &lt;<A HREF="http://96.43.144.26:443">http://96.43.144.26:443</A>&gt; FD 15 flags=1*

I assume that a pinned connection means a server connection which MUST have
a 1:1 relationship with some client connection. Accordingly, if the client
terminates, then the server connection should also be closing. From the
post:
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2015-June/004298.html">http://lists.squid-cache.org/pipermail/squid-users/2015-June/004298.html</A>

1. Are there any security reasons behind *pinning the connection* when a
peek is done at Step1 such that server connection get closed if
corresponding client closes. Why is that done?

2.a)  I see a stmt &quot;reusing a pinned conn&quot; in the function
selectPeerForIntercepted().
&gt;<i>From the logs, I dont find this function getting called. Under what
</I>scenario will this get called? In other words, what is the scenario where a
pinned connection can be reused?

   b) Which configure option is used to enable *#if STRICT_ORIGINAL_DST ?*


*#if STRICT_ORIGINAL_DST*
*if (isIntercepted &amp;&amp; useOriginalDst) {*
*        selectPeerForIntercepted();*
*        // 3.2 does not suppro re-wrapping inside CONNECT.*
*        // our only alternative is to fake destination &quot;found&quot; and
continue with the forwarding.*
*        startConnectionOrFail();*
*        return;*
*    }*
*#endif*


On Wed, Jul 18, 2018 at 5:00 PM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 07/18/2018 03:03 PM, Vishali Somaskanthan wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I had a problem after sending too many requests to the same server where
</I>&gt;<i> &gt; my persistence stopped working suddenly.
</I>&gt;<i>
</I>&gt;<i> Please note that there are many reasons why a proxy may close a
</I>&gt;<i> connection. For pinned to-server connections (like those created by
</I>&gt;<i> SslBump), it may not be possible to open a new to-server connection so
</I>&gt;<i> Squid should close both from-client and to-server connections.
</I>&gt;<i>
</I>&gt;<i> In general, a client should not rely on a connections staying persistent
</I>&gt;<i> except in some very unusual/special circumstances.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 1. What is the relationship between the caching and the persistence
</I>&gt;<i> &gt; connection established?
</I>&gt;<i>
</I>&gt;<i> Virtually none. Caching decisions are done primarily based on request
</I>&gt;<i> and response headers.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2. When will squid use cached results and when will it not if the cache
</I>&gt;<i> &gt; deny all directive weren't specified.
</I>&gt;<i>
</I>&gt;<i> Squid will deliver a response from the cache when HTTP rules and Squid
</I>&gt;<i> configuration allow a hit. The details are too complex to document here.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 3. However, this didn't work fully. Even with /cache deny all/
</I>&gt;<i> &gt; directive, persistence wasn't working when I peeked at the sslBump step
</I>&gt;<i> &gt; 1 and then Bumped.
</I>&gt;<i> &gt; Persistence worked only when I directly did sslbump allow all (without
</I>&gt;<i> &gt; peeking at first step).
</I>&gt;<i>
</I>&gt;<i> Bumping step should not affect connection persistence AFAICT. I do not
</I>&gt;<i> know why it does in your case. This could be a Squid bug or a
</I>&gt;<i> misunderstanding. If you can reproduce, Squid logs should contain
</I>&gt;<i> reasons for each connection closure (but it may be difficult to find).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>


-- 
Regards,
Vishali Somaskanthan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180726/a357f369/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180726/a357f369/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018738.html">[squid-users] server persistent connections and cache
</A></li>
	<LI>Next message (by thread): <A HREF="018778.html">[squid-users] server persistent connections and cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18777">[ date ]</a>
              <a href="thread.html#18777">[ thread ]</a>
              <a href="subject.html#18777">[ subject ]</a>
              <a href="author.html#18777">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
