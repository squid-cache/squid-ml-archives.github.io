<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] server persistent connections and cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20server%20persistent%20connections%20and%20cache&In-Reply-To=%3CCABfsTT5B6q29zKewLNNRjDQJo9RC-5xOKkDTynz1oa4QYttjNQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018778.html">
   <LINK REL="Next"  HREF="018780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] server persistent connections and cache</H1>
    <B>Vishali Somaskanthan</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20server%20persistent%20connections%20and%20cache&In-Reply-To=%3CCABfsTT5B6q29zKewLNNRjDQJo9RC-5xOKkDTynz1oa4QYttjNQ%40mail.gmail.com%3E"
       TITLE="[squid-users] server persistent connections and cache">vishali.somaskanthan at viptela.com
       </A><BR>
    <I>Thu Jul 26 23:47:04 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018778.html">[squid-users] server persistent connections and cache
</A></li>
        <LI>Next message (by thread): <A HREF="018780.html">[squid-users] server persistent connections and cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18779">[ date ]</a>
              <a href="thread.html#18779">[ thread ]</a>
              <a href="subject.html#18779">[ subject ]</a>
              <a href="author.html#18779">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

FYI, in all my examples below, one have the same client and same server



By re-use I meant to say that the server-connection S (TCP + SSL) is
re-used across 2 client connections (C1 and C2), from the same client one
after the other is torn down. I, presume that &#8220;*server_persistent_connection
on*&#8221; allows for such a use-case. Is my understanding that Pinning means
binding C1 to S and then if C1 is closed, we unpin and then later if C2 is
created, we can pin it again to S?



There is some confusion in my understanding this statement &#8211; &#8220;pinning _all_
SslBump connections is easier than pinning some of them&#8221;, because I see
different behaviors when I bump at Step 1 (case 1) vs bump at Step 2 (case
2).

Case 1: We see that no pinning happens i.e. pinConnection() is not called
at all. C1-&gt;S gets established, C1 is closed and then C2 re-uses S

Case 2: We see that pinning happens i.e. httpsPeeked() calls
pinConnection(). Here, C1-&gt;S gets established. Closing C1 from the client
brings down S. Later, opening C2 opens a new server-connection S.



Is this the expected behavior? Please explain.


Thank you.

On Thu, Jul 26, 2018 at 2:13 PM, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 07/26/2018 02:49 PM, Vishali Somaskanthan wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; 1. Are there any security reasons behind /pinning the connection/ when a
</I>&gt;<i> &gt; peek is done at Step1
</I>&gt;<i>
</I>&gt;<i> I doubt there is some fundamental _security_ reason to pin if you bump
</I>&gt;<i> without forwarding the TLS client information to the server. The reasons
</I>&gt;<i> to pin in that case include:
</I>&gt;<i>
</I>&gt;<i> * honoring client and server blind tunneling expectations
</I>&gt;<i>   (which may result in better compatibility or even security);
</I>&gt;<i>
</I>&gt;<i> * development convenience (pinning _all_ SslBump connections is easier
</I>&gt;<i>   than pinning some of them).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Why is that done?
</I>&gt;<i>
</I>&gt;<i> I speculate it was done for the reasons stated in the above bullets.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2.a)  what is the scenario where a pinned connection can be reused?
</I>&gt;<i>
</I>&gt;<i> When a previously established Squid-to-server connection is used for the
</I>&gt;<i> next request on the corresponding client-to-Squid connection.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;    b) Which configure option is used to enable /#if STRICT_ORIGINAL_DST
</I>&gt;<i> ?/
</I>&gt;<i>
</I>&gt;<i> There is no user-friendly way to control that macro AFAICT. You may
</I>&gt;<i> define it when building Squid from sources (e.g., by passing
</I>&gt;<i> -DSTRICT_ORIGINAL_DST=1 to the compiler via CPPFLAGS). Please do not
</I>&gt;<i> misinterpret my response as an indication that this is an officially
</I>&gt;<i> supported feature.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Wed, Jul 18, 2018 at 5:00 PM, Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 07/18/2018 03:03 PM, Vishali Somaskanthan wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; I had a problem after sending too many requests to the same server
</I>&gt;<i> where
</I>&gt;<i> &gt;     &gt; my persistence stopped working suddenly.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Please note that there are many reasons why a proxy may close a
</I>&gt;<i> &gt;     connection. For pinned to-server connections (like those created by
</I>&gt;<i> &gt;     SslBump), it may not be possible to open a new to-server connection
</I>&gt;<i> so
</I>&gt;<i> &gt;     Squid should close both from-client and to-server connections.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     In general, a client should not rely on a connections staying
</I>&gt;<i> persistent
</I>&gt;<i> &gt;     except in some very unusual/special circumstances.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; 1. What is the relationship between the caching and the persistence
</I>&gt;<i> &gt;     &gt; connection established?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Virtually none. Caching decisions are done primarily based on request
</I>&gt;<i> &gt;     and response headers.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; 2. When will squid use cached results and when will it not if the
</I>&gt;<i> cache
</I>&gt;<i> &gt;     &gt; deny all directive weren't specified.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Squid will deliver a response from the cache when HTTP rules and
</I>&gt;<i> Squid
</I>&gt;<i> &gt;     configuration allow a hit. The details are too complex to document
</I>&gt;<i> here.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; 3. However, this didn't work fully. Even with /cache deny all/
</I>&gt;<i> &gt;     &gt; directive, persistence wasn't working when I peeked at the sslBump
</I>&gt;<i> step
</I>&gt;<i> &gt;     &gt; 1 and then Bumped.
</I>&gt;<i> &gt;     &gt; Persistence worked only when I directly did sslbump allow all
</I>&gt;<i> (without
</I>&gt;<i> &gt;     &gt; peeking at first step).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Bumping step should not affect connection persistence AFAICT. I do
</I>&gt;<i> not
</I>&gt;<i> &gt;     know why it does in your case. This could be a Squid bug or a
</I>&gt;<i> &gt;     misunderstanding. If you can reproduce, Squid logs should contain
</I>&gt;<i> &gt;     reasons for each connection closure (but it may be difficult to
</I>&gt;<i> find).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt; Vishali Somaskanthan
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Regards,
Vishali Somaskanthan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180726/e6f82263/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180726/e6f82263/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018778.html">[squid-users] server persistent connections and cache
</A></li>
	<LI>Next message (by thread): <A HREF="018780.html">[squid-users] server persistent connections and cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18779">[ date ]</a>
              <a href="thread.html#18779">[ thread ]</a>
              <a href="subject.html#18779">[ subject ]</a>
              <a href="author.html#18779">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
