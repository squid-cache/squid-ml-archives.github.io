<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL errors with Squid 3.5.27
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20errors%20with%20Squid%203.5.27&In-Reply-To=%3C9fcd2760-281d-63f2-52e4-983ac8c5b052%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018400.html">
   <LINK REL="Next"  HREF="018408.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL errors with Squid 3.5.27</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20errors%20with%20Squid%203.5.27&In-Reply-To=%3C9fcd2760-281d-63f2-52e4-983ac8c5b052%40treenet.co.nz%3E"
       TITLE="[squid-users] SSL errors with Squid 3.5.27">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jun  9 05:31:37 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018400.html">[squid-users] SSL errors with Squid 3.5.27
</A></li>
        <LI>Next message (by thread): <A HREF="018408.html">[squid-users] SSL errors with Squid 3.5.27
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18401">[ date ]</a>
              <a href="thread.html#18401">[ thread ]</a>
              <a href="subject.html#18401">[ subject ]</a>
              <a href="author.html#18401">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/06/18 11:15, Julian Perconti wrote:
&gt;<i> Hello community, I am new to the list and, I hope everyone is well.
</I>&gt;<i> 
</I>&gt;<i> I have running a squid server on debian 7.
</I>&gt;<i> 
</I>&gt;<i> My squid version is 3.5.27 manually compiled with LibreSSL 2.6.0 due to
</I>&gt;<i> problems with Dropbox. After compiling squid with LibreSSL, the error
</I>&gt;<i> &quot;unknown cipher returned&quot; has disappeared and dropbox worked correctly.
</I>&gt;<i> 
</I>&gt;<i> Everything works quite well, except that in /var/log/squid/cache.log there
</I>&gt;<i> are 5 types of problems (at least):
</I>&gt;<i> 
</I>&gt;<i> [1] 2018/06/08 17:14:05 kid1| Error negotiating SSL connection on FD 7:
</I>&gt;<i> error:14037418:SSL routines:ACCEPT_SR_KEY_EXCH:tlsv1 alert unknown ca (1/0)
</I>&gt;<i> [2] 2018/06/08 17:14:39 kid1| Error negotiating SSL on FD 11:
</I>&gt;<i> error:14007086:SSL routines:CONNECT_CR_CERT:certificate verify failed
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> [3] 2018/06/08 18:35:43 kid1| Error negotiating SSL connection on FD 10:
</I>&gt;<i> (104) Connection reset by peer
</I>&gt;<i> [4] 2018/06/08 18:56:52 kid1| Error negotiating SSL on FD 13:
</I>&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/-1/104)
</I>&gt;<i> [5] 2018/06/08 19:20:06 kid1| Error negotiating SSL connection on FD 9:
</I>&gt;<i> error:06FFF064:digital envelope routines:CRYPTO_internal:bad decrypt (1/-1)
</I>
This one may need you to check the ciphers you are allowing. Or be a
sign of a bug in the library.

Trying to connect to the server manually with a CLI tool that can debug
the verify procedure would be the best way forward. You may want to look
at the handshake the client is sending to Squid and Squid to the server
for what to test with.


&gt;<i> 
</I>&gt;<i> However I think (I'm not sure but ...), that the most serious is the number
</I>&gt;<i> [2]:
</I>&gt;<i> SSL negotiating error on FD 11: error: 14007086: SSL routines:
</I>&gt;<i> CONNECT_CR_CERT:certificate verify failed (1/-1/0)
</I>&gt;<i> 
</I>&gt;<i> The problem I have it with WhatsApp from mobile devices ... the application
</I>&gt;<i> tries to connect to the network indefinitely without success, and the error
</I>&gt;<i> that appears (at that moment) is [2]: (...) certificate verify failed
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> 
</I>
For 3.5.27 you need to find out what their CA is and decide whether its
worth adding to sslproxy_foreign_intermediate_certs (for intermediates),
OR to sslproxy_cafile or the system root CAs if it's self-signed.

If its an intermediate you might have better behaviour with Squid-4. But
be aware that LibreSSL is not tested by any of us dev, so technically
&quot;not supported&quot; even if it usually works.


&gt;<i> 
</I>&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;<i>   cert=/etc/squid/ssl_cert/squidCA.pem \
</I>&gt;<i>   key=/etc/squid/ssl_cert/squidCA.pem \
</I>&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem
</I>
These DH parameters are for old DH not for ECDHE (missing curve name).
So this may be restricting what your Squid can do to match up the client
and server crypto requirements.


&gt;<i> 
</I>&gt;<i> Any kind of suggestion is welcome; both if there is something wrong in the
</I>&gt;<i> configuration written above, or better yet if someone knows the cause and
</I>&gt;<i> solution of this problem.
</I>
Most of these are probably just the side effects of an untrusted CA.
This is normal for TLS/SSL.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018400.html">[squid-users] SSL errors with Squid 3.5.27
</A></li>
	<LI>Next message (by thread): <A HREF="018408.html">[squid-users] SSL errors with Squid 3.5.27
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18401">[ date ]</a>
              <a href="thread.html#18401">[ thread ]</a>
              <a href="subject.html#18401">[ subject ]</a>
              <a href="author.html#18401">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
