<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS cache for Java application - only getting	TCP_MISS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20cache%20for%20Java%20application%20-%20only%20getting%0A%09TCP_MISS&In-Reply-To=%3CJdXq3pJFV_94n9mhtaks-iNxdcviA2En7umcT0nz328hxjaCsPTEPQhbyFFQCaOy0a6dlH6rSAa6YwK1hJNUFr40eB3qyZ7s_HBacwWGu38%3D%40protonmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018441.html">
   <LINK REL="Next"  HREF="018446.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS cache for Java application - only getting	TCP_MISS</H1>
    <B>Tomas Finn&#248;y</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20cache%20for%20Java%20application%20-%20only%20getting%0A%09TCP_MISS&In-Reply-To=%3CJdXq3pJFV_94n9mhtaks-iNxdcviA2En7umcT0nz328hxjaCsPTEPQhbyFFQCaOy0a6dlH6rSAa6YwK1hJNUFr40eB3qyZ7s_HBacwWGu38%3D%40protonmail.com%3E"
       TITLE="[squid-users] HTTPS cache for Java application - only getting	TCP_MISS">baretomas at protonmail.com
       </A><BR>
    <I>Thu Jun 14 15:49:59 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018441.html">[squid-users] HTTPS cache for Java application - only getting TCP_MISS
</A></li>
        <LI>Next message (by thread): <A HREF="018446.html">[squid-users] HTTPS cache for Java application - only getting	TCP_MISS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18445">[ date ]</a>
              <a href="thread.html#18445">[ thread ]</a>
              <a href="subject.html#18445">[ subject ]</a>
              <a href="author.html#18445">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&#8208;&#8208;&#8208;&#8208;&#8208;&#8208;&#8208; Original Message &#8208;&#8208;&#8208;&#8208;&#8208;&#8208;&#8208;

On June 14, 2018 1:25 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 14/06/18 07:28, baretomas wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'm setting up a Squid proxy as a cache for a number (as many as possible)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; of identical JAVA applications to run their web calls through. The calls are
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ofc identical, and the response they get can safely be cached for 5-10
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; seconds.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I do this because most of the calls is directed at a single server on the
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; internet that I don't want to hammer, since I will ofc be locked out of it
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; then.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Currently Im simply testing this on a single computer: the application and
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; squid
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The calls from the application is done using ssl / https by telling java to
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; use Squid as a proxy (-Dhttps.proxyHost and -Dhttp.proxyHost). I've set up
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; squid and JAVA with self-signed certificates, and the application sends its
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; calls through squid and gets the reponse. No problem there (wasnt easy that
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; either I must say :P ).
</I>&gt;<i> 
</I>&gt;<i> I was going to ask what was so hard about it. Then I looked at your
</I>&gt;<i> 
</I>&gt;<i> config and see that your are in fact using NAT interception instead of
</I>&gt;<i> 
</I>&gt;<i> the easy way.
</I>&gt;<i> 
</I>&gt;<i> So what exactly do those -D options cause the Java applications to do
</I>&gt;<i> 
</I>&gt;<i> with the proxy?
</I>&gt;<i> 
</I>&gt;<i> I have some suspicions, but am not familiar enough with Java API and
</I>&gt;<i> 
</I>&gt;<i> the specific details are critical to what you need the proxy to be doing.
</I>&gt;<i> 
</I>&gt;<i> &gt; The problem is that none of the calls get cached: All rows in the access.log
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; hava a TCP_MISS/200 tag in them.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I've searched all through the web for a solution to this, and have tried
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; everything people have suggested. So I was hoping someone could help me?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Anyone have any tips on what to try?
</I>&gt;<i> 
</I>&gt;<i> There are three ways to do this:
</I>&gt;<i> 
</I>&gt;<i> 1.  if you own the domain the apps are connecting to. Setup the proxy as
</I>&gt;<i>     
</I>&gt;<i>     a normal TLS / HTTPS reverse-proxy.
</I>&gt;<i>     
</I>&gt;<i> 2.  if you have enough control of the apps to get them connecting with
</I>&gt;<i>     
</I>&gt;<i>     TLS to the proxy and sending their requests there. Do that.
</I>&gt;<i>     
</I>&gt;<i> 3.  the (relatively) complicated SSL-Bump way you found. The proxy is
</I>&gt;<i>     
</I>&gt;<i>     fully at the mercy of the the messages sent by apps and servers. Caching
</I>&gt;<i>     
</I>&gt;<i>     is a luxury here, easily broken / prevented.
</I>&gt;<i>     
</I>&gt;<i>     Well, there is a forth way with intercept. But that is a VERY last
</I>&gt;<i>     
</I>&gt;<i>     resort and you already have (3) going and that is already better than
</I>&gt;<i>     
</I>&gt;<i>     intercept. Getting to (1) or (2) would be simplest if you meet the &quot;if
</I>&gt;<i>     
</I>&gt;<i>     ...&quot; requirements for those.
</I>&gt;<i>     
</I>&gt;<i> 
</I>&gt;<i> &gt; MY config (note Ive set the refresh_pattern like that just to see if I could
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; catch anything. The plan is to modify it so it actualyl does refresh the
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; responses frmo the web calls in 5-10 seconds intervals. There are commented
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; out pats Ive tried with no luck there too):
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> Ah. The way you write that implies a misunderstanding about refresh_pattern.
</I>&gt;<i> 
</I>&gt;<i> HTTP has some fixed algorithms written into the protocol that caches are
</I>&gt;<i> 
</I>&gt;<i> required to perform to determine if any object stored can be used or
</I>&gt;<i> 
</I>&gt;<i> requires replacement.
</I>&gt;<i> 
</I>&gt;<i> The parameters used by these algorithms come in the form of headers in
</I>&gt;<i> 
</I>&gt;<i> the originally stored reply message, the current clients request.
</I>&gt;<i> 
</I>&gt;<i> Sometimes they require revalidation, which is a quick check with the
</I>&gt;<i> 
</I>&gt;<i> server for updated instructions and/or content.
</I>&gt;<i> 
</I>&gt;<i> What refresh_pattern actually does is provide default values for those
</I>&gt;<i> 
</I>&gt;<i> algorithm parameters IF any one (or more) of them are missing from those
</I>&gt;<i> 
</I>&gt;<i> HTTP messages.
</I>&gt;<i> 
</I>&gt;<i> The proper way to make caching happen with your desired behaviour is for
</I>&gt;<i> 
</I>&gt;<i> the server to present HTTP Cache-Control header saying the object is
</I>&gt;<i> 
</I>&gt;<i> cacheable (ie does not forbid caching), but not for more than 10seconds.
</I>&gt;<i> 
</I>&gt;<i> Cache-Control: max-age=10
</I>&gt;<i> 
</I>&gt;<i> OR to say that objects need revalidation, but presents a 304 status for
</I>&gt;<i> 
</I>&gt;<i> revalidation checks. (ie Cache-Control:no-cache) (yeah, thats right,
</I>&gt;<i> 
</I>&gt;<i> &quot;no-cache&quot; means do cache).
</I>&gt;<i> 
</I>&gt;<i> That said, I doubt you really are wanting to force that and would be
</I>&gt;<i> 
</I>&gt;<i> happy if the server was instructing the the proxy as being safe to cache
</I>&gt;<i> 
</I>&gt;<i> an object for several minutes or any value larger than 10sec.
</I>&gt;<i> 
</I>&gt;<i> So what we circle back to is that you are probably trying to force
</I>&gt;<i> 
</I>&gt;<i> things to cache and be used long past their actual safe-to-use lifetimes
</I>&gt;<i> 
</I>&gt;<i> as specified by the devs most authoritative on that subject (under
</I>&gt;<i> 
</I>&gt;<i> 10sec?). As you should be aware, this is highly unsafe thing to be doing
</I>&gt;<i> 
</I>&gt;<i> unless you are one of those devs - be very careful what you choose to do.
</I>&gt;<i> 
</I>&gt;<i> &gt; Squid normally listens to port 3128
</I>&gt;<i> &gt; ===================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB cert=/cygdrive/c/squid/etc/squid/correct.pem
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; key=/cygdrive/c/squid/etc/squid/ssl/myca.key
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; cert=/cygdrive/c/squid/etc/squid/proxyCAx.pem
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; key=/cygdrive/c/squid/etc/squid/proxyCA.pem
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #https_port 3129 cert=/cygdrive/c/squid/etc/squid/proxyCAx.pem
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; key=/cygdrive/c/squid/etc/squid/proxyCA.pem
</I>&gt;<i> 
</I>&gt;<i> Hmm. This is a Windows machine running Cygwin?
</I>&gt;<i> 
</I>&gt;<i> FYI: Performance is going to be terrible. It may not be super relevant
</I>&gt;<i> 
</I>&gt;<i> yet. Just be aware that Windows imposes limitations on usable sockets
</I>&gt;<i> 
</I>&gt;<i> per application - which is much smaller than a typical proxy requires.
</I>&gt;<i> 
</I>&gt;<i> The Cygwin people do a lot but they cannot solve some OS limitation
</I>&gt;<i> 
</I>&gt;<i> problems.
</I>&gt;<i> 
</I>&gt;<i> To meet your very first sentence &quot;as many as possible&quot; requirement you
</I>&gt;<i> 
</I>&gt;<i> will need a non-Windows machine to run the proxy on. That simple change
</I>&gt;<i> 
</I>&gt;<i> will get you something around 3 orders of magnitude higher peak client
</I>&gt;<i> 
</I>&gt;<i> capacity on the proxy.
</I>&gt;<i> 
</I>&gt;<i> &gt; Uncomment the line below to enable disk caching - path format is
</I>&gt;<i> &gt; ================================================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; /cygdrive/&lt;full path to cache folder&gt;, i.e.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #cache_dir aufs /cygdrive/c/squid/var/cache/ 3000 16 256
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; certificate generation program
</I>&gt;<i> &gt; ==============================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; sslcrtd_program /cygdrive/c/squid/lib/squid/ssl_crtd -s
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; /cygdrive/c/squid/var/cache/squid_ssldb -M 4MB
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Leave coredumps in the first cache dir
</I>&gt;<i> &gt; ======================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; coredump_dir /var/cache/squid
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Add any of your own refresh_pattern entries above these.
</I>&gt;<i> &gt; ========================================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #refresh_pattern -i (/cgi-bin/|?) 0 0% 0
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #refresh_pattern -i (/cgi-bin/|?) 1440 100% 4320 ignore-no-store
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; override-lastmod override-expire ignore-must-revalidate ignore-reload
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ignore-private ignore-auth
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; refresh_pattern . 1440 100% 4320 ignore-no-store override-lastmod
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; override-expire ignore-must-revalidate ignore-reload ignore-private
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ignore-auth override-lastmod
</I>&gt;<i> 
</I>&gt;<i> -   ignore-must-revalidate actively reduces caching. Because it disables
</I>&gt;<i>     
</I>&gt;<i>     several of the widely used HTTP mechanisms that rely on revalidation to
</I>&gt;<i>     
</I>&gt;<i>     allow things to be stored in a cache.
</I>&gt;<i>     
</I>&gt;<i>     It is only beneficial if the server is broken; requiring revalidation
</I>&gt;<i>     
</I>&gt;<i>     plus not supporting revalidation.
</I>&gt;<i>     
</I>&gt;<i> -   ignore-auth same un-intuitive effects as ignoring revalidation, again
</I>&gt;<i>     
</I>&gt;<i>     reducing caching ability.
</I>&gt;<i>     
</I>&gt;<i>     This is only useful if you want to prevent caching of contents which
</I>&gt;<i>     
</I>&gt;<i>     require any form of login to view. High security networks dealing with
</I>&gt;<i>     
</I>&gt;<i>     classified or confidential materials find this useful - regular Internet
</I>&gt;<i>     
</I>&gt;<i>     admin not so much.
</I>&gt;<i>     
</I>&gt;<i> -   ignore-no-store is highly dangerous and rarely necessary. The &quot;nuclear
</I>&gt;<i>     
</I>&gt;<i>     option&quot; for caching. It has the potential to eradicate user privacy and
</I>&gt;<i>     
</I>&gt;<i>     scramble up any server personalized content (not in a good way).
</I>&gt;<i>     
</I>&gt;<i>     This is a last resort intended only to copy with severely braindead
</I>&gt;<i>     
</I>&gt;<i>     applications. YMMV whether you have to deal with any of those - just
</I>&gt;<i>     
</I>&gt;<i>     treat this an absolute last resort rather than something to play with.
</I>&gt;<i>     
</I>&gt;<i>     Overall - in order to use these refresh-pattern controls you need to
</I>&gt;<i>     
</I>&gt;<i>     know what the HTTP(S) messages going through your proxy contain in terms
</I>&gt;<i>     
</I>&gt;<i>     of caching headers AND what those messages are doing semantically /
</I>&gt;<i>     
</I>&gt;<i>     content wise for the client application. Using any of them as a generic
</I>&gt;<i>     
</I>&gt;<i>     &quot;makes caching better&quot; thing only leads to problems in todays HTTP protocol.
</I>&gt;<i>     
</I>&gt;<i> 
</I>&gt;<i> &gt; Bumped requests have relative URLs so Squid has to use reverse proxy
</I>&gt;<i> &gt; ====================================================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; or accelerator code. By default, that code denies direct forwarding.
</I>&gt;<i> &gt; ====================================================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The need for this option may disappear in the future.
</I>&gt;<i> &gt; =====================================================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; #always_direct allow all
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; dns_nameservers 8.8.8.8 208.67.222.222
</I>&gt;<i> 
</I>&gt;<i> Use of 8.8.8.8 is known to be explicitly detrimental to caching
</I>&gt;<i> 
</I>&gt;<i> intercepted traffic.
</I>&gt;<i> 
</I>&gt;<i> Those servers present different result sets based on the timing and IP
</I>&gt;<i> 
</I>&gt;<i> sending the query. The #1 requirement of caching intercepted (or
</I>&gt;<i> 
</I>&gt;<i> SSL-Bump'ed) content is that the client and proxy have the exact same
</I>&gt;<i> 
</I>&gt;<i> view of DNS system contents. Having the DNS reply contents change
</I>&gt;<i> 
</I>&gt;<i> between two consecutive and identical queries breaks that requirement.
</I>&gt;<i> 
</I>&gt;<i> &gt; max_filedescriptors 3200
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Max Object Size Cache
</I>&gt;<i> &gt; =====================
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; maximum_object_size 10240 KB
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> This causes the proxy to attempt decryption of the traffic using crypto
</I>&gt;<i> 
</I>&gt;<i> algorithms based solely on the ClientHello details and its own
</I>&gt;<i> 
</I>&gt;<i> capabilities. There is zero server crypto capabilities known for the
</I>&gt;<i> 
</I>&gt;<i> proxy to use to ensure traffic can actually make it to the server.
</I>&gt;<i> 
</I>&gt;<i> You are rather lucky that it actually worked at all. Almost any
</I>&gt;<i> 
</I>&gt;<i> deviation (ie emergency security updates in future) at either client or
</I>&gt;<i> 
</I>&gt;<i> server or proxy endpoints risks breaking the communication through this
</I>&gt;<i> 
</I>&gt;<i> proxy.
</I>&gt;<i> 
</I>&gt;<i> Ideally there would be a stare action for step2 and them bump only at
</I>&gt;<i> 
</I>&gt;<i> step 3.
</I>&gt;<i> 
</I>&gt;<i> So in summary to the things to try to get better caching:
</I>&gt;<i> 
</I>&gt;<i> -   ditch 8.8.8.8. Use a local DNS resolver within your own network,
</I>&gt;<i>     
</I>&gt;<i>     shared by clients and proxy. That can use 8.8.8.8 itself, the important
</I>&gt;<i>     
</I>&gt;<i>     part is that it should be responsible for caching DNS results and
</I>&gt;<i>     
</I>&gt;<i>     ensuring the app clients and Squid see as much the same records as possible.
</I>&gt;<i>     
</I>&gt;<i> -   try &quot;debug_options 11,2&quot; to get a cache.log of the HTTP(S) headers for
</I>&gt;<i>     
</I>&gt;<i>     message being decrypted in the proxy. Look at those headers to see why
</I>&gt;<i>     
</I>&gt;<i>     they are not caching normally. Use that info to inform your next
</I>&gt;<i>     
</I>&gt;<i>     actions. It cannot tell you how the message is used by the application,
</I>&gt;<i>     
</I>&gt;<i>     hopefully you can figure that out somehow before forcing anything unnatural.
</I>&gt;<i>     
</I>&gt;<i> -   if you can, try pasting some of the transaction URLs into the tool at
</I>&gt;<i>     
</I>&gt;<i>     redbot.org to see if there are any HTTP level mistakes in the apps that
</I>&gt;<i>     
</I>&gt;<i>     could be fixed for better cacheability.
</I>&gt;<i>     
</I>&gt;<i>     Amos
</I>

Very much thanks for this very informative post to my question! I will spend some time understanding it, and try out the things you suggest!
Thanks again!


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018441.html">[squid-users] HTTPS cache for Java application - only getting TCP_MISS
</A></li>
	<LI>Next message (by thread): <A HREF="018446.html">[squid-users] HTTPS cache for Java application - only getting	TCP_MISS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18445">[ date ]</a>
              <a href="thread.html#18445">[ thread ]</a>
              <a href="subject.html#18445">[ subject ]</a>
              <a href="author.html#18445">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
