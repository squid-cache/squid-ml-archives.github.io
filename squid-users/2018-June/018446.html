<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS cache for Java application - only getting	TCP_MISS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20cache%20for%20Java%20application%20-%20only%20getting%0A%09TCP_MISS&In-Reply-To=%3C1529004740348-0.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018445.html">
   <LINK REL="Next"  HREF="018447.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS cache for Java application - only getting	TCP_MISS</H1>
    <B>baretomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20cache%20for%20Java%20application%20-%20only%20getting%0A%09TCP_MISS&In-Reply-To=%3C1529004740348-0.post%40n4.nabble.com%3E"
       TITLE="[squid-users] HTTPS cache for Java application - only getting	TCP_MISS">baretomas at protonmail.com
       </A><BR>
    <I>Thu Jun 14 19:32:20 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018445.html">[squid-users] HTTPS cache for Java application - only getting	TCP_MISS
</A></li>
        <LI>Next message (by thread): <A HREF="018447.html">[squid-users] HTTPS cache for Java application - only getting TCP_MISS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18446">[ date ]</a>
              <a href="thread.html#18446">[ thread ]</a>
              <a href="subject.html#18446">[ subject ]</a>
              <a href="author.html#18446">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok Im back. Still confused as ever. Look below for my story.

On 14 June 2018 1:25 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:


&gt;<i> There are three ways to do this:
</I>&gt;<i> 
</I>&gt;<i> 1.  if you own the domain the apps are connecting to. Setup the proxy as
</I>&gt;<i>     a normal TLS / HTTPS reverse-proxy.
</I>&gt;<i> 2.  if you have enough control of the apps to get them connecting with
</I>&gt;<i>     TLS to the proxy and sending their requests there. Do that.
</I>&gt;<i> 3.  the (relatively) complicated SSL-Bump way you found. The proxy is
</I>&gt;<i>     fully at the mercy of the the messages sent by apps and servers.
</I>&gt;<i> Caching
</I>&gt;<i>     is a luxury here, easily broken / prevented.
</I>&gt;<i>     Well, there is a forth way with intercept. But that is a VERY last
</I>&gt;<i>     resort and you already have (3) going and that is already better than
</I>&gt;<i>     intercept. Getting to (1) or (2) would be simplest if you meet the &quot;if
</I>&gt;<i>     ...&quot; requirements for those.
</I>
1. Both the proxy and the apps are on the same machine on my home network.
The server they are calling is not mine and have no way of modifying its
behaviour. That rules out 1, if I understood correctly?

2. According to the java docs, the https_proxy (-Dhttps.proxyHost and
-Dhttps.proxyPort should redirect all ssl traffic to that destination.)
should cover this. And I already have done that. 

So I seemed to have combined 2 and 3 here? 

But I *only* need 2 you are saying. 


&gt;<i> The proper way to make caching happen with your desired behaviour is for
</I>&gt;<i> the server to present HTTP Cache-Control header saying the object is
</I>&gt;<i> cacheable (ie does not forbid caching), but not for more than 10seconds.
</I>&gt;<i> Cache-Control: max-age=10
</I>&gt;<i> OR to say that objects need revalidation, but presents a 304 status for
</I>&gt;<i> revalidation checks. (ie Cache-Control:no-cache) (yeah, thats right,
</I>&gt;<i> &quot;no-cache&quot; means do cache).
</I>&gt;<i> 
</I>&gt;<i> That said, I doubt you really are wanting to force that and would be
</I>&gt;<i> happy if the server was instructing the the proxy as being safe to cache
</I>&gt;<i> an object for several minutes or any value larger than 10sec.
</I>&gt;<i> So what we circle back to is that you are probably trying to force
</I>&gt;<i> things to cache and be used long past their actual safe-to-use lifetimes
</I>&gt;<i> as specified by the devs most authoritative on that subject (under
</I>&gt;<i> 10sec?). As you should be aware, this is highly unsafe thing to be doing
</I>&gt;<i> unless you are one of those devs - be very careful what you choose to do.
</I>
I'm well aware of the issues this might pose, and yes: the server *is*
sending out cache-control. Look below for the header. My wish is to ignore
those headers and still cache the content.

To repeat, Im well aware of the issues this might pose, and is ready to run
side-by-side tests continuosly to make certain all the app behave like they
should, even if they are only getting cached content. 

Ive analyzed the apps web calls for about a day of data, and figured out how
many and what type of calls it does, and I know the response content very
well, since I have written apps against that API myself.

What I am actually doing is writing a test bench for the application in
question by running many of them simultaneously against the same data sets,
with differing configurations to compare the result.

No other person is to touch this project, so Im fairly sure it wont affect
anyone but my own free time :)

It's not meant for production environment of any kind, and Im aware of the
potential failures of the project should anything out of my control happen. 

But thanks for the warnings of course. You have no way of knowing what my
intentions with the project were when I first asked my questions, and
probably should have had done that from the start.

I hope that makes evrything a bit clearer? Anyway,

So...is it all possible to override the cache controls of the headers below?

server reply header:

HTTP/1.1 200 OK
Content-Type: application/json
Transfer-Encoding: chunked
Connection: keep-alive
Date: Wed, 13 Jun 2018 17:18:33 GMT
Server: nginx
Vary: Accept-Encoding
Strict-Transport-Security: max-age=31536000; includeSubdomains
X-Frame-Options: SAMEORIGIN
X-Xss-Protection: 1; mode=block
X-Content-Type-Options: nosniff
Content-Security-Policy: default-src 'self'
X-Content-Security-Policy: default-src 'self'
X-WebKit-CSP: default-src 'self'
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0
X-Cache: Miss from cloudfront
Via: 1.1 21258ec71c1aa4499bcd08c6ad0eba38.cloudfront.net (CloudFront)
X-Amz-Cf-Id: gdqZScePve6zvtHqlFa8TmCmmh0rKGrwD2Gwx46PbUSqd94QiJhkPQ==


&gt;<i> &gt; Squid normally listens to port 3128
</I>&gt;<i> &gt; ===================================
</I>&gt;<i> &gt; #http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> cert=/cygdrive/c/squid/etc/squid/correct.pem
</I>&gt;<i> &gt; key=/cygdrive/c/squid/etc/squid/ssl/myca.key
</I>&gt;<i> &gt; http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; cert=/cygdrive/c/squid/etc/squid/proxyCAx.pem
</I>&gt;<i> &gt; key=/cygdrive/c/squid/etc/squid/proxyCA.pem
</I>&gt;<i> &gt; #https_port 3129 cert=/cygdrive/c/squid/etc/squid/proxyCAx.pem
</I>&gt;<i> &gt; key=/cygdrive/c/squid/etc/squid/proxyCA.pem
</I>&gt;<i> 
</I>&gt;<i> Hmm. This is a Windows machine running Cygwin?
</I>&gt;<i> FYI: Performance is going to be terrible. It may not be super relevant
</I>&gt;<i> yet. Just be aware that Windows imposes limitations on usable sockets
</I>&gt;<i> per application - which is much smaller than a typical proxy requires.
</I>&gt;<i> 
</I>&gt;<i> The Cygwin people do a lot but they cannot solve some OS limitation
</I>&gt;<i> problems.
</I>&gt;<i> 
</I>&gt;<i> To meet your very first sentence &quot;as many as possible&quot; requirement you
</I>&gt;<i> will need a non-Windows machine to run the proxy on. That simple change
</I>&gt;<i> will get you something around 3 orders of magnitude higher peak client
</I>&gt;<i> capacity on the proxy.
</I>
The current setup is on my windows laptop. Im only doing PoCs on it before
doing it all over again on a debian box with docker, where the applications
are to run. (Im already looking forward to bug hunting the differences in
behaviour for the whole thing after moving it, btw!) 
Sounds ok? If anyone have any suggestions on how I would run this even more
efficiently, I would very much like to know!  It's a critical facet of the
proejhct to get as many of these applciations running at the same time.

&gt;<i>     Overall - in order to use these refresh-pattern controls you need to
</I>&gt;<i>     know what the HTTP(S) messages going through your proxy contain in
</I>&gt;<i> terms
</I>&gt;<i>     of caching headers AND what those messages are doing semantically /
</I>&gt;<i>     content wise for the client application. Using any of them as a
</I>&gt;<i> generic
</I>&gt;<i>     &quot;makes caching better&quot; thing only leads to problems in todays HTTP
</I>&gt;<i> protocol.
</I>
I've pulled out the relevant bits of the headers:

Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0

I guess I went slightly overboard with my config. I tried to add one
directive after another to see if there was any change. I couldn't spot any.
Would this be the correct setup for my refresh_pattern to be able to cache
reponses with this header?

ignore-no-store ignore-must-revalidate  override-expire   ?

What about the Expires: 0? Is that covered by override-expire?


&gt;<i> &gt; dns_nameservers 8.8.8.8 208.67.222.222
</I>&gt;<i> 
</I>&gt;<i> Use of 8.8.8.8 is known to be explicitly detrimental to caching
</I>&gt;<i> intercepted traffic.
</I>&gt;<i> 
</I>&gt;<i> Those servers present different result sets based on the timing and IP
</I>&gt;<i> sending the query. The #1 requirement of caching intercepted (or
</I>&gt;<i> SSL-Bump'ed) content is that the client and proxy have the exact same
</I>&gt;<i> view of DNS system contents. Having the DNS reply contents change
</I>&gt;<i> between two consecutive and identical queries breaks that requirement.
</I>
Thanks. Using my own dns now!

&gt;<i> &gt; max_filedescriptors 3200
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Max Object Size Cache
</I>&gt;<i> &gt; =====================
</I>&gt;<i> &gt; maximum_object_size 10240 KB
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> This causes the proxy to attempt decryption of the traffic using crypto
</I>&gt;<i> algorithms based solely on the ClientHello details and its own
</I>&gt;<i> capabilities. There is zero server crypto capabilities known for the
</I>&gt;<i> proxy to use to ensure traffic can actually make it to the server.
</I>&gt;<i> You are rather lucky that it actually worked at all. Almost any
</I>&gt;<i> deviation (ie emergency security updates in future) at either client or
</I>&gt;<i> server or proxy endpoints risks breaking the communication through this
</I>&gt;<i> proxy.
</I>&gt;<i> 
</I>&gt;<i> Ideally there would be a stare action for step2 and them bump only at
</I>&gt;<i> 
</I>&gt;<i> step 3.
</I>&gt;<i> 
</I>&gt;<i> So in summary to the things to try to get better caching:
</I>&gt;<i> 
</I>&gt;<i> -   ditch 8.8.8.8. Use a local DNS resolver within your own network,
</I>&gt;<i>     shared by clients and proxy. That can use 8.8.8.8 itself, the
</I>&gt;<i> important
</I>&gt;<i>     part is that it should be responsible for caching DNS results and
</I>&gt;<i>     ensuring the app clients and Squid see as much the same records as
</I>&gt;<i> possible.
</I>&gt;<i>     
</I>&gt;<i> -   try &quot;debug_options 11,2&quot; to get a cache.log of the HTTP(S) headers for
</I>&gt;<i>     message being decrypted in the proxy. Look at those headers to see why
</I>&gt;<i>     they are not caching normally. Use that info to inform your next
</I>&gt;<i>     actions. It cannot tell you how the message is used by the
</I>&gt;<i> application,
</I>&gt;<i>     hopefully you can figure that out somehow before forcing anything
</I>&gt;<i> unnatural.
</I>&gt;<i>     
</I>&gt;<i> -   if you can, try pasting some of the transaction URLs into the tool at
</I>&gt;<i>     redbot.org to see if there are any HTTP level mistakes in the apps
</I>&gt;<i> that
</I>&gt;<i>     could be fixed for better cacheability.
</I>

What Im still confused about all this, and it's probably because I dont
understand the squid system well enough, and that I have possibly read too
many suggestions on other forums that have pointed me in the wrong
direction.

What I have gathered from your posts and the others:

If I want to cache https/ssl I need to decrypt the requests and responses
using certificates.
Otherwise the application will only tunnel its requests to the destination
and the proxy wont know what's in the messages.

However, I *dont* have to bump and peek and do a fancy dance to get squid to
cache it. 

I also see that Amos is suggesting a reverse proxy (accel mode) on the
proxy. So...

... I assume this is not needed?
http_port 3128 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB
cert=/cygdrive/c/squid/etc/squid/proxyCAx.pem
key=/cygdrive/c/squid/etc/squid/proxyCA.pem

And I need something like this:

https_port 3128 accel generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB
cert=/cygdrive/c/squid/etc/squid/proxyCAx.pem
key=/cygdrive/c/squid/etc/squid/proxyCA.pem

I tried this here now, and it seems to fail even more than before. No idea
why. I get this error message that seems to point me in the right direction,
but haven't found anything on google to give me an indication as to what it
actually points towards.

Squid_SSL_accept: Error negotiating SSL connection on FD 10:
error:00000005:lib(0):func(0):DH lib

Am I right in my musings so far? :)

Oh. Ive tried to use the browser as source of my tests. There is little
change in result to what the java apps are doing. 

Any thoughts or ideas are wildly appreciated!







--
Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018445.html">[squid-users] HTTPS cache for Java application - only getting	TCP_MISS
</A></li>
	<LI>Next message (by thread): <A HREF="018447.html">[squid-users] HTTPS cache for Java application - only getting TCP_MISS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18446">[ date ]</a>
              <a href="thread.html#18446">[ thread ]</a>
              <a href="subject.html#18446">[ subject ]</a>
              <a href="author.html#18446">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
