<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ignore SSL error and splice by ssl::server_name	at the same time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ignore%20SSL%20error%20and%20splice%20by%20ssl%3A%3Aserver_name%0A%09at%20the%20same%20time&In-Reply-To=%3C45be4c80c58842568fd50b1825755da5%40mbxtoa3.winmail.deshaw.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018488.html">
   <LINK REL="Next"  HREF="018490.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ignore SSL error and splice by ssl::server_name	at the same time</H1>
    <B>Ahmad, Sarfaraz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ignore%20SSL%20error%20and%20splice%20by%20ssl%3A%3Aserver_name%0A%09at%20the%20same%20time&In-Reply-To=%3C45be4c80c58842568fd50b1825755da5%40mbxtoa3.winmail.deshaw.com%3E"
       TITLE="[squid-users] Ignore SSL error and splice by ssl::server_name	at the same time">Sarfaraz.Ahmad at deshaw.com
       </A><BR>
    <I>Wed Jun 20 12:25:31 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018488.html">[squid-users] Ignore SSL error and splice by ssl::server_name	at the same time
</A></li>
        <LI>Next message (by thread): <A HREF="018490.html">[squid-users] Ignore SSL error and splice by ssl::server_name at the same time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18489">[ date ]</a>
              <a href="thread.html#18489">[ thread ]</a>
              <a href="subject.html#18489">[ subject ]</a>
              <a href="author.html#18489">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I found the answer to my problem. The SNI and Subject CN were different in my case and I was not peeking at step2 (meaning not looking at the server certificate) that is why my ACLs were ineffective.

Regards,
Sarfaraz

From: Ahmad, Sarfaraz
Sent: Wednesday, June 20, 2018 3:25 PM
To: '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: RE: Ignore SSL error and splice by ssl::server_name at the same time

Forgot to add. Remote IP addresses are not expected to remain constant. So I cannot build ACLs that way. So ssl::server_name is the only other hope.

From: Ahmad, Sarfaraz
Sent: Wednesday, June 20, 2018 2:34 PM
To: '<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Ignore SSL error and splice by ssl::server_name at the same time

Hi,

I need to provide access to a API service exposed on the internet to my clients. That API uses a certificate signed by a private CA.
I don't want to trust that private CA in my proxies (lest it gets abused and I end up trusting certificates in the proxy that I shouldn't be.  My clients would be unaware since I am bumping all the TLS connections unless explicitly configured. )
To avoid that I tried ignoring the ssl validation error with  sslproxy_cert_error directive and then splicing the connection. But its not working out.

SubjectCN in that services' certificate is &quot;kube-apiserver&quot;

Ignore settings :

acl broken_kubernetes ssl::server_name kube-apiserver
sslproxy_cert_error allow broken_kubernetes
sslproxy_cert_error deny all


Splicing settings:

acl no_ssl_bump_kubernetes ssl::server_name kube-apiserver
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1
ssl_bump splice no_ssl_bump_kubernetes
ssl_bump bump all

Splicing settings are in the lower half of my config.
But I am still getting MITM'ed (bumped) and on the clients, I get a &quot;Not Trusted by MyCA&quot; certificate is being shown. Any ideas ?

Regards,
Sarfaraz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180620/c1a64841/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180620/c1a64841/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018488.html">[squid-users] Ignore SSL error and splice by ssl::server_name	at the same time
</A></li>
	<LI>Next message (by thread): <A HREF="018490.html">[squid-users] Ignore SSL error and splice by ssl::server_name at the same time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18489">[ date ]</a>
              <a href="thread.html#18489">[ thread ]</a>
              <a href="subject.html#18489">[ subject ]</a>
              <a href="author.html#18489">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
