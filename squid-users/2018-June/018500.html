<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Speed &#8203;&#8203;limit from file size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%0A%20%3D%3Futf-8%3Fb%3FU3BlZWQg4oCL4oCLbGltaXQgZnJvbSBmaWxlIHNp%3F%3D%20%3D%3Futf-8%3Fq%3Fze%3F%3D&In-Reply-To=%3Caf61d5b5-944b-f9f3-931a-337c36b177d6%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018498.html">
   <LINK REL="Next"  HREF="018502.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Speed &#8203;&#8203;limit from file size</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%0A%20%3D%3Futf-8%3Fb%3FU3BlZWQg4oCL4oCLbGltaXQgZnJvbSBmaWxlIHNp%3F%3D%20%3D%3Futf-8%3Fq%3Fze%3F%3D&In-Reply-To=%3Caf61d5b5-944b-f9f3-931a-337c36b177d6%40measurement-factory.com%3E"
       TITLE="[squid-users] Speed &#8203;&#8203;limit from file size">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jun 21 16:09:35 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018498.html">[squid-users] Speed &#8203;&#8203;limit from file size
</A></li>
        <LI>Next message (by thread): <A HREF="018502.html">[squid-users] Speed &#8203;&#8203;limit from file size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18500">[ date ]</a>
              <a href="thread.html#18500">[ thread ]</a>
              <a href="subject.html#18500">[ subject ]</a>
              <a href="author.html#18500">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/21/2018 05:11 AM, Michael Pro wrote:
&gt;<i> Simplify the task, let's say that I need to limit the speed only for
</I>&gt;<i> what is in the cache, for each client.
</I>&gt;<i> for this type of traffic is it possible made this logic ?
</I>&gt;<i> file =&lt;1MB client download with 400Kbit/s
</I>&gt;<i> file 1MB...5MB client donload with 4Mbit/s
</I>&gt;<i> file &gt;5MB - no speed limit
</I>
The Content-Length part of my earlier response still applies.

The adaptation parts of my earlier response do not apply to cache hits:
Squid does not support the post-cache RESPMOD vectoring point.

If your use case is limited to cache hits, then modifying Squid to add a
response size-like ACL would be even more tempting because fully cached
hits without a Content-Length header have known (to Squid) sizes. Please
note cache hits that are still in the process of being downloaded (and
cached) may lack the Content-Length header. In that case, those cache
hits will not have a known (to Squid) size.

You could try using client delay pools (see Amos response for details)
but please note that those pools aggregate based on client IP addresses.
If you have many clients with the same source IP address (NAT or a peer
proxy), then this aggregation may present problems.

You may prefer response delay pools, but they are only available in v5:
<A HREF="https://github.com/squid-cache/squid/commit/b27668e">https://github.com/squid-cache/squid/commit/b27668e</A>


Overall, you may be better off redesigning your bandwidth limiting plans
away from &quot;file size&quot; and towards something more directly related to
bandwidth consumption. The further you get from HTTP, the more difficult
mapping your requirements to HTTP tool capabilities becomes...


HTH,

Alex.


&gt;<i> &#1095;&#1090;, 21 &#1080;&#1102;&#1085;. 2018 &#1075;. &#1074; 8:18, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 06/20/2018 01:44 PM, Michael Pro wrote:
</I>&gt;&gt;&gt;<i> Is it possible to limit the speed of receiving the file to the client
</I>&gt;&gt;&gt;<i> depending on the file size?
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Let's say,
</I>&gt;&gt;&gt;<i> file =&lt;1MB client download with 400Kbit/s
</I>&gt;&gt;&gt;<i> file 1MB...5MB client donload with 4Mbit/s
</I>&gt;&gt;&gt;<i> file &gt;5MB - no speed limit
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For HTTP responses with a Content-Length header, you can create poor
</I>&gt;&gt;<i> man's equivalent of a missing response_body_size ACL. For example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   acl smallerThanTenBytes rep_header Content-Length ^[0-9]$
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> With an ACL like that, you can direct responses to the right pool. IIRC,
</I>&gt;&gt;<i> pool assignment may happen multiple times during the lifetime of a
</I>&gt;&gt;<i> transaction so you need to be careful to deal with assignments that are
</I>&gt;&gt;<i> done before there is a response. Delay pools are not my area of
</I>&gt;&gt;<i> expertise but others on the list can help you with the details.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For HTTP responses without a Content-Length header, you can use an
</I>&gt;&gt;<i> adaptation service (ICAP or eCAP) to tag transactions that start to
</I>&gt;&gt;<i> exceed 1MB and 5MB boundaries. A &quot;note&quot; ACL can check for that tag, but
</I>&gt;&gt;<i> I do not think Squid delay pools re-check pool ACLs after the response
</I>&gt;&gt;<i> body bytes start to flow. If I am right, then you would not be able to
</I>&gt;&gt;<i> (re)route response body bytes to the right delay pool for responses
</I>&gt;&gt;<i> without a Content-Length header.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You could use an adaptation service itself to slow responses without
</I>&gt;&gt;<i> Content-Length down (partially duplicating Squid's delay pools
</I>&gt;&gt;<i> capabilities), but the precision of such an approach may be too low due
</I>&gt;&gt;<i> to Squid internal buffering. YMMV.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For HTTP CONNECT tunnels (i.e., HTTPS traffic) even the adaptation
</I>&gt;&gt;<i> tricks would not work because adaptation services do not get CONNECT
</I>&gt;&gt;<i> tunnel bytes (yet?). You would have to bump the tunnel to get access to
</I>&gt;&gt;<i> the HTTP responses inside (and bumping opens another huge Pandora box).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018498.html">[squid-users] Speed &#8203;&#8203;limit from file size
</A></li>
	<LI>Next message (by thread): <A HREF="018502.html">[squid-users] Speed &#8203;&#8203;limit from file size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18500">[ date ]</a>
              <a href="thread.html#18500">[ thread ]</a>
              <a href="subject.html#18500">[ subject ]</a>
              <a href="author.html#18500">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
