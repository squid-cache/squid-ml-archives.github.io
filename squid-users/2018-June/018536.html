<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Splice using SubjectCN/SAN from remote server certificate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Splice%20using%20SubjectCN/SAN%20from%20remote%20server%0A%20certificate&In-Reply-To=%3C18d9100f-7208-7892-5707-936e8a8e46a4%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018529.html">
   <LINK REL="Next"  HREF="018530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Splice using SubjectCN/SAN from remote server certificate</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Splice%20using%20SubjectCN/SAN%20from%20remote%20server%0A%20certificate&In-Reply-To=%3C18d9100f-7208-7892-5707-936e8a8e46a4%40measurement-factory.com%3E"
       TITLE="[squid-users] Splice using SubjectCN/SAN from remote server certificate">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jun 26 17:54:25 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018529.html">[squid-users] Splice using SubjectCN/SAN from remote server certificate
</A></li>
        <LI>Next message (by thread): <A HREF="018530.html">[squid-users] Trust a particular CA only for a limited domain
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18536">[ date ]</a>
              <a href="thread.html#18536">[ thread ]</a>
              <a href="subject.html#18536">[ subject ]</a>
              <a href="author.html#18536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/25/2018 11:42 PM, Ahmad, Sarfaraz wrote:

&gt;<i> we cannot look at the SubjectCN/SAN in the remote server certificate
</I>&gt;<i> and then decide whether we want to splice or bump. (peeking at step 
</I>&gt;<i> 2 really restricts our options) Is my understanding correct ? Or is
</I>&gt;<i> there a way to accomplish this ?
</I>
In some rare cases, it is possible to peek at the server and then bump
the connections: For that to work, Squid must fool OpenSSL into
believing that OpenSSL generated the forwarded ClientHello message. This
requires adjusting internal OpenSSL state. That adjustment is possible
for some OpenSSL versions. Relying on this trick is unsafe because the
server may use a cipher (or another TLS feature) that Squid does not
actually support, precluding bumping.

In most modern scenarios, the adjustment is either impossible or unsafe.
Moderns Squids do not enable this feature by default:

&gt;<i> checking whether hello message can be overwritten in SSL struct... possibly; to try, set SQUID_USE_OPENSSL_HELLO_OVERWRITE_HACK macro value to 1
</I>

Similarly, there are rare cases where it is possible to stare at the
server and then splice the connections. Doing so requires using the same
hack as described above: Squid forwards ClientHello intact while
allowing OpenSSL to later bump the connection because OpenSSL thinks
that it sent that ClientHello.


FWIW, please note that it is not possible to forward a modified
ClientHello and then splice TLS connections. Splicing requires
forwarding intact ClientHello and ServerHello messages because TLS
agents exchange their checksums in the Finished messages.

Also, TLS v1.3 will make most of this irrelevant because it encrypts the
server certificate. You would have to make most of your decisions during
step2.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018529.html">[squid-users] Splice using SubjectCN/SAN from remote server certificate
</A></li>
	<LI>Next message (by thread): <A HREF="018530.html">[squid-users] Trust a particular CA only for a limited domain
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18536">[ date ]</a>
              <a href="thread.html#18536">[ thread ]</a>
              <a href="subject.html#18536">[ subject ]</a>
              <a href="author.html#18536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
