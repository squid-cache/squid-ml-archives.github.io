<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Introduction &amp; Squid ports
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Introduction%20%26%20Squid%20ports&In-Reply-To=%3Cc79e7207-a304-c9c2-031a-a0e44cc3707e%40microlinux.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017759.html">
   <LINK REL="Next"  HREF="017764.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Introduction &amp; Squid ports</H1>
    <B>Nicolas Kovacs</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Introduction%20%26%20Squid%20ports&In-Reply-To=%3Cc79e7207-a304-c9c2-031a-a0e44cc3707e%40microlinux.fr%3E"
       TITLE="[squid-users] Introduction &amp; Squid ports">info at microlinux.fr
       </A><BR>
    <I>Sun Mar 11 07:51:06 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017759.html">[squid-users] PHP: failed to open stream: Cannot connect to HTTPS server through proxy
</A></li>
        <LI>Next message (by thread): <A HREF="017764.html">[squid-users] Introduction &amp; Squid ports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17760">[ date ]</a>
              <a href="thread.html#17760">[ thread ]</a>
              <a href="subject.html#17760">[ subject ]</a>
              <a href="author.html#17760">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm new to this list, so let me introduce myself. I'm a 50-year old
Austrian living in Montpezat (South France), and I'm the manager of a
small IT company with a focus on Linux and free software.

I've been using Squid for a few years, but only as a transparent HTTP
proxy. Here's my blog article (in French) about that configuration on
CentOS 7:

<A HREF="https://blog.microlinux.fr/squid-centos/">https://blog.microlinux.fr/squid-centos/</A>

These last two weeks I've been experimenting quite a lot with using
Squid as a transparent HTTP+HTTPS proxy. I've also written a blog
article about this setup:

<A HREF="https://blog.microlinux.fr/squid-https-centos/">https://blog.microlinux.fr/squid-https-centos/</A>

This configuration is running quite nicely, though I still have to sand
down a few rough edges. I went through quite a lot of trial and error,
using the Squid wiki as well as a handful of tutorials I found on the
Internet.

Here's the section of my squid.conf file defining ports:

--8&lt;-------------------------------------------------------------
# Ports du proxy
http_port 3130
http_port 3128 intercept
https_port 3129 intercept ssl-bump \
  cert=/etc/squid/ssl_cert/amandine.sandbox.lan.pem \
  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
--8&lt;-------------------------------------------------------------

And here's the corresponding section of my firewall script:

--8&lt;-------------------------------------------------------------
# Commandes
IPT=/usr/sbin/iptables
SYS=/usr/sbin/sysctl
SERVICE=/usr/sbin/service

# Internet
IFACE_INET=enp2s0

# R&#233;seau local
IFACE_LAN=virbr0
IFACE_LAN_IP=192.168.2.0/24

# Serveur
SERVER_IP=192.168.2.1

...

# Squid
$IPT -A INPUT -p tcp -i $IFACE_LAN --dport 3128 -j ACCEPT
$IPT -A INPUT -p udp -i $IFACE_LAN --dport 3128 -j ACCEPT
$IPT -A PREROUTING -t nat -i $IFACE_LAN -p tcp ! -d $SERVER_IP \
  --dport 80 -j REDIRECT --to-port 3128
$IPT -A INPUT -p tcp -i $IFACE_LAN --dport 3129 -j ACCEPT
$IPT -A INPUT -p udp -i $IFACE_LAN --dport 3129 -j ACCEPT
$IPT -A PREROUTING -t nat -i $IFACE_LAN -p tcp ! -d $SERVER_IP \
  --dport 443 -j REDIRECT --to-port 3129
$IPT -A INPUT -p tcp -i $IFACE_LAN --dport 3130 -j ACCEPT
$IPT -A INPUT -p udp -i $IFACE_LAN --dport 3130 -j ACCEPT
--8&lt;-------------------------------------------------------------

This configuration works perfectly and gives me no errors or whatsoever,
though I don't quite understand why I need all these ports. When I used
only HTTP, I had this configuration

http_port 3128 transparent

So I wonder why it wasn't possible to have something like this:

http_port 3128 transparent
https_port 3129 transparent ssl-bump

I'm not sure about how the &quot;intercept&quot; mode works. As far as I
understand, connections to port 80 get redirected to port 3128 by the
firewall, but what then? Does &quot;http_port 3128 intercept&quot; mean that Squid
redirects these again and sends them to its internal port 3130?

Similarly, connections to port 443 get redirected to port 3129 by the
firewall, so far so good. But I don't understand how to read &quot;https_port
3129 intercept&quot;. Again, does this mean that Squid redirects these to its
internal port 3130, along with HTTP connections?

In short, my configuration works, but I'd like to get a better grasp on
*how* it works.

Cheers from the sunny South of France,

Niki Kovacs

-- 
Microlinux - Solutions informatiques durables
7, place de l'&#233;glise - 30730 Montpezat
Site : <A HREF="https://www.microlinux.fr">https://www.microlinux.fr</A>
Blog : <A HREF="https://blog.microlinux.fr">https://blog.microlinux.fr</A>
Mail : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at microlinux.fr</A>
T&#233;l. : 04 66 63 10 32

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017759.html">[squid-users] PHP: failed to open stream: Cannot connect to HTTPS server through proxy
</A></li>
	<LI>Next message (by thread): <A HREF="017764.html">[squid-users] Introduction &amp; Squid ports
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17760">[ date ]</a>
              <a href="thread.html#17760">[ thread ]</a>
              <a href="subject.html#17760">[ subject ]</a>
              <a href="author.html#17760">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
