<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Allow some domains to bypass Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Allow%20some%20domains%20to%20bypass%20Squid&In-Reply-To=%3C4081e7fb-2705-726f-1fc9-e68e21eea30c%40microlinux.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017771.html">
   <LINK REL="Next"  HREF="017778.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Allow some domains to bypass Squid</H1>
    <B>Nicolas Kovacs</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Allow%20some%20domains%20to%20bypass%20Squid&In-Reply-To=%3C4081e7fb-2705-726f-1fc9-e68e21eea30c%40microlinux.fr%3E"
       TITLE="[squid-users] Allow some domains to bypass Squid">info at microlinux.fr
       </A><BR>
    <I>Sun Mar 11 10:03:46 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017771.html">[squid-users] Allow some domains to bypass Squid
</A></li>
        <LI>Next message (by thread): <A HREF="017778.html">[squid-users] Allow some domains to bypass Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17766">[ date ]</a>
              <a href="thread.html#17766">[ thread ]</a>
              <a href="subject.html#17766">[ subject ]</a>
              <a href="author.html#17766">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Le 11/03/2018 &#224; 09:24, Amos Jeffries a &#233;crit&#160;:
&gt;<i> What you need to start with is switch your thinking from &quot;domains&quot; to
</I>&gt;<i> considering things in terms of connections and individual servers. Since
</I>&gt;<i> &quot;domain&quot; is a URL concept, and URLs are all hidden inside the encrypted
</I>&gt;<i> part of the traffic there is no knowing what that really is until after
</I>&gt;<i> decryption.
</I>&gt;<i> 
</I>&gt;<i> However when dealing with servers and connections, the connections TLS
</I>&gt;<i> SNI can tell you which *server* a client is connecting to and you can
</I>&gt;<i> decide to do the splice action based on which servers you are having
</I>&gt;<i> trouble with (not domains).
</I>&gt;<i> 
</I>&gt;<i> Or better yet, decide even earlier in your NAT system not to send that
</I>&gt;<i> traffic to the proxy at all.
</I>
I tried to formulate your suggestion in my own words and sent it to the
CentOS mailing list, where I'm a regular, since this seems more to be of
an iptables-related problem (&quot;earlier in the NAT system&quot;).

Here's my message:

--8&lt;---------------------------------------------------------

Hi,

I'm currently facing a quite tricky problem. Here goes.

I have setup Squid as a transparent HTTP+HTTPS proxy in my local
network. All web traffic gets handed over to Squid by an iptables script
on the server. Here's the relevant section in /etc/squid/squid.conf:

--8&lt;-------------------------------------------------------------
# Ports du proxy
http_port 3130
http_port 3128 intercept
https_port 3129 intercept ssl-bump \
  cert=/etc/squid/ssl_cert/amandine.sandbox.lan.pem \
  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
--8&lt;-------------------------------------------------------------

And here's the corresponding section of my firewall script:

--8&lt;-------------------------------------------------------------
# Commandes
IPT=/usr/sbin/iptables
SYS=/usr/sbin/sysctl
SERVICE=/usr/sbin/service

# Internet
IFACE_INET=enp2s0

# R&#233;seau local
IFACE_LAN=virbr0
IFACE_LAN_IP=192.168.2.0/24

# Serveur
SERVER_IP=192.168.2.1

...

# Squid
$IPT -A INPUT -p tcp -i $IFACE_LAN --dport 3128 -j ACCEPT
$IPT -A INPUT -p udp -i $IFACE_LAN --dport 3128 -j ACCEPT
$IPT -A PREROUTING -t nat -i $IFACE_LAN -p tcp ! -d $SERVER_IP \
  --dport 80 -j REDIRECT --to-port 3128
$IPT -A INPUT -p tcp -i $IFACE_LAN --dport 3129 -j ACCEPT
$IPT -A INPUT -p udp -i $IFACE_LAN --dport 3129 -j ACCEPT
$IPT -A PREROUTING -t nat -i $IFACE_LAN -p tcp ! -d $SERVER_IP \
  --dport 443 -j REDIRECT --to-port 3129
$IPT -A INPUT -p tcp -i $IFACE_LAN --dport 3130 -j ACCEPT
$IPT -A INPUT -p udp -i $IFACE_LAN --dport 3130 -j ACCEPT
--8&lt;-------------------------------------------------------------

This setup works nicely for the vast majority of web sites.

BUT: a handful of sites has some trouble with my local certificate. For
example, I can't sync my local Github repo anymore. Or my local OwnCloud
client spews back a warning message on every startup.

I asked on the Squid mailing list if there was a possibility to create
an exception for a list of domains, so that these can simply bypass the
proxy. The problem is, according to one of the developers, I have to
tackle that problem earlier in the process, e. g. in the firewall setup.

So here's what I want to do, in plain words:

1. Redirect all HTTP traffic (port 80) to port 3128. So far so good.

2. Redirect all HTTPS traffic (port 443) to port 3129. Equally OK.

AND...

3. DO NOT REDIRECT traffic that goes to certain domains, like:

  github.com
  credit-cooperatif.coop
  cloud.microlinux.fr
  squid-cache.org
  etc.

Ideally, these domains should be read from a simple text file.

Any idea how I could do that? I don't even know if this is theoretically
possible.

Cheers,

Niki

-- 
Microlinux - Solutions informatiques durables
7, place de l'&#233;glise - 30730 Montpezat
Site : <A HREF="https://www.microlinux.fr">https://www.microlinux.fr</A>
Blog : <A HREF="https://blog.microlinux.fr">https://blog.microlinux.fr</A>
Mail : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at microlinux.fr</A>
T&#233;l. : 04 66 63 10 32

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017771.html">[squid-users] Allow some domains to bypass Squid
</A></li>
	<LI>Next message (by thread): <A HREF="017778.html">[squid-users] Allow some domains to bypass Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17766">[ date ]</a>
              <a href="thread.html#17766">[ thread ]</a>
              <a href="subject.html#17766">[ subject ]</a>
              <a href="author.html#17766">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
