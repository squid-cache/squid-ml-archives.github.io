<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Allow some domains to bypass Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Allow%20some%20domains%20to%20bypass%20Squid&In-Reply-To=%3C15d21273-7c0b-b792-06ef-1444d900866e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017763.html">
   <LINK REL="Next"  HREF="017768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Allow some domains to bypass Squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Allow%20some%20domains%20to%20bypass%20Squid&In-Reply-To=%3C15d21273-7c0b-b792-06ef-1444d900866e%40treenet.co.nz%3E"
       TITLE="[squid-users] Allow some domains to bypass Squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Mar 11 10:17:54 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017763.html">[squid-users] Allow some domains to bypass Squid
</A></li>
        <LI>Next message (by thread): <A HREF="017768.html">[squid-users] Allow some domains to bypass Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17767">[ date ]</a>
              <a href="thread.html#17767">[ thread ]</a>
              <a href="subject.html#17767">[ subject ]</a>
              <a href="author.html#17767">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/18 21:33, Nicolas Kovacs wrote:
&gt;<i> Le 11/03/2018 &#224; 09:24, Amos Jeffries a &#233;crit&#160;:
</I>&gt;&gt;<i> What you need to start with is switch your thinking from &quot;domains&quot; to
</I>&gt;&gt;<i> considering things in terms of connections and individual servers. Since
</I>&gt;&gt;<i> &quot;domain&quot; is a URL concept, and URLs are all hidden inside the encrypted
</I>&gt;&gt;<i> part of the traffic there is no knowing what that really is until after
</I>&gt;&gt;<i> decryption.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However when dealing with servers and connections, the connections TLS
</I>&gt;&gt;<i> SNI can tell you which *server* a client is connecting to and you can
</I>&gt;&gt;<i> decide to do the splice action based on which servers you are having
</I>&gt;&gt;<i> trouble with (not domains).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Or better yet, decide even earlier in your NAT system not to send that
</I>&gt;&gt;<i> traffic to the proxy at all.
</I>&gt;<i> 
</I>&gt;<i> I'm sorry, but I don't understand what you're saying.
</I>&gt;<i> 
</I>
Once the traffic arrives at the proxy it MUST be handled. It is too late
to send it elsewhere.

So to actually bypass the proxy you have to not send the TCP packets to
it at all. But the NAT system only works with raw-IPs.


There are many ways to &quot;handle&quot; traffic though. Rejection is one. When
TLS is involved relaying without doing anything (aka splice) is another.

But TLS is a point-to-point security protocol. Its handshakes are
dealing with origin server names. The domain name is a secondary detail
only sometimes available at all.

see
&lt;<A HREF="https://superuser.com/questions/59093/difference-between-host-name-and-domain-name/59094">https://superuser.com/questions/59093/difference-between-host-name-and-domain-name/59094</A>&gt;



&gt;<i> Here's what I want, It's very simple.
</I>&gt;<i> 
</I>&gt;<i> Create a text file that contains a list of domains. For example:
</I>&gt;<i> 
</I>&gt;<i>   google.com
</I>
Talking this as an example;

&quot;google.com&quot; is the public domain that users enter into their browsers
to view a certain website. The browser than does a lot of stuff, and
eventually contacts one of the origin servers for &quot;google.com&quot;.

But &quot;google.com&quot; is not actually the name for any of those origin
servers. The server names for Google machines are all inside the
*.1e100.net TLD name, and all their machines answer to many different
&quot;domain names&quot; at the HTTP level (gmail.com, google.com, youtube.com,
googlevideo.com, 1e100.net, ... and many others including all the
country-specific ccTLDs variations on those names, and a lot of common
typos eg &quot;gogle.com&quot;).


Your MITM proxy does not receive a URL straight off. It receives a TCP
SYN+ACK packet details. Which contains only the raw-IP for that Google
server. It can lookup the DNS to find out the servers name
 ... something.1e100.net.

If you configured it to handle the TLS handshake (with ssl-bump) it will
receive various representations of that server name in TLS messages.
Which should still be something.1e100.net, usually not &quot;google.com&quot; -
but that depends on whether the client software (Browser or non-Browser)
is properly obeying the requirement that it indicate *server name* in
TLS SNI.
 And also on whether the Google company servers specify the &quot;google.com&quot;
domain as an alias (SubjectAltName) for their TLS certificate from any
particular server (some do, some do not).


All of the above has to happen and be acceptable to the proxy access
controls you have configured before it gets a chance to decrypt the HTTP
message inside the TLS encryption ... and finally find out what URL for
that message is with its domain name.
 Only then can it re-process those access controls for the HTTP(S)
message itself using the actual domain name the client wants.

The above is why we have different &quot;dstdomain&quot; and &quot;ssl::server_name&quot;
ACL types to deal with the different name information available.



&gt;<i>   hotmail.com
</I>&gt;<i>   github.com
</I>&gt;<i>   credit-cooperatif.fr
</I>&gt;<i> 
</I>&gt;<i> And then all connections that go to anyone of these domains don't get
</I>&gt;<i> cached, but simply pass through Squid.
</I>
The process is not getting anywhere close to caching being relevant. The
error you mentioned earlier is in the TLS handshake part of the process.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017763.html">[squid-users] Allow some domains to bypass Squid
</A></li>
	<LI>Next message (by thread): <A HREF="017768.html">[squid-users] Allow some domains to bypass Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17767">[ date ]</a>
              <a href="thread.html#17767">[ thread ]</a>
              <a href="subject.html#17767">[ subject ]</a>
              <a href="author.html#17767">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
