<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Allow some domains to bypass Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Allow%20some%20domains%20to%20bypass%20Squid&In-Reply-To=%3C91ca7fc3-9dd8-ec6b-7adb-c2b86012d1de%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017775.html">
   <LINK REL="Next"  HREF="017771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Allow some domains to bypass Squid</H1>
    <B>Nishant Sharma</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Allow%20some%20domains%20to%20bypass%20Squid&In-Reply-To=%3C91ca7fc3-9dd8-ec6b-7adb-c2b86012d1de%40gmail.com%3E"
       TITLE="[squid-users] Allow some domains to bypass Squid">codemarauder at gmail.com
       </A><BR>
    <I>Mon Mar 12 06:01:56 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017775.html">[squid-users] Allow some domains to bypass Squid
</A></li>
        <LI>Next message (by thread): <A HREF="017771.html">[squid-users] Allow some domains to bypass Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17779">[ date ]</a>
              <a href="thread.html#17779">[ thread ]</a>
              <a href="subject.html#17779">[ subject ]</a>
              <a href="author.html#17779">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Nicolas,

On Sunday 11 March 2018 05:35 PM, Nicolas Kovacs wrote:
&gt;<i> Le 11/03/2018 &#224; 12:31, Amos Jeffries a &#233;crit&#160;:
</I>&gt;<i> OK, I got something that's starting to work.
</I>&gt;<i> 
</I>&gt;<i> # Exceptions
</I>&gt;<i> EXCEPTIONS=$(egrep -v '(^\#)|(^\s+$)' /usr/local/sbin/no-proxy.txt)
</I>&gt;<i> for EXCEPTION in $EXCEPTIONS; do
</I>&gt;<i>    $IPT -A PREROUTING -t nat -i $IFACE_LAN -d $EXCEPTION -j ACCEPT
</I>&gt;<i> done
</I>
The problem with this approach might be that domains are looked up for 
their IPs at the time of rule creation and not at the time of request. 
Since destinations like github.com, google.com, facebook etc use many 
large pools of IPs, your rule might not match later in the day or after 
a few days.

Better to use &quot;ipset&quot; along with dnsmasq and refer that ipset in the 
iptables rule to match dst.

1. ipset create _ipsetname_ bitmap:ip

2. Configure dnsmasq to populate _ipsetname_ by adding following lines 
for each domain to dnsmasq.conf:

ipset=/google.com/_ipsetname_
ipset=/github.com/_ipsetname_
...
...

3. Use dnsmasq as resolver-cache on your proxy machine and ensure that 
squid uses your dnsmasq for DNS queries.

4. Add intercept iptables rules to not NAT the traffic  to destination 
ipset:

iptables -A PREROUTING -t nat -i $IFACE_LAN -m set --match-set 
_ipsetname_ dst -j ACCEPT

Dnsmasq will keep populating the ipset as and when a resolution request 
is received for the matched domains. An ipset can hold 65534 entries.

I use this approach extensively to allow Anti-Virus and Windows updates 
to the machines which otherwise are not allowed to access Internet 
directly without configuring explicit proxy or through proxy.pac/wpad.

Regards,
Nishant

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017775.html">[squid-users] Allow some domains to bypass Squid
</A></li>
	<LI>Next message (by thread): <A HREF="017771.html">[squid-users] Allow some domains to bypass Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17779">[ date ]</a>
              <a href="thread.html#17779">[ thread ]</a>
              <a href="subject.html#17779">[ subject ]</a>
              <a href="author.html#17779">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
