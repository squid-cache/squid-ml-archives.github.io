<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL intercept in explicit mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20intercept%20in%20explicit%20mode&In-Reply-To=%3Cf6a85fc5-50a3-9372-b487-72d8d42122fe%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017808.html">
   <LINK REL="Next"  HREF="017810.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL intercept in explicit mode</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20intercept%20in%20explicit%20mode&In-Reply-To=%3Cf6a85fc5-50a3-9372-b487-72d8d42122fe%40gmail.com%3E"
       TITLE="[squid-users] SSL intercept in explicit mode">yvoinov at gmail.com
       </A><BR>
    <I>Tue Mar 13 17:44:41 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017808.html">[squid-users] SSL intercept in explicit mode
</A></li>
        <LI>Next message (by thread): <A HREF="017810.html">[squid-users] SSL intercept in explicit mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17809">[ date ]</a>
              <a href="thread.html#17809">[ thread ]</a>
              <a href="subject.html#17809">[ subject ]</a>
              <a href="author.html#17809">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>AFAIK,

SSL bump subsystem uses OpenSSL memory routines. So, first of all, most
probably leaks (if any) can be OpenSSL-related, but not squid itself.

Now let's see your config snippets.

13.03.2018 23:00, Aaron Turner &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> &quot;Usually misconfiguration leads to memory overhead.&quot;
</I>&gt;<i>
</I>&gt;<i> This may be true, but if you look in the list archives a few months
</I>&gt;<i> ago I basically chased my tail in circles and nobody could tell me
</I>&gt;<i> what I was doing wrong and so many of the docs are so old that they're
</I>&gt;<i> worse then useless, they seem to suggest the wrong thing.
</I>&gt;<i>
</I>&gt;<i> It was literally leaking GB's worth of RAM.  I even disabled all
</I>&gt;<i> caching and process sizes were growing into the GB's.  Turn off
</I>&gt;<i> ssl-bump and the leak went away.
</I>&gt;<i>
</I>&gt;<i> This is what I was using:
</I>&gt;<i>
</I>&gt;<i> http_port 10.0.0.1:3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=400MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> sslflags=NO_DEFAULT_CA
</I>&gt;<i> http_port localhost:3128
</I>&gt;<i> ssl_bump bump all
</I>bump all is useless without peek/splice.

Let's see on my config snippets:

https_port 3127 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=10MB cert=/usr/local/squid/etc/rootCA2.crt
key=/usr/local/squid/etc/rootCA2.key
tls-cafile=/usr/local/squid/etc/rootCA12.crt
options=SINGLE_DH_USE:SINGLE_ECDH_USE
tls-dh=secp384r1:/usr/local/squid/etc/dhparam.pem
cipher=HIGH:MEDIUM:RC4:3DES:!aNULL:!eNULL:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS
tls-no-npn sslflags=NO_DEFAULT_CA:VERIFY_CRL_ALL
http_port 3128 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=10MB cert=/usr/local/squid/etc/rootCA2.crt
key=/usr/local/squid/etc/rootCA2.key
tls-cafile=/usr/local/squid/etc/rootCA12.crt
options=SINGLE_DH_USE:SINGLE_ECDH_USE
tls-dh=secp384r1:/usr/local/squid/etc/dhparam.pem
cipher=HIGH:MEDIUM:RC4:3DES:!aNULL:!eNULL:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS
tls-no-npn sslflags=NO_DEFAULT_CA:VERIFY_CRL_ALL
tls_outgoing_options cafile=/usr/local/squid/etc/ca-bundle.crt
cipher=HIGH:MEDIUM:RC4:3DES:!aNULL:!eNULL:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS
# Cert database on ramdisk
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
/ramdisk1/ssl_db -M 1GB
sslcrtd_children 32 startup=10 idle=5

# SSL bump rules
acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex
&quot;/usr/local/squid/etc/acl.url.nobump&quot;
ssl_bump peek DiscoverSNIHost
ssl_bump splice NoSSLIntercept
ssl_bump bump all

&gt;<i>
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 32 startup=2 idle=2
</I>This is defaults. Pay attention, -M is limits use ssl_db directory to 4
Mb in size. It's too few for production servers. My ramdisk for ssl db
is 1+ Gb in size:

/dev/ramdisk/ramdisk1&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 961M&#160;&#160; 14M&#160; 890M&#160;&#160; 2% /ramdisk1/ssl_db

&gt;<i> sslproxy_session_cache_size 100 MB
</I>This is disbalanced size instead of previous setting. Why so big?

#&#160; TAG: sslproxy_session_cache_size
#&#160;&#160;&#160;&#160;&#160;&#160;&#160; Sets the cache size to use for ssl session
#Default:
# sslproxy_session_cache_size 2 MB

&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>*NEVER use this options. It is unsafe.

SSL Bump is dangerous enough itself. Don't do it more unsafe
additionally by yourself.
*
&gt;<i>
</I>&gt;<i> This was on a machine (EC2 VM) with 14GB of RAM.
</I>Pay attention on several places:

1. OS memory allocator.
2. OpenSSL version.
3. OS configuration (IPC, shared memory, swap - all memory related).
4. Squid's memory/pools configuration.

Don't forget about: Often memory fragmentation seems like leaks. But no
leaks occurs indeed.

Also, don't forget - squid's memory consumption is not only cache_mem,
but also caching on-disk metadata (swap.state), pools settings, working
memory areas, processes memory. And - also - such things like content
adaptation (did you know wide uses ecap gzip adapter is leaky itself?).

But this is just for example.

In any case, dig to the OpenSSL/OS side. Squid's memory in most cases is ok.

I know, this appears SSL Bump is leaky. But this is not correct.
&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Aaron Turner
</I>&gt;<i> <A HREF="https://synfin.net/">https://synfin.net/</A>         Twitter: @synfinatic
</I>&gt;<i> My father once told me that respect for the truth comes close to being
</I>&gt;<i> the basis for all morality.  &quot;Something cannot emerge from nothing,&quot;
</I>&gt;<i> he said.  This is profound thinking if you understand how unstable
</I>&gt;<i> &quot;the truth&quot; can be.  -- Frank Herbert, Dune
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, Mar 13, 2018 at 9:47 AM, Yuri &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> I've used it on all versions starting from 3.4.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now I'm using Squid 5.0.0.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm afraid, my config is completely useless, because of it contains tons
</I>&gt;&gt;<i> of optimizations/tweaks/tricks and designed for customized Squid 5.0.0,
</I>&gt;&gt;<i> with different memory allocator for custom infrastructure.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can't just take my config, implement it and hope it will give same
</I>&gt;&gt;<i> results for you.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At least, it uses non-system CA bundle, platform-specific configuration
</I>&gt;&gt;<i> parameters combinations, etc.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can say, than SSL Bump is not directly related to memory leaks. Squid
</I>&gt;&gt;<i> itself almost not contains memory leaks now. Usually misconfiguration
</I>&gt;&gt;<i> leads to memory overhead.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As a recommendation, I can give some advices.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Use server with enough RAM. 4 Gb usually enough just for default
</I>&gt;&gt;<i> squid configuration. Usually whole system RAM usage should never be
</I>&gt;&gt;<i> bigger than 1/2 of overall physical RAM. (I.e. at least 1/3 of RAM
</I>&gt;&gt;<i> should always be free during normal running. This prevents OS allocator
</I>&gt;&gt;<i> pressure to your proxy and, also, increasing performance of proxy). In
</I>&gt;&gt;<i> case of medium proxy server 16 Gb of RAM seems big enough, but never try
</I>&gt;&gt;<i> to fill it up completely.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Don't set giant cache_mem. Remember how you platform allocates whole
</I>&gt;&gt;<i> RAM - kernel, anon pages, fs caches, etc. - and use reasonable squid's
</I>&gt;&gt;<i> memory-related settings.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3. Use sslflags=NO_DEFAULT_CA with your SSL Bump ports.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4. Never remember - SSL Bump increases your cache memory pressure due to
</I>&gt;&gt;<i> increasing caching. So, you still require to have enough memory in your
</I>&gt;&gt;<i> system.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 13.03.2018 22:25, Aaron Turner &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;<i> What version are you using Yuri?  Can you share your config?
</I>&gt;&gt;&gt;<i> Everytime I use ssl bump, I have massive memory leaks.  It's been
</I>&gt;&gt;&gt;<i> effectively unusable for me.
</I>&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;<i> Aaron Turner
</I>&gt;&gt;&gt;<i> <A HREF="https://synfin.net/">https://synfin.net/</A>         Twitter: @synfinatic
</I>&gt;&gt;&gt;<i> My father once told me that respect for the truth comes close to being
</I>&gt;&gt;&gt;<i> the basis for all morality.  &quot;Something cannot emerge from nothing,&quot;
</I>&gt;&gt;&gt;<i> he said.  This is profound thinking if you understand how unstable
</I>&gt;&gt;&gt;<i> &quot;the truth&quot; can be.  -- Frank Herbert, Dune
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Tue, Mar 13, 2018 at 9:10 AM, Yuri &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvoinov at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> Moreover,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> SSL Bump combines with interception/explicit proxy in one setup.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> And works perfectly.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 13.03.2018 21:14, Marcus Kool &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;SSL bump&quot; is the name of a complex Squid feature.
</I>&gt;&gt;&gt;&gt;&gt;<i> With ssl_bump ACLs one can decide which domains can be 'spliced' (go
</I>&gt;&gt;&gt;&gt;&gt;<i> through the proxy untouched) or can be 'bumped' (decrypted).
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Interception is not a requirement for SSL bump.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Marcus
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 13/03/18 11:44, Danilo V wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I mean SSL bump in explicit mode.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> So intercept is a essencial requirement for running SSL bump?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Em ter, 13 de mar de 2018 &#224;s 11:10, Matus UHLAR - fantomas
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A>&gt;&gt; escreveu:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     On 13.03.18 13:44, Danilo V wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>      &gt;Is it possible/feasible to configure squid in explicit mode
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> with ssl
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>      &gt;intercept?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     explicit is not intercept, intercept is not explicit.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     explicit is where browser is configured (manually or
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> automatically via WPAD)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     to use the proxy.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     intercept is where network device forcifully redirects http/https
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> connections
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     to the proxy.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     maybe you mean SSL bump in explicit mode?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>      &gt;Due to architecture of my network it is not possible to implement
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>      &gt;transparent proxy.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     excuse me?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     by &quot;transparent&quot; people mean what we usually call &quot;intercept&quot;.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>      &gt;What would be the behavior of applications that dont support
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> proxy - i.e.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>      &gt;dont forward requests to proxy?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     they mest be intercepted.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     --
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A>&gt; ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     Warning: I wish NOT to receive e-mail advertising to this address.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     Micro$oft random number generator: 0, 0, 0, 4.33e+67, 0, 0, 0...
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;&gt;<i> &quot;C++ seems like a language suitable for firing other people's legs.&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> *****************************
</I>&gt;&gt;&gt;&gt;<i> * C++20 : Bug to the future *
</I>&gt;&gt;&gt;&gt;<i> *****************************
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> &quot;C++ seems like a language suitable for firing other people's legs.&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *****************************
</I>&gt;&gt;<i> * C++20 : Bug to the future *
</I>&gt;&gt;<i> *****************************
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>
-- 
&quot;C++ seems like a language suitable for firing other people's legs.&quot;

*****************************
* C++20 : Bug to the future *
*****************************

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180313/d0312fc9/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180313/d0312fc9/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 659 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180313/d0312fc9/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180313/d0312fc9/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017808.html">[squid-users] SSL intercept in explicit mode
</A></li>
	<LI>Next message (by thread): <A HREF="017810.html">[squid-users] SSL intercept in explicit mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17809">[ date ]</a>
              <a href="thread.html#17809">[ thread ]</a>
              <a href="subject.html#17809">[ subject ]</a>
              <a href="author.html#17809">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
