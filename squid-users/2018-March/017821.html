<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid + SquidGuard : static block page not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20SquidGuard%20%3A%20static%20block%20page%20not%20working&In-Reply-To=%3C8194858d-1f1f-f02f-bc72-a32d5f348c68%40microlinux.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017820.html">
   <LINK REL="Next"  HREF="017822.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid + SquidGuard : static block page not working</H1>
    <B>Nicolas Kovacs</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20SquidGuard%20%3A%20static%20block%20page%20not%20working&In-Reply-To=%3C8194858d-1f1f-f02f-bc72-a32d5f348c68%40microlinux.fr%3E"
       TITLE="[squid-users] Squid + SquidGuard : static block page not working">info at microlinux.fr
       </A><BR>
    <I>Wed Mar 14 12:43:41 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017820.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
        <LI>Next message (by thread): <A HREF="017822.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17821">[ date ]</a>
              <a href="thread.html#17821">[ thread ]</a>
              <a href="subject.html#17821">[ subject ]</a>
              <a href="author.html#17821">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Le 14/03/2018 &#224; 13:39, Nicolas Kovacs a &#233;crit&#160;:
&gt;<i> Yes, I do. Because this is part of a step-by-step course about
</I>&gt;<i> SquidGuard, which worked perfectly under Slackware Linux. And my
</I>&gt;<i> filtering rules are becoming increasingly complex.
</I>
FYI, this is the course. It's a HOWTO in simple text format.

I'm currently trying to adapt this to CentOS 7.

Niki

-- 
Microlinux - Solutions informatiques durables
7, place de l'&#233;glise - 30730 Montpezat
Site : <A HREF="https://www.microlinux.fr">https://www.microlinux.fr</A>
Blog : <A HREF="https://blog.microlinux.fr">https://blog.microlinux.fr</A>
Mail : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at microlinux.fr</A>
T&#233;l. : 04 66 63 10 32
-------------- next part --------------
================
SquidGuard HOWTO (c) Nicolas Kovacs &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at microlinux.fr</A>&gt;
================

Derni&#232;re r&#233;vision : 5 mai 2015

Ce HOWTO d&#233;crit la mise en place du redirecteur SquidGuard pour un serveur
proxy Squid sous Slackware.

  * G&#233;n&#233;ralit&#233;s et pr&#233;requis
  * Installation
  * La page explicative
  * Une redirection simple
  * R&#233;cup&#233;rer les listes noires et blanches
  * Un filtre simple pour contenus probl&#233;matiques
  * Automatiser les op&#233;rations


G&#233;n&#233;ralit&#233;s et pr&#233;requis
------------------------

SquidGuard est un plug-in pour Squid. On doit donc disposer d'une installation
fonctionnelle de ce dernier.


Installation
------------

Installer le paquet 'squidGuard' depuis le d&#233;p&#244;t de paquets MLES.


La page explicative
-------------------

Lorsque SquidGuard refuse l'acc&#232;s &#224; une page, c'est toujours une bonne id&#233;e
d'expliquer les raisons de ce refus aux utilisateurs. Pour commencer, on va
donc mettre en place une page d'avertissement, qui sera h&#233;berg&#233;e sur le
serveur lui-m&#234;me. 

Le r&#233;pertoire 'template/squidguard/html/' propose un mod&#232;le de page
explicative.

Pour la configuration d'une page web locale, voir le Apache-HOWTO.


Une redirection simple
----------------------

Nous n'avons pas encore de listes noires et blanches ni de base de donn&#233;es,
mais nous pouvons d&#233;j&#224; faire un premier test de redirection :

  1. la machine 192.168.2.2 n'est pas filtr&#233;e

  2. toutes les autres machines du r&#233;seau local sont bloqu&#233;es

SquidGuard se configure par le biais du fichier de configuration
'/etc/squidguard/squidguard.conf'. Sauvegardez le fichier de configuration
d'origine :

  # cd /etc/squidguard
  # mv squidguard.conf squidguard.conf.orig

&#201;ditez un fichier de configuration minimal comme ceci :

--8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
dbhome /var/lib/squidguard
logdir /var/log/squidguard

src admin {
  ip 192.168.2.2
}

acl {
  admin {
    pass any
  }
  default {
    pass none
    redirect <A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A>
  }
}
--8&lt;--------------------------------------------------------------------------

  &gt; La directive 'dbhome' indique &#224; SquidGuard o&#249; trouver la base de donn&#233;es
    des listes (que nous n'avons pas encore).

  &gt; La directive 'logdir' sp&#233;cifie l'endroit o&#249; l'on d&#233;sire r&#233;cup&#233;rer les
    logs.

  &gt; Les sources d&#233;finissent les groupes de clients. Ici, nous d&#233;finissons une
    seule adresse IP.

  &gt; Les 'acl' ou &quot;Access Control Lists&quot; permettent de d&#233;finir quelle source
    peut aller ou ne pas aller vers quelle(s) destination(s). 

  &gt; Lorsqu'une destination n'est pas autoris&#233;e, la directive 'redirect' permet
    de servir une page explicative au client. 

&#192; pr&#233;sent, il faut configurer Squid pour qu'il utilise SquidGuard. &#201;diter le
fichier '/etc/squid/squid.conf' et ajouter cette stance &#224; la fin du fichier :

--8&lt;---------- /etc/squid/squid.conf -----------------------------------------
url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidguard.conf
url_rewrite_children 5
--8&lt;--------------------------------------------------------------------------

Recharger la configuration de Squid :

  # /etc/rc.d/rc.squid reload

V&#233;rifier si la modification a bien &#233;t&#233; prise en compte :

  # ps aux | grep squid | grep -v grep
  root      5043  ...  /usr/sbin/squid -F
  nobody    5045  ...  (squid) -F
  nobody    5068  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
  nobody    5069  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
  nobody    5070  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
  nobody    5071  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
  nobody    5072  ...  (squidGuard) -c /etc/squidguard/squidguard.conf

Maintenant, on peut essayer de naviguer sur Internet :

  1. avec la machine 192.168.2.2

  2. avec une machine dont l'adresse IP n'est pas 192.168.2.2


R&#233;cup&#233;rer les listes noires et blanches
---------------------------------------

Dans les exemples pr&#233;sent&#233;s ci-dessous, nous utiliserons les listes noires et
blanches maintenues par le Centre de Ressources Informatiques de l'Universit&#233;
de Toulouse. Ces listes ne font pas partie de SquidGuard. On peut les
r&#233;cup&#233;rer manuellement comme ceci :
  
  # cd /var/lib/squidguard
  # wget -c <A HREF="ftp://ftp.ut-capitole.fr/blacklist/blacklists.tar.gz">ftp://ftp.ut-capitole.fr/blacklist/blacklists.tar.gz</A>
  # tar xvzf blacklists.tar.gz
  # cd blacklists

Chacun des r&#233;pertoires correspond &#224; une cat&#233;gorie (ou &quot;destination&quot;) du Web :

  # ls -l | awk '{print $9, $10, $11}'
  ads -&gt; publicite
  adult  
  aggressive -&gt; agressif
  agressif  
  arjel  
  astrology  
  audio-video  
  bank  
  bitcoin  
  blog  
  cc-by-sa-4-0.pdf  
  celebrity  
  chat  
  child  
  cleaning  
  cooking  
  dangerous_material  
  dating  
  drogue  
  drugs -&gt; drogue
  educational_games  
  filehosting  
  financial  
  forums  
  gambling  
  games  
  global_usage  
  hacking  
  jobsearch  
  ...

On peut &#233;galement r&#233;cup&#233;rer les listes avec l'outil 'rsync'. Cette m&#233;thode est
m&#234;me recommand&#233;e, &#233;tant donn&#233; que 'rsync' ne t&#233;l&#233;chargera que la diff&#233;rence
entre les arborescences distante et locale lors d'une mise &#224; jour :

  # cd /var/lib/squidguard
  # rm -rf blacklists*
  # rsync -rv <A HREF="rsync://ftp.ut-capitole.fr/blacklist/">rsync://ftp.ut-capitole.fr/blacklist/</A> .
  # cd dest

La seule diff&#233;rence par rapport au t&#233;l&#233;chargement avec 'wget', c'est que nous
retrouvons nos destinations dans un r&#233;pertoire 'dest/' et non 'blacklists/'.

Rep&#233;rez le fichier 'global_usage' et jetez un oeil dedans. Il s'agit d'un
fichier explicatif sur le contenu des listes.


Un filtre simple pour contenus probl&#233;matiques
---------------------------------------------

Dans ce deuxi&#232;me exemple, nous allons filtrer les sites &#224; contenu
manifestement probl&#233;matique (porno, violence, drogues) pour toutes les
machines du r&#233;seau local. 

Dans un premier temps, nous allons adapter la directive 'dbhome' &#224; ce que nous
venons de t&#233;l&#233;charger un peu plus haut :

--8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
dbhome /var/lib/squidguard/dest
logdir /var/log/squidguard
...
--8&lt;--------------------------------------------------------------------------

Les sources sont l&#224; pour sp&#233;cifier les groupes de clients. Nous allons d&#233;finir
tout le r&#233;seau local &quot;&#224; la louche&quot; :

--8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
...
src microlinux {
  ip 192.168.2.0/24
}
--8&lt;--------------------------------------------------------------------------

Les destinations d&#233;finissent des ensembles de domaines, d'URL ou d'expressions
r&#233;guli&#232;res &#224; appliquer aux URLs. Ici, nous allons d&#233;finir trois destinations :

--8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
...
# Des sites adultes allant de l'&#233;rotique &#224; la pornographie dure
destination adult {
  domainlist adult/domains
  urllist adult/urls
  log adult
}

# Quelques sites racistes, antis&#233;mites et incitant &#224; la haine
destination agressif {
  domainlist agressif/domains
  urllist agressif/urls
  log agressif
}

# Drogues
destination drogue {
  domainlist drogue/domains
  urllist drogue/urls
  log drogue
}
--8&lt;--------------------------------------------------------------------------

Les ACLs (&quot;Access Control Lists&quot;) permettent de d&#233;finir quelle source peut
aller ou ne pas aller vers quelle destination :

--8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
...
acl {
  microlinux {
    pass !adult
    pass !agressif
    pass !drogue
    redirect <A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A>
  }
  default {
    pass none
    redirect <A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A>
  }
}
--8&lt;--------------------------------------------------------------------------

  &gt; Le point d'exclamation '!' &#233;quivaut &#224; une n&#233;gation.

Au total, notre configuration ressemblera donc &#224; ceci :

--8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
dbhome /var/lib/squidguard/dest
logdir /var/log/squidguard

src microlinux {
  ip 192.168.2.0/24
}

# Des sites adultes allant de l'&#233;rotique &#224; la pornographie dure
destination adult {
  domainlist adult/domains
  urllist adult/urls
  log adult
}

# Quelques sites racistes, antis&#233;mites et incitant &#224; la haine
destination agressif {
  domainlist agressif/domains
  urllist agressif/urls
  log agressif
}

# Drogues
destination drogue {
  domainlist drogue/domains
  urllist drogue/urls
  log drogue
}

acl {
  microlinux {
    pass !adult
    pass !agressif
    pass !drogue
    redirect <A HREF="http://squidguard.amandine/avertissement.html">http://squidguard.amandine/avertissement.html</A>
  }
  default {
    pass none
    redirect <A HREF="http://squidguard.amandine/avertissement.html">http://squidguard.amandine/avertissement.html</A>
  }
}
--8&lt;--------------------------------------------------------------------------

Avant d'aller plus loin, nous devons r&#233;gler quelques permissions.
Rappelons-nous que le proxy cache Squid tourne avec les droits de
l'utilisateur 'nobody' et du groupe 'nobody' :

--8&lt;---------- /etc/squid/squid.conf -----------------------------------------
...
cache_effective_user nobody
cache_effective_group nobody
...
--8&lt;--------------------------------------------------------------------------

L'arborescence '/var/lib/squidguard' doit &#234;tre accessible en lecture/&#233;criture
pour Squid :

  # chown -R nobody:nobody /var/lib/squidguard/
  # ls -ld /var/lib/squidguard/
  drwxr-xr-x 3 nobody nobody 4096 nov.   2 08:56 /var/lib/squidguard/

Au cas o&#249; le r&#233;pertoire des logs n'existe pas, il faut le cr&#233;er :

  # mkdir -v /var/log/squidguard
  mkdir: cr&#233;ation du r&#233;pertoire &#171;&#160;/var/log/squidguard&#160;&#187;

L&#224; aussi, il faut ajuster les permissions :

  # chown -R nobody:nobody /var/log/squidguard/
  # ls -ld /var/log/squidguard/
  drwxr-xr-x 2 nobody nobody 4096 nov.   2 11:08 /var/log/squidguard/

Pour pouvoir fonctionner rapidement, SquidGuard n'utilise pas les fichiers
texte, mais des bases de donn&#233;es au format Berkeley. Ces bases de donn&#233;es
n'existent pas encore, et nous devons les construire :

  # squidGuard -C all

Si tout s'est bien pass&#233;, on obtient quelque chose comme ceci :

  # cat /var/log/squidguard/squidGuard.log 
  2014-11-02 11:09:39 [3897] New setting: dbhome: /var/lib/squidguard/dest
  2014-11-02 11:09:39 [3897] New setting: logdir: /var/log/squidguard
  2014-11-02 11:09:39 [3897] init domainlist
  /var/lib/squidguard/dest/adult/domains
  2014-11-02 11:09:52 [3897] create new dbfile
  /var/lib/squidguard/dest/adult/domains.db
  2014-11-02 11:09:53 [3897] init urllist /var/lib/squidguard/dest/adult/urls
  2014-11-02 11:09:53 [3897] create new dbfile
  /var/lib/squidguard/dest/adult/urls.db
  2014-11-02 11:09:54 [3897] init domainlist
  /var/lib/squidguard/dest/agressif/domains
  2014-11-02 11:09:54 [3897] create new dbfile
  /var/lib/squidguard/dest/agressif/domains.db
  2014-11-02 11:09:54 [3897] init urllist /var/lib/squidguard/dest/agressif/urls
  2014-11-02 11:09:54 [3897] create new dbfile
  /var/lib/squidguard/dest/agressif/urls.db
  2014-11-02 11:09:54 [3897] init domainlist
  /var/lib/squidguard/dest/drogue/domains
  2014-11-02 11:09:54 [3897] create new dbfile
  /var/lib/squidguard/dest/drogue/domains.db
  2014-11-02 11:09:54 [3897] init urllist /var/lib/squidguard/dest/drogue/urls
  2014-11-02 11:09:54 [3897] create new dbfile
  /var/lib/squidguard/dest/drogue/urls.db
  2014-11-02 11:09:54 [3897] squidGuard 1.4 started (1414922979.731)
  2014-11-02 11:09:54 [3897] db update done
  2014-11-02 11:09:54 [3897] squidGuard stopped (1414922994.459)

Quelques mises en garde s'imposent ici :

  1. SquidGuard est une application assez pointue, pour ne pas dire une
  v&#233;ritable usine &#224; gaz. La moindre faute de frappe dans un des fichiers de
  configuration se solde g&#233;n&#233;ralement par un &#233;chec. Il est donc n&#233;cessaire de
  porter une grande attention &#224; la syntaxe. 

  2. Les bases de donn&#233;es (fichiers '*.db' en-dessous de l'arborescence
  '/var/lib/squidguard/dest/') doivent &#234;tre construites *apr&#232;s* avoir &#233;crit le
  fichier de configuration, car seules les destinations d&#233;finies dans ce
  fichier seront compil&#233;es. Autrement dit, si vous devez ajouter une
  destination par la suite (malware, tricheur, etc.) il va falloir penser &#224;
  compiler les bases de donn&#233;es correspondantes.

  3. En r&#232;gle g&#233;n&#233;rale, &#231;a ne fonctionne que rarement du premier coup. Dans ce
  cas, jetez un oeil dans les logs, notamment 'squidGuard.log'. Ce dernier
  vous sera d'un grand secours, car il vous avertira de tous les probl&#232;mes de
  configuration.

&#201;tant donn&#233; que la commande 'squidGuard -C all' a &#233;t&#233; invoqu&#233;e par root, les
fichiers g&#233;n&#233;r&#233;s par cette commande appartiennent &#224; ce dernier :

  # ls -l /var/lib/squidguard/dest/adult/
  total 66704
  -rw-r--r-- 1 nobody nobody 17977204 nov.   1 11:02 domains
  -rw-r--r-- 1 root   root   44773376 nov.   2 11:09 domains.db
  -rw-r--r-- 1 nobody nobody        0 nov.   1 11:02 expressions
  -rw-r--r-- 1 nobody nobody  1959494 nov.   1 11:02 urls
  -rw-r--r-- 1 root   root    3584000 nov.   2 11:09 urls.db
  -rw-r--r-- 1 nobody nobody       17 nov.   1 11:02 usage
  ...
  # ls -l /var/log/squidguard/
  total 4
  -rw-r--r-- 1 root root    0 nov.   2 11:09 adult
  -rw-r--r-- 1 root root    0 nov.   2 11:09 agressif
  -rw-r--r-- 1 root root    0 nov.   2 11:09 drogue
  -rw-r--r-- 1 root root 1316 nov.   2 11:09 squidGuard.log

On va donc devoir rectifier le tir une deuxi&#232;me fois pour les permissions :

  # chown -R nobody:nobody /var/lib/squidguard/
  # chown -R nobody:nobody /var/log/squidguard/

Recharger la configuration :

  # /etc/rc.d/rc.squid reload

&#192; pr&#233;sent, naviguer sur le Web et tester le filtrage de quelques sites
potentiellement probl&#233;matiques :

  * <A HREF="http://www.nichons.com">http://www.nichons.com</A>

  * <A HREF="http://www.whitehonor.com">http://www.whitehonor.com</A>

  * <A HREF="http://www.cannabizz.com">http://www.cannabizz.com</A>

Si tout se passe bien, les pages ne s'affichent pas, et l'utilisateur se
trouve confront&#233; &#224; la page explicative. Non content de cela, sa tentative est
enregistr&#233;e dans le fichier log correspondant &#224; la cat&#233;gorie de site prohib&#233;,
par exemple :

  # tail -f /var/log/squidguard/adult
  2014-11-02 11:28:42 ... <A HREF="http://www.nichons.com/">http://www.nichons.com/</A> 192.168.2.3/- - GET REDIRECT
  2014-11-02 11:28:42 ... <A HREF="http://www.nichons.com/favicon.ico">http://www.nichons.com/favicon.ico</A> 192.168.2.3/- ...
  2014-11-02 11:28:42 ... <A HREF="http://www.nichons.com/favicon.ico">http://www.nichons.com/favicon.ico</A> 192.168.2.3/- ...


Automatiser les op&#233;rations
--------------------------

Je fournis un script 'blacklist.sh' dans le r&#233;pertoire 'template/squidguard/',
qui automatise la plupart des t&#226;ches r&#233;p&#233;titives. Copier ce script dans un
endroit appropri&#233;, par exemple '/usr/local/sbin/', et le rendre ex&#233;cutable. Il
se charge de :

  1. r&#233;cup&#233;rer les listes noires et blanches

  2. mettre &#224; jour les listes d&#233;j&#224; t&#233;l&#233;charg&#233;es

  3. construire les bases de donn&#233;es Berkeley

  4. rectifier les permissions

  5. relancer Squid pour prendre en compte les modifications


------------------------------------------------------------------------------
# vim: syntax=txt
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017820.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
	<LI>Next message (by thread): <A HREF="017822.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17821">[ date ]</a>
              <a href="thread.html#17821">[ thread ]</a>
              <a href="subject.html#17821">[ subject ]</a>
              <a href="author.html#17821">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
