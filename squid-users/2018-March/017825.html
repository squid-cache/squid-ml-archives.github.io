<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid + SquidGuard : static block page not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20SquidGuard%20%3A%20static%20block%20page%20not%20working&In-Reply-To=%3C77404db1-0dd0-dd95-9588-2e2aeaa50b12%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017842.html">
   <LINK REL="Next"  HREF="017826.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid + SquidGuard : static block page not working</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%2B%20SquidGuard%20%3A%20static%20block%20page%20not%20working&In-Reply-To=%3C77404db1-0dd0-dd95-9588-2e2aeaa50b12%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid + SquidGuard : static block page not working">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Mar 14 13:42:16 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017842.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
        <LI>Next message (by thread): <A HREF="017826.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17825">[ date ]</a>
              <a href="thread.html#17825">[ thread ]</a>
              <a href="subject.html#17825">[ subject ]</a>
              <a href="author.html#17825">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/03/18 01:43, Nicolas Kovacs wrote:
&gt;<i> Le 14/03/2018 &#224; 13:39, Nicolas Kovacs a &#233;crit&#160;:
</I>&gt;&gt;<i> Yes, I do. Because this is part of a step-by-step course about
</I>&gt;&gt;<i> SquidGuard, which worked perfectly under Slackware Linux. And my
</I>&gt;&gt;<i> filtering rules are becoming increasingly complex.
</I>&gt;<i> FYI, this is the course. It's a HOWTO in simple text format.
</I>&gt;<i> 
</I>&gt;<i> I'm currently trying to adapt this to CentOS 7.
</I>&gt;<i> 
</I>&gt;<i> Niki
</I>&gt;<i> 
</I>&gt;<i> -- Microlinux - Solutions informatiques durables 7, place de l'&#233;glise -
</I>&gt;<i> 30730 Montpezat Site : <A HREF="https://www.microlinux.fr">https://www.microlinux.fr</A> Blog :
</I>&gt;<i> <A HREF="https://blog.microlinux.fr">https://blog.microlinux.fr</A> Mail : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at microlinux.fr</A> T&#233;l. : 04 66 63 10 32
</I>&gt;<i> 
</I>&gt;<i> 
</I>
I have added some &quot;Best Practice&quot; config changes inline below:

&gt;<i> SquidGuard-HOWTO.txt
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ================
</I>&gt;<i> SquidGuard HOWTO (c) Nicolas Kovacs &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at microlinux.fr</A>&gt;
</I>&gt;<i> ================
</I>&gt;<i> 
</I>&gt;<i> Derni&#232;re r&#233;vision : 5 mai 2015
</I>&gt;<i> 
</I>&gt;<i> Ce HOWTO d&#233;crit la mise en place du redirecteur SquidGuard pour un serveur
</I>&gt;<i> proxy Squid sous Slackware.
</I>&gt;<i> 
</I>&gt;<i>   * G&#233;n&#233;ralit&#233;s et pr&#233;requis
</I>&gt;<i>   * Installation
</I>&gt;<i>   * La page explicative
</I>&gt;<i>   * Une redirection simple
</I>&gt;<i>   * R&#233;cup&#233;rer les listes noires et blanches
</I>&gt;<i>   * Un filtre simple pour contenus probl&#233;matiques
</I>&gt;<i>   * Automatiser les op&#233;rations
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> G&#233;n&#233;ralit&#233;s et pr&#233;requis
</I>&gt;<i> ------------------------
</I>&gt;<i> 
</I>&gt;<i> SquidGuard est un plug-in pour Squid. On doit donc disposer d'une installation
</I>&gt;<i> fonctionnelle de ce dernier.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Installation
</I>&gt;<i> ------------
</I>&gt;<i> 
</I>&gt;<i> Installer le paquet 'squidGuard' depuis le d&#233;p&#244;t de paquets MLES.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> La page explicative
</I>&gt;<i> -------------------
</I>&gt;<i> 
</I>&gt;<i> Lorsque SquidGuard refuse l'acc&#232;s &#224; une page, c'est toujours une bonne id&#233;e
</I>&gt;<i> d'expliquer les raisons de ce refus aux utilisateurs. Pour commencer, on va
</I>&gt;<i> donc mettre en place une page d'avertissement, qui sera h&#233;berg&#233;e sur le
</I>&gt;<i> serveur lui-m&#234;me. 
</I>&gt;<i> 
</I>&gt;<i> Le r&#233;pertoire 'template/squidguard/html/' propose un mod&#232;le de page
</I>&gt;<i> explicative.
</I>&gt;<i> 
</I>&gt;<i> Pour la configuration d'une page web locale, voir le Apache-HOWTO.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Une redirection simple
</I>&gt;<i> ----------------------
</I>&gt;<i> 
</I>&gt;<i> Nous n'avons pas encore de listes noires et blanches ni de base de donn&#233;es,
</I>&gt;<i> mais nous pouvons d&#233;j&#224; faire un premier test de redirection :
</I>&gt;<i> 
</I>&gt;<i>   1. la machine 192.168.2.2 n'est pas filtr&#233;e
</I>&gt;<i> 
</I>&gt;<i>   2. toutes les autres machines du r&#233;seau local sont bloqu&#233;es
</I>&gt;<i> 
</I>&gt;<i> SquidGuard se configure par le biais du fichier de configuration
</I>&gt;<i> '/etc/squidguard/squidguard.conf'. Sauvegardez le fichier de configuration
</I>&gt;<i> d'origine :
</I>&gt;<i> 
</I>&gt;<i>   # cd /etc/squidguard
</I>&gt;<i>   # mv squidguard.conf squidguard.conf.orig
</I>&gt;<i> 
</I>&gt;<i> &#201;ditez un fichier de configuration minimal comme ceci :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
</I>&gt;<i> dbhome /var/lib/squidguard
</I>&gt;<i> logdir /var/log/squidguard
</I>&gt;<i> 
</I>&gt;<i> src admin {
</I>&gt;<i>   ip 192.168.2.2
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> acl {
</I>&gt;<i>   admin {
</I>&gt;<i>     pass any
</I>&gt;<i>   }
</I>&gt;<i>   default {
</I>&gt;<i>     pass none
</I>&gt;<i>     redirect <A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A>
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>
In squid.conf:

  acl admin src 192.168.2.2
  http_access allow admin

  acl redirect src all
  deny_info 302:<A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A> redirect
  http_access deny redirect

No URL-rewrite use.


&gt;<i>   &gt; La directive 'dbhome' indique &#224; SquidGuard o&#249; trouver la base de donn&#233;es
</I>&gt;<i>     des listes (que nous n'avons pas encore).
</I>&gt;<i> 
</I>&gt;<i>   &gt; La directive 'logdir' sp&#233;cifie l'endroit o&#249; l'on d&#233;sire r&#233;cup&#233;rer les
</I>&gt;<i>     logs.
</I>&gt;<i> 
</I>&gt;<i>   &gt; Les sources d&#233;finissent les groupes de clients. Ici, nous d&#233;finissons une
</I>&gt;<i>     seule adresse IP.
</I>&gt;<i> 
</I>&gt;<i>   &gt; Les 'acl' ou &quot;Access Control Lists&quot; permettent de d&#233;finir quelle source
</I>&gt;<i>     peut aller ou ne pas aller vers quelle(s) destination(s). 
</I>&gt;<i> 
</I>&gt;<i>   &gt; Lorsqu'une destination n'est pas autoris&#233;e, la directive 'redirect' permet
</I>&gt;<i>     de servir une page explicative au client. 
</I>&gt;<i> 
</I>&gt;<i> &#192; pr&#233;sent, il faut configurer Squid pour qu'il utilise SquidGuard. &#201;diter le
</I>&gt;<i> fichier '/etc/squid/squid.conf' et ajouter cette stance &#224; la fin du fichier :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squid/squid.conf -----------------------------------------
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidguard.conf
</I>&gt;<i> url_rewrite_children 5
</I>
Add:
  url_rewrite_access deny CONNECT


&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Recharger la configuration de Squid :
</I>&gt;<i> 
</I>&gt;<i>   # /etc/rc.d/rc.squid reload
</I>&gt;<i> 
</I>&gt;<i> V&#233;rifier si la modification a bien &#233;t&#233; prise en compte :
</I>&gt;<i> 
</I>&gt;<i>   # ps aux | grep squid | grep -v grep
</I>&gt;<i>   root      5043  ...  /usr/sbin/squid -F
</I>&gt;<i>   nobody    5045  ...  (squid) -F
</I>&gt;<i>   nobody    5068  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
</I>&gt;<i>   nobody    5069  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
</I>&gt;<i>   nobody    5070  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
</I>&gt;<i>   nobody    5071  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
</I>&gt;<i>   nobody    5072  ...  (squidGuard) -c /etc/squidguard/squidguard.conf
</I>&gt;<i> 
</I>&gt;<i> Maintenant, on peut essayer de naviguer sur Internet :
</I>&gt;<i> 
</I>&gt;<i>   1. avec la machine 192.168.2.2
</I>&gt;<i> 
</I>&gt;<i>   2. avec une machine dont l'adresse IP n'est pas 192.168.2.2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> R&#233;cup&#233;rer les listes noires et blanches
</I>&gt;<i> ---------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Dans les exemples pr&#233;sent&#233;s ci-dessous, nous utiliserons les listes noires et
</I>&gt;<i> blanches maintenues par le Centre de Ressources Informatiques de l'Universit&#233;
</I>&gt;<i> de Toulouse. Ces listes ne font pas partie de SquidGuard. On peut les
</I>&gt;<i> r&#233;cup&#233;rer manuellement comme ceci :
</I>&gt;<i>   
</I>&gt;<i>   # cd /var/lib/squidguard
</I>&gt;<i>   # wget -c <A HREF="ftp://ftp.ut-capitole.fr/blacklist/blacklists.tar.gz">ftp://ftp.ut-capitole.fr/blacklist/blacklists.tar.gz</A>
</I>&gt;<i>   # tar xvzf blacklists.tar.gz
</I>&gt;<i>   # cd blacklists
</I>&gt;<i> 
</I>&gt;<i> Chacun des r&#233;pertoires correspond &#224; une cat&#233;gorie (ou &quot;destination&quot;) du Web :
</I>&gt;<i> 
</I>&gt;<i>   # ls -l | awk '{print $9, $10, $11}'
</I>&gt;<i>   ads -&gt; publicite
</I>&gt;<i>   adult  
</I>&gt;<i>   aggressive -&gt; agressif
</I>&gt;<i>   agressif  
</I>&gt;<i>   arjel  
</I>&gt;<i>   astrology  
</I>&gt;<i>   audio-video  
</I>&gt;<i>   bank  
</I>&gt;<i>   bitcoin  
</I>&gt;<i>   blog  
</I>&gt;<i>   cc-by-sa-4-0.pdf  
</I>&gt;<i>   celebrity  
</I>&gt;<i>   chat  
</I>&gt;<i>   child  
</I>&gt;<i>   cleaning  
</I>&gt;<i>   cooking  
</I>&gt;<i>   dangerous_material  
</I>&gt;<i>   dating  
</I>&gt;<i>   drogue  
</I>&gt;<i>   drugs -&gt; drogue
</I>&gt;<i>   educational_games  
</I>&gt;<i>   filehosting  
</I>&gt;<i>   financial  
</I>&gt;<i>   forums  
</I>&gt;<i>   gambling  
</I>&gt;<i>   games  
</I>&gt;<i>   global_usage  
</I>&gt;<i>   hacking  
</I>&gt;<i>   jobsearch  
</I>&gt;<i>   ...
</I>&gt;<i> 
</I>&gt;<i> On peut &#233;galement r&#233;cup&#233;rer les listes avec l'outil 'rsync'. Cette m&#233;thode est
</I>&gt;<i> m&#234;me recommand&#233;e, &#233;tant donn&#233; que 'rsync' ne t&#233;l&#233;chargera que la diff&#233;rence
</I>&gt;<i> entre les arborescences distante et locale lors d'une mise &#224; jour :
</I>&gt;<i> 
</I>&gt;<i>   # cd /var/lib/squidguard
</I>&gt;<i>   # rm -rf blacklists*
</I>&gt;<i>   # rsync -rv <A HREF="rsync://ftp.ut-capitole.fr/blacklist/">rsync://ftp.ut-capitole.fr/blacklist/</A> .
</I>&gt;<i>   # cd dest
</I>&gt;<i> 
</I>&gt;<i> La seule diff&#233;rence par rapport au t&#233;l&#233;chargement avec 'wget', c'est que nous
</I>&gt;<i> retrouvons nos destinations dans un r&#233;pertoire 'dest/' et non 'blacklists/'.
</I>&gt;<i> 
</I>&gt;<i> Rep&#233;rez le fichier 'global_usage' et jetez un oeil dedans. Il s'agit d'un
</I>&gt;<i> fichier explicatif sur le contenu des listes.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Un filtre simple pour contenus probl&#233;matiques
</I>&gt;<i> ---------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Dans ce deuxi&#232;me exemple, nous allons filtrer les sites &#224; contenu
</I>&gt;<i> manifestement probl&#233;matique (porno, violence, drogues) pour toutes les
</I>&gt;<i> machines du r&#233;seau local. 
</I>&gt;<i> 
</I>&gt;<i> Dans un premier temps, nous allons adapter la directive 'dbhome' &#224; ce que nous
</I>&gt;<i> venons de t&#233;l&#233;charger un peu plus haut :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
</I>&gt;<i> dbhome /var/lib/squidguard/dest
</I>&gt;<i> logdir /var/log/squidguard
</I>&gt;<i> ...
</I>&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Les sources sont l&#224; pour sp&#233;cifier les groupes de clients. Nous allons d&#233;finir
</I>&gt;<i> tout le r&#233;seau local &quot;&#224; la louche&quot; :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
</I>&gt;<i> ...
</I>&gt;<i> src microlinux {
</I>&gt;<i>   ip 192.168.2.0/24
</I>&gt;<i> }
</I>&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Les destinations d&#233;finissent des ensembles de domaines, d'URL ou d'expressions
</I>&gt;<i> r&#233;guli&#232;res &#224; appliquer aux URLs. Ici, nous allons d&#233;finir trois destinations :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
</I>&gt;<i> ...
</I>&gt;<i> # Des sites adultes allant de l'&#233;rotique &#224; la pornographie dure
</I>&gt;<i> destination adult {
</I>&gt;<i>   domainlist adult/domains
</I>&gt;<i>   urllist adult/urls
</I>&gt;<i>   log adult
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> # Quelques sites racistes, antis&#233;mites et incitant &#224; la haine
</I>&gt;<i> destination agressif {
</I>&gt;<i>   domainlist agressif/domains
</I>&gt;<i>   urllist agressif/urls
</I>&gt;<i>   log agressif
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> # Drogues
</I>&gt;<i> destination drogue {
</I>&gt;<i>   domainlist drogue/domains
</I>&gt;<i>   urllist drogue/urls
</I>&gt;<i>   log drogue
</I>&gt;<i> }
</I>&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Les ACLs (&quot;Access Control Lists&quot;) permettent de d&#233;finir quelle source peut
</I>&gt;<i> aller ou ne pas aller vers quelle destination :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
</I>&gt;<i> ...
</I>&gt;<i> acl {
</I>&gt;<i>   microlinux {
</I>&gt;<i>     pass !adult
</I>&gt;<i>     pass !agressif
</I>&gt;<i>     pass !drogue
</I>&gt;<i>     redirect <A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A>
</I>&gt;<i>   }
</I>&gt;<i>   default {
</I>&gt;<i>     pass none
</I>&gt;<i>     redirect <A HREF="http://squidguard.nestor/avertissement.html">http://squidguard.nestor/avertissement.html</A>
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i>   &gt; Le point d'exclamation '!' &#233;quivaut &#224; une n&#233;gation.
</I>&gt;<i> 
</I>&gt;<i> Au total, notre configuration ressemblera donc &#224; ceci :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squidguard/squidguard.conf -------------------------------
</I>&gt;<i> dbhome /var/lib/squidguard/dest
</I>&gt;<i> logdir /var/log/squidguard
</I>&gt;<i> 
</I>&gt;<i> src microlinux {
</I>&gt;<i>   ip 192.168.2.0/24
</I>&gt;<i> }
</I>
squid.conf:
  acl microlinux src 192.168.2.0/24

&gt;<i> 
</I>&gt;<i> # Des sites adultes allant de l'&#233;rotique &#224; la pornographie dure
</I>&gt;<i> destination adult {
</I>&gt;<i>   domainlist adult/domains
</I>&gt;<i>   urllist adult/urls
</I>&gt;<i>   log adult
</I>&gt;<i> }
</I>&gt;<i> 
</I>
squid.conf:
  acl adult_domains dstdomain &quot;/var/lib/squidguard/dest/adult/domains&quot;
  acl adult_urls url_regex &quot;/var/lib/squidguard/dest/adult/urls&quot;
  acl adult any-of adult_domains adult_urls

(or files in a location other than &quot;lib/squidguard/&quot;.)

Note: Squid can handle regex files up to several hundred entries easily.
If they get into thousands OR are very frequently changed urldbguard can
become worth using.


The below agressif and drogue definitions can be done using the same
pattern as the adult lines above.


&gt;<i> # Quelques sites racistes, antis&#233;mites et incitant &#224; la haine
</I>&gt;<i> destination agressif {
</I>&gt;<i>   domainlist agressif/domains
</I>&gt;<i>   urllist agressif/urls
</I>&gt;<i>   log agressif
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> # Drogues
</I>&gt;<i> destination drogue {
</I>&gt;<i>   domainlist drogue/domains
</I>&gt;<i>   urllist drogue/urls
</I>&gt;<i>   log drogue
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> acl {
</I>&gt;<i>   microlinux {
</I>&gt;<i>     pass !adult
</I>&gt;<i>     pass !agressif
</I>&gt;<i>     pass !drogue
</I>&gt;<i>     redirect <A HREF="http://squidguard.amandine/avertissement.html">http://squidguard.amandine/avertissement.html</A>
</I>&gt;<i>   }
</I>&gt;<i>   default {
</I>&gt;<i>     pass none
</I>&gt;<i>     redirect <A HREF="http://squidguard.amandine/avertissement.html">http://squidguard.amandine/avertissement.html</A>
</I>&gt;<i>   }
</I>&gt;<i> }
</I>
squid.conf:

 acl redirect src all
 deny_info 302:<A HREF="http://squidguard.amandine/avertissement.html">http://squidguard.amandine/avertissement.html</A> redirect
 http_access allow microlinux !adult !agressif !drogue
 http_access deny redirect


&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Avant d'aller plus loin, nous devons r&#233;gler quelques permissions.
</I>&gt;<i> Rappelons-nous que le proxy cache Squid tourne avec les droits de
</I>&gt;<i> l'utilisateur 'nobody' et du groupe 'nobody' :
</I>&gt;<i> 
</I>&gt;<i> --8&lt;---------- /etc/squid/squid.conf -----------------------------------------
</I>&gt;<i> ...
</I>&gt;<i> cache_effective_user nobody
</I>&gt;<i> cache_effective_group nobody
</I>&gt;<i> ...
</I>&gt;<i> --8&lt;--------------------------------------------------------------------------
</I>
Remove entirely. Pre-packaged Squid should be built with the appropriate
user account in --with-default-user= such that these do not need setting
at all.

&gt;<i> 
</I>&gt;<i> L'arborescence '/var/lib/squidguard' doit &#234;tre accessible en lecture/&#233;criture
</I>&gt;<i> pour Squid :
</I>&gt;<i> 
</I>&gt;<i>   # chown -R nobody:nobody /var/lib/squidguard/
</I>&gt;<i>   # ls -ld /var/lib/squidguard/
</I>&gt;<i>   drwxr-xr-x 3 nobody nobody 4096 nov.   2 08:56 /var/lib/squidguard/
</I>&gt;<i> 
</I>&gt;<i> Au cas o&#249; le r&#233;pertoire des logs n'existe pas, il faut le cr&#233;er :
</I>&gt;<i> 
</I>&gt;<i>   # mkdir -v /var/log/squidguard
</I>&gt;<i>   mkdir: cr&#233;ation du r&#233;pertoire &#171;&#160;/var/log/squidguard&#160;&#187;
</I>&gt;<i> 
</I>&gt;<i> L&#224; aussi, il faut ajuster les permissions :
</I>&gt;<i> 
</I>&gt;<i>   # chown -R nobody:nobody /var/log/squidguard/
</I>&gt;<i>   # ls -ld /var/log/squidguard/
</I>&gt;<i>   drwxr-xr-x 2 nobody nobody 4096 nov.   2 11:08 /var/log/squidguard/
</I>&gt;<i> 
</I>&gt;<i> Pour pouvoir fonctionner rapidement, SquidGuard n'utilise pas les fichiers
</I>&gt;<i> texte, mais des bases de donn&#233;es au format Berkeley. Ces bases de donn&#233;es
</I>&gt;<i> n'existent pas encore, et nous devons les construire :
</I>&gt;<i> 
</I>&gt;<i>   # squidGuard -C all
</I>&gt;<i> 
</I>&gt;<i> Si tout s'est bien pass&#233;, on obtient quelque chose comme ceci :
</I>&gt;<i> 
</I>&gt;<i>   # cat /var/log/squidguard/squidGuard.log 
</I>&gt;<i>   2014-11-02 11:09:39 [3897] New setting: dbhome: /var/lib/squidguard/dest
</I>&gt;<i>   2014-11-02 11:09:39 [3897] New setting: logdir: /var/log/squidguard
</I>&gt;<i>   2014-11-02 11:09:39 [3897] init domainlist
</I>&gt;<i>   /var/lib/squidguard/dest/adult/domains
</I>&gt;<i>   2014-11-02 11:09:52 [3897] create new dbfile
</I>&gt;<i>   /var/lib/squidguard/dest/adult/domains.db
</I>&gt;<i>   2014-11-02 11:09:53 [3897] init urllist /var/lib/squidguard/dest/adult/urls
</I>&gt;<i>   2014-11-02 11:09:53 [3897] create new dbfile
</I>&gt;<i>   /var/lib/squidguard/dest/adult/urls.db
</I>&gt;<i>   2014-11-02 11:09:54 [3897] init domainlist
</I>&gt;<i>   /var/lib/squidguard/dest/agressif/domains
</I>&gt;<i>   2014-11-02 11:09:54 [3897] create new dbfile
</I>&gt;<i>   /var/lib/squidguard/dest/agressif/domains.db
</I>&gt;<i>   2014-11-02 11:09:54 [3897] init urllist /var/lib/squidguard/dest/agressif/urls
</I>&gt;<i>   2014-11-02 11:09:54 [3897] create new dbfile
</I>&gt;<i>   /var/lib/squidguard/dest/agressif/urls.db
</I>&gt;<i>   2014-11-02 11:09:54 [3897] init domainlist
</I>&gt;<i>   /var/lib/squidguard/dest/drogue/domains
</I>&gt;<i>   2014-11-02 11:09:54 [3897] create new dbfile
</I>&gt;<i>   /var/lib/squidguard/dest/drogue/domains.db
</I>&gt;<i>   2014-11-02 11:09:54 [3897] init urllist /var/lib/squidguard/dest/drogue/urls
</I>&gt;<i>   2014-11-02 11:09:54 [3897] create new dbfile
</I>&gt;<i>   /var/lib/squidguard/dest/drogue/urls.db
</I>&gt;<i>   2014-11-02 11:09:54 [3897] squidGuard 1.4 started (1414922979.731)
</I>&gt;<i>   2014-11-02 11:09:54 [3897] db update done
</I>&gt;<i>   2014-11-02 11:09:54 [3897] squidGuard stopped (1414922994.459)
</I>&gt;<i> 
</I>&gt;<i> Quelques mises en garde s'imposent ici :
</I>&gt;<i> 
</I>&gt;<i>   1. SquidGuard est une application assez pointue, pour ne pas dire une
</I>&gt;<i>   v&#233;ritable usine &#224; gaz. La moindre faute de frappe dans un des fichiers de
</I>&gt;<i>   configuration se solde g&#233;n&#233;ralement par un &#233;chec. Il est donc n&#233;cessaire de
</I>&gt;<i>   porter une grande attention &#224; la syntaxe. 
</I>&gt;<i> 
</I>&gt;<i>   2. Les bases de donn&#233;es (fichiers '*.db' en-dessous de l'arborescence
</I>&gt;<i>   '/var/lib/squidguard/dest/') doivent &#234;tre construites *apr&#232;s* avoir &#233;crit le
</I>&gt;<i>   fichier de configuration, car seules les destinations d&#233;finies dans ce
</I>&gt;<i>   fichier seront compil&#233;es. Autrement dit, si vous devez ajouter une
</I>&gt;<i>   destination par la suite (malware, tricheur, etc.) il va falloir penser &#224;
</I>&gt;<i>   compiler les bases de donn&#233;es correspondantes.
</I>&gt;<i> 
</I>&gt;<i>   3. En r&#232;gle g&#233;n&#233;rale, &#231;a ne fonctionne que rarement du premier coup. Dans ce
</I>&gt;<i>   cas, jetez un oeil dans les logs, notamment 'squidGuard.log'. Ce dernier
</I>&gt;<i>   vous sera d'un grand secours, car il vous avertira de tous les probl&#232;mes de
</I>&gt;<i>   configuration.
</I>&gt;<i> 
</I>&gt;<i> &#201;tant donn&#233; que la commande 'squidGuard -C all' a &#233;t&#233; invoqu&#233;e par root, les
</I>&gt;<i> fichiers g&#233;n&#233;r&#233;s par cette commande appartiennent &#224; ce dernier :
</I>&gt;<i> 
</I>&gt;<i>   # ls -l /var/lib/squidguard/dest/adult/
</I>&gt;<i>   total 66704
</I>&gt;<i>   -rw-r--r-- 1 nobody nobody 17977204 nov.   1 11:02 domains
</I>&gt;<i>   -rw-r--r-- 1 root   root   44773376 nov.   2 11:09 domains.db
</I>&gt;<i>   -rw-r--r-- 1 nobody nobody        0 nov.   1 11:02 expressions
</I>&gt;<i>   -rw-r--r-- 1 nobody nobody  1959494 nov.   1 11:02 urls
</I>&gt;<i>   -rw-r--r-- 1 root   root    3584000 nov.   2 11:09 urls.db
</I>&gt;<i>   -rw-r--r-- 1 nobody nobody       17 nov.   1 11:02 usage
</I>&gt;<i>   ...
</I>&gt;<i>   # ls -l /var/log/squidguard/
</I>&gt;<i>   total 4
</I>&gt;<i>   -rw-r--r-- 1 root root    0 nov.   2 11:09 adult
</I>&gt;<i>   -rw-r--r-- 1 root root    0 nov.   2 11:09 agressif
</I>&gt;<i>   -rw-r--r-- 1 root root    0 nov.   2 11:09 drogue
</I>&gt;<i>   -rw-r--r-- 1 root root 1316 nov.   2 11:09 squidGuard.log
</I>&gt;<i> 
</I>&gt;<i> On va donc devoir rectifier le tir une deuxi&#232;me fois pour les permissions :
</I>&gt;<i> 
</I>&gt;<i>   # chown -R nobody:nobody /var/lib/squidguard/
</I>&gt;<i>   # chown -R nobody:nobody /var/log/squidguard/
</I>&gt;<i> 
</I>&gt;<i> Recharger la configuration :
</I>&gt;<i> 
</I>&gt;<i>   # /etc/rc.d/rc.squid reload
</I>&gt;<i> 
</I>&gt;<i> &#192; pr&#233;sent, naviguer sur le Web et tester le filtrage de quelques sites
</I>&gt;<i> potentiellement probl&#233;matiques :
</I>&gt;<i> 
</I>&gt;<i>   * <A HREF="http://www.nichons.com">http://www.nichons.com</A>
</I>&gt;<i> 
</I>&gt;<i>   * <A HREF="http://www.whitehonor.com">http://www.whitehonor.com</A>
</I>&gt;<i> 
</I>&gt;<i>   * <A HREF="http://www.cannabizz.com">http://www.cannabizz.com</A>
</I>&gt;<i> 
</I>&gt;<i> Si tout se passe bien, les pages ne s'affichent pas, et l'utilisateur se
</I>&gt;<i> trouve confront&#233; &#224; la page explicative. Non content de cela, sa tentative est
</I>&gt;<i> enregistr&#233;e dans le fichier log correspondant &#224; la cat&#233;gorie de site prohib&#233;,
</I>&gt;<i> par exemple :
</I>&gt;<i> 
</I>&gt;<i>   # tail -f /var/log/squidguard/adult
</I>&gt;<i>   2014-11-02 11:28:42 ... <A HREF="http://www.nichons.com/">http://www.nichons.com/</A> 192.168.2.3/- - GET REDIRECT
</I>&gt;<i>   2014-11-02 11:28:42 ... <A HREF="http://www.nichons.com/favicon.ico">http://www.nichons.com/favicon.ico</A> 192.168.2.3/- ...
</I>&gt;<i>   2014-11-02 11:28:42 ... <A HREF="http://www.nichons.com/favicon.ico">http://www.nichons.com/favicon.ico</A> 192.168.2.3/- ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Automatiser les op&#233;rations
</I>&gt;<i> --------------------------
</I>&gt;<i> 
</I>&gt;<i> Je fournis un script 'blacklist.sh' dans le r&#233;pertoire 'template/squidguard/',
</I>&gt;<i> qui automatise la plupart des t&#226;ches r&#233;p&#233;titives. Copier ce script dans un
</I>&gt;<i> endroit appropri&#233;, par exemple '/usr/local/sbin/', et le rendre ex&#233;cutable. Il
</I>&gt;<i> se charge de :
</I>&gt;<i> 
</I>&gt;<i>   1. r&#233;cup&#233;rer les listes noires et blanches
</I>&gt;<i> 
</I>&gt;<i>   2. mettre &#224; jour les listes d&#233;j&#224; t&#233;l&#233;charg&#233;es
</I>&gt;<i> 
</I>&gt;<i>   3. construire les bases de donn&#233;es Berkeley
</I>&gt;<i> 
</I>&gt;<i>   4. rectifier les permissions
</I>&gt;<i> 
</I>&gt;<i>   5. relancer Squid pour prendre en compte les modifications
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------------
</I>&gt;<i> # vim: syntax=txt
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017842.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
	<LI>Next message (by thread): <A HREF="017826.html">[squid-users] Squid + SquidGuard : static block page not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17825">[ date ]</a>
              <a href="thread.html#17825">[ thread ]</a>
              <a href="subject.html#17825">[ subject ]</a>
              <a href="author.html#17825">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
