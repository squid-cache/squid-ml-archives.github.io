<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Intercepting proxy creates forwading loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intercepting%20proxy%20creates%20forwading%20loop&In-Reply-To=%3C404dd128-a3a2-79f2-3bea-e810162f9fa7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017850.html">
   <LINK REL="Next"  HREF="017851.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Intercepting proxy creates forwading loop</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Intercepting%20proxy%20creates%20forwading%20loop&In-Reply-To=%3C404dd128-a3a2-79f2-3bea-e810162f9fa7%40treenet.co.nz%3E"
       TITLE="[squid-users] Intercepting proxy creates forwading loop">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Mar 17 13:02:16 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017850.html">[squid-users] Intercepting proxy creates forwading loop
</A></li>
        <LI>Next message (by thread): <A HREF="017851.html">[squid-users] Reverse proxy is not responding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17852">[ date ]</a>
              <a href="thread.html#17852">[ thread ]</a>
              <a href="subject.html#17852">[ subject ]</a>
              <a href="author.html#17852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/03/18 06:57, Patrick Nick wrote:
&gt;<i> Hello list,&#160;
</I>&gt;<i> 
</I>&gt;<i> I have resolved first problem about cache_peer using Kerberos
</I>&gt;<i> authentication. Now I want to make that setup transparent/intercepting.
</I>&gt;<i> Keep in mind that my situation does NOT involve browsers or port 80 at
</I>&gt;<i> any point, it's a pure machine-to-machine API communication.
</I>&gt;<i> 
</I>&gt;<i> I have added the &quot;intercept&quot; keyword to my config, here is a part of my
</I>&gt;<i> config that seems relevant:
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> cache_peer&#160;my.company.webserver.net
</I>&gt;<i> &lt;<A HREF="http://my.company.webserver.net/">http://my.company.webserver.net/</A>&gt;&#160;parent 8081 0 no-query
</I>&gt;<i> login=NEGOTIATE:myPrincipal originserver
</I>&gt;<i> 
</I>&gt;<i> And here is how I test it by using the rather new curl option
</I>&gt;<i> &quot;--connect-to&quot; which allows to send the request to a different host:port
</I>&gt;<i> than specified in the &quot;Host:&quot; http header:
</I>&gt;<i> 
</I>&gt;<i> curl -b ~/cookies.txt -c ~/cookies.txt -H'Content-Type:
</I>&gt;<i> application/json' &quot;<A HREF="http://my.company.host.net:8081/status">http://my.company.host.net:8081/status</A>&quot; --connect-to
</I>&gt;<i> &quot;my.company.host.net:8081
</I>&gt;<i> &lt;<A HREF="http://my.company.host.net:8081">http://my.company.host.net:8081</A>&gt;:my.squid.host.net:3128
</I>&gt;<i> &lt;<A HREF="http://my.squid.host.net:3128">http://my.squid.host.net:3128</A>&gt;&quot; -v
</I>&gt;<i> 
</I>&gt;<i> The result is always &quot;HTTP/1.1 403 Forbidden&quot; and in the logs I see
</I>&gt;<i> &quot;WARNING: Forwarding loop detected for:&quot;.
</I>&gt;<i> 
</I>&gt;<i> I don't understand how a loop can form. I've seen many tutorials talking
</I>&gt;<i> about using iptables to redirect traffic to a different port, but I
</I>&gt;<i> don't think that I need that, since the curl-option should take care of
</I>&gt;<i> that.
</I>
You absolutely DO need the iptables part, because Squid &quot;intercept&quot; is
integrated with the machines NAT system. Squid outbound connection for
intercepted traffic prefers the same IP:port the client used (aka
transparency) to avoid security issues like CVE-2009-0801.

Since curl did a &quot;connect-to&quot; to Squid's IP:port directly and
my.squid.host.net != my.company.host.net ... Squid copies that with a
connection to my.squid.host.net:3128 and sends the request for
my.company.host.net:8081 there. Et Voila`, Loop.


&gt;<i> I assume that squid should receive the request and then send it on to
</I>&gt;<i> what's specified in the &quot;Host:&quot; header. Is this wrong?
</I>
Sort of wrong yes. Squid uses the TCP connection IP:port with
modification to undo NAT in accordance with the local machines NAT
records. Host header (and thus caching which relies on it) is only used
if it correlates reliably with those details.


&gt;<i> What kind of loop is forming here and how do I break it?
</I>
A transparent forwarding loop.

Add the iptables part of the config and send test requests *exactly* as
the clients would in their real traffic. No shortcuts like curl
--connect-to, unless that is actually how the client connects.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017850.html">[squid-users] Intercepting proxy creates forwading loop
</A></li>
	<LI>Next message (by thread): <A HREF="017851.html">[squid-users] Reverse proxy is not responding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17852">[ date ]</a>
              <a href="thread.html#17852">[ thread ]</a>
              <a href="subject.html#17852">[ subject ]</a>
              <a href="author.html#17852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
