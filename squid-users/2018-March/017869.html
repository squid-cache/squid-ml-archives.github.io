<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] multiple log_file_daemon settings in squid.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20multiple%20log_file_daemon%20settings%20in%20squid.conf&In-Reply-To=%3CAM4PR0401MB219422C52A282CCDD9338EEC8FAB0%40AM4PR0401MB2194.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017876.html">
   <LINK REL="Next"  HREF="017871.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] multiple log_file_daemon settings in squid.conf</H1>
    <B>Rafael Akchurin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20multiple%20log_file_daemon%20settings%20in%20squid.conf&In-Reply-To=%3CAM4PR0401MB219422C52A282CCDD9338EEC8FAB0%40AM4PR0401MB2194.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] multiple log_file_daemon settings in squid.conf">rafael.akchurin at diladele.com
       </A><BR>
    <I>Tue Mar 20 10:38:13 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017876.html">[squid-users] Volume quota management availablity
</A></li>
        <LI>Next message (by thread): <A HREF="017871.html">[squid-users] multiple log_file_daemon settings in squid.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17869">[ date ]</a>
              <a href="thread.html#17869">[ thread ]</a>
              <a href="subject.html#17869">[ subject ]</a>
              <a href="author.html#17869">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Greetings all,

I am trying to find the best (easiest, least interfering) solution for the following problem.

Our custom ICAP server writes various information about ICAP transaction (user name, policy ip, detection module, timings, words triggered detection, etc) into the record database. This happens at the time when ICAP transaction ends. Based on that information we build extensive reports of web filtering activity.

As known, end of the ICAP transaction does not mean the end of the original transaction in Squid - e.g. after scanning CONNECT request and allowing it to proceed, the actual data transfer from the Squid's perspective may end much much later. The piece of information that would be very interesting for reporting module is how many bytes were pumped through that connection. This information is only available after the original Squid transaction ends.

So somehow in the record database we must correlate the ICAP transaction(s) with original Squid transaction.

Question 1:
Is there any unique transaction ID in the Squid's inner workings that I can see in the ICAP server, by passing it as additional X-* ICAP header?
I see some references to so called &quot;master transaction&quot; in the docs but could not find any log format like identifier that can be used for ICAP header value.

Question 2:
If there is no such transaction ID, I can use ICAP header to pass the ICAP specific transaction ID back to Squid *and* I can get that ID written to Squid's access log as &quot;X-WebSafety-IID=%{X-WebSafety-IID}adapt::&lt;last_h&quot;. Is it a valid approach?

Question 3:
If q1 or q2 is answered positively, I still need to somehow get the data from squid's access log the ICAP record database. Currently the idea is to have the custom logfile_daemon setting that would fork original log_file_daemon to have log entries written to access_log *and* parse out the ICAP ID *and* update the corresponding ICAP record in the database with transferred bytes information. But this seems complex and fragile.

Is it possible to have *two* daemon log settings in the squid.conf? One (original) would write access_log is usual and another one would parse out pumped bytes and update the ICAP records database.

Hope I could explain it :(

Thanks in advance for everyone taking time to respond.

Best regards,
Rafael Akchurin
Diladele B.V.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180320/1d6856c3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180320/1d6856c3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017876.html">[squid-users] Volume quota management availablity
</A></li>
	<LI>Next message (by thread): <A HREF="017871.html">[squid-users] multiple log_file_daemon settings in squid.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17869">[ date ]</a>
              <a href="thread.html#17869">[ thread ]</a>
              <a href="subject.html#17869">[ subject ]</a>
              <a href="author.html#17869">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
