<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] multiple log_file_daemon settings in squid.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20multiple%20log_file_daemon%20settings%20in%20squid.conf&In-Reply-To=%3Cff948ebb-35cf-469d-c822-2142fb37b67a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017869.html">
   <LINK REL="Next"  HREF="017881.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] multiple log_file_daemon settings in squid.conf</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20multiple%20log_file_daemon%20settings%20in%20squid.conf&In-Reply-To=%3Cff948ebb-35cf-469d-c822-2142fb37b67a%40treenet.co.nz%3E"
       TITLE="[squid-users] multiple log_file_daemon settings in squid.conf">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 20 12:35:28 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017869.html">[squid-users] multiple log_file_daemon settings in squid.conf
</A></li>
        <LI>Next message (by thread): <A HREF="017881.html">[squid-users] multiple log_file_daemon settings in squid.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17871">[ date ]</a>
              <a href="thread.html#17871">[ thread ]</a>
              <a href="subject.html#17871">[ subject ]</a>
              <a href="author.html#17871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/03/18 23:38, Rafael Akchurin wrote:
&gt;<i> Greetings all,
</I>&gt;<i> 
</I>&gt;<i> I am trying to find the best (easiest, least interfering) solution for
</I>&gt;<i> the following problem.
</I>&gt;<i> 
</I>&gt;<i> Our custom ICAP server writes various information about ICAP transaction
</I>&gt;<i> (user name, policy ip, detection module, timings, words triggered
</I>&gt;<i> detection, etc) into the record database. This happens at the time when
</I>&gt;<i> ICAP transaction ends. Based on that information we build extensive
</I>&gt;<i> reports of web filtering activity.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> As known, end of the ICAP transaction does not mean the end of the
</I>&gt;<i> original transaction in Squid &#8211; e.g. after scanning CONNECT request and
</I>&gt;<i> allowing it to proceed, the actual data transfer from the Squid&#8217;s
</I>&gt;<i> perspective may end much much later. The piece of information that would
</I>&gt;<i> be very interesting for reporting module is how many bytes were pumped
</I>&gt;<i> through that connection. This information is only available after the
</I>&gt;<i> original Squid transaction ends.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> So somehow in the record database we must correlate the ICAP
</I>&gt;<i> transaction(s) with original Squid transaction.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Question 1:
</I>&gt;<i> 
</I>&gt;<i> Is there any unique transaction ID in the Squid&#8217;s inner workings that I
</I>&gt;<i> can see in the ICAP server, by passing it as additional X-* ICAP header?
</I>&gt;<i> 
</I>&gt;<i> I see some references to so called &#8220;master transaction&#8221; in the docs but
</I>&gt;<i> could not find any log format like identifier that can be used for ICAP
</I>&gt;<i> header value.
</I>
see &lt;<A HREF="http://www.squid-cache.org/Doc/config/adaptation_meta/">http://www.squid-cache.org/Doc/config/adaptation_meta/</A>&gt;

There is also the note directive. Although that is only added right at
the point of logging - so it is useful for Squid adding notes if the
ICAP service does not add any itself. All Squid helpers used for a
transaction add notes about their results to the transaction (except
security tokens for NTLM, Kerberos and Digest).
 &lt;<A HREF="http://www.squid-cache.org/Doc/config/note/">http://www.squid-cache.org/Doc/config/note/</A>&gt;


&gt;<i> 
</I>&gt;<i> Question 2:
</I>&gt;<i> 
</I>&gt;<i> If there is no such transaction ID, I can use ICAP header to pass the
</I>&gt;<i> ICAP specific transaction ID back to Squid **and** I can get that ID
</I>&gt;<i> written to Squid&#8217;s access log as
</I>&gt;<i> &quot;X-WebSafety-IID=%{X-WebSafety-IID}adapt::&lt;last_h&quot;. Is it a valid approach?
</I>&gt;<i> 
</I>
Yes.


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Question 3:
</I>&gt;<i> 
</I>&gt;<i> If q1 or q2 is answered positively, I still need to somehow get the data
</I>&gt;<i> from squid&#8217;s access log the ICAP record database. Currently the idea is
</I>&gt;<i> to have the custom logfile_daemon setting that would fork original
</I>&gt;<i> log_file_daemon to have log entries written to access_log **and** parse
</I>&gt;<i> out the ICAP ID **and** update the corresponding ICAP record in the
</I>&gt;<i> database with transferred bytes information. But this seems complex and
</I>&gt;<i> fragile.
</I>&gt;<i> 
</I>
There is only one daemon at a time supported.

That said the daemon can be instructed via access_log parameter
&quot;daemon:PLACE&quot; to send its data to a specific output PLACE - where PLACE
is a string passed to the helper command line and interpreted in any way
the helper author desires.
 The bundled helpers treat is respectively as the name+path of a file,
or a database DSN to drop the relevant access_log lines to.


Alternatively the &quot;tcp:&quot; logging module can send the log lines as a raw
TCP stream to some place that handles input with the logformat defined
syntax as a series of lines.
 I've seen people defining custom logformat with variously SQL, XML and
JSON markup for delivery to custom daemon or tcp modules.


There is also the option of an external ACL helper that gets passed the
%note details along with anything else you wish it to use. That helper
can do any updates you want prior to the logformat using the same
details. The only restriction here is that it must run in a slow-group
access check. The last one that seems reasonable is http_reply_access
which preceeds ICAP RESPMOD alterations.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017869.html">[squid-users] multiple log_file_daemon settings in squid.conf
</A></li>
	<LI>Next message (by thread): <A HREF="017881.html">[squid-users] multiple log_file_daemon settings in squid.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17871">[ date ]</a>
              <a href="thread.html#17871">[ thread ]</a>
              <a href="subject.html#17871">[ subject ]</a>
              <a href="author.html#17871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
