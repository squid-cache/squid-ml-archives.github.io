<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSLBump, system requirements ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%2C%20system%20requirements%20%3F&In-Reply-To=%3C6c74c6dd-f52f-33c0-258c-e0066885d094%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017880.html">
   <LINK REL="Next"  HREF="017883.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSLBump, system requirements ?</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%2C%20system%20requirements%20%3F&In-Reply-To=%3C6c74c6dd-f52f-33c0-258c-e0066885d094%40gmail.com%3E"
       TITLE="[squid-users] SSLBump, system requirements ?">yvoinov at gmail.com
       </A><BR>
    <I>Tue Mar 20 16:47:46 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017880.html">[squid-users] SSLBump, system requirements ?
</A></li>
        <LI>Next message (by thread): <A HREF="017883.html">[squid-users] SSLBump, system requirements ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17882">[ date ]</a>
              <a href="thread.html#17882">[ thread ]</a>
              <a href="subject.html#17882">[ subject ]</a>
              <a href="author.html#17882">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

20.03.2018 21:30, FredB &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i> Hi all,
</I>&gt;<i>
</I>&gt;<i> I'm testing SSLBump and Squid eats up all my CPU, maybe I made something wrong or maybe some updates are required ? Any advice would be greatly appreciated.
</I>&gt;<i>
</I>&gt;<i> Debian 8.10 64 bits, Squid 3.5.27 + 64 Go ram + SSD + 15 Cores Xeon(R) CPU E5-2637 v2 @ 3.50GHz
</I>Big box. How much users and traffic?
&gt;<i>  
</I>&gt;<i> FI, I don't see anything about limit reached in kern.log (File descriptor or network)
</I>&gt;<i>
</I>&gt;<i> acl nobump dstdomain &quot;/home/squid/domains&quot; -&gt; Some very used websites (google, fb, etc) otherwise the system dies after less 1 minute 
</I>&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ca_orion/cert generate-host-certificates=on dynamic_cert_mem_cache_size=500MB
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /usr/lib/squid/ssl_db -M 100MB
</I>Disbalanced config.

dynamic_cert_mem_cache_size=500MB

and only 100 MB on disk?

sslcrtd_program /usr/lib/squid/ssl_crtd -s /usr/lib/squid/ssl_db -M 100MB


&gt;<i> sslcrtd_children 2000 startup=100 idle=20 
</I>Why so much children? Again - for what workload?
&gt;<i> sslproxy_capath /etc/ssl/certs/
</I>&gt;<i> sslproxy_foreign_intermediate_certs /etc/squid/ssl_certs/imtermediate.ca.pem
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice nobump
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> The sslcrtd_children increases quickly and permanently
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl | wc -l
</I>&gt;<i> 1321
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl | wc -l
</I>&gt;<i> 1341
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl | wc -l
</I>&gt;<i> 1341
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl_crt | wc -l
</I>&gt;<i> 1380
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl_crt | wc -l
</I>&gt;<i> 1381
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl_crt | wc -l
</I>&gt;<i> 1382
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at proxyorion5</A>:/tmp# ps -edf | grep ssl_crt | wc -l
</I>&gt;<i> 1395
</I>&gt;<i>
</I>&gt;<i> Of course after a while 2000 is reached and the system becomes completely mad, but I already tried 200, 500, 1000, etc 
</I>&gt;<i>
</I>&gt;<i> Right after squid start CPU and load average values are very, very, high 
</I>&gt;<i>
</I>&gt;<i> top - 16:06:17 up 13 days,  2:46,  3 users,  load average: 102,02, 56,67, 30,75
</I>&gt;<i> Tasks: 1964 total,   3 running, 1961 sleeping,   0 stopped,   0 zombie
</I>&gt;<i> %Cpu(s): 15,3 us,  3,7 sy,  0,0 ni, 80,2 id,  0,4 wa,  0,0 hi,  0,4 si,  0,0 st
</I>&gt;<i> KiB Mem:  66086692 total, 52378248 used, 13708444 free,  2899764 buffers
</I>&gt;<i> KiB Swap:  1952764 total,        0 used,  1952764 free. 32798948 cached Mem
</I>&gt;<i>
</I>&gt;<i>   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                  
</I>&gt;<i> 23711 squid     20   0 3438832 2,976g  13784 R 100,0  4,7   6:01.02 squid                                                    
</I>&gt;<i> 23724 squid     20   0   24868   8552   4340 S   3,6  0,0   0:02.46 ssl_crtd                                                 
</I>&gt;<i> 23712 squid     20   0   25132   8896   4428 R   3,0  0,0   0:02.62 ssl_crtd                                                 
</I>&gt;<i> 23714 squid     20   0   24868   8556   4344 S   2,3  0,0   0:02.43 ssl_crtd                                                 
</I>&gt;<i> 23716 squid     20   0   24868   8636   4428 S   2,3  0,0   0:02.26 ssl_crtd                                                 
</I>&gt;<i> 23720 squid     20   0   24868   8612   4400 S   2,3  0,0   0:02.58 ssl_crtd                                                 
</I>&gt;<i> 23771 squid     20   0   24868   8580   4368 S   2,0  0,0   0:01.86 ssl_crtd                                                 
</I>&gt;<i> 23780 squid     20   0   24872   8484   4268 S   2,0  0,0   0:01.86 ssl_crtd                                                 
</I>&gt;<i> 23787 squid     20   0   24868   8612   4404 S   2,0  0,0   0:01.92 ssl_crtd 
</I>.... what means some bottlenecks. Obviously.
&gt;<i>  
</I>&gt;<i>
</I>&gt;<i> The same system without SSLBump and e2guardian (web filtering) added (I tried without more or less 10% CPU )
</I>&gt;<i>
</I>&gt;<i> Tasks: 304 total,   2 running, 302 sleeping,   0 stopped,   0 zombie
</I>&gt;<i> %Cpu(s):  2,0 us,  1,1 sy,  0,0 ni, 95,9 id,  0,1 wa,  0,0 hi,  0,9 si,  0,0 st
</I>&gt;<i> KiB Mem:  66086700 total, 65627952 used,   458748 free,  2652264 buffers
</I>&gt;<i> KiB Swap:  1952764 total,    20884 used,  1931880 free. 32639208 cached Mem
</I>&gt;<i>
</I>&gt;<i>   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                         
</I>&gt;<i> 20389 e2guard+  20   0  0,122t 1,133g   6144 S  28,6  1,8 191:06.50 e2guardian                      
</I>&gt;<i> 20283 squid     20   0 21,761g 0,021t   8128 R  24,2 34,0 145:00.09 squid                           
</I>&gt;<i>   101 root      20   0       0      0      0 S   1,3  0,0  19:05.09 kswapd1                         
</I>&gt;<i>   100 root      20   0       0      0      0 S   1,0  0,0  22:41.82 kswapd0                         
</I>&gt;<i>     8 root      20   0       0      0      0 S   0,7  0,0  68:49.48 rcu_sched                       
</I>&gt;<i>    24 root      20   0       0      0      0 S   0,3  0,0   8:37.14 ksoftirqd/3                     
</I>&gt;<i>    65 root      20   0       0      0      0 S   0,3  0,0   8:05.02 ksoftirqd/11                    
</I>&gt;<i>   929 root      20   0   71928   6984   4716 S   0,3  0,0  17:53.57 syslog-ng                       
</I>&gt;<i>  8069 root      20   0       0      0      0 S   0,3  0,0   0:22.35 kworker/0:0                     
</I>&gt;<i> 16624 root      20   0   25868   3236   2592 R   0,3  0,0   0:00.19 top                             
</I>&gt;<i> 20291 squid     20   0   59504   5228   4568 S   0,3  0,0   0:03.41 digest_
</I>&gt;<i>   
</I>&gt;<i> FredB
</I>&gt;<i>     
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
&quot;C++ seems like a language suitable for firing other people's legs.&quot;

*****************************
* C++20 : Bug to the future *
*****************************


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 659 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180320/9f4f62cc/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180320/9f4f62cc/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017880.html">[squid-users] SSLBump, system requirements ?
</A></li>
	<LI>Next message (by thread): <A HREF="017883.html">[squid-users] SSLBump, system requirements ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17882">[ date ]</a>
              <a href="thread.html#17882">[ thread ]</a>
              <a href="subject.html#17882">[ subject ]</a>
              <a href="author.html#17882">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
