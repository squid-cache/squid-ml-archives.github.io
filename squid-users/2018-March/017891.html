<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSLBump, system requirements ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%2C%20system%20requirements%20%3F&In-Reply-To=%3Cfe05f30c-0d2c-72b0-40c7-b73509e7cdcc%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017890.html">
   <LINK REL="Next"  HREF="017892.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSLBump, system requirements ?</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%2C%20system%20requirements%20%3F&In-Reply-To=%3Cfe05f30c-0d2c-72b0-40c7-b73509e7cdcc%40gmail.com%3E"
       TITLE="[squid-users] SSLBump, system requirements ?">yvoinov at gmail.com
       </A><BR>
    <I>Wed Mar 21 12:56:41 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017890.html">[squid-users] SSLBump, system requirements ?
</A></li>
        <LI>Next message (by thread): <A HREF="017892.html">[squid-users] SSLBump, system requirements ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17891">[ date ]</a>
              <a href="thread.html#17891">[ thread ]</a>
              <a href="subject.html#17891">[ subject ]</a>
              <a href="author.html#17891">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

21.03.2018 14:55, FredB &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;&gt;&gt;<i> Perhaps I should retry SMP but unfortunately in the past I had many
</I>&gt;&gt;&gt;<i> issues with, and some features I'm using still SMP-unaware
</I>&gt;&gt;<i> Squid's SMP itself does not solves SSL Bump issues. It's about
</I>&gt;&gt;<i> different
</I>&gt;&gt;<i> things, and, IMHO, irrelevant your load profile.
</I>&gt;<i>
</I>&gt;<i> I'm thinking about that, because the single squid core is 100% CPU
</I>&gt;<i> I tried with 900MB and 50MB without more success, I also added sslflags-NO_DEFAULT_CA
</I>&gt;<i>
</I>&gt;<i> How much simultaneous users do you have ? and bandwidth ? 
</I>200 users, 2 Gbps downstream.
&gt;<i>
</I>&gt;<i> I'm using this right now, the number of process used is very better now but still an issue with CPU  
</I>&gt;<i>
</I>&gt;<i> acl nobump dstdomain &quot;/home/squid/domains&quot;
</I>&gt;<i>
</I>&gt;<i> http_port 8080 ssl-bump cert=/etc/squid/ca_orion/cert generate-host-certificates=on sslflags=NO_DEFAULT_CA dynamic_cert_mem_cache_size=500MB
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /usr/lib/squid/ssl_db -M 500MB
</I>&gt;<i> sslcrtd_children 1000 startup=100 idle=5
</I>It does not work that way. There are still many processes. Scaling is
rarely linear.

Pls keep in mind, squid itself is thread-unaware. So, with thousands of
children you make serialization point by yourself from squid's size.
Another serialization point is SSL db on disk, due to it uses file
locking mechanism.

Both reasons leads to make bottleneck on SSL certgen processes.

So, you can't simple set 1000 children and expect good performing.

Just for record:
Performance tuning/scaling makes different. Much different.

1. You require to set good initial approximation. Not by proportion &quot;1
user - 1 child instance&quot;.
2. Then run your load and get performance statistics.
3. Analyze results.
4. Based on step 3, increasing/decreasing parameter value.

General rule: change only one parameter during tuning/scaling iteration.
&gt;<i>
</I>&gt;<i> sslproxy_capath /etc/ssl/certs/
</I>&gt;<i> sslproxy_foreign_intermediate_certs /etc/squid/ssl_certs/imtermediate.ca.pem
</I>&gt;<i>
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice nobump
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> Maybe there is a problem with memory, but as you can see here CPU is the point 
</I>Yes, indeed. You eat up too much RAM due to misconfiguration. But also
you have 2 waiting points descrived above.

I can recommend you get wait CPU/IO performance events to make sure.

Wait IO events can increasing CPU consumption, when such structures of
queues overflows etc. Usually this occurs on thread-aware apps with
spin-count synchronization mech, however, often can occurs on
single-threaded applications depenging implementation.
&gt;<i>
</I>&gt;<i> top - 09:50:04 up 16:16,  1 user,  load average: 1,72, 1,78, 1,39
</I>&gt;<i> Tasks: 393 total,   3 running, 390 sleeping,   0 stopped,   0 zombie
</I>&gt;<i> %Cpu(s):  8,4 us,  1,2 sy,  0,0 ni, 89,6 id,  0,3 wa,  0,0 hi,  0,5 si,  0,0 st
</I>&gt;<i> KiB Mem:  66086692 total, 28654240 used, 37432452 free,  2974568 buffers
</I>&gt;<i> KiB Swap:  1952764 total,        0 used,  1952764 free. 17653336 cached Mem
</I>&gt;<i>
</I>&gt;<i>   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                                                  
</I>&gt;<i>  9803 squid     20   0 3913044 3,452g  13464 R  99,9  5,5   7:47.47 squid                                                                                                                                                                    
</I>&gt;<i> 10051 e2guard+  20   0  0,122t 284392   5124 S  25,6  0,4   1:33.10 e2guardian                                                                                                                                                               
</I>&gt;<i>  9804 squid     20   0   21956   5628   4420 S   7,3  0,0   0:48.93 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9805 squid     20   0   21952   5672   4372 S   6,3  0,0   0:31.25 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9806 squid     20   0   21952   5476   4252 S   2,7  0,0   0:19.10 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9807 squid     20   0   21952   5616   4408 S   2,3  0,0   0:13.88 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9808 squid     20   0   21952   5540   4332 S   2,3  0,0   0:10.59 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9810 squid     20   0   21956   5536   4332 S   2,0  0,0   0:05.61 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9809 squid     20   0   21952   5584   4372 S   1,7  0,0   0:07.40 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9996 squid     20   0   25612   2924   2696 S   1,3  0,0   0:05.47 diskd                                                                                                                                                                    
</I>&gt;<i>  9995 squid     20   0   25612   2744   2516 S   1,0  0,0   0:04.41 diskd                                                                                                                                                                    
</I>&gt;<i>  9811 squid     20   0   21964   5588   4372 S   0,7  0,0   0:03.72 ssl_crtd                                                                                                                                                                 
</I>&gt;<i>  9813 squid     20   0   21848   5660   4464 S   0,7  0,0   0:01.96 ssl_crtd  
</I>As you can see, your Squid's consumes most CPU. And __not__ ssl_crtd.
So, most probably you have bottleneck between squid and ssl_crtd due to
reasons above.
&gt;<i>   
</I>&gt;<i>
</I>&gt;<i> Amos, there is way to add the domain requested in message like this ?
</I>&gt;<i>
</I>&gt;<i> 2018/03/21 09:45:30| Error negotiating SSL on FD 1835: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed (1/-1/0)
</I>&gt;<i> 2018/03/21 09:45:30| Error negotiating SSL on FD 4782: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed (1/-1/0)
</I>&gt;<i>
</I>&gt;<i> It can be very, very, useful for analysis 
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> FredB
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
&quot;C++ seems like a language suitable for firing other people's legs.&quot;

*****************************
* C++20 : Bug to the future *
*****************************

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/35830dcb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/35830dcb/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 659 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/35830dcb/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/35830dcb/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017890.html">[squid-users] SSLBump, system requirements ?
</A></li>
	<LI>Next message (by thread): <A HREF="017892.html">[squid-users] SSLBump, system requirements ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17891">[ date ]</a>
              <a href="thread.html#17891">[ thread ]</a>
              <a href="subject.html#17891">[ subject ]</a>
              <a href="author.html#17891">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
