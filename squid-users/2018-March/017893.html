<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSLBump, system requirements ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%2C%20system%20requirements%20%3F&In-Reply-To=%3C606705f6-fedd-d92f-b7b0-a477399018e0%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017892.html">
   <LINK REL="Next"  HREF="017896.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSLBump, system requirements ?</H1>
    <B>Yuri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSLBump%2C%20system%20requirements%20%3F&In-Reply-To=%3C606705f6-fedd-d92f-b7b0-a477399018e0%40gmail.com%3E"
       TITLE="[squid-users] SSLBump, system requirements ?">yvoinov at gmail.com
       </A><BR>
    <I>Wed Mar 21 13:19:19 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017892.html">[squid-users] SSLBump, system requirements ?
</A></li>
        <LI>Next message (by thread): <A HREF="017896.html">[squid-users] SSLBump, system requirements ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17893">[ date ]</a>
              <a href="thread.html#17893">[ thread ]</a>
              <a href="subject.html#17893">[ subject ]</a>
              <a href="author.html#17893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Finally.

Premature optimization is the root of all evils.

Never start new setups from your assumptions only. Set good enough
starting values and monitor. Increase only if required.

And, pls, don't think all performance problems can solves with giant RAM.

It does not matter how big your RAM is. It's important how you use it.

Scaling is also done differently.


21.03.2018 19:08, Yuri &#1087;&#1080;&#1096;&#1077;&#1090;:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 21.03.2018 14:55, FredB &#1087;&#1080;&#1096;&#1077;&#1090;:
</I>&gt;&gt;&gt;&gt;<i> Perhaps I should retry SMP but unfortunately in the past I had many
</I>&gt;&gt;&gt;&gt;<i> issues with, and some features I'm using still SMP-unaware
</I>&gt;&gt;&gt;<i> Squid's SMP itself does not solves SSL Bump issues. It's about
</I>&gt;&gt;&gt;<i> different
</I>&gt;&gt;&gt;<i> things, and, IMHO, irrelevant your load profile.
</I>&gt;&gt;<i> I'm thinking about that, because the single squid core is 100% CPU
</I>&gt;&gt;<i> I tried with 900MB and 50MB without more success, I also added sslflags-NO_DEFAULT_CA
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How much simultaneous users do you have ? and bandwidth ? 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm using this right now, the number of process used is very better now but still an issue with CPU  
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl nobump dstdomain &quot;/home/squid/domains&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 8080 ssl-bump cert=/etc/squid/ca_orion/cert generate-host-certificates=on sslflags=NO_DEFAULT_CA dynamic_cert_mem_cache_size=500MB
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /usr/lib/squid/ssl_db -M 500MB
</I>&gt;&gt;<i> sslcrtd_children 1000 startup=100 idle=5
</I>&gt;<i> Still misconfiguration. Pay attention. You set
</I>&gt;<i> dynamic_cert_mem_cache_size=500MB
</I>&gt;<i> Again - why so much?
</I>&gt;<i>
</I>&gt;<i> Do not think that a lot of RAM will not make anything worse.
</I>&gt;<i>
</I>&gt;<i> For some unknown reason, you set dynamic_cert_mem_cache_size equal to
</I>&gt;<i> -M on-disk fs limit. It is enough to set dynamic_cert_mem_cache_size
</I>&gt;<i> to 1/10-1/20 of overall SSL db on-disk size.
</I>&gt;<i>
</I>&gt;<i> And still too high upper children limit. Just imagine, how much RAM
</I>&gt;<i> will eat by 1000 processes. Each with own heap.
</I>&gt;<i>
</I>&gt;<i> It seems for me, in your case good initial approximation will be
</I>&gt;<i>
</I>&gt;<i> sslcrtd_children 256 startup=100 idle=200
</I>&gt;<i>
</I>&gt;<i> No more. Other changes will do only based on performance stats and
</I>&gt;<i> diagnostics.
</I>&gt;<i>
</I>&gt;&gt;<i> sslproxy_capath /etc/ssl/certs/
</I>&gt;&gt;<i> sslproxy_foreign_intermediate_certs /etc/squid/ssl_certs/imtermediate.ca.pem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;<i> ssl_bump splice nobump
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Maybe there is a problem with memory, but as you can see here CPU is the point 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> top - 09:50:04 up 16:16,  1 user,  load average: 1,72, 1,78, 1,39
</I>&gt;&gt;<i> Tasks: 393 total,   3 running, 390 sleeping,   0 stopped,   0 zombie
</I>&gt;&gt;<i> %Cpu(s):  8,4 us,  1,2 sy,  0,0 ni, 89,6 id,  0,3 wa,  0,0 hi,  0,5 si,  0,0 st
</I>&gt;&gt;<i> KiB Mem:  66086692 total, 28654240 used, 37432452 free,  2974568 buffers
</I>&gt;&gt;<i> KiB Swap:  1952764 total,        0 used,  1952764 free. 17653336 cached Mem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                                                  
</I>&gt;&gt;<i>  9803 squid     20   0 3913044 3,452g  13464 R  99,9  5,5   7:47.47 squid                                                                                                                                                                    
</I>&gt;&gt;<i> 10051 e2guard+  20   0  0,122t 284392   5124 S  25,6  0,4   1:33.10 e2guardian                                                                                                                                                               
</I>&gt;&gt;<i>  9804 squid     20   0   21956   5628   4420 S   7,3  0,0   0:48.93 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9805 squid     20   0   21952   5672   4372 S   6,3  0,0   0:31.25 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9806 squid     20   0   21952   5476   4252 S   2,7  0,0   0:19.10 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9807 squid     20   0   21952   5616   4408 S   2,3  0,0   0:13.88 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9808 squid     20   0   21952   5540   4332 S   2,3  0,0   0:10.59 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9810 squid     20   0   21956   5536   4332 S   2,0  0,0   0:05.61 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9809 squid     20   0   21952   5584   4372 S   1,7  0,0   0:07.40 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9996 squid     20   0   25612   2924   2696 S   1,3  0,0   0:05.47 diskd                                                                                                                                                                    
</I>&gt;&gt;<i>  9995 squid     20   0   25612   2744   2516 S   1,0  0,0   0:04.41 diskd                                                                                                                                                                    
</I>&gt;&gt;<i>  9811 squid     20   0   21964   5588   4372 S   0,7  0,0   0:03.72 ssl_crtd                                                                                                                                                                 
</I>&gt;&gt;<i>  9813 squid     20   0   21848   5660   4464 S   0,7  0,0   0:01.96 ssl_crtd    
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos, there is way to add the domain requested in message like this ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2018/03/21 09:45:30| Error negotiating SSL on FD 1835: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed (1/-1/0)
</I>&gt;&gt;<i> 2018/03/21 09:45:30| Error negotiating SSL on FD 4782: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed (1/-1/0)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It can be very, very, useful for analysis 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FredB
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> &quot;C++ seems like a language suitable for firing other people's legs.&quot;
</I>&gt;<i>
</I>&gt;<i> *****************************
</I>&gt;<i> * C++20 : Bug to the future *
</I>&gt;<i> *****************************
</I>
-- 
&quot;C++ seems like a language suitable for firing other people's legs.&quot;

*****************************
* C++20 : Bug to the future *
*****************************

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/7a1d5c3e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/7a1d5c3e/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 659 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/7a1d5c3e/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180321/7a1d5c3e/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017892.html">[squid-users] SSLBump, system requirements ?
</A></li>
	<LI>Next message (by thread): <A HREF="017896.html">[squid-users] SSLBump, system requirements ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17893">[ date ]</a>
              <a href="thread.html#17893">[ thread ]</a>
              <a href="subject.html#17893">[ subject ]</a>
              <a href="author.html#17893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
