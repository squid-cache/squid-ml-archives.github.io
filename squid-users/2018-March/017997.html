<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] https proxy authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https%20proxy%20authentication&In-Reply-To=%3C1de18b37-385c-e20f-7feb-432fd403bcdf%40matrixscience.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017996.html">
   <LINK REL="Next"  HREF="018000.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] https proxy authentication</H1>
    <B>Adam Weremczuk</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https%20proxy%20authentication&In-Reply-To=%3C1de18b37-385c-e20f-7feb-432fd403bcdf%40matrixscience.com%3E"
       TITLE="[squid-users] https proxy authentication">adamw at matrixscience.com
       </A><BR>
    <I>Thu Mar 29 15:24:11 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="017996.html">[squid-users] Squid proxychains problem
</A></li>
        <LI>Next message (by thread): <A HREF="018000.html">[squid-users] https proxy authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17997">[ date ]</a>
              <a href="thread.html#17997">[ thread ]</a>
              <a href="subject.html#17997">[ subject ]</a>
              <a href="author.html#17997">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I have a solution in place with a dedicated squid LXC container (v 
3.1.20-2.2).
Both http and https proxy run on default port 3128.
Https in tunneled in http using CONNECT.
There is no authentication in place and both are working fine.

For testing purposes we also use an Apache (v 2.2.22-13) proxy forwarder 
running on a different machine on port 80 as &quot;aproxy&quot;.

Config below:

/# Authenticated proxy for testing purposes//
//# We forward http/s requests to the local proxy server//
//ProxyRequests On//
//ProxyVia On//
//ProxyRemote http <A HREF="http://proxy.example.internal:3128//">http://proxy.example.internal:3128//</A>
//ProxyRemote https <A HREF="http://proxy.example.internal:3128//">http://proxy.example.internal:3128//</A>
//ProxyDomain .example.internal//
//NoProxy .example.internal 192.168.x.x/22//
//&lt;Proxy *&gt;//
//&#160;&#160; Order Deny,Allow//
//&#160;&#160; Deny from all//
//&#160;&#160; Allow from 192.168.x.x/22//
//&#160;&#160; AuthType Basic//
//&#160;&#160; AuthName ProxyAuth//
//&#160;&#160; AuthUserFile /etc/apache2/proxypasswd//
//&#160;&#160; Require valid-user//
//&lt;/Proxy&gt;/

This is working as expected for http requests:

1. Unauthenticated (failure):

/$ http_proxy=<A HREF="http://aproxy:80//">http://aproxy:80//</A>
//$ wget <A HREF="http://example.com">http://example.com</A> 2&gt;&amp;1 | grep response//
//Proxy request sent, awaiting response... 407 Proxy Authentication 
Required/

2. Username with password (success):

/$ http_proxy=<A HREF="http://username1:password@aproxy:80//">http://username1:password@aproxy:80//</A>
//$ wget <A HREF="http://example.com">http://example.com</A> 2&gt;&amp;1 | grep response//
//Proxy request sent, awaiting response... 200 OK/

3. Username without password (success):
/
//$ http_proxy=<A HREF="http://username2:@aproxy:80//">http://username2:@aproxy:80//</A>
//$ wget <A HREF="http://example.com">http://example.com</A> 2&gt;&amp;1 | grep response//
//Proxy request sent, awaiting response... 200 OK/

My *PROBLEM* is I can't find a way to use authentication for proxied 
https requests.

 From a LAN client trying to establish connection:

/$ echo $http_proxy//
//<A HREF="http://username1:password@aproxy:80//">http://username1:password@aproxy:80//</A>
/

/$ echo $https_proxy//
//<A HREF="http://username1:password@aproxy:80//">http://username1:password@aproxy:80//</A>
/

/$ wget --server-response <A HREF="https://example.com">https://example.com</A> 2&gt;&amp;1//
//--2018-03-29 15:20:44--&#160; <A HREF="https://example.com///">https://example.com///</A>
//Resolving aproxy (aproxy)... 192.168.x.x//
//Connecting to aproxy (aproxy)|192.168.x.x|:80... connected.//
//Proxy tunneling failed: Service Temporarily UnavailableUnable to 
establish SSL connection./

On &quot;aproxy&quot; only one line in apache error log (even in debug mode):

/[Thu Mar 29 15:21:59 2018] [error] (111)Connection refused: proxy: 
CONNECT: attempt to connect to 93.184.216.34:443 (example.com) failed/

Nothing is logged on squid &quot;proxy&quot; which is the next hop.

What's the easiest way to enable authenticated https proxying?
I don't want to enable it for our main production proxy:3128
Or maybe it's already supposed to work but I'm missing something?

Please advise.

Thanks
Adam

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180329/937aaa92/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180329/937aaa92/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="017996.html">[squid-users] Squid proxychains problem
</A></li>
	<LI>Next message (by thread): <A HREF="018000.html">[squid-users] https proxy authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17997">[ date ]</a>
              <a href="thread.html#17997">[ thread ]</a>
              <a href="subject.html#17997">[ subject ]</a>
              <a href="author.html#17997">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
