<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and squid's own IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C92821481-40de-b0c9-c396-e501a15c727f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018173.html">
   <LINK REL="Next"  HREF="018176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and squid's own IP address?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C92821481-40de-b0c9-c396-e501a15c727f%40treenet.co.nz%3E"
       TITLE="[squid-users] deny_info and squid's own IP address?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May  1 03:40:13 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018173.html">[squid-users] Squid 3.5.27 - While access https website, always &quot;Your connection is not secure&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="018176.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18174">[ date ]</a>
              <a href="thread.html#18174">[ thread ]</a>
              <a href="subject.html#18174">[ subject ]</a>
              <a href="author.html#18174">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/05/18 00:54, Amish wrote:
&gt;<i> Hello
</I>&gt;<i> 
</I>&gt;<i> I have 2 LAN interface on squid box, say department A (192.168.1.1/24)
</I>&gt;<i> and department B (192.168.2.1/24)
</I>&gt;<i> 
</I>&gt;<i> I have few banned sites. Say Facebook.
</I>&gt;<i> 
</I>&gt;<i> I have HTTP server (running on same server as squid) which shows custom
</I>&gt;<i> pages with custom logo based on IP address.
</I>&gt;<i> 
</I>&gt;<i> When request comes for a banned site I would like client to be
</I>&gt;<i> redirected based on squid's own IP.
</I>
Firstly, is there any particular reason you are requiring it to be a
redirect?
 from what you have said it appears you can achieve the same outcome
without the extra web server by using a custom error page.

&gt;<i> 
</I>&gt;<i> Something like this:
</I>&gt;<i> 
</I>&gt;<i> acl blockedsites url_regex facebook
</I>&gt;<i> http_access deny blockedsites
</I>&gt;<i> deny_info <A HREF="http://SQUID-IP/banned.html">http://SQUID-IP/banned.html</A> blockedsites
</I>&gt;<i> 
</I>&gt;<i> I need SQUID-IP to be replaced by 192.168.1.1 or 192.168.2.1 depending
</I>&gt;<i> on the IP on which connection came to.
</I>&gt;<i> 
</I>
Secondly, I think you are probably looking at this from the wrong
direction. With the topology you have described each of these &quot;Squid
IPs&quot; is actually just the IP facing a certain client subnet. So the
client subnet is what you want to be detecting, not the specific Squid IP.


Thirdly, on the issue of %h - the Squid hostname is *required* to
resolve in DNS explicitly so clients can access things like these URLs.
If your network and DNS is configured correctly each client subnet
should resolve that hostname to the relevant IP which you are trying to
&quot;pass&quot; to the web server in your redirect URL. So they will naturally
(and only) connect to the web server (or Squid itself) using the right
IP anyway - the web server should be able to detect what it needs from
its own inbound TCP/IP connection instead of using raw-IPs in the traffic.


There are three options available to work around broken DNS:


Option 1) to do exactly (and only) what you asked for.

Currently this can be done with an external helper:

 external_acl_type getIp concurrency=100 %MYADDR /path/to/script
 deny_info 302:<A HREF="http://%et/banned.html">http://%et/banned.html</A> getIp

where the script just echos back to Squid the IP it was given like so:
    [channel-id] OK message=&quot;&lt;input-IP&gt;&quot;\n


Option 2) to use the client IP and have your web server respond based on
those subnets instead of Squid IP.

 acl clients1 src 192.168.1.0/24
 deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients1
 http_access deny blockedsites clients1

 acl clients2 src 192.168.2.0/24
 deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients2
 http_access deny blockedsites clients2


** If you really *have* to use Squid-IP, this can work with localip ACL
type instead of src. But then you have to bake each Squid-IP variation
into the deny_info URL instead of using %i.



Option 3) to use a custom error page instead of a redirect.

Place your banned.html page into /etc/squid/banned.html and either a)
write it with javascripts that pull in the right images/branding based
on client IPs.

  deny_info 403:/etc/squid/banned.html blockedsites

** Like (2) above this can use Squid-IP (via localip ACL type) if you
really have to. But with the same limitation of using different files
for branding instead of javascript for dynamic sub-resource/image fetching.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018173.html">[squid-users] Squid 3.5.27 - While access https website, always &quot;Your connection is not secure&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="018176.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18174">[ date ]</a>
              <a href="thread.html#18174">[ thread ]</a>
              <a href="subject.html#18174">[ subject ]</a>
              <a href="author.html#18174">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
