<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and squid's own IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C83d17937-119d-e41e-928a-be20445b8db9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018174.html">
   <LINK REL="Next"  HREF="018179.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and squid's own IP address?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C83d17937-119d-e41e-928a-be20445b8db9%40treenet.co.nz%3E"
       TITLE="[squid-users] deny_info and squid's own IP address?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May  1 03:52:14 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018174.html">[squid-users] deny_info and squid's own IP address?
</A></li>
        <LI>Next message (by thread): <A HREF="018179.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18176">[ date ]</a>
              <a href="thread.html#18176">[ thread ]</a>
              <a href="subject.html#18176">[ subject ]</a>
              <a href="author.html#18176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 01/05/18 15:40, Amos Jeffries wrote:
&gt;<i> On 01/05/18 00:54, Amish wrote:
</I>&gt;&gt;<i> Hello
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have 2 LAN interface on squid box, say department A (192.168.1.1/24)
</I>&gt;&gt;<i> and department B (192.168.2.1/24)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have few banned sites. Say Facebook.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have HTTP server (running on same server as squid) which shows custom
</I>&gt;&gt;<i> pages with custom logo based on IP address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When request comes for a banned site I would like client to be
</I>&gt;&gt;<i> redirected based on squid's own IP.
</I>&gt;<i> 
</I>&gt;<i> Firstly, is there any particular reason you are requiring it to be a
</I>&gt;<i> redirect?
</I>&gt;<i>  from what you have said it appears you can achieve the same outcome
</I>&gt;<i> without the extra web server by using a custom error page.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Something like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl blockedsites url_regex facebook
</I>&gt;&gt;<i> http_access deny blockedsites
</I>&gt;&gt;<i> deny_info <A HREF="http://SQUID-IP/banned.html">http://SQUID-IP/banned.html</A> blockedsites
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I need SQUID-IP to be replaced by 192.168.1.1 or 192.168.2.1 depending
</I>&gt;&gt;<i> on the IP on which connection came to.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Secondly, I think you are probably looking at this from the wrong
</I>&gt;<i> direction. With the topology you have described each of these &quot;Squid
</I>&gt;<i> IPs&quot; is actually just the IP facing a certain client subnet. So the
</I>&gt;<i> client subnet is what you want to be detecting, not the specific Squid IP.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thirdly, on the issue of %h - the Squid hostname is *required* to
</I>&gt;<i> resolve in DNS explicitly so clients can access things like these URLs.
</I>&gt;<i> If your network and DNS is configured correctly each client subnet
</I>&gt;<i> should resolve that hostname to the relevant IP which you are trying to
</I>&gt;<i> &quot;pass&quot; to the web server in your redirect URL. So they will naturally
</I>&gt;<i> (and only) connect to the web server (or Squid itself) using the right
</I>&gt;<i> IP anyway - the web server should be able to detect what it needs from
</I>&gt;<i> its own inbound TCP/IP connection instead of using raw-IPs in the traffic.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> There are three options available to work around broken DNS:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Option 1) to do exactly (and only) what you asked for.
</I>&gt;<i> 
</I>&gt;<i> Currently this can be done with an external helper:
</I>&gt;<i> 
</I>&gt;<i>  external_acl_type getIp concurrency=100 %MYADDR /path/to/script
</I>&gt;<i>  deny_info 302:<A HREF="http://%et/banned.html">http://%et/banned.html</A> getIp
</I>&gt;<i> 
</I>&gt;<i> where the script just echos back to Squid the IP it was given like so:
</I>&gt;<i>     [channel-id] OK message=&quot;&lt;input-IP&gt;&quot;\n
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Option 2) to use the client IP and have your web server respond based on
</I>&gt;<i> those subnets instead of Squid IP.
</I>&gt;<i> 
</I>&gt;<i>  acl clients1 src 192.168.1.0/24
</I>&gt;<i>  deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients1
</I>&gt;<i>  http_access deny blockedsites clients1
</I>&gt;<i> 
</I>&gt;<i>  acl clients2 src 192.168.2.0/24
</I>&gt;<i>  deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients2
</I>&gt;<i>  http_access deny blockedsites clients2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ** If you really *have* to use Squid-IP, this can work with localip ACL
</I>&gt;<i> type instead of src. But then you have to bake each Squid-IP variation
</I>&gt;<i> into the deny_info URL instead of using %i.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Option 3) to use a custom error page instead of a redirect.
</I>&gt;<i> 
</I>&gt;<i> Place your banned.html page into /etc/squid/banned.html and either a)
</I>&gt;<i> write it with javascripts that pull in the right images/branding based
</I>&gt;<i> on client IPs.
</I>
or b) use multiple pages with different branding.

&gt;<i> 
</I>&gt;<i>   deny_info 403:/etc/squid/banned.html blockedsites
</I>&gt;<i> 
</I>&gt;<i> ** Like (2) above this can use Squid-IP (via localip ACL type) if you
</I>&gt;<i> really have to. But with the same limitation of using different files
</I>&gt;<i> for branding instead of javascript for dynamic sub-resource/image fetching.
</I>&gt;<i> 
</I>

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018174.html">[squid-users] deny_info and squid's own IP address?
</A></li>
	<LI>Next message (by thread): <A HREF="018179.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18176">[ date ]</a>
              <a href="thread.html#18176">[ thread ]</a>
              <a href="subject.html#18176">[ subject ]</a>
              <a href="author.html#18176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
