<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and squid's own IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C12a68dab-dcde-7c31-0466-ce3eb98ae8a8%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018176.html">
   <LINK REL="Next"  HREF="018180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and squid's own IP address?</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C12a68dab-dcde-7c31-0466-ce3eb98ae8a8%40gmail.com%3E"
       TITLE="[squid-users] deny_info and squid's own IP address?">anon.amish at gmail.com
       </A><BR>
    <I>Tue May  1 07:44:32 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018176.html">[squid-users] deny_info and squid's own IP address?
</A></li>
        <LI>Next message (by thread): <A HREF="018180.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18179">[ date ]</a>
              <a href="thread.html#18179">[ thread ]</a>
              <a href="subject.html#18179">[ subject ]</a>
              <a href="author.html#18179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

First of thanks a lot for taking your time out for replying to my query.

My replies are inline.

On Tuesday 01 May 2018 09:10 AM, Amos Jeffries wrote:
&gt;<i> On 01/05/18 00:54, Amish wrote:
</I>&gt;&gt;<i> Hello
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have 2 LAN interface on squid box, say department A (192.168.1.1/24)
</I>&gt;&gt;<i> and department B (192.168.2.1/24)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have few banned sites. Say Facebook.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have HTTP server (running on same server as squid) which shows custom
</I>&gt;&gt;<i> pages with custom logo based on IP address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When request comes for a banned site I would like client to be
</I>&gt;&gt;<i> redirected based on squid's own IP.
</I>&gt;<i> Firstly, is there any particular reason you are requiring it to be a
</I>&gt;<i> redirect?
</I>&gt;<i>   from what you have said it appears you can achieve the same outcome
</I>&gt;<i> without the extra web server by using a custom error page.
</I>
No I cant use custom error page as Javascript will leak the IP range of 
department A to department B.
(I had simplified my example, its actually two companies and not two 
departments infact I have 4-5 companies/subnets)

&gt;<i> Thirdly, on the issue of %h - the Squid hostname is *required* to
</I>&gt;<i> resolve in DNS explicitly so clients can access things like these URLs.
</I>&gt;<i> If your network and DNS is configured correctly each client subnet
</I>&gt;<i> should resolve that hostname to the relevant IP which you are trying to
</I>&gt;<i> &quot;pass&quot; to the web server in your redirect URL. So they will naturally
</I>&gt;<i> (and only) connect to the web server (or Squid itself) using the right
</I>&gt;<i> IP anyway - the web server should be able to detect what it needs from
</I>&gt;<i> its own inbound TCP/IP connection instead of using raw-IPs in the traffic.
</I>&gt;<i>
</I>Some company uses OpenDNS, other Cloudflare, other Google etc.

So DNS will not resolve the hostname to same as %MYADDR.

&gt;<i> There are three options available to work around broken DNS:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Option 1) to do exactly (and only) what you asked for.
</I>&gt;<i>
</I>&gt;<i> Currently this can be done with an external helper:
</I>&gt;<i>
</I>&gt;<i>   external_acl_type getIp concurrency=100 %MYADDR /path/to/script
</I>&gt;<i>   deny_info 302:<A HREF="http://%et/banned.html">http://%et/banned.html</A> getIp
</I>&gt;<i>
</I>&gt;<i> where the script just echos back to Squid the IP it was given like so:
</I>&gt;<i>      [channel-id] OK message=&quot;&lt;input-IP&gt;&quot;\n
</I>&gt;<i>
</I>
Based on documentation of FORMAT for deny_info, I think you mean %o and 
not %et

Also will this &quot;message&quot; be available if I change by http_access line to:
deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
http_access deny blockedsites getIp

will &quot;message&quot; of getIp be available to deny_info of blockedsites?

I will give this a try*, **however please see the end of the e-mail for 
a feature request.*

&gt;<i> Option 2) to use the client IP and have your web server respond based on
</I>&gt;<i> those subnets instead of Squid IP.
</I>&gt;<i>
</I>&gt;<i>   acl clients1 src 192.168.1.0/24
</I>&gt;<i>   deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients1
</I>&gt;<i>   http_access deny blockedsites clients1
</I>&gt;<i>
</I>&gt;<i>   acl clients2 src 192.168.2.0/24
</I>&gt;<i>   deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients2
</I>&gt;<i>   http_access deny blockedsites clients2
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ** If you really *have* to use Squid-IP, this can work with localip ACL
</I>&gt;<i> type instead of src. But then you have to bake each Squid-IP variation
</I>&gt;<i> into the deny_info URL instead of using %i.
</I>&gt;<i>
</I>
I will have to do this for each company. But I would like to keep 
squid.conf simple and minimal.

&gt;<i>
</I>&gt;<i> Option 3) to use a custom error page instead of a redirect.
</I>&gt;<i>
</I>&gt;<i> Place your banned.html page into /etc/squid/banned.html and either a)
</I>&gt;<i> write it with javascripts that pull in the right images/branding based
</I>&gt;<i> on client IPs.
</I>&gt;<i>
</I>&gt;<i>    deny_info 403:/etc/squid/banned.html blockedsites
</I>&gt;<i>
</I>&gt;<i> ** Like (2) above this can use Squid-IP (via localip ACL type) if you
</I>&gt;<i> really have to. But with the same limitation of using different files
</I>&gt;<i> for branding instead of javascript for dynamic sub-resource/image fetching.
</I>
As stated earlier, this would leak IP range information.


_*Feature request:*_
Can we have the following switch-case in file errorpage.cc?

Source: 
<A HREF="https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857">https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857</A>

Currently case 'I' (capital i) for building_deny_info_url returns string 
&quot;[unknown]&quot;

Can it be modified to return &quot;interface&quot; address? i.e. same as MYADDR

I believe it would be just few (may be one) line change in code.

I can create a PR if required but can you or someone guide me on how to 
fetch MYADDR?

After this feature - all I would need to do is:

deny_info <A HREF="http://%I/banned.html">http://%I/banned.html</A> blockedsites

Thank you again for your help.

Amish

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180501/5041253b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180501/5041253b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018176.html">[squid-users] deny_info and squid's own IP address?
</A></li>
	<LI>Next message (by thread): <A HREF="018180.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18179">[ date ]</a>
              <a href="thread.html#18179">[ thread ]</a>
              <a href="subject.html#18179">[ subject ]</a>
              <a href="author.html#18179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
