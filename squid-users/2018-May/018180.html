<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and squid's own IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3Ce466cd2d-02ac-7723-1fec-b631652dfcb8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018179.html">
   <LINK REL="Next"  HREF="018181.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and squid's own IP address?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3Ce466cd2d-02ac-7723-1fec-b631652dfcb8%40treenet.co.nz%3E"
       TITLE="[squid-users] deny_info and squid's own IP address?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May  1 09:11:33 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018179.html">[squid-users] deny_info and squid's own IP address?
</A></li>
        <LI>Next message (by thread): <A HREF="018181.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18180">[ date ]</a>
              <a href="thread.html#18180">[ thread ]</a>
              <a href="subject.html#18180">[ subject ]</a>
              <a href="author.html#18180">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/05/18 19:44, Amish wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> First of thanks a lot for taking your time out for replying to my query.
</I>&gt;<i> 
</I>&gt;<i> My replies are inline.
</I>&gt;<i> 
</I>&gt;<i> On Tuesday 01 May 2018 09:10 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 01/05/18 00:54, Amish wrote:
</I>&gt;&gt;&gt;<i> Hello
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have 2 LAN interface on squid box, say department A (192.168.1.1/24)
</I>&gt;&gt;&gt;<i> and department B (192.168.2.1/24)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have few banned sites. Say Facebook.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have HTTP server (running on same server as squid) which shows custom
</I>&gt;&gt;&gt;<i> pages with custom logo based on IP address.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> When request comes for a banned site I would like client to be
</I>&gt;&gt;&gt;<i> redirected based on squid's own IP.
</I>&gt;&gt;<i> Firstly, is there any particular reason you are requiring it to be a
</I>&gt;&gt;<i> redirect?
</I>&gt;&gt;<i>  from what you have said it appears you can achieve the same outcome
</I>&gt;&gt;<i> without the extra web server by using a custom error page.
</I>&gt;<i> 
</I>&gt;<i> No I cant use custom error page as Javascript will leak the IP range of
</I>&gt;<i> department A to department B.
</I>&gt;<i> (I had simplified my example, its actually two companies and not two
</I>&gt;<i> departments infact I have 4-5 companies/subnets)
</I>&gt;<i> 
</I>&gt;&gt;<i> Thirdly, on the issue of %h - the Squid hostname is *required* to
</I>&gt;&gt;<i> resolve in DNS explicitly so clients can access things like these URLs.
</I>&gt;&gt;<i> If your network and DNS is configured correctly each client subnet
</I>&gt;&gt;<i> should resolve that hostname to the relevant IP which you are trying to
</I>&gt;&gt;<i> &quot;pass&quot; to the web server in your redirect URL. So they will naturally
</I>&gt;&gt;<i> (and only) connect to the web server (or Squid itself) using the right
</I>&gt;&gt;<i> IP anyway - the web server should be able to detect what it needs from
</I>&gt;&gt;<i> its own inbound TCP/IP connection instead of using raw-IPs in the traffic.
</I>&gt;&gt;<i>
</I>&gt;<i> Some company uses OpenDNS, other Cloudflare, other Google etc.
</I>&gt;<i> 
</I>&gt;<i> So DNS will not resolve the hostname to same as %MYADDR.
</I>
I suspect something is going screwy there. How are these clients getting
to the proxy if they resolve its name to a different IP than they
connect to?


&gt;<i> 
</I>&gt;&gt;<i> There are three options available to work around broken DNS:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Option 1) to do exactly (and only) what you asked for.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Currently this can be done with an external helper:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  external_acl_type getIp concurrency=100 %MYADDR /path/to/script
</I>&gt;&gt;<i>  deny_info 302:<A HREF="http://%et/banned.html">http://%et/banned.html</A> getIp
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> where the script just echos back to Squid the IP it was given like so:
</I>&gt;&gt;<i>     [channel-id] OK message=&quot;&lt;input-IP&gt;&quot;\n
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Based on documentation of FORMAT for deny_info, I think you mean %o and
</I>&gt;<i> not %et
</I>
Ah, yes. Sorry. Getting my legacy formats mixed up.

&gt;<i> 
</I>&gt;<i> Also will this &quot;message&quot; be available if I change by http_access line to:
</I>&gt;<i> deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
</I>&gt;<i> http_access deny blockedsites getIp
</I>&gt;<i> 
</I>&gt;<i> will &quot;message&quot; of getIp be available to deny_info of blockedsites?
</I>
The message will persist as an annotation in the transaction, but only
from the point the external ACL is tested. So the deny_info has to be
attached to the external ACL or something following it.

Also, deny_info only works if it is attached to the *last* ACL named on
a line.

So:

 deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> getIp
 http_access deny blockedsites getIp

or,

 deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
 http_access deny getIp blockedsites

or,
 deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
 http_access deny getIp !all
 ...
 http_access deny blockedsites


should work, but other orderings do not.


&gt;<i> 
</I>&gt;<i> I will give this a try*, **however please see the end of the e-mail for
</I>&gt;<i> a feature request.*
</I>&gt;<i> 
</I>&gt;&gt;<i> Option 2) to use the client IP and have your web server respond based on
</I>&gt;&gt;<i> those subnets instead of Squid IP.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  acl clients1 src 192.168.1.0/24
</I>&gt;&gt;<i>  deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients1
</I>&gt;&gt;<i>  http_access deny blockedsites clients1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  acl clients2 src 192.168.2.0/24
</I>&gt;&gt;<i>  deny_info 302:<A HREF="http://%h/banned.html?%i">http://%h/banned.html?%i</A> clients2
</I>&gt;&gt;<i>  http_access deny blockedsites clients2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ** If you really *have* to use Squid-IP, this can work with localip ACL
</I>&gt;&gt;<i> type instead of src. But then you have to bake each Squid-IP variation
</I>&gt;&gt;<i> into the deny_info URL instead of using %i.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I will have to do this for each company. But I would like to keep
</I>&gt;<i> squid.conf simple and minimal.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Option 3) to use a custom error page instead of a redirect.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Place your banned.html page into /etc/squid/banned.html and either a)
</I>&gt;&gt;<i> write it with javascripts that pull in the right images/branding based
</I>&gt;&gt;<i> on client IPs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   deny_info 403:/etc/squid/banned.html blockedsites
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ** Like (2) above this can use Squid-IP (via localip ACL type) if you
</I>&gt;&gt;<i> really have to. But with the same limitation of using different files
</I>&gt;&gt;<i> for branding instead of javascript for dynamic sub-resource/image fetching.
</I>&gt;<i> 
</I>&gt;<i> As stated earlier, this would leak IP range information.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _*Feature request:*_
</I>&gt;<i> Can we have the following switch-case in file errorpage.cc?
</I>&gt;<i> 
</I>&gt;<i> Source:
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857">https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857</A>
</I>&gt;<i> 
</I>&gt;<i> Currently case 'I' (capital i) for building_deny_info_url returns string
</I>&gt;<i> &quot;[unknown]&quot;
</I>&gt;<i> 
</I>&gt;<i> Can it be modified to return &quot;interface&quot; address? i.e. same as MYADDR
</I>&gt;<i> 
</I>&gt;<i> I believe it would be just few (may be one) line change in code.
</I>&gt;<i> 
</I>&gt;<i> I can create a PR if required but can you or someone guide me on how to
</I>&gt;<i> fetch MYADDR?
</I>
A PR is welcome, but re-using a %macro which already has a different
definition will add problems in the long-term plan of conversion to
logformat %macro codes. So picking a letter that has not yet been used
for anything would be best.

The Squid IP:port on client requests should be available to that code as
request-&gt;masterXaction-&gt;tcpClient-&gt;local , the request and tcpClient
pointers may be nil since not all transactions have a client or the
error may be about the lack of an HTTP request on the TCP connection.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018179.html">[squid-users] deny_info and squid's own IP address?
</A></li>
	<LI>Next message (by thread): <A HREF="018181.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18180">[ date ]</a>
              <a href="thread.html#18180">[ thread ]</a>
              <a href="subject.html#18180">[ subject ]</a>
              <a href="author.html#18180">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
