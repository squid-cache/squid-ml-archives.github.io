<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and squid's own IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3Cc77df3c5-957a-57eb-e5ff-318efe89edb4%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018180.html">
   <LINK REL="Next"  HREF="018182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and squid's own IP address?</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3Cc77df3c5-957a-57eb-e5ff-318efe89edb4%40gmail.com%3E"
       TITLE="[squid-users] deny_info and squid's own IP address?">anon.amish at gmail.com
       </A><BR>
    <I>Tue May  1 11:10:30 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018180.html">[squid-users] deny_info and squid's own IP address?
</A></li>
        <LI>Next message (by thread): <A HREF="018182.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18181">[ date ]</a>
              <a href="thread.html#18181">[ thread ]</a>
              <a href="subject.html#18181">[ subject ]</a>
              <a href="author.html#18181">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tuesday 01 May 2018 02:41 PM, Amos Jeffries wrote:
&gt;<i> On 01/05/18 19:44, Amish wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> First of thanks a lot for taking your time out for replying to my query.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My replies are inline.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tuesday 01 May 2018 09:10 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;<i> On 01/05/18 00:54, Amish wrote:
</I>&gt;&gt;&gt;&gt;<i> Hello
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I have 2 LAN interface on squid box, say department A (192.168.1.1/24)
</I>&gt;&gt;&gt;&gt;<i> and department B (192.168.2.1/24)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I have few banned sites. Say Facebook.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I have HTTP server (running on same server as squid) which shows custom
</I>&gt;&gt;&gt;&gt;<i> pages with custom logo based on IP address.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> When request comes for a banned site I would like client to be
</I>&gt;&gt;&gt;&gt;<i> redirected based on squid's own IP.
</I>&gt;&gt;&gt;<i> Firstly, is there any particular reason you are requiring it to be a
</I>&gt;&gt;&gt;<i> redirect?
</I>&gt;&gt;&gt;<i>   from what you have said it appears you can achieve the same outcome
</I>&gt;&gt;&gt;<i> without the extra web server by using a custom error page.
</I>&gt;&gt;<i> No I cant use custom error page as Javascript will leak the IP range of
</I>&gt;&gt;<i> department A to department B.
</I>&gt;&gt;<i> (I had simplified my example, its actually two companies and not two
</I>&gt;&gt;<i> departments infact I have 4-5 companies/subnets)
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thirdly, on the issue of %h - the Squid hostname is *required* to
</I>&gt;&gt;&gt;<i> resolve in DNS explicitly so clients can access things like these URLs.
</I>&gt;&gt;&gt;<i> If your network and DNS is configured correctly each client subnet
</I>&gt;&gt;&gt;<i> should resolve that hostname to the relevant IP which you are trying to
</I>&gt;&gt;&gt;<i> &quot;pass&quot; to the web server in your redirect URL. So they will naturally
</I>&gt;&gt;&gt;<i> (and only) connect to the web server (or Squid itself) using the right
</I>&gt;&gt;&gt;<i> IP anyway - the web server should be able to detect what it needs from
</I>&gt;&gt;&gt;<i> its own inbound TCP/IP connection instead of using raw-IPs in the traffic.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Some company uses OpenDNS, other Cloudflare, other Google etc.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So DNS will not resolve the hostname to same as %MYADDR.
</I>&gt;<i> I suspect something is going screwy there. How are these clients getting
</I>&gt;<i> to the proxy if they resolve its name to a different IP than they
</I>&gt;<i> connect to?
</I>
They connect by putting IP address in Proxy setting.

&gt;<i>
</I>&gt;&gt;&gt;<i> There are three options available to work around broken DNS:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Option 1) to do exactly (and only) what you asked for.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Currently this can be done with an external helper:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>   external_acl_type getIp concurrency=100 %MYADDR /path/to/script
</I>&gt;&gt;&gt;<i>   deny_info 302:<A HREF="http://%et/banned.html">http://%et/banned.html</A> getIp
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> where the script just echos back to Squid the IP it was given like so:
</I>&gt;&gt;&gt;<i>      [channel-id] OK message=&quot;&lt;input-IP&gt;&quot;\n
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Based on documentation of FORMAT for deny_info, I think you mean %o and
</I>&gt;&gt;<i> not %et
</I>&gt;<i> Ah, yes. Sorry. Getting my legacy formats mixed up.
</I>&gt;<i>
</I>&gt;&gt;<i> Also will this &quot;message&quot; be available if I change by http_access line to:
</I>&gt;&gt;<i> deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
</I>&gt;&gt;<i> http_access deny blockedsites getIp
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> will &quot;message&quot; of getIp be available to deny_info of blockedsites?
</I>&gt;<i> The message will persist as an annotation in the transaction, but only
</I>&gt;<i> from the point the external ACL is tested. So the deny_info has to be
</I>&gt;<i> attached to the external ACL or something following it.
</I>&gt;<i>
</I>&gt;<i> Also, deny_info only works if it is attached to the *last* ACL named on
</I>&gt;<i> a line.
</I>&gt;<i>
</I>&gt;<i> So:
</I>&gt;<i>
</I>&gt;<i>   deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> getIp
</I>&gt;<i>   http_access deny blockedsites getIp
</I>&gt;<i>
</I>&gt;<i> or,
</I>&gt;<i>
</I>&gt;<i>   deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
</I>&gt;<i>   http_access deny getIp blockedsites
</I>&gt;<i>
</I>&gt;<i> or,
</I>&gt;<i>   deny_info 302:<A HREF="http://%o/banned.html">http://%o/banned.html</A> blockedsites
</I>&gt;<i>   http_access deny getIp !all
</I>&gt;<i>   ...
</I>&gt;<i>   http_access deny blockedsites
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> should work, but other orderings do not.
</I>&gt;<i>
</I>
Tried this and it works as I expect it to.
&gt;&gt;<i> _*Feature request:*_
</I>&gt;&gt;<i> Can we have the following switch-case in file errorpage.cc?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Source:
</I>&gt;&gt;<i> <A HREF="https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857">https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Currently case 'I' (capital i) for building_deny_info_url returns string
</I>&gt;&gt;<i> &quot;[unknown]&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can it be modified to return &quot;interface&quot; address? i.e. same as MYADDR
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe it would be just few (may be one) line change in code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can create a PR if required but can you or someone guide me on how to
</I>&gt;&gt;<i> fetch MYADDR?
</I>&gt;<i> A PR is welcome, but re-using a %macro which already has a different
</I>&gt;<i> definition will add problems in the long-term plan of conversion to
</I>&gt;<i> logformat %macro codes. So picking a letter that has not yet been used
</I>&gt;<i> for anything would be best.
</I>&gt;<i>
</I>&gt;<i> The Squid IP:port on client requests should be available to that code as
</I>&gt;<i> request-&gt;masterXaction-&gt;tcpClient-&gt;local , the request and tcpClient
</I>&gt;<i> pointers may be nil since not all transactions have a client or the
</I>&gt;<i> error may be about the lack of an HTTP request on the TCP connection.
</I>
I chose I (capital i) as it is not used for deny_info (and not 
documented either) and also properly reflects that it means interface 
address.

Document source: <A HREF="http://www.squid-cache.org/Doc/config/deny_info/">http://www.squid-cache.org/Doc/config/deny_info/</A>

%i (small i) is used for client IP address
%I (capital i) may be used for interface (own) IP address

Let me know if its ok and I would attempt to create a PR.

Thank you again.

Amish

&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018180.html">[squid-users] deny_info and squid's own IP address?
</A></li>
	<LI>Next message (by thread): <A HREF="018182.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18181">[ date ]</a>
              <a href="thread.html#18181">[ thread ]</a>
              <a href="subject.html#18181">[ subject ]</a>
              <a href="author.html#18181">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
