<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and squid's own IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C1fa374e3-2896-2bd9-2527-8b18bff319cd%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018181.html">
   <LINK REL="Next"  HREF="018187.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and squid's own IP address?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20squid%27s%20own%20IP%20address%3F&In-Reply-To=%3C1fa374e3-2896-2bd9-2527-8b18bff319cd%40treenet.co.nz%3E"
       TITLE="[squid-users] deny_info and squid's own IP address?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May  1 14:17:42 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018181.html">[squid-users] deny_info and squid's own IP address?
</A></li>
        <LI>Next message (by thread): <A HREF="018187.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18182">[ date ]</a>
              <a href="thread.html#18182">[ thread ]</a>
              <a href="subject.html#18182">[ subject ]</a>
              <a href="author.html#18182">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/05/18 23:10, Amish wrote:
&gt;<i> On Tuesday 01 May 2018 02:41 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 01/05/18 19:44, Amish wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> First of thanks a lot for taking your time out for replying to my query.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My replies are inline.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Tuesday 01 May 2018 09:10 AM, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 01/05/18 00:54, Amish wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hello
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have 2 LAN interface on squid box, say department A (192.168.1.1/24)
</I>&gt;&gt;&gt;&gt;&gt;<i> and department B (192.168.2.1/24)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have few banned sites. Say Facebook.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have HTTP server (running on same server as squid) which shows
</I>&gt;&gt;&gt;&gt;&gt;<i> custom
</I>&gt;&gt;&gt;&gt;&gt;<i> pages with custom logo based on IP address.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> When request comes for a banned site I would like client to be
</I>&gt;&gt;&gt;&gt;&gt;<i> redirected based on squid's own IP.
</I>&gt;&gt;&gt;&gt;<i> Firstly, is there any particular reason you are requiring it to be a
</I>&gt;&gt;&gt;&gt;<i> redirect?
</I>&gt;&gt;&gt;&gt;<i> &#160; from what you have said it appears you can achieve the same outcome
</I>&gt;&gt;&gt;&gt;<i> without the extra web server by using a custom error page.
</I>&gt;&gt;&gt;<i> No I cant use custom error page as Javascript will leak the IP range of
</I>&gt;&gt;&gt;<i> department A to department B.
</I>&gt;&gt;&gt;<i> (I had simplified my example, its actually two companies and not two
</I>&gt;&gt;&gt;<i> departments infact I have 4-5 companies/subnets)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thirdly, on the issue of %h - the Squid hostname is *required* to
</I>&gt;&gt;&gt;&gt;<i> resolve in DNS explicitly so clients can access things like these URLs.
</I>&gt;&gt;&gt;&gt;<i> If your network and DNS is configured correctly each client subnet
</I>&gt;&gt;&gt;&gt;<i> should resolve that hostname to the relevant IP which you are trying to
</I>&gt;&gt;&gt;&gt;<i> &quot;pass&quot; to the web server in your redirect URL. So they will naturally
</I>&gt;&gt;&gt;&gt;<i> (and only) connect to the web server (or Squid itself) using the right
</I>&gt;&gt;&gt;&gt;<i> IP anyway - the web server should be able to detect what it needs from
</I>&gt;&gt;&gt;&gt;<i> its own inbound TCP/IP connection instead of using raw-IPs in the
</I>&gt;&gt;&gt;&gt;<i> traffic.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Some company uses OpenDNS, other Cloudflare, other Google etc.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So DNS will not resolve the hostname to same as %MYADDR.
</I>&gt;&gt;<i> I suspect something is going screwy there. How are these clients getting
</I>&gt;&gt;<i> to the proxy if they resolve its name to a different IP than they
</I>&gt;&gt;<i> connect to?
</I>&gt;<i> 
</I>&gt;<i> They connect by putting IP address in Proxy setting.
</I>
Then all their traffic goes through the proxy, which does the DNS
portion on their behalf - including the fetch for the redirection URL.

That means you can have the proxy do whatever you want with it on the
second fetch.
For example;

 http_port 3128

 acl toSquid dstdomain squid-domain.example.com
 acl banUrl urlpath_regex ^/banned.html$
 deny_info 302:<A HREF="http://%h/banned.html">http://%h/banned.html</A> blockedsites
 http_access deny blockedsites

... the simplest way is just to pass a Forwarded header for the server
to use:

 request_header_add Forwarded &quot;for=%&gt;a;by=%la&quot; toSquid banUrl

 OR, you can setup explicit hostname replacement with cache_peer
forcedomain= for each client &quot;interface&quot;:

 acl clients1 localip 192.168.1.1
 cache_peer localhost 80 0 name=server1 originserver \
  forcedomain=192.168.1.1
 cache_peer_access server1 allow clients1 toSquid banUrl

 acl clients2 localip 192.168.2.1
 cache_peer localhost 80 0 name=server2 originserver \
  forcedomain=192.168.2.1
 cache_peer_access server2 allow clients2 toSquid banUrl



&gt;&gt;&gt;<i> _*Feature request:*_
</I>&gt;&gt;&gt;<i> Can we have the following switch-case in file errorpage.cc?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Source:
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857">https://github.com/squid-cache/squid/blob/master/src/errorpage.cc#L857</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Currently case 'I' (capital i) for building_deny_info_url returns string
</I>&gt;&gt;&gt;<i> &quot;[unknown]&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can it be modified to return &quot;interface&quot; address? i.e. same as MYADDR
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I believe it would be just few (may be one) line change in code.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I can create a PR if required but can you or someone guide me on how to
</I>&gt;&gt;&gt;<i> fetch MYADDR?
</I>&gt;&gt;<i> A PR is welcome, but re-using a %macro which already has a different
</I>&gt;&gt;<i> definition will add problems in the long-term plan of conversion to
</I>&gt;&gt;<i> logformat %macro codes. So picking a letter that has not yet been used
</I>&gt;&gt;<i> for anything would be best.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Squid IP:port on client requests should be available to that code as
</I>&gt;&gt;<i> request-&gt;masterXaction-&gt;tcpClient-&gt;local , the request and tcpClient
</I>&gt;&gt;<i> pointers may be nil since not all transactions have a client or the
</I>&gt;&gt;<i> error may be about the lack of an HTTP request on the TCP connection.
</I>&gt;<i> 
</I>&gt;<i> I chose I (capital i) as it is not used for deny_info (and not
</I>&gt;<i> documented either) and also properly reflects that it means interface
</I>&gt;<i> address.
</I>
The issue is that deny_info is a subset of ERR_* %macros and &quot;%I&quot;
already means server-IP to the Convert() function. So when the Convert()
function is replaced with the generic logformat macros we will have to
add extra code complexity to determine the use instead of adding it as
an alias for the logformat &quot;%&lt;a&quot; (your data is actually %la in logformat
terms).

Since we already know that conversion is going to happen it is a bad
idea to knowingly make it harder to do. Which means picking a completely
unused letter - &quot;AbCGjJkKnNOqQrvVXyYZ&quot; are available, or numbers.


&gt;<i> 
</I>&gt;<i> Document source: <A HREF="http://www.squid-cache.org/Doc/config/deny_info/">http://www.squid-cache.org/Doc/config/deny_info/</A>
</I>&gt;<i> 
</I>&gt;<i> %i (small i) is used for client IP address
</I>&gt;<i> %I (capital i) may be used for interface (own) IP address
</I>
Squid has no knowledge of &quot;interfaces&quot; all it has is a TCP connection,
so that definition is not consistent with what Squid has available. L
for 'local address/IP' would be better but is also already taken by
another definition.

There is not really any meaningful mapping for these one-letter codes
and has not been for years. Which is part of why the logformat
conversion is planned.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018181.html">[squid-users] deny_info and squid's own IP address?
</A></li>
	<LI>Next message (by thread): <A HREF="018187.html">[squid-users] deny_info and squid's own IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18182">[ date ]</a>
              <a href="thread.html#18182">[ thread ]</a>
              <a href="subject.html#18182">[ subject ]</a>
              <a href="author.html#18182">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
