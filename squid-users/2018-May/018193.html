<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Question about shutdown_lifetime behavior.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Question%20about%20shutdown_lifetime%20behavior.&In-Reply-To=%3C2AF4E0DB5D20734E8939C5EF204ACBAC01AEC439A1%40ITHMail2.ith.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018186.html">
   <LINK REL="Next"  HREF="018194.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Question about shutdown_lifetime behavior.</H1>
    <B>Cody Herzog</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Question%20about%20shutdown_lifetime%20behavior.&In-Reply-To=%3C2AF4E0DB5D20734E8939C5EF204ACBAC01AEC439A1%40ITHMail2.ith.local%3E"
       TITLE="[squid-users] Question about shutdown_lifetime behavior.">CHerzog at IntouchHealth.com
       </A><BR>
    <I>Wed May  2 21:07:35 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018186.html">[squid-users] Question about shutdown_lifetime behavior.
</A></li>
        <LI>Next message (by thread): <A HREF="018194.html">[squid-users] Question about shutdown_lifetime behavior.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18193">[ date ]</a>
              <a href="thread.html#18193">[ thread ]</a>
              <a href="subject.html#18193">[ subject ]</a>
              <a href="author.html#18193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks again, Amos.

&gt;<i>Then Squids behaviour already matches your requirements. The &quot;or when timeout occurs&quot; is shutdown_lifetime and you do not have to do anything.
</I>
I'm confused by this. After issuing the first shutdown command, my desired behavior is for Squid to shut itself down fully as soon as it detects that there is no more client activity. My understanding from your first response is that Squid will always wait the full timeout, regardless of whether activity seems to have stopped.

Ultimately, I ended up having to implement something custom anyway.

My clients have multiple persistent WebSocket connections to different services. Some of those services are critical, and some are not. Shutdown must be postponed until there are no more active connections to critical services. Connections to the non-critical services can last a very long time, and I don't want to postpone shutdown because of those connections.
 
To get my desired behavior, I ended up polling 'cache_<A HREF="object://cache.host.name/active_requests">object://cache.host.name/active_requests</A>' to check if any critical requests are active, and if not, then I issue the shutdown command.

The tricky thing is that 'cache_object' cannot be queried after the first shutdown command has been issued, because Squid does not accept any new connections. Therefore, I had to find a way to prevent new client connections, while still allowing 'cache_object' to keep working. I was able to accomplish this by modifying squid.conf and issuing a 'reconfigure'.  Thankfully, the 'reconfigure' which prevents new client connections does not seem to break any of the active WebSocket connections.

So, here is my shutdown sequence:

1.) Modify config file to prevent new client connections and 'reconfigure'.
2.) Poll active requests until there are no connections to critical services.
3.) Issue the shutdown command with a small value for shutdown_lifetime.

Does that sounds reasonable?

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018186.html">[squid-users] Question about shutdown_lifetime behavior.
</A></li>
	<LI>Next message (by thread): <A HREF="018194.html">[squid-users] Question about shutdown_lifetime behavior.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18193">[ date ]</a>
              <a href="thread.html#18193">[ thread ]</a>
              <a href="subject.html#18193">[ subject ]</a>
              <a href="author.html#18193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
