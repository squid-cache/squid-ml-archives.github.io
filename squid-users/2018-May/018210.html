<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid configuration sanity check
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20configuration%20sanity%20check&In-Reply-To=%3C3a048ca2-72c5-956f-e236-dd459d34e1fb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018209.html">
   <LINK REL="Next"  HREF="018211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid configuration sanity check</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20configuration%20sanity%20check&In-Reply-To=%3C3a048ca2-72c5-956f-e236-dd459d34e1fb%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid configuration sanity check">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May  7 16:30:02 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018209.html">[squid-users] Squid configuration sanity check
</A></li>
        <LI>Next message (by thread): <A HREF="018211.html">[squid-users] Squid configuration sanity check
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18210">[ date ]</a>
              <a href="thread.html#18210">[ thread ]</a>
              <a href="subject.html#18210">[ subject ]</a>
              <a href="author.html#18210">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/05/18 00:24, Alex K wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I wanted to check with your accumulated wisdom the following squid
</I>&gt;<i> configuration.
</I>&gt;<i> 
</I>&gt;<i> The config is working both for splice or bump (by
</I>&gt;<i> commenting/uncommenting the respective line) using TPROXY. It is a
</I>&gt;<i> config ported form an old installation of squid 3.1 for the new 3.5 and
</I>&gt;<i> although I did some cleanup I am wondering if I am misusing any
</I>&gt;<i> directive or missing any crucial one for better performance or just for
</I>&gt;<i> sake of cleanliness.
</I>&gt;<i> 
</I>&gt;<i> At the moment for filtering I am using squidGuard and considering to go
</I>&gt;<i> with ufdbGuard instead as pointed from Amos (thanx for that).
</I>&gt;<i> &#160;
</I>&gt;<i> To avoid issues with some sites I am considering to use only splicing,
</I>&gt;<i> although this has some caveats as bumping also does. I could go with a
</I>&gt;<i> hybrid approach (splice some and bump all) but this sounds that this
</I>&gt;<i> will cause periodically more administrative overhead to sort out the
</I>&gt;<i> sites that need splicing.
</I>&gt;<i> 
</I>&gt;<i> The config has also some ACLs as an attempt to block media streaming by
</I>&gt;<i> those seem to not work.
</I>
The ACL checking for <A HREF="mms://">mms://</A> URL will not work because MMS protocol is
not HTTP. Any client using that protocol will not be going through
Squid. So quite likely none of the other checks will work for its
non-proxied traffic either.

&quot;working&quot; can also depend on what you are looking at. Your rules are
only blocking *reply* access. Which means only that the client does not
get the response delivered. It still gets fetched from the server -
maybe in full. So checking your logs etc can still show things arriving
and lots of bandwidth usage.

The urlpath and req_mime_type can be checked in http_access instead to
block those requests from ever happening. That MAY work better, but no
guarantees.



&gt;<i> 
</I>&gt;<i> The hardware running the squid is somehow small with 4 GB of RAM, 4 CPU
</I>&gt;<i> cores and 100 GB SSD in case one wonders.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.200.1:3128 tproxy
</I>&gt;<i> https_port 192.168.200.1:3129 tproxy \
</I>&gt;<i>   ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB \
</I>&gt;<i>   cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s
</I>&gt;<i> /usr/local/squid/var/lib/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> 
</I>&gt;<i> shutdown_lifetime 5 seconds
</I>&gt;<i> 
</I>&gt;<i> # ACL
</I>&gt;<i> #acl ncsa_users proxy_auth REQUIRED
</I>&gt;<i> #acl all src 0.0.0.0/0.0.0.0
</I>&gt;<i> acl manager proto cache_object
</I>
'manager' ACL is now built-in, and has a different type signature. The
above needs to be removed. Same with 'all'. It is not a good idea to
leave them even commented out because the old definitions are no longer
true.


&gt;<i> acl localhost src 192.168.200.1/32
</I>
192.168.200.1 is assigned to your lo interface?

&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl Safe_ports port 10080
</I>&gt;<i> acl Safe_ports port 10443
</I>&gt;<i> acl SSL method CONNECT
</I>
The above can be quite deceptive,

&gt;<i> acl CONNECT method CONNECT # multiling http
</I>&gt;<i> #acl block_url dstdomain &quot;/etc/squid/block_url.squid&quot;
</I>&gt;<i> #acl allow_url dstdomain &quot;/etc/squid/allow_url.squid&quot;
</I>&gt;<i> acl ELAN src 192.168.200.0/24
</I>&gt;<i> 
</I>&gt;<i> acl QUERY urlpath_regex cgi-bin \?
</I>
The QUERY is not being used. It is also no longer necessary so can be
removed.

&gt;<i> 
</I>&gt;<i> # SSL
</I>&gt;<i> always_direct allow all
</I>
That should not be. You do not have any cache_peer configured.

&gt;<i> 
</I>&gt;<i> # Video Streaming ACLs
</I>&gt;<i> acl media rep_mime_type ^.*mms.*
</I>&gt;<i> acl media rep_mime_type ^.*ms-hdr.*
</I>&gt;<i> acl media rep_mime_type ^.*x-fcs.*
</I>&gt;<i> acl media rep_mime_type ^.*x-ms-asf.*
</I>&gt;<i> acl media2 urlpath_regex dvrplayer mediastream <A HREF="mms://">mms://</A>
</I>&gt;<i> acl media2 urlpath_regex \.asf$ \.afx$ \.flv$ \.swf$
</I>&gt;<i> acl flashvideo rep_mime_type -i video/flv
</I>&gt;<i> acl flashvideo rep_mime_type -i video/x-flv
</I>&gt;<i> acl shockwave rep_mime_type -i ^application/x-shockwave-flash$
</I>
&gt;<i> acl x-type req_mime_type -i ^application/octet-stream$
</I>&gt;<i> acl x-type req_mime_type -i application/octet-stream
</I>
All the lines like the two above are duplicates.
The &quot;^foo$&quot; pattern is a sub-set of &quot;foo&quot; pattern.


&gt;<i> acl x-type req_mime_type -i ^application/x-mplayer2$
</I>&gt;<i> acl x-type req_mime_type -i application/x-mplayer2
</I>&gt;<i> acl x-type req_mime_type -i ^application/x-oleobject$
</I>&gt;<i> acl x-type req_mime_type -i application/x-oleobject
</I>&gt;<i> acl x-type req_mime_type -i application/x-pncmd
</I>&gt;<i> acl x-type req_mime_type -i ^video/x-ms-asf$
</I>&gt;<i> acl x-type2 rep_mime_type -i ^application/octet-stream$
</I>&gt;<i> acl x-type2 rep_mime_type -i application/octet-stream
</I>&gt;<i> acl x-type2 rep_mime_type -i ^application/x-mplayer2$
</I>&gt;<i> acl x-type2 rep_mime_type -i application/x-mplayer2
</I>&gt;<i> acl x-type2 rep_mime_type -i ^application/x-oleobject$
</I>&gt;<i> acl x-type2 rep_mime_type -i application/x-oleobject
</I>&gt;<i> acl x-type2 rep_mime_type -i application/x-pncmd
</I>&gt;<i> acl x-type2 rep_mime_type -i ^video/x-ms-asf$
</I>&gt;<i> 
</I>&gt;<i> # Block Media Streaming
</I>&gt;<i> http_reply_access deny flashvideo
</I>&gt;<i> http_reply_access deny shockwave
</I>&gt;<i> http_reply_access deny media
</I>&gt;<i> http_reply_access deny media2
</I>&gt;<i> http_reply_access deny x-type
</I>&gt;<i> http_reply_access deny x-type2
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
FYI: current best-practice recommendation is to place the manager access
line down here after the faster port checks.

&gt;<i> #http_access deny block_url
</I>&gt;<i> #http_access allow allow_url
</I>&gt;<i> http_access allow LAN
</I>&gt;<i> http_access allow ELAN
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> #http_access allow ncsa_users
</I>&gt;<i> http_reply_access allow all
</I>
This http_reply_access line should be up with the others so it does not
fool anyone into thinking its placement here with the http_access lines
has any meaning.

&gt;<i> 
</I>&gt;<i> deny_info ERR_CUSTOM LAN ELAN media media2 flashvideo shockwave x-type
</I>&gt;<i> x-type2
</I>&gt;<i> error_directory /usr/share/squid-langpack/en
</I>&gt;<i> 
</I>&gt;<i> #icp_access allow all
</I>&gt;<i> 
</I>&gt;<i> # Logging
</I>&gt;<i> logfile_daemon /usr/lib/squid/log_db_daemon
</I>&gt;<i> access_log daemon:/127.0.0.1/squid_log/access_log/squid/squid squid
</I>&gt;<i> icap_log stdio:/var/log/squid/icap.log squid
</I>&gt;<i> cache_store_log stdio:/var/log/squid/store.log
</I>&gt;<i> 
</I>&gt;<i> # DNS
</I>&gt;<i> dns_nameservers 127.0.0.1
</I>&gt;<i> positive_dns_ttl 8 hours
</I>&gt;<i> negative_dns_ttl 30 seconds
</I>&gt;<i> ipcache_size 2048
</I>&gt;<i> ipcache_low 95
</I>&gt;<i> ipcache_high 97
</I>&gt;<i> fqdncache_size 2048
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> cache_dir ufs /var/spool/squid 10240 16 256
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 30 MB
</I>&gt;<i> maximum_object_size_in_memory 1024 KB
</I>&gt;<i> 
</I>&gt;<i> # HTTPS filtering
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> #ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> # SquidGuard
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squidguard/squidGuard.conf
</I>&gt;<i> url_rewrite_children 5
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Your input is highly appreciated.
</I>&gt;<i> 
</I>&gt;<i> Alex
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018209.html">[squid-users] Squid configuration sanity check
</A></li>
	<LI>Next message (by thread): <A HREF="018211.html">[squid-users] Squid configuration sanity check
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18210">[ date ]</a>
              <a href="thread.html#18210">[ thread ]</a>
              <a href="subject.html#18210">[ subject ]</a>
              <a href="author.html#18210">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
