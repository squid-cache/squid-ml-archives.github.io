<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help with WCCP: Cisco 1841 to Squid 3.5.25 on Ubuntu	16
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20WCCP%3A%20Cisco%201841%20to%20Squid%203.5.25%20on%20Ubuntu%0A%0916&In-Reply-To=%3Ctrinity-07e4cfb1-84d9-42fc-aeab-969784ed615a-1525839715367%403c-app-mailcom-bs11%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018241.html">
   <LINK REL="Next"  HREF="018220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help with WCCP: Cisco 1841 to Squid 3.5.25 on Ubuntu	16</H1>
    <B>Ilias Clifton</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20WCCP%3A%20Cisco%201841%20to%20Squid%203.5.25%20on%20Ubuntu%0A%0916&In-Reply-To=%3Ctrinity-07e4cfb1-84d9-42fc-aeab-969784ed615a-1525839715367%403c-app-mailcom-bs11%3E"
       TITLE="[squid-users] Help with WCCP: Cisco 1841 to Squid 3.5.25 on Ubuntu	16">adilias3 at gmx.com
       </A><BR>
    <I>Wed May  9 04:21:55 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018241.html">[squid-users] Kerberos authentication on mobile phones
</A></li>
        <LI>Next message (by thread): <A HREF="018220.html">[squid-users] Help with WCCP: Cisco 1841 to Squid 3.5.25 on Ubuntu 16
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18219">[ date ]</a>
              <a href="thread.html#18219">[ thread ]</a>
              <a href="subject.html#18219">[ subject ]</a>
              <a href="author.html#18219">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hello,
&#160;
I've been trying to get WCCP working but have been banging my head against a wall, so thought I would ask for help.
&#160;
There are 2 internal subnets that I would like to use the squid proxy: 172.28.30.128/25 and 172.28.29.0/25
&#160;
I have squid v3.5.25 running on Ubuntu 16 : 172.28.28.252
&#160;
I have a Cisco 1841 - Adv IP - 12.4, see relevent config:
&#160;
#Inside Interface
interface FastEthernet0/1
&#160;ip address 172.28.28.1 255.255.255.240
&#160;ip wccp web-cache redirect in
&#160;ip nat inside
&#160;ip virtual-reassembly max-reassemblies 64
&#160;no ip mroute-cache
&#160;duplex auto
&#160;speed auto
&#160;
#Loopback for wccp router ID
interface Loopback0
&#160;ip address 172.28.28.33 255.255.255.255
&#160;
ip wccp web-cache redirect-list PROXY_USERS group-list SQUID
&#160;
ip access-list extended PROXY_USERS
&#160;deny &#160; tcp host 172.28.28.252 any
&#160;permit tcp 172.28.30.128 0.0.0.127 any eq www
&#160;permit tcp 172.28.29.0 0.0.0.127 any eq www
&#160;deny &#160; ip any any
&#160;
ip access-list standard SQUID
&#160;permit 172.28.28.252
&#160;
&#160;
&#160;
On the Ubuntu box, I have the squid with the following config:
&#160;
http_port 3128
http_port 3129 intercept&#160;
acl localnet src 172.28.28.0/22 &#160;&#160;
http_access allow localnet
http_access allow localhost
http_access deny all
visible_hostname Squid
wccp2_router 172.28.28.1
wccp2_forwarding_method gre
wccp2_return_method gre
wccp2_service standard 0
&#160;
If clients are manually set to use the proxy on port 3128, they work correctly.
&#160;
Again on the Ubuntu box, I have setup the following gre tunnel.
&#160;
ip tunnel add wccp0 mode gre remote 172.28.28.33 local 172.28.28.252 dev ens33 ttl 255
&#160;
and the following redirect using iptables..
&#160;
iptables -t nat&#160;-A PREROUTING -i wccp0 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3129
&#160;
In sysctl.conf, I have disabled reverse path filtering and enabled ip forarding.
&#160;
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.all.rp_filter=0
net.ipv4.ip_forward=1

When starting squid, using tcpdump, i see traffic between the Ubuntu box and the router on udp port 2048

00:39:34.587799 IP 172.28.28.252.2048 &gt; 172.28.28.1.2048: UDP, length 144
00:39:34.590399 IP 172.28.28.1.2048 &gt; 172.28.28.252.2048: UDP, length 140

I see the following message on the router..
%WCCP-5-SERVICEFOUND: Service web-cache acquired on WCCP client 172.28.28.252

So looks like it's working ok so far...

When I try and browse to a site from a client..
$ wget <A HREF="http://www.google.com">http://www.google.com</A>

On the Ubuntu box, I see gre traffic on the ethernet interface..
00:44:22.340734 IP 172.28.28.33 &gt; 172.28.28.252: GREv0, length 72: gre-proto-0x883e


I see the un-encapsulated traffic on the wccp0 interface:
00:56:26.888519 IP 172.28.29.4.52128 &gt; 216.58.203.100.80

Which is correctly showing original client IP and destination IP.

I can see hits on the iptable redirect rule:
pkts bytes target     prot opt in     out     source               destination         
  429 26280 REDIRECT   tcp  --  wccp0  any     anywhere             anywhere             tcp dpt:http redir ports 3129


But there is no response from squid on the Ubuntu box :-(

I don't see anything helpful in either access.log or cache.log.

I'm not sure if there is anything else that could be dropping the packet apart from return path filtering..

If someone could give me some pointers or any further debugging I could try, that would be great.


Thanks.







&#160;
&#160;
&#160;
&#160;
&#160;
&#160;
&#160;
&#160;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018241.html">[squid-users] Kerberos authentication on mobile phones
</A></li>
	<LI>Next message (by thread): <A HREF="018220.html">[squid-users] Help with WCCP: Cisco 1841 to Squid 3.5.25 on Ubuntu 16
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18219">[ date ]</a>
              <a href="thread.html#18219">[ thread ]</a>
              <a href="subject.html#18219">[ subject ]</a>
              <a href="author.html#18219">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
