<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Possible access via v6 when no interfaces present, fixable with dns_v4_first
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20access%20via%20v6%20when%20no%20interfaces%20present%2C%0A%20fixable%20with%20dns_v4_first&In-Reply-To=%3Ca66f087f-25ab-4bfc-652d-b82de4bd82a4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018305.html">
   <LINK REL="Next"  HREF="018310.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Possible access via v6 when no interfaces present, fixable with dns_v4_first</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Possible%20access%20via%20v6%20when%20no%20interfaces%20present%2C%0A%20fixable%20with%20dns_v4_first&In-Reply-To=%3Ca66f087f-25ab-4bfc-652d-b82de4bd82a4%40treenet.co.nz%3E"
       TITLE="[squid-users] Possible access via v6 when no interfaces present, fixable with dns_v4_first">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat May 19 20:48:13 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018305.html">[squid-users] Possible access via v6 when no interfaces present,	fixable with dns_v4_first
</A></li>
        <LI>Next message (by thread): <A HREF="018310.html">[squid-users] The right way how to increase max_filedescriptors on	Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18306">[ date ]</a>
              <a href="thread.html#18306">[ thread ]</a>
              <a href="subject.html#18306">[ subject ]</a>
              <a href="author.html#18306">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/05/18 14:14, Luke wrote:
&gt;<i> 
</I>&gt;<i> We're interested to know why this copy of Squid acted differently to all the
</I>&gt;<i> others.  One potential clue we noticed is that this particular LAN has a lot
</I>&gt;<i> of v6 trafflic flying around on it, compared to the rest of our networks.  I
</I>&gt;<i> understand Squid runs it's own DNS resolver.  Could something on the local
</I>&gt;<i> LAN be announcing itself and the resolver in Squid picking up on that,
</I>&gt;<i> switching around the order of DNS resolution so that it tries that v6
</I>&gt;<i> address first?
</I>
You have not mentioned overriding Squids normal DNS hijacking protection
with the ignore_unknown_nameservers directive. So probably not.

What you are seeing in that DNS result ordering is RFC 6540 (aka BCP
177) required behaviour. When a server is advertising IPv6 addresses,
they have preference over IPv4 ones.

The dns_v4_first option is provided to allow to you &quot;force&quot; use of the
outdated IPv4 protocol. It is a workaround, not a fix.

In normal operation Squid will test those addresses and immediately be
told by the network they are not routed, so move on to the IPv4 ones.
Updating its internal DNS cache appropriately not to try them again
until DNS TTL expires the record or IPv4 starts failing too.


&gt;<i> 
</I>&gt;<i> Anything else we should be looking for?  Guidance appreciated!
</I>&gt;<i> 
</I>
Anything that would cause an IPv6 TCP SYN request to result in a timeout
instead of ICMPv6 &quot;not available&quot; response packet. If IPv6 between Squid
and those edge.icloud.com IPv6 servers was working you would not have
noticed anything. That includes values of working such as &quot;blocked at
the firewall&quot;.

Since Squid is actually getting DNS results I assume DNS lag is not the
problem. But if it is taking a long time to get those results it can
still be playing a part of the issue as it reduces the amount of time
that can be spent on IPv6 connection attempts.

Next thing after DNS to check is ICMP(v6). ICMP is not an optional
protocol and admin blocking it in firewalls can cause major problems
when IPv6 relies on it for routing. Specifically for MTU detection.
 &lt;<A HREF="https://tools.ietf.org/html/rfc4890">https://tools.ietf.org/html/rfc4890</A>&gt;
 &lt;<A HREF="https://sites.google.com/site/ipv6center/icmpv6-is-non-optional">https://sites.google.com/site/ipv6center/icmpv6-is-non-optional</A>&gt;

With port 443 traffic is it increasingly likely that the protocol is not
compatible with HTTP/1.1. If the TCP SYN works fine, but the HTTP
messaging hangs (ICMP fault usually) or produces some weird protocol
response that Squid does not handle it can result in errors.

Some web servers have IPv6 records but hang or crash when IPv6 is
delivered to them. Cloudflare have pretty good IPv6 service, so that is
highly unlikely but worth a check if all else fails to bring up a clue.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018305.html">[squid-users] Possible access via v6 when no interfaces present,	fixable with dns_v4_first
</A></li>
	<LI>Next message (by thread): <A HREF="018310.html">[squid-users] The right way how to increase max_filedescriptors on	Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18306">[ date ]</a>
              <a href="thread.html#18306">[ thread ]</a>
              <a href="subject.html#18306">[ subject ]</a>
              <a href="author.html#18306">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
