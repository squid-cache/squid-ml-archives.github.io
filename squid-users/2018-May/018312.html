<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] The right way how to increase max_filedescriptors on Linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20The%20right%20way%20how%20to%20increase%20max_filedescriptors%0A%20on%20Linux&In-Reply-To=%3C753601ff-8034-2735-fb85-dcd33c2938da%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018310.html">
   <LINK REL="Next"  HREF="018318.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] The right way how to increase max_filedescriptors on Linux</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20The%20right%20way%20how%20to%20increase%20max_filedescriptors%0A%20on%20Linux&In-Reply-To=%3C753601ff-8034-2735-fb85-dcd33c2938da%40treenet.co.nz%3E"
       TITLE="[squid-users] The right way how to increase max_filedescriptors on Linux">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 21 13:29:52 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018310.html">[squid-users] The right way how to increase max_filedescriptors on	Linux
</A></li>
        <LI>Next message (by thread): <A HREF="018318.html">[squid-users] The right way how to increase max_filedescriptors on Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18312">[ date ]</a>
              <a href="thread.html#18312">[ thread ]</a>
              <a href="subject.html#18312">[ subject ]</a>
              <a href="author.html#18312">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/05/18 00:08, kAja Ziegler wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> &#160; I want to ask, if it is really needed to use ulimit or
</I>&gt;<i> /etc/security/limits.conf to increase max_filedescriptors value? From my
</I>&gt;<i> testing, it seems not.
</I>
Sometimes yes, sometimes no. It depends on what the systems normal
settings are and whether the Squid binary was built with full or partial
rlimit() support.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> *= my environment:*
</I>&gt;<i> 
</I>&gt;<i> CentOS 6.9
</I>&gt;<i> Squid 3.1.23 / 3.4.14
</I>&gt;<i> 
</I>&gt;<i> *- default ulimits for root and other users:*
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ulimit -Sa | grep -- '-n'
</I>&gt;<i> open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (-n) 1024
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ulimit -Ha | grep -- '-n'
</I>&gt;<i> open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (-n) 4096
</I>&gt;<i> 
</I>&gt;<i> *- default ulimits for squid user:*
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# sudo -u squid /bin/bash
</I>&gt;<i> bash-4.1$ id
</I>&gt;<i> uid=23(squid) gid=23(squid) groups=23(squid),...
</I>&gt;<i> bash-4.1$ ulimit -Sa | grep -- '-n'
</I>&gt;<i> open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (-n) 1024
</I>&gt;<i> bash-4.1$ ulimit -Ha | grep -- '-n'
</I>&gt;<i> open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; (-n) 4096
</I>&gt;<i> 
</I>&gt;<i> *- processes:*
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ps aux | grep squid
</I>&gt;<i> root&#160;&#160;&#160;&#160;&#160; 7194&#160; 0.0&#160; 0.1&#160; 73524&#160; 3492 ?&#160;&#160;&#160;&#160;&#160;&#160;&#160; Ss&#160;&#160; May17&#160;&#160; 0:00 squid
</I>&gt;<i> -f /etc/squid/squid.conf
</I>&gt;<i> squid&#160;&#160;&#160;&#160; 7197&#160; 0.2 10.9 276080 210156 ?&#160;&#160;&#160;&#160;&#160;&#160; S&#160;&#160;&#160; May17&#160;&#160; 4:53 (squid)
</I>&gt;<i> -f /etc/squid/squid.conf
</I>&gt;<i> squid&#160;&#160;&#160;&#160; 7198&#160; 0.0&#160; 0.0&#160; 20080&#160; 1084 ?&#160;&#160;&#160;&#160;&#160;&#160;&#160; S&#160;&#160;&#160; May17&#160;&#160; 0:00 (unlinkd)
</I>&gt;<i> 
</I>&gt;<i> *- error and warning messages from cache.log:*
</I>&gt;<i> 
</I>&gt;<i> client_side.cc(3070) okToAccept: WARNING! Your cache is running out of
</I>&gt;<i> filedescriptors
</I>&gt;<i> 
</I>&gt;<i> comm_open: socket failure: (24) Too many open files
</I>&gt;<i> 
</I>&gt;<i> IpIntercept.cc(137) NetfilterInterception:&#160; NF
</I>&gt;<i> getsockopt(SO_ORIGINAL_DST) failed on FD 68: (2) No such file or
</I>&gt;<i> directory ... (many with different FD)
</I>&gt;<i> 
</I>
These should not be related to FD numbers running out. As you can see FD
68 was already allocated to this TCP connection and the socket accept()'ed.

NAT errors are usually caused by explicit-proxy traffic arriving at a
NAT interception port. Such traffic is prohibited.
or by NAT table overflowing under extreme traffic loads. Either way
current Squid versions will terminate that connection immediately since
it cannot identify where the packets were supposed to be going.

&gt;<i> 
</I>&gt;<i> I found many How-tos like these -
</I>&gt;<i> <A HREF="https://access.redhat.com/solutions/63027">https://access.redhat.com/solutions/63027</A> and
</I>&gt;<i> <A HREF="https://www.cyberciti.biz/faq/squid-proxy-server-running-out-filedescriptors/.">https://www.cyberciti.biz/faq/squid-proxy-server-running-out-filedescriptors/.</A>
</I>&gt;<i> Both how-tos mention editing the file /etc/security/limits.conf and
</I>&gt;<i> adding the line &quot;* - nofile 4096&quot; to increase the nofile limit for all
</I>&gt;<i> users except root - I don't like this. According to my test, see below,&#160;
</I>&gt;<i> this is not necessary, but I want to be sure, so I'm writing here.
</I>
Note that neither of those are the official Squid FAQ.

The official recommendation is to use those data sources to *check* what
the system limits are.

The official Best Practice varies depending on ones needs. Packagers
distributing Squid are advised to set reasonable limits in the init
script starting Squid. End users to use the configuration file best
suited to their need (MAY be limits.conf, but usually squid.conf).


&gt;<i> 
</I>&gt;<i> *a) Squid default configuration (max_filedesc 0) and default nofile
</I>&gt;<i> limit (1024/4096):*
</I>&gt;<i> 
</I>
Do not set the limit to &quot;0&quot;. That actually means *no* filedescriptors
for the newer Squid versions.

Remove the directive entirely from your squid.conf for the default
behaviour.

Also &quot;max_filedescriptors&quot; is teh directive name. &quot;max_filedesc&quot; was
only for the experimental RHEL patch many decades ago.

&gt;<i> 
</I>&gt;<i> *c) Squid configuration with max_filedesc 8192 and default nofile limit
</I>&gt;<i> (1024/4096):*
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ps aux | grep squid
</I>&gt;<i> root&#160;&#160;&#160;&#160; 18734&#160; 0.0&#160; 0.1&#160; 73524&#160; 3492 ?&#160;&#160;&#160;&#160;&#160;&#160;&#160; Ss&#160;&#160; 14:00&#160;&#160; 0:00 squid
</I>&gt;<i> -f /etc/squid/squid.conf
</I>&gt;<i> squid&#160;&#160;&#160; 18737&#160; 0.3&#160; 0.6&#160; 80244 11860 ?&#160;&#160;&#160;&#160;&#160;&#160;&#160; S&#160;&#160;&#160; 14:00&#160;&#160; 0:00 (squid)
</I>&gt;<i> -f /etc/squid/squid.conf
</I>&gt;<i> squid&#160;&#160;&#160; 18740&#160; 0.0&#160; 0.0&#160; 20080&#160; 1088 ?&#160;&#160;&#160;&#160;&#160;&#160;&#160; S&#160;&#160;&#160; 14:00&#160;&#160; 0:00 (unlinkd)
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# grep -E &quot;Limit|Max open files&quot; /proc/18734/limits
</I>&gt;<i> Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Soft Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Hard Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Units
</I>&gt;<i> Max open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1024&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 4096&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; files
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# grep -E &quot;Limit|Max open files&quot; /proc/18737/limits
</I>&gt;<i> Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Soft Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Hard Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Units
</I>&gt;<i> Max open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; *8192*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; *8192*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
</I>&gt;<i> files
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# grep -E &quot;Limit|Max open files&quot; /proc/18740/limits
</I>&gt;<i> Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Soft Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Hard Limit&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Units
</I>&gt;<i> Max open files&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;*8192*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;*8192*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
</I>&gt;<i> files
</I>&gt;<i> 
</I>&gt;<i> - both soft and hard nofile limits were increased for processes running
</I>&gt;<i> under squid user
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I think, that the limits could be increased in tests b) and c) because
</I>&gt;<i> the master process runs under the root user. Am I right or not?
</I>
AFAIK, Hard limit can be changed by root (or ulimit tool itself would
not work). Soft limit can be changed by any user to any value below hard
limit.

What you see in (c) is the master process changing the hard limit for
its spawned child processes so that they can use the value in squid.conf
without errors.


&gt;<i> Or need I to increase the limits for the master proccess too?
</I>
Not if squid is correctly setting the limits for you. Doing that
automatically is one of the reasons the master exists separately from
the workers. The init script use of ulimit is a workaround for builds
where rlimit() support is lacking or broken.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018310.html">[squid-users] The right way how to increase max_filedescriptors on	Linux
</A></li>
	<LI>Next message (by thread): <A HREF="018318.html">[squid-users] The right way how to increase max_filedescriptors on Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18312">[ date ]</a>
              <a href="thread.html#18312">[ thread ]</a>
              <a href="subject.html#18312">[ subject ]</a>
              <a href="author.html#18312">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
