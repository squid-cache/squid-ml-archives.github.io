<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] The right way how to increase max_filedescriptors on Linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20The%20right%20way%20how%20to%20increase%20max_filedescriptors%0A%20on%20Linux&In-Reply-To=%3CCAMuNeAsz%3DuDp4oOBANj%2B2wXNv5%2BnWFSg_hVZmna2Cjx7Wc1UHg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018312.html">
   <LINK REL="Next"  HREF="018314.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] The right way how to increase max_filedescriptors on Linux</H1>
    <B>kAja Ziegler</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20The%20right%20way%20how%20to%20increase%20max_filedescriptors%0A%20on%20Linux&In-Reply-To=%3CCAMuNeAsz%3DuDp4oOBANj%2B2wXNv5%2BnWFSg_hVZmna2Cjx7Wc1UHg%40mail.gmail.com%3E"
       TITLE="[squid-users] The right way how to increase max_filedescriptors on Linux">ziegleka at gmail.com
       </A><BR>
    <I>Tue May 22 08:46:44 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018312.html">[squid-users] The right way how to increase max_filedescriptors on Linux
</A></li>
        <LI>Next message (by thread): <A HREF="018314.html">[squid-users] cache_peer to SSL/TLS proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18318">[ date ]</a>
              <a href="thread.html#18318">[ thread ]</a>
              <a href="subject.html#18318">[ subject ]</a>
              <a href="author.html#18318">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, May 21, 2018 at 3:29 PM, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 22/05/18 00:08, kAja Ziegler wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   I want to ask, if it is really needed to use ulimit or
</I>&gt;<i> &gt; /etc/security/limits.conf to increase max_filedescriptors value? From my
</I>&gt;<i> &gt; testing, it seems not.
</I>&gt;<i>
</I>&gt;<i> Sometimes yes, sometimes no. It depends on what the systems normal
</I>&gt;<i> settings are and whether the Squid binary was built with full or partial
</I>&gt;<i> rlimit() support.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *= my environment:*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; CentOS 6.9
</I>&gt;<i> &gt; Squid 3.1.23 / 3.4.14
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *- default ulimits for root and other users:*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ulimit -Sa | grep -- '-n'
</I>&gt;<i> &gt; open files                      (-n) 1024
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ulimit -Ha | grep -- '-n'
</I>&gt;<i> &gt; open files                      (-n) 4096
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *- default ulimits for squid user:*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# sudo -u squid /bin/bash
</I>&gt;<i> &gt; bash-4.1$ id
</I>&gt;<i> &gt; uid=23(squid) gid=23(squid) groups=23(squid),...
</I>&gt;<i> &gt; bash-4.1$ ulimit -Sa | grep -- '-n'
</I>&gt;<i> &gt; open files                      (-n) 1024
</I>&gt;<i> &gt; bash-4.1$ ulimit -Ha | grep -- '-n'
</I>&gt;<i> &gt; open files                      (-n) 4096
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *- processes:*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ps aux | grep squid
</I>&gt;<i> &gt; root      7194  0.0  0.1  73524  3492 ?        Ss   May17   0:00 squid
</I>&gt;<i> &gt; -f /etc/squid/squid.conf
</I>&gt;<i> &gt; squid     7197  0.2 10.9 276080 210156 ?       S    May17   4:53 (squid)
</I>&gt;<i> &gt; -f /etc/squid/squid.conf
</I>&gt;<i> &gt; squid     7198  0.0  0.0  20080  1084 ?        S    May17   0:00
</I>&gt;<i> (unlinkd)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *- error and warning messages from cache.log:*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; client_side.cc(3070) okToAccept: WARNING! Your cache is running out of
</I>&gt;<i> &gt; filedescriptors
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; comm_open: socket failure: (24) Too many open files
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; IpIntercept.cc(137) NetfilterInterception:  NF
</I>&gt;<i> &gt; getsockopt(SO_ORIGINAL_DST) failed on FD 68: (2) No such file or
</I>&gt;<i> &gt; directory ... (many with different FD)
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> These should not be related to FD numbers running out. As you can see FD
</I>&gt;<i> 68 was already allocated to this TCP connection and the socket accept()'ed.
</I>&gt;<i>
</I>&gt;<i> NAT errors are usually caused by explicit-proxy traffic arriving at a
</I>&gt;<i> NAT interception port. Such traffic is prohibited.
</I>&gt;<i> or by NAT table overflowing under extreme traffic loads. Either way
</I>&gt;<i> current Squid versions will terminate that connection immediately since
</I>&gt;<i> it cannot identify where the packets were supposed to be going.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I found many How-tos like these -
</I>&gt;<i> &gt; <A HREF="https://access.redhat.com/solutions/63027">https://access.redhat.com/solutions/63027</A> and
</I>&gt;<i> &gt; <A HREF="https://www.cyberciti.biz/faq/squid-proxy-server-running-">https://www.cyberciti.biz/faq/squid-proxy-server-running-</A>
</I>&gt;<i> out-filedescriptors/.
</I>&gt;<i> &gt; Both how-tos mention editing the file /etc/security/limits.conf and
</I>&gt;<i> &gt; adding the line &quot;* - nofile 4096&quot; to increase the nofile limit for all
</I>&gt;<i> &gt; users except root - I don't like this. According to my test, see below,
</I>&gt;<i> &gt; this is not necessary, but I want to be sure, so I'm writing here.
</I>&gt;<i>
</I>&gt;<i> Note that neither of those are the official Squid FAQ.
</I>&gt;<i>
</I>&gt;<i> The official recommendation is to use those data sources to *check* what
</I>&gt;<i> the system limits are.
</I>&gt;<i>
</I>&gt;<i> The official Best Practice varies depending on ones needs. Packagers
</I>&gt;<i> distributing Squid are advised to set reasonable limits in the init
</I>&gt;<i> script starting Squid. End users to use the configuration file best
</I>&gt;<i> suited to their need (MAY be limits.conf, but usually squid.conf).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *a) Squid default configuration (max_filedesc 0) and default nofile
</I>&gt;<i> &gt; limit (1024/4096):*
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Do not set the limit to &quot;0&quot;. That actually means *no* filedescriptors
</I>&gt;<i> for the newer Squid versions.
</I>&gt;<i>
</I>&gt;<i> Remove the directive entirely from your squid.conf for the default
</I>&gt;<i> behaviour.
</I>&gt;<i>
</I>&gt;<i> Also &quot;max_filedescriptors&quot; is teh directive name. &quot;max_filedesc&quot; was
</I>&gt;<i> only for the experimental RHEL patch many decades ago.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *c) Squid configuration with max_filedesc 8192 and default nofile limit
</I>&gt;<i> &gt; (1024/4096):*
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# ps aux | grep squid
</I>&gt;<i> &gt; root     18734  0.0  0.1  73524  3492 ?        Ss   14:00   0:00 squid
</I>&gt;<i> &gt; -f /etc/squid/squid.conf
</I>&gt;<i> &gt; squid    18737  0.3  0.6  80244 11860 ?        S    14:00   0:00 (squid)
</I>&gt;<i> &gt; -f /etc/squid/squid.conf
</I>&gt;<i> &gt; squid    18740  0.0  0.0  20080  1088 ?        S    14:00   0:00
</I>&gt;<i> (unlinkd)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# grep -E &quot;Limit|Max open files&quot; /proc/18734/limits
</I>&gt;<i> &gt; Limit                     Soft Limit           Hard Limit           Units
</I>&gt;<i> &gt; Max open files            1024                 4096                 files
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# grep -E &quot;Limit|Max open files&quot; /proc/18737/limits
</I>&gt;<i> &gt; Limit                     Soft Limit           Hard Limit           Units
</I>&gt;<i> &gt; Max open files            *8192*                 *8192*
</I>&gt;<i> &gt; files
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ...</A>]# grep -E &quot;Limit|Max open files&quot; /proc/18740/limits
</I>&gt;<i> &gt; Limit                     Soft Limit           Hard Limit           Units
</I>&gt;<i> &gt; Max open files            *8192*                 *8192*
</I>&gt;<i> &gt; files
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - both soft and hard nofile limits were increased for processes running
</I>&gt;<i> &gt; under squid user
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think, that the limits could be increased in tests b) and c) because
</I>&gt;<i> &gt; the master process runs under the root user. Am I right or not?
</I>&gt;<i>
</I>&gt;<i> AFAIK, Hard limit can be changed by root (or ulimit tool itself would
</I>&gt;<i> not work). Soft limit can be changed by any user to any value below hard
</I>&gt;<i> limit.
</I>&gt;<i>
</I>&gt;<i> What you see in (c) is the master process changing the hard limit for
</I>&gt;<i> its spawned child processes so that they can use the value in squid.conf
</I>&gt;<i> without errors.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Or need I to increase the limits for the master proccess too?
</I>&gt;<i>
</I>&gt;<i> Not if squid is correctly setting the limits for you. Doing that
</I>&gt;<i> automatically is one of the reasons the master exists separately from
</I>&gt;<i> the workers. The init script use of ulimit is a workaround for builds
</I>&gt;<i> where rlimit() support is lacking or broken.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

Thank you Amos for your clarification/explanation and confirmation of my
presumptions.

About the NAT errors I'm going to write new email.


Do not set the limit to &quot;0&quot;. That actually means *no* filedescriptors for
&gt;<i> the newer Squid versions.
</I>&gt;<i>
</I>&gt;<i> Remove the directive entirely from your squid.conf for the default
</I>&gt;<i> behaviour.
</I>

Thank you for the warning, I came up with the documentation for Squid 3.1.


Also &quot;max_filedescriptors&quot; is teh directive name. &quot;max_filedesc&quot; was only
&gt;<i> for the experimental RHEL patch many decades ago.
</I>

Yep, I made copy &amp; paste error from the old RHEL 5.x page -
<A HREF="https://access.redhat.com/solutions/63027.">https://access.redhat.com/solutions/63027.</A>
I use &quot;max_filedescriptors&quot; in my configuration of course.


Best regards
-- 
Karel Ziegler
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180522/4e621804/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180522/4e621804/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018312.html">[squid-users] The right way how to increase max_filedescriptors on Linux
</A></li>
	<LI>Next message (by thread): <A HREF="018314.html">[squid-users] cache_peer to SSL/TLS proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18318">[ date ]</a>
              <a href="thread.html#18318">[ thread ]</a>
              <a href="subject.html#18318">[ subject ]</a>
              <a href="author.html#18318">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
