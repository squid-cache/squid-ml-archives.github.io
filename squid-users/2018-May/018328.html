<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] original_dst wrong when using intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20original_dst%20wrong%20when%20using%20intercept&In-Reply-To=%3Ce0a1bd33-e09b-e530-6206-b86bc4579971%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018327.html">
   <LINK REL="Next"  HREF="018330.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] original_dst wrong when using intercept</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20original_dst%20wrong%20when%20using%20intercept&In-Reply-To=%3Ce0a1bd33-e09b-e530-6206-b86bc4579971%40treenet.co.nz%3E"
       TITLE="[squid-users] original_dst wrong when using intercept">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed May 23 05:53:29 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="018327.html">[squid-users] original_dst wrong when using intercept
</A></li>
        <LI>Next message (by thread): <A HREF="018330.html">[squid-users] GET requests remain in pending state with Squid and	Kerberos auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18328">[ date ]</a>
              <a href="thread.html#18328">[ thread ]</a>
              <a href="subject.html#18328">[ subject ]</a>
              <a href="author.html#18328">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/05/18 09:27, monopot wrote:
&gt;<i> I'm trying to setup a Squid proxy to use in one of our AWS accounts.   If I
</I>&gt;<i> put Squid in with a basic http/https filtering setup (no interception) it
</I>&gt;<i> all works great, but the problem is my company wants us to do HTTPS
</I>&gt;<i> interception so I need to use ssl bump.
</I>&gt;<i> 
</I>&gt;<i> Now if I set Squid up following the AWS guide for SSL numping (
</I>&gt;<i> <A HREF="https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/">https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/</A>
</I>&gt;<i> &lt;<A HREF="https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/">https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/</A>&gt; 
</I>&gt;<i> ) and make the Squid instance have traffic default routed too it, everything
</I>&gt;<i> works perfect.  BUT, we can't route direct to it as we already have NAT
</I>&gt;<i> Gateways we need to keep, so i need to send traffic to it either direct or
</I>&gt;<i> via an ELB and have clients configured to where Squid is.   I thought if I
</I>&gt;<i> just take the same instance which works when routed and direct traffic to
</I>&gt;<i> it, everything would work but no.
</I>&gt;<i> 
</I>&gt;<i> Turns out as soon as I turn on interception such as /http_port 3129
</I>&gt;<i> *intercept*/ traffic drops.   In the access log the ORIGINAL_DST is
</I>&gt;<i> incorrect with the intercept option in use as it shows the local IP of the
</I>&gt;<i> squid proxy.   If I remove intercept it works, shown below.
</I>
The ORIGINAL_DST is correct. It is the dst-IP of the TCP packets when
that traffic arrived at your Squid machines NAT system.

That can happen due to any of these reasons:

0) you have explicit/forward-proxy traffic arriving at the NAT intercept
port.

1) you have destination-NAT operating no some machine between Squid and
the client.

2) you have destination-NAT operating somewhere in the network *after*
Squid forwarding that traffic back at the Squid machine.

3) you have DNS interception operating on the clients DNS lookups
telling them that your Squid IP is &quot;the origin&quot; for those domains.

4) you have DNS interception operating on Squid DNS lookups telling
Squid itself is the &quot;the origin&quot; for those domains.



&gt;<i> 
</I>&gt;<i> 1527022455.315    178 10.10.7.36 TCP_MISS/503 3944 GET
</I>&gt;<i> <A HREF="http://www.google.com/">http://www.google.com/</A> - ORIGINAL_DST/10.10.3.214 text/html   
</I>&gt;<i> *(original_dst is squid local IP, not working)*
</I>&gt;<i> 1527022535.319    170 10.10.7.36 TCP_MISS/200 12194 GET
</I>&gt;<i> <A HREF="http://www.google.com/">http://www.google.com/</A> - HIER_DIRECT/216.58.196.132 text/html   * (remove
</I>&gt;<i> intercept, original_dst is correct and works)*
</I>&gt;<i> 
</I>&gt;<i> Any ideas why this is and why it works OK if I route traffic direct and
</I>&gt;<i> don't tell the clients specifically to talk to the proxy with
</I>&gt;<i> export_httpproxy etc?
</I>
The intercept works okay *because* you did not configure the client(s)
that way.

NAT interception MUST only be done on the Squid machine itself. The
clients traffic MUST be going to somewhere other than your Squid when
NAT intercepts it. ORIGINAL_DST will be that other place - origin or
external proxy.

To send different types of traffic to the proxy requires different
listening ports to receive them. One for each type of traffic.
 &quot;HTTP&quot; can be an of three types of traffic - explicit/forward, reverse,
and origin syntax.
 &quot;HTTPS&quot; can be any of those three inside TLS wrapper, plus a number of
non-HTTP protocols.

Your Squid will need:
 - http_port for explicit/forward (port 3128) traffic, and
 - http_port for NAT intercept traffic (port 80), and
 - https_port for NAT intercept HTTPS (port 443) traffic, and
 - (maybe) an https_port for TLS explicit proxy traffic.

When ssl-bump is involved each of the above ports should have it as a
configured option as well as their mode type (no mode flag for the
explicit proxy ports).

Overall if you are in a position to configure the clients to be aware of
the proxy that is the best setup to use. Interception of any type
imposes a lot of major problems to the traffic handling and should be
avoided if possible. Intercept is a last-resort type of traffic handling
for applications which are not properly HTTP compliant.


&gt;<i> 
</I>&gt;<i> My squid.conf is this (no blocking atm)
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid
</I>
Te above should be a FQDN so your clients can fetch and render error
page contents correctly.

Alex has already mentioned the other major issues with this squid.conf
setup so I shall skip them here.


&gt;<i> 
</I>&gt;<i> #Handling HTTP requests
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> #Handling HTTPS requests
</I>&gt;<i> https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 all
</I>&gt;<i> ssl_bump splice step3 all
</I>&gt;<i> ssl_bump terminate step2 all
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> And my IP tables simply has 
</I>&gt;<i> 
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3129
</I>&gt;<i> iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3130
</I>&gt;<i> 
</I>
see &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;

Please add the corresponding mangle table rule(s) to prevent case (1),
(3) and (4); and the POSTROUTING nat table rule(s) to prevents case (2).

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="018327.html">[squid-users] original_dst wrong when using intercept
</A></li>
	<LI>Next message (by thread): <A HREF="018330.html">[squid-users] GET requests remain in pending state with Squid and	Kerberos auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18328">[ date ]</a>
              <a href="thread.html#18328">[ thread ]</a>
              <a href="subject.html#18328">[ subject ]</a>
              <a href="author.html#18328">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
