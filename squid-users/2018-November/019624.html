<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5DRe%3A%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%0A%20Bumping&In-Reply-To=%3Cc0630724-78ed-dd25-63da-2e6e418d7e58%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019621.html">
   <LINK REL="Next"  HREF="019625.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5DRe%3A%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%0A%20Bumping&In-Reply-To=%3Cc0630724-78ed-dd25-63da-2e6e418d7e58%40measurement-factory.com%3E"
       TITLE="[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Nov  2 17:26:54 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019621.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
        <LI>Next message (by thread): <A HREF="019625.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19624">[ date ]</a>
              <a href="thread.html#19624">[ thread ]</a>
              <a href="subject.html#19624">[ subject ]</a>
              <a href="author.html#19624">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/2/18 9:54 AM, Shane Poage wrote:

&gt;<i> my original squid.conf had an ACL directive corresponding to the
</I>&gt;<i> functionality in question:
</I>
&gt;<i> 	acl CONNECT method CONNECT
</I>
That CONNECT ACL declaration is OK, but what matters is how you _use_
that declared ACL. The configuration you posted earlier did not use it
at all.


&gt;<i> http_access allow CONNECT artifactory_repo_filter
</I>
This &quot;CONNECT and artifactory_repo_filter&quot; rule does not make sense. As
I said earlier, your artifactory_repo_filter cannot match a CONNECT
request. Thus, you are joining two conditions that can never be
satisfied for the same request. For any request, you will get either
(false and true) or (true and false), which is, of course, always false.


&gt;<i> http_access allow CONNECT
</I>&gt;<i> http_access allow artifactory_repo_filter
</I>
This &quot;CONNECT or artifactory_repo_filter&quot; combination makes sense, but
the first part is dangerous -- you probably should not allow CONNECT
request to arbitrary port numbers. If you look at how CONNECT requests
are handled in squid.conf.default, then you will probably come up with
something like this:

  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports
  http_access allow CONNECT
  http_access allow artifactory_repo_filter
  http_access deny all

or a bit shorter but arguably less safe (long-term) version:

  http_access deny !Safe_ports
  http_access allow CONNECT SSL_ports
  http_access allow artifactory_repo_filter
  http_access deny all

or an even shorter but arguably even less safe (long-term) version:

  http_access allow SSL_ports CONNECT
  http_access allow Safe_ports artifactory_repo_filter
  http_access deny all


N.B. The above configurations allow plain text traffic matching
artifactory_repo_filter. I do not know whether that is what you want.


&gt;<i> 	This resulted in all SSL traffic being permitted and passed through
</I>&gt;<i> 	the proxy.
</I>
If you are still bumping all SSL traffic, and your
artifactory_repo_filter ACL is working, then all of the above reasonable
configurations should still block bumped GET requests that match
artifactory_repo_filter.


&gt;<i> This makes sense to me because the allow CONNECT
</I>&gt;<i> 	would whitelist all CONNECT traffic, which is what all SSL traffic is
</I>&gt;<i> 	by my understanding. 
</I>
Your understanding is incorrect. Since you are bumping all CONNECT
tunnels, your http_access traffic consists of:

* CONNECT requests
* decrypted requests (e.g., GET) inside bumped CONNECT tunnels
* plain requests (e.g., GET) outside CONNECT tunnels


HTH,

Alex.


&gt;<i> &#65279;On 11/1/18, 6:21 PM, Alex Rousskov wrote:
</I>&gt;<i>     On 11/1/18 2:46 PM, Shane Poage wrote:
</I>&gt;<i>     
</I>&gt;<i>     &gt; I have my proxy configured to bump all traffic so that the
</I>&gt;<i>     &gt; urlpath_regex ACL can be applied, but it appears to not have any
</I>&gt;<i>     &gt; effect post-bump.
</I>&gt;<i>     
</I>&gt;<i>     Your proxy will deny any first post-bump request and close the tunnel
</I>&gt;<i>     because you deny all CONNECT requests that initiate tunnels. CONNECT
</I>&gt;<i>     requests do not have a URL path so they will never match your
</I>&gt;<i>     &quot;http_access allow&quot; rule.
</I>&gt;<i>     
</I>&gt;<i>     When a CONNECT request is denied by a bumping Squid, that Squid bumps
</I>&gt;<i>     the tunnel and then denies the very first bumped request on that tunnel,
</I>&gt;<i>     whatever that request is. This delayed error return is done to deliver
</I>&gt;<i>     the &quot;access denied&quot; error page to the client -- browsers ignore CONNECT
</I>&gt;<i>     error responses.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; http_port 3128 ssl-bump \
</I>&gt;<i>     &gt;   cert=/etc/squid/ssl_certs/artifactory_mitm_ca.pem \
</I>&gt;<i>     &gt;   generate-host-certificates=on \
</I>&gt;<i>     &gt;   dynamic_cert_mem_cache_size=4MB
</I>&gt;<i>     
</I>&gt;<i>     &gt; ssl_bump bump all
</I>&gt;<i>     
</I>&gt;<i>     &gt; acl artifactory_repo_filter urlpath_regex ^/artifactory
</I>&gt;<i>     &gt; http_access allow artifactory_repo_filter
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; # And finally deny all other access to this proxy
</I>&gt;<i>     &gt; http_access deny all
</I>&gt;<i>     
</I>&gt;<i>     Insert an http_access rule to allow all safe CONNECT requests before you
</I>&gt;<i>     deny everything else. IIRC, squid.conf.default has an example of how to
</I>&gt;<i>     do that.
</I>&gt;<i>     
</I>&gt;<i>     Alex.
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019621.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
	<LI>Next message (by thread): <A HREF="019625.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19624">[ date ]</a>
              <a href="thread.html#19624">[ thread ]</a>
              <a href="subject.html#19624">[ subject ]</a>
              <a href="author.html#19624">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
