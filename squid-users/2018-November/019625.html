<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5DRe%3A%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%0A%20Bumping&In-Reply-To=%3CA0E968E2-DEF5-425B-8158-FDD95F889866%40entrustdatacard.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019624.html">
   <LINK REL="Next"  HREF="019626.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping</H1>
    <B>Shane Poage</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5DRe%3A%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%0A%20Bumping&In-Reply-To=%3CA0E968E2-DEF5-425B-8158-FDD95F889866%40entrustdatacard.com%3E"
       TITLE="[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping">Shane.Poage at entrustdatacard.com
       </A><BR>
    <I>Fri Nov  2 18:22:29 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019624.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
        <LI>Next message (by thread): <A HREF="019626.html">[squid-users] URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19625">[ date ]</a>
              <a href="thread.html#19625">[ thread ]</a>
              <a href="subject.html#19625">[ subject ]</a>
              <a href="author.html#19625">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex,

Thanks for all your help so far - I really appreciate it. However, I'm not sure
we're on the same page for some reason because as I said previously, the
suggestions you have made do not appear to be having the effect I'm looking
for. Let me back up a bit and clarify a few things to make sure I am
understanding properly, because there seem to be a few things that I have
thus far fundamentally misunderstood.

My understanding of how SSL bumping works is as follows, based on what
I have read in all of the documentation I could possibly find:

1. A CONNECT request comes in to the proxy from a client.
2. The proxy does access control on that CONNECT request and decides
     whether or not to permit the tunnel. For the sake of moving on, let's
     assume that it decides to allow.
3. The proxy then begins processing the rules for SSL bumping. Again, for the
     sake of simplicity, we'll say that all traffic is getting bumped.
4. The proxy begins bumping traffic and individually processing the requests
     for that session.
5. Each request within the session has the http_access rules applied to them
     as if they were normal HTTP requests made through the proxy, until the
     session is terminated.

Is this understanding correct?

Thanks again,
-Shane

&#65279;On 11/2/18, 12:26 PM, &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

    On 11/2/18 9:54 AM, Shane Poage wrote:
    
    &gt; my original squid.conf had an ACL directive corresponding to the
    &gt; functionality in question:
    
    &gt; 	acl CONNECT method CONNECT
    
    That CONNECT ACL declaration is OK, but what matters is how you _use_
    that declared ACL. The configuration you posted earlier did not use it
    at all.
    
    
    &gt; http_access allow CONNECT artifactory_repo_filter
    
    This &quot;CONNECT and artifactory_repo_filter&quot; rule does not make sense. As
    I said earlier, your artifactory_repo_filter cannot match a CONNECT
    request. Thus, you are joining two conditions that can never be
    satisfied for the same request. For any request, you will get either
    (false and true) or (true and false), which is, of course, always false.
    
    
    &gt; http_access allow CONNECT
    &gt; http_access allow artifactory_repo_filter
    
    This &quot;CONNECT or artifactory_repo_filter&quot; combination makes sense, but
    the first part is dangerous -- you probably should not allow CONNECT
    request to arbitrary port numbers. If you look at how CONNECT requests
    are handled in squid.conf.default, then you will probably come up with
    something like this:
    
      http_access deny !Safe_ports
      http_access deny CONNECT !SSL_ports
      http_access allow CONNECT
      http_access allow artifactory_repo_filter
      http_access deny all
    
    or a bit shorter but arguably less safe (long-term) version:
    
      http_access deny !Safe_ports
      http_access allow CONNECT SSL_ports
      http_access allow artifactory_repo_filter
      http_access deny all
    
    or an even shorter but arguably even less safe (long-term) version:
    
      http_access allow SSL_ports CONNECT
      http_access allow Safe_ports artifactory_repo_filter
      http_access deny all
    
    
    N.B. The above configurations allow plain text traffic matching
    artifactory_repo_filter. I do not know whether that is what you want.
    
    
    &gt; 	This resulted in all SSL traffic being permitted and passed through
    &gt; 	the proxy.
    
    If you are still bumping all SSL traffic, and your
    artifactory_repo_filter ACL is working, then all of the above reasonable
    configurations should still block bumped GET requests that match
    artifactory_repo_filter.
    
    
    &gt; This makes sense to me because the allow CONNECT
    &gt; 	would whitelist all CONNECT traffic, which is what all SSL traffic is
    &gt; 	by my understanding. 
    
    Your understanding is incorrect. Since you are bumping all CONNECT
    tunnels, your http_access traffic consists of:
    
    * CONNECT requests
    * decrypted requests (e.g., GET) inside bumped CONNECT tunnels
    * plain requests (e.g., GET) outside CONNECT tunnels
    
    
    HTH,
    
    Alex.
    
    
    &gt; On 11/1/18, 6:21 PM, Alex Rousskov wrote:
    &gt;     On 11/1/18 2:46 PM, Shane Poage wrote:
    &gt;     
    &gt;     &gt; I have my proxy configured to bump all traffic so that the
    &gt;     &gt; urlpath_regex ACL can be applied, but it appears to not have any
    &gt;     &gt; effect post-bump.
    &gt;     
    &gt;     Your proxy will deny any first post-bump request and close the tunnel
    &gt;     because you deny all CONNECT requests that initiate tunnels. CONNECT
    &gt;     requests do not have a URL path so they will never match your
    &gt;     &quot;http_access allow&quot; rule.
    &gt;     
    &gt;     When a CONNECT request is denied by a bumping Squid, that Squid bumps
    &gt;     the tunnel and then denies the very first bumped request on that tunnel,
    &gt;     whatever that request is. This delayed error return is done to deliver
    &gt;     the &quot;access denied&quot; error page to the client -- browsers ignore CONNECT
    &gt;     error responses.
    &gt;     
    &gt;     
    &gt;     &gt; http_port 3128 ssl-bump \
    &gt;     &gt;   cert=/etc/squid/ssl_certs/artifactory_mitm_ca.pem \
    &gt;     &gt;   generate-host-certificates=on \
    &gt;     &gt;   dynamic_cert_mem_cache_size=4MB
    &gt;     
    &gt;     &gt; ssl_bump bump all
    &gt;     
    &gt;     &gt; acl artifactory_repo_filter urlpath_regex ^/artifactory
    &gt;     &gt; http_access allow artifactory_repo_filter
    &gt;     &gt; 
    &gt;     &gt; # And finally deny all other access to this proxy
    &gt;     &gt; http_access deny all
    &gt;     
    &gt;     Insert an http_access rule to allow all safe CONNECT requests before you
    &gt;     deny everything else. IIRC, squid.conf.default has an example of how to
    &gt;     do that.
    &gt;     
    &gt;     Alex.
    &gt;     _______________________________________________
    &gt;     squid-users mailing list
    &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
    &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
    &gt;     
    &gt; 
    
    

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019624.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
	<LI>Next message (by thread): <A HREF="019626.html">[squid-users] URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19625">[ date ]</a>
              <a href="thread.html#19625">[ thread ]</a>
              <a href="subject.html#19625">[ subject ]</a>
              <a href="author.html#19625">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
