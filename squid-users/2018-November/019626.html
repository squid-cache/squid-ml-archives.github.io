<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] URL Regex ACLs Don't Evaluate After Bumping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%20Bumping&In-Reply-To=%3Cdbfa5f8d-b033-466c-8af6-b2b06e756d50%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019625.html">
   <LINK REL="Next"  HREF="019630.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] URL Regex ACLs Don't Evaluate After Bumping</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%20Bumping&In-Reply-To=%3Cdbfa5f8d-b033-466c-8af6-b2b06e756d50%40measurement-factory.com%3E"
       TITLE="[squid-users] URL Regex ACLs Don't Evaluate After Bumping">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Nov  2 20:15:07 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019625.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
        <LI>Next message (by thread): <A HREF="019630.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19626">[ date ]</a>
              <a href="thread.html#19626">[ thread ]</a>
              <a href="subject.html#19626">[ subject ]</a>
              <a href="author.html#19626">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/2/18 12:22 PM, Shane Poage wrote:

&gt;<i> My understanding of how SSL bumping works is as follows, based on what
</I>&gt;<i> I have read in all of the documentation I could possibly find:
</I>
To simplify, I will interpret the statements below in SslBump context.
That is, I will interpret them as they are applied to traffic received
on an http_port with ssl-bump configured.

I will also assume a bug-free implementation. In other words, the entire
text below is under the &quot;Bugs notwithstanding...&quot; precondition.


&gt;<i> 1. A CONNECT request comes in to the proxy from a client.
</I>&gt;<i> 2. The proxy does access control on that CONNECT request and decides
</I>&gt;<i>      whether or not to permit the tunnel. For the sake of moving on, let's
</I>&gt;<i>      assume that it decides to allow.
</I>
Correct. This decision is a part of SslBump step1.

[ The decision to allow or deny CONNECT is done again during SslBump
step2 if a peek or stare action matches during step1. IIRC, those
additional checks do not happen in your configuration because your
ssl_bump rules match a bump action at step1. Thus, this additional
caveat does not apply to you. ]


&gt;<i> 3. The proxy then begins processing the rules for SSL bumping. Again, for the
</I>&gt;<i>      sake of simplicity, we'll say that all traffic is getting bumped.
</I>
OK. This processing is a part of SslBump step1.


&gt;<i> 4. The proxy begins bumping traffic and individually processing the requests
</I>&gt;<i>      for that session.
</I>
OK. This processing is a part of SslBump step1.

[ Again, there could be more SslBump steps in general, but, in your
specific case, the client connection is bumped here. ]


&gt;<i> 5. Each request within the session has the http_access rules applied to them
</I>&gt;<i>      as if they were normal HTTP requests made through the proxy, until the
</I>&gt;<i>      session is terminated.
</I>
These bumped requests have &quot;https&quot; scheme and some special properties
specific to bumped requests but, overall, they are indeed processed as
usual, including application of http_access rules to each of the bumped
request.


To make progress, I recommend identifying a specific Squid action that
contradicts either your understanding of how things should work or my
remarks and then posting the relevant details of that action along with
a clear explanation of where you see a contradiction.

Alex.


&gt;<i> &#65279;On 11/2/18, 12:26 PM, &quot;Alex Rousskov&quot; wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 11/2/18 9:54 AM, Shane Poage wrote:
</I>&gt;<i>     
</I>&gt;<i>     &gt; my original squid.conf had an ACL directive corresponding to the
</I>&gt;<i>     &gt; functionality in question:
</I>&gt;<i>     
</I>&gt;<i>     &gt; 	acl CONNECT method CONNECT
</I>&gt;<i>     
</I>&gt;<i>     That CONNECT ACL declaration is OK, but what matters is how you _use_
</I>&gt;<i>     that declared ACL. The configuration you posted earlier did not use it
</I>&gt;<i>     at all.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; http_access allow CONNECT artifactory_repo_filter
</I>&gt;<i>     
</I>&gt;<i>     This &quot;CONNECT and artifactory_repo_filter&quot; rule does not make sense. As
</I>&gt;<i>     I said earlier, your artifactory_repo_filter cannot match a CONNECT
</I>&gt;<i>     request. Thus, you are joining two conditions that can never be
</I>&gt;<i>     satisfied for the same request. For any request, you will get either
</I>&gt;<i>     (false and true) or (true and false), which is, of course, always false.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; http_access allow CONNECT
</I>&gt;<i>     &gt; http_access allow artifactory_repo_filter
</I>&gt;<i>     
</I>&gt;<i>     This &quot;CONNECT or artifactory_repo_filter&quot; combination makes sense, but
</I>&gt;<i>     the first part is dangerous -- you probably should not allow CONNECT
</I>&gt;<i>     request to arbitrary port numbers. If you look at how CONNECT requests
</I>&gt;<i>     are handled in squid.conf.default, then you will probably come up with
</I>&gt;<i>     something like this:
</I>&gt;<i>     
</I>&gt;<i>       http_access deny !Safe_ports
</I>&gt;<i>       http_access deny CONNECT !SSL_ports
</I>&gt;<i>       http_access allow CONNECT
</I>&gt;<i>       http_access allow artifactory_repo_filter
</I>&gt;<i>       http_access deny all
</I>&gt;<i>     
</I>&gt;<i>     or a bit shorter but arguably less safe (long-term) version:
</I>&gt;<i>     
</I>&gt;<i>       http_access deny !Safe_ports
</I>&gt;<i>       http_access allow CONNECT SSL_ports
</I>&gt;<i>       http_access allow artifactory_repo_filter
</I>&gt;<i>       http_access deny all
</I>&gt;<i>     
</I>&gt;<i>     or an even shorter but arguably even less safe (long-term) version:
</I>&gt;<i>     
</I>&gt;<i>       http_access allow SSL_ports CONNECT
</I>&gt;<i>       http_access allow Safe_ports artifactory_repo_filter
</I>&gt;<i>       http_access deny all
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     N.B. The above configurations allow plain text traffic matching
</I>&gt;<i>     artifactory_repo_filter. I do not know whether that is what you want.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; 	This resulted in all SSL traffic being permitted and passed through
</I>&gt;<i>     &gt; 	the proxy.
</I>&gt;<i>     
</I>&gt;<i>     If you are still bumping all SSL traffic, and your
</I>&gt;<i>     artifactory_repo_filter ACL is working, then all of the above reasonable
</I>&gt;<i>     configurations should still block bumped GET requests that match
</I>&gt;<i>     artifactory_repo_filter.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; This makes sense to me because the allow CONNECT
</I>&gt;<i>     &gt; 	would whitelist all CONNECT traffic, which is what all SSL traffic is
</I>&gt;<i>     &gt; 	by my understanding. 
</I>&gt;<i>     
</I>&gt;<i>     Your understanding is incorrect. Since you are bumping all CONNECT
</I>&gt;<i>     tunnels, your http_access traffic consists of:
</I>&gt;<i>     
</I>&gt;<i>     * CONNECT requests
</I>&gt;<i>     * decrypted requests (e.g., GET) inside bumped CONNECT tunnels
</I>&gt;<i>     * plain requests (e.g., GET) outside CONNECT tunnels
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     HTH,
</I>&gt;<i>     
</I>&gt;<i>     Alex.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; On 11/1/18, 6:21 PM, Alex Rousskov wrote:
</I>&gt;<i>     &gt;     On 11/1/18 2:46 PM, Shane Poage wrote:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; I have my proxy configured to bump all traffic so that the
</I>&gt;<i>     &gt;     &gt; urlpath_regex ACL can be applied, but it appears to not have any
</I>&gt;<i>     &gt;     &gt; effect post-bump.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     Your proxy will deny any first post-bump request and close the tunnel
</I>&gt;<i>     &gt;     because you deny all CONNECT requests that initiate tunnels. CONNECT
</I>&gt;<i>     &gt;     requests do not have a URL path so they will never match your
</I>&gt;<i>     &gt;     &quot;http_access allow&quot; rule.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     When a CONNECT request is denied by a bumping Squid, that Squid bumps
</I>&gt;<i>     &gt;     the tunnel and then denies the very first bumped request on that tunnel,
</I>&gt;<i>     &gt;     whatever that request is. This delayed error return is done to deliver
</I>&gt;<i>     &gt;     the &quot;access denied&quot; error page to the client -- browsers ignore CONNECT
</I>&gt;<i>     &gt;     error responses.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; http_port 3128 ssl-bump \
</I>&gt;<i>     &gt;     &gt;   cert=/etc/squid/ssl_certs/artifactory_mitm_ca.pem \
</I>&gt;<i>     &gt;     &gt;   generate-host-certificates=on \
</I>&gt;<i>     &gt;     &gt;   dynamic_cert_mem_cache_size=4MB
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; ssl_bump bump all
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; acl artifactory_repo_filter urlpath_regex ^/artifactory
</I>&gt;<i>     &gt;     &gt; http_access allow artifactory_repo_filter
</I>&gt;<i>     &gt;     &gt; 
</I>&gt;<i>     &gt;     &gt; # And finally deny all other access to this proxy
</I>&gt;<i>     &gt;     &gt; http_access deny all
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     Insert an http_access rule to allow all safe CONNECT requests before you
</I>&gt;<i>     &gt;     deny everything else. IIRC, squid.conf.default has an example of how to
</I>&gt;<i>     &gt;     do that.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     Alex.
</I>&gt;<i>     &gt;     _______________________________________________
</I>&gt;<i>     &gt;     squid-users mailing list
</I>&gt;<i>     &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt; 
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019625.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
	<LI>Next message (by thread): <A HREF="019630.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19626">[ date ]</a>
              <a href="thread.html#19626">[ thread ]</a>
              <a href="subject.html#19626">[ subject ]</a>
              <a href="author.html#19626">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
