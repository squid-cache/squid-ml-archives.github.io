<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5DRe%3A%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%0A%20Bumping&In-Reply-To=%3CDFD11E32-0BC9-4C51-A306-3151B0EA4374%40entrustdatacard.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019626.html">
   <LINK REL="Next"  HREF="019631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping</H1>
    <B>Shane Poage</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5DRe%3A%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%0A%20Bumping&In-Reply-To=%3CDFD11E32-0BC9-4C51-A306-3151B0EA4374%40entrustdatacard.com%3E"
       TITLE="[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping">Shane.Poage at entrustdatacard.com
       </A><BR>
    <I>Mon Nov  5 19:02:57 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019626.html">[squid-users] URL Regex ACLs Don't Evaluate After Bumping
</A></li>
        <LI>Next message (by thread): <A HREF="019631.html">[squid-users] URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19630">[ date ]</a>
              <a href="thread.html#19630">[ thread ]</a>
              <a href="subject.html#19630">[ subject ]</a>
              <a href="author.html#19630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex,

Great, it sounds like I'm pretty much on-track in terms of understanding how bumping
works under the hood. Thanks for taking the time to step through that and confirm my
understanding.

So here's the problem: the initial solution you gave for my urlpath_regex ACL not
permitting the traffic I expected was that I needed to permit the initial CONNECT request.
That made sense, but did not appear to behave exactly as I expected. Adding the
'method CONNECT' ACL as an allow http_accept directive appears to let ALL HTTPS
traffic through the proxy and ignore the other ACLs that should apply to the subsequent
requests in the CONNECT tunnel. This doesn't make sense to me based on how I thought
I understood the way bumping functions.

So, here's the question: if I'm not misunderstanding how bumping works, have I uncovered
a bug in Squid? Either in the form of the CONNECT ACL not being applied as expected, or
in the form of the urlpath_regex not being applied... Or is there something additional that
I'm fundamentally missing?

Thanks for your continued assistance,
-Shane

&#65279;On 11/2/18, 3:15 PM, &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

    WARNING: This email originated outside of Entrust Datacard.
    DO NOT CLICK links or attachments unless you trust the sender and know the content is safe.
    
    On 11/2/18 12:22 PM, Shane Poage wrote:
    
    &gt; My understanding of how SSL bumping works is as follows, based on what
    &gt; I have read in all of the documentation I could possibly find:
    
    To simplify, I will interpret the statements below in SslBump context.
    That is, I will interpret them as they are applied to traffic received
    on an http_port with ssl-bump configured.
    
    I will also assume a bug-free implementation. In other words, the entire
    text below is under the &quot;Bugs notwithstanding...&quot; precondition.
    
    
    &gt; 1. A CONNECT request comes in to the proxy from a client.
    &gt; 2. The proxy does access control on that CONNECT request and decides
    &gt;      whether or not to permit the tunnel. For the sake of moving on, let's
    &gt;      assume that it decides to allow.
    
    Correct. This decision is a part of SslBump step1.
    
    [ The decision to allow or deny CONNECT is done again during SslBump
    step2 if a peek or stare action matches during step1. IIRC, those
    additional checks do not happen in your configuration because your
    ssl_bump rules match a bump action at step1. Thus, this additional
    caveat does not apply to you. ]
    
    
    &gt; 3. The proxy then begins processing the rules for SSL bumping. Again, for the
    &gt;      sake of simplicity, we'll say that all traffic is getting bumped.
    
    OK. This processing is a part of SslBump step1.
    
    
    &gt; 4. The proxy begins bumping traffic and individually processing the requests
    &gt;      for that session.
    
    OK. This processing is a part of SslBump step1.
    
    [ Again, there could be more SslBump steps in general, but, in your
    specific case, the client connection is bumped here. ]
    
    
    &gt; 5. Each request within the session has the http_access rules applied to them
    &gt;      as if they were normal HTTP requests made through the proxy, until the
    &gt;      session is terminated.
    
    These bumped requests have &quot;https&quot; scheme and some special properties
    specific to bumped requests but, overall, they are indeed processed as
    usual, including application of http_access rules to each of the bumped
    request.
    
    
    To make progress, I recommend identifying a specific Squid action that
    contradicts either your understanding of how things should work or my
    remarks and then posting the relevant details of that action along with
    a clear explanation of where you see a contradiction.
    
    Alex.
    
    
    &gt; On 11/2/18, 12:26 PM, &quot;Alex Rousskov&quot; wrote:
    &gt; 
    &gt;     On 11/2/18 9:54 AM, Shane Poage wrote:
    &gt;     
    &gt;     &gt; my original squid.conf had an ACL directive corresponding to the
    &gt;     &gt; functionality in question:
    &gt;     
    &gt;     &gt; 	acl CONNECT method CONNECT
    &gt;     
    &gt;     That CONNECT ACL declaration is OK, but what matters is how you _use_
    &gt;     that declared ACL. The configuration you posted earlier did not use it
    &gt;     at all.
    &gt;     
    &gt;     
    &gt;     &gt; http_access allow CONNECT artifactory_repo_filter
    &gt;     
    &gt;     This &quot;CONNECT and artifactory_repo_filter&quot; rule does not make sense. As
    &gt;     I said earlier, your artifactory_repo_filter cannot match a CONNECT
    &gt;     request. Thus, you are joining two conditions that can never be
    &gt;     satisfied for the same request. For any request, you will get either
    &gt;     (false and true) or (true and false), which is, of course, always false.
    &gt;     
    &gt;     
    &gt;     &gt; http_access allow CONNECT
    &gt;     &gt; http_access allow artifactory_repo_filter
    &gt;     
    &gt;     This &quot;CONNECT or artifactory_repo_filter&quot; combination makes sense, but
    &gt;     the first part is dangerous -- you probably should not allow CONNECT
    &gt;     request to arbitrary port numbers. If you look at how CONNECT requests
    &gt;     are handled in squid.conf.default, then you will probably come up with
    &gt;     something like this:
    &gt;     
    &gt;       http_access deny !Safe_ports
    &gt;       http_access deny CONNECT !SSL_ports
    &gt;       http_access allow CONNECT
    &gt;       http_access allow artifactory_repo_filter
    &gt;       http_access deny all
    &gt;     
    &gt;     or a bit shorter but arguably less safe (long-term) version:
    &gt;     
    &gt;       http_access deny !Safe_ports
    &gt;       http_access allow CONNECT SSL_ports
    &gt;       http_access allow artifactory_repo_filter
    &gt;       http_access deny all
    &gt;     
    &gt;     or an even shorter but arguably even less safe (long-term) version:
    &gt;     
    &gt;       http_access allow SSL_ports CONNECT
    &gt;       http_access allow Safe_ports artifactory_repo_filter
    &gt;       http_access deny all
    &gt;     
    &gt;     
    &gt;     N.B. The above configurations allow plain text traffic matching
    &gt;     artifactory_repo_filter. I do not know whether that is what you want.
    &gt;     
    &gt;     
    &gt;     &gt; 	This resulted in all SSL traffic being permitted and passed through
    &gt;     &gt; 	the proxy.
    &gt;     
    &gt;     If you are still bumping all SSL traffic, and your
    &gt;     artifactory_repo_filter ACL is working, then all of the above reasonable
    &gt;     configurations should still block bumped GET requests that match
    &gt;     artifactory_repo_filter.
    &gt;     
    &gt;     
    &gt;     &gt; This makes sense to me because the allow CONNECT
    &gt;     &gt; 	would whitelist all CONNECT traffic, which is what all SSL traffic is
    &gt;     &gt; 	by my understanding. 
    &gt;     
    &gt;     Your understanding is incorrect. Since you are bumping all CONNECT
    &gt;     tunnels, your http_access traffic consists of:
    &gt;     
    &gt;     * CONNECT requests
    &gt;     * decrypted requests (e.g., GET) inside bumped CONNECT tunnels
    &gt;     * plain requests (e.g., GET) outside CONNECT tunnels
    &gt;     
    &gt;     
    &gt;     HTH,
    &gt;     
    &gt;     Alex.
    &gt;     
    &gt;     
    &gt;     &gt; On 11/1/18, 6:21 PM, Alex Rousskov wrote:
    &gt;     &gt;     On 11/1/18 2:46 PM, Shane Poage wrote:
    &gt;     &gt;     
    &gt;     &gt;     &gt; I have my proxy configured to bump all traffic so that the
    &gt;     &gt;     &gt; urlpath_regex ACL can be applied, but it appears to not have any
    &gt;     &gt;     &gt; effect post-bump.
    &gt;     &gt;     
    &gt;     &gt;     Your proxy will deny any first post-bump request and close the tunnel
    &gt;     &gt;     because you deny all CONNECT requests that initiate tunnels. CONNECT
    &gt;     &gt;     requests do not have a URL path so they will never match your
    &gt;     &gt;     &quot;http_access allow&quot; rule.
    &gt;     &gt;     
    &gt;     &gt;     When a CONNECT request is denied by a bumping Squid, that Squid bumps
    &gt;     &gt;     the tunnel and then denies the very first bumped request on that tunnel,
    &gt;     &gt;     whatever that request is. This delayed error return is done to deliver
    &gt;     &gt;     the &quot;access denied&quot; error page to the client -- browsers ignore CONNECT
    &gt;     &gt;     error responses.
    &gt;     &gt;     
    &gt;     &gt;     
    &gt;     &gt;     &gt; http_port 3128 ssl-bump \
    &gt;     &gt;     &gt;   cert=/etc/squid/ssl_certs/artifactory_mitm_ca.pem \
    &gt;     &gt;     &gt;   generate-host-certificates=on \
    &gt;     &gt;     &gt;   dynamic_cert_mem_cache_size=4MB
    &gt;     &gt;     
    &gt;     &gt;     &gt; ssl_bump bump all
    &gt;     &gt;     
    &gt;     &gt;     &gt; acl artifactory_repo_filter urlpath_regex ^/artifactory
    &gt;     &gt;     &gt; http_access allow artifactory_repo_filter
    &gt;     &gt;     &gt; 
    &gt;     &gt;     &gt; # And finally deny all other access to this proxy
    &gt;     &gt;     &gt; http_access deny all
    &gt;     &gt;     
    &gt;     &gt;     Insert an http_access rule to allow all safe CONNECT requests before you
    &gt;     &gt;     deny everything else. IIRC, squid.conf.default has an example of how to
    &gt;     &gt;     do that.
    &gt;     &gt;     
    &gt;     &gt;     Alex.
    &gt;     &gt;     _______________________________________________
    &gt;     &gt;     squid-users mailing list
    &gt;     &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
    &gt;     &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
    &gt;     &gt;     
    &gt;     &gt; 
    &gt;     
    &gt;     
    &gt; 
    
    

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019626.html">[squid-users] URL Regex ACLs Don't Evaluate After Bumping
</A></li>
	<LI>Next message (by thread): <A HREF="019631.html">[squid-users] URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19630">[ date ]</a>
              <a href="thread.html#19630">[ thread ]</a>
              <a href="subject.html#19630">[ subject ]</a>
              <a href="author.html#19630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
