<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] URL Regex ACLs Don't Evaluate After Bumping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%20Bumping&In-Reply-To=%3Ca53909fb-81a7-2335-7cb8-0ed56e5dbbda%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019630.html">
   <LINK REL="Next"  HREF="019636.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] URL Regex ACLs Don't Evaluate After Bumping</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20URL%20Regex%20ACLs%20Don%27t%20Evaluate%20After%20Bumping&In-Reply-To=%3Ca53909fb-81a7-2335-7cb8-0ed56e5dbbda%40measurement-factory.com%3E"
       TITLE="[squid-users] URL Regex ACLs Don't Evaluate After Bumping">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Nov  5 19:23:24 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019630.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
        <LI>Next message (by thread): <A HREF="019636.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19631">[ date ]</a>
              <a href="thread.html#19631">[ thread ]</a>
              <a href="subject.html#19631">[ subject ]</a>
              <a href="author.html#19631">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/5/18 12:02 PM, Shane Poage wrote:

&gt;<i> if I'm not misunderstanding how bumping works, have I uncovered a bug
</I>&gt;<i> in Squid? Either in the form of the CONNECT ACL not being applied as
</I>&gt;<i> expected, or in the form of the urlpath_regex not being applied... Or
</I>&gt;<i> is there something additional that I'm fundamentally missing?
</I>
It is difficult for me to say why a correct configuration does not work
in your environment because you have not supplied any relevant details
(yet). You have supplied details for some other configurations IIRC, but
not the one you should be using.

As a starting point, I recommend posting your current/correct
configuration and the corresponding compressed ALL,3 cache.log while
reproducing a problem on an isolated Squid handling a single problematic
transaction. If possible, please use curl, wget, or another
single-request HTTP client to drive that transaction, not a browser.
Please also post the corresponding access.log lines.


Thank you,

Alex.


&gt;<i> &#65279;On 11/2/18, 3:15 PM, &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     WARNING: This email originated outside of Entrust Datacard.
</I>&gt;<i>     DO NOT CLICK links or attachments unless you trust the sender and know the content is safe.
</I>&gt;<i>     
</I>&gt;<i>     On 11/2/18 12:22 PM, Shane Poage wrote:
</I>&gt;<i>     
</I>&gt;<i>     &gt; My understanding of how SSL bumping works is as follows, based on what
</I>&gt;<i>     &gt; I have read in all of the documentation I could possibly find:
</I>&gt;<i>     
</I>&gt;<i>     To simplify, I will interpret the statements below in SslBump context.
</I>&gt;<i>     That is, I will interpret them as they are applied to traffic received
</I>&gt;<i>     on an http_port with ssl-bump configured.
</I>&gt;<i>     
</I>&gt;<i>     I will also assume a bug-free implementation. In other words, the entire
</I>&gt;<i>     text below is under the &quot;Bugs notwithstanding...&quot; precondition.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; 1. A CONNECT request comes in to the proxy from a client.
</I>&gt;<i>     &gt; 2. The proxy does access control on that CONNECT request and decides
</I>&gt;<i>     &gt;      whether or not to permit the tunnel. For the sake of moving on, let's
</I>&gt;<i>     &gt;      assume that it decides to allow.
</I>&gt;<i>     
</I>&gt;<i>     Correct. This decision is a part of SslBump step1.
</I>&gt;<i>     
</I>&gt;<i>     [ The decision to allow or deny CONNECT is done again during SslBump
</I>&gt;<i>     step2 if a peek or stare action matches during step1. IIRC, those
</I>&gt;<i>     additional checks do not happen in your configuration because your
</I>&gt;<i>     ssl_bump rules match a bump action at step1. Thus, this additional
</I>&gt;<i>     caveat does not apply to you. ]
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; 3. The proxy then begins processing the rules for SSL bumping. Again, for the
</I>&gt;<i>     &gt;      sake of simplicity, we'll say that all traffic is getting bumped.
</I>&gt;<i>     
</I>&gt;<i>     OK. This processing is a part of SslBump step1.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; 4. The proxy begins bumping traffic and individually processing the requests
</I>&gt;<i>     &gt;      for that session.
</I>&gt;<i>     
</I>&gt;<i>     OK. This processing is a part of SslBump step1.
</I>&gt;<i>     
</I>&gt;<i>     [ Again, there could be more SslBump steps in general, but, in your
</I>&gt;<i>     specific case, the client connection is bumped here. ]
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; 5. Each request within the session has the http_access rules applied to them
</I>&gt;<i>     &gt;      as if they were normal HTTP requests made through the proxy, until the
</I>&gt;<i>     &gt;      session is terminated.
</I>&gt;<i>     
</I>&gt;<i>     These bumped requests have &quot;https&quot; scheme and some special properties
</I>&gt;<i>     specific to bumped requests but, overall, they are indeed processed as
</I>&gt;<i>     usual, including application of http_access rules to each of the bumped
</I>&gt;<i>     request.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     To make progress, I recommend identifying a specific Squid action that
</I>&gt;<i>     contradicts either your understanding of how things should work or my
</I>&gt;<i>     remarks and then posting the relevant details of that action along with
</I>&gt;<i>     a clear explanation of where you see a contradiction.
</I>&gt;<i>     
</I>&gt;<i>     Alex.
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i>     &gt; On 11/2/18, 12:26 PM, &quot;Alex Rousskov&quot; wrote:
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;     On 11/2/18 9:54 AM, Shane Poage wrote:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; my original squid.conf had an ACL directive corresponding to the
</I>&gt;<i>     &gt;     &gt; functionality in question:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; 	acl CONNECT method CONNECT
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     That CONNECT ACL declaration is OK, but what matters is how you _use_
</I>&gt;<i>     &gt;     that declared ACL. The configuration you posted earlier did not use it
</I>&gt;<i>     &gt;     at all.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; http_access allow CONNECT artifactory_repo_filter
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     This &quot;CONNECT and artifactory_repo_filter&quot; rule does not make sense. As
</I>&gt;<i>     &gt;     I said earlier, your artifactory_repo_filter cannot match a CONNECT
</I>&gt;<i>     &gt;     request. Thus, you are joining two conditions that can never be
</I>&gt;<i>     &gt;     satisfied for the same request. For any request, you will get either
</I>&gt;<i>     &gt;     (false and true) or (true and false), which is, of course, always false.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; http_access allow CONNECT
</I>&gt;<i>     &gt;     &gt; http_access allow artifactory_repo_filter
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     This &quot;CONNECT or artifactory_repo_filter&quot; combination makes sense, but
</I>&gt;<i>     &gt;     the first part is dangerous -- you probably should not allow CONNECT
</I>&gt;<i>     &gt;     request to arbitrary port numbers. If you look at how CONNECT requests
</I>&gt;<i>     &gt;     are handled in squid.conf.default, then you will probably come up with
</I>&gt;<i>     &gt;     something like this:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;       http_access deny !Safe_ports
</I>&gt;<i>     &gt;       http_access deny CONNECT !SSL_ports
</I>&gt;<i>     &gt;       http_access allow CONNECT
</I>&gt;<i>     &gt;       http_access allow artifactory_repo_filter
</I>&gt;<i>     &gt;       http_access deny all
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     or a bit shorter but arguably less safe (long-term) version:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;       http_access deny !Safe_ports
</I>&gt;<i>     &gt;       http_access allow CONNECT SSL_ports
</I>&gt;<i>     &gt;       http_access allow artifactory_repo_filter
</I>&gt;<i>     &gt;       http_access deny all
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     or an even shorter but arguably even less safe (long-term) version:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;       http_access allow SSL_ports CONNECT
</I>&gt;<i>     &gt;       http_access allow Safe_ports artifactory_repo_filter
</I>&gt;<i>     &gt;       http_access deny all
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     N.B. The above configurations allow plain text traffic matching
</I>&gt;<i>     &gt;     artifactory_repo_filter. I do not know whether that is what you want.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; 	This resulted in all SSL traffic being permitted and passed through
</I>&gt;<i>     &gt;     &gt; 	the proxy.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     If you are still bumping all SSL traffic, and your
</I>&gt;<i>     &gt;     artifactory_repo_filter ACL is working, then all of the above reasonable
</I>&gt;<i>     &gt;     configurations should still block bumped GET requests that match
</I>&gt;<i>     &gt;     artifactory_repo_filter.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; This makes sense to me because the allow CONNECT
</I>&gt;<i>     &gt;     &gt; 	would whitelist all CONNECT traffic, which is what all SSL traffic is
</I>&gt;<i>     &gt;     &gt; 	by my understanding. 
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     Your understanding is incorrect. Since you are bumping all CONNECT
</I>&gt;<i>     &gt;     tunnels, your http_access traffic consists of:
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     * CONNECT requests
</I>&gt;<i>     &gt;     * decrypted requests (e.g., GET) inside bumped CONNECT tunnels
</I>&gt;<i>     &gt;     * plain requests (e.g., GET) outside CONNECT tunnels
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     HTH,
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     Alex.
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     &gt; On 11/1/18, 6:21 PM, Alex Rousskov wrote:
</I>&gt;<i>     &gt;     &gt;     On 11/1/18 2:46 PM, Shane Poage wrote:
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     &gt; I have my proxy configured to bump all traffic so that the
</I>&gt;<i>     &gt;     &gt;     &gt; urlpath_regex ACL can be applied, but it appears to not have any
</I>&gt;<i>     &gt;     &gt;     &gt; effect post-bump.
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     Your proxy will deny any first post-bump request and close the tunnel
</I>&gt;<i>     &gt;     &gt;     because you deny all CONNECT requests that initiate tunnels. CONNECT
</I>&gt;<i>     &gt;     &gt;     requests do not have a URL path so they will never match your
</I>&gt;<i>     &gt;     &gt;     &quot;http_access allow&quot; rule.
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     When a CONNECT request is denied by a bumping Squid, that Squid bumps
</I>&gt;<i>     &gt;     &gt;     the tunnel and then denies the very first bumped request on that tunnel,
</I>&gt;<i>     &gt;     &gt;     whatever that request is. This delayed error return is done to deliver
</I>&gt;<i>     &gt;     &gt;     the &quot;access denied&quot; error page to the client -- browsers ignore CONNECT
</I>&gt;<i>     &gt;     &gt;     error responses.
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     &gt; http_port 3128 ssl-bump \
</I>&gt;<i>     &gt;     &gt;     &gt;   cert=/etc/squid/ssl_certs/artifactory_mitm_ca.pem \
</I>&gt;<i>     &gt;     &gt;     &gt;   generate-host-certificates=on \
</I>&gt;<i>     &gt;     &gt;     &gt;   dynamic_cert_mem_cache_size=4MB
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     &gt; ssl_bump bump all
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     &gt; acl artifactory_repo_filter urlpath_regex ^/artifactory
</I>&gt;<i>     &gt;     &gt;     &gt; http_access allow artifactory_repo_filter
</I>&gt;<i>     &gt;     &gt;     &gt; 
</I>&gt;<i>     &gt;     &gt;     &gt; # And finally deny all other access to this proxy
</I>&gt;<i>     &gt;     &gt;     &gt; http_access deny all
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     Insert an http_access rule to allow all safe CONNECT requests before you
</I>&gt;<i>     &gt;     &gt;     deny everything else. IIRC, squid.conf.default has an example of how to
</I>&gt;<i>     &gt;     &gt;     do that.
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt;     Alex.
</I>&gt;<i>     &gt;     &gt;     _______________________________________________
</I>&gt;<i>     &gt;     &gt;     squid-users mailing list
</I>&gt;<i>     &gt;     &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &gt;     &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &gt;     &gt;     
</I>&gt;<i>     &gt;     &gt; 
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt;     
</I>&gt;<i>     &gt; 
</I>&gt;<i>     
</I>&gt;<i>     
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019630.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
	<LI>Next message (by thread): <A HREF="019636.html">[squid-users] [EXTERNAL]Re: URL Regex ACLs Don't Evaluate After Bumping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19631">[ date ]</a>
              <a href="thread.html#19631">[ thread ]</a>
              <a href="subject.html#19631">[ subject ]</a>
              <a href="author.html#19631">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
